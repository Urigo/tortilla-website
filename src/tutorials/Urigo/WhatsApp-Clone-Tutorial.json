[
  {
    "repoUrl": "https://github.com/Urigo/WhatsApp-Clone-Tutorial",
    "branchName": "master",
    "historyBranchName": "master-history",
    "releases": [
      {
        "releaseVersion": "next",
        "releaseDate": "2019-08-11 20:54:13 +0200",
        "tagName": "master@next",
        "tagRevision": "ac072016207bdc0f4aba38acf1932ccef6f993b2",
        "historyRevision": "b2273c224249135b946b87f7efcd48edb0b69824",
        "changesDiff": "",
        "manuals": [
          {
            "manualTitle": "Whatsapp Clone Tutorial",
            "stepRevision": "42f7af61953ac94f61694501411f99f054111cfd",
            "manualView": "![whatsapp-clone](https://user-images.githubusercontent.com/7648874/54141944-9f801a80-4461-11e9-85a1-bcb161d9a6c6.png)\n\n!(https://www.youtube.com/watch?v=omsHNP4Vjhc)\n\nWhatsapp Clone is a free and open-source tutorial that will guide you step-by-step on how to create a full-stack,\nmobile, hybrid web application from scratch.\n\n- [Skip to just clone the finished application](#cloning-the-finished-app)\n\nThe software world is evolving quickly, and oftentimes people find themselves left behind, even the most experienced ones.\nThe purpose of this tutorial is not only to demonstrate how to create a full application with the latest technologies, but also\nto keep up to date with the ever-changing development ecosystem.\n\nThis tutorial is for anyone who has ever asked themselves one of the following questions:\n\n- How do people build an app today?\n- What are the currently leading technologies in the ecosystem?\n- What are the best practices for using technology XXX?\n- What is the purpose of technology XXX?\n- How does technology XXX work?\n- How do I use technology XXX?\n- How do I migrate to the new version of technology XXX?\n- Why should I use technology XXX over technology YYY?\n\nAll of the above and more can be answered in the tutorial. Whether youâ€™re a beginner, intermediate or a professional,\nwe will have the answers youâ€™re looking for.\n\n**What technologies does Whatsapp Clone uses?**\n\nThe version of the Whatsapp Clone you are looking at, uses:\n\n- [React (with Hooks and Suspense)](http://react.com)\n- [Styled-Components](https://styled-components.com)\n- [Material-UI](https://material-ui.com)\n- [TypeScript](https://typescriptlang.org)\n- [Apollo GraphQL](https://www.apollographql.com)\n- [GraphQL Code Generator](http://graphql-code-generator.com)\n- [GraphQL Modules](https://graphql-modules.com)\n- [PostgreSQL](https://www.postgresql.org/)\n- [GraphQL Inspector](https://graphql-inspector.com/)\n\nThe point of this tutorial is not to be bound to a certain technology, but rather keep itself aligned with the ecosystem.\nWhen a new technology comes out, and itâ€™s better and more popular, Whatsapp Clone will upgrade to use it (together with full migration instructions).\n\n**P2P tutorial for the community by the community**\n\nKeeping tutorials up to date is not an easy task.\nThat's why we've created the Tortilla Tutorial Framework that makes it easy to write and update tutorials.\nAlso, the WhatsApp clone is completely open source in order for the community to give its feedback, help and fork ideas.\nHere are the repositories the tutorial is made of:\n\n- [Whatsapp Clone - Client](https://github.com/Urigo/WhatsApp-Clone-Client-React)\n- [Whatsapp Clone - Server](https://github.com/Urigo/WhatsApp-Clone-server)\n- [Whatsapp Clone - Script's text](https://github.com/Urigo/WhatsApp-Clone-Tutorial)\n\nWeâ€™ve also made sure to publish some important documents so you can get more involved.\nYou can track our progress and comment your suggestions, since everything is based on Google Docs and is updated live:\n\n- [Road map](https://docs.google.com/document/d/1p2Zio6Js2eoFfHs9CjIMF6jTuNyD4eQEHlgEAKhAqM8/edit?usp=sharing)\n- [Chapter manuals] (https://drive.google.com/open?id=1ITxOniS_S3sgZfunLvtJ1L9P6Fj1YOLlFHhoQPjT3S0)\n\n## Cloning the finished app\n\nIf you want to simply clone and run the app locally in it's finished,\nfirst clone the [Server repository](https://github.com/Urigo/WhatsApp-Clone-server) and follow the instructions on the README there.\n\nThen clone the [React Client repository](https://github.com/Urigo/WhatsApp-Clone-Client-React) and follow the instructions there carefully.\n\n**Migration instructions included**\n\nThere are many great tutorials out there, but almost none of them shows you what changes you should make in your app in order to be aligned with a new version of a certain technology.\nAs technologies are being updated by the minute, some changes are minor and insignificant,\nbut often times a breaking change will be made in which case we need to know how we can adapt to that change.\nThanks to the [Tortilla platform](https://tortilla.academy), we can provide you with a git-diff that will show you what changes were made between each and every released version of the Whatsapp Clone tutorial since the beginning of history.\nThis way you can easily notice the changes in APIs and migrate your app in no time.\n\n![tutorial-versions-diff](https://user-images.githubusercontent.com/7648874/54142148-0f8ea080-4462-11e9-9522-ec9997b76169.png)\n\n**Prerequisites for WhatsApp Clone**\n\n> Even if you don't have experience with the technologies below you might still be able to start the tutorial and pick things along the way.\n> If you struggle with anything during the tutorial, contact us on the forum or on Github with your questions.\n> It will help us make sure that the tutorial is good for beginners as well\n\n- JavaScript - https://javascript.info/\n- TypeScript\n- JSX\n- HTML\n- CSS\n- Node.JS\n- npm & Yarn\n- React\n- SQL\n\nOS operations such as navigating to a folder, or creating a folder, are all gonna be written in Bash, but the instructions are OS agnostic and can be applied on any machine that is web-compatible.\n\nMake sure you have the latest global dependencies on your computer before starting the tutorial:\n\n**[Node](https://nodejs.org/)**\n\nInstall [nvm](https://github.com/nvm-sh/nvm) by running the following command in your [command line](https://www.wikihow.com/Get-to-the-Command-Line-on-a-Mac):\n\n    $ curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.34.0/install.sh | bash\n\nThen install the latest version of Node by running the following:\n\n    $ nvm install node\n\n**[Yarn](https://yarnpkg.com)**\n\nFollow the instructions [here](https://yarnpkg.com/en/docs/install#mac-stable).\n\n\n**Whatâ€™s on the tutorial?**\n\nWhatsapp Clone is built chronologically, from the most basic, to more higher level features, so we recommend you to follow the tutorial in the right order.\nEach step is focused on a different subject, so by the end of it youâ€™ll have a new feature and a new set of knowledge that you can start implementing in your everyday scenario immediately.\n\nIf you feel like you want to skip or focus on a specific subject, on each step you can download the full app code till that point in time.\n\nThat is also useful in case you get stuck.\n\nCurrently, Whatsapp Clone includes the following chapters:\n\n- [Step 1: Creating a basic React APP with a basic view.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step1.md)\n- [Step 2: Styling with Material-UI and Styled-Components.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step2.md)\n- [Step 3: Setting a basic Node.JS server with basic a basic REST endpoint.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step3.md)\n- [Step 4: Transition to GraphQL.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step4.md)\n- [Step 5: Testing.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step5.md)\n- [Step 6: Creating an app router and implementing a chat room.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step6.md)\n- [Step 7: Caching with Apollo-Client.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step7.md)\n- [Step 8: Sending messages with GraphQL mutations.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step8.md)\n- [Step 9: Type safety with GraphQL Code Generator.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step9.md)\n- [Step 10: Live updates with GraphQL subscriptions.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step10.md)\n- [Step 11: Users.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step11.md)\n- [Step 12: Adding and removing chats.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step12.md)\n- [Step 13: Authentication.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step13.md)\n- [Step 14: Migrating to PostgreSQL.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step14.md)\n- [Step 15: Using a REST API.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step15.md)\n- [Step 16: Modularity.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step16.md)\n- [Step 17: Performance.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step17.md)\n- Step 18: Your choice! Submit a request [here](https://github.com/Urigo/WhatsApp-Clone-Client-React/issues)\n\nWhatsapp Clone is updated on a regular basis, so you should expect more steps and extensions with time.\nYou can keep track of our [road map](https://docs.google.com/document/d/1p2Zio6Js2eoFfHs9CjIMF6jTuNyD4eQEHlgEAKhAqM8/edit?usp=sharing) to see whatâ€™s upcoming.\n\n### External contributors\n\n* [jsparvath](https://github.com/jsparvath)\n* [Akirtovskis](https://github.com/Akirtovskis)\n* [MStokluska](https://github.com/MStokluska)\n* [milenazuccarelli](https://github.com/milenazuccarelli)\n* [itsmylife](https://github.com/itsmylife)"
          },
          {
            "manualTitle": "Step 1: Creating a basic React APP with a basic view",
            "stepRevision": "257d2bcea5d97f23b83acac393fa7dab743374da",
            "manualView": "The first thing we will do in the tutorial is to start with the UI (User Interface).\nThat is the visible part of our app that our users will see and interact with.\n\nIn this chapter we will learn how to create a basic React app.\nThe app will contain a basic view that will render a list of conversations within our app.\nWe will gradually create our app, so for now, instead of using real data, we will use in-memory fake data instead of calling a server.\n\nIn order to save time, instead of starting from scratch, we will use a boilerplate to kick-start our application.\nWhen it comes to React apps, the most popular boilerplate is [`create-react-app`](https://github.com/facebook/create-react-app)\nwhich is also officially maintained by Facebook, the creators of [React](https://reactjs.org/).\n\nWe'll launch `create-react-app` using `yarn create` (so we won't need to install `create-react-app` permanently),\nand run the `react-app` command to create the basis for our WhatsApp Clone.\n\nIn your command line, navigate to the folder you want to put your app's folder in and run:\n\n    $ yarn create react-app whatsapp-clone-client --typescript\n\n> Note how we used the `client` postfix. That's because we're planning to create a server as well on later chapters.\n\nIt will create a directory called `whatsapp-clone-client` inside the current folder.\nInside that directory, it will generate the initial project structure and install the needed dependencies.\nNo configuration or complicated folder structures, just the files you need to build your app.\n\n### Review the generated code\n\n> In our project, we're gonna use [TypeScript](https://www.typescriptlang.org/) (indicated by the `--typescript` command).\n> The main advantage of using TypeScript over using plain JavaScript is that if we want, we get to tell the compiler what types and data structures we expect in certain places,\n> so that the compiler (which unlike a human never forgets) will remind us when we make a mistake and assume something that is not true.\n> The more information we will provide to the compiler, the more the compiler will be able to help us.\n\nOnce the installation is done, you can open your project folder:\n\n\t$ cd whatsapp-clone-client\n\nInside the newly created project, you can run some built-in commands:\n\n\t$ yarn start\n\nRuns the app in development mode. Open `[http://localhost:3000](http://localhost:3000)` to view it in the browser:\n\n![boilerplate-page](https://user-images.githubusercontent.com/7648874/54026782-025f8080-41da-11e9-9a4e-796fe15e8d03.png)\n\n### create-react-app\n\nLet's look at what create-react-app has created for us in order to understand everything that's going on.\n\nFirst thing, let's look at what webpage is being served to the browser.\nThat webpage in `index.html` that sits under the `public` folder.\n\n[{]: <helper> (diffStep \"root\" files=\"public/index.html\" module=\"client\")\n\n#### [Whatsapp Clone Client](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/3285e0c7df54bb4705b18f6ce53f667d443cbf0e)\n\n##### Added public&#x2F;index.html\n```diff\n@@ -0,0 +1,38 @@\n+â”Š  â”Š 1â”Š<!DOCTYPE html>\n+â”Š  â”Š 2â”Š<html lang=\"en\">\n+â”Š  â”Š 3â”Š  <head>\n+â”Š  â”Š 4â”Š    <meta charset=\"utf-8\" />\n+â”Š  â”Š 5â”Š    <link rel=\"shortcut icon\" href=\"%PUBLIC_URL%/favicon.ico\" />\n+â”Š  â”Š 6â”Š    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\n+â”Š  â”Š 7â”Š    <meta name=\"theme-color\" content=\"#000000\" />\n+â”Š  â”Š 8â”Š    <!--\n+â”Š  â”Š 9â”Š      manifest.json provides metadata used when your web app is installed on a\n+â”Š  â”Š10â”Š      user's mobile device or desktop. See https://developers.google.com/web/fundamentals/web-app-manifest/\n+â”Š  â”Š11â”Š    -->\n+â”Š  â”Š12â”Š    <link rel=\"manifest\" href=\"%PUBLIC_URL%/manifest.json\" />\n+â”Š  â”Š13â”Š    <!--\n+â”Š  â”Š14â”Š      Notice the use of %PUBLIC_URL% in the tags above.\n+â”Š  â”Š15â”Š      It will be replaced with the URL of the `public` folder during the build.\n+â”Š  â”Š16â”Š      Only files inside the `public` folder can be referenced from the HTML.\n+â”Š  â”Š17â”Š\n+â”Š  â”Š18â”Š      Unlike \"/favicon.ico\" or \"favicon.ico\", \"%PUBLIC_URL%/favicon.ico\" will\n+â”Š  â”Š19â”Š      work correctly both with client-side routing and a non-root public URL.\n+â”Š  â”Š20â”Š      Learn how to configure a non-root public URL by running `npm run build`.\n+â”Š  â”Š21â”Š    -->\n+â”Š  â”Š22â”Š    <title>React App</title>\n+â”Š  â”Š23â”Š  </head>\n+â”Š  â”Š24â”Š  <body>\n+â”Š  â”Š25â”Š    <noscript>You need to enable JavaScript to run this app.</noscript>\n+â”Š  â”Š26â”Š    <div id=\"root\"></div>\n+â”Š  â”Š27â”Š    <!--\n+â”Š  â”Š28â”Š      This HTML file is a template.\n+â”Š  â”Š29â”Š      If you open it directly in the browser, you will see an empty page.\n+â”Š  â”Š30â”Š\n+â”Š  â”Š31â”Š      You can add webfonts, meta tags, or analytics to this file.\n+â”Š  â”Š32â”Š      The build step will place the bundled scripts into the <body> tag.\n+â”Š  â”Š33â”Š\n+â”Š  â”Š34â”Š      To begin the development, run `npm start` or `yarn start`.\n+â”Š  â”Š35â”Š      To create a production bundle, use `npm run build` or `yarn build`.\n+â”Š  â”Š36â”Š    -->\n+â”Š  â”Š37â”Š  </body>\n+â”Š  â”Š38â”Š</html>\n```\n\n[}]: #\n\nAs you can see, this file is a regular HTML file. You will want to edit it's `<title>` to name our real app:\n\n[{]: <helper> (diffStep \"1.1\" files=\"public/index.html\" module=\"client\")\n\n#### [__Client__ Step 1.1: Rename the app](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/4e69eb75bf1b7bd90c3882a8a4a6c802752785a7)\n\n##### Changed public&#x2F;index.html\n```diff\n@@ -19,7 +19,7 @@\n â”Š19â”Š19â”Š      work correctly both with client-side routing and a non-root public URL.\n â”Š20â”Š20â”Š      Learn how to configure a non-root public URL by running `npm run build`.\n â”Š21â”Š21â”Š    -->\n-â”Š22â”Š  â”Š    <title>React App</title>\n+â”Š  â”Š22â”Š    <title>WhatsApp Clone</title>\n â”Š23â”Š23â”Š  </head>\n â”Š24â”Š24â”Š  <body>\n â”Š25â”Š25â”Š    <noscript>You need to enable JavaScript to run this app.</noscript>\n```\n\n[}]: #\n\nIn the `public` folder we will place assets that are not going to change, like `favicon.ico`, static images and the HTML templates.\n\nWhen we will prepare to app for production, a script from `create-react-app` will place those assets in a build folder and reference them into the\nHTML template.\n\nAnother file in the `public` folder is the `manifest.json` file that gives browsers information about our app in case the users will install the app permanently on their\nmobile phones or desktop apps.\nYou can read more about it here: https://developers.google.com/web/fundamentals/web-app-manifest/.\n\n[{]: <helper> (diffStep \"1.1\" files=\"public/manifest.json\" module=\"client\")\n\n#### [__Client__ Step 1.1: Rename the app](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/4e69eb75bf1b7bd90c3882a8a4a6c802752785a7)\n\n##### Changed public&#x2F;manifest.json\n```diff\n@@ -1,6 +1,6 @@\n â”Š1â”Š1â”Š{\n-â”Š2â”Š â”Š  \"short_name\": \"React App\",\n-â”Š3â”Š â”Š  \"name\": \"Create React App Sample\",\n+â”Š â”Š2â”Š  \"short_name\": \"WhatsApp Clone\",\n+â”Š â”Š3â”Š  \"name\": \"An open source chat app\",\n â”Š4â”Š4â”Š  \"icons\": [\n â”Š5â”Š5â”Š    {\n â”Š6â”Š6â”Š      \"src\": \"favicon.ico\",\n```\n\n[}]: #\n\nNow the HTML file has in it's <body> tag just one `<div id=\"root\"></div>` tag which is empty.\nSo how do we get the nice React logo that is being rendered onto our screen?\n\n`create-react-app` has scripts that will run the `src/index.tsx` file together with our HTML template, so let's look what this file is doing.\n\n[{]: <helper> (diffStep \"root\" files=\"public/index.html\" module=\"client\")\n\n#### [Whatsapp Clone Client](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/3285e0c7df54bb4705b18f6ce53f667d443cbf0e)\n\n##### Added public&#x2F;index.html\n```diff\n@@ -0,0 +1,38 @@\n+â”Š  â”Š 1â”Š<!DOCTYPE html>\n+â”Š  â”Š 2â”Š<html lang=\"en\">\n+â”Š  â”Š 3â”Š  <head>\n+â”Š  â”Š 4â”Š    <meta charset=\"utf-8\" />\n+â”Š  â”Š 5â”Š    <link rel=\"shortcut icon\" href=\"%PUBLIC_URL%/favicon.ico\" />\n+â”Š  â”Š 6â”Š    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\n+â”Š  â”Š 7â”Š    <meta name=\"theme-color\" content=\"#000000\" />\n+â”Š  â”Š 8â”Š    <!--\n+â”Š  â”Š 9â”Š      manifest.json provides metadata used when your web app is installed on a\n+â”Š  â”Š10â”Š      user's mobile device or desktop. See https://developers.google.com/web/fundamentals/web-app-manifest/\n+â”Š  â”Š11â”Š    -->\n+â”Š  â”Š12â”Š    <link rel=\"manifest\" href=\"%PUBLIC_URL%/manifest.json\" />\n+â”Š  â”Š13â”Š    <!--\n+â”Š  â”Š14â”Š      Notice the use of %PUBLIC_URL% in the tags above.\n+â”Š  â”Š15â”Š      It will be replaced with the URL of the `public` folder during the build.\n+â”Š  â”Š16â”Š      Only files inside the `public` folder can be referenced from the HTML.\n+â”Š  â”Š17â”Š\n+â”Š  â”Š18â”Š      Unlike \"/favicon.ico\" or \"favicon.ico\", \"%PUBLIC_URL%/favicon.ico\" will\n+â”Š  â”Š19â”Š      work correctly both with client-side routing and a non-root public URL.\n+â”Š  â”Š20â”Š      Learn how to configure a non-root public URL by running `npm run build`.\n+â”Š  â”Š21â”Š    -->\n+â”Š  â”Š22â”Š    <title>React App</title>\n+â”Š  â”Š23â”Š  </head>\n+â”Š  â”Š24â”Š  <body>\n+â”Š  â”Š25â”Š    <noscript>You need to enable JavaScript to run this app.</noscript>\n+â”Š  â”Š26â”Š    <div id=\"root\"></div>\n+â”Š  â”Š27â”Š    <!--\n+â”Š  â”Š28â”Š      This HTML file is a template.\n+â”Š  â”Š29â”Š      If you open it directly in the browser, you will see an empty page.\n+â”Š  â”Š30â”Š\n+â”Š  â”Š31â”Š      You can add webfonts, meta tags, or analytics to this file.\n+â”Š  â”Š32â”Š      The build step will place the bundled scripts into the <body> tag.\n+â”Š  â”Š33â”Š\n+â”Š  â”Š34â”Š      To begin the development, run `npm start` or `yarn start`.\n+â”Š  â”Š35â”Š      To create a production bundle, use `npm run build` or `yarn build`.\n+â”Š  â”Š36â”Š    -->\n+â”Š  â”Š37â”Š  </body>\n+â”Š  â”Š38â”Š</html>\n```\n\n[}]: #\n\nThe important thing to see here is that `React` is calling it's render method and telling it to render the `App` component into a document where `id` equals `root`.\n\nSo now you know where React is coming into our html template.\n\nBut where does the `App` React component comes from and where does `React` itself comes from?\n\nThe `index.tsx` file imports this code from outside of the file using the `import` command.\n\nIn the case of the `App` component, we can see it bring it from the path './App', which is in the same folder ('src').\n\nGetting React, it is simply calling it by name instead of a path. That means that the import will automatically look for a folder named `react` under the `node-modules` folder.\n\n`node-modules` is a default folder which will include all of the libraries we want to use in our app.\n\n[yarn](https://yarnpkg.com) will install those libraries according to the dependencies listed inside the `package.json` file, so let's look into that.\n\nUnder dependencies you can see all the libraries our app currently depends on.\n\n[{]: <helper> (diffStep \"root\" files=\"package.json\" module=\"client\")\n\n#### [Whatsapp Clone Client](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/3285e0c7df54bb4705b18f6ce53f667d443cbf0e)\n\n##### Added package.json\n```diff\n@@ -0,0 +1,40 @@\n+â”Š  â”Š 1â”Š{\n+â”Š  â”Š 2â”Š  \"name\": \"whatsapp-clone-client\",\n+â”Š  â”Š 3â”Š  \"version\": \"0.1.0\",\n+â”Š  â”Š 4â”Š  \"private\": true,\n+â”Š  â”Š 5â”Š  \"repository\": {\n+â”Š  â”Š 6â”Š    \"type\": \"git\",\n+â”Š  â”Š 7â”Š    \"url\": \"https://github.com/Urigo/WhatsApp-Clone-Client-React.git\"\n+â”Š  â”Š 8â”Š  },\n+â”Š  â”Š 9â”Š  \"dependencies\": {\n+â”Š  â”Š10â”Š    \"@types/jest\": \"24.0.13\",\n+â”Š  â”Š11â”Š    \"@types/node\": \"12.0.1\",\n+â”Š  â”Š12â”Š    \"@types/react\": \"16.8.17\",\n+â”Š  â”Š13â”Š    \"@types/react-dom\": \"16.8.4\",\n+â”Š  â”Š14â”Š    \"react\": \"^16.8.6\",\n+â”Š  â”Š15â”Š    \"react-dom\": \"^16.8.6\",\n+â”Š  â”Š16â”Š    \"react-scripts\": \"3.0.1\",\n+â”Š  â”Š17â”Š    \"typescript\": \"3.4.5\"\n+â”Š  â”Š18â”Š  },\n+â”Š  â”Š19â”Š  \"scripts\": {\n+â”Š  â”Š20â”Š    \"start\": \"react-scripts start\",\n+â”Š  â”Š21â”Š    \"build\": \"react-scripts build\",\n+â”Š  â”Š22â”Š    \"test\": \"TZ=\\\"Asia/Jerusalem\\\" react-scripts test\",\n+â”Š  â”Š23â”Š    \"eject\": \"react-scripts eject\"\n+â”Š  â”Š24â”Š  },\n+â”Š  â”Š25â”Š  \"eslintConfig\": {\n+â”Š  â”Š26â”Š    \"extends\": \"react-app\"\n+â”Š  â”Š27â”Š  },\n+â”Š  â”Š28â”Š  \"browserslist\": {\n+â”Š  â”Š29â”Š    \"production\": [\n+â”Š  â”Š30â”Š      \">0.2%\",\n+â”Š  â”Š31â”Š      \"not dead\",\n+â”Š  â”Š32â”Š      \"not op_mini all\"\n+â”Š  â”Š33â”Š    ],\n+â”Š  â”Š34â”Š    \"development\": [\n+â”Š  â”Š35â”Š      \"last 1 chrome version\",\n+â”Š  â”Š36â”Š      \"last 1 firefox version\",\n+â”Š  â”Š37â”Š      \"last 1 safari version\"\n+â”Š  â”Š38â”Š    ]\n+â”Š  â”Š39â”Š  }\n+â”Š  â”Š40â”Š}\n```\n\n[}]: #\n\nYou can also see other values in there like `scripts`, which will teach `yarn` new commands that we can use.\nThe right side will name the command and the left would be the actual command that it will run.\n\nAnother file that got created is `tsconfig.json`:\n\n[{]: <helper> (diffStep \"root\" files=\"tsconfig.json\" module=\"client\")\n\n#### [Whatsapp Clone Client](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/3285e0c7df54bb4705b18f6ce53f667d443cbf0e)\n\n##### Added tsconfig.json\n```diff\n@@ -0,0 +1,25 @@\n+â”Š  â”Š 1â”Š{\n+â”Š  â”Š 2â”Š  \"compilerOptions\": {\n+â”Š  â”Š 3â”Š    \"target\": \"es5\",\n+â”Š  â”Š 4â”Š    \"lib\": [\n+â”Š  â”Š 5â”Š      \"dom\",\n+â”Š  â”Š 6â”Š      \"dom.iterable\",\n+â”Š  â”Š 7â”Š      \"esnext\"\n+â”Š  â”Š 8â”Š    ],\n+â”Š  â”Š 9â”Š    \"allowJs\": true,\n+â”Š  â”Š10â”Š    \"skipLibCheck\": true,\n+â”Š  â”Š11â”Š    \"esModuleInterop\": true,\n+â”Š  â”Š12â”Š    \"allowSyntheticDefaultImports\": true,\n+â”Š  â”Š13â”Š    \"strict\": true,\n+â”Š  â”Š14â”Š    \"forceConsistentCasingInFileNames\": true,\n+â”Š  â”Š15â”Š    \"module\": \"esnext\",\n+â”Š  â”Š16â”Š    \"moduleResolution\": \"node\",\n+â”Š  â”Š17â”Š    \"resolveJsonModule\": true,\n+â”Š  â”Š18â”Š    \"isolatedModules\": true,\n+â”Š  â”Š19â”Š    \"noEmit\": true,\n+â”Š  â”Š20â”Š    \"jsx\": \"preserve\"\n+â”Š  â”Š21â”Š  },\n+â”Š  â”Š22â”Š  \"include\": [\n+â”Š  â”Š23â”Š    \"src\"\n+â”Š  â”Š24â”Š  ]\n+â”Š  â”Š25â”Š}\n```\n\n[}]: #\n\nThat file specifies options for the Typescript compiler when it takes our code and transforms it from Typescript into Javascript.\n\nSome noticeable configuration options for that file are:\n\n* `target` - What kind of Javascript should the compilers output? in our case `es5` is the version of Javascript that is supported by many browsers.\nIf you know that your app would run only on newer browsers or a Node environment, you can change that value to a newer version and gain performance improvements.\n* `lib` - If you are using new syntax from Javascript, the compiler can add to it's output libraries that would help you support the new syntax even if the browsers don't know those.\n* `strict` - We can give Typescript a lot of information or not so much. The more we give it the more it can help us. adding the strict option will make the compiler warn us when we won't give it enough information.\n\nFor the full set of options, check out the [official docs](https://www.typescriptlang.org/docs/handbook/compiler-options.html);\n\nNow, let's look at our App's code in `src/App.tsx`:\n\n[{]: <helper> (diffStep \"root\" files=\"App.tsx\" module=\"client\")\n\n#### [Whatsapp Clone Client](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/3285e0c7df54bb4705b18f6ce53f667d443cbf0e)\n\n##### Added src&#x2F;App.tsx\n```diff\n@@ -0,0 +1,26 @@\n+â”Š  â”Š 1â”Šimport React from 'react';\n+â”Š  â”Š 2â”Šimport logo from './logo.svg';\n+â”Š  â”Š 3â”Šimport './App.css';\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šconst App: React.FC = () => {\n+â”Š  â”Š 6â”Š  return (\n+â”Š  â”Š 7â”Š    <div className=\"App\">\n+â”Š  â”Š 8â”Š      <header className=\"App-header\">\n+â”Š  â”Š 9â”Š        <img src={logo} className=\"App-logo\" alt=\"logo\" />\n+â”Š  â”Š10â”Š        <p>\n+â”Š  â”Š11â”Š          Edit <code>src/App.tsx</code> and save to reload.\n+â”Š  â”Š12â”Š        </p>\n+â”Š  â”Š13â”Š        <a\n+â”Š  â”Š14â”Š          className=\"App-link\"\n+â”Š  â”Š15â”Š          href=\"https://reactjs.org\"\n+â”Š  â”Š16â”Š          target=\"_blank\"\n+â”Š  â”Š17â”Š          rel=\"noopener noreferrer\"\n+â”Š  â”Š18â”Š        >\n+â”Š  â”Š19â”Š          Learn React\n+â”Š  â”Š20â”Š        </a>\n+â”Š  â”Š21â”Š      </header>\n+â”Š  â”Š22â”Š    </div>\n+â”Š  â”Š23â”Š  );\n+â”Š  â”Š24â”Š}\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Šexport default App;\n```\n\n[}]: #\n\nWe can see that our app is just a function named `App`.\n\n`const App` means we declare a variable named `App` and `const` means it cannot be changed after it has been declared (you can't do `App = XX;` later in the app);\n\nNext we assign App with a function. Something like: `const App = () => {}`.\nThat way of creating functions is called `arrow functions`. It is almost equivalent to `const App = function(){}`.\nSo it is a function that doesn't accept any parameters into it.\n\nThat function returns `jsx`. A visual language from React that describes how our component should look like.\n\nSo all a React component is, is simply a function that returns how it look like.\n\nWe then export this function so that React could import it from `index.tsx`.\n\nIn our own component we will import things like the logo and styles that the component uses and those will be imported together with it each time\nsomething will import our component.\n\nThe last thing we haven't explained is the following part: `App: React.FC`.\nThose are Typescript typings. Everything after `:` describes the types of the `App` variable and has no affect on the behavior and execution of the app.\nIt will tell Typescript how `App` is supposed to look like, so that in case we make a mistake, Typescript will warn us before we get the app running.\n\nSo what are the types of React.FC?  You can check it out inside by using command+click on it's name.\nYou see that it accepts `P` as props into the component and needs to return `React.Element` or `null`.\n\nLet's test out how typescript typings work: Declare a Typescript interface named `AppProps` that includes a property called `name` of type string. Now use that interface to describe the shape that app's props should have: update the line that declares app to `const App: React.FC<AppProps> = ({name}) => {`\n\nNow open the file `src/index.tsx`.\nYou can see that our editor is calling out that there is an error in our code because no name prop is passed to the App component.\n\nYou will encounter those errors a lot as you develop.\nAlways read the errors all the way. Take your time to understand each sentence there because that will save you a lot of time.\nThat is true also when you are not programming and just encounter errors in the apps you are using...\n\nAs the error message suggests, give the App component a name prop. If you pass a prop that is not a string like `true` or `1+1`, TypeScript will let you know with an error.\n\nThe default for React.FC is that there are no props passed inside so if we'll bring that back but keep sending the `name` value from `index.tsx` in the code, you should now get an error because you are passing a props that the component doesn't accept.\n\nThose errors can be very useful when your app grows.\nMake sure to define types on the component itself like we have done now. It would make it easier to identify the issues.\n\nNext, we have `App.css`. This is used to style our App component.\nPlay around with changing some of the values and see how it changes your view.\nRight now the link between the styles and the components is done by class names (`App-header`, etc).\nLater on we'll learn better strategies of sorting our styles and making\nsure they are not touching components that we don't want them to affect.\n\nNext file - `App.test.tsx`.\nThis file contains automatic tests to make sure our app is doing what it's supposed to do.\n\nWe are programmers, that means that many times our job is to take something manual and making it automatic.\nThat's why we should also strive to automate things we do ourselves.\nType checking is one area, testing is another.  If we can automate tests and run them all the time, it can save us a lot of time\nand bring us a lot of confidence that when we change our code, we haven't destroyed anything.\n\nThe testing tool that create-react-app provides us with is [Jest](https://jestjs.io/).\n\nRight now we have only one simple test - it renders the App React component and makes sure nothing crashes.\nRun the test by running `yarn test` in the command line.\n\nNow go and remove the export from the app component. see how the tests picked up immediately that something is wrong.\n\nIn a later chapter we'll learn how to test more things to make sure we get guarantees that things are working as expected.\n\n## Pin dependencies and save-exact\n\nCheckout the package versions on the `package.json` file.\n\nyou can see the `^` sign.  That means that every time someone will get this code and run `yarn`, what `yarn` will do is to get the newest version on that range.\nWe don't want that. We want to first be notified when a new version is out and we want to explicitly update it.\n\nThat's why we need to add 2 things into our code:\nFirst, to delete all `^` (while also let's update all dependencies to their current latest).\n\n[{]: <helper> (diffStep \"1.2\" files=\"package.json\" module=\"client\")\n\n#### [__Client__ Step 1.2: Pin dependencies](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/fba8842263675a5653d2947f26c99341672a8a19)\n\n##### Changed package.json\n```diff\n@@ -7,14 +7,14 @@\n â”Š 7â”Š 7â”Š    \"url\": \"https://github.com/Urigo/WhatsApp-Clone-Client-React.git\"\n â”Š 8â”Š 8â”Š  },\n â”Š 9â”Š 9â”Š  \"dependencies\": {\n-â”Š10â”Š  â”Š    \"@types/jest\": \"24.0.13\",\n-â”Š11â”Š  â”Š    \"@types/node\": \"12.0.1\",\n-â”Š12â”Š  â”Š    \"@types/react\": \"16.8.17\",\n-â”Š13â”Š  â”Š    \"@types/react-dom\": \"16.8.4\",\n-â”Š14â”Š  â”Š    \"react\": \"^16.8.6\",\n-â”Š15â”Š  â”Š    \"react-dom\": \"^16.8.6\",\n-â”Š16â”Š  â”Š    \"react-scripts\": \"3.0.1\",\n-â”Š17â”Š  â”Š    \"typescript\": \"3.4.5\"\n+â”Š  â”Š10â”Š    \"@types/jest\": \"24.0.17\",\n+â”Š  â”Š11â”Š    \"@types/node\": \"12.7.1\",\n+â”Š  â”Š12â”Š    \"@types/react\": \"16.8.23\",\n+â”Š  â”Š13â”Š    \"@types/react-dom\": \"16.8.5\",\n+â”Š  â”Š14â”Š    \"react\": \"16.9.0\",\n+â”Š  â”Š15â”Š    \"react-dom\": \"16.9.0\",\n+â”Š  â”Š16â”Š    \"react-scripts\": \"3.1.0\",\n+â”Š  â”Š17â”Š    \"typescript\": \"3.5.3\"\n â”Š18â”Š18â”Š  },\n â”Š19â”Š19â”Š  \"scripts\": {\n â”Š20â”Š20â”Š    \"start\": \"react-scripts start\",\n```\n```diff\n@@ -37,4 +37,4 @@\n â”Š37â”Š37â”Š      \"last 1 safari version\"\n â”Š38â”Š38â”Š    ]\n â”Š39â”Š39â”Š  }\n-â”Š40â”Š  â”Š}\n+â”Š  â”Š40â”Š}ðŸš«â†µ\n```\n\n[}]: #\n\nSecond, to add the following command that will make each `yarn add <package-name>` command automatically add the library without any additions or `^` signs into it.\n\n[{]: <helper> (diffStep \"1.2\" files=\".npmrc\" module=\"client\")\n\n#### [__Client__ Step 1.2: Pin dependencies](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/fba8842263675a5653d2947f26c99341672a8a19)\n\n##### Added .npmrc\n```diff\n@@ -0,0 +1 @@\n+â”Š â”Š1â”Šsave-exact=true\n```\n\n[}]: #\n\nThere is no need to upgrade your dependencies at all. If they work it's ok. But, it is highly recommended.\nPackages keep improving all the time with important things that would help your app and will save you time.\nIf you make it a routine to upgrade it makes it much easier then to upgrade every couple of months.\nIn order to discover if there are new versions of libraries there are 2 options.\n\nOne is to manually run a check every day or so to find new packages out there.\nYou can do that by going to your command line in the root folder of the project and type `yarn outdated`.\n\nBut if you want to get notified when there is a new version of your dependencies, you can check out [Renovate](https://github.com/renovatebot/renovate).\nIf your project is hosted somewhere, for example Github, it will analyze your `package.json` and submit a new PR when a new release happened from one of your dependencies.\n\n## git and saving your code on Github\n\nIf you want to save your code somewhere where you can track versions, using [git](https://git-scm.com/book/en/v2) and [Github](https://guides.github.com/activities/hello-world/) is a good choice.\nHere is a nice guide to start: https://try.github.io/.\n\nYou can check out the `.gitignore` file create-react-app has set up for us in the root folder.\nThat file will tell `.git` what not to save and not to upload.\n\n## Code formatting\n\nSome developers write code in a different style than others and it might be annoying while doing code reviews or even merging conflicts. That's why we want to make it consistent. We're going to use **Prettier** which has an opinionated set of styling rules and supports many languages. Your IDE most likely supports it too.\n\n    $ yarn add prettier\n\nWe're going to define a npm script called `format`, few styling rules and we're also going to ignore *node_modules*:\n\n[{]: <helper> (diffStep \"1.3\" files=\"package.json, .prettierrc.yml, .prettierignore\" module=\"client\")\n\n#### [__Client__ Step 1.3: Use Prettier](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/7fbf1a47622e7eceeda4d0cacfc695248b4cd1f5)\n\n##### Added .prettierignore\n```diff\n@@ -0,0 +1 @@\n+â”Š â”Š1â”Šnode_modulesðŸš«â†µ\n```\n\n##### Added .prettierrc.yml\n```diff\n@@ -0,0 +1,4 @@\n+â”Š â”Š1â”ŠtrailingComma: 'es5'\n+â”Š â”Š2â”ŠtabWidth: 2\n+â”Š â”Š3â”ŠsingleQuote: true\n+â”Š â”Š4â”ŠjsxBracketSameLine: true\n```\n\n##### Changed package.json\n```diff\n@@ -11,6 +11,7 @@\n â”Š11â”Š11â”Š    \"@types/node\": \"12.7.1\",\n â”Š12â”Š12â”Š    \"@types/react\": \"16.8.23\",\n â”Š13â”Š13â”Š    \"@types/react-dom\": \"16.8.5\",\n+â”Š  â”Š14â”Š    \"prettier\": \"1.18.2\",\n â”Š14â”Š15â”Š    \"react\": \"16.9.0\",\n â”Š15â”Š16â”Š    \"react-dom\": \"16.9.0\",\n â”Š16â”Š17â”Š    \"react-scripts\": \"3.1.0\",\n```\n```diff\n@@ -20,7 +21,8 @@\n â”Š20â”Š21â”Š    \"start\": \"react-scripts start\",\n â”Š21â”Š22â”Š    \"build\": \"react-scripts build\",\n â”Š22â”Š23â”Š    \"test\": \"TZ=\\\"Asia/Jerusalem\\\" react-scripts test\",\n-â”Š23â”Š  â”Š    \"eject\": \"react-scripts eject\"\n+â”Š  â”Š24â”Š    \"eject\": \"react-scripts eject\",\n+â”Š  â”Š25â”Š    \"format\": \"prettier \\\"**/*.{ts,tsx,css,graphql}\\\" --write\"\n â”Š24â”Š26â”Š  },\n â”Š25â”Š27â”Š  \"eslintConfig\": {\n â”Š26â”Š28â”Š    \"extends\": \"react-app\"\n```\n\n[}]: #\n\nNow let's run:\n\n    $ yarn format\n\nPrettier should format your code:\n\n[{]: <helper> (diffStep \"1.3\" files=\"src/App.tsx\" module=\"client\")\n\n#### [__Client__ Step 1.3: Use Prettier](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/7fbf1a47622e7eceeda4d0cacfc695248b4cd1f5)\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -14,13 +14,12 @@\n â”Š14â”Š14â”Š          className=\"App-link\"\n â”Š15â”Š15â”Š          href=\"https://reactjs.org\"\n â”Š16â”Š16â”Š          target=\"_blank\"\n-â”Š17â”Š  â”Š          rel=\"noopener noreferrer\"\n-â”Š18â”Š  â”Š        >\n+â”Š  â”Š17â”Š          rel=\"noopener noreferrer\">\n â”Š19â”Š18â”Š          Learn React\n â”Š20â”Š19â”Š        </a>\n â”Š21â”Š20â”Š      </header>\n â”Š22â”Š21â”Š    </div>\n â”Š23â”Š22â”Š  );\n-â”Š24â”Š  â”Š}\n+â”Š  â”Š23â”Š};\n â”Š25â”Š24â”Š\n â”Š26â”Š25â”Šexport default App;\n```\n\n[}]: #\n\n> Remember to run `yarn prettier` before you comit your changes!\n\n**End of intro**\n\nAssuming that everything is set, we will now create our first screen - `ChatsListScreen`.\nThe ChatsListScreen component is responsible for showing the active conversations within our app.\n\nIt's best to first schematically plan how our view's gonna look like.\nThis would help us illustrate the intended view and also understand which React.Components / elements take part in it.\nThis is how our screen's gonna look like:\n\n![chatslistscreen](https://user-images.githubusercontent.com/7648874/54027873-01305280-41de-11e9-9df0-5ad9c9c2f226.png)\n\nLet's break down the image above and see what components are we gonna have in the `ChatsListScreen`:\n\n- Navbar -  Which should contain a simple static title for now.\n- ChatsList - Where each item's gonna contain some data regards the user we're chatting with and information about the chat.\n\nFirst let's remove the current React code and add our own code into it.\n\nFor now, let's create fake data on our HTML.\n\nAs this data will be changed and we are not going to manually add HTML tags every time there is a new message, let's move our data into a JSON structure.\nFor now it would be a structure we will manually create.\nThat way we can already make our React component behave like our final version.\n\n[{]: <helper> (diffStep \"1.4\" files=\"App.tsx\" module=\"client\")\n\n#### [__Client__ Step 1.4: Create ChatsList screen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/7f863186eb09e5250defd7b77fa3b09c4d58032d)\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -1,23 +1,31 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n-â”Š 2â”Š  â”Šimport logo from './logo.svg';\n-â”Š 3â”Š  â”Šimport './App.css';\n â”Š 4â”Š 2â”Š\n â”Š 5â”Š 3â”Šconst App: React.FC = () => {\n â”Š 6â”Š 4â”Š  return (\n-â”Š 7â”Š  â”Š    <div className=\"App\">\n-â”Š 8â”Š  â”Š      <header className=\"App-header\">\n-â”Š 9â”Š  â”Š        <img src={logo} className=\"App-logo\" alt=\"logo\" />\n-â”Š10â”Š  â”Š        <p>\n-â”Š11â”Š  â”Š          Edit <code>src/App.tsx</code> and save to reload.\n-â”Š12â”Š  â”Š        </p>\n-â”Š13â”Š  â”Š        <a\n-â”Š14â”Š  â”Š          className=\"App-link\"\n-â”Š15â”Š  â”Š          href=\"https://reactjs.org\"\n-â”Š16â”Š  â”Š          target=\"_blank\"\n-â”Š17â”Š  â”Š          rel=\"noopener noreferrer\">\n-â”Š18â”Š  â”Š          Learn React\n-â”Š19â”Š  â”Š        </a>\n-â”Š20â”Š  â”Š      </header>\n+â”Š  â”Š 5â”Š    <div>\n+â”Š  â”Š 6â”Š      <div>Whatsapp Clone</div>\n+â”Š  â”Š 7â”Š      <div>\n+â”Š  â”Š 8â”Š        <ul>\n+â”Š  â”Š 9â”Š          <li>\n+â”Š  â”Š10â”Š            <img\n+â”Š  â”Š11â”Š              src=\"https://randomuser.me/api/portraits/thumb/men/1.jpg\"\n+â”Š  â”Š12â”Š              alt=\"Profile\"\n+â”Š  â”Š13â”Š            />\n+â”Š  â”Š14â”Š            <div>Ethan Gonzalez</div>\n+â”Š  â”Š15â”Š            <div>You on your way?</div>\n+â”Š  â”Š16â”Š            <div>10:25</div>\n+â”Š  â”Š17â”Š          </li>\n+â”Š  â”Š18â”Š          <li>\n+â”Š  â”Š19â”Š            <img\n+â”Š  â”Š20â”Š              src=\"https://randomuser.me/api/portraits/thumb/men/2.jpg\"\n+â”Š  â”Š21â”Š              alt=\"Profile\"\n+â”Š  â”Š22â”Š            />\n+â”Š  â”Š23â”Š            <div>Bryan Wallace</div>\n+â”Š  â”Š24â”Š            <div>Hey, it's me</div>\n+â”Š  â”Š25â”Š            <div>13:27</div>\n+â”Š  â”Š26â”Š          </li>\n+â”Š  â”Š27â”Š        </ul>\n+â”Š  â”Š28â”Š      </div>\n â”Š21â”Š29â”Š    </div>\n â”Š22â”Š30â”Š  );\n â”Š23â”Š31â”Š};\n```\n\n[}]: #\n\nIf all we do in the function is just returning a value, instead of `const App: React.FC = () => { return () };` we can also do `const App: React.FC = () => ();`\nSo let's use that for our ChatsList component.\n\nWe have to import React to make sure it will work.\nWe also have to export our component function so that the `App` component would be able to import it.\n(You can't import Javascript variables from a file if that file won't explicitly export it).\n\nAs we don't use those styles and logos anymore, we can delete the `src/App.css` and the `src/logo.svg` files from our app.\n\nNow let's move ChatsList into it's own component:\n\n[{]: <helper> (diffStep \"1.5\" files=\"ChatsList.tsx\" module=\"client\")\n\n#### [__Client__ Step 1.5: Move ChatsList to a component](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/239691f25412d4f54f42ce2d87f4365e29cf7806)\n\n##### Added src&#x2F;components&#x2F;ChatsList.tsx\n```diff\n@@ -0,0 +1,22 @@\n+â”Š  â”Š 1â”Šimport React from 'react';\n+â”Š  â”Š 2â”Š\n+â”Š  â”Š 3â”Šconst ChatsList: React.FC = () => (\n+â”Š  â”Š 4â”Š  <div>\n+â”Š  â”Š 5â”Š    <ul>\n+â”Š  â”Š 6â”Š        <li>\n+â”Š  â”Š 7â”Š          <img src=\"https://randomuser.me/api/portraits/thumb/men/1.jpg\" alt=\"Profile\"/>\n+â”Š  â”Š 8â”Š          <div>Ethan Gonzalez</div>\n+â”Š  â”Š 9â”Š            <div>You on your way?</div>\n+â”Š  â”Š10â”Š            <div>10:25</div>\n+â”Š  â”Š11â”Š        </li>\n+â”Š  â”Š12â”Š        <li>\n+â”Š  â”Š13â”Š          <img src=\"https://randomuser.me/api/portraits/thumb/men/2.jpg\" alt=\"Profile\"/>\n+â”Š  â”Š14â”Š          <div>Bryan Wallace</div>\n+â”Š  â”Š15â”Š            <div>Hey, it's me</div>\n+â”Š  â”Š16â”Š            <div>13:27</div>\n+â”Š  â”Š17â”Š        </li>\n+â”Š  â”Š18â”Š    </ul>\n+â”Š  â”Š19â”Š  </div>\n+â”Š  â”Š20â”Š);\n+â”Š  â”Š21â”Š\n+â”Š  â”Š22â”Šexport default ChatsList;ðŸš«â†µ\n```\n\n[}]: #\n\nand let's import that component into the App component and use the shorter syntax for the functional component:\n\n[{]: <helper> (diffStep \"1.5\" files=\"App.tsx\" module=\"client\")\n\n#### [__Client__ Step 1.5: Move ChatsList to a component](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/239691f25412d4f54f42ce2d87f4365e29cf7806)\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -1,31 +1,13 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n+â”Š  â”Š 2â”Šimport ChatsList from './components/ChatsList';\n â”Š 2â”Š 3â”Š\n â”Š 3â”Š 4â”Šconst App: React.FC = () => {\n â”Š 4â”Š 5â”Š  return (\n â”Š 5â”Š 6â”Š    <div>\n-â”Š 6â”Š  â”Š      <div>Whatsapp Clone</div>\n â”Š 7â”Š 7â”Š      <div>\n-â”Š 8â”Š  â”Š        <ul>\n-â”Š 9â”Š  â”Š          <li>\n-â”Š10â”Š  â”Š            <img\n-â”Š11â”Š  â”Š              src=\"https://randomuser.me/api/portraits/thumb/men/1.jpg\"\n-â”Š12â”Š  â”Š              alt=\"Profile\"\n-â”Š13â”Š  â”Š            />\n-â”Š14â”Š  â”Š            <div>Ethan Gonzalez</div>\n-â”Š15â”Š  â”Š            <div>You on your way?</div>\n-â”Š16â”Š  â”Š            <div>10:25</div>\n-â”Š17â”Š  â”Š          </li>\n-â”Š18â”Š  â”Š          <li>\n-â”Š19â”Š  â”Š            <img\n-â”Š20â”Š  â”Š              src=\"https://randomuser.me/api/portraits/thumb/men/2.jpg\"\n-â”Š21â”Š  â”Š              alt=\"Profile\"\n-â”Š22â”Š  â”Š            />\n-â”Š23â”Š  â”Š            <div>Bryan Wallace</div>\n-â”Š24â”Š  â”Š            <div>Hey, it's me</div>\n-â”Š25â”Š  â”Š            <div>13:27</div>\n-â”Š26â”Š  â”Š          </li>\n-â”Š27â”Š  â”Š        </ul>\n+â”Š  â”Š 8â”Š        Whatsapp Clone\n â”Š28â”Š 9â”Š      </div>\n+â”Š  â”Š10â”Š      <ChatsList />\n â”Š29â”Š11â”Š    </div>\n â”Š30â”Š12â”Š  );\n â”Š31â”Š13â”Š};\n```\n\n[}]: #\n\nand let's do the same for our Navbar:\n\n[{]: <helper> (diffStep \"1.6\" module=\"client\")\n\n#### [__Client__ Step 1.6: Move ChatsNavbar to a component](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/6bfc354df157450d5ac8f62a37c0bcb0986beeae)\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -1,12 +1,11 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n â”Š 2â”Š 2â”Šimport ChatsList from './components/ChatsList';\n+â”Š  â”Š 3â”Šimport ChatsNavbar from './components/ChatsNavbar';\n â”Š 3â”Š 4â”Š\n â”Š 4â”Š 5â”Šconst App: React.FC = () => {\n â”Š 5â”Š 6â”Š  return (\n â”Š 6â”Š 7â”Š    <div>\n-â”Š 7â”Š  â”Š      <div>\n-â”Š 8â”Š  â”Š        Whatsapp Clone\n-â”Š 9â”Š  â”Š      </div>\n+â”Š  â”Š 8â”Š      <ChatsNavbar />\n â”Š10â”Š 9â”Š      <ChatsList />\n â”Š11â”Š10â”Š    </div>\n â”Š12â”Š11â”Š  );\n```\n\n##### Changed src&#x2F;components&#x2F;ChatsList.tsx\n```diff\n@@ -3,20 +3,26 @@\n â”Š 3â”Š 3â”Šconst ChatsList: React.FC = () => (\n â”Š 4â”Š 4â”Š  <div>\n â”Š 5â”Š 5â”Š    <ul>\n-â”Š 6â”Š  â”Š        <li>\n-â”Š 7â”Š  â”Š          <img src=\"https://randomuser.me/api/portraits/thumb/men/1.jpg\" alt=\"Profile\"/>\n-â”Š 8â”Š  â”Š          <div>Ethan Gonzalez</div>\n-â”Š 9â”Š  â”Š            <div>You on your way?</div>\n-â”Š10â”Š  â”Š            <div>10:25</div>\n-â”Š11â”Š  â”Š        </li>\n-â”Š12â”Š  â”Š        <li>\n-â”Š13â”Š  â”Š          <img src=\"https://randomuser.me/api/portraits/thumb/men/2.jpg\" alt=\"Profile\"/>\n-â”Š14â”Š  â”Š          <div>Bryan Wallace</div>\n-â”Š15â”Š  â”Š            <div>Hey, it's me</div>\n-â”Š16â”Š  â”Š            <div>13:27</div>\n-â”Š17â”Š  â”Š        </li>\n+â”Š  â”Š 6â”Š      <li>\n+â”Š  â”Š 7â”Š        <img\n+â”Š  â”Š 8â”Š          src=\"https://randomuser.me/api/portraits/thumb/men/1.jpg\"\n+â”Š  â”Š 9â”Š          alt=\"Profile\"\n+â”Š  â”Š10â”Š        />\n+â”Š  â”Š11â”Š        <div>Ethan Gonzalez</div>\n+â”Š  â”Š12â”Š        <div>You on your way?</div>\n+â”Š  â”Š13â”Š        <div>10:25</div>\n+â”Š  â”Š14â”Š      </li>\n+â”Š  â”Š15â”Š      <li>\n+â”Š  â”Š16â”Š        <img\n+â”Š  â”Š17â”Š          src=\"https://randomuser.me/api/portraits/thumb/men/2.jpg\"\n+â”Š  â”Š18â”Š          alt=\"Profile\"\n+â”Š  â”Š19â”Š        />\n+â”Š  â”Š20â”Š        <div>Bryan Wallace</div>\n+â”Š  â”Š21â”Š        <div>Hey, it's me</div>\n+â”Š  â”Š22â”Š        <div>13:27</div>\n+â”Š  â”Š23â”Š      </li>\n â”Š18â”Š24â”Š    </ul>\n â”Š19â”Š25â”Š  </div>\n â”Š20â”Š26â”Š);\n â”Š21â”Š27â”Š\n-â”Š22â”Š  â”Šexport default ChatsList;ðŸš«â†µ\n+â”Š  â”Š28â”Šexport default ChatsList;\n```\n\n##### Added src&#x2F;components&#x2F;ChatsNavbar.tsx\n```diff\n@@ -0,0 +1,5 @@\n+â”Š â”Š1â”Šimport React from 'react';\n+â”Š â”Š2â”Š\n+â”Š â”Š3â”Šconst ChatsNavbar: React.FC = () => <div>Whatsapp Clone</div>;\n+â”Š â”Š4â”Š\n+â”Š â”Š5â”Šexport default ChatsNavbar;\n```\n\n[}]: #\n\nReact apps tend to store React.Components under a directory located at `src/components`, and so we're gonna follow this pattern.\nWe will create a directory called ChatsListScreen in the `components` dir where we're simply gonna import and put together the Navbar and ChatsList components.\nThis is how the contents of that directory should look like:\n\n    ChatsListScreen\n    â”œâ”€â”€ index.tsx\n    â”œâ”€â”€ ChatsList\n    â””â”€â”€ ChatsNavbar\n\nWe will use the `index.tsx` file to define that component, this way we can import it using the directory name:\n\n[{]: <helper> (diffStep \"1.7\" module=\"client\")\n\n#### [__Client__ Step 1.7: Move all ChatsListScreen into a folder](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/105189dfd6e499ac0fd3fe4cb3b0ca0da8316aed)\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -1,14 +1,10 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n-â”Š 2â”Š  â”Šimport ChatsList from './components/ChatsList';\n-â”Š 3â”Š  â”Šimport ChatsNavbar from './components/ChatsNavbar';\n+â”Š  â”Š 2â”Šimport ChatsListScreen from './components/ChatsListScreen';\n â”Š 4â”Š 3â”Š\n-â”Š 5â”Š  â”Šconst App: React.FC = () => {\n-â”Š 6â”Š  â”Š  return (\n-â”Š 7â”Š  â”Š    <div>\n-â”Š 8â”Š  â”Š      <ChatsNavbar />\n-â”Š 9â”Š  â”Š      <ChatsList />\n-â”Š10â”Š  â”Š    </div>\n-â”Š11â”Š  â”Š  );\n-â”Š12â”Š  â”Š};\n+â”Š  â”Š 4â”Šconst App: React.FC = () => (\n+â”Š  â”Š 5â”Š  <div>\n+â”Š  â”Š 6â”Š    <ChatsListScreen />\n+â”Š  â”Š 7â”Š  </div>\n+â”Š  â”Š 8â”Š);\n â”Š13â”Š 9â”Š\n â”Š14â”Š10â”Šexport default App;\n```\n\n##### Renamed from src&#x2F;components&#x2F;ChatsList.tsx to src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n\n\n##### Renamed from src&#x2F;components&#x2F;ChatsNavbar.tsx to src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsNavbar.tsx\n\n\n##### Added src&#x2F;components&#x2F;ChatsListScreen&#x2F;index.tsx\n```diff\n@@ -0,0 +1,12 @@\n+â”Š  â”Š 1â”Šimport React from 'react';\n+â”Š  â”Š 2â”Šimport ChatsNavbar from './ChatsNavbar';\n+â”Š  â”Š 3â”Šimport ChatsList from './ChatsList';\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šconst ChatsListScreen: React.FC = () => (\n+â”Š  â”Š 6â”Š  <div>\n+â”Š  â”Š 7â”Š    <ChatsNavbar />\n+â”Š  â”Š 8â”Š    <ChatsList />\n+â”Š  â”Š 9â”Š  </div>\n+â”Š  â”Š10â”Š);\n+â”Š  â”Š11â”Š\n+â”Š  â”Š12â”Šexport default ChatsListScreen;\n```\n\n[}]: #\n\nNow, we have our app rendering our view, but it is completely static and manual in the code.\n\nIf we had 10 messages, we wouldn't want to type all of those HTML tags again and again.\nAlso if the data will change, the app should do this update itself without the need of hand written code.\n\nSo let's create a file that lists just the data of our chats and then make our React component render a line for each entry in that file.\n\nWe will create the file in a JSON format:\n\n[{]: <helper> (diffStep \"1.8\" files=\"db.ts\" module=\"client\")\n\n#### [__Client__ Step 1.8: Attach unique keys to ChatsList](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/764a7968450531f959a7fe1a6f1e902a3b08574c)\n\n##### Added src&#x2F;db.ts\n```diff\n@@ -0,0 +1,49 @@\n+â”Š  â”Š 1â”Šexport const messages = [\n+â”Š  â”Š 2â”Š  {\n+â”Š  â”Š 3â”Š    id: '1',\n+â”Š  â”Š 4â”Š    content: 'You on your way?',\n+â”Š  â”Š 5â”Š    createdAt: new Date(Date.now() - 60 * 1000 * 1000),\n+â”Š  â”Š 6â”Š  },\n+â”Š  â”Š 7â”Š  {\n+â”Š  â”Š 8â”Š    id: '2',\n+â”Š  â”Š 9â”Š    content: \"Hey, it's me\",\n+â”Š  â”Š10â”Š    createdAt: new Date(Date.now() - 2 * 60 * 1000 * 1000),\n+â”Š  â”Š11â”Š  },\n+â”Š  â”Š12â”Š  {\n+â”Š  â”Š13â”Š    id: '3',\n+â”Š  â”Š14â”Š    content: 'I should buy a boat',\n+â”Š  â”Š15â”Š    createdAt: new Date(Date.now() - 24 * 60 * 1000 * 1000),\n+â”Š  â”Š16â”Š  },\n+â”Š  â”Š17â”Š  {\n+â”Š  â”Š18â”Š    id: '4',\n+â”Š  â”Š19â”Š    content: 'This is wicked good ice cream.',\n+â”Š  â”Š20â”Š    createdAt: new Date(Date.now() - 14 * 24 * 60 * 1000 * 1000),\n+â”Š  â”Š21â”Š  },\n+â”Š  â”Š22â”Š];\n+â”Š  â”Š23â”Š\n+â”Š  â”Š24â”Šexport const chats = [\n+â”Š  â”Š25â”Š  {\n+â”Š  â”Š26â”Š    id: '1',\n+â”Š  â”Š27â”Š    name: 'Ethan Gonzalez',\n+â”Š  â”Š28â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n+â”Š  â”Š29â”Š    lastMessage: messages.find(m => m.id === '1'),\n+â”Š  â”Š30â”Š  },\n+â”Š  â”Š31â”Š  {\n+â”Š  â”Š32â”Š    id: '2',\n+â”Š  â”Š33â”Š    name: 'Bryan Wallace',\n+â”Š  â”Š34â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n+â”Š  â”Š35â”Š    lastMessage: messages.find(m => m.id === '2'),\n+â”Š  â”Š36â”Š  },\n+â”Š  â”Š37â”Š  {\n+â”Š  â”Š38â”Š    id: '3',\n+â”Š  â”Š39â”Š    name: 'Avery Stewart',\n+â”Š  â”Š40â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n+â”Š  â”Š41â”Š    lastMessage: messages.find(m => m.id === '3'),\n+â”Š  â”Š42â”Š  },\n+â”Š  â”Š43â”Š  {\n+â”Š  â”Š44â”Š    id: '4',\n+â”Š  â”Š45â”Š    name: 'Katie Peterson',\n+â”Š  â”Š46â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n+â”Š  â”Š47â”Š    lastMessage: messages.find(m => m.id === '4'),\n+â”Š  â”Š48â”Š  },\n+â”Š  â”Š49â”Š];\n```\n\n[}]: #\n\nWe are giving IDs for the values just like a database gives a unique id for each value.\n\nThis is so we can reference specific values, for example,\nlast message would actually reference the other array instead of duplicating the values.\n\nNow let's change ChatsList component to import the data from that file.\nThen to use the Javascript [map](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/map)\nfunction to render a line for each data entry:\n\n[{]: <helper> (diffStep \"1.8\" files=\"ChatsList.tsx\" module=\"client\")\n\n#### [__Client__ Step 1.8: Attach unique keys to ChatsList](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/764a7968450531f959a7fe1a6f1e902a3b08574c)\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -1,26 +1,15 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n+â”Š  â”Š 2â”Šimport { chats } from '../../db';\n â”Š 2â”Š 3â”Š\n â”Š 3â”Š 4â”Šconst ChatsList: React.FC = () => (\n â”Š 4â”Š 5â”Š  <div>\n â”Š 5â”Š 6â”Š    <ul>\n-â”Š 6â”Š  â”Š      <li>\n-â”Š 7â”Š  â”Š        <img\n-â”Š 8â”Š  â”Š          src=\"https://randomuser.me/api/portraits/thumb/men/1.jpg\"\n-â”Š 9â”Š  â”Š          alt=\"Profile\"\n-â”Š10â”Š  â”Š        />\n-â”Š11â”Š  â”Š        <div>Ethan Gonzalez</div>\n-â”Š12â”Š  â”Š        <div>You on your way?</div>\n-â”Š13â”Š  â”Š        <div>10:25</div>\n-â”Š14â”Š  â”Š      </li>\n-â”Š15â”Š  â”Š      <li>\n-â”Š16â”Š  â”Š        <img\n-â”Š17â”Š  â”Š          src=\"https://randomuser.me/api/portraits/thumb/men/2.jpg\"\n-â”Š18â”Š  â”Š          alt=\"Profile\"\n-â”Š19â”Š  â”Š        />\n-â”Š20â”Š  â”Š        <div>Bryan Wallace</div>\n-â”Š21â”Š  â”Š        <div>Hey, it's me</div>\n-â”Š22â”Š  â”Š        <div>13:27</div>\n-â”Š23â”Š  â”Š      </li>\n+â”Š  â”Š 7â”Š      {chats.map(chat => (\n+â”Š  â”Š 8â”Š        <li key={chat.id}>\n+â”Š  â”Š 9â”Š          <img src={chat.picture} alt=\"Profile\" />\n+â”Š  â”Š10â”Š          <div>{chat.name}</div>\n+â”Š  â”Š11â”Š        </li>\n+â”Š  â”Š12â”Š      ))}\n â”Š24â”Š13â”Š    </ul>\n â”Š25â”Š14â”Š  </div>\n â”Š26â”Š15â”Š);\n```\n\n[}]: #\n\nWhen running `map` on the `chats` array, it will run a function for each entry in the array and return a value.\nThe function will receive the current entry as a parameter.\nIn our case the function will get the current function and will return a JSX line with the data of that specific chat.\n\nNotice we are also adding the `key` tag with the ID of each chat.\nIf you'll remove that and render again you will see the following error inside the console of your [Chrome developer tools](https://developers.google.com/web/tools/chrome-devtools/):\n`Warning: Each child in a list should have a unique \"key\" prop`.\n\nBy telling React how to identify and distinguish each element using the `key` value we help solve that problem and also making React faster.\nRead [here](https://reactjs.org/docs/lists-and-keys.html) for more in depth explanation.\n\nNow that we've rendered a line for each chat, let's add also the last message's content and creation date for each chat:\n\n[{]: <helper> (diffStep \"1.9\" module=\"client\")\n\n#### [__Client__ Step 1.9: Failed try to add last message to ChatsList](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/e1e7f8ece37a4713bb603d7b159229d4459536e3)\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -8,6 +8,8 @@\n â”Š 8â”Š 8â”Š        <li key={chat.id}>\n â”Š 9â”Š 9â”Š          <img src={chat.picture} alt=\"Profile\" />\n â”Š10â”Š10â”Š          <div>{chat.name}</div>\n+â”Š  â”Š11â”Š          <div>{chat.lastMessage.content}</div>\n+â”Š  â”Š12â”Š          <div>{chat.lastMessage.createdAt}</div>\n â”Š11â”Š13â”Š        </li>\n â”Š12â”Š14â”Š      ))}\n â”Š13â”Š15â”Š    </ul>\n```\n\n[}]: #\n\nTry to run the app again.\n\nYou can see we get a Typescript error.\nThis is because Typescript is smart enough and tells us there might be no last message.\nSo we add a check.\nRemember to always check for null or undefined if optional, donâ€™t write shorter write safer:\n\n[{]: <helper> (diffStep \"1.10\" module=\"client\")\n\n#### [__Client__ Step 1.10: Second failed try to add last message to ChatsList](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/bf6bc55de6098f41a94298ac714270d7e278cd43)\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -8,8 +8,10 @@\n â”Š 8â”Š 8â”Š        <li key={chat.id}>\n â”Š 9â”Š 9â”Š          <img src={chat.picture} alt=\"Profile\" />\n â”Š10â”Š10â”Š          <div>{chat.name}</div>\n+â”Š  â”Š11â”Š          {chat.lastMessage && (\n â”Š11â”Š12â”Š          <div>{chat.lastMessage.content}</div>\n â”Š12â”Š13â”Š          <div>{chat.lastMessage.createdAt}</div>\n+â”Š  â”Š14â”Š          )}\n â”Š13â”Š15â”Š        </li>\n â”Š14â”Š16â”Š      ))}\n â”Š15â”Š17â”Š    </ul>\n```\n\n[}]: #\n\nNow let's try again.\n\nNow we have a syntax error - A JSX return value can't have more then a single root Element.\nSo in order to return a root element from the function but still display multiple elements in the same level,\nwe can use [React.Fragment](https://reactjs.org/docs/fragments.html) to wrap the returned elements:\n\n[{]: <helper> (diffStep \"1.11\" module=\"client\")\n\n#### [__Client__ Step 1.11: Third failed try to add last message to ChatsList](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/1246f4dcaa98cdf968b6a548b04cfbb5bbb62762)\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -9,8 +9,10 @@\n â”Š 9â”Š 9â”Š          <img src={chat.picture} alt=\"Profile\" />\n â”Š10â”Š10â”Š          <div>{chat.name}</div>\n â”Š11â”Š11â”Š          {chat.lastMessage && (\n-â”Š12â”Š  â”Š          <div>{chat.lastMessage.content}</div>\n-â”Š13â”Š  â”Š          <div>{chat.lastMessage.createdAt}</div>\n+â”Š  â”Š12â”Š            <React.Fragment>\n+â”Š  â”Š13â”Š              <div>{chat.lastMessage.content}</div>\n+â”Š  â”Š14â”Š              <div>{chat.lastMessage.createdAt}</div>\n+â”Š  â”Š15â”Š            </React.Fragment>\n â”Š14â”Š16â”Š          )}\n â”Š15â”Š17â”Š        </li>\n â”Š16â”Š18â”Š      ))}\n```\n\n[}]: #\n\n\nLet's try again.  This time it looks like the format is not correct, so let's format the date using the `moment` library.\n\nLet's install the [`moment`](https://momentjs.com/) library to wrap `lastMessage.createdAt` with a better format.\nMoment has the ability to wrap date objects nicely and rewrite them in a pretty format.\nThis way we can have an elegant time format at which the message was sent e.g. `11:34`.\nTo install:\n\n\t$ yarn add moment\n\n\nAnd now let's import the library by it's name, wrap the value of each chat and call the `format` function with our requested format:\n\n[{]: <helper> (diffStep \"1.12\" files=\"ChatsList.tsx\" module=\"client\")\n\n#### [__Client__ Step 1.12: Success adding last message to ChatsList](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/6b332cbc0ee36aa2fb9715847ce49a4a8cd4e1d0)\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -1,5 +1,6 @@\n â”Š1â”Š1â”Šimport React from 'react';\n â”Š2â”Š2â”Šimport { chats } from '../../db';\n+â”Š â”Š3â”Šimport moment from 'moment';\n â”Š3â”Š4â”Š\n â”Š4â”Š5â”Šconst ChatsList: React.FC = () => (\n â”Š5â”Š6â”Š  <div>\n```\n```diff\n@@ -11,7 +12,7 @@\n â”Š11â”Š12â”Š          {chat.lastMessage && (\n â”Š12â”Š13â”Š            <React.Fragment>\n â”Š13â”Š14â”Š              <div>{chat.lastMessage.content}</div>\n-â”Š14â”Š  â”Š              <div>{chat.lastMessage.createdAt}</div>\n+â”Š  â”Š15â”Š              <div>{moment(chat.lastMessage.createdAt).format('HH:mm')}</div>\n â”Š15â”Š16â”Š            </React.Fragment>\n â”Š16â”Š17â”Š          )}\n â”Š17â”Š18â”Š        </li>\n```\n\n[}]: #\n\n\nIf you'll try to run the app you'll see that everything is there, but it's not hard to notice that it's missing some style:\n\n![naked-chats-list](https://user-images.githubusercontent.com/7648874/54028578-73099b80-41e0-11e9-803a-7469300acb06.png)\n\nIn the next chapter we will take care of styling our application with [Material-UI](https://material-ui.com/) and [styled-components](https://www.styled-components.com/) - we will give it the desired look and make it more user friendly. For now the ChatsListScreen serves no purpose, because you can't really do anything with it, but it can be used as a great basis to build on top of as we make progress.\n\nTODO: Define and use Prettier.\nTODO: Editor and Prettier, extensions - Auto Import, GitLens, npm Intellisense, TypeScript Importer - works when Auto Import doesn't\nTODO: react-dev-tools, go through everything on dev tools.\nTODO: build. show built code. show it on file and show it on the browser.\nTODO: Go through all of https://facebook.github.io/create-react-app/docs/\nTODO: Should we talk about Storybook?\nTODO: Should we use â€œâ€ or â€˜â€™?\nTODO: Should we use date-fns instead of moment?"
          },
          {
            "manualTitle": "Step 2: Styling with Material UI and styled-components",
            "stepRevision": "c68db2f5bf767e3c80af2ec45ac788158c4a3cf3",
            "manualView": "Now it's time to style our app.\n\nWe can edit styles manually but we can also use ready made components that have already been styled and shared in the community.\n\nIn this chapter we will do both.\n\nFirst, we would also use [Material-UI](https://material-ui.com/) - a library with a set of React components that implements Google's Material Design.\nWhat's good about it is that the design is already implemented right out of the box.\nNot only that, but it also includes a set of icons which are free to use.\n\nThere are many things that Material-UI can offer, and it's not easy to follow it up, especially with the constantly evolving and improving API.\nThe best way to go with it, is to identify a component you need, and then look for it in the [official website](https://material-ui.com/).\nAnd when it comes to searching for icons, they can be found on the [material.io](https://material-ui.com/) website through the search bar.\n\nAs we move further in this tutorial you should have a better grasp of Material and how to use it.\n\n![material-ui-icons](https://user-images.githubusercontent.com/7648874/54141504-c853e000-4460-11e9-94b5-aae98ec9a1e3.png)\n\nWe will start off by installing some of the needed material libraries and its Typescript types library:\n\n    $ yarn add @material-ui/core @material-ui/icons\n\n`@material-ui/core` includes core component of Material-UI such as Input, Popover, Modal, etc, and `@material-ui/icons` includes a set of icons.\nMaterial is very generic and has a built in theming system which can be controlled by simply setting few variables,\nwhich is exactly what we're gonna need in our app.\n\nIn our app we're mainly gonna use 2 colors:\n\n- Primary #306759\n- Secondary #79e352\n\nThe easiest way to reference colors without repeating yourself is through Themes.\nTheme definition can easily be done in Material using the MuiThemeProvider component:\n\n[{]: <helper> (diffStep \"2.2\" module=\"client\")\n\n#### [__Client__ Step 2.2: Setup Material-UI theme](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/ad59ed1e2566ce51f9962027e9f1ab249461d4ed)\n\n##### Changed src&#x2F;index.tsx\n```diff\n@@ -1,10 +1,23 @@\n+â”Š  â”Š 1â”Šimport { MuiThemeProvider, createMuiTheme } from '@material-ui/core/styles';\n â”Š 1â”Š 2â”Šimport React from 'react';\n â”Š 2â”Š 3â”Šimport ReactDOM from 'react-dom';\n â”Š 3â”Š 4â”Šimport './index.css';\n â”Š 4â”Š 5â”Šimport App from './App';\n â”Š 5â”Š 6â”Šimport * as serviceWorker from './serviceWorker';\n â”Š 6â”Š 7â”Š\n-â”Š 7â”Š  â”ŠReactDOM.render(<App />, document.getElementById('root'));\n+â”Š  â”Š 8â”Šconst theme = createMuiTheme({\n+â”Š  â”Š 9â”Š  palette: {\n+â”Š  â”Š10â”Š    primary: { main: '#2c6157' },\n+â”Š  â”Š11â”Š    secondary: { main: '#6fd056' },\n+â”Š  â”Š12â”Š  },\n+â”Š  â”Š13â”Š});\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”ŠReactDOM.render(\n+â”Š  â”Š16â”Š  <MuiThemeProvider theme={theme}>\n+â”Š  â”Š17â”Š    <App />\n+â”Š  â”Š18â”Š  </MuiThemeProvider>,\n+â”Š  â”Š19â”Š  document.getElementById('root')\n+â”Š  â”Š20â”Š);\n â”Š 8â”Š21â”Š\n â”Š 9â”Š22â”Š// If you want your app to work offline and load faster, you can change\n â”Š10â”Š23â”Š// unregister() to register() below. Note this comes with some pitfalls.\n```\n\n[}]: #\n\n\nWe create a `palette` of the themes together with any other definitions for the theme, and then we wrap our app with a React component\nfrom the `material-ui` library to provide those definitions to all of our App's components when they need them.\n\nOnce we have it set, the colors should be available to use in our application by simply providing the \"color\" prop to the component instance whose color we would like to change:\n\n```diff\n<Button color=\"primary\">Primary</Button>\n<Button color=\"secondary\">Secondary</Button>\n```\n\nIn our app, we're also gonna use CSS directly to change its colors, therefore it would be handy to have these theme variables available to us through CSS.\nTo do so, we will have a second definition of these variables in `index.css`, at the `:root` level of our application.\n\nThat feels like a small duplication but this will help us use them in styled components directly.\nAlso that means you can view the variables in chrome-dev-tools.\n\n[{]: <helper> (diffStep \"2.3\" module=\"client\")\n\n#### [__Client__ Step 2.3: Setup CSS theme vars](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/99c78d284576c73adb00a22c3d1cb0401ad0fc7f)\n\n##### Changed src&#x2F;index.css\n```diff\n@@ -1,3 +1,10 @@\n+â”Š  â”Š 1â”Š:root {\n+â”Š  â”Š 2â”Š  --primary-bg: #2c6157;\n+â”Š  â”Š 3â”Š  --secondary-bg: #6fd056;\n+â”Š  â”Š 4â”Š  --primary-text: white;\n+â”Š  â”Š 5â”Š  --secondary-text: white;\n+â”Š  â”Š 6â”Š}\n+â”Š  â”Š 7â”Š\n â”Š 1â”Š 8â”Šbody {\n â”Š 2â”Š 9â”Š  margin: 0;\n â”Š 3â”Š10â”Š  padding: 0;\n```\n\n[}]: #\n\n`:root` is a pseudo element that simply represents the root node, which will make the colors available in all elements.\nNormally, it works like JavaScript's scoping system and it will make variables available only to the current node and to its children, NOT its parents.\nCSS vars can be used like so:\n\n```css\n  color: var(--primary-text);\n  background-color: var(--primary-bg);\n```\n\nMore information about CSS variables can be found in the [official MDN docs](https://developer.mozilla.org/en-US/docs/Web/CSS/Using_CSS_variables).\n\nSo getting back to the ChatsListScreen, we will wrap the ChatsNavbar with Material's <Toolbar /> component:\n\n[{]: <helper> (diffStep \"2.4\" files=\"ChatsNavbar.tsx\" module=\"client\")\n\n#### [__Client__ Step 2.4: Use Material components](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/9ecc9c1124efdea938c7e579aa5ac76d15d542a8)\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsNavbar.tsx\n```diff\n@@ -1,5 +1,6 @@\n â”Š1â”Š1â”Šimport React from 'react';\n+â”Š â”Š2â”Šimport { Toolbar } from '@material-ui/core';\n â”Š2â”Š3â”Š\n-â”Š3â”Š â”Šconst ChatsNavbar: React.FC = () => <div>Whatsapp Clone</div>;\n+â”Š â”Š4â”Šconst ChatsNavbar: React.FC = () => <Toolbar>Whatsapp Clone</Toolbar>;\n â”Š4â”Š5â”Š\n â”Š5â”Š6â”Šexport default ChatsNavbar;\n```\n\n[}]: #\n\nAnd we will replace the `<ul />` and `<li />` elements with Material's `<List />` and `<ListItem />` in ChatsList:\n\n[{]: <helper> (diffStep \"2.4\" files=\"ChatsList.tsx\" module=\"client\")\n\n#### [__Client__ Step 2.4: Use Material components](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/9ecc9c1124efdea938c7e579aa5ac76d15d542a8)\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -1,12 +1,13 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n â”Š 2â”Š 2â”Šimport { chats } from '../../db';\n â”Š 3â”Š 3â”Šimport moment from 'moment';\n+â”Š  â”Š 4â”Šimport { List, ListItem } from '@material-ui/core';\n â”Š 4â”Š 5â”Š\n â”Š 5â”Š 6â”Šconst ChatsList: React.FC = () => (\n â”Š 6â”Š 7â”Š  <div>\n-â”Š 7â”Š  â”Š    <ul>\n+â”Š  â”Š 8â”Š    <List>\n â”Š 8â”Š 9â”Š      {chats.map(chat => (\n-â”Š 9â”Š  â”Š        <li key={chat.id}>\n+â”Š  â”Š10â”Š        <ListItem key={chat.id} button>\n â”Š10â”Š11â”Š          <img src={chat.picture} alt=\"Profile\" />\n â”Š11â”Š12â”Š          <div>{chat.name}</div>\n â”Š12â”Š13â”Š          {chat.lastMessage && (\n```\n```diff\n@@ -15,9 +16,9 @@\n â”Š15â”Š16â”Š              <div>{moment(chat.lastMessage.createdAt).format('HH:mm')}</div>\n â”Š16â”Š17â”Š            </React.Fragment>\n â”Š17â”Š18â”Š          )}\n-â”Š18â”Š  â”Š        </li>\n+â”Š  â”Š19â”Š        </ListItem>\n â”Š19â”Š20â”Š      ))}\n-â”Š20â”Š  â”Š    </ul>\n+â”Š  â”Š21â”Š    </List>\n â”Š21â”Š22â”Š  </div>\n â”Š22â”Š23â”Š);\n â”Š23â”Š24â”Š\n```\n\n[}]: #\n\nThanks to the `button` attribute, the Material component can give our list a more vibrant feeling and that will display a nice ripple effect once an item is clicked,\nsomething that could have taken a long time to implement manually.\n\nNow that we are using existing styled components, it's time to customize them to look exactly like we want them to look.\nWhen we write styles, we usually use CSS.\n\nOne of the important concepts that React brought us was the fact we could use just Javascript to describe our components\nand another was the fact that we could encapsulate our UI into a set of separated components.\n\nBut when it comes to CSS, we are still using it like before, having no encapsulation between different definitions and files.\n\n[Styled-components](https://www.styled-components.com/) is a relatively new library that will transpile a given string into a CSS string and will encapsulate it under a `React.Component`.\nBringing the same concepts from React into the way we write styles, so we can define our styles programmatically.\nWith JavaScript in-hand you naturally have more control over our styles and its encapsulation, which makes it a very powerful tool.\n\nHere's one way to style a button using styled-components:\n\n```js\nimport styled, { css } from 'styled-components';\n\nconst Button = styled.button`\n  background: transparent;\n  border-radius: 3px;\n  border: 2px solid palevioletred;\n  color: palevioletred;\n  margin: 0.5em 1em;\n  padding: 0.25em 1em;\n\n  ${props => props.primary && css`\n    background: palevioletred;\n    color: white;\n  `}\n`;\n```\n\n* `styled` is coming from the `styled-components` library. When we call `styled.button` that means we are extending a button component from styled.\n* `Button` will become a full React componnet with the extended styled we specified\n* Like a React component, we can send props into our component. And like a React function, we can write Javascript code that interact and respond to those props.\nIn our case, just like a check we've done before in TSX to render something only if it exists, here only if we have a `primary` property, we will add extra styles to our component.\nThe created Button is actually a React.Component, so an instance of it can be created with ease like any other component:\n* `css` is telling Styled components that the string literal that comes after describes CSS styles.\n\n```jsx\n  <Button primary />\n```\n\nBut as this is just like a component, we should type it just like we type component, defining what properties it should get in:\n\n```tsx\nimport styled, { css } from 'styled-components';\n\ninterface ButtonProps {\n  readonly primary: any;\n};\n\nconst Button = styled.button<ButtonProps>`\n  background: transparent;\n  border-radius: 3px;\n  border: 2px solid palevioletred;\n  color: palevioletred;\n  margin: 0.5em 1em;\n  padding: 0.25em 1em;\n\n  ${props => props.primary && css`\n    background: palevioletred;\n    color: white;\n  `}\n`;\n```\n\nMore information about styled-components can be found in the official [docs page](https://www.styled-components.com/docs).\n\nNow, we will use `styled-components` to create new React.Components which are bound into a style-sheet.\nThis way when we create new instances of them, the components will be styled right out of the box. Example:\n\n```jsx\nconst Button = styled.button `\n  border-radius: 999px;\n`\n\nconst RedButton = styled(Button) `\n  color: red;\n`\n\nconst GreenButton = styled(Button) `\n  color: green;\n`\n\nconst BlueButton = styled(Button) `\n  color: blue;\n`\n\nconst Dashboard = (\n  <div>\n    <RedButton />\n    <GreenButton />\n    <BlueButton />\n  </div>\n)\n```\n\nThe clear advantage of such working strategy is that all the styles are encapsulated, unlike traditional CSS where style rules can easily collide and be merged unintentionally.\nRemember that **`styled-components` operates per component, not globally**.\n\nWe will start off by installing `styled-components` and its Typescript types library:\n\n    $ yarn add styled-components @types/styled-components\n\nNow, let's use `styled-components` our `ChatsListScreen`:\n\n[{]: <helper> (diffStep \"2.5\" files=\"index.tsx\" module=\"client\")\n\n#### [__Client__ Step 2.5: Add style with styled-components](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/33e81b5dddf16944bd37a7f20372bcef98e57cb4)\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;index.tsx\n```diff\n@@ -1,12 +1,17 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n â”Š 2â”Š 2â”Šimport ChatsNavbar from './ChatsNavbar';\n â”Š 3â”Š 3â”Šimport ChatsList from './ChatsList';\n+â”Š  â”Š 4â”Šimport styled from 'styled-components';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šconst Container = styled.div`\n+â”Š  â”Š 7â”Š  height: 100vh;\n+â”Š  â”Š 8â”Š`;\n â”Š 4â”Š 9â”Š\n â”Š 5â”Š10â”Šconst ChatsListScreen: React.FC = () => (\n-â”Š 6â”Š  â”Š  <div>\n+â”Š  â”Š11â”Š  <Container>\n â”Š 7â”Š12â”Š    <ChatsNavbar />\n â”Š 8â”Š13â”Š    <ChatsList />\n-â”Š 9â”Š  â”Š  </div>\n+â”Š  â”Š14â”Š  </Container>\n â”Š10â”Š15â”Š);\n â”Š11â”Š16â”Š\n â”Š12â”Š17â”Šexport default ChatsListScreen;\n```\n\n[}]: #\n\nHere you can see that we've created a new component called `Container`.\nThat component is extending `div` and adds some styles into it.\nThen we've replaced the `div` element with the new, enhanced `div` called `Container`.\n\nWith this we know for sure that the styles we applied for `Container` won't affect any other component in our app.\n\n[{]: <helper> (diffStep \"2.5\" files=\"ChatsNavbar.tsx\" module=\"client\")\n\n#### [__Client__ Step 2.5: Add style with styled-components](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/33e81b5dddf16944bd37a7f20372bcef98e57cb4)\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsNavbar.tsx\n```diff\n@@ -1,6 +1,14 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n â”Š 2â”Š 2â”Šimport { Toolbar } from '@material-ui/core';\n+â”Š  â”Š 3â”Šimport styled from 'styled-components';\n â”Š 3â”Š 4â”Š\n-â”Š 4â”Š  â”Šconst ChatsNavbar: React.FC = () => <Toolbar>Whatsapp Clone</Toolbar>;\n+â”Š  â”Š 5â”Šconst Container = styled(Toolbar)`\n+â”Š  â”Š 6â”Š  background-color: var(--primary-bg);\n+â”Š  â”Š 7â”Š  color: var(--primary-text);\n+â”Š  â”Š 8â”Š  font-size: 20px;\n+â”Š  â”Š 9â”Š  line-height: 40px;\n+â”Š  â”Š10â”Š`;\n+â”Š  â”Š11â”Š\n+â”Š  â”Š12â”Šconst ChatsNavbar: React.FC = () => <Container>Whatsapp Clone</Container>;\n â”Š 5â”Š13â”Š\n â”Š 6â”Š14â”Šexport default ChatsNavbar;\n```\n\n[}]: #\n\nHere you can see we've done the same, but instead of extending a built-in component from styled-component,\nwe enhanced the `Toolbar` component from `material-ui.\n\nNotice that we also called the wrapper `Container` but again it has no affect on any component outside of our specific component.\n\n> Notice that we've added Typescript type inference `as typeof Toolbar` at the end. That's because of an issue that suppose to be fixed when we'll upgrade to material-ui v4.\n\nLet's finish this off by doing the same in our last component:\n\n[{]: <helper> (diffStep \"2.5\" files=\"ChatsList.tsx\" module=\"client\")\n\n#### [__Client__ Step 2.5: Add style with styled-components](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/33e81b5dddf16944bd37a7f20372bcef98e57cb4)\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -2,24 +2,81 @@\n â”Š 2â”Š 2â”Šimport { chats } from '../../db';\n â”Š 3â”Š 3â”Šimport moment from 'moment';\n â”Š 4â”Š 4â”Šimport { List, ListItem } from '@material-ui/core';\n+â”Š  â”Š 5â”Šimport styled from 'styled-components';\n â”Š 5â”Š 6â”Š\n-â”Š 6â”Š  â”Šconst ChatsList: React.FC = () => (\n-â”Š 7â”Š  â”Š  <div>\n-â”Š 8â”Š  â”Š    <List>\n+â”Š  â”Š 7â”Šconst Container = styled.div`\n+â”Š  â”Š 8â”Š  height: calc(100% - 56px);\n+â”Š  â”Š 9â”Š  overflow-y: overlay;\n+â”Š  â”Š10â”Š`;\n+â”Š  â”Š11â”Š\n+â”Š  â”Š12â”Šconst StyledList = styled(List)`\n+â”Š  â”Š13â”Š  padding: 0 !important;\n+â”Š  â”Š14â”Š`;\n+â”Š  â”Š15â”Š\n+â”Š  â”Š16â”Šconst StyledListItem = styled(ListItem)`\n+â”Š  â”Š17â”Š  height: 76px;\n+â”Š  â”Š18â”Š  padding: 0 15px;\n+â”Š  â”Š19â”Š  display: flex;\n+â”Š  â”Š20â”Š`;\n+â”Š  â”Š21â”Š\n+â”Š  â”Š22â”Šconst ChatPicture = styled.img`\n+â”Š  â”Š23â”Š  height: 50px;\n+â”Š  â”Š24â”Š  width: 50px;\n+â”Š  â”Š25â”Š  object-fit: cover;\n+â”Š  â”Š26â”Š  border-radius: 50%;\n+â”Š  â”Š27â”Š`;\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Šconst ChatInfo = styled.div`\n+â”Š  â”Š30â”Š  width: calc(100% - 60px);\n+â”Š  â”Š31â”Š  height: 46px;\n+â”Š  â”Š32â”Š  padding: 15px 0;\n+â”Š  â”Š33â”Š  margin-left: 10px;\n+â”Š  â”Š34â”Š  border-bottom: 0.5px solid silver;\n+â”Š  â”Š35â”Š  position: relative;\n+â”Š  â”Š36â”Š`;\n+â”Š  â”Š37â”Š\n+â”Š  â”Š38â”Šconst ChatName = styled.div`\n+â”Š  â”Š39â”Š  margin-top: 5px;\n+â”Š  â”Š40â”Š`;\n+â”Š  â”Š41â”Š\n+â”Š  â”Š42â”Šconst MessageContent = styled.div`\n+â”Š  â”Š43â”Š  color: gray;\n+â”Š  â”Š44â”Š  font-size: 15px;\n+â”Š  â”Š45â”Š  margin-top: 5px;\n+â”Š  â”Š46â”Š  text-overflow: ellipsis;\n+â”Š  â”Š47â”Š  overflow: hidden;\n+â”Š  â”Š48â”Š  white-space: nowrap;\n+â”Š  â”Š49â”Š`;\n+â”Š  â”Š50â”Š\n+â”Š  â”Š51â”Šconst MessageDate = styled.div`\n+â”Š  â”Š52â”Š  position: absolute;\n+â”Š  â”Š53â”Š  color: gray;\n+â”Š  â”Š54â”Š  top: 20px;\n+â”Š  â”Š55â”Š  right: 0;\n+â”Š  â”Š56â”Š  font-size: 13px;\n+â”Š  â”Š57â”Š`;\n+â”Š  â”Š58â”Š\n+â”Š  â”Š59â”Šconst ChatsList = () => (\n+â”Š  â”Š60â”Š  <Container>\n+â”Š  â”Š61â”Š    <StyledList>\n â”Š 9â”Š62â”Š      {chats.map(chat => (\n-â”Š10â”Š  â”Š        <ListItem key={chat.id} button>\n-â”Š11â”Š  â”Š          <img src={chat.picture} alt=\"Profile\" />\n-â”Š12â”Š  â”Š          <div>{chat.name}</div>\n-â”Š13â”Š  â”Š          {chat.lastMessage && (\n-â”Š14â”Š  â”Š            <React.Fragment>\n-â”Š15â”Š  â”Š              <div>{chat.lastMessage.content}</div>\n-â”Š16â”Š  â”Š              <div>{moment(chat.lastMessage.createdAt).format('HH:mm')}</div>\n-â”Š17â”Š  â”Š            </React.Fragment>\n-â”Š18â”Š  â”Š          )}\n-â”Š19â”Š  â”Š        </ListItem>\n+â”Š  â”Š63â”Š        <StyledListItem key={chat.id} button>\n+â”Š  â”Š64â”Š          <ChatPicture src={chat.picture} alt=\"Profile\" />\n+â”Š  â”Š65â”Š          <ChatInfo>\n+â”Š  â”Š66â”Š            <ChatName>{chat.name}</ChatName>\n+â”Š  â”Š67â”Š            {chat.lastMessage && (\n+â”Š  â”Š68â”Š              <React.Fragment>\n+â”Š  â”Š69â”Š                <MessageContent>{chat.lastMessage.content}</MessageContent>\n+â”Š  â”Š70â”Š                <MessageDate>\n+â”Š  â”Š71â”Š                  {moment(chat.lastMessage.createdAt).format('HH:mm')}\n+â”Š  â”Š72â”Š                </MessageDate>\n+â”Š  â”Š73â”Š              </React.Fragment>\n+â”Š  â”Š74â”Š            )}\n+â”Š  â”Š75â”Š          </ChatInfo>\n+â”Š  â”Š76â”Š        </StyledListItem>\n â”Š20â”Š77â”Š      ))}\n-â”Š21â”Š  â”Š    </List>\n-â”Š22â”Š  â”Š  </div>\n+â”Š  â”Š78â”Š    </StyledList>\n+â”Š  â”Š79â”Š  </Container>\n â”Š23â”Š80â”Š);\n â”Š24â”Š81â”Š\n â”Š25â”Š82â”Šexport default ChatsList;\n```\n\n[}]: #\n\nNotice that we've changed the structure of the HTML of the `ChatsList` component.\nWe've added the ChatInfo to allow better alignment of the elements.\n\nWe're done styling `ChatsListScreen`. We will keep using the same principles to style the rest of the components in our application. The final result should look like so:\n\n![screenshot](https://user-images.githubusercontent.com/7648874/54141766-40baa100-4461-11e9-8dd0-59edcfdb3b84.png)\n\n\nTODO: What do people think about https://www.styled-components.com/docs/tooling#babel-plugin, should we use it here?"
          },
          {
            "manualTitle": "Step 3: Setup a basic Node.JS server with a basic REST endpoint",
            "stepRevision": "8e0bd3d2c92663db940df2cd80854880e468015f",
            "manualView": "Currently we have a running app with a single screen which looks stylish and presents some data to the user.\n\nThere is something missing though - The data that we are displaying can't be changed in any way.\n\nbut even if we'll change the data, there is still a more fundamental issue - all of the data lives on the client.\n\nThat means that each client has it's own copy of the data and the data is not shared between them,\nif a client will create a new message, only that client will have the new message and not the client that the message was sent to.\n\nAlso if the client will shut down, all data will be lost.\n\nSo how can we have a place to put data that is being shared between all clients?\n\nWe should find a central machine that all clients will connect to and get the data from.\nIf some client wants to create a new message, it will create it on that central machine so that the next time another clients will ask for the available messages,\nall those messages will be available on the central machine.\n\nThat central machine that stores data is called a database. and the machine that communicates between the database and the client is called a server.\n\nIn this step, we will write a NodeJS server (server that runs using the Javascript language) and will expose a REST endpoint that will serve the data-mock.\nWe will build the REST application using [Express](https://www.npmjs.com/package/express).\nFurther in this tutorial, we will migrate to using a real data-base with real I/O from the user, because at this point, if the server will shut down, all data will be lost.\n\nThe plan is to have a server up and running at `localhost:4000` that will expose a `GET /chats` route.\nUnlike our client application, we're not gonna use any boilerplate and we're gonna set everything up manually.\n\nRight outside the client project, we will create a new directory called `whatsapp-clone-server` in which we will start creating our server:\n\n    $ mkdir whatsapp-clone-server\n    $ cd whatsapp-clone-server\n\nThen we will use `Yarn` to initialize a new project:\n\n    $ yarn init -yp\n\nThere's nothing special about this command, it only creates a basic `package.json` file.\nJust to make sure that things work, we will add an `index.js` file which will print `\"hello world\"` to the console.\n\n[{]: <helper> (diffStep \"1.1\" files=\"index.js\" module=\"server\")\n\n#### [__Server__ Step 1.1: Create start script](https://github.com/Urigo/WhatsApp-Clone-Server/commit/d403cd8817a32d36b80ede879382b358a487c632)\n\n##### Added index.js\n```diff\n@@ -0,0 +1 @@\n+â”Š â”Š1â”Šconsole.log('hello world')\n```\n\n[}]: #\n\nAnd we will add a startup script to the `package.json` file called `start`:\n\n    \"scripts\": {\n      \"start\": \"node index.js\"\n    }\n\nNPM-scripts are just a way to defined an alias for commands. Now we only have one simple script,\nbut it can turn out to be something very complex depending on our server, so it can be very useful.\nMore about npm-scripts can be found in the [official NPM docs](https://docs.npmjs.com/misc/scripts).\n\nNow we can run our server by running `$ yarn start` and we should see the message \"hello world\" printed to the console, as expected.\n\nLike in our client's app, we will be using TypeScript.\nIn order to use TypeScript we will install few packages:\n\n    $ yarn add --dev typescript ts-node @types/node\n\n> Note how we used the `--dev` flag. It is a good practice to separate between production dependencies and development dependencies.\nThat way when you deploy your server to the real environment, you won't install the unnecessary development dependencies there.\nMore about the `--dev` option can be read in the [NPM-install docs](https://docs.npmjs.com/cli/install).\n\n- The [`typescript`](https://www.npmjs.com/package/typescript) package is TypeScript's core transpiler.\n- [`ts-node`](https://www.npmjs.com/package/ts-node) is an interpreter that will transpile required `.ts` files into JavaScript at runtime.\n- [`@types/node`](https://www.npmjs.com/package/@types/node) will make the appropriate definitions for a Node.JS environment.\n\n> You can read more about the `@types` monorepo in the [official GitHub repository](https://github.com/DefinitelyTyped/DefinitelyTyped).\n\nWe will rename the `index.js` file to `index.ts`:\n\n    $ mv index.js index.ts\n\nNow we need to compile the `ts` file to turn it into a Javascript file the Node can run.\n\nFor that we will use Typescript and its `tsc` command.\nThe command has many options, but instead of writing them in the command line, we can specify them in a `tsconfig.json` file at the root of the project.\n\nOur server is gonna use the following `tsconfig.json` file, feel free to make the necessary modifications based on your needs:\n\n[{]: <helper> (diffStep \"1.2\" files=\"tsconfig.json\" module=\"server\")\n\n#### [__Server__ Step 1.2: Setup TypeScript](https://github.com/Urigo/WhatsApp-Clone-Server/commit/c5c16f7c4fad7331d0397b405f13df1b5bbbe32e)\n\n##### Added tsconfig.json\n```diff\n@@ -0,0 +1,17 @@\n+â”Š  â”Š 1â”Š{\n+â”Š  â”Š 2â”Š  \"compilerOptions\": {\n+â”Š  â”Š 3â”Š    \"target\": \"es2018\",\n+â”Š  â”Š 4â”Š    \"module\": \"commonjs\",\n+â”Š  â”Š 5â”Š    \"lib\": [\n+â”Š  â”Š 6â”Š      \"es2018\",\n+â”Š  â”Š 7â”Š      \"esnext.asynciterable\"\n+â”Š  â”Š 8â”Š    ],\n+â”Š  â”Š 9â”Š    \"skipLibCheck\": true,\n+â”Š  â”Š10â”Š    \"strict\": true,\n+â”Š  â”Š11â”Š    \"strictFunctionTypes\": false,\n+â”Š  â”Š12â”Š    \"strictPropertyInitialization\": false,\n+â”Š  â”Š13â”Š    \"esModuleInterop\": true,\n+â”Š  â”Š14â”Š    \"experimentalDecorators\": true,\n+â”Š  â”Š15â”Š    \"emitDecoratorMetadata\": true\n+â”Š  â”Š16â”Š  }\n+â”Š  â”Š17â”Š}\n```\n\n[}]: #\n\nWe need to tell Typescript which files to compile. Those are in the `include` key.\n\nNow let's run `tsc` and see what happens.\n\nWe've got a new `index.js` file!  Now let's run it by running `node index.js`.\n\nThat's great, but doing this work each time we change a file can be annoying,\nso let's use tools to track when files change and make them run the code automatically after.\n\nAnd we will update the npm-script `start` to use `ts-node`, since we wanna use TypeScript, and not JavaScript directly:\n\n    \"start\": \"ts-node index.ts\"\n\nWe can test the startup of our server again by running `$ yarn start` and we should see the message \"hello world\" printed to the console.\n\nThe skeleton of the project is set and we can move on to implementing the REST API.\n\nLike we said at the beginning, we will be using Express to setup the API. Express is a wrapper around the native [Node.JS \"http\"](https://nodejs.org/api/http.html) library which is responsible for handling HTTP requests.\nYes, it can also be used directly, but Express is much more comfortable and has an amazing ecosystem built around it.\nLet's install Express and its TypeScript definitions:\n\n    $ yarn add express\n    $ yarn add --dev @types/express\n\nBefore we implement the `GET /chats` route we will implement a `GET /_ping` route. This route will be used to determine whether the server is up and running or not, and how fast the connection is based on the response time.\nFor every request sent to this route, we should expect a response saying \"pong\".\nSome call it \"heartbeat\", because this route is being tested repeatedly by the hosting machine to check if it's alive, just like a heartbeat in a way.\nThis is how the route should look like:\n\n[{]: <helper> (diffStep \"1.3\" files=\"index.ts\" module=\"server\")\n\n#### [__Server__ Step 1.3: Setup a Express with a basic health check route](https://github.com/Urigo/WhatsApp-Clone-Server/commit/a378e7225f4956e0d9ff705f863ecf50451fe4c0)\n\n##### Changed index.ts\n```diff\n@@ -1 +1,13 @@\n-â”Š 1â”Š  â”Šconsole.log('hello world')\n+â”Š  â”Š 1â”Šimport express from 'express'\n+â”Š  â”Š 2â”Š\n+â”Š  â”Š 3â”Šconst app = express()\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šapp.get('/_ping', (req, res) => {\n+â”Š  â”Š 6â”Š  res.send('pong')\n+â”Š  â”Š 7â”Š})\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Šconst port = process.env.PORT || 4000\n+â”Š  â”Š10â”Š\n+â”Š  â”Š11â”Šapp.listen(port, () => {\n+â”Š  â”Š12â”Š  console.log(`Server is listening on port ${port}`)\n+â”Š  â”Š13â”Š})\n```\n\n[}]: #\n\nWe can use the\n\n        $ curl localhost:4000/_ping\n\ncommand to send a request to the server and we should get a \"pong\", assuming that the server available on that URL.\n\n**Code formatting**\n\nJust like we talked in the first chapter, some developers write code in a different style than others and since we want to make it consistent, we're going to use **Prettier**.\n\n    $ yarn add -D prettier\n\nWe're going to define a npm script called `format`, few styling rules and we're also going to ignore *node_modules*:\n\n[{]: <helper> (diffStep \"1.4\" files=\"package.json, .prettierrc.yml, .prettierignore\" module=\"server\")\n\n#### [__Server__ Step 1.4: Use Prettier](https://github.com/Urigo/WhatsApp-Clone-Server/commit/40c625badade840022de64e7f0cf266859476c19)\n\n##### Added .prettierignore\n```diff\n@@ -0,0 +1 @@\n+â”Š â”Š1â”Šnode_modulesðŸš«â†µ\n```\n\n##### Added .prettierrc.yml\n```diff\n@@ -0,0 +1,4 @@\n+â”Š â”Š1â”ŠtrailingComma: 'es5'\n+â”Š â”Š2â”ŠtabWidth: 2\n+â”Š â”Š3â”ŠsingleQuote: true\n+â”Š â”Š4â”Šparser: 'typescript'\n```\n\n##### Changed package.json\n```diff\n@@ -7,11 +7,13 @@\n â”Š 7â”Š 7â”Š  },\n â”Š 8â”Š 8â”Š  \"private\": true,\n â”Š 9â”Š 9â”Š  \"scripts\": {\n-â”Š10â”Š  â”Š    \"start\": \"ts-node index.ts\"\n+â”Š  â”Š10â”Š    \"start\": \"ts-node index.ts\",\n+â”Š  â”Š11â”Š    \"format\": \"prettier \\\"**/*.ts\\\" --write\"\n â”Š11â”Š12â”Š  },\n â”Š12â”Š13â”Š  \"devDependencies\": {\n â”Š13â”Š14â”Š    \"@types/express\": \"4.17.0\",\n â”Š14â”Š15â”Š    \"@types/node\": \"12.7.1\",\n+â”Š  â”Š16â”Š    \"prettier\": \"1.18.2\",\n â”Š15â”Š17â”Š    \"ts-node\": \"8.3.0\",\n â”Š16â”Š18â”Š    \"typescript\": \"3.5.3\"\n â”Š17â”Š19â”Š  },\n```\n\n[}]: #\n\nNow let's run:\n\n    $ yarn format\n\nPrettier should format your code:\n\n[{]: <helper> (diffStep \"1.4\" files=\"index.ts\" module=\"server\")\n\n#### [__Server__ Step 1.4: Use Prettier](https://github.com/Urigo/WhatsApp-Clone-Server/commit/40c625badade840022de64e7f0cf266859476c19)\n\n##### Changed index.ts\n```diff\n@@ -1,13 +1,13 @@\n-â”Š 1â”Š  â”Šimport express from 'express'\n+â”Š  â”Š 1â”Šimport express from 'express';\n â”Š 2â”Š 2â”Š\n-â”Š 3â”Š  â”Šconst app = express()\n+â”Š  â”Š 3â”Šconst app = express();\n â”Š 4â”Š 4â”Š\n â”Š 5â”Š 5â”Šapp.get('/_ping', (req, res) => {\n-â”Š 6â”Š  â”Š  res.send('pong')\n-â”Š 7â”Š  â”Š})\n+â”Š  â”Š 6â”Š  res.send('pong');\n+â”Š  â”Š 7â”Š});\n â”Š 8â”Š 8â”Š\n-â”Š 9â”Š  â”Šconst port = process.env.PORT || 4000\n+â”Š  â”Š 9â”Šconst port = process.env.PORT || 4000;\n â”Š10â”Š10â”Š\n â”Š11â”Š11â”Šapp.listen(port, () => {\n-â”Š12â”Š  â”Š  console.log(`Server is listening on port ${port}`)\n-â”Š13â”Š  â”Š})\n+â”Š  â”Š12â”Š  console.log(`Server is listening on port ${port}`);\n+â”Š  â”Š13â”Š});\n```\n\n[}]: #\n\n> Remember to run `yarn prettier` before you comit your changes!\n\nThe `GET /chats` should be implemented similarly, only the response is different. Instead of returning \"pong\" we will return the data-mock for our chats:\n\n[{]: <helper> (diffStep \"1.5\" files=\"index.ts, db.ts\" module=\"server\")\n\n#### [__Server__ Step 1.5: Create GET /chats route](https://github.com/Urigo/WhatsApp-Clone-Server/commit/4e2a58908f297ccb51734eddc4526db7ddb04a70)\n\n##### Added db.ts\n```diff\n@@ -0,0 +1,51 @@\n+â”Š  â”Š 1â”Šexport const messages = [\n+â”Š  â”Š 2â”Š  {\n+â”Š  â”Š 3â”Š    id: '1',\n+â”Š  â”Š 4â”Š    content: 'You on your way?',\n+â”Š  â”Š 5â”Š    createdAt: new Date(new Date('1-1-2019').getTime() - 60 * 1000 * 1000),\n+â”Š  â”Š 6â”Š  },\n+â”Š  â”Š 7â”Š  {\n+â”Š  â”Š 8â”Š    id: '2',\n+â”Š  â”Š 9â”Š    content: \"Hey, it's me\",\n+â”Š  â”Š10â”Š    createdAt: new Date(new Date('1-1-2019').getTime() - 2 * 60 * 1000 * 1000),\n+â”Š  â”Š11â”Š  },\n+â”Š  â”Š12â”Š  {\n+â”Š  â”Š13â”Š    id: '3',\n+â”Š  â”Š14â”Š    content: 'I should buy a boat',\n+â”Š  â”Š15â”Š    createdAt: new Date(new Date('1-1-2019').getTime() - 24 * 60 * 1000 * 1000),\n+â”Š  â”Š16â”Š  },\n+â”Š  â”Š17â”Š  {\n+â”Š  â”Š18â”Š    id: '4',\n+â”Š  â”Š19â”Š    content: 'This is wicked good ice cream.',\n+â”Š  â”Š20â”Š    createdAt: new Date(\n+â”Š  â”Š21â”Š      new Date('1-1-2019').getTime() - 14 * 24 * 60 * 1000 * 1000\n+â”Š  â”Š22â”Š    ),\n+â”Š  â”Š23â”Š  },\n+â”Š  â”Š24â”Š];\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Šexport const chats = [\n+â”Š  â”Š27â”Š  {\n+â”Š  â”Š28â”Š    id: '1',\n+â”Š  â”Š29â”Š    name: 'Ethan Gonzalez',\n+â”Š  â”Š30â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n+â”Š  â”Š31â”Š    lastMessage: '1',\n+â”Š  â”Š32â”Š  },\n+â”Š  â”Š33â”Š  {\n+â”Š  â”Š34â”Š    id: '2',\n+â”Š  â”Š35â”Š    name: 'Bryan Wallace',\n+â”Š  â”Š36â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n+â”Š  â”Š37â”Š    lastMessage: '2',\n+â”Š  â”Š38â”Š  },\n+â”Š  â”Š39â”Š  {\n+â”Š  â”Š40â”Š    id: '3',\n+â”Š  â”Š41â”Š    name: 'Avery Stewart',\n+â”Š  â”Š42â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n+â”Š  â”Š43â”Š    lastMessage: '3',\n+â”Š  â”Š44â”Š  },\n+â”Š  â”Š45â”Š  {\n+â”Š  â”Š46â”Š    id: '4',\n+â”Š  â”Š47â”Š    name: 'Katie Peterson',\n+â”Š  â”Š48â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n+â”Š  â”Š49â”Š    lastMessage: '4',\n+â”Š  â”Š50â”Š  },\n+â”Š  â”Š51â”Š];\n```\n\n##### Changed index.ts\n```diff\n@@ -1,4 +1,5 @@\n â”Š1â”Š1â”Šimport express from 'express';\n+â”Š â”Š2â”Šimport { chats } from './db';\n â”Š2â”Š3â”Š\n â”Š3â”Š4â”Šconst app = express();\n â”Š4â”Š5â”Š\n```\n```diff\n@@ -6,6 +7,10 @@\n â”Š 6â”Š 7â”Š  res.send('pong');\n â”Š 7â”Š 8â”Š});\n â”Š 8â”Š 9â”Š\n+â”Š  â”Š10â”Šapp.get('/chats', (req, res) => {\n+â”Š  â”Š11â”Š  res.json(chats);\n+â”Š  â”Š12â”Š});\n+â”Š  â”Š13â”Š\n â”Š 9â”Š14â”Šconst port = process.env.PORT || 4000;\n â”Š10â”Š15â”Š\n â”Š11â”Š16â”Šapp.listen(port, () => {\n```\n\n[}]: #\n\nTODO: Mention `_req`\n\nCheck that we can get the chats by running:\n\n        $ curl localhost:4000/chats\n\nUnlike the previous route, we used the `.json()` method this time around to send a response. This will simply stringify the given JSON and set the right headers.\nSimilarly to the client, we've defined the db mock in a dedicated file, as this is easier to maintain and look at.\n\nIt's also recommended to connect a middleware called [`cors`](https://www.npmjs.com/package/cors) which will enable cross-origin requests.\nWithout it we will only be able to make requests in localhost, something which is likely to limit us in the future because we would probably host our server somewhere separate than the client application.\nWithout it it will also be impossible to call the server from our client app.\nLet's install the `cors` library and load it with the Express `middleware()` function:\n\n    $ yarn add cors\n\nand its Typescript types:\n\n\n    $ yarn add --dev @types/cors\n\n[{]: <helper> (diffStep \"1.6\" files=\"index.ts\" module=\"server\")\n\n#### [__Server__ Step 1.6: Use CORS](https://github.com/Urigo/WhatsApp-Clone-Server/commit/c3e831816c00bac03e25f7986c54ba35148c6cc2)\n\n##### Changed index.ts\n```diff\n@@ -1,8 +1,11 @@\n+â”Š  â”Š 1â”Šimport cors from 'cors';\n â”Š 1â”Š 2â”Šimport express from 'express';\n â”Š 2â”Š 3â”Šimport { chats } from './db';\n â”Š 3â”Š 4â”Š\n â”Š 4â”Š 5â”Šconst app = express();\n â”Š 5â”Š 6â”Š\n+â”Š  â”Š 7â”Šapp.use(cors());\n+â”Š  â”Š 8â”Š\n â”Š 6â”Š 9â”Šapp.get('/_ping', (req, res) => {\n â”Š 7â”Š10â”Š  res.send('pong');\n â”Š 8â”Š11â”Š});\n```\n\n[}]: #\n\nThe server is now ready to use!\n\nSo getting back to the client, first we will define our server's URL under the `.env` file:\n\n[{]: <helper> (diffStep \"3.1\" module=\"client\")\n\n#### [__Client__ Step 3.1: Define server URL](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/76dc2d402b713cf4771061546964c6c2ed9f6d33)\n\n##### Added .env\n```diff\n@@ -0,0 +1 @@\n+â”Š â”Š1â”ŠREACT_APP_SERVER_URL=http://localhost:4000ðŸš«â†µ\n```\n\n[}]: #\n\nThis will make our server's URL available under the `process.env.REACT_APP_SERVER_URL` member expression and it will be replaced with a fixed value at build time, just like macros.\nThe `.env` file is a file which will automatically be loaded to `process.env` by the [`dotenv`](https://www.npmjs.com/package/dotenv) NPM package.\n`react-scripts` then filters environment variables which have a `REACT_APP_` prefix and provides the created JSON to a Webpack plugin called [DefinePlugin](https://webpack.js.org/plugins/define-plugin/), which will result in the macro effect.\n\nNow let's move back into our React app folder.\nWe will now replace the local data-mock usage with a fetch from the server.\nFor that we can use the native [fetch API](https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API),\nhowever, it needs to be used in the right life-cycle hook of the React.Component.\n\nThere are 2 naive approaches for that:\n\n- Calling `fetch()` outside the component, but this way that chats will be fetched even if we're not even intending to create an instance of the component.\n\n```js\nfetch().then(() => /* ... */)\nconst MyComponent = () => {}\n```\n\n- Calling `fetch()` inside the component, but then it will be invoked whenever the component is re-rendered.\n\n```js\nconst MyComponent = () => {\n  fetch().then(() => /* ... */)\n}\n```\n\nThese 2 approaches indeed work, but they both fail to deliver what's necessary on the right time.\nIn addition, there's no way to properly coordinate async function calls with the render method of the component.\n\n**Introducing: React hooks**\n\nWith React hooks we can invoke the desired logic in the right life-cycle stage of the target component.\nThis way we can avoid potential memory leaks or extra calculations.\nTo implement a proper `fetch()`, we will be using 2 React hooks:\n\n- [`React.useState()`](https://reactjs.org/docs/hooks-reference.html#usestate) - which is used to get and set a state of the component - will be used to store the chats fetched from the server.\n\n```js\nconst [value, setValue] = useState(initialValue);\n```\n\n- [`React.useMemo()`](https://reactjs.org/docs/hooks-reference.html#usememo) - which is used to run a computation only once certain conditions were met - will be used to run the `fetch()` function only once the component has mounted.\n\n```js\nconst memoizedValue = useMemo(calcFn, [cond1, cond2, ...conds]);\n```\n\nThe result of that approach will look like this, in the context of our ChatsList component:\n\n[{]: <helper> (diffStep \"3.2\" module=\"client\")\n\n#### [__Client__ Step 3.2: Fetch chats using native fetch API instead of mock DB](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/5ca4d41f18bb865bd708cb3c08003eb6e9ee3dea)\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -1,8 +1,8 @@\n â”Š1â”Š1â”Šimport React from 'react';\n-â”Š2â”Š â”Šimport { chats } from '../../db';\n â”Š3â”Š2â”Šimport moment from 'moment';\n â”Š4â”Š3â”Šimport { List, ListItem } from '@material-ui/core';\n â”Š5â”Š4â”Šimport styled from 'styled-components';\n+â”Š â”Š5â”Šimport { useState, useMemo } from 'react';\n â”Š6â”Š6â”Š\n â”Š7â”Š7â”Šconst Container = styled.div`\n â”Š8â”Š8â”Š  height: calc(100% - 56px);\n```\n```diff\n@@ -56,27 +56,37 @@\n â”Š56â”Š56â”Š  font-size: 13px;\n â”Š57â”Š57â”Š`;\n â”Š58â”Š58â”Š\n-â”Š59â”Š  â”Šconst ChatsList = () => (\n-â”Š60â”Š  â”Š  <Container>\n-â”Š61â”Š  â”Š    <StyledList>\n-â”Š62â”Š  â”Š      {chats.map(chat => (\n-â”Š63â”Š  â”Š        <StyledListItem key={chat.id} button>\n-â”Š64â”Š  â”Š          <ChatPicture src={chat.picture} alt=\"Profile\" />\n-â”Š65â”Š  â”Š          <ChatInfo>\n-â”Š66â”Š  â”Š            <ChatName>{chat.name}</ChatName>\n-â”Š67â”Š  â”Š            {chat.lastMessage && (\n-â”Š68â”Š  â”Š              <React.Fragment>\n-â”Š69â”Š  â”Š                <MessageContent>{chat.lastMessage.content}</MessageContent>\n-â”Š70â”Š  â”Š                <MessageDate>\n-â”Š71â”Š  â”Š                  {moment(chat.lastMessage.createdAt).format('HH:mm')}\n-â”Š72â”Š  â”Š                </MessageDate>\n-â”Š73â”Š  â”Š              </React.Fragment>\n-â”Š74â”Š  â”Š            )}\n-â”Š75â”Š  â”Š          </ChatInfo>\n-â”Š76â”Š  â”Š        </StyledListItem>\n-â”Š77â”Š  â”Š      ))}\n-â”Š78â”Š  â”Š    </StyledList>\n-â”Š79â”Š  â”Š  </Container>\n-â”Š80â”Š  â”Š);\n+â”Š  â”Š59â”Šconst ChatsList = () => {\n+â”Š  â”Š60â”Š  const [chats, setChats] = useState<any[]>([]);\n+â”Š  â”Š61â”Š\n+â”Š  â”Š62â”Š  useMemo(async () => {\n+â”Š  â”Š63â”Š    const body = await fetch(`${process.env.REACT_APP_SERVER_URL}/chats`);\n+â”Š  â”Š64â”Š    const chats = await body.json();\n+â”Š  â”Š65â”Š    setChats(chats);\n+â”Š  â”Š66â”Š  }, []);\n+â”Š  â”Š67â”Š\n+â”Š  â”Š68â”Š  return (\n+â”Š  â”Š69â”Š    <Container>\n+â”Š  â”Š70â”Š      <StyledList>\n+â”Š  â”Š71â”Š        {chats.map(chat => (\n+â”Š  â”Š72â”Š          <StyledListItem key={chat!.id} button>\n+â”Š  â”Š73â”Š            <ChatPicture src={chat.picture} alt=\"Profile\" />\n+â”Š  â”Š74â”Š            <ChatInfo>\n+â”Š  â”Š75â”Š              <ChatName>{chat.name}</ChatName>\n+â”Š  â”Š76â”Š              {chat.lastMessage && (\n+â”Š  â”Š77â”Š                <React.Fragment>\n+â”Š  â”Š78â”Š                  <MessageContent>{chat.lastMessage.content}</MessageContent>\n+â”Š  â”Š79â”Š                  <MessageDate>\n+â”Š  â”Š80â”Š                    {moment(chat.lastMessage.createdAt).format('HH:mm')}\n+â”Š  â”Š81â”Š                  </MessageDate>\n+â”Š  â”Š82â”Š                </React.Fragment>\n+â”Š  â”Š83â”Š              )}\n+â”Š  â”Š84â”Š            </ChatInfo>\n+â”Š  â”Š85â”Š          </StyledListItem>\n+â”Š  â”Š86â”Š        ))}\n+â”Š  â”Š87â”Š      </StyledList>\n+â”Š  â”Š88â”Š    </Container>\n+â”Š  â”Š89â”Š  );\n+â”Š  â”Š90â”Š};\n â”Š81â”Š91â”Š\n â”Š82â”Š92â”Šexport default ChatsList;\n```\n\n##### Deleted src&#x2F;db.ts\n```diff\n@@ -1,49 +0,0 @@\n-â”Š 1â”Š  â”Šexport const messages = [\n-â”Š 2â”Š  â”Š  {\n-â”Š 3â”Š  â”Š    id: '1',\n-â”Š 4â”Š  â”Š    content: 'You on your way?',\n-â”Š 5â”Š  â”Š    createdAt: new Date(Date.now() - 60 * 1000 * 1000),\n-â”Š 6â”Š  â”Š  },\n-â”Š 7â”Š  â”Š  {\n-â”Š 8â”Š  â”Š    id: '2',\n-â”Š 9â”Š  â”Š    content: \"Hey, it's me\",\n-â”Š10â”Š  â”Š    createdAt: new Date(Date.now() - 2 * 60 * 1000 * 1000),\n-â”Š11â”Š  â”Š  },\n-â”Š12â”Š  â”Š  {\n-â”Š13â”Š  â”Š    id: '3',\n-â”Š14â”Š  â”Š    content: 'I should buy a boat',\n-â”Š15â”Š  â”Š    createdAt: new Date(Date.now() - 24 * 60 * 1000 * 1000),\n-â”Š16â”Š  â”Š  },\n-â”Š17â”Š  â”Š  {\n-â”Š18â”Š  â”Š    id: '4',\n-â”Š19â”Š  â”Š    content: 'This is wicked good ice cream.',\n-â”Š20â”Š  â”Š    createdAt: new Date(Date.now() - 14 * 24 * 60 * 1000 * 1000),\n-â”Š21â”Š  â”Š  },\n-â”Š22â”Š  â”Š];\n-â”Š23â”Š  â”Š\n-â”Š24â”Š  â”Šexport const chats = [\n-â”Š25â”Š  â”Š  {\n-â”Š26â”Š  â”Š    id: '1',\n-â”Š27â”Š  â”Š    name: 'Ethan Gonzalez',\n-â”Š28â”Š  â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n-â”Š29â”Š  â”Š    lastMessage: messages.find(m => m.id === '1'),\n-â”Š30â”Š  â”Š  },\n-â”Š31â”Š  â”Š  {\n-â”Š32â”Š  â”Š    id: '2',\n-â”Š33â”Š  â”Š    name: 'Bryan Wallace',\n-â”Š34â”Š  â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n-â”Š35â”Š  â”Š    lastMessage: messages.find(m => m.id === '2'),\n-â”Š36â”Š  â”Š  },\n-â”Š37â”Š  â”Š  {\n-â”Š38â”Š  â”Š    id: '3',\n-â”Š39â”Š  â”Š    name: 'Avery Stewart',\n-â”Š40â”Š  â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n-â”Š41â”Š  â”Š    lastMessage: messages.find(m => m.id === '3'),\n-â”Š42â”Š  â”Š  },\n-â”Š43â”Š  â”Š  {\n-â”Š44â”Š  â”Š    id: '4',\n-â”Š45â”Š  â”Š    name: 'Katie Peterson',\n-â”Š46â”Š  â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n-â”Š47â”Š  â”Š    lastMessage: messages.find(m => m.id === '4'),\n-â”Š48â”Š  â”Š  },\n-â”Š49â”Š  â”Š];\n```\n\n[}]: #\n\n> It's recommended to read about React hooks and their basic concept at the [official React docs page](https://reactjs.org/docs/hooks-overview.html).\n\nAt this point we can get rid of `db.ts` file in the client, since we don't use it anymore:\n\n    $ rm src/db.ts\n\nThat's it. Our ChatsListScreen is now connected to a working back-end.\nIn the next step we will upgrade our REST API into a GraphQL API and we will create a basis for a more robust back-end.\n\n-------------\nTODO:\n\nFirst, `tsc` has a `--watch` option so that if the Typescript files changed it will compile them again and spit new Javascript files.\n\nThen we need to rerun the Node server everytime the output Javascript files has changed.\n[nodemon](https://github.com/remy/nodemon) is a tool that tracks file and if the files changed it will re-run our node server.\n\nLet's create a new npm script called \"watch\" and make it run both tools:\n\nTODO: New diff\n\nTODO: https://stackoverflow.com/a/39172660/1426570\n\nTODO: Better watch, also watch and copy schema files (maybe in a later chapter)?\n\nTODO: concurrently - because it works on all environments\n\nTODO: Explain what -r register command does in Node and in Jest\n\nTODO: Talk about the difference between graphql-import and graphql-import-node\n\nTODO: Show debugging\n\n\nIt's a bit annoying that we get the compiled file right next to our Typescript file, so let's move it into a separate folder:\n\nTODO: New diff for the `lib` folder update\n\nTODO: why `useMemo(fn, [true])` instead of `useEffect(fn, [])` ?\n\nTODO: Move to hooks in a separate commit and later change to call the server"
          },
          {
            "manualTitle": "Step 4: Transition to GraphQL",
            "stepRevision": "bf2cf1ba0715aeb20bd00eb4373e872aadd64294",
            "manualView": "**What is GraphQL?**\n\n[GraphQL](https://graphql.org/) is a query language invented by Facebook, and it's used to query data within from a schema.\nIn our case, we will create a schema for the data that our server exposes through its API.\nIt allows clients to define the structure of the data required, and the exact same structure of data will be returned from the server,\ntherefore preventing excessively large amounts of data from being returned.\nUnlike REST, GraphQL APIs are organized in terms of types and fields, not endpoints.\n\nEven if we use GraphQL without a server, it can save us a lot of code and work becuase it can transform data in a very easy way from a schema to a query.\n\nCurrently in our app, if we'd like to get its chats we would send a GET request to `/chats`.\nWith GraphQL it would be done differently with a string that describes the data that we would like to get:\n\n```graphql\nchats {\n  id\n  name\n  picture\n  lastMessage {\n    id\n    content\n    createdAt\n  }\n}\n```\n\n> Above: An illustration of a potential GraphQL query sent to our Whatsapp API\n\n**Why GraphQL and not REST?**\n\nREST has been used for many more years and has proven itself to work well, and it's completely agnostic to the implementation of the back-end.\nHowever, when it comes to data projection and aggregation, it fails to deliver.\n\nWhen using REST, often times you'll find yourself performing multiple requests to execute a single query of data.\nNot only that, you might even end up with additional data that is not necessary.\nEither way, the process would result in slower and heavier response.\n\nWith GraphQL we donâ€™t have that kind of problem. The API is based on a schema built from many entities that we call object types.\nThink of GraphQL as something similar to TypeScript but for API.\nObject types are like interfaces, they describe the shape of an entity.\n\nIn TypeScript you would describe a Chat as:\n\n```\ninterface Chat {\n  id: string;\n  name: string;\n  picture: string;\n  lastMessage: Message;\n}\n\ninterface Message {\n  id: string;\n  content: string;\n  createdAt: number;\n}\n```\n\nGraphQL:\n\n```\ntype Chat {\n  id: String\n  name: String\n  picture: String\n  lastMessage: Message\n}\n\ntype Message {\n  id: String\n  content: String\n  createdAt: Float\n}\n```\n\nLooks pretty similar?\n\nSo this is the definition of the available data, now let's see how we can pick and structure data from it using a query:\n\n```graphql\n# request\nchats {\n  id\n  name\n  picture\n  lastMessage {\n    id\n    content\n    createdAt\n  }\n}\n```\n\nWe think itâ€™s pretty straightforward to understand what do you fetch by just looking at the query above.\n\n![graphql-request](https://user-images.githubusercontent.com/7648874/54133620-5aec8300-4451-11e9-9bda-a459dc48f57c.png)\n\nIf you would execute that query the result might look like this:\n\n```js\n// response\n{\n  chats: [{\n    id: â€œ1â€,\n    name: â€œEthan Gonzalezâ€,\n    picture: â€œhttps://randomuser.me/api/portraits/thumb/men/1.jpgâ€,\n    lastMessage: {\n      id: â€œ1â€,\n      content: \"You on your way?\",\n      createdAt: 1234567890\n  }]\n}\n```\n\nYou'll get exactly what you asked for with a single request. GraphQL provides a dynamic API while REST doesn't.\n\n**GraphQL schema, in a nutshell**\n\nLike said earlier,  GraphQL APIs are organized in terms of types and fields.\nThat means that our app data should be described with a schema, where each field's gonna have a resolver - the handler that will return the corresponding data.\nThings will be much clearer as we move further.\n\nLet's try to describe our app's data with a GraphQL schema and then dive into it:\n\n```graphql\nscalar Date\n\ntype Message {\n  id: ID!\n  content: String!\n  createdAt: Date!\n}\n\ntype Chat {\n  id: ID!\n  name: String!\n  picture: String\n  lastMessage: Message\n}\n\ntype Query {\n  chats: [Chat!]!\n}\n```\n\nThe schema is self explanatory in terms of what data it's compatible with. Supported built-in scalar types in GraphQL are:\n\n- Int: Signed 32â€bit integer\n- Float: Signed double-precision floating-point value\n- String: UTFâ€8 character sequence\n- Boolean: true or false\n- ID (serialized as String): A unique identifier, often used to refetch an object or as the key for a cache.\nWhile serialized as a String, ID signifies that it is not intended to be humanâ€readable\n\nAny custom scalar can be declared with the `scalar` keyword, and custom types can be declared with the `type` keyword.\nHowever, you should know that some types are reserved by GraphQL itself; `Query` is one of them.\nThe `Query` type will be used as the root for received queries by the clients, which means that we can send queries which start with the `chats` field.\nOther reserved types are:\n\n- `type Query` - reserved for [GraphQL queries](https://graphql.org/learn/queries/#mutations).\n- `type Mutation` - reserved for [GraphQL mutations.](https://graphql.github.io/learn/queries/)\n- `type Subscription` - reserved for [GraphQL subscriptions.](https://www.apollographql.com/docs/react/advanced/subscriptions.html)\n\n> As we're not gonna go through the entire GraphQL API, it's recommended to go through the [official learn section of the GraphQL website](https://graphql.org/learn/), but the information so far will definitely help you kick-start, plus the upcoming implementation.\n\n**Getting started**\n\nWe will be implementing a GraphQL mechanism for the client and for the server.\nWe will start with the server as things will make more sense, and we will be able to test it before we proceed into the client.\nEssentially GraphQL is connected into a HTTP endpoint, usually under `POST /graphql`, and so this is exactly what we're gonna do, connect the endpoint handler.\nLuckily, we don't have to implement that. A team called [Apollo](https://www.apollographql.com/) already did it for us, so we can use their implementation.\nWe will install the required packages:\n\n    $ yarn add apollo-server-express graphql\n    $ yarn add --dev @types/graphql\n\n- [`graphql`](https://www.npmjs.com/package/graphql) - The core package of GraphQL that includes the resolvers for basic data-types.\n- [`apollo-server-express`](https://www.npmjs.com/package/apollo-server-express) - Apollo's implementation for the GraphQL Express REST endpoint.\n- `@types/graphql` - TypeScript definitions. Notice that we didn't need to install Apollo's types library. That is because Apollo themselves writes their source code in Typescript so\nwe get a ready Typescript code directly from their library.\n\nWe can now connect Apollo's middleware under the `/graphql` route:\n\n[{]: <helper> (diffStep \"2.1\" files=\"index.ts\" module=\"server\")\n\n#### [__Server__ Step 2.1: Setup Apollo GraphQL](https://github.com/Urigo/WhatsApp-Clone-Server/commit/9cf46ca95eabf1db70d70a44cac2329134fe27b0)\n\n##### Changed index.ts\n```diff\n@@ -1,10 +1,13 @@\n+â”Š  â”Š 1â”Šimport { ApolloServer, gql } from 'apollo-server-express';\n â”Š 1â”Š 2â”Šimport cors from 'cors';\n â”Š 2â”Š 3â”Šimport express from 'express';\n â”Š 3â”Š 4â”Šimport { chats } from './db';\n+â”Š  â”Š 5â”Šimport schema from './schema';\n â”Š 4â”Š 6â”Š\n â”Š 5â”Š 7â”Šconst app = express();\n â”Š 6â”Š 8â”Š\n â”Š 7â”Š 9â”Šapp.use(cors());\n+â”Š  â”Š10â”Šapp.use(express.json());\n â”Š 8â”Š11â”Š\n â”Š 9â”Š12â”Šapp.get('/_ping', (req, res) => {\n â”Š10â”Š13â”Š  res.send('pong');\n```\n```diff\n@@ -14,6 +17,13 @@\n â”Š14â”Š17â”Š  res.json(chats);\n â”Š15â”Š18â”Š});\n â”Š16â”Š19â”Š\n+â”Š  â”Š20â”Šconst server = new ApolloServer({ schema });\n+â”Š  â”Š21â”Š\n+â”Š  â”Š22â”Šserver.applyMiddleware({\n+â”Š  â”Š23â”Š  app,\n+â”Š  â”Š24â”Š  path: '/graphql',\n+â”Š  â”Š25â”Š});\n+â”Š  â”Š26â”Š\n â”Š17â”Š27â”Šconst port = process.env.PORT || 4000;\n â”Š18â”Š28â”Š\n â”Š19â”Š29â”Šapp.listen(port, () => {\n```\n\n[}]: #\n\nAs you can see, the middleware requires a schema. A schema is composed mainly out of 2 fields:\n\n- `typeDefs` (type definitions) - the schema types we wrote earlier this chapter for chats.\n- `resolvers` - The handlers that will provide the data for each field in `typeDefs`.\n\nWe will start first by defining the types.\nAll we have to do is to copy-paste the contents of the schema that was shown earlier into a new file called `typeDefs.graphql`:\n\nNote that some of the fields have exclamation mark at the end and it means that the field is non-nullable,\nmeaning that the GraphQL service promises to always give you a value when you query this field.\n\nChats Query is even more interesting case with two exclamation marks `[Chat!]!`.\n\nThe outer exclamation mark means that if you run this query it will always return an array of zero or more items (never null)\nand inner exclamation mark means that every item of returned array will be of type `Chat` and never be null.\n\n[{]: <helper> (diffStep \"2.2\" files=\"schema/typeDefs.graphql\" module=\"server\")\n\n#### [__Server__ Step 2.2: Create a basic GraphQL schema](https://github.com/Urigo/WhatsApp-Clone-Server/commit/9a6d0df924f210377a01e1d04cb0cecc3789f5fd)\n\n##### Added schema&#x2F;typeDefs.graphql\n```diff\n@@ -0,0 +1,18 @@\n+â”Š  â”Š 1â”Šscalar Date\n+â”Š  â”Š 2â”Š\n+â”Š  â”Š 3â”Štype Message {\n+â”Š  â”Š 4â”Š  id: ID!\n+â”Š  â”Š 5â”Š  content: String!\n+â”Š  â”Š 6â”Š  createdAt: Date!\n+â”Š  â”Š 7â”Š}\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Štype Chat {\n+â”Š  â”Š10â”Š  id: ID!\n+â”Š  â”Š11â”Š  name: String!\n+â”Š  â”Š12â”Š  picture: String\n+â”Š  â”Š13â”Š  lastMessage: Message\n+â”Š  â”Š14â”Š}\n+â”Š  â”Š15â”Š\n+â”Š  â”Š16â”Štype Query {\n+â”Š  â”Š17â”Š  chats: [Chat!]!\n+â”Š  â”Š18â”Š}\n```\n\n[}]: #\n\nThe `.graphql` file extension is just a more convenient way to work with a GraphQL schema. The exported result should be a simple string that we can use to compose our GraphQL schema. The clear advantage of working with a dedicated file is that we get to have syntax highlight.\n\nNow we will implement the resolvers. Resolvers are presented in a JSON object where each resolver name should match the field name it represents. You can read more about resolvers in [Apollo's official docs for resolvers](https://www.apollographql.com/docs/tutorial/resolvers.html). This is how our resolvers should look like:\n\n[{]: <helper> (diffStep \"2.2\" files=\"schema/resolvers.ts\" module=\"server\")\n\n#### [__Server__ Step 2.2: Create a basic GraphQL schema](https://github.com/Urigo/WhatsApp-Clone-Server/commit/9a6d0df924f210377a01e1d04cb0cecc3789f5fd)\n\n##### Added schema&#x2F;resolvers.ts\n```diff\n@@ -0,0 +1,14 @@\n+â”Š  â”Š 1â”Šimport { GraphQLDateTime } from 'graphql-iso-date';\n+â”Š  â”Š 2â”Šimport { chats } from '../db';\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šconst resolvers = {\n+â”Š  â”Š 5â”Š  Date: GraphQLDateTime,\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Š  Query: {\n+â”Š  â”Š 8â”Š    chats() {\n+â”Š  â”Š 9â”Š      return chats;\n+â”Š  â”Š10â”Š    },\n+â”Š  â”Š11â”Š  },\n+â”Š  â”Š12â”Š};\n+â”Š  â”Š13â”Š\n+â”Š  â”Š14â”Šexport default resolvers;\n```\n\n[}]: #\n\nFor now it's extremely simple, we map the chats query directly into the database collection. Each field in the resolvers object should match the GraphQL type it represents in the schema. Since we don't have any logic now, we should not implement any resolvers for the rest of the types, the data will simply be forwarded as is.\n\nNote that we've implemented a custom scalar named `Date` and we resolved it with an NPM package. Let's install it:\n\n    $ yarn add graphql-iso-date\n    $ yarn add --dev @types/graphql-iso-date\n\nFinal thing that we have to do would be combining the resolvers and the type-defs under a single GraphQL schema.\n\n[{]: <helper> (diffStep \"2.2\" files=\"index.ts\" module=\"server\")\n\n#### [__Server__ Step 2.2: Create a basic GraphQL schema](https://github.com/Urigo/WhatsApp-Clone-Server/commit/9a6d0df924f210377a01e1d04cb0cecc3789f5fd)\n\n##### Added schema&#x2F;index.ts\n```diff\n@@ -0,0 +1,7 @@\n+â”Š â”Š1â”Šimport { importSchema } from 'graphql-import';\n+â”Š â”Š2â”Šimport { makeExecutableSchema } from 'graphql-tools';\n+â”Š â”Š3â”Šimport resolvers from './resolvers';\n+â”Š â”Š4â”Š\n+â”Š â”Š5â”Šconst typeDefs = importSchema('schema/typeDefs.graphql');\n+â”Š â”Š6â”Š\n+â”Š â”Š7â”Šexport default makeExecutableSchema({ resolvers, typeDefs });\n```\n\n[}]: #\n\n[`graphql-tools`](https://www.npmjs.com/package/graphql-tools) is a library with a set of utilities that will help us create a schema that will be compatible with Apollo's API:\n\n    $ yarn add graphql-tools graphql-import\n\nThere's one optimization however that we should make in the our DB. Right now, the each chat document has a direct reference to a message via the `lastMessage` field. Practically speaking, this is NOT how the data sits in the DB. The `lastMessage` should only hold the ID for the correlated message, and then in the Node.JS app we should **resolve** it according to our needs. Let's make the appropriate changes in the DB then:\n\n[{]: <helper> (diffStep \"2.3\" files=\"db.ts\" module=\"server\")\n\n#### [__Server__ Step 2.3: Resolve Chat.lastMessage](https://github.com/Urigo/WhatsApp-Clone-Server/commit/13c0783cbc300d67562494ea22027586d40d3abe)\n\n\n\n[}]: #\n\nAnd a resolver to the `lastMessage` field:\n\n[{]: <helper> (diffStep \"2.3\" files=\"schema/resolvers.ts\" module=\"server\")\n\n#### [__Server__ Step 2.3: Resolve Chat.lastMessage](https://github.com/Urigo/WhatsApp-Clone-Server/commit/13c0783cbc300d67562494ea22027586d40d3abe)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,9 +1,15 @@\n â”Š 1â”Š 1â”Šimport { GraphQLDateTime } from 'graphql-iso-date';\n-â”Š 2â”Š  â”Šimport { chats } from '../db';\n+â”Š  â”Š 2â”Šimport { chats, messages } from '../db';\n â”Š 3â”Š 3â”Š\n â”Š 4â”Š 4â”Šconst resolvers = {\n â”Š 5â”Š 5â”Š  Date: GraphQLDateTime,\n â”Š 6â”Š 6â”Š\n+â”Š  â”Š 7â”Š  Chat: {\n+â”Š  â”Š 8â”Š    lastMessage(chat: any) {\n+â”Š  â”Š 9â”Š      return messages.find(m => m.id === chat.lastMessage);\n+â”Š  â”Š10â”Š    },\n+â”Š  â”Š11â”Š  },\n+â”Š  â”Š12â”Š\n â”Š 7â”Š13â”Š  Query: {\n â”Š 8â”Š14â”Š    chats() {\n â”Š 9â”Š15â”Š      return chats;\n```\n\n[}]: #\n\nThe first argument of the resolver is the raw chat data received by the DB, and the returned result should be the mapped value which we would like to return to the client.\n\nAs we get further in this tutorial we should get a better grasp regards resolvers and their API, since we will have to deal with more logic and complexity within our Node.JS app.\n\nAssuming that the server is running, we can already test our GraphQL endpoint. Because it's exposed to us via a REST endpoint, we can use a `$ curl` command to send a request to `GET localhost:4000/graphql` and get a response with all the data. Again, the query that we're gonna use to fetch the chats is:\n\n```graphql\nchats {\n  id\n  name\n  picture\n  lastMessage {\n    id\n    content\n    createdAt\n  }\n}\n```\n\nThe one-liner version of it with a `$ curl` command looks like so:\n\n    curl \\\n      -X POST \\\n      -H \"Content-Type: application/json\" \\\n      --data '{ \"query\": \"{ chats { id name picture lastMessage { id content createdAt } } }\" }' \\\n      localhost:4000/graphql\n\nAs a response we should get the data-mock for our chats stored in the server. Since we have that in place, we can go ahead and delete our implementation for the `GET /chats` route.\n\nAnother way to test and inspect our GraphQL schema would be by using an IDE for the browser called [GraphQL Playground](https://github.com/prisma/graphql-playground).\nApollo-Server ships with it right out of the box and can be used right away by navigating to the `http://localhost:4000/graphql` URL from the browser.\n\n[![](https://i.imgur.com/AE5W6OW.png)](https://graphqlbin.com/v2/6RQ6TM)\n\nSo getting back to the client, all we have to do is to change the fetching URL in the ChatsList component to use our newly implemented GraphQL REST endpoint:\n\n[{]: <helper> (diffStep \"4.1\" module=\"client\")\n\n#### [__Client__ Step 4.1: Replace REST call with GraphQL call](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/f585ee6128509256d0f646120864a62e7674d9a6)\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -56,12 +56,35 @@\n â”Š56â”Š56â”Š  font-size: 13px;\n â”Š57â”Š57â”Š`;\n â”Š58â”Š58â”Š\n+â”Š  â”Š59â”Šconst getChatsQuery = `\n+â”Š  â”Š60â”Š  query GetChats {\n+â”Š  â”Š61â”Š    chats {\n+â”Š  â”Š62â”Š      id\n+â”Š  â”Š63â”Š      name\n+â”Š  â”Š64â”Š      picture\n+â”Š  â”Š65â”Š      lastMessage {\n+â”Š  â”Š66â”Š        id\n+â”Š  â”Š67â”Š        content\n+â”Š  â”Š68â”Š        createdAt\n+â”Š  â”Š69â”Š      }\n+â”Š  â”Š70â”Š    }\n+â”Š  â”Š71â”Š  }\n+â”Š  â”Š72â”Š`;\n+â”Š  â”Š73â”Š\n â”Š59â”Š74â”Šconst ChatsList = () => {\n â”Š60â”Š75â”Š  const [chats, setChats] = useState<any[]>([]);\n â”Š61â”Š76â”Š\n â”Š62â”Š77â”Š  useMemo(async () => {\n-â”Š63â”Š  â”Š    const body = await fetch(`${process.env.REACT_APP_SERVER_URL}/chats`);\n-â”Š64â”Š  â”Š    const chats = await body.json();\n+â”Š  â”Š78â”Š    const body = await fetch(`${process.env.REACT_APP_SERVER_URL}/graphql`, {\n+â”Š  â”Š79â”Š      method: 'POST',\n+â”Š  â”Š80â”Š      headers: {\n+â”Š  â”Š81â”Š        'Content-Type': 'application/json',\n+â”Š  â”Š82â”Š      },\n+â”Š  â”Š83â”Š      body: JSON.stringify({ query: getChatsQuery }),\n+â”Š  â”Š84â”Š    });\n+â”Š  â”Š85â”Š    const {\n+â”Š  â”Š86â”Š      data: { chats },\n+â”Š  â”Š87â”Š    } = await body.json();\n â”Š65â”Š88â”Š    setChats(chats);\n â”Š66â”Š89â”Š  }, []);\n```\n\n[}]: #\n\nThe received data should be similar to the previous one.\nNo further changes are required.\n\nIn the next chapter, we will continue working on the UI of our front-end application and we will add a new screen to the flow - the `ChatRoomScreen`.\n\n-------\nTODO: Start with calling the  `graphql` function just on the server to show how it works.\nTODO: Example middlewares in Node\nTODO: Mention the vs code extension\n\nTODO: Introduce the scalar type later on\n\nTODO: Start without Apollo and add it later, in the same file.\nTODO: remove `gql` import becuase it's unused\nTODO: Add visualizations of how GraphQL works\nTODO: import { loadSchema } from 'graphql-toolkit'; and install it\n\nTODO: What DB change is that?\nTODO: Type `lastMessage(chat: any) {`\nTOOD: Change `m` to `currentIteratedMessage`\n\nTODO: Why adding headers? and go through the code\n\nTODO: Talk about working with document node and not with makeExacutableSchema\n```\n×–×” ×œ× ×ž×©× ×” ×‘×ª×›×œ×¡, ×›×™ ApolloServer ×‘×›×œ ×ž×§×¨×” ×™×¢×©×” ×œ×–×” ×§×™×ž×¤×•×œ\n×”× ×§×•×“×” ×”×™× ×©×œ× ×¦×¨×™×š ×œ×§×ž×¤×œ ×¤×¢×ž×™×™× ×œGraphQLSchema\n×¤×©×•×˜ ×¢×“×™×£ ×©××ª ×”×§×™×ž×¤×•×œ ×™×¢×©×” ×”×¨×›×™×‘ ×”××—×¨×•×Ÿ ×©×”×•×œ×š ×œ×”×©×ª×ž×© ×‘typeDefs\n\nDocumentNode => DocumentNode (cheap, easy, no checks)\nDocumentNode => GraphQLSchema (compile AST, does all checking, might throw exceptions, expensive)\nGraphQLSchema => DocumentNode (printed version, might lost AST features such as directives)\n```"
          },
          {
            "manualTitle": "Step 5: Testing",
            "stepRevision": "cc44a589913a59cd5df2f020df63ed6713fd26af",
            "manualView": "Testing is a crucial part when writing an application, especially if we're planning to publish it or make it a commercial thing. Before we hand someone a product, of any kind, we wanna make sure that it passes certain quality checks. We're signed on that product and so it's very important to ensure that it functions properly according our expectations, otherwise wouldn't wanna use it and will look for alternatives.\n\nIn the context of software, we constantly make changes. It's also inevitable to make all features completely independent from one another, so something in the app is likely to break as we upgrade it or maintain it. That's why we need to write a set of tests that can be run on demand, so when we implement a new feature we can simply run the tests and see what feature broke due to most recent changes.\n\nThere are currently 3 main testing frameworks in the NPM ecosystem: [Jasmine](https://jasmine.github.io/), [Mocha](https://mochajs.org/), and [Jest](https://jestjs.io/). Each testing framework has its pros, and cons, and at the end of the day it's a matter of preference. In our application we're gonna use [Jest](https://jestjs.io/) - a testing framework which was developed by Facebook. What's good about Jest is that it can be used to test both client and server logic, because it runs as a Node.JS application, but it also emulates the browser environment whenever we run it, thanks to [JSDOM](https://github.com/jsdom/jsdom).\n\n![jest](https://user-images.githubusercontent.com/7648874/54493900-e2ce0380-490f-11e9-8075-be4a236c7c38.png)\n\nIn this chapter we will learn how to test the React.Components in the client, and Apollo-GraphQL resolvers in the server. There are 3 kinds of tests:\n\n- Unit tests - which are used to test a single component, independently from other components in our system.\n- Integration tests - which are used to test a component in relation to other components in our systems (how well do they co-work with each other).\n- e2e tests (end to end) - which are used to test a complete, from the moment I clicked on a button in the user interface until the data gets back from the server and shown on the screen.\n\nThe efficiency of the tests go from bottom to top (unit -> e2e), but the maintenance and complexity go from bottom to top (e2e -> unit). Accordingly we will need to find a good balance where we donâ€™t spend too much time on writing tests yet have a good indicator for how well our system functions. So we should write a lot of unit tests, a good amount of integration tests and a handful of e2e tests.\n\n![tests-types-table](https://user-images.githubusercontent.com/7648874/54494121-fed2a480-4911-11e9-9370-694ec989729b.png)\n\nWe will start with the client as itâ€™s much easier, because Jest is set and ready to use right out of the box thanks to `create-react-app`.\n\n**Client - Testing React.Components**\n\nThanks to `create-react-app`, we have Jest set and ready to use right out of the box, so we can start writing tests right away. I you'll look at the `src` you'll see a file called `App.test.tsx`, which simply ensures that the component can be rendered without crashing.\n\n```jsx\nimport React from 'react';\nimport ReactDOM from 'react-dom';\nimport App from './App';\n\nit('renders without crashing', () => {\n  const div = document.createElement('div');\n  ReactDOM.render(<App />, div);\n  ReactDOM.unmountComponentAtNode(div);\n});\n```\n\nThis is not a typical test that you're likely to find in a React project, but it demonstrates very well how Jest can be used to test DOM related issues. If you'll run `$ npm run test` (or `$ yarn test`) in the command line and then press `a`, you should see the following output:\n\n![report](https://user-images.githubusercontent.com/7648874/54341429-eabe4700-4674-11e9-8e76-3aaaf7fec79a.png)\n\nJest will automatically run for every file that ends with a `.test.xxx` extension. This is very convenient because the tests can live right next to the component, and you don't need to lookup for it across the project. This behavior can be modified by configuring Jest in the `package.json` file under the `\"jest\"` field. More information about configuring Jest can be found in the official[ configuration documentation](https://jestjs.io/docs/en/configuration).\n\n> If you get a warning message regards wrapping the component with `act()` - this is a known issue with hooks and should have a proper solution soon. More about this issue and progress regards its fix can be found in this [GitHub thread](https://github.com/facebook/react/issues/14769#issuecomment-470097212).\n\nNow we're gonna write a basic test for the `<ChatsList />` component. In the test, we'll mock a fake response from the server, and examine the contents of rendered HTML. Since the HTML of the component is a dynamic thing and is constantly subject to changes, it would be a good idea to annotate it with `data-testid` attributes so it can be tested regardless of its structure:\n\n[{]: <helper> (diffStep \"5.1\" files=\"ChatsList.tsx\" module=\"client\")\n\n#### [__Client__ Step 5.1: Add data-testid attributes](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/55d2c369f90953154cc37e3de2a7f23d72b123f8)\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -92,14 +92,20 @@\n â”Š 92â”Š 92â”Š    <Container>\n â”Š 93â”Š 93â”Š      <StyledList>\n â”Š 94â”Š 94â”Š        {chats.map(chat => (\n-â”Š 95â”Š   â”Š          <StyledListItem key={chat!.id} button>\n-â”Š 96â”Š   â”Š            <ChatPicture src={chat.picture} alt=\"Profile\" />\n+â”Š   â”Š 95â”Š          <StyledListItem key={chat.id} button>\n+â”Š   â”Š 96â”Š            <ChatPicture\n+â”Š   â”Š 97â”Š              data-testid=\"picture\"\n+â”Š   â”Š 98â”Š              src={chat.picture}\n+â”Š   â”Š 99â”Š              alt=\"Profile\"\n+â”Š   â”Š100â”Š            />\n â”Š 97â”Š101â”Š            <ChatInfo>\n-â”Š 98â”Š   â”Š              <ChatName>{chat.name}</ChatName>\n+â”Š   â”Š102â”Š              <ChatName data-testid=\"name\">{chat.name}</ChatName>\n â”Š 99â”Š103â”Š              {chat.lastMessage && (\n â”Š100â”Š104â”Š                <React.Fragment>\n-â”Š101â”Š   â”Š                  <MessageContent>{chat.lastMessage.content}</MessageContent>\n-â”Š102â”Š   â”Š                  <MessageDate>\n+â”Š   â”Š105â”Š                  <MessageContent data-testid=\"content\">\n+â”Š   â”Š106â”Š                    {chat.lastMessage.content}\n+â”Š   â”Š107â”Š                  </MessageContent>\n+â”Š   â”Š108â”Š                  <MessageDate data-testid=\"date\">\n â”Š103â”Š109â”Š                    {moment(chat.lastMessage.createdAt).format('HH:mm')}\n â”Š104â”Š110â”Š                  </MessageDate>\n â”Š105â”Š111â”Š                </React.Fragment>\n```\n\n[}]: #\n\nNow we can select various HTML elements with a query selector when we test the component. We will install a couple of packages that will assist us in implementing the test:\n\n    $ yarn add jest-fetch-mock @testing-library/jest-dom @testing-library/react\n\n- The [`jest-fetch-mock`](https://www.npmjs.com/package/jest-fetch-mock) package can mock responses emitted by the Fetch API.\n- The [`@testing-library/jest-dom`](https://www.npmjs.com/package/@testing-library/jest-dom) package will add custom matchers that will help us examine HTML contents of DOM elements.\n- The [`@testing-library/react`](https://www.npmjs.com/package/@testing-library/react) package contains utility methods that will help us test React.Components with Jest.\n\nNext, we will create a file under the `src` folder called `setupTests.ts`. This file is loaded configured automatically by `create-react-app` and loaded by Jest, and we can use it to set up our testing environment according to our needs (like said earlier, Jest can be configured, so this file path can be changed). We will use that file to define a fake Fetch API using the `jest-fetch-mock` library:\n\n[{]: <helper> (diffStep \"5.2\" files=\"src/setupTests.ts\" module=\"client\")\n\n#### [__Client__ Step 5.2: Setup tests](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/7fc14c4d3db50f809d5e14f8de03a6ba94086b65)\n\n##### Added src&#x2F;setupTests.ts\n```diff\n@@ -0,0 +1,7 @@\n+â”Š â”Š1â”Šimport '@testing-library/jest-dom/extend-expect';\n+â”Š â”Š2â”Šimport { GlobalWithFetchMock } from 'jest-fetch-mock';\n+â”Š â”Š3â”Šimport { act } from '@testing-library/react';\n+â”Š â”Š4â”Š\n+â”Š â”Š5â”Šconst customGlobal: GlobalWithFetchMock = global as GlobalWithFetchMock;\n+â”Š â”Š6â”ŠcustomGlobal.fetch = require('jest-fetch-mock');\n+â”Š â”Š7â”ŠcustomGlobal.fetchMock = customGlobal.fetch;\n```\n\n[}]: #\n\nWe will create another file called `ChatsList.test.tsx`, right next to the `<ChatsList />` component under the `ChatsListScreen` directory, and inside we will implement our test. The test should follow these steps:\n\n- Mock the response to contain a fake chat, so we won't need to make an actual call to our GraphQL API.\n- We will create a new instance of `<ChatsList />` and render it in a container element.\n- We will wait for changes in the DOM caused by `setState()`.\n- We will test the contents of the container.\n\nAnd this is how the implementation should look like:\n\n[{]: <helper> (diffStep \"5.3\" files=\"src/components/ChatsListScreen/ChatsList.test.tsx\" module=\"client\")\n\n#### [__Client__ Step 5.3: Test ChatsList](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/561b555c4a66b0e96a2a5bf1061041ef695e2ce6)\n\n##### Added src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.test.tsx\n```diff\n@@ -0,0 +1,43 @@\n+â”Š  â”Š 1â”Šimport React from 'react';\n+â”Š  â”Š 2â”Šimport ReactDOM from 'react-dom';\n+â”Š  â”Š 3â”Šimport { cleanup, render, waitForDomChange } from '@testing-library/react';\n+â”Š  â”Š 4â”Šimport ChatsList from './ChatsList';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šdescribe('ChatsList', () => {\n+â”Š  â”Š 7â”Š  afterEach(cleanup);\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Š  it('renders fetched chats data', async () => {\n+â”Š  â”Š10â”Š    fetchMock.mockResponseOnce(\n+â”Š  â”Š11â”Š      JSON.stringify({\n+â”Š  â”Š12â”Š        data: {\n+â”Š  â”Š13â”Š          chats: [\n+â”Š  â”Š14â”Š            {\n+â”Š  â”Š15â”Š              id: 1,\n+â”Š  â”Š16â”Š              name: 'Foo Bar',\n+â”Š  â”Š17â”Š              picture: 'https://localhost:4000/picture.jpg',\n+â”Š  â”Š18â”Š              lastMessage: {\n+â”Š  â”Š19â”Š                id: 1,\n+â”Š  â”Š20â”Š                content: 'Hello',\n+â”Š  â”Š21â”Š                createdAt: new Date('1 Jan 2019 GMT'),\n+â”Š  â”Š22â”Š              },\n+â”Š  â”Š23â”Š            },\n+â”Š  â”Š24â”Š          ],\n+â”Š  â”Š25â”Š        },\n+â”Š  â”Š26â”Š      })\n+â”Š  â”Š27â”Š    );\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š    {\n+â”Š  â”Š30â”Š      const { container, getByTestId } = render(<ChatsList />);\n+â”Š  â”Š31â”Š\n+â”Š  â”Š32â”Š      await waitForDomChange({ container });\n+â”Š  â”Š33â”Š\n+â”Š  â”Š34â”Š      expect(getByTestId('name')).toHaveTextContent('Foo Bar');\n+â”Š  â”Š35â”Š      expect(getByTestId('picture')).toHaveAttribute(\n+â”Š  â”Š36â”Š        'src',\n+â”Š  â”Š37â”Š        'https://localhost:4000/picture.jpg'\n+â”Š  â”Š38â”Š      );\n+â”Š  â”Š39â”Š      expect(getByTestId('content')).toHaveTextContent('Hello');\n+â”Š  â”Š40â”Š      expect(getByTestId('date')).toHaveTextContent('02:00');\n+â”Š  â”Š41â”Š    }\n+â”Š  â”Š42â”Š  });\n+â”Š  â”Š43â”Š});ðŸš«â†µ\n```\n\n[}]: #\n\n> Jest API is vast but pretty intuitive for the most part. It mostly consists of test descriptors and matchers. [Here's a full list of all matchers which are built into Jest's API](https://jestjs.io/docs/en/expect). Always make sure to work against it when writing tests, for optimal results.\n\nWe will now move on to testing the server where we will learn how to setup Jest manually and test it against a GraphQL API.\n\n**Server - Testing GraphQL resolvers**\n\nTo set-up Jest, we will run the following in the command line:\n\n    $ yarn add --dev jest @types/jest ts-jest\n\n\nThis will basically install Jest and make it useable with TypeScript.\nIn addition, we will need to specify the file pattern that we would like to transform with [`ts-jest`](https://www.npmjs.com/package/ts-jest), by adding the following section to `package.json`:\n\n```\n{\n  \"jest\": {\n    \"transform\": {\n      \"^.+\\\\.(js|jsx|ts|tsx)$\": \"<rootDir>/node_modules/ts-jest\"\n    }\n  }\n}\n```\n\nWe will also add a `\"test\"` script in the `package.json` file,\nso we can run the tests with `$ yarn test`:\n\n```\n{\n  \"scripts\": {\n    \"test\": \"jest\"\n  }\n}\n```\n\nThis is how our `package.json` should look like at this point:\n\n> Notice we have lines there that mention `jest-junit`.\n> Those are needed for our own tutorial CI, you don't have to use it.\n\n[{]: <helper> (diffStep \"3.1\" files=\"package.json\" module=\"server\")\n\n#### [__Server__ Step 3.1: Install and configure Jest](https://github.com/Urigo/WhatsApp-Clone-Server/commit/77e51da6a344d23d710c10bb747d4b0f2cbf7ea4)\n\n##### Changed package.json\n```diff\n@@ -8,15 +8,23 @@\n â”Š 8â”Š 8â”Š  \"private\": true,\n â”Š 9â”Š 9â”Š  \"scripts\": {\n â”Š10â”Š10â”Š    \"start\": \"ts-node index.ts\",\n+â”Š  â”Š11â”Š    \"test\": \"TZ=\\\"Asia/Jerusalem\\\" jest\",\n â”Š11â”Š12â”Š    \"format\": \"prettier \\\"**/*.ts\\\" --write\"\n â”Š12â”Š13â”Š  },\n+â”Š  â”Š14â”Š  \"jest-junit\": {\n+â”Š  â”Š15â”Š    \"outputDirectory\": \"./test-results\"\n+â”Š  â”Š16â”Š  },\n â”Š13â”Š17â”Š  \"devDependencies\": {\n â”Š14â”Š18â”Š    \"@types/cors\": \"2.8.5\",\n â”Š15â”Š19â”Š    \"@types/express\": \"4.17.0\",\n â”Š16â”Š20â”Š    \"@types/graphql\": \"14.2.3\",\n â”Š17â”Š21â”Š    \"@types/graphql-iso-date\": \"3.3.1\",\n+â”Š  â”Š22â”Š    \"@types/jest\": \"24.0.17\",\n â”Š18â”Š23â”Š    \"@types/node\": \"12.7.1\",\n+â”Š  â”Š24â”Š    \"jest\": \"24.8.0\",\n+â”Š  â”Š25â”Š    \"jest-junit\": \"7.0.0\",\n â”Š19â”Š26â”Š    \"prettier\": \"1.18.2\",\n+â”Š  â”Š27â”Š    \"ts-jest\": \"24.0.2\",\n â”Š20â”Š28â”Š    \"ts-node\": \"8.3.0\",\n â”Š21â”Š29â”Š    \"typescript\": \"3.5.3\"\n â”Š22â”Š30â”Š  },\n```\n```diff\n@@ -28,5 +36,19 @@\n â”Š28â”Š36â”Š    \"graphql-import\": \"0.7.1\",\n â”Š29â”Š37â”Š    \"graphql-iso-date\": \"3.6.1\",\n â”Š30â”Š38â”Š    \"graphql-tools\": \"4.0.5\"\n+â”Š  â”Š39â”Š  },\n+â”Š  â”Š40â”Š  \"jest\": {\n+â”Š  â”Š41â”Š    \"transform\": {\n+â”Š  â”Š42â”Š      \"^.+\\\\.(js|jsx|ts|tsx)$\": \"<rootDir>/node_modules/ts-jest\"\n+â”Š  â”Š43â”Š    },\n+â”Š  â”Š44â”Š    \"globals\": {\n+â”Š  â”Š45â”Š      \"ts-jest\": {\n+â”Š  â”Š46â”Š        \"diagnostics\": false\n+â”Š  â”Š47â”Š      }\n+â”Š  â”Š48â”Š    },\n+â”Š  â”Š49â”Š    \"reporters\": [\n+â”Š  â”Š50â”Š      \"default\",\n+â”Š  â”Š51â”Š      \"jest-junit\"\n+â”Š  â”Š52â”Š    ]\n â”Š31â”Š53â”Š  }\n â”Š32â”Š54â”Š}ðŸš«â†µ\n```\n\n[}]: #\n\nNow we're gonna test the `chats` query in our GraphQL schema. To do so, we will setup an Apollo Client and send a query request to our back-end, and then we will match the received response with a pre-defined snapshot. Luckily, we don't have to set an actual client, since the tests and the implementation of the back-end live right next to each other, thus, we will install a package which will help us achieving so:\n\n    $ yarn add --dev apollo-server-testing\n\nWe will define the test suite under the `tests/queries` folder in a file called `getChats.test.ts`:\n\n[{]: <helper> (diffStep \"3.2\" files=\"tests/queries/getChats.test.ts\" module=\"server\")\n\n#### [__Server__ Step 3.2: Test Query.chats](https://github.com/Urigo/WhatsApp-Clone-Server/commit/c8b7539990614f741dde47fbd6305e5cb473fb4b)\n\n##### Added tests&#x2F;queries&#x2F;getChats.test.ts\n```diff\n@@ -0,0 +1,32 @@\n+â”Š  â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n+â”Š  â”Š 2â”Šimport { ApolloServer, gql } from 'apollo-server-express';\n+â”Š  â”Š 3â”Šimport schema from '../../schema';\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šdescribe('Query.chats', () => {\n+â”Š  â”Š 6â”Š  it('should fetch all chats', async () => {\n+â”Š  â”Š 7â”Š    const server = new ApolloServer({ schema });\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Š    const { query } = createTestClient(server);\n+â”Š  â”Š10â”Š\n+â”Š  â”Š11â”Š    const res = await query({\n+â”Š  â”Š12â”Š      query: gql`\n+â”Š  â”Š13â”Š        query GetChats {\n+â”Š  â”Š14â”Š          chats {\n+â”Š  â”Š15â”Š            id\n+â”Š  â”Š16â”Š            name\n+â”Š  â”Š17â”Š            picture\n+â”Š  â”Š18â”Š            lastMessage {\n+â”Š  â”Š19â”Š              id\n+â”Š  â”Š20â”Š              content\n+â”Š  â”Š21â”Š              createdAt\n+â”Š  â”Š22â”Š            }\n+â”Š  â”Š23â”Š          }\n+â”Š  â”Š24â”Š        }\n+â”Š  â”Š25â”Š      `,\n+â”Š  â”Š26â”Š    });\n+â”Š  â”Š27â”Š\n+â”Š  â”Š28â”Š    expect(res.data).toBeDefined();\n+â”Š  â”Š29â”Š    expect(res.errors).toBeUndefined();\n+â”Š  â”Š30â”Š    expect(res.data).toMatchSnapshot();\n+â”Š  â”Š31â”Š  });\n+â”Š  â”Š32â”Š});\n```\n\n[}]: #\n\nIn the test function, we create a new instance of the Apollo-GraphQL server using our schema, and we query some data against it thanks to the fake client created by [`apollo-server-testing`](https://www.npmjs.com/package/apollo-server-testing).\n\nThe `.toMatchSnapshot()` matcher will call the `toString()` method on the examined object and will test it against a predefined snapshot.\nThe snapshot will automatically be created once we run the test for the first time and will be stored under the `__snapshot__` directory.\nThis means that the first test run will always pass. This is useful because you can later on observe and adjust manually the snapshot manually without having to write it from scratch.\n\nSo let's do our first test run for the server:\n\n    $ yarn test\n\nThe expected result should be a projection of the data stored in the `db.ts` file.\n\n[{]: <helper> (diffStep \"3.2\" files=\"tests/queries/__snapshots__\" module=\"server\")\n\n#### [__Server__ Step 3.2: Test Query.chats](https://github.com/Urigo/WhatsApp-Clone-Server/commit/c8b7539990614f741dde47fbd6305e5cb473fb4b)\n\n##### Added tests&#x2F;queries&#x2F;\\__snapshots__&#x2F;getChats.test.ts.snap\n```diff\n@@ -0,0 +1,48 @@\n+â”Š  â”Š 1â”Š// Jest Snapshot v1, https://goo.gl/fbAQLP\n+â”Š  â”Š 2â”Š\n+â”Š  â”Š 3â”Šexports[`Query.chats should fetch all chats 1`] = `\n+â”Š  â”Š 4â”ŠObject {\n+â”Š  â”Š 5â”Š  \"chats\": Array [\n+â”Š  â”Š 6â”Š    Object {\n+â”Š  â”Š 7â”Š      \"id\": \"1\",\n+â”Š  â”Š 8â”Š      \"lastMessage\": Object {\n+â”Š  â”Š 9â”Š        \"content\": \"You on your way?\",\n+â”Š  â”Š10â”Š        \"createdAt\": \"2018-12-30T23:20:00.000Z\",\n+â”Š  â”Š11â”Š        \"id\": \"1\",\n+â”Š  â”Š12â”Š      },\n+â”Š  â”Š13â”Š      \"name\": \"Ethan Gonzalez\",\n+â”Š  â”Š14â”Š      \"picture\": \"https://randomuser.me/api/portraits/thumb/men/1.jpg\",\n+â”Š  â”Š15â”Š    },\n+â”Š  â”Š16â”Š    Object {\n+â”Š  â”Š17â”Š      \"id\": \"2\",\n+â”Š  â”Š18â”Š      \"lastMessage\": Object {\n+â”Š  â”Š19â”Š        \"content\": \"Hey, it's me\",\n+â”Š  â”Š20â”Š        \"createdAt\": \"2018-12-30T06:40:00.000Z\",\n+â”Š  â”Š21â”Š        \"id\": \"2\",\n+â”Š  â”Š22â”Š      },\n+â”Š  â”Š23â”Š      \"name\": \"Bryan Wallace\",\n+â”Š  â”Š24â”Š      \"picture\": \"https://randomuser.me/api/portraits/thumb/men/2.jpg\",\n+â”Š  â”Š25â”Š    },\n+â”Š  â”Š26â”Š    Object {\n+â”Š  â”Š27â”Š      \"id\": \"3\",\n+â”Š  â”Š28â”Š      \"lastMessage\": Object {\n+â”Š  â”Š29â”Š        \"content\": \"I should buy a boat\",\n+â”Š  â”Š30â”Š        \"createdAt\": \"2018-12-15T00:00:00.000Z\",\n+â”Š  â”Š31â”Š        \"id\": \"3\",\n+â”Š  â”Š32â”Š      },\n+â”Š  â”Š33â”Š      \"name\": \"Avery Stewart\",\n+â”Š  â”Š34â”Š      \"picture\": \"https://randomuser.me/api/portraits/thumb/women/1.jpg\",\n+â”Š  â”Š35â”Š    },\n+â”Š  â”Š36â”Š    Object {\n+â”Š  â”Š37â”Š      \"id\": \"4\",\n+â”Š  â”Š38â”Š      \"lastMessage\": Object {\n+â”Š  â”Š39â”Š        \"content\": \"This is wicked good ice cream.\",\n+â”Š  â”Š40â”Š        \"createdAt\": \"2018-05-12T08:00:00.000Z\",\n+â”Š  â”Š41â”Š        \"id\": \"4\",\n+â”Š  â”Š42â”Š      },\n+â”Š  â”Š43â”Š      \"name\": \"Katie Peterson\",\n+â”Š  â”Š44â”Š      \"picture\": \"https://randomuser.me/api/portraits/thumb/women/2.jpg\",\n+â”Š  â”Š45â”Š    },\n+â”Š  â”Š46â”Š  ],\n+â”Š  â”Š47â”Š}\n+â”Š  â”Š48â”Š`;\n```\n\n[}]: #\n\nAlways be sure to observe the snapshot before moving on! The received result isn't necessarily what you'd expect. Also it's not a good practice to store production data in the snapshot because it's subject to changes. Normally we would set up another instance of the DB for testing purposes, but since our DB is a mock and doesn't represent real data, there's no need to at this stage.\n\nNow that we have the required knowledge regards testing and Jest's API, we will implement tests throughout the tutorial as a trivial thing. We will not go through each and every new matcher that we introduce, as it is self explanatory and there's too much of them. Be sure to work against [this full list of matchers](https://jestjs.io/docs/en/expect) when working with Jest.\n\nIn the next chapter we will continue expanding our application by adding a `<ChatRoomScreen />`.\n\n----------\nTODO: Check what changed on testing in create-react-app 3.0 https://facebook.github.io/create-react-app/docs/running-tests\n\nTODO: I think ts-jest could be configured in a simpler way, but need to check\n\t{ preset: 'ts-jest' }\n\nTODO: I donâ€™t like using jestâ€™s toMatchSnapshot() to compare operationâ€™s result that comes from the real GraphQL Schema (with resolvers).\nIt might change quite a lot and break tests. That data might be huge and hard to be validated by looking at it. Maybe checking a structure is a better approach?\n\nTODO: Why ts-jest?\n\nTODO: Change into tortilla diff:\n\nTODO: Change into Tortilla diif:\n\nTODO: Test with UTC timezone so it would work on all computers\n\nTODO: const server = new ApolloServer({ typeDefs }); // easier, no need to compile the schema before"
          },
          {
            "manualTitle": "Step 6: Creating an app router and implementing a chat room",
            "stepRevision": "ca0c3c0d20df2b4720e6ee01f989af4f295e6fc6",
            "manualView": "In this chapter we will learn how to build a chat room screen.\nIn order to navigate between different screens, we will setup a router.\n\nSince we're gonna have to screens in our app now - `ChatsListScreen` and `ChatRoomScreen`, we will need a router that will be able to alternate between them.\nWe will be using the [`react-router-dom`](https://www.npmjs.com/package/react-router-dom) package to manage the routes of the application:\n\n    $ yarn add react-router-dom @types/react-router-dom\n\nAnd we will implement a router directly in the `<App />` component:\n\n[{]: <helper> (diffStep 6.1 files=\"App\" module=\"client\")\n\n#### [__Client__ Step 6.1: Add router](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/debf474bf7873bd1b1851a0e59605913f36b710e)\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -1,10 +1,18 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n+â”Š  â”Š 2â”Šimport { BrowserRouter, Route, Redirect, Switch } from 'react-router-dom';\n+â”Š  â”Š 3â”Šimport ChatRoomScreen from './components/ChatRoomScreen';\n â”Š 2â”Š 4â”Šimport ChatsListScreen from './components/ChatsListScreen';\n â”Š 3â”Š 5â”Š\n â”Š 4â”Š 6â”Šconst App: React.FC = () => (\n-â”Š 5â”Š  â”Š  <div>\n-â”Š 6â”Š  â”Š    <ChatsListScreen />\n-â”Š 7â”Š  â”Š  </div>\n+â”Š  â”Š 7â”Š  <BrowserRouter>\n+â”Š  â”Š 8â”Š    <Switch>\n+â”Š  â”Š 9â”Š      <Route exact path=\"/chats\" component={ChatsListScreen} />\n+â”Š  â”Š10â”Š      <Route exact path=\"/chats/:chatId\" component={ChatRoomScreen} />\n+â”Š  â”Š11â”Š    </Switch>\n+â”Š  â”Š12â”Š    <Route exact path=\"/\" render={redirectToChats} />\n+â”Š  â”Š13â”Š  </BrowserRouter>\n â”Š 8â”Š14â”Š);\n â”Š 9â”Š15â”Š\n+â”Š  â”Š16â”Šconst redirectToChats = () => <Redirect to=\"/chats\" />;\n+â”Š  â”Š17â”Š\n â”Š10â”Š18â”Šexport default App;\n```\n\n[}]: #\n\nThe purpose of a router is to make route managing easy and declarative.\nIt will take care of managing the history within our app and parameterize certain screens according to our need.\nEssentially it's a wrap around the `window.history` object which is also compatible with React.\nI recommend you to go through the [official MDN docs](https://developer.mozilla.org/en-US/docs/Web/API/History) if you're not yet familiar with the concept.\n\nThe `<Route />` component represents a path for a route in our application. Using the colon syntax (`:chatId`) we basically tell the router that the `/chat` route should be followed by a string whose value can later on be addressed via a parameter called `chatId` when navigating to the route. So here's a sum-up of the routes manifest:\n\n\n\n*   `/chats` - will navigate to the `ChatsListScreen`.\n*   `/chat/:chatId` - e.g. `/chat/1`, will navigate to the `ChatRoomScreen` and will parameterize it to show data which is related to chat ID 1.\n*   Any other route will fallback to the `/chats` route which will redirect us to the `ChatsListScreen`.\n\nNow we will implement the `ChatRoomScreen` so the router can function properly.\nFor now we will make it a plain screen which simply prints out the information of the chat that was clicked so we can have a complete flow,\nand then we will take care of the rest.\n\nTo do so, we will first implement the `chat` query in our backend.\nThis would be a parameterized query that will provide us with a specific chat according to the received ID,\nand it will be used by the new screen as soon as it is initialized.\nFirst we would update the `Chat` type to contain a `messages` field:\n\n[{]: <helper> (diffStep 4.1 files=\"typeDefs.graphql\" module=\"server\")\n\n#### [__Server__ Step 4.1: Add messages field to Chat type](https://github.com/Urigo/WhatsApp-Clone-Server/commit/7eb8ebb9aab3ef113788d2df4afe00b74121a419)\n\n##### Changed schema&#x2F;typeDefs.graphql\n```diff\n@@ -11,6 +11,7 @@\n â”Š11â”Š11â”Š  name: String!\n â”Š12â”Š12â”Š  picture: String\n â”Š13â”Š13â”Š  lastMessage: Message\n+â”Š  â”Š14â”Š  messages: [Message!]!\n â”Š14â”Š15â”Š}\n â”Š15â”Š16â”Š\n â”Š16â”Š17â”Štype Query {\n```\n\n[}]: #\n\nThen we will create the appropriate resolver:\n\n[{]: <helper> (diffStep 4.1 files=\"resolvers.ts\" module=\"server\")\n\n#### [__Server__ Step 4.1: Add messages field to Chat type](https://github.com/Urigo/WhatsApp-Clone-Server/commit/7eb8ebb9aab3ef113788d2df4afe00b74121a419)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -5,6 +5,10 @@\n â”Š 5â”Š 5â”Š  Date: GraphQLDateTime,\n â”Š 6â”Š 6â”Š\n â”Š 7â”Š 7â”Š  Chat: {\n+â”Š  â”Š 8â”Š    messages(chat: any) {\n+â”Š  â”Š 9â”Š      return messages.filter(m => chat.messages.includes(m.id));\n+â”Š  â”Š10â”Š    },\n+â”Š  â”Š11â”Š\n â”Š 8â”Š12â”Š    lastMessage(chat: any) {\n â”Š 9â”Š13â”Š      return messages.find(m => m.id === chat.lastMessage);\n â”Š10â”Š14â”Š    },\n```\n\n[}]: #\n\nAnd then we will update our DB mock to be aligned with these changes:\n\n[{]: <helper> (diffStep 4.1 files=\"db\" module=\"server\")\n\n#### [__Server__ Step 4.1: Add messages field to Chat type](https://github.com/Urigo/WhatsApp-Clone-Server/commit/7eb8ebb9aab3ef113788d2df4afe00b74121a419)\n\n##### Changed db.ts\n```diff\n@@ -29,23 +29,27 @@\n â”Š29â”Š29â”Š    name: 'Ethan Gonzalez',\n â”Š30â”Š30â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n â”Š31â”Š31â”Š    lastMessage: '1',\n+â”Š  â”Š32â”Š    messages: ['1'],\n â”Š32â”Š33â”Š  },\n â”Š33â”Š34â”Š  {\n â”Š34â”Š35â”Š    id: '2',\n â”Š35â”Š36â”Š    name: 'Bryan Wallace',\n â”Š36â”Š37â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n â”Š37â”Š38â”Š    lastMessage: '2',\n+â”Š  â”Š39â”Š    messages: ['2'],\n â”Š38â”Š40â”Š  },\n â”Š39â”Š41â”Š  {\n â”Š40â”Š42â”Š    id: '3',\n â”Š41â”Š43â”Š    name: 'Avery Stewart',\n â”Š42â”Š44â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n â”Š43â”Š45â”Š    lastMessage: '3',\n+â”Š  â”Š46â”Š    messages: ['3'],\n â”Š44â”Š47â”Š  },\n â”Š45â”Š48â”Š  {\n â”Š46â”Š49â”Š    id: '4',\n â”Š47â”Š50â”Š    name: 'Katie Peterson',\n â”Š48â”Š51â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n â”Š49â”Š52â”Š    lastMessage: '4',\n+â”Š  â”Š53â”Š    messages: ['4'],\n â”Š50â”Š54â”Š  },\n â”Š51â”Š55â”Š];\n```\n\n[}]: #\n\nThis means that when we resolve `Chat.lastMessage`, we should get it directly from the `Chat.messages` field:\n\n[{]: <helper> (diffStep 4.2 module=\"server\")\n\n#### [__Server__ Step 4.2: Resolve last message based on messages array](https://github.com/Urigo/WhatsApp-Clone-Server/commit/1782612b4dfa706db628e38d7aab0c352247632d)\n\n##### Changed db.ts\n```diff\n@@ -28,28 +28,24 @@\n â”Š28â”Š28â”Š    id: '1',\n â”Š29â”Š29â”Š    name: 'Ethan Gonzalez',\n â”Š30â”Š30â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n-â”Š31â”Š  â”Š    lastMessage: '1',\n â”Š32â”Š31â”Š    messages: ['1'],\n â”Š33â”Š32â”Š  },\n â”Š34â”Š33â”Š  {\n â”Š35â”Š34â”Š    id: '2',\n â”Š36â”Š35â”Š    name: 'Bryan Wallace',\n â”Š37â”Š36â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n-â”Š38â”Š  â”Š    lastMessage: '2',\n â”Š39â”Š37â”Š    messages: ['2'],\n â”Š40â”Š38â”Š  },\n â”Š41â”Š39â”Š  {\n â”Š42â”Š40â”Š    id: '3',\n â”Š43â”Š41â”Š    name: 'Avery Stewart',\n â”Š44â”Š42â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n-â”Š45â”Š  â”Š    lastMessage: '3',\n â”Š46â”Š43â”Š    messages: ['3'],\n â”Š47â”Š44â”Š  },\n â”Š48â”Š45â”Š  {\n â”Š49â”Š46â”Š    id: '4',\n â”Š50â”Š47â”Š    name: 'Katie Peterson',\n â”Š51â”Š48â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n-â”Š52â”Š  â”Š    lastMessage: '4',\n â”Š53â”Š49â”Š    messages: ['4'],\n â”Š54â”Š50â”Š  },\n â”Š55â”Š51â”Š];\n```\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -10,7 +10,9 @@\n â”Š10â”Š10â”Š    },\n â”Š11â”Š11â”Š\n â”Š12â”Š12â”Š    lastMessage(chat: any) {\n-â”Š13â”Š  â”Š      return messages.find(m => m.id === chat.lastMessage);\n+â”Š  â”Š13â”Š      const lastMessage = chat.messages[chat.messages.length - 1];\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”Š      return messages.find(m => m.id === lastMessage);\n â”Š14â”Š16â”Š    },\n â”Š15â”Š17â”Š  },\n```\n\n[}]: #\n\nNow that we have an updated schema which is relevant to the new screen that we would like to add, we will declare a new query called `chat`:\n\n[{]: <helper> (diffStep 4.3 files=\"schema/typeDefs\" module=\"server\")\n\n#### [__Server__ Step 4.3: Add chat field to Query type](https://github.com/Urigo/WhatsApp-Clone-Server/commit/460fb0fabe1aa0cc6cddfbe070870f318286d83e)\n\n##### Changed schema&#x2F;typeDefs.graphql\n```diff\n@@ -16,4 +16,5 @@\n â”Š16â”Š16â”Š\n â”Š17â”Š17â”Štype Query {\n â”Š18â”Š18â”Š  chats: [Chat!]!\n+â”Š  â”Š19â”Š  chat(chatId: ID!): Chat\n â”Š19â”Š20â”Š}\n```\n\n[}]: #\n\nNote that unlike the `chats` query, this time we have a parameter. The parameters are provided to the resolver function as the second parameter as a JSON. Using the provided parameter - the chat ID, we will find and return the relevant chat from the DB:\n\n[{]: <helper> (diffStep 4.3 files=\"schema/resolvers\" module=\"server\")\n\n#### [__Server__ Step 4.3: Add chat field to Query type](https://github.com/Urigo/WhatsApp-Clone-Server/commit/460fb0fabe1aa0cc6cddfbe070870f318286d83e)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -20,6 +20,10 @@\n â”Š20â”Š20â”Š    chats() {\n â”Š21â”Š21â”Š      return chats;\n â”Š22â”Š22â”Š    },\n+â”Š  â”Š23â”Š\n+â”Š  â”Š24â”Š    chat(root: any, { chatId }: any) {\n+â”Š  â”Š25â”Š      return chats.find(c => c.id === chatId);\n+â”Š  â”Š26â”Š    },\n â”Š23â”Š27â”Š  },\n â”Š24â”Š28â”Š};\n â”Š25â”Š29â”Š\n```\n\n[}]: #\n\n> More about the resolver signature can be read in [Apollo-GraphQL's official docs page](https://www.apollographql.com/docs/apollo-server/essentials/data.html#type-signature).\n\nNow we will add a test suite:\n\n[{]: <helper> (diffStep 4.3 files=\"tests/queries/getChat.test\" module=\"server\")\n\n#### [__Server__ Step 4.3: Add chat field to Query type](https://github.com/Urigo/WhatsApp-Clone-Server/commit/460fb0fabe1aa0cc6cddfbe070870f318286d83e)\n\n##### Added tests&#x2F;queries&#x2F;getChat.test.ts\n```diff\n@@ -0,0 +1,33 @@\n+â”Š  â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n+â”Š  â”Š 2â”Šimport { ApolloServer, gql } from 'apollo-server-express';\n+â”Š  â”Š 3â”Šimport schema from '../../schema';\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šdescribe('Query.chat', () => {\n+â”Š  â”Š 6â”Š  it('should fetch specified chat', async () => {\n+â”Š  â”Š 7â”Š    const server = new ApolloServer({ schema });\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Š    const { query } = createTestClient(server);\n+â”Š  â”Š10â”Š\n+â”Š  â”Š11â”Š    const res = await query({\n+â”Š  â”Š12â”Š      variables: { chatId: '1' },\n+â”Š  â”Š13â”Š      query: gql`\n+â”Š  â”Š14â”Š        query GetChat($chatId: ID!) {\n+â”Š  â”Š15â”Š          chat(chatId: $chatId) {\n+â”Š  â”Š16â”Š            id\n+â”Š  â”Š17â”Š            name\n+â”Š  â”Š18â”Š            picture\n+â”Š  â”Š19â”Š            lastMessage {\n+â”Š  â”Š20â”Š              id\n+â”Š  â”Š21â”Š              content\n+â”Š  â”Š22â”Š              createdAt\n+â”Š  â”Š23â”Š            }\n+â”Š  â”Š24â”Š          }\n+â”Š  â”Š25â”Š        }\n+â”Š  â”Š26â”Š      `,\n+â”Š  â”Š27â”Š    });\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š    expect(res.data).toBeDefined();\n+â”Š  â”Š30â”Š    expect(res.errors).toBeUndefined();\n+â”Š  â”Š31â”Š    expect(res.data).toMatchSnapshot();\n+â”Š  â”Š32â”Š  });\n+â”Š  â”Š33â”Š});\n```\n\n[}]: #\n\nWe can observe the snapshot created by Jest to get a better understanding of how the response should look like:\n\n[{]: <helper> (diffStep 4.3 files=\"__snapshot__\" module=\"server\")\n\n#### [__Server__ Step 4.3: Add chat field to Query type](https://github.com/Urigo/WhatsApp-Clone-Server/commit/460fb0fabe1aa0cc6cddfbe070870f318286d83e)\n\n\n\n[}]: #\n\nIf you experience any TypeScript related issues with the following error:\n\n```\nObject literal may only specify known properties, and 'variables' does not exist in type 'Query'.\n```\n\nAdd the following declaration file to your project:\n\n[{]: <helper> (diffStep 4.3 files=\"types\" module=\"server\")\n\n#### [__Server__ Step 4.3: Add chat field to Query type](https://github.com/Urigo/WhatsApp-Clone-Server/commit/460fb0fabe1aa0cc6cddfbe070870f318286d83e)\n\n##### Added types&#x2F;apollo-server-testing.d.ts\n```diff\n@@ -0,0 +1,27 @@\n+â”Š  â”Š 1â”Šdeclare module 'apollo-server-testing' {\n+â”Š  â”Š 2â”Š  import { ApolloServerBase } from 'apollo-server-core';\n+â”Š  â”Š 3â”Š  import { print, DocumentNode } from 'graphql';\n+â”Š  â”Š 4â”Š  import { GraphQLResponse } from 'graphql-extensions';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Š  type StringOrAst = string | DocumentNode;\n+â”Š  â”Š 7â”Š\n+â”Š  â”Š 8â”Š  // A query must not come with a mutation (and vice versa).\n+â”Š  â”Š 9â”Š  type Query<TVariables> = {\n+â”Š  â”Š10â”Š    query: StringOrAst;\n+â”Š  â”Š11â”Š    mutation?: undefined;\n+â”Š  â”Š12â”Š    variables?: TVariables;\n+â”Š  â”Š13â”Š  };\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”Š  type Mutation<TVariables> = {\n+â”Š  â”Š16â”Š    mutation: StringOrAst;\n+â”Š  â”Š17â”Š    query?: undefined;\n+â”Š  â”Š18â”Š    variables?: TVariables;\n+â”Š  â”Š19â”Š  };\n+â”Š  â”Š20â”Š\n+â”Š  â”Š21â”Š  export const createTestClient: <TVariables>(\n+â”Š  â”Š22â”Š    server: ApolloServerBase\n+â”Š  â”Š23â”Š  ) => {\n+â”Š  â”Š24â”Š    query: (query: Query<TVariables>) => Promise<GraphQLResponse>;\n+â”Š  â”Š25â”Š    mutate: (mutation: Mutation<TVariables>) => Promise<GraphQLResponse>;\n+â”Š  â”Š26â”Š  };\n+â”Š  â”Š27â”Š}\n```\n\n[}]: #\n\nThis is a [known issue](https://github.com/apollographql/apollo-server/issues/2172) in the `apollo-server-testing` package and has a pending [fix PR](https://github.com/apollographql/apollo-server/pull/2307).\nNow getting back to the client, let's implement a basic version of the `ChatRoomScreen` where we will fetch the new query and print it to the screen:\n\n[{]: <helper> (diffStep 6.2 module=\"client\")\n\n#### [__Client__ Step 6.2: Add basic ChatRoomScreen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/f04e2d17c798e66b5995d67106957c94e9125b3e)\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -1,5 +1,11 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n-â”Š 2â”Š  â”Šimport { BrowserRouter, Route, Redirect, Switch } from 'react-router-dom';\n+â”Š  â”Š 2â”Šimport {\n+â”Š  â”Š 3â”Š  BrowserRouter,\n+â”Š  â”Š 4â”Š  Route,\n+â”Š  â”Š 5â”Š  Redirect,\n+â”Š  â”Š 6â”Š  Switch,\n+â”Š  â”Š 7â”Š  RouteComponentProps,\n+â”Š  â”Š 8â”Š} from 'react-router-dom';\n â”Š 3â”Š 9â”Šimport ChatRoomScreen from './components/ChatRoomScreen';\n â”Š 4â”Š10â”Šimport ChatsListScreen from './components/ChatsListScreen';\n â”Š 5â”Š11â”Š\n```\n```diff\n@@ -7,7 +13,14 @@\n â”Š 7â”Š13â”Š  <BrowserRouter>\n â”Š 8â”Š14â”Š    <Switch>\n â”Š 9â”Š15â”Š      <Route exact path=\"/chats\" component={ChatsListScreen} />\n-â”Š10â”Š  â”Š      <Route exact path=\"/chats/:chatId\" component={ChatRoomScreen} />\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š      <Route\n+â”Š  â”Š18â”Š        exact\n+â”Š  â”Š19â”Š        path=\"/chats/:chatId\"\n+â”Š  â”Š20â”Š        component={({ match }: RouteComponentProps<{ chatId: string }>) => (\n+â”Š  â”Š21â”Š          <ChatRoomScreen chatId={match.params.chatId} />\n+â”Š  â”Š22â”Š        )}\n+â”Š  â”Š23â”Š      />\n â”Š11â”Š24â”Š    </Switch>\n â”Š12â”Š25â”Š    <Route exact path=\"/\" render={redirectToChats} />\n â”Š13â”Š26â”Š  </BrowserRouter>\n```\n\n##### Added src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -0,0 +1,76 @@\n+â”Š  â”Š 1â”Šimport React from 'react';\n+â”Š  â”Š 2â”Šimport { useMemo, useState } from 'react';\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šconst getChatQuery = `\n+â”Š  â”Š 5â”Š  query GetChat($chatId: ID!) {\n+â”Š  â”Š 6â”Š    chat(chatId: $chatId) {\n+â”Š  â”Š 7â”Š      id\n+â”Š  â”Š 8â”Š      name\n+â”Š  â”Š 9â”Š      picture\n+â”Š  â”Š10â”Š      messages {\n+â”Š  â”Š11â”Š        id\n+â”Š  â”Š12â”Š        content\n+â”Š  â”Š13â”Š        createdAt\n+â”Š  â”Š14â”Š      }\n+â”Š  â”Š15â”Š    }\n+â”Š  â”Š16â”Š  }\n+â”Š  â”Š17â”Š`;\n+â”Š  â”Š18â”Š\n+â”Š  â”Š19â”Šinterface ChatRoomScreenParams {\n+â”Š  â”Š20â”Š  chatId: string;\n+â”Š  â”Š21â”Š}\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Šinterface ChatQueryMessage {\n+â”Š  â”Š24â”Š  id: string;\n+â”Š  â”Š25â”Š  content: string;\n+â”Š  â”Š26â”Š  createdAt: Date;\n+â”Š  â”Š27â”Š}\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Šinterface ChatQueryResult {\n+â”Š  â”Š30â”Š  id: string;\n+â”Š  â”Š31â”Š  name: string;\n+â”Š  â”Š32â”Š  picture: string;\n+â”Š  â”Š33â”Š  messages: Array<ChatQueryMessage>;\n+â”Š  â”Š34â”Š}\n+â”Š  â”Š35â”Š\n+â”Š  â”Š36â”Štype OptionalChatQueryResult = ChatQueryResult | null;\n+â”Š  â”Š37â”Š\n+â”Š  â”Š38â”Šconst ChatRoomScreen: React.FC<ChatRoomScreenParams> = ({ chatId }) => {\n+â”Š  â”Š39â”Š  const [chat, setChat] = useState<OptionalChatQueryResult>(null);\n+â”Š  â”Š40â”Š\n+â”Š  â”Š41â”Š  useMemo(async () => {\n+â”Š  â”Š42â”Š    const body = await fetch(`${process.env.REACT_APP_SERVER_URL}/graphql`, {\n+â”Š  â”Š43â”Š      method: 'POST',\n+â”Š  â”Š44â”Š      headers: {\n+â”Š  â”Š45â”Š        'Content-Type': 'application/json',\n+â”Š  â”Š46â”Š      },\n+â”Š  â”Š47â”Š      body: JSON.stringify({\n+â”Š  â”Š48â”Š        query: getChatQuery,\n+â”Š  â”Š49â”Š        variables: { chatId },\n+â”Š  â”Š50â”Š      }),\n+â”Š  â”Š51â”Š    });\n+â”Š  â”Š52â”Š    const {\n+â”Š  â”Š53â”Š      data: { chat },\n+â”Š  â”Š54â”Š    } = await body.json();\n+â”Š  â”Š55â”Š    setChat(chat);\n+â”Š  â”Š56â”Š  }, [chatId]);\n+â”Š  â”Š57â”Š\n+â”Š  â”Š58â”Š  if (!chat) return null;\n+â”Š  â”Š59â”Š\n+â”Š  â”Š60â”Š  return (\n+â”Š  â”Š61â”Š    <div>\n+â”Š  â”Š62â”Š      <img src={chat.picture} alt=\"Profile\" />\n+â”Š  â”Š63â”Š      <div>{chat.name}</div>\n+â”Š  â”Š64â”Š      <ul>\n+â”Š  â”Š65â”Š        {chat.messages.map(message => (\n+â”Š  â”Š66â”Š          <li key={message.id}>\n+â”Š  â”Š67â”Š            <div>{message.content}</div>\n+â”Š  â”Š68â”Š            <div>{message.createdAt}</div>\n+â”Š  â”Š69â”Š          </li>\n+â”Š  â”Š70â”Š        ))}\n+â”Š  â”Š71â”Š      </ul>\n+â”Š  â”Š72â”Š    </div>\n+â”Š  â”Š73â”Š  );\n+â”Š  â”Š74â”Š};\n+â”Š  â”Š75â”Š\n+â”Š  â”Š76â”Šexport default ChatRoomScreen;\n```\n\n[}]: #\n\nNote how we used the `match.params.chatId` variable to get the selected chat ID.\nThe `match` prop is defined and provided to us by the `<Route />` component, since it interfaces directly with the `ChatRoomScreen`.\nMore about that can be read in the [official docs page](https://reacttraining.com/react-router/core/api/match).\n\nIn many examples online, you can see people pass the `match` prop directly to the component.\nThe main issue with that is that this makes the component being usable only by a router, but the truth is that the component\ndoesn't care if it's consumed by a router or another parents component as long as they will pass the `chatId` prop.\n\nSo we need to make sure the interface of the ChatRoom component defines those requierements right.\n\nNext we will call our server from the component with the right query and store the result on a `useState` hook.\n\nNow, because we are using GraphQL, we know the types of the result that we are going to get, so let's create Typescript interfaces that\ndescribe the data we're going to get from the server.\n\nIf you'll run the application and type `/chats/1` in the URL bar, this is what you should see on the screen:\n\n![naked-chat](https://user-images.githubusercontent.com/7648874/54664314-d4096b80-4b1e-11e9-9e06-1323cf7b0abe.png)\n\nThe view has no styling at all but it should be fixed in a moment.\nTo make navigation more convenient we will add an `onClick` listener for each chat item in the `ChatsList`.\nUsing the [history](https://reacttraining.com/react-router/core/api/history) object, provided to us by the `<Route />` component,\nwe will navigate to the correlated `ChatRoomScreen`:\n\nFirst let's install the `history` package:\n\n    $ yarn add history @types/history\n\n[{]: <helper> (diffStep 6.3 module=\"client\")\n\n#### [__Client__ Step 6.3: Navigate to chat on click](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/2173002932e08b8495237fa53deffdd7c7db4b07)\n\n##### Changed package.json\n```diff\n@@ -9,12 +9,14 @@\n â”Š 9â”Š 9â”Š  \"dependencies\": {\n â”Š10â”Š10â”Š    \"@material-ui/core\": \"4.3.2\",\n â”Š11â”Š11â”Š    \"@material-ui/icons\": \"4.2.1\",\n+â”Š  â”Š12â”Š    \"@types/history\": \"4.7.2\",\n â”Š12â”Š13â”Š    \"@types/jest\": \"24.0.17\",\n â”Š13â”Š14â”Š    \"@types/node\": \"12.7.1\",\n â”Š14â”Š15â”Š    \"@types/react\": \"16.8.23\",\n â”Š15â”Š16â”Š    \"@types/react-dom\": \"16.8.5\",\n â”Š16â”Š17â”Š    \"@types/react-router-dom\": \"4.3.4\",\n â”Š17â”Š18â”Š    \"@types/styled-components\": \"4.1.18\",\n+â”Š  â”Š19â”Š    \"history\": \"4.9.0\",\n â”Š18â”Š20â”Š    \"moment\": \"2.24.0\",\n â”Š19â”Š21â”Š    \"prettier\": \"1.18.2\",\n â”Š20â”Š22â”Š    \"react\": \"16.9.0\",\n```\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -2,7 +2,8 @@\n â”Š2â”Š2â”Šimport moment from 'moment';\n â”Š3â”Š3â”Šimport { List, ListItem } from '@material-ui/core';\n â”Š4â”Š4â”Šimport styled from 'styled-components';\n-â”Š5â”Š â”Šimport { useState, useMemo } from 'react';\n+â”Š â”Š5â”Šimport { useCallback, useState, useMemo } from 'react';\n+â”Š â”Š6â”Šimport { History } from 'history';\n â”Š6â”Š7â”Š\n â”Š7â”Š8â”Šconst Container = styled.div`\n â”Š8â”Š9â”Š  height: calc(100% - 56px);\n```\n```diff\n@@ -71,7 +72,11 @@\n â”Š71â”Š72â”Š  }\n â”Š72â”Š73â”Š`;\n â”Š73â”Š74â”Š\n-â”Š74â”Š  â”Šconst ChatsList = () => {\n+â”Š  â”Š75â”Šinterface ChatsListProps {\n+â”Š  â”Š76â”Š  history: History;\n+â”Š  â”Š77â”Š}\n+â”Š  â”Š78â”Š\n+â”Š  â”Š79â”Šconst ChatsList: React.FC<ChatsListProps> = ({ history }) => {\n â”Š75â”Š80â”Š  const [chats, setChats] = useState<any[]>([]);\n â”Š76â”Š81â”Š\n â”Š77â”Š82â”Š  useMemo(async () => {\n```\n```diff\n@@ -88,11 +93,22 @@\n â”Š 88â”Š 93â”Š    setChats(chats);\n â”Š 89â”Š 94â”Š  }, []);\n â”Š 90â”Š 95â”Š\n+â”Š   â”Š 96â”Š  const navToChat = useCallback(\n+â”Š   â”Š 97â”Š    chat => {\n+â”Š   â”Š 98â”Š      history.push(`chats/${chat.id}`);\n+â”Š   â”Š 99â”Š    },\n+â”Š   â”Š100â”Š    [history]\n+â”Š   â”Š101â”Š  );\n+â”Š   â”Š102â”Š\n â”Š 91â”Š103â”Š  return (\n â”Š 92â”Š104â”Š    <Container>\n â”Š 93â”Š105â”Š      <StyledList>\n â”Š 94â”Š106â”Š        {chats.map(chat => (\n-â”Š 95â”Š   â”Š          <StyledListItem key={chat.id} button>\n+â”Š   â”Š107â”Š          <StyledListItem\n+â”Š   â”Š108â”Š            key={chat.id}\n+â”Š   â”Š109â”Š            data-testid=\"chat\"\n+â”Š   â”Š110â”Š            button\n+â”Š   â”Š111â”Š            onClick={navToChat.bind(null, chat)}>\n â”Š 96â”Š112â”Š            <ChatPicture\n â”Š 97â”Š113â”Š              data-testid=\"picture\"\n â”Š 98â”Š114â”Š              src={chat.picture}\n```\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;index.tsx\n```diff\n@@ -2,15 +2,20 @@\n â”Š 2â”Š 2â”Šimport ChatsNavbar from './ChatsNavbar';\n â”Š 3â”Š 3â”Šimport ChatsList from './ChatsList';\n â”Š 4â”Š 4â”Šimport styled from 'styled-components';\n+â”Š  â”Š 5â”Šimport { History } from 'history';\n â”Š 5â”Š 6â”Š\n â”Š 6â”Š 7â”Šconst Container = styled.div`\n â”Š 7â”Š 8â”Š  height: 100vh;\n â”Š 8â”Š 9â”Š`;\n â”Š 9â”Š10â”Š\n-â”Š10â”Š  â”Šconst ChatsListScreen: React.FC = () => (\n+â”Š  â”Š11â”Šinterface ChatsListScreenProps {\n+â”Š  â”Š12â”Š  history: History;\n+â”Š  â”Š13â”Š}\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”Šconst ChatsListScreen: React.FC<ChatsListScreenProps> = ({ history }) => (\n â”Š11â”Š16â”Š  <Container>\n â”Š12â”Š17â”Š    <ChatsNavbar />\n-â”Š13â”Š  â”Š    <ChatsList />\n+â”Š  â”Š18â”Š    <ChatsList history={history} />\n â”Š14â”Š19â”Š  </Container>\n â”Š15â”Š20â”Š);\n```\n\n[}]: #\n\nAnd add test the new logic:\n\n[{]: <helper> (diffStep 6.4 module=\"client\")\n\n#### [__Client__ Step 6.4: Test new navigation logic](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/24d35f42c7c2610a688dad3d5d67e873f981144f)\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.test.tsx\n```diff\n@@ -1,10 +1,24 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n â”Š 2â”Š 2â”Šimport ReactDOM from 'react-dom';\n-â”Š 3â”Š  â”Šimport { cleanup, render, waitForDomChange } from '@testing-library/react';\n+â”Š  â”Š 3â”Šimport {\n+â”Š  â”Š 4â”Š  cleanup,\n+â”Š  â”Š 5â”Š  render,\n+â”Š  â”Š 6â”Š  fireEvent,\n+â”Š  â”Š 7â”Š  wait,\n+â”Š  â”Š 8â”Š  waitForDomChange,\n+â”Š  â”Š 9â”Š} from '@testing-library/react';\n â”Š 4â”Š10â”Šimport ChatsList from './ChatsList';\n+â”Š  â”Š11â”Šimport { createBrowserHistory } from 'history';\n â”Š 5â”Š12â”Š\n â”Š 6â”Š13â”Šdescribe('ChatsList', () => {\n-â”Š 7â”Š  â”Š  afterEach(cleanup);\n+â”Š  â”Š14â”Š  afterEach(() => {\n+â”Š  â”Š15â”Š    cleanup();\n+â”Š  â”Š16â”Š    delete window.location;\n+â”Š  â”Š17â”Š\n+â”Š  â”Š18â”Š    window.location = {\n+â”Š  â”Š19â”Š        href: '/',\n+â”Š  â”Š20â”Š    };\n+â”Š  â”Š21â”Š  });\n â”Š 8â”Š22â”Š\n â”Š 9â”Š23â”Š  it('renders fetched chats data', async () => {\n â”Š10â”Š24â”Š    fetchMock.mockResponseOnce(\n```\n```diff\n@@ -40,4 +54,39 @@\n â”Š40â”Š54â”Š      expect(getByTestId('date')).toHaveTextContent('02:00');\n â”Š41â”Š55â”Š    }\n â”Š42â”Š56â”Š  });\n-â”Š43â”Š  â”Š});ðŸš«â†µ\n+â”Š  â”Š57â”Š\n+â”Š  â”Š58â”Š  it('should navigate to the target chat room on chat item click', async () => {\n+â”Š  â”Š59â”Š    fetchMock.mockResponseOnce(\n+â”Š  â”Š60â”Š      JSON.stringify({\n+â”Š  â”Š61â”Š        data: {\n+â”Š  â”Š62â”Š          chats: [\n+â”Š  â”Š63â”Š            {\n+â”Š  â”Š64â”Š              id: 1,\n+â”Š  â”Š65â”Š              name: 'Foo Bar',\n+â”Š  â”Š66â”Š              picture: 'https://localhost:4000/picture.jpg',\n+â”Š  â”Š67â”Š              lastMessage: {\n+â”Š  â”Š68â”Š                id: 1,\n+â”Š  â”Š69â”Š                content: 'Hello',\n+â”Š  â”Š70â”Š                createdAt: new Date('1 Jan 2019 GMT'),\n+â”Š  â”Š71â”Š              },\n+â”Š  â”Š72â”Š            },\n+â”Š  â”Š73â”Š          ],\n+â”Š  â”Š74â”Š        },\n+â”Š  â”Š75â”Š      })\n+â”Š  â”Š76â”Š    );\n+â”Š  â”Š77â”Š\n+â”Š  â”Š78â”Š    const history = createBrowserHistory();\n+â”Š  â”Š79â”Š\n+â”Š  â”Š80â”Š    {\n+â”Š  â”Š81â”Š      const { container, getByTestId } = render(\n+â”Š  â”Š82â”Š        <ChatsList history={history} />\n+â”Š  â”Š83â”Š      );\n+â”Š  â”Š84â”Š\n+â”Š  â”Š85â”Š      await waitForDomChange({ container });\n+â”Š  â”Š86â”Š\n+â”Š  â”Š87â”Š      fireEvent.click(getByTestId('chat'));\n+â”Š  â”Š88â”Š\n+â”Š  â”Š89â”Š      await wait(() => expect(history.location.pathname).toEqual('/chats/1'));\n+â”Š  â”Š90â”Š    }\n+â”Š  â”Š91â”Š  });\n+â”Š  â”Š92â”Š});\n```\n\n[}]: #\n\nIf you'll click on the chat item you'll see that the screen changes very suddenly.\nWe can smooth the transition by animating it with CSS.\nLuckily we don't need to implemented such mechanism manually because there's a package that can do that for us - [`react-router-transition`](https://www.npmjs.com/package/react-router-transition):\n\n    $ yarn add react-router-transition\n\nAnd let's add the mising types for the library:\n\n[{]: <helper> (diffStep 6.5 files=\"react-app-env.d.ts\" module=\"client\")\n\n#### [__Client__ Step 6.5: Animate route switching](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/61bec756f13ffa4afc1a3226386522c12bb61990)\n\n##### Changed src&#x2F;react-app-env.d.ts\n```diff\n@@ -1 +1,3 @@\n â”Š1â”Š1â”Š/// <reference types=\"react-scripts\" />\n+â”Š â”Š2â”Š\n+â”Š â”Š3â”Šdeclare module 'react-router-transition';\n```\n\n[}]: #\n\nUsing this package, we will create a custom `Switch` component that will play an animation for all its subordinate `Route` components.\nThe animation is defined by the user using a component called `AnimatedSwitch` as specified in the [package's docs page](http://maisano.github.io/react-router-transition/animated-switch/props).\nSo first, let's create our switch component that will play a smooth transition switching routes:\n\n[{]: <helper> (diffStep 6.5 files=\"AnimatedSwitch\" module=\"client\")\n\n#### [__Client__ Step 6.5: Animate route switching](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/61bec756f13ffa4afc1a3226386522c12bb61990)\n\n##### Added src&#x2F;components&#x2F;AnimatedSwitch.tsx\n```diff\n@@ -0,0 +1,38 @@\n+â”Š  â”Š 1â”Šimport { Switch } from 'react-router-dom';\n+â”Š  â”Š 2â”Šimport { AnimatedSwitch, spring } from 'react-router-transition';\n+â”Š  â”Š 3â”Šimport styled from 'styled-components';\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Š// A workaround to make test pass\n+â”Š  â”Š 6â”Šconst SwitchComponent =\n+â”Š  â”Š 7â”Š  process.env.NODE_ENV === 'test' ? Switch : AnimatedSwitch;\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Šconst glide = (val: number) =>\n+â”Š  â”Š10â”Š  spring(val, {\n+â”Š  â”Š11â”Š    stiffness: 174,\n+â”Š  â”Š12â”Š    damping: 24,\n+â”Š  â”Š13â”Š  });\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”Šconst mapStyles = (styles: any) => ({\n+â”Š  â”Š16â”Š  transform: `translateX(${styles.offset}%)`,\n+â”Š  â”Š17â”Š});\n+â”Š  â”Š18â”Š\n+â”Š  â”Š19â”Šconst MyAnimatedSwitch = styled(SwitchComponent).attrs(() => ({\n+â”Š  â”Š20â”Š  atEnter: { offset: 100 },\n+â”Š  â”Š21â”Š  atLeave: { offset: glide(-100) },\n+â”Š  â”Š22â”Š  atActive: { offset: glide(0) },\n+â”Š  â”Š23â”Š  mapStyles,\n+â”Š  â”Š24â”Š}))`\n+â”Š  â”Š25â”Š  position: relative;\n+â”Š  â”Š26â”Š  overflow: hidden;\n+â”Š  â”Š27â”Š  height: 100vh;\n+â”Š  â”Š28â”Š  width: 100vw;\n+â”Š  â”Š29â”Š\n+â”Š  â”Š30â”Š  > div {\n+â”Š  â”Š31â”Š    position: absolute;\n+â”Š  â”Š32â”Š    overflow: hidden;\n+â”Š  â”Š33â”Š    height: 100vh;\n+â”Š  â”Š34â”Š    width: 100vw;\n+â”Š  â”Š35â”Š  }\n+â”Š  â”Š36â”Š`;\n+â”Š  â”Š37â”Š\n+â”Š  â”Š38â”Šexport default MyAnimatedSwitch;\n```\n\n[}]: #\n\nAnd then replace it with the main `Switch` component in our app:\n\n[{]: <helper> (diffStep 6.5 files=\"App\" module=\"client\")\n\n#### [__Client__ Step 6.5: Animate route switching](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/61bec756f13ffa4afc1a3226386522c12bb61990)\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -3,15 +3,15 @@\n â”Š 3â”Š 3â”Š  BrowserRouter,\n â”Š 4â”Š 4â”Š  Route,\n â”Š 5â”Š 5â”Š  Redirect,\n-â”Š 6â”Š  â”Š  Switch,\n â”Š 7â”Š 6â”Š  RouteComponentProps,\n â”Š 8â”Š 7â”Š} from 'react-router-dom';\n â”Š 9â”Š 8â”Šimport ChatRoomScreen from './components/ChatRoomScreen';\n â”Š10â”Š 9â”Šimport ChatsListScreen from './components/ChatsListScreen';\n+â”Š  â”Š10â”Šimport AnimatedSwitch from './components/AnimatedSwitch';\n â”Š11â”Š11â”Š\n â”Š12â”Š12â”Šconst App: React.FC = () => (\n â”Š13â”Š13â”Š  <BrowserRouter>\n-â”Š14â”Š  â”Š    <Switch>\n+â”Š  â”Š14â”Š    <AnimatedSwitch>\n â”Š15â”Š15â”Š      <Route exact path=\"/chats\" component={ChatsListScreen} />\n â”Š16â”Š16â”Š\n â”Š17â”Š17â”Š      <Route\n```\n```diff\n@@ -21,7 +21,7 @@\n â”Š21â”Š21â”Š          <ChatRoomScreen chatId={match.params.chatId} />\n â”Š22â”Š22â”Š        )}\n â”Š23â”Š23â”Š      />\n-â”Š24â”Š  â”Š    </Switch>\n+â”Š  â”Š24â”Š    </AnimatedSwitch>\n â”Š25â”Š25â”Š    <Route exact path=\"/\" render={redirectToChats} />\n â”Š26â”Š26â”Š  </BrowserRouter>\n â”Š27â”Š27â”Š);\n```\n\n[}]: #\n\nBoth components act identically and thus there shall be no special treatment. Behold the new transition effect:\n\n![transition-demo](https://user-images.githubusercontent.com/7648874/54739398-ebb22400-4bf2-11e9-8d4c-2aeb65deeb92.gif)\n\nThe final screen will be composed out of 3 components:\n\n\n\n*   A navigation bar.\n*   A messages list.\n*   A message input.\n\nWe will create a new directory under the path `public/assets` and inside we will download and place a couple of assets which are necessary for our view:\n\n*   [chat-background.jpg](https://raw.githubusercontent.com/Urigo/WhatsApp-Clone-Client-Angular/master/src/assets/chat-background.jpg)\n*   [message-mine.png](https://raw.githubusercontent.com/Urigo/WhatsApp-Clone-Client-Angular/master/src/assets/message-mine.png)\n\nIn the main `index.ts` file of the screen we will simply import all 3 in the right order.\nWe will start with the most simple one - the `ChatRoomNavbar`.\nThe navbar should show the picture of the chat we're currently at and its name,\nalong with a back button that will bring us back to the `ChatsListScreen`:\n\n[{]: <helper> (diffStep 6.6 files=\"ChatNavbar\" module=\"client\")\n\n#### [__Client__ Step 6.6: Implement ChatRoomScreen components](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/af4d95ac6c0c12669c02495ed34c67360820fa4b)\n\n##### Added src&#x2F;components&#x2F;ChatRoomScreen&#x2F;ChatNavbar.tsx\n```diff\n@@ -0,0 +1,59 @@\n+â”Š  â”Š 1â”Šimport Button from '@material-ui/core/Button';\n+â”Š  â”Š 2â”Šimport Toolbar from '@material-ui/core/Toolbar';\n+â”Š  â”Š 3â”Šimport ArrowBackIcon from '@material-ui/icons/ArrowBack';\n+â”Š  â”Š 4â”Šimport React from 'react';\n+â”Š  â”Š 5â”Šimport { useCallback } from 'react';\n+â”Š  â”Š 6â”Šimport styled from 'styled-components';\n+â”Š  â”Š 7â”Šimport { History } from 'history';\n+â”Š  â”Š 8â”Šimport { ChatQueryResult } from './index';\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Šconst Container = styled(Toolbar)`\n+â”Š  â”Š11â”Š  padding: 0;\n+â”Š  â”Š12â”Š  display: flex;\n+â”Š  â”Š13â”Š  flex-direction: row;\n+â”Š  â”Š14â”Š  background-color: var(--primary-bg);\n+â”Š  â”Š15â”Š  color: var(--primary-text);\n+â”Š  â”Š16â”Š`;\n+â”Š  â”Š17â”Š\n+â”Š  â”Š18â”Šconst BackButton = styled(Button)`\n+â”Š  â”Š19â”Š  svg {\n+â”Š  â”Š20â”Š    color: var(--primary-text);\n+â”Š  â”Š21â”Š  }\n+â”Š  â”Š22â”Š`;\n+â”Š  â”Š23â”Š\n+â”Š  â”Š24â”Šconst Picture = styled.img`\n+â”Š  â”Š25â”Š  height: 40px;\n+â”Š  â”Š26â”Š  width: 40px;\n+â”Š  â”Š27â”Š  margin-top: 3px;\n+â”Š  â”Š28â”Š  margin-left: -22px;\n+â”Š  â”Š29â”Š  object-fit: cover;\n+â”Š  â”Š30â”Š  padding: 5px;\n+â”Š  â”Š31â”Š  border-radius: 50%;\n+â”Š  â”Š32â”Š`;\n+â”Š  â”Š33â”Š\n+â”Š  â”Š34â”Šconst Name = styled.div`\n+â”Š  â”Š35â”Š  line-height: 56px;\n+â”Š  â”Š36â”Š`;\n+â”Š  â”Š37â”Š\n+â”Š  â”Š38â”Šinterface ChatNavbarProps {\n+â”Š  â”Š39â”Š  history: History;\n+â”Š  â”Š40â”Š  chat: ChatQueryResult;\n+â”Š  â”Š41â”Š}\n+â”Š  â”Š42â”Š\n+â”Š  â”Š43â”Šconst ChatNavbar: React.FC<ChatNavbarProps> = ({ chat, history }) => {\n+â”Š  â”Š44â”Š  const navBack = useCallback(() => {\n+â”Š  â”Š45â”Š    history.replace('/chats');\n+â”Š  â”Š46â”Š  }, [history]);\n+â”Š  â”Š47â”Š\n+â”Š  â”Š48â”Š  return (\n+â”Š  â”Š49â”Š    <Container>\n+â”Š  â”Š50â”Š      <BackButton onClick={navBack}>\n+â”Š  â”Š51â”Š        <ArrowBackIcon />\n+â”Š  â”Š52â”Š      </BackButton>\n+â”Š  â”Š53â”Š      <Picture src={chat.picture} />\n+â”Š  â”Š54â”Š      <Name>{chat.name}</Name>\n+â”Š  â”Š55â”Š    </Container>\n+â”Š  â”Š56â”Š  );\n+â”Š  â”Š57â”Š};\n+â”Š  â”Š58â”Š\n+â”Š  â”Š59â”Šexport default ChatNavbar;\n```\n\n[}]: #\n\nNext, would be the `MesagesList` component, where we will see a scrollable list of all the messages of the active chat:\n\n[{]: <helper> (diffStep 6.6 files=\"MessagesList\" module=\"client\")\n\n#### [__Client__ Step 6.6: Implement ChatRoomScreen components](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/af4d95ac6c0c12669c02495ed34c67360820fa4b)\n\n##### Added src&#x2F;components&#x2F;ChatRoomScreen&#x2F;MessagesList.tsx\n```diff\n@@ -0,0 +1,78 @@\n+â”Š  â”Š 1â”Šimport moment from 'moment';\n+â”Š  â”Š 2â”Šimport React from 'react';\n+â”Š  â”Š 3â”Šimport styled from 'styled-components';\n+â”Š  â”Š 4â”Šimport { ChatQueryMessage } from './index';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šconst Container = styled.div`\n+â”Š  â”Š 7â”Š  display: block;\n+â”Š  â”Š 8â”Š  flex: 2;\n+â”Š  â”Š 9â”Š  overflow-y: overlay;\n+â”Š  â”Š10â”Š  padding: 0 15px;\n+â”Š  â”Š11â”Š`;\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Šconst MessageItem = styled.div`\n+â”Š  â”Š14â”Š  float: right;\n+â”Š  â”Š15â”Š  background-color: #dcf8c6;\n+â”Š  â”Š16â”Š  display: inline-block;\n+â”Š  â”Š17â”Š  position: relative;\n+â”Š  â”Š18â”Š  max-width: 100%;\n+â”Š  â”Š19â”Š  border-radius: 7px;\n+â”Š  â”Š20â”Š  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.15);\n+â”Š  â”Š21â”Š  margin-top: 10px;\n+â”Š  â”Š22â”Š  margin-bottom: 10px;\n+â”Š  â”Š23â”Š  clear: both;\n+â”Š  â”Š24â”Š\n+â”Š  â”Š25â”Š  &::after {\n+â”Š  â”Š26â”Š    content: '';\n+â”Š  â”Š27â”Š    display: table;\n+â”Š  â”Š28â”Š    clear: both;\n+â”Š  â”Š29â”Š  }\n+â”Š  â”Š30â”Š\n+â”Š  â”Š31â”Š  &::before {\n+â”Š  â”Š32â”Š    background-image: url(/assets/message-mine.png);\n+â”Š  â”Š33â”Š    content: '';\n+â”Š  â”Š34â”Š    position: absolute;\n+â”Š  â”Š35â”Š    bottom: 3px;\n+â”Š  â”Š36â”Š    width: 12px;\n+â”Š  â”Š37â”Š    height: 19px;\n+â”Š  â”Š38â”Š    right: -11px;\n+â”Š  â”Š39â”Š    background-position: 50% 50%;\n+â”Š  â”Š40â”Š    background-repeat: no-repeat;\n+â”Š  â”Š41â”Š    background-size: contain;\n+â”Š  â”Š42â”Š  }\n+â”Š  â”Š43â”Š`;\n+â”Š  â”Š44â”Š\n+â”Š  â”Š45â”Šconst Contents = styled.div`\n+â”Š  â”Š46â”Š  padding: 5px 7px;\n+â”Š  â”Š47â”Š  word-wrap: break-word;\n+â”Š  â”Š48â”Š\n+â”Š  â”Š49â”Š  &::after {\n+â”Š  â”Š50â”Š    content: ' \\\\00a0\\\\00a0\\\\00a0\\\\00a0\\\\00a0\\\\00a0\\\\00a0\\\\00a0\\\\00a0\\\\00a0\\\\00a0\\\\00a0\\\\00a0\\\\00a0\\\\00a0\\\\00a0\\\\00a0\\\\00a0\\\\00a0';\n+â”Š  â”Š51â”Š    display: inline;\n+â”Š  â”Š52â”Š  }\n+â”Š  â”Š53â”Š`;\n+â”Š  â”Š54â”Š\n+â”Š  â”Š55â”Šconst Timestamp = styled.div`\n+â”Š  â”Š56â”Š  position: absolute;\n+â”Š  â”Š57â”Š  bottom: 2px;\n+â”Š  â”Š58â”Š  right: 7px;\n+â”Š  â”Š59â”Š  color: gray;\n+â”Š  â”Š60â”Š  font-size: 12px;\n+â”Š  â”Š61â”Š`;\n+â”Š  â”Š62â”Š\n+â”Š  â”Š63â”Šinterface MessagesListProps {\n+â”Š  â”Š64â”Š  messages: Array<ChatQueryMessage>;\n+â”Š  â”Š65â”Š}\n+â”Š  â”Š66â”Š\n+â”Š  â”Š67â”Šconst MessagesList: React.FC<MessagesListProps> = ({ messages }) => (\n+â”Š  â”Š68â”Š  <Container>\n+â”Š  â”Š69â”Š    {messages.map((message: any) => (\n+â”Š  â”Š70â”Š      <MessageItem key={message.id}>\n+â”Š  â”Š71â”Š        <Contents>{message.content}</Contents>\n+â”Š  â”Š72â”Š        <Timestamp>{moment(message.createdAt).format('HH:mm')}</Timestamp>\n+â”Š  â”Š73â”Š      </MessageItem>\n+â”Š  â”Š74â”Š    ))}\n+â”Š  â”Š75â”Š  </Container>\n+â”Š  â”Š76â”Š);\n+â”Š  â”Š77â”Š\n+â”Š  â”Š78â”Šexport default MessagesList;\n```\n\n[}]: #\n\nAnd finally, would be the `MessageInput` component which will trigger an event whenever we type and submit a new message:\n\n[{]: <helper> (diffStep 6.6 files=\"MessageInput\" module=\"client\")\n\n#### [__Client__ Step 6.6: Implement ChatRoomScreen components](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/af4d95ac6c0c12669c02495ed34c67360820fa4b)\n\n##### Added src&#x2F;components&#x2F;ChatRoomScreen&#x2F;MessageInput.tsx\n```diff\n@@ -0,0 +1,53 @@\n+â”Š  â”Š 1â”Šimport Button from '@material-ui/core/Button';\n+â”Š  â”Š 2â”Šimport SendIcon from '@material-ui/icons/Send';\n+â”Š  â”Š 3â”Šimport React from 'react';\n+â”Š  â”Š 4â”Šimport styled from 'styled-components';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šconst Container = styled.div`\n+â”Š  â”Š 7â”Š  display: flex;\n+â”Š  â”Š 8â”Š  height: 50px;\n+â”Š  â”Š 9â”Š  padding: 5px;\n+â”Š  â”Š10â”Š  width: calc(100% - 10px);\n+â”Š  â”Š11â”Š`;\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Šconst ActualInput = styled.input`\n+â”Š  â”Š14â”Š  width: calc(100% - 50px);\n+â”Š  â”Š15â”Š  border: none;\n+â”Š  â”Š16â”Š  border-radius: 999px;\n+â”Š  â”Š17â”Š  padding: 10px;\n+â”Š  â”Š18â”Š  padding-left: 20px;\n+â”Š  â”Š19â”Š  padding-right: 20px;\n+â”Š  â”Š20â”Š  font-size: 15px;\n+â”Š  â”Š21â”Š  outline: none;\n+â”Š  â”Š22â”Š  box-shadow: 0 1px silver;\n+â”Š  â”Š23â”Š  font-size: 18px;\n+â”Š  â”Š24â”Š  line-height: 45px;\n+â”Š  â”Š25â”Š`;\n+â”Š  â”Š26â”Š\n+â”Š  â”Š27â”Šconst SendButton = styled(Button)`\n+â”Š  â”Š28â”Š  min-width: 50px !important;\n+â”Š  â”Š29â”Š  width: 50px !important;\n+â”Š  â”Š30â”Š  border-radius: 999px !important;\n+â”Š  â”Š31â”Š  background-color: var(--primary-bg) !important;\n+â”Š  â”Š32â”Š  margin: 0 5px !important;\n+â”Š  â”Š33â”Š  margin-right: 0 !important;\n+â”Š  â”Š34â”Š  color: white !important;\n+â”Š  â”Š35â”Š  padding-left: 20px !important;\n+â”Š  â”Š36â”Š\n+â”Š  â”Š37â”Š  svg {\n+â”Š  â”Š38â”Š    margin-left: -3px;\n+â”Š  â”Š39â”Š  }\n+â”Š  â”Š40â”Š`;\n+â”Š  â”Š41â”Š\n+â”Š  â”Š42â”Šconst MessageInput: React.FC = () => {\n+â”Š  â”Š43â”Š  return (\n+â”Š  â”Š44â”Š    <Container>\n+â”Š  â”Š45â”Š      <ActualInput type=\"text\" placeholder=\"Type a message\" />\n+â”Š  â”Š46â”Š      <SendButton variant=\"contained\" color=\"primary\">\n+â”Š  â”Š47â”Š        <SendIcon />\n+â”Š  â”Š48â”Š      </SendButton>\n+â”Š  â”Š49â”Š    </Container>\n+â”Š  â”Š50â”Š  );\n+â”Š  â”Š51â”Š};\n+â”Š  â”Š52â”Š\n+â”Š  â”Š53â”Šexport default MessageInput;\n```\n\n[}]: #\n\nNow that we have all 3 components, we will put them all together in the main `index.ts` file:\n\n[{]: <helper> (diffStep 6.6 files=\"index\" module=\"client\")\n\n#### [__Client__ Step 6.6: Implement ChatRoomScreen components](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/af4d95ac6c0c12669c02495ed34c67360820fa4b)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -1,5 +1,17 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n â”Š 2â”Š 2â”Šimport { useMemo, useState } from 'react';\n+â”Š  â”Š 3â”Šimport styled from 'styled-components';\n+â”Š  â”Š 4â”Šimport ChatNavbar from './ChatNavbar';\n+â”Š  â”Š 5â”Šimport MessageInput from './MessageInput';\n+â”Š  â”Š 6â”Šimport MessagesList from './MessagesList';\n+â”Š  â”Š 7â”Šimport { History } from 'history';\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Šconst Container = styled.div`\n+â”Š  â”Š10â”Š  background: url(/assets/chat-background.jpg);\n+â”Š  â”Š11â”Š  display: flex;\n+â”Š  â”Š12â”Š  flex-flow: column;\n+â”Š  â”Š13â”Š  height: 100vh;\n+â”Š  â”Š14â”Š`;\n â”Š 3â”Š15â”Š\n â”Š 4â”Š16â”Šconst getChatQuery = `\n â”Š 5â”Š17â”Š  query GetChat($chatId: ID!) {\n```\n```diff\n@@ -18,15 +30,16 @@\n â”Š18â”Š30â”Š\n â”Š19â”Š31â”Šinterface ChatRoomScreenParams {\n â”Š20â”Š32â”Š  chatId: string;\n+â”Š  â”Š33â”Š  history: History;\n â”Š21â”Š34â”Š}\n â”Š22â”Š35â”Š\n-â”Š23â”Š  â”Šinterface ChatQueryMessage {\n+â”Š  â”Š36â”Šexport interface ChatQueryMessage {\n â”Š24â”Š37â”Š  id: string;\n â”Š25â”Š38â”Š  content: string;\n â”Š26â”Š39â”Š  createdAt: Date;\n â”Š27â”Š40â”Š}\n â”Š28â”Š41â”Š\n-â”Š29â”Š  â”Šinterface ChatQueryResult {\n+â”Š  â”Š42â”Šexport interface ChatQueryResult {\n â”Š30â”Š43â”Š  id: string;\n â”Š31â”Š44â”Š  name: string;\n â”Š32â”Š45â”Š  picture: string;\n```\n```diff\n@@ -35,7 +48,10 @@\n â”Š35â”Š48â”Š\n â”Š36â”Š49â”Štype OptionalChatQueryResult = ChatQueryResult | null;\n â”Š37â”Š50â”Š\n-â”Š38â”Š  â”Šconst ChatRoomScreen: React.FC<ChatRoomScreenParams> = ({ chatId }) => {\n+â”Š  â”Š51â”Šconst ChatRoomScreen: React.FC<ChatRoomScreenParams> = ({\n+â”Š  â”Š52â”Š  history,\n+â”Š  â”Š53â”Š  chatId,\n+â”Š  â”Š54â”Š}) => {\n â”Š39â”Š55â”Š  const [chat, setChat] = useState<OptionalChatQueryResult>(null);\n â”Š40â”Š56â”Š\n â”Š41â”Š57â”Š  useMemo(async () => {\n```\n```diff\n@@ -58,18 +74,11 @@\n â”Š58â”Š74â”Š  if (!chat) return null;\n â”Š59â”Š75â”Š\n â”Š60â”Š76â”Š  return (\n-â”Š61â”Š  â”Š    <div>\n-â”Š62â”Š  â”Š      <img src={chat.picture} alt=\"Profile\" />\n-â”Š63â”Š  â”Š      <div>{chat.name}</div>\n-â”Š64â”Š  â”Š      <ul>\n-â”Š65â”Š  â”Š        {chat.messages.map(message => (\n-â”Š66â”Š  â”Š          <li key={message.id}>\n-â”Š67â”Š  â”Š            <div>{message.content}</div>\n-â”Š68â”Š  â”Š            <div>{message.createdAt}</div>\n-â”Š69â”Š  â”Š          </li>\n-â”Š70â”Š  â”Š        ))}\n-â”Š71â”Š  â”Š      </ul>\n-â”Š72â”Š  â”Š    </div>\n+â”Š  â”Š77â”Š    <Container>\n+â”Š  â”Š78â”Š      <ChatNavbar chat={chat} history={history} />\n+â”Š  â”Š79â”Š      {chat.messages && <MessagesList messages={chat.messages} />}\n+â”Š  â”Š80â”Š      <MessageInput />\n+â”Š  â”Š81â”Š    </Container>\n â”Š73â”Š82â”Š  );\n â”Š74â”Š83â”Š};\n```\n\n[}]: #\n\nAnd let's also send the new required `history` props to our `ChatRoomScreen` component:\n\n[{]: <helper> (diffStep 6.6 files=\"App.tsx\" module=\"client\")\n\n#### [__Client__ Step 6.6: Implement ChatRoomScreen components](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/af4d95ac6c0c12669c02495ed34c67360820fa4b)\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -17,8 +17,11 @@\n â”Š17â”Š17â”Š      <Route\n â”Š18â”Š18â”Š        exact\n â”Š19â”Š19â”Š        path=\"/chats/:chatId\"\n-â”Š20â”Š  â”Š        component={({ match }: RouteComponentProps<{ chatId: string }>) => (\n-â”Š21â”Š  â”Š          <ChatRoomScreen chatId={match.params.chatId} />\n+â”Š  â”Š20â”Š        component={({\n+â”Š  â”Š21â”Š          match,\n+â”Š  â”Š22â”Š          history,\n+â”Š  â”Š23â”Š        }: RouteComponentProps<{ chatId: string }>) => (\n+â”Š  â”Š24â”Š          <ChatRoomScreen chatId={match.params.chatId} history={history} />\n â”Š22â”Š25â”Š        )}\n â”Š23â”Š26â”Š      />\n â”Š24â”Š27â”Š    </AnimatedSwitch>\n```\n\n[}]: #\n\nThe view is complete! However the `MessageInput` is not bound to our messages list.\nWe will use the triggered callback to update the chat state, whose changes should appear in the `MessagesList` component in the following render phase:\n\n[{]: <helper> (diffStep 6.7 module=\"client\")\n\n#### [__Client__ Step 6.7: Define onSendMessage callback](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/49d27f796b0ed934f829887c823bbaaccb6ba992)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;MessageInput.tsx\n```diff\n@@ -2,6 +2,7 @@\n â”Š2â”Š2â”Šimport SendIcon from '@material-ui/icons/Send';\n â”Š3â”Š3â”Šimport React from 'react';\n â”Š4â”Š4â”Šimport styled from 'styled-components';\n+â”Š â”Š5â”Šimport { useState } from 'react';\n â”Š5â”Š6â”Š\n â”Š6â”Š7â”Šconst Container = styled.div`\n â”Š7â”Š8â”Š  display: flex;\n```\n```diff\n@@ -39,11 +40,43 @@\n â”Š39â”Š40â”Š  }\n â”Š40â”Š41â”Š`;\n â”Š41â”Š42â”Š\n-â”Š42â”Š  â”Šconst MessageInput: React.FC = () => {\n+â”Š  â”Š43â”Šinterface MessageInputProps {\n+â”Š  â”Š44â”Š  onSendMessage(content: string): any;\n+â”Š  â”Š45â”Š}\n+â”Š  â”Š46â”Š\n+â”Š  â”Š47â”Šconst MessageInput: React.FC<MessageInputProps> = ({ onSendMessage }) => {\n+â”Š  â”Š48â”Š  const [message, setMessage] = useState('');\n+â”Š  â”Š49â”Š\n+â”Š  â”Š50â”Š  const onKeyPress = (e: any) => {\n+â”Š  â”Š51â”Š    if (e.charCode === 13) {\n+â”Š  â”Š52â”Š      submitMessage();\n+â”Š  â”Š53â”Š    }\n+â”Š  â”Š54â”Š  };\n+â”Š  â”Š55â”Š\n+â”Š  â”Š56â”Š  const onChange = ({ target }: any) => {\n+â”Š  â”Š57â”Š    setMessage(target.value);\n+â”Š  â”Š58â”Š  };\n+â”Š  â”Š59â”Š\n+â”Š  â”Š60â”Š  const submitMessage = () => {\n+â”Š  â”Š61â”Š    if (!message) return;\n+â”Š  â”Š62â”Š\n+â”Š  â”Š63â”Š    setMessage('');\n+â”Š  â”Š64â”Š\n+â”Š  â”Š65â”Š    if (typeof onSendMessage === 'function') {\n+â”Š  â”Š66â”Š      onSendMessage(message);\n+â”Š  â”Š67â”Š    }\n+â”Š  â”Š68â”Š  };\n+â”Š  â”Š69â”Š\n â”Š43â”Š70â”Š  return (\n â”Š44â”Š71â”Š    <Container>\n-â”Š45â”Š  â”Š      <ActualInput type=\"text\" placeholder=\"Type a message\" />\n-â”Š46â”Š  â”Š      <SendButton variant=\"contained\" color=\"primary\">\n+â”Š  â”Š72â”Š      <ActualInput\n+â”Š  â”Š73â”Š        type=\"text\"\n+â”Š  â”Š74â”Š        placeholder=\"Type a message\"\n+â”Š  â”Š75â”Š        value={message}\n+â”Š  â”Š76â”Š        onKeyPress={onKeyPress}\n+â”Š  â”Š77â”Š        onChange={onChange}\n+â”Š  â”Š78â”Š      />\n+â”Š  â”Š79â”Š      <SendButton variant=\"contained\" color=\"primary\" onClick={submitMessage}>\n â”Š47â”Š80â”Š        <SendIcon />\n â”Š48â”Š81â”Š      </SendButton>\n â”Š49â”Š82â”Š    </Container>\n```\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -1,5 +1,5 @@\n â”Š1â”Š1â”Šimport React from 'react';\n-â”Š2â”Š â”Šimport { useMemo, useState } from 'react';\n+â”Š â”Š2â”Šimport { useCallback, useMemo, useState } from 'react';\n â”Š3â”Š3â”Šimport styled from 'styled-components';\n â”Š4â”Š4â”Šimport ChatNavbar from './ChatNavbar';\n â”Š5â”Š5â”Šimport MessageInput from './MessageInput';\n```\n```diff\n@@ -71,13 +71,31 @@\n â”Š 71â”Š 71â”Š    setChat(chat);\n â”Š 72â”Š 72â”Š  }, [chatId]);\n â”Š 73â”Š 73â”Š\n+â”Š   â”Š 74â”Š  const onSendMessage = useCallback(\n+â”Š   â”Š 75â”Š    (content: string) => {\n+â”Š   â”Š 76â”Š      if (!chat) return null;\n+â”Š   â”Š 77â”Š\n+â”Š   â”Š 78â”Š      const message = {\n+â”Š   â”Š 79â”Š        id: (chat.messages.length + 10).toString(),\n+â”Š   â”Š 80â”Š        createdAt: new Date(),\n+â”Š   â”Š 81â”Š        content,\n+â”Š   â”Š 82â”Š      };\n+â”Š   â”Š 83â”Š\n+â”Š   â”Š 84â”Š      setChat({\n+â”Š   â”Š 85â”Š        ...chat,\n+â”Š   â”Š 86â”Š        messages: chat.messages.concat(message),\n+â”Š   â”Š 87â”Š      });\n+â”Š   â”Š 88â”Š    },\n+â”Š   â”Š 89â”Š    [chat]\n+â”Š   â”Š 90â”Š  );\n+â”Š   â”Š 91â”Š\n â”Š 74â”Š 92â”Š  if (!chat) return null;\n â”Š 75â”Š 93â”Š\n â”Š 76â”Š 94â”Š  return (\n â”Š 77â”Š 95â”Š    <Container>\n â”Š 78â”Š 96â”Š      <ChatNavbar chat={chat} history={history} />\n â”Š 79â”Š 97â”Š      {chat.messages && <MessagesList messages={chat.messages} />}\n-â”Š 80â”Š   â”Š      <MessageInput />\n+â”Š   â”Š 98â”Š      <MessageInput onSendMessage={onSendMessage} />\n â”Š 81â”Š 99â”Š    </Container>\n â”Š 82â”Š100â”Š  );\n â”Š 83â”Š101â”Š};\n```\n\n[}]: #\n\nThis is how the entire flow should look like:\n\n![flow-demo](https://user-images.githubusercontent.com/7648874/54739741-27012280-4bf4-11e9-97cb-c715482e2e70.gif)\n\nAn edge case that should be taken care of is when the messages list length in the view exceeds the length of the container,\nin which case we will have to scroll down to the bottom of the view.\nThis way we can keep track of the most recent message.\nWe will use `ReactDOM` to retrieve the native HTML element of the container and change the position of the scroller whenever a messages was sent:\n\n[{]: <helper> (diffStep 6.8 module=\"client\")\n\n#### [__Client__ Step 6.8: Reset scroller on message sent](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/5e02d9fe06f9c0b72d3c2385771adaf70562a54c)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;MessagesList.tsx\n```diff\n@@ -1,5 +1,7 @@\n â”Š1â”Š1â”Šimport moment from 'moment';\n â”Š2â”Š2â”Šimport React from 'react';\n+â”Š â”Š3â”Šimport { useEffect, useRef } from 'react';\n+â”Š â”Š4â”Šimport ReactDOM from 'react-dom';\n â”Š3â”Š5â”Šimport styled from 'styled-components';\n â”Š4â”Š6â”Šimport { ChatQueryMessage } from './index';\n â”Š5â”Š7â”Š\n```\n```diff\n@@ -64,15 +66,26 @@\n â”Š64â”Š66â”Š  messages: Array<ChatQueryMessage>;\n â”Š65â”Š67â”Š}\n â”Š66â”Š68â”Š\n-â”Š67â”Š  â”Šconst MessagesList: React.FC<MessagesListProps> = ({ messages }) => (\n-â”Š68â”Š  â”Š  <Container>\n-â”Š69â”Š  â”Š    {messages.map((message: any) => (\n-â”Š70â”Š  â”Š      <MessageItem key={message.id}>\n-â”Š71â”Š  â”Š        <Contents>{message.content}</Contents>\n-â”Š72â”Š  â”Š        <Timestamp>{moment(message.createdAt).format('HH:mm')}</Timestamp>\n-â”Š73â”Š  â”Š      </MessageItem>\n-â”Š74â”Š  â”Š    ))}\n-â”Š75â”Š  â”Š  </Container>\n-â”Š76â”Š  â”Š);\n+â”Š  â”Š69â”Šconst MessagesList: React.FC<MessagesListProps> = ({ messages }) => {\n+â”Š  â”Š70â”Š  const selfRef = useRef(null);\n+â”Š  â”Š71â”Š\n+â”Š  â”Š72â”Š  useEffect(() => {\n+â”Š  â”Š73â”Š    if (!selfRef.current) return;\n+â”Š  â”Š74â”Š\n+â”Š  â”Š75â”Š    const selfDOMNode = ReactDOM.findDOMNode(selfRef.current) as HTMLElement;\n+â”Š  â”Š76â”Š    selfDOMNode.scrollTop = Number.MAX_SAFE_INTEGER;\n+â”Š  â”Š77â”Š  }, [messages.length]);\n+â”Š  â”Š78â”Š\n+â”Š  â”Š79â”Š  return (\n+â”Š  â”Š80â”Š    <Container ref={selfRef}>\n+â”Š  â”Š81â”Š      {messages.map((message: any) => (\n+â”Š  â”Š82â”Š        <MessageItem key={message.id}>\n+â”Š  â”Š83â”Š          <Contents>{message.content}</Contents>\n+â”Š  â”Š84â”Š          <Timestamp>{moment(message.createdAt).format('HH:mm')}</Timestamp>\n+â”Š  â”Š85â”Š        </MessageItem>\n+â”Š  â”Š86â”Š      ))}\n+â”Š  â”Š87â”Š    </Container>\n+â”Š  â”Š88â”Š  );\n+â”Š  â”Š89â”Š};\n â”Š77â”Š90â”Š\n â”Š78â”Š91â”Šexport default MessagesList;\n```\n\n[}]: #\n\nBefore we wrap things up, we should also test our components.\nSince the new components have a direct control over the app's history,\nwe should also find a way to simulate it in our tests.\nBecause `react-dom-router` uses the [`history`](https://www.npmjs.com/package/history) package under the hood,\nthat means that we can use that package to inject a custom history object directly into the tested components:\n\n[{]: <helper> (diffStep 6.9 files=\"components\" module=\"client\")\n\n#### [__Client__ Step 6.9: Test ChatRoomScreen child components](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/53269beb18555ae1c3b364fb742d067b273e2d1c)\n\n##### Added src&#x2F;components&#x2F;ChatRoomScreen&#x2F;ChatNavbar.test.tsx\n```diff\n@@ -0,0 +1,79 @@\n+â”Š  â”Š 1â”Šimport { createMemoryHistory } from 'history';\n+â”Š  â”Š 2â”Šimport React from 'react';\n+â”Š  â”Š 3â”Šimport { cleanup, render, fireEvent, wait } from '@testing-library/react';\n+â”Š  â”Š 4â”Šimport ChatNavbar from './ChatNavbar';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šdescribe('ChatNavbar', () => {\n+â”Š  â”Š 7â”Š  afterEach(cleanup);\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Š  it('renders chat data', () => {\n+â”Š  â”Š10â”Š\n+â”Š  â”Š11â”Š    const time = new Date('1 Jan 2019 GMT');\n+â”Š  â”Š12â”Š    const chat = {\n+â”Š  â”Š13â”Š      id: '1',\n+â”Š  â”Š14â”Š      name: 'Foo Bar',\n+â”Š  â”Š15â”Š      picture: 'https://localhost:4000/picture.jpg',\n+â”Š  â”Š16â”Š      messages: [\n+â”Š  â”Š17â”Š        {\n+â”Š  â”Š18â”Š          id: '1',\n+â”Š  â”Š19â”Š          content: 'foo',\n+â”Š  â”Š20â”Š          createdAt: time,\n+â”Š  â”Š21â”Š        },\n+â”Š  â”Š22â”Š        {\n+â”Š  â”Š23â”Š          id: '2',\n+â”Š  â”Š24â”Š          content: 'bar',\n+â”Š  â”Š25â”Š          createdAt: time,\n+â”Š  â”Š26â”Š        },\n+â”Š  â”Š27â”Š      ]\n+â”Š  â”Š28â”Š    };\n+â”Š  â”Š29â”Š\n+â”Š  â”Š30â”Š    const history = createMemoryHistory();\n+â”Š  â”Š31â”Š\n+â”Š  â”Š32â”Š    {\n+â”Š  â”Š33â”Š      const { container, getByTestId } = render(<ChatNavbar chat={chat} history={history}/>);\n+â”Š  â”Š34â”Š\n+â”Š  â”Š35â”Š      expect(getByTestId('chat-name')).toHaveTextContent('Foo Bar');\n+â”Š  â”Š36â”Š      expect(getByTestId('chat-picture')).toHaveAttribute(\n+â”Š  â”Š37â”Š        'src',\n+â”Š  â”Š38â”Š        'https://localhost:4000/picture.jpg'\n+â”Š  â”Š39â”Š      );\n+â”Š  â”Š40â”Š    }\n+â”Š  â”Š41â”Š  });\n+â”Š  â”Š42â”Š\n+â”Š  â”Š43â”Š  it('goes back on arrow click', async () => {\n+â”Š  â”Š44â”Š    const time = new Date('1 Jan 2019 GMT');\n+â”Š  â”Š45â”Š    const chat = {\n+â”Š  â”Š46â”Š      id: '1',\n+â”Š  â”Š47â”Š      name: 'Foo Bar',\n+â”Š  â”Š48â”Š      picture: 'https://localhost:4000/picture.jpg',\n+â”Š  â”Š49â”Š      messages: [\n+â”Š  â”Š50â”Š        {\n+â”Š  â”Š51â”Š          id: '1',\n+â”Š  â”Š52â”Š          content: 'foo',\n+â”Š  â”Š53â”Š          createdAt: time,\n+â”Š  â”Š54â”Š        },\n+â”Š  â”Š55â”Š        {\n+â”Š  â”Š56â”Š          id: '2',\n+â”Š  â”Š57â”Š          content: 'bar',\n+â”Š  â”Š58â”Š          createdAt: time,\n+â”Š  â”Š59â”Š        },\n+â”Š  â”Š60â”Š      ]\n+â”Š  â”Š61â”Š    };\n+â”Š  â”Š62â”Š\n+â”Š  â”Š63â”Š    const history = createMemoryHistory();\n+â”Š  â”Š64â”Š\n+â”Š  â”Š65â”Š    history.push('/chats/1');\n+â”Š  â”Š66â”Š\n+â”Š  â”Š67â”Š    await wait(() => expect(history.location.pathname).toEqual('/chats/1'));\n+â”Š  â”Š68â”Š\n+â”Š  â”Š69â”Š    {\n+â”Š  â”Š70â”Š      const { container, getByTestId } = render(\n+â”Š  â”Š71â”Š        <ChatNavbar chat={chat} history={history} />\n+â”Š  â”Š72â”Š      );\n+â”Š  â”Š73â”Š\n+â”Š  â”Š74â”Š      fireEvent.click(getByTestId('back-button'));\n+â”Š  â”Š75â”Š\n+â”Š  â”Š76â”Š      await wait(() => expect(history.location.pathname).toEqual('/chats'));\n+â”Š  â”Š77â”Š    }\n+â”Š  â”Š78â”Š  });\n+â”Š  â”Š79â”Š});\n```\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;ChatNavbar.tsx\n```diff\n@@ -47,11 +47,11 @@\n â”Š47â”Š47â”Š\n â”Š48â”Š48â”Š  return (\n â”Š49â”Š49â”Š    <Container>\n-â”Š50â”Š  â”Š      <BackButton onClick={navBack}>\n+â”Š  â”Š50â”Š      <BackButton data-testid=\"back-button\" onClick={navBack}>\n â”Š51â”Š51â”Š        <ArrowBackIcon />\n â”Š52â”Š52â”Š      </BackButton>\n-â”Š53â”Š  â”Š      <Picture src={chat.picture} />\n-â”Š54â”Š  â”Š      <Name>{chat.name}</Name>\n+â”Š  â”Š53â”Š      <Picture data-testid=\"chat-picture\" src={chat.picture} />\n+â”Š  â”Š54â”Š      <Name data-testid=\"chat-name\">{chat.name}</Name>\n â”Š55â”Š55â”Š    </Container>\n â”Š56â”Š56â”Š  );\n â”Š57â”Š57â”Š};\n```\n\n##### Added src&#x2F;components&#x2F;ChatRoomScreen&#x2F;MessageInput.test.tsx\n```diff\n@@ -0,0 +1,57 @@\n+â”Š  â”Š 1â”Šimport { createMemoryHistory } from 'history';\n+â”Š  â”Š 2â”Šimport React from 'react';\n+â”Š  â”Š 3â”Šimport {\n+â”Š  â”Š 4â”Š  cleanup,\n+â”Š  â”Š 5â”Š  render,\n+â”Š  â”Š 6â”Š  fireEvent,\n+â”Š  â”Š 7â”Š  wait,\n+â”Š  â”Š 8â”Š  waitForElement,\n+â”Š  â”Š 9â”Š} from '@testing-library/react';\n+â”Š  â”Š10â”Šimport MessageInput from './MessageInput';\n+â”Š  â”Š11â”Š\n+â”Š  â”Š12â”Šdescribe('MessageInput;', () => {\n+â”Š  â”Š13â”Š  afterEach(cleanup);\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”Š  it('triggers callback on send button click', async () => {\n+â”Š  â”Š16â”Š    const onSendMessage = jest.fn(() => {});\n+â”Š  â”Š17â”Š\n+â”Š  â”Š18â”Š    {\n+â”Š  â”Š19â”Š      const { container, getByTestId } = render(\n+â”Š  â”Š20â”Š        <MessageInput onSendMessage={onSendMessage} />\n+â”Š  â”Š21â”Š      );\n+â”Š  â”Š22â”Š      const messageInput = getByTestId('message-input');\n+â”Š  â”Š23â”Š      const sendButton = getByTestId('send-button');\n+â”Š  â”Š24â”Š\n+â”Š  â”Š25â”Š      fireEvent.change(messageInput, { target: { value: 'foo' } });\n+â”Š  â”Š26â”Š\n+â”Š  â”Š27â”Š      await waitForElement(() => messageInput);\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š      fireEvent.click(sendButton);\n+â”Š  â”Š30â”Š\n+â”Š  â”Š31â”Š      await wait(() => expect(onSendMessage.mock.calls.length).toBe(1));\n+â”Š  â”Š32â”Š    }\n+â”Š  â”Š33â”Š  });\n+â”Š  â”Š34â”Š\n+â”Š  â”Š35â”Š  it('triggers callback on Enter press', async () => {\n+â”Š  â”Š36â”Š    const onSendMessage = jest.fn(() => {});\n+â”Š  â”Š37â”Š\n+â”Š  â”Š38â”Š    {\n+â”Š  â”Š39â”Š      const { container, getByTestId } = render(\n+â”Š  â”Š40â”Š        <MessageInput onSendMessage={onSendMessage} />\n+â”Š  â”Š41â”Š      );\n+â”Š  â”Š42â”Š      const messageInput = getByTestId('message-input');\n+â”Š  â”Š43â”Š\n+â”Š  â”Š44â”Š      fireEvent.change(messageInput, { target: { value: 'foo' } });\n+â”Š  â”Š45â”Š\n+â”Š  â”Š46â”Š      await waitForElement(() => messageInput);\n+â”Š  â”Š47â”Š\n+â”Š  â”Š48â”Š      fireEvent.keyPress(messageInput, {\n+â”Š  â”Š49â”Š        key: 'Enter',\n+â”Š  â”Š50â”Š        code: 13,\n+â”Š  â”Š51â”Š        charCode: 13,\n+â”Š  â”Š52â”Š      });\n+â”Š  â”Š53â”Š\n+â”Š  â”Š54â”Š      await wait(() => expect(onSendMessage.mock.calls.length).toBe(1));\n+â”Š  â”Š55â”Š    }\n+â”Š  â”Š56â”Š  });\n+â”Š  â”Š57â”Š});\n```\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;MessageInput.tsx\n```diff\n@@ -70,13 +70,18 @@\n â”Š70â”Š70â”Š  return (\n â”Š71â”Š71â”Š    <Container>\n â”Š72â”Š72â”Š      <ActualInput\n+â”Š  â”Š73â”Š        data-testid=\"message-input\"\n â”Š73â”Š74â”Š        type=\"text\"\n â”Š74â”Š75â”Š        placeholder=\"Type a message\"\n â”Š75â”Š76â”Š        value={message}\n â”Š76â”Š77â”Š        onKeyPress={onKeyPress}\n â”Š77â”Š78â”Š        onChange={onChange}\n â”Š78â”Š79â”Š      />\n-â”Š79â”Š  â”Š      <SendButton variant=\"contained\" color=\"primary\" onClick={submitMessage}>\n+â”Š  â”Š80â”Š      <SendButton\n+â”Š  â”Š81â”Š        data-testid=\"send-button\"\n+â”Š  â”Š82â”Š        variant=\"contained\"\n+â”Š  â”Š83â”Š        color=\"primary\"\n+â”Š  â”Š84â”Š        onClick={submitMessage}>\n â”Š80â”Š85â”Š        <SendIcon />\n â”Š81â”Š86â”Š      </SendButton>\n â”Š82â”Š87â”Š    </Container>\n```\n\n##### Added src&#x2F;components&#x2F;ChatRoomScreen&#x2F;MessagesList.test.tsx\n```diff\n@@ -0,0 +1,47 @@\n+â”Š  â”Š 1â”Šimport { createMemoryHistory } from 'history';\n+â”Š  â”Š 2â”Šimport React from 'react';\n+â”Š  â”Š 3â”Šimport {\n+â”Š  â”Š 4â”Š  cleanup,\n+â”Š  â”Š 5â”Š  render,\n+â”Š  â”Š 6â”Š  fireEvent,\n+â”Š  â”Š 7â”Š  wait,\n+â”Š  â”Š 8â”Š  getByTestId,\n+â”Š  â”Š 9â”Š} from '@testing-library/react';\n+â”Š  â”Š10â”Šimport MessagesList from './MessagesList';\n+â”Š  â”Š11â”Š\n+â”Š  â”Š12â”Šdescribe('MessagesList', () => {\n+â”Š  â”Š13â”Š  afterEach(cleanup);\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”Š  const time = new Date('1 Jan 2019 GMT');\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š  it('renders messages data', () => {\n+â”Š  â”Š18â”Š    const messages = [\n+â”Š  â”Š19â”Š      {\n+â”Š  â”Š20â”Š        id: '1',\n+â”Š  â”Š21â”Š        content: 'foo',\n+â”Š  â”Š22â”Š        createdAt: time,\n+â”Š  â”Š23â”Š      },\n+â”Š  â”Š24â”Š      {\n+â”Š  â”Š25â”Š        id: '2',\n+â”Š  â”Š26â”Š        content: 'bar',\n+â”Š  â”Š27â”Š        createdAt: time,\n+â”Š  â”Š28â”Š      },\n+â”Š  â”Š29â”Š    ];\n+â”Š  â”Š30â”Š\n+â”Š  â”Š31â”Š    let message1, message2;\n+â”Š  â”Š32â”Š    {\n+â”Š  â”Š33â”Š      const { container, getAllByTestId, getByTestId } = render(\n+â”Š  â”Š34â”Š        <MessagesList messages={messages} />\n+â”Š  â”Š35â”Š      );\n+â”Š  â”Š36â”Š      const match = getAllByTestId('message-item');\n+â”Š  â”Š37â”Š      message1 = match[0];\n+â”Š  â”Š38â”Š      message2 = match[1];\n+â”Š  â”Š39â”Š    }\n+â”Š  â”Š40â”Š\n+â”Š  â”Š41â”Š    expect(getByTestId(message1, 'message-content')).toHaveTextContent('foo');\n+â”Š  â”Š42â”Š    expect(getByTestId(message1, 'message-date')).toHaveTextContent('02:00');\n+â”Š  â”Š43â”Š\n+â”Š  â”Š44â”Š    expect(getByTestId(message2, 'message-content')).toHaveTextContent('bar');\n+â”Š  â”Š45â”Š    expect(getByTestId(message2, 'message-date')).toHaveTextContent('02:00');\n+â”Š  â”Š46â”Š  });\n+â”Š  â”Š47â”Š});\n```\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;MessagesList.tsx\n```diff\n@@ -79,9 +79,11 @@\n â”Š79â”Š79â”Š  return (\n â”Š80â”Š80â”Š    <Container ref={selfRef}>\n â”Š81â”Š81â”Š      {messages.map((message: any) => (\n-â”Š82â”Š  â”Š        <MessageItem key={message.id}>\n-â”Š83â”Š  â”Š          <Contents>{message.content}</Contents>\n-â”Š84â”Š  â”Š          <Timestamp>{moment(message.createdAt).format('HH:mm')}</Timestamp>\n+â”Š  â”Š82â”Š        <MessageItem data-testid=\"message-item\" key={message.id}>\n+â”Š  â”Š83â”Š          <Contents data-testid=\"message-content\">{message.content}</Contents>\n+â”Š  â”Š84â”Š          <Timestamp data-testid=\"message-date\">\n+â”Š  â”Š85â”Š            {moment(message.createdAt).format('HH:mm')}\n+â”Š  â”Š86â”Š          </Timestamp>\n â”Š85â”Š87â”Š        </MessageItem>\n â”Š86â”Š88â”Š      ))}\n â”Š87â”Š89â”Š    </Container>\n```\n\n[}]: #\n\nThere are many things which are incomplete in the current implementation. The functionality exists in the UI, but no messages are really being sent and stored in the database. In the next chapters we will learn how to:\n\n\n\n*   Cache query results with Apollo-Client.\n*   Send messages with GraphQL mutations\n\n--------\nTODO: Add this to router chapter - https://www.pluralsight.com/guides/react-router-typescript\nAnd this - https://stackoverflow.com/questions/49342390/typescript-how-to-add-type-check-for-history-object-in-react\n\nTODO: https://medium.com/@jrwebdev/react-higher-order-component-patterns-in-typescript-42278f7590fb\n\nTODO: https://www.cypress.io/blog/2019/05/13/code-create-react-app-v3-and-its-cypress-tests-using-typescript/#\n\nTODO: Schema says thereâ€™s always an array with messages, is it really true? Is newly created chat resolves an empty array, null will throw an error?\n\nTODO: Same thing with `chats: [Chat!]!`, do we always return an array here?\n\nTODO: _root and type all resolvers\n\nTODO: How to import schema together with jest, should I changed from ts-jest?\n\nTODO: remove all that part including the file in the commit\n\nTODO: Add all the new files and changes on 6.6\n\nTODO: Add all the new files and changes on 6.7"
          },
          {
            "manualTitle": "Step 7: Caching with Apollo-Client",
            "stepRevision": "c92f2378b94d54cfcd572c22f54e7613199a2620",
            "manualView": "In the previous step we've implemented a `ChatRoomScreen` where we were able to view each chat's messages list by clicking on a chat item from the main screen.\nIt all looks functional, however, there's a significant optimization issue - each time we navigate into a `ChatRoomScreen`,\nwe need to re-fetch the data related to the target chat.\n\nThe solution for that would be [caching](https://en.wikipedia.org/wiki/Cache_(computing)) the fetch result,\nso it can be re-used once we re-enter a screen that we've visited before.\nFor now things are fairly simple so the caching mechanism can be implemented manually,\nbut things are gonna get tougher when we add more queries or things like message sending and profile updating to the mix,\nso it's not gonna be an easy task.\n\nLuckily, in the Apollo team they've invented a solution that works right out of the box and integrates perfectly with Apollo-GraphQL server - [Apollo-GraphQL client](https://www.apollographql.com/docs/link/#apollo-client).\n\n\n![caching](https://user-images.githubusercontent.com/7648874/54871150-f505e100-4dea-11e9-9e2d-439fbf3eaebe.png)\n\n\n\nApollo-Client is a wrap around our GraphQL endpoint which essentially uses HTTP requests (and further on [web-sockets](https://en.wikipedia.org/wiki/WebSocket), but we will get there), something that we've implemented manually so far.\nNot only it can be used to fetch data, but it will also cache the result of the query so it can be seamlessly re-used when we request the same data.\nThis means that we will need to setup an Apollo-Client and replace all our `fetch()` calls with `client.query()` call.\nMore about Apollo-Client's API further in this tutorial, but let's start configuring it.\nFirst we will install few essential NPM packages:\n\n    $ yarn add apollo-client apollo-cache-inmemory apollo-link apollo-link-http\n\n\n\n*   [`apollo-client`](https://www.npmjs.com/package/apollo-client) - Apollo-Client's core package, as we explained earlier.\n*   [`apollo-cache-inmemory`](https://www.npmjs.com/package/apollo-cache-inmemory) - The data store that will be used to cache the results.\n*   [`apollo-link-http`](https://www.npmjs.com/package/apollo-link-http) - Get GraphQL results over a network using HTTP fetch.\n\nWe will create a new file in the `src` directory called `client.ts` and inside we will export the client:\n\n[{]: <helper> (diffStep 7.1 files=\"client\" module=\"client\")\n\n#### [__Client__ Step 7.1: Add Apollo client](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/c56311f96ea6a0f1fe944ce2f5c48f29af8abc9d)\n\n##### Added src&#x2F;client.ts\n```diff\n@@ -0,0 +1,16 @@\n+â”Š  â”Š 1â”Šimport { InMemoryCache } from 'apollo-cache-inmemory';\n+â”Š  â”Š 2â”Šimport { ApolloClient } from 'apollo-client';\n+â”Š  â”Š 3â”Šimport { HttpLink } from 'apollo-link-http';\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šconst httpUri = process.env.REACT_APP_SERVER_URL + '/graphql';\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Šconst httpLink = new HttpLink({\n+â”Š  â”Š 8â”Š  uri: httpUri,\n+â”Š  â”Š 9â”Š});\n+â”Š  â”Š10â”Š\n+â”Š  â”Š11â”Šconst inMemoryCache = new InMemoryCache();\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Šexport default new ApolloClient({\n+â”Š  â”Š14â”Š  link: httpLink,\n+â”Š  â”Š15â”Š  cache: inMemoryCache,\n+â”Š  â”Š16â”Š});\n```\n\n[}]: #\n\nAlthough the client can be used directly and integrated into any UI framework, it would be the most comfortable to use a wrap around it which is suitable for React.\nFor that we will use Apollo's React Hooks package called [`@apollo/react-hooks`](https://github.com/apollographql/react-apollo) which includes a set of\n[React hooks](https://reactjs.org/docs/hooks-intro.html) that can connect between our Apollo-Client and target React.Component:\n\n    $ yarn add @apollo/react-hooks graphql-tag graphql\n\nWith `@apollo/react-hooks` we can use the `useQuery()` hook to fetch data from our GraphQL API.\nThe `graphql-tag` package is used to parse the GraphQL string to an [AST](https://en.wikipedia.org/wiki/Abstract_syntax_tree),\nsomething which is required when using Apollo Client. Example:\n\n\n```\nimport gql from 'graphql-tag';\nimport { useQuery } from '@apollo/react-hooks';\n\nconst GET_DOGS = gql`\n  {\n    dogs {\n      id\n      breed\n    }\n  }\n`;\n\nconst Dogs = () => {\n  const { data, error, loading } = useQuery(GET_DOGS);\n  if (loading) {\n    return <div>Loading...</div>;\n  };\n  if (error) {\n    return <div>Error! {error.message}</div>;\n  };\n\n  return (\n    <ul>\n      {data.dogs.map(dog => (\n        <li key={dog.id}>{dog.breed}</li>\n      ))}\n    </ul>\n  );\n};\n```\n\n\nThe package requires a small setup so that imported hooks can use our Apollo-Client:\n\n[{]: <helper> (diffStep 7.2 files=\"index\" module=\"client\")\n\n#### [__Client__ Step 7.2: Provide Apollo client](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/27b38466b762c86107ad159b2aa9efe4e5af0a20)\n\n##### Changed src&#x2F;index.tsx\n```diff\n@@ -1,8 +1,10 @@\n â”Š 1â”Š 1â”Šimport { MuiThemeProvider, createMuiTheme } from '@material-ui/core/styles';\n â”Š 2â”Š 2â”Šimport React from 'react';\n â”Š 3â”Š 3â”Šimport ReactDOM from 'react-dom';\n+â”Š  â”Š 4â”Šimport { ApolloProvider } from '@apollo/react-hooks';\n â”Š 4â”Š 5â”Šimport './index.css';\n â”Š 5â”Š 6â”Šimport App from './App';\n+â”Š  â”Š 7â”Šimport client from './client';\n â”Š 6â”Š 8â”Šimport * as serviceWorker from './serviceWorker';\n â”Š 7â”Š 9â”Š\n â”Š 8â”Š10â”Šconst theme = createMuiTheme({\n```\n```diff\n@@ -14,7 +16,9 @@\n â”Š14â”Š16â”Š\n â”Š15â”Š17â”ŠReactDOM.render(\n â”Š16â”Š18â”Š  <MuiThemeProvider theme={theme}>\n-â”Š17â”Š  â”Š    <App />\n+â”Š  â”Š19â”Š    <ApolloProvider client={client}>\n+â”Š  â”Š20â”Š      <App />\n+â”Š  â”Š21â”Š    </ApolloProvider>\n â”Š18â”Š22â”Š  </MuiThemeProvider>,\n â”Š19â”Š23â”Š  document.getElementById('root')\n â”Š20â”Š24â”Š);\n```\n\n[}]: #\n\nThe code above uses the [Context/Provider](https://reactjs.org/docs/context.html) API, thus the client is now known globally.\nNow that we can use the `useQuery()` hook, there's no need to use the native Fetch API anymore.\nLet's replace all our Fetch API call instances with a React hook:\n\n[{]: <helper> (diffStep 7.3 files=\"components\" module=\"client\")\n\n#### [__Client__ Step 7.3: Replace fetch() calls with Apollo useQuery()](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/cd08f52ba6b9b91859a7d72f741c60fa2afcfb5b)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -1,5 +1,7 @@\n+â”Š â”Š1â”Šimport gql from 'graphql-tag';\n â”Š1â”Š2â”Šimport React from 'react';\n-â”Š2â”Š â”Šimport { useCallback, useMemo, useState } from 'react';\n+â”Š â”Š3â”Šimport { useCallback } from 'react';\n+â”Š â”Š4â”Šimport { useApolloClient, useQuery } from '@apollo/react-hooks';\n â”Š3â”Š5â”Šimport styled from 'styled-components';\n â”Š4â”Š6â”Šimport ChatNavbar from './ChatNavbar';\n â”Š5â”Š7â”Šimport MessageInput from './MessageInput';\n```\n```diff\n@@ -13,7 +15,7 @@\n â”Š13â”Š15â”Š  height: 100vh;\n â”Š14â”Š16â”Š`;\n â”Š15â”Š17â”Š\n-â”Š16â”Š  â”Šconst getChatQuery = `\n+â”Š  â”Š18â”Šconst getChatQuery = gql`\n â”Š17â”Š19â”Š  query GetChat($chatId: ID!) {\n â”Š18â”Š20â”Š    chat(chatId: $chatId) {\n â”Š19â”Š21â”Š      id\n```\n```diff\n@@ -52,24 +54,12 @@\n â”Š52â”Š54â”Š  history,\n â”Š53â”Š55â”Š  chatId,\n â”Š54â”Š56â”Š}) => {\n-â”Š55â”Š  â”Š  const [chat, setChat] = useState<OptionalChatQueryResult>(null);\n-â”Š56â”Š  â”Š\n-â”Š57â”Š  â”Š  useMemo(async () => {\n-â”Š58â”Š  â”Š    const body = await fetch(`${process.env.REACT_APP_SERVER_URL}/graphql`, {\n-â”Š59â”Š  â”Š      method: 'POST',\n-â”Š60â”Š  â”Š      headers: {\n-â”Š61â”Š  â”Š        'Content-Type': 'application/json',\n-â”Š62â”Š  â”Š      },\n-â”Š63â”Š  â”Š      body: JSON.stringify({\n-â”Š64â”Š  â”Š        query: getChatQuery,\n-â”Š65â”Š  â”Š        variables: { chatId },\n-â”Š66â”Š  â”Š      }),\n-â”Š67â”Š  â”Š    });\n-â”Š68â”Š  â”Š    const {\n-â”Š69â”Š  â”Š      data: { chat },\n-â”Š70â”Š  â”Š    } = await body.json();\n-â”Š71â”Š  â”Š    setChat(chat);\n-â”Š72â”Š  â”Š  }, [chatId]);\n+â”Š  â”Š57â”Š  const client = useApolloClient();\n+â”Š  â”Š58â”Š  const {\n+â”Š  â”Š59â”Š    data: { chat },\n+â”Š  â”Š60â”Š  } = useQuery<any>(getChatQuery, {\n+â”Š  â”Š61â”Š    variables: { chatId },\n+â”Š  â”Š62â”Š  });\n â”Š73â”Š63â”Š\n â”Š74â”Š64â”Š  const onSendMessage = useCallback(\n â”Š75â”Š65â”Š    (content: string) => {\n```\n```diff\n@@ -79,14 +69,21 @@\n â”Š79â”Š69â”Š        id: (chat.messages.length + 10).toString(),\n â”Š80â”Š70â”Š        createdAt: new Date(),\n â”Š81â”Š71â”Š        content,\n+â”Š  â”Š72â”Š        __typename: 'Chat',\n â”Š82â”Š73â”Š      };\n â”Š83â”Š74â”Š\n-â”Š84â”Š  â”Š      setChat({\n-â”Š85â”Š  â”Š        ...chat,\n-â”Š86â”Š  â”Š        messages: chat.messages.concat(message),\n+â”Š  â”Š75â”Š      client.writeQuery({\n+â”Š  â”Š76â”Š        query: getChatQuery,\n+â”Š  â”Š77â”Š        variables: { chatId },\n+â”Š  â”Š78â”Š        data: {\n+â”Š  â”Š79â”Š          chat: {\n+â”Š  â”Š80â”Š            ...chat,\n+â”Š  â”Š81â”Š            messages: chat.messages.concat(message),\n+â”Š  â”Š82â”Š          },\n+â”Š  â”Š83â”Š        },\n â”Š87â”Š84â”Š      });\n â”Š88â”Š85â”Š    },\n-â”Š89â”Š  â”Š    [chat]\n+â”Š  â”Š86â”Š    [chat, chatId, client]\n â”Š90â”Š87â”Š  );\n â”Š91â”Š88â”Š\n â”Š92â”Š89â”Š  if (!chat) return null;\n```\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -2,8 +2,10 @@\n â”Š 2â”Š 2â”Šimport moment from 'moment';\n â”Š 3â”Š 3â”Šimport { List, ListItem } from '@material-ui/core';\n â”Š 4â”Š 4â”Šimport styled from 'styled-components';\n-â”Š 5â”Š  â”Šimport { useCallback, useState, useMemo } from 'react';\n+â”Š  â”Š 5â”Šimport { useCallback } from 'react';\n â”Š 6â”Š 6â”Šimport { History } from 'history';\n+â”Š  â”Š 7â”Šimport gql from 'graphql-tag';\n+â”Š  â”Š 8â”Šimport { useQuery } from '@apollo/react-hooks';\n â”Š 7â”Š 9â”Š\n â”Š 8â”Š10â”Šconst Container = styled.div`\n â”Š 9â”Š11â”Š  height: calc(100% - 56px);\n```\n```diff\n@@ -57,7 +59,7 @@\n â”Š57â”Š59â”Š  font-size: 13px;\n â”Š58â”Š60â”Š`;\n â”Š59â”Š61â”Š\n-â”Š60â”Š  â”Šconst getChatsQuery = `\n+â”Š  â”Š62â”Šconst getChatsQuery = gql`\n â”Š61â”Š63â”Š  query GetChats {\n â”Š62â”Š64â”Š    chats {\n â”Š63â”Š65â”Š      id\n```\n```diff\n@@ -77,21 +79,7 @@\n â”Š77â”Š79â”Š}\n â”Š78â”Š80â”Š\n â”Š79â”Š81â”Šconst ChatsList: React.FC<ChatsListProps> = ({ history }) => {\n-â”Š80â”Š  â”Š  const [chats, setChats] = useState<any[]>([]);\n-â”Š81â”Š  â”Š\n-â”Š82â”Š  â”Š  useMemo(async () => {\n-â”Š83â”Š  â”Š    const body = await fetch(`${process.env.REACT_APP_SERVER_URL}/graphql`, {\n-â”Š84â”Š  â”Š      method: 'POST',\n-â”Š85â”Š  â”Š      headers: {\n-â”Š86â”Š  â”Š        'Content-Type': 'application/json',\n-â”Š87â”Š  â”Š      },\n-â”Š88â”Š  â”Š      body: JSON.stringify({ query: getChatsQuery }),\n-â”Š89â”Š  â”Š    });\n-â”Š90â”Š  â”Š    const {\n-â”Š91â”Š  â”Š      data: { chats },\n-â”Š92â”Š  â”Š    } = await body.json();\n-â”Š93â”Š  â”Š    setChats(chats);\n-â”Š94â”Š  â”Š  }, []);\n+â”Š  â”Š82â”Š  const { data } = useQuery<any>(getChatsQuery);\n â”Š95â”Š83â”Š\n â”Š96â”Š84â”Š  const navToChat = useCallback(\n â”Š97â”Š85â”Š    chat => {\n```\n```diff\n@@ -100,10 +88,15 @@\n â”Š100â”Š 88â”Š    [history]\n â”Š101â”Š 89â”Š  );\n â”Š102â”Š 90â”Š\n+â”Š   â”Š 91â”Š  if (data === undefined || data.chats === undefined) {\n+â”Š   â”Š 92â”Š    return null;\n+â”Š   â”Š 93â”Š  }\n+â”Š   â”Š 94â”Š  let chats = data.chats;\n+â”Š   â”Š 95â”Š\n â”Š103â”Š 96â”Š  return (\n â”Š104â”Š 97â”Š    <Container>\n â”Š105â”Š 98â”Š      <StyledList>\n-â”Š106â”Š   â”Š        {chats.map(chat => (\n+â”Š   â”Š 99â”Š        {chats.map((chat: any) => (\n â”Š107â”Š100â”Š          <StyledListItem\n â”Š108â”Š101â”Š            key={chat.id}\n â”Š109â”Š102â”Š            data-testid=\"chat\"\n```\n\n[}]: #\n\nYou can see that we've fetched the query using Apollo client, and we removed the `setChat` call because Apollo will know automatically to place the results in the cache.\n\nAnd you can see we can also work directly with the cache.\n\nOn the `OnSendMessage` function we take the new message and push it to Apollo Client's cache.\n\nNow if we'll scroll to another screen and come back, the messages will still be displayed there.\n\nYou can see that we've added the `__typename` when we push a new chat to the cache.\nThat's how Apollo Client knows where to place the results.\n\nThe replacement is finished. Note that we removed the usage of `useMemo()` - because Apollo has an internal cache mechanism, there's no need to memoize the result anymore.\nWe also used the [`writeQuery()`](https://www.apollographql.com/docs/react/features/caching.html#writequery-and-writefragment) method to edit the stored result in the cache, so in the next render phase we would have an updated chat with the newly added message.\n\nWe shouldn't see any change at all in the view and the response time, since we're running it locally, but if we will take a look at the `network` tab in the browser's dev-tools we should notice the differences:\n\n**before**\n\n![fetch](https://user-images.githubusercontent.com/7648874/54871305-e5879780-4dec-11e9-87bb-3279e9e18342.png)\n\n**after**\n\n![apollo](https://user-images.githubusercontent.com/7648874/54871319-1bc51700-4ded-11e9-9001-d5518bedf9ad.png)\n\n> Above: ChatsListScreen -> ChatRoomScreen -> ChatsListScreen -> ChatRoomScreen\n\nThis test is obviously very rough, but the deviation is so big that you don't need any accuracy to emphasize the difference.\nThe blue stripes represents the requests made and the time they took. Before we had about 6 request phases, while after we had only 3 of them.\n\nSince we don't use the Fetch API anymore, we will also need to update our tests.\nRight now we mock the response from the fetch API, but a more appropriate way would be creating a fake Apollo Client where we will be able to mock the results.\nFor that we will install a package called [`apollo-link-mock`](https://www.npmjs.com/package/apollo-link-mock):\n\n    $ yarn add --dev apollo-link-mock\n\nAnd we will create a `test-helpers.ts` file under the `src` directory that will contain the utility function for creating a fake Apollo Client:\n\n[{]: <helper> (diffStep 7.4 files=\"test-helpers\" module=\"client\")\n\n#### [__Client__ Step 7.4: Mock Apollo requests in tests](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/12523de794cb529a7f31f8e3a9a53d5acdc593b4)\n\n##### Added src&#x2F;test-helpers.ts\n```diff\n@@ -0,0 +1,10 @@\n+â”Š  â”Š 1â”Šimport { InMemoryCache } from 'apollo-cache-inmemory';\n+â”Š  â”Š 2â”Šimport { ApolloClient } from 'apollo-client';\n+â”Š  â”Š 3â”Šimport { MockLink } from 'apollo-link-mock';\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šexport const mockApolloClient = (mocks: any) => {\n+â”Š  â”Š 6â”Š  return new ApolloClient({\n+â”Š  â”Š 7â”Š    cache: new InMemoryCache(),\n+â”Š  â”Š 8â”Š    link: new MockLink(mocks),\n+â”Š  â”Š 9â”Š  });\n+â”Š  â”Š10â”Š};\n```\n\n[}]: #\n\nThe fake client accepts an array of mocks where each mock object will have a `request` key that will contain details about the request and a `result` key which will contain the mocked result.\nYou should get a better understanding of how it works now that we will replace the fake Fetch calls with fake Apollo Clients:\n\n[{]: <helper> (diffStep 7.4 files=\"src/components\" module=\"client\")\n\n#### [__Client__ Step 7.4: Mock Apollo requests in tests](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/12523de794cb529a7f31f8e3a9a53d5acdc593b4)\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.test.tsx\n```diff\n@@ -1,4 +1,5 @@\n â”Š1â”Š1â”Šimport React from 'react';\n+â”Š â”Š2â”Šimport { ApolloProvider } from '@apollo/react-hooks';\n â”Š2â”Š3â”Šimport ReactDOM from 'react-dom';\n â”Š3â”Š4â”Šimport {\n â”Š4â”Š5â”Š  cleanup,\n```\n```diff\n@@ -7,8 +8,9 @@\n â”Š 7â”Š 8â”Š  wait,\n â”Š 8â”Š 9â”Š  waitForDomChange,\n â”Š 9â”Š10â”Š} from '@testing-library/react';\n-â”Š10â”Š  â”Šimport ChatsList from './ChatsList';\n â”Š11â”Š11â”Šimport { createBrowserHistory } from 'history';\n+â”Š  â”Š12â”Šimport { mockApolloClient } from '../../test-helpers';\n+â”Š  â”Š13â”Šimport ChatsList, { getChatsQuery } from './ChatsList';\n â”Š12â”Š14â”Š\n â”Š13â”Š15â”Šdescribe('ChatsList', () => {\n â”Š14â”Š16â”Š  afterEach(() => {\n```\n```diff\n@@ -21,27 +23,38 @@\n â”Š21â”Š23â”Š  });\n â”Š22â”Š24â”Š\n â”Š23â”Š25â”Š  it('renders fetched chats data', async () => {\n-â”Š24â”Š  â”Š    fetchMock.mockResponseOnce(\n-â”Š25â”Š  â”Š      JSON.stringify({\n-â”Š26â”Š  â”Š        data: {\n-â”Š27â”Š  â”Š          chats: [\n-â”Š28â”Š  â”Š            {\n-â”Š29â”Š  â”Š              id: 1,\n-â”Š30â”Š  â”Š              name: 'Foo Bar',\n-â”Š31â”Š  â”Š              picture: 'https://localhost:4000/picture.jpg',\n-â”Š32â”Š  â”Š              lastMessage: {\n+â”Š  â”Š26â”Š    const client = mockApolloClient([\n+â”Š  â”Š27â”Š      {\n+â”Š  â”Š28â”Š        request: { query: getChatsQuery },\n+â”Š  â”Š29â”Š        result: {\n+â”Š  â”Š30â”Š          data: {\n+â”Š  â”Š31â”Š            chats: [\n+â”Š  â”Š32â”Š              {\n+â”Š  â”Š33â”Š                __typename: 'Chat',\n â”Š33â”Š34â”Š                id: 1,\n-â”Š34â”Š  â”Š                content: 'Hello',\n-â”Š35â”Š  â”Š                createdAt: new Date('1 Jan 2019 GMT'),\n+â”Š  â”Š35â”Š                name: 'Foo Bar',\n+â”Š  â”Š36â”Š                picture: 'https://localhost:4000/picture.jpg',\n+â”Š  â”Š37â”Š                lastMessage: {\n+â”Š  â”Š38â”Š                  __typename: 'Message',\n+â”Š  â”Š39â”Š                  id: 1,\n+â”Š  â”Š40â”Š                  content: 'Hello',\n+â”Š  â”Š41â”Š                  createdAt: new Date('1 Jan 2019 GMT'),\n+â”Š  â”Š42â”Š                },\n â”Š36â”Š43â”Š              },\n-â”Š37â”Š  â”Š            },\n-â”Š38â”Š  â”Š          ],\n+â”Š  â”Š44â”Š            ],\n+â”Š  â”Š45â”Š          },\n â”Š39â”Š46â”Š        },\n-â”Š40â”Š  â”Š      })\n-â”Š41â”Š  â”Š    );\n+â”Š  â”Š47â”Š      },\n+â”Š  â”Š48â”Š    ]);\n+â”Š  â”Š49â”Š\n+â”Š  â”Š50â”Š    const history = createBrowserHistory();\n â”Š42â”Š51â”Š\n â”Š43â”Š52â”Š    {\n-â”Š44â”Š  â”Š      const { container, getByTestId } = render(<ChatsList />);\n+â”Š  â”Š53â”Š      const { container, getByTestId } = render(\n+â”Š  â”Š54â”Š        <ApolloProvider client={client}>\n+â”Š  â”Š55â”Š          <ChatsList history={history}/>\n+â”Š  â”Š56â”Š        </ApolloProvider>\n+â”Š  â”Š57â”Š      );\n â”Š45â”Š58â”Š\n â”Š46â”Š59â”Š      await waitForDomChange({ container });\n â”Š47â”Š60â”Š\n```\n```diff\n@@ -56,30 +69,37 @@\n â”Š 56â”Š 69â”Š  });\n â”Š 57â”Š 70â”Š\n â”Š 58â”Š 71â”Š  it('should navigate to the target chat room on chat item click', async () => {\n-â”Š 59â”Š   â”Š    fetchMock.mockResponseOnce(\n-â”Š 60â”Š   â”Š      JSON.stringify({\n-â”Š 61â”Š   â”Š        data: {\n-â”Š 62â”Š   â”Š          chats: [\n-â”Š 63â”Š   â”Š            {\n-â”Š 64â”Š   â”Š              id: 1,\n-â”Š 65â”Š   â”Š              name: 'Foo Bar',\n-â”Š 66â”Š   â”Š              picture: 'https://localhost:4000/picture.jpg',\n-â”Š 67â”Š   â”Š              lastMessage: {\n+â”Š   â”Š 72â”Š    const client = mockApolloClient([\n+â”Š   â”Š 73â”Š      {\n+â”Š   â”Š 74â”Š        request: { query: getChatsQuery },\n+â”Š   â”Š 75â”Š        result: {\n+â”Š   â”Š 76â”Š          data: {\n+â”Š   â”Š 77â”Š            chats: [\n+â”Š   â”Š 78â”Š              {\n+â”Š   â”Š 79â”Š                __typename: 'Chat',\n â”Š 68â”Š 80â”Š                id: 1,\n-â”Š 69â”Š   â”Š                content: 'Hello',\n-â”Š 70â”Š   â”Š                createdAt: new Date('1 Jan 2019 GMT'),\n+â”Š   â”Š 81â”Š                name: 'Foo Bar',\n+â”Š   â”Š 82â”Š                picture: 'https://localhost:4000/picture.jpg',\n+â”Š   â”Š 83â”Š                lastMessage: {\n+â”Š   â”Š 84â”Š                  __typename: 'Message',\n+â”Š   â”Š 85â”Š                  id: 1,\n+â”Š   â”Š 86â”Š                  content: 'Hello',\n+â”Š   â”Š 87â”Š                  createdAt: new Date('1 Jan 2019 GMT'),\n+â”Š   â”Š 88â”Š                },\n â”Š 71â”Š 89â”Š              },\n-â”Š 72â”Š   â”Š            },\n-â”Š 73â”Š   â”Š          ],\n+â”Š   â”Š 90â”Š            ],\n+â”Š   â”Š 91â”Š          },\n â”Š 74â”Š 92â”Š        },\n-â”Š 75â”Š   â”Š      })\n-â”Š 76â”Š   â”Š    );\n+â”Š   â”Š 93â”Š      },\n+â”Š   â”Š 94â”Š    ]);\n â”Š 77â”Š 95â”Š\n â”Š 78â”Š 96â”Š    const history = createBrowserHistory();\n â”Š 79â”Š 97â”Š\n â”Š 80â”Š 98â”Š    {\n â”Š 81â”Š 99â”Š      const { container, getByTestId } = render(\n-â”Š 82â”Š   â”Š        <ChatsList history={history} />\n+â”Š   â”Š100â”Š        <ApolloProvider client={client}>\n+â”Š   â”Š101â”Š          <ChatsList history={history} />\n+â”Š   â”Š102â”Š        </ApolloProvider>\n â”Š 83â”Š103â”Š      );\n â”Š 84â”Š104â”Š\n â”Š 85â”Š105â”Š      await waitForDomChange({ container });\n```\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -59,7 +59,7 @@\n â”Š59â”Š59â”Š  font-size: 13px;\n â”Š60â”Š60â”Š`;\n â”Š61â”Š61â”Š\n-â”Š62â”Š  â”Šconst getChatsQuery = gql`\n+â”Š  â”Š62â”Šexport const getChatsQuery = gql`\n â”Š63â”Š63â”Š  query GetChats {\n â”Š64â”Š64â”Š    chats {\n â”Š65â”Š65â”Š      id\n```\n\n[}]: #\n\nWe are telling Apollo mock to give a certain result each time it gets a specific query.\n\nNote how we used the `ApolloProvider` component to provide the target component with the fake Apollo Client.\nLike so, any other component which uses Apollo Client should be wrapped with an ApolloProvider when rendering it, otherwise it will not function as intended:\n\n[{]: <helper> (diffStep 7.4 files=\"src/App\" module=\"client\")\n\n#### [__Client__ Step 7.4: Mock Apollo requests in tests](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/12523de794cb529a7f31f8e3a9a53d5acdc593b4)\n\n##### Changed src&#x2F;App.test.tsx\n```diff\n@@ -1,9 +1,18 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n+â”Š  â”Š 2â”Šimport { ApolloProvider } from '@apollo/react-hooks';\n â”Š 2â”Š 3â”Šimport ReactDOM from 'react-dom';\n â”Š 3â”Š 4â”Šimport App from './App';\n+â”Š  â”Š 5â”Šimport { mockApolloClient } from './test-helpers';\n â”Š 4â”Š 6â”Š\n â”Š 5â”Š 7â”Šit('renders without crashing', () => {\n+â”Š  â”Š 8â”Š  const client = mockApolloClient();\n â”Š 6â”Š 9â”Š  const div = document.createElement('div');\n-â”Š 7â”Š  â”Š  ReactDOM.render(<App />, div);\n+â”Š  â”Š10â”Š\n+â”Š  â”Š11â”Š  ReactDOM.render(\n+â”Š  â”Š12â”Š    <ApolloProvider client={client}>\n+â”Š  â”Š13â”Š      <App />\n+â”Š  â”Š14â”Š    </ApolloProvider>,\n+â”Š  â”Š15â”Š    div\n+â”Š  â”Š16â”Š  );\n â”Š 8â”Š17â”Š  ReactDOM.unmountComponentAtNode(div);\n â”Š 9â”Š18â”Š});\n```\n\n[}]: #\n\nThat's it for this chapter. There's one thing missing to make our `ChatRoomScreen` functional and that would be actually sending a message to the backend and updating the DB. In the next chapter we will learn how to do exactly that with our new Apollo-Client.\n\n\n--------------------\n\nTODO: Change the whole intro.\n\nTODO: I think we might want to explain the cache in more details\nhow itâ€™s normalized\nhow some parts update automatically and some do not\nwhatâ€™s the smallest unit stored in the cache\nand other stuff\nthis might help later on with optimistic responses and mutations in general\n\nTODO: Remove all label code\n\nTODO: Create a drawing of the cache.\nTODO: Change typename from Chat to Message\n\nTODO: Explain a bit about Apollo links."
          },
          {
            "manualTitle": "Step 8: Sending messages with GraphQL mutations",
            "stepRevision": "441f6e19bdd01e22284555049395547a2c20547c",
            "manualView": "The view and the functionality for updating the component's state when sending a message already exists.\nThe thing is that messages are not really being sent, we only update the memory in the client.\n\nIf so, how exactly can we send messages and store them in the DB? For this purpose we're gonna learn about GraphQL mutations -\na method for sending and applying mutations in our back-end.\n\n**What are GraphQL mutations?**\n\nIf you have an API endpoint that alters data, like inserting data into a database or altering data that's already in a database,\nyou should make this endpoint a `Mutation` rather than a `Query`.\nThis is as simple as making the API endpoint part of the top-level `Mutation` type instead of the top-level `Query` type.\n\nMutation is a remote procedure call (RPC), meaning it is used to trigger a function on the server,\nbut unlike other protocols which have RPCs, GraphQL Mutation also includes a query, which means the client can ask for data\nonce the operation is complete.\n\nIt's often convenient to have a mutation that maps to a database create or update operation and have it return the same thing that the server stored.\nThat way, if you modify the data on the server, the client can learn about those modifications.\nYou can also think about a GraphQL Mutation as a ** GraphQL query, only with side effects**.\nIt's equivalent to GET (query) and POST/PUT (mutation) in the context of REST API.\n\nBelow is a sample GraphQL mutation request:\n\n```graphql\nmutation AddMessage($chatId: ID!) {\n  addMessage(chatId: $chatId) {\n    id\n    contents\n    createdAt\n  }\n}\n```\n\n**How to implement a GraphQL mutation?**\n\nSince GraphQL is schema based, we will need to create a new type called `Mutation` in the `typeDefs.graphql` file.\nIn this chapter we want to have the ability to send messages, thus we will have a field named `addMessage` in the new mutation type:\n\n[{]: <helper> (diffStep 5.1 files=\"typeDefs\" module=\"server\")\n\n#### [__Server__ Step 5.1: Add addMessage() mutation](https://github.com/Urigo/WhatsApp-Clone-Server/commit/cefd79b0f80f9cb0c38e8fc1b934b2ff3599c204)\n\n##### Changed schema&#x2F;typeDefs.graphql\n```diff\n@@ -18,3 +18,7 @@\n â”Š18â”Š18â”Š  chats: [Chat!]!\n â”Š19â”Š19â”Š  chat(chatId: ID!): Chat\n â”Š20â”Š20â”Š}\n+â”Š  â”Š21â”Š\n+â”Š  â”Š22â”Štype Mutation {\n+â”Š  â”Š23â”Š  addMessage(chatId: ID!, content: String!): Message\n+â”Š  â”Š24â”Š}\n```\n\n[}]: #\n\nNote that our mutation resolver `addMessage` receives a `chatId` and it is a non-optional parameter.\nThis is because when adding a message, we should update both the messages collection, and the correlated chat document.\n\nMutations are resolved exactly like any other type in our resolvers manifest. The new resolver should look like this:\n\n[{]: <helper> (diffStep 5.1 files=\"resolvers\" module=\"server\")\n\n#### [__Server__ Step 5.1: Add addMessage() mutation](https://github.com/Urigo/WhatsApp-Clone-Server/commit/cefd79b0f80f9cb0c38e8fc1b934b2ff3599c204)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -25,6 +25,32 @@\n â”Š25â”Š25â”Š      return chats.find(c => c.id === chatId);\n â”Š26â”Š26â”Š    },\n â”Š27â”Š27â”Š  },\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š  Mutation: {\n+â”Š  â”Š30â”Š    addMessage(root: any, { chatId, content }: any) {\n+â”Š  â”Š31â”Š      const chatIndex = chats.findIndex(c => c.id === chatId);\n+â”Š  â”Š32â”Š\n+â”Š  â”Š33â”Š      if (chatIndex === -1) return null;\n+â”Š  â”Š34â”Š\n+â”Š  â”Š35â”Š      const chat = chats[chatIndex];\n+â”Š  â”Š36â”Š\n+â”Š  â”Š37â”Š      const messagesIds = messages.map(currentMessage => Number(currentMessage.id));\n+â”Š  â”Š38â”Š      const messageId = String(Math.max(...messagesIds) + 1);\n+â”Š  â”Š39â”Š      const message = {\n+â”Š  â”Š40â”Š        id: messageId,\n+â”Š  â”Š41â”Š        createdAt: new Date(),\n+â”Š  â”Š42â”Š        content,\n+â”Š  â”Š43â”Š      };\n+â”Š  â”Š44â”Š\n+â”Š  â”Š45â”Š      messages.push(message);\n+â”Š  â”Š46â”Š      chat.messages.push(messageId);\n+â”Š  â”Š47â”Š      // The chat will appear at the top of the ChatsList component\n+â”Š  â”Š48â”Š      chats.splice(chatIndex, 1);\n+â”Š  â”Š49â”Š      chats.unshift(chat);\n+â”Š  â”Š50â”Š\n+â”Š  â”Š51â”Š      return message;\n+â”Š  â”Š52â”Š    },\n+â”Š  â”Š53â”Š  },\n â”Š28â”Š54â”Š};\n â”Š29â”Š55â”Š\n â”Š30â”Š56â”Šexport default resolvers;\n```\n\n[}]: #\n\nWhen we add a message, we first find the right chat,\nthen we generate a new message ID that is bigger then all the previous messages (when we'll move to a real database it will do that for us)\nand push the message into the right chat.\n\nIn terms of testing, we will use a temporary solution for now to reset the DB each time we test a mutation. Since we make a modification in the DB, we need to make sure that each test is completely agnostic and doesn't affect one another, thus, we will export a `resetDB()` method from our `db.ts` module:\n\n[{]: <helper> (diffStep 5.2 files=\"db.ts\" module=\"server\")\n\n#### [__Server__ Step 5.2: Test addMessage() mutation](https://github.com/Urigo/WhatsApp-Clone-Server/commit/9691a15d2e6a61a0ae1b5f46279499b318ac4186)\n\n##### Changed db.ts\n```diff\n@@ -1,51 +1,83 @@\n-â”Š 1â”Š  â”Šexport const messages = [\n-â”Š 2â”Š  â”Š  {\n-â”Š 3â”Š  â”Š    id: '1',\n-â”Š 4â”Š  â”Š    content: 'You on your way?',\n-â”Š 5â”Š  â”Š    createdAt: new Date(new Date('1-1-2019').getTime() - 60 * 1000 * 1000),\n-â”Š 6â”Š  â”Š  },\n-â”Š 7â”Š  â”Š  {\n-â”Š 8â”Š  â”Š    id: '2',\n-â”Š 9â”Š  â”Š    content: \"Hey, it's me\",\n-â”Š10â”Š  â”Š    createdAt: new Date(new Date('1-1-2019').getTime() - 2 * 60 * 1000 * 1000),\n-â”Š11â”Š  â”Š  },\n-â”Š12â”Š  â”Š  {\n-â”Š13â”Š  â”Š    id: '3',\n-â”Š14â”Š  â”Š    content: 'I should buy a boat',\n-â”Š15â”Š  â”Š    createdAt: new Date(new Date('1-1-2019').getTime() - 24 * 60 * 1000 * 1000),\n-â”Š16â”Š  â”Š  },\n-â”Š17â”Š  â”Š  {\n-â”Š18â”Š  â”Š    id: '4',\n-â”Š19â”Š  â”Š    content: 'This is wicked good ice cream.',\n-â”Š20â”Š  â”Š    createdAt: new Date(\n-â”Š21â”Š  â”Š      new Date('1-1-2019').getTime() - 14 * 24 * 60 * 1000 * 1000\n-â”Š22â”Š  â”Š    ),\n-â”Š23â”Š  â”Š  },\n-â”Š24â”Š  â”Š];\n+â”Š  â”Š 1â”Šexport type Message = {\n+â”Š  â”Š 2â”Š  id: string;\n+â”Š  â”Š 3â”Š  content: string;\n+â”Š  â”Š 4â”Š  createdAt: Date;\n+â”Š  â”Š 5â”Š};\n â”Š25â”Š 6â”Š\n-â”Š26â”Š  â”Šexport const chats = [\n-â”Š27â”Š  â”Š  {\n-â”Š28â”Š  â”Š    id: '1',\n-â”Š29â”Š  â”Š    name: 'Ethan Gonzalez',\n-â”Š30â”Š  â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n-â”Š31â”Š  â”Š    messages: ['1'],\n-â”Š32â”Š  â”Š  },\n-â”Š33â”Š  â”Š  {\n-â”Š34â”Š  â”Š    id: '2',\n-â”Š35â”Š  â”Š    name: 'Bryan Wallace',\n-â”Š36â”Š  â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n-â”Š37â”Š  â”Š    messages: ['2'],\n-â”Š38â”Š  â”Š  },\n-â”Š39â”Š  â”Š  {\n-â”Š40â”Š  â”Š    id: '3',\n-â”Š41â”Š  â”Š    name: 'Avery Stewart',\n-â”Š42â”Š  â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n-â”Š43â”Š  â”Š    messages: ['3'],\n-â”Š44â”Š  â”Š  },\n-â”Š45â”Š  â”Š  {\n-â”Š46â”Š  â”Š    id: '4',\n-â”Š47â”Š  â”Š    name: 'Katie Peterson',\n-â”Š48â”Š  â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n-â”Š49â”Š  â”Š    messages: ['4'],\n-â”Š50â”Š  â”Š  },\n-â”Š51â”Š  â”Š];\n+â”Š  â”Š 7â”Šexport type Chat = {\n+â”Š  â”Š 8â”Š  id: string;\n+â”Š  â”Š 9â”Š  name: string;\n+â”Š  â”Š10â”Š  picture: string;\n+â”Š  â”Š11â”Š  messages: string[];\n+â”Š  â”Š12â”Š};\n+â”Š  â”Š13â”Š\n+â”Š  â”Š14â”Šexport const messages: Message[] = [];\n+â”Š  â”Š15â”Šexport const chats: Chat[] = [];\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Šexport const resetDb = () => {\n+â”Š  â”Š18â”Š  messages.splice(\n+â”Š  â”Š19â”Š    0,\n+â”Š  â”Š20â”Š    Infinity,\n+â”Š  â”Š21â”Š    ...[\n+â”Š  â”Š22â”Š      {\n+â”Š  â”Š23â”Š        id: '1',\n+â”Š  â”Š24â”Š        content: 'You on your way?',\n+â”Š  â”Š25â”Š        createdAt: new Date(new Date('1-1-2019').getTime() - 60 * 1000 * 1000),\n+â”Š  â”Š26â”Š      },\n+â”Š  â”Š27â”Š      {\n+â”Š  â”Š28â”Š        id: '2',\n+â”Š  â”Š29â”Š        content: \"Hey, it's me\",\n+â”Š  â”Š30â”Š        createdAt: new Date(\n+â”Š  â”Š31â”Š          new Date('1-1-2019').getTime() - 2 * 60 * 1000 * 1000\n+â”Š  â”Š32â”Š        ),\n+â”Š  â”Š33â”Š      },\n+â”Š  â”Š34â”Š      {\n+â”Š  â”Š35â”Š        id: '3',\n+â”Š  â”Š36â”Š        content: 'I should buy a boat',\n+â”Š  â”Š37â”Š        createdAt: new Date(\n+â”Š  â”Š38â”Š          new Date('1-1-2019').getTime() - 24 * 60 * 1000 * 1000\n+â”Š  â”Š39â”Š        ),\n+â”Š  â”Š40â”Š      },\n+â”Š  â”Š41â”Š      {\n+â”Š  â”Š42â”Š        id: '4',\n+â”Š  â”Š43â”Š        content: 'This is wicked good ice cream.',\n+â”Š  â”Š44â”Š        createdAt: new Date(\n+â”Š  â”Š45â”Š          new Date('1-1-2019').getTime() - 14 * 24 * 60 * 1000 * 1000\n+â”Š  â”Š46â”Š        ),\n+â”Š  â”Š47â”Š      },\n+â”Š  â”Š48â”Š    ]\n+â”Š  â”Š49â”Š  );\n+â”Š  â”Š50â”Š\n+â”Š  â”Š51â”Š  chats.splice(\n+â”Š  â”Š52â”Š    0,\n+â”Š  â”Š53â”Š    Infinity,\n+â”Š  â”Š54â”Š    ...[\n+â”Š  â”Š55â”Š      {\n+â”Š  â”Š56â”Š        id: '1',\n+â”Š  â”Š57â”Š        name: 'Ethan Gonzalez',\n+â”Š  â”Š58â”Š        picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n+â”Š  â”Š59â”Š        messages: ['1'],\n+â”Š  â”Š60â”Š      },\n+â”Š  â”Š61â”Š      {\n+â”Š  â”Š62â”Š        id: '2',\n+â”Š  â”Š63â”Š        name: 'Bryan Wallace',\n+â”Š  â”Š64â”Š        picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n+â”Š  â”Š65â”Š        messages: ['2'],\n+â”Š  â”Š66â”Š      },\n+â”Š  â”Š67â”Š      {\n+â”Š  â”Š68â”Š        id: '3',\n+â”Š  â”Š69â”Š        name: 'Avery Stewart',\n+â”Š  â”Š70â”Š        picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n+â”Š  â”Š71â”Š        messages: ['3'],\n+â”Š  â”Š72â”Š      },\n+â”Š  â”Š73â”Š      {\n+â”Š  â”Š74â”Š        id: '4',\n+â”Š  â”Š75â”Š        name: 'Katie Peterson',\n+â”Š  â”Š76â”Š        picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n+â”Š  â”Š77â”Š        messages: ['4'],\n+â”Š  â”Š78â”Š      },\n+â”Š  â”Š79â”Š    ]\n+â”Š  â”Š80â”Š  );\n+â”Š  â”Š81â”Š};\n+â”Š  â”Š82â”Š\n+â”Š  â”Š83â”ŠresetDb();\n```\n\n[}]: #\n\nAnd we will use the `beforeEach()` test hook to reset the `chats` and `messages` collections:\n\n[{]: <helper> (diffStep 5.2 files=\"tests\" module=\"server\")\n\n#### [__Server__ Step 5.2: Test addMessage() mutation](https://github.com/Urigo/WhatsApp-Clone-Server/commit/9691a15d2e6a61a0ae1b5f46279499b318ac4186)\n\n##### Added tests&#x2F;mutations&#x2F;\\__snapshots__&#x2F;addMessage.test.ts.snap\n```diff\n@@ -0,0 +1,22 @@\n+â”Š  â”Š 1â”Š// Jest Snapshot v1, https://goo.gl/fbAQLP\n+â”Š  â”Š 2â”Š\n+â”Š  â”Š 3â”Šexports[`Mutation.addMessage should add message to specified chat 1`] = `\n+â”Š  â”Š 4â”ŠObject {\n+â”Š  â”Š 5â”Š  \"addMessage\": Object {\n+â”Š  â”Š 6â”Š    \"content\": \"Hello World\",\n+â”Š  â”Š 7â”Š    \"id\": \"5\",\n+â”Š  â”Š 8â”Š  },\n+â”Š  â”Š 9â”Š}\n+â”Š  â”Š10â”Š`;\n+â”Š  â”Š11â”Š\n+â”Š  â”Š12â”Šexports[`Mutation.addMessage should add message to specified chat 2`] = `\n+â”Š  â”Š13â”ŠObject {\n+â”Š  â”Š14â”Š  \"chat\": Object {\n+â”Š  â”Š15â”Š    \"id\": \"1\",\n+â”Š  â”Š16â”Š    \"lastMessage\": Object {\n+â”Š  â”Š17â”Š      \"content\": \"Hello World\",\n+â”Š  â”Š18â”Š      \"id\": \"5\",\n+â”Š  â”Š19â”Š    },\n+â”Š  â”Š20â”Š  },\n+â”Š  â”Š21â”Š}\n+â”Š  â”Š22â”Š`;\n```\n\n##### Added tests&#x2F;mutations&#x2F;addMessage.test.ts\n```diff\n@@ -0,0 +1,49 @@\n+â”Š  â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n+â”Š  â”Š 2â”Šimport { ApolloServer, gql } from 'apollo-server-express';\n+â”Š  â”Š 3â”Šimport schema from '../../schema';\n+â”Š  â”Š 4â”Šimport { resetDb } from '../../db';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šdescribe('Mutation.addMessage', () => {\n+â”Š  â”Š 7â”Š  beforeEach(resetDb);\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Š  it('should add message to specified chat', async () => {\n+â”Š  â”Š10â”Š    const server = new ApolloServer({ schema });\n+â”Š  â”Š11â”Š\n+â”Š  â”Š12â”Š    const { query, mutate } = createTestClient(server);\n+â”Š  â”Š13â”Š\n+â”Š  â”Š14â”Š    const addMessageRes = await mutate({\n+â”Š  â”Š15â”Š      variables: { chatId: '1', content: 'Hello World' },\n+â”Š  â”Š16â”Š      mutation: gql`\n+â”Š  â”Š17â”Š        mutation AddMessage($chatId: ID!, $content: String!) {\n+â”Š  â”Š18â”Š          addMessage(chatId: $chatId, content: $content) {\n+â”Š  â”Š19â”Š            id\n+â”Š  â”Š20â”Š            content\n+â”Š  â”Š21â”Š          }\n+â”Š  â”Š22â”Š        }\n+â”Š  â”Š23â”Š      `,\n+â”Š  â”Š24â”Š    });\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Š    expect(addMessageRes.data).toBeDefined();\n+â”Š  â”Š27â”Š    expect(addMessageRes.errors).toBeUndefined();\n+â”Š  â”Š28â”Š    expect(addMessageRes.data).toMatchSnapshot();\n+â”Š  â”Š29â”Š\n+â”Š  â”Š30â”Š    const getChatRes = await query({\n+â”Š  â”Š31â”Š      variables: { chatId: '1' },\n+â”Š  â”Š32â”Š      query: gql`\n+â”Š  â”Š33â”Š        query GetChat($chatId: ID!) {\n+â”Š  â”Š34â”Š          chat(chatId: $chatId) {\n+â”Š  â”Š35â”Š            id\n+â”Š  â”Š36â”Š            lastMessage {\n+â”Š  â”Š37â”Š              id\n+â”Š  â”Š38â”Š              content\n+â”Š  â”Š39â”Š            }\n+â”Š  â”Š40â”Š          }\n+â”Š  â”Š41â”Š        }\n+â”Š  â”Š42â”Š      `,\n+â”Š  â”Š43â”Š    });\n+â”Š  â”Š44â”Š\n+â”Š  â”Š45â”Š    expect(getChatRes.data).toBeDefined();\n+â”Š  â”Š46â”Š    expect(getChatRes.errors).toBeUndefined();\n+â”Š  â”Š47â”Š    expect(getChatRes.data).toMatchSnapshot();\n+â”Š  â”Š48â”Š  });\n+â”Š  â”Š49â”Š});\n```\n\n[}]: #\n\nNow we have the infrastructure set for sending a new message and we can start using it in our client.\n\n**How to use a GraphQL mutation?**\n\nLike in the previous chapters, we're gonna use a React hook so we can run a mutation more efficiently in a React.Component.\nFor this we're gonna use the [`useMutation()`](https://www.apollographql.com/docs/react/essentials/mutations/#the-usemutation-hook) react hook.\nThe first argument of the hook is the mutation string, and the second one is the [mutation options](https://www.apollographql.com/docs/react/api/apollo-client.html#ApolloClient.mutate).\nWe're gonna provide our mutation call with a single option called `optimisticResponse`.\n\nOptimistic response is a common pattern that will update the state of the component twice so we can have a better UX: First it updates the component's state with the predicted result,\nand then it will update the state with the actual result.\n\n\n\n![optimistic_response](https://user-images.githubusercontent.com/7648874/54883302-859df900-4e9f-11e9-9eb7-a98108cd2482.png)\n\n\nThis is how the component should look like:\n\n[{]: <helper> (diffStep 8.1 module=\"client\")\n\n#### [__Client__ Step 8.1: Send message with a GraphQL mutation](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/840b5504f28da008395352118a3f19188d97da0e)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -1,7 +1,7 @@\n â”Š1â”Š1â”Šimport gql from 'graphql-tag';\n â”Š2â”Š2â”Šimport React from 'react';\n â”Š3â”Š3â”Šimport { useCallback } from 'react';\n-â”Š4â”Š â”Šimport { useApolloClient, useQuery } from '@apollo/react-hooks';\n+â”Š â”Š4â”Šimport { useQuery, useMutation } from '@apollo/react-hooks';\n â”Š5â”Š5â”Šimport styled from 'styled-components';\n â”Š6â”Š6â”Šimport ChatNavbar from './ChatNavbar';\n â”Š7â”Š7â”Šimport MessageInput from './MessageInput';\n```\n```diff\n@@ -30,6 +30,16 @@\n â”Š30â”Š30â”Š  }\n â”Š31â”Š31â”Š`;\n â”Š32â”Š32â”Š\n+â”Š  â”Š33â”Šconst addMessageMutation = gql`\n+â”Š  â”Š34â”Š  mutation AddMessage($chatId: ID!, $content: String!) {\n+â”Š  â”Š35â”Š    addMessage(chatId: $chatId, content: $content) {\n+â”Š  â”Š36â”Š      id\n+â”Š  â”Š37â”Š      content\n+â”Š  â”Š38â”Š      createdAt\n+â”Š  â”Š39â”Š    }\n+â”Š  â”Š40â”Š  }\n+â”Š  â”Š41â”Š`;\n+â”Š  â”Š42â”Š\n â”Š33â”Š43â”Šinterface ChatRoomScreenParams {\n â”Š34â”Š44â”Š  chatId: string;\n â”Š35â”Š45â”Š  history: History;\n```\n```diff\n@@ -54,36 +64,43 @@\n â”Š 54â”Š 64â”Š  history,\n â”Š 55â”Š 65â”Š  chatId,\n â”Š 56â”Š 66â”Š}) => {\n-â”Š 57â”Š   â”Š  const client = useApolloClient();\n â”Š 58â”Š 67â”Š  const {\n â”Š 59â”Š 68â”Š    data: { chat },\n â”Š 60â”Š 69â”Š  } = useQuery<any>(getChatQuery, {\n â”Š 61â”Š 70â”Š    variables: { chatId },\n â”Š 62â”Š 71â”Š  });\n+â”Š   â”Š 72â”Š  const [addMessage] = useMutation(addMessageMutation);\n â”Š 63â”Š 73â”Š\n â”Š 64â”Š 74â”Š  const onSendMessage = useCallback(\n â”Š 65â”Š 75â”Š    (content: string) => {\n-â”Š 66â”Š   â”Š      if (!chat) return null;\n-â”Š 67â”Š   â”Š\n-â”Š 68â”Š   â”Š      const message = {\n-â”Š 69â”Š   â”Š        id: (chat.messages.length + 10).toString(),\n-â”Š 70â”Š   â”Š        createdAt: new Date(),\n-â”Š 71â”Š   â”Š        content,\n-â”Š 72â”Š   â”Š        __typename: 'Chat',\n-â”Š 73â”Š   â”Š      };\n-â”Š 74â”Š   â”Š\n-â”Š 75â”Š   â”Š      client.writeQuery({\n-â”Š 76â”Š   â”Š        query: getChatQuery,\n-â”Š 77â”Š   â”Š        variables: { chatId },\n-â”Š 78â”Š   â”Š        data: {\n-â”Š 79â”Š   â”Š          chat: {\n-â”Š 80â”Š   â”Š            ...chat,\n-â”Š 81â”Š   â”Š            messages: chat.messages.concat(message),\n+â”Š   â”Š 76â”Š      addMessage({\n+â”Š   â”Š 77â”Š        variables: { chatId, content },\n+â”Š   â”Š 78â”Š        optimisticResponse: {\n+â”Š   â”Š 79â”Š          __typename: 'Mutation',\n+â”Š   â”Š 80â”Š          addMessage: {\n+â”Š   â”Š 81â”Š            __typename: 'Message',\n+â”Š   â”Š 82â”Š            id: Math.random()\n+â”Š   â”Š 83â”Š              .toString(36)\n+â”Š   â”Š 84â”Š              .substr(2, 9),\n+â”Š   â”Š 85â”Š            createdAt: new Date(),\n+â”Š   â”Š 86â”Š            content,\n â”Š 82â”Š 87â”Š          },\n â”Š 83â”Š 88â”Š        },\n+â”Š   â”Š 89â”Š        update: (client, { data: { addMessage } }) => {\n+â”Š   â”Š 90â”Š          client.writeQuery({\n+â”Š   â”Š 91â”Š            query: getChatQuery,\n+â”Š   â”Š 92â”Š            variables: { chatId },\n+â”Š   â”Š 93â”Š            data: {\n+â”Š   â”Š 94â”Š              chat: {\n+â”Š   â”Š 95â”Š                ...chat,\n+â”Š   â”Š 96â”Š                messages: chat.messages.concat(addMessage),\n+â”Š   â”Š 97â”Š              },\n+â”Š   â”Š 98â”Š            },\n+â”Š   â”Š 99â”Š          });\n+â”Š   â”Š100â”Š        },\n â”Š 84â”Š101â”Š      });\n â”Š 85â”Š102â”Š    },\n-â”Š 86â”Š   â”Š    [chat, chatId, client]\n+â”Š   â”Š103â”Š    [chat, chatId, addMessage]\n â”Š 87â”Š104â”Š  );\n â”Š 88â”Š105â”Š\n â”Š 89â”Š106â”Š  if (!chat) return null;\n```\n\n[}]: #\n\nNote that unlike `useQuery()`, `useMutation()` returns a callback that will run the mutation only once called, NOT immediately.\nSeemingly, everything works fine, but if you'll try to navigate from `ChatsListScreen` to `ChatRoomScreen`, send a message, and then go back, you'll see that the last message was not updated.\nSo why is that exactly?\n\n**Cache updating**\n\nAs explained in the previous chapter, Apollo-Client will cache all the results in a data-store.\nLater on, rather than re-fetching the data, it will look up for the result in the store and will serve it to you in case it exists.\nThat means, that even though we ran the mutation and updated the data on the server, our data-store is still left behind and it needs to be updated as well,\notherwise Apollo-Client will see nothing wrong with the outcome.\n\nApollo-Client stores the data in a hash, where the key represents the query and the value represents the retrieved result.\nThis means that the cache will need to be updated for:\n\n\n*   `chats` query - which we already did, without really diving into the reason behind it.\n*   `chat(chatId: $chatId)` where `chatId` is the chat that was just mutated.\n\nIndeed, a query will be duplicated for each and every distinct set of parameters.\nSo potentially our data-store can grow infinite amount of times, and we will need to take care of it and manage it correctly, so things won't get out of hand.\n\nTo update a query, we will first export the `getChats` query to a separate file so it can be imported in the `ChatRoomScreen`.\nWe will define all our GraphQL assets under the `src/graphql` directory:\n\n[{]: <helper> (diffStep 8.2 files=\"graphql\" module=\"client\")\n\n#### [__Client__ Step 8.2: Rewrite lastMessage to chats query](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/8ccec8b94e7efaf13327cf0469e4d0bf17927ef8)\n\n##### Added src&#x2F;graphql&#x2F;queries&#x2F;chats.query.ts\n```diff\n@@ -0,0 +1,16 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag';\n+â”Š  â”Š 2â”Š\n+â”Š  â”Š 3â”Šexport default gql`\n+â”Š  â”Š 4â”Š  query Chats {\n+â”Š  â”Š 5â”Š    chats {\n+â”Š  â”Š 6â”Š      id\n+â”Š  â”Š 7â”Š      name\n+â”Š  â”Š 8â”Š      picture\n+â”Š  â”Š 9â”Š      lastMessage {\n+â”Š  â”Š10â”Š        id\n+â”Š  â”Š11â”Š        content\n+â”Š  â”Š12â”Š        createdAt\n+â”Š  â”Š13â”Š      }\n+â”Š  â”Š14â”Š    }\n+â”Š  â”Š15â”Š  }\n+â”Š  â”Š16â”Š`;\n```\n\n##### Added src&#x2F;graphql&#x2F;queries&#x2F;index.ts\n```diff\n@@ -0,0 +1 @@\n+â”Š â”Š1â”Šexport { default as chats } from './chats.query';\n```\n\n[}]: #\n\nAnd then we will read the memoized result from the store using [`client.readQuery`](https://www.apollographql.com/docs/react/features/caching.html#readquery),\nupdate it, and then rewrite it using [`client.writeQuery`](https://www.apollographql.com/docs/react/features/caching.html#writequery-and-writefragment).\nWe can gain access to the client object via the `update` callback which will be triggered right after the mutation has been successfully executed.\nThis is how it should look like:\n\n[{]: <helper> (diffStep 8.2 files=\"components\" module=\"client\")\n\n#### [__Client__ Step 8.2: Rewrite lastMessage to chats query](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/8ccec8b94e7efaf13327cf0469e4d0bf17927ef8)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -7,6 +7,7 @@\n â”Š 7â”Š 7â”Šimport MessageInput from './MessageInput';\n â”Š 8â”Š 8â”Šimport MessagesList from './MessagesList';\n â”Š 9â”Š 9â”Šimport { History } from 'history';\n+â”Š  â”Š10â”Šimport * as queries from '../../graphql/queries';\n â”Š10â”Š11â”Š\n â”Š11â”Š12â”Šconst Container = styled.div`\n â”Š12â”Š13â”Š  background: url(/assets/chat-background.jpg);\n```\n```diff\n@@ -60,6 +61,10 @@\n â”Š60â”Š61â”Š\n â”Š61â”Š62â”Štype OptionalChatQueryResult = ChatQueryResult | null;\n â”Š62â”Š63â”Š\n+â”Š  â”Š64â”Šinterface ChatsResult {\n+â”Š  â”Š65â”Š  chats: any[];\n+â”Š  â”Š66â”Š}\n+â”Š  â”Š67â”Š\n â”Š63â”Š68â”Šconst ChatRoomScreen: React.FC<ChatRoomScreenParams> = ({\n â”Š64â”Š69â”Š  history,\n â”Š65â”Š70â”Š  chatId,\n```\n```diff\n@@ -97,6 +102,37 @@\n â”Š 97â”Š102â”Š              },\n â”Š 98â”Š103â”Š            },\n â”Š 99â”Š104â”Š          });\n+â”Š   â”Š105â”Š\n+â”Š   â”Š106â”Š          let data;\n+â”Š   â”Š107â”Š          try {\n+â”Š   â”Š108â”Š            data = client.readQuery<ChatsResult>({\n+â”Š   â”Š109â”Š              query: queries.chats,\n+â”Š   â”Š110â”Š            });\n+â”Š   â”Š111â”Š          } catch (e) {\n+â”Š   â”Š112â”Š            return;\n+â”Š   â”Š113â”Š          }\n+â”Š   â”Š114â”Š\n+â”Š   â”Š115â”Š          if (!data || data === null) {\n+â”Š   â”Š116â”Š            return null;\n+â”Š   â”Š117â”Š          }\n+â”Š   â”Š118â”Š          if (!data.chats || data.chats === undefined) {\n+â”Š   â”Š119â”Š            return null;\n+â”Š   â”Š120â”Š          }\n+â”Š   â”Š121â”Š          const chats = data.chats;\n+â”Š   â”Š122â”Š\n+â”Š   â”Š123â”Š          const chatIndex = chats.findIndex((c: any) => c.id === chatId);\n+â”Š   â”Š124â”Š          if (chatIndex === -1) return;\n+â”Š   â”Š125â”Š          const chatWhereAdded = chats[chatIndex];\n+â”Š   â”Š126â”Š\n+â”Š   â”Š127â”Š          chatWhereAdded.lastMessage = addMessage;\n+â”Š   â”Š128â”Š          // The chat will appear at the top of the ChatsList component\n+â”Š   â”Š129â”Š          chats.splice(chatIndex, 1);\n+â”Š   â”Š130â”Š          chats.unshift(chatWhereAdded);\n+â”Š   â”Š131â”Š\n+â”Š   â”Š132â”Š          client.writeQuery({\n+â”Š   â”Š133â”Š            query: queries.chats,\n+â”Š   â”Š134â”Š            data: { chats: chats },\n+â”Š   â”Š135â”Š          });\n â”Š100â”Š136â”Š        },\n â”Š101â”Š137â”Š      });\n â”Š102â”Š138â”Š    },\n```\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.test.tsx\n```diff\n@@ -11,6 +11,7 @@\n â”Š11â”Š11â”Šimport { createBrowserHistory } from 'history';\n â”Š12â”Š12â”Šimport { mockApolloClient } from '../../test-helpers';\n â”Š13â”Š13â”Šimport ChatsList, { getChatsQuery } from './ChatsList';\n+â”Š  â”Š14â”Šimport * as queries from '../../graphql/queries';\n â”Š14â”Š15â”Š\n â”Š15â”Š16â”Šdescribe('ChatsList', () => {\n â”Š16â”Š17â”Š  afterEach(() => {\n```\n```diff\n@@ -25,7 +26,7 @@\n â”Š25â”Š26â”Š  it('renders fetched chats data', async () => {\n â”Š26â”Š27â”Š    const client = mockApolloClient([\n â”Š27â”Š28â”Š      {\n-â”Š28â”Š  â”Š        request: { query: getChatsQuery },\n+â”Š  â”Š29â”Š        request: { query: queries.chats },\n â”Š29â”Š30â”Š        result: {\n â”Š30â”Š31â”Š          data: {\n â”Š31â”Š32â”Š            chats: [\n```\n```diff\n@@ -71,7 +72,7 @@\n â”Š71â”Š72â”Š  it('should navigate to the target chat room on chat item click', async () => {\n â”Š72â”Š73â”Š    const client = mockApolloClient([\n â”Š73â”Š74â”Š      {\n-â”Š74â”Š  â”Š        request: { query: getChatsQuery },\n+â”Š  â”Š75â”Š        request: { query: queries.chats },\n â”Š75â”Š76â”Š        result: {\n â”Š76â”Š77â”Š          data: {\n â”Š77â”Š78â”Š            chats: [\n```\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -4,8 +4,8 @@\n â”Š 4â”Š 4â”Šimport styled from 'styled-components';\n â”Š 5â”Š 5â”Šimport { useCallback } from 'react';\n â”Š 6â”Š 6â”Šimport { History } from 'history';\n-â”Š 7â”Š  â”Šimport gql from 'graphql-tag';\n â”Š 8â”Š 7â”Šimport { useQuery } from '@apollo/react-hooks';\n+â”Š  â”Š 8â”Šimport * as queries from '../../graphql/queries';\n â”Š 9â”Š 9â”Š\n â”Š10â”Š10â”Šconst Container = styled.div`\n â”Š11â”Š11â”Š  height: calc(100% - 56px);\n```\n```diff\n@@ -59,27 +59,12 @@\n â”Š59â”Š59â”Š  font-size: 13px;\n â”Š60â”Š60â”Š`;\n â”Š61â”Š61â”Š\n-â”Š62â”Š  â”Šexport const getChatsQuery = gql`\n-â”Š63â”Š  â”Š  query GetChats {\n-â”Š64â”Š  â”Š    chats {\n-â”Š65â”Š  â”Š      id\n-â”Š66â”Š  â”Š      name\n-â”Š67â”Š  â”Š      picture\n-â”Š68â”Š  â”Š      lastMessage {\n-â”Š69â”Š  â”Š        id\n-â”Š70â”Š  â”Š        content\n-â”Š71â”Š  â”Š        createdAt\n-â”Š72â”Š  â”Š      }\n-â”Š73â”Š  â”Š    }\n-â”Š74â”Š  â”Š  }\n-â”Š75â”Š  â”Š`;\n-â”Š76â”Š  â”Š\n â”Š77â”Š62â”Šinterface ChatsListProps {\n â”Š78â”Š63â”Š  history: History;\n â”Š79â”Š64â”Š}\n â”Š80â”Š65â”Š\n â”Š81â”Š66â”Šconst ChatsList: React.FC<ChatsListProps> = ({ history }) => {\n-â”Š82â”Š  â”Š  const { data } = useQuery<any>(getChatsQuery);\n+â”Š  â”Š67â”Š  const { data } = useQuery<any>(queries.chats);\n â”Š83â”Š68â”Š\n â”Š84â”Š69â”Š  const navToChat = useCallback(\n â”Š85â”Š70â”Š    chat => {\n```\n\n[}]: #\n\nRight now what happens is that we update a single chat document twice: Once for the `chats` query and another time for the `chat($chatId)` query.\nThis work is redundant and become more complex as we add more `chat` related queries.\nTo solve it, we can define and use a [GraphQL fragment](https://www.apollographql.com/docs/react/advanced/fragments.html).\n\n**Using Fragments**\n\nA GraphQL fragment is a shared piece of query logic.\n\n```graphql\nfragment NameParts on Person {\n  firstName\n  lastName\n}\n\nquery GetPerson {\n  people(id: \"7\") {\n    ...NameParts\n    avatar(size: LARGE)\n  }\n}\n```\n\nIt's important to note that the component after the `on` clause is designated for the type we are selecting from. In this case, `people` is of type `Person` and we want to select the `firstName` and `lastName` fields from `people(id: \"7\")`.\n\nApollo maps the fragment ID to its retrieved data in the store. By default, Apollo will compose the fragment ID out of the entity type and the ID of the document. For example, for a `Chat` document with an ID of `7`, the fragment ID would be `Chat:7`. This behavior can be modified, but there's no need to.\n\nWe will define the following fragments in our app:\n\n\n\n*   `Message` - represents a message\n*   `Chat` - represents a chat, **without its messages list**.\n*   `FullChat` - represents a chat, **including its messages list**.\n\nOnce we define the fragments we can start embedding them in our queries. We will create a new directory path `src/graphql/fragments`, and inside we will create a dedicated fragment file for each fragment type: `message.fragment.ts`, `chat.fragment.ts` and `fullChat.fragment.ts`:\n\n[{]: <helper> (diffStep 8.3 files=\"graphql/fragments\" module=\"client\")\n\n#### [__Client__ Step 8.3: Update queries to use GraphQL fragments](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/c88a50e4639439f15c42411c5f1478316d9c8a6a)\n\n##### Added src&#x2F;graphql&#x2F;fragments&#x2F;chat.fragment.ts\n```diff\n@@ -0,0 +1,14 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag';\n+â”Š  â”Š 2â”Šimport message from './message.fragment';\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šexport default gql`\n+â”Š  â”Š 5â”Š  fragment Chat on Chat {\n+â”Š  â”Š 6â”Š    id\n+â”Š  â”Š 7â”Š    name\n+â”Š  â”Š 8â”Š    picture\n+â”Š  â”Š 9â”Š    lastMessage {\n+â”Š  â”Š10â”Š      ...Message\n+â”Š  â”Š11â”Š    }\n+â”Š  â”Š12â”Š  }\n+â”Š  â”Š13â”Š  ${message}\n+â”Š  â”Š14â”Š`;\n```\n\n##### Added src&#x2F;graphql&#x2F;fragments&#x2F;fullChat.fragment.ts\n```diff\n@@ -0,0 +1,14 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag';\n+â”Š  â”Š 2â”Šimport chat from './chat.fragment';\n+â”Š  â”Š 3â”Šimport message from './message.fragment';\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šexport default gql`\n+â”Š  â”Š 6â”Š  fragment FullChat on Chat {\n+â”Š  â”Š 7â”Š    ...Chat\n+â”Š  â”Š 8â”Š    messages {\n+â”Š  â”Š 9â”Š      ...Message\n+â”Š  â”Š10â”Š    }\n+â”Š  â”Š11â”Š  }\n+â”Š  â”Š12â”Š  ${chat}\n+â”Š  â”Š13â”Š  ${message}\n+â”Š  â”Š14â”Š`;\n```\n\n##### Added src&#x2F;graphql&#x2F;fragments&#x2F;index.ts\n```diff\n@@ -0,0 +1,3 @@\n+â”Š â”Š1â”Šexport { default as chat } from './chat.fragment';\n+â”Š â”Š2â”Šexport { default as fullChat } from './fullChat.fragment';\n+â”Š â”Š3â”Šexport { default as message } from './message.fragment';\n```\n\n##### Added src&#x2F;graphql&#x2F;fragments&#x2F;message.fragment.ts\n```diff\n@@ -0,0 +1,9 @@\n+â”Š â”Š1â”Šimport gql from 'graphql-tag';\n+â”Š â”Š2â”Š\n+â”Š â”Š3â”Šexport default gql`\n+â”Š â”Š4â”Š  fragment Message on Message {\n+â”Š â”Š5â”Š    id\n+â”Š â”Š6â”Š    createdAt\n+â”Š â”Š7â”Š    content\n+â”Š â”Š8â”Š  }\n+â”Š â”Š9â”Š`;\n```\n\n[}]: #\n\nAnd now that we have the fragments available to us, let's embed them in the relevant queries:\n\n[{]: <helper> (diffStep 8.3 files=\"components, graphql/queries\" module=\"client\")\n\n#### [__Client__ Step 8.3: Update queries to use GraphQL fragments](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/c88a50e4639439f15c42411c5f1478316d9c8a6a)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -8,6 +8,7 @@\n â”Š 8â”Š 8â”Šimport MessagesList from './MessagesList';\n â”Š 9â”Š 9â”Šimport { History } from 'history';\n â”Š10â”Š10â”Šimport * as queries from '../../graphql/queries';\n+â”Š  â”Š11â”Šimport * as fragments from '../../graphql/fragments';\n â”Š11â”Š12â”Š\n â”Š12â”Š13â”Šconst Container = styled.div`\n â”Š13â”Š14â”Š  background: url(/assets/chat-background.jpg);\n```\n```diff\n@@ -19,26 +20,19 @@\n â”Š19â”Š20â”Šconst getChatQuery = gql`\n â”Š20â”Š21â”Š  query GetChat($chatId: ID!) {\n â”Š21â”Š22â”Š    chat(chatId: $chatId) {\n-â”Š22â”Š  â”Š      id\n-â”Š23â”Š  â”Š      name\n-â”Š24â”Š  â”Š      picture\n-â”Š25â”Š  â”Š      messages {\n-â”Š26â”Š  â”Š        id\n-â”Š27â”Š  â”Š        content\n-â”Š28â”Š  â”Š        createdAt\n-â”Š29â”Š  â”Š      }\n+â”Š  â”Š23â”Š      ...FullChat\n â”Š30â”Š24â”Š    }\n â”Š31â”Š25â”Š  }\n+â”Š  â”Š26â”Š  ${fragments.fullChat}\n â”Š32â”Š27â”Š`;\n â”Š33â”Š28â”Š\n â”Š34â”Š29â”Šconst addMessageMutation = gql`\n â”Š35â”Š30â”Š  mutation AddMessage($chatId: ID!, $content: String!) {\n â”Š36â”Š31â”Š    addMessage(chatId: $chatId, content: $content) {\n-â”Š37â”Š  â”Š      id\n-â”Š38â”Š  â”Š      content\n-â”Š39â”Š  â”Š      createdAt\n+â”Š  â”Š32â”Š      ...Message\n â”Š40â”Š33â”Š    }\n â”Š41â”Š34â”Š  }\n+â”Š  â”Š35â”Š  ${fragments.message}\n â”Š42â”Š36â”Š`;\n â”Š43â”Š37â”Š\n â”Š44â”Š38â”Šinterface ChatRoomScreenParams {\n```\n\n##### Changed src&#x2F;graphql&#x2F;queries&#x2F;chats.query.ts\n```diff\n@@ -1,16 +1,11 @@\n â”Š 1â”Š 1â”Šimport gql from 'graphql-tag';\n+â”Š  â”Š 2â”Šimport * as fragments from '../fragments';\n â”Š 2â”Š 3â”Š\n â”Š 3â”Š 4â”Šexport default gql`\n â”Š 4â”Š 5â”Š  query Chats {\n â”Š 5â”Š 6â”Š    chats {\n-â”Š 6â”Š  â”Š      id\n-â”Š 7â”Š  â”Š      name\n-â”Š 8â”Š  â”Š      picture\n-â”Š 9â”Š  â”Š      lastMessage {\n-â”Š10â”Š  â”Š        id\n-â”Š11â”Š  â”Š        content\n-â”Š12â”Š  â”Š        createdAt\n-â”Š13â”Š  â”Š      }\n+â”Š  â”Š 7â”Š      ...Chat\n â”Š14â”Š 8â”Š    }\n â”Š15â”Š 9â”Š  }\n+â”Š  â”Š10â”Š  ${fragments.chat}\n â”Š16â”Š11â”Š`;\n```\n\n[}]: #\n\nSimilarly to query rewriting, we will use the [`readFragment()`](https://www.apollographql.com/docs/react/features/caching.html#readfragment) and [`writeFragment()`](https://www.apollographql.com/docs/react/features/caching.html#writefragment) methods in the same way to rewrite the fragments. When working with a fragment we need to compose its ID, just like explained earlier. The default mapping function called `defaultDataIdFromObject` can be imported from `apollo-cache-inmemory` and be used to specify the fragment that we would like to read/write. Accordingly, we're gonna replace all our query re-writings with fragments re-writings, as we don't need them anymore:\n\n[{]: <helper> (diffStep 8.4 module=\"client\")\n\n#### [__Client__ Step 8.4: Rewrite fragments](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/2dab313d7b1c7c0f636d0d9f07579a589516b020)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -1,3 +1,4 @@\n+â”Š â”Š1â”Šimport { defaultDataIdFromObject } from 'apollo-cache-inmemory';\n â”Š1â”Š2â”Šimport gql from 'graphql-tag';\n â”Š2â”Š3â”Šimport React from 'react';\n â”Š3â”Š4â”Šimport { useCallback } from 'react';\n```\n```diff\n@@ -86,15 +87,38 @@\n â”Š 86â”Š 87â”Š          },\n â”Š 87â”Š 88â”Š        },\n â”Š 88â”Š 89â”Š        update: (client, { data: { addMessage } }) => {\n-â”Š 89â”Š   â”Š          client.writeQuery({\n-â”Š 90â”Š   â”Š            query: getChatQuery,\n-â”Š 91â”Š   â”Š            variables: { chatId },\n-â”Š 92â”Š   â”Š            data: {\n-â”Š 93â”Š   â”Š              chat: {\n-â”Š 94â”Š   â”Š                ...chat,\n-â”Š 95â”Š   â”Š                messages: chat.messages.concat(addMessage),\n-â”Š 96â”Š   â”Š              },\n-â”Š 97â”Š   â”Š            },\n+â”Š   â”Š 90â”Š          type FullChat = { [key: string]: any };\n+â”Š   â”Š 91â”Š          let fullChat;\n+â”Š   â”Š 92â”Š          const chatIdFromStore = defaultDataIdFromObject(chat);\n+â”Š   â”Š 93â”Š\n+â”Š   â”Š 94â”Š          if (chatIdFromStore === null) {\n+â”Š   â”Š 95â”Š            return;\n+â”Š   â”Š 96â”Š          }\n+â”Š   â”Š 97â”Š\n+â”Š   â”Š 98â”Š          try {\n+â”Š   â”Š 99â”Š            fullChat = client.readFragment<FullChat>({\n+â”Š   â”Š100â”Š              id: chatIdFromStore,\n+â”Š   â”Š101â”Š              fragment: fragments.fullChat,\n+â”Š   â”Š102â”Š              fragmentName: 'FullChat',\n+â”Š   â”Š103â”Š            });\n+â”Š   â”Š104â”Š          } catch (e) {\n+â”Š   â”Š105â”Š            return;\n+â”Š   â”Š106â”Š          }\n+â”Š   â”Š107â”Š\n+â”Š   â”Š108â”Š          if (fullChat === null) {\n+â”Š   â”Š109â”Š            return;\n+â”Š   â”Š110â”Š          }\n+â”Š   â”Š111â”Š          if (fullChat.messages.some((m: any) => m.id === addMessage.id))\n+â”Š   â”Š112â”Š            return;\n+â”Š   â”Š113â”Š\n+â”Š   â”Š114â”Š          fullChat.messages.push(addMessage);\n+â”Š   â”Š115â”Š          fullChat.lastMessage = addMessage;\n+â”Š   â”Š116â”Š\n+â”Š   â”Š117â”Š          client.writeFragment({\n+â”Š   â”Š118â”Š            id: chatIdFromStore,\n+â”Š   â”Š119â”Š            fragment: fragments.fullChat,\n+â”Š   â”Š120â”Š            fragmentName: 'FullChat',\n+â”Š   â”Š121â”Š            data: fullChat,\n â”Š 98â”Š122â”Š          });\n â”Š 99â”Š123â”Š\n â”Š100â”Š124â”Š          let data;\n```\n```diff\n@@ -118,7 +142,6 @@\n â”Š118â”Š142â”Š          if (chatIndex === -1) return;\n â”Š119â”Š143â”Š          const chatWhereAdded = chats[chatIndex];\n â”Š120â”Š144â”Š\n-â”Š121â”Š   â”Š          chatWhereAdded.lastMessage = addMessage;\n â”Š122â”Š145â”Š          // The chat will appear at the top of the ChatsList component\n â”Š123â”Š146â”Š          chats.splice(chatIndex, 1);\n â”Š124â”Š147â”Š          chats.unshift(chatWhereAdded);\n```\n\n[}]: #\n\n\n----------\nTODO: Isnâ€™t `chats.splice(0, Infinity, ...[ â€¦ ])` the same as `chats = [...]` ?\nI see an explanation of apollo-cache but it makes you feel itâ€™s the fragment thatâ€™s being cached, which is not true, itâ€™s the object type.\nWe shouldnâ€™t use `defaultDataIdFromObject` directly from `apollo-cache-inmemory` but define it somewhere in our code and use that. It might change in the future and then we would have to do it in 500 files.\nI would explain a lot more than it is now, about the caching. It should be based on a simpler example and show that when an entity `Foo:1` is modified, the change reflects in all component. We should describe how itâ€™s stored, as references and not real data and so on.\n\nTODO: Better fragments naming and convensions"
          },
          {
            "manualTitle": "Step 9: Type safety with GraphQL Code Generator",
            "stepRevision": "812cce24cbf8511aa89bf01cee206b0b233d7570",
            "manualView": "So far we've been just writing code. If there was an error we would most likely discover it during runtime. As a reminder, we've created a project which is based on TypeScript, but we haven't really took any advantage of TypeScript's type safety mechanism. Currently, the TypeScript compiler is configured to work on loose mode, so any object which is not bound to any type will be converted to `any` - a type which is compatible with any type of casting and will ignore type errors.\n\nSo far it's been very convenient because we've only started to learn about building an app and the ecosystem around it, but for a long term project it's would be very handy to take a full advantage of TypeScript and not let it go under the radar. So where exactly are we missing type checkings? In the core of our project - when dealing with GraphQL documents.\n\nWhen we run a query, or a mutation, we wanna make sure that we use the received data correctly, based on its intended shape and form. For example, given the following GraphQL query:\n\n```graphql\nquery Chats {\n  chats {\n    id\n    name\n    picture\n  }\n}\n```\n\nWe want to have the following TypeScript type:\n\n```ts\nexport type Chat = {\n  __typename?: \"Chat\"\n  id: string\n  name: string\n  picture: string\n}\n\nexport type ChatQuery = {\n  __typename?: \"Query\"\n  chats: Chats[]\n}\n\n```\n\nSo later on we can use it with `@apollo/react-hooks` like so:\n\n```ts\nuseQuery<ChatsQuery>(getChatsQuery)\n```\n\nEverything looks nice in theory, but the main issue that arises from having type definitions is that we need to maintain and sync 2 similar code bases:\nA GraphQL schema and TypeScript type definitions.\nBoth are essentially the same, and if so, why do we even need to maintain 2 code bases?\nIsn't there a tool which does that for us? A question which brings us straight to the point of the chapter.\n\n**Introducing: GraphQL Code Generator**\n\nWith [GraphQL Code Generator](https://graphql-code-generator.com/) we can generate TypeScript definitions given a GraphQL schema, and a set of GraphQL documents if they are presented to us.\n\n\n\n![graphql-codegen](https://user-images.githubusercontent.com/7648874/54940897-9f564380-4f66-11e9-9891-3b994a1daef1.png)\n\n\nGraphQL Code Generator is a simple CLI tool that operates based on a configuration file and can generate TypeScript types for both Client and Server.\nWe will start with generating types for the server.\n\nIn the server project, install GraphQL Code Generator via Yarn\n\n    $ yarn add @graphql-codegen/cli --dev\n\nNow GraphQL Code Generator can be used directly from the `scripts` section in the `package.json` file using the `gql-gen` binary.\nWe're gonna call the code generation script \"codegen\":\n\n```json\n{\n  \"codegen\": \"gql-gen\"\n}\n```\n\nThis command will automatically be referenced to a configuration file in the root of our project called `codegen.yml`.\nThe essence of this file is to provide the code generator with the GraphQL schema, GraphQL documents, the output path of the type definition file/s and a set of plug-ins.\nMore about the configuration file can be found in the [official website](https://graphql-code-generator.com/docs/getting-started/codegen-config).\n\nIn the server project, we will generate the `types/graphql.d.ts` file and we will use a couple of plug-ins to do that:\n\n\n\n*   `@graphql-codegen/typescript` - Will generate the core TypeScript types from our GraphQL schema.\n*   `@graphql-codegen/typescript-resolvers` - Will generate resolvers signatures with the generated TypeScript types.\n\n> A full list of available plugins is available [here](https://graphql-code-generator.com/docs/plugins/). In addition, you can write your own [custom plugin](https://graphql-code-generator.com/docs/custom-codegen/write-your-plugin).\n\nLet's install these 2 plugins:\n\n    $ yarn add @graphql-codegen/typescript @graphql-codegen/typescript-resolvers --dev\n\nAnd write the `codegen.yml` file:\n\n[{]: <helper> (diffStep 6.1 files=\"codegen.yml\" module=\"server\")\n\n#### [__Server__ Step 6.1: Setup GraphQL Code Generator](https://github.com/Urigo/WhatsApp-Clone-Server/commit/f52e6b4d181f49258c825cc9364755499c06c070)\n\n##### Added codegen.yml\n```diff\n@@ -0,0 +1,16 @@\n+â”Š  â”Š 1â”Šschema: ./schema/typeDefs.graphql\n+â”Š  â”Š 2â”Šoverwrite: true\n+â”Š  â”Š 3â”Šgenerates:\n+â”Š  â”Š 4â”Š  ./types/graphql.d.ts:\n+â”Š  â”Š 5â”Š    plugins:\n+â”Š  â”Š 6â”Š      - typescript\n+â”Š  â”Š 7â”Š      - typescript-resolvers\n+â”Š  â”Š 8â”Š    config:\n+â”Š  â”Š 9â”Š      mappers:\n+â”Š  â”Š10â”Š        # import { Message } from '../db'\n+â”Š  â”Š11â”Š        # The root types of Message resolvers\n+â”Š  â”Š12â”Š        Message: ../db#Message\n+â”Š  â”Š13â”Š        Chat: ../db#Chat\n+â”Š  â”Š14â”Š      scalars:\n+â”Š  â”Š15â”Š        # e.g. Message.createdAt will be of type Date\n+â”Š  â”Š16â”Š        Date: Date\n```\n\n[}]: #\n\n> See inline comments to learn more about our configuration setup.\n\nNow if you'll run `$ npm run codegen` you should see that a new file `types/graphql.d.ts` has been generated with all the necessary TypeScript types. Since these types are very likely to change as we extend our schema, there's no need to include them in our project, thus it's recommended to add the appropriate .gitignore rule:\n\n[{]: <helper> (diffStep 6.1 files=\".gitignore\" module=\"server\")\n\n#### [__Server__ Step 6.1: Setup GraphQL Code Generator](https://github.com/Urigo/WhatsApp-Clone-Server/commit/f52e6b4d181f49258c825cc9364755499c06c070)\n\n##### Changed .gitignore\n```diff\n@@ -1,3 +1,4 @@\n â”Š1â”Š1â”Šnode_modules\n â”Š2â”Š2â”Šnpm-debug.log\n-â”Š3â”Š â”Štest-results/ðŸš«â†µ\n+â”Š â”Š3â”Štest-results/\n+â”Š â”Š4â”Štypes/graphql.d.tsðŸš«â†µ\n```\n\n[}]: #\n\nNow to make sure we always get the updated types, let's add a task that would run automatically before we start the server.\n`prestart` is a saved word that means that when we run `yarn start` it will run that task automatically before running the script in `start`:\n\n[{]: <helper> (diffStep 6.1 files=\"package.json\" module=\"server\")\n\n#### [__Server__ Step 6.1: Setup GraphQL Code Generator](https://github.com/Urigo/WhatsApp-Clone-Server/commit/f52e6b4d181f49258c825cc9364755499c06c070)\n\n##### Changed package.json\n```diff\n@@ -7,14 +7,19 @@\n â”Š 7â”Š 7â”Š  },\n â”Š 8â”Š 8â”Š  \"private\": true,\n â”Š 9â”Š 9â”Š  \"scripts\": {\n+â”Š  â”Š10â”Š    \"prestart\": \"yarn codegen\",\n â”Š10â”Š11â”Š    \"start\": \"ts-node index.ts\",\n â”Š11â”Š12â”Š    \"test\": \"TZ=\\\"Asia/Jerusalem\\\" jest\",\n+â”Š  â”Š13â”Š    \"codegen\": \"gql-gen\",\n â”Š12â”Š14â”Š    \"format\": \"prettier \\\"**/*.ts\\\" --write\"\n â”Š13â”Š15â”Š  },\n â”Š14â”Š16â”Š  \"jest-junit\": {\n â”Š15â”Š17â”Š    \"outputDirectory\": \"./test-results\"\n â”Š16â”Š18â”Š  },\n â”Š17â”Š19â”Š  \"devDependencies\": {\n+â”Š  â”Š20â”Š    \"@graphql-codegen/cli\": \"1.5.0\",\n+â”Š  â”Š21â”Š    \"@graphql-codegen/typescript\": \"1.5.0\",\n+â”Š  â”Š22â”Š    \"@graphql-codegen/typescript-resolvers\": \"1.5.0\",\n â”Š18â”Š23â”Š    \"@types/cors\": \"2.8.5\",\n â”Š19â”Š24â”Š    \"@types/express\": \"4.17.0\",\n â”Š20â”Š25â”Š    \"@types/graphql\": \"14.2.3\",\n```\n\n[}]: #\n\nNow we can import the `IResolvers` type from the file we've just created and use it in the `resolvers.ts` file to ensure our resolvers handlers have the right signature:\n\n[{]: <helper> (diffStep 6.2 module=\"server\")\n\n#### [__Server__ Step 6.2: Type resolvers](https://github.com/Urigo/WhatsApp-Clone-Server/commit/5948f6267a9648e21efbe5d05cb14b3cae9cbea1)\n\n##### Changed schema&#x2F;index.ts\n```diff\n@@ -1,7 +1,10 @@\n â”Š 1â”Š 1â”Šimport { importSchema } from 'graphql-import';\n-â”Š 2â”Š  â”Šimport { makeExecutableSchema } from 'graphql-tools';\n+â”Š  â”Š 2â”Šimport { makeExecutableSchema, IResolvers } from 'graphql-tools';\n â”Š 3â”Š 3â”Šimport resolvers from './resolvers';\n â”Š 4â”Š 4â”Š\n â”Š 5â”Š 5â”Šconst typeDefs = importSchema('schema/typeDefs.graphql');\n â”Š 6â”Š 6â”Š\n-â”Š 7â”Š  â”Šexport default makeExecutableSchema({ resolvers, typeDefs });\n+â”Š  â”Š 7â”Šexport default makeExecutableSchema({\n+â”Š  â”Š 8â”Š  resolvers: resolvers as IResolvers,\n+â”Š  â”Š 9â”Š  typeDefs,\n+â”Š  â”Š10â”Š});\n```\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,18 +1,19 @@\n â”Š 1â”Š 1â”Šimport { GraphQLDateTime } from 'graphql-iso-date';\n-â”Š 2â”Š  â”Šimport { chats, messages } from '../db';\n+â”Š  â”Š 2â”Šimport { Message, chats, messages } from '../db';\n+â”Š  â”Š 3â”Šimport { Resolvers } from '../types/graphql';\n â”Š 3â”Š 4â”Š\n-â”Š 4â”Š  â”Šconst resolvers = {\n+â”Š  â”Š 5â”Šconst resolvers: Resolvers = {\n â”Š 5â”Š 6â”Š  Date: GraphQLDateTime,\n â”Š 6â”Š 7â”Š\n â”Š 7â”Š 8â”Š  Chat: {\n-â”Š 8â”Š  â”Š    messages(chat: any) {\n+â”Š  â”Š 9â”Š    messages(chat) {\n â”Š 9â”Š10â”Š      return messages.filter(m => chat.messages.includes(m.id));\n â”Š10â”Š11â”Š    },\n â”Š11â”Š12â”Š\n-â”Š12â”Š  â”Š    lastMessage(chat: any) {\n+â”Š  â”Š13â”Š    lastMessage(chat) {\n â”Š13â”Š14â”Š      const lastMessage = chat.messages[chat.messages.length - 1];\n â”Š14â”Š15â”Š\n-â”Š15â”Š  â”Š      return messages.find(m => m.id === lastMessage);\n+â”Š  â”Š16â”Š      return messages.find(m => m.id === lastMessage) || null;\n â”Š16â”Š17â”Š    },\n â”Š17â”Š18â”Š  },\n â”Š18â”Š19â”Š\n```\n```diff\n@@ -21,13 +22,13 @@\n â”Š21â”Š22â”Š      return chats;\n â”Š22â”Š23â”Š    },\n â”Š23â”Š24â”Š\n-â”Š24â”Š  â”Š    chat(root: any, { chatId }: any) {\n-â”Š25â”Š  â”Š      return chats.find(c => c.id === chatId);\n+â”Š  â”Š25â”Š    chat(root, { chatId }) {\n+â”Š  â”Š26â”Š      return chats.find(c => c.id === chatId) || null;\n â”Š26â”Š27â”Š    },\n â”Š27â”Š28â”Š  },\n â”Š28â”Š29â”Š\n â”Š29â”Š30â”Š  Mutation: {\n-â”Š30â”Š  â”Š    addMessage(root: any, { chatId, content }: any) {\n+â”Š  â”Š31â”Š    addMessage(root, { chatId, content }) {\n â”Š31â”Š32â”Š      const chatIndex = chats.findIndex(c => c.id === chatId);\n â”Š32â”Š33â”Š\n â”Š33â”Š34â”Š      if (chatIndex === -1) return null;\n```\n```diff\n@@ -36,7 +37,7 @@\n â”Š36â”Š37â”Š\n â”Š37â”Š38â”Š      const messagesIds = messages.map(currentMessage => Number(currentMessage.id));\n â”Š38â”Š39â”Š      const messageId = String(Math.max(...messagesIds) + 1);\n-â”Š39â”Š  â”Š      const message = {\n+â”Š  â”Š40â”Š      const message: Message = {\n â”Š40â”Š41â”Š        id: messageId,\n â”Š41â”Š42â”Š        createdAt: new Date(),\n â”Š42â”Š43â”Š        content,\n```\n\n[}]: #\n\nWe will now repeat the same process in the client with few tweaks. Again, we will install GraphQL Code Generator:\n\n    $ yarn add @graphql-codegen/cli --dev\n\nAnd we will define a script:\n\n```json\n{\n  \"codegen\": \"gql-gen\"\n}\n```\n\nThis time around, because we're in the client, we will define a set of glob paths that will specify which files contain GraphQL documents.\nGraphQL Code Generator is smart enough to automatically recognize the documents within these files by looking at the `gql` template literal calls using the `typescript-operations` package.\nWe will be using a plugin called `typescript-react-apollo` to generate React/Apollo-GraphQL hooks that can be used in our function components.\nLet's install the necessary plugins:\n\n    $ yarn add @graphql-codegen/cli @graphql-codegen/typescript @graphql-codegen/typescript-operations @graphql-codegen/typescript-react-apollo @graphql-codegen/add\n\n\nAnd we will write the `codegen.yml` file:\n\n[{]: <helper> (diffStep 9.1 files=\"codegen.yml\" module=\"client\")\n\n#### [__Client__ Step 9.1: Setup GraphQL Code Generator](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/14ea541ad005a1b3c35350fe587cb94f80151e44)\n\n##### Added codegen.yml\n```diff\n@@ -0,0 +1,20 @@\n+â”Š  â”Š 1â”Šschema: ../WhatsApp-Clone-Server/schema/typeDefs.graphql\n+â”Š  â”Š 2â”Šdocuments:\n+â”Š  â”Š 3â”Š  - ./src/components/**/*.tsx\n+â”Š  â”Š 4â”Š  - ./src/graphql/fragments/**/*.ts\n+â”Š  â”Š 5â”Š  - ./src/graphql/queries/**/*.ts\n+â”Š  â”Š 6â”Šoverwrite: true\n+â”Š  â”Š 7â”Šgenerates:\n+â”Š  â”Š 8â”Š  ./src/graphql/types.tsx:\n+â”Š  â”Š 9â”Š    plugins:\n+â”Š  â”Š10â”Š      - add: '/* eslint-disable */'\n+â”Š  â”Š11â”Š      - typescript\n+â”Š  â”Š12â”Š      - typescript-operations\n+â”Š  â”Š13â”Š      - typescript-react-apollo\n+â”Š  â”Š14â”Š    # The combined options of all provided plug-ins\n+â”Š  â”Š15â”Š    # More information about the options below:\n+â”Š  â”Š16â”Š    # graphql-code-generator.com/docs/plugins/typescript-react-apollo#configuration\n+â”Š  â”Š17â”Š    config:\n+â”Š  â”Š18â”Š      withHOC: false\n+â”Š  â”Š19â”Š      withHooks: true\n+â”Š  â”Š20â”Š      withComponent: false\n```\n\n[}]: #\n\nNotice that we sent the schema as a local path.\nWe could have also provided a GraphQL endpoint that exposes a GraphQL schema.\nThis way if there's an existing running GraphQL API, we can generate TypeScript types out of it, such as GitHub's GraphQL API.\nThe advantages of providing a local path is that the server doesn't have to be running in order to generate types, which is more comfortable in development, and we can bypass authentication if the endpoint is guarded with such mechanism.\nThis will be useful in further chapters when we're introduced to the concept of authentication.\n\nBe sure to add a .gitignore rule because we want to run the generator every time there is a change and don't want to rely on old generated types:\n\n[{]: <helper> (diffStep 9.1 files=\".gitignore\" module=\"client\")\n\n#### [__Client__ Step 9.1: Setup GraphQL Code Generator](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/14ea541ad005a1b3c35350fe587cb94f80151e44)\n\n##### Changed .gitignore\n```diff\n@@ -21,3 +21,5 @@\n â”Š21â”Š21â”Šnpm-debug.log*\n â”Š22â”Š22â”Šyarn-debug.log*\n â”Š23â”Š23â”Šyarn-error.log*\n+â”Š  â”Š24â”Š\n+â”Š  â”Š25â”Šsrc/graphql/types.tsx\n```\n\n[}]: #\n\nNow we have TypeScript types available to us and we can replace `useQuery()` and `useMutation()` calls with the generated React hooks.\nLet's use those and also remove all the old manual typings:\n\n[{]: <helper> (diffStep 9.2 module=\"client\")\n\n#### [__Client__ Step 9.2: Use GraphQL Codegen hooks](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/233a17fb351e4d97281f6dc0c508254374214593)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;ChatNavbar.tsx\n```diff\n@@ -5,7 +5,6 @@\n â”Š 5â”Š 5â”Šimport { useCallback } from 'react';\n â”Š 6â”Š 6â”Šimport styled from 'styled-components';\n â”Š 7â”Š 7â”Šimport { History } from 'history';\n-â”Š 8â”Š  â”Šimport { ChatQueryResult } from './index';\n â”Š 9â”Š 8â”Š\n â”Š10â”Š 9â”Šconst Container = styled(Toolbar)`\n â”Š11â”Š10â”Š  padding: 0;\n```\n```diff\n@@ -37,7 +36,10 @@\n â”Š37â”Š36â”Š\n â”Š38â”Š37â”Šinterface ChatNavbarProps {\n â”Š39â”Š38â”Š  history: History;\n-â”Š40â”Š  â”Š  chat: ChatQueryResult;\n+â”Š  â”Š39â”Š  chat?: {\n+â”Š  â”Š40â”Š    picture?: string | null;\n+â”Š  â”Š41â”Š    name?: string | null;\n+â”Š  â”Š42â”Š  };\n â”Š41â”Š43â”Š}\n â”Š42â”Š44â”Š\n â”Š43â”Š45â”Šconst ChatNavbar: React.FC<ChatNavbarProps> = ({ chat, history }) => {\n```\n```diff\n@@ -50,8 +52,12 @@\n â”Š50â”Š52â”Š      <BackButton data-testid=\"back-button\" onClick={navBack}>\n â”Š51â”Š53â”Š        <ArrowBackIcon />\n â”Š52â”Š54â”Š      </BackButton>\n-â”Š53â”Š  â”Š      <Picture data-testid=\"chat-picture\" src={chat.picture} />\n-â”Š54â”Š  â”Š      <Name data-testid=\"chat-name\">{chat.name}</Name>\n+â”Š  â”Š55â”Š      {chat && chat.picture && chat.name && (\n+â”Š  â”Š56â”Š        <React.Fragment>\n+â”Š  â”Š57â”Š          <Picture data-testid=\"chat-picture\" src={chat.picture} />\n+â”Š  â”Š58â”Š          <Name data-testid=\"chat-name\">{chat.name}</Name>\n+â”Š  â”Š59â”Š        </React.Fragment>\n+â”Š  â”Š60â”Š      )}\n â”Š55â”Š61â”Š    </Container>\n â”Š56â”Š62â”Š  );\n â”Š57â”Š63â”Š};\n```\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;MessagesList.tsx\n```diff\n@@ -3,7 +3,6 @@\n â”Š3â”Š3â”Šimport { useEffect, useRef } from 'react';\n â”Š4â”Š4â”Šimport ReactDOM from 'react-dom';\n â”Š5â”Š5â”Šimport styled from 'styled-components';\n-â”Š6â”Š â”Šimport { ChatQueryMessage } from './index';\n â”Š7â”Š6â”Š\n â”Š8â”Š7â”Šconst Container = styled.div`\n â”Š9â”Š8â”Š  display: block;\n```\n```diff\n@@ -62,8 +61,13 @@\n â”Š62â”Š61â”Š  font-size: 12px;\n â”Š63â”Š62â”Š`;\n â”Š64â”Š63â”Š\n+â”Š  â”Š64â”Šinterface Message {\n+â”Š  â”Š65â”Š  id: string | null;\n+â”Š  â”Š66â”Š  content: string | null;\n+â”Š  â”Š67â”Š  createdAt: string | null;\n+â”Š  â”Š68â”Š}\n â”Š65â”Š69â”Šinterface MessagesListProps {\n-â”Š66â”Š  â”Š  messages: Array<ChatQueryMessage>;\n+â”Š  â”Š70â”Š  messages: Array<Message>;\n â”Š67â”Š71â”Š}\n â”Š68â”Š72â”Š\n â”Š69â”Š73â”Šconst MessagesList: React.FC<MessagesListProps> = ({ messages }) => {\n```\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -2,12 +2,12 @@\n â”Š 2â”Š 2â”Šimport gql from 'graphql-tag';\n â”Š 3â”Š 3â”Šimport React from 'react';\n â”Š 4â”Š 4â”Šimport { useCallback } from 'react';\n-â”Š 5â”Š  â”Šimport { useQuery, useMutation } from '@apollo/react-hooks';\n â”Š 6â”Š 5â”Šimport styled from 'styled-components';\n â”Š 7â”Š 6â”Šimport ChatNavbar from './ChatNavbar';\n â”Š 8â”Š 7â”Šimport MessageInput from './MessageInput';\n â”Š 9â”Š 8â”Šimport MessagesList from './MessagesList';\n â”Š10â”Š 9â”Šimport { History } from 'history';\n+â”Š  â”Š10â”Šimport { ChatsQuery, useGetChatQuery, useAddMessageMutation } from '../../graphql/types';\n â”Š11â”Š11â”Šimport * as queries from '../../graphql/queries';\n â”Š12â”Š12â”Šimport * as fragments from '../../graphql/fragments';\n â”Š13â”Š13â”Š\n```\n```diff\n@@ -18,6 +18,7 @@\n â”Š18â”Š18â”Š  height: 100vh;\n â”Š19â”Š19â”Š`;\n â”Š20â”Š20â”Š\n+â”Š  â”Š21â”Š// eslint-disable-next-line\n â”Š21â”Š22â”Šconst getChatQuery = gql`\n â”Š22â”Š23â”Š  query GetChat($chatId: ID!) {\n â”Š23â”Š24â”Š    chat(chatId: $chatId) {\n```\n```diff\n@@ -27,6 +28,7 @@\n â”Š27â”Š28â”Š  ${fragments.fullChat}\n â”Š28â”Š29â”Š`;\n â”Š29â”Š30â”Š\n+â”Š  â”Š31â”Š// eslint-disable-next-line\n â”Š30â”Š32â”Šconst addMessageMutation = gql`\n â”Š31â”Š33â”Š  mutation AddMessage($chatId: ID!, $content: String!) {\n â”Š32â”Š34â”Š    addMessage(chatId: $chatId, content: $content) {\n```\n```diff\n@@ -41,21 +43,6 @@\n â”Š41â”Š43â”Š  history: History;\n â”Š42â”Š44â”Š}\n â”Š43â”Š45â”Š\n-â”Š44â”Š  â”Šexport interface ChatQueryMessage {\n-â”Š45â”Š  â”Š  id: string;\n-â”Š46â”Š  â”Š  content: string;\n-â”Š47â”Š  â”Š  createdAt: Date;\n-â”Š48â”Š  â”Š}\n-â”Š49â”Š  â”Š\n-â”Š50â”Š  â”Šexport interface ChatQueryResult {\n-â”Š51â”Š  â”Š  id: string;\n-â”Š52â”Š  â”Š  name: string;\n-â”Š53â”Š  â”Š  picture: string;\n-â”Š54â”Š  â”Š  messages: Array<ChatQueryMessage>;\n-â”Š55â”Š  â”Š}\n-â”Š56â”Š  â”Š\n-â”Š57â”Š  â”Štype OptionalChatQueryResult = ChatQueryResult | null;\n-â”Š58â”Š  â”Š\n â”Š59â”Š46â”Šinterface ChatsResult {\n â”Š60â”Š47â”Š  chats: any[];\n â”Š61â”Š48â”Š}\n```\n```diff\n@@ -64,15 +51,20 @@\n â”Š64â”Š51â”Š  history,\n â”Š65â”Š52â”Š  chatId,\n â”Š66â”Š53â”Š}) => {\n-â”Š67â”Š  â”Š  const {\n-â”Š68â”Š  â”Š    data: { chat },\n-â”Š69â”Š  â”Š  } = useQuery<any>(getChatQuery, {\n+â”Š  â”Š54â”Š  const { data, loading } = useGetChatQuery({\n â”Š70â”Š55â”Š    variables: { chatId },\n â”Š71â”Š56â”Š  });\n-â”Š72â”Š  â”Š  const [addMessage] = useMutation(addMessageMutation);\n+â”Š  â”Š57â”Š\n+â”Š  â”Š58â”Šconst [addMessage] = useAddMessageMutation();\n â”Š73â”Š59â”Š\n â”Š74â”Š60â”Š  const onSendMessage = useCallback(\n â”Š75â”Š61â”Š    (content: string) => {\n+â”Š  â”Š62â”Š      if (data === undefined) {\n+â”Š  â”Š63â”Š        return null;\n+â”Š  â”Š64â”Š      }\n+â”Š  â”Š65â”Š      const chat = data.chat;\n+â”Š  â”Š66â”Š      if (chat === null) return null;\n+â”Š  â”Š67â”Š\n â”Š76â”Š68â”Š      addMessage({\n â”Š77â”Š69â”Š        variables: { chatId, content },\n â”Š78â”Š70â”Š        optimisticResponse: {\n```\n```diff\n@@ -89,12 +81,12 @@\n â”Š 89â”Š 81â”Š        update: (client, { data: { addMessage } }) => {\n â”Š 90â”Š 82â”Š          type FullChat = { [key: string]: any };\n â”Š 91â”Š 83â”Š          let fullChat;\n+â”Š   â”Š 84â”Š\n â”Š 92â”Š 85â”Š          const chatIdFromStore = defaultDataIdFromObject(chat);\n â”Š 93â”Š 86â”Š\n â”Š 94â”Š 87â”Š          if (chatIdFromStore === null) {\n â”Š 95â”Š 88â”Š            return;\n â”Š 96â”Š 89â”Š          }\n-â”Š 97â”Š   â”Š\n â”Š 98â”Š 90â”Š          try {\n â”Š 99â”Š 91â”Š            fullChat = client.readFragment<FullChat>({\n â”Š100â”Š 92â”Š              id: chatIdFromStore,\n```\n```diff\n@@ -105,11 +97,10 @@\n â”Š105â”Š 97â”Š            return;\n â”Š106â”Š 98â”Š          }\n â”Š107â”Š 99â”Š\n-â”Š108â”Š   â”Š          if (fullChat === null) {\n+â”Š   â”Š100â”Š          if (fullChat === null || fullChat.messages === null) {\n â”Š109â”Š101â”Š            return;\n â”Š110â”Š102â”Š          }\n-â”Š111â”Š   â”Š          if (fullChat.messages.some((m: any) => m.id === addMessage.id))\n-â”Š112â”Š   â”Š            return;\n+â”Š   â”Š103â”Š          if (fullChat.messages.some((currentMessage: any) => currentMessage.id === addMessage.id)) return;\n â”Š113â”Š104â”Š\n â”Š114â”Š105â”Š          fullChat.messages.push(addMessage);\n â”Š115â”Š106â”Š          fullChat.lastMessage = addMessage;\n```\n```diff\n@@ -121,24 +112,24 @@\n â”Š121â”Š112â”Š            data: fullChat,\n â”Š122â”Š113â”Š          });\n â”Š123â”Š114â”Š\n-â”Š124â”Š   â”Š          let data;\n+â”Š   â”Š115â”Š          let data: ChatsQuery | null;\n â”Š125â”Š116â”Š          try {\n-â”Š126â”Š   â”Š            data = client.readQuery<ChatsResult>({\n+â”Š   â”Š117â”Š            data = client.readQuery({\n â”Š127â”Š118â”Š              query: queries.chats,\n â”Š128â”Š119â”Š            });\n â”Š129â”Š120â”Š          } catch (e) {\n â”Š130â”Š121â”Š            return;\n â”Š131â”Š122â”Š          }\n â”Š132â”Š123â”Š\n-â”Š133â”Š   â”Š          if (!data || data === null) {\n-â”Š134â”Š   â”Š            return null;\n-â”Š135â”Š   â”Š          }\n-â”Š136â”Š   â”Š          if (!data.chats || data.chats === undefined) {\n+â”Š   â”Š124â”Š          if (!data || !data.chats) {\n â”Š137â”Š125â”Š            return null;\n â”Š138â”Š126â”Š          }\n â”Š139â”Š127â”Š          const chats = data.chats;\n â”Š140â”Š128â”Š\n-â”Š141â”Š   â”Š          const chatIndex = chats.findIndex((c: any) => c.id === chatId);\n+â”Š   â”Š129â”Š          const chatIndex = chats.findIndex((c: any) => {\n+â”Š   â”Š130â”Š            if (addMessage === null || addMessage.chat === null) return -1;\n+â”Š   â”Š131â”Š            return c.id === addMessage.chat.id;\n+â”Š   â”Š132â”Š          });\n â”Š142â”Š133â”Š          if (chatIndex === -1) return;\n â”Š143â”Š134â”Š          const chatWhereAdded = chats[chatIndex];\n â”Š144â”Š135â”Š\n```\n```diff\n@@ -153,10 +144,17 @@\n â”Š153â”Š144â”Š        },\n â”Š154â”Š145â”Š      });\n â”Š155â”Š146â”Š    },\n-â”Š156â”Š   â”Š    [chat, chatId, addMessage]\n+â”Š   â”Š147â”Š    [data, chatId, addMessage]\n â”Š157â”Š148â”Š  );\n â”Š158â”Š149â”Š\n-â”Š159â”Š   â”Š  if (!chat) return null;\n+â”Š   â”Š150â”Š  if (data === undefined) {\n+â”Š   â”Š151â”Š    return null;\n+â”Š   â”Š152â”Š  }\n+â”Š   â”Š153â”Š  const chat = data.chat;\n+â”Š   â”Š154â”Š  const loadingChat = loading;\n+â”Š   â”Š155â”Š\n+â”Š   â”Š156â”Š  if (loadingChat) return null;\n+â”Š   â”Š157â”Š  if (chat === null) return null;\n â”Š160â”Š158â”Š\n â”Š161â”Š159â”Š  return (\n â”Š162â”Š160â”Š    <Container>\n```\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -4,8 +4,7 @@\n â”Š 4â”Š 4â”Šimport styled from 'styled-components';\n â”Š 5â”Š 5â”Šimport { useCallback } from 'react';\n â”Š 6â”Š 6â”Šimport { History } from 'history';\n-â”Š 7â”Š  â”Šimport { useQuery } from '@apollo/react-hooks';\n-â”Š 8â”Š  â”Šimport * as queries from '../../graphql/queries';\n+â”Š  â”Š 7â”Šimport { useChatsQuery } from '../../graphql/types';\n â”Š 9â”Š 8â”Š\n â”Š10â”Š 9â”Šconst Container = styled.div`\n â”Š11â”Š10â”Š  height: calc(100% - 56px);\n```\n```diff\n@@ -64,8 +63,6 @@\n â”Š64â”Š63â”Š}\n â”Š65â”Š64â”Š\n â”Š66â”Š65â”Šconst ChatsList: React.FC<ChatsListProps> = ({ history }) => {\n-â”Š67â”Š  â”Š  const { data } = useQuery<any>(queries.chats);\n-â”Š68â”Š  â”Š\n â”Š69â”Š66â”Š  const navToChat = useCallback(\n â”Š70â”Š67â”Š    chat => {\n â”Š71â”Š68â”Š      history.push(`chats/${chat.id}`);\n```\n```diff\n@@ -73,6 +70,8 @@\n â”Š73â”Š70â”Š    [history]\n â”Š74â”Š71â”Š  );\n â”Š75â”Š72â”Š\n+â”Š  â”Š73â”Š  const { data } = useChatsQuery();\n+â”Š  â”Š74â”Š\n â”Š76â”Š75â”Š  if (data === undefined || data.chats === undefined) {\n â”Š77â”Š76â”Š    return null;\n â”Š78â”Š77â”Š  }\n```\n\n[}]: #\n\nTo test if things are working properly, we can address a non existing field in one of the retrieved query results, for example `chat.foo` in `useGetChatQuery()`.\nWe should receive the following typing error when trying to run the project:\n\n```\nTypeScript error: Property 'foo' does not exist on type '{ __typename?: \"Chat\"; } & { __typename?: \"Chat\"; } & { messages: ({ __typename?: \"Message\"; } & { __typename?: \"Message\"; } & Pick<Message, \"id\" | \"createdAt\" | \"content\">)[]; } & { __typename?: \"Chat\"; } & Pick<...> & { ...; }'.  TS2339\n\n    44 |   const addMessage = useAddMessageMutation()\n    45 |\n  > 46 |   console.log(chat.foo)\n       |                    ^\n    47 |\n    48 |   const onSendMessage = useCallback((content) => {\n    49 |     addMessage({\n```\n\nTODO: Mappers are not explained - The root types of Message resolvers - doesnâ€™t say much\nwe donâ€™t need to use `resolvers as IResolvers`, thereâ€™s a flag for it, in codegen\n\nTODO: Change `gql-gen` to `graphql-codegen`"
          },
          {
            "manualTitle": "Step 10: Live updates with GraphQL subscriptions",
            "stepRevision": "9ad0285a476322aa5334d9f21afba476c5d4e6f4",
            "manualView": "So far we've been developing the app and we've been treating it as if there's no other users; we're the only one exists.\nThis approach is true when we want to develop a UI and focus on UX, but comes a point where we need to start thinking on a macro level.\nOur app is social interactive, and if things work properly for me, it doesn't mean that it works properly to the fellow I'm chatting with.\nIt's inevitable to have an authentication system in our app, hence we need to take care of things before we get to that stage.\n\nTry to open 2 instances of the app in 2 separate tabs/windows, and navigate into the same chat room.\nTry to send a message with one instance and notice that the second instance doesn't update unless we refresh the page.\n\n\n![ezgif com-video-to-gif (2)](https://user-images.githubusercontent.com/7648874/55079371-fbd87080-50d6-11e9-8ade-5ffeed6eaf8d.gif)\n\n\nThis issue is very important and should be addressed, because a chat is all about sending and receiving messages on a lively basis.\nThis issue was expected, as there's no mechanism that would trigger and listen to changes in the back-end.\nIn this chapter we're gonna address that issue by implementing exactly that mechanism.\n\n**Introducing: GraphQL Subscriptions**\n\n[GraphQL subscriptions](https://github.com/apollographql/graphql-subscriptions) is a mechanism that works on [web-sockets](https://en.wikipedia.org/wiki/WebSocket) and live communication; clients can subscribe to it and be notified regards specific changes that happen in the back-end. Notifications will be triggered manually by us and can be provided with parameters that provide additional information regards the triggered event. For example, a `messageAdded` will be published with the new message, and will notify all clients who are subscribed to that event. Once the subscribers are notified, they can respond as they would like to, such as updating the UI.\n\n\n\n![subscription-notifications](https://user-images.githubusercontent.com/7648874/55079462-30e4c300-50d7-11e9-8399-7706da2a9cff.png)\n\n\nA subscription is presented in our GraphQL schema as a separate type called `Subscription`, where each field represents an event name along with its return type.\nLike any other GraphQL type, each field should be match with a resolver where we handle the request.\n\nIn this chapter we will implement the `messageAdded` subscription, so users can be notified when it happens and update the messages list to contain the new message.\n\n**Implementing a subscription**\n\nWe will start by creating a new `Subscription` type in our GraphQL schema with the field `messageAdded`:\n\n[{]: <helper> (diffStep 7.1 module=\"server\")\n\n#### [__Server__ Step 7.1: Add subscription type with messageAdded](https://github.com/Urigo/WhatsApp-Clone-Server/commit/9c7459a9e7731eb2b2622d75969f51f08bce00b6)\n\n##### Changed schema&#x2F;typeDefs.graphql\n```diff\n@@ -22,3 +22,7 @@\n â”Š22â”Š22â”Štype Mutation {\n â”Š23â”Š23â”Š  addMessage(chatId: ID!, content: String!): Message\n â”Š24â”Š24â”Š}\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Štype Subscription {\n+â”Š  â”Š27â”Š  messageAdded: Message!\n+â”Š  â”Š28â”Š}\n```\n\n[}]: #\n\nChanges are triggered using an event-emitter like object called `PubSub`. This can be done using the `PubSub.prototype.publish` method. We will create a new instance of it and will provide it via the [context](https://www.apollographql.com/docs/apollo-server/essentials/data#context) - a common pattern for providing objects which are useful for the execution of the resolvers:\n\nTODO: Explain what the context is\n\n[{]: <helper> (diffStep 7.2 module=\"server\")\n\n#### [__Server__ Step 7.2: Provide a new instance of PubSub to context](https://github.com/Urigo/WhatsApp-Clone-Server/commit/88dee11c329eaae4fe1ab5d8d14ac78fcf487512)\n\n##### Changed index.ts\n```diff\n@@ -1,4 +1,4 @@\n-â”Š1â”Š â”Šimport { ApolloServer, gql } from 'apollo-server-express';\n+â”Š â”Š1â”Šimport { ApolloServer, gql, PubSub } from 'apollo-server-express';\n â”Š2â”Š2â”Šimport cors from 'cors';\n â”Š3â”Š3â”Šimport express from 'express';\n â”Š4â”Š4â”Šimport schema from './schema';\n```\n```diff\n@@ -12,7 +12,11 @@\n â”Š12â”Š12â”Š  res.send('pong');\n â”Š13â”Š13â”Š});\n â”Š14â”Š14â”Š\n-â”Š15â”Š  â”Šconst server = new ApolloServer({ schema });\n+â”Š  â”Š15â”Šconst pubsub = new PubSub();\n+â”Š  â”Š16â”Šconst server = new ApolloServer({\n+â”Š  â”Š17â”Š  schema,\n+â”Š  â”Š18â”Š  context: () => ({ pubsub }),\n+â”Š  â”Š19â”Š});\n â”Š16â”Š20â”Š\n â”Š17â”Š21â”Šserver.applyMiddleware({\n â”Š18â”Š22â”Š  app,\n```\n\n[}]: #\n\nInside the `addMessage` resolver we will publish a new event called `messageAdded`. The 3rd argument of the resolver will be the context object that we've just defined in the previous step, where we can use the pubsub instance. The TypeScript type of our context can be directly defined and generated by CodeGen through the `codegen.yml` file. This can be specified under the `ContextType` field with the file path that contains the context followed by the name of the exported object, like so:\n\n[{]: <helper> (diffStep 7.3 module=\"server\")\n\n#### [__Server__ Step 7.3: Define Context type](https://github.com/Urigo/WhatsApp-Clone-Server/commit/e3ff9c62759e42549e16e5fb37efb25b6a6292ef)\n\n##### Changed codegen.yml\n```diff\n@@ -6,6 +6,7 @@\n â”Š 6â”Š 6â”Š      - typescript\n â”Š 7â”Š 7â”Š      - typescript-resolvers\n â”Š 8â”Š 8â”Š    config:\n+â”Š  â”Š 9â”Š      contextType: ../context#MyContext\n â”Š 9â”Š10â”Š      mappers:\n â”Š10â”Š11â”Š        # import { Message } from '../db'\n â”Š11â”Š12â”Š        # The root types of Message resolvers\n```\n\n##### Added context.ts\n```diff\n@@ -0,0 +1,5 @@\n+â”Š â”Š1â”Šimport { PubSub } from 'apollo-server-express';\n+â”Š â”Š2â”Š\n+â”Š â”Š3â”Šexport type MyContext = {\n+â”Š â”Š4â”Š  pubsub: PubSub;\n+â”Š â”Š5â”Š};\n```\n\n[}]: #\n\nThe event will be published right after the message was pushed into the messages collection, because order is a crucial thing. We don't want to notify our users unless the change has been made. The event will have a single parameter which represents the new message.\n\n[{]: <helper> (diffStep 7.4 module=\"server\")\n\n#### [__Server__ Step 7.4: Publish message added event](https://github.com/Urigo/WhatsApp-Clone-Server/commit/0af76ec2af552c66deda78f6f832e5ae857b6491)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -28,7 +28,7 @@\n â”Š28â”Š28â”Š  },\n â”Š29â”Š29â”Š\n â”Š30â”Š30â”Š  Mutation: {\n-â”Š31â”Š  â”Š    addMessage(root, { chatId, content }) {\n+â”Š  â”Š31â”Š    addMessage(root, { chatId, content }, { pubsub }) {\n â”Š32â”Š32â”Š      const chatIndex = chats.findIndex(c => c.id === chatId);\n â”Š33â”Š33â”Š\n â”Š34â”Š34â”Š      if (chatIndex === -1) return null;\n```\n```diff\n@@ -49,6 +49,10 @@\n â”Š49â”Š49â”Š      chats.splice(chatIndex, 1);\n â”Š50â”Š50â”Š      chats.unshift(chat);\n â”Š51â”Š51â”Š\n+â”Š  â”Š52â”Š      pubsub.publish('messageAdded', {\n+â”Š  â”Š53â”Š        messageAdded: message,\n+â”Š  â”Š54â”Š      });\n+â”Š  â”Š55â”Š\n â”Š52â”Š56â”Š      return message;\n â”Š53â”Š57â”Š    },\n â”Š54â”Š58â”Š  },\n```\n\n##### Changed tests&#x2F;mutations&#x2F;addMessage.test.ts\n```diff\n@@ -1,5 +1,5 @@\n â”Š1â”Š1â”Šimport { createTestClient } from 'apollo-server-testing';\n-â”Š2â”Š â”Šimport { ApolloServer, gql } from 'apollo-server-express';\n+â”Š â”Š2â”Šimport { ApolloServer, PubSub, gql } from 'apollo-server-express';\n â”Š3â”Š3â”Šimport schema from '../../schema';\n â”Š4â”Š4â”Šimport { resetDb } from '../../db';\n â”Š5â”Š5â”Š\n```\n```diff\n@@ -7,7 +7,10 @@\n â”Š 7â”Š 7â”Š  beforeEach(resetDb);\n â”Š 8â”Š 8â”Š\n â”Š 9â”Š 9â”Š  it('should add message to specified chat', async () => {\n-â”Š10â”Š  â”Š    const server = new ApolloServer({ schema });\n+â”Š  â”Š10â”Š    const server = new ApolloServer({\n+â”Š  â”Š11â”Š      schema,\n+â”Š  â”Š12â”Š      context: () => ({ pubsub: new PubSub() }),\n+â”Š  â”Š13â”Š    });\n â”Š11â”Š14â”Š\n â”Š12â”Š15â”Š    const { query, mutate } = createTestClient(server);\n```\n\n[}]: #\n\nA subscription resolver behaves differently and thus should be implemented differently. Using the `pubsub.asyncIterator` instance, we can specify which events are relevant for the subscription, for example, all clients who are subscribers of the `chatUpdated` subscription will be notified when `messageAdded`, `messageRemoved` and `chatInfoChanged` events were triggered. For now, we will have a 1 to 1 relationship between the `messageAdded` event and `messageAdded` subscription. In code, it should look like this:\n\n[{]: <helper> (diffStep 7.5 module=\"server\")\n\n#### [__Server__ Step 7.5: Add Subscription.messageAdded resolver](https://github.com/Urigo/WhatsApp-Clone-Server/commit/f72e6384995a2ffd085f30e3d861142d0455265c)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -56,6 +56,13 @@\n â”Š56â”Š56â”Š      return message;\n â”Š57â”Š57â”Š    },\n â”Š58â”Š58â”Š  },\n+â”Š  â”Š59â”Š\n+â”Š  â”Š60â”Š  Subscription: {\n+â”Š  â”Š61â”Š    messageAdded: {\n+â”Š  â”Š62â”Š      subscribe: (root, args, { pubsub }) =>\n+â”Š  â”Š63â”Š        pubsub.asyncIterator('messageAdded'),\n+â”Š  â”Š64â”Š    },\n+â”Š  â”Š65â”Š  },\n â”Š59â”Š66â”Š};\n â”Š60â”Š67â”Š\n â”Š61â”Š68â”Šexport default resolvers;\n```\n\n[}]: #\n\nThe idea behind the `pubsub.asyncIterator` method is that it returns an [`Iterator`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Iterators_and_Generators#Iterators) like object, where each value is a promise that will be resolved when the relevant events are triggered. By default, the parameter that has a similar name to the subscription will be returned as a response, e.g. `messageAdded` parameter will be sent back to the subscribers. This behavior can be modified as explained [here](https://github.com/apollographql/graphql-subscriptions#payload-manipulation), but it's very unlikely and not necessary for our use case.\n\nAs mentioned at the beginning of this article, there needs to be an open connection between the client and the server so live updates can happen. There are serveral methods for doing so, but the 2 most popular ones are:\n\n\n\n*   Based on polling with HTTP protocol\n*   Based on web-sockets (WS protocol)\n\nHTTP polling means that each amount of time an HTTP request will be made to the server where potential changes can be sent back to us at any given time. HTTP requests are very reliable, but the problem with them is that they contain a lot of information in their headers, so even if we sent an empty request, it might be still very heavy due to cookies, user-agent, language, request type, etc.\n\nWith web-sockets, once a connection has been established, it will remain open and it will only send the information which is relevant for the current session, so it's much faster. The communication is between the server and the client is bi-directional when it comes to web-sockets, which means that a user can spontaneously receive information from the server, as long as the communication channel remains open.\n\n> More information about the advantages of Web Sockets over HTTP can be found at [websocket.org](http://websocket.org/quantum.html)\n\nThe subscription mechanism can be installed using the `server.installSubscriptionHandlers`. It will use the WS protocol by default and will fallback to HTTP polling if there were troubles establishing a connection via WS protocol:\n\n[{]: <helper> (diffStep 7.6 module=\"server\")\n\n#### [__Server__ Step 7.6: Install subscription handlers](https://github.com/Urigo/WhatsApp-Clone-Server/commit/2f99ff9340f037d65afcb14c94c682a93aebc287)\n\n##### Changed index.ts\n```diff\n@@ -1,6 +1,7 @@\n â”Š1â”Š1â”Šimport { ApolloServer, gql, PubSub } from 'apollo-server-express';\n â”Š2â”Š2â”Šimport cors from 'cors';\n â”Š3â”Š3â”Šimport express from 'express';\n+â”Š â”Š4â”Šimport http from 'http';\n â”Š4â”Š5â”Šimport schema from './schema';\n â”Š5â”Š6â”Š\n â”Š6â”Š7â”Šconst app = express();\n```\n```diff\n@@ -23,8 +24,11 @@\n â”Š23â”Š24â”Š  path: '/graphql',\n â”Š24â”Š25â”Š});\n â”Š25â”Š26â”Š\n+â”Š  â”Š27â”Šconst httpServer = http.createServer(app);\n+â”Š  â”Š28â”Šserver.installSubscriptionHandlers(httpServer);\n+â”Š  â”Š29â”Š\n â”Š26â”Š30â”Šconst port = process.env.PORT || 4000;\n â”Š27â”Š31â”Š\n-â”Š28â”Š  â”Šapp.listen(port, () => {\n+â”Š  â”Š32â”ŠhttpServer.listen(port, () => {\n â”Š29â”Š33â”Š  console.log(`Server is listening on port ${port}`);\n â”Š30â”Š34â”Š});\n```\n\n[}]: #\n\nNow we have everything set and we can start listening to subscriptions and react to to triggered changes.\n\n**Using subscriptions**\n\nTo support subscriptions we need to establish a WS connection. For that we will need to update our Apollo client. We will install a couple of packages that will enable such feature:\n\n    $ yarn add subscriptions-transport-ws apollo-link apollo-link-ws apollo-utilities\n\n\n*   [`subscriptions-transport-ws`](https://www.npmjs.com/package/subscriptions-transport-ws) - a transport layer that understands how client and GraphQL API communicates with each other. The spec has GQL_INIT GQL_UPDATE GQL_DATA events.\n*   [`apollo-link-ws`](https://www.npmjs.com/package/apollo-link-ws) - Will establish a WS connection.\n*   [`apollo-link`](https://www.npmjs.com/package/apollo-link) - Will enable WS and HTTP connections co-exist in a single client.\n*   [`apollo-utilities`](https://www.npmjs.com/package/apollo-utilities) - Includes utility functions that will help us analyze a GraphQL AST.\n\nThe WS url can be composed by simply running a regular expression over the `REACT_APP_SERVER_URL` environment variable and is unnecessary to be stored separately. Here's how our new client should look like: \\\n\n\n[{]: <helper> (diffStep 10.1 files=\"client\" module=\"client\")\n\n#### [__Client__ Step 10.1: Setup WS link](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/bf7f53dcd094b96ced78ddde4b40c9b942b66136)\n\n##### Changed src&#x2F;client.ts\n```diff\n@@ -1,16 +1,40 @@\n â”Š 1â”Š 1â”Šimport { InMemoryCache } from 'apollo-cache-inmemory';\n â”Š 2â”Š 2â”Šimport { ApolloClient } from 'apollo-client';\n+â”Š  â”Š 3â”Šimport { getMainDefinition } from 'apollo-utilities';\n â”Š 3â”Š 4â”Šimport { HttpLink } from 'apollo-link-http';\n+â”Š  â”Š 5â”Šimport { WebSocketLink } from 'apollo-link-ws';\n+â”Š  â”Š 6â”Šimport { ApolloLink, split } from 'apollo-link';\n â”Š 4â”Š 7â”Š\n â”Š 5â”Š 8â”Šconst httpUri = process.env.REACT_APP_SERVER_URL + '/graphql';\n+â”Š  â”Š 9â”Šconst wsUri = httpUri.replace(/^https?/, 'ws');\n â”Š 6â”Š10â”Š\n â”Š 7â”Š11â”Šconst httpLink = new HttpLink({\n â”Š 8â”Š12â”Š  uri: httpUri,\n â”Š 9â”Š13â”Š});\n â”Š10â”Š14â”Š\n+â”Š  â”Š15â”Šconst wsLink = new WebSocketLink({\n+â”Š  â”Š16â”Š  uri: wsUri,\n+â”Š  â”Š17â”Š  options: {\n+â”Š  â”Š18â”Š    // Automatic reconnect in case of connection error\n+â”Š  â”Š19â”Š    reconnect: true,\n+â”Š  â”Š20â”Š  },\n+â”Š  â”Š21â”Š});\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Šconst terminatingLink = split(\n+â”Š  â”Š24â”Š  ({ query }) => {\n+â”Š  â”Š25â”Š    const { kind, operation } = getMainDefinition(query);\n+â”Š  â”Š26â”Š    // If this is a subscription query, use wsLink, otherwise use httpLink\n+â”Š  â”Š27â”Š    return kind === 'OperationDefinition' && operation === 'subscription';\n+â”Š  â”Š28â”Š  },\n+â”Š  â”Š29â”Š  wsLink,\n+â”Š  â”Š30â”Š  httpLink\n+â”Š  â”Š31â”Š);\n+â”Š  â”Š32â”Š\n+â”Š  â”Š33â”Šconst link = ApolloLink.from([terminatingLink]);\n+â”Š  â”Š34â”Š\n â”Š11â”Š35â”Šconst inMemoryCache = new InMemoryCache();\n â”Š12â”Š36â”Š\n â”Š13â”Š37â”Šexport default new ApolloClient({\n-â”Š14â”Š  â”Š  link: httpLink,\n+â”Š  â”Š38â”Š  link,\n â”Š15â”Š39â”Š  cache: inMemoryCache,\n â”Š16â”Š40â”Š});\n```\n\n[}]: #\n\nOur subscription listeners should live globally across our application and shouldn't be bound to a specific component, thus we will create an external service which will be responsible of doing so. Using that service, we will update our GraphQL data-store any time a new message has been added. We will define a `messageAdded` subscription in a dedicated file under the `src/graphql/subscriptions` dir where all our subscriptions will be defined and exported:\n\n[comment]: # (but they are anyway. Itâ€™s just a standalone function that is used in a component. Which makes no difference.)\n\n[{]: <helper> (diffStep 10.2 module=\"client\")\n\n#### [__Client__ Step 10.2: Add messageAdded subscription document](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/02b4f37287e1d3a6db60a2aa18cc92c99591f936)\n\n##### Added src&#x2F;graphql&#x2F;subscriptions&#x2F;index.ts\n```diff\n@@ -0,0 +1 @@\n+â”Š â”Š1â”Šexport { default as messageAdded } from './messageAdded.subscription';\n```\n\n##### Added src&#x2F;graphql&#x2F;subscriptions&#x2F;messageAdded.subscription.ts\n```diff\n@@ -0,0 +1,11 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag';\n+â”Š  â”Š 2â”Šimport * as fragments from '../fragments';\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šexport default gql`\n+â”Š  â”Š 5â”Š  subscription MessageAdded {\n+â”Š  â”Š 6â”Š    messageAdded {\n+â”Š  â”Š 7â”Š      ...Message\n+â”Š  â”Š 8â”Š    }\n+â”Š  â”Š 9â”Š  }\n+â”Š  â”Š10â”Š  ${fragments.message}\n+â”Š  â”Š11â”Š`;\n```\n\n[}]: #\n\nNow we will create the service under the path `services/cache.service.ts`.\nLike any other GraphQL operation, `@apollo/react-hooks` provides us with a dedicated React hook for subscriptions called `useSubscription`.\n\nGiven the subscription document and the `onSubscriptionData` callback we can handle incoming changes.\nWe will be using GraphQL Code Generator to generate typed subscription hooks, as the `typescript-react-apollo` plug-in supports it right out of the box.\n\nFirst let's update the `codegen.yml` file to look for documents in the `graphql/subscriptions` dir:\n\n[{]: <helper> (diffStep 10.3 module=\"client\")\n\n#### [__Client__ Step 10.3: Include subscription documents in codegen.yml](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/a71364ec6b7cfe6a6ea14a1a7695b57d8d5dcef9)\n\n##### Changed codegen.yml\n```diff\n@@ -3,6 +3,7 @@\n â”Š3â”Š3â”Š  - ./src/components/**/*.tsx\n â”Š4â”Š4â”Š  - ./src/graphql/fragments/**/*.ts\n â”Š5â”Š5â”Š  - ./src/graphql/queries/**/*.ts\n+â”Š â”Š6â”Š  - ./src/graphql/subscriptions/**/*.ts\n â”Š6â”Š7â”Šoverwrite: true\n â”Š7â”Š8â”Šgenerates:\n â”Š8â”Š9â”Š  ./src/graphql/types.tsx:\n```\n\n[}]: #\n\nAnd then we will type the code generation command:\n\n    $ npm run codegen\n\nNow we can import and use the newly generated hook `useMessageAddedSubscription` in the `cache.service`. Like mentioned earlier, we will be using the `onSubscriptionData` callback to retrieve the change that was sent by the server and we will use it to re-write our cache. In this case we will be writing a new fragment for the incoming message, and we will update the correlated chat:\n\n[{]: <helper> (diffStep 10.4 files=\"cache.service\" module=\"client\")\n\n#### [__Client__ Step 10.4: Update cache on message added](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/bf723a7f891998c7b3fbf3adffed6e40b7c40ca3)\n\n##### Added src&#x2F;services&#x2F;cache.service.ts\n```diff\n@@ -0,0 +1,86 @@\n+â”Š  â”Š 1â”Šimport { DataProxy } from 'apollo-cache';\n+â”Š  â”Š 2â”Šimport { defaultDataIdFromObject } from 'apollo-cache-inmemory';\n+â”Š  â”Š 3â”Šimport { ApolloClient } from 'apollo-client';\n+â”Š  â”Š 4â”Šimport * as fragments from '../graphql/fragments';\n+â”Š  â”Š 5â”Šimport * as queries from '../graphql/queries';\n+â”Š  â”Š 6â”Šimport { MessageFragment, useMessageAddedSubscription } from '../graphql/types';\n+â”Š  â”Š 7â”Š\n+â”Š  â”Š 8â”Štype Client = ApolloClient<any> | DataProxy;\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Šexport const useCacheService = () => {\n+â”Š  â”Š11â”Š  useMessageAddedSubscription({\n+â”Š  â”Š12â”Š    onSubscriptionData: ({ client, subscriptionData: { data } }) => {\n+â”Š  â”Š13â”Š      if (data) {\n+â”Š  â”Š14â”Š        writeMessage(client, data.messageAdded);\n+â”Š  â”Š15â”Š      }\n+â”Š  â”Š16â”Š    },\n+â”Š  â”Š17â”Š  });\n+â”Š  â”Š18â”Š};\n+â”Š  â”Š19â”Š\n+â”Š  â”Š20â”Šexport const writeMessage = (client: Client, message: MessageFragment) => {\n+â”Š  â”Š21â”Š  type FullChat = { [key: string]: any };\n+â”Š  â”Š22â”Š  let fullChat;\n+â”Š  â”Š23â”Š\n+â”Š  â”Š24â”Š  const chatIdFromStore = defaultDataIdFromObject(message.chat);\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Š  if (chatIdFromStore === null) {\n+â”Š  â”Š27â”Š    return;\n+â”Š  â”Š28â”Š  }\n+â”Š  â”Š29â”Š  try {\n+â”Š  â”Š30â”Š    fullChat = client.readFragment<FullChat>({\n+â”Š  â”Š31â”Š      id: chatIdFromStore,\n+â”Š  â”Š32â”Š      fragment: fragments.fullChat,\n+â”Š  â”Š33â”Š      fragmentName: 'FullChat',\n+â”Š  â”Š34â”Š    });\n+â”Š  â”Š35â”Š  } catch (e) {\n+â”Š  â”Š36â”Š    return;\n+â”Š  â”Š37â”Š  }\n+â”Š  â”Š38â”Š\n+â”Š  â”Š39â”Š  if (fullChat === null || fullChat.messages === null) {\n+â”Š  â”Š40â”Š    return;\n+â”Š  â”Š41â”Š  }\n+â”Š  â”Š42â”Š  if (fullChat.messages.some((m: any) => m.id === message.id)) return;\n+â”Š  â”Š43â”Š\n+â”Š  â”Š44â”Š  fullChat.messages.push(message);\n+â”Š  â”Š45â”Š  fullChat.lastMessage = message;\n+â”Š  â”Š46â”Š\n+â”Š  â”Š47â”Š  client.writeFragment({\n+â”Š  â”Š48â”Š    id: chatIdFromStore,\n+â”Š  â”Š49â”Š    fragment: fragments.fullChat,\n+â”Š  â”Š50â”Š    fragmentName: 'FullChat',\n+â”Š  â”Š51â”Š    data: fullChat,\n+â”Š  â”Š52â”Š  });\n+â”Š  â”Š53â”Š\n+â”Š  â”Š54â”Š  let data;\n+â”Š  â”Š55â”Š  try {\n+â”Š  â”Š56â”Š    data = client.readQuery({\n+â”Š  â”Š57â”Š      query: queries.chats,\n+â”Š  â”Š58â”Š    });\n+â”Š  â”Š59â”Š  } catch (e) {\n+â”Š  â”Š60â”Š    return;\n+â”Š  â”Š61â”Š  }\n+â”Š  â”Š62â”Š\n+â”Š  â”Š63â”Š  if (!data || data === null) {\n+â”Š  â”Š64â”Š    return null;\n+â”Š  â”Š65â”Š  }\n+â”Š  â”Š66â”Š  if (!data.chats || data.chats === undefined) {\n+â”Š  â”Š67â”Š    return null;\n+â”Š  â”Š68â”Š  }\n+â”Š  â”Š69â”Š  const chats = data.chats;\n+â”Š  â”Š70â”Š\n+â”Š  â”Š71â”Š  const chatIndex = chats.findIndex((c: any) => {\n+â”Š  â”Š72â”Š    if (message === null || message.chat === null) return -1;\n+â”Š  â”Š73â”Š    return c.id === message.chat.id;\n+â”Š  â”Š74â”Š  });\n+â”Š  â”Š75â”Š  if (chatIndex === -1) return;\n+â”Š  â”Š76â”Š  const chatWhereAdded = chats[chatIndex];\n+â”Š  â”Š77â”Š\n+â”Š  â”Š78â”Š  // The chat will appear at the top of the ChatsList component\n+â”Š  â”Š79â”Š  chats.splice(chatIndex, 1);\n+â”Š  â”Š80â”Š  chats.unshift(chatWhereAdded);\n+â”Š  â”Š81â”Š\n+â”Š  â”Š82â”Š  client.writeQuery({\n+â”Š  â”Š83â”Š    query: queries.chats,\n+â”Š  â”Š84â”Š    data: { chats: chats },\n+â”Š  â”Š85â”Š  });\n+â”Š  â”Š86â”Š};\n```\n\n[}]: #\n\nWe will also use the exported `writeMessage()` function in the `ChatRoomScreen` so we won't have any code duplications:\n\n[{]: <helper> (diffStep 10.4 files=\"ChatRoom\" module=\"client\")\n\n#### [__Client__ Step 10.4: Update cache on message added](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/bf723a7f891998c7b3fbf3adffed6e40b7c40ca3)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -1,4 +1,3 @@\n-â”Š1â”Š â”Šimport { defaultDataIdFromObject } from 'apollo-cache-inmemory';\n â”Š2â”Š1â”Šimport gql from 'graphql-tag';\n â”Š3â”Š2â”Šimport React from 'react';\n â”Š4â”Š3â”Šimport { useCallback } from 'react';\n```\n```diff\n@@ -7,9 +6,9 @@\n â”Š 7â”Š 6â”Šimport MessageInput from './MessageInput';\n â”Š 8â”Š 7â”Šimport MessagesList from './MessagesList';\n â”Š 9â”Š 8â”Šimport { History } from 'history';\n-â”Š10â”Š  â”Šimport { ChatsQuery, useGetChatQuery, useAddMessageMutation } from '../../graphql/types';\n-â”Š11â”Š  â”Šimport * as queries from '../../graphql/queries';\n+â”Š  â”Š 9â”Šimport { useGetChatQuery, useAddMessageMutation } from '../../graphql/types';\n â”Š12â”Š10â”Šimport * as fragments from '../../graphql/fragments';\n+â”Š  â”Š11â”Šimport { writeMessage } from '../../services/cache.service';\n â”Š13â”Š12â”Š\n â”Š14â”Š13â”Šconst Container = styled.div`\n â”Š15â”Š14â”Š  background: url(/assets/chat-background.jpg);\n```\n```diff\n@@ -43,10 +42,6 @@\n â”Š43â”Š42â”Š  history: History;\n â”Š44â”Š43â”Š}\n â”Š45â”Š44â”Š\n-â”Š46â”Š  â”Šinterface ChatsResult {\n-â”Š47â”Š  â”Š  chats: any[];\n-â”Š48â”Š  â”Š}\n-â”Š49â”Š  â”Š\n â”Š50â”Š45â”Šconst ChatRoomScreen: React.FC<ChatRoomScreenParams> = ({\n â”Š51â”Š46â”Š  history,\n â”Š52â”Š47â”Š  chatId,\n```\n```diff\n@@ -79,68 +74,7 @@\n â”Š 79â”Š 74â”Š          },\n â”Š 80â”Š 75â”Š        },\n â”Š 81â”Š 76â”Š        update: (client, { data: { addMessage } }) => {\n-â”Š 82â”Š   â”Š          type FullChat = { [key: string]: any };\n-â”Š 83â”Š   â”Š          let fullChat;\n-â”Š 84â”Š   â”Š\n-â”Š 85â”Š   â”Š          const chatIdFromStore = defaultDataIdFromObject(chat);\n-â”Š 86â”Š   â”Š\n-â”Š 87â”Š   â”Š          if (chatIdFromStore === null) {\n-â”Š 88â”Š   â”Š            return;\n-â”Š 89â”Š   â”Š          }\n-â”Š 90â”Š   â”Š          try {\n-â”Š 91â”Š   â”Š            fullChat = client.readFragment<FullChat>({\n-â”Š 92â”Š   â”Š              id: chatIdFromStore,\n-â”Š 93â”Š   â”Š              fragment: fragments.fullChat,\n-â”Š 94â”Š   â”Š              fragmentName: 'FullChat',\n-â”Š 95â”Š   â”Š            });\n-â”Š 96â”Š   â”Š          } catch (e) {\n-â”Š 97â”Š   â”Š            return;\n-â”Š 98â”Š   â”Š          }\n-â”Š 99â”Š   â”Š\n-â”Š100â”Š   â”Š          if (fullChat === null || fullChat.messages === null) {\n-â”Š101â”Š   â”Š            return;\n-â”Š102â”Š   â”Š          }\n-â”Š103â”Š   â”Š          if (fullChat.messages.some((currentMessage: any) => currentMessage.id === addMessage.id)) return;\n-â”Š104â”Š   â”Š\n-â”Š105â”Š   â”Š          fullChat.messages.push(addMessage);\n-â”Š106â”Š   â”Š          fullChat.lastMessage = addMessage;\n-â”Š107â”Š   â”Š\n-â”Š108â”Š   â”Š          client.writeFragment({\n-â”Š109â”Š   â”Š            id: chatIdFromStore,\n-â”Š110â”Š   â”Š            fragment: fragments.fullChat,\n-â”Š111â”Š   â”Š            fragmentName: 'FullChat',\n-â”Š112â”Š   â”Š            data: fullChat,\n-â”Š113â”Š   â”Š          });\n-â”Š114â”Š   â”Š\n-â”Š115â”Š   â”Š          let data: ChatsQuery | null;\n-â”Š116â”Š   â”Š          try {\n-â”Š117â”Š   â”Š            data = client.readQuery({\n-â”Š118â”Š   â”Š              query: queries.chats,\n-â”Š119â”Š   â”Š            });\n-â”Š120â”Š   â”Š          } catch (e) {\n-â”Š121â”Š   â”Š            return;\n-â”Š122â”Š   â”Š          }\n-â”Š123â”Š   â”Š\n-â”Š124â”Š   â”Š          if (!data || !data.chats) {\n-â”Š125â”Š   â”Š            return null;\n-â”Š126â”Š   â”Š          }\n-â”Š127â”Š   â”Š          const chats = data.chats;\n-â”Š128â”Š   â”Š\n-â”Š129â”Š   â”Š          const chatIndex = chats.findIndex((c: any) => {\n-â”Š130â”Š   â”Š            if (addMessage === null || addMessage.chat === null) return -1;\n-â”Š131â”Š   â”Š            return c.id === addMessage.chat.id;\n-â”Š132â”Š   â”Š          });\n-â”Š133â”Š   â”Š          if (chatIndex === -1) return;\n-â”Š134â”Š   â”Š          const chatWhereAdded = chats[chatIndex];\n-â”Š135â”Š   â”Š\n-â”Š136â”Š   â”Š          // The chat will appear at the top of the ChatsList component\n-â”Š137â”Š   â”Š          chats.splice(chatIndex, 1);\n-â”Š138â”Š   â”Š          chats.unshift(chatWhereAdded);\n-â”Š139â”Š   â”Š\n-â”Š140â”Š   â”Š          client.writeQuery({\n-â”Š141â”Š   â”Š            query: queries.chats,\n-â”Š142â”Š   â”Š            data: { chats: chats },\n-â”Š143â”Š   â”Š          });\n+â”Š   â”Š 77â”Š          writeMessage(client, addMessage);\n â”Š144â”Š 78â”Š        },\n â”Š145â”Š 79â”Š      });\n â”Š146â”Š 80â”Š    },\n```\n\n[}]: #\n\nOne thing missing that you might notice is that we're trying to retrieve the chat from the received message, unfortunately our GraphQL schema doesn't support it and we will need to add it. On the server, we will add a `chat` field to the `Message` type in the GraphQL schema, and we will implement a resolver which will lookup for the chat in the chats collection:\n\n[{]: <helper> (diffStep 7.7 module=\"server\")\n\n#### [__Server__ Step 7.7: Add Message.chat resolver](https://github.com/Urigo/WhatsApp-Clone-Server/commit/378919bf4e763bdab9ca90453f4378b3b6575823)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -5,6 +5,12 @@\n â”Š 5â”Š 5â”Šconst resolvers: Resolvers = {\n â”Š 6â”Š 6â”Š  Date: GraphQLDateTime,\n â”Š 7â”Š 7â”Š\n+â”Š  â”Š 8â”Š  Message: {\n+â”Š  â”Š 9â”Š    chat(message) {\n+â”Š  â”Š10â”Š      return chats.find(c => c.messages.some(m => m === message.id)) || null;\n+â”Š  â”Š11â”Š    },\n+â”Š  â”Š12â”Š  },\n+â”Š  â”Š13â”Š\n â”Š 8â”Š14â”Š  Chat: {\n â”Š 9â”Š15â”Š    messages(chat) {\n â”Š10â”Š16â”Š      return messages.filter(m => chat.messages.includes(m.id));\n```\n\n##### Changed schema&#x2F;typeDefs.graphql\n```diff\n@@ -4,6 +4,7 @@\n â”Š 4â”Š 4â”Š  id: ID!\n â”Š 5â”Š 5â”Š  content: String!\n â”Š 6â”Š 6â”Š  createdAt: Date!\n+â”Š  â”Š 7â”Š  chat: Chat\n â”Š 7â”Š 8â”Š}\n â”Š 8â”Š 9â”Š\n â”Š 9â”Š10â”Štype Chat {\n```\n\n[}]: #\n\nNow that we have it supported we can update the `Message` fragment in the client to include that information. We don't need the entire chat, only its ID, since the fragment ID composition is done out of an ID and type name:\n\n[{]: <helper> (diffStep 10.5 module=\"client\")\n\n#### [__Client__ Step 10.5: Add chat.id to message fragment](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/f7175cce2ba958c1579fd396c0ea0f27a33a9c13)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -70,6 +70,10 @@\n â”Š70â”Š70â”Š              .toString(36)\n â”Š71â”Š71â”Š              .substr(2, 9),\n â”Š72â”Š72â”Š            createdAt: new Date(),\n+â”Š  â”Š73â”Š            chat: {\n+â”Š  â”Š74â”Š              __typename: 'Chat',\n+â”Š  â”Š75â”Š              id: chatId,\n+â”Š  â”Š76â”Š            },\n â”Š73â”Š77â”Š            content,\n â”Š74â”Š78â”Š          },\n â”Š75â”Š79â”Š        },\n```\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.test.tsx\n```diff\n@@ -40,6 +40,10 @@\n â”Š40â”Š40â”Š                  id: 1,\n â”Š41â”Š41â”Š                  content: 'Hello',\n â”Š42â”Š42â”Š                  createdAt: new Date('1 Jan 2019 GMT'),\n+â”Š  â”Š43â”Š                  chat: {\n+â”Š  â”Š44â”Š                    __typename: 'Chat',\n+â”Š  â”Š45â”Š                    id: 1,\n+â”Š  â”Š46â”Š                  },\n â”Š43â”Š47â”Š                },\n â”Š44â”Š48â”Š              },\n â”Š45â”Š49â”Š            ],\n```\n```diff\n@@ -86,6 +90,10 @@\n â”Š86â”Š90â”Š                  id: 1,\n â”Š87â”Š91â”Š                  content: 'Hello',\n â”Š88â”Š92â”Š                  createdAt: new Date('1 Jan 2019 GMT'),\n+â”Š  â”Š93â”Š                  chat: {\n+â”Š  â”Š94â”Š                    __typename: 'Chat',\n+â”Š  â”Š95â”Š                    id: 1,\n+â”Š  â”Š96â”Š                  },\n â”Š89â”Š97â”Š                },\n â”Š90â”Š98â”Š              },\n â”Š91â”Š99â”Š            ],\n```\n\n##### Changed src&#x2F;graphql&#x2F;fragments&#x2F;message.fragment.ts\n```diff\n@@ -5,5 +5,8 @@\n â”Š 5â”Š 5â”Š    id\n â”Š 6â”Š 6â”Š    createdAt\n â”Š 7â”Š 7â”Š    content\n+â”Š  â”Š 8â”Š    chat {\n+â”Š  â”Š 9â”Š      id\n+â”Š  â”Š10â”Š    }\n â”Š 8â”Š11â”Š  }\n â”Š 9â”Š12â”Š`;\n```\n\n[}]: #\n\nFinally, we will import the `useCacheService` React hook that we've just created and we will use it in our main `App` component. This means that the cache service will start listening for changes right as the app component is mounted:\n\n[{]: <helper> (diffStep 10.6 module=\"client\")\n\n#### [__Client__ Step 10.6: Use cache service](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/2b5cd95a34c433aed1bbf4f7febf3a9420e63222)\n\n##### Changed src&#x2F;App.test.tsx\n```diff\n@@ -3,9 +3,15 @@\n â”Š 3â”Š 3â”Šimport ReactDOM from 'react-dom';\n â”Š 4â”Š 4â”Šimport App from './App';\n â”Š 5â”Š 5â”Šimport { mockApolloClient } from './test-helpers';\n+â”Š  â”Š 6â”Šimport * as subscriptions from './graphql/subscriptions';\n â”Š 6â”Š 7â”Š\n â”Š 7â”Š 8â”Šit('renders without crashing', () => {\n-â”Š 8â”Š  â”Š  const client = mockApolloClient();\n+â”Š  â”Š 9â”Š  const client = mockApolloClient([\n+â”Š  â”Š10â”Š    {\n+â”Š  â”Š11â”Š      request: { query: subscriptions.messageAdded },\n+â”Š  â”Š12â”Š      result: { data: {} }\n+â”Š  â”Š13â”Š    }\n+â”Š  â”Š14â”Š  ]);\n â”Š 9â”Š15â”Š  const div = document.createElement('div');\n â”Š10â”Š16â”Š\n â”Š11â”Š17â”Š  ReactDOM.render(\n```\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -8,26 +8,31 @@\n â”Š 8â”Š 8â”Šimport ChatRoomScreen from './components/ChatRoomScreen';\n â”Š 9â”Š 9â”Šimport ChatsListScreen from './components/ChatsListScreen';\n â”Š10â”Š10â”Šimport AnimatedSwitch from './components/AnimatedSwitch';\n+â”Š  â”Š11â”Šimport { useCacheService } from './services/cache.service';\n â”Š11â”Š12â”Š\n-â”Š12â”Š  â”Šconst App: React.FC = () => (\n-â”Š13â”Š  â”Š  <BrowserRouter>\n-â”Š14â”Š  â”Š    <AnimatedSwitch>\n-â”Š15â”Š  â”Š      <Route exact path=\"/chats\" component={ChatsListScreen} />\n+â”Š  â”Š13â”Šconst App: React.FC = () => {\n+â”Š  â”Š14â”Š  useCacheService();\n â”Š16â”Š15â”Š\n-â”Š17â”Š  â”Š      <Route\n-â”Š18â”Š  â”Š        exact\n-â”Š19â”Š  â”Š        path=\"/chats/:chatId\"\n-â”Š20â”Š  â”Š        component={({\n-â”Š21â”Š  â”Š          match,\n-â”Š22â”Š  â”Š          history,\n-â”Š23â”Š  â”Š        }: RouteComponentProps<{ chatId: string }>) => (\n-â”Š24â”Š  â”Š          <ChatRoomScreen chatId={match.params.chatId} history={history} />\n-â”Š25â”Š  â”Š        )}\n-â”Š26â”Š  â”Š      />\n-â”Š27â”Š  â”Š    </AnimatedSwitch>\n-â”Š28â”Š  â”Š    <Route exact path=\"/\" render={redirectToChats} />\n-â”Š29â”Š  â”Š  </BrowserRouter>\n-â”Š30â”Š  â”Š);\n+â”Š  â”Š16â”Š  return (\n+â”Š  â”Š17â”Š    <BrowserRouter>\n+â”Š  â”Š18â”Š      <AnimatedSwitch>\n+â”Š  â”Š19â”Š        <Route exact path=\"/chats\" component={ChatsListScreen} />\n+â”Š  â”Š20â”Š\n+â”Š  â”Š21â”Š        <Route\n+â”Š  â”Š22â”Š          exact\n+â”Š  â”Š23â”Š          path=\"/chats/:chatId\"\n+â”Š  â”Š24â”Š          component={({\n+â”Š  â”Š25â”Š            match,\n+â”Š  â”Š26â”Š            history,\n+â”Š  â”Š27â”Š          }: RouteComponentProps<{ chatId: string }>) => (\n+â”Š  â”Š28â”Š            <ChatRoomScreen chatId={match.params.chatId} history={history} />\n+â”Š  â”Š29â”Š          )}\n+â”Š  â”Š30â”Š        />\n+â”Š  â”Š31â”Š      </AnimatedSwitch>\n+â”Š  â”Š32â”Š      <Route exact path=\"/\" render={redirectToChats} />\n+â”Š  â”Š33â”Š    </BrowserRouter>\n+â”Š  â”Š34â”Š  );\n+â”Š  â”Š35â”Š};\n â”Š31â”Š36â”Š\n â”Š32â”Š37â”Šconst redirectToChats = () => <Redirect to=\"/chats\" />;\n```\n\n[}]: #\n\nSubscription handling is complete! If you'll try to repeat the same process again where you check messages updating between 2 instances of the app, you should see them both update.\n\n-------\n\nTODO: `useCacheService` shouldnâ€™t be called like that since itâ€™s related to message events and cache updates are only side-effects."
          },
          {
            "manualTitle": "Step 11: Users",
            "stepRevision": "3a875393231eb276e90695f2a439136646d47f69",
            "manualView": "Our chat app is pretty functional. We can pick a chat from the chats list and we can send messages. It's not hard to notice that one of the most important mechanisms is missing, which is relating a chat or a message to a specific user. Even though we can send messages, it's basically pointless unless someone else receives it. In this chapter we will create a new users collection with pre-defined documents and we will learn how to simulate authentication programmatically so we can test the new mechanism.\n\n**Reshaping the back-end**\n\nTo implement this feature we need to rethink our back-end and reshape the way our GraphQL schema is structured. Right now we only have 2 entities: Chat and Message, which are connected like so:\n\n\n\n![chat-message-orm](https://user-images.githubusercontent.com/7648874/55325929-0faa1b00-54b9-11e9-8868-7a8ed3edcda1.png)\n\n\nWe want to have a new User entity where each user will have Chats he participates in and Messages he owns. Therefore, our new GraphQL schema should look like something like this:\n\n\n\n![chat-message-user-orm](https://user-images.githubusercontent.com/7648874/55325935-146ecf00-54b9-11e9-8c0f-bc3b63cbe676.png)\n\nThis change would require us to update the GraphQL type definitions and handlers, the DB models, and the codegen configuration file:\n\n[{]: <helper> (diffStep 8.1 module=\"server\")\n\n#### [__Server__ Step 8.1: Add User type](https://github.com/Urigo/WhatsApp-Clone-Server/commit/29570144935ca14d6aa0feebf8c6c83b4c84e065)\n\n##### Changed codegen.yml\n```diff\n@@ -10,6 +10,7 @@\n â”Š10â”Š10â”Š      mappers:\n â”Š11â”Š11â”Š        # import { Message } from '../db'\n â”Š12â”Š12â”Š        # The root types of Message resolvers\n+â”Š  â”Š13â”Š        User: ../db#User\n â”Š13â”Š14â”Š        Message: ../db#Message\n â”Š14â”Š15â”Š        Chat: ../db#Chat\n â”Š15â”Š16â”Š      scalars:\n```\n\n##### Changed db.ts\n```diff\n@@ -1,20 +1,60 @@\n+â”Š  â”Š 1â”Šexport type User = {\n+â”Š  â”Š 2â”Š  id: string;\n+â”Š  â”Š 3â”Š  name: string;\n+â”Š  â”Š 4â”Š  picture: string;\n+â”Š  â”Š 5â”Š};\n+â”Š  â”Š 6â”Š\n â”Š 1â”Š 7â”Šexport type Message = {\n â”Š 2â”Š 8â”Š  id: string;\n â”Š 3â”Š 9â”Š  content: string;\n â”Š 4â”Š10â”Š  createdAt: Date;\n+â”Š  â”Š11â”Š  sender: string;\n+â”Š  â”Š12â”Š  recipient: string;\n â”Š 5â”Š13â”Š};\n â”Š 6â”Š14â”Š\n â”Š 7â”Š15â”Šexport type Chat = {\n â”Š 8â”Š16â”Š  id: string;\n-â”Š 9â”Š  â”Š  name: string;\n-â”Š10â”Š  â”Š  picture: string;\n â”Š11â”Š17â”Š  messages: string[];\n+â”Š  â”Š18â”Š  participants: string[];\n â”Š12â”Š19â”Š};\n â”Š13â”Š20â”Š\n+â”Š  â”Š21â”Šexport const users: User[] = [];\n â”Š14â”Š22â”Šexport const messages: Message[] = [];\n â”Š15â”Š23â”Šexport const chats: Chat[] = [];\n â”Š16â”Š24â”Š\n â”Š17â”Š25â”Šexport const resetDb = () => {\n+â”Š  â”Š26â”Š  users.splice(\n+â”Š  â”Š27â”Š    0,\n+â”Š  â”Š28â”Š    Infinity,\n+â”Š  â”Š29â”Š    ...[\n+â”Š  â”Š30â”Š      {\n+â”Š  â”Š31â”Š        id: '1',\n+â”Š  â”Š32â”Š        name: 'Ray Edwards',\n+â”Š  â”Š33â”Š        picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n+â”Š  â”Š34â”Š      },\n+â”Š  â”Š35â”Š      {\n+â”Š  â”Š36â”Š        id: '2',\n+â”Š  â”Š37â”Š        name: 'Ethan Gonzalez',\n+â”Š  â”Š38â”Š        picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n+â”Š  â”Š39â”Š      },\n+â”Š  â”Š40â”Š      {\n+â”Š  â”Š41â”Š        id: '3',\n+â”Š  â”Š42â”Š        name: 'Bryan Wallace',\n+â”Š  â”Š43â”Š        picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n+â”Š  â”Š44â”Š      },\n+â”Š  â”Š45â”Š      {\n+â”Š  â”Š46â”Š        id: '4',\n+â”Š  â”Š47â”Š        name: 'Avery Stewart',\n+â”Š  â”Š48â”Š        picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n+â”Š  â”Š49â”Š      },\n+â”Š  â”Š50â”Š      {\n+â”Š  â”Š51â”Š        id: '5',\n+â”Š  â”Š52â”Š        name: 'Katie Peterson',\n+â”Š  â”Š53â”Š        picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n+â”Š  â”Š54â”Š      },\n+â”Š  â”Š55â”Š    ]\n+â”Š  â”Š56â”Š  );\n+â”Š  â”Š57â”Š\n â”Š18â”Š58â”Š  messages.splice(\n â”Š19â”Š59â”Š    0,\n â”Š20â”Š60â”Š    Infinity,\n```\n```diff\n@@ -23,6 +63,8 @@\n â”Š23â”Š63â”Š        id: '1',\n â”Š24â”Š64â”Š        content: 'You on your way?',\n â”Š25â”Š65â”Š        createdAt: new Date(new Date('1-1-2019').getTime() - 60 * 1000 * 1000),\n+â”Š  â”Š66â”Š        sender: '1',\n+â”Š  â”Š67â”Š        recipient: '2',\n â”Š26â”Š68â”Š      },\n â”Š27â”Š69â”Š      {\n â”Š28â”Š70â”Š        id: '2',\n```\n```diff\n@@ -30,6 +72,8 @@\n â”Š30â”Š72â”Š        createdAt: new Date(\n â”Š31â”Š73â”Š          new Date('1-1-2019').getTime() - 2 * 60 * 1000 * 1000\n â”Š32â”Š74â”Š        ),\n+â”Š  â”Š75â”Š        sender: '1',\n+â”Š  â”Š76â”Š        recipient: '3',\n â”Š33â”Š77â”Š      },\n â”Š34â”Š78â”Š      {\n â”Š35â”Š79â”Š        id: '3',\n```\n```diff\n@@ -37,6 +81,8 @@\n â”Š37â”Š81â”Š        createdAt: new Date(\n â”Š38â”Š82â”Š          new Date('1-1-2019').getTime() - 24 * 60 * 1000 * 1000\n â”Š39â”Š83â”Š        ),\n+â”Š  â”Š84â”Š        sender: '1',\n+â”Š  â”Š85â”Š        recipient: '4',\n â”Š40â”Š86â”Š      },\n â”Š41â”Š87â”Š      {\n â”Š42â”Š88â”Š        id: '4',\n```\n```diff\n@@ -44,6 +90,8 @@\n â”Š44â”Š90â”Š        createdAt: new Date(\n â”Š45â”Š91â”Š          new Date('1-1-2019').getTime() - 14 * 24 * 60 * 1000 * 1000\n â”Š46â”Š92â”Š        ),\n+â”Š  â”Š93â”Š        sender: '1',\n+â”Š  â”Š94â”Š        recipient: '5',\n â”Š47â”Š95â”Š      },\n â”Š48â”Š96â”Š    ]\n â”Š49â”Š97â”Š  );\n```\n```diff\n@@ -54,26 +102,22 @@\n â”Š 54â”Š102â”Š    ...[\n â”Š 55â”Š103â”Š      {\n â”Š 56â”Š104â”Š        id: '1',\n-â”Š 57â”Š   â”Š        name: 'Ethan Gonzalez',\n-â”Š 58â”Š   â”Š        picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n+â”Š   â”Š105â”Š        participants: ['1', '2'],\n â”Š 59â”Š106â”Š        messages: ['1'],\n â”Š 60â”Š107â”Š      },\n â”Š 61â”Š108â”Š      {\n â”Š 62â”Š109â”Š        id: '2',\n-â”Š 63â”Š   â”Š        name: 'Bryan Wallace',\n-â”Š 64â”Š   â”Š        picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n+â”Š   â”Š110â”Š        participants: ['1', '3'],\n â”Š 65â”Š111â”Š        messages: ['2'],\n â”Š 66â”Š112â”Š      },\n â”Š 67â”Š113â”Š      {\n â”Š 68â”Š114â”Š        id: '3',\n-â”Š 69â”Š   â”Š        name: 'Avery Stewart',\n-â”Š 70â”Š   â”Š        picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n+â”Š   â”Š115â”Š        participants: ['1', '4'],\n â”Š 71â”Š116â”Š        messages: ['3'],\n â”Š 72â”Š117â”Š      },\n â”Š 73â”Š118â”Š      {\n â”Š 74â”Š119â”Š        id: '4',\n-â”Š 75â”Š   â”Š        name: 'Katie Peterson',\n-â”Š 76â”Š   â”Š        picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n+â”Š   â”Š120â”Š        participants: ['1', '5'],\n â”Š 77â”Š121â”Š        messages: ['4'],\n â”Š 78â”Š122â”Š      },\n â”Š 79â”Š123â”Š    ]\n```\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,5 +1,5 @@\n â”Š1â”Š1â”Šimport { GraphQLDateTime } from 'graphql-iso-date';\n-â”Š2â”Š â”Šimport { Message, chats, messages } from '../db';\n+â”Š â”Š2â”Šimport { User, Message, chats, messages, users } from '../db';\n â”Š3â”Š3â”Šimport { Resolvers } from '../types/graphql';\n â”Š4â”Š4â”Š\n â”Š5â”Š5â”Šconst resolvers: Resolvers = {\n```\n```diff\n@@ -9,9 +9,27 @@\n â”Š 9â”Š 9â”Š    chat(message) {\n â”Š10â”Š10â”Š      return chats.find(c => c.messages.some(m => m === message.id)) || null;\n â”Š11â”Š11â”Š    },\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Š    sender(message) {\n+â”Š  â”Š14â”Š      return users.find(u => u.id === message.sender) || null;\n+â”Š  â”Š15â”Š    },\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š    recipient(message) {\n+â”Š  â”Š18â”Š      return users.find(u => u.id === message.recipient) || null;\n+â”Š  â”Š19â”Š    },\n â”Š12â”Š20â”Š  },\n â”Š13â”Š21â”Š\n â”Š14â”Š22â”Š  Chat: {\n+â”Š  â”Š23â”Š    name() {\n+â”Š  â”Š24â”Š      // TODO: Resolve in relation to current user\n+â”Š  â”Š25â”Š      return null;\n+â”Š  â”Š26â”Š    },\n+â”Š  â”Š27â”Š\n+â”Š  â”Š28â”Š    picture() {\n+â”Š  â”Š29â”Š      // TODO: Resolve in relation to current user\n+â”Š  â”Š30â”Š      return null;\n+â”Š  â”Š31â”Š    },\n+â”Š  â”Š32â”Š\n â”Š15â”Š33â”Š    messages(chat) {\n â”Š16â”Š34â”Š      return messages.filter(m => chat.messages.includes(m.id));\n â”Š17â”Š35â”Š    },\n```\n```diff\n@@ -21,6 +39,12 @@\n â”Š21â”Š39â”Š\n â”Š22â”Š40â”Š      return messages.find(m => m.id === lastMessage) || null;\n â”Š23â”Š41â”Š    },\n+â”Š  â”Š42â”Š\n+â”Š  â”Š43â”Š    participants(chat) {\n+â”Š  â”Š44â”Š      return chat.participants\n+â”Š  â”Š45â”Š        .map(p => users.find(u => u.id === p))\n+â”Š  â”Š46â”Š        .filter(Boolean) as User[];\n+â”Š  â”Š47â”Š    },\n â”Š24â”Š48â”Š  },\n â”Š25â”Š49â”Š\n â”Š26â”Š50â”Š  Query: {\n```\n```diff\n@@ -46,6 +70,8 @@\n â”Š46â”Š70â”Š      const message: Message = {\n â”Š47â”Š71â”Š        id: messageId,\n â”Š48â”Š72â”Š        createdAt: new Date(),\n+â”Š  â”Š73â”Š        sender: '', // TODO: Fill-in\n+â”Š  â”Š74â”Š        recipient: '', // TODO: Fill-in\n â”Š49â”Š75â”Š        content,\n â”Š50â”Š76â”Š      };\n â”Š51â”Š77â”Š\n```\n\n##### Changed schema&#x2F;typeDefs.graphql\n```diff\n@@ -1,18 +1,28 @@\n â”Š 1â”Š 1â”Šscalar Date\n â”Š 2â”Š 2â”Š\n+â”Š  â”Š 3â”Štype User {\n+â”Š  â”Š 4â”Š  id: ID!\n+â”Š  â”Š 5â”Š  name: String!\n+â”Š  â”Š 6â”Š  picture: String\n+â”Š  â”Š 7â”Š}\n+â”Š  â”Š 8â”Š\n â”Š 3â”Š 9â”Štype Message {\n â”Š 4â”Š10â”Š  id: ID!\n â”Š 5â”Š11â”Š  content: String!\n â”Š 6â”Š12â”Š  createdAt: Date!\n â”Š 7â”Š13â”Š  chat: Chat\n+â”Š  â”Š14â”Š  sender: User\n+â”Š  â”Š15â”Š  recipient: User\n+â”Š  â”Š16â”Š  isMine: Boolean!\n â”Š 8â”Š17â”Š}\n â”Š 9â”Š18â”Š\n â”Š10â”Š19â”Štype Chat {\n â”Š11â”Š20â”Š  id: ID!\n-â”Š12â”Š  â”Š  name: String!\n+â”Š  â”Š21â”Š  name: String\n â”Š13â”Š22â”Š  picture: String\n â”Š14â”Š23â”Š  lastMessage: Message\n â”Š15â”Š24â”Š  messages: [Message!]!\n+â”Š  â”Š25â”Š  participants: [User!]!\n â”Š16â”Š26â”Š}\n â”Š17â”Š27â”Š\n â”Š18â”Š28â”Štype Query {\n```\n\n[}]: #\n\nEven though we made these changes, the app remained the same. That's because the Query type haven't changed at all, and we still serve the same data as before. What we need to do is to edit the Query resolvers to serve data based on the user that is currently logged-in to the app in the current session. Before we go all in with a robust authentication system, it would be smarter to simulate it, so we can test our app and see that everything works as intended.\n\nFor now, let's assume that we're logged in with user of ID 1 - Ray Edwards. Codewise, this would mean that we will need to have the current user defined on the resolver context. In the main file, let's add the `currentUser` field to the context using a simple `find()` method from our `users` collection:\n\n[{]: <helper> (diffStep 8.2 files=\"index.ts\" module=\"server\")\n\n#### [__Server__ Step 8.2: Resolve queries in relation to current user](https://github.com/Urigo/WhatsApp-Clone-Server/commit/f6d88bc57827802d69965d0eae8ced26ddaa94b9)\n\n##### Changed index.ts\n```diff\n@@ -2,6 +2,7 @@\n â”Š2â”Š2â”Šimport cors from 'cors';\n â”Š3â”Š3â”Šimport express from 'express';\n â”Š4â”Š4â”Šimport http from 'http';\n+â”Š â”Š5â”Šimport { users } from './db';\n â”Š5â”Š6â”Šimport schema from './schema';\n â”Š6â”Š7â”Š\n â”Š7â”Š8â”Šconst app = express();\n```\n```diff\n@@ -16,7 +17,10 @@\n â”Š16â”Š17â”Šconst pubsub = new PubSub();\n â”Š17â”Š18â”Šconst server = new ApolloServer({\n â”Š18â”Š19â”Š  schema,\n-â”Š19â”Š  â”Š  context: () => ({ pubsub }),\n+â”Š  â”Š20â”Š  context: () => ({\n+â”Š  â”Š21â”Š    currentUser: users.find(u => u.id === '1'),\n+â”Š  â”Š22â”Š    pubsub,\n+â”Š  â”Š23â”Š  }),\n â”Š20â”Š24â”Š});\n â”Š21â”Š25â”Š\n â”Š22â”Š26â”Šserver.applyMiddleware({\n```\n\n[}]: #\n\nAnd we will update the context type:\n\n[{]: <helper> (diffStep 8.2 files=\"context\" module=\"server\")\n\n#### [__Server__ Step 8.2: Resolve queries in relation to current user](https://github.com/Urigo/WhatsApp-Clone-Server/commit/f6d88bc57827802d69965d0eae8ced26ddaa94b9)\n\n##### Changed context.ts\n```diff\n@@ -1,5 +1,7 @@\n â”Š1â”Š1â”Šimport { PubSub } from 'apollo-server-express';\n+â”Š â”Š2â”Šimport { User } from './db';\n â”Š2â”Š3â”Š\n â”Š3â”Š4â”Šexport type MyContext = {\n â”Š4â”Š5â”Š  pubsub: PubSub;\n+â”Š â”Š6â”Š  currentUser: User;\n â”Š5â”Š7â”Š};\n```\n\n[}]: #\n\nNow we will update the resolvers to fetch data relatively to the current user logged in. If there's no user logged in, the resolvers should return `null`, as the client is not authorized to view the data he requested:\n\n[{]: <helper> (diffStep 8.2 files=\"schema, tests\" module=\"server\")\n\n#### [__Server__ Step 8.2: Resolve queries in relation to current user](https://github.com/Urigo/WhatsApp-Clone-Server/commit/f6d88bc57827802d69965d0eae8ced26ddaa94b9)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -17,17 +17,35 @@\n â”Š17â”Š17â”Š    recipient(message) {\n â”Š18â”Š18â”Š      return users.find(u => u.id === message.recipient) || null;\n â”Š19â”Š19â”Š    },\n+â”Š  â”Š20â”Š\n+â”Š  â”Š21â”Š    isMine(message, args, { currentUser }) {\n+â”Š  â”Š22â”Š      return message.sender === currentUser.id;\n+â”Š  â”Š23â”Š    },\n â”Š20â”Š24â”Š  },\n â”Š21â”Š25â”Š\n â”Š22â”Š26â”Š  Chat: {\n-â”Š23â”Š  â”Š    name() {\n-â”Š24â”Š  â”Š      // TODO: Resolve in relation to current user\n-â”Š25â”Š  â”Š      return null;\n+â”Š  â”Š27â”Š    name(chat, args, { currentUser }) {\n+â”Š  â”Š28â”Š      if (!currentUser) return null;\n+â”Š  â”Š29â”Š\n+â”Š  â”Š30â”Š      const participantId = chat.participants.find(p => p !== currentUser.id);\n+â”Š  â”Š31â”Š\n+â”Š  â”Š32â”Š      if (!participantId) return null;\n+â”Š  â”Š33â”Š\n+â”Š  â”Š34â”Š      const participant = users.find(u => u.id === participantId);\n+â”Š  â”Š35â”Š\n+â”Š  â”Š36â”Š      return participant ? participant.name : null;\n â”Š26â”Š37â”Š    },\n â”Š27â”Š38â”Š\n-â”Š28â”Š  â”Š    picture() {\n-â”Š29â”Š  â”Š      // TODO: Resolve in relation to current user\n-â”Š30â”Š  â”Š      return null;\n+â”Š  â”Š39â”Š    picture(chat, args, { currentUser }) {\n+â”Š  â”Š40â”Š      if (!currentUser) return null;\n+â”Š  â”Š41â”Š\n+â”Š  â”Š42â”Š      const participantId = chat.participants.find(p => p !== currentUser.id);\n+â”Š  â”Š43â”Š\n+â”Š  â”Š44â”Š      if (!participantId) return null;\n+â”Š  â”Š45â”Š\n+â”Š  â”Š46â”Š      const participant = users.find(u => u.id === participantId);\n+â”Š  â”Š47â”Š\n+â”Š  â”Š48â”Š      return participant ? participant.picture : null;\n â”Š31â”Š49â”Š    },\n â”Š32â”Š50â”Š\n â”Š33â”Š51â”Š    messages(chat) {\n```\n```diff\n@@ -48,30 +66,41 @@\n â”Š 48â”Š 66â”Š  },\n â”Š 49â”Š 67â”Š\n â”Š 50â”Š 68â”Š  Query: {\n-â”Š 51â”Š   â”Š    chats() {\n-â”Š 52â”Š   â”Š      return chats;\n+â”Š   â”Š 69â”Š    chats(root, args, { currentUser }) {\n+â”Š   â”Š 70â”Š      if (!currentUser) return [];\n+â”Š   â”Š 71â”Š\n+â”Š   â”Š 72â”Š      return chats.filter(c => c.participants.includes(currentUser.id));\n â”Š 53â”Š 73â”Š    },\n â”Š 54â”Š 74â”Š\n-â”Š 55â”Š   â”Š    chat(root, { chatId }) {\n-â”Š 56â”Š   â”Š      return chats.find(c => c.id === chatId) || null;\n+â”Š   â”Š 75â”Š    chat(root, { chatId }, { currentUser }) {\n+â”Š   â”Š 76â”Š      if (!currentUser) return null;\n+â”Š   â”Š 77â”Š\n+â”Š   â”Š 78â”Š      const chat = chats.find(c => c.id === chatId);\n+â”Š   â”Š 79â”Š\n+â”Š   â”Š 80â”Š      if (!chat) return null;\n+â”Š   â”Š 81â”Š\n+â”Š   â”Š 82â”Š      return chat.participants.includes(currentUser.id) ? chat : null;\n â”Š 57â”Š 83â”Š    },\n â”Š 58â”Š 84â”Š  },\n â”Š 59â”Š 85â”Š\n â”Š 60â”Š 86â”Š  Mutation: {\n-â”Š 61â”Š   â”Š    addMessage(root, { chatId, content }, { pubsub }) {\n+â”Š   â”Š 87â”Š    addMessage(root, { chatId, content }, { currentUser, pubsub }) {\n+â”Š   â”Š 88â”Š      if (!currentUser) return null;\n+â”Š   â”Š 89â”Š\n â”Š 62â”Š 90â”Š      const chatIndex = chats.findIndex(c => c.id === chatId);\n â”Š 63â”Š 91â”Š\n â”Š 64â”Š 92â”Š      if (chatIndex === -1) return null;\n â”Š 65â”Š 93â”Š\n â”Š 66â”Š 94â”Š      const chat = chats[chatIndex];\n+â”Š   â”Š 95â”Š      if (!chat.participants.includes(currentUser.id)) return null;\n â”Š 67â”Š 96â”Š\n â”Š 68â”Š 97â”Š      const messagesIds = messages.map(currentMessage => Number(currentMessage.id));\n â”Š 69â”Š 98â”Š      const messageId = String(Math.max(...messagesIds) + 1);\n â”Š 70â”Š 99â”Š      const message: Message = {\n â”Š 71â”Š100â”Š        id: messageId,\n â”Š 72â”Š101â”Š        createdAt: new Date(),\n-â”Š 73â”Š   â”Š        sender: '', // TODO: Fill-in\n-â”Š 74â”Š   â”Š        recipient: '', // TODO: Fill-in\n+â”Š   â”Š102â”Š        sender: currentUser.id,\n+â”Š   â”Š103â”Š        recipient: chat.participants.find(p => p !== currentUser.id) as string,\n â”Š 75â”Š104â”Š        content,\n â”Š 76â”Š105â”Š      };\n â”Š 77â”Š106â”Š\n```\n\n##### Changed tests&#x2F;mutations&#x2F;addMessage.test.ts\n```diff\n@@ -1,7 +1,7 @@\n â”Š1â”Š1â”Šimport { createTestClient } from 'apollo-server-testing';\n â”Š2â”Š2â”Šimport { ApolloServer, PubSub, gql } from 'apollo-server-express';\n â”Š3â”Š3â”Šimport schema from '../../schema';\n-â”Š4â”Š â”Šimport { resetDb } from '../../db';\n+â”Š â”Š4â”Šimport { resetDb, users } from '../../db';\n â”Š5â”Š5â”Š\n â”Š6â”Š6â”Šdescribe('Mutation.addMessage', () => {\n â”Š7â”Š7â”Š  beforeEach(resetDb);\n```\n```diff\n@@ -9,7 +9,10 @@\n â”Š 9â”Š 9â”Š  it('should add message to specified chat', async () => {\n â”Š10â”Š10â”Š    const server = new ApolloServer({\n â”Š11â”Š11â”Š      schema,\n-â”Š12â”Š  â”Š      context: () => ({ pubsub: new PubSub() }),\n+â”Š  â”Š12â”Š      context: () => ({\n+â”Š  â”Š13â”Š        pubsub: new PubSub(),\n+â”Š  â”Š14â”Š        currentUser: users[0],\n+â”Š  â”Š15â”Š      }),\n â”Š13â”Š16â”Š    });\n â”Š14â”Š17â”Š\n â”Š15â”Š18â”Š    const { query, mutate } = createTestClient(server);\n```\n\n##### Changed tests&#x2F;queries&#x2F;getChat.test.ts\n```diff\n@@ -1,10 +1,16 @@\n â”Š 1â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n â”Š 2â”Š 2â”Šimport { ApolloServer, gql } from 'apollo-server-express';\n â”Š 3â”Š 3â”Šimport schema from '../../schema';\n+â”Š  â”Š 4â”Šimport { users } from '../../db';\n â”Š 4â”Š 5â”Š\n â”Š 5â”Š 6â”Šdescribe('Query.chat', () => {\n â”Š 6â”Š 7â”Š  it('should fetch specified chat', async () => {\n-â”Š 7â”Š  â”Š    const server = new ApolloServer({ schema });\n+â”Š  â”Š 8â”Š    const server = new ApolloServer({\n+â”Š  â”Š 9â”Š      schema,\n+â”Š  â”Š10â”Š      context: () => ({\n+â”Š  â”Š11â”Š        currentUser: users[0],\n+â”Š  â”Š12â”Š      }),\n+â”Š  â”Š13â”Š    });\n â”Š 8â”Š14â”Š\n â”Š 9â”Š15â”Š    const { query } = createTestClient(server);\n â”Š10â”Š16â”Š\n```\n\n##### Changed tests&#x2F;queries&#x2F;getChats.test.ts\n```diff\n@@ -1,10 +1,16 @@\n â”Š 1â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n â”Š 2â”Š 2â”Šimport { ApolloServer, gql } from 'apollo-server-express';\n â”Š 3â”Š 3â”Šimport schema from '../../schema';\n+â”Š  â”Š 4â”Šimport { users } from '../../db';\n â”Š 4â”Š 5â”Š\n â”Š 5â”Š 6â”Šdescribe('Query.chats', () => {\n â”Š 6â”Š 7â”Š  it('should fetch all chats', async () => {\n-â”Š 7â”Š  â”Š    const server = new ApolloServer({ schema });\n+â”Š  â”Š 8â”Š    const server = new ApolloServer({\n+â”Š  â”Š 9â”Š      schema,\n+â”Š  â”Š10â”Š      context: () => ({\n+â”Š  â”Š11â”Š        currentUser: users[0],\n+â”Š  â”Š12â”Š      }),\n+â”Š  â”Š13â”Š    });\n â”Š 8â”Š14â”Š\n â”Š 9â”Š15â”Š    const { query } = createTestClient(server);\n```\n\n[}]: #\n\nNow if we will get back to the app and refresh the page, we should see a new chats list which is only relevant to Ray Edwards.\nEarlier in this chapter, we've defined a new `isMine` field on the `Message` type.\nThis field is useful because now we can differentiate between messages that are mine and messages that belong to the recipient.\nWe can use that information to distinct between messages in our UI.\n\nBut we should also take into account the current user when we publish real-time subscription events.\n\nWe will check if there is a logged in user and if the users is part of the actual conversation before we publish:\n\n[{]: <helper> (diffStep 8.3 module=\"server\")\n\n#### [__Server__ Step 8.3: Resolve subscriptions in relation to current user](https://github.com/Urigo/WhatsApp-Clone-Server/commit/8f6f98fb992b1440064d439aa2e67920c77d463b)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,3 +1,4 @@\n+â”Š â”Š1â”Šimport { withFilter } from 'apollo-server-express';\n â”Š1â”Š2â”Šimport { GraphQLDateTime } from 'graphql-iso-date';\n â”Š2â”Š3â”Šimport { User, Message, chats, messages, users } from '../db';\n â”Š3â”Š4â”Šimport { Resolvers } from '../types/graphql';\n```\n```diff\n@@ -120,8 +121,16 @@\n â”Š120â”Š121â”Š\n â”Š121â”Š122â”Š  Subscription: {\n â”Š122â”Š123â”Š    messageAdded: {\n-â”Š123â”Š   â”Š      subscribe: (root, args, { pubsub }) =>\n-â”Š124â”Š   â”Š        pubsub.asyncIterator('messageAdded'),\n+â”Š   â”Š124â”Š      subscribe: withFilter(\n+â”Š   â”Š125â”Š        (root, args, { pubsub }) => pubsub.asyncIterator('messageAdded'),\n+â”Š   â”Š126â”Š        ({ messageAdded }, args, { currentUser }) => {\n+â”Š   â”Š127â”Š          if (!currentUser) return false;\n+â”Š   â”Š128â”Š\n+â”Š   â”Š129â”Š          return [messageAdded.sender, messageAdded.recipient].includes(\n+â”Š   â”Š130â”Š            currentUser.id\n+â”Š   â”Š131â”Š          );\n+â”Š   â”Š132â”Š        }\n+â”Š   â”Š133â”Š      ),\n â”Š125â”Š134â”Š    },\n â”Š126â”Š135â”Š  },\n â”Š127â”Š136â”Š};\n```\n\n[}]: #\n\nLet's first download a new image that will help us achieve the new style and save it under the [`src/public/assets/message-yours.png`](https://github.com/Urigo/WhatsApp-Clone-Client-React/blob/cordova/public/assets/message-other.png?raw=true) path. Then let's implement the new style:\n\n[{]: <helper> (diffStep 11.1 files=\"src/components\" module=\"client\")\n\n#### [__Client__ Step 11.1: Distinguish messages](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/6d57701097760d246daf3b8bee4be5da8947d75a)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;MessagesList.tsx\n```diff\n@@ -2,7 +2,7 @@\n â”Š2â”Š2â”Šimport React from 'react';\n â”Š3â”Š3â”Šimport { useEffect, useRef } from 'react';\n â”Š4â”Š4â”Šimport ReactDOM from 'react-dom';\n-â”Š5â”Š â”Šimport styled from 'styled-components';\n+â”Š â”Š5â”Šimport styled, { css } from 'styled-components';\n â”Š6â”Š6â”Š\n â”Š7â”Š7â”Šconst Container = styled.div`\n â”Š8â”Š8â”Š  display: block;\n```\n```diff\n@@ -11,9 +11,11 @@\n â”Š11â”Š11â”Š  padding: 0 15px;\n â”Š12â”Š12â”Š`;\n â”Š13â”Š13â”Š\n+â”Š  â”Š14â”Štype StyledProp = {\n+â”Š  â”Š15â”Š  isMine: any;\n+â”Š  â”Š16â”Š};\n+â”Š  â”Š17â”Š\n â”Š14â”Š18â”Šconst MessageItem = styled.div`\n-â”Š15â”Š  â”Š  float: right;\n-â”Š16â”Š  â”Š  background-color: #dcf8c6;\n â”Š17â”Š19â”Š  display: inline-block;\n â”Š18â”Š20â”Š  position: relative;\n â”Š19â”Š21â”Š  max-width: 100%;\n```\n```diff\n@@ -30,17 +32,36 @@\n â”Š30â”Š32â”Š  }\n â”Š31â”Š33â”Š\n â”Š32â”Š34â”Š  &::before {\n-â”Š33â”Š  â”Š    background-image: url(/assets/message-mine.png);\n â”Š34â”Š35â”Š    content: '';\n â”Š35â”Š36â”Š    position: absolute;\n â”Š36â”Š37â”Š    bottom: 3px;\n â”Š37â”Š38â”Š    width: 12px;\n â”Š38â”Š39â”Š    height: 19px;\n-â”Š39â”Š  â”Š    right: -11px;\n â”Š40â”Š40â”Š    background-position: 50% 50%;\n â”Š41â”Š41â”Š    background-repeat: no-repeat;\n â”Š42â”Š42â”Š    background-size: contain;\n â”Š43â”Š43â”Š  }\n+â”Š  â”Š44â”Š\n+â”Š  â”Š45â”Š  ${(props: StyledProp) =>\n+â”Š  â”Š46â”Š    props.isMine\n+â”Š  â”Š47â”Š      ? css`\n+â”Š  â”Š48â”Š          float: right;\n+â”Š  â”Š49â”Š          background-color: #dcf8c6;\n+â”Š  â”Š50â”Š\n+â”Š  â”Š51â”Š          &::before {\n+â”Š  â”Š52â”Š            right: -11px;\n+â”Š  â”Š53â”Š            background-image: url(/assets/message-mine.png);\n+â”Š  â”Š54â”Š          }\n+â”Š  â”Š55â”Š        `\n+â”Š  â”Š56â”Š      : css`\n+â”Š  â”Š57â”Š          float: left;\n+â”Š  â”Š58â”Š          background-color: #fff;\n+â”Š  â”Š59â”Š\n+â”Š  â”Š60â”Š          &::before {\n+â”Š  â”Š61â”Š            left: -11px;\n+â”Š  â”Š62â”Š            background-image: url(/assets/message-other.png);\n+â”Š  â”Š63â”Š          }\n+â”Š  â”Š64â”Š        `}\n â”Š44â”Š65â”Š`;\n â”Š45â”Š66â”Š\n â”Š46â”Š67â”Šconst Contents = styled.div`\n```\n```diff\n@@ -75,7 +96,6 @@\n â”Š 75â”Š 96â”Š\n â”Š 76â”Š 97â”Š  useEffect(() => {\n â”Š 77â”Š 98â”Š    if (!selfRef.current) return;\n-â”Š 78â”Š   â”Š\n â”Š 79â”Š 99â”Š    const selfDOMNode = ReactDOM.findDOMNode(selfRef.current) as HTMLElement;\n â”Š 80â”Š100â”Š    selfDOMNode.scrollTop = Number.MAX_SAFE_INTEGER;\n â”Š 81â”Š101â”Š  }, [messages.length]);\n```\n```diff\n@@ -83,7 +103,10 @@\n â”Š 83â”Š103â”Š  return (\n â”Š 84â”Š104â”Š    <Container ref={selfRef}>\n â”Š 85â”Š105â”Š      {messages.map((message: any) => (\n-â”Š 86â”Š   â”Š        <MessageItem data-testid=\"message-item\" key={message.id}>\n+â”Š   â”Š106â”Š        <MessageItem\n+â”Š   â”Š107â”Š          data-testid=\"message-item\"\n+â”Š   â”Š108â”Š          isMine={message.isMine}\n+â”Š   â”Š109â”Š          key={message.id}>\n â”Š 87â”Š110â”Š          <Contents data-testid=\"message-content\">{message.content}</Contents>\n â”Š 88â”Š111â”Š          <Timestamp data-testid=\"message-date\">\n â”Š 89â”Š112â”Š            {moment(message.createdAt).format('HH:mm')}\n```\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -70,6 +70,7 @@\n â”Š70â”Š70â”Š              .toString(36)\n â”Š71â”Š71â”Š              .substr(2, 9),\n â”Š72â”Š72â”Š            createdAt: new Date(),\n+â”Š  â”Š73â”Š            isMine: true,\n â”Š73â”Š74â”Š            chat: {\n â”Š74â”Š75â”Š              __typename: 'Chat',\n â”Š75â”Š76â”Š              id: chatId,\n```\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.test.tsx\n```diff\n@@ -40,6 +40,7 @@\n â”Š40â”Š40â”Š                  id: 1,\n â”Š41â”Š41â”Š                  content: 'Hello',\n â”Š42â”Š42â”Š                  createdAt: new Date('1 Jan 2019 GMT'),\n+â”Š  â”Š43â”Š                  isMine: true,\n â”Š43â”Š44â”Š                  chat: {\n â”Š44â”Š45â”Š                    __typename: 'Chat',\n â”Š45â”Š46â”Š                    id: 1,\n```\n```diff\n@@ -90,6 +91,7 @@\n â”Š90â”Š91â”Š                  id: 1,\n â”Š91â”Š92â”Š                  content: 'Hello',\n â”Š92â”Š93â”Š                  createdAt: new Date('1 Jan 2019 GMT'),\n+â”Š  â”Š94â”Š                  isMine: true,\n â”Š93â”Š95â”Š                  chat: {\n â”Š94â”Š96â”Š                    __typename: 'Chat',\n â”Š95â”Š97â”Š                    id: 1,\n```\n\n[}]: #\n\n[{]: <helper> (diffStep 11.1 files=\"message.fragment.ts\" module=\"client\")\n\n#### [__Client__ Step 11.1: Distinguish messages](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/6d57701097760d246daf3b8bee4be5da8947d75a)\n\n##### Changed src&#x2F;graphql&#x2F;fragments&#x2F;message.fragment.ts\n```diff\n@@ -5,6 +5,7 @@\n â”Š 5â”Š 5â”Š    id\n â”Š 6â”Š 6â”Š    createdAt\n â”Š 7â”Š 7â”Š    content\n+â”Š  â”Š 8â”Š    isMine\n â”Š 8â”Š 9â”Š    chat {\n â”Š 9â”Š10â”Š      id\n â”Š10â”Š11â”Š    }\n```\n\n[}]: #\n\nThis is how the updated `ChatRoomScreen` should look like:\n\n\n\n![chat-room-screen](https://user-images.githubusercontent.com/7648874/55326701-face8700-54ba-11e9-877e-0b7dd71a1b68.png)\n\n\n\nWe can use a temporary solution to log-in and alternate between different users. This would be a good way to test data authorization without implementing an authentication mechanism. One way to know which user is logged in is via [cookies](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies).\n\nCookies are just text files which are stored locally on your computer and they contain key-value data maps. Cookies will be sent automatically by the browser with every HTTP request under the `Cookie` header. The header can be parsed and read by the server and this way inform it about the state of the client. Cookie values can also be set by the server by sending back a response which contain a `Set-Cookie` header. The browser will automatically write these cookies because of its specification and how it works.\n\nThis is how you can set cookies on the client:\n\n```js\ndocument.cookie = \"yummy_cookie=choco\"\ndocument.cookie = \"tasty_cookie=strawberry\"\n// logs \"yummy_cookie=choco; tasty_cookie=strawberry\"\n```\n\nAnd this is how further requests would look like:\n\n```\nGET /sample_page.html HTTP/2.0\nHost: www.example.org\nCookie: yummy_cookie=choco; tasty_cookie=strawberry\n```\n\nUsing this method we can set the current user's ID. Open your browser's dev-console, and type the following:\n\n```js\n// Ray Edwards\ndocument.cookie = 'currentUserId=1'\n```\n\nTo be able to send cookies with Apollo Client, we need to set the [`credentials`](https://www.apollographql.com/docs/react/recipes/authentication#cookie) option to \"include\" when creating the HTTP link:\n\n[{]: <helper> (diffStep 11.2 module=\"client\")\n\n#### [__Client__ Step 11.2: Support credentials](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/0646f718d6a37ea957ff6aa84ed88741d3b188d9)\n\n##### Changed src&#x2F;client.ts\n```diff\n@@ -10,6 +10,7 @@\n â”Š10â”Š10â”Š\n â”Š11â”Š11â”Šconst httpLink = new HttpLink({\n â”Š12â”Š12â”Š  uri: httpUri,\n+â”Š  â”Š13â”Š  credentials: 'include',\n â”Š13â”Š14â”Š});\n â”Š14â”Š15â”Š\n â”Š15â”Š16â”Šconst wsLink = new WebSocketLink({\n```\n\n[}]: #\n\nThis will set the [`Access-Control-Allow-Credentials`](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Credentials) header to â€œincludeâ€ with each HTTP request which is necessary when using the POST method. In correlation to that, we would need to configure the server to be able to receive and set cookies. This can be done via CORS options like so:\n\n[{]: <helper> (diffStep 8.4 files=\"index.ts\" module=\"server\")\n\n#### [__Server__ Step 8.4: Support credentials](https://github.com/Urigo/WhatsApp-Clone-Server/commit/6bdf8fb2e7a72f94f76a5645fbc6aa7fc9982079)\n\n##### Changed index.ts\n```diff\n@@ -7,7 +7,8 @@\n â”Š 7â”Š 7â”Š\n â”Š 8â”Š 8â”Šconst app = express();\n â”Š 9â”Š 9â”Š\n-â”Š10â”Š  â”Šapp.use(cors());\n+â”Š  â”Š10â”Šconst origin = process.env.ORIGIN || 'http://localhost:3000';\n+â”Š  â”Š11â”Šapp.use(cors({ credentials: true, origin }));\n â”Š11â”Š12â”Šapp.use(express.json());\n â”Š12â”Š13â”Š\n â”Š13â”Š14â”Šapp.get('/_ping', (req, res) => {\n```\n```diff\n@@ -26,6 +27,7 @@\n â”Š26â”Š27â”Šserver.applyMiddleware({\n â”Š27â”Š28â”Š  app,\n â”Š28â”Š29â”Š  path: '/graphql',\n+â”Š  â”Š30â”Š  cors: { credentials: true, origin },\n â”Š29â”Š31â”Š});\n â”Š30â”Š32â”Š\n â”Š31â”Š33â”Šconst httpServer = http.createServer(app);\n```\n\n[}]: #\n\nSo how exactly does one retrieve the values of the cookies? Like mentioned earlier, each and every request will have them set on the `cookie` header, so one way would be by reading the header directly, but a more convenient way would be using an Express middleware called [`cookie-parser`](https://www.npmjs.com/package/cookie-parser):\n\n    $ yarn add cookie-parser\n\n[{]: <helper> (diffStep 8.5 files=\"index.ts\" module=\"server\")\n\n#### [__Server__ Step 8.5: Use cookie parser](https://github.com/Urigo/WhatsApp-Clone-Server/commit/e8debe467fccef4b5a38694f2c3b2f96e1f1ea31)\n\n##### Changed index.ts\n```diff\n@@ -1,5 +1,6 @@\n â”Š1â”Š1â”Šimport { ApolloServer, gql, PubSub } from 'apollo-server-express';\n â”Š2â”Š2â”Šimport cors from 'cors';\n+â”Š â”Š3â”Šimport cookieParser from 'cookie-parser';\n â”Š3â”Š4â”Šimport express from 'express';\n â”Š4â”Š5â”Šimport http from 'http';\n â”Š5â”Š6â”Šimport { users } from './db';\n```\n```diff\n@@ -10,6 +11,7 @@\n â”Š10â”Š11â”Šconst origin = process.env.ORIGIN || 'http://localhost:3000';\n â”Š11â”Š12â”Šapp.use(cors({ credentials: true, origin }));\n â”Š12â”Š13â”Šapp.use(express.json());\n+â”Š  â”Š14â”Šapp.use(cookieParser());\n â”Š13â”Š15â”Š\n â”Š14â”Š16â”Šapp.get('/_ping', (req, res) => {\n â”Š15â”Š17â”Š  res.send('pong');\n```\n\n[}]: #\n\n`cookie-parser` will read the `Cookie` header, it will parse it into a JSON and will define it on `req.cookies`. Since weâ€™re using Apollo-Server with Express, the `req` object should be accessible as the first argument in the `context` function. This means that we can use the `currentUserId` from the cookies to fetch the current user from our users collection and define it on the context object:\n\n[{]: <helper> (diffStep 8.6 module=\"server\")\n\n#### [__Server__ Step 8.6: Define current user based on cookies](https://github.com/Urigo/WhatsApp-Clone-Server/commit/fe595067819160a2fa31aa5ad78fd58ecbcf40c0)\n\n##### Changed index.ts\n```diff\n@@ -1,6 +1,7 @@\n â”Š1â”Š1â”Šimport { ApolloServer, gql, PubSub } from 'apollo-server-express';\n â”Š2â”Š2â”Šimport cors from 'cors';\n â”Š3â”Š3â”Šimport cookieParser from 'cookie-parser';\n+â”Š â”Š4â”Šimport cookie from 'cookie';\n â”Š4â”Š5â”Šimport express from 'express';\n â”Š5â”Š6â”Šimport http from 'http';\n â”Š6â”Š7â”Šimport { users } from './db';\n```\n```diff\n@@ -20,10 +21,30 @@\n â”Š20â”Š21â”Šconst pubsub = new PubSub();\n â”Š21â”Š22â”Šconst server = new ApolloServer({\n â”Š22â”Š23â”Š  schema,\n-â”Š23â”Š  â”Š  context: () => ({\n-â”Š24â”Š  â”Š    currentUser: users.find(u => u.id === '1'),\n-â”Š25â”Š  â”Š    pubsub,\n-â”Š26â”Š  â”Š  }),\n+â”Š  â”Š24â”Š  context: (session: any) => {\n+â”Š  â”Š25â”Š    // Access the request object\n+â”Š  â”Š26â”Š    let req = session.connection\n+â”Š  â”Š27â”Š      ? session.connection.context.request\n+â”Š  â”Š28â”Š      : session.req;\n+â”Š  â”Š29â”Š\n+â”Š  â”Š30â”Š    // It's subscription\n+â”Š  â”Š31â”Š    if (session.connection) {\n+â”Š  â”Š32â”Š      req.cookies = cookie.parse(req.headers.cookie || '');\n+â”Š  â”Š33â”Š    }\n+â”Š  â”Š34â”Š\n+â”Š  â”Š35â”Š    return {\n+â”Š  â”Š36â”Š      currentUser: users.find(u => u.id === req.cookies.currentUserId),\n+â”Š  â”Š37â”Š      pubsub,\n+â”Š  â”Š38â”Š    };\n+â”Š  â”Š39â”Š  },\n+â”Š  â”Š40â”Š  subscriptions: {\n+â”Š  â”Š41â”Š    onConnect(params, ws, ctx) {\n+â”Š  â”Š42â”Š      // pass the request object to context\n+â”Š  â”Š43â”Š      return {\n+â”Š  â”Š44â”Š        request: ctx.request,\n+â”Š  â”Š45â”Š      };\n+â”Š  â”Š46â”Š    },\n+â”Š  â”Š47â”Š  },\n â”Š27â”Š48â”Š});\n â”Š28â”Š49â”Š\n â”Š29â”Š50â”Šserver.applyMiddleware({\n```\n\n##### Changed package.json\n```diff\n@@ -21,6 +21,7 @@\n â”Š21â”Š21â”Š    \"@graphql-codegen/typescript\": \"1.5.0\",\n â”Š22â”Š22â”Š    \"@graphql-codegen/typescript-resolvers\": \"1.5.0\",\n â”Š23â”Š23â”Š    \"@types/cors\": \"2.8.5\",\n+â”Š  â”Š24â”Š    \"@types/cookie\": \"0.3.3\",\n â”Š24â”Š25â”Š    \"@types/cookie-parser\": \"1.4.1\",\n â”Š25â”Š26â”Š    \"@types/express\": \"4.17.0\",\n â”Š26â”Š27â”Š    \"@types/graphql\": \"14.2.3\",\n```\n```diff\n@@ -37,6 +38,7 @@\n â”Š37â”Š38â”Š  \"dependencies\": {\n â”Š38â”Š39â”Š    \"apollo-server-express\": \"2.8.1\",\n â”Š39â”Š40â”Š    \"apollo-server-testing\": \"2.8.1\",\n+â”Š  â”Š41â”Š    \"cookie\": \"0.4.0\",\n â”Š40â”Š42â”Š    \"cors\": \"2.8.5\",\n â”Š41â”Š43â”Š    \"cookie-parser\": \"1.4.4\",\n â”Š42â”Š44â”Š    \"express\": \"4.17.1\",\n```\n\n[}]: #\n\nNow you can go ahead and change the value of the `currentUserId` cookie and see how it affects the view anytime you refresh the page. Needless to say that this is not the most convenient way to switch between users, so weâ€™re gonna implement a dedicated screen that will set the cookies for us.\n\nAll the auth related logic should go into a dedicated service since it can serve us vastly across the application, not just for a single component. Thus we will create a new service called `auth.service`, which will contain 3 basic functions for now: `signIn()`, `signOut()` and `isSignedIn():\n\n[{]: <helper> (diffStep 11.3 module=\"client\")\n\n#### [__Client__ Step 11.3: Add basic auth.service](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/ab63a19ab7bb0627fda06d72ad8daa01678e74b2)\n\n##### Added src&#x2F;services&#x2F;auth.service.tsx\n```diff\n@@ -0,0 +1,26 @@\n+â”Š  â”Š 1â”Šimport { useCallback } from 'react'\n+â”Š  â”Š 2â”Šimport { useApolloClient } from '@apollo/react-hooks'\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šexport const signIn = (currentUserId: string) => {\n+â”Š  â”Š 5â”Š  document.cookie = `currentUserId=${currentUserId}`;\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Š  // This will become async in the near future\n+â”Š  â”Š 8â”Š  return Promise.resolve();\n+â”Š  â”Š 9â”Š};\n+â”Š  â”Š10â”Š\n+â”Š  â”Š11â”Šexport const useSignOut = () => {\n+â”Š  â”Š12â”Š  const client = useApolloClient()\n+â”Š  â”Š13â”Š\n+â”Š  â”Š14â”Š  return useCallback(() => {\n+â”Š  â”Š15â”Š    // \"expires\" represents the lifespan of a cookie. Beyond that date the cookie will\n+â”Š  â”Š16â”Š    // be deleted by the browser. \"expires\" cannot be viewed from \"document.cookie\"\n+â”Š  â”Š17â”Š    document.cookie = `currentUserId=;expires=${new Date(0)}`;\n+â”Š  â”Š18â”Š\n+â”Š  â”Š19â”Š    // Clear cache\n+â”Š  â”Š20â”Š    return client.clearStore();\n+â”Š  â”Š21â”Š  }, [client])\n+â”Š  â”Š22â”Š};\n+â”Š  â”Š23â”Š\n+â”Š  â”Š24â”Šexport const isSignedIn = () => {\n+â”Š  â”Š25â”Š  return /currentUserId=.+(;|$)/.test(document.cookie);\n+â”Š  â”Š26â”Š};\n```\n\n[}]: #\n\nNow we will implement the `AuthScreen`. For now this screen should be fairly simple. It should contain a single `TextField` to specify the current user ID, and a `sign-in` button that will call the `signIn()` method with the specified ID. Once it does so, we will be proceeded to the `ChatsListScreen`. First we will download and save the following assets:\n\n- [`src/public/assets/whatsapp-icon.ping`](https://github.com/Urigo/WhatsApp-Clone-Client-React/raw/wip/cookie-auth/public/assets/whatsapp-icon.png)\n\n[{]: <helper> (diffStep 11.4 files=\"components\" module=\"client\")\n\n#### [__Client__ Step 11.4: Add AuthScreen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/26cbaea70ae2345e1c4da3071791df5c5ebd81ff)\n\n##### Added src&#x2F;components&#x2F;AuthScreen&#x2F;index.tsx\n```diff\n@@ -0,0 +1,167 @@\n+â”Š   â”Š  1â”Šimport MaterialButton from '@material-ui/core/Button';\n+â”Š   â”Š  2â”Šimport MaterialTextField from '@material-ui/core/TextField';\n+â”Š   â”Š  3â”Šimport React from 'react';\n+â”Š   â”Š  4â”Šimport { useCallback, useState } from 'react';\n+â”Š   â”Š  5â”Šimport styled from 'styled-components';\n+â”Š   â”Š  6â”Šimport { signIn } from '../../services/auth.service';\n+â”Š   â”Š  7â”Šimport { RouteComponentProps } from 'react-router-dom';\n+â”Š   â”Š  8â”Š\n+â”Š   â”Š  9â”Šconst Container = styled.div`\n+â”Š   â”Š 10â”Š  height: 100%;\n+â”Š   â”Š 11â”Š  background: radial-gradient(rgb(34, 65, 67), rgb(17, 48, 50)),\n+â”Š   â”Š 12â”Š    url(/assets/chat-background.jpg) no-repeat;\n+â”Š   â”Š 13â”Š  background-size: cover;\n+â”Š   â”Š 14â”Š  background-blend-mode: multiply;\n+â”Š   â”Š 15â”Š  color: white;\n+â”Š   â”Š 16â”Š`;\n+â”Š   â”Š 17â”Š\n+â”Š   â”Š 18â”Šconst Intro = styled.div`\n+â”Š   â”Š 19â”Š  height: 265px;\n+â”Š   â”Š 20â”Š`;\n+â”Š   â”Š 21â”Š\n+â”Š   â”Š 22â”Šconst Icon = styled.img`\n+â”Š   â”Š 23â”Š  width: 125px;\n+â”Š   â”Š 24â”Š  height: auto;\n+â”Š   â”Š 25â”Š  margin-left: auto;\n+â”Š   â”Š 26â”Š  margin-right: auto;\n+â”Š   â”Š 27â”Š  padding-top: 70px;\n+â”Š   â”Š 28â”Š  display: block;\n+â”Š   â”Š 29â”Š`;\n+â”Š   â”Š 30â”Š\n+â”Š   â”Š 31â”Šconst Title = styled.h2`\n+â”Š   â”Š 32â”Š  width: 100%;\n+â”Š   â”Š 33â”Š  text-align: center;\n+â”Š   â”Š 34â”Š  color: white;\n+â”Š   â”Š 35â”Š`;\n+â”Š   â”Š 36â”Š\n+â”Š   â”Š 37â”Š// eslint-disable-next-line\n+â”Š   â”Š 38â”Šconst Alternative = styled.div`\n+â”Š   â”Š 39â”Š  position: fixed;\n+â”Š   â”Š 40â”Š  bottom: 10px;\n+â”Š   â”Š 41â”Š  left: 10px;\n+â”Š   â”Š 42â”Š\n+â”Š   â”Š 43â”Š  a {\n+â”Š   â”Š 44â”Š    color: var(--secondary-bg);\n+â”Š   â”Š 45â”Š  }\n+â”Š   â”Š 46â”Š`;\n+â”Š   â”Š 47â”Š\n+â”Š   â”Š 48â”Šconst SignInForm = styled.div`\n+â”Š   â”Š 49â”Š  height: calc(100% - 265px);\n+â”Š   â”Š 50â”Š`;\n+â”Š   â”Š 51â”Š\n+â”Š   â”Š 52â”Šconst ActualForm = styled.form`\n+â”Š   â”Š 53â”Š  padding: 20px;\n+â”Š   â”Š 54â”Š`;\n+â”Š   â”Š 55â”Š\n+â”Š   â”Š 56â”Šconst Section = styled.div`\n+â”Š   â”Š 57â”Š  width: 100%;\n+â”Š   â”Š 58â”Š  padding-bottom: 35px;\n+â”Š   â”Š 59â”Š`;\n+â”Š   â”Š 60â”Š\n+â”Š   â”Š 61â”Šconst Legend = styled.legend`\n+â”Š   â”Š 62â”Š  font-weight: bold;\n+â”Š   â”Š 63â”Š  color: white;\n+â”Š   â”Š 64â”Š`;\n+â”Š   â”Š 65â”Š\n+â”Š   â”Š 66â”Š// eslint-disable-next-line\n+â”Š   â”Š 67â”Šconst Label = styled.label`\n+â”Š   â”Š 68â”Š  color: white !important;\n+â”Š   â”Š 69â”Š`;\n+â”Š   â”Š 70â”Š\n+â”Š   â”Š 71â”Š// eslint-disable-next-line\n+â”Š   â”Š 72â”Šconst Input = styled.input`\n+â”Š   â”Š 73â”Š  color: white;\n+â”Š   â”Š 74â”Š\n+â”Š   â”Š 75â”Š  &::placeholder {\n+â”Š   â”Š 76â”Š    color: var(--primary-bg);\n+â”Š   â”Š 77â”Š  }\n+â”Š   â”Š 78â”Š`;\n+â”Š   â”Š 79â”Š\n+â”Š   â”Š 80â”Šconst TextField = styled(MaterialTextField)`\n+â”Š   â”Š 81â”Š  width: 100%;\n+â”Š   â”Š 82â”Š  position: relative;\n+â”Š   â”Š 83â”Š\n+â”Š   â”Š 84â”Š  > div::before {\n+â”Š   â”Š 85â”Š    border-color: white !important;\n+â”Š   â”Š 86â”Š  }\n+â”Š   â”Š 87â”Š\n+â”Š   â”Š 88â”Š  input {\n+â”Š   â”Š 89â”Š    color: white !important;\n+â”Š   â”Š 90â”Š\n+â”Š   â”Š 91â”Š    &::placeholder {\n+â”Š   â”Š 92â”Š      color: var(--primary-bg) !important;\n+â”Š   â”Š 93â”Š    }\n+â”Š   â”Š 94â”Š  }\n+â”Š   â”Š 95â”Š\n+â”Š   â”Š 96â”Š  label {\n+â”Š   â”Š 97â”Š    color: white !important;\n+â”Š   â”Š 98â”Š  }\n+â”Š   â”Š 99â”Š`;\n+â”Š   â”Š100â”Š\n+â”Š   â”Š101â”Šconst Button = styled(MaterialButton)`\n+â”Š   â”Š102â”Š  width: 100px;\n+â”Š   â”Š103â”Š  display: block !important;\n+â”Š   â”Š104â”Š  margin: auto !important;\n+â”Š   â”Š105â”Š  background-color: var(--secondary-bg) !important;\n+â”Š   â”Š106â”Š\n+â”Š   â”Š107â”Š  &[disabled] {\n+â”Š   â”Š108â”Š    color: #38a81c;\n+â”Š   â”Š109â”Š  }\n+â”Š   â”Š110â”Š\n+â”Š   â”Š111â”Š  &:not([disabled]) {\n+â”Š   â”Š112â”Š    color: white;\n+â”Š   â”Š113â”Š  }\n+â”Š   â”Š114â”Š`;\n+â”Š   â”Š115â”Š\n+â”Š   â”Š116â”Šconst AuthScreen: React.FC<RouteComponentProps<any>> = ({ history }) => {\n+â”Š   â”Š117â”Š  const [userId, setUserId] = useState('');\n+â”Š   â”Š118â”Š\n+â”Š   â”Š119â”Š  const onUserIdChange = useCallback(({ target }) => {\n+â”Š   â”Š120â”Š    setUserId(target.value);\n+â”Š   â”Š121â”Š  }, []);\n+â”Š   â”Š122â”Š\n+â”Š   â”Š123â”Š  const maySignIn = useCallback(() => {\n+â”Š   â”Š124â”Š    return !!userId;\n+â”Š   â”Š125â”Š  }, [userId]);\n+â”Š   â”Š126â”Š\n+â”Š   â”Š127â”Š  const handleSignIn = useCallback(() => {\n+â”Š   â”Š128â”Š    signIn(userId).then(() => {\n+â”Š   â”Š129â”Š      history.replace('/chats');\n+â”Š   â”Š130â”Š    });\n+â”Š   â”Š131â”Š  }, [userId, history]);\n+â”Š   â”Š132â”Š\n+â”Š   â”Š133â”Š  return (\n+â”Š   â”Š134â”Š    <Container>\n+â”Š   â”Š135â”Š      <Intro>\n+â”Š   â”Š136â”Š        <Icon src=\"assets/whatsapp-icon.png\" className=\"AuthScreen-icon\" />\n+â”Š   â”Š137â”Š        <Title className=\"AuthScreen-title\">WhatsApp</Title>\n+â”Š   â”Š138â”Š      </Intro>\n+â”Š   â”Š139â”Š      <SignInForm>\n+â”Š   â”Š140â”Š        <ActualForm>\n+â”Š   â”Š141â”Š          <Legend>Sign in</Legend>\n+â”Š   â”Š142â”Š          <Section>\n+â”Š   â”Š143â”Š            <TextField\n+â”Š   â”Š144â”Š              data-testid=\"user-id-input\"\n+â”Š   â”Š145â”Š              label=\"User ID\"\n+â”Š   â”Š146â”Š              value={userId}\n+â”Š   â”Š147â”Š              onChange={onUserIdChange}\n+â”Š   â”Š148â”Š              margin=\"normal\"\n+â”Š   â”Š149â”Š              placeholder=\"Enter current user ID\"\n+â”Š   â”Š150â”Š            />\n+â”Š   â”Š151â”Š          </Section>\n+â”Š   â”Š152â”Š          <Button\n+â”Š   â”Š153â”Š            data-testid=\"sign-in-button\"\n+â”Š   â”Š154â”Š            type=\"button\"\n+â”Š   â”Š155â”Š            color=\"secondary\"\n+â”Š   â”Š156â”Š            variant=\"contained\"\n+â”Š   â”Š157â”Š            disabled={!maySignIn()}\n+â”Š   â”Š158â”Š            onClick={handleSignIn}>\n+â”Š   â”Š159â”Š            Sign in\n+â”Š   â”Š160â”Š          </Button>\n+â”Š   â”Š161â”Š        </ActualForm>\n+â”Š   â”Š162â”Š      </SignInForm>\n+â”Š   â”Š163â”Š    </Container>\n+â”Š   â”Š164â”Š  );\n+â”Š   â”Š165â”Š};\n+â”Š   â”Š166â”Š\n+â”Š   â”Š167â”Šexport default AuthScreen;\n```\n\n[}]: #\n\nAccordingly we will define a new `/sign-in` route that will render the `AuthScreen` weâ€™re under that path name:\n\n[{]: <helper> (diffStep 11.4 files=\"App\" module=\"client\")\n\n#### [__Client__ Step 11.4: Add AuthScreen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/26cbaea70ae2345e1c4da3071791df5c5ebd81ff)\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -5,6 +5,7 @@\n â”Š 5â”Š 5â”Š  Redirect,\n â”Š 6â”Š 6â”Š  RouteComponentProps,\n â”Š 7â”Š 7â”Š} from 'react-router-dom';\n+â”Š  â”Š 8â”Šimport AuthScreen from './components/AuthScreen';\n â”Š 8â”Š 9â”Šimport ChatRoomScreen from './components/ChatRoomScreen';\n â”Š 9â”Š10â”Šimport ChatsListScreen from './components/ChatsListScreen';\n â”Š10â”Š11â”Šimport AnimatedSwitch from './components/AnimatedSwitch';\n```\n```diff\n@@ -16,6 +17,7 @@\n â”Š16â”Š17â”Š  return (\n â”Š17â”Š18â”Š    <BrowserRouter>\n â”Š18â”Š19â”Š      <AnimatedSwitch>\n+â”Š  â”Š20â”Š        <Route exact path=\"/sign-(in|up)\" component={AuthScreen} />\n â”Š19â”Š21â”Š        <Route exact path=\"/chats\" component={ChatsListScreen} />\n â”Š20â”Š22â”Š\n â”Š21â”Š23â”Š        <Route\n```\n\n[}]: #\n\nThis is how the new screen should look like:\n\n![auth-screen](https://user-images.githubusercontent.com/7648874/55606715-7a56a180-57ac-11e9-8eea-2da5931cccf5.png)\n\nNow letâ€™s type the `/sign-in` route in our browserâ€™s navigation bar and assign a user ID, see how it affects what chats we see in the `ChatsListScreen`. Youâ€™ve probably noticed that thereâ€™s no way to escape from the `/chats` route unless we edit the browserâ€™s navigation bar manually. To fix that, we will add a new sign-out button to the navbar of the `ChatsListScreen` that will call the `signOut()` method anytime we click on it, and will bring us back to the `AuthScreen`:\n\n[{]: <helper> (diffStep 11.5 module=\"client\")\n\n#### [__Client__ Step 11.5: Add sign-out button that ChatsNavbar](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/9435aa54a0db9c1418f4ba00592ac75e4c864bc6)\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsNavbar.tsx\n```diff\n@@ -1,14 +1,48 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n-â”Š 2â”Š  â”Šimport { Toolbar } from '@material-ui/core';\n+â”Š  â”Š 2â”Šimport { Button, Toolbar } from '@material-ui/core';\n â”Š 3â”Š 3â”Šimport styled from 'styled-components';\n+â”Š  â”Š 4â”Šimport SignOutIcon from '@material-ui/icons/PowerSettingsNew';\n+â”Š  â”Š 5â”Šimport { useCallback } from 'react';\n+â”Š  â”Š 6â”Šimport { useSignOut } from '../../services/auth.service';\n+â”Š  â”Š 7â”Šimport { History } from 'history';\n â”Š 4â”Š 8â”Š\n â”Š 5â”Š 9â”Šconst Container = styled(Toolbar)`\n+â”Š  â”Š10â”Š  display: flex;\n â”Š 6â”Š11â”Š  background-color: var(--primary-bg);\n â”Š 7â”Š12â”Š  color: var(--primary-text);\n â”Š 8â”Š13â”Š  font-size: 20px;\n â”Š 9â”Š14â”Š  line-height: 40px;\n â”Š10â”Š15â”Š`;\n â”Š11â”Š16â”Š\n-â”Š12â”Š  â”Šconst ChatsNavbar: React.FC = () => <Container>Whatsapp Clone</Container>;\n+â”Š  â”Š17â”Šconst Title = styled.div`\n+â”Š  â”Š18â”Š  flex: 1;\n+â”Š  â”Š19â”Š`;\n+â”Š  â”Š20â”Š\n+â”Š  â”Š21â”Šconst LogoutButton = styled(Button)`\n+â”Š  â”Š22â”Š  color: var(--primary-text) !important;\n+â”Š  â”Š23â”Š`;\n+â”Š  â”Š24â”Š\n+â”Š  â”Š25â”Šinterface ChildComponentProps {\n+â”Š  â”Š26â”Š  history: History;\n+â”Š  â”Š27â”Š}\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Šconst ChatsNavbar: React.FC<ChildComponentProps> = ({ history }) => {\n+â”Š  â”Š30â”Š  const signOut = useSignOut();\n+â”Š  â”Š31â”Š\n+â”Š  â”Š32â”Š  const handleSignOut = useCallback(() => {\n+â”Š  â”Š33â”Š    signOut().then(() => {\n+â”Š  â”Š34â”Š      history.replace('/sign-in');\n+â”Š  â”Š35â”Š    });\n+â”Š  â”Š36â”Š  }, [history, signOut]);\n+â”Š  â”Š37â”Š\n+â”Š  â”Š38â”Š  return (\n+â”Š  â”Š39â”Š    <Container>\n+â”Š  â”Š40â”Š      <Title>Whatsapp Clone</Title>\n+â”Š  â”Š41â”Š      <LogoutButton data-testid=\"sign-out-button\" onClick={handleSignOut}>\n+â”Š  â”Š42â”Š        <SignOutIcon />\n+â”Š  â”Š43â”Š      </LogoutButton>\n+â”Š  â”Š44â”Š    </Container>\n+â”Š  â”Š45â”Š  );\n+â”Š  â”Š46â”Š};\n â”Š13â”Š47â”Š\n â”Š14â”Š48â”Šexport default ChatsNavbar;\n```\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;index.tsx\n```diff\n@@ -14,7 +14,7 @@\n â”Š14â”Š14â”Š\n â”Š15â”Š15â”Šconst ChatsListScreen: React.FC<ChatsListScreenProps> = ({ history }) => (\n â”Š16â”Š16â”Š  <Container>\n-â”Š17â”Š  â”Š    <ChatsNavbar />\n+â”Š  â”Š17â”Š    <ChatsNavbar history={history} />\n â”Š18â”Š18â”Š    <ChatsList history={history} />\n â”Š19â”Š19â”Š  </Container>\n â”Š20â”Š20â”Š);\n```\n\n[}]: #\n\nAt this point weâ€™ve got everything we need, but we will add a small touch to improve the user experience and make it feel more complete. Users who arenâ€™t logged in shouldnâ€™t be able to view any screen besides the `AuthScreen`. First they need to sign-in, and only then they will be able to view the `ChatsListScreen` and `ChatRoomScreen`. To achieve that, we will wrap all the components which require authentication before we provide them into their routes. This wrap will basically check whether a user is logged in or not by reading the cookies, and if not we will be redirected to the `/sign-in` route. Letâ€™s implement that wrap in the `auth.service` and call it `withAuth()`:\n\n[{]: <helper> (diffStep 11.6 files=\"auth.service\" module=\"client\")\n\n#### [__Client__ Step 11.6: Add withAuth() route wrapper](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/60092a09735d759558b047d511916af6a63d934c)\n\n##### Changed src&#x2F;services&#x2F;auth.service.tsx\n```diff\n@@ -1,5 +1,26 @@\n-â”Š 1â”Š  â”Šimport { useCallback } from 'react'\n-â”Š 2â”Š  â”Šimport { useApolloClient } from '@apollo/react-hooks'\n+â”Š  â”Š 1â”Šimport React from 'react';\n+â”Š  â”Š 2â”Šimport { useCallback } from 'react';\n+â”Š  â”Š 3â”Šimport { useApolloClient } from '@apollo/react-hooks';\n+â”Š  â”Š 4â”Šimport { Redirect } from 'react-router-dom';\n+â”Š  â”Š 5â”Šimport { useCacheService } from './cache.service';\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Šexport const withAuth = <P extends object>(\n+â”Š  â”Š 8â”Š  Component: React.ComponentType<P>\n+â”Š  â”Š 9â”Š) => {\n+â”Š  â”Š10â”Š  return (props: any) => {\n+â”Š  â”Š11â”Š    if (!isSignedIn()) {\n+â”Š  â”Š12â”Š      if (props.history.location.pathname === '/sign-in') {\n+â”Š  â”Š13â”Š        return null;\n+â”Š  â”Š14â”Š      }\n+â”Š  â”Š15â”Š\n+â”Š  â”Š16â”Š      return <Redirect to=\"/sign-in\" />;\n+â”Š  â”Š17â”Š    }\n+â”Š  â”Š18â”Š\n+â”Š  â”Š19â”Š    useCacheService();\n+â”Š  â”Š20â”Š\n+â”Š  â”Š21â”Š    return <Component {...props as P} />;\n+â”Š  â”Š22â”Š  };\n+â”Š  â”Š23â”Š};\n â”Š 3â”Š24â”Š\n â”Š 4â”Š25â”Šexport const signIn = (currentUserId: string) => {\n â”Š 5â”Š26â”Š  document.cookie = `currentUserId=${currentUserId}`;\n```\n\n[}]: #\n\nWe will use this function to wrap the right components in our appâ€™s router. Note that since we used the `useCacheService()` directly in the `withAuth()` method, thereâ€™s no need to use it in the router itself anymore. This makes a lot more sense since thereâ€™s no need to stay subscribed to data that you're not gonna receive from the first place unless youâ€™re logged-in:\n\n[{]: <helper> (diffStep 11.6 files=\"App\" module=\"client\")\n\n#### [__Client__ Step 11.6: Add withAuth() route wrapper](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/60092a09735d759558b047d511916af6a63d934c)\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -9,32 +9,27 @@\n â”Š 9â”Š 9â”Šimport ChatRoomScreen from './components/ChatRoomScreen';\n â”Š10â”Š10â”Šimport ChatsListScreen from './components/ChatsListScreen';\n â”Š11â”Š11â”Šimport AnimatedSwitch from './components/AnimatedSwitch';\n-â”Š12â”Š  â”Šimport { useCacheService } from './services/cache.service';\n+â”Š  â”Š12â”Šimport { withAuth } from './services/auth.service';\n â”Š13â”Š13â”Š\n-â”Š14â”Š  â”Šconst App: React.FC = () => {\n-â”Š15â”Š  â”Š  useCacheService();\n+â”Š  â”Š14â”Šconst App: React.FC = () => (\n+â”Š  â”Š15â”Š  <BrowserRouter>\n+â”Š  â”Š16â”Š    <AnimatedSwitch>\n+â”Š  â”Š17â”Š      <Route exact path=\"/sign-(in|up)\" component={AuthScreen} />\n+â”Š  â”Š18â”Š      <Route exact path=\"/chats\" component={withAuth(ChatsListScreen)} />\n â”Š16â”Š19â”Š\n-â”Š17â”Š  â”Š  return (\n-â”Š18â”Š  â”Š    <BrowserRouter>\n-â”Š19â”Š  â”Š      <AnimatedSwitch>\n-â”Š20â”Š  â”Š        <Route exact path=\"/sign-(in|up)\" component={AuthScreen} />\n-â”Š21â”Š  â”Š        <Route exact path=\"/chats\" component={ChatsListScreen} />\n-â”Š22â”Š  â”Š\n-â”Š23â”Š  â”Š        <Route\n-â”Š24â”Š  â”Š          exact\n-â”Š25â”Š  â”Š          path=\"/chats/:chatId\"\n-â”Š26â”Š  â”Š          component={({\n-â”Š27â”Š  â”Š            match,\n-â”Š28â”Š  â”Š            history,\n-â”Š29â”Š  â”Š          }: RouteComponentProps<{ chatId: string }>) => (\n+â”Š  â”Š20â”Š      <Route\n+â”Š  â”Š21â”Š        exact\n+â”Š  â”Š22â”Š        path=\"/chats/:chatId\"\n+â”Š  â”Š23â”Š        component={withAuth(\n+â”Š  â”Š24â”Š          ({ match, history }: RouteComponentProps<{ chatId: string }>) => (\n â”Š30â”Š25â”Š            <ChatRoomScreen chatId={match.params.chatId} history={history} />\n-â”Š31â”Š  â”Š          )}\n-â”Š32â”Š  â”Š        />\n-â”Š33â”Š  â”Š      </AnimatedSwitch>\n-â”Š34â”Š  â”Š      <Route exact path=\"/\" render={redirectToChats} />\n-â”Š35â”Š  â”Š    </BrowserRouter>\n-â”Š36â”Š  â”Š  );\n-â”Š37â”Š  â”Š};\n+â”Š  â”Š26â”Š          )\n+â”Š  â”Š27â”Š        )}\n+â”Š  â”Š28â”Š      />\n+â”Š  â”Š29â”Š    </AnimatedSwitch>\n+â”Š  â”Š30â”Š    <Route exact path=\"/\" render={redirectToChats} />\n+â”Š  â”Š31â”Š  </BrowserRouter>\n+â”Š  â”Š32â”Š);\n â”Š38â”Š33â”Š\n â”Š39â”Š34â”Šconst redirectToChats = () => <Redirect to=\"/chats\" />;\n â”Š40â”Š35â”Š\n```\n\n[}]: #\n\nAssuming that youâ€™re not logged-in, if youâ€™ll try to force navigate to the `/chats` route you should be automatically redirected to the `/sign-in` form. We will finish the chapter here as we wanna keep things simple and gradual. Itâ€™s true that we havenâ€™t implemented true authentication, but that would be addressed soon further in this tutorial."
          },
          {
            "manualTitle": "Step 12: Adding and removing chats",
            "stepRevision": "db3d3c7fb392b2091f268e4ed143cbb7de6db549",
            "manualView": "Now that the users system is ready it would be a lot more comfortable to implement a chat creation feature. In the original Whatsapp, you can create a new chat based on your available contacts - a list of your contacts will appear on the screen and by picking one of the items youâ€™ll basically be able to start chatting with the selected contact. However, since in our app we donâ€™t have any real contacts (yet), we will implement the chats creation feature based on all available users in our DB. By picking a user from the users list we will be able to start chatting with it.\n\n![demo](https://user-images.githubusercontent.com/7648874/55896445-e4c67200-5bf0-11e9-9c1c-88318642ef81.gif)\n\nTo be able to fetch users in our system we will need to add a new query called `users`. The `users` query will retrieve all users except for current user:\n\n[{]: <helper> (diffStep 9.1 module=\"server\")\n\n#### [__Server__ Step 9.1: Add Query.users](https://github.com/Urigo/WhatsApp-Clone-Server/commit/12f305d6ccf2bfd56fda0f7ceb4a8e560a288ddb)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -82,6 +82,12 @@\n â”Š82â”Š82â”Š\n â”Š83â”Š83â”Š      return chat.participants.includes(currentUser.id) ? chat : null;\n â”Š84â”Š84â”Š    },\n+â”Š  â”Š85â”Š\n+â”Š  â”Š86â”Š    users(root, args, { currentUser }) {\n+â”Š  â”Š87â”Š      if (!currentUser) return [];\n+â”Š  â”Š88â”Š\n+â”Š  â”Š89â”Š      return users.filter(u => u.id !== currentUser.id);\n+â”Š  â”Š90â”Š    },\n â”Š85â”Š91â”Š  },\n â”Š86â”Š92â”Š\n â”Š87â”Š93â”Š  Mutation: {\n```\n\n##### Changed schema&#x2F;typeDefs.graphql\n```diff\n@@ -28,6 +28,7 @@\n â”Š28â”Š28â”Štype Query {\n â”Š29â”Š29â”Š  chats: [Chat!]!\n â”Š30â”Š30â”Š  chat(chatId: ID!): Chat\n+â”Š  â”Š31â”Š  users: [User!]!\n â”Š31â”Š32â”Š}\n â”Š32â”Š33â”Š\n â”Š33â”Š34â”Štype Mutation {\n```\n\n##### Added tests&#x2F;queries&#x2F;\\__snapshots__&#x2F;getUsers.test.ts.snap\n```diff\n@@ -0,0 +1,55 @@\n+â”Š  â”Š 1â”Š// Jest Snapshot v1, https://goo.gl/fbAQLP\n+â”Š  â”Š 2â”Š\n+â”Š  â”Š 3â”Šexports[`Query.getUsers should fetch all users except the one signed-in 1`] = `\n+â”Š  â”Š 4â”ŠObject {\n+â”Š  â”Š 5â”Š  \"users\": Array [\n+â”Š  â”Š 6â”Š    Object {\n+â”Š  â”Š 7â”Š      \"id\": \"2\",\n+â”Š  â”Š 8â”Š      \"name\": \"Ethan Gonzalez\",\n+â”Š  â”Š 9â”Š      \"picture\": \"https://randomuser.me/api/portraits/thumb/men/1.jpg\",\n+â”Š  â”Š10â”Š    },\n+â”Š  â”Š11â”Š    Object {\n+â”Š  â”Š12â”Š      \"id\": \"3\",\n+â”Š  â”Š13â”Š      \"name\": \"Bryan Wallace\",\n+â”Š  â”Š14â”Š      \"picture\": \"https://randomuser.me/api/portraits/thumb/men/2.jpg\",\n+â”Š  â”Š15â”Š    },\n+â”Š  â”Š16â”Š    Object {\n+â”Š  â”Š17â”Š      \"id\": \"4\",\n+â”Š  â”Š18â”Š      \"name\": \"Avery Stewart\",\n+â”Š  â”Š19â”Š      \"picture\": \"https://randomuser.me/api/portraits/thumb/women/1.jpg\",\n+â”Š  â”Š20â”Š    },\n+â”Š  â”Š21â”Š    Object {\n+â”Š  â”Š22â”Š      \"id\": \"5\",\n+â”Š  â”Š23â”Š      \"name\": \"Katie Peterson\",\n+â”Š  â”Š24â”Š      \"picture\": \"https://randomuser.me/api/portraits/thumb/women/2.jpg\",\n+â”Š  â”Š25â”Š    },\n+â”Š  â”Š26â”Š  ],\n+â”Š  â”Š27â”Š}\n+â”Š  â”Š28â”Š`;\n+â”Š  â”Š29â”Š\n+â”Š  â”Š30â”Šexports[`Query.getUsers should fetch all users except the one signed-in 2`] = `\n+â”Š  â”Š31â”ŠObject {\n+â”Š  â”Š32â”Š  \"users\": Array [\n+â”Š  â”Š33â”Š    Object {\n+â”Š  â”Š34â”Š      \"id\": \"1\",\n+â”Š  â”Š35â”Š      \"name\": \"Ray Edwards\",\n+â”Š  â”Š36â”Š      \"picture\": \"https://randomuser.me/api/portraits/thumb/lego/1.jpg\",\n+â”Š  â”Š37â”Š    },\n+â”Š  â”Š38â”Š    Object {\n+â”Š  â”Š39â”Š      \"id\": \"3\",\n+â”Š  â”Š40â”Š      \"name\": \"Bryan Wallace\",\n+â”Š  â”Š41â”Š      \"picture\": \"https://randomuser.me/api/portraits/thumb/men/2.jpg\",\n+â”Š  â”Š42â”Š    },\n+â”Š  â”Š43â”Š    Object {\n+â”Š  â”Š44â”Š      \"id\": \"4\",\n+â”Š  â”Š45â”Š      \"name\": \"Avery Stewart\",\n+â”Š  â”Š46â”Š      \"picture\": \"https://randomuser.me/api/portraits/thumb/women/1.jpg\",\n+â”Š  â”Š47â”Š    },\n+â”Š  â”Š48â”Š    Object {\n+â”Š  â”Š49â”Š      \"id\": \"5\",\n+â”Š  â”Š50â”Š      \"name\": \"Katie Peterson\",\n+â”Š  â”Š51â”Š      \"picture\": \"https://randomuser.me/api/portraits/thumb/women/2.jpg\",\n+â”Š  â”Š52â”Š    },\n+â”Š  â”Š53â”Š  ],\n+â”Š  â”Š54â”Š}\n+â”Š  â”Š55â”Š`;\n```\n\n##### Added tests&#x2F;queries&#x2F;getUsers.test.ts\n```diff\n@@ -0,0 +1,51 @@\n+â”Š  â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n+â”Š  â”Š 2â”Šimport { ApolloServer, gql } from 'apollo-server-express';\n+â”Š  â”Š 3â”Šimport schema from '../../schema';\n+â”Š  â”Š 4â”Šimport { users } from '../../db';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šdescribe('Query.getUsers', () => {\n+â”Š  â”Š 7â”Š  it('should fetch all users except the one signed-in', async () => {\n+â”Š  â”Š 8â”Š    let currentUser = users[0];\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Š    const server = new ApolloServer({\n+â”Š  â”Š11â”Š      schema,\n+â”Š  â”Š12â”Š      context: () => ({ currentUser }),\n+â”Š  â”Š13â”Š    });\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”Š    const { query } = createTestClient(server);\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š    let res = await query({\n+â”Š  â”Š18â”Š      query: gql`\n+â”Š  â”Š19â”Š        query GetUsers {\n+â”Š  â”Š20â”Š          users {\n+â”Š  â”Š21â”Š            id\n+â”Š  â”Š22â”Š            name\n+â”Š  â”Š23â”Š            picture\n+â”Š  â”Š24â”Š          }\n+â”Š  â”Š25â”Š        }\n+â”Š  â”Š26â”Š      `,\n+â”Š  â”Š27â”Š    });\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š    expect(res.data).toBeDefined();\n+â”Š  â”Š30â”Š    expect(res.errors).toBeUndefined();\n+â”Š  â”Š31â”Š    expect(res.data).toMatchSnapshot();\n+â”Š  â”Š32â”Š\n+â”Š  â”Š33â”Š    currentUser = users[1];\n+â”Š  â”Š34â”Š\n+â”Š  â”Š35â”Š    res = await query({\n+â”Š  â”Š36â”Š      query: gql`\n+â”Š  â”Š37â”Š        query GetUsers {\n+â”Š  â”Š38â”Š          users {\n+â”Š  â”Š39â”Š            id\n+â”Š  â”Š40â”Š            name\n+â”Š  â”Š41â”Š            picture\n+â”Š  â”Š42â”Š          }\n+â”Š  â”Š43â”Š        }\n+â”Š  â”Š44â”Š      `,\n+â”Š  â”Š45â”Š    });\n+â”Š  â”Š46â”Š\n+â”Š  â”Š47â”Š    expect(res.data).toBeDefined();\n+â”Š  â”Š48â”Š    expect(res.errors).toBeUndefined();\n+â”Š  â”Š49â”Š    expect(res.data).toMatchSnapshot();\n+â”Š  â”Š50â”Š  });\n+â”Š  â”Š51â”Š});\n```\n\n[}]: #\n\nThis query will be reflected in a component called `UsersList`. First we will define and export a new fragment called `User`:\n\n[{]: <helper> (diffStep 12.1 files=\"graphql/fragments\" module=\"client\")\n\n#### [__Client__ Step 12.1: Add basic ChatCreationScreen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/e6e20c4bb42dbd7890e46ddc7a529d9721105c76)\n\n##### Changed src&#x2F;graphql&#x2F;fragments&#x2F;index.ts\n```diff\n@@ -1,3 +1,4 @@\n â”Š1â”Š1â”Šexport { default as chat } from './chat.fragment';\n â”Š2â”Š2â”Šexport { default as fullChat } from './fullChat.fragment';\n â”Š3â”Š3â”Šexport { default as message } from './message.fragment';\n+â”Š â”Š4â”Šexport { default as user } from './user.fragment';\n```\n\n##### Added src&#x2F;graphql&#x2F;fragments&#x2F;user.fragment.ts\n```diff\n@@ -0,0 +1,9 @@\n+â”Š â”Š1â”Šimport gql from 'graphql-tag';\n+â”Š â”Š2â”Š\n+â”Š â”Š3â”Šexport default gql`\n+â”Š â”Š4â”Š  fragment User on User {\n+â”Š â”Š5â”Š    id\n+â”Š â”Š6â”Š    name\n+â”Š â”Š7â”Š    picture\n+â”Š â”Š8â”Š  }\n+â”Š â”Š9â”Š`;\n```\n\n[}]: #\n\nAnd then we will implement the `UsersList` component which is going to use the `users` query with the `User` fragment:\n\n[{]: <helper> (diffStep 12.1 files=\"UsersList\" module=\"client\")\n\n#### [__Client__ Step 12.1: Add basic ChatCreationScreen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/e6e20c4bb42dbd7890e46ddc7a529d9721105c76)\n\n##### Added src&#x2F;components&#x2F;UsersList.test.tsx\n```diff\n@@ -0,0 +1,46 @@\n+â”Š  â”Š 1â”Šimport React from 'react';\n+â”Š  â”Š 2â”Šimport { ApolloProvider } from '@apollo/react-hooks';\n+â”Š  â”Š 3â”Šimport { cleanup, render, waitForDomChange } from '@testing-library/react';\n+â”Š  â”Š 4â”Šimport { mockApolloClient } from '../test-helpers';\n+â”Š  â”Š 5â”Šimport UsersList, { UsersListQuery } from './UsersList';\n+â”Š  â”Š 6â”Šimport * as queries from '../graphql/queries';\n+â”Š  â”Š 7â”Š\n+â”Š  â”Š 8â”Šdescribe('UsersList', () => {\n+â”Š  â”Š 9â”Š  afterEach(cleanup);\n+â”Š  â”Š10â”Š\n+â”Š  â”Š11â”Š  it('renders fetched users data', async () => {\n+â”Š  â”Š12â”Š    const client = mockApolloClient([\n+â”Š  â”Š13â”Š      {\n+â”Š  â”Š14â”Š        request: { query: UsersListQuery },\n+â”Š  â”Š15â”Š        result: {\n+â”Š  â”Š16â”Š          data: {\n+â”Š  â”Š17â”Š            users: [\n+â”Š  â”Š18â”Š              {\n+â”Š  â”Š19â”Š                __typename: 'User',\n+â”Š  â”Š20â”Š                id: 1,\n+â”Š  â”Š21â”Š                name: 'Charles Dickhead',\n+â”Š  â”Š22â”Š                picture: 'https://localhost:4000/dick.jpg',\n+â”Š  â”Š23â”Š              },\n+â”Š  â”Š24â”Š            ],\n+â”Š  â”Š25â”Š          },\n+â”Š  â”Š26â”Š        },\n+â”Š  â”Š27â”Š      },\n+â”Š  â”Š28â”Š    ]);\n+â”Š  â”Š29â”Š\n+â”Š  â”Š30â”Š    {\n+â”Š  â”Š31â”Š      const { container, getByTestId } = render(\n+â”Š  â”Š32â”Š        <ApolloProvider client={client}>\n+â”Š  â”Š33â”Š          <UsersList />\n+â”Š  â”Š34â”Š        </ApolloProvider>\n+â”Š  â”Š35â”Š      );\n+â”Š  â”Š36â”Š\n+â”Š  â”Š37â”Š      await waitForDomChange({ container });\n+â”Š  â”Š38â”Š\n+â”Š  â”Š39â”Š      expect(getByTestId('name')).toHaveTextContent('Charles Dickhead');\n+â”Š  â”Š40â”Š      expect(getByTestId('picture')).toHaveAttribute(\n+â”Š  â”Š41â”Š        'src',\n+â”Š  â”Š42â”Š        'https://localhost:4000/dick.jpg'\n+â”Š  â”Š43â”Š      );\n+â”Š  â”Š44â”Š    }\n+â”Š  â”Š45â”Š  });\n+â”Š  â”Š46â”Š});\n```\n\n##### Added src&#x2F;components&#x2F;UsersList.tsx\n```diff\n@@ -0,0 +1,64 @@\n+â”Š  â”Š 1â”Šimport MaterialList from '@material-ui/core/List';\n+â”Š  â”Š 2â”Šimport MaterialItem from '@material-ui/core/ListItem';\n+â”Š  â”Š 3â”Šimport gql from 'graphql-tag';\n+â”Š  â”Š 4â”Šimport React from 'react';\n+â”Š  â”Š 5â”Šimport styled from 'styled-components';\n+â”Š  â”Š 6â”Šimport * as fragments from '../graphql/fragments';\n+â”Š  â”Š 7â”Šimport { useUsersListQuery } from '../graphql/types';\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Šconst ActualList = styled(MaterialList)`\n+â”Š  â”Š10â”Š  padding: 0;\n+â”Š  â”Š11â”Š`;\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Šconst UserItem = styled(MaterialItem)`\n+â”Š  â”Š14â”Š  position: relative;\n+â”Š  â”Š15â”Š  padding: 7.5px 15px;\n+â”Š  â”Š16â”Š  display: flex;\n+â”Š  â”Š17â”Š  cursor: pinter;\n+â”Š  â”Š18â”Š`;\n+â”Š  â”Š19â”Š\n+â”Š  â”Š20â”Šconst ProfilePicture = styled.img`\n+â”Š  â”Š21â”Š  height: 50px;\n+â”Š  â”Š22â”Š  width: 50px;\n+â”Š  â”Š23â”Š  object-fit: cover;\n+â”Š  â”Š24â”Š  border-radius: 50%;\n+â”Š  â”Š25â”Š`;\n+â”Š  â”Š26â”Š\n+â”Š  â”Š27â”Šconst Name = styled.div`\n+â”Š  â”Š28â”Š  padding-left: 15px;\n+â”Š  â”Š29â”Š  font-weight: bold;\n+â”Š  â”Š30â”Š`;\n+â”Š  â”Š31â”Š\n+â”Š  â”Š32â”Šexport const UsersListQuery = gql`\n+â”Š  â”Š33â”Š  query UsersList {\n+â”Š  â”Š34â”Š    users {\n+â”Š  â”Š35â”Š      ...User\n+â”Š  â”Š36â”Š    }\n+â”Š  â”Š37â”Š  }\n+â”Š  â”Š38â”Š  ${fragments.user}\n+â”Š  â”Š39â”Š`;\n+â”Š  â”Š40â”Š\n+â”Š  â”Š41â”Šconst UsersList: React.FC = () => {\n+â”Š  â”Š42â”Š  const { data, loading: loadingUsers } = useUsersListQuery();\n+â”Š  â”Š43â”Š\n+â”Š  â”Š44â”Š  if (data === undefined) return null;\n+â”Š  â”Š45â”Š  const users = data.users;\n+â”Š  â”Š46â”Š\n+â”Š  â”Š47â”Š  return (\n+â”Š  â”Š48â”Š    <ActualList>\n+â”Š  â”Š49â”Š      {!loadingUsers &&\n+â”Š  â”Š50â”Š        users.map(user => (\n+â”Š  â”Š51â”Š          <UserItem key={user.id} button>\n+â”Š  â”Š52â”Š            {user !== null && user.picture !== null && (\n+â”Š  â”Š53â”Š              <React.Fragment>\n+â”Š  â”Š54â”Š                <ProfilePicture data-testid=\"picture\" src={user.picture} />\n+â”Š  â”Š55â”Š                <Name data-testid=\"name\">{user.name}</Name>\n+â”Š  â”Š56â”Š              </React.Fragment>\n+â”Š  â”Š57â”Š            )}\n+â”Š  â”Š58â”Š          </UserItem>\n+â”Š  â”Š59â”Š        ))}\n+â”Š  â”Š60â”Š    </ActualList>\n+â”Š  â”Š61â”Š  );\n+â”Š  â”Š62â”Š};\n+â”Š  â”Š63â”Š\n+â”Š  â”Š64â”Šexport default UsersList;\n```\n\n[}]: #\n\nThe list is likely to change when a new user signs-up. We will implement a subscription and live-update the list further this tutorial when we go through authentication. Now we will implement a new screen component called `ChatCreationScreen`. The screen will simply render the `UsersList` along with a navigation bar:\n\n[{]: <helper> (diffStep 12.1 files=\"ChatCreationScreen\" module=\"client\")\n\n#### [__Client__ Step 12.1: Add basic ChatCreationScreen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/e6e20c4bb42dbd7890e46ddc7a529d9721105c76)\n\n##### Added src&#x2F;components&#x2F;ChatCreationScreen&#x2F;ChatCreationNavbar.test.tsx\n```diff\n@@ -0,0 +1,26 @@\n+â”Š  â”Š 1â”Šimport { createMemoryHistory } from 'history';\n+â”Š  â”Š 2â”Šimport React from 'react';\n+â”Š  â”Š 3â”Šimport { cleanup, render, fireEvent, wait } from '@testing-library/react';\n+â”Š  â”Š 4â”Šimport ChatCreationNavbar from './ChatCreationNavbar';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šdescribe('ChatCreationNavbar', () => {\n+â”Š  â”Š 7â”Š  afterEach(cleanup);\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Š  it('goes back on arrow click', async () => {\n+â”Š  â”Š10â”Š    const history = createMemoryHistory();\n+â”Š  â”Š11â”Š\n+â”Š  â”Š12â”Š    history.push('/new-chat');\n+â”Š  â”Š13â”Š\n+â”Š  â”Š14â”Š    await wait(() => expect(history.location.pathname).toEqual('/new-chat'));\n+â”Š  â”Š15â”Š\n+â”Š  â”Š16â”Š    {\n+â”Š  â”Š17â”Š      const { container, getByTestId } = render(\n+â”Š  â”Š18â”Š        <ChatCreationNavbar history={history} />\n+â”Š  â”Š19â”Š      );\n+â”Š  â”Š20â”Š\n+â”Š  â”Š21â”Š      fireEvent.click(getByTestId('back-button'));\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Š      await wait(() => expect(history.location.pathname).toEqual('/chats'));\n+â”Š  â”Š24â”Š    }\n+â”Š  â”Š25â”Š  });\n+â”Š  â”Š26â”Š});\n```\n\n##### Added src&#x2F;components&#x2F;ChatCreationScreen&#x2F;ChatCreationNavbar.tsx\n```diff\n@@ -0,0 +1,45 @@\n+â”Š  â”Š 1â”Šimport ArrowBackIcon from '@material-ui/icons/ArrowBack';\n+â”Š  â”Š 2â”Šimport { Toolbar, Button } from '@material-ui/core';\n+â”Š  â”Š 3â”Šimport React from 'react';\n+â”Š  â”Š 4â”Šimport { useCallback } from 'react';\n+â”Š  â”Š 5â”Šimport styled from 'styled-components';\n+â”Š  â”Š 6â”Šimport { History } from 'history';\n+â”Š  â”Š 7â”Š\n+â”Š  â”Š 8â”Šconst Container = styled(Toolbar)`\n+â”Š  â”Š 9â”Š  display: flex;\n+â”Š  â”Š10â”Š  background-color: var(--primary-bg);\n+â”Š  â”Š11â”Š  color: var(--primary-text);\n+â”Š  â”Š12â”Š  font-size: 20px;\n+â”Š  â”Š13â”Š  line-height: 40px;\n+â”Š  â”Š14â”Š`;\n+â”Š  â”Š15â”Š\n+â”Š  â”Š16â”Šconst BackButton = styled(Button)`\n+â”Š  â”Š17â”Š  svg {\n+â”Š  â”Š18â”Š    color: var(--primary-text);\n+â”Š  â”Š19â”Š  }\n+â”Š  â”Š20â”Š`;\n+â”Š  â”Š21â”Š\n+â”Š  â”Š22â”Šconst Title = styled.div`\n+â”Š  â”Š23â”Š  flex: 1;\n+â”Š  â”Š24â”Š`;\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Šinterface ChildComponentProps {\n+â”Š  â”Š27â”Š  history: History;\n+â”Š  â”Š28â”Š}\n+â”Š  â”Š29â”Š\n+â”Š  â”Š30â”Šconst ChatCreationNavbar: React.FC<ChildComponentProps> = ({ history }) => {\n+â”Š  â”Š31â”Š  const navBack = useCallback(() => {\n+â”Š  â”Š32â”Š    history.replace('/chats');\n+â”Š  â”Š33â”Š  }, [history]);\n+â”Š  â”Š34â”Š\n+â”Š  â”Š35â”Š  return (\n+â”Š  â”Š36â”Š    <Container>\n+â”Š  â”Š37â”Š      <BackButton data-testid=\"back-button\" onClick={navBack}>\n+â”Š  â”Š38â”Š        <ArrowBackIcon />\n+â”Š  â”Š39â”Š      </BackButton>\n+â”Š  â”Š40â”Š      <Title>Create Chat</Title>\n+â”Š  â”Š41â”Š    </Container>\n+â”Š  â”Š42â”Š  );\n+â”Š  â”Š43â”Š};\n+â”Š  â”Š44â”Š\n+â”Š  â”Š45â”Šexport default ChatCreationNavbar;\n```\n\n##### Added src&#x2F;components&#x2F;ChatCreationScreen&#x2F;index.tsx\n```diff\n@@ -0,0 +1,29 @@\n+â”Š  â”Š 1â”Šimport React from 'react';\n+â”Š  â”Š 2â”Šimport styled from 'styled-components';\n+â”Š  â”Š 3â”Šimport UsersList from '../UsersList';\n+â”Š  â”Š 4â”Šimport ChatCreationNavbar from './ChatCreationNavbar';\n+â”Š  â”Š 5â”Šimport { History } from 'history';\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Š// eslint-disable-next-line\n+â”Š  â”Š 8â”Šconst Container = styled.div`\n+â”Š  â”Š 9â”Š  height: calc(100% - 56px);\n+â”Š  â”Š10â”Š  overflow-y: overlay;\n+â”Š  â”Š11â”Š`;\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Š// eslint-disable-next-line\n+â”Š  â”Š14â”Šconst StyledUsersList = styled(UsersList)`\n+â”Š  â”Š15â”Š  height: calc(100% - 56px);\n+â”Š  â”Š16â”Š`;\n+â”Š  â”Š17â”Š\n+â”Š  â”Š18â”Šinterface ChildComponentProps {\n+â”Š  â”Š19â”Š  history: History;\n+â”Š  â”Š20â”Š}\n+â”Š  â”Š21â”Š\n+â”Š  â”Š22â”Šconst ChatCreationScreen: React.FC<ChildComponentProps> = ({ history }) => (\n+â”Š  â”Š23â”Š  <div>\n+â”Š  â”Š24â”Š    <ChatCreationNavbar history={history} />\n+â”Š  â”Š25â”Š    <UsersList />\n+â”Š  â”Š26â”Š  </div>\n+â”Š  â”Š27â”Š);\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Šexport default ChatCreationScreen;\n```\n\n[}]: #\n\nThe screen will be available under the route `/new-chat`. The new route will be restricted, since only authenticated users should be able to access it:\n\n[{]: <helper> (diffStep 12.1 files=\"App\" module=\"client\")\n\n#### [__Client__ Step 12.1: Add basic ChatCreationScreen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/e6e20c4bb42dbd7890e46ddc7a529d9721105c76)\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -8,6 +8,7 @@\n â”Š 8â”Š 8â”Šimport AuthScreen from './components/AuthScreen';\n â”Š 9â”Š 9â”Šimport ChatRoomScreen from './components/ChatRoomScreen';\n â”Š10â”Š10â”Šimport ChatsListScreen from './components/ChatsListScreen';\n+â”Š  â”Š11â”Šimport ChatCreationScreen from './components/ChatCreationScreen';\n â”Š11â”Š12â”Šimport AnimatedSwitch from './components/AnimatedSwitch';\n â”Š12â”Š13â”Šimport { withAuth } from './services/auth.service';\n â”Š13â”Š14â”Š\n```\n```diff\n@@ -26,6 +27,8 @@\n â”Š26â”Š27â”Š          )\n â”Š27â”Š28â”Š        )}\n â”Š28â”Š29â”Š      />\n+â”Š  â”Š30â”Š\n+â”Š  â”Š31â”Š      <Route exact path=\"/new-chat\" component={withAuth(ChatCreationScreen)} />\n â”Š29â”Š32â”Š    </AnimatedSwitch>\n â”Š30â”Š33â”Š    <Route exact path=\"/\" render={redirectToChats} />\n â”Š31â”Š34â”Š  </BrowserRouter>\n```\n\n[}]: #\n\nthe `/new-chat` route will be accessible directly from the main `ChatsListScreen`. We will implement a navigation button which is gonna have a fixed position at the bottom right corner of the screen:\n\n[{]: <helper> (diffStep 12.1 files=\"AddChatButton\" module=\"client\")\n\n#### [__Client__ Step 12.1: Add basic ChatCreationScreen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/e6e20c4bb42dbd7890e46ddc7a529d9721105c76)\n\n##### Added src&#x2F;components&#x2F;ChatsListScreen&#x2F;AddChatButton.test.tsx\n```diff\n@@ -0,0 +1,27 @@\n+â”Š  â”Š 1â”Šimport { createMemoryHistory } from 'history';\n+â”Š  â”Š 2â”Šimport { ApolloProvider } from '@apollo/react-hooks';\n+â”Š  â”Š 3â”Šimport React from 'react';\n+â”Š  â”Š 4â”Šimport { cleanup, render, fireEvent, wait } from '@testing-library/react';\n+â”Š  â”Š 5â”Šimport AddChatButton from './AddChatButton';\n+â”Š  â”Š 6â”Šimport { mockApolloClient } from '../../test-helpers';\n+â”Š  â”Š 7â”Š\n+â”Š  â”Š 8â”Šdescribe('AddChatButton', () => {\n+â”Š  â”Š 9â”Š  afterEach(cleanup);\n+â”Š  â”Š10â”Š\n+â”Š  â”Š11â”Š  it('goes back on arrow click', async () => {\n+â”Š  â”Š12â”Š    const history = createMemoryHistory();\n+â”Š  â”Š13â”Š    const client = mockApolloClient();\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”Š    {\n+â”Š  â”Š16â”Š      const { container, getByTestId } = render(\n+â”Š  â”Š17â”Š        <ApolloProvider client={client}>\n+â”Š  â”Š18â”Š          <AddChatButton history={history} />\n+â”Š  â”Š19â”Š        </ApolloProvider>\n+â”Š  â”Š20â”Š      );\n+â”Š  â”Š21â”Š\n+â”Š  â”Š22â”Š      fireEvent.click(getByTestId('new-chat-button'));\n+â”Š  â”Š23â”Š\n+â”Š  â”Š24â”Š      await wait(() => expect(history.location.pathname).toEqual('/new-chat'));\n+â”Š  â”Š25â”Š    }\n+â”Š  â”Š26â”Š  });\n+â”Š  â”Š27â”Š});\n```\n\n##### Added src&#x2F;components&#x2F;ChatsListScreen&#x2F;AddChatButton.tsx\n```diff\n@@ -0,0 +1,43 @@\n+â”Š  â”Š 1â”Šimport Button from '@material-ui/core/Button';\n+â”Š  â”Š 2â”Šimport ChatIcon from '@material-ui/icons/Chat';\n+â”Š  â”Š 3â”Šimport React from 'react';\n+â”Š  â”Š 4â”Šimport styled from 'styled-components';\n+â”Š  â”Š 5â”Šimport { History } from 'history';\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Šconst Container = styled.div`\n+â”Š  â”Š 8â”Š  position: fixed;\n+â”Š  â”Š 9â”Š  right: 10px;\n+â”Š  â”Š10â”Š  bottom: 10px;\n+â”Š  â”Š11â”Š\n+â”Š  â”Š12â”Š  button {\n+â”Š  â”Š13â”Š    min-width: 50px;\n+â”Š  â”Š14â”Š    width: 50px;\n+â”Š  â”Š15â”Š    height: 50px;\n+â”Š  â”Š16â”Š    border-radius: 999px;\n+â”Š  â”Š17â”Š    background-color: var(--secondary-bg);\n+â”Š  â”Š18â”Š    color: white;\n+â”Š  â”Š19â”Š  }\n+â”Š  â”Š20â”Š`;\n+â”Š  â”Š21â”Šinterface ChildComponentProps {\n+â”Š  â”Š22â”Š  history: History;\n+â”Š  â”Š23â”Š}\n+â”Š  â”Š24â”Š\n+â”Š  â”Š25â”Šconst AddChatButton: React.FC<ChildComponentProps> = ({ history }) => {\n+â”Š  â”Š26â”Š  const onClick = () => {\n+â”Š  â”Š27â”Š    history.push('/new-chat');\n+â”Š  â”Š28â”Š  };\n+â”Š  â”Š29â”Š\n+â”Š  â”Š30â”Š  return (\n+â”Š  â”Š31â”Š    <Container>\n+â”Š  â”Š32â”Š      <Button\n+â”Š  â”Š33â”Š        data-testid=\"new-chat-button\"\n+â”Š  â”Š34â”Š        variant=\"contained\"\n+â”Š  â”Š35â”Š        color=\"secondary\"\n+â”Š  â”Š36â”Š        onClick={onClick}>\n+â”Š  â”Š37â”Š        <ChatIcon />\n+â”Š  â”Š38â”Š      </Button>\n+â”Š  â”Š39â”Š    </Container>\n+â”Š  â”Š40â”Š  );\n+â”Š  â”Š41â”Š};\n+â”Š  â”Š42â”Š\n+â”Š  â”Š43â”Šexport default AddChatButton;\n```\n\n[}]: #\n\nAnd then we will render it in the `ChatsListScreen`:\n\n[{]: <helper> (diffStep 12.1 files=\"ChatsListScreen/index\" module=\"client\")\n\n#### [__Client__ Step 12.1: Add basic ChatCreationScreen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/e6e20c4bb42dbd7890e46ddc7a529d9721105c76)\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;index.tsx\n```diff\n@@ -3,6 +3,7 @@\n â”Š3â”Š3â”Šimport ChatsList from './ChatsList';\n â”Š4â”Š4â”Šimport styled from 'styled-components';\n â”Š5â”Š5â”Šimport { History } from 'history';\n+â”Š â”Š6â”Šimport AddChatButton from './AddChatButton';\n â”Š6â”Š7â”Š\n â”Š7â”Š8â”Šconst Container = styled.div`\n â”Š8â”Š9â”Š  height: 100vh;\n```\n```diff\n@@ -16,6 +17,7 @@\n â”Š16â”Š17â”Š  <Container>\n â”Š17â”Š18â”Š    <ChatsNavbar history={history} />\n â”Š18â”Š19â”Š    <ChatsList history={history} />\n+â”Š  â”Š20â”Š    <AddChatButton history={history} />\n â”Š19â”Š21â”Š  </Container>\n â”Š20â”Š22â”Š);\n â”Š21â”Š23â”Š\n```\n\n[}]: #\n\nFor now we can only observe the users list. Our goal now is to be able to start chatting with a user once it has been clicked. First we will need to add a new mutation called `addChat` which will create a new chat document and add it to the chats collection. If the chat already exists we will return the existing instance. This behavior will help us navigate to the desired `ChatRoomScreen`, whether it exists or not:\n\n[{]: <helper> (diffStep 9.2 module=\"server\")\n\n#### [__Server__ Step 9.2: Add Mutation.addChat](https://github.com/Urigo/WhatsApp-Clone-Server/commit/0321f8d3c2826ddfd1f1b9be37c2d1848d7f8ca6)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,6 +1,6 @@\n â”Š1â”Š1â”Šimport { withFilter } from 'apollo-server-express';\n â”Š2â”Š2â”Šimport { GraphQLDateTime } from 'graphql-iso-date';\n-â”Š3â”Š â”Šimport { User, Message, chats, messages, users } from '../db';\n+â”Š â”Š3â”Šimport { User, Message, Chat, chats, messages, users } from '../db';\n â”Š4â”Š4â”Šimport { Resolvers } from '../types/graphql';\n â”Š5â”Š5â”Š\n â”Š6â”Š6â”Šconst resolvers: Resolvers = {\n```\n```diff\n@@ -123,6 +123,31 @@\n â”Š123â”Š123â”Š\n â”Š124â”Š124â”Š      return message;\n â”Š125â”Š125â”Š    },\n+â”Š   â”Š126â”Š\n+â”Š   â”Š127â”Š    addChat(root, { recipientId }, { currentUser }) {\n+â”Š   â”Š128â”Š      if (!currentUser) return null;\n+â”Š   â”Š129â”Š      if (!users.some(u => u.id === recipientId)) return null;\n+â”Š   â”Š130â”Š\n+â”Š   â”Š131â”Š      let chat = chats.find(\n+â”Š   â”Š132â”Š        c =>\n+â”Š   â”Š133â”Š          c.participants.includes(currentUser.id) &&\n+â”Š   â”Š134â”Š          c.participants.includes(recipientId)\n+â”Š   â”Š135â”Š      );\n+â”Š   â”Š136â”Š\n+â”Š   â”Š137â”Š      if (chat) return chat;\n+â”Š   â”Š138â”Š\n+â”Š   â”Š139â”Š      const chatsIds = chats.map(c => Number(c.id));\n+â”Š   â”Š140â”Š\n+â”Š   â”Š141â”Š      chat = {\n+â”Š   â”Š142â”Š        id: String(Math.max(...chatsIds) + 1),\n+â”Š   â”Š143â”Š        participants: [currentUser.id, recipientId],\n+â”Š   â”Š144â”Š        messages: [],\n+â”Š   â”Š145â”Š      };\n+â”Š   â”Š146â”Š\n+â”Š   â”Š147â”Š      chats.push(chat);\n+â”Š   â”Š148â”Š\n+â”Š   â”Š149â”Š      return chat;\n+â”Š   â”Š150â”Š    },\n â”Š126â”Š151â”Š  },\n â”Š127â”Š152â”Š\n â”Š128â”Š153â”Š  Subscription: {\n```\n\n##### Changed schema&#x2F;typeDefs.graphql\n```diff\n@@ -33,6 +33,7 @@\n â”Š33â”Š33â”Š\n â”Š34â”Š34â”Štype Mutation {\n â”Š35â”Š35â”Š  addMessage(chatId: ID!, content: String!): Message\n+â”Š  â”Š36â”Š  addChat(recipientId: ID!): Chat\n â”Š36â”Š37â”Š}\n â”Š37â”Š38â”Š\n â”Š38â”Š39â”Štype Subscription {\n```\n\n##### Added tests&#x2F;mutations&#x2F;\\__snapshots__&#x2F;addChat.test.ts.snap\n```diff\n@@ -0,0 +1,52 @@\n+â”Š  â”Š 1â”Š// Jest Snapshot v1, https://goo.gl/fbAQLP\n+â”Š  â”Š 2â”Š\n+â”Š  â”Š 3â”Šexports[`Mutation.addChat creates a new chat between current user and specified recipient 1`] = `\n+â”Š  â”Š 4â”ŠObject {\n+â”Š  â”Š 5â”Š  \"addChat\": Object {\n+â”Š  â”Š 6â”Š    \"id\": \"5\",\n+â”Š  â”Š 7â”Š    \"name\": \"Bryan Wallace\",\n+â”Š  â”Š 8â”Š    \"participants\": Array [\n+â”Š  â”Š 9â”Š      Object {\n+â”Š  â”Š10â”Š        \"id\": \"2\",\n+â”Š  â”Š11â”Š      },\n+â”Š  â”Š12â”Š      Object {\n+â”Š  â”Š13â”Š        \"id\": \"3\",\n+â”Š  â”Š14â”Š      },\n+â”Š  â”Š15â”Š    ],\n+â”Š  â”Š16â”Š  },\n+â”Š  â”Š17â”Š}\n+â”Š  â”Š18â”Š`;\n+â”Š  â”Š19â”Š\n+â”Š  â”Š20â”Šexports[`Mutation.addChat creates a new chat between current user and specified recipient 2`] = `\n+â”Š  â”Š21â”ŠObject {\n+â”Š  â”Š22â”Š  \"chat\": Object {\n+â”Š  â”Š23â”Š    \"id\": \"5\",\n+â”Š  â”Š24â”Š    \"name\": \"Bryan Wallace\",\n+â”Š  â”Š25â”Š    \"participants\": Array [\n+â”Š  â”Š26â”Š      Object {\n+â”Š  â”Š27â”Š        \"id\": \"2\",\n+â”Š  â”Š28â”Š      },\n+â”Š  â”Š29â”Š      Object {\n+â”Š  â”Š30â”Š        \"id\": \"3\",\n+â”Š  â”Š31â”Š      },\n+â”Š  â”Š32â”Š    ],\n+â”Š  â”Š33â”Š  },\n+â”Š  â”Š34â”Š}\n+â”Š  â”Š35â”Š`;\n+â”Š  â”Š36â”Š\n+â”Š  â”Š37â”Šexports[`Mutation.addChat returns the existing chat if so 1`] = `\n+â”Š  â”Š38â”ŠObject {\n+â”Š  â”Š39â”Š  \"addChat\": Object {\n+â”Š  â”Š40â”Š    \"id\": \"1\",\n+â”Š  â”Š41â”Š    \"name\": \"Ethan Gonzalez\",\n+â”Š  â”Š42â”Š    \"participants\": Array [\n+â”Š  â”Š43â”Š      Object {\n+â”Š  â”Š44â”Š        \"id\": \"1\",\n+â”Š  â”Š45â”Š      },\n+â”Š  â”Š46â”Š      Object {\n+â”Š  â”Š47â”Š        \"id\": \"2\",\n+â”Š  â”Š48â”Š      },\n+â”Š  â”Š49â”Š    ],\n+â”Š  â”Š50â”Š  },\n+â”Š  â”Š51â”Š}\n+â”Š  â”Š52â”Š`;\n```\n\n##### Added tests&#x2F;mutations&#x2F;addChat.test.ts\n```diff\n@@ -0,0 +1,89 @@\n+â”Š  â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n+â”Š  â”Š 2â”Šimport { ApolloServer, PubSub, gql } from 'apollo-server-express';\n+â”Š  â”Š 3â”Šimport schema from '../../schema';\n+â”Š  â”Š 4â”Šimport { resetDb, users } from '../../db';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šdescribe('Mutation.addChat', () => {\n+â”Š  â”Š 7â”Š  beforeEach(resetDb);\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Š  it('creates a new chat between current user and specified recipient', async () => {\n+â”Š  â”Š10â”Š    const server = new ApolloServer({\n+â”Š  â”Š11â”Š      schema,\n+â”Š  â”Š12â”Š      context: () => ({\n+â”Š  â”Š13â”Š        pubsub: new PubSub(),\n+â”Š  â”Š14â”Š        currentUser: users[1],\n+â”Š  â”Š15â”Š      }),\n+â”Š  â”Š16â”Š    });\n+â”Š  â”Š17â”Š\n+â”Š  â”Š18â”Š    const { query, mutate } = createTestClient(server);\n+â”Š  â”Š19â”Š\n+â”Š  â”Š20â”Š    const addChatRes = await mutate({\n+â”Š  â”Š21â”Š      variables: { recipientId: '3' },\n+â”Š  â”Š22â”Š      mutation: gql`\n+â”Š  â”Š23â”Š        mutation AddChat($recipientId: ID!) {\n+â”Š  â”Š24â”Š          addChat(recipientId: $recipientId) {\n+â”Š  â”Š25â”Š            id\n+â”Š  â”Š26â”Š            name\n+â”Š  â”Š27â”Š            participants {\n+â”Š  â”Š28â”Š              id\n+â”Š  â”Š29â”Š            }\n+â”Š  â”Š30â”Š          }\n+â”Š  â”Š31â”Š        }\n+â”Š  â”Š32â”Š      `,\n+â”Š  â”Š33â”Š    });\n+â”Š  â”Š34â”Š\n+â”Š  â”Š35â”Š    expect(addChatRes.data).toBeDefined();\n+â”Š  â”Š36â”Š    expect(addChatRes.errors).toBeUndefined();\n+â”Š  â”Š37â”Š    expect(addChatRes.data).toMatchSnapshot();\n+â”Š  â”Š38â”Š\n+â”Š  â”Š39â”Š    const getChatRes = await query({\n+â”Š  â”Š40â”Š      variables: { chatId: '5' },\n+â”Š  â”Š41â”Š      query: gql`\n+â”Š  â”Š42â”Š        query GetChat($chatId: ID!) {\n+â”Š  â”Š43â”Š          chat(chatId: $chatId) {\n+â”Š  â”Š44â”Š            id\n+â”Š  â”Š45â”Š            name\n+â”Š  â”Š46â”Š            participants {\n+â”Š  â”Š47â”Š              id\n+â”Š  â”Š48â”Š            }\n+â”Š  â”Š49â”Š          }\n+â”Š  â”Š50â”Š        }\n+â”Š  â”Š51â”Š      `,\n+â”Š  â”Š52â”Š    });\n+â”Š  â”Š53â”Š\n+â”Š  â”Š54â”Š    expect(getChatRes.data).toBeDefined();\n+â”Š  â”Š55â”Š    expect(getChatRes.errors).toBeUndefined();\n+â”Š  â”Š56â”Š    expect(getChatRes.data).toMatchSnapshot();\n+â”Š  â”Š57â”Š  });\n+â”Š  â”Š58â”Š\n+â”Š  â”Š59â”Š  it('returns the existing chat if so', async () => {\n+â”Š  â”Š60â”Š    const server = new ApolloServer({\n+â”Š  â”Š61â”Š      schema,\n+â”Š  â”Š62â”Š      context: () => ({\n+â”Š  â”Š63â”Š        pubsub: new PubSub(),\n+â”Š  â”Š64â”Š        currentUser: users[0],\n+â”Š  â”Š65â”Š      }),\n+â”Š  â”Š66â”Š    });\n+â”Š  â”Š67â”Š\n+â”Š  â”Š68â”Š    const { query, mutate } = createTestClient(server);\n+â”Š  â”Š69â”Š\n+â”Š  â”Š70â”Š    const addChatRes = await mutate({\n+â”Š  â”Š71â”Š      variables: { recipientId: '2' },\n+â”Š  â”Š72â”Š      mutation: gql`\n+â”Š  â”Š73â”Š        mutation AddChat($recipientId: ID!) {\n+â”Š  â”Š74â”Š          addChat(recipientId: $recipientId) {\n+â”Š  â”Š75â”Š            id\n+â”Š  â”Š76â”Š            name\n+â”Š  â”Š77â”Š            participants {\n+â”Š  â”Š78â”Š              id\n+â”Š  â”Š79â”Š            }\n+â”Š  â”Š80â”Š          }\n+â”Š  â”Š81â”Š        }\n+â”Š  â”Š82â”Š      `,\n+â”Š  â”Š83â”Š    });\n+â”Š  â”Š84â”Š\n+â”Š  â”Š85â”Š    expect(addChatRes.data).toBeDefined();\n+â”Š  â”Š86â”Š    expect(addChatRes.errors).toBeUndefined();\n+â”Š  â”Š87â”Š    expect(addChatRes.data).toMatchSnapshot();\n+â”Š  â”Š88â”Š  });\n+â”Š  â”Š89â”Š});\n```\n\n[}]: #\n\nTo use the new mutation, we will define a new callback called `onUserPick` in the `UsersList` so it can be used from the `ChatCreationScreen`:\n\n[{]: <helper> (diffStep 12.2 files=\"UsersList\" module=\"client\")\n\n#### [__Client__ Step 12.2: Create chat on user pick](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/43327a50cd8ad2b1eadc2d4796918e1349f93b44)\n\n##### Changed src&#x2F;components&#x2F;UsersList.test.tsx\n```diff\n@@ -1,6 +1,12 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n â”Š 2â”Š 2â”Šimport { ApolloProvider } from '@apollo/react-hooks';\n-â”Š 3â”Š  â”Šimport { cleanup, render, waitForDomChange } from '@testing-library/react';\n+â”Š  â”Š 3â”Šimport {\n+â”Š  â”Š 4â”Š  cleanup,\n+â”Š  â”Š 5â”Š  render,\n+â”Š  â”Š 6â”Š  fireEvent,\n+â”Š  â”Š 7â”Š  wait,\n+â”Š  â”Š 8â”Š  waitForDomChange,\n+â”Š  â”Š 9â”Š} from '@testing-library/react';\n â”Š 4â”Š10â”Šimport { mockApolloClient } from '../test-helpers';\n â”Š 5â”Š11â”Šimport UsersList, { UsersListQuery } from './UsersList';\n â”Š 6â”Š12â”Šimport * as queries from '../graphql/queries';\n```\n```diff\n@@ -43,4 +49,45 @@\n â”Š43â”Š49â”Š      );\n â”Š44â”Š50â”Š    }\n â”Š45â”Š51â”Š  });\n+â”Š  â”Š52â”Š\n+â”Š  â”Š53â”Š  it('triggers onUserPick() callback on user-item click', async () => {\n+â”Š  â”Š54â”Š    const client = mockApolloClient([\n+â”Š  â”Š55â”Š      {\n+â”Š  â”Š56â”Š        request: { query: UsersListQuery },\n+â”Š  â”Š57â”Š        result: {\n+â”Š  â”Š58â”Š          data: {\n+â”Š  â”Š59â”Š            users: [\n+â”Š  â”Š60â”Š              {\n+â”Š  â”Š61â”Š                __typename: 'User',\n+â”Š  â”Š62â”Š                id: 1,\n+â”Š  â”Š63â”Š                name: 'Charles Dickhead',\n+â”Š  â”Š64â”Š                picture: 'https://localhost:4000/dick.jpg',\n+â”Š  â”Š65â”Š              },\n+â”Š  â”Š66â”Š            ],\n+â”Š  â”Š67â”Š          },\n+â”Š  â”Š68â”Š        },\n+â”Š  â”Š69â”Š      },\n+â”Š  â”Š70â”Š    ]);\n+â”Š  â”Š71â”Š\n+â”Š  â”Š72â”Š    const onUserPick = jest.fn(() => {});\n+â”Š  â”Š73â”Š\n+â”Š  â”Š74â”Š    {\n+â”Š  â”Š75â”Š      const { container, getByTestId } = render(\n+â”Š  â”Š76â”Š        <ApolloProvider client={client}>\n+â”Š  â”Š77â”Š          <UsersList onUserPick={onUserPick} />\n+â”Š  â”Š78â”Š        </ApolloProvider>\n+â”Š  â”Š79â”Š      );\n+â”Š  â”Š80â”Š\n+â”Š  â”Š81â”Š      await waitForDomChange({ container });\n+â”Š  â”Š82â”Š\n+â”Š  â”Š83â”Š      fireEvent.click(getByTestId('user'));\n+â”Š  â”Š84â”Š\n+â”Š  â”Š85â”Š      await wait(() => expect(onUserPick.mock.calls.length).toBe(1));\n+â”Š  â”Š86â”Š\n+â”Š  â”Š87â”Š      expect(onUserPick.mock.calls[0][0].name).toEqual('Charles Dickhead');\n+â”Š  â”Š88â”Š      expect(onUserPick.mock.calls[0][0].picture).toEqual(\n+â”Š  â”Š89â”Š        'https://localhost:4000/dick.jpg'\n+â”Š  â”Š90â”Š      );\n+â”Š  â”Š91â”Š    }\n+â”Š  â”Š92â”Š  });\n â”Š46â”Š93â”Š});\n```\n\n##### Changed src&#x2F;components&#x2F;UsersList.tsx\n```diff\n@@ -4,7 +4,7 @@\n â”Š 4â”Š 4â”Šimport React from 'react';\n â”Š 5â”Š 5â”Šimport styled from 'styled-components';\n â”Š 6â”Š 6â”Šimport * as fragments from '../graphql/fragments';\n-â”Š 7â”Š  â”Šimport { useUsersListQuery } from '../graphql/types';\n+â”Š  â”Š 7â”Šimport { useUsersListQuery, User } from '../graphql/types';\n â”Š 8â”Š 8â”Š\n â”Š 9â”Š 9â”Šconst ActualList = styled(MaterialList)`\n â”Š10â”Š10â”Š  padding: 0;\n```\n```diff\n@@ -38,7 +38,13 @@\n â”Š38â”Š38â”Š  ${fragments.user}\n â”Š39â”Š39â”Š`;\n â”Š40â”Š40â”Š\n-â”Š41â”Š  â”Šconst UsersList: React.FC = () => {\n+â”Š  â”Š41â”Šinterface ChildComponentProps {\n+â”Š  â”Š42â”Š  onUserPick: any;\n+â”Š  â”Š43â”Š}\n+â”Š  â”Š44â”Š\n+â”Š  â”Š45â”Šconst UsersList: React.FC<ChildComponentProps> = ({\n+â”Š  â”Š46â”Š  onUserPick = (user: User) => {},\n+â”Š  â”Š47â”Š}) => {\n â”Š42â”Š48â”Š  const { data, loading: loadingUsers } = useUsersListQuery();\n â”Š43â”Š49â”Š\n â”Š44â”Š50â”Š  if (data === undefined) return null;\n```\n```diff\n@@ -48,7 +54,11 @@\n â”Š48â”Š54â”Š    <ActualList>\n â”Š49â”Š55â”Š      {!loadingUsers &&\n â”Š50â”Š56â”Š        users.map(user => (\n-â”Š51â”Š  â”Š          <UserItem key={user.id} button>\n+â”Š  â”Š57â”Š          <UserItem\n+â”Š  â”Š58â”Š            key={user.id}\n+â”Š  â”Š59â”Š            data-testid=\"user\"\n+â”Š  â”Š60â”Š            onClick={onUserPick.bind(null, user)}\n+â”Š  â”Š61â”Š            button>\n â”Š52â”Š62â”Š            {user !== null && user.picture !== null && (\n â”Š53â”Š63â”Š              <React.Fragment>\n â”Š54â”Š64â”Š                <ProfilePicture data-testid=\"picture\" src={user.picture} />\n```\n\n[}]: #\n\nIn the `ChatCreationScreen/index.tsx` module, we will define an `AddChat` document with `graphql-tag`. Using the `$ yarn codegen` command we can generate the correlated React mutation hook and use it as the `onUserPick` callback:\n\n[{]: <helper> (diffStep 12.2 files=\"ChatCreationScreen/index\" module=\"client\")\n\n#### [__Client__ Step 12.2: Create chat on user pick](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/43327a50cd8ad2b1eadc2d4796918e1349f93b44)\n\n##### Changed src&#x2F;components&#x2F;ChatCreationScreen&#x2F;index.tsx\n```diff\n@@ -1,8 +1,12 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag';\n â”Š 1â”Š 2â”Šimport React from 'react';\n+â”Š  â”Š 3â”Šimport { useCallback } from 'react';\n â”Š 2â”Š 4â”Šimport styled from 'styled-components';\n+â”Š  â”Š 5â”Šimport * as fragments from '../../graphql/fragments';\n â”Š 3â”Š 6â”Šimport UsersList from '../UsersList';\n â”Š 4â”Š 7â”Šimport ChatCreationNavbar from './ChatCreationNavbar';\n â”Š 5â”Š 8â”Šimport { History } from 'history';\n+â”Š  â”Š 9â”Šimport { useAddChatMutation } from '../../graphql/types';\n â”Š 6â”Š10â”Š\n â”Š 7â”Š11â”Š// eslint-disable-next-line\n â”Š 8â”Š12â”Šconst Container = styled.div`\n```\n```diff\n@@ -15,15 +19,53 @@\n â”Š15â”Š19â”Š  height: calc(100% - 56px);\n â”Š16â”Š20â”Š`;\n â”Š17â”Š21â”Š\n+â”Š  â”Š22â”Šgql`\n+â”Š  â”Š23â”Š  mutation AddChat($recipientId: ID!) {\n+â”Š  â”Š24â”Š    addChat(recipientId: $recipientId) {\n+â”Š  â”Š25â”Š      ...Chat\n+â”Š  â”Š26â”Š    }\n+â”Š  â”Š27â”Š  }\n+â”Š  â”Š28â”Š  ${fragments.chat}\n+â”Š  â”Š29â”Š`;\n+â”Š  â”Š30â”Š\n â”Š18â”Š31â”Šinterface ChildComponentProps {\n â”Š19â”Š32â”Š  history: History;\n â”Š20â”Š33â”Š}\n â”Š21â”Š34â”Š\n-â”Š22â”Š  â”Šconst ChatCreationScreen: React.FC<ChildComponentProps> = ({ history }) => (\n-â”Š23â”Š  â”Š  <div>\n-â”Š24â”Š  â”Š    <ChatCreationNavbar history={history} />\n-â”Š25â”Š  â”Š    <UsersList />\n-â”Š26â”Š  â”Š  </div>\n-â”Š27â”Š  â”Š);\n+â”Š  â”Š35â”Šconst ChatCreationScreen: React.FC<ChildComponentProps> = ({ history }) => {\n+â”Š  â”Š36â”Š  const [addChat] = useAddChatMutation();\n+â”Š  â”Š37â”Š\n+â”Š  â”Š38â”Š  const onUserPick = useCallback(\n+â”Š  â”Š39â”Š    user => addChat({\n+â”Š  â”Š40â”Š        optimisticResponse: {\n+â”Š  â”Š41â”Š          __typename: 'Mutation',\n+â”Š  â”Š42â”Š          addChat: {\n+â”Š  â”Š43â”Š            __typename: 'Chat',\n+â”Š  â”Š44â”Š            id: Math.random()\n+â”Š  â”Š45â”Š              .toString(36)\n+â”Š  â”Š46â”Š              .substr(2, 9),\n+â”Š  â”Š47â”Š            name: user.name,\n+â”Š  â”Š48â”Š            picture: user.picture,\n+â”Š  â”Š49â”Š            lastMessage: null,\n+â”Š  â”Š50â”Š          },\n+â”Š  â”Š51â”Š        },\n+â”Š  â”Š52â”Š        variables: {\n+â”Š  â”Š53â”Š          recipientId: user.id,\n+â”Š  â”Š54â”Š        },\n+â”Š  â”Š55â”Š      }).then(result => {\n+â”Š  â”Š56â”Š        if (result && result.data !== null) {\n+â”Š  â”Š57â”Š          history.push(`/chats/${result.data!.addChat!.id}`);\n+â”Š  â”Š58â”Š        }\n+â”Š  â”Š59â”Š      }),\n+â”Š  â”Š60â”Š    [addChat, history]\n+â”Š  â”Š61â”Š  );\n+â”Š  â”Š62â”Š\n+â”Š  â”Š63â”Š  return (\n+â”Š  â”Š64â”Š    <div>\n+â”Š  â”Š65â”Š      <ChatCreationNavbar history={history} />\n+â”Š  â”Š66â”Š      <UsersList onUserPick={onUserPick} />\n+â”Š  â”Š67â”Š    </div>\n+â”Š  â”Š68â”Š  );\n+â”Š  â”Š69â”Š};\n â”Š28â”Š70â”Š\n â”Š29â”Š71â”Šexport default ChatCreationScreen;\n```\n\n[}]: #\n\nChats can now be created, you can test out the function by signing in with different users. However, the chats list in the `ChatsListScreen` will not be updated unless we refresh the page manually. In the server project, we will define a new subscription called `chatAdded`. The subscription should be broadcasted to the current user only if he is a participant of the published chat:\n\n[{]: <helper> (diffStep 9.3 module=\"server\")\n\n#### [__Server__ Step 9.3: Add Subscription.chatAdded](https://github.com/Urigo/WhatsApp-Clone-Server/commit/6e01e565fc23804dbf45b5c1ed14433c58a0631a)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -124,7 +124,7 @@\n â”Š124â”Š124â”Š      return message;\n â”Š125â”Š125â”Š    },\n â”Š126â”Š126â”Š\n-â”Š127â”Š   â”Š    addChat(root, { recipientId }, { currentUser }) {\n+â”Š   â”Š127â”Š    addChat(root, { recipientId }, { currentUser, pubsub }) {\n â”Š128â”Š128â”Š      if (!currentUser) return null;\n â”Š129â”Š129â”Š      if (!users.some(u => u.id === recipientId)) return null;\n â”Š130â”Š130â”Š\n```\n```diff\n@@ -146,6 +146,10 @@\n â”Š146â”Š146â”Š\n â”Š147â”Š147â”Š      chats.push(chat);\n â”Š148â”Š148â”Š\n+â”Š   â”Š149â”Š      pubsub.publish('chatAdded', {\n+â”Š   â”Š150â”Š        chatAdded: chat,\n+â”Š   â”Š151â”Š      });\n+â”Š   â”Š152â”Š\n â”Š149â”Š153â”Š      return chat;\n â”Š150â”Š154â”Š    },\n â”Š151â”Š155â”Š  },\n```\n```diff\n@@ -163,6 +167,17 @@\n â”Š163â”Š167â”Š        }\n â”Š164â”Š168â”Š      ),\n â”Š165â”Š169â”Š    },\n+â”Š   â”Š170â”Š\n+â”Š   â”Š171â”Š    chatAdded: {\n+â”Š   â”Š172â”Š      subscribe: withFilter(\n+â”Š   â”Š173â”Š        (root, args, { pubsub }) => pubsub.asyncIterator('chatAdded'),\n+â”Š   â”Š174â”Š        ({ chatAdded }: { chatAdded: Chat }, args, { currentUser }) => {\n+â”Š   â”Š175â”Š          if (!currentUser) return false;\n+â”Š   â”Š176â”Š\n+â”Š   â”Š177â”Š          return chatAdded.participants.some(p => p === currentUser.id);\n+â”Š   â”Š178â”Š        }\n+â”Š   â”Š179â”Š      ),\n+â”Š   â”Š180â”Š    },\n â”Š166â”Š181â”Š  },\n â”Š167â”Š182â”Š};\n â”Š168â”Š183â”Š\n```\n\n##### Changed schema&#x2F;typeDefs.graphql\n```diff\n@@ -38,4 +38,5 @@\n â”Š38â”Š38â”Š\n â”Š39â”Š39â”Štype Subscription {\n â”Š40â”Š40â”Š  messageAdded: Message!\n+â”Š  â”Š41â”Š  chatAdded: Chat!\n â”Š41â”Š42â”Š}\n```\n\n[}]: #\n\nNow we will listen to the new subscription in the client and update the cache. First we will define the subscription document:\n\n[{]: <helper> (diffStep 12.3 files=\"graphql/subscriptions\" module=\"client\")\n\n#### [__Client__ Step 12.3: Write chat on chatAdded](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/20cef4aadf44091a63251bf359aa50062938f6d7)\n\n##### Added src&#x2F;graphql&#x2F;subscriptions&#x2F;chatAdded.subscription.ts\n```diff\n@@ -0,0 +1,11 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag';\n+â”Š  â”Š 2â”Šimport * as fragments from '../fragments';\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šexport default gql`\n+â”Š  â”Š 5â”Š  subscription ChatAdded {\n+â”Š  â”Š 6â”Š    chatAdded {\n+â”Š  â”Š 7â”Š      ...Chat\n+â”Š  â”Š 8â”Š    }\n+â”Š  â”Š 9â”Š  }\n+â”Š  â”Š10â”Š  ${fragments.chat}\n+â”Š  â”Š11â”Š`;\n```\n\n##### Changed src&#x2F;graphql&#x2F;subscriptions&#x2F;index.ts\n```diff\n@@ -1 +1,2 @@\n â”Š1â”Š1â”Šexport { default as messageAdded } from './messageAdded.subscription';\n+â”Š â”Š2â”Šexport { default as chatAdded } from './chatAdded.subscription';\n```\n\n[}]: #\n\nAnd then we will update the `cache.service` to write the broadcasted chat to the store. We will write the fragment, and we will also update the `chats` query to contain the new chat. We will also check if the chat already exists before we update the query, because remember, the `addChat` mutation will return the chat even if it already exists, not if it was created only:\n\n[{]: <helper> (diffStep 12.3 module=\"client\")\n\n#### [__Client__ Step 12.3: Write chat on chatAdded](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/20cef4aadf44091a63251bf359aa50062938f6d7)\n\n##### Changed src&#x2F;components&#x2F;ChatCreationScreen&#x2F;index.tsx\n```diff\n@@ -7,6 +7,7 @@\n â”Š 7â”Š 7â”Šimport ChatCreationNavbar from './ChatCreationNavbar';\n â”Š 8â”Š 8â”Šimport { History } from 'history';\n â”Š 9â”Š 9â”Šimport { useAddChatMutation } from '../../graphql/types';\n+â”Š  â”Š10â”Šimport { writeChat } from '../../services/cache.service';\n â”Š10â”Š11â”Š\n â”Š11â”Š12â”Š// eslint-disable-next-line\n â”Š12â”Š13â”Šconst Container = styled.div`\n```\n```diff\n@@ -52,6 +53,9 @@\n â”Š52â”Š53â”Š        variables: {\n â”Š53â”Š54â”Š          recipientId: user.id,\n â”Š54â”Š55â”Š        },\n+â”Š  â”Š56â”Š        update: (client, { data: { addChat } }) => {\n+â”Š  â”Š57â”Š          writeChat(client, addChat);\n+â”Š  â”Š58â”Š        },\n â”Š55â”Š59â”Š      }).then(result => {\n â”Š56â”Š60â”Š        if (result && result.data !== null) {\n â”Š57â”Š61â”Š          history.push(`/chats/${result.data!.addChat!.id}`);\n```\n\n##### Added src&#x2F;graphql&#x2F;subscriptions&#x2F;chatAdded.subscription.ts\n```diff\n@@ -0,0 +1,11 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag';\n+â”Š  â”Š 2â”Šimport * as fragments from '../fragments';\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šexport default gql`\n+â”Š  â”Š 5â”Š  subscription ChatAdded {\n+â”Š  â”Š 6â”Š    chatAdded {\n+â”Š  â”Š 7â”Š      ...Chat\n+â”Š  â”Š 8â”Š    }\n+â”Š  â”Š 9â”Š  }\n+â”Š  â”Š10â”Š  ${fragments.chat}\n+â”Š  â”Š11â”Š`;\n```\n\n##### Changed src&#x2F;graphql&#x2F;subscriptions&#x2F;index.ts\n```diff\n@@ -1 +1,2 @@\n â”Š1â”Š1â”Šexport { default as messageAdded } from './messageAdded.subscription';\n+â”Š â”Š2â”Šexport { default as chatAdded } from './chatAdded.subscription';\n```\n\n##### Changed src&#x2F;services&#x2F;cache.service.ts\n```diff\n@@ -3,7 +3,12 @@\n â”Š 3â”Š 3â”Šimport { ApolloClient } from 'apollo-client';\n â”Š 4â”Š 4â”Šimport * as fragments from '../graphql/fragments';\n â”Š 5â”Š 5â”Šimport * as queries from '../graphql/queries';\n-â”Š 6â”Š  â”Šimport { MessageFragment, useMessageAddedSubscription } from '../graphql/types';\n+â”Š  â”Š 6â”Šimport {\n+â”Š  â”Š 7â”Š  MessageFragment,\n+â”Š  â”Š 8â”Š  ChatFragment,\n+â”Š  â”Š 9â”Š  useMessageAddedSubscription,\n+â”Š  â”Š10â”Š  useChatAddedSubscription,\n+â”Š  â”Š11â”Š} from '../graphql/types';\n â”Š 7â”Š12â”Š\n â”Š 8â”Š13â”Štype Client = ApolloClient<any> | DataProxy;\n â”Š 9â”Š14â”Š\n```\n```diff\n@@ -15,6 +20,14 @@\n â”Š15â”Š20â”Š      }\n â”Š16â”Š21â”Š    },\n â”Š17â”Š22â”Š  });\n+â”Š  â”Š23â”Š\n+â”Š  â”Š24â”Š  useChatAddedSubscription({\n+â”Š  â”Š25â”Š    onSubscriptionData: ({ client, subscriptionData: { data } }) => {\n+â”Š  â”Š26â”Š      if (data) {\n+â”Š  â”Š27â”Š        writeChat(client, data.chatAdded);\n+â”Š  â”Š28â”Š      }\n+â”Š  â”Š29â”Š    },\n+â”Š  â”Š30â”Š  });\n â”Š18â”Š31â”Š};\n â”Š19â”Š32â”Š\n â”Š20â”Š33â”Šexport const writeMessage = (client: Client, message: MessageFragment) => {\n```\n```diff\n@@ -84,3 +97,40 @@\n â”Š 84â”Š 97â”Š    data: { chats: chats },\n â”Š 85â”Š 98â”Š  });\n â”Š 86â”Š 99â”Š};\n+â”Š   â”Š100â”Š\n+â”Š   â”Š101â”Šexport const writeChat = (client: Client, chat: ChatFragment) => {\n+â”Š   â”Š102â”Š  const chatId = defaultDataIdFromObject(chat);\n+â”Š   â”Š103â”Š  if (chatId === null) {\n+â”Š   â”Š104â”Š    return;\n+â”Š   â”Š105â”Š  }\n+â”Š   â”Š106â”Š\n+â”Š   â”Š107â”Š  client.writeFragment({\n+â”Š   â”Š108â”Š    id: chatId,\n+â”Š   â”Š109â”Š    fragment: fragments.chat,\n+â”Š   â”Š110â”Š    fragmentName: 'Chat',\n+â”Š   â”Š111â”Š    data: chat,\n+â”Š   â”Š112â”Š  });\n+â”Š   â”Š113â”Š\n+â”Š   â”Š114â”Š  let data;\n+â”Š   â”Š115â”Š  try {\n+â”Š   â”Š116â”Š    data = client.readQuery({\n+â”Š   â”Š117â”Š      query: queries.chats,\n+â”Š   â”Š118â”Š    });\n+â”Š   â”Š119â”Š  } catch (e) {\n+â”Š   â”Š120â”Š    return;\n+â”Š   â”Š121â”Š  }\n+â”Š   â”Š122â”Š\n+â”Š   â”Š123â”Š  if (!data) return;\n+â”Š   â”Š124â”Š\n+â”Š   â”Š125â”Š  const chats = data.chats;\n+â”Š   â”Š126â”Š\n+â”Š   â”Š127â”Š  if (!chats) return;\n+â”Š   â”Š128â”Š  if (chats.some((c: any) => c.id === chat.id)) return;\n+â”Š   â”Š129â”Š\n+â”Š   â”Š130â”Š  chats.unshift(chat);\n+â”Š   â”Š131â”Š\n+â”Š   â”Š132â”Š  client.writeQuery({\n+â”Š   â”Š133â”Š    query: queries.chats,\n+â”Š   â”Š134â”Š    data: { chats },\n+â”Š   â”Š135â”Š  });\n+â”Š   â”Š136â”Š};\n```\n\n[}]: #\n\nNow we can create new chats, and the chats list would be updated, without refreshing the page. You can also test it with 2 separate sessions in the browser and see how each tab/window affects the other. Lastly, we will implement a chat removal function. This is important as we donâ€™t want to garbage our chats collection, sometimes we would like to clean up some of them.\n\nIn the back-end, letâ€™s implement the `removeChat` mutation. The chat can only be removed only if the current user is one of the chatâ€™s participants. The mutation will also remove all the messages which are related to the target chat, since weâ€™re not gonna use them anymore. The chat will be removed for all participants. This is not exactly the behavior of the original Whatsapp, but to keep things simple we will go with that solution:\n\n[{]: <helper> (diffStep 9.4 module=\"server\")\n\n#### [__Server__ Step 9.4: Add Mutation.removeChat](https://github.com/Urigo/WhatsApp-Clone-Server/commit/c13dbecef37e5db66a6403cfd533a625c0c69be7)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -152,6 +152,30 @@\n â”Š152â”Š152â”Š\n â”Š153â”Š153â”Š      return chat;\n â”Š154â”Š154â”Š    },\n+â”Š   â”Š155â”Š\n+â”Š   â”Š156â”Š    removeChat(root, { chatId }, { currentUser }) {\n+â”Š   â”Š157â”Š      if (!currentUser) return null;\n+â”Š   â”Š158â”Š\n+â”Š   â”Š159â”Š      const chatIndex = chats.findIndex(c => c.id === chatId);\n+â”Š   â”Š160â”Š\n+â”Š   â”Š161â”Š      if (chatIndex === -1) return null;\n+â”Š   â”Š162â”Š\n+â”Š   â”Š163â”Š      const chat = chats[chatIndex];\n+â”Š   â”Š164â”Š\n+â”Š   â”Š165â”Š      if (!chat.participants.some(p => p === currentUser.id)) return null;\n+â”Š   â”Š166â”Š\n+â”Š   â”Š167â”Š      chat.messages.forEach(chatMessage => {\n+â”Š   â”Š168â”Š        const chatMessageIndex = messages.findIndex(m => m.id === chatMessage);\n+â”Š   â”Š169â”Š\n+â”Š   â”Š170â”Š        if (chatMessageIndex !== -1) {\n+â”Š   â”Š171â”Š          messages.splice(chatMessageIndex, 1);\n+â”Š   â”Š172â”Š        }\n+â”Š   â”Š173â”Š      });\n+â”Š   â”Š174â”Š\n+â”Š   â”Š175â”Š      chats.splice(chatIndex, 1);\n+â”Š   â”Š176â”Š\n+â”Š   â”Š177â”Š      return chatId;\n+â”Š   â”Š178â”Š    },\n â”Š155â”Š179â”Š  },\n â”Š156â”Š180â”Š\n â”Š157â”Š181â”Š  Subscription: {\n```\n\n##### Changed schema&#x2F;typeDefs.graphql\n```diff\n@@ -34,6 +34,7 @@\n â”Š34â”Š34â”Štype Mutation {\n â”Š35â”Š35â”Š  addMessage(chatId: ID!, content: String!): Message\n â”Š36â”Š36â”Š  addChat(recipientId: ID!): Chat\n+â”Š  â”Š37â”Š  removeChat(chatId: ID!): ID\n â”Š37â”Š38â”Š}\n â”Š38â”Š39â”Š\n â”Š39â”Š40â”Štype Subscription {\n```\n\n##### Added tests&#x2F;mutations&#x2F;removeChat.test.ts\n```diff\n@@ -0,0 +1,52 @@\n+â”Š  â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n+â”Š  â”Š 2â”Šimport { ApolloServer, PubSub, gql } from 'apollo-server-express';\n+â”Š  â”Š 3â”Šimport schema from '../../schema';\n+â”Š  â”Š 4â”Šimport { resetDb, users } from '../../db';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šdescribe('Mutation.removeChat', () => {\n+â”Š  â”Š 7â”Š  beforeEach(resetDb);\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Š  it('removes chat by id', async () => {\n+â”Š  â”Š10â”Š    const server = new ApolloServer({\n+â”Š  â”Š11â”Š      schema,\n+â”Š  â”Š12â”Š      context: () => ({\n+â”Š  â”Š13â”Š        pubsub: new PubSub(),\n+â”Š  â”Š14â”Š        currentUser: users[0],\n+â”Š  â”Š15â”Š      }),\n+â”Š  â”Š16â”Š    });\n+â”Š  â”Š17â”Š\n+â”Š  â”Š18â”Š    const { query, mutate } = createTestClient(server);\n+â”Š  â”Š19â”Š\n+â”Š  â”Š20â”Š    const addChatRes = await mutate({\n+â”Š  â”Š21â”Š      variables: { chatId: '1' },\n+â”Š  â”Š22â”Š      mutation: gql`\n+â”Š  â”Š23â”Š        mutation RemoveChat($chatId: ID!) {\n+â”Š  â”Š24â”Š          removeChat(chatId: $chatId)\n+â”Š  â”Š25â”Š        }\n+â”Š  â”Š26â”Š      `,\n+â”Š  â”Š27â”Š    });\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š    expect(addChatRes.data).toBeDefined();\n+â”Š  â”Š30â”Š    expect(addChatRes.errors).toBeUndefined();\n+â”Š  â”Š31â”Š    expect(addChatRes.data!.removeChat).toEqual('1');\n+â”Š  â”Š32â”Š\n+â”Š  â”Š33â”Š    const getChatRes = await query({\n+â”Š  â”Š34â”Š      variables: { chatId: '1' },\n+â”Š  â”Š35â”Š      query: gql`\n+â”Š  â”Š36â”Š        query GetChat($chatId: ID!) {\n+â”Š  â”Š37â”Š          chat(chatId: $chatId) {\n+â”Š  â”Š38â”Š            id\n+â”Š  â”Š39â”Š            name\n+â”Š  â”Š40â”Š            participants {\n+â”Š  â”Š41â”Š              id\n+â”Š  â”Š42â”Š            }\n+â”Š  â”Š43â”Š          }\n+â”Š  â”Š44â”Š        }\n+â”Š  â”Š45â”Š      `,\n+â”Š  â”Š46â”Š    });\n+â”Š  â”Š47â”Š\n+â”Š  â”Š48â”Š    expect(addChatRes.data).toBeDefined();\n+â”Š  â”Š49â”Š    expect(getChatRes.errors).toBeUndefined();\n+â”Š  â”Š50â”Š    expect(addChatRes.data!.chat).toBeUndefined();\n+â”Š  â”Š51â”Š  });\n+â”Š  â”Š52â”Š});\n```\n\n[}]: #\n\nIn the client app, a chat could be removed directly from the `ChatRoomScreen`. On the top right corner, right on the navbar, we will add a dispose button that will call the `removeChat` mutation. Just like we did before, we will define the mutation document with `graphql-tag` and generate the correlated hook with CodeGen:\n\n[{]: <helper> (diffStep 12.4 module=\"client\")\n\n#### [__Client__ Step 12.4: Add chat removal function](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/bd74306a669a7cf0e0693cabafc3de1b8965a2ce)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;ChatNavbar.test.tsx\n```diff\n@@ -1,12 +1,16 @@\n â”Š 1â”Š 1â”Šimport { createMemoryHistory } from 'history';\n â”Š 2â”Š 2â”Šimport React from 'react';\n+â”Š  â”Š 3â”Šimport { ApolloProvider } from '@apollo/react-hooks';\n â”Š 3â”Š 4â”Šimport { cleanup, render, fireEvent, wait } from '@testing-library/react';\n+â”Š  â”Š 5â”Šimport { mockApolloClient } from '../../test-helpers';\n â”Š 4â”Š 6â”Šimport ChatNavbar from './ChatNavbar';\n+â”Š  â”Š 7â”Šimport { RemoveChatDocument } from '../../graphql/types';\n â”Š 5â”Š 8â”Š\n â”Š 6â”Š 9â”Šdescribe('ChatNavbar', () => {\n â”Š 7â”Š10â”Š  afterEach(cleanup);\n â”Š 8â”Š11â”Š\n â”Š 9â”Š12â”Š  it('renders chat data', () => {\n+â”Š  â”Š13â”Š    const client = mockApolloClient();\n â”Š10â”Š14â”Š\n â”Š11â”Š15â”Š    const time = new Date('1 Jan 2019 GMT');\n â”Š12â”Š16â”Š    const chat = {\n```\n```diff\n@@ -30,7 +34,11 @@\n â”Š30â”Š34â”Š    const history = createMemoryHistory();\n â”Š31â”Š35â”Š\n â”Š32â”Š36â”Š    {\n-â”Š33â”Š  â”Š      const { container, getByTestId } = render(<ChatNavbar chat={chat} history={history}/>);\n+â”Š  â”Š37â”Š      const { container, getByTestId } = render(\n+â”Š  â”Š38â”Š        <ApolloProvider client={client}>\n+â”Š  â”Š39â”Š          <ChatNavbar chat={chat} history={history}/>\n+â”Š  â”Š40â”Š        </ApolloProvider>\n+â”Š  â”Š41â”Š      );\n â”Š34â”Š42â”Š\n â”Š35â”Š43â”Š      expect(getByTestId('chat-name')).toHaveTextContent('Foo Bar');\n â”Š36â”Š44â”Š      expect(getByTestId('chat-picture')).toHaveAttribute(\n```\n```diff\n@@ -41,6 +49,8 @@\n â”Š41â”Š49â”Š  });\n â”Š42â”Š50â”Š\n â”Š43â”Š51â”Š  it('goes back on arrow click', async () => {\n+â”Š  â”Š52â”Š    const client = mockApolloClient();\n+â”Š  â”Š53â”Š\n â”Š44â”Š54â”Š    const time = new Date('1 Jan 2019 GMT');\n â”Š45â”Š55â”Š    const chat = {\n â”Š46â”Š56â”Š      id: '1',\n```\n```diff\n@@ -68,7 +78,9 @@\n â”Š68â”Š78â”Š\n â”Š69â”Š79â”Š    {\n â”Š70â”Š80â”Š      const { container, getByTestId } = render(\n-â”Š71â”Š  â”Š        <ChatNavbar chat={chat} history={history} />\n+â”Š  â”Š81â”Š        <ApolloProvider client={client}>\n+â”Š  â”Š82â”Š          <ChatNavbar chat={chat} history={history} />\n+â”Š  â”Š83â”Š        </ApolloProvider>\n â”Š72â”Š84â”Š      );\n â”Š73â”Š85â”Š\n â”Š74â”Š86â”Š      fireEvent.click(getByTestId('back-button'));\n```\n```diff\n@@ -76,4 +88,57 @@\n â”Š 76â”Š 88â”Š      await wait(() => expect(history.location.pathname).toEqual('/chats'));\n â”Š 77â”Š 89â”Š    }\n â”Š 78â”Š 90â”Š  });\n+â”Š   â”Š 91â”Š\n+â”Š   â”Š 92â”Š  it('goes back on chat removal', async () => {\n+â”Š   â”Š 93â”Š    const client = mockApolloClient([\n+â”Š   â”Š 94â”Š      {\n+â”Š   â”Š 95â”Š        request: {\n+â”Š   â”Š 96â”Š          query: RemoveChatDocument,\n+â”Š   â”Š 97â”Š          variables: { chatId: '1' },\n+â”Š   â”Š 98â”Š        },\n+â”Š   â”Š 99â”Š        result: {\n+â”Š   â”Š100â”Š          data: {\n+â”Š   â”Š101â”Š            removeChat: '1',\n+â”Š   â”Š102â”Š          },\n+â”Š   â”Š103â”Š        },\n+â”Š   â”Š104â”Š      },\n+â”Š   â”Š105â”Š    ]);\n+â”Š   â”Š106â”Š\n+â”Š   â”Š107â”Š    const time = new Date('1 Jan 2019 GMT');\n+â”Š   â”Š108â”Š    const chat = {\n+â”Š   â”Š109â”Š      id: '1',\n+â”Š   â”Š110â”Š      name: 'Foo Bar',\n+â”Š   â”Š111â”Š      picture: 'https://localhost:4000/picture.jpg',\n+â”Š   â”Š112â”Š      messages: [\n+â”Š   â”Š113â”Š        {\n+â”Š   â”Š114â”Š          id: '1',\n+â”Š   â”Š115â”Š          content: 'foo',\n+â”Š   â”Š116â”Š          createdAt: time,\n+â”Š   â”Š117â”Š        },\n+â”Š   â”Š118â”Š        {\n+â”Š   â”Š119â”Š          id: '2',\n+â”Š   â”Š120â”Š          content: 'bar',\n+â”Š   â”Š121â”Š          createdAt: time,\n+â”Š   â”Š122â”Š        },\n+â”Š   â”Š123â”Š      ]\n+â”Š   â”Š124â”Š    };\n+â”Š   â”Š125â”Š\n+â”Š   â”Š126â”Š    const history = createMemoryHistory();\n+â”Š   â”Š127â”Š\n+â”Š   â”Š128â”Š    history.push('/chats/1');\n+â”Š   â”Š129â”Š\n+â”Š   â”Š130â”Š    await wait(() => expect(history.location.pathname).toEqual('/chats/1'));\n+â”Š   â”Š131â”Š\n+â”Š   â”Š132â”Š    {\n+â”Š   â”Š133â”Š      const { container, getByTestId } = render(\n+â”Š   â”Š134â”Š        <ApolloProvider client={client}>\n+â”Š   â”Š135â”Š          <ChatNavbar chat={chat} history={history} />\n+â”Š   â”Š136â”Š        </ApolloProvider>\n+â”Š   â”Š137â”Š      );\n+â”Š   â”Š138â”Š\n+â”Š   â”Š139â”Š      fireEvent.click(getByTestId('delete-button'));\n+â”Š   â”Š140â”Š\n+â”Š   â”Š141â”Š      await wait(() => expect(history.location.pathname).toEqual('/chats'));\n+â”Š   â”Š142â”Š    }\n+â”Š   â”Š143â”Š  });\n â”Š 79â”Š144â”Š});\n```\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;ChatNavbar.tsx\n```diff\n@@ -1,10 +1,13 @@\n â”Š 1â”Š 1â”Šimport Button from '@material-ui/core/Button';\n â”Š 2â”Š 2â”Šimport Toolbar from '@material-ui/core/Toolbar';\n â”Š 3â”Š 3â”Šimport ArrowBackIcon from '@material-ui/icons/ArrowBack';\n+â”Š  â”Š 4â”Šimport DeleteIcon from '@material-ui/icons/Delete';\n+â”Š  â”Š 5â”Šimport gql from 'graphql-tag';\n â”Š 4â”Š 6â”Šimport React from 'react';\n â”Š 5â”Š 7â”Šimport { useCallback } from 'react';\n â”Š 6â”Š 8â”Šimport styled from 'styled-components';\n â”Š 7â”Š 9â”Šimport { History } from 'history';\n+â”Š  â”Š10â”Šimport { useRemoveChatMutation } from '../../graphql/types';\n â”Š 8â”Š11â”Š\n â”Š 9â”Š12â”Šconst Container = styled(Toolbar)`\n â”Š10â”Š13â”Š  padding: 0;\n```\n```diff\n@@ -20,6 +23,12 @@\n â”Š20â”Š23â”Š  }\n â”Š21â”Š24â”Š`;\n â”Š22â”Š25â”Š\n+â”Š  â”Š26â”Šconst Rest = styled.div`\n+â”Š  â”Š27â”Š  flex: 1;\n+â”Š  â”Š28â”Š  display: flex;\n+â”Š  â”Š29â”Š  justify-content: flex-end;\n+â”Š  â”Š30â”Š`;\n+â”Š  â”Š31â”Š\n â”Š23â”Š32â”Šconst Picture = styled.img`\n â”Š24â”Š33â”Š  height: 40px;\n â”Š25â”Š34â”Š  width: 40px;\n```\n```diff\n@@ -34,15 +43,38 @@\n â”Š34â”Š43â”Š  line-height: 56px;\n â”Š35â”Š44â”Š`;\n â”Š36â”Š45â”Š\n+â”Š  â”Š46â”Šconst DeleteButton = styled(Button)`\n+â”Š  â”Š47â”Š  color: var(--primary-text) !important;\n+â”Š  â”Š48â”Š`;\n+â”Š  â”Š49â”Š\n+â”Š  â”Š50â”Šexport const removeChatMutation = gql`\n+â”Š  â”Š51â”Š  mutation RemoveChat($chatId: ID!) {\n+â”Š  â”Š52â”Š    removeChat(chatId: $chatId)\n+â”Š  â”Š53â”Š  }\n+â”Š  â”Š54â”Š`;\n+â”Š  â”Š55â”Š\n â”Š37â”Š56â”Šinterface ChatNavbarProps {\n â”Š38â”Š57â”Š  history: History;\n-â”Š39â”Š  â”Š  chat?: {\n+â”Š  â”Š58â”Š  chat: {\n â”Š40â”Š59â”Š    picture?: string | null;\n â”Š41â”Š60â”Š    name?: string | null;\n+â”Š  â”Š61â”Š    id: string;\n â”Š42â”Š62â”Š  };\n â”Š43â”Š63â”Š}\n â”Š44â”Š64â”Š\n â”Š45â”Š65â”Šconst ChatNavbar: React.FC<ChatNavbarProps> = ({ chat, history }) => {\n+â”Š  â”Š66â”Š  const [removeChat] = useRemoveChatMutation({\n+â”Š  â”Š67â”Š    variables: {\n+â”Š  â”Š68â”Š      chatId: chat.id,\n+â”Š  â”Š69â”Š    },\n+â”Š  â”Š70â”Š  });\n+â”Š  â”Š71â”Š\n+â”Š  â”Š72â”Š  const handleRemoveChat = useCallback(() => {\n+â”Š  â”Š73â”Š    removeChat().then(() => {\n+â”Š  â”Š74â”Š      history.replace('/chats');\n+â”Š  â”Š75â”Š    });\n+â”Š  â”Š76â”Š  }, [removeChat, history]);\n+â”Š  â”Š77â”Š\n â”Š46â”Š78â”Š  const navBack = useCallback(() => {\n â”Š47â”Š79â”Š    history.replace('/chats');\n â”Š48â”Š80â”Š  }, [history]);\n```\n```diff\n@@ -58,6 +90,11 @@\n â”Š 58â”Š 90â”Š          <Name data-testid=\"chat-name\">{chat.name}</Name>\n â”Š 59â”Š 91â”Š        </React.Fragment>\n â”Š 60â”Š 92â”Š      )}\n+â”Š   â”Š 93â”Š      <Rest>\n+â”Š   â”Š 94â”Š        <DeleteButton data-testid=\"delete-button\" onClick={handleRemoveChat}>\n+â”Š   â”Š 95â”Š          <DeleteIcon />\n+â”Š   â”Š 96â”Š        </DeleteButton>\n+â”Š   â”Š 97â”Š      </Rest>\n â”Š 61â”Š 98â”Š    </Container>\n â”Š 62â”Š 99â”Š  );\n â”Š 63â”Š100â”Š};\n```\n\n[}]: #\n\nNormally this is a dangerous behavior because we wipe out the entire history without any warnings, which is not recommended. For tutoring purposes only we will keep it the way it is, because it makes things simple and easier to understand.\n\nTo be able to update the chats list cache, we will implement a `chatRemoved` subscription. The subscription will be broadcasted only to those whoâ€™re participants of the published chat:\n\n[{]: <helper> (diffStep 9.5 module=\"server\")\n\n#### [__Server__ Step 9.5: Add Subscription.chatRemoved](https://github.com/Urigo/WhatsApp-Clone-Server/commit/d881ea725ef772e717e82edf1cbc1ce8bfb953b6)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -153,7 +153,7 @@\n â”Š153â”Š153â”Š      return chat;\n â”Š154â”Š154â”Š    },\n â”Š155â”Š155â”Š\n-â”Š156â”Š   â”Š    removeChat(root, { chatId }, { currentUser }) {\n+â”Š   â”Š156â”Š    removeChat(root, { chatId }, { currentUser, pubsub }) {\n â”Š157â”Š157â”Š      if (!currentUser) return null;\n â”Š158â”Š158â”Š\n â”Š159â”Š159â”Š      const chatIndex = chats.findIndex(c => c.id === chatId);\n```\n```diff\n@@ -174,6 +174,11 @@\n â”Š174â”Š174â”Š\n â”Š175â”Š175â”Š      chats.splice(chatIndex, 1);\n â”Š176â”Š176â”Š\n+â”Š   â”Š177â”Š      pubsub.publish('chatRemoved', {\n+â”Š   â”Š178â”Š        chatRemoved: chat.id,\n+â”Š   â”Š179â”Š        targetChat: chat,\n+â”Š   â”Š180â”Š      });\n+â”Š   â”Š181â”Š\n â”Š177â”Š182â”Š      return chatId;\n â”Š178â”Š183â”Š    },\n â”Š179â”Š184â”Š  },\n```\n```diff\n@@ -202,6 +207,17 @@\n â”Š202â”Š207â”Š        }\n â”Š203â”Š208â”Š      ),\n â”Š204â”Š209â”Š    },\n+â”Š   â”Š210â”Š\n+â”Š   â”Š211â”Š    chatRemoved: {\n+â”Š   â”Š212â”Š      subscribe: withFilter(\n+â”Š   â”Š213â”Š        (root, args, { pubsub }) => pubsub.asyncIterator('chatRemoved'),\n+â”Š   â”Š214â”Š        ({ targetChat }: { targetChat: Chat }, args, { currentUser }) => {\n+â”Š   â”Š215â”Š          if (!currentUser) return false;\n+â”Š   â”Š216â”Š\n+â”Š   â”Š217â”Š          return targetChat.participants.some(p => p === currentUser.id);\n+â”Š   â”Š218â”Š        }\n+â”Š   â”Š219â”Š      ),\n+â”Š   â”Š220â”Š    },\n â”Š205â”Š221â”Š  },\n â”Š206â”Š222â”Š};\n â”Š207â”Š223â”Š\n```\n\n##### Changed schema&#x2F;typeDefs.graphql\n```diff\n@@ -40,4 +40,5 @@\n â”Š40â”Š40â”Štype Subscription {\n â”Š41â”Š41â”Š  messageAdded: Message!\n â”Š42â”Š42â”Š  chatAdded: Chat!\n+â”Š  â”Š43â”Š  chatRemoved: ID!\n â”Š43â”Š44â”Š}\n```\n\n[}]: #\n\nIn the client, we will define the right subscription document:\n\n[{]: <helper> (diffStep 12.5 files=\"graphql/subscriptions\" module=\"client\")\n\n#### [__Client__ Step 12.5: Update cache on chat removal](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/5df52ae6401b5e6a250d83865988624e075c7154)\n\n##### Added src&#x2F;graphql&#x2F;subscriptions&#x2F;chatRemoved.subscription.ts\n```diff\n@@ -0,0 +1,7 @@\n+â”Š â”Š1â”Šimport gql from 'graphql-tag';\n+â”Š â”Š2â”Š\n+â”Š â”Š3â”Šexport default gql`\n+â”Š â”Š4â”Š  subscription ChatRemoved {\n+â”Š â”Š5â”Š    chatRemoved\n+â”Š â”Š6â”Š  }\n+â”Š â”Š7â”Š`;\n```\n\n##### Changed src&#x2F;graphql&#x2F;subscriptions&#x2F;index.ts\n```diff\n@@ -1,2 +1,3 @@\n â”Š1â”Š1â”Šexport { default as messageAdded } from './messageAdded.subscription';\n â”Š2â”Š2â”Šexport { default as chatAdded } from './chatAdded.subscription';\n+â”Š â”Š3â”Šexport { default as chatRemoved } from './chatRemoved.subscription';\n```\n\n[}]: #\n\nAnd we will update the `cache.service` to listen to the new subscription and update the `chats` query accordingly. When we deal with the fragment, we remove the `FullChat` fragment because it consists of the `Chat` fragment. If it was the other way around, we would still have some data leftovers from the `FullChat` on the fragment, because of how Apollo-Cache manages the store:\n\n[{]: <helper> (diffStep 12.5 files=\"cache.service\" module=\"client\")\n\n#### [__Client__ Step 12.5: Update cache on chat removal](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/5df52ae6401b5e6a250d83865988624e075c7154)\n\n##### Changed src&#x2F;services&#x2F;cache.service.ts\n```diff\n@@ -8,6 +8,7 @@\n â”Š 8â”Š 8â”Š  ChatFragment,\n â”Š 9â”Š 9â”Š  useMessageAddedSubscription,\n â”Š10â”Š10â”Š  useChatAddedSubscription,\n+â”Š  â”Š11â”Š  useChatRemovedSubscription,\n â”Š11â”Š12â”Š} from '../graphql/types';\n â”Š12â”Š13â”Š\n â”Š13â”Š14â”Štype Client = ApolloClient<any> | DataProxy;\n```\n```diff\n@@ -28,6 +29,14 @@\n â”Š28â”Š29â”Š      }\n â”Š29â”Š30â”Š    },\n â”Š30â”Š31â”Š  });\n+â”Š  â”Š32â”Š\n+â”Š  â”Š33â”Š  useChatRemovedSubscription({\n+â”Š  â”Š34â”Š    onSubscriptionData: ({ client, subscriptionData: { data } }) => {\n+â”Š  â”Š35â”Š      if (data) {\n+â”Š  â”Š36â”Š        eraseChat(client, data.chatRemoved);\n+â”Š  â”Š37â”Š      }\n+â”Š  â”Š38â”Š    },\n+â”Š  â”Š39â”Š  });\n â”Š31â”Š40â”Š};\n â”Š32â”Š41â”Š\n â”Š33â”Š42â”Šexport const writeMessage = (client: Client, message: MessageFragment) => {\n```\n```diff\n@@ -134,3 +143,49 @@\n â”Š134â”Š143â”Š    data: { chats },\n â”Š135â”Š144â”Š  });\n â”Š136â”Š145â”Š};\n+â”Š   â”Š146â”Š\n+â”Š   â”Š147â”Šexport const eraseChat = (client: Client, chatId: string) => {\n+â”Š   â”Š148â”Š  const chatType = {\n+â”Š   â”Š149â”Š    __typename: 'Chat',\n+â”Š   â”Š150â”Š    id: chatId,\n+â”Š   â”Š151â”Š  };\n+â”Š   â”Š152â”Š\n+â”Š   â”Š153â”Š  const chatIdFromObject = defaultDataIdFromObject(chatType);\n+â”Š   â”Š154â”Š  if (chatIdFromObject === null) {\n+â”Š   â”Š155â”Š    return;\n+â”Š   â”Š156â”Š  }\n+â”Š   â”Š157â”Š\n+â”Š   â”Š158â”Š  client.writeFragment({\n+â”Š   â”Š159â”Š    id: chatIdFromObject,\n+â”Š   â”Š160â”Š    fragment: fragments.fullChat,\n+â”Š   â”Š161â”Š    fragmentName: 'FullChat',\n+â”Š   â”Š162â”Š    data: null,\n+â”Š   â”Š163â”Š  });\n+â”Š   â”Š164â”Š\n+â”Š   â”Š165â”Š  let data;\n+â”Š   â”Š166â”Š  try {\n+â”Š   â”Š167â”Š    data = client.readQuery({\n+â”Š   â”Š168â”Š      query: queries.chats,\n+â”Š   â”Š169â”Š    });\n+â”Š   â”Š170â”Š  } catch (e) {\n+â”Š   â”Š171â”Š    return;\n+â”Š   â”Š172â”Š  }\n+â”Š   â”Š173â”Š\n+â”Š   â”Š174â”Š  if (!data || !data.chats) return;\n+â”Š   â”Š175â”Š\n+â”Š   â”Š176â”Š  const chats = data.chats;\n+â”Š   â”Š177â”Š\n+â”Š   â”Š178â”Š  if (!chats) return;\n+â”Š   â”Š179â”Š\n+â”Š   â”Š180â”Š  const chatIndex = chats.findIndex((c: any) => c.id === chatId);\n+â”Š   â”Š181â”Š\n+â”Š   â”Š182â”Š  if (chatIndex === -1) return;\n+â”Š   â”Š183â”Š\n+â”Š   â”Š184â”Š  // The chat will appear at the top of the ChatsList component\n+â”Š   â”Š185â”Š  chats.splice(chatIndex, 1);\n+â”Š   â”Š186â”Š\n+â”Š   â”Š187â”Š  client.writeQuery({\n+â”Š   â”Š188â”Š    query: queries.chats,\n+â”Š   â”Š189â”Š    data: { chats: chats },\n+â”Š   â”Š190â”Š  });\n+â”Š   â”Š191â”Š};\n```\n\n[}]: #\n\nWe will also update the `ChatRoomScreen` to redirect us to the `/chats` route if the chat was not found.\n\nThe render method of the component will be re-triggered automatically by `@apollo/react-hooks` if the cached result of `useGetChat()` hook has changed,\nwhich means that even if you didnâ€™t actively remove the chat, you will still be redirected as a result:\n\n[{]: <helper> (diffStep 12.5 files=\"ChatRoom\" module=\"client\")\n\n#### [__Client__ Step 12.5: Update cache on chat removal](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/5df52ae6401b5e6a250d83865988624e075c7154)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;ChatNavbar.tsx\n```diff\n@@ -8,6 +8,7 @@\n â”Š 8â”Š 8â”Šimport styled from 'styled-components';\n â”Š 9â”Š 9â”Šimport { History } from 'history';\n â”Š10â”Š10â”Šimport { useRemoveChatMutation } from '../../graphql/types';\n+â”Š  â”Š11â”Šimport { eraseChat } from '../../services/cache.service';\n â”Š11â”Š12â”Š\n â”Š12â”Š13â”Šconst Container = styled(Toolbar)`\n â”Š13â”Š14â”Š  padding: 0;\n```\n```diff\n@@ -67,6 +68,9 @@\n â”Š67â”Š68â”Š    variables: {\n â”Š68â”Š69â”Š      chatId: chat.id,\n â”Š69â”Š70â”Š    },\n+â”Š  â”Š71â”Š    update: (client, { data: { removeChat } }) => {\n+â”Š  â”Š72â”Š      eraseChat(client, removeChat);\n+â”Š  â”Š73â”Š    },\n â”Š70â”Š74â”Š  });\n â”Š71â”Š75â”Š\n â”Š72â”Š76â”Š  const handleRemoveChat = useCallback(() => {\n```\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -1,6 +1,7 @@\n â”Š1â”Š1â”Šimport gql from 'graphql-tag';\n â”Š2â”Š2â”Šimport React from 'react';\n â”Š3â”Š3â”Šimport { useCallback } from 'react';\n+â”Š â”Š4â”Šimport { Redirect } from 'react-router-dom';\n â”Š4â”Š5â”Šimport styled from 'styled-components';\n â”Š5â”Š6â”Šimport ChatNavbar from './ChatNavbar';\n â”Š6â”Š7â”Šimport MessageInput from './MessageInput';\n```\n```diff\n@@ -95,6 +96,11 @@\n â”Š 95â”Š 96â”Š  if (loadingChat) return null;\n â”Š 96â”Š 97â”Š  if (chat === null) return null;\n â”Š 97â”Š 98â”Š\n+â”Š   â”Š 99â”Š  // Chat was probably removed from cache by the subscription handler\n+â”Š   â”Š100â”Š  if (!chat) {\n+â”Š   â”Š101â”Š    return <Redirect to=\"/chats\" />;\n+â”Š   â”Š102â”Š  }\n+â”Š   â”Š103â”Š\n â”Š 98â”Š104â”Š  return (\n â”Š 99â”Š105â”Š    <Container>\n â”Š100â”Š106â”Š      <ChatNavbar chat={chat} history={history} />\n```\n\n[}]: #\n\nTODO: maybe mention that ApolloCache doesnâ€™t have Garbage Collector so even though the object is removed, everything else related to it says in cache."
          },
          {
            "manualTitle": "Step 13: Authentication",
            "stepRevision": "291c273e35085abf4fd94a3151e8b4567c15c1c8",
            "manualView": "In the previous step weâ€™ve set the ground for the authentication system in our app. We have a users collection which can be used to distinguish which data the client is authorized to view, and we have a context handler which can retrieve the current user logged in based on the received value of the `cookie` header. Itâ€™s definitely a good starting point, but it misses a lot of things.\n\nIn this chapter we will implement a cookie-based authentication system. There are many ways to implement an authentication system in an app, but cookie-based authentication is one of the most popular ones, hence we will go with that method. Essentially the authentication flow in our app should look very simple: a user will be able to sign-in with a dedicated screen, and if he doesnâ€™t own an account he can use the sign-up screen to create a new one. The more complicated part in this flow is the back-end, which is the core of this chapter. So before we get into the implementation, we need to understand the authentication process:\n\n- A user logs in with a username and a password.\nThe server compares the received username and password to the ones stored in the database.\n- If the comparison was successful, the server will generate a token and will set it as a cookie.\n- Each time a request is sent, the server will retrieve the username from the stored token on the cookie header and will send data back accordingly.\n\n![auth-flow](https://user-images.githubusercontent.com/7648874/55929679-55e94200-5c50-11e9-9fe7-54ad6194a572.png)\n\nThe stored token will save us the hassle of re-specifying the username and password over and over again each and every request. Itâ€™s important to note that everything in the authentication process is encrypted, **sensitive information will never be stored or sent in its raw form**, otherwise data might be stolen in case of a DB breach or a request hijacking. This is what it means for our app:\n\n- Passwords will always be stored in an encrypted form in the DB using an algorithm called [Bcrypt](https://en.wikipedia.org/wiki/Bcrypt). Bcrypt has the ability to compare the password in its raw form to the encrypted one, which can help us authorize the user.\n\n- Tokens are self contained. That means that once we decode the encrypted string we can get a hold of the username string. This form of encrypted tokens is called [Json Web Token (JWT)](https://jwt.io/).\n\n> We're not going to elaborate about the algorithm behind each encryption method because we want to focus more on practicality, although it's very much recommended to understand how each method works before proceeding.\n\nThe implementation will follow the principles above. Authentication is a hot topic in the GraphQL world and there are several ways of doing so. We will start with the back-end and set the infrastructure for authentication, and then we will move on to the front-end.\n\nWeâ€™re gonna expose 2 new mutations from GraphQL Schema: `signIn` and `signUp`. `/sign-out` is unnecessary because it can be done locally by deleting the right cookie. Our back-end is gonna grow bigger so first we will separate the Express app from the Apollo Server instance, and extract the env vars to a dedicated module:\n\n[{]: <helper> (diffStep 10.1 module=\"server\")\n\n#### [__Server__ Step 10.1: Separate app into a different module](https://github.com/Urigo/WhatsApp-Clone-Server/commit/c19cc937e4890137a5f644bdb2a80c9f0755461d)\n\n##### Added app.ts\n```diff\n@@ -0,0 +1,14 @@\n+â”Š  â”Š 1â”Šimport cors from 'cors';\n+â”Š  â”Š 2â”Šimport cookieParser from 'cookie-parser';\n+â”Š  â”Š 3â”Šimport express from 'express';\n+â”Š  â”Š 4â”Šimport { origin } from './env';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šexport const app = express();\n+â”Š  â”Š 7â”Š\n+â”Š  â”Š 8â”Šapp.use(cors({ credentials: true, origin }));\n+â”Š  â”Š 9â”Šapp.use(express.json());\n+â”Š  â”Š10â”Šapp.use(cookieParser());\n+â”Š  â”Š11â”Š\n+â”Š  â”Š12â”Šapp.get('/_ping', (req, res) => {\n+â”Š  â”Š13â”Š  res.send('pong');\n+â”Š  â”Š14â”Š});\n```\n\n##### Added env.ts\n```diff\n@@ -0,0 +1,2 @@\n+â”Š â”Š1â”Šexport const origin = process.env.ORIGIN || 'http://localhost:3000';\n+â”Š â”Š2â”Šexport const port = process.env.PORT || 4000;\n```\n\n##### Changed index.ts\n```diff\n@@ -1,23 +1,11 @@\n â”Š 1â”Š 1â”Šimport { ApolloServer, gql, PubSub } from 'apollo-server-express';\n-â”Š 2â”Š  â”Šimport cors from 'cors';\n-â”Š 3â”Š  â”Šimport cookieParser from 'cookie-parser';\n â”Š 4â”Š 2â”Šimport cookie from 'cookie';\n-â”Š 5â”Š  â”Šimport express from 'express';\n â”Š 6â”Š 3â”Šimport http from 'http';\n+â”Š  â”Š 4â”Šimport { app } from './app';\n â”Š 7â”Š 5â”Šimport { users } from './db';\n+â”Š  â”Š 6â”Šimport { origin, port } from './env';\n â”Š 8â”Š 7â”Šimport schema from './schema';\n â”Š 9â”Š 8â”Š\n-â”Š10â”Š  â”Šconst app = express();\n-â”Š11â”Š  â”Š\n-â”Š12â”Š  â”Šconst origin = process.env.ORIGIN || 'http://localhost:3000';\n-â”Š13â”Š  â”Šapp.use(cors({ credentials: true, origin }));\n-â”Š14â”Š  â”Šapp.use(express.json());\n-â”Š15â”Š  â”Šapp.use(cookieParser());\n-â”Š16â”Š  â”Š\n-â”Š17â”Š  â”Šapp.get('/_ping', (req, res) => {\n-â”Š18â”Š  â”Š  res.send('pong');\n-â”Š19â”Š  â”Š});\n-â”Š20â”Š  â”Š\n â”Š21â”Š 9â”Šconst pubsub = new PubSub();\n â”Š22â”Š10â”Šconst server = new ApolloServer({\n â”Š23â”Š11â”Š  schema,\n```\n```diff\n@@ -56,8 +44,6 @@\n â”Š56â”Š44â”Šconst httpServer = http.createServer(app);\n â”Š57â”Š45â”Šserver.installSubscriptionHandlers(httpServer);\n â”Š58â”Š46â”Š\n-â”Š59â”Š  â”Šconst port = process.env.PORT || 4000;\n-â”Š60â”Š  â”Š\n â”Š61â”Š47â”ŠhttpServer.listen(port, () => {\n â”Š62â”Š48â”Š  console.log(`Server is listening on port ${port}`);\n â”Š63â”Š49â”Š});\n```\n\n[}]: #\n\nWe will first start with the `signIn` mutation, so we can test it against pre-defined user credentials, and then we will proceed to implementing the `signUp` mutation. It would be a lot easier to progress this way. For that we will install a couple of packages:\n\n- `bcrypt` - which is responsible for running a one-way encryption against received passwords before theyâ€™re stored in the DB.\n- `jsonwebtoken` - responsible for encrypting the logged-in username before itâ€™s set as a cooky and decrypting it once itâ€™s sent back with a request.\n\n    $ yarn add bcrypt jsonwebtoken\n\n\n    $ yarn add --dev @types/bcrypt @types/jsonwebtoken\n\nAnd we will implement the `signIn` mutation:\n\n[{]: <helper> (diffStep 10.2 module=\"server\")\n\n#### [__Server__ Step 10.2: Add signIn mutation](https://github.com/Urigo/WhatsApp-Clone-Server/commit/efbd6bd70d59795be8e801d823e9248106f0eafb)\n\n##### Changed context.ts\n```diff\n@@ -1,7 +1,9 @@\n â”Š1â”Š1â”Šimport { PubSub } from 'apollo-server-express';\n â”Š2â”Š2â”Šimport { User } from './db';\n+â”Š â”Š3â”Šimport { Response } from 'express';\n â”Š3â”Š4â”Š\n â”Š4â”Š5â”Šexport type MyContext = {\n â”Š5â”Š6â”Š  pubsub: PubSub;\n â”Š6â”Š7â”Š  currentUser: User;\n+â”Š â”Š8â”Š  res: Response;\n â”Š7â”Š9â”Š};\n```\n\n##### Changed env.ts\n```diff\n@@ -1,2 +1,6 @@\n+â”Š â”Š1â”Šexport const expiration = process.env.JWT_EXPIRATION_MS\n+â”Š â”Š2â”Š  ? parseInt(process.env.JWT_EXPIRATION_MS)\n+â”Š â”Š3â”Š  : 24 * 60 * 60 * 1000;\n+â”Š â”Š4â”Šexport const secret = process.env.JWT_SECRET || '70p53cr37';\n â”Š1â”Š5â”Šexport const origin = process.env.ORIGIN || 'http://localhost:3000';\n â”Š2â”Š6â”Šexport const port = process.env.PORT || 4000;\n```\n\n##### Changed index.ts\n```diff\n@@ -23,6 +23,7 @@\n â”Š23â”Š23â”Š    return {\n â”Š24â”Š24â”Š      currentUser: users.find(u => u.id === req.cookies.currentUserId),\n â”Š25â”Š25â”Š      pubsub,\n+â”Š  â”Š26â”Š      res: session.res,\n â”Š26â”Š27â”Š    };\n â”Š27â”Š28â”Š  },\n â”Š28â”Š29â”Š  subscriptions: {\n```\n\n##### Changed package.json\n```diff\n@@ -20,6 +20,7 @@\n â”Š20â”Š20â”Š    \"@graphql-codegen/cli\": \"1.5.0\",\n â”Š21â”Š21â”Š    \"@graphql-codegen/typescript\": \"1.5.0\",\n â”Š22â”Š22â”Š    \"@graphql-codegen/typescript-resolvers\": \"1.5.0\",\n+â”Š  â”Š23â”Š    \"@types/bcrypt\": \"3.0.0\",\n â”Š23â”Š24â”Š    \"@types/cors\": \"2.8.5\",\n â”Š24â”Š25â”Š    \"@types/cookie\": \"0.3.3\",\n â”Š25â”Š26â”Š    \"@types/cookie-parser\": \"1.4.1\",\n```\n```diff\n@@ -27,6 +28,7 @@\n â”Š27â”Š28â”Š    \"@types/graphql\": \"14.2.3\",\n â”Š28â”Š29â”Š    \"@types/graphql-iso-date\": \"3.3.1\",\n â”Š29â”Š30â”Š    \"@types/jest\": \"24.0.17\",\n+â”Š  â”Š31â”Š    \"@types/jsonwebtoken\": \"8.3.3\",\n â”Š30â”Š32â”Š    \"@types/node\": \"12.7.1\",\n â”Š31â”Š33â”Š    \"jest\": \"24.8.0\",\n â”Š32â”Š34â”Š    \"jest-junit\": \"7.0.0\",\n```\n```diff\n@@ -38,6 +40,7 @@\n â”Š38â”Š40â”Š  \"dependencies\": {\n â”Š39â”Š41â”Š    \"apollo-server-express\": \"2.8.1\",\n â”Š40â”Š42â”Š    \"apollo-server-testing\": \"2.8.1\",\n+â”Š  â”Š43â”Š    \"bcrypt\": \"3.0.6\",\n â”Š41â”Š44â”Š    \"cookie\": \"0.4.0\",\n â”Š42â”Š45â”Š    \"cors\": \"2.8.5\",\n â”Š43â”Š46â”Š    \"cookie-parser\": \"1.4.4\",\n```\n```diff\n@@ -45,7 +48,8 @@\n â”Š45â”Š48â”Š    \"graphql\": \"14.4.2\",\n â”Š46â”Š49â”Š    \"graphql-import\": \"0.7.1\",\n â”Š47â”Š50â”Š    \"graphql-iso-date\": \"3.6.1\",\n-â”Š48â”Š  â”Š    \"graphql-tools\": \"4.0.5\"\n+â”Š  â”Š51â”Š    \"graphql-tools\": \"4.0.5\",\n+â”Š  â”Š52â”Š    \"jsonwebtoken\": \"8.5.1\"\n â”Š49â”Š53â”Š  },\n â”Š50â”Š54â”Š  \"jest\": {\n â”Š51â”Š55â”Š    \"transform\": {\n```\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -2,6 +2,9 @@\n â”Š 2â”Š 2â”Šimport { GraphQLDateTime } from 'graphql-iso-date';\n â”Š 3â”Š 3â”Šimport { User, Message, Chat, chats, messages, users } from '../db';\n â”Š 4â”Š 4â”Šimport { Resolvers } from '../types/graphql';\n+â”Š  â”Š 5â”Šimport { secret, expiration } from '../env';\n+â”Š  â”Š 6â”Šimport bcrypt from 'bcrypt';\n+â”Š  â”Š 7â”Šimport jwt from 'jsonwebtoken';\n â”Š 5â”Š 8â”Š\n â”Š 6â”Š 9â”Šconst resolvers: Resolvers = {\n â”Š 7â”Š10â”Š  Date: GraphQLDateTime,\n```\n```diff\n@@ -91,6 +94,26 @@\n â”Š 91â”Š 94â”Š  },\n â”Š 92â”Š 95â”Š\n â”Š 93â”Š 96â”Š  Mutation: {\n+â”Š   â”Š 97â”Š    signIn(root, { username, password }, { res }) {\n+â”Š   â”Š 98â”Š      const user = users.find(u => u.username === username);\n+â”Š   â”Š 99â”Š\n+â”Š   â”Š100â”Š      if (!user) {\n+â”Š   â”Š101â”Š        throw new Error('user not found');\n+â”Š   â”Š102â”Š      }\n+â”Š   â”Š103â”Š\n+â”Š   â”Š104â”Š      const passwordsMatch = bcrypt.compareSync(password, user.password);\n+â”Š   â”Š105â”Š\n+â”Š   â”Š106â”Š      if (!passwordsMatch) {\n+â”Š   â”Š107â”Š        throw new Error('password is incorrect');\n+â”Š   â”Š108â”Š      }\n+â”Š   â”Š109â”Š\n+â”Š   â”Š110â”Š      const authToken = jwt.sign(username, secret);\n+â”Š   â”Š111â”Š\n+â”Š   â”Š112â”Š      res.cookie('authToken', authToken, { maxAge: expiration });\n+â”Š   â”Š113â”Š\n+â”Š   â”Š114â”Š      return user;\n+â”Š   â”Š115â”Š    },\n+â”Š   â”Š116â”Š\n â”Š 94â”Š117â”Š    addMessage(root, { chatId, content }, { currentUser, pubsub }) {\n â”Š 95â”Š118â”Š      if (!currentUser) return null;\n â”Š 96â”Š119â”Š\n```\n\n##### Changed schema&#x2F;typeDefs.graphql\n```diff\n@@ -32,6 +32,7 @@\n â”Š32â”Š32â”Š}\n â”Š33â”Š33â”Š\n â”Š34â”Š34â”Štype Mutation {\n+â”Š  â”Š35â”Š  signIn(username: String!, password: String!): User\n â”Š35â”Š36â”Š  addMessage(chatId: ID!, content: String!): Message\n â”Š36â”Š37â”Š  addChat(recipientId: ID!): Chat\n â”Š37â”Š38â”Š  removeChat(chatId: ID!): ID\n```\n\n[}]: #\n\nAs you can see we use a special secret before we encrypt the username with JWT. The same secret will be used later on to decrypt the token back into username when getting requests. If someone malicious will get a hold of that password, he can fabricate an authentication token for every user that he wants, **thus itâ€™s important to choose a strong secret**.\n\nWhen building the context for our GraphQL resolvers, we will decode the received cookie with JWT using the same secret to determine the username who made the request. Once we have that username, we can simply retrieve the original user from the DB and define it on the context:\n\n[{]: <helper> (diffStep 10.3 module=\"server\")\n\n#### [__Server__ Step 10.3: Get current user from auth token](https://github.com/Urigo/WhatsApp-Clone-Server/commit/b84fb86e87922d61804187a57c537e476bd68934)\n\n##### Changed index.ts\n```diff\n@@ -1,9 +1,10 @@\n â”Š 1â”Š 1â”Šimport { ApolloServer, gql, PubSub } from 'apollo-server-express';\n â”Š 2â”Š 2â”Šimport cookie from 'cookie';\n â”Š 3â”Š 3â”Šimport http from 'http';\n+â”Š  â”Š 4â”Šimport jwt from 'jsonwebtoken';\n â”Š 4â”Š 5â”Šimport { app } from './app';\n â”Š 5â”Š 6â”Šimport { users } from './db';\n-â”Š 6â”Š  â”Šimport { origin, port } from './env';\n+â”Š  â”Š 7â”Šimport { origin, port, secret } from './env';\n â”Š 7â”Š 8â”Šimport schema from './schema';\n â”Š 8â”Š 9â”Š\n â”Š 9â”Š10â”Šconst pubsub = new PubSub();\n```\n```diff\n@@ -20,8 +21,14 @@\n â”Š20â”Š21â”Š      req.cookies = cookie.parse(req.headers.cookie || '');\n â”Š21â”Š22â”Š    }\n â”Š22â”Š23â”Š\n+â”Š  â”Š24â”Š    let currentUser;\n+â”Š  â”Š25â”Š    if (req.cookies.authToken) {\n+â”Š  â”Š26â”Š      const username = jwt.verify(req.cookies.authToken, secret) as string;\n+â”Š  â”Š27â”Š      currentUser = username && users.find(u => u.username === username);\n+â”Š  â”Š28â”Š    }\n+â”Š  â”Š29â”Š\n â”Š23â”Š30â”Š    return {\n-â”Š24â”Š  â”Š      currentUser: users.find(u => u.id === req.cookies.currentUserId),\n+â”Š  â”Š31â”Š      currentUser,\n â”Š25â”Š32â”Š      pubsub,\n â”Š26â”Š33â”Š      res: session.res,\n â”Š27â”Š34â”Š    };\n```\n\n[}]: #\n\nYou might have noticed that the User schema has been updated, because we try to address the `user.username` property. The authentication in our app will be done with a username and a password; accordingly, we will update our User type definitions and the user documents in the users collection mock. The credentials that weâ€™re going to store can actually be used to sign-in to our app:\n\n[{]: <helper> (diffStep 10.4 module=\"server\")\n\n#### [__Server__ Step 10.4: Update user schema to contain credentials](https://github.com/Urigo/WhatsApp-Clone-Server/commit/84fccf59e9bac2d75b35bf70b1ccf591cb762c93)\n\n##### Changed db.ts\n```diff\n@@ -1,6 +1,8 @@\n â”Š1â”Š1â”Šexport type User = {\n â”Š2â”Š2â”Š  id: string;\n â”Š3â”Š3â”Š  name: string;\n+â”Š â”Š4â”Š  username: string;\n+â”Š â”Š5â”Š  password: string;\n â”Š4â”Š6â”Š  picture: string;\n â”Š5â”Š7â”Š};\n â”Š6â”Š8â”Š\n```\n```diff\n@@ -30,26 +32,41 @@\n â”Š30â”Š32â”Š      {\n â”Š31â”Š33â”Š        id: '1',\n â”Š32â”Š34â”Š        name: 'Ray Edwards',\n+â”Š  â”Š35â”Š        username: 'ray',\n+â”Š  â”Š36â”Š        password:\n+â”Š  â”Š37â”Š          '$2a$08$NO9tkFLCoSqX1c5wk3s7z.JfxaVMKA.m7zUDdDwEquo4rvzimQeJm', // 111\n â”Š33â”Š38â”Š        picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n â”Š34â”Š39â”Š      },\n â”Š35â”Š40â”Š      {\n â”Š36â”Š41â”Š        id: '2',\n â”Š37â”Š42â”Š        name: 'Ethan Gonzalez',\n+â”Š  â”Š43â”Š        username: 'ethan',\n+â”Š  â”Š44â”Š        password:\n+â”Š  â”Š45â”Š          '$2a$08$xE4FuCi/ifxjL2S8CzKAmuKLwv18ktksSN.F3XYEnpmcKtpbpeZgO', // 222\n â”Š38â”Š46â”Š        picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n â”Š39â”Š47â”Š      },\n â”Š40â”Š48â”Š      {\n â”Š41â”Š49â”Š        id: '3',\n â”Š42â”Š50â”Š        name: 'Bryan Wallace',\n+â”Š  â”Š51â”Š        username: 'bryan',\n+â”Š  â”Š52â”Š        password:\n+â”Š  â”Š53â”Š          '$2a$08$UHgH7J8G6z1mGQn2qx2kdeWv0jvgHItyAsL9hpEUI3KJmhVW5Q1d.', // 333\n â”Š43â”Š54â”Š        picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n â”Š44â”Š55â”Š      },\n â”Š45â”Š56â”Š      {\n â”Š46â”Š57â”Š        id: '4',\n â”Š47â”Š58â”Š        name: 'Avery Stewart',\n+â”Š  â”Š59â”Š        username: 'avery',\n+â”Š  â”Š60â”Š        password:\n+â”Š  â”Š61â”Š          '$2a$08$wR1k5Q3T9FC7fUgB7Gdb9Os/GV7dGBBf4PLlWT7HERMFhmFDt47xi', // 444\n â”Š48â”Š62â”Š        picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n â”Š49â”Š63â”Š      },\n â”Š50â”Š64â”Š      {\n â”Š51â”Š65â”Š        id: '5',\n â”Š52â”Š66â”Š        name: 'Katie Peterson',\n+â”Š  â”Š67â”Š        username: 'katie',\n+â”Š  â”Š68â”Š        password:\n+â”Š  â”Š69â”Š          '$2a$08$6.mbXqsDX82ZZ7q5d8Osb..JrGSsNp4R3IKj7mxgF6YGT0OmMw242', // 555\n â”Š53â”Š70â”Š        picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n â”Š54â”Š71â”Š      },\n â”Š55â”Š72â”Š    ]\n```\n\n[}]: #\n\nTo test it out, we will run our front-end application and open the dev-console. Using the Apollo Client we will send a request to the `signIn` mutation. We can use the credentials of one of the users stored in the DB. As for now all our restricted routes are observing the `currentUserId` cookie. This is wrong and no longer relevant. Letâ€™s change the `withAuth()` method to observe the `authToken` cookie so we can test our new mutation successfully:\n\n[{]: <helper> (diffStep 13.1 module=\"client\")\n\n#### [__Client__ Step 13.1: Use authToken cookie](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/4aad700fd0a8ec371f47f9fc4a5312fdcc278e3d)\n\n##### Changed src&#x2F;services&#x2F;auth.service.tsx\n```diff\n@@ -22,8 +22,8 @@\n â”Š22â”Š22â”Š  };\n â”Š23â”Š23â”Š};\n â”Š24â”Š24â”Š\n-â”Š25â”Š  â”Šexport const signIn = (currentUserId: string) => {\n-â”Š26â”Š  â”Š  document.cookie = `currentUserId=${currentUserId}`;\n+â”Š  â”Š25â”Šexport const signIn = (authToken: string) => {\n+â”Š  â”Š26â”Š  document.cookie = `authToken=${authToken}`;\n â”Š27â”Š27â”Š\n â”Š28â”Š28â”Š  // This will become async in the near future\n â”Š29â”Š29â”Š  return Promise.resolve();\n```\n```diff\n@@ -35,7 +35,7 @@\n â”Š35â”Š35â”Š  return useCallback(() => {\n â”Š36â”Š36â”Š    // \"expires\" represents the lifespan of a cookie. Beyond that date the cookie will\n â”Š37â”Š37â”Š    // be deleted by the browser. \"expires\" cannot be viewed from \"document.cookie\"\n-â”Š38â”Š  â”Š    document.cookie = `currentUserId=;expires=${new Date(0)}`;\n+â”Š  â”Š38â”Š    document.cookie = `authToken=;expires=${new Date(0)}`;\n â”Š39â”Š39â”Š\n â”Š40â”Š40â”Š    // Clear cache\n â”Š41â”Š41â”Š    return client.clearStore();\n```\n```diff\n@@ -43,5 +43,5 @@\n â”Š43â”Š43â”Š};\n â”Š44â”Š44â”Š\n â”Š45â”Š45â”Šexport const isSignedIn = () => {\n-â”Š46â”Š  â”Š  return /currentUserId=.+(;|$)/.test(document.cookie);\n+â”Š  â”Š46â”Š  return /authToken=.+(;|$)/.test(document.cookie);\n â”Š47â”Š47â”Š};\n```\n\n[}]: #\n\nNow we can perform the signIn. It would be a good idea to signIn with the first user - `ray`, since all the DB mock is built around him:\n\n```js\nmutation signIn(username: 'ray', password: '111') {\n  id\n}\n```\n\nNow if we would look at the value of `document.cookie` we should see a key named `authToken` with a JWT token and the `ChatsListScreen` should show the chats which are relevant to `ray`. To complete the sign-in flow we would need to update the `AuthScreen` and the `auth.service` to use username and password and the actual `sign-in` mutation weâ€™ve just implemented.\n\nNow back to the `auth.service`, we will replace the `signIn()` method implementation with one that actually calls the `signIn` mutation in our API. We will start by defining the mutation:\n\n[{]: <helper> (diffStep 13.2 files=\"graphql/mutations\" module=\"client\")\n\n#### [__Client__ Step 13.2: Update auth service to call signIn mutation](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/5094ff7ac1e6501fa343e5f92b5e0bf7ede30e5f)\n\n##### Added src&#x2F;graphql&#x2F;mutations&#x2F;index.ts\n```diff\n@@ -0,0 +1 @@\n+â”Š â”Š1â”Šexport { default as signIn } from './signIn.mutation'\n```\n\n##### Added src&#x2F;graphql&#x2F;mutations&#x2F;signIn.mutation.ts\n```diff\n@@ -0,0 +1,9 @@\n+â”Š â”Š1â”Šimport gql from 'graphql-tag'\n+â”Š â”Š2â”Š\n+â”Š â”Š3â”Šexport default gql`\n+â”Š â”Š4â”Š  mutation signIn($username: String!, $password: String!) {\n+â”Š â”Š5â”Š    signIn(username: $username, password: $password) {\n+â”Š â”Š6â”Š      id\n+â”Š â”Š7â”Š    }\n+â”Š â”Š8â”Š  }\n+â”Š â”Š9â”Š`\n```\n\n[}]: #\n\nUpdating `codegen.yml` to include the file we've just added in the generation process:\n\n[{]: <helper> (diffStep 13.2 files=\"codegen.yml\" module=\"client\")\n\n#### [__Client__ Step 13.2: Update auth service to call signIn mutation](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/5094ff7ac1e6501fa343e5f92b5e0bf7ede30e5f)\n\n##### Changed codegen.yml\n```diff\n@@ -4,6 +4,7 @@\n â”Š 4â”Š 4â”Š  - ./src/graphql/fragments/**/*.ts\n â”Š 5â”Š 5â”Š  - ./src/graphql/queries/**/*.ts\n â”Š 6â”Š 6â”Š  - ./src/graphql/subscriptions/**/*.ts\n+â”Š  â”Š 7â”Š  - ./src/graphql/mutations/**/*.ts\n â”Š 7â”Š 8â”Šoverwrite: true\n â”Š 8â”Š 9â”Šgenerates:\n â”Š 9â”Š10â”Š  ./src/graphql/types.tsx:\n```\n\n[}]: #\n\nAnd finally, we will update the service to use the generated mutation method `useSignInMutation()`:\n\n[{]: <helper> (diffStep 13.2 files=\"auth.service.ts\" module=\"client\")\n\n#### [__Client__ Step 13.2: Update auth service to call signIn mutation](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/5094ff7ac1e6501fa343e5f92b5e0bf7ede30e5f)\n\n##### Changed src&#x2F;services&#x2F;auth.service.tsx\n```diff\n@@ -2,6 +2,7 @@\n â”Š2â”Š2â”Šimport { useCallback } from 'react';\n â”Š3â”Š3â”Šimport { useApolloClient } from '@apollo/react-hooks';\n â”Š4â”Š4â”Šimport { Redirect } from 'react-router-dom';\n+â”Š â”Š5â”Šimport { useSignInMutation } from '../graphql/types';\n â”Š5â”Š6â”Šimport { useCacheService } from './cache.service';\n â”Š6â”Š7â”Š\n â”Š7â”Š8â”Šexport const withAuth = <P extends object>(\n```\n```diff\n@@ -22,12 +23,7 @@\n â”Š22â”Š23â”Š  };\n â”Š23â”Š24â”Š};\n â”Š24â”Š25â”Š\n-â”Š25â”Š  â”Šexport const signIn = (authToken: string) => {\n-â”Š26â”Š  â”Š  document.cookie = `authToken=${authToken}`;\n-â”Š27â”Š  â”Š\n-â”Š28â”Š  â”Š  // This will become async in the near future\n-â”Š29â”Š  â”Š  return Promise.resolve();\n-â”Š30â”Š  â”Š};\n+â”Š  â”Š26â”Šexport const useSignIn = useSignInMutation;\n â”Š31â”Š27â”Š\n â”Š32â”Š28â”Šexport const useSignOut = () => {\n â”Š33â”Š29â”Š  const client = useApolloClient()\n```\n\n[}]: #\n\nTo check if weâ€™re authorized to visit a route, not only we would need to check if we have the `authToken` cookie defined, but we would also need to validate it against the server to see that it actually references a real user. For that we will implement `Query.me` which will send us back the current user logged in directly from the context:\n\n[{]: <helper> (diffStep 10.5 module=\"server\")\n\n#### [__Server__ Step 10.5: Add Query.me](https://github.com/Urigo/WhatsApp-Clone-Server/commit/c8be3a0fd61ed0ade7597d13bbaf7f32b47dd7c4)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -70,6 +70,10 @@\n â”Š70â”Š70â”Š  },\n â”Š71â”Š71â”Š\n â”Š72â”Š72â”Š  Query: {\n+â”Š  â”Š73â”Š    me(root, args, { currentUser }) {\n+â”Š  â”Š74â”Š      return currentUser || null;\n+â”Š  â”Š75â”Š    },\n+â”Š  â”Š76â”Š\n â”Š73â”Š77â”Š    chats(root, args, { currentUser }) {\n â”Š74â”Š78â”Š      if (!currentUser) return [];\n â”Š75â”Š79â”Š\n```\n\n##### Changed schema&#x2F;typeDefs.graphql\n```diff\n@@ -26,6 +26,7 @@\n â”Š26â”Š26â”Š}\n â”Š27â”Š27â”Š\n â”Š28â”Š28â”Štype Query {\n+â”Š  â”Š29â”Š  me: User\n â”Š29â”Š30â”Š  chats: [Chat!]!\n â”Š30â”Š31â”Š  chat(chatId: ID!): Chat\n â”Š31â”Š32â”Š  users: [User!]!\n```\n\n##### Added tests&#x2F;queries&#x2F;getMe.test.ts\n```diff\n@@ -0,0 +1,33 @@\n+â”Š  â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n+â”Š  â”Š 2â”Šimport { ApolloServer, gql } from 'apollo-server-express';\n+â”Š  â”Š 3â”Šimport schema from '../../schema';\n+â”Š  â”Š 4â”Šimport { users } from '../../db';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šdescribe('Query.me', () => {\n+â”Š  â”Š 7â”Š  it('should fetch current user', async () => {\n+â”Š  â”Š 8â”Š    const server = new ApolloServer({\n+â”Š  â”Š 9â”Š      schema,\n+â”Š  â”Š10â”Š      context: () => ({\n+â”Š  â”Š11â”Š        currentUser: users[0],\n+â”Š  â”Š12â”Š      }),\n+â”Š  â”Š13â”Š    });\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”Š    const { query } = createTestClient(server);\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š    const res = await query({\n+â”Š  â”Š18â”Š      query: gql`\n+â”Š  â”Š19â”Š        query GetMe {\n+â”Š  â”Š20â”Š          me {\n+â”Š  â”Š21â”Š            id\n+â”Š  â”Š22â”Š            name\n+â”Š  â”Š23â”Š            picture\n+â”Š  â”Š24â”Š          }\n+â”Š  â”Š25â”Š        }\n+â”Š  â”Š26â”Š      `,\n+â”Š  â”Š27â”Š    });\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š    expect(res.data).toBeDefined();\n+â”Š  â”Š30â”Š    expect(res.errors).toBeUndefined();\n+â”Š  â”Š31â”Š    expect(res.data).toMatchSnapshot();\n+â”Š  â”Š32â”Š  });\n+â”Š  â”Š33â”Š});\n```\n\n[}]: #\n\nNow will use the GraphQL query weâ€™ve just implemented to check if the user actually exists within the DB before we proceed to the restricted route:\n\n[{]: <helper> (diffStep 13.3 module=\"client\")\n\n#### [__Client__ Step 13.3: Validate auth token against the back-end on restricted route](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/6bdcfb7bbf3eb42f99fea162e896f504c19d42bf)\n\n##### Added src&#x2F;graphql&#x2F;queries&#x2F;me.query.ts\n```diff\n@@ -0,0 +1,11 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag';\n+â”Š  â”Š 2â”Šimport * as fragments from '../fragments';\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šexport default gql`\n+â”Š  â”Š 5â”Š  query Me {\n+â”Š  â”Š 6â”Š    me {\n+â”Š  â”Š 7â”Š      ...User\n+â”Š  â”Š 8â”Š    }\n+â”Š  â”Š 9â”Š  }\n+â”Š  â”Š10â”Š  ${fragments.user}\n+â”Š  â”Š11â”Š`;\n```\n\n##### Changed src&#x2F;services&#x2F;auth.service.tsx\n```diff\n@@ -1,10 +1,16 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n-â”Š 2â”Š  â”Šimport { useCallback } from 'react';\n+â”Š  â”Š 2â”Šimport { useContext, useCallback } from 'react';\n â”Š 3â”Š 3â”Šimport { useApolloClient } from '@apollo/react-hooks';\n â”Š 4â”Š 4â”Šimport { Redirect } from 'react-router-dom';\n-â”Š 5â”Š  â”Šimport { useSignInMutation } from '../graphql/types';\n+â”Š  â”Š 5â”Šimport { useMeQuery, User, useSignInMutation } from '../graphql/types';\n â”Š 6â”Š 6â”Šimport { useCacheService } from './cache.service';\n â”Š 7â”Š 7â”Š\n+â”Š  â”Š 8â”Šconst MyContext = React.createContext<User | null>(null);\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Šexport const useMe = () => {\n+â”Š  â”Š11â”Š  return useContext(MyContext);\n+â”Š  â”Š12â”Š};\n+â”Š  â”Š13â”Š\n â”Š 8â”Š14â”Šexport const withAuth = <P extends object>(\n â”Š 9â”Š15â”Š  Component: React.ComponentType<P>\n â”Š10â”Š16â”Š) => {\n```\n```diff\n@@ -17,9 +23,26 @@\n â”Š17â”Š23â”Š      return <Redirect to=\"/sign-in\" />;\n â”Š18â”Š24â”Š    }\n â”Š19â”Š25â”Š\n+â”Š  â”Š26â”Š    const signOut = useSignOut();\n+â”Š  â”Š27â”Š    const { data, error, loading } = useMeQuery();\n+â”Š  â”Š28â”Š\n â”Š20â”Š29â”Š    useCacheService();\n â”Š21â”Š30â”Š\n-â”Š22â”Š  â”Š    return <Component {...props as P} />;\n+â”Š  â”Š31â”Š    if (loading) return null;\n+â”Š  â”Š32â”Š\n+â”Š  â”Š33â”Š    if (data === undefined) return null;\n+â”Š  â”Š34â”Š\n+â”Š  â”Š35â”Š    if (error || !data.me) {\n+â”Š  â”Š36â”Š      signOut();\n+â”Š  â”Š37â”Š\n+â”Š  â”Š38â”Š      return <Redirect to=\"/sign-in\" />;\n+â”Š  â”Š39â”Š    }\n+â”Š  â”Š40â”Š\n+â”Š  â”Š41â”Š    return (\n+â”Š  â”Š42â”Š      <MyContext.Provider value={data.me}>\n+â”Š  â”Š43â”Š        <Component {...props as P} />\n+â”Š  â”Š44â”Š      </MyContext.Provider>\n+â”Š  â”Š45â”Š    );\n â”Š23â”Š46â”Š  };\n â”Š24â”Š47â”Š};\n```\n\n[}]: #\n\nwe will use the new query to try and fetch the user directly from the back-end, and we will only proceed if the user was actually found. In addition, we will replace the `signIn()` method to call `signIn` mutation:\n\n[{]: <helper> (diffStep 13.4 module=\"client\")\n\n#### [__Client__ Step 13.4: Add username and password to AuthScreen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/f983110258245161136e62ed8aae85f636913143)\n\n##### Changed src&#x2F;components&#x2F;AuthScreen&#x2F;index.tsx\n```diff\n@@ -3,7 +3,7 @@\n â”Š3â”Š3â”Šimport React from 'react';\n â”Š4â”Š4â”Šimport { useCallback, useState } from 'react';\n â”Š5â”Š5â”Šimport styled from 'styled-components';\n-â”Š6â”Š â”Šimport { signIn } from '../../services/auth.service';\n+â”Š â”Š6â”Šimport { useSignIn } from '../../services/auth.service';\n â”Š7â”Š7â”Šimport { RouteComponentProps } from 'react-router-dom';\n â”Š8â”Š8â”Š\n â”Š9â”Š9â”Šconst Container = styled.div`\n```\n```diff\n@@ -114,21 +114,35 @@\n â”Š114â”Š114â”Š`;\n â”Š115â”Š115â”Š\n â”Š116â”Š116â”Šconst AuthScreen: React.FC<RouteComponentProps<any>> = ({ history }) => {\n-â”Š117â”Š   â”Š  const [userId, setUserId] = useState('');\n+â”Š   â”Š117â”Š  const [username, setUsername] = useState('');\n+â”Š   â”Š118â”Š  const [password, setPassword] = useState('');\n+â”Š   â”Š119â”Š  // eslint-disable-next-line\n+â”Š   â”Š120â”Š  const [error, setError] = useState('');\n+â”Š   â”Š121â”Š  const [signIn] = useSignIn();\n+â”Š   â”Š122â”Š\n+â”Š   â”Š123â”Š  const onUsernameChange = useCallback(({ target }) => {\n+â”Š   â”Š124â”Š    setError('');\n+â”Š   â”Š125â”Š    setUsername(target.value);\n+â”Š   â”Š126â”Š  }, []);\n â”Š118â”Š127â”Š\n-â”Š119â”Š   â”Š  const onUserIdChange = useCallback(({ target }) => {\n-â”Š120â”Š   â”Š    setUserId(target.value);\n+â”Š   â”Š128â”Š  const onPasswordChange = useCallback(({ target }) => {\n+â”Š   â”Š129â”Š    setError('');\n+â”Š   â”Š130â”Š    setPassword(target.value);\n â”Š121â”Š131â”Š  }, []);\n â”Š122â”Š132â”Š\n â”Š123â”Š133â”Š  const maySignIn = useCallback(() => {\n-â”Š124â”Š   â”Š    return !!userId;\n-â”Š125â”Š   â”Š  }, [userId]);\n+â”Š   â”Š134â”Š    return !!(username && password);\n+â”Š   â”Š135â”Š  }, [username, password]);\n â”Š126â”Š136â”Š\n â”Š127â”Š137â”Š  const handleSignIn = useCallback(() => {\n-â”Š128â”Š   â”Š    signIn(userId).then(() => {\n-â”Š129â”Š   â”Š      history.replace('/chats');\n-â”Š130â”Š   â”Š    });\n-â”Š131â”Š   â”Š  }, [userId, history]);\n+â”Š   â”Š138â”Š    signIn({ variables: { username, password } })\n+â”Š   â”Š139â”Š      .then(() => {\n+â”Š   â”Š140â”Š        history.push('/chats');\n+â”Š   â”Š141â”Š      })\n+â”Š   â”Š142â”Š      .catch(error => {\n+â”Š   â”Š143â”Š        setError(error.message || error);\n+â”Š   â”Š144â”Š      });\n+â”Š   â”Š145â”Š  }, [username, password, history, signIn]);\n â”Š132â”Š146â”Š\n â”Š133â”Š147â”Š  return (\n â”Š134â”Š148â”Š    <Container>\n```\n```diff\n@@ -141,12 +155,21 @@\n â”Š141â”Š155â”Š          <Legend>Sign in</Legend>\n â”Š142â”Š156â”Š          <Section>\n â”Š143â”Š157â”Š            <TextField\n-â”Š144â”Š   â”Š              data-testid=\"user-id-input\"\n-â”Š145â”Š   â”Š              label=\"User ID\"\n-â”Š146â”Š   â”Š              value={userId}\n-â”Š147â”Š   â”Š              onChange={onUserIdChange}\n+â”Š   â”Š158â”Š              className=\"AuthScreen-text-field\"\n+â”Š   â”Š159â”Š              label=\"Username\"\n+â”Š   â”Š160â”Š              value={username}\n+â”Š   â”Š161â”Š              onChange={onUsernameChange}\n+â”Š   â”Š162â”Š              margin=\"normal\"\n+â”Š   â”Š163â”Š              placeholder=\"Enter your username\"\n+â”Š   â”Š164â”Š            />\n+â”Š   â”Š165â”Š            <TextField\n+â”Š   â”Š166â”Š              className=\"AuthScreen-text-field\"\n+â”Š   â”Š167â”Š              label=\"Password\"\n+â”Š   â”Š168â”Š              type=\"password\"\n+â”Š   â”Š169â”Š              value={password}\n+â”Š   â”Š170â”Š              onChange={onPasswordChange}\n â”Š148â”Š171â”Š              margin=\"normal\"\n-â”Š149â”Š   â”Š              placeholder=\"Enter current user ID\"\n+â”Š   â”Š172â”Š              placeholder=\"Enter your password\"\n â”Š150â”Š173â”Š            />\n â”Š151â”Š174â”Š          </Section>\n â”Š152â”Š175â”Š          <Button\n```\n\n[}]: #\n\nThe behavior of the updated screen should be identical to what we had so far. To complete the flow weâ€™ll need a way to signUp. When we signing-up we will need the following parameters: `name`, `username`, `password` and `passwordConfirm`. In addition we will need to run certain validations against the parameters:\n\n- The name must be at least 3 and at most 50 characters long.\n- The username must be at least 3 and at most 18 characters long.\n- A password must be at least 8 and at most 30 characters long. In addition, it should contain English letters, numbers, and special characters.\n\nFor that we will implement a dedicated validations module:\n\n[{]: <helper> (diffStep 10.6 files=\"validators\" module=\"server\")\n\n#### [__Server__ Step 10.6: Add signUp mutation](https://github.com/Urigo/WhatsApp-Clone-Server/commit/3e958c71a03103c0a379f73875c144ed08b21e73)\n\n##### Added validators.ts\n```diff\n@@ -0,0 +1,43 @@\n+â”Š  â”Š 1â”Šexport const validatePassword = (ctx: string, str: string) => {\n+â”Š  â”Š 2â”Š  if (typeof str !== 'string') {\n+â”Š  â”Š 3â”Š    throw TypeError(`${ctx} must be a string`);\n+â”Š  â”Š 4â”Š  }\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Š  validateLength(ctx, str, 8, 30);\n+â”Š  â”Š 7â”Š\n+â”Š  â”Š 8â”Š  if (!/[a-zA-Z]+/.test(str)) {\n+â”Š  â”Š 9â”Š    throw TypeError(`${ctx} must contain english letters`);\n+â”Š  â”Š10â”Š  }\n+â”Š  â”Š11â”Š\n+â”Š  â”Š12â”Š  if (!/\\d+/.test(str)) {\n+â”Š  â”Š13â”Š    throw TypeError(`${ctx} must contain numbers`);\n+â”Š  â”Š14â”Š  }\n+â”Š  â”Š15â”Š\n+â”Š  â”Š16â”Š  if (!/[^\\da-zA-Z]+/.test(str)) {\n+â”Š  â”Š17â”Š    throw TypeError(`${ctx} must contain special charachters`);\n+â”Š  â”Š18â”Š  }\n+â”Š  â”Š19â”Š};\n+â”Š  â”Š20â”Š\n+â”Š  â”Š21â”Šexport const validateLength = (ctx: string, str: string, ...args: number[]) => {\n+â”Š  â”Š22â”Š  let min, max;\n+â”Š  â”Š23â”Š\n+â”Š  â”Š24â”Š  if (args.length === 1) {\n+â”Š  â”Š25â”Š    min = 0;\n+â”Š  â”Š26â”Š    max = args[0];\n+â”Š  â”Š27â”Š  } else {\n+â”Š  â”Š28â”Š    min = args[0];\n+â”Š  â”Š29â”Š    max = args[1];\n+â”Š  â”Š30â”Š  }\n+â”Š  â”Š31â”Š\n+â”Š  â”Š32â”Š  if (typeof str !== 'string') {\n+â”Š  â”Š33â”Š    throw TypeError(`${ctx} must be a string`);\n+â”Š  â”Š34â”Š  }\n+â”Š  â”Š35â”Š\n+â”Š  â”Š36â”Š  if (str.length < min) {\n+â”Š  â”Š37â”Š    throw TypeError(`${ctx} must be at least ${min} chars long`);\n+â”Š  â”Š38â”Š  }\n+â”Š  â”Š39â”Š\n+â”Š  â”Š40â”Š  if (str.length > max) {\n+â”Š  â”Š41â”Š    throw TypeError(`${ctx} must contain ${max} chars at most`);\n+â”Š  â”Š42â”Š  }\n+â”Š  â”Š43â”Š};\n```\n\n[}]: #\n\nAnd we will implement the resolver and schema for the `signUp` mutation:\n\n[{]: <helper> (diffStep 10.6 files=\"schema\" module=\"server\")\n\n#### [__Server__ Step 10.6: Add signUp mutation](https://github.com/Urigo/WhatsApp-Clone-Server/commit/3e958c71a03103c0a379f73875c144ed08b21e73)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -5,6 +5,7 @@\n â”Š 5â”Š 5â”Šimport { secret, expiration } from '../env';\n â”Š 6â”Š 6â”Šimport bcrypt from 'bcrypt';\n â”Š 7â”Š 7â”Šimport jwt from 'jsonwebtoken';\n+â”Š  â”Š 8â”Šimport { validateLength, validatePassword } from '../validators';\n â”Š 8â”Š 9â”Š\n â”Š 9â”Š10â”Šconst resolvers: Resolvers = {\n â”Š10â”Š11â”Š  Date: GraphQLDateTime,\n```\n```diff\n@@ -118,6 +119,34 @@\n â”Š118â”Š119â”Š      return user;\n â”Š119â”Š120â”Š    },\n â”Š120â”Š121â”Š\n+â”Š   â”Š122â”Š    signUp(root, { name, username, password, passwordConfirm }) {\n+â”Š   â”Š123â”Š      validateLength('req.name', name, 3, 50);\n+â”Š   â”Š124â”Š      validateLength('req.username', username, 3, 18);\n+â”Š   â”Š125â”Š      validatePassword('req.password', password);\n+â”Š   â”Š126â”Š\n+â”Š   â”Š127â”Š      if (password !== passwordConfirm) {\n+â”Š   â”Š128â”Š        throw Error(\"req.password and req.passwordConfirm don't match\");\n+â”Š   â”Š129â”Š      }\n+â”Š   â”Š130â”Š\n+â”Š   â”Š131â”Š      if (users.some(u => u.username === username)) {\n+â”Š   â”Š132â”Š        throw Error('username already exists');\n+â”Š   â”Š133â”Š      }\n+â”Š   â”Š134â”Š\n+â”Š   â”Š135â”Š      const passwordHash = bcrypt.hashSync(password, bcrypt.genSaltSync(8));\n+â”Š   â”Š136â”Š\n+â”Š   â”Š137â”Š      const user: User = {\n+â”Š   â”Š138â”Š        id: String(users.length + 1),\n+â”Š   â”Š139â”Š        password: passwordHash,\n+â”Š   â”Š140â”Š        picture: '',\n+â”Š   â”Š141â”Š        username,\n+â”Š   â”Š142â”Š        name,\n+â”Š   â”Š143â”Š      };\n+â”Š   â”Š144â”Š\n+â”Š   â”Š145â”Š      users.push(user);\n+â”Š   â”Š146â”Š\n+â”Š   â”Š147â”Š      return user;\n+â”Š   â”Š148â”Š    },\n+â”Š   â”Š149â”Š\n â”Š121â”Š150â”Š    addMessage(root, { chatId, content }, { currentUser, pubsub }) {\n â”Š122â”Š151â”Š      if (!currentUser) return null;\n â”Š123â”Š152â”Š\n```\n\n##### Changed schema&#x2F;typeDefs.graphql\n```diff\n@@ -34,6 +34,7 @@\n â”Š34â”Š34â”Š\n â”Š35â”Š35â”Štype Mutation {\n â”Š36â”Š36â”Š  signIn(username: String!, password: String!): User\n+â”Š  â”Š37â”Š  signUp(name: String!, username: String!, password: String!, passwordConfirm: String!): User\n â”Š37â”Š38â”Š  addMessage(chatId: ID!, content: String!): Message\n â”Š38â”Š39â”Š  addChat(recipientId: ID!): Chat\n â”Š39â”Š40â”Š  removeChat(chatId: ID!): ID\n```\n\n[}]: #\n\nBefore encrypting the password we append a string called â€œsaltâ€ to it. Even though the passwords are stored encrypted in the DB, a hacker might use a dictionary of common passwords in their encrypted form to decipher the original password. When adding salt to a password which is essentially a random string, the hacker cannot use a dictionary anymore since he would need to know the salt. Hypothetically, the hacker can get a hold of the salt and re-generate the entire dictionary, however that would take too long because of the way Bcrypt is designed to work.\n\nGoing back to the client, we will implement a new `signUp()` method in the `auth.service` that will call the `signUp` mutation:\n\n[{]: <helper> (diffStep 13.5 module=\"client\")\n\n#### [__Client__ Step 13.5: Add signUp() method to auth.service](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/0b90629177e66dde5fe88b31a787f22b989e9275)\n\n##### Added src&#x2F;graphql&#x2F;mutations&#x2F;signUp.mutation.ts\n```diff\n@@ -0,0 +1,9 @@\n+â”Š â”Š1â”Šimport gql from 'graphql-tag'\n+â”Š â”Š2â”Š\n+â”Š â”Š3â”Šexport default gql`\n+â”Š â”Š4â”Š  mutation signUp($name: String!, $username: String!, $password: String!, $passwordConfirm: String!) {\n+â”Š â”Š5â”Š    signUp(name: $name, username: $username, password: $password, passwordConfirm: $passwordConfirm) {\n+â”Š â”Š6â”Š      id\n+â”Š â”Š7â”Š    }\n+â”Š â”Š8â”Š  }\n+â”Š â”Š9â”Š`\n```\n\n##### Changed src&#x2F;services&#x2F;auth.service.tsx\n```diff\n@@ -2,7 +2,7 @@\n â”Š2â”Š2â”Šimport { useContext, useCallback } from 'react';\n â”Š3â”Š3â”Šimport { useApolloClient } from '@apollo/react-hooks';\n â”Š4â”Š4â”Šimport { Redirect } from 'react-router-dom';\n-â”Š5â”Š â”Šimport { useMeQuery, User, useSignInMutation } from '../graphql/types';\n+â”Š â”Š5â”Šimport { useMeQuery, User, useSignInMutation, useSignUpMutation } from '../graphql/types';\n â”Š6â”Š6â”Šimport { useCacheService } from './cache.service';\n â”Š7â”Š7â”Š\n â”Š8â”Š8â”Šconst MyContext = React.createContext<User | null>(null);\n```\n```diff\n@@ -47,6 +47,7 @@\n â”Š47â”Š47â”Š};\n â”Š48â”Š48â”Š\n â”Š49â”Š49â”Šexport const useSignIn = useSignInMutation;\n+â”Š  â”Š50â”Šexport const useSignUp = useSignUpMutation;\n â”Š50â”Š51â”Š\n â”Š51â”Š52â”Šexport const useSignOut = () => {\n â”Š52â”Š53â”Š  const client = useApolloClient()\n```\n\n[}]: #\n\nNow we will implement a dedicated `SignUpForm` that we can use to perform the sign-up. Instead of implementing a new screen, we will use the `AuthScreen` to alternate between the `SignInForm` and the `SignUpForm` using `AnimatedSwitch`. This way we can have a container component that is common for both forms, and we will be able to switch between the two very smoothly. We will first define a new `/sign-up` route in our router:\n\n[{]: <helper> (diffStep 13.6 module=\"client\")\n\n#### [__Client__ Step 13.6: Split AuthScreen into SignInForm and SignUpForm](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/405ed9dba6c98399285de0bfc8e8008a34ec08e7)\n\n##### Added src&#x2F;components&#x2F;AuthScreen&#x2F;SignInForm.test.tsx\n```diff\n@@ -0,0 +1,163 @@\n+â”Š   â”Š  1â”Šimport { createMemoryHistory } from 'history';\n+â”Š   â”Š  2â”Šimport React from 'react';\n+â”Š   â”Š  3â”Šimport { ApolloProvider } from '@apollo/react-hooks';\n+â”Š   â”Š  4â”Šimport { act, cleanup, render, fireEvent, wait, waitForElement } from '@testing-library/react';\n+â”Š   â”Š  5â”Šimport SignInForm from './SignInForm';\n+â”Š   â”Š  6â”Šimport { SignInDocument } from '../../graphql/types';\n+â”Š   â”Š  7â”Šimport { mockApolloClient } from '../../test-helpers';\n+â”Š   â”Š  8â”Š\n+â”Š   â”Š  9â”Šdescribe('SignInForm', () => {\n+â”Š   â”Š 10â”Š  afterEach(cleanup);\n+â”Š   â”Š 11â”Š\n+â”Š   â”Š 12â”Š  it('enables sign-in button when filled in', async () => {\n+â”Š   â”Š 13â”Š    const history = createMemoryHistory();\n+â”Š   â”Š 14â”Š    const client = mockApolloClient();\n+â”Š   â”Š 15â”Š\n+â”Š   â”Š 16â”Š    let getByTestId: any = null;\n+â”Š   â”Š 17â”Š\n+â”Š   â”Š 18â”Š    act(() => {\n+â”Š   â”Š 19â”Š      getByTestId = render(\n+â”Š   â”Š 20â”Š        <ApolloProvider client={client}>\n+â”Š   â”Š 21â”Š          <SignInForm history={history} />\n+â”Š   â”Š 22â”Š        </ApolloProvider>\n+â”Š   â”Š 23â”Š      ).getByTestId;\n+â”Š   â”Š 24â”Š    });\n+â”Š   â”Š 25â”Š\n+â”Š   â”Š 26â”Š    const signInButton = await waitForElement(() =>\n+â”Š   â”Š 27â”Š      getByTestId('sign-in-button') as HTMLButtonElement\n+â”Š   â”Š 28â”Š    );\n+â”Š   â”Š 29â”Š    const usernameInput = await waitForElement(() =>\n+â”Š   â”Š 30â”Š      getByTestId('username-input').querySelector('input')\n+â”Š   â”Š 31â”Š    );\n+â”Š   â”Š 32â”Š    const passwordInput = await waitForElement(() =>\n+â”Š   â”Š 33â”Š      getByTestId('password-input').querySelector('input')\n+â”Š   â”Š 34â”Š    );\n+â”Š   â”Š 35â”Š\n+â”Š   â”Š 36â”Š    expect(signInButton.disabled).toEqual(true);\n+â”Š   â”Š 37â”Š\n+â”Š   â”Š 38â”Š    act(() => {\n+â”Š   â”Š 39â”Š      fireEvent.change(usernameInput, { target: { value: 'username' } });\n+â”Š   â”Š 40â”Š      fireEvent.change(passwordInput, { target: { value: 'password' } });\n+â”Š   â”Š 41â”Š    });\n+â”Š   â”Š 42â”Š\n+â”Š   â”Š 43â”Š    await wait(() =>\n+â”Š   â”Š 44â”Š      expect(signInButton.disabled).toEqual(false)\n+â”Š   â”Š 45â”Š    )\n+â”Š   â”Š 46â”Š  });\n+â”Š   â”Š 47â”Š\n+â”Š   â”Š 48â”Š  it('prints server error if input was wrong', async () => {\n+â”Š   â”Š 49â”Š    const history = createMemoryHistory();\n+â”Š   â”Š 50â”Š\n+â”Š   â”Š 51â”Š    const client = mockApolloClient([\n+â”Š   â”Š 52â”Š      {\n+â”Š   â”Š 53â”Š        request: {\n+â”Š   â”Š 54â”Š          query: SignInDocument,\n+â”Š   â”Š 55â”Š          variables: {\n+â”Š   â”Š 56â”Š            username: 'username',\n+â”Š   â”Š 57â”Š            password: 'password'\n+â”Š   â”Š 58â”Š          }\n+â”Š   â”Š 59â”Š        },\n+â”Š   â”Š 60â”Š        get result() { throw Error('sign-in failed') },\n+â”Š   â”Š 61â”Š      }\n+â”Š   â”Š 62â”Š    ]);\n+â”Š   â”Š 63â”Š\n+â”Š   â”Š 64â”Š    let getByTestId: any = null;\n+â”Š   â”Š 65â”Š\n+â”Š   â”Š 66â”Š    act(() => {\n+â”Š   â”Š 67â”Š      getByTestId = render(\n+â”Š   â”Š 68â”Š        <ApolloProvider client={client}>\n+â”Š   â”Š 69â”Š          <SignInForm history={history} />\n+â”Š   â”Š 70â”Š        </ApolloProvider>\n+â”Š   â”Š 71â”Š      ).getByTestId;\n+â”Š   â”Š 72â”Š    });\n+â”Š   â”Š 73â”Š\n+â”Š   â”Š 74â”Š    const signInButton = await waitForElement(() =>\n+â”Š   â”Š 75â”Š      getByTestId('sign-in-button') as HTMLButtonElement\n+â”Š   â”Š 76â”Š    );\n+â”Š   â”Š 77â”Š    const usernameInput = await waitForElement(() =>\n+â”Š   â”Š 78â”Š      getByTestId('username-input').querySelector('input')\n+â”Š   â”Š 79â”Š    );\n+â”Š   â”Š 80â”Š    const passwordInput = await waitForElement(() =>\n+â”Š   â”Š 81â”Š      getByTestId('password-input').querySelector('input')\n+â”Š   â”Š 82â”Š    );\n+â”Š   â”Š 83â”Š\n+â”Š   â”Š 84â”Š    act(() => {\n+â”Š   â”Š 85â”Š      fireEvent.change(usernameInput, { target: { value: 'username' } });\n+â”Š   â”Š 86â”Š      fireEvent.change(passwordInput, { target: { value: 'password' } });\n+â”Š   â”Š 87â”Š    });\n+â”Š   â”Š 88â”Š\n+â”Š   â”Š 89â”Š    await wait(() =>\n+â”Š   â”Š 90â”Š      expect(usernameInput.value).toEqual('username')\n+â”Š   â”Š 91â”Š    );\n+â”Š   â”Š 92â”Š\n+â”Š   â”Š 93â”Š    await wait(() =>\n+â”Š   â”Š 94â”Š      expect(passwordInput.value).toEqual('password')\n+â”Š   â”Š 95â”Š    );\n+â”Š   â”Š 96â”Š\n+â”Š   â”Š 97â”Š    act(() => {\n+â”Š   â”Š 98â”Š      fireEvent.click(signInButton);\n+â”Š   â”Š 99â”Š    });\n+â”Š   â”Š100â”Š\n+â”Š   â”Š101â”Š    const errorMessage = await waitForElement(() =>\n+â”Š   â”Š102â”Š      getByTestId('error-message')\n+â”Š   â”Š103â”Š    );\n+â”Š   â”Š104â”Š\n+â”Š   â”Š105â”Š    await wait(() => expect(errorMessage.innerHTML).toContain('sign-in failed'));\n+â”Š   â”Š106â”Š  });\n+â”Š   â”Š107â”Š\n+â”Š   â”Š108â”Š  it('navigates to /chats if everything went right', async () => {\n+â”Š   â”Š109â”Š    const history = createMemoryHistory();\n+â”Š   â”Š110â”Š\n+â”Š   â”Š111â”Š    const client = mockApolloClient([\n+â”Š   â”Š112â”Š      {\n+â”Š   â”Š113â”Š        request: {\n+â”Š   â”Š114â”Š          query: SignInDocument,\n+â”Š   â”Š115â”Š          variables: {\n+â”Š   â”Š116â”Š            username: 'username',\n+â”Š   â”Š117â”Š            password: 'password'\n+â”Š   â”Š118â”Š          }\n+â”Š   â”Š119â”Š        },\n+â”Š   â”Š120â”Š        result: { data: {} }\n+â”Š   â”Š121â”Š      }\n+â”Š   â”Š122â”Š    ]);\n+â”Š   â”Š123â”Š\n+â”Š   â”Š124â”Š    let getByTestId: any = null;\n+â”Š   â”Š125â”Š\n+â”Š   â”Š126â”Š    act(() => {\n+â”Š   â”Š127â”Š      getByTestId = render(\n+â”Š   â”Š128â”Š        <ApolloProvider client={client}>\n+â”Š   â”Š129â”Š          <SignInForm history={history} />\n+â”Š   â”Š130â”Š        </ApolloProvider>\n+â”Š   â”Š131â”Š      ).getByTestId;\n+â”Š   â”Š132â”Š    })\n+â”Š   â”Š133â”Š\n+â”Š   â”Š134â”Š    const usernameInput = await waitForElement(() =>\n+â”Š   â”Š135â”Š      getByTestId('username-input').querySelector('input')\n+â”Š   â”Š136â”Š    );\n+â”Š   â”Š137â”Š    const passwordInput = await waitForElement(() =>\n+â”Š   â”Š138â”Š      getByTestId('password-input').querySelector('input')\n+â”Š   â”Š139â”Š    );\n+â”Š   â”Š140â”Š    const signInButton = await waitForElement(() =>\n+â”Š   â”Š141â”Š      getByTestId('sign-in-button') as HTMLButtonElement\n+â”Š   â”Š142â”Š    );\n+â”Š   â”Š143â”Š\n+â”Š   â”Š144â”Š    act(() => {\n+â”Š   â”Š145â”Š      fireEvent.change(usernameInput, { target: { value: 'username' } });\n+â”Š   â”Š146â”Š      fireEvent.change(passwordInput, { target: { value: 'password' } });\n+â”Š   â”Š147â”Š    });\n+â”Š   â”Š148â”Š\n+â”Š   â”Š149â”Š    await wait(() =>\n+â”Š   â”Š150â”Š      expect(usernameInput.value).toEqual('username')\n+â”Š   â”Š151â”Š    );\n+â”Š   â”Š152â”Š\n+â”Š   â”Š153â”Š    await wait(() =>\n+â”Š   â”Š154â”Š      expect(passwordInput.value).toEqual('password')\n+â”Š   â”Š155â”Š    );\n+â”Š   â”Š156â”Š\n+â”Š   â”Š157â”Š    act(() => {\n+â”Š   â”Š158â”Š      fireEvent.click(signInButton);\n+â”Š   â”Š159â”Š    });\n+â”Š   â”Š160â”Š\n+â”Š   â”Š161â”Š    await wait(() => expect(history.location.pathname).toEqual('/chats'));\n+â”Š   â”Š162â”Š  });\n+â”Š   â”Š163â”Š});ðŸš«â†µ\n```\n\n##### Added src&#x2F;components&#x2F;AuthScreen&#x2F;SignInForm.tsx\n```diff\n@@ -0,0 +1,83 @@\n+â”Š  â”Š 1â”Šimport React from 'react';\n+â”Š  â”Š 2â”Šimport { useCallback, useState } from 'react';\n+â”Š  â”Š 3â”Šimport { useSignIn } from '../../services/auth.service';\n+â”Š  â”Š 4â”Šimport {\n+â”Š  â”Š 5â”Š  SignForm,\n+â”Š  â”Š 6â”Š  ActualForm,\n+â”Š  â”Š 7â”Š  Legend,\n+â”Š  â”Š 8â”Š  Section,\n+â”Š  â”Š 9â”Š  TextField,\n+â”Š  â”Š10â”Š  Button,\n+â”Š  â”Š11â”Š  ErrorMessage,\n+â”Š  â”Š12â”Š} from './form-components';\n+â”Š  â”Š13â”Šimport { RouteComponentProps } from 'react-router-dom';\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”Šconst SignInForm: React.FC<RouteComponentProps<any>> = ({ history }) => {\n+â”Š  â”Š16â”Š  const [username, setUsername] = useState('');\n+â”Š  â”Š17â”Š  const [password, setPassword] = useState('');\n+â”Š  â”Š18â”Š  const [error, setError] = useState('');\n+â”Š  â”Š19â”Š  const [signIn] = useSignIn();\n+â”Š  â”Š20â”Š\n+â”Š  â”Š21â”Š  const onUsernameChange = useCallback(({ target }) => {\n+â”Š  â”Š22â”Š    setError('');\n+â”Š  â”Š23â”Š    setUsername(target.value);\n+â”Š  â”Š24â”Š  }, []);\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Š  const onPasswordChange = useCallback(({ target }) => {\n+â”Š  â”Š27â”Š    setError('');\n+â”Š  â”Š28â”Š    setPassword(target.value);\n+â”Š  â”Š29â”Š  }, []);\n+â”Š  â”Š30â”Š\n+â”Š  â”Š31â”Š  const maySignIn = useCallback(() => {\n+â”Š  â”Š32â”Š    return !!(username && password);\n+â”Š  â”Š33â”Š  }, [username, password]);\n+â”Š  â”Š34â”Š\n+â”Š  â”Š35â”Š  const handleSignIn = useCallback(() => {\n+â”Š  â”Š36â”Š    signIn({ variables: { username, password } })\n+â”Š  â”Š37â”Š      .then(() => {\n+â”Š  â”Š38â”Š        history.replace('/chats');\n+â”Š  â”Š39â”Š      })\n+â”Š  â”Š40â”Š      .catch(error => {\n+â”Š  â”Š41â”Š        setError(error.message || error);\n+â”Š  â”Š42â”Š      });\n+â”Š  â”Š43â”Š  }, [username, password, history, signIn]);\n+â”Š  â”Š44â”Š\n+â”Š  â”Š45â”Š  return (\n+â”Š  â”Š46â”Š    <SignForm>\n+â”Š  â”Š47â”Š      <ActualForm>\n+â”Š  â”Š48â”Š        <Legend>Sign in</Legend>\n+â”Š  â”Š49â”Š        <Section style={{ width: '100%' }}>\n+â”Š  â”Š50â”Š          <TextField\n+â”Š  â”Š51â”Š            data-testid=\"username-input\"\n+â”Š  â”Š52â”Š            label=\"Username\"\n+â”Š  â”Š53â”Š            value={username}\n+â”Š  â”Š54â”Š            onChange={onUsernameChange}\n+â”Š  â”Š55â”Š            margin=\"normal\"\n+â”Š  â”Š56â”Š            placeholder=\"Enter your username\"\n+â”Š  â”Š57â”Š          />\n+â”Š  â”Š58â”Š          <TextField\n+â”Š  â”Š59â”Š            data-testid=\"password-input\"\n+â”Š  â”Š60â”Š            label=\"Password\"\n+â”Š  â”Š61â”Š            type=\"password\"\n+â”Š  â”Š62â”Š            value={password}\n+â”Š  â”Š63â”Š            onChange={onPasswordChange}\n+â”Š  â”Š64â”Š            margin=\"normal\"\n+â”Š  â”Š65â”Š            placeholder=\"Enter your password\"\n+â”Š  â”Š66â”Š          />\n+â”Š  â”Š67â”Š        </Section>\n+â”Š  â”Š68â”Š        <Button\n+â”Š  â”Š69â”Š          data-testid=\"sign-in-button\"\n+â”Š  â”Š70â”Š          type=\"button\"\n+â”Š  â”Š71â”Š          color=\"secondary\"\n+â”Š  â”Š72â”Š          variant=\"contained\"\n+â”Š  â”Š73â”Š          disabled={!maySignIn()}\n+â”Š  â”Š74â”Š          onClick={handleSignIn}>\n+â”Š  â”Š75â”Š          Sign in\n+â”Š  â”Š76â”Š        </Button>\n+â”Š  â”Š77â”Š        <ErrorMessage data-testid=\"error-message\">{error}</ErrorMessage>\n+â”Š  â”Š78â”Š      </ActualForm>\n+â”Š  â”Š79â”Š    </SignForm>\n+â”Š  â”Š80â”Š  );\n+â”Š  â”Š81â”Š};\n+â”Š  â”Š82â”Š\n+â”Š  â”Š83â”Šexport default SignInForm;\n```\n\n##### Added src&#x2F;components&#x2F;AuthScreen&#x2F;SignUpForm.test.tsx\n```diff\n@@ -0,0 +1,225 @@\n+â”Š   â”Š  1â”Šimport { createMemoryHistory } from 'history';\n+â”Š   â”Š  2â”Šimport React from 'react';\n+â”Š   â”Š  3â”Šimport { ApolloProvider } from '@apollo/react-hooks';\n+â”Š   â”Š  4â”Šimport { act, cleanup, render, fireEvent, wait, waitForElement } from '@testing-library/react';\n+â”Š   â”Š  5â”Šimport SignUpForm from './SignUpForm';\n+â”Š   â”Š  6â”Šimport { SignUpDocument } from '../../graphql/types';\n+â”Š   â”Š  7â”Šimport { mockApolloClient } from '../../test-helpers';\n+â”Š   â”Š  8â”Š\n+â”Š   â”Š  9â”Šdescribe('SignUpForm', () => {\n+â”Š   â”Š 10â”Š  afterEach(cleanup);\n+â”Š   â”Š 11â”Š\n+â”Š   â”Š 12â”Š  it('enables sign-up button when filled in', async () => {\n+â”Š   â”Š 13â”Š    const history = createMemoryHistory();\n+â”Š   â”Š 14â”Š    const client = mockApolloClient();\n+â”Š   â”Š 15â”Š\n+â”Š   â”Š 16â”Š    let getByTestId: any = null;\n+â”Š   â”Š 17â”Š\n+â”Š   â”Š 18â”Š    act(() => {\n+â”Š   â”Š 19â”Š      getByTestId = render(\n+â”Š   â”Š 20â”Š        <ApolloProvider client={client}>\n+â”Š   â”Š 21â”Š          <SignUpForm history={history} />\n+â”Š   â”Š 22â”Š        </ApolloProvider>\n+â”Š   â”Š 23â”Š      ).getByTestId;\n+â”Š   â”Š 24â”Š    });\n+â”Š   â”Š 25â”Š\n+â”Š   â”Š 26â”Š    const nameInput = await waitForElement(() =>\n+â”Š   â”Š 27â”Š      getByTestId('name-input').querySelector('input')\n+â”Š   â”Š 28â”Š    );\n+â”Š   â”Š 29â”Š    const usernameInput = await waitForElement(() =>\n+â”Š   â”Š 30â”Š      getByTestId('username-input').querySelector('input')\n+â”Š   â”Š 31â”Š    );\n+â”Š   â”Š 32â”Š    const passwordInput = await waitForElement(() =>\n+â”Š   â”Š 33â”Š      getByTestId('password-input').querySelector('input')\n+â”Š   â”Š 34â”Š    );\n+â”Š   â”Š 35â”Š    const passwordConfirmInput = await waitForElement(() =>\n+â”Š   â”Š 36â”Š      getByTestId('password-confirm-input').querySelector('input')\n+â”Š   â”Š 37â”Š    );\n+â”Š   â”Š 38â”Š    const signUpButton = await waitForElement(() =>\n+â”Š   â”Š 39â”Š      getByTestId('sign-up-button') as HTMLButtonElement\n+â”Š   â”Š 40â”Š    );\n+â”Š   â”Š 41â”Š\n+â”Š   â”Š 42â”Š    expect(signUpButton.disabled).toEqual(true);\n+â”Š   â”Š 43â”Š\n+â”Š   â”Š 44â”Š    act(() => {\n+â”Š   â”Š 45â”Š      fireEvent.change(nameInput, { target: { value: 'User Name' } });\n+â”Š   â”Š 46â”Š      fireEvent.change(usernameInput, { target: { value: 'username' } });\n+â”Š   â”Š 47â”Š      fireEvent.change(passwordInput, { target: { value: 'password' } });\n+â”Š   â”Š 48â”Š      fireEvent.change(passwordConfirmInput, { target: { value: 'password' } });\n+â”Š   â”Š 49â”Š    });\n+â”Š   â”Š 50â”Š\n+â”Š   â”Š 51â”Š    await wait(() =>\n+â”Š   â”Š 52â”Š      expect(nameInput.value).toEqual('User Name')\n+â”Š   â”Š 53â”Š    );\n+â”Š   â”Š 54â”Š\n+â”Š   â”Š 55â”Š    await wait(() =>\n+â”Š   â”Š 56â”Š      expect(usernameInput.value).toEqual('username')\n+â”Š   â”Š 57â”Š    );\n+â”Š   â”Š 58â”Š\n+â”Š   â”Š 59â”Š    await wait(() =>\n+â”Š   â”Š 60â”Š      expect(passwordInput.value).toEqual('password')\n+â”Š   â”Š 61â”Š    );\n+â”Š   â”Š 62â”Š\n+â”Š   â”Š 63â”Š    await wait(() =>\n+â”Š   â”Š 64â”Š      expect(passwordConfirmInput.value).toEqual('password')\n+â”Š   â”Š 65â”Š    );\n+â”Š   â”Š 66â”Š\n+â”Š   â”Š 67â”Š    await wait(() =>\n+â”Š   â”Š 68â”Š      expect(signUpButton.disabled).toEqual(false)\n+â”Š   â”Š 69â”Š    )\n+â”Š   â”Š 70â”Š  });\n+â”Š   â”Š 71â”Š\n+â”Š   â”Š 72â”Š  it('prints server error if input was wrong', async () => {\n+â”Š   â”Š 73â”Š    const history = createMemoryHistory();\n+â”Š   â”Š 74â”Š\n+â”Š   â”Š 75â”Š    const client = mockApolloClient([\n+â”Š   â”Š 76â”Š      {\n+â”Š   â”Š 77â”Š        request: {\n+â”Š   â”Š 78â”Š          query: SignUpDocument,\n+â”Š   â”Š 79â”Š          variables: {\n+â”Š   â”Š 80â”Š            name: 'User Name',\n+â”Š   â”Š 81â”Š            username: 'username',\n+â”Š   â”Š 82â”Š            password: 'password',\n+â”Š   â”Š 83â”Š            passwordConfirm: 'password'\n+â”Š   â”Š 84â”Š          }\n+â”Š   â”Š 85â”Š        },\n+â”Š   â”Š 86â”Š        get result() { throw Error('sign-up failed') }\n+â”Š   â”Š 87â”Š      }\n+â”Š   â”Š 88â”Š    ]);\n+â”Š   â”Š 89â”Š\n+â”Š   â”Š 90â”Š    let getByTestId: any = null;\n+â”Š   â”Š 91â”Š\n+â”Š   â”Š 92â”Š    act(() => {\n+â”Š   â”Š 93â”Š      getByTestId = render(\n+â”Š   â”Š 94â”Š        <ApolloProvider client={client}>\n+â”Š   â”Š 95â”Š          <SignUpForm history={history} />\n+â”Š   â”Š 96â”Š        </ApolloProvider>\n+â”Š   â”Š 97â”Š      ).getByTestId;\n+â”Š   â”Š 98â”Š    });\n+â”Š   â”Š 99â”Š\n+â”Š   â”Š100â”Š    const nameInput = await waitForElement(() =>\n+â”Š   â”Š101â”Š      getByTestId('name-input').querySelector('input')\n+â”Š   â”Š102â”Š    );\n+â”Š   â”Š103â”Š    const usernameInput = await waitForElement(() =>\n+â”Š   â”Š104â”Š      getByTestId('username-input').querySelector('input')\n+â”Š   â”Š105â”Š    );\n+â”Š   â”Š106â”Š    const passwordInput = await waitForElement(() =>\n+â”Š   â”Š107â”Š      getByTestId('password-input').querySelector('input')\n+â”Š   â”Š108â”Š    );\n+â”Š   â”Š109â”Š    const passwordConfirmInput = await waitForElement(() =>\n+â”Š   â”Š110â”Š      getByTestId('password-confirm-input').querySelector('input')\n+â”Š   â”Š111â”Š    );\n+â”Š   â”Š112â”Š    const signUpButton = await waitForElement(() =>\n+â”Š   â”Š113â”Š      getByTestId('sign-up-button') as HTMLButtonElement\n+â”Š   â”Š114â”Š    );\n+â”Š   â”Š115â”Š\n+â”Š   â”Š116â”Š    act(() => {\n+â”Š   â”Š117â”Š      fireEvent.change(nameInput, { target: { value: 'User Name' } });\n+â”Š   â”Š118â”Š      fireEvent.change(usernameInput, { target: { value: 'username' } });\n+â”Š   â”Š119â”Š      fireEvent.change(passwordInput, { target: { value: 'password' } });\n+â”Š   â”Š120â”Š      fireEvent.change(passwordConfirmInput, { target: { value: 'password' } });\n+â”Š   â”Š121â”Š    });\n+â”Š   â”Š122â”Š\n+â”Š   â”Š123â”Š    await wait(() =>\n+â”Š   â”Š124â”Š      expect(nameInput.value).toEqual('User Name')\n+â”Š   â”Š125â”Š    );\n+â”Š   â”Š126â”Š\n+â”Š   â”Š127â”Š    await wait(() =>\n+â”Š   â”Š128â”Š      expect(usernameInput.value).toEqual('username')\n+â”Š   â”Š129â”Š    );\n+â”Š   â”Š130â”Š\n+â”Š   â”Š131â”Š    await wait(() =>\n+â”Š   â”Š132â”Š      expect(passwordInput.value).toEqual('password')\n+â”Š   â”Š133â”Š    );\n+â”Š   â”Š134â”Š\n+â”Š   â”Š135â”Š    await wait(() =>\n+â”Š   â”Š136â”Š      expect(passwordConfirmInput.value).toEqual('password')\n+â”Š   â”Š137â”Š    );\n+â”Š   â”Š138â”Š\n+â”Š   â”Š139â”Š    act(() => {\n+â”Š   â”Š140â”Š      fireEvent.click(signUpButton);\n+â”Š   â”Š141â”Š    });\n+â”Š   â”Š142â”Š\n+â”Š   â”Š143â”Š    const errorMessage = await waitForElement(() =>\n+â”Š   â”Š144â”Š      getByTestId('error-message')\n+â”Š   â”Š145â”Š    );\n+â”Š   â”Š146â”Š\n+â”Š   â”Š147â”Š    await wait(() =>expect(errorMessage.innerHTML).toContain('sign-up failed'));\n+â”Š   â”Š148â”Š  });\n+â”Š   â”Š149â”Š\n+â”Š   â”Š150â”Š  it('navigates to /sign-in if everything went right', async () => {\n+â”Š   â”Š151â”Š    const history = createMemoryHistory();\n+â”Š   â”Š152â”Š\n+â”Š   â”Š153â”Š    const client = mockApolloClient([\n+â”Š   â”Š154â”Š      {\n+â”Š   â”Š155â”Š        request: {\n+â”Š   â”Š156â”Š          query: SignUpDocument,\n+â”Š   â”Š157â”Š          variables: {\n+â”Š   â”Š158â”Š            name: 'User Name',\n+â”Š   â”Š159â”Š            username: 'username',\n+â”Š   â”Š160â”Š            password: 'password',\n+â”Š   â”Š161â”Š            passwordConfirm: 'password'\n+â”Š   â”Š162â”Š          }\n+â”Š   â”Š163â”Š        },\n+â”Š   â”Š164â”Š        result: { data: {} }\n+â”Š   â”Š165â”Š      }\n+â”Š   â”Š166â”Š    ]);\n+â”Š   â”Š167â”Š\n+â”Š   â”Š168â”Š    let getByTestId: any = null;\n+â”Š   â”Š169â”Š\n+â”Š   â”Š170â”Š    act(() => {\n+â”Š   â”Š171â”Š      getByTestId = render(\n+â”Š   â”Š172â”Š        <ApolloProvider client={client}>\n+â”Š   â”Š173â”Š          <SignUpForm history={history} />\n+â”Š   â”Š174â”Š        </ApolloProvider>\n+â”Š   â”Š175â”Š      ).getByTestId;\n+â”Š   â”Š176â”Š    });\n+â”Š   â”Š177â”Š\n+â”Š   â”Š178â”Š    const nameInput = await waitForElement(() =>\n+â”Š   â”Š179â”Š      getByTestId('name-input').querySelector('input')\n+â”Š   â”Š180â”Š    );\n+â”Š   â”Š181â”Š    const usernameInput = await waitForElement(() =>\n+â”Š   â”Š182â”Š      getByTestId('username-input').querySelector('input')\n+â”Š   â”Š183â”Š    );\n+â”Š   â”Š184â”Š    const passwordInput = await waitForElement(() =>\n+â”Š   â”Š185â”Š      getByTestId('password-input').querySelector('input')\n+â”Š   â”Š186â”Š    );\n+â”Š   â”Š187â”Š    const passwordConfirmInput = await waitForElement(() =>\n+â”Š   â”Š188â”Š      getByTestId('password-confirm-input').querySelector('input')\n+â”Š   â”Š189â”Š    );\n+â”Š   â”Š190â”Š    const signUpButton = await waitForElement(() =>\n+â”Š   â”Š191â”Š      getByTestId('sign-up-button') as HTMLButtonElement\n+â”Š   â”Š192â”Š    );\n+â”Š   â”Š193â”Š\n+â”Š   â”Š194â”Š    act(() => {\n+â”Š   â”Š195â”Š      fireEvent.change(nameInput, { target: { value: 'User Name' } });\n+â”Š   â”Š196â”Š      fireEvent.change(usernameInput, { target: { value: 'username' } });\n+â”Š   â”Š197â”Š      fireEvent.change(passwordInput, { target: { value: 'password' } });\n+â”Š   â”Š198â”Š      fireEvent.change(passwordConfirmInput, { target: { value: 'password' } });\n+â”Š   â”Š199â”Š    });\n+â”Š   â”Š200â”Š\n+â”Š   â”Š201â”Š    await wait(() =>\n+â”Š   â”Š202â”Š      expect(nameInput.value).toEqual('User Name')\n+â”Š   â”Š203â”Š    );\n+â”Š   â”Š204â”Š\n+â”Š   â”Š205â”Š    await wait(() =>\n+â”Š   â”Š206â”Š      expect(usernameInput.value).toEqual('username')\n+â”Š   â”Š207â”Š    );\n+â”Š   â”Š208â”Š\n+â”Š   â”Š209â”Š    await wait(() =>\n+â”Š   â”Š210â”Š      expect(passwordInput.value).toEqual('password')\n+â”Š   â”Š211â”Š    );\n+â”Š   â”Š212â”Š\n+â”Š   â”Š213â”Š    await wait(() =>\n+â”Š   â”Š214â”Š      expect(passwordConfirmInput.value).toEqual('password')\n+â”Š   â”Š215â”Š    );\n+â”Š   â”Š216â”Š\n+â”Š   â”Š217â”Š    act(() => {\n+â”Š   â”Š218â”Š      fireEvent.click(signUpButton);\n+â”Š   â”Š219â”Š    });\n+â”Š   â”Š220â”Š\n+â”Š   â”Š221â”Š    await wait(() =>\n+â”Š   â”Š222â”Š      expect(history.location.pathname).toEqual('/sign-in')\n+â”Š   â”Š223â”Š    );\n+â”Š   â”Š224â”Š  });\n+â”Š   â”Š225â”Š});ðŸš«â†µ\n```\n\n##### Added src&#x2F;components&#x2F;AuthScreen&#x2F;SignUpForm.tsx\n```diff\n@@ -0,0 +1,124 @@\n+â”Š   â”Š  1â”Šimport React from 'react';\n+â”Š   â”Š  2â”Šimport { useCallback, useState } from 'react';\n+â”Š   â”Š  3â”Šimport { useSignUp } from '../../services/auth.service';\n+â”Š   â”Š  4â”Šimport {\n+â”Š   â”Š  5â”Š  SignForm,\n+â”Š   â”Š  6â”Š  ActualForm,\n+â”Š   â”Š  7â”Š  Legend,\n+â”Š   â”Š  8â”Š  Section,\n+â”Š   â”Š  9â”Š  TextField,\n+â”Š   â”Š 10â”Š  Button,\n+â”Š   â”Š 11â”Š  ErrorMessage,\n+â”Š   â”Š 12â”Š} from './form-components';\n+â”Š   â”Š 13â”Šimport { RouteComponentProps } from 'react-router-dom';\n+â”Š   â”Š 14â”Š\n+â”Š   â”Š 15â”Šconst SignUpForm: React.FC<RouteComponentProps<any>> = ({ history }) => {\n+â”Š   â”Š 16â”Š  const [name, setName] = useState('');\n+â”Š   â”Š 17â”Š  const [username, setUsername] = useState('');\n+â”Š   â”Š 18â”Š  const [password, setPassword] = useState('');\n+â”Š   â”Š 19â”Š  const [passwordConfirm, setPasswordConfirm] = useState('');\n+â”Š   â”Š 20â”Š  const [error, setError] = useState('');\n+â”Š   â”Š 21â”Š  const [signUp] = useSignUp()\n+â”Š   â”Š 22â”Š\n+â”Š   â”Š 23â”Š  const updateName = useCallback(({ target }) => {\n+â”Š   â”Š 24â”Š    setError('');\n+â”Š   â”Š 25â”Š    setName(target.value);\n+â”Š   â”Š 26â”Š  }, []);\n+â”Š   â”Š 27â”Š\n+â”Š   â”Š 28â”Š  const updateUsername = useCallback(({ target }) => {\n+â”Š   â”Š 29â”Š    setError('');\n+â”Š   â”Š 30â”Š    setUsername(target.value);\n+â”Š   â”Š 31â”Š  }, []);\n+â”Š   â”Š 32â”Š\n+â”Š   â”Š 33â”Š  const updatePassword = useCallback(({ target }) => {\n+â”Š   â”Š 34â”Š    setError('');\n+â”Š   â”Š 35â”Š    setPassword(target.value);\n+â”Š   â”Š 36â”Š  }, []);\n+â”Š   â”Š 37â”Š\n+â”Š   â”Š 38â”Š  const updatePasswordConfirm = useCallback(({ target }) => {\n+â”Š   â”Š 39â”Š    setError('');\n+â”Š   â”Š 40â”Š    setPasswordConfirm(target.value);\n+â”Š   â”Š 41â”Š  }, []);\n+â”Š   â”Š 42â”Š\n+â”Š   â”Š 43â”Š  const maySignUp = useCallback(() => {\n+â”Š   â”Š 44â”Š    return !!(name && username && password && password === passwordConfirm);\n+â”Š   â”Š 45â”Š  }, [name, username, password, passwordConfirm]);\n+â”Š   â”Š 46â”Š\n+â”Š   â”Š 47â”Š  const handleSignUp = useCallback(() => {\n+â”Š   â”Š 48â”Š    signUp({ variables: { username, password, passwordConfirm, name } })\n+â”Š   â”Š 49â”Š      .then(() => {\n+â”Š   â”Š 50â”Š        history.replace('/sign-in');\n+â”Š   â”Š 51â”Š      })\n+â”Š   â”Š 52â”Š      .catch(error => {\n+â”Š   â”Š 53â”Š        setError(error.message || error);\n+â”Š   â”Š 54â”Š      });\n+â”Š   â”Š 55â”Š  }, [name, username, password, passwordConfirm, history, signUp]);\n+â”Š   â”Š 56â”Š\n+â”Š   â”Š 57â”Š  return (\n+â”Š   â”Š 58â”Š    <SignForm>\n+â”Š   â”Š 59â”Š      <ActualForm>\n+â”Š   â”Š 60â”Š        <Legend>Sign up</Legend>\n+â”Š   â”Š 61â”Š        <Section\n+â”Š   â”Š 62â”Š          style={{\n+â”Š   â”Š 63â”Š            float: 'left',\n+â”Š   â”Š 64â”Š            width: 'calc(50% - 10px)',\n+â”Š   â”Š 65â”Š            paddingRight: '10px',\n+â”Š   â”Š 66â”Š          }}>\n+â”Š   â”Š 67â”Š          <TextField\n+â”Š   â”Š 68â”Š            data-testid=\"name-input\"\n+â”Š   â”Š 69â”Š            label=\"Name\"\n+â”Š   â”Š 70â”Š            value={name}\n+â”Š   â”Š 71â”Š            onChange={updateName}\n+â”Š   â”Š 72â”Š            autoComplete=\"off\"\n+â”Š   â”Š 73â”Š            margin=\"normal\"\n+â”Š   â”Š 74â”Š          />\n+â”Š   â”Š 75â”Š          <TextField\n+â”Š   â”Š 76â”Š            data-testid=\"username-input\"\n+â”Š   â”Š 77â”Š            label=\"Username\"\n+â”Š   â”Š 78â”Š            value={username}\n+â”Š   â”Š 79â”Š            onChange={updateUsername}\n+â”Š   â”Š 80â”Š            autoComplete=\"off\"\n+â”Š   â”Š 81â”Š            margin=\"normal\"\n+â”Š   â”Š 82â”Š          />\n+â”Š   â”Š 83â”Š        </Section>\n+â”Š   â”Š 84â”Š        <Section\n+â”Š   â”Š 85â”Š          style={{\n+â”Š   â”Š 86â”Š            float: 'right',\n+â”Š   â”Š 87â”Š            width: 'calc(50% - 10px)',\n+â”Š   â”Š 88â”Š            paddingLeft: '10px',\n+â”Š   â”Š 89â”Š          }}>\n+â”Š   â”Š 90â”Š          <TextField\n+â”Š   â”Š 91â”Š            data-testid=\"password-input\"\n+â”Š   â”Š 92â”Š            label=\"Password\"\n+â”Š   â”Š 93â”Š            type=\"password\"\n+â”Š   â”Š 94â”Š            value={password}\n+â”Š   â”Š 95â”Š            onChange={updatePassword}\n+â”Š   â”Š 96â”Š            autoComplete=\"off\"\n+â”Š   â”Š 97â”Š            margin=\"normal\"\n+â”Š   â”Š 98â”Š          />\n+â”Š   â”Š 99â”Š          <TextField\n+â”Š   â”Š100â”Š            data-testid=\"password-confirm-input\"\n+â”Š   â”Š101â”Š            label=\"Confirm password\"\n+â”Š   â”Š102â”Š            type=\"password\"\n+â”Š   â”Š103â”Š            value={passwordConfirm}\n+â”Š   â”Š104â”Š            onChange={updatePasswordConfirm}\n+â”Š   â”Š105â”Š            autoComplete=\"off\"\n+â”Š   â”Š106â”Š            margin=\"normal\"\n+â”Š   â”Š107â”Š          />\n+â”Š   â”Š108â”Š        </Section>\n+â”Š   â”Š109â”Š        <Button\n+â”Š   â”Š110â”Š          data-testid=\"sign-up-button\"\n+â”Š   â”Š111â”Š          type=\"button\"\n+â”Š   â”Š112â”Š          color=\"secondary\"\n+â”Š   â”Š113â”Š          variant=\"contained\"\n+â”Š   â”Š114â”Š          disabled={!maySignUp()}\n+â”Š   â”Š115â”Š          onClick={handleSignUp}>\n+â”Š   â”Š116â”Š          Sign up\n+â”Š   â”Š117â”Š        </Button>\n+â”Š   â”Š118â”Š        <ErrorMessage data-testid=\"error-message\">{error}</ErrorMessage>\n+â”Š   â”Š119â”Š      </ActualForm>\n+â”Š   â”Š120â”Š    </SignForm>\n+â”Š   â”Š121â”Š  );\n+â”Š   â”Š122â”Š};\n+â”Š   â”Š123â”Š\n+â”Š   â”Š124â”Šexport default SignUpForm;\n```\n\n##### Added src&#x2F;components&#x2F;AuthScreen&#x2F;form-components.ts\n```diff\n@@ -0,0 +1,75 @@\n+â”Š  â”Š 1â”Šimport MaterialButton from '@material-ui/core/Button';\n+â”Š  â”Š 2â”Šimport MaterialTextField from '@material-ui/core/TextField';\n+â”Š  â”Š 3â”Šimport styled from 'styled-components';\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šexport const SignForm = styled.div`\n+â”Š  â”Š 6â”Š  height: calc(100% - 265px);\n+â”Š  â”Š 7â”Š`;\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Šexport const ActualForm = styled.form`\n+â”Š  â”Š10â”Š  padding: 20px;\n+â”Š  â”Š11â”Š`;\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Šexport const Section = styled.div`\n+â”Š  â”Š14â”Š  padding-bottom: 35px;\n+â”Š  â”Š15â”Š`;\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Šexport const Legend = styled.legend`\n+â”Š  â”Š18â”Š  font-weight: bold;\n+â”Š  â”Š19â”Š  color: white;\n+â”Š  â”Š20â”Š`;\n+â”Š  â”Š21â”Š\n+â”Š  â”Š22â”Šexport const Label = styled.label`\n+â”Š  â”Š23â”Š  color: white !important;\n+â”Š  â”Š24â”Š`;\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Šexport const Input = styled.input`\n+â”Š  â”Š27â”Š  color: white;\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š  &::placeholder {\n+â”Š  â”Š30â”Š    color: var(--primary-bg);\n+â”Š  â”Š31â”Š  }\n+â”Š  â”Š32â”Š`;\n+â”Š  â”Š33â”Š\n+â”Š  â”Š34â”Šexport const TextField = styled(MaterialTextField)`\n+â”Š  â”Š35â”Š  width: 100%;\n+â”Š  â”Š36â”Š  position: relative;\n+â”Š  â”Š37â”Š\n+â”Š  â”Š38â”Š  > div::before {\n+â”Š  â”Š39â”Š    border-color: white !important;\n+â”Š  â”Š40â”Š  }\n+â”Š  â”Š41â”Š\n+â”Š  â”Š42â”Š  input {\n+â”Š  â”Š43â”Š    color: white !important;\n+â”Š  â”Š44â”Š\n+â”Š  â”Š45â”Š    &::placeholder {\n+â”Š  â”Š46â”Š      color: var(--primary-bg) !important;\n+â”Š  â”Š47â”Š    }\n+â”Š  â”Š48â”Š  }\n+â”Š  â”Š49â”Š\n+â”Š  â”Š50â”Š  label {\n+â”Š  â”Š51â”Š    color: white !important;\n+â”Š  â”Š52â”Š  }\n+â”Š  â”Š53â”Š`;\n+â”Š  â”Š54â”Š\n+â”Š  â”Š55â”Šexport const Button = styled(MaterialButton)`\n+â”Š  â”Š56â”Š  width: 100px;\n+â”Š  â”Š57â”Š  display: block !important;\n+â”Š  â”Š58â”Š  margin: auto !important;\n+â”Š  â”Š59â”Š  background-color: var(--secondary-bg) !important;\n+â”Š  â”Š60â”Š\n+â”Š  â”Š61â”Š  &[disabled] {\n+â”Š  â”Š62â”Š    color: #38a81c;\n+â”Š  â”Š63â”Š  }\n+â”Š  â”Š64â”Š\n+â”Š  â”Š65â”Š  &:not([disabled]) {\n+â”Š  â”Š66â”Š    color: white;\n+â”Š  â”Š67â”Š  }\n+â”Š  â”Š68â”Š`;\n+â”Š  â”Š69â”Š\n+â”Š  â”Š70â”Šexport const ErrorMessage = styled.div`\n+â”Š  â”Š71â”Š  position: fixed;\n+â”Š  â”Š72â”Š  color: red;\n+â”Š  â”Š73â”Š  font-size: 15px;\n+â”Š  â”Š74â”Š  margin-top: 20px;\n+â”Š  â”Š75â”Š`;\n```\n\n##### Changed src&#x2F;components&#x2F;AuthScreen&#x2F;index.tsx\n```diff\n@@ -1,13 +1,13 @@\n-â”Š 1â”Š  â”Šimport MaterialButton from '@material-ui/core/Button';\n-â”Š 2â”Š  â”Šimport MaterialTextField from '@material-ui/core/TextField';\n â”Š 3â”Š 1â”Šimport React from 'react';\n-â”Š 4â”Š  â”Šimport { useCallback, useState } from 'react';\n+â”Š  â”Š 2â”Šimport { useMemo } from 'react';\n+â”Š  â”Š 3â”Šimport { Route } from 'react-router-dom';\n â”Š 5â”Š 4â”Šimport styled from 'styled-components';\n-â”Š 6â”Š  â”Šimport { useSignIn } from '../../services/auth.service';\n+â”Š  â”Š 5â”Šimport AnimatedSwitch from '../AnimatedSwitch';\n+â”Š  â”Š 6â”Šimport SignInForm from './SignInForm';\n+â”Š  â”Š 7â”Šimport SignUpForm from './SignUpForm';\n â”Š 7â”Š 8â”Šimport { RouteComponentProps } from 'react-router-dom';\n â”Š 8â”Š 9â”Š\n â”Š 9â”Š10â”Šconst Container = styled.div`\n-â”Š10â”Š  â”Š  height: 100%;\n â”Š11â”Š11â”Š  background: radial-gradient(rgb(34, 65, 67), rgb(17, 48, 50)),\n â”Š12â”Š12â”Š    url(/assets/chat-background.jpg) no-repeat;\n â”Š13â”Š13â”Š  background-size: cover;\n```\n```diff\n@@ -40,149 +40,51 @@\n â”Š 40â”Š 40â”Š  bottom: 10px;\n â”Š 41â”Š 41â”Š  left: 10px;\n â”Š 42â”Š 42â”Š\n-â”Š 43â”Š   â”Š  a {\n+â”Š   â”Š 43â”Š  label {\n â”Š 44â”Š 44â”Š    color: var(--secondary-bg);\n â”Š 45â”Š 45â”Š  }\n â”Š 46â”Š 46â”Š`;\n â”Š 47â”Š 47â”Š\n-â”Š 48â”Š   â”Šconst SignInForm = styled.div`\n-â”Š 49â”Š   â”Š  height: calc(100% - 265px);\n-â”Š 50â”Š   â”Š`;\n-â”Š 51â”Š   â”Š\n-â”Š 52â”Š   â”Šconst ActualForm = styled.form`\n-â”Š 53â”Š   â”Š  padding: 20px;\n-â”Š 54â”Š   â”Š`;\n-â”Š 55â”Š   â”Š\n-â”Š 56â”Š   â”Šconst Section = styled.div`\n-â”Š 57â”Š   â”Š  width: 100%;\n-â”Š 58â”Š   â”Š  padding-bottom: 35px;\n-â”Š 59â”Š   â”Š`;\n-â”Š 60â”Š   â”Š\n-â”Š 61â”Š   â”Šconst Legend = styled.legend`\n-â”Š 62â”Š   â”Š  font-weight: bold;\n-â”Š 63â”Š   â”Š  color: white;\n-â”Š 64â”Š   â”Š`;\n-â”Š 65â”Š   â”Š\n-â”Š 66â”Š   â”Š// eslint-disable-next-line\n-â”Š 67â”Š   â”Šconst Label = styled.label`\n-â”Š 68â”Š   â”Š  color: white !important;\n-â”Š 69â”Š   â”Š`;\n-â”Š 70â”Š   â”Š\n-â”Š 71â”Š   â”Š// eslint-disable-next-line\n-â”Š 72â”Š   â”Šconst Input = styled.input`\n-â”Š 73â”Š   â”Š  color: white;\n-â”Š 74â”Š   â”Š\n-â”Š 75â”Š   â”Š  &::placeholder {\n-â”Š 76â”Š   â”Š    color: var(--primary-bg);\n-â”Š 77â”Š   â”Š  }\n-â”Š 78â”Š   â”Š`;\n-â”Š 79â”Š   â”Š\n-â”Š 80â”Š   â”Šconst TextField = styled(MaterialTextField)`\n-â”Š 81â”Š   â”Š  width: 100%;\n-â”Š 82â”Š   â”Š  position: relative;\n-â”Š 83â”Š   â”Š\n-â”Š 84â”Š   â”Š  > div::before {\n-â”Š 85â”Š   â”Š    border-color: white !important;\n-â”Š 86â”Š   â”Š  }\n-â”Š 87â”Š   â”Š\n-â”Š 88â”Š   â”Š  input {\n-â”Š 89â”Š   â”Š    color: white !important;\n-â”Š 90â”Š   â”Š\n-â”Š 91â”Š   â”Š    &::placeholder {\n-â”Š 92â”Š   â”Š      color: var(--primary-bg) !important;\n+â”Š   â”Š 48â”Šconst AuthScreen: React.FC<RouteComponentProps<any>> = ({\n+â”Š   â”Š 49â”Š  history,\n+â”Š   â”Š 50â”Š  location,\n+â”Š   â”Š 51â”Š}) => {\n+â”Š   â”Š 52â”Š  const alternative = useMemo(() => {\n+â”Š   â”Š 53â”Š    if (location.pathname === '/sign-in') {\n+â”Š   â”Š 54â”Š      const handleSignUp = () => {\n+â”Š   â”Š 55â”Š        history.replace('/sign-up');\n+â”Š   â”Š 56â”Š      };\n+â”Š   â”Š 57â”Š\n+â”Š   â”Š 58â”Š      return (\n+â”Š   â”Š 59â”Š        <Alternative>\n+â”Š   â”Š 60â”Š          Don't have an account yet?{' '}\n+â”Š   â”Š 61â”Š          <label onClick={handleSignUp}>Sign up!</label>\n+â”Š   â”Š 62â”Š        </Alternative>\n+â”Š   â”Š 63â”Š      );\n+â”Š   â”Š 64â”Š    } else {\n+â”Š   â”Š 65â”Š      const handleSignIn = () => {\n+â”Š   â”Š 66â”Š        history.replace('/sign-in');\n+â”Š   â”Š 67â”Š      };\n+â”Š   â”Š 68â”Š\n+â”Š   â”Š 69â”Š      return (\n+â”Š   â”Š 70â”Š        <Alternative>\n+â”Š   â”Š 71â”Š          Already have an accout? <label onClick={handleSignIn}>Sign in!</label>\n+â”Š   â”Š 72â”Š        </Alternative>\n+â”Š   â”Š 73â”Š      );\n â”Š 93â”Š 74â”Š    }\n-â”Š 94â”Š   â”Š  }\n-â”Š 95â”Š   â”Š\n-â”Š 96â”Š   â”Š  label {\n-â”Š 97â”Š   â”Š    color: white !important;\n-â”Š 98â”Š   â”Š  }\n-â”Š 99â”Š   â”Š`;\n-â”Š100â”Š   â”Š\n-â”Š101â”Š   â”Šconst Button = styled(MaterialButton)`\n-â”Š102â”Š   â”Š  width: 100px;\n-â”Š103â”Š   â”Š  display: block !important;\n-â”Š104â”Š   â”Š  margin: auto !important;\n-â”Š105â”Š   â”Š  background-color: var(--secondary-bg) !important;\n-â”Š106â”Š   â”Š\n-â”Š107â”Š   â”Š  &[disabled] {\n-â”Š108â”Š   â”Š    color: #38a81c;\n-â”Š109â”Š   â”Š  }\n-â”Š110â”Š   â”Š\n-â”Š111â”Š   â”Š  &:not([disabled]) {\n-â”Š112â”Š   â”Š    color: white;\n-â”Š113â”Š   â”Š  }\n-â”Š114â”Š   â”Š`;\n-â”Š115â”Š   â”Š\n-â”Š116â”Š   â”Šconst AuthScreen: React.FC<RouteComponentProps<any>> = ({ history }) => {\n-â”Š117â”Š   â”Š  const [username, setUsername] = useState('');\n-â”Š118â”Š   â”Š  const [password, setPassword] = useState('');\n-â”Š119â”Š   â”Š  // eslint-disable-next-line\n-â”Š120â”Š   â”Š  const [error, setError] = useState('');\n-â”Š121â”Š   â”Š  const [signIn] = useSignIn();\n-â”Š122â”Š   â”Š\n-â”Š123â”Š   â”Š  const onUsernameChange = useCallback(({ target }) => {\n-â”Š124â”Š   â”Š    setError('');\n-â”Š125â”Š   â”Š    setUsername(target.value);\n-â”Š126â”Š   â”Š  }, []);\n-â”Š127â”Š   â”Š\n-â”Š128â”Š   â”Š  const onPasswordChange = useCallback(({ target }) => {\n-â”Š129â”Š   â”Š    setError('');\n-â”Š130â”Š   â”Š    setPassword(target.value);\n-â”Š131â”Š   â”Š  }, []);\n-â”Š132â”Š   â”Š\n-â”Š133â”Š   â”Š  const maySignIn = useCallback(() => {\n-â”Š134â”Š   â”Š    return !!(username && password);\n-â”Š135â”Š   â”Š  }, [username, password]);\n-â”Š136â”Š   â”Š\n-â”Š137â”Š   â”Š  const handleSignIn = useCallback(() => {\n-â”Š138â”Š   â”Š    signIn({ variables: { username, password } })\n-â”Š139â”Š   â”Š      .then(() => {\n-â”Š140â”Š   â”Š        history.push('/chats');\n-â”Š141â”Š   â”Š      })\n-â”Š142â”Š   â”Š      .catch(error => {\n-â”Š143â”Š   â”Š        setError(error.message || error);\n-â”Š144â”Š   â”Š      });\n-â”Š145â”Š   â”Š  }, [username, password, history, signIn]);\n+â”Š   â”Š 75â”Š  }, [location.pathname, history]);\n â”Š146â”Š 76â”Š\n â”Š147â”Š 77â”Š  return (\n-â”Š148â”Š   â”Š    <Container>\n-â”Š149â”Š   â”Š      <Intro>\n+â”Š   â”Š 78â”Š    <Container className=\"AuthScreen Screen\">\n+â”Š   â”Š 79â”Š      <Intro className=\"AuthScreen-intro\">\n â”Š150â”Š 80â”Š        <Icon src=\"assets/whatsapp-icon.png\" className=\"AuthScreen-icon\" />\n â”Š151â”Š 81â”Š        <Title className=\"AuthScreen-title\">WhatsApp</Title>\n â”Š152â”Š 82â”Š      </Intro>\n-â”Š153â”Š   â”Š      <SignInForm>\n-â”Š154â”Š   â”Š        <ActualForm>\n-â”Š155â”Š   â”Š          <Legend>Sign in</Legend>\n-â”Š156â”Š   â”Š          <Section>\n-â”Š157â”Š   â”Š            <TextField\n-â”Š158â”Š   â”Š              className=\"AuthScreen-text-field\"\n-â”Š159â”Š   â”Š              label=\"Username\"\n-â”Š160â”Š   â”Š              value={username}\n-â”Š161â”Š   â”Š              onChange={onUsernameChange}\n-â”Š162â”Š   â”Š              margin=\"normal\"\n-â”Š163â”Š   â”Š              placeholder=\"Enter your username\"\n-â”Š164â”Š   â”Š            />\n-â”Š165â”Š   â”Š            <TextField\n-â”Š166â”Š   â”Š              className=\"AuthScreen-text-field\"\n-â”Š167â”Š   â”Š              label=\"Password\"\n-â”Š168â”Š   â”Š              type=\"password\"\n-â”Š169â”Š   â”Š              value={password}\n-â”Š170â”Š   â”Š              onChange={onPasswordChange}\n-â”Š171â”Š   â”Š              margin=\"normal\"\n-â”Š172â”Š   â”Š              placeholder=\"Enter your password\"\n-â”Š173â”Š   â”Š            />\n-â”Š174â”Š   â”Š          </Section>\n-â”Š175â”Š   â”Š          <Button\n-â”Š176â”Š   â”Š            data-testid=\"sign-in-button\"\n-â”Š177â”Š   â”Š            type=\"button\"\n-â”Š178â”Š   â”Š            color=\"secondary\"\n-â”Š179â”Š   â”Š            variant=\"contained\"\n-â”Š180â”Š   â”Š            disabled={!maySignIn()}\n-â”Š181â”Š   â”Š            onClick={handleSignIn}>\n-â”Š182â”Š   â”Š            Sign in\n-â”Š183â”Š   â”Š          </Button>\n-â”Š184â”Š   â”Š        </ActualForm>\n-â”Š185â”Š   â”Š      </SignInForm>\n+â”Š   â”Š 83â”Š      <AnimatedSwitch>\n+â”Š   â”Š 84â”Š        <Route exact path=\"/sign-in\" component={SignInForm} />\n+â”Š   â”Š 85â”Š        <Route exact path=\"/sign-up\" component={SignUpForm} />\n+â”Š   â”Š 86â”Š      </AnimatedSwitch>\n+â”Š   â”Š 87â”Š      {alternative}\n â”Š186â”Š 88â”Š    </Container>\n â”Š187â”Š 89â”Š  );\n â”Š188â”Š 90â”Š};\n```\n\n[}]: #\n\nAnd then we will make the necessary changes in the `AuthScreen`:\n\n[{]: <helper> (diffStep 13.6 module=\"client\")\n\n#### [__Client__ Step 13.6: Split AuthScreen into SignInForm and SignUpForm](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/405ed9dba6c98399285de0bfc8e8008a34ec08e7)\n\n##### Added src&#x2F;components&#x2F;AuthScreen&#x2F;SignInForm.test.tsx\n```diff\n@@ -0,0 +1,163 @@\n+â”Š   â”Š  1â”Šimport { createMemoryHistory } from 'history';\n+â”Š   â”Š  2â”Šimport React from 'react';\n+â”Š   â”Š  3â”Šimport { ApolloProvider } from '@apollo/react-hooks';\n+â”Š   â”Š  4â”Šimport { act, cleanup, render, fireEvent, wait, waitForElement } from '@testing-library/react';\n+â”Š   â”Š  5â”Šimport SignInForm from './SignInForm';\n+â”Š   â”Š  6â”Šimport { SignInDocument } from '../../graphql/types';\n+â”Š   â”Š  7â”Šimport { mockApolloClient } from '../../test-helpers';\n+â”Š   â”Š  8â”Š\n+â”Š   â”Š  9â”Šdescribe('SignInForm', () => {\n+â”Š   â”Š 10â”Š  afterEach(cleanup);\n+â”Š   â”Š 11â”Š\n+â”Š   â”Š 12â”Š  it('enables sign-in button when filled in', async () => {\n+â”Š   â”Š 13â”Š    const history = createMemoryHistory();\n+â”Š   â”Š 14â”Š    const client = mockApolloClient();\n+â”Š   â”Š 15â”Š\n+â”Š   â”Š 16â”Š    let getByTestId: any = null;\n+â”Š   â”Š 17â”Š\n+â”Š   â”Š 18â”Š    act(() => {\n+â”Š   â”Š 19â”Š      getByTestId = render(\n+â”Š   â”Š 20â”Š        <ApolloProvider client={client}>\n+â”Š   â”Š 21â”Š          <SignInForm history={history} />\n+â”Š   â”Š 22â”Š        </ApolloProvider>\n+â”Š   â”Š 23â”Š      ).getByTestId;\n+â”Š   â”Š 24â”Š    });\n+â”Š   â”Š 25â”Š\n+â”Š   â”Š 26â”Š    const signInButton = await waitForElement(() =>\n+â”Š   â”Š 27â”Š      getByTestId('sign-in-button') as HTMLButtonElement\n+â”Š   â”Š 28â”Š    );\n+â”Š   â”Š 29â”Š    const usernameInput = await waitForElement(() =>\n+â”Š   â”Š 30â”Š      getByTestId('username-input').querySelector('input')\n+â”Š   â”Š 31â”Š    );\n+â”Š   â”Š 32â”Š    const passwordInput = await waitForElement(() =>\n+â”Š   â”Š 33â”Š      getByTestId('password-input').querySelector('input')\n+â”Š   â”Š 34â”Š    );\n+â”Š   â”Š 35â”Š\n+â”Š   â”Š 36â”Š    expect(signInButton.disabled).toEqual(true);\n+â”Š   â”Š 37â”Š\n+â”Š   â”Š 38â”Š    act(() => {\n+â”Š   â”Š 39â”Š      fireEvent.change(usernameInput, { target: { value: 'username' } });\n+â”Š   â”Š 40â”Š      fireEvent.change(passwordInput, { target: { value: 'password' } });\n+â”Š   â”Š 41â”Š    });\n+â”Š   â”Š 42â”Š\n+â”Š   â”Š 43â”Š    await wait(() =>\n+â”Š   â”Š 44â”Š      expect(signInButton.disabled).toEqual(false)\n+â”Š   â”Š 45â”Š    )\n+â”Š   â”Š 46â”Š  });\n+â”Š   â”Š 47â”Š\n+â”Š   â”Š 48â”Š  it('prints server error if input was wrong', async () => {\n+â”Š   â”Š 49â”Š    const history = createMemoryHistory();\n+â”Š   â”Š 50â”Š\n+â”Š   â”Š 51â”Š    const client = mockApolloClient([\n+â”Š   â”Š 52â”Š      {\n+â”Š   â”Š 53â”Š        request: {\n+â”Š   â”Š 54â”Š          query: SignInDocument,\n+â”Š   â”Š 55â”Š          variables: {\n+â”Š   â”Š 56â”Š            username: 'username',\n+â”Š   â”Š 57â”Š            password: 'password'\n+â”Š   â”Š 58â”Š          }\n+â”Š   â”Š 59â”Š        },\n+â”Š   â”Š 60â”Š        get result() { throw Error('sign-in failed') },\n+â”Š   â”Š 61â”Š      }\n+â”Š   â”Š 62â”Š    ]);\n+â”Š   â”Š 63â”Š\n+â”Š   â”Š 64â”Š    let getByTestId: any = null;\n+â”Š   â”Š 65â”Š\n+â”Š   â”Š 66â”Š    act(() => {\n+â”Š   â”Š 67â”Š      getByTestId = render(\n+â”Š   â”Š 68â”Š        <ApolloProvider client={client}>\n+â”Š   â”Š 69â”Š          <SignInForm history={history} />\n+â”Š   â”Š 70â”Š        </ApolloProvider>\n+â”Š   â”Š 71â”Š      ).getByTestId;\n+â”Š   â”Š 72â”Š    });\n+â”Š   â”Š 73â”Š\n+â”Š   â”Š 74â”Š    const signInButton = await waitForElement(() =>\n+â”Š   â”Š 75â”Š      getByTestId('sign-in-button') as HTMLButtonElement\n+â”Š   â”Š 76â”Š    );\n+â”Š   â”Š 77â”Š    const usernameInput = await waitForElement(() =>\n+â”Š   â”Š 78â”Š      getByTestId('username-input').querySelector('input')\n+â”Š   â”Š 79â”Š    );\n+â”Š   â”Š 80â”Š    const passwordInput = await waitForElement(() =>\n+â”Š   â”Š 81â”Š      getByTestId('password-input').querySelector('input')\n+â”Š   â”Š 82â”Š    );\n+â”Š   â”Š 83â”Š\n+â”Š   â”Š 84â”Š    act(() => {\n+â”Š   â”Š 85â”Š      fireEvent.change(usernameInput, { target: { value: 'username' } });\n+â”Š   â”Š 86â”Š      fireEvent.change(passwordInput, { target: { value: 'password' } });\n+â”Š   â”Š 87â”Š    });\n+â”Š   â”Š 88â”Š\n+â”Š   â”Š 89â”Š    await wait(() =>\n+â”Š   â”Š 90â”Š      expect(usernameInput.value).toEqual('username')\n+â”Š   â”Š 91â”Š    );\n+â”Š   â”Š 92â”Š\n+â”Š   â”Š 93â”Š    await wait(() =>\n+â”Š   â”Š 94â”Š      expect(passwordInput.value).toEqual('password')\n+â”Š   â”Š 95â”Š    );\n+â”Š   â”Š 96â”Š\n+â”Š   â”Š 97â”Š    act(() => {\n+â”Š   â”Š 98â”Š      fireEvent.click(signInButton);\n+â”Š   â”Š 99â”Š    });\n+â”Š   â”Š100â”Š\n+â”Š   â”Š101â”Š    const errorMessage = await waitForElement(() =>\n+â”Š   â”Š102â”Š      getByTestId('error-message')\n+â”Š   â”Š103â”Š    );\n+â”Š   â”Š104â”Š\n+â”Š   â”Š105â”Š    await wait(() => expect(errorMessage.innerHTML).toContain('sign-in failed'));\n+â”Š   â”Š106â”Š  });\n+â”Š   â”Š107â”Š\n+â”Š   â”Š108â”Š  it('navigates to /chats if everything went right', async () => {\n+â”Š   â”Š109â”Š    const history = createMemoryHistory();\n+â”Š   â”Š110â”Š\n+â”Š   â”Š111â”Š    const client = mockApolloClient([\n+â”Š   â”Š112â”Š      {\n+â”Š   â”Š113â”Š        request: {\n+â”Š   â”Š114â”Š          query: SignInDocument,\n+â”Š   â”Š115â”Š          variables: {\n+â”Š   â”Š116â”Š            username: 'username',\n+â”Š   â”Š117â”Š            password: 'password'\n+â”Š   â”Š118â”Š          }\n+â”Š   â”Š119â”Š        },\n+â”Š   â”Š120â”Š        result: { data: {} }\n+â”Š   â”Š121â”Š      }\n+â”Š   â”Š122â”Š    ]);\n+â”Š   â”Š123â”Š\n+â”Š   â”Š124â”Š    let getByTestId: any = null;\n+â”Š   â”Š125â”Š\n+â”Š   â”Š126â”Š    act(() => {\n+â”Š   â”Š127â”Š      getByTestId = render(\n+â”Š   â”Š128â”Š        <ApolloProvider client={client}>\n+â”Š   â”Š129â”Š          <SignInForm history={history} />\n+â”Š   â”Š130â”Š        </ApolloProvider>\n+â”Š   â”Š131â”Š      ).getByTestId;\n+â”Š   â”Š132â”Š    })\n+â”Š   â”Š133â”Š\n+â”Š   â”Š134â”Š    const usernameInput = await waitForElement(() =>\n+â”Š   â”Š135â”Š      getByTestId('username-input').querySelector('input')\n+â”Š   â”Š136â”Š    );\n+â”Š   â”Š137â”Š    const passwordInput = await waitForElement(() =>\n+â”Š   â”Š138â”Š      getByTestId('password-input').querySelector('input')\n+â”Š   â”Š139â”Š    );\n+â”Š   â”Š140â”Š    const signInButton = await waitForElement(() =>\n+â”Š   â”Š141â”Š      getByTestId('sign-in-button') as HTMLButtonElement\n+â”Š   â”Š142â”Š    );\n+â”Š   â”Š143â”Š\n+â”Š   â”Š144â”Š    act(() => {\n+â”Š   â”Š145â”Š      fireEvent.change(usernameInput, { target: { value: 'username' } });\n+â”Š   â”Š146â”Š      fireEvent.change(passwordInput, { target: { value: 'password' } });\n+â”Š   â”Š147â”Š    });\n+â”Š   â”Š148â”Š\n+â”Š   â”Š149â”Š    await wait(() =>\n+â”Š   â”Š150â”Š      expect(usernameInput.value).toEqual('username')\n+â”Š   â”Š151â”Š    );\n+â”Š   â”Š152â”Š\n+â”Š   â”Š153â”Š    await wait(() =>\n+â”Š   â”Š154â”Š      expect(passwordInput.value).toEqual('password')\n+â”Š   â”Š155â”Š    );\n+â”Š   â”Š156â”Š\n+â”Š   â”Š157â”Š    act(() => {\n+â”Š   â”Š158â”Š      fireEvent.click(signInButton);\n+â”Š   â”Š159â”Š    });\n+â”Š   â”Š160â”Š\n+â”Š   â”Š161â”Š    await wait(() => expect(history.location.pathname).toEqual('/chats'));\n+â”Š   â”Š162â”Š  });\n+â”Š   â”Š163â”Š});ðŸš«â†µ\n```\n\n##### Added src&#x2F;components&#x2F;AuthScreen&#x2F;SignInForm.tsx\n```diff\n@@ -0,0 +1,83 @@\n+â”Š  â”Š 1â”Šimport React from 'react';\n+â”Š  â”Š 2â”Šimport { useCallback, useState } from 'react';\n+â”Š  â”Š 3â”Šimport { useSignIn } from '../../services/auth.service';\n+â”Š  â”Š 4â”Šimport {\n+â”Š  â”Š 5â”Š  SignForm,\n+â”Š  â”Š 6â”Š  ActualForm,\n+â”Š  â”Š 7â”Š  Legend,\n+â”Š  â”Š 8â”Š  Section,\n+â”Š  â”Š 9â”Š  TextField,\n+â”Š  â”Š10â”Š  Button,\n+â”Š  â”Š11â”Š  ErrorMessage,\n+â”Š  â”Š12â”Š} from './form-components';\n+â”Š  â”Š13â”Šimport { RouteComponentProps } from 'react-router-dom';\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”Šconst SignInForm: React.FC<RouteComponentProps<any>> = ({ history }) => {\n+â”Š  â”Š16â”Š  const [username, setUsername] = useState('');\n+â”Š  â”Š17â”Š  const [password, setPassword] = useState('');\n+â”Š  â”Š18â”Š  const [error, setError] = useState('');\n+â”Š  â”Š19â”Š  const [signIn] = useSignIn();\n+â”Š  â”Š20â”Š\n+â”Š  â”Š21â”Š  const onUsernameChange = useCallback(({ target }) => {\n+â”Š  â”Š22â”Š    setError('');\n+â”Š  â”Š23â”Š    setUsername(target.value);\n+â”Š  â”Š24â”Š  }, []);\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Š  const onPasswordChange = useCallback(({ target }) => {\n+â”Š  â”Š27â”Š    setError('');\n+â”Š  â”Š28â”Š    setPassword(target.value);\n+â”Š  â”Š29â”Š  }, []);\n+â”Š  â”Š30â”Š\n+â”Š  â”Š31â”Š  const maySignIn = useCallback(() => {\n+â”Š  â”Š32â”Š    return !!(username && password);\n+â”Š  â”Š33â”Š  }, [username, password]);\n+â”Š  â”Š34â”Š\n+â”Š  â”Š35â”Š  const handleSignIn = useCallback(() => {\n+â”Š  â”Š36â”Š    signIn({ variables: { username, password } })\n+â”Š  â”Š37â”Š      .then(() => {\n+â”Š  â”Š38â”Š        history.replace('/chats');\n+â”Š  â”Š39â”Š      })\n+â”Š  â”Š40â”Š      .catch(error => {\n+â”Š  â”Š41â”Š        setError(error.message || error);\n+â”Š  â”Š42â”Š      });\n+â”Š  â”Š43â”Š  }, [username, password, history, signIn]);\n+â”Š  â”Š44â”Š\n+â”Š  â”Š45â”Š  return (\n+â”Š  â”Š46â”Š    <SignForm>\n+â”Š  â”Š47â”Š      <ActualForm>\n+â”Š  â”Š48â”Š        <Legend>Sign in</Legend>\n+â”Š  â”Š49â”Š        <Section style={{ width: '100%' }}>\n+â”Š  â”Š50â”Š          <TextField\n+â”Š  â”Š51â”Š            data-testid=\"username-input\"\n+â”Š  â”Š52â”Š            label=\"Username\"\n+â”Š  â”Š53â”Š            value={username}\n+â”Š  â”Š54â”Š            onChange={onUsernameChange}\n+â”Š  â”Š55â”Š            margin=\"normal\"\n+â”Š  â”Š56â”Š            placeholder=\"Enter your username\"\n+â”Š  â”Š57â”Š          />\n+â”Š  â”Š58â”Š          <TextField\n+â”Š  â”Š59â”Š            data-testid=\"password-input\"\n+â”Š  â”Š60â”Š            label=\"Password\"\n+â”Š  â”Š61â”Š            type=\"password\"\n+â”Š  â”Š62â”Š            value={password}\n+â”Š  â”Š63â”Š            onChange={onPasswordChange}\n+â”Š  â”Š64â”Š            margin=\"normal\"\n+â”Š  â”Š65â”Š            placeholder=\"Enter your password\"\n+â”Š  â”Š66â”Š          />\n+â”Š  â”Š67â”Š        </Section>\n+â”Š  â”Š68â”Š        <Button\n+â”Š  â”Š69â”Š          data-testid=\"sign-in-button\"\n+â”Š  â”Š70â”Š          type=\"button\"\n+â”Š  â”Š71â”Š          color=\"secondary\"\n+â”Š  â”Š72â”Š          variant=\"contained\"\n+â”Š  â”Š73â”Š          disabled={!maySignIn()}\n+â”Š  â”Š74â”Š          onClick={handleSignIn}>\n+â”Š  â”Š75â”Š          Sign in\n+â”Š  â”Š76â”Š        </Button>\n+â”Š  â”Š77â”Š        <ErrorMessage data-testid=\"error-message\">{error}</ErrorMessage>\n+â”Š  â”Š78â”Š      </ActualForm>\n+â”Š  â”Š79â”Š    </SignForm>\n+â”Š  â”Š80â”Š  );\n+â”Š  â”Š81â”Š};\n+â”Š  â”Š82â”Š\n+â”Š  â”Š83â”Šexport default SignInForm;\n```\n\n##### Added src&#x2F;components&#x2F;AuthScreen&#x2F;SignUpForm.test.tsx\n```diff\n@@ -0,0 +1,225 @@\n+â”Š   â”Š  1â”Šimport { createMemoryHistory } from 'history';\n+â”Š   â”Š  2â”Šimport React from 'react';\n+â”Š   â”Š  3â”Šimport { ApolloProvider } from '@apollo/react-hooks';\n+â”Š   â”Š  4â”Šimport { act, cleanup, render, fireEvent, wait, waitForElement } from '@testing-library/react';\n+â”Š   â”Š  5â”Šimport SignUpForm from './SignUpForm';\n+â”Š   â”Š  6â”Šimport { SignUpDocument } from '../../graphql/types';\n+â”Š   â”Š  7â”Šimport { mockApolloClient } from '../../test-helpers';\n+â”Š   â”Š  8â”Š\n+â”Š   â”Š  9â”Šdescribe('SignUpForm', () => {\n+â”Š   â”Š 10â”Š  afterEach(cleanup);\n+â”Š   â”Š 11â”Š\n+â”Š   â”Š 12â”Š  it('enables sign-up button when filled in', async () => {\n+â”Š   â”Š 13â”Š    const history = createMemoryHistory();\n+â”Š   â”Š 14â”Š    const client = mockApolloClient();\n+â”Š   â”Š 15â”Š\n+â”Š   â”Š 16â”Š    let getByTestId: any = null;\n+â”Š   â”Š 17â”Š\n+â”Š   â”Š 18â”Š    act(() => {\n+â”Š   â”Š 19â”Š      getByTestId = render(\n+â”Š   â”Š 20â”Š        <ApolloProvider client={client}>\n+â”Š   â”Š 21â”Š          <SignUpForm history={history} />\n+â”Š   â”Š 22â”Š        </ApolloProvider>\n+â”Š   â”Š 23â”Š      ).getByTestId;\n+â”Š   â”Š 24â”Š    });\n+â”Š   â”Š 25â”Š\n+â”Š   â”Š 26â”Š    const nameInput = await waitForElement(() =>\n+â”Š   â”Š 27â”Š      getByTestId('name-input').querySelector('input')\n+â”Š   â”Š 28â”Š    );\n+â”Š   â”Š 29â”Š    const usernameInput = await waitForElement(() =>\n+â”Š   â”Š 30â”Š      getByTestId('username-input').querySelector('input')\n+â”Š   â”Š 31â”Š    );\n+â”Š   â”Š 32â”Š    const passwordInput = await waitForElement(() =>\n+â”Š   â”Š 33â”Š      getByTestId('password-input').querySelector('input')\n+â”Š   â”Š 34â”Š    );\n+â”Š   â”Š 35â”Š    const passwordConfirmInput = await waitForElement(() =>\n+â”Š   â”Š 36â”Š      getByTestId('password-confirm-input').querySelector('input')\n+â”Š   â”Š 37â”Š    );\n+â”Š   â”Š 38â”Š    const signUpButton = await waitForElement(() =>\n+â”Š   â”Š 39â”Š      getByTestId('sign-up-button') as HTMLButtonElement\n+â”Š   â”Š 40â”Š    );\n+â”Š   â”Š 41â”Š\n+â”Š   â”Š 42â”Š    expect(signUpButton.disabled).toEqual(true);\n+â”Š   â”Š 43â”Š\n+â”Š   â”Š 44â”Š    act(() => {\n+â”Š   â”Š 45â”Š      fireEvent.change(nameInput, { target: { value: 'User Name' } });\n+â”Š   â”Š 46â”Š      fireEvent.change(usernameInput, { target: { value: 'username' } });\n+â”Š   â”Š 47â”Š      fireEvent.change(passwordInput, { target: { value: 'password' } });\n+â”Š   â”Š 48â”Š      fireEvent.change(passwordConfirmInput, { target: { value: 'password' } });\n+â”Š   â”Š 49â”Š    });\n+â”Š   â”Š 50â”Š\n+â”Š   â”Š 51â”Š    await wait(() =>\n+â”Š   â”Š 52â”Š      expect(nameInput.value).toEqual('User Name')\n+â”Š   â”Š 53â”Š    );\n+â”Š   â”Š 54â”Š\n+â”Š   â”Š 55â”Š    await wait(() =>\n+â”Š   â”Š 56â”Š      expect(usernameInput.value).toEqual('username')\n+â”Š   â”Š 57â”Š    );\n+â”Š   â”Š 58â”Š\n+â”Š   â”Š 59â”Š    await wait(() =>\n+â”Š   â”Š 60â”Š      expect(passwordInput.value).toEqual('password')\n+â”Š   â”Š 61â”Š    );\n+â”Š   â”Š 62â”Š\n+â”Š   â”Š 63â”Š    await wait(() =>\n+â”Š   â”Š 64â”Š      expect(passwordConfirmInput.value).toEqual('password')\n+â”Š   â”Š 65â”Š    );\n+â”Š   â”Š 66â”Š\n+â”Š   â”Š 67â”Š    await wait(() =>\n+â”Š   â”Š 68â”Š      expect(signUpButton.disabled).toEqual(false)\n+â”Š   â”Š 69â”Š    )\n+â”Š   â”Š 70â”Š  });\n+â”Š   â”Š 71â”Š\n+â”Š   â”Š 72â”Š  it('prints server error if input was wrong', async () => {\n+â”Š   â”Š 73â”Š    const history = createMemoryHistory();\n+â”Š   â”Š 74â”Š\n+â”Š   â”Š 75â”Š    const client = mockApolloClient([\n+â”Š   â”Š 76â”Š      {\n+â”Š   â”Š 77â”Š        request: {\n+â”Š   â”Š 78â”Š          query: SignUpDocument,\n+â”Š   â”Š 79â”Š          variables: {\n+â”Š   â”Š 80â”Š            name: 'User Name',\n+â”Š   â”Š 81â”Š            username: 'username',\n+â”Š   â”Š 82â”Š            password: 'password',\n+â”Š   â”Š 83â”Š            passwordConfirm: 'password'\n+â”Š   â”Š 84â”Š          }\n+â”Š   â”Š 85â”Š        },\n+â”Š   â”Š 86â”Š        get result() { throw Error('sign-up failed') }\n+â”Š   â”Š 87â”Š      }\n+â”Š   â”Š 88â”Š    ]);\n+â”Š   â”Š 89â”Š\n+â”Š   â”Š 90â”Š    let getByTestId: any = null;\n+â”Š   â”Š 91â”Š\n+â”Š   â”Š 92â”Š    act(() => {\n+â”Š   â”Š 93â”Š      getByTestId = render(\n+â”Š   â”Š 94â”Š        <ApolloProvider client={client}>\n+â”Š   â”Š 95â”Š          <SignUpForm history={history} />\n+â”Š   â”Š 96â”Š        </ApolloProvider>\n+â”Š   â”Š 97â”Š      ).getByTestId;\n+â”Š   â”Š 98â”Š    });\n+â”Š   â”Š 99â”Š\n+â”Š   â”Š100â”Š    const nameInput = await waitForElement(() =>\n+â”Š   â”Š101â”Š      getByTestId('name-input').querySelector('input')\n+â”Š   â”Š102â”Š    );\n+â”Š   â”Š103â”Š    const usernameInput = await waitForElement(() =>\n+â”Š   â”Š104â”Š      getByTestId('username-input').querySelector('input')\n+â”Š   â”Š105â”Š    );\n+â”Š   â”Š106â”Š    const passwordInput = await waitForElement(() =>\n+â”Š   â”Š107â”Š      getByTestId('password-input').querySelector('input')\n+â”Š   â”Š108â”Š    );\n+â”Š   â”Š109â”Š    const passwordConfirmInput = await waitForElement(() =>\n+â”Š   â”Š110â”Š      getByTestId('password-confirm-input').querySelector('input')\n+â”Š   â”Š111â”Š    );\n+â”Š   â”Š112â”Š    const signUpButton = await waitForElement(() =>\n+â”Š   â”Š113â”Š      getByTestId('sign-up-button') as HTMLButtonElement\n+â”Š   â”Š114â”Š    );\n+â”Š   â”Š115â”Š\n+â”Š   â”Š116â”Š    act(() => {\n+â”Š   â”Š117â”Š      fireEvent.change(nameInput, { target: { value: 'User Name' } });\n+â”Š   â”Š118â”Š      fireEvent.change(usernameInput, { target: { value: 'username' } });\n+â”Š   â”Š119â”Š      fireEvent.change(passwordInput, { target: { value: 'password' } });\n+â”Š   â”Š120â”Š      fireEvent.change(passwordConfirmInput, { target: { value: 'password' } });\n+â”Š   â”Š121â”Š    });\n+â”Š   â”Š122â”Š\n+â”Š   â”Š123â”Š    await wait(() =>\n+â”Š   â”Š124â”Š      expect(nameInput.value).toEqual('User Name')\n+â”Š   â”Š125â”Š    );\n+â”Š   â”Š126â”Š\n+â”Š   â”Š127â”Š    await wait(() =>\n+â”Š   â”Š128â”Š      expect(usernameInput.value).toEqual('username')\n+â”Š   â”Š129â”Š    );\n+â”Š   â”Š130â”Š\n+â”Š   â”Š131â”Š    await wait(() =>\n+â”Š   â”Š132â”Š      expect(passwordInput.value).toEqual('password')\n+â”Š   â”Š133â”Š    );\n+â”Š   â”Š134â”Š\n+â”Š   â”Š135â”Š    await wait(() =>\n+â”Š   â”Š136â”Š      expect(passwordConfirmInput.value).toEqual('password')\n+â”Š   â”Š137â”Š    );\n+â”Š   â”Š138â”Š\n+â”Š   â”Š139â”Š    act(() => {\n+â”Š   â”Š140â”Š      fireEvent.click(signUpButton);\n+â”Š   â”Š141â”Š    });\n+â”Š   â”Š142â”Š\n+â”Š   â”Š143â”Š    const errorMessage = await waitForElement(() =>\n+â”Š   â”Š144â”Š      getByTestId('error-message')\n+â”Š   â”Š145â”Š    );\n+â”Š   â”Š146â”Š\n+â”Š   â”Š147â”Š    await wait(() =>expect(errorMessage.innerHTML).toContain('sign-up failed'));\n+â”Š   â”Š148â”Š  });\n+â”Š   â”Š149â”Š\n+â”Š   â”Š150â”Š  it('navigates to /sign-in if everything went right', async () => {\n+â”Š   â”Š151â”Š    const history = createMemoryHistory();\n+â”Š   â”Š152â”Š\n+â”Š   â”Š153â”Š    const client = mockApolloClient([\n+â”Š   â”Š154â”Š      {\n+â”Š   â”Š155â”Š        request: {\n+â”Š   â”Š156â”Š          query: SignUpDocument,\n+â”Š   â”Š157â”Š          variables: {\n+â”Š   â”Š158â”Š            name: 'User Name',\n+â”Š   â”Š159â”Š            username: 'username',\n+â”Š   â”Š160â”Š            password: 'password',\n+â”Š   â”Š161â”Š            passwordConfirm: 'password'\n+â”Š   â”Š162â”Š          }\n+â”Š   â”Š163â”Š        },\n+â”Š   â”Š164â”Š        result: { data: {} }\n+â”Š   â”Š165â”Š      }\n+â”Š   â”Š166â”Š    ]);\n+â”Š   â”Š167â”Š\n+â”Š   â”Š168â”Š    let getByTestId: any = null;\n+â”Š   â”Š169â”Š\n+â”Š   â”Š170â”Š    act(() => {\n+â”Š   â”Š171â”Š      getByTestId = render(\n+â”Š   â”Š172â”Š        <ApolloProvider client={client}>\n+â”Š   â”Š173â”Š          <SignUpForm history={history} />\n+â”Š   â”Š174â”Š        </ApolloProvider>\n+â”Š   â”Š175â”Š      ).getByTestId;\n+â”Š   â”Š176â”Š    });\n+â”Š   â”Š177â”Š\n+â”Š   â”Š178â”Š    const nameInput = await waitForElement(() =>\n+â”Š   â”Š179â”Š      getByTestId('name-input').querySelector('input')\n+â”Š   â”Š180â”Š    );\n+â”Š   â”Š181â”Š    const usernameInput = await waitForElement(() =>\n+â”Š   â”Š182â”Š      getByTestId('username-input').querySelector('input')\n+â”Š   â”Š183â”Š    );\n+â”Š   â”Š184â”Š    const passwordInput = await waitForElement(() =>\n+â”Š   â”Š185â”Š      getByTestId('password-input').querySelector('input')\n+â”Š   â”Š186â”Š    );\n+â”Š   â”Š187â”Š    const passwordConfirmInput = await waitForElement(() =>\n+â”Š   â”Š188â”Š      getByTestId('password-confirm-input').querySelector('input')\n+â”Š   â”Š189â”Š    );\n+â”Š   â”Š190â”Š    const signUpButton = await waitForElement(() =>\n+â”Š   â”Š191â”Š      getByTestId('sign-up-button') as HTMLButtonElement\n+â”Š   â”Š192â”Š    );\n+â”Š   â”Š193â”Š\n+â”Š   â”Š194â”Š    act(() => {\n+â”Š   â”Š195â”Š      fireEvent.change(nameInput, { target: { value: 'User Name' } });\n+â”Š   â”Š196â”Š      fireEvent.change(usernameInput, { target: { value: 'username' } });\n+â”Š   â”Š197â”Š      fireEvent.change(passwordInput, { target: { value: 'password' } });\n+â”Š   â”Š198â”Š      fireEvent.change(passwordConfirmInput, { target: { value: 'password' } });\n+â”Š   â”Š199â”Š    });\n+â”Š   â”Š200â”Š\n+â”Š   â”Š201â”Š    await wait(() =>\n+â”Š   â”Š202â”Š      expect(nameInput.value).toEqual('User Name')\n+â”Š   â”Š203â”Š    );\n+â”Š   â”Š204â”Š\n+â”Š   â”Š205â”Š    await wait(() =>\n+â”Š   â”Š206â”Š      expect(usernameInput.value).toEqual('username')\n+â”Š   â”Š207â”Š    );\n+â”Š   â”Š208â”Š\n+â”Š   â”Š209â”Š    await wait(() =>\n+â”Š   â”Š210â”Š      expect(passwordInput.value).toEqual('password')\n+â”Š   â”Š211â”Š    );\n+â”Š   â”Š212â”Š\n+â”Š   â”Š213â”Š    await wait(() =>\n+â”Š   â”Š214â”Š      expect(passwordConfirmInput.value).toEqual('password')\n+â”Š   â”Š215â”Š    );\n+â”Š   â”Š216â”Š\n+â”Š   â”Š217â”Š    act(() => {\n+â”Š   â”Š218â”Š      fireEvent.click(signUpButton);\n+â”Š   â”Š219â”Š    });\n+â”Š   â”Š220â”Š\n+â”Š   â”Š221â”Š    await wait(() =>\n+â”Š   â”Š222â”Š      expect(history.location.pathname).toEqual('/sign-in')\n+â”Š   â”Š223â”Š    );\n+â”Š   â”Š224â”Š  });\n+â”Š   â”Š225â”Š});ðŸš«â†µ\n```\n\n##### Added src&#x2F;components&#x2F;AuthScreen&#x2F;SignUpForm.tsx\n```diff\n@@ -0,0 +1,124 @@\n+â”Š   â”Š  1â”Šimport React from 'react';\n+â”Š   â”Š  2â”Šimport { useCallback, useState } from 'react';\n+â”Š   â”Š  3â”Šimport { useSignUp } from '../../services/auth.service';\n+â”Š   â”Š  4â”Šimport {\n+â”Š   â”Š  5â”Š  SignForm,\n+â”Š   â”Š  6â”Š  ActualForm,\n+â”Š   â”Š  7â”Š  Legend,\n+â”Š   â”Š  8â”Š  Section,\n+â”Š   â”Š  9â”Š  TextField,\n+â”Š   â”Š 10â”Š  Button,\n+â”Š   â”Š 11â”Š  ErrorMessage,\n+â”Š   â”Š 12â”Š} from './form-components';\n+â”Š   â”Š 13â”Šimport { RouteComponentProps } from 'react-router-dom';\n+â”Š   â”Š 14â”Š\n+â”Š   â”Š 15â”Šconst SignUpForm: React.FC<RouteComponentProps<any>> = ({ history }) => {\n+â”Š   â”Š 16â”Š  const [name, setName] = useState('');\n+â”Š   â”Š 17â”Š  const [username, setUsername] = useState('');\n+â”Š   â”Š 18â”Š  const [password, setPassword] = useState('');\n+â”Š   â”Š 19â”Š  const [passwordConfirm, setPasswordConfirm] = useState('');\n+â”Š   â”Š 20â”Š  const [error, setError] = useState('');\n+â”Š   â”Š 21â”Š  const [signUp] = useSignUp()\n+â”Š   â”Š 22â”Š\n+â”Š   â”Š 23â”Š  const updateName = useCallback(({ target }) => {\n+â”Š   â”Š 24â”Š    setError('');\n+â”Š   â”Š 25â”Š    setName(target.value);\n+â”Š   â”Š 26â”Š  }, []);\n+â”Š   â”Š 27â”Š\n+â”Š   â”Š 28â”Š  const updateUsername = useCallback(({ target }) => {\n+â”Š   â”Š 29â”Š    setError('');\n+â”Š   â”Š 30â”Š    setUsername(target.value);\n+â”Š   â”Š 31â”Š  }, []);\n+â”Š   â”Š 32â”Š\n+â”Š   â”Š 33â”Š  const updatePassword = useCallback(({ target }) => {\n+â”Š   â”Š 34â”Š    setError('');\n+â”Š   â”Š 35â”Š    setPassword(target.value);\n+â”Š   â”Š 36â”Š  }, []);\n+â”Š   â”Š 37â”Š\n+â”Š   â”Š 38â”Š  const updatePasswordConfirm = useCallback(({ target }) => {\n+â”Š   â”Š 39â”Š    setError('');\n+â”Š   â”Š 40â”Š    setPasswordConfirm(target.value);\n+â”Š   â”Š 41â”Š  }, []);\n+â”Š   â”Š 42â”Š\n+â”Š   â”Š 43â”Š  const maySignUp = useCallback(() => {\n+â”Š   â”Š 44â”Š    return !!(name && username && password && password === passwordConfirm);\n+â”Š   â”Š 45â”Š  }, [name, username, password, passwordConfirm]);\n+â”Š   â”Š 46â”Š\n+â”Š   â”Š 47â”Š  const handleSignUp = useCallback(() => {\n+â”Š   â”Š 48â”Š    signUp({ variables: { username, password, passwordConfirm, name } })\n+â”Š   â”Š 49â”Š      .then(() => {\n+â”Š   â”Š 50â”Š        history.replace('/sign-in');\n+â”Š   â”Š 51â”Š      })\n+â”Š   â”Š 52â”Š      .catch(error => {\n+â”Š   â”Š 53â”Š        setError(error.message || error);\n+â”Š   â”Š 54â”Š      });\n+â”Š   â”Š 55â”Š  }, [name, username, password, passwordConfirm, history, signUp]);\n+â”Š   â”Š 56â”Š\n+â”Š   â”Š 57â”Š  return (\n+â”Š   â”Š 58â”Š    <SignForm>\n+â”Š   â”Š 59â”Š      <ActualForm>\n+â”Š   â”Š 60â”Š        <Legend>Sign up</Legend>\n+â”Š   â”Š 61â”Š        <Section\n+â”Š   â”Š 62â”Š          style={{\n+â”Š   â”Š 63â”Š            float: 'left',\n+â”Š   â”Š 64â”Š            width: 'calc(50% - 10px)',\n+â”Š   â”Š 65â”Š            paddingRight: '10px',\n+â”Š   â”Š 66â”Š          }}>\n+â”Š   â”Š 67â”Š          <TextField\n+â”Š   â”Š 68â”Š            data-testid=\"name-input\"\n+â”Š   â”Š 69â”Š            label=\"Name\"\n+â”Š   â”Š 70â”Š            value={name}\n+â”Š   â”Š 71â”Š            onChange={updateName}\n+â”Š   â”Š 72â”Š            autoComplete=\"off\"\n+â”Š   â”Š 73â”Š            margin=\"normal\"\n+â”Š   â”Š 74â”Š          />\n+â”Š   â”Š 75â”Š          <TextField\n+â”Š   â”Š 76â”Š            data-testid=\"username-input\"\n+â”Š   â”Š 77â”Š            label=\"Username\"\n+â”Š   â”Š 78â”Š            value={username}\n+â”Š   â”Š 79â”Š            onChange={updateUsername}\n+â”Š   â”Š 80â”Š            autoComplete=\"off\"\n+â”Š   â”Š 81â”Š            margin=\"normal\"\n+â”Š   â”Š 82â”Š          />\n+â”Š   â”Š 83â”Š        </Section>\n+â”Š   â”Š 84â”Š        <Section\n+â”Š   â”Š 85â”Š          style={{\n+â”Š   â”Š 86â”Š            float: 'right',\n+â”Š   â”Š 87â”Š            width: 'calc(50% - 10px)',\n+â”Š   â”Š 88â”Š            paddingLeft: '10px',\n+â”Š   â”Š 89â”Š          }}>\n+â”Š   â”Š 90â”Š          <TextField\n+â”Š   â”Š 91â”Š            data-testid=\"password-input\"\n+â”Š   â”Š 92â”Š            label=\"Password\"\n+â”Š   â”Š 93â”Š            type=\"password\"\n+â”Š   â”Š 94â”Š            value={password}\n+â”Š   â”Š 95â”Š            onChange={updatePassword}\n+â”Š   â”Š 96â”Š            autoComplete=\"off\"\n+â”Š   â”Š 97â”Š            margin=\"normal\"\n+â”Š   â”Š 98â”Š          />\n+â”Š   â”Š 99â”Š          <TextField\n+â”Š   â”Š100â”Š            data-testid=\"password-confirm-input\"\n+â”Š   â”Š101â”Š            label=\"Confirm password\"\n+â”Š   â”Š102â”Š            type=\"password\"\n+â”Š   â”Š103â”Š            value={passwordConfirm}\n+â”Š   â”Š104â”Š            onChange={updatePasswordConfirm}\n+â”Š   â”Š105â”Š            autoComplete=\"off\"\n+â”Š   â”Š106â”Š            margin=\"normal\"\n+â”Š   â”Š107â”Š          />\n+â”Š   â”Š108â”Š        </Section>\n+â”Š   â”Š109â”Š        <Button\n+â”Š   â”Š110â”Š          data-testid=\"sign-up-button\"\n+â”Š   â”Š111â”Š          type=\"button\"\n+â”Š   â”Š112â”Š          color=\"secondary\"\n+â”Š   â”Š113â”Š          variant=\"contained\"\n+â”Š   â”Š114â”Š          disabled={!maySignUp()}\n+â”Š   â”Š115â”Š          onClick={handleSignUp}>\n+â”Š   â”Š116â”Š          Sign up\n+â”Š   â”Š117â”Š        </Button>\n+â”Š   â”Š118â”Š        <ErrorMessage data-testid=\"error-message\">{error}</ErrorMessage>\n+â”Š   â”Š119â”Š      </ActualForm>\n+â”Š   â”Š120â”Š    </SignForm>\n+â”Š   â”Š121â”Š  );\n+â”Š   â”Š122â”Š};\n+â”Š   â”Š123â”Š\n+â”Š   â”Š124â”Šexport default SignUpForm;\n```\n\n##### Added src&#x2F;components&#x2F;AuthScreen&#x2F;form-components.ts\n```diff\n@@ -0,0 +1,75 @@\n+â”Š  â”Š 1â”Šimport MaterialButton from '@material-ui/core/Button';\n+â”Š  â”Š 2â”Šimport MaterialTextField from '@material-ui/core/TextField';\n+â”Š  â”Š 3â”Šimport styled from 'styled-components';\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šexport const SignForm = styled.div`\n+â”Š  â”Š 6â”Š  height: calc(100% - 265px);\n+â”Š  â”Š 7â”Š`;\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Šexport const ActualForm = styled.form`\n+â”Š  â”Š10â”Š  padding: 20px;\n+â”Š  â”Š11â”Š`;\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Šexport const Section = styled.div`\n+â”Š  â”Š14â”Š  padding-bottom: 35px;\n+â”Š  â”Š15â”Š`;\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Šexport const Legend = styled.legend`\n+â”Š  â”Š18â”Š  font-weight: bold;\n+â”Š  â”Š19â”Š  color: white;\n+â”Š  â”Š20â”Š`;\n+â”Š  â”Š21â”Š\n+â”Š  â”Š22â”Šexport const Label = styled.label`\n+â”Š  â”Š23â”Š  color: white !important;\n+â”Š  â”Š24â”Š`;\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Šexport const Input = styled.input`\n+â”Š  â”Š27â”Š  color: white;\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š  &::placeholder {\n+â”Š  â”Š30â”Š    color: var(--primary-bg);\n+â”Š  â”Š31â”Š  }\n+â”Š  â”Š32â”Š`;\n+â”Š  â”Š33â”Š\n+â”Š  â”Š34â”Šexport const TextField = styled(MaterialTextField)`\n+â”Š  â”Š35â”Š  width: 100%;\n+â”Š  â”Š36â”Š  position: relative;\n+â”Š  â”Š37â”Š\n+â”Š  â”Š38â”Š  > div::before {\n+â”Š  â”Š39â”Š    border-color: white !important;\n+â”Š  â”Š40â”Š  }\n+â”Š  â”Š41â”Š\n+â”Š  â”Š42â”Š  input {\n+â”Š  â”Š43â”Š    color: white !important;\n+â”Š  â”Š44â”Š\n+â”Š  â”Š45â”Š    &::placeholder {\n+â”Š  â”Š46â”Š      color: var(--primary-bg) !important;\n+â”Š  â”Š47â”Š    }\n+â”Š  â”Š48â”Š  }\n+â”Š  â”Š49â”Š\n+â”Š  â”Š50â”Š  label {\n+â”Š  â”Š51â”Š    color: white !important;\n+â”Š  â”Š52â”Š  }\n+â”Š  â”Š53â”Š`;\n+â”Š  â”Š54â”Š\n+â”Š  â”Š55â”Šexport const Button = styled(MaterialButton)`\n+â”Š  â”Š56â”Š  width: 100px;\n+â”Š  â”Š57â”Š  display: block !important;\n+â”Š  â”Š58â”Š  margin: auto !important;\n+â”Š  â”Š59â”Š  background-color: var(--secondary-bg) !important;\n+â”Š  â”Š60â”Š\n+â”Š  â”Š61â”Š  &[disabled] {\n+â”Š  â”Š62â”Š    color: #38a81c;\n+â”Š  â”Š63â”Š  }\n+â”Š  â”Š64â”Š\n+â”Š  â”Š65â”Š  &:not([disabled]) {\n+â”Š  â”Š66â”Š    color: white;\n+â”Š  â”Š67â”Š  }\n+â”Š  â”Š68â”Š`;\n+â”Š  â”Š69â”Š\n+â”Š  â”Š70â”Šexport const ErrorMessage = styled.div`\n+â”Š  â”Š71â”Š  position: fixed;\n+â”Š  â”Š72â”Š  color: red;\n+â”Š  â”Š73â”Š  font-size: 15px;\n+â”Š  â”Š74â”Š  margin-top: 20px;\n+â”Š  â”Š75â”Š`;\n```\n\n##### Changed src&#x2F;components&#x2F;AuthScreen&#x2F;index.tsx\n```diff\n@@ -1,13 +1,13 @@\n-â”Š 1â”Š  â”Šimport MaterialButton from '@material-ui/core/Button';\n-â”Š 2â”Š  â”Šimport MaterialTextField from '@material-ui/core/TextField';\n â”Š 3â”Š 1â”Šimport React from 'react';\n-â”Š 4â”Š  â”Šimport { useCallback, useState } from 'react';\n+â”Š  â”Š 2â”Šimport { useMemo } from 'react';\n+â”Š  â”Š 3â”Šimport { Route } from 'react-router-dom';\n â”Š 5â”Š 4â”Šimport styled from 'styled-components';\n-â”Š 6â”Š  â”Šimport { useSignIn } from '../../services/auth.service';\n+â”Š  â”Š 5â”Šimport AnimatedSwitch from '../AnimatedSwitch';\n+â”Š  â”Š 6â”Šimport SignInForm from './SignInForm';\n+â”Š  â”Š 7â”Šimport SignUpForm from './SignUpForm';\n â”Š 7â”Š 8â”Šimport { RouteComponentProps } from 'react-router-dom';\n â”Š 8â”Š 9â”Š\n â”Š 9â”Š10â”Šconst Container = styled.div`\n-â”Š10â”Š  â”Š  height: 100%;\n â”Š11â”Š11â”Š  background: radial-gradient(rgb(34, 65, 67), rgb(17, 48, 50)),\n â”Š12â”Š12â”Š    url(/assets/chat-background.jpg) no-repeat;\n â”Š13â”Š13â”Š  background-size: cover;\n```\n```diff\n@@ -40,149 +40,51 @@\n â”Š 40â”Š 40â”Š  bottom: 10px;\n â”Š 41â”Š 41â”Š  left: 10px;\n â”Š 42â”Š 42â”Š\n-â”Š 43â”Š   â”Š  a {\n+â”Š   â”Š 43â”Š  label {\n â”Š 44â”Š 44â”Š    color: var(--secondary-bg);\n â”Š 45â”Š 45â”Š  }\n â”Š 46â”Š 46â”Š`;\n â”Š 47â”Š 47â”Š\n-â”Š 48â”Š   â”Šconst SignInForm = styled.div`\n-â”Š 49â”Š   â”Š  height: calc(100% - 265px);\n-â”Š 50â”Š   â”Š`;\n-â”Š 51â”Š   â”Š\n-â”Š 52â”Š   â”Šconst ActualForm = styled.form`\n-â”Š 53â”Š   â”Š  padding: 20px;\n-â”Š 54â”Š   â”Š`;\n-â”Š 55â”Š   â”Š\n-â”Š 56â”Š   â”Šconst Section = styled.div`\n-â”Š 57â”Š   â”Š  width: 100%;\n-â”Š 58â”Š   â”Š  padding-bottom: 35px;\n-â”Š 59â”Š   â”Š`;\n-â”Š 60â”Š   â”Š\n-â”Š 61â”Š   â”Šconst Legend = styled.legend`\n-â”Š 62â”Š   â”Š  font-weight: bold;\n-â”Š 63â”Š   â”Š  color: white;\n-â”Š 64â”Š   â”Š`;\n-â”Š 65â”Š   â”Š\n-â”Š 66â”Š   â”Š// eslint-disable-next-line\n-â”Š 67â”Š   â”Šconst Label = styled.label`\n-â”Š 68â”Š   â”Š  color: white !important;\n-â”Š 69â”Š   â”Š`;\n-â”Š 70â”Š   â”Š\n-â”Š 71â”Š   â”Š// eslint-disable-next-line\n-â”Š 72â”Š   â”Šconst Input = styled.input`\n-â”Š 73â”Š   â”Š  color: white;\n-â”Š 74â”Š   â”Š\n-â”Š 75â”Š   â”Š  &::placeholder {\n-â”Š 76â”Š   â”Š    color: var(--primary-bg);\n-â”Š 77â”Š   â”Š  }\n-â”Š 78â”Š   â”Š`;\n-â”Š 79â”Š   â”Š\n-â”Š 80â”Š   â”Šconst TextField = styled(MaterialTextField)`\n-â”Š 81â”Š   â”Š  width: 100%;\n-â”Š 82â”Š   â”Š  position: relative;\n-â”Š 83â”Š   â”Š\n-â”Š 84â”Š   â”Š  > div::before {\n-â”Š 85â”Š   â”Š    border-color: white !important;\n-â”Š 86â”Š   â”Š  }\n-â”Š 87â”Š   â”Š\n-â”Š 88â”Š   â”Š  input {\n-â”Š 89â”Š   â”Š    color: white !important;\n-â”Š 90â”Š   â”Š\n-â”Š 91â”Š   â”Š    &::placeholder {\n-â”Š 92â”Š   â”Š      color: var(--primary-bg) !important;\n+â”Š   â”Š 48â”Šconst AuthScreen: React.FC<RouteComponentProps<any>> = ({\n+â”Š   â”Š 49â”Š  history,\n+â”Š   â”Š 50â”Š  location,\n+â”Š   â”Š 51â”Š}) => {\n+â”Š   â”Š 52â”Š  const alternative = useMemo(() => {\n+â”Š   â”Š 53â”Š    if (location.pathname === '/sign-in') {\n+â”Š   â”Š 54â”Š      const handleSignUp = () => {\n+â”Š   â”Š 55â”Š        history.replace('/sign-up');\n+â”Š   â”Š 56â”Š      };\n+â”Š   â”Š 57â”Š\n+â”Š   â”Š 58â”Š      return (\n+â”Š   â”Š 59â”Š        <Alternative>\n+â”Š   â”Š 60â”Š          Don't have an account yet?{' '}\n+â”Š   â”Š 61â”Š          <label onClick={handleSignUp}>Sign up!</label>\n+â”Š   â”Š 62â”Š        </Alternative>\n+â”Š   â”Š 63â”Š      );\n+â”Š   â”Š 64â”Š    } else {\n+â”Š   â”Š 65â”Š      const handleSignIn = () => {\n+â”Š   â”Š 66â”Š        history.replace('/sign-in');\n+â”Š   â”Š 67â”Š      };\n+â”Š   â”Š 68â”Š\n+â”Š   â”Š 69â”Š      return (\n+â”Š   â”Š 70â”Š        <Alternative>\n+â”Š   â”Š 71â”Š          Already have an accout? <label onClick={handleSignIn}>Sign in!</label>\n+â”Š   â”Š 72â”Š        </Alternative>\n+â”Š   â”Š 73â”Š      );\n â”Š 93â”Š 74â”Š    }\n-â”Š 94â”Š   â”Š  }\n-â”Š 95â”Š   â”Š\n-â”Š 96â”Š   â”Š  label {\n-â”Š 97â”Š   â”Š    color: white !important;\n-â”Š 98â”Š   â”Š  }\n-â”Š 99â”Š   â”Š`;\n-â”Š100â”Š   â”Š\n-â”Š101â”Š   â”Šconst Button = styled(MaterialButton)`\n-â”Š102â”Š   â”Š  width: 100px;\n-â”Š103â”Š   â”Š  display: block !important;\n-â”Š104â”Š   â”Š  margin: auto !important;\n-â”Š105â”Š   â”Š  background-color: var(--secondary-bg) !important;\n-â”Š106â”Š   â”Š\n-â”Š107â”Š   â”Š  &[disabled] {\n-â”Š108â”Š   â”Š    color: #38a81c;\n-â”Š109â”Š   â”Š  }\n-â”Š110â”Š   â”Š\n-â”Š111â”Š   â”Š  &:not([disabled]) {\n-â”Š112â”Š   â”Š    color: white;\n-â”Š113â”Š   â”Š  }\n-â”Š114â”Š   â”Š`;\n-â”Š115â”Š   â”Š\n-â”Š116â”Š   â”Šconst AuthScreen: React.FC<RouteComponentProps<any>> = ({ history }) => {\n-â”Š117â”Š   â”Š  const [username, setUsername] = useState('');\n-â”Š118â”Š   â”Š  const [password, setPassword] = useState('');\n-â”Š119â”Š   â”Š  // eslint-disable-next-line\n-â”Š120â”Š   â”Š  const [error, setError] = useState('');\n-â”Š121â”Š   â”Š  const [signIn] = useSignIn();\n-â”Š122â”Š   â”Š\n-â”Š123â”Š   â”Š  const onUsernameChange = useCallback(({ target }) => {\n-â”Š124â”Š   â”Š    setError('');\n-â”Š125â”Š   â”Š    setUsername(target.value);\n-â”Š126â”Š   â”Š  }, []);\n-â”Š127â”Š   â”Š\n-â”Š128â”Š   â”Š  const onPasswordChange = useCallback(({ target }) => {\n-â”Š129â”Š   â”Š    setError('');\n-â”Š130â”Š   â”Š    setPassword(target.value);\n-â”Š131â”Š   â”Š  }, []);\n-â”Š132â”Š   â”Š\n-â”Š133â”Š   â”Š  const maySignIn = useCallback(() => {\n-â”Š134â”Š   â”Š    return !!(username && password);\n-â”Š135â”Š   â”Š  }, [username, password]);\n-â”Š136â”Š   â”Š\n-â”Š137â”Š   â”Š  const handleSignIn = useCallback(() => {\n-â”Š138â”Š   â”Š    signIn({ variables: { username, password } })\n-â”Š139â”Š   â”Š      .then(() => {\n-â”Š140â”Š   â”Š        history.push('/chats');\n-â”Š141â”Š   â”Š      })\n-â”Š142â”Š   â”Š      .catch(error => {\n-â”Š143â”Š   â”Š        setError(error.message || error);\n-â”Š144â”Š   â”Š      });\n-â”Š145â”Š   â”Š  }, [username, password, history, signIn]);\n+â”Š   â”Š 75â”Š  }, [location.pathname, history]);\n â”Š146â”Š 76â”Š\n â”Š147â”Š 77â”Š  return (\n-â”Š148â”Š   â”Š    <Container>\n-â”Š149â”Š   â”Š      <Intro>\n+â”Š   â”Š 78â”Š    <Container className=\"AuthScreen Screen\">\n+â”Š   â”Š 79â”Š      <Intro className=\"AuthScreen-intro\">\n â”Š150â”Š 80â”Š        <Icon src=\"assets/whatsapp-icon.png\" className=\"AuthScreen-icon\" />\n â”Š151â”Š 81â”Š        <Title className=\"AuthScreen-title\">WhatsApp</Title>\n â”Š152â”Š 82â”Š      </Intro>\n-â”Š153â”Š   â”Š      <SignInForm>\n-â”Š154â”Š   â”Š        <ActualForm>\n-â”Š155â”Š   â”Š          <Legend>Sign in</Legend>\n-â”Š156â”Š   â”Š          <Section>\n-â”Š157â”Š   â”Š            <TextField\n-â”Š158â”Š   â”Š              className=\"AuthScreen-text-field\"\n-â”Š159â”Š   â”Š              label=\"Username\"\n-â”Š160â”Š   â”Š              value={username}\n-â”Š161â”Š   â”Š              onChange={onUsernameChange}\n-â”Š162â”Š   â”Š              margin=\"normal\"\n-â”Š163â”Š   â”Š              placeholder=\"Enter your username\"\n-â”Š164â”Š   â”Š            />\n-â”Š165â”Š   â”Š            <TextField\n-â”Š166â”Š   â”Š              className=\"AuthScreen-text-field\"\n-â”Š167â”Š   â”Š              label=\"Password\"\n-â”Š168â”Š   â”Š              type=\"password\"\n-â”Š169â”Š   â”Š              value={password}\n-â”Š170â”Š   â”Š              onChange={onPasswordChange}\n-â”Š171â”Š   â”Š              margin=\"normal\"\n-â”Š172â”Š   â”Š              placeholder=\"Enter your password\"\n-â”Š173â”Š   â”Š            />\n-â”Š174â”Š   â”Š          </Section>\n-â”Š175â”Š   â”Š          <Button\n-â”Š176â”Š   â”Š            data-testid=\"sign-in-button\"\n-â”Š177â”Š   â”Š            type=\"button\"\n-â”Š178â”Š   â”Š            color=\"secondary\"\n-â”Š179â”Š   â”Š            variant=\"contained\"\n-â”Š180â”Š   â”Š            disabled={!maySignIn()}\n-â”Š181â”Š   â”Š            onClick={handleSignIn}>\n-â”Š182â”Š   â”Š            Sign in\n-â”Š183â”Š   â”Š          </Button>\n-â”Š184â”Š   â”Š        </ActualForm>\n-â”Š185â”Š   â”Š      </SignInForm>\n+â”Š   â”Š 83â”Š      <AnimatedSwitch>\n+â”Š   â”Š 84â”Š        <Route exact path=\"/sign-in\" component={SignInForm} />\n+â”Š   â”Š 85â”Š        <Route exact path=\"/sign-up\" component={SignUpForm} />\n+â”Š   â”Š 86â”Š      </AnimatedSwitch>\n+â”Š   â”Š 87â”Š      {alternative}\n â”Š186â”Š 88â”Š    </Container>\n â”Š187â”Š 89â”Š  );\n â”Š188â”Š 90â”Š};\n```\n\n[}]: #\n\n> Note how we used the `/sign-(in|up)` pattern to define the `signUp` mutation. This is because the request will be further redirected in the `AuthScreen`.\n\nThe authentication flow is complete! To test it out, you can create a new user, log in with it and start chatting with other users."
          },
          {
            "manualTitle": "Step 14: Migrating to PostgreSQL",
            "stepRevision": "691dfc74a02ff712d5485160c071c50041bb3f16",
            "manualView": "**Which Relational Database? And Why?**\n\nWeâ€™ve used to have an in-memory database so far that keeps our entities on memory inside business logic so far. But in a real application we will need a real database system that keeps our data which is seperated from our business logic. In this part we will design our database according to the relational database principles with the benefits of SQL.\n\nWe prefer to use PostgreSQL from now on; because PostgreSQL is a Relational Database implementation that has tables, constraints, triggers, roles, stored procedures and views together with foreign tables from external data sources and many features from NoSQL.\n\n**Database Design**\n\nWhile we are defining our entity types and schema inside our array-based in-memory database, we have already designed the basic parts of them. In this part, we will design our relational database with base and relation tables regarding to them.\n\nInitially we can decide the base fields without relations;\n* User;\n    * `id`\n    * `name`\n    * `username`\n    * `password`\n    * `picture`\n* Message;\n    * `id`\n    * `content`\n    * `created_at`\n* Chat;\n    * `id`\n\nBefore creating tables, we should design our database structure according to [Database Normalization principles](https://www.essentialsql.com/get-ready-to-learn-sql-database-normalization-explained-in-simple-english/) to prevent duplicated data and modification anomalies.\n\nInitially we will have 3 base tables in our database; `user`, `chat`, `message`; and there are some relations between those 3 tables. These relations will be defined in other relation tables together with different primary key and foreign key definitions.\n\nThere are four types of relations in relational databases;\n\n* One to one\n    * This relationship means A entity type can have a relationship with only one instance of B entity type while B entity type can have a relationship with only one instance of A entity type. For example, one user can have only one profile while a profile belongs to only one user.\n* Many to one\n    * This relationship means A entity type can have a relationship with multiple instances of B entity type while B entity type can have a relationship with only one instance of A entity type. For example, a chat can have multiple messages while a message belongs to only one chat. But `many to one` as a word means multiple photos belong to the same chat.\n* One to many\n    * This relationship has the same logic with Many to one. However, `One to many` as a word means a chat can have multiple messages while those messages cannot have multiple chats but only one.\n* Many to many\n    * This relationship means A entity type can have a relationship with multiple instances of B entity type while B entity type can have a relationship with multiple instances of A entity type dependently or independently. For example; a chat can have multiple users, and a user can have multiple chats.\n\nYou can read more about those relations in [here](https://www.techrepublic.com/article/relational-databases-defining-relationships-between-database-tables/).\n\nIn existing entity declarations and schema, we have 6 relationships;\n\n* Message has a One To Many relationship under the name of `chat` inside our schema; so one message can have one chat while one chat can have multiple messages.\n\n```gql\ntype Message { chat: Chat }\n```\n\n* Message has another One To Many relationship under the name of `sender`` inside our schema; so one message can have one sender while one sender user can have multiple messages.\n\n```gql\ntype Message { sender: User }\n```\n\n* Message has one more One To Many relationship under the name of `recipient`` inside our schema; so one message can have one recipient while one recipient user can have multiple messages.\n\n```gql\ntype Message { recipient: User }\n```\n\n* Chat has a One To Many relationship under the name of `messages`, because one chat can have multiple messages while one message can have only one chat. Notice that this relationship is the reversed version of the first relationship in Message.\n\n```gql\n`type Chat { messages: [Message] }\n```\n\n* Chat has another Many To Many relationship under the name of `participants`, because one chat can have multiple participants while a participant can have multiple chats as well.\n\n```gql\ntype Chat { participants: [User] }\n```\n\n* User has a Many To Many relationship under the name of `chats`, because one user can have multiple chats, while it has the same situation for chats.\n\n```gql\ntype User { chats: [Chat] }\n```\n\n\nSo we should decide the dependencies between each other to add columns and tables to our database.\n\n* User is independent in all relationships, so we will keep its columns as it is\n* Message is dependent to User in two cases so we can define this relationship as two different new foreign keys pointing to Userâ€™s id under the columns `sender_user_id`. But we donâ€™t need `recipient_user_id` because `recipient` can be found under Chatâ€™s participants.\n* Chat is also independent because it will be better to keep those relations inside Message.\n* Message is dependent to Chat so we can define this relationship as a new foreign key that points to Chatâ€™s id under the column named `chat_id`.\n* We need to have another table that defines the relationship between multiple chats and users.\n\n> We donâ€™t need to duplicate relations in each entities, because SQL has the power to reverse each relations even if they are defined only in one entity. This is one of the rule of Database Normalization.\n\nFinally we can decide on our tables;\n\n* `chats` table;\n    * `id` ->\n        * `PRIMARY KEY` - `SERIAL`\n        * `SERIAL` will automatically increase the number of the new chat row. Check SQL docs about primary key and auto increment\n* `users` table;\n    * `id` ->\n        * `PRIMARY KEY` - `SERIAL`\n    * `name` ->\n        * `VARCHAR`\n    * `username` ->\n        * `VARCHAR` - `UNIQUE`\n        * `UNIQUE` means this value can exist in this table only once. We use this feature because `username` must be unique in users for each user\n    * `password` ->\n        * `VARCHAR`\n    * `picture` ->\n        * `VARCHAR`\n* `chats_users` table;\n    * `chat_id` ->\n        * `FOREIGN KEY` points to `chat.id` ->\n            * `ON DELETE` -> `CASCADE`.\n            * This means that if chat that has this id is deleted, this row will be deleted automatically as well.\n    * `user_id` ->\n        * FOREIGN KEY points to `user.id` ->\n            * `ON DELETE` -> `CASCADE`.\n* `messages` table;\n    * `id` ->\n        * `PRIMARY KEY` - `SERIAL`\n    * `content` ->\n        * `VARCHAR`\n    * `created_at` ->\n        * `TIMESTAMP` ->\n            * `DEFAULT_VALUE = now()`\n            * This means it will automatically set this to the current timestamp in the new row.\n    * `chat_id` ->\n        * `FOREIGN KEY` points to `chat.id` ->\n            * `ON DELETE` -> `CASCADE`\n            * This means that if chat that has this id is deleted, this row will be deleted automatically as well. So the message will be deleted immediately after the chat is deleted.\n    * `sender_user_id` ->\n        * `FOREIGN_KEY` points to `user.id`\n            * `ON DELETE` -> `CASCADE`\n            * This means that if user that has this id is deleted, this message will be deleted.\n\n> Notice that having a good dependency gives us an opportunity to benefit from `ON_DELETE` feature of SQL. Otherwise, we need to delete each dependent row manually by hand.\n\n**Installing PostgreSQL on your machine**\n\n***Windows / Mac OS X***\n\nYou can download one-click installer for Windows and Mac OS X. During the installation, you must define a password and keep it somewhere safe.\n\n[https://www.enterprisedb.com/downloads/postgres-postgresql-downloads](Download Installer)\n\n***Ubuntu / Debian***\n\nIf you have Debian package manager on your machine, you can install PostgreSQL in a single line in your Bash terminal;\n\n    $ sudo apt-get install postgresql postgresql-contrib\n\n***Other environments***\n\nCheck [https://www.postgresql.org/download/](PostgreSQL website) for installation instructions on other environments.\n\nFollowing above link, after initializing the database using:\n```\npostgresql-setup initdb\n```\nNavigate to /var/lib/pgsql/11/data/pg_hba.conf and edit IPv4 local connections to:\n```\n# IPv4 local connections:\nhost    all             all             127.0.0.1/32            trust\n```\nBy doing so you are setting PostgreSQL permissions so your WhatsApp server can access the database.\n\n**Creating Database, Database User and Tables**\n\n> Make sure you have installed PostgreSQL on your environment first!\n\nWe will use Bash terminal in order to access PostgreSQL using superuser;\n\n    $ su - postgres\n\nYou don't need to execute the previous command if you're using Windows. But you have to open the terminal with Administrator privileges.\n\n    $ psql template1\n\nThen we will see the following PostgreSQL console;\n\nbash```\nWelcome to psql 7.4.16, the PostgreSQL interactive terminal.\n\nType:  \\\\copyright for distribution terms\n       \\\\h for help with SQL commands\n       \\\\? for help on internal slash commands\n       \\\\g or terminate with semicolon to execute query\n       \\\\q to quit\n\ntemplate1\n```\n\nSo we can do the following SQL operations in order to create our new user, database and tables;\n\n* Create user for our database\n\n```sql\n    CREATE DATABASE whatsapp;\n```\n\n* Create database\n\n```sql\n    CREATE USER testuser WITH PASSWORD 'testpassword';\n```\n\n* Give permissions to that user\n\n```sql\n    GRANT ALL PRIVILEGES ON DATABASE whatsapp to testuser;\n```\n\n* Connect database\n\n```sql\n    \\connect whatsapp\n```\n\n* Create `chats` table\n\n```sql\n    CREATE TABLE chats(\n        id SERIAL PRIMARY KEY\n    );\n```\n\n* Create `users` table\n\n```sql\n    CREATE TABLE users(\n        id SERIAL PRIMARY KEY,\n        username VARCHAR (50) UNIQUE NOT NULL,\n        name VARCHAR (50) NOT NULL,\n        password VARCHAR (255) NOT NULL,\n        picture VARCHAR (255) NOT NULL\n    );\n```\n\n* Create `chats_users` table\n\n```sql\n    CREATE TABLE chats_users(\n        chat_id INTEGER NOT NULL REFERENCES chats(id) ON DELETE CASCADE,\n        user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE\n    );\n```\n\n* Create messages table;\n\n```sql\n    CREATE TABLE messages(\n        id SERIAL PRIMARY KEY,\n        content VARCHAR (355) NOT NULL,\n        created_at TIMESTAMP NOT NULL DEFAULT NOW(),\n        chat_id INTEGER NOT NULL REFERENCES chats(id) ON DELETE CASCADE,\n        sender_user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE\n    );\n```\n\n* Give access for those tables\n\n```sql\n    GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO testuser;\n    GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO testuser;\n```\n\n**Installing PostgreSQL on our backend project**\n\nAs we are using PostgreSQL, we will use `node-postgres` as our database client in the backend.\n\nFirst install necessary npm packages using yarn;\n\n\t$ yarn add pg\n\nAnd we will also need TypeScript definitions for better development experience;\n\n\t$ yarn add @types/pg --dev\n\nWe will use `sql` template literals (which is way easier and safer than native API) with [this package](https://github.com/felixfbecker/node-sql-template-strings) which allows you to have SQL highlighting in VSCode with (this extension)[https://marketplace.visualstudio.com/items?itemName=forbeslindesay.vscode-sql-template-literal].\n\n\t$ yarn add sql-template-strings\n\n**Connecting to our database**\n\nWe will use connection pooling to prevent connection leaks and benefit from transactions in our complicated SQL queries. [You can read more about the benefits of connection pooling.](https://node-postgres.com/features/pooling)\n\nFirst we need to create a connection pool using our connection credentials;\n\n[{]: <helper> (diffStep 11.2 files=\"db\" module=\"server\")\n\n#### [__Server__ Step 11.2: Connecting to database](https://github.com/Urigo/WhatsApp-Clone-Server/commit/6d399e1472517b16e5c930387f541c6e17de14ad)\n\n##### Changed db.ts\n```diff\n@@ -1,3 +1,5 @@\n+â”Š â”Š1â”Šimport { Pool } from 'pg';\n+â”Š â”Š2â”Š\n â”Š1â”Š3â”Šexport type User = {\n â”Š2â”Š4â”Š  id: string;\n â”Š3â”Š5â”Š  name: string;\n```\n```diff\n@@ -20,6 +22,16 @@\n â”Š20â”Š22â”Š  participants: string[];\n â”Š21â”Š23â”Š};\n â”Š22â”Š24â”Š\n+â”Š  â”Š25â”Šexport const dbConfig = {\n+â”Š  â”Š26â”Š  host: 'localhost',\n+â”Š  â”Š27â”Š  port: process.env.DB_PORT ? parseInt(process.env.DB_PORT) : 5432,\n+â”Š  â”Š28â”Š  user: 'testuser',\n+â”Š  â”Š29â”Š  password: 'testpassword',\n+â”Š  â”Š30â”Š  database: 'whatsapp',\n+â”Š  â”Š31â”Š};\n+â”Š  â”Š32â”Š\n+â”Š  â”Š33â”Šexport let pool: Pool = new Pool(dbConfig);\n+â”Š  â”Š34â”Š\n â”Š23â”Š35â”Šexport const users: User[] = [];\n â”Š24â”Š36â”Šexport const messages: Message[] = [];\n â”Š25â”Š37â”Šexport const chats: Chat[] = [];\n```\n\n[}]: #\n\n**Add Database Client to GraphQL Context**\n\nAfter that, we will request a client from this pool on each network request in our GraphQL context. So we need to update our context interface and context builder function.\n\n[{]: <helper> (diffStep 11.3 files=\"context, index\" module=\"server\")\n\n#### [__Server__ Step 11.3: Add Database Client to GraphQL Context](https://github.com/Urigo/WhatsApp-Clone-Server/commit/0c0e85f208a87396eb83ec942b296b93dd079186)\n\n##### Changed context.ts\n```diff\n@@ -1,9 +1,11 @@\n â”Š 1â”Š 1â”Šimport { PubSub } from 'apollo-server-express';\n â”Š 2â”Š 2â”Šimport { User } from './db';\n â”Š 3â”Š 3â”Šimport { Response } from 'express';\n+â”Š  â”Š 4â”Šimport { PoolClient } from 'pg';\n â”Š 4â”Š 5â”Š\n â”Š 5â”Š 6â”Šexport type MyContext = {\n â”Š 6â”Š 7â”Š  pubsub: PubSub;\n â”Š 7â”Š 8â”Š  currentUser: User;\n â”Š 8â”Š 9â”Š  res: Response;\n+â”Š  â”Š10â”Š  db: PoolClient;\n â”Š 9â”Š11â”Š};\n```\n\n##### Changed index.ts\n```diff\n@@ -3,14 +3,16 @@\n â”Š 3â”Š 3â”Šimport http from 'http';\n â”Š 4â”Š 4â”Šimport jwt from 'jsonwebtoken';\n â”Š 5â”Š 5â”Šimport { app } from './app';\n-â”Š 6â”Š  â”Šimport { users } from './db';\n+â”Š  â”Š 6â”Šimport { pool } from './db';\n â”Š 7â”Š 7â”Šimport { origin, port, secret } from './env';\n â”Š 8â”Š 8â”Šimport schema from './schema';\n+â”Š  â”Š 9â”Šimport { MyContext } from './context';\n+â”Š  â”Š10â”Šimport sql from 'sql-template-strings';\n â”Š 9â”Š11â”Š\n â”Š10â”Š12â”Šconst pubsub = new PubSub();\n â”Š11â”Š13â”Šconst server = new ApolloServer({\n â”Š12â”Š14â”Š  schema,\n-â”Š13â”Š  â”Š  context: (session: any) => {\n+â”Š  â”Š15â”Š  context: async (session: any) => {\n â”Š14â”Š16â”Š    // Access the request object\n â”Š15â”Š17â”Š    let req = session.connection\n â”Š16â”Š18â”Š      ? session.connection.context.request\n```\n```diff\n@@ -24,12 +26,24 @@\n â”Š24â”Š26â”Š    let currentUser;\n â”Š25â”Š27â”Š    if (req.cookies.authToken) {\n â”Š26â”Š28â”Š      const username = jwt.verify(req.cookies.authToken, secret) as string;\n-â”Š27â”Š  â”Š      currentUser = username && users.find(u => u.username === username);\n+â”Š  â”Š29â”Š      if (username) {\n+â”Š  â”Š30â”Š        const { rows } = await pool.query(\n+â”Š  â”Š31â”Š          sql`SELECT * FROM users WHERE username = ${username}`\n+â”Š  â”Š32â”Š        );\n+â”Š  â”Š33â”Š        currentUser = rows[0];\n+â”Š  â”Š34â”Š      }\n+â”Š  â”Š35â”Š    }\n+â”Š  â”Š36â”Š\n+â”Š  â”Š37â”Š    let db;\n+â”Š  â”Š38â”Š\n+â”Š  â”Š39â”Š    if (!session.connection) {\n+â”Š  â”Š40â”Š      db = await pool.connect();\n â”Š28â”Š41â”Š    }\n â”Š29â”Š42â”Š\n â”Š30â”Š43â”Š    return {\n â”Š31â”Š44â”Š      currentUser,\n â”Š32â”Š45â”Š      pubsub,\n+â”Š  â”Š46â”Š      db,\n â”Š33â”Š47â”Š      res: session.res,\n â”Š34â”Š48â”Š    };\n â”Š35â”Š49â”Š  },\n```\n```diff\n@@ -41,6 +55,11 @@\n â”Š41â”Š55â”Š      };\n â”Š42â”Š56â”Š    },\n â”Š43â”Š57â”Š  },\n+â”Š  â”Š58â”Š  formatResponse: (res: any, { context }: { context: MyContext }) => {\n+â”Š  â”Š59â”Š    context.db.release();\n+â”Š  â”Š60â”Š\n+â”Š  â”Š61â”Š    return res;\n+â”Š  â”Š62â”Š  },\n â”Š44â”Š63â”Š});\n â”Š45â”Š64â”Š\n â”Š46â”Š65â”Šserver.applyMiddleware({\n```\n\n[}]: #\n\n> However we need to release that client to the pool after the network connection ends to prevent connection leaks. So, letâ€™s use `formatResponse` to do this operation.\n> We don't need connection pooling for subscriptions, because it can cause the connection open in all websocket connection. That's why, we don't request a new client from the pool if it is a subscription.\n\n**Update entity typings**\n\nWe should update our entity typings according to our new database tables and columns.\n\n[{]: <helper> (diffStep 11.4 files=\"db\" module=\"server\")\n\n#### [__Server__ Step 11.4: Update Entity Types](https://github.com/Urigo/WhatsApp-Clone-Server/commit/ba6396e7382af75837aa8052aa1aa1ae2c1d03bd)\n\n##### Changed db.ts\n```diff\n@@ -11,15 +11,13 @@\n â”Š11â”Š11â”Šexport type Message = {\n â”Š12â”Š12â”Š  id: string;\n â”Š13â”Š13â”Š  content: string;\n-â”Š14â”Š  â”Š  createdAt: Date;\n-â”Š15â”Š  â”Š  sender: string;\n-â”Š16â”Š  â”Š  recipient: string;\n+â”Š  â”Š14â”Š  created_at: Date;\n+â”Š  â”Š15â”Š  chat_id: string;\n+â”Š  â”Š16â”Š  sender_user_id: string;\n â”Š17â”Š17â”Š};\n â”Š18â”Š18â”Š\n â”Š19â”Š19â”Šexport type Chat = {\n â”Š20â”Š20â”Š  id: string;\n-â”Š21â”Š  â”Š  messages: string[];\n-â”Š22â”Š  â”Š  participants: string[];\n â”Š23â”Š21â”Š};\n â”Š24â”Š22â”Š\n â”Š25â”Š23â”Šexport const dbConfig = {\n```\n\n[}]: #\n\n**Add Sample Data**\n\nWe need to update the `resetDb` function to add a sample data to our new relational database instead of in-memory database. But we will call `resetDb` if it is asked by using the environmental variable.\n\n[{]: <helper> (diffStep 11.5 module=\"server\")\n\n#### [__Server__ Step 11.5: Add Sample Data](https://github.com/Urigo/WhatsApp-Clone-Server/commit/7e41146da05b248af5386d29987650daa2ffcc91)\n\n##### Changed db.ts\n```diff\n@@ -1,4 +1,6 @@\n â”Š1â”Š1â”Šimport { Pool } from 'pg';\n+â”Š â”Š2â”Šimport sql from 'sql-template-strings';\n+â”Š â”Š3â”Šimport { resetDb as envResetDb } from './env';\n â”Š2â”Š4â”Š\n â”Š3â”Š5â”Šexport type User = {\n â”Š4â”Š6â”Š  id: string;\n```\n```diff\n@@ -34,121 +36,181 @@\n â”Š 34â”Š 36â”Šexport const messages: Message[] = [];\n â”Š 35â”Š 37â”Šexport const chats: Chat[] = [];\n â”Š 36â”Š 38â”Š\n-â”Š 37â”Š   â”Šexport const resetDb = () => {\n-â”Š 38â”Š   â”Š  users.splice(\n-â”Š 39â”Š   â”Š    0,\n-â”Š 40â”Š   â”Š    Infinity,\n-â”Š 41â”Š   â”Š    ...[\n-â”Š 42â”Š   â”Š      {\n-â”Š 43â”Š   â”Š        id: '1',\n-â”Š 44â”Š   â”Š        name: 'Ray Edwards',\n-â”Š 45â”Š   â”Š        username: 'ray',\n-â”Š 46â”Š   â”Š        password:\n-â”Š 47â”Š   â”Š          '$2a$08$NO9tkFLCoSqX1c5wk3s7z.JfxaVMKA.m7zUDdDwEquo4rvzimQeJm', // 111\n-â”Š 48â”Š   â”Š        picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n-â”Š 49â”Š   â”Š      },\n-â”Š 50â”Š   â”Š      {\n-â”Š 51â”Š   â”Š        id: '2',\n-â”Š 52â”Š   â”Š        name: 'Ethan Gonzalez',\n-â”Š 53â”Š   â”Š        username: 'ethan',\n-â”Š 54â”Š   â”Š        password:\n-â”Š 55â”Š   â”Š          '$2a$08$xE4FuCi/ifxjL2S8CzKAmuKLwv18ktksSN.F3XYEnpmcKtpbpeZgO', // 222\n-â”Š 56â”Š   â”Š        picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n-â”Š 57â”Š   â”Š      },\n-â”Š 58â”Š   â”Š      {\n-â”Š 59â”Š   â”Š        id: '3',\n-â”Š 60â”Š   â”Š        name: 'Bryan Wallace',\n-â”Š 61â”Š   â”Š        username: 'bryan',\n-â”Š 62â”Š   â”Š        password:\n-â”Š 63â”Š   â”Š          '$2a$08$UHgH7J8G6z1mGQn2qx2kdeWv0jvgHItyAsL9hpEUI3KJmhVW5Q1d.', // 333\n-â”Š 64â”Š   â”Š        picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n-â”Š 65â”Š   â”Š      },\n-â”Š 66â”Š   â”Š      {\n-â”Š 67â”Š   â”Š        id: '4',\n-â”Š 68â”Š   â”Š        name: 'Avery Stewart',\n-â”Š 69â”Š   â”Š        username: 'avery',\n-â”Š 70â”Š   â”Š        password:\n-â”Š 71â”Š   â”Š          '$2a$08$wR1k5Q3T9FC7fUgB7Gdb9Os/GV7dGBBf4PLlWT7HERMFhmFDt47xi', // 444\n-â”Š 72â”Š   â”Š        picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n-â”Š 73â”Š   â”Š      },\n-â”Š 74â”Š   â”Š      {\n-â”Š 75â”Š   â”Š        id: '5',\n-â”Š 76â”Š   â”Š        name: 'Katie Peterson',\n-â”Š 77â”Š   â”Š        username: 'katie',\n-â”Š 78â”Š   â”Š        password:\n-â”Š 79â”Š   â”Š          '$2a$08$6.mbXqsDX82ZZ7q5d8Osb..JrGSsNp4R3IKj7mxgF6YGT0OmMw242', // 555\n-â”Š 80â”Š   â”Š        picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n-â”Š 81â”Š   â”Š      },\n-â”Š 82â”Š   â”Š    ]\n+â”Š   â”Š 39â”Šexport const resetDb = async () => {\n+â”Š   â”Š 40â”Š  await pool.query(sql`DELETE FROM users`);\n+â”Š   â”Š 41â”Š\n+â”Š   â”Š 42â”Š  const sampleUsers = [\n+â”Š   â”Š 43â”Š    {\n+â”Š   â”Š 44â”Š      id: '1',\n+â”Š   â”Š 45â”Š      name: 'Ray Edwards',\n+â”Š   â”Š 46â”Š      username: 'ray',\n+â”Š   â”Š 47â”Š      password: '$2a$08$NO9tkFLCoSqX1c5wk3s7z.JfxaVMKA.m7zUDdDwEquo4rvzimQeJm', // 111\n+â”Š   â”Š 48â”Š      picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n+â”Š   â”Š 49â”Š    },\n+â”Š   â”Š 50â”Š    {\n+â”Š   â”Š 51â”Š      id: '2',\n+â”Š   â”Š 52â”Š      name: 'Ethan Gonzalez',\n+â”Š   â”Š 53â”Š      username: 'ethan',\n+â”Š   â”Š 54â”Š      password: '$2a$08$xE4FuCi/ifxjL2S8CzKAmuKLwv18ktksSN.F3XYEnpmcKtpbpeZgO', // 222\n+â”Š   â”Š 55â”Š      picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n+â”Š   â”Š 56â”Š    },\n+â”Š   â”Š 57â”Š    {\n+â”Š   â”Š 58â”Š      id: '3',\n+â”Š   â”Š 59â”Š      name: 'Bryan Wallace',\n+â”Š   â”Š 60â”Š      username: 'bryan',\n+â”Š   â”Š 61â”Š      password: '$2a$08$UHgH7J8G6z1mGQn2qx2kdeWv0jvgHItyAsL9hpEUI3KJmhVW5Q1d.', // 333\n+â”Š   â”Š 62â”Š      picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n+â”Š   â”Š 63â”Š    },\n+â”Š   â”Š 64â”Š    {\n+â”Š   â”Š 65â”Š      id: '4',\n+â”Š   â”Š 66â”Š      name: 'Avery Stewart',\n+â”Š   â”Š 67â”Š      username: 'avery',\n+â”Š   â”Š 68â”Š      password: '$2a$08$wR1k5Q3T9FC7fUgB7Gdb9Os/GV7dGBBf4PLlWT7HERMFhmFDt47xi', // 444\n+â”Š   â”Š 69â”Š      picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n+â”Š   â”Š 70â”Š    },\n+â”Š   â”Š 71â”Š    {\n+â”Š   â”Š 72â”Š      id: '5',\n+â”Š   â”Š 73â”Š      name: 'Katie Peterson',\n+â”Š   â”Š 74â”Š      username: 'katie',\n+â”Š   â”Š 75â”Š      password: '$2a$08$6.mbXqsDX82ZZ7q5d8Osb..JrGSsNp4R3IKj7mxgF6YGT0OmMw242', // 555\n+â”Š   â”Š 76â”Š      picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n+â”Š   â”Š 77â”Š    },\n+â”Š   â”Š 78â”Š  ];\n+â”Š   â”Š 79â”Š\n+â”Š   â”Š 80â”Š  for (const sampleUser of sampleUsers) {\n+â”Š   â”Š 81â”Š    await pool.query(sql`\n+â”Š   â”Š 82â”Š      INSERT INTO users(id, name, username, password, picture)\n+â”Š   â”Š 83â”Š      VALUES(${sampleUser.id}, ${sampleUser.name}, ${sampleUser.username}, ${\n+â”Š   â”Š 84â”Š      sampleUser.password\n+â”Š   â”Š 85â”Š    }, ${sampleUser.picture})\n+â”Š   â”Š 86â”Š    `);\n+â”Š   â”Š 87â”Š  }\n+â”Š   â”Š 88â”Š\n+â”Š   â”Š 89â”Š  await pool.query(\n+â”Š   â”Š 90â”Š    sql`SELECT setval('users_id_seq', (SELECT max(id) FROM users))`\n â”Š 83â”Š 91â”Š  );\n â”Š 84â”Š 92â”Š\n-â”Š 85â”Š   â”Š  messages.splice(\n-â”Š 86â”Š   â”Š    0,\n-â”Š 87â”Š   â”Š    Infinity,\n-â”Š 88â”Š   â”Š    ...[\n-â”Š 89â”Š   â”Š      {\n-â”Š 90â”Š   â”Š        id: '1',\n-â”Š 91â”Š   â”Š        content: 'You on your way?',\n-â”Š 92â”Š   â”Š        createdAt: new Date(new Date('1-1-2019').getTime() - 60 * 1000 * 1000),\n-â”Š 93â”Š   â”Š        sender: '1',\n-â”Š 94â”Š   â”Š        recipient: '2',\n-â”Š 95â”Š   â”Š      },\n-â”Š 96â”Š   â”Š      {\n-â”Š 97â”Š   â”Š        id: '2',\n-â”Š 98â”Š   â”Š        content: \"Hey, it's me\",\n-â”Š 99â”Š   â”Š        createdAt: new Date(\n-â”Š100â”Š   â”Š          new Date('1-1-2019').getTime() - 2 * 60 * 1000 * 1000\n-â”Š101â”Š   â”Š        ),\n-â”Š102â”Š   â”Š        sender: '1',\n-â”Š103â”Š   â”Š        recipient: '3',\n-â”Š104â”Š   â”Š      },\n-â”Š105â”Š   â”Š      {\n-â”Š106â”Š   â”Š        id: '3',\n-â”Š107â”Š   â”Š        content: 'I should buy a boat',\n-â”Š108â”Š   â”Š        createdAt: new Date(\n-â”Š109â”Š   â”Š          new Date('1-1-2019').getTime() - 24 * 60 * 1000 * 1000\n-â”Š110â”Š   â”Š        ),\n-â”Š111â”Š   â”Š        sender: '1',\n-â”Š112â”Š   â”Š        recipient: '4',\n-â”Š113â”Š   â”Š      },\n-â”Š114â”Š   â”Š      {\n-â”Š115â”Š   â”Š        id: '4',\n-â”Š116â”Š   â”Š        content: 'This is wicked good ice cream.',\n-â”Š117â”Š   â”Š        createdAt: new Date(\n-â”Š118â”Š   â”Š          new Date('1-1-2019').getTime() - 14 * 24 * 60 * 1000 * 1000\n-â”Š119â”Š   â”Š        ),\n-â”Š120â”Š   â”Š        sender: '1',\n-â”Š121â”Š   â”Š        recipient: '5',\n-â”Š122â”Š   â”Š      },\n-â”Š123â”Š   â”Š    ]\n+â”Š   â”Š 93â”Š  await pool.query(sql`DELETE FROM chats`);\n+â”Š   â”Š 94â”Š\n+â”Š   â”Š 95â”Š  const sampleChats = [\n+â”Š   â”Š 96â”Š    {\n+â”Š   â”Š 97â”Š      id: '1',\n+â”Š   â”Š 98â”Š    },\n+â”Š   â”Š 99â”Š    {\n+â”Š   â”Š100â”Š      id: '2',\n+â”Š   â”Š101â”Š    },\n+â”Š   â”Š102â”Š    {\n+â”Š   â”Š103â”Š      id: '3',\n+â”Š   â”Š104â”Š    },\n+â”Š   â”Š105â”Š    {\n+â”Š   â”Š106â”Š      id: '4',\n+â”Š   â”Š107â”Š    },\n+â”Š   â”Š108â”Š  ];\n+â”Š   â”Š109â”Š\n+â”Š   â”Š110â”Š  for (const sampleChat of sampleChats) {\n+â”Š   â”Š111â”Š    await pool.query(sql`\n+â”Š   â”Š112â”Š      INSERT INTO chats(id)\n+â”Š   â”Š113â”Š      VALUES(${sampleChat.id})\n+â”Š   â”Š114â”Š    `);\n+â”Š   â”Š115â”Š  }\n+â”Š   â”Š116â”Š\n+â”Š   â”Š117â”Š  await pool.query(\n+â”Š   â”Š118â”Š    sql`SELECT setval('chats_id_seq', (SELECT max(id) FROM chats))`\n â”Š124â”Š119â”Š  );\n â”Š125â”Š120â”Š\n-â”Š126â”Š   â”Š  chats.splice(\n-â”Š127â”Š   â”Š    0,\n-â”Š128â”Š   â”Š    Infinity,\n-â”Š129â”Š   â”Š    ...[\n-â”Š130â”Š   â”Š      {\n-â”Š131â”Š   â”Š        id: '1',\n-â”Š132â”Š   â”Š        participants: ['1', '2'],\n-â”Š133â”Š   â”Š        messages: ['1'],\n-â”Š134â”Š   â”Š      },\n-â”Š135â”Š   â”Š      {\n-â”Š136â”Š   â”Š        id: '2',\n-â”Š137â”Š   â”Š        participants: ['1', '3'],\n-â”Š138â”Š   â”Š        messages: ['2'],\n-â”Š139â”Š   â”Š      },\n-â”Š140â”Š   â”Š      {\n-â”Š141â”Š   â”Š        id: '3',\n-â”Š142â”Š   â”Š        participants: ['1', '4'],\n-â”Š143â”Š   â”Š        messages: ['3'],\n-â”Š144â”Š   â”Š      },\n-â”Š145â”Š   â”Š      {\n-â”Š146â”Š   â”Š        id: '4',\n-â”Š147â”Š   â”Š        participants: ['1', '5'],\n-â”Š148â”Š   â”Š        messages: ['4'],\n-â”Š149â”Š   â”Š      },\n-â”Š150â”Š   â”Š    ]\n+â”Š   â”Š121â”Š  await pool.query(sql`DELETE FROM chats_users`);\n+â”Š   â”Š122â”Š\n+â”Š   â”Š123â”Š  const sampleChatsUsers = [\n+â”Š   â”Š124â”Š    {\n+â”Š   â”Š125â”Š      chat_id: '1',\n+â”Š   â”Š126â”Š      user_id: '1',\n+â”Š   â”Š127â”Š    },\n+â”Š   â”Š128â”Š    {\n+â”Š   â”Š129â”Š      chat_id: '1',\n+â”Š   â”Š130â”Š      user_id: '2',\n+â”Š   â”Š131â”Š    },\n+â”Š   â”Š132â”Š    {\n+â”Š   â”Š133â”Š      chat_id: '2',\n+â”Š   â”Š134â”Š      user_id: '1',\n+â”Š   â”Š135â”Š    },\n+â”Š   â”Š136â”Š    {\n+â”Š   â”Š137â”Š      chat_id: '2',\n+â”Š   â”Š138â”Š      user_id: '3',\n+â”Š   â”Š139â”Š    },\n+â”Š   â”Š140â”Š    {\n+â”Š   â”Š141â”Š      chat_id: '3',\n+â”Š   â”Š142â”Š      user_id: '1',\n+â”Š   â”Š143â”Š    },\n+â”Š   â”Š144â”Š    {\n+â”Š   â”Š145â”Š      chat_id: '3',\n+â”Š   â”Š146â”Š      user_id: '4',\n+â”Š   â”Š147â”Š    },\n+â”Š   â”Š148â”Š    {\n+â”Š   â”Š149â”Š      chat_id: '4',\n+â”Š   â”Š150â”Š      user_id: '1',\n+â”Š   â”Š151â”Š    },\n+â”Š   â”Š152â”Š    {\n+â”Š   â”Š153â”Š      chat_id: '4',\n+â”Š   â”Š154â”Š      user_id: '5',\n+â”Š   â”Š155â”Š    },\n+â”Š   â”Š156â”Š  ];\n+â”Š   â”Š157â”Š\n+â”Š   â”Š158â”Š  for (const sampleChatUser of sampleChatsUsers) {\n+â”Š   â”Š159â”Š    await pool.query(sql`\n+â”Š   â”Š160â”Š      INSERT INTO chats_users(chat_id, user_id)\n+â”Š   â”Š161â”Š      VALUES(${sampleChatUser.chat_id}, ${sampleChatUser.user_id})\n+â”Š   â”Š162â”Š    `);\n+â”Š   â”Š163â”Š  }\n+â”Š   â”Š164â”Š\n+â”Š   â”Š165â”Š  await pool.query(sql`DELETE FROM messages`);\n+â”Š   â”Š166â”Š\n+â”Š   â”Š167â”Š  const baseTime = new Date('1 Jan 2019 GMT').getTime();\n+â”Š   â”Š168â”Š\n+â”Š   â”Š169â”Š  const sampleMessages = [\n+â”Š   â”Š170â”Š    {\n+â”Š   â”Š171â”Š      id: '1',\n+â”Š   â”Š172â”Š      content: 'You on your way?',\n+â”Š   â”Š173â”Š      created_at: new Date(baseTime - 60 * 1000 * 1000),\n+â”Š   â”Š174â”Š      chat_id: '1',\n+â”Š   â”Š175â”Š      sender_user_id: '1',\n+â”Š   â”Š176â”Š    },\n+â”Š   â”Š177â”Š    {\n+â”Š   â”Š178â”Š      id: '2',\n+â”Š   â”Š179â”Š      content: \"Hey, it's me\",\n+â”Š   â”Š180â”Š      created_at: new Date(baseTime - 2 * 60 * 1000 * 1000),\n+â”Š   â”Š181â”Š      chat_id: '2',\n+â”Š   â”Š182â”Š      sender_user_id: '1',\n+â”Š   â”Š183â”Š    },\n+â”Š   â”Š184â”Š    {\n+â”Š   â”Š185â”Š      id: '3',\n+â”Š   â”Š186â”Š      content: 'I should buy a boat',\n+â”Š   â”Š187â”Š      created_at: new Date(baseTime - 24 * 60 * 1000 * 1000),\n+â”Š   â”Š188â”Š      chat_id: '3',\n+â”Š   â”Š189â”Š      sender_user_id: '1',\n+â”Š   â”Š190â”Š    },\n+â”Š   â”Š191â”Š    {\n+â”Š   â”Š192â”Š      id: '4',\n+â”Š   â”Š193â”Š      content: 'This is wicked good ice cream.',\n+â”Š   â”Š194â”Š      created_at: new Date(baseTime - 14 * 24 * 60 * 1000 * 1000),\n+â”Š   â”Š195â”Š      chat_id: '4',\n+â”Š   â”Š196â”Š      sender_user_id: '1',\n+â”Š   â”Š197â”Š    },\n+â”Š   â”Š198â”Š  ];\n+â”Š   â”Š199â”Š\n+â”Š   â”Š200â”Š  for (const sampleMessage of sampleMessages) {\n+â”Š   â”Š201â”Š    await pool.query(sql`\n+â”Š   â”Š202â”Š      INSERT INTO messages(id, content, created_at, chat_id, sender_user_id)\n+â”Š   â”Š203â”Š      VALUES(${sampleMessage.id}, ${sampleMessage.content}, ${\n+â”Š   â”Š204â”Š      sampleMessage.created_at\n+â”Š   â”Š205â”Š    }, ${sampleMessage.chat_id}, ${sampleMessage.sender_user_id})\n+â”Š   â”Š206â”Š    `);\n+â”Š   â”Š207â”Š  }\n+â”Š   â”Š208â”Š\n+â”Š   â”Š209â”Š  await pool.query(\n+â”Š   â”Š210â”Š    sql`SELECT setval('messages_id_seq', (SELECT max(id) FROM messages))`\n â”Š151â”Š211â”Š  );\n â”Š152â”Š212â”Š};\n â”Š153â”Š213â”Š\n-â”Š154â”Š   â”ŠresetDb();\n+â”Š   â”Š214â”Šif (envResetDb) {\n+â”Š   â”Š215â”Š  resetDb();\n+â”Š   â”Š216â”Š}\n```\n\n##### Changed env.ts\n```diff\n@@ -4,3 +4,4 @@\n â”Š4â”Š4â”Šexport const secret = process.env.JWT_SECRET || '70p53cr37';\n â”Š5â”Š5â”Šexport const origin = process.env.ORIGIN || 'http://localhost:3000';\n â”Š6â”Š6â”Šexport const port = process.env.PORT || 4000;\n+â”Š â”Š7â”Šexport const resetDb = process.env.RESET_DB || false;\n```\n\n[}]: #\n\n> When you update tables with your own ID values, you have to update `SEQUENCE`; because PostgreSQL calculates the next ID value using `SEQUENCE`s.\n\n**Updating Resolvers**\n\nWe will benefit from transactions for complicated SQL queries in mutation. Transactions will help us to rollback our changes if there is an exception in the middle of our operations.\n\n[{]: <helper> (diffStep 11.6 files=\"resolvers\" module=\"server\")\n\n#### [__Server__ Step 11.6: Updating Resolvers with SQL](https://github.com/Urigo/WhatsApp-Clone-Server/commit/677890dc67cbf15c09d87749a3cf3ca9484292d2)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,72 +1,104 @@\n â”Š  1â”Š  1â”Šimport { withFilter } from 'apollo-server-express';\n â”Š  2â”Š  2â”Šimport { GraphQLDateTime } from 'graphql-iso-date';\n-â”Š  3â”Š   â”Šimport { User, Message, Chat, chats, messages, users } from '../db';\n+â”Š   â”Š  3â”Šimport { Message, Chat, pool } from '../db';\n â”Š  4â”Š  4â”Šimport { Resolvers } from '../types/graphql';\n â”Š  5â”Š  5â”Šimport { secret, expiration } from '../env';\n â”Š  6â”Š  6â”Šimport bcrypt from 'bcrypt';\n â”Š  7â”Š  7â”Šimport jwt from 'jsonwebtoken';\n â”Š  8â”Š  8â”Šimport { validateLength, validatePassword } from '../validators';\n+â”Š   â”Š  9â”Šimport sql from 'sql-template-strings';\n â”Š  9â”Š 10â”Š\n â”Š 10â”Š 11â”Šconst resolvers: Resolvers = {\n â”Š 11â”Š 12â”Š  Date: GraphQLDateTime,\n â”Š 12â”Š 13â”Š\n â”Š 13â”Š 14â”Š  Message: {\n-â”Š 14â”Š   â”Š    chat(message) {\n-â”Š 15â”Š   â”Š      return chats.find(c => c.messages.some(m => m === message.id)) || null;\n+â”Š   â”Š 15â”Š    createdAt(message) {\n+â”Š   â”Š 16â”Š      return new Date(message.created_at);\n â”Š 16â”Š 17â”Š    },\n â”Š 17â”Š 18â”Š\n-â”Š 18â”Š   â”Š    sender(message) {\n-â”Š 19â”Š   â”Š      return users.find(u => u.id === message.sender) || null;\n+â”Š   â”Š 19â”Š    async chat(message, args, { db }) {\n+â”Š   â”Š 20â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š 21â”Š        SELECT * FROM chats WHERE id = ${message.chat_id}\n+â”Š   â”Š 22â”Š      `);\n+â”Š   â”Š 23â”Š      return rows[0] || null;\n â”Š 20â”Š 24â”Š    },\n â”Š 21â”Š 25â”Š\n-â”Š 22â”Š   â”Š    recipient(message) {\n-â”Š 23â”Š   â”Š      return users.find(u => u.id === message.recipient) || null;\n+â”Š   â”Š 26â”Š    async sender(message, args, { db }) {\n+â”Š   â”Š 27â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š 28â”Š        SELECT * FROM users WHERE id = ${message.sender_user_id}\n+â”Š   â”Š 29â”Š      `);\n+â”Š   â”Š 30â”Š      return rows[0] || null;\n+â”Š   â”Š 31â”Š    },\n+â”Š   â”Š 32â”Š\n+â”Š   â”Š 33â”Š    async recipient(message, args, { db }) {\n+â”Š   â”Š 34â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š 35â”Š        SELECT users.* FROM users, chats_users\n+â”Š   â”Š 36â”Š        WHERE chats_users.user_id != ${message.sender_user_id}\n+â”Š   â”Š 37â”Š        AND chats_users.chat_id = ${message.chat_id}\n+â”Š   â”Š 38â”Š      `);\n+â”Š   â”Š 39â”Š      return rows[0] || null;\n â”Š 24â”Š 40â”Š    },\n â”Š 25â”Š 41â”Š\n â”Š 26â”Š 42â”Š    isMine(message, args, { currentUser }) {\n-â”Š 27â”Š   â”Š      return message.sender === currentUser.id;\n+â”Š   â”Š 43â”Š      return message.sender_user_id === currentUser.id;\n â”Š 28â”Š 44â”Š    },\n â”Š 29â”Š 45â”Š  },\n â”Š 30â”Š 46â”Š\n â”Š 31â”Š 47â”Š  Chat: {\n-â”Š 32â”Š   â”Š    name(chat, args, { currentUser }) {\n+â”Š   â”Š 48â”Š    async name(chat, args, { currentUser, db }) {\n â”Š 33â”Š 49â”Š      if (!currentUser) return null;\n â”Š 34â”Š 50â”Š\n-â”Š 35â”Š   â”Š      const participantId = chat.participants.find(p => p !== currentUser.id);\n+â”Š   â”Š 51â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š 52â”Š        SELECT users.* FROM users, chats_users\n+â”Š   â”Š 53â”Š        WHERE users.id != ${currentUser.id}\n+â”Š   â”Š 54â”Š        AND users.id = chats_users.user_id\n+â”Š   â”Š 55â”Š        AND chats_users.chat_id = ${chat.id}`);\n â”Š 36â”Š 56â”Š\n-â”Š 37â”Š   â”Š      if (!participantId) return null;\n-â”Š 38â”Š   â”Š\n-â”Š 39â”Š   â”Š      const participant = users.find(u => u.id === participantId);\n+â”Š   â”Š 57â”Š      const participant = rows[0];\n â”Š 40â”Š 58â”Š\n â”Š 41â”Š 59â”Š      return participant ? participant.name : null;\n â”Š 42â”Š 60â”Š    },\n â”Š 43â”Š 61â”Š\n-â”Š 44â”Š   â”Š    picture(chat, args, { currentUser }) {\n+â”Š   â”Š 62â”Š    async picture(chat, args, { currentUser, db }) {\n â”Š 45â”Š 63â”Š      if (!currentUser) return null;\n â”Š 46â”Š 64â”Š\n-â”Š 47â”Š   â”Š      const participantId = chat.participants.find(p => p !== currentUser.id);\n-â”Š 48â”Š   â”Š\n-â”Š 49â”Š   â”Š      if (!participantId) return null;\n+â”Š   â”Š 65â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š 66â”Š        SELECT users.* FROM users, chats_users\n+â”Š   â”Š 67â”Š        WHERE users.id != ${currentUser.id}\n+â”Š   â”Š 68â”Š        AND users.id = chats_users.user_id\n+â”Š   â”Š 69â”Š        AND chats_users.chat_id = ${chat.id}`);\n â”Š 50â”Š 70â”Š\n-â”Š 51â”Š   â”Š      const participant = users.find(u => u.id === participantId);\n+â”Š   â”Š 71â”Š      const participant = rows[0];\n â”Š 52â”Š 72â”Š\n â”Š 53â”Š 73â”Š      return participant ? participant.picture : null;\n â”Š 54â”Š 74â”Š    },\n â”Š 55â”Š 75â”Š\n-â”Š 56â”Š   â”Š    messages(chat) {\n-â”Š 57â”Š   â”Š      return messages.filter(m => chat.messages.includes(m.id));\n+â”Š   â”Š 76â”Š    async messages(chat, args, { db }) {\n+â”Š   â”Š 77â”Š      const { rows } = await db.query(\n+â”Š   â”Š 78â”Š        sql`SELECT * FROM messages WHERE chat_id = ${chat.id}`\n+â”Š   â”Š 79â”Š      );\n+â”Š   â”Š 80â”Š\n+â”Š   â”Š 81â”Š      return rows;\n â”Š 58â”Š 82â”Š    },\n â”Š 59â”Š 83â”Š\n-â”Š 60â”Š   â”Š    lastMessage(chat) {\n-â”Š 61â”Š   â”Š      const lastMessage = chat.messages[chat.messages.length - 1];\n+â”Š   â”Š 84â”Š    async lastMessage(chat, args, { db }) {\n+â”Š   â”Š 85â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š 86â”Š        SELECT * FROM messages\n+â”Š   â”Š 87â”Š        WHERE chat_id = ${chat.id}\n+â”Š   â”Š 88â”Š        ORDER BY created_at DESC\n+â”Š   â”Š 89â”Š        LIMIT 1`);\n â”Š 62â”Š 90â”Š\n-â”Š 63â”Š   â”Š      return messages.find(m => m.id === lastMessage) || null;\n+â”Š   â”Š 91â”Š      return rows[0];\n â”Š 64â”Š 92â”Š    },\n â”Š 65â”Š 93â”Š\n-â”Š 66â”Š   â”Š    participants(chat) {\n-â”Š 67â”Š   â”Š      return chat.participants\n-â”Š 68â”Š   â”Š        .map(p => users.find(u => u.id === p))\n-â”Š 69â”Š   â”Š        .filter(Boolean) as User[];\n+â”Š   â”Š 94â”Š    async participants(chat, args, { db }) {\n+â”Š   â”Š 95â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š 96â”Š        SELECT users.* FROM users, chats_users\n+â”Š   â”Š 97â”Š        WHERE chats_users.chat_id = ${chat.id}\n+â”Š   â”Š 98â”Š        AND chats_users.user_id = users.id\n+â”Š   â”Š 99â”Š      `);\n+â”Š   â”Š100â”Š\n+â”Š   â”Š101â”Š      return rows;\n â”Š 70â”Š102â”Š    },\n â”Š 71â”Š103â”Š  },\n â”Š 72â”Š104â”Š\n```\n```diff\n@@ -75,32 +107,48 @@\n â”Š 75â”Š107â”Š      return currentUser || null;\n â”Š 76â”Š108â”Š    },\n â”Š 77â”Š109â”Š\n-â”Š 78â”Š   â”Š    chats(root, args, { currentUser }) {\n+â”Š   â”Š110â”Š    async chats(root, args, { currentUser, db }) {\n â”Š 79â”Š111â”Š      if (!currentUser) return [];\n â”Š 80â”Š112â”Š\n-â”Š 81â”Š   â”Š      return chats.filter(c => c.participants.includes(currentUser.id));\n+â”Š   â”Š113â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š114â”Š        SELECT chats.* FROM chats, chats_users\n+â”Š   â”Š115â”Š        WHERE chats.id = chats_users.chat_id\n+â”Š   â”Š116â”Š        AND chats_users.user_id = ${currentUser.id}\n+â”Š   â”Š117â”Š      `);\n+â”Š   â”Š118â”Š\n+â”Š   â”Š119â”Š      return rows;\n â”Š 82â”Š120â”Š    },\n â”Š 83â”Š121â”Š\n-â”Š 84â”Š   â”Š    chat(root, { chatId }, { currentUser }) {\n+â”Š   â”Š122â”Š    async chat(root, { chatId }, { currentUser, db }) {\n â”Š 85â”Š123â”Š      if (!currentUser) return null;\n â”Š 86â”Š124â”Š\n-â”Š 87â”Š   â”Š      const chat = chats.find(c => c.id === chatId);\n+â”Š   â”Š125â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š126â”Š        SELECT chats.* FROM chats, chats_users\n+â”Š   â”Š127â”Š        WHERE chats_users.chat_id = ${chatId}\n+â”Š   â”Š128â”Š        AND chats.id = chats_users.chat_id\n+â”Š   â”Š129â”Š        AND chats_users.user_id = ${currentUser.id}\n+â”Š   â”Š130â”Š      `);\n â”Š 88â”Š131â”Š\n-â”Š 89â”Š   â”Š      if (!chat) return null;\n-â”Š 90â”Š   â”Š\n-â”Š 91â”Š   â”Š      return chat.participants.includes(currentUser.id) ? chat : null;\n+â”Š   â”Š132â”Š      return rows[0] ? rows[0] : null;\n â”Š 92â”Š133â”Š    },\n â”Š 93â”Š134â”Š\n-â”Š 94â”Š   â”Š    users(root, args, { currentUser }) {\n+â”Š   â”Š135â”Š    async users(root, args, { currentUser, db }) {\n â”Š 95â”Š136â”Š      if (!currentUser) return [];\n â”Š 96â”Š137â”Š\n-â”Š 97â”Š   â”Š      return users.filter(u => u.id !== currentUser.id);\n+â”Š   â”Š138â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š139â”Š        SELECT * FROM users WHERE users.id != ${currentUser.id}\n+â”Š   â”Š140â”Š      `);\n+â”Š   â”Š141â”Š\n+â”Š   â”Š142â”Š      return rows;\n â”Š 98â”Š143â”Š    },\n â”Š 99â”Š144â”Š  },\n â”Š100â”Š145â”Š\n â”Š101â”Š146â”Š  Mutation: {\n-â”Š102â”Š   â”Š    signIn(root, { username, password }, { res }) {\n-â”Š103â”Š   â”Š      const user = users.find(u => u.username === username);\n+â”Š   â”Š147â”Š    async signIn(root, { username, password }, { db, res }) {\n+â”Š   â”Š148â”Š      const { rows } = await db.query(\n+â”Š   â”Š149â”Š        sql`SELECT * FROM users WHERE username = ${username}`\n+â”Š   â”Š150â”Š      );\n+â”Š   â”Š151â”Š      const user = rows[0];\n â”Š104â”Š152â”Š\n â”Š105â”Š153â”Š      if (!user) {\n â”Š106â”Š154â”Š        throw new Error('user not found');\n```\n```diff\n@@ -119,7 +167,7 @@\n â”Š119â”Š167â”Š      return user;\n â”Š120â”Š168â”Š    },\n â”Š121â”Š169â”Š\n-â”Š122â”Š   â”Š    signUp(root, { name, username, password, passwordConfirm }) {\n+â”Š   â”Š170â”Š    async signUp(root, { name, username, password, passwordConfirm }, { db }) {\n â”Š123â”Š171â”Š      validateLength('req.name', name, 3, 50);\n â”Š124â”Š172â”Š      validateLength('req.username', username, 3, 18);\n â”Š125â”Š173â”Š      validatePassword('req.password', password);\n```\n```diff\n@@ -128,114 +176,131 @@\n â”Š128â”Š176â”Š        throw Error(\"req.password and req.passwordConfirm don't match\");\n â”Š129â”Š177â”Š      }\n â”Š130â”Š178â”Š\n-â”Š131â”Š   â”Š      if (users.some(u => u.username === username)) {\n+â”Š   â”Š179â”Š      const existingUserQuery = await db.query(\n+â”Š   â”Š180â”Š        sql`SELECT * FROM users WHERE username = ${username}`\n+â”Š   â”Š181â”Š      );\n+â”Š   â”Š182â”Š      if (existingUserQuery.rows[0]) {\n â”Š132â”Š183â”Š        throw Error('username already exists');\n â”Š133â”Š184â”Š      }\n â”Š134â”Š185â”Š\n â”Š135â”Š186â”Š      const passwordHash = bcrypt.hashSync(password, bcrypt.genSaltSync(8));\n â”Š136â”Š187â”Š\n-â”Š137â”Š   â”Š      const user: User = {\n-â”Š138â”Š   â”Š        id: String(users.length + 1),\n-â”Š139â”Š   â”Š        password: passwordHash,\n-â”Š140â”Š   â”Š        picture: '',\n-â”Š141â”Š   â”Š        username,\n-â”Š142â”Š   â”Š        name,\n-â”Š143â”Š   â”Š      };\n+â”Š   â”Š188â”Š      const createdUserQuery = await db.query(sql`\n+â”Š   â”Š189â”Š        INSERT INTO users(password, picture, username, name)\n+â”Š   â”Š190â”Š        VALUES(${passwordHash}, '', ${username}, ${name})\n+â”Š   â”Š191â”Š        RETURNING *\n+â”Š   â”Š192â”Š      `);\n â”Š144â”Š193â”Š\n-â”Š145â”Š   â”Š      users.push(user);\n+â”Š   â”Š194â”Š      const user = createdUserQuery.rows[0];\n â”Š146â”Š195â”Š\n â”Š147â”Š196â”Š      return user;\n â”Š148â”Š197â”Š    },\n â”Š149â”Š198â”Š\n-â”Š150â”Š   â”Š    addMessage(root, { chatId, content }, { currentUser, pubsub }) {\n+â”Š   â”Š199â”Š    async addMessage(root, { chatId, content }, { currentUser, pubsub, db }) {\n â”Š151â”Š200â”Š      if (!currentUser) return null;\n â”Š152â”Š201â”Š\n-â”Š153â”Š   â”Š      const chatIndex = chats.findIndex(c => c.id === chatId);\n-â”Š154â”Š   â”Š\n-â”Š155â”Š   â”Š      if (chatIndex === -1) return null;\n-â”Š156â”Š   â”Š\n-â”Š157â”Š   â”Š      const chat = chats[chatIndex];\n-â”Š158â”Š   â”Š      if (!chat.participants.includes(currentUser.id)) return null;\n-â”Š159â”Š   â”Š\n-â”Š160â”Š   â”Š      const messagesIds = messages.map(currentMessage => Number(currentMessage.id));\n-â”Š161â”Š   â”Š      const messageId = String(Math.max(...messagesIds) + 1);\n-â”Š162â”Š   â”Š      const message: Message = {\n-â”Š163â”Š   â”Š        id: messageId,\n-â”Š164â”Š   â”Š        createdAt: new Date(),\n-â”Š165â”Š   â”Š        sender: currentUser.id,\n-â”Š166â”Š   â”Š        recipient: chat.participants.find(p => p !== currentUser.id) as string,\n-â”Š167â”Š   â”Š        content,\n-â”Š168â”Š   â”Š      };\n+â”Š   â”Š202â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š203â”Š        INSERT INTO messages(chat_id, sender_user_id, content)\n+â”Š   â”Š204â”Š        VALUES(${chatId}, ${currentUser.id}, ${content})\n+â”Š   â”Š205â”Š        RETURNING *\n+â”Š   â”Š206â”Š      `);\n â”Š169â”Š207â”Š\n-â”Š170â”Š   â”Š      messages.push(message);\n-â”Š171â”Š   â”Š      chat.messages.push(messageId);\n-â”Š172â”Š   â”Š      // The chat will appear at the top of the ChatsList component\n-â”Š173â”Š   â”Š      chats.splice(chatIndex, 1);\n-â”Š174â”Š   â”Š      chats.unshift(chat);\n+â”Š   â”Š208â”Š      const messageAdded = rows[0];\n â”Š175â”Š209â”Š\n â”Š176â”Š210â”Š      pubsub.publish('messageAdded', {\n-â”Š177â”Š   â”Š        messageAdded: message,\n+â”Š   â”Š211â”Š        messageAdded,\n â”Š178â”Š212â”Š      });\n â”Š179â”Š213â”Š\n-â”Š180â”Š   â”Š      return message;\n+â”Š   â”Š214â”Š      return messageAdded;\n â”Š181â”Š215â”Š    },\n â”Š182â”Š216â”Š\n-â”Š183â”Š   â”Š    addChat(root, { recipientId }, { currentUser, pubsub }) {\n+â”Š   â”Š217â”Š    async addChat(root, { recipientId }, { currentUser, pubsub, db }) {\n â”Š184â”Š218â”Š      if (!currentUser) return null;\n-â”Š185â”Š   â”Š      if (!users.some(u => u.id === recipientId)) return null;\n â”Š186â”Š219â”Š\n-â”Š187â”Š   â”Š      let chat = chats.find(\n-â”Š188â”Š   â”Š        c =>\n-â”Š189â”Š   â”Š          c.participants.includes(currentUser.id) &&\n-â”Š190â”Š   â”Š          c.participants.includes(recipientId)\n-â”Š191â”Š   â”Š      );\n+â”Š   â”Š220â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š221â”Š        SELECT chats.* FROM chats, (SELECT * FROM chats_users WHERE user_id = ${\n+â”Š   â”Š222â”Š          currentUser.id\n+â”Š   â”Š223â”Š        }) AS chats_of_current_user, chats_users\n+â”Š   â”Š224â”Š        WHERE chats_users.chat_id = chats_of_current_user.chat_id\n+â”Š   â”Š225â”Š        AND chats.id = chats_users.chat_id\n+â”Š   â”Š226â”Š        AND chats_users.user_id = ${recipientId}\n+â”Š   â”Š227â”Š      `);\n+â”Š   â”Š228â”Š\n+â”Š   â”Š229â”Š      // If there is already a chat between these two users, return it\n+â”Š   â”Š230â”Š      if (rows[0]) {\n+â”Š   â”Š231â”Š        return rows[0];\n+â”Š   â”Š232â”Š      }\n â”Š192â”Š233â”Š\n-â”Š193â”Š   â”Š      if (chat) return chat;\n+â”Š   â”Š234â”Š      try {\n+â”Š   â”Š235â”Š        await db.query('BEGIN');\n â”Š194â”Š236â”Š\n-â”Š195â”Š   â”Š      const chatsIds = chats.map(c => Number(c.id));\n+â”Š   â”Š237â”Š        const { rows } = await db.query(sql`\n+â”Š   â”Š238â”Š          INSERT INTO chats\n+â”Š   â”Š239â”Š          DEFAULT VALUES\n+â”Š   â”Š240â”Š          RETURNING *\n+â”Š   â”Š241â”Š        `);\n â”Š196â”Š242â”Š\n-â”Š197â”Š   â”Š      chat = {\n-â”Š198â”Š   â”Š        id: String(Math.max(...chatsIds) + 1),\n-â”Š199â”Š   â”Š        participants: [currentUser.id, recipientId],\n-â”Š200â”Š   â”Š        messages: [],\n-â”Š201â”Š   â”Š      };\n+â”Š   â”Š243â”Š        const chatAdded = rows[0];\n â”Š202â”Š244â”Š\n-â”Š203â”Š   â”Š      chats.push(chat);\n+â”Š   â”Š245â”Š        await db.query(sql`\n+â”Š   â”Š246â”Š          INSERT INTO chats_users(chat_id, user_id)\n+â”Š   â”Š247â”Š          VALUES(${chatAdded.id}, ${currentUser.id})\n+â”Š   â”Š248â”Š        `);\n â”Š204â”Š249â”Š\n-â”Š205â”Š   â”Š      pubsub.publish('chatAdded', {\n-â”Š206â”Š   â”Š        chatAdded: chat,\n-â”Š207â”Š   â”Š      });\n+â”Š   â”Š250â”Š        await db.query(sql`\n+â”Š   â”Š251â”Š          INSERT INTO chats_users(chat_id, user_id)\n+â”Š   â”Š252â”Š          VALUES(${chatAdded.id}, ${recipientId})\n+â”Š   â”Š253â”Š        `);\n â”Š208â”Š254â”Š\n-â”Š209â”Š   â”Š      return chat;\n-â”Š210â”Š   â”Š    },\n+â”Š   â”Š255â”Š        await db.query('COMMIT');\n â”Š211â”Š256â”Š\n-â”Š212â”Š   â”Š    removeChat(root, { chatId }, { currentUser, pubsub }) {\n-â”Š213â”Š   â”Š      if (!currentUser) return null;\n+â”Š   â”Š257â”Š        pubsub.publish('chatAdded', {\n+â”Š   â”Š258â”Š          chatAdded,\n+â”Š   â”Š259â”Š        });\n â”Š214â”Š260â”Š\n-â”Š215â”Š   â”Š      const chatIndex = chats.findIndex(c => c.id === chatId);\n+â”Š   â”Š261â”Š        return chatAdded;\n+â”Š   â”Š262â”Š      } catch (e) {\n+â”Š   â”Š263â”Š        await db.query('ROLLBACK');\n+â”Š   â”Š264â”Š        throw e;\n+â”Š   â”Š265â”Š      }\n+â”Š   â”Š266â”Š    },\n â”Š216â”Š267â”Š\n-â”Š217â”Š   â”Š      if (chatIndex === -1) return null;\n+â”Š   â”Š268â”Š    async removeChat(root, { chatId }, { currentUser, pubsub, db }) {\n+â”Š   â”Š269â”Š      if (!currentUser) return null;\n â”Š218â”Š270â”Š\n-â”Š219â”Š   â”Š      const chat = chats[chatIndex];\n+â”Š   â”Š271â”Š      try {\n+â”Š   â”Š272â”Š        await db.query('BEGIN');\n â”Š220â”Š273â”Š\n-â”Š221â”Š   â”Š      if (!chat.participants.some(p => p === currentUser.id)) return null;\n+â”Š   â”Š274â”Š        const { rows } = await db.query(sql`\n+â”Š   â”Š275â”Š          SELECT chats.* FROM chats, chats_users\n+â”Š   â”Š276â”Š          WHERE id = ${chatId}\n+â”Š   â”Š277â”Š          AND chats.id = chats_users.chat_id\n+â”Š   â”Š278â”Š          AND chats_users.user_id = ${currentUser.id}\n+â”Š   â”Š279â”Š        `);\n â”Š222â”Š280â”Š\n-â”Š223â”Š   â”Š      chat.messages.forEach(chatMessage => {\n-â”Š224â”Š   â”Š        const chatMessageIndex = messages.findIndex(m => m.id === chatMessage);\n+â”Š   â”Š281â”Š        const chat = rows[0];\n â”Š225â”Š282â”Š\n-â”Š226â”Š   â”Š        if (chatMessageIndex !== -1) {\n-â”Š227â”Š   â”Š          messages.splice(chatMessageIndex, 1);\n+â”Š   â”Š283â”Š        if (!chat) {\n+â”Š   â”Š284â”Š          await db.query('ROLLBACK');\n+â”Š   â”Š285â”Š          return null;\n â”Š228â”Š286â”Š        }\n-â”Š229â”Š   â”Š      });\n â”Š230â”Š287â”Š\n-â”Š231â”Š   â”Š      chats.splice(chatIndex, 1);\n+â”Š   â”Š288â”Š        await db.query(sql`\n+â”Š   â”Š289â”Š          DELETE FROM chats WHERE chats.id = ${chatId}\n+â”Š   â”Š290â”Š        `);\n â”Š232â”Š291â”Š\n-â”Š233â”Š   â”Š      pubsub.publish('chatRemoved', {\n-â”Š234â”Š   â”Š        chatRemoved: chat.id,\n-â”Š235â”Š   â”Š        targetChat: chat,\n-â”Š236â”Š   â”Š      });\n+â”Š   â”Š292â”Š        pubsub.publish('chatRemoved', {\n+â”Š   â”Š293â”Š          chatRemoved: chat.id,\n+â”Š   â”Š294â”Š          targetChat: chat,\n+â”Š   â”Š295â”Š        });\n â”Š237â”Š296â”Š\n-â”Š238â”Š   â”Š      return chatId;\n+â”Š   â”Š297â”Š        await db.query('COMMIT');\n+â”Š   â”Š298â”Š\n+â”Š   â”Š299â”Š        return chatId;\n+â”Š   â”Š300â”Š      } catch (e) {\n+â”Š   â”Š301â”Š        await db.query('ROLLBACK');\n+â”Š   â”Š302â”Š        throw e;\n+â”Š   â”Š303â”Š      }\n â”Š239â”Š304â”Š    },\n â”Š240â”Š305â”Š  },\n â”Š241â”Š306â”Š\n```\n```diff\n@@ -243,12 +308,19 @@\n â”Š243â”Š308â”Š    messageAdded: {\n â”Š244â”Š309â”Š      subscribe: withFilter(\n â”Š245â”Š310â”Š        (root, args, { pubsub }) => pubsub.asyncIterator('messageAdded'),\n-â”Š246â”Š   â”Š        ({ messageAdded }, args, { currentUser }) => {\n+â”Š   â”Š311â”Š        async (\n+â”Š   â”Š312â”Š          { messageAdded }: { messageAdded: Message },\n+â”Š   â”Š313â”Š          args,\n+â”Š   â”Š314â”Š          { currentUser }\n+â”Š   â”Š315â”Š        ) => {\n â”Š247â”Š316â”Š          if (!currentUser) return false;\n â”Š248â”Š317â”Š\n-â”Š249â”Š   â”Š          return [messageAdded.sender, messageAdded.recipient].includes(\n-â”Š250â”Š   â”Š            currentUser.id\n-â”Š251â”Š   â”Š          );\n+â”Š   â”Š318â”Š          const { rows } = await pool.query(sql`\n+â”Š   â”Š319â”Š            SELECT * FROM chats_users\n+â”Š   â”Š320â”Š            WHERE chat_id = ${messageAdded.chat_id}\n+â”Š   â”Š321â”Š            AND user_id = ${currentUser.id}`);\n+â”Š   â”Š322â”Š\n+â”Š   â”Š323â”Š          return !!rows.length;\n â”Š252â”Š324â”Š        }\n â”Š253â”Š325â”Š      ),\n â”Š254â”Š326â”Š    },\n```\n```diff\n@@ -256,10 +328,15 @@\n â”Š256â”Š328â”Š    chatAdded: {\n â”Š257â”Š329â”Š      subscribe: withFilter(\n â”Š258â”Š330â”Š        (root, args, { pubsub }) => pubsub.asyncIterator('chatAdded'),\n-â”Š259â”Š   â”Š        ({ chatAdded }: { chatAdded: Chat }, args, { currentUser }) => {\n+â”Š   â”Š331â”Š        async ({ chatAdded }: { chatAdded: Chat }, args, { currentUser }) => {\n â”Š260â”Š332â”Š          if (!currentUser) return false;\n â”Š261â”Š333â”Š\n-â”Š262â”Š   â”Š          return chatAdded.participants.some(p => p === currentUser.id);\n+â”Š   â”Š334â”Š          const { rows } = await pool.query(sql`\n+â”Š   â”Š335â”Š            SELECT * FROM chats_users\n+â”Š   â”Š336â”Š            WHERE chat_id = ${chatAdded.id}\n+â”Š   â”Š337â”Š            AND user_id = ${currentUser.id}`);\n+â”Š   â”Š338â”Š\n+â”Š   â”Š339â”Š          return !!rows.length;\n â”Š263â”Š340â”Š        }\n â”Š264â”Š341â”Š      ),\n â”Š265â”Š342â”Š    },\n```\n```diff\n@@ -267,10 +344,15 @@\n â”Š267â”Š344â”Š    chatRemoved: {\n â”Š268â”Š345â”Š      subscribe: withFilter(\n â”Š269â”Š346â”Š        (root, args, { pubsub }) => pubsub.asyncIterator('chatRemoved'),\n-â”Š270â”Š   â”Š        ({ targetChat }: { targetChat: Chat }, args, { currentUser }) => {\n+â”Š   â”Š347â”Š        async ({ targetChat }: { targetChat: Chat }, args, { currentUser }) => {\n â”Š271â”Š348â”Š          if (!currentUser) return false;\n â”Š272â”Š349â”Š\n-â”Š273â”Š   â”Š          return targetChat.participants.some(p => p === currentUser.id);\n+â”Š   â”Š350â”Š          const { rows } = await pool.query(sql`\n+â”Š   â”Š351â”Š            SELECT * FROM chats_users\n+â”Š   â”Š352â”Š            WHERE chat_id = ${targetChat.id}\n+â”Š   â”Š353â”Š            AND user_id = ${currentUser.id}`);\n+â”Š   â”Š354â”Š\n+â”Š   â”Š355â”Š          return !!rows.length;\n â”Š274â”Š356â”Š        }\n â”Š275â”Š357â”Š      ),\n â”Š276â”Š358â”Š    },\n```\n\n[}]: #\n\n> We use `pool` itself instead of `db` from the context in the subscriptions. Remember we don't request for a new client from the pool in subscriptions.\n> If you use `pool.query`, it just opens a connection, does that operation and set the client free. In that case, you wouldn't be able to work with transactions which is not need in GraphQL Subscriptions.\n\n**Updating Subscriptions w/ PostgreSQL PubSub mechanism**\n\nApolloâ€™s default PubSub mechanism is not for production usage. So, we will use PostgreSQLâ€™s notify/listen for our PubSub mechanism in GraphQL Subscriptions.\n\nInstall the necessary packages;\n\n\t$ yarn add graphql-postgres-subscriptions\n\n[{]: <helper> (diffStep 11.7 files=\"index\" module=\"server\")\n\n#### [__Server__ Step 11.7: Updating Subscriptions w/ PostgreSQL PubSub mechanism](https://github.com/Urigo/WhatsApp-Clone-Server/commit/5ee727c3e68ab895694881726786a10c4ffbd938)\n\n##### Changed index.ts\n```diff\n@@ -1,4 +1,4 @@\n-â”Š1â”Š â”Šimport { ApolloServer, gql, PubSub } from 'apollo-server-express';\n+â”Š â”Š1â”Šimport { ApolloServer } from 'apollo-server-express';\n â”Š2â”Š2â”Šimport cookie from 'cookie';\n â”Š3â”Š3â”Šimport http from 'http';\n â”Š4â”Š4â”Šimport jwt from 'jsonwebtoken';\n```\n```diff\n@@ -8,8 +8,15 @@\n â”Š 8â”Š 8â”Šimport schema from './schema';\n â”Š 9â”Š 9â”Šimport { MyContext } from './context';\n â”Š10â”Š10â”Šimport sql from 'sql-template-strings';\n+â”Š  â”Š11â”Šconst { PostgresPubSub } = require('graphql-postgres-subscriptions');\n â”Š11â”Š12â”Š\n-â”Š12â”Š  â”Šconst pubsub = new PubSub();\n+â”Š  â”Š13â”Šconst pubsub = new PostgresPubSub({\n+â”Š  â”Š14â”Š  host: 'localhost',\n+â”Š  â”Š15â”Š  port: process.env.DB_PORT ? parseInt(process.env.DB_PORT) : 5432,\n+â”Š  â”Š16â”Š  user: 'testuser',\n+â”Š  â”Š17â”Š  password: 'testpassword',\n+â”Š  â”Š18â”Š  database: 'whatsapp',\n+â”Š  â”Š19â”Š});\n â”Š13â”Š20â”Šconst server = new ApolloServer({\n â”Š14â”Š21â”Š  schema,\n â”Š15â”Š22â”Š  context: async (session: any) => {\n```\n\n[}]: #\n\n> Unfortunately `graphql-postgres-subscription` doesn't have TypeScript typings, so we have to import it using `require`.\n\n**Updating Tests**\n\nWe should update tests to use SQL instead of in-memory database.\n\n[{]: <helper> (diffStep 11.8 files=\"test\" module=\"server\")\n\n#### [__Server__ Step 11.8: Updating Tests with SQL](https://github.com/Urigo/WhatsApp-Clone-Server/commit/a7996674bd819e4abc3f5fb8c2abb0b1f6414da0)\n\n##### Changed tests&#x2F;mutations&#x2F;addChat.test.ts\n```diff\n@@ -1,18 +1,27 @@\n â”Š 1â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n â”Š 2â”Š 2â”Šimport { ApolloServer, PubSub, gql } from 'apollo-server-express';\n â”Š 3â”Š 3â”Šimport schema from '../../schema';\n-â”Š 4â”Š  â”Šimport { resetDb, users } from '../../db';\n+â”Š  â”Š 4â”Šimport { resetDb, pool } from '../../db';\n+â”Š  â”Š 5â”Šimport sql from 'sql-template-strings';\n+â”Š  â”Š 6â”Šimport { MyContext } from '../../context';\n â”Š 5â”Š 7â”Š\n â”Š 6â”Š 8â”Šdescribe('Mutation.addChat', () => {\n â”Š 7â”Š 9â”Š  beforeEach(resetDb);\n â”Š 8â”Š10â”Š\n â”Š 9â”Š11â”Š  it('creates a new chat between current user and specified recipient', async () => {\n+â”Š  â”Š12â”Š    const { rows } = await pool.query(sql`SELECT * FROM users WHERE id = 2`);\n+â”Š  â”Š13â”Š    const currentUser = rows[0];\n â”Š10â”Š14â”Š    const server = new ApolloServer({\n â”Š11â”Š15â”Š      schema,\n-â”Š12â”Š  â”Š      context: () => ({\n+â”Š  â”Š16â”Š      context: async () => ({\n â”Š13â”Š17â”Š        pubsub: new PubSub(),\n-â”Š14â”Š  â”Š        currentUser: users[1],\n+â”Š  â”Š18â”Š        currentUser,\n+â”Š  â”Š19â”Š        db: await pool.connect(),\n â”Š15â”Š20â”Š      }),\n+â”Š  â”Š21â”Š      formatResponse: (res: any, { context }: { context: MyContext }) => {\n+â”Š  â”Š22â”Š        context.db.release();\n+â”Š  â”Š23â”Š        return res;\n+â”Š  â”Š24â”Š      },\n â”Š16â”Š25â”Š    });\n â”Š17â”Š26â”Š\n â”Š18â”Š27â”Š    const { query, mutate } = createTestClient(server);\n```\n```diff\n@@ -57,12 +66,19 @@\n â”Š57â”Š66â”Š  });\n â”Š58â”Š67â”Š\n â”Š59â”Š68â”Š  it('returns the existing chat if so', async () => {\n+â”Š  â”Š69â”Š    const { rows } = await pool.query(sql`SELECT * FROM users WHERE id = 1`);\n+â”Š  â”Š70â”Š    const currentUser = rows[0];\n â”Š60â”Š71â”Š    const server = new ApolloServer({\n â”Š61â”Š72â”Š      schema,\n-â”Š62â”Š  â”Š      context: () => ({\n+â”Š  â”Š73â”Š      context: async () => ({\n â”Š63â”Š74â”Š        pubsub: new PubSub(),\n-â”Š64â”Š  â”Š        currentUser: users[0],\n+â”Š  â”Š75â”Š        currentUser,\n+â”Š  â”Š76â”Š        db: await pool.connect(),\n â”Š65â”Š77â”Š      }),\n+â”Š  â”Š78â”Š      formatResponse: (res: any, { context }: { context: MyContext }) => {\n+â”Š  â”Š79â”Š        context.db.release();\n+â”Š  â”Š80â”Š        return res;\n+â”Š  â”Š81â”Š      },\n â”Š66â”Š82â”Š    });\n â”Š67â”Š83â”Š\n â”Š68â”Š84â”Š    const { query, mutate } = createTestClient(server);\n```\n\n##### Changed tests&#x2F;mutations&#x2F;addMessage.test.ts\n```diff\n@@ -1,18 +1,27 @@\n â”Š 1â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n â”Š 2â”Š 2â”Šimport { ApolloServer, PubSub, gql } from 'apollo-server-express';\n â”Š 3â”Š 3â”Šimport schema from '../../schema';\n-â”Š 4â”Š  â”Šimport { resetDb, users } from '../../db';\n+â”Š  â”Š 4â”Šimport { resetDb, pool } from '../../db';\n+â”Š  â”Š 5â”Šimport sql from 'sql-template-strings';\n+â”Š  â”Š 6â”Šimport { MyContext } from '../../context';\n â”Š 5â”Š 7â”Š\n â”Š 6â”Š 8â”Šdescribe('Mutation.addMessage', () => {\n â”Š 7â”Š 9â”Š  beforeEach(resetDb);\n â”Š 8â”Š10â”Š\n â”Š 9â”Š11â”Š  it('should add message to specified chat', async () => {\n+â”Š  â”Š12â”Š    const { rows } = await pool.query(sql`SELECT * FROM users WHERE id = 1`);\n+â”Š  â”Š13â”Š    const currentUser = rows[0];\n â”Š10â”Š14â”Š    const server = new ApolloServer({\n â”Š11â”Š15â”Š      schema,\n-â”Š12â”Š  â”Š      context: () => ({\n+â”Š  â”Š16â”Š      context: async () => ({\n â”Š13â”Š17â”Š        pubsub: new PubSub(),\n-â”Š14â”Š  â”Š        currentUser: users[0],\n+â”Š  â”Š18â”Š        currentUser,\n+â”Š  â”Š19â”Š        db: await pool.connect(),\n â”Š15â”Š20â”Š      }),\n+â”Š  â”Š21â”Š      formatResponse: (res: any, { context }: { context: MyContext }) => {\n+â”Š  â”Š22â”Š        context.db.release();\n+â”Š  â”Š23â”Š        return res;\n+â”Š  â”Š24â”Š      },\n â”Š16â”Š25â”Š    });\n â”Š17â”Š26â”Š\n â”Š18â”Š27â”Š    const { query, mutate } = createTestClient(server);\n```\n\n##### Changed tests&#x2F;mutations&#x2F;removeChat.test.ts\n```diff\n@@ -1,18 +1,27 @@\n â”Š 1â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n â”Š 2â”Š 2â”Šimport { ApolloServer, PubSub, gql } from 'apollo-server-express';\n â”Š 3â”Š 3â”Šimport schema from '../../schema';\n-â”Š 4â”Š  â”Šimport { resetDb, users } from '../../db';\n+â”Š  â”Š 4â”Šimport { resetDb, pool } from '../../db';\n+â”Š  â”Š 5â”Šimport sql from 'sql-template-strings';\n+â”Š  â”Š 6â”Šimport { MyContext } from '../../context';\n â”Š 5â”Š 7â”Š\n â”Š 6â”Š 8â”Šdescribe('Mutation.removeChat', () => {\n â”Š 7â”Š 9â”Š  beforeEach(resetDb);\n â”Š 8â”Š10â”Š\n â”Š 9â”Š11â”Š  it('removes chat by id', async () => {\n+â”Š  â”Š12â”Š    const { rows } = await pool.query(sql`SELECT * FROM users WHERE id = 1`);\n+â”Š  â”Š13â”Š    const currentUser = rows[0];\n â”Š10â”Š14â”Š    const server = new ApolloServer({\n â”Š11â”Š15â”Š      schema,\n-â”Š12â”Š  â”Š      context: () => ({\n+â”Š  â”Š16â”Š      context: async () => ({\n â”Š13â”Š17â”Š        pubsub: new PubSub(),\n-â”Š14â”Š  â”Š        currentUser: users[0],\n+â”Š  â”Š18â”Š        currentUser,\n+â”Š  â”Š19â”Š        db: await pool.connect(),\n â”Š15â”Š20â”Š      }),\n+â”Š  â”Š21â”Š      formatResponse: (res: any, { context }: { context: MyContext }) => {\n+â”Š  â”Š22â”Š        context.db.release();\n+â”Š  â”Š23â”Š        return res;\n+â”Š  â”Š24â”Š      },\n â”Š16â”Š25â”Š    });\n â”Š17â”Š26â”Š\n â”Š18â”Š27â”Š    const { query, mutate } = createTestClient(server);\n```\n\n##### Changed tests&#x2F;queries&#x2F;getChat.test.ts\n```diff\n@@ -1,15 +1,26 @@\n â”Š 1â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n â”Š 2â”Š 2â”Šimport { ApolloServer, gql } from 'apollo-server-express';\n â”Š 3â”Š 3â”Šimport schema from '../../schema';\n-â”Š 4â”Š  â”Šimport { users } from '../../db';\n+â”Š  â”Š 4â”Šimport { pool, resetDb } from '../../db';\n+â”Š  â”Š 5â”Šimport sql from 'sql-template-strings';\n+â”Š  â”Š 6â”Šimport { MyContext } from '../../context';\n â”Š 5â”Š 7â”Š\n â”Š 6â”Š 8â”Šdescribe('Query.chat', () => {\n+â”Š  â”Š 9â”Š  beforeEach(resetDb);\n+â”Š  â”Š10â”Š\n â”Š 7â”Š11â”Š  it('should fetch specified chat', async () => {\n+â”Š  â”Š12â”Š    const { rows } = await pool.query(sql`SELECT * FROM users WHERE id = 1`);\n+â”Š  â”Š13â”Š    const currentUser = rows[0];\n â”Š 8â”Š14â”Š    const server = new ApolloServer({\n â”Š 9â”Š15â”Š      schema,\n-â”Š10â”Š  â”Š      context: () => ({\n-â”Š11â”Š  â”Š        currentUser: users[0],\n+â”Š  â”Š16â”Š      context: async () => ({\n+â”Š  â”Š17â”Š        currentUser,\n+â”Š  â”Š18â”Š        db: await pool.connect(),\n â”Š12â”Š19â”Š      }),\n+â”Š  â”Š20â”Š      formatResponse: (res: any, { context }: { context: MyContext }) => {\n+â”Š  â”Š21â”Š        context.db.release();\n+â”Š  â”Š22â”Š        return res;\n+â”Š  â”Š23â”Š      },\n â”Š13â”Š24â”Š    });\n â”Š14â”Š25â”Š\n â”Š15â”Š26â”Š    const { query } = createTestClient(server);\n```\n\n##### Changed tests&#x2F;queries&#x2F;getChats.test.ts\n```diff\n@@ -1,15 +1,26 @@\n â”Š 1â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n â”Š 2â”Š 2â”Šimport { ApolloServer, gql } from 'apollo-server-express';\n â”Š 3â”Š 3â”Šimport schema from '../../schema';\n-â”Š 4â”Š  â”Šimport { users } from '../../db';\n+â”Š  â”Š 4â”Šimport { pool, resetDb } from '../../db';\n+â”Š  â”Š 5â”Šimport sql from 'sql-template-strings';\n+â”Š  â”Š 6â”Šimport { MyContext } from '../../context';\n â”Š 5â”Š 7â”Š\n â”Š 6â”Š 8â”Šdescribe('Query.chats', () => {\n+â”Š  â”Š 9â”Š  beforeEach(resetDb);\n+â”Š  â”Š10â”Š\n â”Š 7â”Š11â”Š  it('should fetch all chats', async () => {\n+â”Š  â”Š12â”Š    const { rows } = await pool.query(sql`SELECT * FROM users WHERE id = 1`);\n+â”Š  â”Š13â”Š    const currentUser = rows[0];\n â”Š 8â”Š14â”Š    const server = new ApolloServer({\n â”Š 9â”Š15â”Š      schema,\n-â”Š10â”Š  â”Š      context: () => ({\n-â”Š11â”Š  â”Š        currentUser: users[0],\n+â”Š  â”Š16â”Š      context: async () => ({\n+â”Š  â”Š17â”Š        currentUser,\n+â”Š  â”Š18â”Š        db: await pool.connect(),\n â”Š12â”Š19â”Š      }),\n+â”Š  â”Š20â”Š      formatResponse: (res: any, { context }: { context: MyContext }) => {\n+â”Š  â”Š21â”Š        context.db.release();\n+â”Š  â”Š22â”Š        return res;\n+â”Š  â”Š23â”Š      },\n â”Š13â”Š24â”Š    });\n â”Š14â”Š25â”Š\n â”Š15â”Š26â”Š    const { query } = createTestClient(server);\n```\n\n##### Changed tests&#x2F;queries&#x2F;getMe.test.ts\n```diff\n@@ -1,15 +1,24 @@\n â”Š 1â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n â”Š 2â”Š 2â”Šimport { ApolloServer, gql } from 'apollo-server-express';\n â”Š 3â”Š 3â”Šimport schema from '../../schema';\n-â”Š 4â”Š  â”Šimport { users } from '../../db';\n+â”Š  â”Š 4â”Šimport { pool } from '../../db';\n+â”Š  â”Š 5â”Šimport sql from 'sql-template-strings';\n+â”Š  â”Š 6â”Šimport { MyContext } from '../../context';\n â”Š 5â”Š 7â”Š\n â”Š 6â”Š 8â”Šdescribe('Query.me', () => {\n â”Š 7â”Š 9â”Š  it('should fetch current user', async () => {\n+â”Š  â”Š10â”Š    const { rows } = await pool.query(sql`SELECT * FROM users WHERE id = 1`);\n+â”Š  â”Š11â”Š    const currentUser = rows[0];\n â”Š 8â”Š12â”Š    const server = new ApolloServer({\n â”Š 9â”Š13â”Š      schema,\n-â”Š10â”Š  â”Š      context: () => ({\n-â”Š11â”Š  â”Š        currentUser: users[0],\n+â”Š  â”Š14â”Š      context: async () => ({\n+â”Š  â”Š15â”Š        currentUser,\n+â”Š  â”Š16â”Š        db: await pool.connect(),\n â”Š12â”Š17â”Š      }),\n+â”Š  â”Š18â”Š      formatResponse: (res: any, { context }: { context: MyContext }) => {\n+â”Š  â”Š19â”Š        context.db.release();\n+â”Š  â”Š20â”Š        return res;\n+â”Š  â”Š21â”Š      },\n â”Š13â”Š22â”Š    });\n â”Š14â”Š23â”Š\n â”Š15â”Š24â”Š    const { query } = createTestClient(server);\n```\n\n##### Changed tests&#x2F;queries&#x2F;getUsers.test.ts\n```diff\n@@ -1,15 +1,27 @@\n â”Š 1â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n â”Š 2â”Š 2â”Šimport { ApolloServer, gql } from 'apollo-server-express';\n â”Š 3â”Š 3â”Šimport schema from '../../schema';\n-â”Š 4â”Š  â”Šimport { users } from '../../db';\n+â”Š  â”Š 4â”Šimport { pool } from '../../db';\n+â”Š  â”Š 5â”Šimport sql from 'sql-template-strings';\n+â”Š  â”Š 6â”Šimport { MyContext } from '../../context';\n â”Š 5â”Š 7â”Š\n â”Š 6â”Š 8â”Šdescribe('Query.getUsers', () => {\n â”Š 7â”Š 9â”Š  it('should fetch all users except the one signed-in', async () => {\n-â”Š 8â”Š  â”Š    let currentUser = users[0];\n-â”Š 9â”Š  â”Š\n+â”Š  â”Š10â”Š    const firstUserQuery = await pool.query(\n+â”Š  â”Š11â”Š      sql`SELECT * FROM users WHERE id = 1`\n+â”Š  â”Š12â”Š    );\n+â”Š  â”Š13â”Š    let currentUser = firstUserQuery.rows[0];\n+â”Š  â”Š14â”Š    const db = await pool.connect();\n â”Š10â”Š15â”Š    const server = new ApolloServer({\n â”Š11â”Š16â”Š      schema,\n-â”Š12â”Š  â”Š      context: () => ({ currentUser }),\n+â”Š  â”Š17â”Š      context: async () => ({\n+â”Š  â”Š18â”Š        currentUser,\n+â”Š  â”Š19â”Š        db: await pool.connect(),\n+â”Š  â”Š20â”Š      }),\n+â”Š  â”Š21â”Š      formatResponse: (res: any, { context }: { context: MyContext }) => {\n+â”Š  â”Š22â”Š        context.db.release();\n+â”Š  â”Š23â”Š        return res;\n+â”Š  â”Š24â”Š      },\n â”Š13â”Š25â”Š    });\n â”Š14â”Š26â”Š\n â”Š15â”Š27â”Š    const { query } = createTestClient(server);\n```\n```diff\n@@ -30,7 +42,10 @@\n â”Š30â”Š42â”Š    expect(res.errors).toBeUndefined();\n â”Š31â”Š43â”Š    expect(res.data).toMatchSnapshot();\n â”Š32â”Š44â”Š\n-â”Š33â”Š  â”Š    currentUser = users[1];\n+â”Š  â”Š45â”Š    const secondUserQuery = await pool.query(\n+â”Š  â”Š46â”Š      sql`SELECT * FROM users WHERE id = '2'`\n+â”Š  â”Š47â”Š    );\n+â”Š  â”Š48â”Š    currentUser = secondUserQuery.rows[0];\n â”Š34â”Š49â”Š\n â”Š35â”Š50â”Š    res = await query({\n â”Š36â”Š51â”Š      query: gql`\n```\n\n[}]: #\n\n> Because we are running tests against a database, we need to first make sure they run serially, one after the other,\n> using Jest's `runInBand` option.\n> Also, because during the test we will access a resource (DB) that will keep living, we need to tell Jest to close itself\n> after the test is done, using the `forceExit` option\n\n[{]: <helper> (diffStep 11.8 files=\"package.json\" module=\"server\")\n\n#### [__Server__ Step 11.8: Updating Tests with SQL](https://github.com/Urigo/WhatsApp-Clone-Server/commit/a7996674bd819e4abc3f5fb8c2abb0b1f6414da0)\n\n##### Changed package.json\n```diff\n@@ -9,7 +9,7 @@\n â”Š 9â”Š 9â”Š  \"scripts\": {\n â”Š10â”Š10â”Š    \"prestart\": \"yarn codegen\",\n â”Š11â”Š11â”Š    \"start\": \"ts-node index.ts\",\n-â”Š12â”Š  â”Š    \"test\": \"TZ=\\\"Asia/Jerusalem\\\" jest\",\n+â”Š  â”Š12â”Š    \"test\": \"TZ=\\\"Asia/Jerusalem\\\" jest --runInBand --forceExit\",\n â”Š13â”Š13â”Š    \"codegen\": \"gql-gen\",\n â”Š14â”Š14â”Š    \"format\": \"prettier \\\"**/*.ts\\\" --write\"\n â”Š15â”Š15â”Š  },\n```\n\n[}]: #\n\n**Remove in-memory database**\n\nWe can remove all the stuff related to in-memory database now.\n\n[{]: <helper> (diffStep 11.9 files=\"db\" module=\"server\")\n\n#### [__Server__ Step 11.9: Removing in-memory database](https://github.com/Urigo/WhatsApp-Clone-Server/commit/964111ab4033b1ab2b45eb97189f4a0fe5b654fa)\n\n##### Changed db.ts\n```diff\n@@ -32,10 +32,6 @@\n â”Š32â”Š32â”Š\n â”Š33â”Š33â”Šexport let pool: Pool = new Pool(dbConfig);\n â”Š34â”Š34â”Š\n-â”Š35â”Š  â”Šexport const users: User[] = [];\n-â”Š36â”Š  â”Šexport const messages: Message[] = [];\n-â”Š37â”Š  â”Šexport const chats: Chat[] = [];\n-â”Š38â”Š  â”Š\n â”Š39â”Š35â”Šexport async function initDb(): Promise<void> {\n â”Š40â”Š36â”Š  // Clear tables\n â”Š41â”Š37â”Š  await pool.query(sql`DROP TABLE IF EXISTS messages;`);\n```\n\n[}]: #"
          },
          {
            "manualTitle": "Step 15: Using a REST API",
            "stepRevision": "67c60a80d4f31477a0a7696aa27e0e8e1d337707",
            "manualView": "Despite using GraphQL throughout all our app, we will soon meet the need to use some external API and chances are it will be REST.\nOur first idea could be to bridge the REST API through GraphQL, reproposing the very same API to the client. This approach is wrong, because our first concern should always be to provide the client with ready to use data in the best possible shape.\nThe client donâ€™t need to know that our GraphQL API is backed by a REST API, it doesnâ€™t have to pass headers required by the underlying API or do any kind of special considerations: our backend should take care of everything.\n\n## Retrieve a profile picture from a REST API\n\nIn this chapter we will discuss how to use an external API called Unsplash to retrieve random profile pictures for the users who didnâ€™t set any.\n\nStart heading to https://unsplash.com/developers and clicking on â€œRegister as a developerâ€. After registering you will have to create a new app: take note of the Access Key because weâ€™re going to need it.\n\nIf you look at the Documentation (https://unsplash.com/documentation#get-a-random-photo) youâ€™ll notice that in order to retrieve a random photo we have to query the /photos/random endpoint (GET method). We also have to pass some headers for the authent\ncation and some params for the search term and the orientation.\n\nOn the browser we would probably use the fetch api, but since on we node we would need a polyfill itâ€™s better to just use a full fledged library like axios:\n\n    yarn add axios\n    yarn add -D @types/axios\n\nBefore we start implementing, we want to create some typings for our endpoint, because ideally we would like to be aided by those typings during the development.\nIn order to do so we can use a Chrome extension like Advanced Rest Client to retrieve the response.\nSet the Method to GET, the Headers to Authorization: 'Client-ID 4d048cfb4383b407eff92e4a2a5ec36c0a866be85e64caafa588c110efad350d' and the Request URL to https://api.unsplash.com/photos/random, along with the params to query: 'portrait' and orientation: 'squarish'.\nCopy the response, create a new file called types/unsplash.ts in your vscode editor and run the command â€œPast JSON as Typesâ€ (you need to install the Past JSON as Code extension and press CTRL+P to open the run command prompt). That would be enough to automatically create the typings for the random photo endpoint.\n\nNow we can finally implement the REST API call in our picture resolver:\n\n[{]: <helper> (diffStep \"12.1\" files=\"schema/resolvers.ts\" module=\"server\")\n\n#### [__Server__ Step 12.1: Retrieve profile picture from REST API](https://github.com/Urigo/WhatsApp-Clone-Server/commit/4cfc0b3dfae323b8fddf7fd7da62fc0345ca7a78)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -7,6 +7,8 @@\n â”Š 7â”Š 7â”Šimport jwt from 'jsonwebtoken';\n â”Š 8â”Š 8â”Šimport { validateLength, validatePassword } from '../validators';\n â”Š 9â”Š 9â”Šimport sql from 'sql-template-strings';\n+â”Š  â”Š10â”Šimport axios from 'axios';\n+â”Š  â”Š11â”Šimport { RandomPhoto } from '../types/unsplash';\n â”Š10â”Š12â”Š\n â”Š11â”Š13â”Šconst resolvers: Resolvers = {\n â”Š12â”Š14â”Š  Date: GraphQLDateTime,\n```\n```diff\n@@ -70,7 +72,26 @@\n â”Š70â”Š72â”Š\n â”Š71â”Š73â”Š      const participant = rows[0];\n â”Š72â”Š74â”Š\n-â”Š73â”Š  â”Š      return participant ? participant.picture : null;\n+â”Š  â”Š75â”Š      if (participant && participant.picture) return participant.picture;\n+â”Š  â”Š76â”Š\n+â”Š  â”Š77â”Š      try {\n+â”Š  â”Š78â”Š        return (await axios.get<RandomPhoto>(\n+â”Š  â”Š79â”Š          'https://api.unsplash.com/photos/random',\n+â”Š  â”Š80â”Š          {\n+â”Š  â”Š81â”Š            params: {\n+â”Š  â”Š82â”Š              query: 'portrait',\n+â”Š  â”Š83â”Š              orientation: 'squarish',\n+â”Š  â”Š84â”Š            },\n+â”Š  â”Š85â”Š            headers: {\n+â”Š  â”Š86â”Š              Authorization:\n+â”Š  â”Š87â”Š                'Client-ID 4d048cfb4383b407eff92e4a2a5ec36c0a866be85e64caafa588c110efad350d',\n+â”Š  â”Š88â”Š            },\n+â”Š  â”Š89â”Š          }\n+â”Š  â”Š90â”Š        )).data.urls.small;\n+â”Š  â”Š91â”Š      } catch (err) {\n+â”Š  â”Š92â”Š        console.error('Cannot retrieve random photo:', err);\n+â”Š  â”Š93â”Š        return null;\n+â”Š  â”Š94â”Š      }\n â”Š74â”Š95â”Š    },\n â”Š75â”Š96â”Š\n â”Š76â”Š97â”Š    async messages(chat, args, { db }) {\n```\n\n[}]: #\n\nIn order to test it, we have to remove the picture from one of the users and re-run the server with the `RESET_DB=true` environment variable:\n\n[{]: <helper> (diffStep \"12.1\" files=\"db.ts\" module=\"server\")\n\n#### [__Server__ Step 12.1: Retrieve profile picture from REST API](https://github.com/Urigo/WhatsApp-Clone-Server/commit/4cfc0b3dfae323b8fddf7fd7da62fc0345ca7a78)\n\n##### Changed db.ts\n```diff\n@@ -123,6 +123,10 @@\n â”Š123â”Š123â”Š    sql`SELECT setval('users_id_seq', (SELECT max(id) FROM users))`\n â”Š124â”Š124â”Š  );\n â”Š125â”Š125â”Š\n+â”Š   â”Š126â”Š  await pool.query(\n+â”Š   â”Š127â”Š    sql`SELECT setval('users_id_seq', (SELECT max(id) FROM users))`\n+â”Š   â”Š128â”Š  );\n+â”Š   â”Š129â”Š\n â”Š126â”Š130â”Š  await pool.query(sql`DELETE FROM chats`);\n â”Š127â”Š131â”Š\n â”Š128â”Š132â”Š  const sampleChats = [\n```\n\n[}]: #\n\n\n## Track the API\n\nEven if our typings are working pretty well so far, not all REST APIs are versioned and the shape weâ€™ve got from the server could potentially change.\nIn order to keep an eye on it we could use the safe-api middleware in order to check for abnormal answers coming from the server and log them. We can also generate the typings automatically based on the response we get.\nFirst letâ€™s install the safe-api middleware:\n\n    yarn add @safe-api/middleware\n\nThen letâ€™s use it inside our resolver:\n\n[{]: <helper> (diffStep \"12.2\" files=\"schema/resolvers.ts\" module=\"server\")\n\n#### [__Server__ Step 12.2: Use safe-api](https://github.com/Urigo/WhatsApp-Clone-Server/commit/39d0a984e9f00331afd50753659b5c2048bbb21e)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -9,6 +9,8 @@\n â”Š 9â”Š 9â”Šimport sql from 'sql-template-strings';\n â”Š10â”Š10â”Šimport axios from 'axios';\n â”Š11â”Š11â”Šimport { RandomPhoto } from '../types/unsplash';\n+â”Š  â”Š12â”Šimport { trackProvider } from '@safe-api/middleware';\n+â”Š  â”Š13â”Šimport { resolve } from 'path';\n â”Š12â”Š14â”Š\n â”Š13â”Š15â”Šconst resolvers: Resolvers = {\n â”Š14â”Š16â”Š  Date: GraphQLDateTime,\n```\n```diff\n@@ -74,20 +76,38 @@\n â”Š 74â”Š 76â”Š\n â”Š 75â”Š 77â”Š      if (participant && participant.picture) return participant.picture;\n â”Š 76â”Š 78â”Š\n+â”Š   â”Š 79â”Š      interface RandomPhotoInput {\n+â”Š   â”Š 80â”Š        query: string;\n+â”Š   â”Š 81â”Š        orientation: 'landscape' | 'portrait' | 'squarish';\n+â”Š   â”Š 82â”Š      }\n+â”Š   â”Š 83â”Š\n+â”Š   â”Š 84â”Š      const trackedRandomPhoto = await trackProvider(\n+â”Š   â”Š 85â”Š        async ({ query, orientation }: RandomPhotoInput) =>\n+â”Š   â”Š 86â”Š          (await axios.get<RandomPhoto>(\n+â”Š   â”Š 87â”Š            'https://api.unsplash.com/photos/random',\n+â”Š   â”Š 88â”Š            {\n+â”Š   â”Š 89â”Š              params: {\n+â”Š   â”Š 90â”Š                query,\n+â”Š   â”Š 91â”Š                orientation,\n+â”Š   â”Š 92â”Š              },\n+â”Š   â”Š 93â”Š              headers: {\n+â”Š   â”Š 94â”Š                Authorization:\n+â”Š   â”Š 95â”Š                  'Client-ID 4d048cfb4383b407eff92e4a2a5ec36c0a866be85e64caafa588c110efad350d',\n+â”Š   â”Š 96â”Š              },\n+â”Š   â”Š 97â”Š            }\n+â”Š   â”Š 98â”Š          )).data,\n+â”Š   â”Š 99â”Š        {\n+â”Š   â”Š100â”Š          provider: 'Unsplash',\n+â”Š   â”Š101â”Š          method: 'RandomPhoto',\n+â”Š   â”Š102â”Š          location: resolve(__dirname, '../logs/main'),\n+â”Š   â”Š103â”Š        }\n+â”Š   â”Š104â”Š      );\n+â”Š   â”Š105â”Š\n â”Š 77â”Š106â”Š      try {\n-â”Š 78â”Š   â”Š        return (await axios.get<RandomPhoto>(\n-â”Š 79â”Š   â”Š          'https://api.unsplash.com/photos/random',\n-â”Š 80â”Š   â”Š          {\n-â”Š 81â”Š   â”Š            params: {\n-â”Š 82â”Š   â”Š              query: 'portrait',\n-â”Š 83â”Š   â”Š              orientation: 'squarish',\n-â”Š 84â”Š   â”Š            },\n-â”Š 85â”Š   â”Š            headers: {\n-â”Š 86â”Š   â”Š              Authorization:\n-â”Š 87â”Š   â”Š                'Client-ID 4d048cfb4383b407eff92e4a2a5ec36c0a866be85e64caafa588c110efad350d',\n-â”Š 88â”Š   â”Š            },\n-â”Š 89â”Š   â”Š          }\n-â”Š 90â”Š   â”Š        )).data.urls.small;\n+â”Š   â”Š107â”Š        return (await trackedRandomPhoto({\n+â”Š   â”Š108â”Š          query: 'portrait',\n+â”Š   â”Š109â”Š          orientation: 'squarish',\n+â”Š   â”Š110â”Š        })).urls.small;\n â”Š 91â”Š111â”Š      } catch (err) {\n â”Š 92â”Š112â”Š        console.error('Cannot retrieve random photo:', err);\n â”Š 93â”Š113â”Š        return null;\n```\n\n[}]: #\n\nNow launch the client in order to retrieve the picture field multiple times.\n\nIf you look inside the logs directory you will notice that it generated some graphql schema to represent the REST API. You will notice that each time we call the REST endpoint it generates a new schema, because a single response isnâ€™t generic enough to account for all possible responses. Ideally safe-api should be able to average multiple esponses in order to generate the least generic schema matching the given responses.\n\nNow we need to remove `types/unsplash.ts` and generate some Typescript typings out of the schema. Do do so we can use the graphql-code-generator:\n\n[{]: <helper> (diffStep \"12.3\" files=\".gitignore, codegen.yml\" module=\"server\")\n\n#### [__Server__ Step 12.3: Generate typings from safe-api](https://github.com/Urigo/WhatsApp-Clone-Server/commit/0da850c7d04bc9363c0c49efd8c7e6375ec969ed)\n\n##### Changed .gitignore\n```diff\n@@ -1,4 +1,5 @@\n â”Š1â”Š1â”Šnode_modules\n â”Š2â”Š2â”Šnpm-debug.log\n â”Š3â”Š3â”Štest-results/\n-â”Š4â”Š â”Štypes/graphql.d.tsðŸš«â†µ\n+â”Š â”Š4â”Štypes/graphql.d.ts\n+â”Š â”Š5â”Štypes/unsplash.d.tsðŸš«â†µ\n```\n\n##### Changed codegen.yml\n```diff\n@@ -1,7 +1,7 @@\n-â”Š1â”Š â”Šschema: ./schema/typeDefs.graphql\n â”Š2â”Š1â”Šoverwrite: true\n â”Š3â”Š2â”Šgenerates:\n â”Š4â”Š3â”Š  ./types/graphql.d.ts:\n+â”Š â”Š4â”Š    schema: ./schema/typeDefs.graphql\n â”Š5â”Š5â”Š    plugins:\n â”Š6â”Š6â”Š      - typescript\n â”Š7â”Š7â”Š      - typescript-resolvers\n```\n```diff\n@@ -16,3 +16,7 @@\n â”Š16â”Š16â”Š      scalars:\n â”Š17â”Š17â”Š        # e.g. Message.createdAt will be of type Date\n â”Š18â”Š18â”Š        Date: Date\n+â”Š  â”Š19â”Š  ./types/unsplash.d.ts:\n+â”Š  â”Š20â”Š    schema: ./logs/main/Unsplash.RandomPhoto.graphql\n+â”Š  â”Š21â”Š    plugins:\n+â”Š  â”Š22â”Š      - typescript\n```\n\n[}]: #\n\n    yarn codegen\n\n\n## Apollo DataSources\n\nWeâ€™re not done yet, there is still room for improvement. Instead of using axios, we could use Apolloâ€™s Data Sources and take advantage of the built-in support for caching, deduplication and error handling.\n\n    yarn remove axios @types/axios\n    yarn add apollo-datasource-rest\n\n[{]: <helper> (diffStep \"12.4\" files=\"schema/unsplash.api.ts\" module=\"server\")\n\n#### [__Server__ Step 12.4: Use Apollo DataSources](https://github.com/Urigo/WhatsApp-Clone-Server/commit/7bf9c2aef4ee4570c6f81c6e40a88703241e4b32)\n\n##### Added schema&#x2F;unsplash.api.ts\n```diff\n@@ -0,0 +1,45 @@\n+â”Š  â”Š 1â”Šimport { RESTDataSource, RequestOptions } from 'apollo-datasource-rest';\n+â”Š  â”Š 2â”Šimport { resolve } from 'path';\n+â”Š  â”Š 3â”Šimport { trackProvider } from '@safe-api/middleware';\n+â”Š  â”Š 4â”Šimport { RandomPhoto } from '../types/unsplash';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šinterface RandomPhotoInput {\n+â”Š  â”Š 7â”Š  query: string;\n+â”Š  â”Š 8â”Š  orientation: 'landscape' | 'portrait' | 'squarish';\n+â”Š  â”Š 9â”Š}\n+â”Š  â”Š10â”Š\n+â”Š  â”Š11â”Šexport class UnsplashApi extends RESTDataSource {\n+â”Š  â”Š12â”Š  constructor() {\n+â”Š  â”Š13â”Š    super();\n+â”Š  â”Š14â”Š    this.baseURL = 'https://api.unsplash.com/';\n+â”Š  â”Š15â”Š  }\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š  willSendRequest(request: RequestOptions) {\n+â”Š  â”Š18â”Š    request.headers.set(\n+â”Š  â”Š19â”Š      'Authorization',\n+â”Š  â”Š20â”Š      'Client-ID 4d048cfb4383b407eff92e4a2a5ec36c0a866be85e64caafa588c110efad350d'\n+â”Š  â”Š21â”Š    );\n+â”Š  â”Š22â”Š  }\n+â”Š  â”Š23â”Š\n+â”Š  â”Š24â”Š  async getRandomPhoto() {\n+â”Š  â”Š25â”Š    const trackedRandomPhoto = await trackProvider(\n+â”Š  â”Š26â”Š      ({ query, orientation }: RandomPhotoInput) =>\n+â”Š  â”Š27â”Š        this.get<RandomPhoto>('photos/random', { query, orientation }),\n+â”Š  â”Š28â”Š      {\n+â”Š  â”Š29â”Š        provider: 'Unsplash',\n+â”Š  â”Š30â”Š        method: 'RandomPhoto',\n+â”Š  â”Š31â”Š        location: resolve(__dirname, '../logs/main'),\n+â”Š  â”Š32â”Š      }\n+â”Š  â”Š33â”Š    );\n+â”Š  â”Š34â”Š\n+â”Š  â”Š35â”Š    try {\n+â”Š  â”Š36â”Š      return (await trackedRandomPhoto({\n+â”Š  â”Š37â”Š        query: 'portrait',\n+â”Š  â”Š38â”Š        orientation: 'squarish',\n+â”Š  â”Š39â”Š      })).urls.small;\n+â”Š  â”Š40â”Š    } catch (err) {\n+â”Š  â”Š41â”Š      console.error('Cannot retrieve random photo:', err);\n+â”Š  â”Š42â”Š      return null;\n+â”Š  â”Š43â”Š    }\n+â”Š  â”Š44â”Š  }\n+â”Š  â”Š45â”Š}\n```\n\n[}]: #\n\nWe created the UnsplashApi class, which extends RESTDataSource. In the constructor you need to set the baseUrl (after calling super() to run the constructor of the base class). You also need to create a willSendRequest method to set the authentication headers for each call. Then itâ€™s simply a matter of creating a getRandomPhoto method to perform the actual REST API call. Instead of calling axios you will have to call the get method of the class (which in turn gets inherited from its RESTDataSource base class): the API is very similar to the axios one.\n\nIn order to access the data source from the resolvers we need to tell Apollo to put them on the context for every request. We shouldnâ€™t use the context field, because that would lead to circular dependencies. Instead we need to use the dataSources field:\n\n[{]: <helper> (diffStep \"12.4\" files=\"index.ts\" module=\"server\")\n\n#### [__Server__ Step 12.4: Use Apollo DataSources](https://github.com/Urigo/WhatsApp-Clone-Server/commit/7bf9c2aef4ee4570c6f81c6e40a88703241e4b32)\n\n##### Changed index.ts\n```diff\n@@ -8,6 +8,7 @@\n â”Š 8â”Š 8â”Šimport schema from './schema';\n â”Š 9â”Š 9â”Šimport { MyContext } from './context';\n â”Š10â”Š10â”Šimport sql from 'sql-template-strings';\n+â”Š  â”Š11â”Šimport { UnsplashApi } from './schema/unsplash.api';\n â”Š11â”Š12â”Šconst { PostgresPubSub } = require('graphql-postgres-subscriptions');\n â”Š12â”Š13â”Š\n â”Š13â”Š14â”Šconst pubsub = new PostgresPubSub({\n```\n```diff\n@@ -67,6 +68,9 @@\n â”Š67â”Š68â”Š\n â”Š68â”Š69â”Š    return res;\n â”Š69â”Š70â”Š  },\n+â”Š  â”Š71â”Š  dataSources: () => ({\n+â”Š  â”Š72â”Š    unsplashApi: new UnsplashApi(),\n+â”Š  â”Š73â”Š  }),\n â”Š70â”Š74â”Š});\n â”Š71â”Š75â”Š\n â”Š72â”Š76â”Šserver.applyMiddleware({\n```\n\n[}]: #\n\nNow we need to update the typings for our context and run the graphq-code-generator again:\n\n[{]: <helper> (diffStep \"12.4\" files=\"context.ts\" module=\"server\")\n\n#### [__Server__ Step 12.4: Use Apollo DataSources](https://github.com/Urigo/WhatsApp-Clone-Server/commit/7bf9c2aef4ee4570c6f81c6e40a88703241e4b32)\n\n##### Changed context.ts\n```diff\n@@ -2,10 +2,14 @@\n â”Š 2â”Š 2â”Šimport { User } from './db';\n â”Š 3â”Š 3â”Šimport { Response } from 'express';\n â”Š 4â”Š 4â”Šimport { PoolClient } from 'pg';\n+â”Š  â”Š 5â”Šimport { UnsplashApi } from './schema/unsplash.api';\n â”Š 5â”Š 6â”Š\n â”Š 6â”Š 7â”Šexport type MyContext = {\n â”Š 7â”Š 8â”Š  pubsub: PubSub;\n â”Š 8â”Š 9â”Š  currentUser: User;\n â”Š 9â”Š10â”Š  res: Response;\n â”Š10â”Š11â”Š  db: PoolClient;\n+â”Š  â”Š12â”Š  dataSources: {\n+â”Š  â”Š13â”Š    unsplashApi: UnsplashApi;\n+â”Š  â”Š14â”Š  };\n â”Š11â”Š15â”Š};\n```\n\n[}]: #\n\n    yarn codegen\n\nNow it should be pretty easy to modify our resolver in order to use our just created datasource:\n\n[{]: <helper> (diffStep \"12.4\" files=\"schema/resolvers.ts\" module=\"server\")\n\n#### [__Server__ Step 12.4: Use Apollo DataSources](https://github.com/Urigo/WhatsApp-Clone-Server/commit/7bf9c2aef4ee4570c6f81c6e40a88703241e4b32)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -7,10 +7,6 @@\n â”Š 7â”Š 7â”Šimport jwt from 'jsonwebtoken';\n â”Š 8â”Š 8â”Šimport { validateLength, validatePassword } from '../validators';\n â”Š 9â”Š 9â”Šimport sql from 'sql-template-strings';\n-â”Š10â”Š  â”Šimport axios from 'axios';\n-â”Š11â”Š  â”Šimport { RandomPhoto } from '../types/unsplash';\n-â”Š12â”Š  â”Šimport { trackProvider } from '@safe-api/middleware';\n-â”Š13â”Š  â”Šimport { resolve } from 'path';\n â”Š14â”Š10â”Š\n â”Š15â”Š11â”Šconst resolvers: Resolvers = {\n â”Š16â”Š12â”Š  Date: GraphQLDateTime,\n```\n```diff\n@@ -63,7 +59,7 @@\n â”Š63â”Š59â”Š      return participant ? participant.name : null;\n â”Š64â”Š60â”Š    },\n â”Š65â”Š61â”Š\n-â”Š66â”Š  â”Š    async picture(chat, args, { currentUser, db }) {\n+â”Š  â”Š62â”Š    async picture(chat, args, { currentUser, db, dataSources }) {\n â”Š67â”Š63â”Š      if (!currentUser) return null;\n â”Š68â”Š64â”Š\n â”Š69â”Š65â”Š      const { rows } = await db.query(sql`\n```\n```diff\n@@ -74,44 +70,9 @@\n â”Š 74â”Š 70â”Š\n â”Š 75â”Š 71â”Š      const participant = rows[0];\n â”Š 76â”Š 72â”Š\n-â”Š 77â”Š   â”Š      if (participant && participant.picture) return participant.picture;\n-â”Š 78â”Š   â”Š\n-â”Š 79â”Š   â”Š      interface RandomPhotoInput {\n-â”Š 80â”Š   â”Š        query: string;\n-â”Š 81â”Š   â”Š        orientation: 'landscape' | 'portrait' | 'squarish';\n-â”Š 82â”Š   â”Š      }\n-â”Š 83â”Š   â”Š\n-â”Š 84â”Š   â”Š      const trackedRandomPhoto = await trackProvider(\n-â”Š 85â”Š   â”Š        async ({ query, orientation }: RandomPhotoInput) =>\n-â”Š 86â”Š   â”Š          (await axios.get<RandomPhoto>(\n-â”Š 87â”Š   â”Š            'https://api.unsplash.com/photos/random',\n-â”Š 88â”Š   â”Š            {\n-â”Š 89â”Š   â”Š              params: {\n-â”Š 90â”Š   â”Š                query,\n-â”Š 91â”Š   â”Š                orientation,\n-â”Š 92â”Š   â”Š              },\n-â”Š 93â”Š   â”Š              headers: {\n-â”Š 94â”Š   â”Š                Authorization:\n-â”Š 95â”Š   â”Š                  'Client-ID 4d048cfb4383b407eff92e4a2a5ec36c0a866be85e64caafa588c110efad350d',\n-â”Š 96â”Š   â”Š              },\n-â”Š 97â”Š   â”Š            }\n-â”Š 98â”Š   â”Š          )).data,\n-â”Š 99â”Š   â”Š        {\n-â”Š100â”Š   â”Š          provider: 'Unsplash',\n-â”Š101â”Š   â”Š          method: 'RandomPhoto',\n-â”Š102â”Š   â”Š          location: resolve(__dirname, '../logs/main'),\n-â”Š103â”Š   â”Š        }\n-â”Š104â”Š   â”Š      );\n-â”Š105â”Š   â”Š\n-â”Š106â”Š   â”Š      try {\n-â”Š107â”Š   â”Š        return (await trackedRandomPhoto({\n-â”Š108â”Š   â”Š          query: 'portrait',\n-â”Š109â”Š   â”Š          orientation: 'squarish',\n-â”Š110â”Š   â”Š        })).urls.small;\n-â”Š111â”Š   â”Š      } catch (err) {\n-â”Š112â”Š   â”Š        console.error('Cannot retrieve random photo:', err);\n-â”Š113â”Š   â”Š        return null;\n-â”Š114â”Š   â”Š      }\n+â”Š   â”Š 73â”Š      return participant && participant.picture\n+â”Š   â”Š 74â”Š        ? participant.picture\n+â”Š   â”Š 75â”Š        : dataSources.unsplashApi.getRandomPhoto();\n â”Š115â”Š 76â”Š    },\n â”Š116â”Š 77â”Š\n â”Š117â”Š 78â”Š    async messages(chat, args, { db }) {\n```\n\n[}]: #"
          },
          {
            "manualTitle": "Step 16: Modularity",
            "stepRevision": "3bfc7f61cf056a15ceae3dd6e355d58bd33e8046",
            "manualView": "This chapter is focused entirely on how to organize a GraphQL API. By far, our project's schema looks simple and keeping SDL and resolvers in two files is really enough.\n\n## Issues we face when GraphQL API grows\n\nUsually, every app starts small and the difficulty of maintenance grows while features are being implemented. I believe that you should always start small and see how a project involves. You could look up many articles about best practices of organising a project but they bring no benefit when your project is small. You don't want to jump between files in order to find what you're looking for, it should be intuitive. I agree a proper folder structure helps but if your schema has 100 lines of code then it makes no sense to split it into 5 files with 20 LOC each. The schema is so small that it won't hurt you when you hit the wall and separation will be necessary but until it happens you can easily move on with the project.\n\nBigger project means more people, more people means teams. In the current state of the app, they might interrupt each other and that eventually affects productivity.\nLack of separation makes the schema harder to maintain, especially once it grows rapidly.\n\n## That's why modularity is a thing!\n\nIn order to improve and solve those issues we would have to split an API into many pieces.\nThose might be files, even folders, doesn't really matter because the goal is to keep relevant chunks of code in one place, conceptually called module.\n\nIf done right, one team won't disturb another and it also helps to understand an entire codebase just by looking at those modules or even learn a feature because everything related to it is within a single module.\n\nThere's also a very important aspect, reusability. Most APIs have something in common, the first thing that comes to mind is authentication and user mechanism in general.\nWhen working with modules, it gets easier to share those.\n\n## Many ways to organize an API\n\nGraphQL specification explains just the language and how to form an API. Managing codebase, that's on our side.\n\nSince we're talking about modularity, let's see possible implementations.\n\nThe first thing on mind are files and folders. Putting relevant logic in a file won't scale well once we add more things, like business logic for example. Which means we need folders, that's for sure.\n\nOkay, so the next question, how to store SDL and resolvers. Do we want to have them stored together or keep them separated?\n\nI'm a big fan of the former because in schema-first approach the SDL is written first and you see exactly how to construct resolvers. The latter would require to jump between files or have them opened side-by-side.\nAnother benefit shows up when you add, remove or just change part of a schema, less likely that you'll miss something.\n\nBut as always, there are things you can't do with that approach.\nOne that pops into my head right away is an IDE supportâ€¦ ?\n< guys, any ideas? >\n\nLet's talk about modularity in terms of SDL.\nWe know how to define types in GraphQL but what if a type is a sum of many features?\nThere two ways to do it. One is to use the `extend` keyword, another to define a type multiple type. Both gave the same effect, all is merged into one type after all.\n\nBut there are few major differences.\n\nThe `extend` keyword is obviously a part of the specification so IDEs and most tools support it. It feels more natural than the second option.\n\nDefining the same type multiple times is the opposite. It might feel odd, not many IDEs and\ntools support it so you have to add a library that handles it but on the other way you don't care if there's already a type or not, you just make sure there's one with proper fields, no matter what. It might also warn you when fields overlap.\n\n## Modularized schema\n\nThere are couple solutions to help you modularize the schema and we will look at 3 of them.\n\nFirst, let's start by defining 3 modules:\n\n- common - things we want to share with all the rest\n- users - everything related to users\n- chats - core logic of WhatsApp\n\n### Using directories\n\nThe simplest and most obvious solution would be to split what we have and move that into directories.\n\nStarting with common module. We need to create a folder at `/modules/common` and a `index.ts` file in it:\n\n[{]: <helper> (diffStep \"13.1\" files=\"modules/common/index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.1: Modularize schema](https://github.com/Urigo/WhatsApp-Clone-Server/commit/7be36f4a336712a4ef2de692cb492e04d919cac8)\n\n##### Added modules&#x2F;common&#x2F;index.ts\n```diff\n@@ -0,0 +1,23 @@\n+â”Š  â”Š 1â”Šimport { gql } from 'apollo-server-express';\n+â”Š  â”Š 2â”Šimport { GraphQLDateTime } from 'graphql-iso-date';\n+â”Š  â”Š 3â”Šimport { Resolvers } from '../../types/graphql';\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šexport const typeDefs = gql`\n+â”Š  â”Š 6â”Š  scalar Date\n+â”Š  â”Š 7â”Š\n+â”Š  â”Š 8â”Š  type Query {\n+â”Š  â”Š 9â”Š    _dummy: Boolean\n+â”Š  â”Š10â”Š  }\n+â”Š  â”Š11â”Š\n+â”Š  â”Š12â”Š  type Mutation {\n+â”Š  â”Š13â”Š    _dummy: Boolean\n+â”Š  â”Š14â”Š  }\n+â”Š  â”Š15â”Š\n+â”Š  â”Š16â”Š  type Subscription {\n+â”Š  â”Š17â”Š    _dummy: Boolean\n+â”Š  â”Š18â”Š  }\n+â”Š  â”Š19â”Š`;\n+â”Š  â”Š20â”Š\n+â”Š  â”Š21â”Šexport const resolvers: Resolvers = {\n+â”Š  â”Š22â”Š  Date: GraphQLDateTime,\n+â”Š  â”Š23â”Š};\n```\n\n[}]: #\n\nYou can see a pattern here, two things are being exported, one with type definitions and the other with resolvers. Why those `_dummy` fields? We want to use `extend` keyword, that require a base type and GraphQL doesn't accept empty objects.\n\nNow, let's do the same but with Users module:\n\n[{]: <helper> (diffStep \"13.1\" files=\"modules/users/index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.1: Modularize schema](https://github.com/Urigo/WhatsApp-Clone-Server/commit/7be36f4a336712a4ef2de692cb492e04d919cac8)\n\n##### Added modules&#x2F;users&#x2F;index.ts\n```diff\n@@ -0,0 +1,100 @@\n+â”Š   â”Š  1â”Šimport { gql } from 'apollo-server-express';\n+â”Š   â”Š  2â”Šimport sql from 'sql-template-strings';\n+â”Š   â”Š  3â”Šimport bcrypt from 'bcrypt';\n+â”Š   â”Š  4â”Šimport jwt from 'jsonwebtoken';\n+â”Š   â”Š  5â”Šimport { secret, expiration } from '../../env';\n+â”Š   â”Š  6â”Šimport { validateLength, validatePassword } from '../../validators';\n+â”Š   â”Š  7â”Šimport { Resolvers } from '../../types/graphql';\n+â”Š   â”Š  8â”Š\n+â”Š   â”Š  9â”Šexport const typeDefs = gql`\n+â”Š   â”Š 10â”Š  type User {\n+â”Š   â”Š 11â”Š    id: ID!\n+â”Š   â”Š 12â”Š    name: String!\n+â”Š   â”Š 13â”Š    picture: String\n+â”Š   â”Š 14â”Š  }\n+â”Š   â”Š 15â”Š\n+â”Š   â”Š 16â”Š  extend type Query {\n+â”Š   â”Š 17â”Š    me: User\n+â”Š   â”Š 18â”Š    users: [User!]!\n+â”Š   â”Š 19â”Š  }\n+â”Š   â”Š 20â”Š\n+â”Š   â”Š 21â”Š  extend type Mutation {\n+â”Š   â”Š 22â”Š    signIn(username: String!, password: String!): User\n+â”Š   â”Š 23â”Š    signUp(\n+â”Š   â”Š 24â”Š      name: String!\n+â”Š   â”Š 25â”Š      username: String!\n+â”Š   â”Š 26â”Š      password: String!\n+â”Š   â”Š 27â”Š      passwordConfirm: String!\n+â”Š   â”Š 28â”Š    ): User\n+â”Š   â”Š 29â”Š  }\n+â”Š   â”Š 30â”Š`;\n+â”Š   â”Š 31â”Š\n+â”Š   â”Š 32â”Šexport const resolvers: Resolvers = {\n+â”Š   â”Š 33â”Š  Query: {\n+â”Š   â”Š 34â”Š    me(root, args, { currentUser }) {\n+â”Š   â”Š 35â”Š      return currentUser || null;\n+â”Š   â”Š 36â”Š    },\n+â”Š   â”Š 37â”Š    async users(root, args, { currentUser, db }) {\n+â”Š   â”Š 38â”Š      if (!currentUser) return [];\n+â”Š   â”Š 39â”Š\n+â”Š   â”Š 40â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š 41â”Š        SELECT * FROM users WHERE users.id != ${currentUser.id}\n+â”Š   â”Š 42â”Š      `);\n+â”Š   â”Š 43â”Š\n+â”Š   â”Š 44â”Š      return rows;\n+â”Š   â”Š 45â”Š    },\n+â”Š   â”Š 46â”Š  },\n+â”Š   â”Š 47â”Š  Mutation: {\n+â”Š   â”Š 48â”Š    async signIn(root, { username, password }, { db, res }) {\n+â”Š   â”Š 49â”Š      const { rows } = await db.query(\n+â”Š   â”Š 50â”Š        sql`SELECT * FROM users WHERE username = ${username}`\n+â”Š   â”Š 51â”Š      );\n+â”Š   â”Š 52â”Š      const user = rows[0];\n+â”Š   â”Š 53â”Š\n+â”Š   â”Š 54â”Š      if (!user) {\n+â”Š   â”Š 55â”Š        throw new Error('user not found');\n+â”Š   â”Š 56â”Š      }\n+â”Š   â”Š 57â”Š\n+â”Š   â”Š 58â”Š      const passwordsMatch = bcrypt.compareSync(password, user.password);\n+â”Š   â”Š 59â”Š\n+â”Š   â”Š 60â”Š      if (!passwordsMatch) {\n+â”Š   â”Š 61â”Š        throw new Error('password is incorrect');\n+â”Š   â”Š 62â”Š      }\n+â”Š   â”Š 63â”Š\n+â”Š   â”Š 64â”Š      const authToken = jwt.sign(username, secret);\n+â”Š   â”Š 65â”Š\n+â”Š   â”Š 66â”Š      res.cookie('authToken', authToken, { maxAge: expiration });\n+â”Š   â”Š 67â”Š\n+â”Š   â”Š 68â”Š      return user;\n+â”Š   â”Š 69â”Š    },\n+â”Š   â”Š 70â”Š\n+â”Š   â”Š 71â”Š    async signUp(root, { name, username, password, passwordConfirm }, { db }) {\n+â”Š   â”Š 72â”Š      validateLength('req.name', name, 3, 50);\n+â”Š   â”Š 73â”Š      validateLength('req.username', username, 3, 18);\n+â”Š   â”Š 74â”Š      validatePassword('req.password', password);\n+â”Š   â”Š 75â”Š\n+â”Š   â”Š 76â”Š      if (password !== passwordConfirm) {\n+â”Š   â”Š 77â”Š        throw Error(\"req.password and req.passwordConfirm don't match\");\n+â”Š   â”Š 78â”Š      }\n+â”Š   â”Š 79â”Š\n+â”Š   â”Š 80â”Š      const existingUserQuery = await db.query(\n+â”Š   â”Š 81â”Š        sql`SELECT * FROM users WHERE username = ${username}`\n+â”Š   â”Š 82â”Š      );\n+â”Š   â”Š 83â”Š      if (existingUserQuery.rows[0]) {\n+â”Š   â”Š 84â”Š        throw Error('username already exists');\n+â”Š   â”Š 85â”Š      }\n+â”Š   â”Š 86â”Š\n+â”Š   â”Š 87â”Š      const passwordHash = bcrypt.hashSync(password, bcrypt.genSaltSync(8));\n+â”Š   â”Š 88â”Š\n+â”Š   â”Š 89â”Š      const createdUserQuery = await db.query(sql`\n+â”Š   â”Š 90â”Š        INSERT INTO users(password, picture, username, name)\n+â”Š   â”Š 91â”Š        VALUES(${passwordHash}, '', ${username}, ${name})\n+â”Š   â”Š 92â”Š        RETURNING *\n+â”Š   â”Š 93â”Š      `);\n+â”Š   â”Š 94â”Š\n+â”Š   â”Š 95â”Š      const user = createdUserQuery.rows[0];\n+â”Š   â”Š 96â”Š\n+â”Š   â”Š 97â”Š      return user;\n+â”Š   â”Š 98â”Š    },\n+â”Š   â”Š 99â”Š  },\n+â”Š   â”Š100â”Š};\n```\n\n[}]: #\n\nAnd Chats module:\n\n[{]: <helper> (diffStep \"13.1\" files=\"modules/chats/index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.1: Modularize schema](https://github.com/Urigo/WhatsApp-Clone-Server/commit/7be36f4a336712a4ef2de692cb492e04d919cac8)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,16 +1,47 @@\n-â”Š 1â”Š  â”Šimport { withFilter } from 'apollo-server-express';\n-â”Š 2â”Š  â”Šimport { GraphQLDateTime } from 'graphql-iso-date';\n-â”Š 3â”Š  â”Šimport { Message, Chat, pool } from '../db';\n-â”Š 4â”Š  â”Šimport { Resolvers } from '../types/graphql';\n-â”Š 5â”Š  â”Šimport { secret, expiration } from '../env';\n-â”Š 6â”Š  â”Šimport bcrypt from 'bcrypt';\n-â”Š 7â”Š  â”Šimport jwt from 'jsonwebtoken';\n-â”Š 8â”Š  â”Šimport { validateLength, validatePassword } from '../validators';\n+â”Š  â”Š 1â”Šimport { gql, withFilter } from 'apollo-server-express';\n â”Š 9â”Š 2â”Šimport sql from 'sql-template-strings';\n-â”Š10â”Š  â”Š\n-â”Š11â”Š  â”Šconst resolvers: Resolvers = {\n-â”Š12â”Š  â”Š  Date: GraphQLDateTime,\n-â”Š13â”Š  â”Š\n+â”Š  â”Š 3â”Šimport { Message, Chat, pool } from '../../db';\n+â”Š  â”Š 4â”Šimport { Resolvers } from '../../types/graphql';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šexport const typeDefs = gql`\n+â”Š  â”Š 7â”Š  type Message {\n+â”Š  â”Š 8â”Š    id: ID!\n+â”Š  â”Š 9â”Š    content: String!\n+â”Š  â”Š10â”Š    createdAt: Date!\n+â”Š  â”Š11â”Š    chat: Chat\n+â”Š  â”Š12â”Š    sender: User\n+â”Š  â”Š13â”Š    recipient: User\n+â”Š  â”Š14â”Š    isMine: Boolean!\n+â”Š  â”Š15â”Š  }\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š  type Chat {\n+â”Š  â”Š18â”Š    id: ID!\n+â”Š  â”Š19â”Š    name: String\n+â”Š  â”Š20â”Š    picture: String\n+â”Š  â”Š21â”Š    lastMessage: Message\n+â”Š  â”Š22â”Š    messages: [Message!]!\n+â”Š  â”Š23â”Š    participants: [User!]!\n+â”Š  â”Š24â”Š  }\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Š  extend type Query {\n+â”Š  â”Š27â”Š    chats: [Chat!]!\n+â”Š  â”Š28â”Š    chat(chatId: ID!): Chat\n+â”Š  â”Š29â”Š  }\n+â”Š  â”Š30â”Š\n+â”Š  â”Š31â”Š  extend type Mutation {\n+â”Š  â”Š32â”Š    addMessage(chatId: ID!, content: String!): Message\n+â”Š  â”Š33â”Š    addChat(recipientId: ID!): Chat\n+â”Š  â”Š34â”Š    removeChat(chatId: ID!): ID\n+â”Š  â”Š35â”Š  }\n+â”Š  â”Š36â”Š\n+â”Š  â”Š37â”Š  extend type Subscription {\n+â”Š  â”Š38â”Š    messageAdded: Message!\n+â”Š  â”Š39â”Š    chatAdded: Chat!\n+â”Š  â”Š40â”Š    chatRemoved: ID!\n+â”Š  â”Š41â”Š  }\n+â”Š  â”Š42â”Š`;\n+â”Š  â”Š43â”Š\n+â”Š  â”Š44â”Šexport const resolvers: Resolvers = {\n â”Š14â”Š45â”Š  Message: {\n â”Š15â”Š46â”Š    createdAt(message) {\n â”Š16â”Š47â”Š      return new Date(message.created_at);\n```\n```diff\n@@ -105,10 +136,6 @@\n â”Š105â”Š136â”Š  },\n â”Š106â”Š137â”Š\n â”Š107â”Š138â”Š  Query: {\n-â”Š108â”Š   â”Š    me(root, args, { currentUser }) {\n-â”Š109â”Š   â”Š      return currentUser || null;\n-â”Š110â”Š   â”Š    },\n-â”Š111â”Š   â”Š\n â”Š112â”Š139â”Š    async chats(root, args, { currentUser, db }) {\n â”Š113â”Š140â”Š      if (!currentUser) return [];\n â”Š114â”Š141â”Š\n```\n```diff\n@@ -133,71 +160,9 @@\n â”Š133â”Š160â”Š\n â”Š134â”Š161â”Š      return rows[0] ? rows[0] : null;\n â”Š135â”Š162â”Š    },\n-â”Š136â”Š   â”Š\n-â”Š137â”Š   â”Š    async users(root, args, { currentUser, db }) {\n-â”Š138â”Š   â”Š      if (!currentUser) return [];\n-â”Š139â”Š   â”Š\n-â”Š140â”Š   â”Š      const { rows } = await db.query(sql`\n-â”Š141â”Š   â”Š        SELECT * FROM users WHERE users.id != ${currentUser.id}\n-â”Š142â”Š   â”Š      `);\n-â”Š143â”Š   â”Š\n-â”Š144â”Š   â”Š      return rows;\n-â”Š145â”Š   â”Š    },\n â”Š146â”Š163â”Š  },\n â”Š147â”Š164â”Š\n â”Š148â”Š165â”Š  Mutation: {\n-â”Š149â”Š   â”Š    async signIn(root, { username, password }, { db, res }) {\n-â”Š150â”Š   â”Š      const { rows } = await db.query(\n-â”Š151â”Š   â”Š        sql`SELECT * FROM users WHERE username = ${username}`\n-â”Š152â”Š   â”Š      );\n-â”Š153â”Š   â”Š      const user = rows[0];\n-â”Š154â”Š   â”Š\n-â”Š155â”Š   â”Š      if (!user) {\n-â”Š156â”Š   â”Š        throw new Error('user not found');\n-â”Š157â”Š   â”Š      }\n-â”Š158â”Š   â”Š\n-â”Š159â”Š   â”Š      const passwordsMatch = bcrypt.compareSync(password, user.password);\n-â”Š160â”Š   â”Š\n-â”Š161â”Š   â”Š      if (!passwordsMatch) {\n-â”Š162â”Š   â”Š        throw new Error('password is incorrect');\n-â”Š163â”Š   â”Š      }\n-â”Š164â”Š   â”Š\n-â”Š165â”Š   â”Š      const authToken = jwt.sign(username, secret);\n-â”Š166â”Š   â”Š\n-â”Š167â”Š   â”Š      res.cookie('authToken', authToken, { maxAge: expiration });\n-â”Š168â”Š   â”Š\n-â”Š169â”Š   â”Š      return user;\n-â”Š170â”Š   â”Š    },\n-â”Š171â”Š   â”Š\n-â”Š172â”Š   â”Š    async signUp(root, { name, username, password, passwordConfirm }, { db }) {\n-â”Š173â”Š   â”Š      validateLength('req.name', name, 3, 50);\n-â”Š174â”Š   â”Š      validateLength('req.username', username, 3, 18);\n-â”Š175â”Š   â”Š      validatePassword('req.password', password);\n-â”Š176â”Š   â”Š\n-â”Š177â”Š   â”Š      if (password !== passwordConfirm) {\n-â”Š178â”Š   â”Š        throw Error(\"req.password and req.passwordConfirm don't match\");\n-â”Š179â”Š   â”Š      }\n-â”Š180â”Š   â”Š\n-â”Š181â”Š   â”Š      const existingUserQuery = await db.query(\n-â”Š182â”Š   â”Š        sql`SELECT * FROM users WHERE username = ${username}`\n-â”Š183â”Š   â”Š      );\n-â”Š184â”Š   â”Š      if (existingUserQuery.rows[0]) {\n-â”Š185â”Š   â”Š        throw Error('username already exists');\n-â”Š186â”Š   â”Š      }\n-â”Š187â”Š   â”Š\n-â”Š188â”Š   â”Š      const passwordHash = bcrypt.hashSync(password, bcrypt.genSaltSync(8));\n-â”Š189â”Š   â”Š\n-â”Š190â”Š   â”Š      const createdUserQuery = await db.query(sql`\n-â”Š191â”Š   â”Š        INSERT INTO users(password, picture, username, name)\n-â”Š192â”Š   â”Š        VALUES(${passwordHash}, '', ${username}, ${name})\n-â”Š193â”Š   â”Š        RETURNING *\n-â”Š194â”Š   â”Š      `);\n-â”Š195â”Š   â”Š\n-â”Š196â”Š   â”Š      const user = createdUserQuery.rows[0];\n-â”Š197â”Š   â”Š\n-â”Š198â”Š   â”Š      return user;\n-â”Š199â”Š   â”Š    },\n-â”Š200â”Š   â”Š\n â”Š201â”Š166â”Š    async addMessage(root, { chatId, content }, { currentUser, pubsub, db }) {\n â”Š202â”Š167â”Š      if (!currentUser) return null;\n â”Š203â”Š168â”Š\n```\n```diff\n@@ -360,5 +325,3 @@\n â”Š360â”Š325â”Š    },\n â”Š361â”Š326â”Š  },\n â”Š362â”Š327â”Š};\n-â”Š363â”Š   â”Š\n-â”Š364â”Š   â”Šexport default resolvers;\n```\n\n[}]: #\n\nSeems like modules are ready but we still need to create a Schema out of them.\n\n[{]: <helper> (diffStep \"13.1\" files=\"schema/index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.1: Modularize schema](https://github.com/Urigo/WhatsApp-Clone-Server/commit/7be36f4a336712a4ef2de692cb492e04d919cac8)\n\n##### Changed schema&#x2F;index.ts\n```diff\n@@ -1,10 +1,15 @@\n-â”Š 1â”Š  â”Šimport { importSchema } from 'graphql-import';\n â”Š 2â”Š 1â”Šimport { makeExecutableSchema, IResolvers } from 'graphql-tools';\n-â”Š 3â”Š  â”Šimport resolvers from './resolvers';\n-â”Š 4â”Š  â”Š\n-â”Š 5â”Š  â”Šconst typeDefs = importSchema('schema/typeDefs.graphql');\n+â”Š  â”Š 2â”Šimport { merge } from 'lodash';\n+â”Š  â”Š 3â”Šimport * as commonModule from '../modules/common';\n+â”Š  â”Š 4â”Šimport * as usersModule from '../modules/users';\n+â”Š  â”Š 5â”Šimport * as chatsModule from '../modules/chats';\n â”Š 6â”Š 6â”Š\n â”Š 7â”Š 7â”Šexport default makeExecutableSchema({\n-â”Š 8â”Š  â”Š  resolvers: resolvers as IResolvers,\n-â”Š 9â”Š  â”Š  typeDefs,\n+â”Š  â”Š 8â”Š  resolvers: merge(\n+â”Š  â”Š 9â”Š    {},\n+â”Š  â”Š10â”Š    commonModule.resolvers,\n+â”Š  â”Š11â”Š    usersModule.resolvers,\n+â”Š  â”Š12â”Š    chatsModule.resolvers\n+â”Š  â”Š13â”Š  ) as IResolvers,\n+â”Š  â”Š14â”Š  typeDefs: [commonModule.typeDefs, usersModule.typeDefs, chatsModule.typeDefs],\n â”Š10â”Š15â”Š});\n```\n\n[}]: #\n\nBecause we moved everything from `resolvers.ts` and `typeDefs.graphql` files, those can now be removed.\n\nThe last thing we need to adjust is the GraphQL Code Generator's config, in `codegen.yml`:\n\n[{]: <helper> (diffStep \"13.1\" files=\"codegen.yml\" module=\"server\")\n\n#### [__Server__ Step 13.1: Modularize schema](https://github.com/Urigo/WhatsApp-Clone-Server/commit/7be36f4a336712a4ef2de692cb492e04d919cac8)\n\n##### Changed codegen.yml\n```diff\n@@ -1,7 +1,7 @@\n â”Š1â”Š1â”Šoverwrite: true\n â”Š2â”Š2â”Šgenerates:\n â”Š3â”Š3â”Š  ./types/graphql.d.ts:\n-â”Š4â”Š â”Š    schema: ./schema/typeDefs.graphql\n+â”Š â”Š4â”Š    schema: ./modules/*/index.ts\n â”Š5â”Š5â”Š    plugins:\n â”Š6â”Š6â”Š      - typescript\n â”Š7â”Š7â”Š      - typescript-resolvers\n```\n\n[}]: #\n\nWe no longer keep all type definitions in one place and all documents are wrapped with `gql` tag, the codegen is smart enough to find those.\n\n### Using Apollo Modules\n\nAn alternative to the previous solution and far more interesting is a module feature of Apollo Server.\n\nLet's see how it all might look like when using Apollo Server's modules:\n\n[{]: <helper> (diffStep \"13.2\" files=\"index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.2: Use Apollo Modules](https://github.com/Urigo/WhatsApp-Clone-Server/commit/991ad9ac02cf17beac14a06a922cb4b0bae38741)\n\n##### Changed index.ts\n```diff\n@@ -5,12 +5,15 @@\n â”Š 5â”Š 5â”Šimport { app } from './app';\n â”Š 6â”Š 6â”Šimport { pool } from './db';\n â”Š 7â”Š 7â”Šimport { origin, port, secret } from './env';\n-â”Š 8â”Š  â”Šimport schema from './schema';\n â”Š 9â”Š 8â”Šimport { MyContext } from './context';\n â”Š10â”Š 9â”Šimport sql from 'sql-template-strings';\n â”Š11â”Š10â”Šimport { UnsplashApi } from './schema/unsplash.api';\n â”Š12â”Š11â”Šconst { PostgresPubSub } = require('graphql-postgres-subscriptions');\n â”Š13â”Š12â”Š\n+â”Š  â”Š13â”Šimport * as commonModule from './modules/common';\n+â”Š  â”Š14â”Šimport * as usersModule from './modules/users';\n+â”Š  â”Š15â”Šimport * as chatsModule from './modules/chats';\n+â”Š  â”Š16â”Š\n â”Š14â”Š17â”Šconst pubsub = new PostgresPubSub({\n â”Š15â”Š18â”Š  host: 'localhost',\n â”Š16â”Š19â”Š  port: process.env.DB_PORT ? parseInt(process.env.DB_PORT) : 5432,\n```\n```diff\n@@ -19,7 +22,7 @@\n â”Š19â”Š22â”Š  database: 'whatsapp',\n â”Š20â”Š23â”Š});\n â”Š21â”Š24â”Šconst server = new ApolloServer({\n-â”Š22â”Š  â”Š  schema,\n+â”Š  â”Š25â”Š  modules: [commonModule, usersModule, chatsModule],\n â”Š23â”Š26â”Š  context: async (session: any) => {\n â”Š24â”Š27â”Š    // Access the request object\n â”Š25â”Š28â”Š    let req = session.connection\n```\n\n##### Deleted schema&#x2F;index.ts\n```diff\n@@ -1,15 +0,0 @@\n-â”Š 1â”Š  â”Šimport { makeExecutableSchema, IResolvers } from 'graphql-tools';\n-â”Š 2â”Š  â”Šimport { merge } from 'lodash';\n-â”Š 3â”Š  â”Šimport * as commonModule from '../modules/common';\n-â”Š 4â”Š  â”Šimport * as usersModule from '../modules/users';\n-â”Š 5â”Š  â”Šimport * as chatsModule from '../modules/chats';\n-â”Š 6â”Š  â”Š\n-â”Š 7â”Š  â”Šexport default makeExecutableSchema({\n-â”Š 8â”Š  â”Š  resolvers: merge(\n-â”Š 9â”Š  â”Š    {},\n-â”Š10â”Š  â”Š    commonModule.resolvers,\n-â”Š11â”Š  â”Š    usersModule.resolvers,\n-â”Š12â”Š  â”Š    chatsModule.resolvers\n-â”Š13â”Š  â”Š  ) as IResolvers,\n-â”Š14â”Š  â”Š  typeDefs: [commonModule.typeDefs, usersModule.typeDefs, chatsModule.typeDefs],\n-â”Š15â”Š  â”Š});\n```\n\n[}]: #\n\nThe `modules` of ApolloServer accepts an array of objects with `resolvers` and `typeDefs` properties. That's exactly what we exported and that's why we can use esmodules directly.\n\nBecause we no longer use `schema.ts`, let's remove it.\n\nIf you would run the server right now, you will see a lot of warnings about missing index signatures. It's definitely nothing to worry about and can be easily fixed by using `useIndexSignature` flag of codegen:\n\n[{]: <helper> (diffStep \"13.2\" files=\"codegen.yml\" module=\"server\")\n\n#### [__Server__ Step 13.2: Use Apollo Modules](https://github.com/Urigo/WhatsApp-Clone-Server/commit/991ad9ac02cf17beac14a06a922cb4b0bae38741)\n\n##### Changed codegen.yml\n```diff\n@@ -6,6 +6,7 @@\n â”Š 6â”Š 6â”Š      - typescript\n â”Š 7â”Š 7â”Š      - typescript-resolvers\n â”Š 8â”Š 8â”Š    config:\n+â”Š  â”Š 9â”Š      useIndexSignature: true\n â”Š 9â”Š10â”Š      contextType: ../context#MyContext\n â”Š10â”Š11â”Š      mappers:\n â”Š11â”Š12â”Š        # import { Message } from '../db'\n```\n\n[}]: #\n\nYou might ask how is that different from what we have already implemented. The code is a bit simpler because the merging part is done by Apollo Server. We get some helpful messages when type's definition is missing but one of the modules was extending it and also when there are duplicates. Apollo Modules are very straightforward and basic but maybe that's all you really need in a project.\n\n### Using GraphQL Modules\n\nThere's an another alternative option that forces good patterns and providess a nice to work with API. It's called GraphQL Modules.\nThe main goal is to help organize an API and allow to develop it across multiple teams.\n\nyarn add @graphql-modules/core\n\nSame as Apollo Server's modules, has useful warnings and messages but you can use it with any implementation of GraphQL server.\n\n```ts\nimport { GraphQLModule } from â€˜@graphql-modules/core';\n\nexport default = new GraphQLModule({\n  name: 'common',\n  typeDefs,\n  resolvers\n});\n```\n\nIt's a bit similar to what we have in Apollo Modules but as you probably noticed, it's wrapped within `GraphQLModule` class. The class manages a business logic, SDL, resolvers and dependencies between modules.\n\n> An important thing to be aware of, GraphQL Modules encapsulates every module. To get a better understanding, think of it as CSS Modules.\n\nNow that you know some basics, let's implement the simplest of all modules:\n\n[{]: <helper> (diffStep \"13.3\" files=\"modules/common/index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.3: Use GraphQL Modules](https://github.com/Urigo/WhatsApp-Clone-Server/commit/ff8c1a7bae4e107a5a7b75811f732f3e7626aa78)\n\n##### Changed modules&#x2F;common&#x2F;index.ts\n```diff\n@@ -1,8 +1,12 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š 1â”Š 2â”Šimport { gql } from 'apollo-server-express';\n â”Š 2â”Š 3â”Šimport { GraphQLDateTime } from 'graphql-iso-date';\n+â”Š  â”Š 4â”Šimport { pool } from '../../db';\n â”Š 3â”Š 5â”Šimport { Resolvers } from '../../types/graphql';\n â”Š 4â”Š 6â”Š\n-â”Š 5â”Š  â”Šexport const typeDefs = gql`\n+â”Š  â”Š 7â”Šconst { PostgresPubSub } = require('graphql-postgres-subscriptions');\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Šconst typeDefs = gql`\n â”Š 6â”Š10â”Š  scalar Date\n â”Š 7â”Š11â”Š\n â”Š 8â”Š12â”Š  type Query {\n```\n```diff\n@@ -18,6 +22,33 @@\n â”Š18â”Š22â”Š  }\n â”Š19â”Š23â”Š`;\n â”Š20â”Š24â”Š\n-â”Š21â”Š  â”Šexport const resolvers: Resolvers = {\n+â”Š  â”Š25â”Šconst resolvers: Resolvers = {\n â”Š22â”Š26â”Š  Date: GraphQLDateTime,\n â”Š23â”Š27â”Š};\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Šconst pubsub = new PostgresPubSub({\n+â”Š  â”Š30â”Š  host: 'localhost',\n+â”Š  â”Š31â”Š  port: process.env.DB_PORT ? parseInt(process.env.DB_PORT) : 5432,\n+â”Š  â”Š32â”Š  user: 'testuser',\n+â”Š  â”Š33â”Š  password: 'testpassword',\n+â”Š  â”Š34â”Š  database: 'whatsapp',\n+â”Š  â”Š35â”Š});\n+â”Š  â”Š36â”Š\n+â”Š  â”Š37â”Šexport default new GraphQLModule({\n+â”Š  â”Š38â”Š  name: 'common',\n+â”Š  â”Š39â”Š  typeDefs,\n+â”Š  â”Š40â”Š  resolvers,\n+â”Š  â”Š41â”Š  async context({ res, connection }) {\n+â”Š  â”Š42â”Š    let db;\n+â”Š  â”Š43â”Š\n+â”Š  â”Š44â”Š    if (!connection) {\n+â”Š  â”Š45â”Š      db = await pool.connect();\n+â”Š  â”Š46â”Š    }\n+â”Š  â”Š47â”Š\n+â”Š  â”Š48â”Š    return {\n+â”Š  â”Š49â”Š      pubsub,\n+â”Š  â”Š50â”Š      res,\n+â”Š  â”Š51â”Š      db,\n+â”Š  â”Š52â”Š    };\n+â”Š  â”Š53â”Š  },\n+â”Š  â”Š54â”Š});\n```\n\n[}]: #\n\nAs we mentioned, there's no global context so we moved the common parts into Common module.\n\nLet's take care of other two modules and migrate `modules/users/index.ts` first:\n\n[{]: <helper> (diffStep \"13.3\" files=\"modules/users/index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.3: Use GraphQL Modules](https://github.com/Urigo/WhatsApp-Clone-Server/commit/ff8c1a7bae4e107a5a7b75811f732f3e7626aa78)\n\n##### Changed modules&#x2F;users&#x2F;index.ts\n```diff\n@@ -1,12 +1,16 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š 1â”Š 2â”Šimport { gql } from 'apollo-server-express';\n+â”Š  â”Š 3â”Šimport cookie from 'cookie';\n â”Š 2â”Š 4â”Šimport sql from 'sql-template-strings';\n â”Š 3â”Š 5â”Šimport bcrypt from 'bcrypt';\n â”Š 4â”Š 6â”Šimport jwt from 'jsonwebtoken';\n+â”Š  â”Š 7â”Šimport commonModule from '../common';\n â”Š 5â”Š 8â”Šimport { secret, expiration } from '../../env';\n+â”Š  â”Š 9â”Šimport { pool } from '../../db';\n â”Š 6â”Š10â”Šimport { validateLength, validatePassword } from '../../validators';\n â”Š 7â”Š11â”Šimport { Resolvers } from '../../types/graphql';\n â”Š 8â”Š12â”Š\n-â”Š 9â”Š  â”Šexport const typeDefs = gql`\n+â”Š  â”Š13â”Šconst typeDefs = gql`\n â”Š10â”Š14â”Š  type User {\n â”Š11â”Š15â”Š    id: ID!\n â”Š12â”Š16â”Š    name: String!\n```\n```diff\n@@ -29,7 +33,7 @@\n â”Š29â”Š33â”Š  }\n â”Š30â”Š34â”Š`;\n â”Š31â”Š35â”Š\n-â”Š32â”Š  â”Šexport const resolvers: Resolvers = {\n+â”Š  â”Š36â”Šconst resolvers: Resolvers = {\n â”Š33â”Š37â”Š  Query: {\n â”Š34â”Š38â”Š    me(root, args, { currentUser }) {\n â”Š35â”Š39â”Š      return currentUser || null;\n```\n```diff\n@@ -98,3 +102,38 @@\n â”Š 98â”Š102â”Š    },\n â”Š 99â”Š103â”Š  },\n â”Š100â”Š104â”Š};\n+â”Š   â”Š105â”Š\n+â”Š   â”Š106â”Šexport default new GraphQLModule({\n+â”Š   â”Š107â”Š  name: 'users',\n+â”Š   â”Š108â”Š  typeDefs,\n+â”Š   â”Š109â”Š  resolvers,\n+â”Š   â”Š110â”Š  imports: () => [commonModule],\n+â”Š   â”Š111â”Š  async context(session) {\n+â”Š   â”Š112â”Š    let currentUser;\n+â”Š   â”Š113â”Š\n+â”Š   â”Š114â”Š    // Access the request object\n+â”Š   â”Š115â”Š    let req = session.connection\n+â”Š   â”Š116â”Š      ? session.connection.context.request\n+â”Š   â”Š117â”Š      : session.req;\n+â”Š   â”Š118â”Š\n+â”Š   â”Š119â”Š    // It's subscription\n+â”Š   â”Š120â”Š    if (session.connection) {\n+â”Š   â”Š121â”Š      req.cookies = cookie.parse(req.headers.cookie || '');\n+â”Š   â”Š122â”Š    }\n+â”Š   â”Š123â”Š\n+â”Š   â”Š124â”Š    if (req.cookies.authToken) {\n+â”Š   â”Š125â”Š      const username = jwt.verify(req.cookies.authToken, secret) as string;\n+â”Š   â”Š126â”Š\n+â”Š   â”Š127â”Š      if (username) {\n+â”Š   â”Š128â”Š        const { rows } = await pool.query(\n+â”Š   â”Š129â”Š          sql`SELECT * FROM users WHERE username = ${username}`\n+â”Š   â”Š130â”Š        );\n+â”Š   â”Š131â”Š        currentUser = rows[0];\n+â”Š   â”Š132â”Š      }\n+â”Š   â”Š133â”Š    }\n+â”Š   â”Š134â”Š\n+â”Š   â”Š135â”Š    return {\n+â”Š   â”Š136â”Š      currentUser,\n+â”Š   â”Š137â”Š    };\n+â”Š   â”Š138â”Š  },\n+â”Š   â”Š139â”Š});\n```\n\n[}]: #\n\nJust like with Common, we also moved related context but there's a totally new thing called `imports`. In order to let Users module see Common's contents (types, resolvers, context etc) we need to include it in the dependencies.\n\nNow `Chats` that depends on `Users` and `Common` modules:\n\n[{]: <helper> (diffStep \"13.3\" files=\"modules/chats/index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.3: Use GraphQL Modules](https://github.com/Urigo/WhatsApp-Clone-Server/commit/ff8c1a7bae4e107a5a7b75811f732f3e7626aa78)\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -1,9 +1,12 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š 1â”Š 2â”Šimport { gql, withFilter } from 'apollo-server-express';\n â”Š 2â”Š 3â”Šimport sql from 'sql-template-strings';\n+â”Š  â”Š 4â”Šimport commonModule from '../common';\n+â”Š  â”Š 5â”Šimport usersModule from '../users';\n â”Š 3â”Š 6â”Šimport { Message, Chat, pool } from '../../db';\n â”Š 4â”Š 7â”Šimport { Resolvers } from '../../types/graphql';\n â”Š 5â”Š 8â”Š\n-â”Š 6â”Š  â”Šexport const typeDefs = gql`\n+â”Š  â”Š 9â”Šconst typeDefs = gql`\n â”Š 7â”Š10â”Š  type Message {\n â”Š 8â”Š11â”Š    id: ID!\n â”Š 9â”Š12â”Š    content: String!\n```\n```diff\n@@ -41,7 +44,7 @@\n â”Š41â”Š44â”Š  }\n â”Š42â”Š45â”Š`;\n â”Š43â”Š46â”Š\n-â”Š44â”Š  â”Šexport const resolvers: Resolvers = {\n+â”Š  â”Š47â”Šconst resolvers: Resolvers = {\n â”Š45â”Š48â”Š  Message: {\n â”Š46â”Š49â”Š    createdAt(message) {\n â”Š47â”Š50â”Š      return new Date(message.created_at);\n```\n```diff\n@@ -325,3 +328,10 @@\n â”Š325â”Š328â”Š    },\n â”Š326â”Š329â”Š  },\n â”Š327â”Š330â”Š};\n+â”Š   â”Š331â”Š\n+â”Š   â”Š332â”Šexport default new GraphQLModule({\n+â”Š   â”Š333â”Š  name: 'chats',\n+â”Š   â”Š334â”Š  typeDefs,\n+â”Š   â”Š335â”Š  resolvers,\n+â”Š   â”Š336â”Š  imports: () => [commonModule, usersModule],\n+â”Š   â”Š337â”Š});\n```\n\n[}]: #\n\nSince every module is now a GraphQL Module, we can take care of how to use them in the ApolloServer.\n\nTo make things easier, we're going to create a module that's called `Root` and represents our API.\n\n```ts\nexport const rootModule = new GraphQLModule({\n  name: 'root',\n  imports: [usersModule, chatsModule],\n});\n```\n\nWe want to pass `schema` and `context` to ApolloServer:\n\n```ts\nconst server = new ApolloServer({\n  schema: rootModule.schema,\n  context: rootModule.context,\n  // ...\n```\n\nNow with all that knowledge, take a look at all changes at once:\n\n[{]: <helper> (diffStep \"13.3\" files=\"index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.3: Use GraphQL Modules](https://github.com/Urigo/WhatsApp-Clone-Server/commit/ff8c1a7bae4e107a5a7b75811f732f3e7626aa78)\n\n##### Changed index.ts\n```diff\n@@ -1,71 +1,23 @@\n â”Š 1â”Š 1â”Šimport { ApolloServer } from 'apollo-server-express';\n-â”Š 2â”Š  â”Šimport cookie from 'cookie';\n+â”Š  â”Š 2â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š 3â”Š 3â”Šimport http from 'http';\n-â”Š 4â”Š  â”Šimport jwt from 'jsonwebtoken';\n â”Š 5â”Š 4â”Šimport { app } from './app';\n-â”Š 6â”Š  â”Šimport { pool } from './db';\n-â”Š 7â”Š  â”Šimport { origin, port, secret } from './env';\n+â”Š  â”Š 5â”Šimport { origin, port } from './env';\n â”Š 8â”Š 6â”Šimport { MyContext } from './context';\n-â”Š 9â”Š  â”Šimport sql from 'sql-template-strings';\n â”Š10â”Š 7â”Šimport { UnsplashApi } from './schema/unsplash.api';\n-â”Š11â”Š  â”Šconst { PostgresPubSub } = require('graphql-postgres-subscriptions');\n â”Š12â”Š 8â”Š\n-â”Š13â”Š  â”Šimport * as commonModule from './modules/common';\n-â”Š14â”Š  â”Šimport * as usersModule from './modules/users';\n-â”Š15â”Š  â”Šimport * as chatsModule from './modules/chats';\n+â”Š  â”Š 9â”Šimport usersModule from './modules/users';\n+â”Š  â”Š10â”Šimport chatsModule from './modules/chats';\n â”Š16â”Š11â”Š\n-â”Š17â”Š  â”Šconst pubsub = new PostgresPubSub({\n-â”Š18â”Š  â”Š  host: 'localhost',\n-â”Š19â”Š  â”Š  port: process.env.DB_PORT ? parseInt(process.env.DB_PORT) : 5432,\n-â”Š20â”Š  â”Š  user: 'testuser',\n-â”Š21â”Š  â”Š  password: 'testpassword',\n-â”Š22â”Š  â”Š  database: 'whatsapp',\n+â”Š  â”Š12â”Šexport const rootModule = new GraphQLModule({\n+â”Š  â”Š13â”Š  name: 'root',\n+â”Š  â”Š14â”Š  imports: [usersModule, chatsModule],\n â”Š23â”Š15â”Š});\n-â”Š24â”Š  â”Šconst server = new ApolloServer({\n-â”Š25â”Š  â”Š  modules: [commonModule, usersModule, chatsModule],\n-â”Š26â”Š  â”Š  context: async (session: any) => {\n-â”Š27â”Š  â”Š    // Access the request object\n-â”Š28â”Š  â”Š    let req = session.connection\n-â”Š29â”Š  â”Š      ? session.connection.context.request\n-â”Š30â”Š  â”Š      : session.req;\n-â”Š31â”Š  â”Š\n-â”Š32â”Š  â”Š    // It's subscription\n-â”Š33â”Š  â”Š    if (session.connection) {\n-â”Š34â”Š  â”Š      req.cookies = cookie.parse(req.headers.cookie || '');\n-â”Š35â”Š  â”Š    }\n-â”Š36â”Š  â”Š\n-â”Š37â”Š  â”Š    let currentUser;\n-â”Š38â”Š  â”Š    if (req.cookies.authToken) {\n-â”Š39â”Š  â”Š      const username = jwt.verify(req.cookies.authToken, secret) as string;\n-â”Š40â”Š  â”Š      if (username) {\n-â”Š41â”Š  â”Š        const { rows } = await pool.query(\n-â”Š42â”Š  â”Š          sql`SELECT * FROM users WHERE username = ${username}`\n-â”Š43â”Š  â”Š        );\n-â”Š44â”Š  â”Š        currentUser = rows[0];\n-â”Š45â”Š  â”Š      }\n-â”Š46â”Š  â”Š    }\n-â”Š47â”Š  â”Š\n-â”Š48â”Š  â”Š    let db;\n â”Š49â”Š16â”Š\n-â”Š50â”Š  â”Š    if (!session.connection) {\n-â”Š51â”Š  â”Š      db = await pool.connect();\n-â”Š52â”Š  â”Š    }\n-â”Š53â”Š  â”Š\n-â”Š54â”Š  â”Š    return {\n-â”Š55â”Š  â”Š      currentUser,\n-â”Š56â”Š  â”Š      pubsub,\n-â”Š57â”Š  â”Š      db,\n-â”Š58â”Š  â”Š      res: session.res,\n-â”Š59â”Š  â”Š    };\n-â”Š60â”Š  â”Š  },\n-â”Š61â”Š  â”Š  subscriptions: {\n-â”Š62â”Š  â”Š    onConnect(params, ws, ctx) {\n-â”Š63â”Š  â”Š      // pass the request object to context\n-â”Š64â”Š  â”Š      return {\n-â”Š65â”Š  â”Š        request: ctx.request,\n-â”Š66â”Š  â”Š      };\n-â”Š67â”Š  â”Š    },\n-â”Š68â”Š  â”Š  },\n+â”Š  â”Š17â”Šconst server = new ApolloServer({\n+â”Š  â”Š18â”Š  schema: rootModule.schema,\n+â”Š  â”Š19â”Š  context: rootModule.context,\n+â”Š  â”Š20â”Š  subscriptions: rootModule.subscriptions,\n â”Š69â”Š21â”Š  formatResponse: (res: any, { context }: { context: MyContext }) => {\n â”Š70â”Š22â”Š    context.db.release();\n â”Š71â”Š23â”Š\n```\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -1,9 +1,12 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š 1â”Š 2â”Šimport { gql, withFilter } from 'apollo-server-express';\n â”Š 2â”Š 3â”Šimport sql from 'sql-template-strings';\n+â”Š  â”Š 4â”Šimport commonModule from '../common';\n+â”Š  â”Š 5â”Šimport usersModule from '../users';\n â”Š 3â”Š 6â”Šimport { Message, Chat, pool } from '../../db';\n â”Š 4â”Š 7â”Šimport { Resolvers } from '../../types/graphql';\n â”Š 5â”Š 8â”Š\n-â”Š 6â”Š  â”Šexport const typeDefs = gql`\n+â”Š  â”Š 9â”Šconst typeDefs = gql`\n â”Š 7â”Š10â”Š  type Message {\n â”Š 8â”Š11â”Š    id: ID!\n â”Š 9â”Š12â”Š    content: String!\n```\n```diff\n@@ -41,7 +44,7 @@\n â”Š41â”Š44â”Š  }\n â”Š42â”Š45â”Š`;\n â”Š43â”Š46â”Š\n-â”Š44â”Š  â”Šexport const resolvers: Resolvers = {\n+â”Š  â”Š47â”Šconst resolvers: Resolvers = {\n â”Š45â”Š48â”Š  Message: {\n â”Š46â”Š49â”Š    createdAt(message) {\n â”Š47â”Š50â”Š      return new Date(message.created_at);\n```\n```diff\n@@ -325,3 +328,10 @@\n â”Š325â”Š328â”Š    },\n â”Š326â”Š329â”Š  },\n â”Š327â”Š330â”Š};\n+â”Š   â”Š331â”Š\n+â”Š   â”Š332â”Šexport default new GraphQLModule({\n+â”Š   â”Š333â”Š  name: 'chats',\n+â”Š   â”Š334â”Š  typeDefs,\n+â”Š   â”Š335â”Š  resolvers,\n+â”Š   â”Š336â”Š  imports: () => [commonModule, usersModule],\n+â”Š   â”Š337â”Š});\n```\n\n##### Changed modules&#x2F;common&#x2F;index.ts\n```diff\n@@ -1,8 +1,12 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š 1â”Š 2â”Šimport { gql } from 'apollo-server-express';\n â”Š 2â”Š 3â”Šimport { GraphQLDateTime } from 'graphql-iso-date';\n+â”Š  â”Š 4â”Šimport { pool } from '../../db';\n â”Š 3â”Š 5â”Šimport { Resolvers } from '../../types/graphql';\n â”Š 4â”Š 6â”Š\n-â”Š 5â”Š  â”Šexport const typeDefs = gql`\n+â”Š  â”Š 7â”Šconst { PostgresPubSub } = require('graphql-postgres-subscriptions');\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Šconst typeDefs = gql`\n â”Š 6â”Š10â”Š  scalar Date\n â”Š 7â”Š11â”Š\n â”Š 8â”Š12â”Š  type Query {\n```\n```diff\n@@ -18,6 +22,33 @@\n â”Š18â”Š22â”Š  }\n â”Š19â”Š23â”Š`;\n â”Š20â”Š24â”Š\n-â”Š21â”Š  â”Šexport const resolvers: Resolvers = {\n+â”Š  â”Š25â”Šconst resolvers: Resolvers = {\n â”Š22â”Š26â”Š  Date: GraphQLDateTime,\n â”Š23â”Š27â”Š};\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Šconst pubsub = new PostgresPubSub({\n+â”Š  â”Š30â”Š  host: 'localhost',\n+â”Š  â”Š31â”Š  port: process.env.DB_PORT ? parseInt(process.env.DB_PORT) : 5432,\n+â”Š  â”Š32â”Š  user: 'testuser',\n+â”Š  â”Š33â”Š  password: 'testpassword',\n+â”Š  â”Š34â”Š  database: 'whatsapp',\n+â”Š  â”Š35â”Š});\n+â”Š  â”Š36â”Š\n+â”Š  â”Š37â”Šexport default new GraphQLModule({\n+â”Š  â”Š38â”Š  name: 'common',\n+â”Š  â”Š39â”Š  typeDefs,\n+â”Š  â”Š40â”Š  resolvers,\n+â”Š  â”Š41â”Š  async context({ res, connection }) {\n+â”Š  â”Š42â”Š    let db;\n+â”Š  â”Š43â”Š\n+â”Š  â”Š44â”Š    if (!connection) {\n+â”Š  â”Š45â”Š      db = await pool.connect();\n+â”Š  â”Š46â”Š    }\n+â”Š  â”Š47â”Š\n+â”Š  â”Š48â”Š    return {\n+â”Š  â”Š49â”Š      pubsub,\n+â”Š  â”Š50â”Š      res,\n+â”Š  â”Š51â”Š      db,\n+â”Š  â”Š52â”Š    };\n+â”Š  â”Š53â”Š  },\n+â”Š  â”Š54â”Š});\n```\n\n##### Changed modules&#x2F;users&#x2F;index.ts\n```diff\n@@ -1,12 +1,16 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š 1â”Š 2â”Šimport { gql } from 'apollo-server-express';\n+â”Š  â”Š 3â”Šimport cookie from 'cookie';\n â”Š 2â”Š 4â”Šimport sql from 'sql-template-strings';\n â”Š 3â”Š 5â”Šimport bcrypt from 'bcrypt';\n â”Š 4â”Š 6â”Šimport jwt from 'jsonwebtoken';\n+â”Š  â”Š 7â”Šimport commonModule from '../common';\n â”Š 5â”Š 8â”Šimport { secret, expiration } from '../../env';\n+â”Š  â”Š 9â”Šimport { pool } from '../../db';\n â”Š 6â”Š10â”Šimport { validateLength, validatePassword } from '../../validators';\n â”Š 7â”Š11â”Šimport { Resolvers } from '../../types/graphql';\n â”Š 8â”Š12â”Š\n-â”Š 9â”Š  â”Šexport const typeDefs = gql`\n+â”Š  â”Š13â”Šconst typeDefs = gql`\n â”Š10â”Š14â”Š  type User {\n â”Š11â”Š15â”Š    id: ID!\n â”Š12â”Š16â”Š    name: String!\n```\n```diff\n@@ -29,7 +33,7 @@\n â”Š29â”Š33â”Š  }\n â”Š30â”Š34â”Š`;\n â”Š31â”Š35â”Š\n-â”Š32â”Š  â”Šexport const resolvers: Resolvers = {\n+â”Š  â”Š36â”Šconst resolvers: Resolvers = {\n â”Š33â”Š37â”Š  Query: {\n â”Š34â”Š38â”Š    me(root, args, { currentUser }) {\n â”Š35â”Š39â”Š      return currentUser || null;\n```\n```diff\n@@ -98,3 +102,38 @@\n â”Š 98â”Š102â”Š    },\n â”Š 99â”Š103â”Š  },\n â”Š100â”Š104â”Š};\n+â”Š   â”Š105â”Š\n+â”Š   â”Š106â”Šexport default new GraphQLModule({\n+â”Š   â”Š107â”Š  name: 'users',\n+â”Š   â”Š108â”Š  typeDefs,\n+â”Š   â”Š109â”Š  resolvers,\n+â”Š   â”Š110â”Š  imports: () => [commonModule],\n+â”Š   â”Š111â”Š  async context(session) {\n+â”Š   â”Š112â”Š    let currentUser;\n+â”Š   â”Š113â”Š\n+â”Š   â”Š114â”Š    // Access the request object\n+â”Š   â”Š115â”Š    let req = session.connection\n+â”Š   â”Š116â”Š      ? session.connection.context.request\n+â”Š   â”Š117â”Š      : session.req;\n+â”Š   â”Š118â”Š\n+â”Š   â”Š119â”Š    // It's subscription\n+â”Š   â”Š120â”Š    if (session.connection) {\n+â”Š   â”Š121â”Š      req.cookies = cookie.parse(req.headers.cookie || '');\n+â”Š   â”Š122â”Š    }\n+â”Š   â”Š123â”Š\n+â”Š   â”Š124â”Š    if (req.cookies.authToken) {\n+â”Š   â”Š125â”Š      const username = jwt.verify(req.cookies.authToken, secret) as string;\n+â”Š   â”Š126â”Š\n+â”Š   â”Š127â”Š      if (username) {\n+â”Š   â”Š128â”Š        const { rows } = await pool.query(\n+â”Š   â”Š129â”Š          sql`SELECT * FROM users WHERE username = ${username}`\n+â”Š   â”Š130â”Š        );\n+â”Š   â”Š131â”Š        currentUser = rows[0];\n+â”Š   â”Š132â”Š      }\n+â”Š   â”Š133â”Š    }\n+â”Š   â”Š134â”Š\n+â”Š   â”Š135â”Š    return {\n+â”Š   â”Š136â”Š      currentUser,\n+â”Š   â”Š137â”Š    };\n+â”Š   â”Š138â”Š  },\n+â”Š   â”Š139â”Š});\n```\n\n[}]: #\n\n#### Migrate Unsplash API to Chats\n\nWe still make use of global context which won't work with GraphQL Modules. To be more specific, it's not the context definition itself but the thing that's being added by ApolloServer, Data Sources.\n\nThe `RESTDataSource` is of course more than a class but in case of Unsplash API we won't loose any important features except the HTTP client. We're going to use `axios` instead:\n\nyarn add axios\n\nWe've got everything now so let's migrate UnsplashAPI class and move it from `schema/unsplash.api.ts` under `modules/chats`!\n\n[{]: <helper> (diffStep \"13.3\" files=\"modules/chats/unsplash.api.ts\" module=\"server\")\n\n#### [__Server__ Step 13.3: Use GraphQL Modules](https://github.com/Urigo/WhatsApp-Clone-Server/commit/ff8c1a7bae4e107a5a7b75811f732f3e7626aa78)\n\n\n\n[}]: #\n\nThere is no big differences between now and what we had before, the only thing that's changed is the way we make http requests.\n\nThe `UnsplashAPI` can be now removed from `dataSources` and moved under Chats module's context:\n\n[{]: <helper> (diffStep \"13.3\" files=\"index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.3: Use GraphQL Modules](https://github.com/Urigo/WhatsApp-Clone-Server/commit/ff8c1a7bae4e107a5a7b75811f732f3e7626aa78)\n\n##### Changed index.ts\n```diff\n@@ -1,71 +1,23 @@\n â”Š 1â”Š 1â”Šimport { ApolloServer } from 'apollo-server-express';\n-â”Š 2â”Š  â”Šimport cookie from 'cookie';\n+â”Š  â”Š 2â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š 3â”Š 3â”Šimport http from 'http';\n-â”Š 4â”Š  â”Šimport jwt from 'jsonwebtoken';\n â”Š 5â”Š 4â”Šimport { app } from './app';\n-â”Š 6â”Š  â”Šimport { pool } from './db';\n-â”Š 7â”Š  â”Šimport { origin, port, secret } from './env';\n+â”Š  â”Š 5â”Šimport { origin, port } from './env';\n â”Š 8â”Š 6â”Šimport { MyContext } from './context';\n-â”Š 9â”Š  â”Šimport sql from 'sql-template-strings';\n â”Š10â”Š 7â”Šimport { UnsplashApi } from './schema/unsplash.api';\n-â”Š11â”Š  â”Šconst { PostgresPubSub } = require('graphql-postgres-subscriptions');\n â”Š12â”Š 8â”Š\n-â”Š13â”Š  â”Šimport * as commonModule from './modules/common';\n-â”Š14â”Š  â”Šimport * as usersModule from './modules/users';\n-â”Š15â”Š  â”Šimport * as chatsModule from './modules/chats';\n+â”Š  â”Š 9â”Šimport usersModule from './modules/users';\n+â”Š  â”Š10â”Šimport chatsModule from './modules/chats';\n â”Š16â”Š11â”Š\n-â”Š17â”Š  â”Šconst pubsub = new PostgresPubSub({\n-â”Š18â”Š  â”Š  host: 'localhost',\n-â”Š19â”Š  â”Š  port: process.env.DB_PORT ? parseInt(process.env.DB_PORT) : 5432,\n-â”Š20â”Š  â”Š  user: 'testuser',\n-â”Š21â”Š  â”Š  password: 'testpassword',\n-â”Š22â”Š  â”Š  database: 'whatsapp',\n+â”Š  â”Š12â”Šexport const rootModule = new GraphQLModule({\n+â”Š  â”Š13â”Š  name: 'root',\n+â”Š  â”Š14â”Š  imports: [usersModule, chatsModule],\n â”Š23â”Š15â”Š});\n-â”Š24â”Š  â”Šconst server = new ApolloServer({\n-â”Š25â”Š  â”Š  modules: [commonModule, usersModule, chatsModule],\n-â”Š26â”Š  â”Š  context: async (session: any) => {\n-â”Š27â”Š  â”Š    // Access the request object\n-â”Š28â”Š  â”Š    let req = session.connection\n-â”Š29â”Š  â”Š      ? session.connection.context.request\n-â”Š30â”Š  â”Š      : session.req;\n-â”Š31â”Š  â”Š\n-â”Š32â”Š  â”Š    // It's subscription\n-â”Š33â”Š  â”Š    if (session.connection) {\n-â”Š34â”Š  â”Š      req.cookies = cookie.parse(req.headers.cookie || '');\n-â”Š35â”Š  â”Š    }\n-â”Š36â”Š  â”Š\n-â”Š37â”Š  â”Š    let currentUser;\n-â”Š38â”Š  â”Š    if (req.cookies.authToken) {\n-â”Š39â”Š  â”Š      const username = jwt.verify(req.cookies.authToken, secret) as string;\n-â”Š40â”Š  â”Š      if (username) {\n-â”Š41â”Š  â”Š        const { rows } = await pool.query(\n-â”Š42â”Š  â”Š          sql`SELECT * FROM users WHERE username = ${username}`\n-â”Š43â”Š  â”Š        );\n-â”Š44â”Š  â”Š        currentUser = rows[0];\n-â”Š45â”Š  â”Š      }\n-â”Š46â”Š  â”Š    }\n-â”Š47â”Š  â”Š\n-â”Š48â”Š  â”Š    let db;\n â”Š49â”Š16â”Š\n-â”Š50â”Š  â”Š    if (!session.connection) {\n-â”Š51â”Š  â”Š      db = await pool.connect();\n-â”Š52â”Š  â”Š    }\n-â”Š53â”Š  â”Š\n-â”Š54â”Š  â”Š    return {\n-â”Š55â”Š  â”Š      currentUser,\n-â”Š56â”Š  â”Š      pubsub,\n-â”Š57â”Š  â”Š      db,\n-â”Š58â”Š  â”Š      res: session.res,\n-â”Š59â”Š  â”Š    };\n-â”Š60â”Š  â”Š  },\n-â”Š61â”Š  â”Š  subscriptions: {\n-â”Š62â”Š  â”Š    onConnect(params, ws, ctx) {\n-â”Š63â”Š  â”Š      // pass the request object to context\n-â”Š64â”Š  â”Š      return {\n-â”Š65â”Š  â”Š        request: ctx.request,\n-â”Š66â”Š  â”Š      };\n-â”Š67â”Š  â”Š    },\n-â”Š68â”Š  â”Š  },\n+â”Š  â”Š17â”Šconst server = new ApolloServer({\n+â”Š  â”Š18â”Š  schema: rootModule.schema,\n+â”Š  â”Š19â”Š  context: rootModule.context,\n+â”Š  â”Š20â”Š  subscriptions: rootModule.subscriptions,\n â”Š69â”Š21â”Š  formatResponse: (res: any, { context }: { context: MyContext }) => {\n â”Š70â”Š22â”Š    context.db.release();\n â”Š71â”Š23â”Š\n```\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -1,9 +1,12 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š 1â”Š 2â”Šimport { gql, withFilter } from 'apollo-server-express';\n â”Š 2â”Š 3â”Šimport sql from 'sql-template-strings';\n+â”Š  â”Š 4â”Šimport commonModule from '../common';\n+â”Š  â”Š 5â”Šimport usersModule from '../users';\n â”Š 3â”Š 6â”Šimport { Message, Chat, pool } from '../../db';\n â”Š 4â”Š 7â”Šimport { Resolvers } from '../../types/graphql';\n â”Š 5â”Š 8â”Š\n-â”Š 6â”Š  â”Šexport const typeDefs = gql`\n+â”Š  â”Š 9â”Šconst typeDefs = gql`\n â”Š 7â”Š10â”Š  type Message {\n â”Š 8â”Š11â”Š    id: ID!\n â”Š 9â”Š12â”Š    content: String!\n```\n```diff\n@@ -41,7 +44,7 @@\n â”Š41â”Š44â”Š  }\n â”Š42â”Š45â”Š`;\n â”Š43â”Š46â”Š\n-â”Š44â”Š  â”Šexport const resolvers: Resolvers = {\n+â”Š  â”Š47â”Šconst resolvers: Resolvers = {\n â”Š45â”Š48â”Š  Message: {\n â”Š46â”Š49â”Š    createdAt(message) {\n â”Š47â”Š50â”Š      return new Date(message.created_at);\n```\n```diff\n@@ -325,3 +328,10 @@\n â”Š325â”Š328â”Š    },\n â”Š326â”Š329â”Š  },\n â”Š327â”Š330â”Š};\n+â”Š   â”Š331â”Š\n+â”Š   â”Š332â”Šexport default new GraphQLModule({\n+â”Š   â”Š333â”Š  name: 'chats',\n+â”Š   â”Š334â”Š  typeDefs,\n+â”Š   â”Š335â”Š  resolvers,\n+â”Š   â”Š336â”Š  imports: () => [commonModule, usersModule],\n+â”Š   â”Š337â”Š});\n```\n\n##### Changed modules&#x2F;common&#x2F;index.ts\n```diff\n@@ -1,8 +1,12 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š 1â”Š 2â”Šimport { gql } from 'apollo-server-express';\n â”Š 2â”Š 3â”Šimport { GraphQLDateTime } from 'graphql-iso-date';\n+â”Š  â”Š 4â”Šimport { pool } from '../../db';\n â”Š 3â”Š 5â”Šimport { Resolvers } from '../../types/graphql';\n â”Š 4â”Š 6â”Š\n-â”Š 5â”Š  â”Šexport const typeDefs = gql`\n+â”Š  â”Š 7â”Šconst { PostgresPubSub } = require('graphql-postgres-subscriptions');\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Šconst typeDefs = gql`\n â”Š 6â”Š10â”Š  scalar Date\n â”Š 7â”Š11â”Š\n â”Š 8â”Š12â”Š  type Query {\n```\n```diff\n@@ -18,6 +22,33 @@\n â”Š18â”Š22â”Š  }\n â”Š19â”Š23â”Š`;\n â”Š20â”Š24â”Š\n-â”Š21â”Š  â”Šexport const resolvers: Resolvers = {\n+â”Š  â”Š25â”Šconst resolvers: Resolvers = {\n â”Š22â”Š26â”Š  Date: GraphQLDateTime,\n â”Š23â”Š27â”Š};\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Šconst pubsub = new PostgresPubSub({\n+â”Š  â”Š30â”Š  host: 'localhost',\n+â”Š  â”Š31â”Š  port: process.env.DB_PORT ? parseInt(process.env.DB_PORT) : 5432,\n+â”Š  â”Š32â”Š  user: 'testuser',\n+â”Š  â”Š33â”Š  password: 'testpassword',\n+â”Š  â”Š34â”Š  database: 'whatsapp',\n+â”Š  â”Š35â”Š});\n+â”Š  â”Š36â”Š\n+â”Š  â”Š37â”Šexport default new GraphQLModule({\n+â”Š  â”Š38â”Š  name: 'common',\n+â”Š  â”Š39â”Š  typeDefs,\n+â”Š  â”Š40â”Š  resolvers,\n+â”Š  â”Š41â”Š  async context({ res, connection }) {\n+â”Š  â”Š42â”Š    let db;\n+â”Š  â”Š43â”Š\n+â”Š  â”Š44â”Š    if (!connection) {\n+â”Š  â”Š45â”Š      db = await pool.connect();\n+â”Š  â”Š46â”Š    }\n+â”Š  â”Š47â”Š\n+â”Š  â”Š48â”Š    return {\n+â”Š  â”Š49â”Š      pubsub,\n+â”Š  â”Š50â”Š      res,\n+â”Š  â”Š51â”Š      db,\n+â”Š  â”Š52â”Š    };\n+â”Š  â”Š53â”Š  },\n+â”Š  â”Š54â”Š});\n```\n\n##### Changed modules&#x2F;users&#x2F;index.ts\n```diff\n@@ -1,12 +1,16 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š 1â”Š 2â”Šimport { gql } from 'apollo-server-express';\n+â”Š  â”Š 3â”Šimport cookie from 'cookie';\n â”Š 2â”Š 4â”Šimport sql from 'sql-template-strings';\n â”Š 3â”Š 5â”Šimport bcrypt from 'bcrypt';\n â”Š 4â”Š 6â”Šimport jwt from 'jsonwebtoken';\n+â”Š  â”Š 7â”Šimport commonModule from '../common';\n â”Š 5â”Š 8â”Šimport { secret, expiration } from '../../env';\n+â”Š  â”Š 9â”Šimport { pool } from '../../db';\n â”Š 6â”Š10â”Šimport { validateLength, validatePassword } from '../../validators';\n â”Š 7â”Š11â”Šimport { Resolvers } from '../../types/graphql';\n â”Š 8â”Š12â”Š\n-â”Š 9â”Š  â”Šexport const typeDefs = gql`\n+â”Š  â”Š13â”Šconst typeDefs = gql`\n â”Š10â”Š14â”Š  type User {\n â”Š11â”Š15â”Š    id: ID!\n â”Š12â”Š16â”Š    name: String!\n```\n```diff\n@@ -29,7 +33,7 @@\n â”Š29â”Š33â”Š  }\n â”Š30â”Š34â”Š`;\n â”Š31â”Š35â”Š\n-â”Š32â”Š  â”Šexport const resolvers: Resolvers = {\n+â”Š  â”Š36â”Šconst resolvers: Resolvers = {\n â”Š33â”Š37â”Š  Query: {\n â”Š34â”Š38â”Š    me(root, args, { currentUser }) {\n â”Š35â”Š39â”Š      return currentUser || null;\n```\n```diff\n@@ -98,3 +102,38 @@\n â”Š 98â”Š102â”Š    },\n â”Š 99â”Š103â”Š  },\n â”Š100â”Š104â”Š};\n+â”Š   â”Š105â”Š\n+â”Š   â”Š106â”Šexport default new GraphQLModule({\n+â”Š   â”Š107â”Š  name: 'users',\n+â”Š   â”Š108â”Š  typeDefs,\n+â”Š   â”Š109â”Š  resolvers,\n+â”Š   â”Š110â”Š  imports: () => [commonModule],\n+â”Š   â”Š111â”Š  async context(session) {\n+â”Š   â”Š112â”Š    let currentUser;\n+â”Š   â”Š113â”Š\n+â”Š   â”Š114â”Š    // Access the request object\n+â”Š   â”Š115â”Š    let req = session.connection\n+â”Š   â”Š116â”Š      ? session.connection.context.request\n+â”Š   â”Š117â”Š      : session.req;\n+â”Š   â”Š118â”Š\n+â”Š   â”Š119â”Š    // It's subscription\n+â”Š   â”Š120â”Š    if (session.connection) {\n+â”Š   â”Š121â”Š      req.cookies = cookie.parse(req.headers.cookie || '');\n+â”Š   â”Š122â”Š    }\n+â”Š   â”Š123â”Š\n+â”Š   â”Š124â”Š    if (req.cookies.authToken) {\n+â”Š   â”Š125â”Š      const username = jwt.verify(req.cookies.authToken, secret) as string;\n+â”Š   â”Š126â”Š\n+â”Š   â”Š127â”Š      if (username) {\n+â”Š   â”Š128â”Š        const { rows } = await pool.query(\n+â”Š   â”Š129â”Š          sql`SELECT * FROM users WHERE username = ${username}`\n+â”Š   â”Š130â”Š        );\n+â”Š   â”Š131â”Š        currentUser = rows[0];\n+â”Š   â”Š132â”Š      }\n+â”Š   â”Š133â”Š    }\n+â”Š   â”Š134â”Š\n+â”Š   â”Š135â”Š    return {\n+â”Š   â”Š136â”Š      currentUser,\n+â”Š   â”Š137â”Š    };\n+â”Š   â”Š138â”Š  },\n+â”Š   â”Š139â”Š});\n```\n\n[}]: #\n\n[{]: <helper> (diffStep \"13.3\" files=\"context.ts\" module=\"server\")\n\n#### [__Server__ Step 13.3: Use GraphQL Modules](https://github.com/Urigo/WhatsApp-Clone-Server/commit/ff8c1a7bae4e107a5a7b75811f732f3e7626aa78)\n\n\n\n[}]: #\n\n[{]: <helper> (diffStep \"13.3\" files=\"modules/chats/index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.3: Use GraphQL Modules](https://github.com/Urigo/WhatsApp-Clone-Server/commit/ff8c1a7bae4e107a5a7b75811f732f3e7626aa78)\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -1,9 +1,12 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š 1â”Š 2â”Šimport { gql, withFilter } from 'apollo-server-express';\n â”Š 2â”Š 3â”Šimport sql from 'sql-template-strings';\n+â”Š  â”Š 4â”Šimport commonModule from '../common';\n+â”Š  â”Š 5â”Šimport usersModule from '../users';\n â”Š 3â”Š 6â”Šimport { Message, Chat, pool } from '../../db';\n â”Š 4â”Š 7â”Šimport { Resolvers } from '../../types/graphql';\n â”Š 5â”Š 8â”Š\n-â”Š 6â”Š  â”Šexport const typeDefs = gql`\n+â”Š  â”Š 9â”Šconst typeDefs = gql`\n â”Š 7â”Š10â”Š  type Message {\n â”Š 8â”Š11â”Š    id: ID!\n â”Š 9â”Š12â”Š    content: String!\n```\n```diff\n@@ -41,7 +44,7 @@\n â”Š41â”Š44â”Š  }\n â”Š42â”Š45â”Š`;\n â”Š43â”Š46â”Š\n-â”Š44â”Š  â”Šexport const resolvers: Resolvers = {\n+â”Š  â”Š47â”Šconst resolvers: Resolvers = {\n â”Š45â”Š48â”Š  Message: {\n â”Š46â”Š49â”Š    createdAt(message) {\n â”Š47â”Š50â”Š      return new Date(message.created_at);\n```\n```diff\n@@ -325,3 +328,10 @@\n â”Š325â”Š328â”Š    },\n â”Š326â”Š329â”Š  },\n â”Š327â”Š330â”Š};\n+â”Š   â”Š331â”Š\n+â”Š   â”Š332â”Šexport default new GraphQLModule({\n+â”Š   â”Š333â”Š  name: 'chats',\n+â”Š   â”Š334â”Š  typeDefs,\n+â”Š   â”Š335â”Š  resolvers,\n+â”Š   â”Š336â”Š  imports: () => [commonModule, usersModule],\n+â”Š   â”Š337â”Š});\n```\n\n[}]: #\n\n#### Dependency Injection in GraphQL Modules\n\nThe major feature of GraphQL Modules is the Dependency Injection. It's optional, you don't have to use it until it's really necessary. Even though WhatsApp clone doesn't need it yet, we're going to talk about DI and implement a simple thing, just for educational purpose.\n\nIf you're familiar with Dependency Injection then you will get it straight away. If not, please read about it here or here (**links**).\n\nTo start working with DI, we we need to install two packages:\n\nyarn add @graphql-modules/di reflect-metadata\n\nLet's now adjust the context type and import `reflect-metadata` into the project:\n\n[{]: <helper> (diffStep \"13.5\" files=\"context.ts\" module=\"server\")\n\n#### [__Server__ Step 13.5: Use Dependency Injection](https://github.com/Urigo/WhatsApp-Clone-Server/commit/dfe0303e3362a46201c59a0caca111aaed8c1d84)\n\n##### Changed context.ts\n```diff\n@@ -1,13 +1,12 @@\n â”Š 1â”Š 1â”Šimport { PubSub } from 'apollo-server-express';\n+â”Š  â”Š 2â”Šimport { ModuleContext } from '@graphql-modules/core';\n â”Š 2â”Š 3â”Šimport { User } from './db';\n â”Š 3â”Š 4â”Šimport { Response } from 'express';\n â”Š 4â”Š 5â”Šimport { PoolClient } from 'pg';\n-â”Š 5â”Š  â”Šimport { UnsplashApi } from './modules/chats/unsplash.api';\n â”Š 6â”Š 6â”Š\n â”Š 7â”Š 7â”Šexport type MyContext = {\n â”Š 8â”Š 8â”Š  pubsub: PubSub;\n â”Š 9â”Š 9â”Š  currentUser: User;\n â”Š10â”Š10â”Š  res: Response;\n â”Š11â”Š11â”Š  db: PoolClient;\n-â”Š12â”Š  â”Š  unsplashApi: UnsplashApi;\n-â”Š13â”Š  â”Š};\n+â”Š  â”Š12â”Š} & ModuleContext;\n```\n\n[}]: #\n\n[{]: <helper> (diffStep \"13.5\" files=\"index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.5: Use Dependency Injection](https://github.com/Urigo/WhatsApp-Clone-Server/commit/dfe0303e3362a46201c59a0caca111aaed8c1d84)\n\n##### Changed index.ts\n```diff\n@@ -1,3 +1,4 @@\n+â”Š â”Š1â”Šimport 'reflect-metadata';\n â”Š1â”Š2â”Šimport { ApolloServer } from 'apollo-server-express';\n â”Š2â”Š3â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š3â”Š4â”Šimport http from 'http';\n```\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -11,7 +11,7 @@\n â”Š11â”Š11â”Š  type Message {\n â”Š12â”Š12â”Š    id: ID!\n â”Š13â”Š13â”Š    content: String!\n-â”Š14â”Š  â”Š    createdAt: Date!\n+â”Š  â”Š14â”Š    createdAt: DateTime!\n â”Š15â”Š15â”Š    chat: Chat\n â”Š16â”Š16â”Š    sender: User\n â”Š17â”Š17â”Š    recipient: User\n```\n```diff\n@@ -94,7 +94,7 @@\n â”Š 94â”Š 94â”Š      return participant ? participant.name : null;\n â”Š 95â”Š 95â”Š    },\n â”Š 96â”Š 96â”Š\n-â”Š 97â”Š   â”Š    async picture(chat, args, { currentUser, db, unsplashApi }) {\n+â”Š   â”Š 97â”Š    async picture(chat, args, { currentUser, db, injector }) {\n â”Š 98â”Š 98â”Š      if (!currentUser) return null;\n â”Š 99â”Š 99â”Š\n â”Š100â”Š100â”Š      const { rows } = await db.query(sql`\n```\n```diff\n@@ -107,7 +107,7 @@\n â”Š107â”Š107â”Š\n â”Š108â”Š108â”Š      return participant && participant.picture\n â”Š109â”Š109â”Š        ? participant.picture\n-â”Š110â”Š   â”Š        : unsplashApi.getRandomPhoto();\n+â”Š   â”Š110â”Š        : injector.get(UnsplashApi).getRandomPhoto();\n â”Š111â”Š111â”Š    },\n â”Š112â”Š112â”Š\n â”Š113â”Š113â”Š    async messages(chat, args, { db }) {\n```\n```diff\n@@ -335,9 +335,5 @@\n â”Š335â”Š335â”Š  typeDefs,\n â”Š336â”Š336â”Š  resolvers,\n â”Š337â”Š337â”Š  imports: () => [commonModule, usersModule],\n-â”Š338â”Š   â”Š  context() {\n-â”Š339â”Š   â”Š    return {\n-â”Š340â”Š   â”Š      unsplashApi: new UnsplashApi(),\n-â”Š341â”Š   â”Š    };\n-â”Š342â”Š   â”Š  },\n+â”Š   â”Š338â”Š  providers: () => [UnsplashApi],\n â”Š343â”Š339â”Š});\n```\n\n##### Changed modules&#x2F;common&#x2F;index.ts\n```diff\n@@ -7,7 +7,7 @@\n â”Š 7â”Š 7â”Šconst { PostgresPubSub } = require('graphql-postgres-subscriptions');\n â”Š 8â”Š 8â”Š\n â”Š 9â”Š 9â”Šconst typeDefs = gql`\n-â”Š10â”Š  â”Š  scalar Date\n+â”Š  â”Š10â”Š  scalar DateTime\n â”Š11â”Š11â”Š\n â”Š12â”Š12â”Š  type Query {\n â”Š13â”Š13â”Š    _dummy: Boolean\n```\n```diff\n@@ -23,7 +23,7 @@\n â”Š23â”Š23â”Š`;\n â”Š24â”Š24â”Š\n â”Š25â”Š25â”Šconst resolvers: Resolvers = {\n-â”Š26â”Š  â”Š  Date: GraphQLDateTime,\n+â”Š  â”Š26â”Š  DateTime: GraphQLDateTime,\n â”Š27â”Š27â”Š};\n â”Š28â”Š28â”Š\n â”Š29â”Š29â”Šconst pubsub = new PostgresPubSub({\n```\n\n[}]: #\n\nIn short, Iependency Injection will instantiate classes, manage dependencies between them and so on and in addition to that, the GraphQL Modules allows to define when each provider / class should be created. We call it scopes.\n\n- Application scope - provider is created when application starts (default)\n- Session - providers are constructed in the beginning of the network request, then kept until the network request is closed\n- Request - creates an instance each time you request it from the injector\n\nBecause our `UnsplashApi` doesn't have to be recreated on every request, we can easily use Application scope, which is the default. The `Injectable` decorator is just to attach some metadata to the class.\n\n[{]: <helper> (diffStep \"13.5\" files=\"modules/chats/unsplash.api.ts\" module=\"server\")\n\n#### [__Server__ Step 13.5: Use Dependency Injection](https://github.com/Urigo/WhatsApp-Clone-Server/commit/dfe0303e3362a46201c59a0caca111aaed8c1d84)\n\n##### Changed modules&#x2F;chats&#x2F;unsplash.api.ts\n```diff\n@@ -1,3 +1,4 @@\n+â”Š â”Š1â”Šimport { Injectable, ProviderScope } from '@graphql-modules/di';\n â”Š1â”Š2â”Šimport { resolve } from 'path';\n â”Š2â”Š3â”Šimport axios from 'axios';\n â”Š3â”Š4â”Šimport { trackProvider } from '@safe-api/middleware';\n```\n```diff\n@@ -8,6 +9,9 @@\n â”Š 8â”Š 9â”Š  orientation: 'landscape' | 'portrait' | 'squarish';\n â”Š 9â”Š10â”Š}\n â”Š10â”Š11â”Š\n+â”Š  â”Š12â”Š@Injectable({\n+â”Š  â”Š13â”Š  scope: ProviderScope.Application,\n+â”Š  â”Š14â”Š})\n â”Š11â”Š15â”Šexport class UnsplashApi {\n â”Š12â”Š16â”Š  baseURL = 'https://api.unsplash.com/';\n â”Š13â”Š17â”Š\n```\n\n[}]: #\n\nHere's how to register the UnsplashApi provider in Chats module:\n\n[{]: <helper> (diffStep \"13.5\" files=\"modules/chats/index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.5: Use Dependency Injection](https://github.com/Urigo/WhatsApp-Clone-Server/commit/dfe0303e3362a46201c59a0caca111aaed8c1d84)\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -11,7 +11,7 @@\n â”Š11â”Š11â”Š  type Message {\n â”Š12â”Š12â”Š    id: ID!\n â”Š13â”Š13â”Š    content: String!\n-â”Š14â”Š  â”Š    createdAt: Date!\n+â”Š  â”Š14â”Š    createdAt: DateTime!\n â”Š15â”Š15â”Š    chat: Chat\n â”Š16â”Š16â”Š    sender: User\n â”Š17â”Š17â”Š    recipient: User\n```\n```diff\n@@ -94,7 +94,7 @@\n â”Š 94â”Š 94â”Š      return participant ? participant.name : null;\n â”Š 95â”Š 95â”Š    },\n â”Š 96â”Š 96â”Š\n-â”Š 97â”Š   â”Š    async picture(chat, args, { currentUser, db, unsplashApi }) {\n+â”Š   â”Š 97â”Š    async picture(chat, args, { currentUser, db, injector }) {\n â”Š 98â”Š 98â”Š      if (!currentUser) return null;\n â”Š 99â”Š 99â”Š\n â”Š100â”Š100â”Š      const { rows } = await db.query(sql`\n```\n```diff\n@@ -107,7 +107,7 @@\n â”Š107â”Š107â”Š\n â”Š108â”Š108â”Š      return participant && participant.picture\n â”Š109â”Š109â”Š        ? participant.picture\n-â”Š110â”Š   â”Š        : unsplashApi.getRandomPhoto();\n+â”Š   â”Š110â”Š        : injector.get(UnsplashApi).getRandomPhoto();\n â”Š111â”Š111â”Š    },\n â”Š112â”Š112â”Š\n â”Š113â”Š113â”Š    async messages(chat, args, { db }) {\n```\n```diff\n@@ -335,9 +335,5 @@\n â”Š335â”Š335â”Š  typeDefs,\n â”Š336â”Š336â”Š  resolvers,\n â”Š337â”Š337â”Š  imports: () => [commonModule, usersModule],\n-â”Š338â”Š   â”Š  context() {\n-â”Š339â”Š   â”Š    return {\n-â”Š340â”Š   â”Š      unsplashApi: new UnsplashApi(),\n-â”Š341â”Š   â”Š    };\n-â”Š342â”Š   â”Š  },\n+â”Š   â”Š338â”Š  providers: () => [UnsplashApi],\n â”Š343â”Š339â”Š});\n```\n\n[}]: #\n\nPlease also take a look at `injector.get(UnsplashApi)` part. There's `injector` instance in every module's context that allows to consume providers and everything that is defined within DI. You simply pass a class / token to the `get` method and GraphQL Modules takes care of the rest.\n\n**What are the benefits of DI?**\n\nYou can have a different implementation of Users based on the same interface. Maybe right now you're using PostgreSQL but at some point a project will be migrated to MongoDB. You could do it through GraphQL context, of course but with Dependency Injection, GraphQL Modules is able to tell you exactly what's missing and where. It reduces boiler plate because instantiation is done by the injector, code is loosely coupled.\n\nHelps maintainability but also comes with few disadvantages. It's a bit complex concept to learn and what could be done on compile time (TypeScript) is moved to run-time.\n\nYou might find DI useful while testing. Let's say you want to test a query that involves `UnsplashApi` provider, you simply replace it with a mocked version without touching the context or internals and you get the expected result every single time.\n\nWe know there's only one provider by far, the `UnsplashApi`, but we're going to implement more and more in following steps.\n\n#### Continuing with DI\n\nWe want to have everything easily accesible and DI helps with that so let's move on and continue migrating things.\n\nOne of the shared objects is database connection and we're going to create a Database provider:\n\n[{]: <helper> (diffStep \"13.6\" files=\"modules/common/database.provider.ts\" module=\"server\")\n\n#### [__Server__ Step 13.6: Define Database provider](https://github.com/Urigo/WhatsApp-Clone-Server/commit/06de9e072077b513496c1588ffbc7ad5461b4c90)\n\n##### Added modules&#x2F;common&#x2F;database.provider.ts\n```diff\n@@ -0,0 +1,26 @@\n+â”Š  â”Š 1â”Šimport { Injectable, ProviderScope } from '@graphql-modules/di';\n+â”Š  â”Š 2â”Šimport { OnResponse } from '@graphql-modules/core';\n+â”Š  â”Š 3â”Šimport { Pool, PoolClient } from 'pg';\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Š@Injectable({\n+â”Š  â”Š 6â”Š  scope: ProviderScope.Session,\n+â”Š  â”Š 7â”Š})\n+â”Š  â”Š 8â”Šexport class Database implements OnResponse {\n+â”Š  â”Š 9â”Š  private instance: PoolClient;\n+â”Š  â”Š10â”Š\n+â”Š  â”Š11â”Š  constructor(private pool: Pool) {}\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Š  async onRequest() {\n+â”Š  â”Š14â”Š    this.instance = await this.pool.connect();\n+â”Š  â”Š15â”Š  }\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š  onResponse() {\n+â”Š  â”Š18â”Š    if (this.instance) {\n+â”Š  â”Š19â”Š      this.instance.release();\n+â”Š  â”Š20â”Š    }\n+â”Š  â”Š21â”Š  }\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Š  async getClient() {\n+â”Š  â”Š24â”Š    return this.instance;\n+â”Š  â”Š25â”Š  }\n+â”Š  â”Š26â”Š}\n```\n\n[}]: #\n\nThings we did there:\n- Session scope was used, which makes sure our provider is created and destroyed on every GraphQL Operation\n- `onRequest` hook is called when a GraphQL Operation starts and we create a database connection in it.\n- `onResponse` hook is triggered when GraphQL Response is about to be sent to the consumer, so we destroy the connection there.\n- `getClient` method exposes the connection\n- `Pool` in constructor means we expect `Pool` to be injected into `Database` provider.\n\nNow we can define `Pool` token and register `Database`:\n\n[{]: <helper> (diffStep \"13.6\" files=\"modules/common/index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.6: Define Database provider](https://github.com/Urigo/WhatsApp-Clone-Server/commit/06de9e072077b513496c1588ffbc7ad5461b4c90)\n\n##### Changed modules&#x2F;common&#x2F;index.ts\n```diff\n@@ -1,8 +1,10 @@\n â”Š 1â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š 2â”Š 2â”Šimport { gql } from 'apollo-server-express';\n â”Š 3â”Š 3â”Šimport { GraphQLDateTime } from 'graphql-iso-date';\n+â”Š  â”Š 4â”Šimport { Pool } from 'pg';\n â”Š 4â”Š 5â”Šimport { pool } from '../../db';\n â”Š 5â”Š 6â”Šimport { Resolvers } from '../../types/graphql';\n+â”Š  â”Š 7â”Šimport { Database } from './database.provider';\n â”Š 6â”Š 8â”Š\n â”Š 7â”Š 9â”Šconst { PostgresPubSub } = require('graphql-postgres-subscriptions');\n â”Š 8â”Š10â”Š\n```\n```diff\n@@ -38,6 +40,13 @@\n â”Š38â”Š40â”Š  name: 'common',\n â”Š39â”Š41â”Š  typeDefs,\n â”Š40â”Š42â”Š  resolvers,\n+â”Š  â”Š43â”Š  providers: () => [\n+â”Š  â”Š44â”Š    {\n+â”Š  â”Š45â”Š      provide: Pool,\n+â”Š  â”Š46â”Š      useValue: pool,\n+â”Š  â”Š47â”Š    },\n+â”Š  â”Š48â”Š    Database,\n+â”Š  â”Š49â”Š  ],\n â”Š41â”Š50â”Š  async context({ res, connection }) {\n â”Š42â”Š51â”Š    let db;\n```\n\n[}]: #\n\n[{]: <helper> (diffStep \"13.6\" files=\"modules/index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.6: Define Database provider](https://github.com/Urigo/WhatsApp-Clone-Server/commit/06de9e072077b513496c1588ffbc7ad5461b4c90)\n\n\n\n[}]: #\n\n#### Creating Users and Chats services\n\nIt's not really recommended to put logic in resolvers so we're going to create a layer with business logic. A good example of that are Users and Chats modules so let's start with the former.\n\nWe're going to create `Users` service and move `Query.users` logic into `findAllExcept` method:\n\n[{]: <helper> (diffStep \"13.7\" files=\"modules/users/users.provider.ts,modules/users/index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.7: Basic User provider](https://github.com/Urigo/WhatsApp-Clone-Server/commit/cc196cf7f4a9c18d84397ca6f11f39c4bc8f8bab)\n\n##### Changed modules&#x2F;users&#x2F;index.ts\n```diff\n@@ -9,6 +9,7 @@\n â”Š 9â”Š 9â”Šimport { pool } from '../../db';\n â”Š10â”Š10â”Šimport { validateLength, validatePassword } from '../../validators';\n â”Š11â”Š11â”Šimport { Resolvers } from '../../types/graphql';\n+â”Š  â”Š12â”Šimport { Users } from './users.provider';\n â”Š12â”Š13â”Š\n â”Š13â”Š14â”Šconst typeDefs = gql`\n â”Š14â”Š15â”Š  type User {\n```\n```diff\n@@ -38,14 +39,10 @@\n â”Š38â”Š39â”Š    me(root, args, { currentUser }) {\n â”Š39â”Š40â”Š      return currentUser || null;\n â”Š40â”Š41â”Š    },\n-â”Š41â”Š  â”Š    async users(root, args, { currentUser, db }) {\n+â”Š  â”Š42â”Š    async users(root, args, { currentUser, injector }) {\n â”Š42â”Š43â”Š      if (!currentUser) return [];\n â”Š43â”Š44â”Š\n-â”Š44â”Š  â”Š      const { rows } = await db.query(sql`\n-â”Š45â”Š  â”Š        SELECT * FROM users WHERE users.id != ${currentUser.id}\n-â”Š46â”Š  â”Š      `);\n-â”Š47â”Š  â”Š\n-â”Š48â”Š  â”Š      return rows;\n+â”Š  â”Š45â”Š      return injector.get(Users).findAllExcept(currentUser.id);\n â”Š49â”Š46â”Š    },\n â”Š50â”Š47â”Š  },\n â”Š51â”Š48â”Š  Mutation: {\n```\n```diff\n@@ -108,6 +105,7 @@\n â”Š108â”Š105â”Š  typeDefs,\n â”Š109â”Š106â”Š  resolvers,\n â”Š110â”Š107â”Š  imports: () => [commonModule],\n+â”Š   â”Š108â”Š  providers: () => [Users],\n â”Š111â”Š109â”Š  async context(session) {\n â”Š112â”Š110â”Š    let currentUser;\n â”Š113â”Š111â”Š\n```\n\n##### Added modules&#x2F;users&#x2F;users.provider.ts\n```diff\n@@ -0,0 +1,19 @@\n+â”Š  â”Š 1â”Šimport { Injectable, Inject, ProviderScope } from '@graphql-modules/di';\n+â”Š  â”Š 2â”Šimport sql from 'sql-template-strings';\n+â”Š  â”Š 3â”Šimport { Database } from '../common/database.provider';\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Š@Injectable({\n+â”Š  â”Š 6â”Š  scope: ProviderScope.Session,\n+â”Š  â”Š 7â”Š})\n+â”Š  â”Š 8â”Šexport class Users {\n+â”Š  â”Š 9â”Š  @Inject() private db: Database;\n+â”Š  â”Š10â”Š\n+â”Š  â”Š11â”Š  async findAllExcept(userId: string) {\n+â”Š  â”Š12â”Š    const db = await this.db.getClient();\n+â”Š  â”Š13â”Š    const { rows } = await db.query(\n+â”Š  â”Š14â”Š      sql`SELECT * FROM users WHERE id != ${userId}`\n+â”Š  â”Š15â”Š    );\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š    return rows;\n+â”Š  â”Š18â”Š  }\n+â”Š  â”Š19â”Š}\n```\n\n[}]: #\n\nA very interesting thing to notice is `@Inject()` decorator.\n\n```ts\n@Inject() private db: Database;\n```\n\nThe @Inject, well... injects `Database` provider as `db` property so you don't have to use the `constructor`.\n\nBack to the Users service. It's very similar to what we did with the `UnsplashApi` so let's move on and implement more methods.\n\n[{]: <helper> (diffStep \"13.8\" module=\"server\")\n\n#### [__Server__ Step 13.8: Implement newUser and findByUsername](https://github.com/Urigo/WhatsApp-Clone-Server/commit/bb6c1e76d447a85b631ce9d78b3fc8664cf6ed2a)\n\n##### Changed modules&#x2F;users&#x2F;index.ts\n```diff\n@@ -46,11 +46,8 @@\n â”Š46â”Š46â”Š    },\n â”Š47â”Š47â”Š  },\n â”Š48â”Š48â”Š  Mutation: {\n-â”Š49â”Š  â”Š    async signIn(root, { username, password }, { db, res }) {\n-â”Š50â”Š  â”Š      const { rows } = await db.query(\n-â”Š51â”Š  â”Š        sql`SELECT * FROM users WHERE username = ${username}`\n-â”Š52â”Š  â”Š      );\n-â”Š53â”Š  â”Š      const user = rows[0];\n+â”Š  â”Š49â”Š    async signIn(root, { username, password }, { injector, res }) {\n+â”Š  â”Š50â”Š      const user = await injector.get(Users).findByUsername(username);\n â”Š54â”Š51â”Š\n â”Š55â”Š52â”Š      if (!user) {\n â”Š56â”Š53â”Š        throw new Error('user not found');\n```\n```diff\n@@ -69,7 +66,11 @@\n â”Š69â”Š66â”Š      return user;\n â”Š70â”Š67â”Š    },\n â”Š71â”Š68â”Š\n-â”Š72â”Š  â”Š    async signUp(root, { name, username, password, passwordConfirm }, { db }) {\n+â”Š  â”Š69â”Š    async signUp(\n+â”Š  â”Š70â”Š      root,\n+â”Š  â”Š71â”Š      { name, username, password, passwordConfirm },\n+â”Š  â”Š72â”Š      { injector }\n+â”Š  â”Š73â”Š    ) {\n â”Š73â”Š74â”Š      validateLength('req.name', name, 3, 50);\n â”Š74â”Š75â”Š      validateLength('req.username', username, 3, 18);\n â”Š75â”Š76â”Š      validatePassword('req.password', password);\n```\n```diff\n@@ -78,24 +79,18 @@\n â”Š 78â”Š 79â”Š        throw Error(\"req.password and req.passwordConfirm don't match\");\n â”Š 79â”Š 80â”Š      }\n â”Š 80â”Š 81â”Š\n-â”Š 81â”Š   â”Š      const existingUserQuery = await db.query(\n-â”Š 82â”Š   â”Š        sql`SELECT * FROM users WHERE username = ${username}`\n-â”Š 83â”Š   â”Š      );\n-â”Š 84â”Š   â”Š      if (existingUserQuery.rows[0]) {\n+â”Š   â”Š 82â”Š      const existingUser = await injector.get(Users).findByUsername(username);\n+â”Š   â”Š 83â”Š      if (existingUser) {\n â”Š 85â”Š 84â”Š        throw Error('username already exists');\n â”Š 86â”Š 85â”Š      }\n â”Š 87â”Š 86â”Š\n-â”Š 88â”Š   â”Š      const passwordHash = bcrypt.hashSync(password, bcrypt.genSaltSync(8));\n+â”Š   â”Š 87â”Š      const createdUser = await injector.get(Users).newUser({\n+â”Š   â”Š 88â”Š        username,\n+â”Š   â”Š 89â”Š        password,\n+â”Š   â”Š 90â”Š        name,\n+â”Š   â”Š 91â”Š      });\n â”Š 89â”Š 92â”Š\n-â”Š 90â”Š   â”Š      const createdUserQuery = await db.query(sql`\n-â”Š 91â”Š   â”Š        INSERT INTO users(password, picture, username, name)\n-â”Š 92â”Š   â”Š        VALUES(${passwordHash}, '', ${username}, ${name})\n-â”Š 93â”Š   â”Š        RETURNING *\n-â”Š 94â”Š   â”Š      `);\n-â”Š 95â”Š   â”Š\n-â”Š 96â”Š   â”Š      const user = createdUserQuery.rows[0];\n-â”Š 97â”Š   â”Š\n-â”Š 98â”Š   â”Š      return user;\n+â”Š   â”Š 93â”Š      return createdUser;\n â”Š 99â”Š 94â”Š    },\n â”Š100â”Š 95â”Š  },\n â”Š101â”Š 96â”Š};\n```\n\n##### Changed modules&#x2F;users&#x2F;users.provider.ts\n```diff\n@@ -1,7 +1,10 @@\n â”Š 1â”Š 1â”Šimport { Injectable, Inject, ProviderScope } from '@graphql-modules/di';\n â”Š 2â”Š 2â”Šimport sql from 'sql-template-strings';\n+â”Š  â”Š 3â”Šimport bcrypt from 'bcrypt';\n â”Š 3â”Š 4â”Šimport { Database } from '../common/database.provider';\n â”Š 4â”Š 5â”Š\n+â”Š  â”Š 6â”Šconst DEFAULT_PROFILE_PIC = 'https://raw.githubusercontent.com/Urigo/WhatsApp-Clone-Client-React/legacy/public/assets/default-profile-pic.jpg'\n+â”Š  â”Š 7â”Š\n â”Š 5â”Š 8â”Š@Injectable({\n â”Š 6â”Š 9â”Š  scope: ProviderScope.Session,\n â”Š 7â”Š10â”Š})\n```\n```diff\n@@ -16,4 +19,34 @@\n â”Š16â”Š19â”Š\n â”Š17â”Š20â”Š    return rows;\n â”Š18â”Š21â”Š  }\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Š  async findByUsername(username: string) {\n+â”Š  â”Š24â”Š    const db = await this.db.getClient();\n+â”Š  â”Š25â”Š    const { rows } = await db.query(\n+â”Š  â”Š26â”Š      sql`SELECT * FROM users WHERE username = ${username}`\n+â”Š  â”Š27â”Š    );\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š    return rows[0] || null;\n+â”Š  â”Š30â”Š  }\n+â”Š  â”Š31â”Š\n+â”Š  â”Š32â”Š  async newUser({\n+â”Š  â”Š33â”Š    username,\n+â”Š  â”Š34â”Š    name,\n+â”Š  â”Š35â”Š    password,\n+â”Š  â”Š36â”Š  }: {\n+â”Š  â”Š37â”Š    username: string;\n+â”Š  â”Š38â”Š    name: string;\n+â”Š  â”Š39â”Š    password: string;\n+â”Š  â”Š40â”Š  }) {\n+â”Š  â”Š41â”Š    const db = await this.db.getClient();\n+â”Š  â”Š42â”Š    const passwordHash = bcrypt.hashSync(password, bcrypt.genSaltSync(8));\n+â”Š  â”Š43â”Š    const createdUserQuery = await db.query(sql`\n+â”Š  â”Š44â”Š        INSERT INTO users(password, picture, username, name)\n+â”Š  â”Š45â”Š        VALUES(${passwordHash}, ${DEFAULT_PROFILE_PIC}, ${username}, ${name})\n+â”Š  â”Š46â”Š        RETURNING *\n+â”Š  â”Š47â”Š      `);\n+â”Š  â”Š48â”Š    const user = createdUserQuery.rows[0];\n+â”Š  â”Š49â”Š\n+â”Š  â”Š50â”Š    return user;\n+â”Š  â”Š51â”Š  }\n â”Š19â”Š52â”Š}\n```\n\n[}]: #\n[{]: <helper> (diffStep \"13.9\" module=\"server\")\n\n#### [__Server__ Step 13.9: Implement findById and use in Chats module](https://github.com/Urigo/WhatsApp-Clone-Server/commit/a5a2605255aceef947f02bc84430aba7717ce1fa)\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -6,6 +6,7 @@\n â”Š 6â”Š 6â”Šimport { Message, Chat, pool } from '../../db';\n â”Š 7â”Š 7â”Šimport { Resolvers } from '../../types/graphql';\n â”Š 8â”Š 8â”Šimport { UnsplashApi } from './unsplash.api';\n+â”Š  â”Š 9â”Šimport { Users } from './../users/users.provider';\n â”Š 9â”Š10â”Š\n â”Š10â”Š11â”Šconst typeDefs = gql`\n â”Š11â”Š12â”Š  type Message {\n```\n```diff\n@@ -58,11 +59,8 @@\n â”Š58â”Š59â”Š      return rows[0] || null;\n â”Š59â”Š60â”Š    },\n â”Š60â”Š61â”Š\n-â”Š61â”Š  â”Š    async sender(message, args, { db }) {\n-â”Š62â”Š  â”Š      const { rows } = await db.query(sql`\n-â”Š63â”Š  â”Š        SELECT * FROM users WHERE id = ${message.sender_user_id}\n-â”Š64â”Š  â”Š      `);\n-â”Š65â”Š  â”Š      return rows[0] || null;\n+â”Š  â”Š62â”Š    async sender(message, args, { injector }) {\n+â”Š  â”Š63â”Š      return injector.get(Users).findById(message.sender_user_id);\n â”Š66â”Š64â”Š    },\n â”Š67â”Š65â”Š\n â”Š68â”Š66â”Š    async recipient(message, args, { db }) {\n```\n\n##### Changed modules&#x2F;users&#x2F;users.provider.ts\n```diff\n@@ -11,6 +11,15 @@\n â”Š11â”Š11â”Šexport class Users {\n â”Š12â”Š12â”Š  @Inject() private db: Database;\n â”Š13â”Š13â”Š\n+â”Š  â”Š14â”Š  async findById(userId: string) {\n+â”Š  â”Š15â”Š    const db = await this.db.getClient();\n+â”Š  â”Š16â”Š    const { rows } = await db.query(\n+â”Š  â”Š17â”Š      sql`SELECT * FROM users WHERE id = ${userId}`\n+â”Š  â”Š18â”Š    );\n+â”Š  â”Š19â”Š\n+â”Š  â”Š20â”Š    return rows[0] || null;\n+â”Š  â”Š21â”Š  }\n+â”Š  â”Š22â”Š\n â”Š14â”Š23â”Š  async findAllExcept(userId: string) {\n â”Š15â”Š24â”Š    const db = await this.db.getClient();\n â”Š16â”Š25â”Š    const { rows } = await db.query(\n```\n\n[}]: #\n\nLet's now implement `Chats` service with two basic methods:\n\n[{]: <helper> (diffStep \"13.10\" module=\"server\")\n\n#### [__Server__ Step 13.10: Basic Chats provider](https://github.com/Urigo/WhatsApp-Clone-Server/commit/506fc26dbee2244d5780af1f21e80c5236276a96)\n\n##### Added modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -0,0 +1,34 @@\n+â”Š  â”Š 1â”Šimport { Injectable, Inject, ProviderScope } from '@graphql-modules/di';\n+â”Š  â”Š 2â”Šimport sql from 'sql-template-strings';\n+â”Š  â”Š 3â”Šimport { Database } from '../common/database.provider';\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Š@Injectable({\n+â”Š  â”Š 6â”Š  scope: ProviderScope.Session,\n+â”Š  â”Š 7â”Š})\n+â”Š  â”Š 8â”Šexport class Chats {\n+â”Š  â”Š 9â”Š  @Inject() private db: Database;\n+â”Š  â”Š10â”Š\n+â”Š  â”Š11â”Š  async findChatsByUser(userId: string) {\n+â”Š  â”Š12â”Š    const db = await this.db.getClient();\n+â”Š  â”Š13â”Š\n+â”Š  â”Š14â”Š    const { rows } = await db.query(sql`\n+â”Š  â”Š15â”Š      SELECT chats.* FROM chats, chats_users\n+â”Š  â”Š16â”Š      WHERE chats.id = chats_users.chat_id\n+â”Š  â”Š17â”Š      AND chats_users.user_id = ${userId}\n+â”Š  â”Š18â”Š    `);\n+â”Š  â”Š19â”Š\n+â”Š  â”Š20â”Š    return rows;\n+â”Š  â”Š21â”Š  }\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Š  async findChatByUser({ chatId, userId }: { chatId: string; userId: string }) {\n+â”Š  â”Š24â”Š    const db = await this.db.getClient();\n+â”Š  â”Š25â”Š    const { rows } = await db.query(sql`\n+â”Š  â”Š26â”Š      SELECT chats.* FROM chats, chats_users\n+â”Š  â”Š27â”Š      WHERE chats_users.chat_id = ${chatId}\n+â”Š  â”Š28â”Š      AND chats.id = chats_users.chat_id\n+â”Š  â”Š29â”Š      AND chats_users.user_id = ${userId}\n+â”Š  â”Š30â”Š    `);\n+â”Š  â”Š31â”Š\n+â”Š  â”Š32â”Š    return rows[0] || null;\n+â”Š  â”Š33â”Š  }\n+â”Š  â”Š34â”Š}\n```\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -7,6 +7,7 @@\n â”Š 7â”Š 7â”Šimport { Resolvers } from '../../types/graphql';\n â”Š 8â”Š 8â”Šimport { UnsplashApi } from './unsplash.api';\n â”Š 9â”Š 9â”Šimport { Users } from './../users/users.provider';\n+â”Š  â”Š10â”Šimport { Chats } from './chats.provider';\n â”Š10â”Š11â”Š\n â”Š11â”Š12â”Šconst typeDefs = gql`\n â”Š12â”Š13â”Š  type Message {\n```\n```diff\n@@ -138,29 +139,18 @@\n â”Š138â”Š139â”Š  },\n â”Š139â”Š140â”Š\n â”Š140â”Š141â”Š  Query: {\n-â”Š141â”Š   â”Š    async chats(root, args, { currentUser, db }) {\n+â”Š   â”Š142â”Š    async chats(root, args, { currentUser, injector }) {\n â”Š142â”Š143â”Š      if (!currentUser) return [];\n â”Š143â”Š144â”Š\n-â”Š144â”Š   â”Š      const { rows } = await db.query(sql`\n-â”Š145â”Š   â”Š        SELECT chats.* FROM chats, chats_users\n-â”Š146â”Š   â”Š        WHERE chats.id = chats_users.chat_id\n-â”Š147â”Š   â”Š        AND chats_users.user_id = ${currentUser.id}\n-â”Š148â”Š   â”Š      `);\n-â”Š149â”Š   â”Š\n-â”Š150â”Š   â”Š      return rows;\n+â”Š   â”Š145â”Š      return injector.get(Chats).findChatsByUser(currentUser.id);\n â”Š151â”Š146â”Š    },\n â”Š152â”Š147â”Š\n-â”Š153â”Š   â”Š    async chat(root, { chatId }, { currentUser, db }) {\n+â”Š   â”Š148â”Š    async chat(root, { chatId }, { currentUser, injector }) {\n â”Š154â”Š149â”Š      if (!currentUser) return null;\n â”Š155â”Š150â”Š\n-â”Š156â”Š   â”Š      const { rows } = await db.query(sql`\n-â”Š157â”Š   â”Š        SELECT chats.* FROM chats, chats_users\n-â”Š158â”Š   â”Š        WHERE chats_users.chat_id = ${chatId}\n-â”Š159â”Š   â”Š        AND chats.id = chats_users.chat_id\n-â”Š160â”Š   â”Š        AND chats_users.user_id = ${currentUser.id}\n-â”Š161â”Š   â”Š      `);\n-â”Š162â”Š   â”Š\n-â”Š163â”Š   â”Š      return rows[0] ? rows[0] : null;\n+â”Š   â”Š151â”Š      return injector\n+â”Š   â”Š152â”Š        .get(Chats)\n+â”Š   â”Š153â”Š        .findChatByUser({ chatId, userId: currentUser.id });\n â”Š164â”Š154â”Š    },\n â”Š165â”Š155â”Š  },\n â”Š166â”Š156â”Š\n```\n```diff\n@@ -333,5 +323,5 @@\n â”Š333â”Š323â”Š  typeDefs,\n â”Š334â”Š324â”Š  resolvers,\n â”Š335â”Š325â”Š  imports: () => [commonModule, usersModule],\n-â”Š336â”Š   â”Š  providers: () => [UnsplashApi],\n+â”Š   â”Š326â”Š  providers: () => [UnsplashApi, Chats],\n â”Š337â”Š327â”Š});\n```\n\n[}]: #\n\nIt looks exatly like `Users` and also has only `database` provider in it.\n\nWe're going to move on and more things:\n\n[{]: <helper> (diffStep \"13.11\" module=\"server\")\n\n#### [__Server__ Step 13.11: Implement findChatById](https://github.com/Urigo/WhatsApp-Clone-Server/commit/b62f273059ef53b2b0049df3b007a916c15ca6a8)\n\n##### Changed modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -31,4 +31,12 @@\n â”Š31â”Š31â”Š\n â”Š32â”Š32â”Š    return rows[0] || null;\n â”Š33â”Š33â”Š  }\n+â”Š  â”Š34â”Š\n+â”Š  â”Š35â”Š  async findChatById(chatId: string) {\n+â”Š  â”Š36â”Š    const db = await this.db.getClient();\n+â”Š  â”Š37â”Š    const { rows } = await db.query(sql`\n+â”Š  â”Š38â”Š      SELECT * FROM chats WHERE id = ${chatId}\n+â”Š  â”Š39â”Š    `);\n+â”Š  â”Š40â”Š    return rows[0] || null;\n+â”Š  â”Š41â”Š  }\n â”Š34â”Š42â”Š}\n```\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -53,11 +53,8 @@\n â”Š53â”Š53â”Š      return new Date(message.created_at);\n â”Š54â”Š54â”Š    },\n â”Š55â”Š55â”Š\n-â”Š56â”Š  â”Š    async chat(message, args, { db }) {\n-â”Š57â”Š  â”Š      const { rows } = await db.query(sql`\n-â”Š58â”Š  â”Š        SELECT * FROM chats WHERE id = ${message.chat_id}\n-â”Š59â”Š  â”Š      `);\n-â”Š60â”Š  â”Š      return rows[0] || null;\n+â”Š  â”Š56â”Š    async chat(message, args, { injector }) {\n+â”Š  â”Š57â”Š      return injector.get(Chats).findChatById(message.chat_id);\n â”Š61â”Š58â”Š    },\n â”Š62â”Š59â”Š\n â”Š63â”Š60â”Š    async sender(message, args, { injector }) {\n```\n\n[}]: #\n[{]: <helper> (diffStep \"13.12\" module=\"server\")\n\n#### [__Server__ Step 13.12: Find chat&#x27;s messages](https://github.com/Urigo/WhatsApp-Clone-Server/commit/19a5df856d0bb583c22b427770b7504d2756ef03)\n\n##### Changed modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -39,4 +39,25 @@\n â”Š39â”Š39â”Š    `);\n â”Š40â”Š40â”Š    return rows[0] || null;\n â”Š41â”Š41â”Š  }\n+â”Š  â”Š42â”Š\n+â”Š  â”Š43â”Š  async findMessagesByChat(chatId: string) {\n+â”Š  â”Š44â”Š    const db = await this.db.getClient();\n+â”Š  â”Š45â”Š    const { rows } = await db.query(\n+â”Š  â”Š46â”Š      sql`SELECT * FROM messages WHERE chat_id = ${chatId}`\n+â”Š  â”Š47â”Š    );\n+â”Š  â”Š48â”Š\n+â”Š  â”Š49â”Š    return rows;\n+â”Š  â”Š50â”Š  }\n+â”Š  â”Š51â”Š\n+â”Š  â”Š52â”Š  async lastMessage(chatId: string) {\n+â”Š  â”Š53â”Š    const db = await this.db.getClient();\n+â”Š  â”Š54â”Š    const { rows } = await db.query(sql`\n+â”Š  â”Š55â”Š      SELECT * FROM messages\n+â”Š  â”Š56â”Š      WHERE chat_id = ${chatId}\n+â”Š  â”Š57â”Š      ORDER BY created_at DESC\n+â”Š  â”Š58â”Š      LIMIT 1\n+â”Š  â”Š59â”Š    `);\n+â”Š  â”Š60â”Š\n+â”Š  â”Š61â”Š    return rows[0];\n+â”Š  â”Š62â”Š  }\n â”Š42â”Š63â”Š}\n```\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -106,22 +106,12 @@\n â”Š106â”Š106â”Š        : injector.get(UnsplashApi).getRandomPhoto();\n â”Š107â”Š107â”Š    },\n â”Š108â”Š108â”Š\n-â”Š109â”Š   â”Š    async messages(chat, args, { db }) {\n-â”Š110â”Š   â”Š      const { rows } = await db.query(\n-â”Š111â”Š   â”Š        sql`SELECT * FROM messages WHERE chat_id = ${chat.id}`\n-â”Š112â”Š   â”Š      );\n-â”Š113â”Š   â”Š\n-â”Š114â”Š   â”Š      return rows;\n+â”Š   â”Š109â”Š    async messages(chat, args, { injector }) {\n+â”Š   â”Š110â”Š      return injector.get(Chats).findMessagesByChat(chat.id);\n â”Š115â”Š111â”Š    },\n â”Š116â”Š112â”Š\n-â”Š117â”Š   â”Š    async lastMessage(chat, args, { db }) {\n-â”Š118â”Š   â”Š      const { rows } = await db.query(sql`\n-â”Š119â”Š   â”Š        SELECT * FROM messages\n-â”Š120â”Š   â”Š        WHERE chat_id = ${chat.id}\n-â”Š121â”Š   â”Š        ORDER BY created_at DESC\n-â”Š122â”Š   â”Š        LIMIT 1`);\n-â”Š123â”Š   â”Š\n-â”Š124â”Š   â”Š      return rows[0];\n+â”Š   â”Š113â”Š    async lastMessage(chat, args, { injector }) {\n+â”Š   â”Š114â”Š      return injector.get(Chats).lastMessage(chat.id);\n â”Š125â”Š115â”Š    },\n â”Š126â”Š116â”Š\n â”Š127â”Š117â”Š    async participants(chat, args, { db }) {\n```\n\n[}]: #\n[{]: <helper> (diffStep \"13.13\" module=\"server\")\n\n#### [__Server__ Step 13.13: Find first participant](https://github.com/Urigo/WhatsApp-Clone-Server/commit/e817a51f389ef809c308e23682b7d15daa1377d9)\n\n##### Changed modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -60,4 +60,16 @@\n â”Š60â”Š60â”Š\n â”Š61â”Š61â”Š    return rows[0];\n â”Š62â”Š62â”Š  }\n+â”Š  â”Š63â”Š\n+â”Š  â”Š64â”Š  async firstRecipient({ chatId, userId }: { chatId: string; userId: string }) {\n+â”Š  â”Š65â”Š    const db = await this.db.getClient();\n+â”Š  â”Š66â”Š    const { rows } = await db.query(sql`\n+â”Š  â”Š67â”Š      SELECT users.* FROM users, chats_users\n+â”Š  â”Š68â”Š      WHERE users.id != ${userId}\n+â”Š  â”Š69â”Š      AND users.id = chats_users.user_id\n+â”Š  â”Š70â”Š      AND chats_users.chat_id = ${chatId}\n+â”Š  â”Š71â”Š    `);\n+â”Š  â”Š72â”Š\n+â”Š  â”Š73â”Š    return rows[0] || null;\n+â”Š  â”Š74â”Š  }\n â”Š63â”Š75â”Š}\n```\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -61,13 +61,11 @@\n â”Š61â”Š61â”Š      return injector.get(Users).findById(message.sender_user_id);\n â”Š62â”Š62â”Š    },\n â”Š63â”Š63â”Š\n-â”Š64â”Š  â”Š    async recipient(message, args, { db }) {\n-â”Š65â”Š  â”Š      const { rows } = await db.query(sql`\n-â”Š66â”Š  â”Š        SELECT users.* FROM users, chats_users\n-â”Š67â”Š  â”Š        WHERE chats_users.user_id != ${message.sender_user_id}\n-â”Š68â”Š  â”Š        AND chats_users.chat_id = ${message.chat_id}\n-â”Š69â”Š  â”Š      `);\n-â”Š70â”Š  â”Š      return rows[0] || null;\n+â”Š  â”Š64â”Š    async recipient(message, args, { injector }) {\n+â”Š  â”Š65â”Š      return injector.get(Chats).firstRecipient({\n+â”Š  â”Š66â”Š        chatId: message.chat_id,\n+â”Š  â”Š67â”Š        userId: message.sender_user_id,\n+â”Š  â”Š68â”Š      });\n â”Š71â”Š69â”Š    },\n â”Š72â”Š70â”Š\n â”Š73â”Š71â”Š    isMine(message, args, { currentUser }) {\n```\n```diff\n@@ -76,16 +74,13 @@\n â”Š76â”Š74â”Š  },\n â”Š77â”Š75â”Š\n â”Š78â”Š76â”Š  Chat: {\n-â”Š79â”Š  â”Š    async name(chat, args, { currentUser, db }) {\n+â”Š  â”Š77â”Š    async name(chat, args, { currentUser, injector }) {\n â”Š80â”Š78â”Š      if (!currentUser) return null;\n â”Š81â”Š79â”Š\n-â”Š82â”Š  â”Š      const { rows } = await db.query(sql`\n-â”Š83â”Š  â”Š        SELECT users.* FROM users, chats_users\n-â”Š84â”Š  â”Š        WHERE users.id != ${currentUser.id}\n-â”Š85â”Š  â”Š        AND users.id = chats_users.user_id\n-â”Š86â”Š  â”Š        AND chats_users.chat_id = ${chat.id}`);\n-â”Š87â”Š  â”Š\n-â”Š88â”Š  â”Š      const participant = rows[0];\n+â”Š  â”Š80â”Š      const participant = await injector.get(Chats).firstRecipient({\n+â”Š  â”Š81â”Š        chatId: chat.id,\n+â”Š  â”Š82â”Š        userId: currentUser.id,\n+â”Š  â”Š83â”Š      });\n â”Š89â”Š84â”Š\n â”Š90â”Š85â”Š      return participant ? participant.name : null;\n â”Š91â”Š86â”Š    },\n```\n```diff\n@@ -93,13 +88,10 @@\n â”Š 93â”Š 88â”Š    async picture(chat, args, { currentUser, db, injector }) {\n â”Š 94â”Š 89â”Š      if (!currentUser) return null;\n â”Š 95â”Š 90â”Š\n-â”Š 96â”Š   â”Š      const { rows } = await db.query(sql`\n-â”Š 97â”Š   â”Š        SELECT users.* FROM users, chats_users\n-â”Š 98â”Š   â”Š        WHERE users.id != ${currentUser.id}\n-â”Š 99â”Š   â”Š        AND users.id = chats_users.user_id\n-â”Š100â”Š   â”Š        AND chats_users.chat_id = ${chat.id}`);\n-â”Š101â”Š   â”Š\n-â”Š102â”Š   â”Š      const participant = rows[0];\n+â”Š   â”Š 91â”Š      const participant = await injector.get(Chats).firstRecipient({\n+â”Š   â”Š 92â”Š        chatId: chat.id,\n+â”Š   â”Š 93â”Š        userId: currentUser.id,\n+â”Š   â”Š 94â”Š      });\n â”Š103â”Š 95â”Š\n â”Š104â”Š 96â”Š      return participant && participant.picture\n â”Š105â”Š 97â”Š        ? participant.picture\n```\n\n[}]: #\n[{]: <helper> (diffStep \"13.14\" module=\"server\")\n\n#### [__Server__ Step 13.14: Find all participants](https://github.com/Urigo/WhatsApp-Clone-Server/commit/7ec04832465f7cd8d53d43af0e7ee86bd20be11e)\n\n##### Changed modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -72,4 +72,15 @@\n â”Š72â”Š72â”Š\n â”Š73â”Š73â”Š    return rows[0] || null;\n â”Š74â”Š74â”Š  }\n+â”Š  â”Š75â”Š\n+â”Š  â”Š76â”Š  async participants(chatId: string) {\n+â”Š  â”Š77â”Š    const db = await this.db.getClient();\n+â”Š  â”Š78â”Š    const { rows } = await db.query(sql`\n+â”Š  â”Š79â”Š      SELECT users.* FROM users, chats_users\n+â”Š  â”Š80â”Š      WHERE chats_users.chat_id = ${chatId}\n+â”Š  â”Š81â”Š      AND chats_users.user_id = users.id\n+â”Š  â”Š82â”Š    `);\n+â”Š  â”Š83â”Š\n+â”Š  â”Š84â”Š    return rows;\n+â”Š  â”Š85â”Š  }\n â”Š75â”Š86â”Š}\n```\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -106,14 +106,8 @@\n â”Š106â”Š106â”Š      return injector.get(Chats).lastMessage(chat.id);\n â”Š107â”Š107â”Š    },\n â”Š108â”Š108â”Š\n-â”Š109â”Š   â”Š    async participants(chat, args, { db }) {\n-â”Š110â”Š   â”Š      const { rows } = await db.query(sql`\n-â”Š111â”Š   â”Š        SELECT users.* FROM users, chats_users\n-â”Š112â”Š   â”Š        WHERE chats_users.chat_id = ${chat.id}\n-â”Š113â”Š   â”Š        AND chats_users.user_id = users.id\n-â”Š114â”Š   â”Š      `);\n-â”Š115â”Š   â”Š\n-â”Š116â”Š   â”Š      return rows;\n+â”Š   â”Š109â”Š    async participants(chat, args, { injector }) {\n+â”Š   â”Š110â”Š      return injector.get(Chats).participants(chat.id);\n â”Š117â”Š111â”Š    },\n â”Š118â”Š112â”Š  },\n```\n\n[}]: #\n[{]: <helper> (diffStep \"13.15\" module=\"server\")\n\n#### [__Server__ Step 13.15: Check if a user belongs to a chat](https://github.com/Urigo/WhatsApp-Clone-Server/commit/e282abbaa16ade91cb80f05df3a6a28726af778f)\n\n##### Changed modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -83,4 +83,15 @@\n â”Š83â”Š83â”Š\n â”Š84â”Š84â”Š    return rows;\n â”Š85â”Š85â”Š  }\n+â”Š  â”Š86â”Š\n+â”Š  â”Š87â”Š  async isParticipant({ chatId, userId }: { chatId: string; userId: string }) {\n+â”Š  â”Š88â”Š    const db = await this.db.getClient();\n+â”Š  â”Š89â”Š    const { rows } = await db.query(sql`\n+â”Š  â”Š90â”Š      SELECT * FROM chats_users\n+â”Š  â”Š91â”Š      WHERE chat_id = ${chatId}\n+â”Š  â”Š92â”Š      AND user_id = ${userId}\n+â”Š  â”Š93â”Š    `);\n+â”Š  â”Š94â”Š\n+â”Š  â”Š95â”Š    return !!rows.length;\n+â”Š  â”Š96â”Š  }\n â”Š86â”Š97â”Š}\n```\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -243,16 +243,14 @@\n â”Š243â”Š243â”Š        async (\n â”Š244â”Š244â”Š          { messageAdded }: { messageAdded: Message },\n â”Š245â”Š245â”Š          args,\n-â”Š246â”Š   â”Š          { currentUser }\n+â”Š   â”Š246â”Š          { currentUser, injector }\n â”Š247â”Š247â”Š        ) => {\n â”Š248â”Š248â”Š          if (!currentUser) return false;\n â”Š249â”Š249â”Š\n-â”Š250â”Š   â”Š          const { rows } = await pool.query(sql`\n-â”Š251â”Š   â”Š            SELECT * FROM chats_users\n-â”Š252â”Š   â”Š            WHERE chat_id = ${messageAdded.chat_id}\n-â”Š253â”Š   â”Š            AND user_id = ${currentUser.id}`);\n-â”Š254â”Š   â”Š\n-â”Š255â”Š   â”Š          return !!rows.length;\n+â”Š   â”Š250â”Š          return injector.get(Chats).isParticipant({\n+â”Š   â”Š251â”Š            chatId: messageAdded.chat_id,\n+â”Š   â”Š252â”Š            userId: currentUser.id,\n+â”Š   â”Š253â”Š          });\n â”Š256â”Š254â”Š        }\n â”Š257â”Š255â”Š      ),\n â”Š258â”Š256â”Š    },\n```\n```diff\n@@ -260,15 +258,17 @@\n â”Š260â”Š258â”Š    chatAdded: {\n â”Š261â”Š259â”Š      subscribe: withFilter(\n â”Š262â”Š260â”Š        (root, args, { pubsub }) => pubsub.asyncIterator('chatAdded'),\n-â”Š263â”Š   â”Š        async ({ chatAdded }: { chatAdded: Chat }, args, { currentUser }) => {\n+â”Š   â”Š261â”Š        async (\n+â”Š   â”Š262â”Š          { chatAdded }: { chatAdded: Chat },\n+â”Š   â”Š263â”Š          args,\n+â”Š   â”Š264â”Š          { currentUser, injector }\n+â”Š   â”Š265â”Š        ) => {\n â”Š264â”Š266â”Š          if (!currentUser) return false;\n â”Š265â”Š267â”Š\n-â”Š266â”Š   â”Š          const { rows } = await pool.query(sql`\n-â”Š267â”Š   â”Š            SELECT * FROM chats_users\n-â”Š268â”Š   â”Š            WHERE chat_id = ${chatAdded.id}\n-â”Š269â”Š   â”Š            AND user_id = ${currentUser.id}`);\n-â”Š270â”Š   â”Š\n-â”Š271â”Š   â”Š          return !!rows.length;\n+â”Š   â”Š268â”Š          return injector.get(Chats).isParticipant({\n+â”Š   â”Š269â”Š            chatId: chatAdded.id,\n+â”Š   â”Š270â”Š            userId: currentUser.id,\n+â”Š   â”Š271â”Š          });\n â”Š272â”Š272â”Š        }\n â”Š273â”Š273â”Š      ),\n â”Š274â”Š274â”Š    },\n```\n```diff\n@@ -276,15 +276,17 @@\n â”Š276â”Š276â”Š    chatRemoved: {\n â”Š277â”Š277â”Š      subscribe: withFilter(\n â”Š278â”Š278â”Š        (root, args, { pubsub }) => pubsub.asyncIterator('chatRemoved'),\n-â”Š279â”Š   â”Š        async ({ targetChat }: { targetChat: Chat }, args, { currentUser }) => {\n+â”Š   â”Š279â”Š        async (\n+â”Š   â”Š280â”Š          { targetChat }: { targetChat: Chat },\n+â”Š   â”Š281â”Š          args,\n+â”Š   â”Š282â”Š          { currentUser, injector }\n+â”Š   â”Š283â”Š        ) => {\n â”Š280â”Š284â”Š          if (!currentUser) return false;\n â”Š281â”Š285â”Š\n-â”Š282â”Š   â”Š          const { rows } = await pool.query(sql`\n-â”Š283â”Š   â”Š            SELECT * FROM chats_users\n-â”Š284â”Š   â”Š            WHERE chat_id = ${targetChat.id}\n-â”Š285â”Š   â”Š            AND user_id = ${currentUser.id}`);\n-â”Š286â”Š   â”Š\n-â”Š287â”Š   â”Š          return !!rows.length;\n+â”Š   â”Š286â”Š          return injector.get(Chats).isParticipant({\n+â”Š   â”Š287â”Š            chatId: targetChat.id,\n+â”Š   â”Š288â”Š            userId: currentUser.id,\n+â”Š   â”Š289â”Š          });\n â”Š288â”Š290â”Š        }\n â”Š289â”Š291â”Š      ),\n â”Š290â”Š292â”Š    },\n```\n\n[}]: #\n\n#### Sharing PubSub\n\nOne of things that are still in the context is `PubSub`. Because we're moving an entire business logic into a separate layer and as part of GraphQL Module's providers we need to make sure that PubSub is accessible throug DI.\n\nLet's register the PubSub and migrate resolvers:\n\n[{]: <helper> (diffStep \"13.16\" module=\"server\")\n\n#### [__Server__ Step 13.16: Move PubSub to Dependency Injection](https://github.com/Urigo/WhatsApp-Clone-Server/commit/69e2a53b4ccf13ea7a1045eb2a6c9030bca4b96e)\n\n##### Changed context.ts\n```diff\n@@ -1,11 +1,9 @@\n-â”Š 1â”Š  â”Šimport { PubSub } from 'apollo-server-express';\n â”Š 2â”Š 1â”Šimport { ModuleContext } from '@graphql-modules/core';\n â”Š 3â”Š 2â”Šimport { User } from './db';\n â”Š 4â”Š 3â”Šimport { Response } from 'express';\n â”Š 5â”Š 4â”Šimport { PoolClient } from 'pg';\n â”Š 6â”Š 5â”Š\n â”Š 7â”Š 6â”Šexport type MyContext = {\n-â”Š 8â”Š  â”Š  pubsub: PubSub;\n â”Š 9â”Š 7â”Š  currentUser: User;\n â”Š10â”Š 8â”Š  res: Response;\n â”Š11â”Š 9â”Š  db: PoolClient;\n```\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -8,6 +8,7 @@\n â”Š 8â”Š 8â”Šimport { UnsplashApi } from './unsplash.api';\n â”Š 9â”Š 9â”Šimport { Users } from './../users/users.provider';\n â”Š10â”Š10â”Šimport { Chats } from './chats.provider';\n+â”Š  â”Š11â”Šimport { PubSub } from '../common/pubsub.provider';\n â”Š11â”Š12â”Š\n â”Š12â”Š13â”Šconst typeDefs = gql`\n â”Š13â”Š14â”Š  type Message {\n```\n```diff\n@@ -128,7 +129,7 @@\n â”Š128â”Š129â”Š  },\n â”Š129â”Š130â”Š\n â”Š130â”Š131â”Š  Mutation: {\n-â”Š131â”Š   â”Š    async addMessage(root, { chatId, content }, { currentUser, pubsub, db }) {\n+â”Š   â”Š132â”Š    async addMessage(root, { chatId, content }, { currentUser, injector, db }) {\n â”Š132â”Š133â”Š      if (!currentUser) return null;\n â”Š133â”Š134â”Š\n â”Š134â”Š135â”Š      const { rows } = await db.query(sql`\n```\n```diff\n@@ -139,14 +140,14 @@\n â”Š139â”Š140â”Š\n â”Š140â”Š141â”Š      const messageAdded = rows[0];\n â”Š141â”Š142â”Š\n-â”Š142â”Š   â”Š      pubsub.publish('messageAdded', {\n+â”Š   â”Š143â”Š      injector.get(PubSub).publish('messageAdded', {\n â”Š143â”Š144â”Š        messageAdded,\n â”Š144â”Š145â”Š      });\n â”Š145â”Š146â”Š\n â”Š146â”Š147â”Š      return messageAdded;\n â”Š147â”Š148â”Š    },\n â”Š148â”Š149â”Š\n-â”Š149â”Š   â”Š    async addChat(root, { recipientId }, { currentUser, pubsub, db }) {\n+â”Š   â”Š150â”Š    async addChat(root, { recipientId }, { currentUser, injector, db }) {\n â”Š150â”Š151â”Š      if (!currentUser) return null;\n â”Š151â”Š152â”Š\n â”Š152â”Š153â”Š      const { rows } = await db.query(sql`\n```\n```diff\n@@ -186,7 +187,7 @@\n â”Š186â”Š187â”Š\n â”Š187â”Š188â”Š        await db.query('COMMIT');\n â”Š188â”Š189â”Š\n-â”Š189â”Š   â”Š        pubsub.publish('chatAdded', {\n+â”Š   â”Š190â”Š        injector.get(PubSub).publish('chatAdded', {\n â”Š190â”Š191â”Š          chatAdded,\n â”Š191â”Š192â”Š        });\n â”Š192â”Š193â”Š\n```\n```diff\n@@ -197,7 +198,7 @@\n â”Š197â”Š198â”Š      }\n â”Š198â”Š199â”Š    },\n â”Š199â”Š200â”Š\n-â”Š200â”Š   â”Š    async removeChat(root, { chatId }, { currentUser, pubsub, db }) {\n+â”Š   â”Š201â”Š    async removeChat(root, { chatId }, { currentUser, injector, db }) {\n â”Š201â”Š202â”Š      if (!currentUser) return null;\n â”Š202â”Š203â”Š\n â”Š203â”Š204â”Š      try {\n```\n```diff\n@@ -221,7 +222,7 @@\n â”Š221â”Š222â”Š          DELETE FROM chats WHERE chats.id = ${chatId}\n â”Š222â”Š223â”Š        `);\n â”Š223â”Š224â”Š\n-â”Š224â”Š   â”Š        pubsub.publish('chatRemoved', {\n+â”Š   â”Š225â”Š        injector.get(PubSub).publish('chatRemoved', {\n â”Š225â”Š226â”Š          chatRemoved: chat.id,\n â”Š226â”Š227â”Š          targetChat: chat,\n â”Š227â”Š228â”Š        });\n```\n```diff\n@@ -239,7 +240,8 @@\n â”Š239â”Š240â”Š  Subscription: {\n â”Š240â”Š241â”Š    messageAdded: {\n â”Š241â”Š242â”Š      subscribe: withFilter(\n-â”Š242â”Š   â”Š        (root, args, { pubsub }) => pubsub.asyncIterator('messageAdded'),\n+â”Š   â”Š243â”Š        (root, args, { injector }) =>\n+â”Š   â”Š244â”Š          injector.get(PubSub).asyncIterator('messageAdded'),\n â”Š243â”Š245â”Š        async (\n â”Š244â”Š246â”Š          { messageAdded }: { messageAdded: Message },\n â”Š245â”Š247â”Š          args,\n```\n```diff\n@@ -257,7 +259,8 @@\n â”Š257â”Š259â”Š\n â”Š258â”Š260â”Š    chatAdded: {\n â”Š259â”Š261â”Š      subscribe: withFilter(\n-â”Š260â”Š   â”Š        (root, args, { pubsub }) => pubsub.asyncIterator('chatAdded'),\n+â”Š   â”Š262â”Š        (root, args, { injector }) =>\n+â”Š   â”Š263â”Š          injector.get(PubSub).asyncIterator('chatAdded'),\n â”Š261â”Š264â”Š        async (\n â”Š262â”Š265â”Š          { chatAdded }: { chatAdded: Chat },\n â”Š263â”Š266â”Š          args,\n```\n```diff\n@@ -275,7 +278,8 @@\n â”Š275â”Š278â”Š\n â”Š276â”Š279â”Š    chatRemoved: {\n â”Š277â”Š280â”Š      subscribe: withFilter(\n-â”Š278â”Š   â”Š        (root, args, { pubsub }) => pubsub.asyncIterator('chatRemoved'),\n+â”Š   â”Š281â”Š        (root, args, { injector }) =>\n+â”Š   â”Š282â”Š          injector.get(PubSub).asyncIterator('chatRemoved'),\n â”Š279â”Š283â”Š        async (\n â”Š280â”Š284â”Š          { targetChat }: { targetChat: Chat },\n â”Š281â”Š285â”Š          args,\n```\n\n##### Changed modules&#x2F;common&#x2F;index.ts\n```diff\n@@ -1,10 +1,12 @@\n â”Š 1â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n+â”Š  â”Š 2â”Šimport { ProviderScope } from '@graphql-modules/di';\n â”Š 2â”Š 3â”Šimport { gql } from 'apollo-server-express';\n â”Š 3â”Š 4â”Šimport { GraphQLDateTime } from 'graphql-iso-date';\n â”Š 4â”Š 5â”Šimport { Pool } from 'pg';\n â”Š 5â”Š 6â”Šimport { pool } from '../../db';\n â”Š 6â”Š 7â”Šimport { Resolvers } from '../../types/graphql';\n â”Š 7â”Š 8â”Šimport { Database } from './database.provider';\n+â”Š  â”Š 9â”Šimport { PubSub } from './pubsub.provider';\n â”Š 8â”Š10â”Š\n â”Š 9â”Š11â”Šconst { PostgresPubSub } = require('graphql-postgres-subscriptions');\n â”Š10â”Š12â”Š\n```\n```diff\n@@ -45,6 +47,11 @@\n â”Š45â”Š47â”Š      provide: Pool,\n â”Š46â”Š48â”Š      useValue: pool,\n â”Š47â”Š49â”Š    },\n+â”Š  â”Š50â”Š    {\n+â”Š  â”Š51â”Š      provide: PubSub,\n+â”Š  â”Š52â”Š      scope: ProviderScope.Application,\n+â”Š  â”Š53â”Š      useValue: pubsub,\n+â”Š  â”Š54â”Š    },\n â”Š48â”Š55â”Š    Database,\n â”Š49â”Š56â”Š  ],\n â”Š50â”Š57â”Š  async context({ res, connection }) {\n```\n```diff\n@@ -55,7 +62,6 @@\n â”Š55â”Š62â”Š    }\n â”Š56â”Š63â”Š\n â”Š57â”Š64â”Š    return {\n-â”Š58â”Š  â”Š      pubsub,\n â”Š59â”Š65â”Š      res,\n â”Š60â”Š66â”Š      db,\n â”Š61â”Š67â”Š    };\n```\n\n##### Added modules&#x2F;common&#x2F;pubsub.provider.ts\n```diff\n@@ -0,0 +1 @@\n+â”Š â”Š1â”Šexport { PubSub } from 'apollo-server-express';\n```\n\n[}]: #\n\nNow, we're going to use `PubSub` within `Chats` service:\n\n[{]: <helper> (diffStep \"13.17\" module=\"server\")\n\n#### [__Server__ Step 13.17: Migrate addMessage to Chats provider](https://github.com/Urigo/WhatsApp-Clone-Server/commit/a5fc4ade5305e7a12632197421ad044396027389)\n\n##### Changed modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -1,12 +1,14 @@\n â”Š 1â”Š 1â”Šimport { Injectable, Inject, ProviderScope } from '@graphql-modules/di';\n â”Š 2â”Š 2â”Šimport sql from 'sql-template-strings';\n â”Š 3â”Š 3â”Šimport { Database } from '../common/database.provider';\n+â”Š  â”Š 4â”Šimport { PubSub } from '../common/pubsub.provider';\n â”Š 4â”Š 5â”Š\n â”Š 5â”Š 6â”Š@Injectable({\n â”Š 6â”Š 7â”Š  scope: ProviderScope.Session,\n â”Š 7â”Š 8â”Š})\n â”Š 8â”Š 9â”Šexport class Chats {\n â”Š 9â”Š10â”Š  @Inject() private db: Database;\n+â”Š  â”Š11â”Š  @Inject() private pubsub: PubSub;\n â”Š10â”Š12â”Š\n â”Š11â”Š13â”Š  async findChatsByUser(userId: string) {\n â”Š12â”Š14â”Š    const db = await this.db.getClient();\n```\n```diff\n@@ -94,4 +96,29 @@\n â”Š 94â”Š 96â”Š\n â”Š 95â”Š 97â”Š    return !!rows.length;\n â”Š 96â”Š 98â”Š  }\n+â”Š   â”Š 99â”Š\n+â”Š   â”Š100â”Š  async addMessage({\n+â”Š   â”Š101â”Š    chatId,\n+â”Š   â”Š102â”Š    userId,\n+â”Š   â”Š103â”Š    content,\n+â”Š   â”Š104â”Š  }: {\n+â”Š   â”Š105â”Š    chatId: string;\n+â”Š   â”Š106â”Š    userId: string;\n+â”Š   â”Š107â”Š    content: string;\n+â”Š   â”Š108â”Š  }) {\n+â”Š   â”Š109â”Š    const db = await this.db.getClient();\n+â”Š   â”Š110â”Š    const { rows } = await db.query(sql`\n+â”Š   â”Š111â”Š      INSERT INTO messages(chat_id, sender_user_id, content)\n+â”Š   â”Š112â”Š      VALUES(${chatId}, ${userId}, ${content})\n+â”Š   â”Š113â”Š      RETURNING *\n+â”Š   â”Š114â”Š    `);\n+â”Š   â”Š115â”Š\n+â”Š   â”Š116â”Š    const messageAdded = rows[0];\n+â”Š   â”Š117â”Š\n+â”Š   â”Š118â”Š    this.pubsub.publish('messageAdded', {\n+â”Š   â”Š119â”Š      messageAdded,\n+â”Š   â”Š120â”Š    });\n+â”Š   â”Š121â”Š\n+â”Š   â”Š122â”Š    return messageAdded;\n+â”Š   â”Š123â”Š  }\n â”Š 97â”Š124â”Š}\n```\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -129,22 +129,12 @@\n â”Š129â”Š129â”Š  },\n â”Š130â”Š130â”Š\n â”Š131â”Š131â”Š  Mutation: {\n-â”Š132â”Š   â”Š    async addMessage(root, { chatId, content }, { currentUser, injector, db }) {\n+â”Š   â”Š132â”Š    async addMessage(root, { chatId, content }, { currentUser, injector }) {\n â”Š133â”Š133â”Š      if (!currentUser) return null;\n â”Š134â”Š134â”Š\n-â”Š135â”Š   â”Š      const { rows } = await db.query(sql`\n-â”Š136â”Š   â”Š        INSERT INTO messages(chat_id, sender_user_id, content)\n-â”Š137â”Š   â”Š        VALUES(${chatId}, ${currentUser.id}, ${content})\n-â”Š138â”Š   â”Š        RETURNING *\n-â”Š139â”Š   â”Š      `);\n-â”Š140â”Š   â”Š\n-â”Š141â”Š   â”Š      const messageAdded = rows[0];\n-â”Š142â”Š   â”Š\n-â”Š143â”Š   â”Š      injector.get(PubSub).publish('messageAdded', {\n-â”Š144â”Š   â”Š        messageAdded,\n-â”Š145â”Š   â”Š      });\n-â”Š146â”Š   â”Š\n-â”Š147â”Š   â”Š      return messageAdded;\n+â”Š   â”Š135â”Š      return injector\n+â”Š   â”Š136â”Š        .get(Chats)\n+â”Š   â”Š137â”Š        .addMessage({ chatId, content, userId: currentUser.id });\n â”Š148â”Š138â”Š    },\n â”Š149â”Š139â”Š\n â”Š150â”Š140â”Š    async addChat(root, { recipientId }, { currentUser, injector, db }) {\n```\n\n[}]: #\n[{]: <helper> (diffStep \"13.18\" module=\"server\")\n\n#### [__Server__ Step 13.18: Migrate addChat to Chats provider](https://github.com/Urigo/WhatsApp-Clone-Server/commit/4213ec01669cd0d017cc45a563c7d916e226196b)\n\n##### Changed modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -121,4 +121,58 @@\n â”Š121â”Š121â”Š\n â”Š122â”Š122â”Š    return messageAdded;\n â”Š123â”Š123â”Š  }\n+â”Š   â”Š124â”Š\n+â”Š   â”Š125â”Š  async addChat({\n+â”Š   â”Š126â”Š    userId,\n+â”Š   â”Š127â”Š    recipientId,\n+â”Š   â”Š128â”Š  }: {\n+â”Š   â”Š129â”Š    userId: string;\n+â”Š   â”Š130â”Š    recipientId: string;\n+â”Š   â”Š131â”Š  }) {\n+â”Š   â”Š132â”Š    const db = await this.db.getClient();\n+â”Š   â”Š133â”Š    const { rows } = await db.query(sql`\n+â”Š   â”Š134â”Š      SELECT chats.* FROM chats, (SELECT * FROM chats_users WHERE user_id = ${userId}) AS chats_of_current_user, chats_users\n+â”Š   â”Š135â”Š      WHERE chats_users.chat_id = chats_of_current_user.chat_id\n+â”Š   â”Š136â”Š      AND chats.id = chats_users.chat_id\n+â”Š   â”Š137â”Š      AND chats_users.user_id = ${recipientId}\n+â”Š   â”Š138â”Š    `);\n+â”Š   â”Š139â”Š\n+â”Š   â”Š140â”Š    // If there is already a chat between these two users, return it\n+â”Š   â”Š141â”Š    if (rows[0]) {\n+â”Š   â”Š142â”Š      return rows[0];\n+â”Š   â”Š143â”Š    }\n+â”Š   â”Š144â”Š\n+â”Š   â”Š145â”Š    try {\n+â”Š   â”Š146â”Š      await db.query('BEGIN');\n+â”Š   â”Š147â”Š\n+â”Š   â”Š148â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š149â”Š        INSERT INTO chats\n+â”Š   â”Š150â”Š        DEFAULT VALUES\n+â”Š   â”Š151â”Š        RETURNING *\n+â”Š   â”Š152â”Š      `);\n+â”Š   â”Š153â”Š\n+â”Š   â”Š154â”Š      const chatAdded = rows[0];\n+â”Š   â”Š155â”Š\n+â”Š   â”Š156â”Š      await db.query(sql`\n+â”Š   â”Š157â”Š        INSERT INTO chats_users(chat_id, user_id)\n+â”Š   â”Š158â”Š        VALUES(${chatAdded.id}, ${userId})\n+â”Š   â”Š159â”Š      `);\n+â”Š   â”Š160â”Š\n+â”Š   â”Š161â”Š      await db.query(sql`\n+â”Š   â”Š162â”Š        INSERT INTO chats_users(chat_id, user_id)\n+â”Š   â”Š163â”Š        VALUES(${chatAdded.id}, ${recipientId})\n+â”Š   â”Š164â”Š      `);\n+â”Š   â”Š165â”Š\n+â”Š   â”Š166â”Š      await db.query('COMMIT');\n+â”Š   â”Š167â”Š\n+â”Š   â”Š168â”Š      this.pubsub.publish('chatAdded', {\n+â”Š   â”Š169â”Š        chatAdded,\n+â”Š   â”Š170â”Š      });\n+â”Š   â”Š171â”Š\n+â”Š   â”Š172â”Š      return chatAdded;\n+â”Š   â”Š173â”Š    } catch (e) {\n+â”Š   â”Š174â”Š      await db.query('ROLLBACK');\n+â”Š   â”Š175â”Š      throw e;\n+â”Š   â”Š176â”Š    }\n+â”Š   â”Š177â”Š  }\n â”Š124â”Š178â”Š}\n```\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -137,55 +137,12 @@\n â”Š137â”Š137â”Š        .addMessage({ chatId, content, userId: currentUser.id });\n â”Š138â”Š138â”Š    },\n â”Š139â”Š139â”Š\n-â”Š140â”Š   â”Š    async addChat(root, { recipientId }, { currentUser, injector, db }) {\n+â”Š   â”Š140â”Š    async addChat(root, { recipientId }, { currentUser, injector }) {\n â”Š141â”Š141â”Š      if (!currentUser) return null;\n â”Š142â”Š142â”Š\n-â”Š143â”Š   â”Š      const { rows } = await db.query(sql`\n-â”Š144â”Š   â”Š        SELECT chats.* FROM chats, (SELECT * FROM chats_users WHERE user_id = ${\n-â”Š145â”Š   â”Š          currentUser.id\n-â”Š146â”Š   â”Š        }) AS chats_of_current_user, chats_users\n-â”Š147â”Š   â”Š        WHERE chats_users.chat_id = chats_of_current_user.chat_id\n-â”Š148â”Š   â”Š        AND chats.id = chats_users.chat_id\n-â”Š149â”Š   â”Š        AND chats_users.user_id = ${recipientId}\n-â”Š150â”Š   â”Š      `);\n-â”Š151â”Š   â”Š\n-â”Š152â”Š   â”Š      // If there is already a chat between these two users, return it\n-â”Š153â”Š   â”Š      if (rows[0]) {\n-â”Š154â”Š   â”Š        return rows[0];\n-â”Š155â”Š   â”Š      }\n-â”Š156â”Š   â”Š\n-â”Š157â”Š   â”Š      try {\n-â”Š158â”Š   â”Š        await db.query('BEGIN');\n-â”Š159â”Š   â”Š\n-â”Š160â”Š   â”Š        const { rows } = await db.query(sql`\n-â”Š161â”Š   â”Š          INSERT INTO chats\n-â”Š162â”Š   â”Š          DEFAULT VALUES\n-â”Š163â”Š   â”Š          RETURNING *\n-â”Š164â”Š   â”Š        `);\n-â”Š165â”Š   â”Š\n-â”Š166â”Š   â”Š        const chatAdded = rows[0];\n-â”Š167â”Š   â”Š\n-â”Š168â”Š   â”Š        await db.query(sql`\n-â”Š169â”Š   â”Š          INSERT INTO chats_users(chat_id, user_id)\n-â”Š170â”Š   â”Š          VALUES(${chatAdded.id}, ${currentUser.id})\n-â”Š171â”Š   â”Š        `);\n-â”Š172â”Š   â”Š\n-â”Š173â”Š   â”Š        await db.query(sql`\n-â”Š174â”Š   â”Š          INSERT INTO chats_users(chat_id, user_id)\n-â”Š175â”Š   â”Š          VALUES(${chatAdded.id}, ${recipientId})\n-â”Š176â”Š   â”Š        `);\n-â”Š177â”Š   â”Š\n-â”Š178â”Š   â”Š        await db.query('COMMIT');\n-â”Š179â”Š   â”Š\n-â”Š180â”Š   â”Š        injector.get(PubSub).publish('chatAdded', {\n-â”Š181â”Š   â”Š          chatAdded,\n-â”Š182â”Š   â”Š        });\n-â”Š183â”Š   â”Š\n-â”Š184â”Š   â”Š        return chatAdded;\n-â”Š185â”Š   â”Š      } catch (e) {\n-â”Š186â”Š   â”Š        await db.query('ROLLBACK');\n-â”Š187â”Š   â”Š        throw e;\n-â”Š188â”Š   â”Š      }\n+â”Š   â”Š143â”Š      return injector\n+â”Š   â”Š144â”Š        .get(Chats)\n+â”Š   â”Š145â”Š        .addChat({ recipientId, userId: currentUser.id });\n â”Š189â”Š146â”Š    },\n â”Š190â”Š147â”Š\n â”Š191â”Š148â”Š    async removeChat(root, { chatId }, { currentUser, injector, db }) {\n```\n\n[}]: #\n[{]: <helper> (diffStep \"13.19\" module=\"server\")\n\n#### [__Server__ Step 13.19: Migrate removeChat to Chats provider](https://github.com/Urigo/WhatsApp-Clone-Server/commit/bd3309b80f9378924d4900c78c3dcfd80b2290bf)\n\n##### Changed modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -175,4 +175,42 @@\n â”Š175â”Š175â”Š      throw e;\n â”Š176â”Š176â”Š    }\n â”Š177â”Š177â”Š  }\n+â”Š   â”Š178â”Š\n+â”Š   â”Š179â”Š  async removeChat({ chatId, userId }: { chatId: string; userId: string }) {\n+â”Š   â”Š180â”Š    const db = await this.db.getClient();\n+â”Š   â”Š181â”Š\n+â”Š   â”Š182â”Š    try {\n+â”Š   â”Š183â”Š      await db.query('BEGIN');\n+â”Š   â”Š184â”Š\n+â”Š   â”Š185â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š186â”Š        SELECT chats.* FROM chats, chats_users\n+â”Š   â”Š187â”Š        WHERE id = ${chatId}\n+â”Š   â”Š188â”Š        AND chats.id = chats_users.chat_id\n+â”Š   â”Š189â”Š        AND chats_users.user_id = ${userId}\n+â”Š   â”Š190â”Š      `);\n+â”Š   â”Š191â”Š\n+â”Š   â”Š192â”Š      const chat = rows[0];\n+â”Š   â”Š193â”Š\n+â”Š   â”Š194â”Š      if (!chat) {\n+â”Š   â”Š195â”Š        await db.query('ROLLBACK');\n+â”Š   â”Š196â”Š        return null;\n+â”Š   â”Š197â”Š      }\n+â”Š   â”Š198â”Š\n+â”Š   â”Š199â”Š      await db.query(sql`\n+â”Š   â”Š200â”Š        DELETE FROM chats WHERE chats.id = ${chatId}\n+â”Š   â”Š201â”Š      `);\n+â”Š   â”Š202â”Š\n+â”Š   â”Š203â”Š      this.pubsub.publish('chatRemoved', {\n+â”Š   â”Š204â”Š        chatRemoved: chat.id,\n+â”Š   â”Š205â”Š        targetChat: chat,\n+â”Š   â”Š206â”Š      });\n+â”Š   â”Š207â”Š\n+â”Š   â”Š208â”Š      await db.query('COMMIT');\n+â”Š   â”Š209â”Š\n+â”Š   â”Š210â”Š      return chatId;\n+â”Š   â”Š211â”Š    } catch (e) {\n+â”Š   â”Š212â”Š      await db.query('ROLLBACK');\n+â”Š   â”Š213â”Š      throw e;\n+â”Š   â”Š214â”Š    }\n+â”Š   â”Š215â”Š  }\n â”Š178â”Š216â”Š}\n```\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -145,42 +145,10 @@\n â”Š145â”Š145â”Š        .addChat({ recipientId, userId: currentUser.id });\n â”Š146â”Š146â”Š    },\n â”Š147â”Š147â”Š\n-â”Š148â”Š   â”Š    async removeChat(root, { chatId }, { currentUser, injector, db }) {\n+â”Š   â”Š148â”Š    async removeChat(root, { chatId }, { currentUser, injector }) {\n â”Š149â”Š149â”Š      if (!currentUser) return null;\n â”Š150â”Š150â”Š\n-â”Š151â”Š   â”Š      try {\n-â”Š152â”Š   â”Š        await db.query('BEGIN');\n-â”Š153â”Š   â”Š\n-â”Š154â”Š   â”Š        const { rows } = await db.query(sql`\n-â”Š155â”Š   â”Š          SELECT chats.* FROM chats, chats_users\n-â”Š156â”Š   â”Š          WHERE id = ${chatId}\n-â”Š157â”Š   â”Š          AND chats.id = chats_users.chat_id\n-â”Š158â”Š   â”Š          AND chats_users.user_id = ${currentUser.id}\n-â”Š159â”Š   â”Š        `);\n-â”Š160â”Š   â”Š\n-â”Š161â”Š   â”Š        const chat = rows[0];\n-â”Š162â”Š   â”Š\n-â”Š163â”Š   â”Š        if (!chat) {\n-â”Š164â”Š   â”Š          await db.query('ROLLBACK');\n-â”Š165â”Š   â”Š          return null;\n-â”Š166â”Š   â”Š        }\n-â”Š167â”Š   â”Š\n-â”Š168â”Š   â”Š        await db.query(sql`\n-â”Š169â”Š   â”Š          DELETE FROM chats WHERE chats.id = ${chatId}\n-â”Š170â”Š   â”Š        `);\n-â”Š171â”Š   â”Š\n-â”Š172â”Š   â”Š        injector.get(PubSub).publish('chatRemoved', {\n-â”Š173â”Š   â”Š          chatRemoved: chat.id,\n-â”Š174â”Š   â”Š          targetChat: chat,\n-â”Š175â”Š   â”Š        });\n-â”Š176â”Š   â”Š\n-â”Š177â”Š   â”Š        await db.query('COMMIT');\n-â”Š178â”Š   â”Š\n-â”Š179â”Š   â”Š        return chatId;\n-â”Š180â”Š   â”Š      } catch (e) {\n-â”Š181â”Š   â”Š        await db.query('ROLLBACK');\n-â”Š182â”Š   â”Š        throw e;\n-â”Š183â”Š   â”Š      }\n+â”Š   â”Š151â”Š      return injector.get(Chats).removeChat({ chatId, userId: currentUser.id });\n â”Š184â”Š152â”Š    },\n â”Š185â”Š153â”Š  },\n```\n\n[}]: #\n\n#### Implementing Auth service\n\nThe last missing piece of our \"context migration\" journey is `currentUser` object. We're going to define the `Auth` service.\n\n[{]: <helper> (diffStep \"13.20\" files=\"modules/users/auth.provider.ts\" module=\"server\")\n\n#### [__Server__ Step 13.20: Implement Auth provider with currentUser method](https://github.com/Urigo/WhatsApp-Clone-Server/commit/b7ff125fc6f3f66eca49aa97ba7de0596c9eefd5)\n\n##### Added modules&#x2F;users&#x2F;auth.provider.ts\n```diff\n@@ -0,0 +1,30 @@\n+â”Š  â”Š 1â”Šimport { Injectable, Inject, ProviderScope } from '@graphql-modules/di';\n+â”Š  â”Š 2â”Šimport { ModuleSessionInfo } from '@graphql-modules/core';\n+â”Š  â”Š 3â”Šimport jwt from 'jsonwebtoken';\n+â”Š  â”Š 4â”Šimport { secret } from '../../env';\n+â”Š  â”Š 5â”Šimport { Users } from './users.provider';\n+â”Š  â”Š 6â”Šimport { User } from '../../db';\n+â”Š  â”Š 7â”Š\n+â”Š  â”Š 8â”Š@Injectable({\n+â”Š  â”Š 9â”Š  scope: ProviderScope.Session,\n+â”Š  â”Š10â”Š})\n+â”Š  â”Š11â”Šexport class Auth {\n+â”Š  â”Š12â”Š  @Inject() private users: Users;\n+â”Š  â”Š13â”Š  @Inject() private module: ModuleSessionInfo;\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”Š  private get req() {\n+â”Š  â”Š16â”Š    return this.module.session.req || this.module.session.request;\n+â”Š  â”Š17â”Š  }\n+â”Š  â”Š18â”Š\n+â”Š  â”Š19â”Š  async currentUser(): Promise<User | null> {\n+â”Š  â”Š20â”Š    if (this.req.cookies.authToken) {\n+â”Š  â”Š21â”Š      const username = jwt.verify(this.req.cookies.authToken, secret) as string;\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Š      if (username) {\n+â”Š  â”Š24â”Š        return this.users.findByUsername(username);\n+â”Š  â”Š25â”Š      }\n+â”Š  â”Š26â”Š    }\n+â”Š  â”Š27â”Š\n+â”Š  â”Š28â”Š    return null;\n+â”Š  â”Š29â”Š  }\n+â”Š  â”Š30â”Š}\n```\n\n[}]: #\n\nIt still needs to be registered and few resolvers in Users module have to be migrated:\n\n[{]: <helper> (diffStep \"13.20\" files=\"modules/users/index.ts, context.ts\" module=\"server\")\n\n#### [__Server__ Step 13.20: Implement Auth provider with currentUser method](https://github.com/Urigo/WhatsApp-Clone-Server/commit/b7ff125fc6f3f66eca49aa97ba7de0596c9eefd5)\n\n##### Changed context.ts\n```diff\n@@ -1,10 +1,8 @@\n â”Š 1â”Š 1â”Šimport { ModuleContext } from '@graphql-modules/core';\n-â”Š 2â”Š  â”Šimport { User } from './db';\n â”Š 3â”Š 2â”Šimport { Response } from 'express';\n â”Š 4â”Š 3â”Šimport { PoolClient } from 'pg';\n â”Š 5â”Š 4â”Š\n â”Š 6â”Š 5â”Šexport type MyContext = {\n-â”Š 7â”Š  â”Š  currentUser: User;\n â”Š 8â”Š 6â”Š  res: Response;\n â”Š 9â”Š 7â”Š  db: PoolClient;\n â”Š10â”Š 8â”Š} & ModuleContext;\n```\n\n##### Changed modules&#x2F;users&#x2F;index.ts\n```diff\n@@ -1,6 +1,5 @@\n â”Š1â”Š1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š2â”Š2â”Šimport { gql } from 'apollo-server-express';\n-â”Š3â”Š â”Šimport cookie from 'cookie';\n â”Š4â”Š3â”Šimport sql from 'sql-template-strings';\n â”Š5â”Š4â”Šimport bcrypt from 'bcrypt';\n â”Š6â”Š5â”Šimport jwt from 'jsonwebtoken';\n```\n```diff\n@@ -10,6 +9,7 @@\n â”Š10â”Š 9â”Šimport { validateLength, validatePassword } from '../../validators';\n â”Š11â”Š10â”Šimport { Resolvers } from '../../types/graphql';\n â”Š12â”Š11â”Šimport { Users } from './users.provider';\n+â”Š  â”Š12â”Šimport { Auth } from './auth.provider';\n â”Š13â”Š13â”Š\n â”Š14â”Š14â”Šconst typeDefs = gql`\n â”Š15â”Š15â”Š  type User {\n```\n```diff\n@@ -36,10 +36,12 @@\n â”Š36â”Š36â”Š\n â”Š37â”Š37â”Šconst resolvers: Resolvers = {\n â”Š38â”Š38â”Š  Query: {\n-â”Š39â”Š  â”Š    me(root, args, { currentUser }) {\n-â”Š40â”Š  â”Š      return currentUser || null;\n+â”Š  â”Š39â”Š    me(root, args, { injector }) {\n+â”Š  â”Š40â”Š      return injector.get(Auth).currentUser();\n â”Š41â”Š41â”Š    },\n-â”Š42â”Š  â”Š    async users(root, args, { currentUser, injector }) {\n+â”Š  â”Š42â”Š    async users(root, args, { injector }) {\n+â”Š  â”Š43â”Š      const currentUser = await injector.get(Auth).currentUser();\n+â”Š  â”Š44â”Š\n â”Š43â”Š45â”Š      if (!currentUser) return [];\n â”Š44â”Š46â”Š\n â”Š45â”Š47â”Š      return injector.get(Users).findAllExcept(currentUser.id);\n```\n```diff\n@@ -100,33 +102,5 @@\n â”Š100â”Š102â”Š  typeDefs,\n â”Š101â”Š103â”Š  resolvers,\n â”Š102â”Š104â”Š  imports: () => [commonModule],\n-â”Š103â”Š   â”Š  providers: () => [Users],\n-â”Š104â”Š   â”Š  async context(session) {\n-â”Š105â”Š   â”Š    let currentUser;\n-â”Š106â”Š   â”Š\n-â”Š107â”Š   â”Š    // Access the request object\n-â”Š108â”Š   â”Š    let req = session.connection\n-â”Š109â”Š   â”Š      ? session.connection.context.request\n-â”Š110â”Š   â”Š      : session.req;\n-â”Š111â”Š   â”Š\n-â”Š112â”Š   â”Š    // It's subscription\n-â”Š113â”Š   â”Š    if (session.connection) {\n-â”Š114â”Š   â”Š      req.cookies = cookie.parse(req.headers.cookie || '');\n-â”Š115â”Š   â”Š    }\n-â”Š116â”Š   â”Š\n-â”Š117â”Š   â”Š    if (req.cookies.authToken) {\n-â”Š118â”Š   â”Š      const username = jwt.verify(req.cookies.authToken, secret) as string;\n-â”Š119â”Š   â”Š\n-â”Š120â”Š   â”Š      if (username) {\n-â”Š121â”Š   â”Š        const { rows } = await pool.query(\n-â”Š122â”Š   â”Š          sql`SELECT * FROM users WHERE username = ${username}`\n-â”Š123â”Š   â”Š        );\n-â”Š124â”Š   â”Š        currentUser = rows[0];\n-â”Š125â”Š   â”Š      }\n-â”Š126â”Š   â”Š    }\n-â”Š127â”Š   â”Š\n-â”Š128â”Š   â”Š    return {\n-â”Š129â”Š   â”Š      currentUser,\n-â”Š130â”Š   â”Š    };\n-â”Š131â”Š   â”Š  },\n+â”Š   â”Š105â”Š  providers: () => [Users, Auth],\n â”Š132â”Š106â”Š});\n```\n\n[}]: #\n\nNow let's use the Auth service in Chats:\n\n[{]: <helper> (diffStep \"13.20\" files=\"modules/chats/index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.20: Implement Auth provider with currentUser method](https://github.com/Urigo/WhatsApp-Clone-Server/commit/b7ff125fc6f3f66eca49aa97ba7de0596c9eefd5)\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -7,6 +7,7 @@\n â”Š 7â”Š 7â”Šimport { Resolvers } from '../../types/graphql';\n â”Š 8â”Š 8â”Šimport { UnsplashApi } from './unsplash.api';\n â”Š 9â”Š 9â”Šimport { Users } from './../users/users.provider';\n+â”Š  â”Š10â”Šimport { Auth } from './../users/auth.provider';\n â”Š10â”Š11â”Šimport { Chats } from './chats.provider';\n â”Š11â”Š12â”Šimport { PubSub } from '../common/pubsub.provider';\n â”Š12â”Š13â”Š\n```\n```diff\n@@ -69,13 +70,16 @@\n â”Š69â”Š70â”Š      });\n â”Š70â”Š71â”Š    },\n â”Š71â”Š72â”Š\n-â”Š72â”Š  â”Š    isMine(message, args, { currentUser }) {\n-â”Š73â”Š  â”Š      return message.sender_user_id === currentUser.id;\n+â”Š  â”Š73â”Š    async isMine(message, args, { injector }) {\n+â”Š  â”Š74â”Š      const currentUser = await injector.get(Auth).currentUser();\n+â”Š  â”Š75â”Š      return message.sender_user_id === currentUser!.id;\n â”Š74â”Š76â”Š    },\n â”Š75â”Š77â”Š  },\n â”Š76â”Š78â”Š\n â”Š77â”Š79â”Š  Chat: {\n-â”Š78â”Š  â”Š    async name(chat, args, { currentUser, injector }) {\n+â”Š  â”Š80â”Š    async name(chat, args, { injector }) {\n+â”Š  â”Š81â”Š      const currentUser = await injector.get(Auth).currentUser();\n+â”Š  â”Š82â”Š\n â”Š79â”Š83â”Š      if (!currentUser) return null;\n â”Š80â”Š84â”Š\n â”Š81â”Š85â”Š      const participant = await injector.get(Chats).firstRecipient({\n```\n```diff\n@@ -86,7 +90,9 @@\n â”Š86â”Š90â”Š      return participant ? participant.name : null;\n â”Š87â”Š91â”Š    },\n â”Š88â”Š92â”Š\n-â”Š89â”Š  â”Š    async picture(chat, args, { currentUser, db, injector }) {\n+â”Š  â”Š93â”Š    async picture(chat, args, { injector }) {\n+â”Š  â”Š94â”Š      const currentUser = await injector.get(Auth).currentUser();\n+â”Š  â”Š95â”Š\n â”Š90â”Š96â”Š      if (!currentUser) return null;\n â”Š91â”Š97â”Š\n â”Š92â”Š98â”Š      const participant = await injector.get(Chats).firstRecipient({\n```\n```diff\n@@ -113,13 +119,17 @@\n â”Š113â”Š119â”Š  },\n â”Š114â”Š120â”Š\n â”Š115â”Š121â”Š  Query: {\n-â”Š116â”Š   â”Š    async chats(root, args, { currentUser, injector }) {\n+â”Š   â”Š122â”Š    async chats(root, args, { injector }) {\n+â”Š   â”Š123â”Š      const currentUser = await injector.get(Auth).currentUser();\n+â”Š   â”Š124â”Š\n â”Š117â”Š125â”Š      if (!currentUser) return [];\n â”Š118â”Š126â”Š\n â”Š119â”Š127â”Š      return injector.get(Chats).findChatsByUser(currentUser.id);\n â”Š120â”Š128â”Š    },\n â”Š121â”Š129â”Š\n-â”Š122â”Š   â”Š    async chat(root, { chatId }, { currentUser, injector }) {\n+â”Š   â”Š130â”Š    async chat(root, { chatId }, { injector }) {\n+â”Š   â”Š131â”Š      const currentUser = await injector.get(Auth).currentUser();\n+â”Š   â”Š132â”Š\n â”Š123â”Š133â”Š      if (!currentUser) return null;\n â”Š124â”Š134â”Š\n â”Š125â”Š135â”Š      return injector\n```\n```diff\n@@ -129,7 +139,9 @@\n â”Š129â”Š139â”Š  },\n â”Š130â”Š140â”Š\n â”Š131â”Š141â”Š  Mutation: {\n-â”Š132â”Š   â”Š    async addMessage(root, { chatId, content }, { currentUser, injector }) {\n+â”Š   â”Š142â”Š    async addMessage(root, { chatId, content }, { injector }) {\n+â”Š   â”Š143â”Š      const currentUser = await injector.get(Auth).currentUser();\n+â”Š   â”Š144â”Š\n â”Š133â”Š145â”Š      if (!currentUser) return null;\n â”Š134â”Š146â”Š\n â”Š135â”Š147â”Š      return injector\n```\n```diff\n@@ -137,7 +149,9 @@\n â”Š137â”Š149â”Š        .addMessage({ chatId, content, userId: currentUser.id });\n â”Š138â”Š150â”Š    },\n â”Š139â”Š151â”Š\n-â”Š140â”Š   â”Š    async addChat(root, { recipientId }, { currentUser, injector }) {\n+â”Š   â”Š152â”Š    async addChat(root, { recipientId }, { injector }) {\n+â”Š   â”Š153â”Š      const currentUser = await injector.get(Auth).currentUser();\n+â”Š   â”Š154â”Š\n â”Š141â”Š155â”Š      if (!currentUser) return null;\n â”Š142â”Š156â”Š\n â”Š143â”Š157â”Š      return injector\n```\n```diff\n@@ -145,7 +159,9 @@\n â”Š145â”Š159â”Š        .addChat({ recipientId, userId: currentUser.id });\n â”Š146â”Š160â”Š    },\n â”Š147â”Š161â”Š\n-â”Š148â”Š   â”Š    async removeChat(root, { chatId }, { currentUser, injector }) {\n+â”Š   â”Š162â”Š    async removeChat(root, { chatId }, { injector }) {\n+â”Š   â”Š163â”Š      const currentUser = await injector.get(Auth).currentUser();\n+â”Š   â”Š164â”Š\n â”Š149â”Š165â”Š      if (!currentUser) return null;\n â”Š150â”Š166â”Š\n â”Š151â”Š167â”Š      return injector.get(Chats).removeChat({ chatId, userId: currentUser.id });\n```\n```diff\n@@ -160,8 +176,10 @@\n â”Š160â”Š176â”Š        async (\n â”Š161â”Š177â”Š          { messageAdded }: { messageAdded: Message },\n â”Š162â”Š178â”Š          args,\n-â”Š163â”Š   â”Š          { currentUser, injector }\n+â”Š   â”Š179â”Š          { injector }\n â”Š164â”Š180â”Š        ) => {\n+â”Š   â”Š181â”Š          const currentUser = await injector.get(Auth).currentUser();\n+â”Š   â”Š182â”Š\n â”Š165â”Š183â”Š          if (!currentUser) return false;\n â”Š166â”Š184â”Š\n â”Š167â”Š185â”Š          return injector.get(Chats).isParticipant({\n```\n```diff\n@@ -176,11 +194,9 @@\n â”Š176â”Š194â”Š      subscribe: withFilter(\n â”Š177â”Š195â”Š        (root, args, { injector }) =>\n â”Š178â”Š196â”Š          injector.get(PubSub).asyncIterator('chatAdded'),\n-â”Š179â”Š   â”Š        async (\n-â”Š180â”Š   â”Š          { chatAdded }: { chatAdded: Chat },\n-â”Š181â”Š   â”Š          args,\n-â”Š182â”Š   â”Š          { currentUser, injector }\n-â”Š183â”Š   â”Š        ) => {\n+â”Š   â”Š197â”Š        async ({ chatAdded }: { chatAdded: Chat }, args, { injector }) => {\n+â”Š   â”Š198â”Š          const currentUser = await injector.get(Auth).currentUser();\n+â”Š   â”Š199â”Š\n â”Š184â”Š200â”Š          if (!currentUser) return false;\n â”Š185â”Š201â”Š\n â”Š186â”Š202â”Š          return injector.get(Chats).isParticipant({\n```\n```diff\n@@ -195,11 +211,9 @@\n â”Š195â”Š211â”Š      subscribe: withFilter(\n â”Š196â”Š212â”Š        (root, args, { injector }) =>\n â”Š197â”Š213â”Š          injector.get(PubSub).asyncIterator('chatRemoved'),\n-â”Š198â”Š   â”Š        async (\n-â”Š199â”Š   â”Š          { targetChat }: { targetChat: Chat },\n-â”Š200â”Š   â”Š          args,\n-â”Š201â”Š   â”Š          { currentUser, injector }\n-â”Š202â”Š   â”Š        ) => {\n+â”Š   â”Š214â”Š        async ({ targetChat }: { targetChat: Chat }, args, { injector }) => {\n+â”Š   â”Š215â”Š          const currentUser = await injector.get(Auth).currentUser();\n+â”Š   â”Š216â”Š\n â”Š203â”Š217â”Š          if (!currentUser) return false;\n â”Š204â”Š218â”Š\n â”Š205â”Š219â”Š          return injector.get(Chats).isParticipant({\n```\n\n[}]: #\n\nBecause we no longer need `db` instance in the context, let's remove it:\n\n[{]: <helper> (diffStep \"13.21\" module=\"server\")\n\n#### [__Server__ Step 13.21: Remove db from context](https://github.com/Urigo/WhatsApp-Clone-Server/commit/7b4e4d82df6e1adde56229a087911d6f7e899d3c)\n\n##### Changed context.ts\n```diff\n@@ -1,8 +1,6 @@\n â”Š1â”Š1â”Šimport { ModuleContext } from '@graphql-modules/core';\n â”Š2â”Š2â”Šimport { Response } from 'express';\n-â”Š3â”Š â”Šimport { PoolClient } from 'pg';\n â”Š4â”Š3â”Š\n â”Š5â”Š4â”Šexport type MyContext = {\n â”Š6â”Š5â”Š  res: Response;\n-â”Š7â”Š â”Š  db: PoolClient;\n â”Š8â”Š6â”Š} & ModuleContext;\n```\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -1,9 +1,8 @@\n â”Š1â”Š1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š2â”Š2â”Šimport { gql, withFilter } from 'apollo-server-express';\n-â”Š3â”Š â”Šimport sql from 'sql-template-strings';\n â”Š4â”Š3â”Šimport commonModule from '../common';\n â”Š5â”Š4â”Šimport usersModule from '../users';\n-â”Š6â”Š â”Šimport { Message, Chat, pool } from '../../db';\n+â”Š â”Š5â”Šimport { Message, Chat } from '../../db';\n â”Š7â”Š6â”Šimport { Resolvers } from '../../types/graphql';\n â”Š8â”Š7â”Šimport { UnsplashApi } from './unsplash.api';\n â”Š9â”Š8â”Šimport { Users } from './../users/users.provider';\n```\n\n##### Changed modules&#x2F;common&#x2F;index.ts\n```diff\n@@ -54,16 +54,9 @@\n â”Š54â”Š54â”Š    },\n â”Š55â”Š55â”Š    Database,\n â”Š56â”Š56â”Š  ],\n-â”Š57â”Š  â”Š  async context({ res, connection }) {\n-â”Š58â”Š  â”Š    let db;\n-â”Š59â”Š  â”Š\n-â”Š60â”Š  â”Š    if (!connection) {\n-â”Š61â”Š  â”Š      db = await pool.connect();\n-â”Š62â”Š  â”Š    }\n-â”Š63â”Š  â”Š\n+â”Š  â”Š57â”Š  async context({ res }) {\n â”Š64â”Š58â”Š    return {\n â”Š65â”Š59â”Š      res,\n-â”Š66â”Š  â”Š      db,\n â”Š67â”Š60â”Š    };\n â”Š68â”Š61â”Š  },\n â”Š69â”Š62â”Š});\n```\n\n##### Changed modules&#x2F;users&#x2F;index.ts\n```diff\n@@ -1,11 +1,9 @@\n â”Š 1â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š 2â”Š 2â”Šimport { gql } from 'apollo-server-express';\n-â”Š 3â”Š  â”Šimport sql from 'sql-template-strings';\n â”Š 4â”Š 3â”Šimport bcrypt from 'bcrypt';\n â”Š 5â”Š 4â”Šimport jwt from 'jsonwebtoken';\n â”Š 6â”Š 5â”Šimport commonModule from '../common';\n â”Š 7â”Š 6â”Šimport { secret, expiration } from '../../env';\n-â”Š 8â”Š  â”Šimport { pool } from '../../db';\n â”Š 9â”Š 7â”Šimport { validateLength, validatePassword } from '../../validators';\n â”Š10â”Š 8â”Šimport { Resolvers } from '../../types/graphql';\n â”Š11â”Š 9â”Šimport { Users } from './users.provider';\n```\n\n[}]: #\n\nBesides the `currentUser` method we're going to have two more, one to sign in and the other to sign up:\n\n[{]: <helper> (diffStep \"13.22\" module=\"server\")\n\n#### [__Server__ Step 13.22: Move signUp logic to Auth provider](https://github.com/Urigo/WhatsApp-Clone-Server/commit/f9b04da64f48fc297ab58f5313b6c798f8718317)\n\n##### Changed modules&#x2F;users&#x2F;auth.provider.ts\n```diff\n@@ -2,6 +2,7 @@\n â”Š2â”Š2â”Šimport { ModuleSessionInfo } from '@graphql-modules/core';\n â”Š3â”Š3â”Šimport jwt from 'jsonwebtoken';\n â”Š4â”Š4â”Šimport { secret } from '../../env';\n+â”Š â”Š5â”Šimport { validateLength, validatePassword } from '../../validators';\n â”Š5â”Š6â”Šimport { Users } from './users.provider';\n â”Š6â”Š7â”Šimport { User } from '../../db';\n â”Š7â”Š8â”Š\n```\n```diff\n@@ -16,6 +17,38 @@\n â”Š16â”Š17â”Š    return this.module.session.req || this.module.session.request;\n â”Š17â”Š18â”Š  }\n â”Š18â”Š19â”Š\n+â”Š  â”Š20â”Š  async signUp({\n+â”Š  â”Š21â”Š    name,\n+â”Š  â”Š22â”Š    password,\n+â”Š  â”Š23â”Š    passwordConfirm,\n+â”Š  â”Š24â”Š    username,\n+â”Š  â”Š25â”Š  }: {\n+â”Š  â”Š26â”Š    name: string;\n+â”Š  â”Š27â”Š    password: string;\n+â”Š  â”Š28â”Š    passwordConfirm: string;\n+â”Š  â”Š29â”Š    username: string;\n+â”Š  â”Š30â”Š  }) {\n+â”Š  â”Š31â”Š    validateLength('req.name', name, 3, 50);\n+â”Š  â”Š32â”Š    validateLength('req.username', username, 3, 18);\n+â”Š  â”Š33â”Š    validatePassword('req.password', password);\n+â”Š  â”Š34â”Š\n+â”Š  â”Š35â”Š    if (password !== passwordConfirm) {\n+â”Š  â”Š36â”Š      throw Error(\"req.password and req.passwordConfirm don't match\");\n+â”Š  â”Š37â”Š    }\n+â”Š  â”Š38â”Š\n+â”Š  â”Š39â”Š    const existingUser = await this.users.findByUsername(username);\n+â”Š  â”Š40â”Š\n+â”Š  â”Š41â”Š    if (existingUser) {\n+â”Š  â”Š42â”Š      throw Error('username already exists');\n+â”Š  â”Š43â”Š    }\n+â”Š  â”Š44â”Š\n+â”Š  â”Š45â”Š    return this.users.newUser({\n+â”Š  â”Š46â”Š      username,\n+â”Š  â”Š47â”Š      name,\n+â”Š  â”Š48â”Š      password,\n+â”Š  â”Š49â”Š    });\n+â”Š  â”Š50â”Š  }\n+â”Š  â”Š51â”Š\n â”Š19â”Š52â”Š  async currentUser(): Promise<User | null> {\n â”Š20â”Š53â”Š    if (this.req.cookies.authToken) {\n â”Š21â”Š54â”Š      const username = jwt.verify(this.req.cookies.authToken, secret) as string;\n```\n\n##### Changed modules&#x2F;users&#x2F;index.ts\n```diff\n@@ -4,7 +4,6 @@\n â”Š 4â”Š 4â”Šimport jwt from 'jsonwebtoken';\n â”Š 5â”Š 5â”Šimport commonModule from '../common';\n â”Š 6â”Š 6â”Šimport { secret, expiration } from '../../env';\n-â”Š 7â”Š  â”Šimport { validateLength, validatePassword } from '../../validators';\n â”Š 8â”Š 7â”Šimport { Resolvers } from '../../types/graphql';\n â”Š 9â”Š 8â”Šimport { Users } from './users.provider';\n â”Š10â”Š 9â”Šimport { Auth } from './auth.provider';\n```\n```diff\n@@ -71,26 +70,9 @@\n â”Š71â”Š70â”Š      { name, username, password, passwordConfirm },\n â”Š72â”Š71â”Š      { injector }\n â”Š73â”Š72â”Š    ) {\n-â”Š74â”Š  â”Š      validateLength('req.name', name, 3, 50);\n-â”Š75â”Š  â”Š      validateLength('req.username', username, 3, 18);\n-â”Š76â”Š  â”Š      validatePassword('req.password', password);\n-â”Š77â”Š  â”Š\n-â”Š78â”Š  â”Š      if (password !== passwordConfirm) {\n-â”Š79â”Š  â”Š        throw Error(\"req.password and req.passwordConfirm don't match\");\n-â”Š80â”Š  â”Š      }\n-â”Š81â”Š  â”Š\n-â”Š82â”Š  â”Š      const existingUser = await injector.get(Users).findByUsername(username);\n-â”Š83â”Š  â”Š      if (existingUser) {\n-â”Š84â”Š  â”Š        throw Error('username already exists');\n-â”Š85â”Š  â”Š      }\n-â”Š86â”Š  â”Š\n-â”Š87â”Š  â”Š      const createdUser = await injector.get(Users).newUser({\n-â”Š88â”Š  â”Š        username,\n-â”Š89â”Š  â”Š        password,\n-â”Š90â”Š  â”Š        name,\n-â”Š91â”Š  â”Š      });\n-â”Š92â”Š  â”Š\n-â”Š93â”Š  â”Š      return createdUser;\n+â”Š  â”Š73â”Š      return injector\n+â”Š  â”Š74â”Š        .get(Auth)\n+â”Š  â”Š75â”Š        .signUp({ name, username, password, passwordConfirm });\n â”Š94â”Š76â”Š    },\n â”Š95â”Š77â”Š  },\n â”Š96â”Š78â”Š};\n```\n\n[}]: #\n[{]: <helper> (diffStep \"13.23\" module=\"server\")\n\n#### [__Server__ Step 13.23: Move signIn logic to Auth provider](https://github.com/Urigo/WhatsApp-Clone-Server/commit/865987d0f59da831c82341cb5cb9c42dfd1ec1e8)\n\n##### Changed context.ts\n```diff\n@@ -1,6 +1,3 @@\n â”Š1â”Š1â”Šimport { ModuleContext } from '@graphql-modules/core';\n-â”Š2â”Š â”Šimport { Response } from 'express';\n â”Š3â”Š2â”Š\n-â”Š4â”Š â”Šexport type MyContext = {\n-â”Š5â”Š â”Š  res: Response;\n-â”Š6â”Š â”Š} & ModuleContext;\n+â”Š â”Š3â”Šexport type MyContext = ModuleContext;\n```\n\n##### Changed modules&#x2F;common&#x2F;index.ts\n```diff\n@@ -54,9 +54,4 @@\n â”Š54â”Š54â”Š    },\n â”Š55â”Š55â”Š    Database,\n â”Š56â”Š56â”Š  ],\n-â”Š57â”Š  â”Š  async context({ res }) {\n-â”Š58â”Š  â”Š    return {\n-â”Š59â”Š  â”Š      res,\n-â”Š60â”Š  â”Š    };\n-â”Š61â”Š  â”Š  },\n â”Š62â”Š57â”Š});\n```\n\n##### Changed modules&#x2F;users&#x2F;auth.provider.ts\n```diff\n@@ -1,7 +1,9 @@\n â”Š1â”Š1â”Šimport { Injectable, Inject, ProviderScope } from '@graphql-modules/di';\n â”Š2â”Š2â”Šimport { ModuleSessionInfo } from '@graphql-modules/core';\n+â”Š â”Š3â”Šimport { Response } from 'express';\n+â”Š â”Š4â”Šimport bcrypt from 'bcrypt';\n â”Š3â”Š5â”Šimport jwt from 'jsonwebtoken';\n-â”Š4â”Š â”Šimport { secret } from '../../env';\n+â”Š â”Š6â”Šimport { secret, expiration } from '../../env';\n â”Š5â”Š7â”Šimport { validateLength, validatePassword } from '../../validators';\n â”Š6â”Š8â”Šimport { Users } from './users.provider';\n â”Š7â”Š9â”Šimport { User } from '../../db';\n```\n```diff\n@@ -17,6 +19,30 @@\n â”Š17â”Š19â”Š    return this.module.session.req || this.module.session.request;\n â”Š18â”Š20â”Š  }\n â”Š19â”Š21â”Š\n+â”Š  â”Š22â”Š  private get res(): Response {\n+â”Š  â”Š23â”Š    return this.module.session.res;\n+â”Š  â”Š24â”Š  }\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Š  async signIn({ username, password }: { username: string; password: string }) {\n+â”Š  â”Š27â”Š    const user = await this.users.findByUsername(username);\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š    if (!user) {\n+â”Š  â”Š30â”Š      throw new Error('user not found');\n+â”Š  â”Š31â”Š    }\n+â”Š  â”Š32â”Š\n+â”Š  â”Š33â”Š    const passwordsMatch = bcrypt.compareSync(password, user.password);\n+â”Š  â”Š34â”Š\n+â”Š  â”Š35â”Š    if (!passwordsMatch) {\n+â”Š  â”Š36â”Š      throw new Error('password is incorrect');\n+â”Š  â”Š37â”Š    }\n+â”Š  â”Š38â”Š\n+â”Š  â”Š39â”Š    const authToken = jwt.sign(username, secret);\n+â”Š  â”Š40â”Š\n+â”Š  â”Š41â”Š    this.res.cookie('authToken', authToken, { maxAge: expiration });\n+â”Š  â”Š42â”Š\n+â”Š  â”Š43â”Š    return user;\n+â”Š  â”Š44â”Š  }\n+â”Š  â”Š45â”Š\n â”Š20â”Š46â”Š  async signUp({\n â”Š21â”Š47â”Š    name,\n â”Š22â”Š48â”Š    password,\n```\n\n##### Changed modules&#x2F;users&#x2F;index.ts\n```diff\n@@ -1,9 +1,6 @@\n â”Š1â”Š1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š2â”Š2â”Šimport { gql } from 'apollo-server-express';\n-â”Š3â”Š â”Šimport bcrypt from 'bcrypt';\n-â”Š4â”Š â”Šimport jwt from 'jsonwebtoken';\n â”Š5â”Š3â”Šimport commonModule from '../common';\n-â”Š6â”Š â”Šimport { secret, expiration } from '../../env';\n â”Š7â”Š4â”Šimport { Resolvers } from '../../types/graphql';\n â”Š8â”Š5â”Šimport { Users } from './users.provider';\n â”Š9â”Š6â”Šimport { Auth } from './auth.provider';\n```\n```diff\n@@ -45,24 +42,8 @@\n â”Š45â”Š42â”Š    },\n â”Š46â”Š43â”Š  },\n â”Š47â”Š44â”Š  Mutation: {\n-â”Š48â”Š  â”Š    async signIn(root, { username, password }, { injector, res }) {\n-â”Š49â”Š  â”Š      const user = await injector.get(Users).findByUsername(username);\n-â”Š50â”Š  â”Š\n-â”Š51â”Š  â”Š      if (!user) {\n-â”Š52â”Š  â”Š        throw new Error('user not found');\n-â”Š53â”Š  â”Š      }\n-â”Š54â”Š  â”Š\n-â”Š55â”Š  â”Š      const passwordsMatch = bcrypt.compareSync(password, user.password);\n-â”Š56â”Š  â”Š\n-â”Š57â”Š  â”Š      if (!passwordsMatch) {\n-â”Š58â”Š  â”Š        throw new Error('password is incorrect');\n-â”Š59â”Š  â”Š      }\n-â”Š60â”Š  â”Š\n-â”Š61â”Š  â”Š      const authToken = jwt.sign(username, secret);\n-â”Š62â”Š  â”Š\n-â”Š63â”Š  â”Š      res.cookie('authToken', authToken, { maxAge: expiration });\n-â”Š64â”Š  â”Š\n-â”Š65â”Š  â”Š      return user;\n+â”Š  â”Š45â”Š    async signIn(root, { username, password }, { injector }) {\n+â”Š  â”Š46â”Š      return injector.get(Auth).signIn({ username, password });\n â”Š66â”Š47â”Š    },\n â”Š67â”Š48â”Š\n â”Š68â”Š49â”Š    async signUp(\n```\n\n[}]: #\n\n#### Exposing server instance\n\nIf you would run `yarn test` right now, you will see a lot of errors, every test will fail. That's because we changed our setup but we didn't adjusted tests.\n\nWe're going to change the setup of tests as well so whenever we do something on server it won't affect them. Instead of exposing schema and context as we did before, we're going to base the tests on a ready to use ApolloServer instance.\n\nIn order to achieve it, we need to separate ApolloServer from other server related logic.\n\n[{]: <helper> (diffStep \"13.24\" module=\"server\")\n\n#### [__Server__ Step 13.24: Move ApolloServer and RootModule into a separate file](https://github.com/Urigo/WhatsApp-Clone-Server/commit/fde2f7422dde8109ed588be45738caf777812b02)\n\n##### Changed index.ts\n```diff\n@@ -1,35 +1,7 @@\n-â”Š 1â”Š  â”Šimport 'reflect-metadata';\n-â”Š 2â”Š  â”Šimport { ApolloServer } from 'apollo-server-express';\n-â”Š 3â”Š  â”Šimport { GraphQLModule } from '@graphql-modules/core';\n-â”Š 4â”Š  â”Šimport cookie from 'cookie';\n â”Š 5â”Š 1â”Šimport http from 'http';\n â”Š 6â”Š 2â”Šimport { app } from './app';\n â”Š 7â”Š 3â”Šimport { origin, port } from './env';\n-â”Š 8â”Š  â”Š\n-â”Š 9â”Š  â”Šimport usersModule from './modules/users';\n-â”Š10â”Š  â”Šimport chatsModule from './modules/chats';\n-â”Š11â”Š  â”Š\n-â”Š12â”Š  â”Šexport const rootModule = new GraphQLModule({\n-â”Š13â”Š  â”Š  name: 'root',\n-â”Š14â”Š  â”Š  imports: [usersModule, chatsModule],\n-â”Š15â”Š  â”Š});\n-â”Š16â”Š  â”Š\n-â”Š17â”Š  â”Šconst server = new ApolloServer({\n-â”Š18â”Š  â”Š  schema: rootModule.schema,\n-â”Š19â”Š  â”Š  context: (session: any) => {\n-â”Š20â”Š  â”Š    if (session.connection) {\n-â”Š21â”Š  â”Š      const req = session.connection.context.session.request;\n-â”Š22â”Š  â”Š      const cookies = req.headers.cookie;\n-â”Š23â”Š  â”Š\n-â”Š24â”Š  â”Š      if (cookies) {\n-â”Š25â”Š  â”Š        req.cookies = cookie.parse(cookies);\n-â”Š26â”Š  â”Š      }\n-â”Š27â”Š  â”Š    }\n-â”Š28â”Š  â”Š\n-â”Š29â”Š  â”Š    return rootModule.context(session);\n-â”Š30â”Š  â”Š  },\n-â”Š31â”Š  â”Š  subscriptions: rootModule.subscriptions,\n-â”Š32â”Š  â”Š});\n+â”Š  â”Š 4â”Šimport { server } from './server';\n â”Š33â”Š 5â”Š\n â”Š34â”Š 6â”Šserver.applyMiddleware({\n â”Š35â”Š 7â”Š  app,\n```\n\n##### Added server.ts\n```diff\n@@ -0,0 +1,29 @@\n+â”Š  â”Š 1â”Šimport 'reflect-metadata';\n+â”Š  â”Š 2â”Šimport { ApolloServer } from 'apollo-server-express';\n+â”Š  â”Š 3â”Šimport { GraphQLModule } from '@graphql-modules/core';\n+â”Š  â”Š 4â”Šimport cookie from 'cookie';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šimport usersModule from './modules/users';\n+â”Š  â”Š 7â”Šimport chatsModule from './modules/chats';\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Šexport const rootModule = new GraphQLModule({\n+â”Š  â”Š10â”Š  name: 'root',\n+â”Š  â”Š11â”Š  imports: [usersModule, chatsModule],\n+â”Š  â”Š12â”Š});\n+â”Š  â”Š13â”Š\n+â”Š  â”Š14â”Šconst server = new ApolloServer({\n+â”Š  â”Š15â”Š  schema: rootModule.schema,\n+â”Š  â”Š16â”Š  context: (session: any) => {\n+â”Š  â”Š17â”Š    if (session.connection) {\n+â”Š  â”Š18â”Š      const req = session.connection.context.session.request;\n+â”Š  â”Š19â”Š      const cookies = req.headers.cookie;\n+â”Š  â”Š20â”Š\n+â”Š  â”Š21â”Š      if (cookies) {\n+â”Š  â”Š22â”Š        req.cookies = cookie.parse(cookies);\n+â”Š  â”Š23â”Š      }\n+â”Š  â”Š24â”Š    }\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Š    return rootModule.context(session);\n+â”Š  â”Š27â”Š  },\n+â”Š  â”Š28â”Š  subscriptions: rootModule.subscriptions,\n+â”Š  â”Š29â”Š});\n```\n\n[}]: #\n[{]: <helper> (diffStep \"13.25\" module=\"server\")\n\n#### [__Server__ Step 13.25: Export server instance](https://github.com/Urigo/WhatsApp-Clone-Server/commit/c4a44c095ef537bb09fb88484c4c1edb3452af0b)\n\n##### Changed server.ts\n```diff\n@@ -11,7 +11,7 @@\n â”Š11â”Š11â”Š  imports: [usersModule, chatsModule],\n â”Š12â”Š12â”Š});\n â”Š13â”Š13â”Š\n-â”Š14â”Š  â”Šconst server = new ApolloServer({\n+â”Š  â”Š14â”Šexport const server = new ApolloServer({\n â”Š15â”Š15â”Š  schema: rootModule.schema,\n â”Š16â”Š16â”Š  context: (session: any) => {\n â”Š17â”Š17â”Š    if (session.connection) {\n```\n\n[}]: #\n\nThere's one thing that changed and might break our tests, this line fix it:\n\n[{]: <helper> (diffStep \"13.26\" module=\"server\")\n\n#### [__Server__ Step 13.26: Define mocked version of Auth provider](https://github.com/Urigo/WhatsApp-Clone-Server/commit/c39b959e740daa06a14cd49ae3479a788d7a24a8)\n\n##### Added tests&#x2F;mocks&#x2F;auth.provider.ts\n```diff\n@@ -0,0 +1,21 @@\n+â”Š  â”Š 1â”Šimport sql from 'sql-template-strings';\n+â”Š  â”Š 2â”Šimport { Auth } from './../../modules/users/auth.provider';\n+â”Š  â”Š 3â”Šimport usersModule from './../../modules/users';\n+â”Š  â”Š 4â”Šimport { pool } from '../../db';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šexport function mockAuth(userId: number) {\n+â”Š  â”Š 7â”Š  class AuthMock extends Auth {\n+â”Š  â”Š 8â”Š    async currentUser() {\n+â”Š  â”Š 9â”Š      const { rows } = await pool.query(\n+â”Š  â”Š10â”Š        sql`SELECT * FROM users WHERE id = ${userId}`\n+â”Š  â”Š11â”Š      );\n+â”Š  â”Š12â”Š      return rows[0];\n+â”Š  â”Š13â”Š    }\n+â”Š  â”Š14â”Š  }\n+â”Š  â”Š15â”Š\n+â”Š  â”Š16â”Š  usersModule.injector.provide({\n+â”Š  â”Š17â”Š    provide: Auth,\n+â”Š  â”Š18â”Š    useClass: AuthMock,\n+â”Š  â”Š19â”Š    overwrite: true,\n+â”Š  â”Š20â”Š  });\n+â”Š  â”Š21â”Š}\n```\n\n[}]: #\n\nRemember when I said about benefits of Dependency Injection? Here's one of them. We create a function that overwrites the `currentUser` method so it always returns a specific user.\n\n[{]: <helper> (diffStep \"13.27\" module=\"server\")\n\n#### [__Server__ Step 13.27: Adjust tests](https://github.com/Urigo/WhatsApp-Clone-Server/commit/1d58f140258a21f62e1c33eee8acf6a4c95e75b1)\n\n##### Changed tests&#x2F;mutations&#x2F;addChat.test.ts\n```diff\n@@ -1,28 +1,14 @@\n â”Š 1â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n-â”Š 2â”Š  â”Šimport { ApolloServer, PubSub, gql } from 'apollo-server-express';\n-â”Š 3â”Š  â”Šimport { rootModule } from '../../index';\n-â”Š 4â”Š  â”Šimport { resetDb, pool } from '../../db';\n-â”Š 5â”Š  â”Šimport sql from 'sql-template-strings';\n-â”Š 6â”Š  â”Šimport { MyContext } from '../../context';\n+â”Š  â”Š 2â”Šimport { gql } from 'apollo-server-express';\n+â”Š  â”Š 3â”Šimport { server } from '../../server';\n+â”Š  â”Š 4â”Šimport { resetDb } from '../../db';\n+â”Š  â”Š 5â”Šimport { mockAuth } from '../mocks/auth.provider';\n â”Š 7â”Š 6â”Š\n â”Š 8â”Š 7â”Šdescribe('Mutation.addChat', () => {\n â”Š 9â”Š 8â”Š  beforeEach(resetDb);\n â”Š10â”Š 9â”Š\n â”Š11â”Š10â”Š  it('creates a new chat between current user and specified recipient', async () => {\n-â”Š12â”Š  â”Š    const { rows } = await pool.query(sql`SELECT * FROM users WHERE id = 2`);\n-â”Š13â”Š  â”Š    const currentUser = rows[0];\n-â”Š14â”Š  â”Š    const server = new ApolloServer({\n-â”Š15â”Š  â”Š      schema: rootModule.schema,\n-â”Š16â”Š  â”Š      context: async () => ({\n-â”Š17â”Š  â”Š        pubsub: new PubSub(),\n-â”Š18â”Š  â”Š        currentUser,\n-â”Š19â”Š  â”Š        db: await pool.connect(),\n-â”Š20â”Š  â”Š      }),\n-â”Š21â”Š  â”Š      formatResponse: (res: any, { context }: { context: MyContext }) => {\n-â”Š22â”Š  â”Š        context.db.release();\n-â”Š23â”Š  â”Š        return res;\n-â”Š24â”Š  â”Š      },\n-â”Š25â”Š  â”Š    });\n+â”Š  â”Š11â”Š    mockAuth(2);\n â”Š26â”Š12â”Š\n â”Š27â”Š13â”Š    const { query, mutate } = createTestClient(server);\n â”Š28â”Š14â”Š\n```\n```diff\n@@ -66,20 +52,7 @@\n â”Š66â”Š52â”Š  });\n â”Š67â”Š53â”Š\n â”Š68â”Š54â”Š  it('returns the existing chat if so', async () => {\n-â”Š69â”Š  â”Š    const { rows } = await pool.query(sql`SELECT * FROM users WHERE id = 1`);\n-â”Š70â”Š  â”Š    const currentUser = rows[0];\n-â”Š71â”Š  â”Š    const server = new ApolloServer({\n-â”Š72â”Š  â”Š      schema: rootModule.schema,\n-â”Š73â”Š  â”Š      context: async () => ({\n-â”Š74â”Š  â”Š        pubsub: new PubSub(),\n-â”Š75â”Š  â”Š        currentUser,\n-â”Š76â”Š  â”Š        db: await pool.connect(),\n-â”Š77â”Š  â”Š      }),\n-â”Š78â”Š  â”Š      formatResponse: (res: any, { context }: { context: MyContext }) => {\n-â”Š79â”Š  â”Š        context.db.release();\n-â”Š80â”Š  â”Š        return res;\n-â”Š81â”Š  â”Š      },\n-â”Š82â”Š  â”Š    });\n+â”Š  â”Š55â”Š    mockAuth(1);\n â”Š83â”Š56â”Š\n â”Š84â”Š57â”Š    const { query, mutate } = createTestClient(server);\n â”Š85â”Š58â”Š\n```\n\n##### Changed tests&#x2F;mutations&#x2F;addMessage.test.ts\n```diff\n@@ -1,28 +1,14 @@\n â”Š 1â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n-â”Š 2â”Š  â”Šimport { ApolloServer, PubSub, gql } from 'apollo-server-express';\n-â”Š 3â”Š  â”Šimport { rootModule } from '../../index';\n-â”Š 4â”Š  â”Šimport { resetDb, pool } from '../../db';\n-â”Š 5â”Š  â”Šimport sql from 'sql-template-strings';\n-â”Š 6â”Š  â”Šimport { MyContext } from '../../context';\n+â”Š  â”Š 2â”Šimport { gql } from 'apollo-server-express';\n+â”Š  â”Š 3â”Šimport { server } from '../../server';\n+â”Š  â”Š 4â”Šimport { resetDb } from '../../db';\n+â”Š  â”Š 5â”Šimport { mockAuth } from '../mocks/auth.provider';\n â”Š 7â”Š 6â”Š\n â”Š 8â”Š 7â”Šdescribe('Mutation.addMessage', () => {\n â”Š 9â”Š 8â”Š  beforeEach(resetDb);\n â”Š10â”Š 9â”Š\n â”Š11â”Š10â”Š  it('should add message to specified chat', async () => {\n-â”Š12â”Š  â”Š    const { rows } = await pool.query(sql`SELECT * FROM users WHERE id = 1`);\n-â”Š13â”Š  â”Š    const currentUser = rows[0];\n-â”Š14â”Š  â”Š    const server = new ApolloServer({\n-â”Š15â”Š  â”Š      schema: rootModule.schema,\n-â”Š16â”Š  â”Š      context: async () => ({\n-â”Š17â”Š  â”Š        pubsub: new PubSub(),\n-â”Š18â”Š  â”Š        currentUser,\n-â”Š19â”Š  â”Š        db: await pool.connect(),\n-â”Š20â”Š  â”Š      }),\n-â”Š21â”Š  â”Š      formatResponse: (res: any, { context }: { context: MyContext }) => {\n-â”Š22â”Š  â”Š        context.db.release();\n-â”Š23â”Š  â”Š        return res;\n-â”Š24â”Š  â”Š      },\n-â”Š25â”Š  â”Š    });\n+â”Š  â”Š11â”Š    mockAuth(1);\n â”Š26â”Š12â”Š\n â”Š27â”Š13â”Š    const { query, mutate } = createTestClient(server);\n â”Š28â”Š14â”Š\n```\n\n##### Changed tests&#x2F;mutations&#x2F;removeChat.test.ts\n```diff\n@@ -1,28 +1,14 @@\n â”Š 1â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n-â”Š 2â”Š  â”Šimport { ApolloServer, PubSub, gql } from 'apollo-server-express';\n-â”Š 3â”Š  â”Šimport { rootModule } from '../../index';\n-â”Š 4â”Š  â”Šimport { resetDb, pool } from '../../db';\n-â”Š 5â”Š  â”Šimport sql from 'sql-template-strings';\n-â”Š 6â”Š  â”Šimport { MyContext } from '../../context';\n+â”Š  â”Š 2â”Šimport { gql } from 'apollo-server-express';\n+â”Š  â”Š 3â”Šimport { server } from '../../server';\n+â”Š  â”Š 4â”Šimport { resetDb } from '../../db';\n+â”Š  â”Š 5â”Šimport { mockAuth } from '../mocks/auth.provider';\n â”Š 7â”Š 6â”Š\n â”Š 8â”Š 7â”Šdescribe('Mutation.removeChat', () => {\n â”Š 9â”Š 8â”Š  beforeEach(resetDb);\n â”Š10â”Š 9â”Š\n â”Š11â”Š10â”Š  it('removes chat by id', async () => {\n-â”Š12â”Š  â”Š    const { rows } = await pool.query(sql`SELECT * FROM users WHERE id = 1`);\n-â”Š13â”Š  â”Š    const currentUser = rows[0];\n-â”Š14â”Š  â”Š    const server = new ApolloServer({\n-â”Š15â”Š  â”Š      schema: rootModule.schema,\n-â”Š16â”Š  â”Š      context: async () => ({\n-â”Š17â”Š  â”Š        pubsub: new PubSub(),\n-â”Š18â”Š  â”Š        currentUser,\n-â”Š19â”Š  â”Š        db: await pool.connect(),\n-â”Š20â”Š  â”Š      }),\n-â”Š21â”Š  â”Š      formatResponse: (res: any, { context }: { context: MyContext }) => {\n-â”Š22â”Š  â”Š        context.db.release();\n-â”Š23â”Š  â”Š        return res;\n-â”Š24â”Š  â”Š      },\n-â”Š25â”Š  â”Š    });\n+â”Š  â”Š11â”Š    mockAuth(1);\n â”Š26â”Š12â”Š\n â”Š27â”Š13â”Š    const { query, mutate } = createTestClient(server);\n â”Š28â”Š14â”Š\n```\n\n##### Changed tests&#x2F;queries&#x2F;getChat.test.ts\n```diff\n@@ -1,27 +1,14 @@\n â”Š 1â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n-â”Š 2â”Š  â”Šimport { ApolloServer, gql } from 'apollo-server-express';\n-â”Š 3â”Š  â”Šimport { rootModule } from '../../index';\n-â”Š 4â”Š  â”Šimport { poolm resetDb } from '../../db';\n-â”Š 5â”Š  â”Šimport sql from 'sql-template-strings';\n-â”Š 6â”Š  â”Šimport { MyContext } from '../../context';\n+â”Š  â”Š 2â”Šimport { gql } from 'apollo-server-express';\n+â”Š  â”Š 3â”Šimport { server } from '../../server';\n+â”Š  â”Š 4â”Šimport { resetDb } from '../../db';\n+â”Š  â”Š 5â”Šimport { mockAuth } from '../mocks/auth.provider';\n â”Š 7â”Š 6â”Š\n â”Š 8â”Š 7â”Šdescribe('Query.chat', () => {\n â”Š 9â”Š 8â”Š  beforeEach(resetDb);\n â”Š10â”Š 9â”Š\n â”Š11â”Š10â”Š  it('should fetch specified chat', async () => {\n-â”Š12â”Š  â”Š    const { rows } = await pool.query(sql`SELECT * FROM users WHERE id = 1`);\n-â”Š13â”Š  â”Š    const currentUser = rows[0];\n-â”Š14â”Š  â”Š    const server = new ApolloServer({\n-â”Š15â”Š  â”Š      schema: rootModule.schema,\n-â”Š16â”Š  â”Š      context: async () => ({\n-â”Š17â”Š  â”Š        currentUser,\n-â”Š18â”Š  â”Š        db: await pool.connect(),\n-â”Š19â”Š  â”Š      }),\n-â”Š20â”Š  â”Š      formatResponse: (res: any, { context }: { context: MyContext }) => {\n-â”Š21â”Š  â”Š        context.db.release();\n-â”Š22â”Š  â”Š        return res;\n-â”Š23â”Š  â”Š      },\n-â”Š24â”Š  â”Š    });\n+â”Š  â”Š11â”Š    mockAuth(1);\n â”Š25â”Š12â”Š\n â”Š26â”Š13â”Š    const { query } = createTestClient(server);\n â”Š27â”Š14â”Š\n```\n\n##### Changed tests&#x2F;queries&#x2F;getChats.test.ts\n```diff\n@@ -1,27 +1,14 @@\n â”Š 1â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n-â”Š 2â”Š  â”Šimport { ApolloServer, gql } from 'apollo-server-express';\n-â”Š 3â”Š  â”Šimport { rootModule } from '../../index';\n-â”Š 4â”Š  â”Šimport { pool, resetDb } from '../../db';\n-â”Š 5â”Š  â”Šimport sql from 'sql-template-strings';\n-â”Š 6â”Š  â”Šimport { MyContext } from '../../context';\n+â”Š  â”Š 2â”Šimport { gql } from 'apollo-server-express';\n+â”Š  â”Š 3â”Šimport { server } from '../../server';\n+â”Š  â”Š 4â”Šimport { resetDb } from '../../db';\n+â”Š  â”Š 5â”Šimport { mockAuth } from '../mocks/auth.provider';\n â”Š 7â”Š 6â”Š\n â”Š 8â”Š 7â”Šdescribe('Query.chats', () => {\n â”Š 9â”Š 8â”Š  beforeEach(resetDb);\n â”Š10â”Š 9â”Š\n â”Š11â”Š10â”Š  it('should fetch all chats', async () => {\n-â”Š12â”Š  â”Š    const { rows } = await pool.query(sql`SELECT * FROM users WHERE id = 1`);\n-â”Š13â”Š  â”Š    const currentUser = rows[0];\n-â”Š14â”Š  â”Š    const server = new ApolloServer({\n-â”Š15â”Š  â”Š      schema: rootModule.schema,\n-â”Š16â”Š  â”Š      context: async () => ({\n-â”Š17â”Š  â”Š        currentUser,\n-â”Š18â”Š  â”Š        db: await pool.connect(),\n-â”Š19â”Š  â”Š      }),\n-â”Š20â”Š  â”Š      formatResponse: (res: any, { context }: { context: MyContext }) => {\n-â”Š21â”Š  â”Š        context.db.release();\n-â”Š22â”Š  â”Š        return res;\n-â”Š23â”Š  â”Š      },\n-â”Š24â”Š  â”Š    });\n+â”Š  â”Š11â”Š    mockAuth(1);\n â”Š25â”Š12â”Š\n â”Š26â”Š13â”Š    const { query } = createTestClient(server);\n â”Š27â”Š14â”Š\n```\n\n##### Changed tests&#x2F;queries&#x2F;getMe.test.ts\n```diff\n@@ -1,25 +1,14 @@\n â”Š 1â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n-â”Š 2â”Š  â”Šimport { ApolloServer, gql } from 'apollo-server-express';\n-â”Š 3â”Š  â”Šimport { rootModule } from '../../index';\n-â”Š 4â”Š  â”Šimport { pool } from '../../db';\n-â”Š 5â”Š  â”Šimport sql from 'sql-template-strings';\n-â”Š 6â”Š  â”Šimport { MyContext } from '../../context';\n+â”Š  â”Š 2â”Šimport { gql } from 'apollo-server-express';\n+â”Š  â”Š 3â”Šimport { server } from '../../server';\n+â”Š  â”Š 4â”Šimport { resetDb } from '../../db';\n+â”Š  â”Š 5â”Šimport { mockAuth } from '../mocks/auth.provider';\n â”Š 7â”Š 6â”Š\n â”Š 8â”Š 7â”Šdescribe('Query.me', () => {\n+â”Š  â”Š 8â”Š  beforeEach(resetDb);\n+â”Š  â”Š 9â”Š\n â”Š 9â”Š10â”Š  it('should fetch current user', async () => {\n-â”Š10â”Š  â”Š    const { rows } = await pool.query(sql`SELECT * FROM users WHERE id = 1`);\n-â”Š11â”Š  â”Š    const currentUser = rows[0];\n-â”Š12â”Š  â”Š    const server = new ApolloServer({\n-â”Š13â”Š  â”Š      schema: rootModule.schema,\n-â”Š14â”Š  â”Š      context: async () => ({\n-â”Š15â”Š  â”Š        currentUser,\n-â”Š16â”Š  â”Š        db: await pool.connect(),\n-â”Š17â”Š  â”Š      }),\n-â”Š18â”Š  â”Š      formatResponse: (res: any, { context }: { context: MyContext }) => {\n-â”Š19â”Š  â”Š        context.db.release();\n-â”Š20â”Š  â”Š        return res;\n-â”Š21â”Š  â”Š      },\n-â”Š22â”Š  â”Š    });\n+â”Š  â”Š11â”Š    mockAuth(1);\n â”Š23â”Š12â”Š\n â”Š24â”Š13â”Š    const { query } = createTestClient(server);\n â”Š25â”Š14â”Š\n```\n\n##### Changed tests&#x2F;queries&#x2F;getUsers.test.ts\n```diff\n@@ -1,28 +1,14 @@\n â”Š 1â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n-â”Š 2â”Š  â”Šimport { ApolloServer, gql } from 'apollo-server-express';\n-â”Š 3â”Š  â”Šimport { rootModule } from '../../index';\n-â”Š 4â”Š  â”Šimport { pool } from '../../db';\n-â”Š 5â”Š  â”Šimport sql from 'sql-template-strings';\n-â”Š 6â”Š  â”Šimport { MyContext } from '../../context';\n+â”Š  â”Š 2â”Šimport { gql } from 'apollo-server-express';\n+â”Š  â”Š 3â”Šimport { server } from '../../server';\n+â”Š  â”Š 4â”Šimport { resetDb } from '../../db';\n+â”Š  â”Š 5â”Šimport { mockAuth } from '../mocks/auth.provider';\n â”Š 7â”Š 6â”Š\n â”Š 8â”Š 7â”Šdescribe('Query.getUsers', () => {\n+â”Š  â”Š 8â”Š  beforeEach(resetDb);\n+â”Š  â”Š 9â”Š\n â”Š 9â”Š10â”Š  it('should fetch all users except the one signed-in', async () => {\n-â”Š10â”Š  â”Š    const firstUserQuery = await pool.query(\n-â”Š11â”Š  â”Š      sql`SELECT * FROM users WHERE id = 1`\n-â”Š12â”Š  â”Š    );\n-â”Š13â”Š  â”Š    let currentUser = firstUserQuery.rows[0];\n-â”Š14â”Š  â”Š    const db = await pool.connect();\n-â”Š15â”Š  â”Š    const server = new ApolloServer({\n-â”Š16â”Š  â”Š      schema: rootModule.schema,\n-â”Š17â”Š  â”Š      context: async () => ({\n-â”Š18â”Š  â”Š        currentUser,\n-â”Š19â”Š  â”Š        db: await pool.connect(),\n-â”Š20â”Š  â”Š      }),\n-â”Š21â”Š  â”Š      formatResponse: (res: any, { context }: { context: MyContext }) => {\n-â”Š22â”Š  â”Š        context.db.release();\n-â”Š23â”Š  â”Š        return res;\n-â”Š24â”Š  â”Š      },\n-â”Š25â”Š  â”Š    });\n+â”Š  â”Š11â”Š    mockAuth(1);\n â”Š26â”Š12â”Š\n â”Š27â”Š13â”Š    const { query } = createTestClient(server);\n â”Š28â”Š14â”Š\n```\n```diff\n@@ -42,10 +28,7 @@\n â”Š42â”Š28â”Š    expect(res.errors).toBeUndefined();\n â”Š43â”Š29â”Š    expect(res.data).toMatchSnapshot();\n â”Š44â”Š30â”Š\n-â”Š45â”Š  â”Š    const secondUserQuery = await pool.query(\n-â”Š46â”Š  â”Š      sql`SELECT * FROM users WHERE id = '2'`\n-â”Š47â”Š  â”Š    );\n-â”Š48â”Š  â”Š    currentUser = secondUserQuery.rows[0];\n+â”Š  â”Š31â”Š    mockAuth(2);\n â”Š49â”Š32â”Š\n â”Š50â”Š33â”Š    res = await query({\n â”Š51â”Š34â”Š      query: gql`\n```\n\n[}]: #\n\nLet's now migrate all tests and see how easier it is now to manage those. Because we use ApolloServer's instance, we don't need to understand how it's implemented.\n\n[{]: <helper> (diffStep \"13.28\" module=\"server\")\n\n#### Step 13.28: NOT FOUND!\n\n[}]: #\n\n## Adjusting client\n\nWe still need to update `codegen.yml` in the client app because of the changes we introduced in this chapter:\n\n[{]: <helper> (diffStep \"14.1\" module=\"client\")\n\n#### [__Client__ Step 14.1: Adjust to GraphQL Modules](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/346a172570d775d7238c81cef32d872ab2016043)\n\n##### Changed codegen.yml\n```diff\n@@ -1,4 +1,4 @@\n-â”Š1â”Š â”Šschema: ../WhatsApp-Clone-Server/schema/typeDefs.graphql\n+â”Š â”Š1â”Šschema: ../WhatsApp-Clone-Server/modules/*/*.ts\n â”Š2â”Š2â”Šdocuments:\n â”Š3â”Š3â”Š  - ./src/components/**/*.tsx\n â”Š4â”Š4â”Š  - ./src/graphql/fragments/**/*.ts\n```\n\n[}]: #\n\n## Many ways to write GraphQL\n\nWeâ€™re going to discuss what are the possible options of building GraphQL API and why schema-first approach was our choice.\n\nThe main ingredient of a GraphQL API is, of course the schema. Itâ€™s built out of type definitions where each of them describes a piece of data, connections between them and how data is actually resolved.\n\nThe way we develop all of it changes the way we work with the API.\n\nWe could define two main approaches:\n  - schema-first\n  - resolver-first\n\nThe former means design comes before code, the latter vice-versa.\n\nIn schema-first development you start with SDL, resolvers and code go next. Schema is sort of a contract between teams and also between frontend and backend. With schema-first approach itâ€™s easier to cooperate, discuss and write a better API. Because the SDL is written upfront, the frontend developers can use a mocked version of it and start working on the product while the backend team does the API, in parallel.\nThere are of course some pain points. Once schema is splitted into SDL and resolvers itâ€™s hard to keep them in sync and thatâ€™s why things like GraphQL Code Generator were developed, to add type safety on top of all.\n\nThe resolver-first approach is a bit different. The schema is defined programmatically, which usually means itâ€™s more flexible and combined with TypeScript or Flow gives you type-safety out of the box.\n\nWe think itâ€™s less readable than having a SDL and thereâ€™s a lack of separation between schema and code which might be a blocker for some teams."
          },
          {
            "manualTitle": "Step 17: Performance",
            "stepRevision": "b90ac63a516b99536ac9bebc4c458e2bface6fc6",
            "manualView": "In this part of the tutorial we're going to do a bit different work than in previous chapters. We'll analyze the code instead of writing it, including both the API and the web application.\n\n## API Performance\n\nFirst, let's start with the GraphQL API.\n\n### Finding bottlenecks\n\nIn order to implement fixes and do improvements we need to understand which part of the API needs help. There's still not many tools around GraphQL in terms of analytics and inspection but there's one highly useful, it's called **Apollo Engine**.\n\nSince we're going to use it, you need to register an account at [engine.apollographql.com](https://engine.apollographql.com/) and create a service. Please then follow [the \"How to configure an Apollo project\" instructions](https://www.apollographql.com/docs/platform/schema-registry/#using-the-schema-registry).\n\nOnce you're ready, please start the server and run this command:\n\n    $ apollo service:push\n\nTo collect the data, let's play with the client app for some time. After that, go to Engine's website.\n\nHere's one of graphs with timing of an operation. We can understand when each resolver takes place and how much time it consumes. Some resolvers happen in parallel.\nThe `< 1ms` says it was a very simple computation or an element resolved immediately.\n\nWe find it very useful to understand how operation behaves.\n\n![Resolvers](../../../assets/step17/img-01.png \"Resolvers\")\n\nLet's go through an entire query to find fields fetched multiple times. The most obvious field is `isMine`. We see it's computed twice for almost 4 and 5 milliseconds.\nIn order to find out what does it mean, we need to look at the code. The resolver gets the currently logged in user from the `Auth` service and its `currentUser`. Each time the method is invoked, a query to PostgreSQL is made. We ask for that data multiple times, once in `lastMessage` and also in every message from the list.\n\nWe could deduplicate the SQL queries! In order to do that the most obvious library that pops to my mind is Dataloader.\n\nLet's install the package and discuss it afterwards:\n\n    npm install dataloader\n\nThe Dataloader is a library created and maintained by Facebook. It's main purpose is to turn equivalent requests into a single execution. Sounds like a perfect solution, right? It actually is.\n\nA short explaination of how Dataloader works.\n\n```ts\nasync function fetchUser(id: number): Promise<User> {\n  // Resolves asynchronously, after less than 1s.\n  return db.users.findOne(id);\n}\n\nasync function fetchUsers(ids: number[]): Promise<User[]> {\n  const users = ids.map(id => fetchUser(id));\n  return Promise.all(users);\n}\n\nconst loader = new Dataloader(keys => fetchUsers(keys));\n\nasync function main() {\n  const user1 = await loader.load(1);\n  const user2 = await loader.load(2);\n\n  // Later on user #1 is fetched again.\n  // It resolves immediately.\n  const member1 = await loader.load(1);\n}\n```\n\nThink of the Dataloader as a class that has a `Map` object in it, its keys are of course unique and each value is a `Promise`.\nEvery time you ask for something, Dataloader looks for it in the `Map`. When there's already something, the `Promise` is returned but if there's none the provided function is invoked and a new `Promise` is created. This way equivalent requests share the same `Promise`.\n\n> It's important to know that the `Map` object grows until the DataLoader is released, that's why it's recommended to keep `Dataloader` in GraphQL's context.\n\nLet's implement `Dataloader` in our `Database` service:\n\n[{]: <helper> (diffStep \"14.1\" files=\"modules/common/database.provider.ts\" module=\"server\")\n\n#### [__Server__ Step 14.1: Deduplicate SQL queries](https://github.com/Urigo/WhatsApp-Clone-Server/commit/3cf746ba8a23c82b982b695aa38554139e1759b1)\n\n##### Changed modules&#x2F;common&#x2F;database.provider.ts\n```diff\n@@ -1,14 +1,41 @@\n â”Š 1â”Š 1â”Šimport { Injectable, ProviderScope } from '@graphql-modules/di';\n â”Š 2â”Š 2â”Šimport { OnResponse } from '@graphql-modules/core';\n-â”Š 3â”Š  â”Šimport { Pool, PoolClient } from 'pg';\n+â”Š  â”Š 3â”Šimport { Pool, PoolClient, QueryResult } from 'pg';\n+â”Š  â”Š 4â”Šimport { SQLStatement } from 'sql-template-strings';\n+â”Š  â”Š 5â”Šimport Dataloader from 'dataloader';\n â”Š 4â”Š 6â”Š\n â”Š 5â”Š 7â”Š@Injectable({\n â”Š 6â”Š 8â”Š  scope: ProviderScope.Session,\n â”Š 7â”Š 9â”Š})\n â”Š 8â”Š10â”Šexport class Database implements OnResponse {\n â”Š 9â”Š11â”Š  private instance: PoolClient;\n+â”Š  â”Š12â”Š  private loader: Dataloader<string | SQLStatement, QueryResult>;\n â”Š10â”Š13â”Š\n-â”Š11â”Š  â”Š  constructor(private pool: Pool) {}\n+â”Š  â”Š14â”Š  constructor(private pool: Pool) {\n+â”Š  â”Š15â”Š    this.loader = new Dataloader(\n+â”Š  â”Š16â”Š      queries =>\n+â”Š  â”Š17â”Š        Promise.all(\n+â”Š  â”Š18â”Š          queries.map(async query => {\n+â”Š  â”Š19â”Š            const db = await this.getClient();\n+â”Š  â”Š20â”Š            return db.query(query);\n+â”Š  â”Š21â”Š          })\n+â”Š  â”Š22â”Š        ),\n+â”Š  â”Š23â”Š      {\n+â”Š  â”Š24â”Š        cacheKeyFn: (key: string | SQLStatement) => {\n+â”Š  â”Š25â”Š          let id: string;\n+â”Š  â”Š26â”Š\n+â”Š  â”Š27â”Š          if (typeof key === 'string') {\n+â”Š  â”Š28â”Š            id = key;\n+â”Š  â”Š29â”Š          } else {\n+â”Š  â”Š30â”Š            id = key.text + ' - ' + JSON.stringify(key.values);\n+â”Š  â”Š31â”Š          }\n+â”Š  â”Š32â”Š\n+â”Š  â”Š33â”Š          return id;\n+â”Š  â”Š34â”Š        },\n+â”Š  â”Š35â”Š        batch: false,\n+â”Š  â”Š36â”Š      }\n+â”Š  â”Š37â”Š    );\n+â”Š  â”Š38â”Š  }\n â”Š12â”Š39â”Š\n â”Š13â”Š40â”Š  async onRequest() {\n â”Š14â”Š41â”Š    this.instance = await this.pool.connect();\n```\n```diff\n@@ -20,7 +47,11 @@\n â”Š20â”Š47â”Š    }\n â”Š21â”Š48â”Š  }\n â”Š22â”Š49â”Š\n-â”Š23â”Š  â”Š  async getClient() {\n+â”Š  â”Š50â”Š  private getClient() {\n â”Š24â”Š51â”Š    return this.instance;\n â”Š25â”Š52â”Š  }\n+â”Š  â”Š53â”Š\n+â”Š  â”Š54â”Š  query(query: SQLStatement | string) {\n+â”Š  â”Š55â”Š    return this.loader.load(query);\n+â”Š  â”Š56â”Š  }\n â”Š26â”Š57â”Š}\n```\n\n[}]: #\n\nThe key is created based on SQL statement and its values and we also turned off batching because it's important to execute SQL operations sequentially.\nThere's also a new method called `query`, to execute SQL statements through Dataloader. It also reduces a boilerplate of asking for db client and executing a query every time we do SQL in resolvers and providers.\n\nNow we need to apply that change in all providers:\n\n[{]: <helper> (diffStep \"14.1\" files=\"modules/users/users.provider.ts, modules/chats/chats.provider.ts\" module=\"server\")\n\n#### [__Server__ Step 14.1: Deduplicate SQL queries](https://github.com/Urigo/WhatsApp-Clone-Server/commit/3cf746ba8a23c82b982b695aa38554139e1759b1)\n\n##### Changed modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -11,9 +11,7 @@\n â”Š11â”Š11â”Š  @Inject() private pubsub: PubSub;\n â”Š12â”Š12â”Š\n â”Š13â”Š13â”Š  async findChatsByUser(userId: string) {\n-â”Š14â”Š  â”Š    const db = await this.db.getClient();\n-â”Š15â”Š  â”Š\n-â”Š16â”Š  â”Š    const { rows } = await db.query(sql`\n+â”Š  â”Š14â”Š    const { rows } = await this.db.query(sql`\n â”Š17â”Š15â”Š      SELECT chats.* FROM chats, chats_users\n â”Š18â”Š16â”Š      WHERE chats.id = chats_users.chat_id\n â”Š19â”Š17â”Š      AND chats_users.user_id = ${userId}\n```\n```diff\n@@ -23,8 +21,7 @@\n â”Š23â”Š21â”Š  }\n â”Š24â”Š22â”Š\n â”Š25â”Š23â”Š  async findChatByUser({ chatId, userId }: { chatId: string; userId: string }) {\n-â”Š26â”Š  â”Š    const db = await this.db.getClient();\n-â”Š27â”Š  â”Š    const { rows } = await db.query(sql`\n+â”Š  â”Š24â”Š    const { rows } = await this.db.query(sql`\n â”Š28â”Š25â”Š      SELECT chats.* FROM chats, chats_users\n â”Š29â”Š26â”Š      WHERE chats_users.chat_id = ${chatId}\n â”Š30â”Š27â”Š      AND chats.id = chats_users.chat_id\n```\n```diff\n@@ -35,16 +32,14 @@\n â”Š35â”Š32â”Š  }\n â”Š36â”Š33â”Š\n â”Š37â”Š34â”Š  async findChatById(chatId: string) {\n-â”Š38â”Š  â”Š    const db = await this.db.getClient();\n-â”Š39â”Š  â”Š    const { rows } = await db.query(sql`\n+â”Š  â”Š35â”Š    const { rows } = await this.db.query(sql`\n â”Š40â”Š36â”Š      SELECT * FROM chats WHERE id = ${chatId}\n â”Š41â”Š37â”Š    `);\n â”Š42â”Š38â”Š    return rows[0] || null;\n â”Š43â”Š39â”Š  }\n â”Š44â”Š40â”Š\n â”Š45â”Š41â”Š  async findMessagesByChat(chatId: string) {\n-â”Š46â”Š  â”Š    const db = await this.db.getClient();\n-â”Š47â”Š  â”Š    const { rows } = await db.query(\n+â”Š  â”Š42â”Š    const { rows } = await this.db.query(\n â”Š48â”Š43â”Š      sql`SELECT * FROM messages WHERE chat_id = ${chatId}`\n â”Š49â”Š44â”Š    );\n â”Š50â”Š45â”Š\n```\n```diff\n@@ -52,8 +47,7 @@\n â”Š52â”Š47â”Š  }\n â”Š53â”Š48â”Š\n â”Š54â”Š49â”Š  async lastMessage(chatId: string) {\n-â”Š55â”Š  â”Š    const db = await this.db.getClient();\n-â”Š56â”Š  â”Š    const { rows } = await db.query(sql`\n+â”Š  â”Š50â”Š    const { rows } = await this.db.query(sql`\n â”Š57â”Š51â”Š      SELECT * FROM messages\n â”Š58â”Š52â”Š      WHERE chat_id = ${chatId}\n â”Š59â”Š53â”Š      ORDER BY created_at DESC\n```\n```diff\n@@ -64,8 +58,7 @@\n â”Š64â”Š58â”Š  }\n â”Š65â”Š59â”Š\n â”Š66â”Š60â”Š  async firstRecipient({ chatId, userId }: { chatId: string; userId: string }) {\n-â”Š67â”Š  â”Š    const db = await this.db.getClient();\n-â”Š68â”Š  â”Š    const { rows } = await db.query(sql`\n+â”Š  â”Š61â”Š    const { rows } = await this.db.query(sql`\n â”Š69â”Š62â”Š      SELECT users.* FROM users, chats_users\n â”Š70â”Š63â”Š      WHERE users.id != ${userId}\n â”Š71â”Š64â”Š      AND users.id = chats_users.user_id\n```\n```diff\n@@ -76,8 +69,7 @@\n â”Š76â”Š69â”Š  }\n â”Š77â”Š70â”Š\n â”Š78â”Š71â”Š  async participants(chatId: string) {\n-â”Š79â”Š  â”Š    const db = await this.db.getClient();\n-â”Š80â”Š  â”Š    const { rows } = await db.query(sql`\n+â”Š  â”Š72â”Š    const { rows } = await this.db.query(sql`\n â”Š81â”Š73â”Š      SELECT users.* FROM users, chats_users\n â”Š82â”Š74â”Š      WHERE chats_users.chat_id = ${chatId}\n â”Š83â”Š75â”Š      AND chats_users.user_id = users.id\n```\n```diff\n@@ -87,8 +79,7 @@\n â”Š87â”Š79â”Š  }\n â”Š88â”Š80â”Š\n â”Š89â”Š81â”Š  async isParticipant({ chatId, userId }: { chatId: string; userId: string }) {\n-â”Š90â”Š  â”Š    const db = await this.db.getClient();\n-â”Š91â”Š  â”Š    const { rows } = await db.query(sql`\n+â”Š  â”Š82â”Š    const { rows } = await this.db.query(sql`\n â”Š92â”Š83â”Š      SELECT * FROM chats_users\n â”Š93â”Š84â”Š      WHERE chat_id = ${chatId}\n â”Š94â”Š85â”Š      AND user_id = ${userId}\n```\n```diff\n@@ -106,8 +97,7 @@\n â”Š106â”Š 97â”Š    userId: string;\n â”Š107â”Š 98â”Š    content: string;\n â”Š108â”Š 99â”Š  }) {\n-â”Š109â”Š   â”Š    const db = await this.db.getClient();\n-â”Š110â”Š   â”Š    const { rows } = await db.query(sql`\n+â”Š   â”Š100â”Š    const { rows } = await this.db.query(sql`\n â”Š111â”Š101â”Š      INSERT INTO messages(chat_id, sender_user_id, content)\n â”Š112â”Š102â”Š      VALUES(${chatId}, ${userId}, ${content})\n â”Š113â”Š103â”Š      RETURNING *\n```\n```diff\n@@ -129,8 +119,7 @@\n â”Š129â”Š119â”Š    userId: string;\n â”Š130â”Š120â”Š    recipientId: string;\n â”Š131â”Š121â”Š  }) {\n-â”Š132â”Š   â”Š    const db = await this.db.getClient();\n-â”Š133â”Š   â”Š    const { rows } = await db.query(sql`\n+â”Š   â”Š122â”Š    const { rows } = await this.db.query(sql`\n â”Š134â”Š123â”Š      SELECT chats.* FROM chats, (SELECT * FROM chats_users WHERE user_id = ${userId}) AS chats_of_current_user, chats_users\n â”Š135â”Š124â”Š      WHERE chats_users.chat_id = chats_of_current_user.chat_id\n â”Š136â”Š125â”Š      AND chats.id = chats_users.chat_id\n```\n```diff\n@@ -143,9 +132,9 @@\n â”Š143â”Š132â”Š    }\n â”Š144â”Š133â”Š\n â”Š145â”Š134â”Š    try {\n-â”Š146â”Š   â”Š      await db.query('BEGIN');\n+â”Š   â”Š135â”Š      await this.db.query('BEGIN');\n â”Š147â”Š136â”Š\n-â”Š148â”Š   â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š137â”Š      const { rows } = await this.db.query(sql`\n â”Š149â”Š138â”Š        INSERT INTO chats\n â”Š150â”Š139â”Š        DEFAULT VALUES\n â”Š151â”Š140â”Š        RETURNING *\n```\n```diff\n@@ -153,17 +142,17 @@\n â”Š153â”Š142â”Š\n â”Š154â”Š143â”Š      const chatAdded = rows[0];\n â”Š155â”Š144â”Š\n-â”Š156â”Š   â”Š      await db.query(sql`\n+â”Š   â”Š145â”Š      await this.db.query(sql`\n â”Š157â”Š146â”Š        INSERT INTO chats_users(chat_id, user_id)\n â”Š158â”Š147â”Š        VALUES(${chatAdded.id}, ${userId})\n â”Š159â”Š148â”Š      `);\n â”Š160â”Š149â”Š\n-â”Š161â”Š   â”Š      await db.query(sql`\n+â”Š   â”Š150â”Š      await this.db.query(sql`\n â”Š162â”Š151â”Š        INSERT INTO chats_users(chat_id, user_id)\n â”Š163â”Š152â”Š        VALUES(${chatAdded.id}, ${recipientId})\n â”Š164â”Š153â”Š      `);\n â”Š165â”Š154â”Š\n-â”Š166â”Š   â”Š      await db.query('COMMIT');\n+â”Š   â”Š155â”Š      await this.db.query('COMMIT');\n â”Š167â”Š156â”Š\n â”Š168â”Š157â”Š      this.pubsub.publish('chatAdded', {\n â”Š169â”Š158â”Š        chatAdded,\n```\n```diff\n@@ -171,18 +160,16 @@\n â”Š171â”Š160â”Š\n â”Š172â”Š161â”Š      return chatAdded;\n â”Š173â”Š162â”Š    } catch (e) {\n-â”Š174â”Š   â”Š      await db.query('ROLLBACK');\n+â”Š   â”Š163â”Š      await this.db.query('ROLLBACK');\n â”Š175â”Š164â”Š      throw e;\n â”Š176â”Š165â”Š    }\n â”Š177â”Š166â”Š  }\n â”Š178â”Š167â”Š\n â”Š179â”Š168â”Š  async removeChat({ chatId, userId }: { chatId: string; userId: string }) {\n-â”Š180â”Š   â”Š    const db = await this.db.getClient();\n-â”Š181â”Š   â”Š\n â”Š182â”Š169â”Š    try {\n-â”Š183â”Š   â”Š      await db.query('BEGIN');\n+â”Š   â”Š170â”Š      await this.db.query('BEGIN');\n â”Š184â”Š171â”Š\n-â”Š185â”Š   â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š172â”Š      const { rows } = await this.db.query(sql`\n â”Š186â”Š173â”Š        SELECT chats.* FROM chats, chats_users\n â”Š187â”Š174â”Š        WHERE id = ${chatId}\n â”Š188â”Š175â”Š        AND chats.id = chats_users.chat_id\n```\n```diff\n@@ -192,11 +179,11 @@\n â”Š192â”Š179â”Š      const chat = rows[0];\n â”Š193â”Š180â”Š\n â”Š194â”Š181â”Š      if (!chat) {\n-â”Š195â”Š   â”Š        await db.query('ROLLBACK');\n+â”Š   â”Š182â”Š        await this.db.query('ROLLBACK');\n â”Š196â”Š183â”Š        return null;\n â”Š197â”Š184â”Š      }\n â”Š198â”Š185â”Š\n-â”Š199â”Š   â”Š      await db.query(sql`\n+â”Š   â”Š186â”Š      await this.db.query(sql`\n â”Š200â”Š187â”Š        DELETE FROM chats WHERE chats.id = ${chatId}\n â”Š201â”Š188â”Š      `);\n â”Š202â”Š189â”Š\n```\n```diff\n@@ -205,11 +192,11 @@\n â”Š205â”Š192â”Š        targetChat: chat,\n â”Š206â”Š193â”Š      });\n â”Š207â”Š194â”Š\n-â”Š208â”Š   â”Š      await db.query('COMMIT');\n+â”Š   â”Š195â”Š      await this.db.query('COMMIT');\n â”Š209â”Š196â”Š\n â”Š210â”Š197â”Š      return chatId;\n â”Š211â”Š198â”Š    } catch (e) {\n-â”Š212â”Š   â”Š      await db.query('ROLLBACK');\n+â”Š   â”Š199â”Š      await this.db.query('ROLLBACK');\n â”Š213â”Š200â”Š      throw e;\n â”Š214â”Š201â”Š    }\n â”Š215â”Š202â”Š  }\n```\n\n##### Changed modules&#x2F;users&#x2F;users.provider.ts\n```diff\n@@ -12,8 +12,7 @@\n â”Š12â”Š12â”Š  @Inject() private db: Database;\n â”Š13â”Š13â”Š\n â”Š14â”Š14â”Š  async findById(userId: string) {\n-â”Š15â”Š  â”Š    const db = await this.db.getClient();\n-â”Š16â”Š  â”Š    const { rows } = await db.query(\n+â”Š  â”Š15â”Š    const { rows } = await this.db.query(\n â”Š17â”Š16â”Š      sql`SELECT * FROM users WHERE id = ${userId}`\n â”Š18â”Š17â”Š    );\n â”Š19â”Š18â”Š\n```\n```diff\n@@ -21,8 +20,7 @@\n â”Š21â”Š20â”Š  }\n â”Š22â”Š21â”Š\n â”Š23â”Š22â”Š  async findAllExcept(userId: string) {\n-â”Š24â”Š  â”Š    const db = await this.db.getClient();\n-â”Š25â”Š  â”Š    const { rows } = await db.query(\n+â”Š  â”Š23â”Š    const { rows } = await this.db.query(\n â”Š26â”Š24â”Š      sql`SELECT * FROM users WHERE id != ${userId}`\n â”Š27â”Š25â”Š    );\n â”Š28â”Š26â”Š\n```\n```diff\n@@ -30,8 +28,7 @@\n â”Š30â”Š28â”Š  }\n â”Š31â”Š29â”Š\n â”Š32â”Š30â”Š  async findByUsername(username: string) {\n-â”Š33â”Š  â”Š    const db = await this.db.getClient();\n-â”Š34â”Š  â”Š    const { rows } = await db.query(\n+â”Š  â”Š31â”Š    const { rows } = await this.db.query(\n â”Š35â”Š32â”Š      sql`SELECT * FROM users WHERE username = ${username}`\n â”Š36â”Š33â”Š    );\n â”Š37â”Š34â”Š\n```\n```diff\n@@ -47,9 +44,8 @@\n â”Š47â”Š44â”Š    name: string;\n â”Š48â”Š45â”Š    password: string;\n â”Š49â”Š46â”Š  }) {\n-â”Š50â”Š  â”Š    const db = await this.db.getClient();\n â”Š51â”Š47â”Š    const passwordHash = bcrypt.hashSync(password, bcrypt.genSaltSync(8));\n-â”Š52â”Š  â”Š    const createdUserQuery = await db.query(sql`\n+â”Š  â”Š48â”Š    const createdUserQuery = await this.db.query(sql`\n â”Š53â”Š49â”Š        INSERT INTO users(password, picture, username, name)\n â”Š54â”Š50â”Š        VALUES(${passwordHash}, ${DEFAULT_PROFILE_PIC}, ${username}, ${name})\n â”Š55â”Š51â”Š        RETURNING *\n```\n\n[}]: #\n\nDeduplication is done but the `currentUser` method does more than just that. It verifies the auth token extracted from a request's cookie. This could be avoided by an assignment to a private prop and a simple if statement.\n\n[{]: <helper> (diffStep \"14.2\" module=\"server\")\n\n#### [__Server__ Step 14.2: Cache current user object](https://github.com/Urigo/WhatsApp-Clone-Server/commit/1004d68c1e18a9030df9410378e6f896362f48b6)\n\n##### Changed modules&#x2F;users&#x2F;auth.provider.ts\n```diff\n@@ -14,6 +14,7 @@\n â”Š14â”Š14â”Šexport class Auth {\n â”Š15â”Š15â”Š  @Inject() private users: Users;\n â”Š16â”Š16â”Š  @Inject() private module: ModuleSessionInfo;\n+â”Š  â”Š17â”Š  private _currentUser: User;\n â”Š17â”Š18â”Š\n â”Š18â”Š19â”Š  private get req() {\n â”Š19â”Š20â”Š    return this.module.session.req || this.module.session.request;\n```\n```diff\n@@ -76,11 +77,16 @@\n â”Š76â”Š77â”Š  }\n â”Š77â”Š78â”Š\n â”Š78â”Š79â”Š  async currentUser(): Promise<User | null> {\n+â”Š  â”Š80â”Š    if (this._currentUser) {\n+â”Š  â”Š81â”Š      return this._currentUser;\n+â”Š  â”Š82â”Š    }\n+â”Š  â”Š83â”Š\n â”Š79â”Š84â”Š    if (this.req.cookies.authToken) {\n â”Š80â”Š85â”Š      const username = jwt.verify(this.req.cookies.authToken, secret) as string;\n â”Š81â”Š86â”Š\n â”Š82â”Š87â”Š      if (username) {\n-â”Š83â”Š  â”Š        return this.users.findByUsername(username);\n+â”Š  â”Š88â”Š        this._currentUser = await this.users.findByUsername(username);\n+â”Š  â”Š89â”Š        return this._currentUser;\n â”Š84â”Š90â”Š      }\n â”Š85â”Š91â”Š    }\n```\n\n[}]: #\n\n![Resolvers](../../../assets/step17/img-02.png \"Resolvers\")\n\nAs you can see at the graph above, we reduced an execution time of `isMine` field from 4ms and 5ms to less than 1. That applies for all calls, all messages so it scales well and won't grow as list of messages increases.\n\nBut there's more... We see `chat` field being computed over and over again. So again, let's repeat the same steps.\nThe `Message.chat` resolver asks `Chats` service and its `findChatById` method which makes a SQL call.\n\nThe deduplication logic, we introduced in the previous step, helps to immediately resolve all `Message.chat` fields except the first occurrence but there's still a space for improvements.\n\nThe `Query.chats` resolver is invoked before the `Message.chat` which means at this point, we already have knowledge about the chats.\n\nLet's implement a caching logic for chats so we could reuse them. We will do it in few steps.\n\nFirst, because we're going to use `Dataloader`, `Chats` class should have private and public API.\n\n[{]: <helper> (diffStep \"14.3\" module=\"server\")\n\n#### [__Server__ Step 14.3: Separate db query from public API](https://github.com/Urigo/WhatsApp-Clone-Server/commit/0c85160c6ec357e4b1d0bbd4fc9daf44c6fe3e45)\n\n##### Changed modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -11,6 +11,10 @@\n â”Š11â”Š11â”Š  @Inject() private pubsub: PubSub;\n â”Š12â”Š12â”Š\n â”Š13â”Š13â”Š  async findChatsByUser(userId: string) {\n+â”Š  â”Š14â”Š    return this._findChatsByUser(userId);\n+â”Š  â”Š15â”Š  }\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š  private async _findChatsByUser(userId: string) {\n â”Š14â”Š18â”Š    const { rows } = await this.db.query(sql`\n â”Š15â”Š19â”Š      SELECT chats.* FROM chats, chats_users\n â”Š16â”Š20â”Š      WHERE chats.id = chats_users.chat_id\n```\n\n[}]: #\n\nThe private method is responsible for quering data from the database but the public one is to allow communication between the service and its consumers.\nIt's also there so we could switch to using Dataloader later on.\n\nWe did that to `findChatsByUser` but there are more:\n\n[{]: <helper> (diffStep \"14.4\" module=\"server\")\n\n#### [__Server__ Step 14.4: Separate findChatByUser](https://github.com/Urigo/WhatsApp-Clone-Server/commit/7824b587f1e0526777c503d5eedf48965c5588c1)\n\n##### Changed modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -25,6 +25,18 @@\n â”Š25â”Š25â”Š  }\n â”Š26â”Š26â”Š\n â”Š27â”Š27â”Š  async findChatByUser({ chatId, userId }: { chatId: string; userId: string }) {\n+â”Š  â”Š28â”Š    const rows = await this._findChatByUser({ chatId, userId });\n+â”Š  â”Š29â”Š\n+â”Š  â”Š30â”Š    return rows[0] || null;\n+â”Š  â”Š31â”Š  }\n+â”Š  â”Š32â”Š\n+â”Š  â”Š33â”Š  private async _findChatByUser({\n+â”Š  â”Š34â”Š    chatId,\n+â”Š  â”Š35â”Š    userId,\n+â”Š  â”Š36â”Š  }: {\n+â”Š  â”Š37â”Š    chatId: string;\n+â”Š  â”Š38â”Š    userId: string;\n+â”Š  â”Š39â”Š  }) {\n â”Š28â”Š40â”Š    const { rows } = await this.db.query(sql`\n â”Š29â”Š41â”Š      SELECT chats.* FROM chats, chats_users\n â”Š30â”Š42â”Š      WHERE chats_users.chat_id = ${chatId}\n```\n```diff\n@@ -32,7 +44,7 @@\n â”Š32â”Š44â”Š      AND chats_users.user_id = ${userId}\n â”Š33â”Š45â”Š    `);\n â”Š34â”Š46â”Š\n-â”Š35â”Š  â”Š    return rows[0] || null;\n+â”Š  â”Š47â”Š    return rows;\n â”Š36â”Š48â”Š  }\n â”Š37â”Š49â”Š\n â”Š38â”Š50â”Š  async findChatById(chatId: string) {\n```\n\n[}]: #\n[{]: <helper> (diffStep \"14.5\" module=\"server\")\n\n#### [__Server__ Step 14.5: Separate findChatById](https://github.com/Urigo/WhatsApp-Clone-Server/commit/e330ce5fcec9e76772e59a2d3f3084902751cede)\n\n##### Changed modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -48,10 +48,15 @@\n â”Š48â”Š48â”Š  }\n â”Š49â”Š49â”Š\n â”Š50â”Š50â”Š  async findChatById(chatId: string) {\n+â”Š  â”Š51â”Š    const rows = await this._findChatById(chatId);\n+â”Š  â”Š52â”Š    return rows[0] || null;\n+â”Š  â”Š53â”Š  }\n+â”Š  â”Š54â”Š\n+â”Š  â”Š55â”Š  private async _findChatById(chatId: string) {\n â”Š51â”Š56â”Š    const { rows } = await this.db.query(sql`\n â”Š52â”Š57â”Š      SELECT * FROM chats WHERE id = ${chatId}\n â”Š53â”Š58â”Š    `);\n-â”Š54â”Š  â”Š    return rows[0] || null;\n+â”Š  â”Š59â”Š    return rows;\n â”Š55â”Š60â”Š  }\n â”Š56â”Š61â”Š\n â”Š57â”Š62â”Š  async findMessagesByChat(chatId: string) {\n```\n\n[}]: #\n\n> Because those private methods are just to query data, make sure they all return untouched `row` object.\n\nNow's the most interesting part, Dataloader.\n\n[{]: <helper> (diffStep \"14.6\" module=\"server\")\n\n#### [__Server__ Step 14.6: Use Dataloader in Chats](https://github.com/Urigo/WhatsApp-Clone-Server/commit/edaf177dc1363c33bd58076f286a7e24df7d3ba7)\n\n##### Changed modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -1,8 +1,23 @@\n â”Š 1â”Š 1â”Šimport { Injectable, Inject, ProviderScope } from '@graphql-modules/di';\n+â”Š  â”Š 2â”Šimport { QueryResult } from 'pg';\n â”Š 2â”Š 3â”Šimport sql from 'sql-template-strings';\n+â”Š  â”Š 4â”Šimport DataLoader from 'dataloader';\n â”Š 3â”Š 5â”Šimport { Database } from '../common/database.provider';\n â”Š 4â”Š 6â”Šimport { PubSub } from '../common/pubsub.provider';\n â”Š 5â”Š 7â”Š\n+â”Š  â”Š 8â”Štype ChatsByUser = { userId: string };\n+â”Š  â”Š 9â”Štype ChatByUser = { userId: string; chatId: string };\n+â”Š  â”Š10â”Štype ChatById = { chatId: string };\n+â”Š  â”Š11â”Štype ChatsKey = ChatById | ChatByUser | ChatsByUser;\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Šfunction isChatsByUser(query: any): query is ChatsByUser {\n+â”Š  â”Š14â”Š  return query.userId && !query.chatId;\n+â”Š  â”Š15â”Š}\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Šfunction isChatByUser(query: any): query is ChatByUser {\n+â”Š  â”Š18â”Š  return query.userId && query.chatId;\n+â”Š  â”Š19â”Š}\n+â”Š  â”Š20â”Š\n â”Š 6â”Š21â”Š@Injectable({\n â”Š 7â”Š22â”Š  scope: ProviderScope.Session,\n â”Š 8â”Š23â”Š})\n```\n```diff\n@@ -10,8 +25,26 @@\n â”Š10â”Š25â”Š  @Inject() private db: Database;\n â”Š11â”Š26â”Š  @Inject() private pubsub: PubSub;\n â”Š12â”Š27â”Š\n+â”Š  â”Š28â”Š  private loaders = {\n+â”Š  â”Š29â”Š    chats: new DataLoader<ChatsKey, QueryResult['rows']>(keys => {\n+â”Š  â”Š30â”Š      return Promise.all(\n+â”Š  â”Š31â”Š        keys.map(async query => {\n+â”Š  â”Š32â”Š          if (isChatsByUser(query)) {\n+â”Š  â”Š33â”Š            return this._findChatsByUser(query.userId);\n+â”Š  â”Š34â”Š          }\n+â”Š  â”Š35â”Š\n+â”Š  â”Š36â”Š          if (isChatByUser(query)) {\n+â”Š  â”Š37â”Š            return this._findChatByUser(query);\n+â”Š  â”Š38â”Š          }\n+â”Š  â”Š39â”Š\n+â”Š  â”Š40â”Š          return this._findChatById(query.chatId);\n+â”Š  â”Š41â”Š        })\n+â”Š  â”Š42â”Š      );\n+â”Š  â”Š43â”Š    }),\n+â”Š  â”Š44â”Š  };\n+â”Š  â”Š45â”Š\n â”Š13â”Š46â”Š  async findChatsByUser(userId: string) {\n-â”Š14â”Š  â”Š    return this._findChatsByUser(userId);\n+â”Š  â”Š47â”Š    return this.loaders.chats.load({ userId });\n â”Š15â”Š48â”Š  }\n â”Š16â”Š49â”Š\n â”Š17â”Š50â”Š  private async _findChatsByUser(userId: string) {\n```\n```diff\n@@ -25,7 +58,7 @@\n â”Š25â”Š58â”Š  }\n â”Š26â”Š59â”Š\n â”Š27â”Š60â”Š  async findChatByUser({ chatId, userId }: { chatId: string; userId: string }) {\n-â”Š28â”Š  â”Š    const rows = await this._findChatByUser({ chatId, userId });\n+â”Š  â”Š61â”Š    const rows = await this.loaders.chats.load({ chatId, userId });\n â”Š29â”Š62â”Š\n â”Š30â”Š63â”Š    return rows[0] || null;\n â”Š31â”Š64â”Š  }\n```\n```diff\n@@ -48,7 +81,7 @@\n â”Š48â”Š81â”Š  }\n â”Š49â”Š82â”Š\n â”Š50â”Š83â”Š  async findChatById(chatId: string) {\n-â”Š51â”Š  â”Š    const rows = await this._findChatById(chatId);\n+â”Š  â”Š84â”Š    const rows = await this.loaders.chats.load({ chatId });\n â”Š52â”Š85â”Š    return rows[0] || null;\n â”Š53â”Š86â”Š  }\n â”Š54â”Š87â”Š\n```\n\n##### Changed package.json\n```diff\n@@ -51,6 +51,7 @@\n â”Š51â”Š51â”Š    \"cookie\": \"0.4.0\",\n â”Š52â”Š52â”Š    \"cors\": \"2.8.5\",\n â”Š53â”Š53â”Š    \"cookie-parser\": \"1.4.4\",\n+â”Š  â”Š54â”Š    \"dataloader\": \"1.4.0\",\n â”Š54â”Š55â”Š    \"express\": \"4.17.1\",\n â”Š55â”Š56â”Š    \"graphql\": \"14.4.2\",\n â”Š56â”Š57â”Š    \"graphql-import\": \"0.7.1\",\n```\n\n[}]: #\n\nWe introduced `ChatsKey` that is a union type, to standarize the input value. Those helper methods like `isChatsByUser` and `isChatByUser` are there to decide what should be fetched.\n\nIn every public method that we previously changed, there's now Dataloader in use but that's not entirely what we're trying to achieve.\n\nThe caching mechanism is not yet completed. We deduplicate requests but in some cases, we ask for chats that are already there, so we need to intercept our dataloader logic and introduce caching.\n\n[{]: <helper> (diffStep \"14.7\" module=\"server\")\n\n#### [__Server__ Step 14.7: Implement caching for Chats](https://github.com/Urigo/WhatsApp-Clone-Server/commit/d76f8318fd525464d31608b04ff9118b1d12aa5b)\n\n##### Changed modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -4,6 +4,7 @@\n â”Š 4â”Š 4â”Šimport DataLoader from 'dataloader';\n â”Š 5â”Š 5â”Šimport { Database } from '../common/database.provider';\n â”Š 6â”Š 6â”Šimport { PubSub } from '../common/pubsub.provider';\n+â”Š  â”Š 7â”Šimport { Chat } from '../../db';\n â”Š 7â”Š 8â”Š\n â”Š 8â”Š 9â”Štype ChatsByUser = { userId: string };\n â”Š 9â”Š10â”Štype ChatByUser = { userId: string; chatId: string };\n```\n```diff\n@@ -25,6 +26,7 @@\n â”Š25â”Š26â”Š  @Inject() private db: Database;\n â”Š26â”Š27â”Š  @Inject() private pubsub: PubSub;\n â”Š27â”Š28â”Š\n+â”Š  â”Š29â”Š  private chatsCache = new Map<string, Chat>();\n â”Š28â”Š30â”Š  private loaders = {\n â”Š29â”Š31â”Š    chats: new DataLoader<ChatsKey, QueryResult['rows']>(keys => {\n â”Š30â”Š32â”Š      return Promise.all(\n```\n```diff\n@@ -33,6 +35,10 @@\n â”Š33â”Š35â”Š            return this._findChatsByUser(query.userId);\n â”Š34â”Š36â”Š          }\n â”Š35â”Š37â”Š\n+â”Š  â”Š38â”Š          if (this.chatsCache.has(query.chatId)) {\n+â”Š  â”Š39â”Š            return [this._readChatFromCache(query.chatId)];\n+â”Š  â”Š40â”Š          }\n+â”Š  â”Š41â”Š\n â”Š36â”Š42â”Š          if (isChatByUser(query)) {\n â”Š37â”Š43â”Š            return this._findChatByUser(query);\n â”Š38â”Š44â”Š          }\n```\n```diff\n@@ -254,4 +260,14 @@\n â”Š254â”Š260â”Š      throw e;\n â”Š255â”Š261â”Š    }\n â”Š256â”Š262â”Š  }\n+â”Š   â”Š263â”Š\n+â”Š   â”Š264â”Š  private _readChatFromCache(chatId: string) {\n+â”Š   â”Š265â”Š    return this.chatsCache.get(chatId);\n+â”Š   â”Š266â”Š  }\n+â”Š   â”Š267â”Š\n+â”Š   â”Š268â”Š  private _writeChatToCache(chat?: Chat) {\n+â”Š   â”Š269â”Š    if (chat) {\n+â”Š   â”Š270â”Š      this.chatsCache.set(chat.id, chat);\n+â”Š   â”Š271â”Š    }\n+â”Š   â”Š272â”Š  }\n â”Š257â”Š273â”Š}\n```\n\n[}]: #\n\nWhenever we ask for a single chat that is available, it's being resolved right away but we still need to write data to the cache.\n\n[{]: <helper> (diffStep \"14.8\" module=\"server\")\n\n#### [__Server__ Step 14.8: Write chats to the cache](https://github.com/Urigo/WhatsApp-Clone-Server/commit/206907427ff19aec597c437eb8ac4eba4393b1f4)\n\n##### Changed modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -60,6 +60,10 @@\n â”Š60â”Š60â”Š      AND chats_users.user_id = ${userId}\n â”Š61â”Š61â”Š    `);\n â”Š62â”Š62â”Š\n+â”Š  â”Š63â”Š    rows.forEach(row => {\n+â”Š  â”Š64â”Š      this._writeChatToCache(row);\n+â”Š  â”Š65â”Š    });\n+â”Š  â”Š66â”Š\n â”Š63â”Š67â”Š    return rows;\n â”Š64â”Š68â”Š  }\n â”Š65â”Š69â”Š\n```\n```diff\n@@ -83,6 +87,8 @@\n â”Š83â”Š87â”Š      AND chats_users.user_id = ${userId}\n â”Š84â”Š88â”Š    `);\n â”Š85â”Š89â”Š\n+â”Š  â”Š90â”Š    this._writeChatToCache(rows[0]);\n+â”Š  â”Š91â”Š\n â”Š86â”Š92â”Š    return rows;\n â”Š87â”Š93â”Š  }\n â”Š88â”Š94â”Š\n```\n```diff\n@@ -95,6 +101,9 @@\n â”Š 95â”Š101â”Š    const { rows } = await this.db.query(sql`\n â”Š 96â”Š102â”Š      SELECT * FROM chats WHERE id = ${chatId}\n â”Š 97â”Š103â”Š    `);\n+â”Š   â”Š104â”Š\n+â”Š   â”Š105â”Š    this._writeChatToCache(rows[0]);\n+â”Š   â”Š106â”Š\n â”Š 98â”Š107â”Š    return rows;\n â”Š 99â”Š108â”Š  }\n```\n\n[}]: #\n\nLet's look at charts in Apollo Engine.\n\n![Resolvers](../../../assets/step17/img-03.png \"Resolvers\")\n\nWe cut off `Message.chat` to less than 1ms.\n\nThe `Chat.name` and `Chat.picture` resolvers share the same logic and since Database service is wrapped with DataLoader, we make a single SQL query. Unfortunately, it's not visible on the graph.\n\nLet's summarize our work. **We made the GetChat operation almost 60% faster on average** and it's just based on one chat with one message. The number would be much much higher on a bigger scale.\n\n### Preventing issues\n\nThe Apollo Engine has another interesting feature. Itâ€™s called Alerts. You set a threshold for all operations or a specific one and whenever it takes longer, you get a notification on Slack. But thereâ€™s a catch, you need to pay in order to unlock it.\n\nWeâ€™re working on something similar but entirely open-sourced. Itâ€™s an extension of ApolloServer that lets you track operations and get exactly what you would get from the engine but self-hosted.\n\n## UI Performance\n\nThe part would be the User Interface and the web app in general.\n\n### Metrics\n\nThere's a highly recommended and very comprehensive publication written by Philip Walton (Engineer at Google) called [\"User-centric Performance Metrics\"](https://developers.google.com/web/fundamentals/performance/user-centric-performance-metrics) that was an inspiration for this chapter. Weâ€™re going to talk in short about measuring render performance of a web application.\n\nLetâ€™s base this chapter on real data. First, open the app and go to Performance tab of Chrome DevTools.\n\n![Record](../../../assets/step17/img-04.png \"Record\")\n\nNow click on â€œStart profiling and reload pageâ€. After itâ€™s done you should see the following:\n\n![All panels](../../../assets/step17/img-05.png \"All panels\")\n\nRight now it may not make a lot of sense, so weâ€™re going to start with something basic.\n\nThereâ€™s many different kinds of charts but we will cover only few of them: Network, Frames, Timings and Main.\n\nLetâ€™s check out the Timings section and explain few important performance metrics.\n\n- DCL - DOMContentLoaded Event\n- L - Onload Event\n- FP - First Paint\n- FCP - First Contentful Paint\n- FMP - First Meaningful Paint\n\nThereâ€™s also another one that is not visible on the timeline but also not less important, TTI - Time to Interactive.\n\nWe will focus on FP, FCP, FMP and TTI.\n\nThe primary difference between the two metrics is **First Paint** marks the point when the browser renders anything that is visually different from what was on the screen prior to navigation. By contrast, **First Contentful Paint** is the point when the browser renders the first bit of content from the DOM, which may be text, an image, SVG, or even a `<canvas>` element.\n\nThe **First Meaningful Paint** should mark the point when something useful was rendered. It might mean an input box on Google, video player on YouTube or in our case, a list of chats.\n\nThe **Time To Interactive** metric marks the point at which the application is both visually rendered and capable of reliably responding to user input.\n\nNow with all that knowledge we can move on to something more practical, the **Frames panel**. The main purpose here is to see whatâ€™s rendered at given time. In our case, the first paint was made after over 200ms, which is not a bad result at all but see that huge blank space next to it.\n\nThe **Network section**, is going to help us out here and give some pointers of what might be a reason of it. Itâ€™s a timeline that explains when each request was made and how long it took to resolve.\n\n![Network section](../../../assets/step17/img-06.png \"Network section\")\n\nWhat do we see here? One of the first requests are js files and we need those to bootstrap and render the app. Thatâ€™s the reason of the blank page.\n\nWe could improve that by either Server-Side Rendering or using a Service Worker.\n\n### Rendering improvements\n\n#### Server-Side Rendering\n\nImplementing SSR means you run the app on server, before itâ€™s being shipped to the client and the documentâ€™s content is not just `<html><body><app></app></body></html>` but an actual markup with all the components in it. Because itâ€™s a part of the document, the browser can already display something meaningful and after js files are loaded, the app bootstraps on the client and it becomes interactive. There is one caveat. Wherever you ship the app it has to be able to run node js.\n\n#### Store Rehydration\n\nWhen talking SSR itâ€™s worth to mention GraphQL and related technique called Store Rehydration. API calls are an important part of an application and plays a huge role in SSR.\n\nGraphQL operations are called once components are mounted which means the cache is filled up and why not reuse it on client.\n\nHow would it work? Data is extracted from the apolloâ€™s cache and passed within a document. After itâ€™s received by the browser, the app runs and so does the Apollo Client. While it happens we look for the data and fill up the cache. Now whenever a component calls a GraphQL operation, the result is already in the cache and resolves immediately.\n\n#### Service Worker\n\nAnother approach is a bit different. By using a Service Worker, weâ€™re able to control and cache requests, including js files, images etc. On the first visit, the app loads exactly the same as without SSR but the next visits are a bit faster. Itâ€™s because the Service Worker is registered after you close the app and of course we canâ€™t cache things that werenâ€™t fetched yet.\n\nBoth techniques are not mutually exclusive and we highly recommend to use both.\n\n![Main section](../../../assets/step17/img-07.png \"Main section\")\n\nThe next section weâ€™re going to talk about is the **Main panel**, a flame chart of activity on the main thread. You see those blocks? They represent an event, the wider it is the longer it took. One of the most important things to remember is to avoid long events since they block the thread.\nThe longest event on our timeline is the Evaluate Script event that involves `main.js`. The file contains all the libraries and the core functionality, those are needed to run the app. By making it lighter we would decrease the time of the first render.\nWe already do something to reduce the bundle size, This technique we use is called code-splitting and it allows to split one piece of code into multiple files which are lazy loaded.\nIt cuts off the size of the main bundle and the rest is loaded on demand, letâ€™s say login page is in a different chunk than list of chats.\n\n### Tooling\n\nThereâ€™s one tool built into Chrome DevTools called Lighthouse that allows to measure, collect metrics and get helpful tips on how to improve the performance and where are the pain points.\n\nHereâ€™s the example:\n\n![Lighthouse results](../../../assets/step17/img-08.png \"Lighthouse results\")\n\nOnce your app is optimized you want to prevent regressions. Lighthouse has you covered! It may run as part of Continuous Integration and prevents deployment when key metrics regress or drop below a certain threshold.\n\n## Making the app feels instant\n\nDealing with slow network can be hard so let's simulate that situation. After all, running the application on local host will always result in low response times.\n\nLuckily most browser come with a built in solution for that - we can simulate a slow network by defining the throttle level:\n\n![Throttling](../../../assets/step17/img-09.png \"Throttling\")\n\nIf we will refresh the application, we should notice a significant slow down the first time we load each screen; about few seconds to load each of them. To ensure that this is really caused by a slow network and not by anything else, we can open the dev-tools of our browser (letâ€™s assume you use Chrome) and under the `network` tab we should notice the network activity times.\n\n> More information about monitoring network activity and throttling it using the Chromeâ€™s dev-tools can be found in [the official dev-tools docs page](https://developers.google.com/web/tools/chrome-devtools/network/).\n\nTo solve these issues there are a couple of changes weâ€™re gonna make in the way we fetch and manage data.\n\n### Optimistic UI\n\nAs you know, pretty much in all cases, everything in Apollo flows through its cache. If a requested data is in there, a query is resolved right away. Mutations are a bit different, they have to reach the server every single time. Seems like nothing we can do about it but fortunately we can simulate the mutation, predict the result and make Apollo treat it as a temporary data. Which means, the appâ€™s state and all components are updated and the change is visible instantly after itâ€™s made.\n\nIn case of the WhatsApp clone, whenever a new message is sent, we will see it right away, on the screen, doesnâ€™t matter if the network is low or even super fast. You may experience the similar behavior on Facebookâ€™s Messenger.\n\n\n```graphql\n  mutation AddMessage($chatId: ID!, $content: String!) {\n    addMessage(chatId: $chatId, content: $content) {\n      ...Message\n    }\n  }\n```\n\n```graphql\n  addMessage({\n    variables: { chatId, content },\n    optimisticResponse: {\n      __typename: 'Mutation',\n      addMessage: {\n        __typename: 'Message',\n        id: Math.random().toString(36).substr(2, 9),\n        createdAt: new Date(),\n        isMine: true,\n        chat: {\n          __typename: 'Chat',\n          id: chatId,\n        },\n        content,\n      }\n    },\n    update: (client, { data: { addMessage } }) => {\n      writeMessage(client, addMessage);\n    },\n  })\n```\n\nWe used words â€œpredictâ€ and â€œsimulateâ€, what if the mutation behaves differently or whatâ€™s more interesting, it fails. Apollo handles that as well. The â€œrealâ€ response overwrites the fake one and the store is reverted back to the original state.\n\n### Prefetching data\n\nAnother technique but with a bit different purpose is about fetching data in advance. In some situations, you might be able to predict which page/component is going to be entered next.\n\nLetâ€™s base it on a real example. The WhatsApp clone has a page with a list of chats. The component that represents the page, calls a GraphQL operation to fetch that list. Right now, when user clicks on one of the chats, heâ€™s redirected to a partially empty page because of the ongoing GraphQL request. What if we could fetch that data in advance? Thatâ€™s what this technique is about. We could predict userâ€™s next move based on a simple mouse event or even by using Artificial Intelligence and data collected by Google Analytics, so whenever the move actually happens, the data is already in the cache.\n\n[{]: <helper> (diffStep \"15.1\" files=\"src/components/ChatRoomScreen/index.tsx\" module=\"client\")\n\n#### [__Client__ Step 15.1: Implement prefetching](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/a6a122fe74e9cdae1974b8b3cd8b4327950e0e3a)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -2,12 +2,19 @@\n â”Š 2â”Š 2â”Šimport React from 'react';\n â”Š 3â”Š 3â”Šimport { useCallback } from 'react';\n â”Š 4â”Š 4â”Šimport { Redirect } from 'react-router-dom';\n+â”Š  â”Š 5â”Šimport { useApolloClient } from '@apollo/react-hooks';\n â”Š 5â”Š 6â”Šimport styled from 'styled-components';\n â”Š 6â”Š 7â”Šimport ChatNavbar from './ChatNavbar';\n â”Š 7â”Š 8â”Šimport MessageInput from './MessageInput';\n â”Š 8â”Š 9â”Šimport MessagesList from './MessagesList';\n â”Š 9â”Š10â”Šimport { History } from 'history';\n-â”Š10â”Š  â”Šimport { useGetChatQuery, useAddMessageMutation } from '../../graphql/types';\n+â”Š  â”Š11â”Šimport {\n+â”Š  â”Š12â”Š  useGetChatQuery,\n+â”Š  â”Š13â”Š  useAddMessageMutation,\n+â”Š  â”Š14â”Š  GetChatQuery,\n+â”Š  â”Š15â”Š  GetChatQueryVariables,\n+â”Š  â”Š16â”Š  GetChatDocument,\n+â”Š  â”Š17â”Š} from '../../graphql/types';\n â”Š11â”Š18â”Šimport * as fragments from '../../graphql/fragments';\n â”Š12â”Š19â”Šimport { writeMessage } from '../../services/cache.service';\n â”Š13â”Š20â”Š\n```\n```diff\n@@ -38,6 +45,19 @@\n â”Š38â”Š45â”Š  ${fragments.message}\n â”Š39â”Š46â”Š`;\n â”Š40â”Š47â”Š\n+â”Š  â”Š48â”Šexport const useGetChatPrefetch = () => {\n+â”Š  â”Š49â”Š  const client = useApolloClient();\n+â”Š  â”Š50â”Š\n+â”Š  â”Š51â”Š  return (chatId: string) => {\n+â”Š  â”Š52â”Š    client.query<GetChatQuery, GetChatQueryVariables>({\n+â”Š  â”Š53â”Š      query: GetChatDocument,\n+â”Š  â”Š54â”Š      variables: {\n+â”Š  â”Š55â”Š        chatId,\n+â”Š  â”Š56â”Š      },\n+â”Š  â”Š57â”Š    });\n+â”Š  â”Š58â”Š  };\n+â”Š  â”Š59â”Š};\n+â”Š  â”Š60â”Š\n â”Š41â”Š61â”Šinterface ChatRoomScreenParams {\n â”Š42â”Š62â”Š  chatId: string;\n â”Š43â”Š63â”Š  history: History;\n```\n\n[}]: #\n\nWe created the `useGetChatPrefetch` hook that gets ApolloClient instance through `useApolloClient` and returns a function to prefetch data. In this case we request `GetChat` operation. Because Apollo deduplicates queries, we won't make multiple http calls, we're safe.\n\nThe actual usage of `useGetChatPrefetch`, happens on `mouse entered` event:\n\n[{]: <helper> (diffStep \"15.1\" files=\"src/components/ChatsListScreen/ChatsList.tsx\" module=\"client\")\n\n#### [__Client__ Step 15.1: Implement prefetching](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/a6a122fe74e9cdae1974b8b3cd8b4327950e0e3a)\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -5,6 +5,7 @@\n â”Š 5â”Š 5â”Šimport { useCallback } from 'react';\n â”Š 6â”Š 6â”Šimport { History } from 'history';\n â”Š 7â”Š 7â”Šimport { useChatsQuery } from '../../graphql/types';\n+â”Š  â”Š 8â”Šimport { useGetChatPrefetch } from '../ChatRoomScreen';\n â”Š 8â”Š 9â”Š\n â”Š 9â”Š10â”Šconst Container = styled.div`\n â”Š10â”Š11â”Š  height: calc(100% - 56px);\n```\n```diff\n@@ -69,6 +70,7 @@\n â”Š69â”Š70â”Š    },\n â”Š70â”Š71â”Š    [history]\n â”Š71â”Š72â”Š  );\n+â”Š  â”Š73â”Š  const prefetchChat = useGetChatPrefetch();\n â”Š72â”Š74â”Š\n â”Š73â”Š75â”Š  const { data } = useChatsQuery();\n â”Š74â”Š76â”Š\n```\n```diff\n@@ -85,7 +87,10 @@\n â”Š85â”Š87â”Š            key={chat.id}\n â”Š86â”Š88â”Š            data-testid=\"chat\"\n â”Š87â”Š89â”Š            button\n-â”Š88â”Š  â”Š            onClick={navToChat.bind(null, chat)}>\n+â”Š  â”Š90â”Š            onClick={navToChat.bind(null, chat)}\n+â”Š  â”Š91â”Š            onMouseEnter={() => {\n+â”Š  â”Š92â”Š              prefetchChat(chat.id);\n+â”Š  â”Š93â”Š            }}>\n â”Š89â”Š94â”Š            <ChatPicture\n â”Š90â”Š95â”Š              data-testid=\"picture\"\n â”Š91â”Š96â”Š              src={chat.picture}\n```\n\n[}]: #\n\nNow, the same but with the list of users:\n\n[{]: <helper> (diffStep \"15.1\" files=\"src/components/ChatsListScreen/AddChatButton.tsx\" module=\"client\")\n\n#### [__Client__ Step 15.1: Implement prefetching](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/a6a122fe74e9cdae1974b8b3cd8b4327950e0e3a)\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;AddChatButton.tsx\n```diff\n@@ -3,6 +3,7 @@\n â”Š3â”Š3â”Šimport React from 'react';\n â”Š4â”Š4â”Šimport styled from 'styled-components';\n â”Š5â”Š5â”Šimport { History } from 'history';\n+â”Š â”Š6â”Šimport { useUsersPrefetch } from '../UsersList';\n â”Š6â”Š7â”Š\n â”Š7â”Š8â”Šconst Container = styled.div`\n â”Š8â”Š9â”Š  position: fixed;\n```\n```diff\n@@ -18,17 +19,19 @@\n â”Š18â”Š19â”Š    color: white;\n â”Š19â”Š20â”Š  }\n â”Š20â”Š21â”Š`;\n+â”Š  â”Š22â”Š\n â”Š21â”Š23â”Šinterface ChildComponentProps {\n â”Š22â”Š24â”Š  history: History;\n â”Š23â”Š25â”Š}\n â”Š24â”Š26â”Š\n â”Š25â”Š27â”Šconst AddChatButton: React.FC<ChildComponentProps> = ({ history }) => {\n+â”Š  â”Š28â”Š  const prefetchUsers = useUsersPrefetch();\n â”Š26â”Š29â”Š  const onClick = () => {\n â”Š27â”Š30â”Š    history.push('/new-chat');\n â”Š28â”Š31â”Š  };\n â”Š29â”Š32â”Š\n â”Š30â”Š33â”Š  return (\n-â”Š31â”Š  â”Š    <Container>\n+â”Š  â”Š34â”Š    <Container onMouseEnter={() => prefetchUsers()}>\n â”Š32â”Š35â”Š      <Button\n â”Š33â”Š36â”Š        data-testid=\"new-chat-button\"\n â”Š34â”Š37â”Š        variant=\"contained\"\n```\n\n[}]: #\n[{]: <helper> (diffStep \"15.1\" files=\"src/components/ChatsListScreen/ChatsList.tsx\" module=\"client\")\n\n#### [__Client__ Step 15.1: Implement prefetching](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/a6a122fe74e9cdae1974b8b3cd8b4327950e0e3a)\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -5,6 +5,7 @@\n â”Š 5â”Š 5â”Šimport { useCallback } from 'react';\n â”Š 6â”Š 6â”Šimport { History } from 'history';\n â”Š 7â”Š 7â”Šimport { useChatsQuery } from '../../graphql/types';\n+â”Š  â”Š 8â”Šimport { useGetChatPrefetch } from '../ChatRoomScreen';\n â”Š 8â”Š 9â”Š\n â”Š 9â”Š10â”Šconst Container = styled.div`\n â”Š10â”Š11â”Š  height: calc(100% - 56px);\n```\n```diff\n@@ -69,6 +70,7 @@\n â”Š69â”Š70â”Š    },\n â”Š70â”Š71â”Š    [history]\n â”Š71â”Š72â”Š  );\n+â”Š  â”Š73â”Š  const prefetchChat = useGetChatPrefetch();\n â”Š72â”Š74â”Š\n â”Š73â”Š75â”Š  const { data } = useChatsQuery();\n â”Š74â”Š76â”Š\n```\n```diff\n@@ -85,7 +87,10 @@\n â”Š85â”Š87â”Š            key={chat.id}\n â”Š86â”Š88â”Š            data-testid=\"chat\"\n â”Š87â”Š89â”Š            button\n-â”Š88â”Š  â”Š            onClick={navToChat.bind(null, chat)}>\n+â”Š  â”Š90â”Š            onClick={navToChat.bind(null, chat)}\n+â”Š  â”Š91â”Š            onMouseEnter={() => {\n+â”Š  â”Š92â”Š              prefetchChat(chat.id);\n+â”Š  â”Š93â”Š            }}>\n â”Š89â”Š94â”Š            <ChatPicture\n â”Š90â”Š95â”Š              data-testid=\"picture\"\n â”Š91â”Š96â”Š              src={chat.picture}\n```\n\n[}]: #\n\n### Splitting and Deferring Queries\n\nPrefetching is an easy way to make your applications UI feel faster. You can use mouse events to predict the data that could be needed. This is powerful and works perfectly on the browser, but can not be applied to a mobile device.\n\nOne solution for improving the UI experience would be the usage of fragments to preload more data in a query, but loading huge amounts of data (that you probably never show to the user) is expensive.\n\nAnother solution would be to **split huge queries into two smaller queries**:\n\n- The first one could load data which is already in the store. This means that it can be displayed instantly.\n- The second query could load data which is not in the store yet and must be fetched from the server first.\n\nThis solution gives you the benefit of not fetching too much data, as well as the possibility to show some part of the views data before the server responds.\n\nThis could be used in our messaging app to load chatâ€™s information and messages separately. This way we will see the title and the image instantly, because itâ€™s already in the cache but messages will be loaded afterwards. UX will benefit a lot.\n\nThereâ€™s also something very similar conceptually to Query Splitting but instead of separating queries we keep everything in one operation and annotate the parts that should be deferred. The annotation is, of course a directive and itâ€™s called **`@defer`**.\n\nOnce the `@defer` is used, the server returns an initial response without waiting for deferred fields to resolve, using null as placeholders for them. Then, it streams patches for each deferred field asynchronously as they resolve. Thanks to that, we maintain one operation but decide how it behaves.\n\n> Right now, this feature is not well supported in Apollo Server so we donâ€™t recommend to use it yet. Keep it on mind though.\n\n### Dealing with rendering issues\n\nThe most naive thing we can do to start noticing performance issues would be loading TONS of data to our app, and make sure that each view is absolutely overwhelmed with information. This way performance issues will start rising above the surface pretty quickly. To do that, we will edit the `resetDb()` method on the server so it can generate large quantities of data. The most comfortable way of controlling that behavior would be through an environment variable that will tell the reset method how much iterations it should run. The more iterations, the more data would be fabricated:\n\n[{]: <helper> (diffStep \"15.10\" module=\"server\")\n\n#### Step 15.10: NOT FOUND!\n\n[}]: #\n\nItâ€™s important to note that weâ€™ve generated the data in a very specific way where a single user will be the center of the network of data. This way when we log in with that user, we should see our views packed. If it wasnâ€™t for that we would have just had large quantities of data in the DB, but none of it would appear to the end-user.\n\nNow, we will restart the server and this time run it differently. We will provide `FAKED_DB` with a value of `100` which should connect us to 100 messages per single view:\n\n    RESET_DB=true FAKED_DB=100 yarn start\n\nNow make sure that the application is running and log-in with the first user of Ray Edwards using the credentials:\n\n    username: ray\n    passowrd: 111\n\nNow try to navigate around between the `ChatsScreen` and `ChatBoxScreen`. Youâ€™ll notice that each transition takes a long time until it shows the data. Itâ€™s obviously something which is related to rendering and not data transportation, because the slowdown also happens the second time you visit a view, a point where the fetched data should have already been stored by Apollo in cache. So weâ€™ve already detected one performance issue we should deal with.\n\n### Pagination\n\nTo solve it, there are couple of changes weâ€™re gonna make in the way we ask for data, messages will be fetched dynamically based on our scrolling position.\n\nWith these changes, the requests will be splitted into smaller chunks, and React DOM wonâ€™t have to deal with a lot of data the first time it loads. There are few challenges that may arise from this implementation:\n\n- Representing queries in a way that they can be loaded in chunks\n- Sending requests and updating the view dynamically\n- Maintaining updates from subscriptions\n\nTo start with, we will first take on the task of improving initialization times. We will release the pressure by fetching only the first 20 messages. This way when we visit a chat, it should be loaded faster.\n\nFor that we're going to implement cursor-based pagination. We will add `after` and `limit` arguments to `Chat.messages` that could be used to fetch a specific snapshot of available messages.\n\n- `after` is optional and marks the point where the last fetch ended (what is the last element of a received list)\n- `limit` is required, defines amount of data\n\nA common design pattern for fetching data snapshots from a GraphQL back-end is called [Relay](https://facebook.github.io/relay/docs/en/graphql-server-specification.html). Relay provides a robust solution which is suitable for things like search engines.\n\nWe will define our own version of it.\n\n[{]: <helper> (diffStep \"14.9\" module=\"server\")\n\n#### [__Server__ Step 14.9: Add fake data](https://github.com/Urigo/WhatsApp-Clone-Server/commit/1b1efff53a613148a57444972525a20a3d7e8a7f)\n\n##### Changed db.ts\n```diff\n@@ -1,6 +1,8 @@\n â”Š1â”Š1â”Šimport { Pool } from 'pg';\n â”Š2â”Š2â”Šimport sql from 'sql-template-strings';\n-â”Š3â”Š â”Šimport { resetDb as envResetDb } from './env';\n+â”Š â”Š3â”Šimport faker from 'faker';\n+â”Š â”Š4â”Šimport addMinutes from 'date-fns/add_minutes';\n+â”Š â”Š5â”Šimport { resetDb as envResetDb, fakedDb } from './env';\n â”Š4â”Š6â”Š\n â”Š5â”Š7â”Šexport type User = {\n â”Š6â”Š8â”Š  id: string;\n```\n```diff\n@@ -234,6 +236,10 @@\n â”Š234â”Š236â”Š    },\n â”Š235â”Š237â”Š  ];\n â”Š236â”Š238â”Š\n+â”Š   â”Š239â”Š  if (fakedDb) {\n+â”Š   â”Š240â”Š    addFakedMessages(sampleMessages, fakedDb);\n+â”Š   â”Š241â”Š  }\n+â”Š   â”Š242â”Š\n â”Š237â”Š243â”Š  for (const sampleMessage of sampleMessages) {\n â”Š238â”Š244â”Š    await pool.query(sql`\n â”Š239â”Š245â”Š      INSERT INTO messages(id, content, created_at, chat_id, sender_user_id)\n```\n```diff\n@@ -248,6 +254,21 @@\n â”Š248â”Š254â”Š  );\n â”Š249â”Š255â”Š};\n â”Š250â”Š256â”Š\n+â”Š   â”Š257â”Šfunction addFakedMessages(messages: Message[], count: number) {\n+â”Š   â”Š258â”Š  const message = messages[0];\n+â”Š   â”Š259â”Š  const date = message.created_at;\n+â”Š   â”Š260â”Š  const id = messages.length + 1;\n+â”Š   â”Š261â”Š\n+â”Š   â”Š262â”Š  new Array(count).fill(0).forEach((_, i) => {\n+â”Š   â”Š263â”Š    messages.push({\n+â”Š   â”Š264â”Š      ...message,\n+â”Š   â”Š265â”Š      id: `${id + i}`,\n+â”Š   â”Š266â”Š      content: faker.lorem.sentence(4),\n+â”Š   â”Š267â”Š      created_at: addMinutes(date, i + 1),\n+â”Š   â”Š268â”Š    });\n+â”Š   â”Š269â”Š  });\n+â”Š   â”Š270â”Š}\n+â”Š   â”Š271â”Š\n â”Š251â”Š272â”Šif (envResetDb) {\n â”Š252â”Š273â”Š  resetDb();\n â”Š253â”Š274â”Š}\n```\n\n##### Changed env.ts\n```diff\n@@ -5,3 +5,6 @@\n â”Š 5â”Š 5â”Šexport const origin = process.env.ORIGIN || 'http://localhost:3000';\n â”Š 6â”Š 6â”Šexport const port = process.env.PORT || 4000;\n â”Š 7â”Š 7â”Šexport const resetDb = process.env.RESET_DB || false;\n+â”Š  â”Š 8â”Šexport const fakedDb = process.env.FAKED_DB\n+â”Š  â”Š 9â”Š  ? parseInt(process.env.FAKED_DB, 10)\n+â”Š  â”Š10â”Š  : 0;\n```\n\n##### Changed package.json\n```diff\n@@ -25,6 +25,7 @@\n â”Š25â”Š25â”Š    \"@types/cookie\": \"0.3.3\",\n â”Š26â”Š26â”Š    \"@types/cookie-parser\": \"1.4.1\",\n â”Š27â”Š27â”Š    \"@types/express\": \"4.17.0\",\n+â”Š  â”Š28â”Š    \"@types/faker\": \"4.1.5\",\n â”Š28â”Š29â”Š    \"@types/graphql\": \"14.2.3\",\n â”Š29â”Š30â”Š    \"@types/graphql-iso-date\": \"3.3.1\",\n â”Š30â”Š31â”Š    \"@types/jest\": \"24.0.17\",\n```\n```diff\n@@ -52,7 +53,9 @@\n â”Š52â”Š53â”Š    \"cors\": \"2.8.5\",\n â”Š53â”Š54â”Š    \"cookie-parser\": \"1.4.4\",\n â”Š54â”Š55â”Š    \"dataloader\": \"1.4.0\",\n+â”Š  â”Š56â”Š    \"date-fns\": \"1.30.1\",\n â”Š55â”Š57â”Š    \"express\": \"4.17.1\",\n+â”Š  â”Š58â”Š    \"faker\": \"4.1.0\",\n â”Š56â”Š59â”Š    \"graphql\": \"14.4.2\",\n â”Š57â”Š60â”Š    \"graphql-import\": \"0.7.1\",\n â”Š58â”Š61â”Š    \"graphql-iso-date\": \"3.6.1\",\n```\n\n[}]: #\n\nThe `MessagesResult` is built of:\n\n- `cursor` - marks the end of a fetched list\n- `hasMore` - tells if there's more data to ask for\n- `message` - has the same type as `Chat.messages` previously had\n\nBecause the cursor marks the edge of received data, it has to be something we could use while sorting. The most obvious choice is the date of creation, so `created_at` column of `messages` table.\n\nIt's stored as `YYYY-MM-DD HH:mm:ss` but we want to expose it as something easier to work with, let's say a `number`.\n\nIn order to do it quickly, let's add `date-fns` package:\n\n    npm install date-fns\n\nIt has `format` method that will help us to do conversions.\n\nWe need to the logic of `Chats.findMessagesByChat` method.\n\n[{]: <helper> (diffStep \"14.11\" module=\"server\")\n\n#### [__Server__ Step 14.11: Implement cursor-based pagination in messages](https://github.com/Urigo/WhatsApp-Clone-Server/commit/983033ff44ff06053741d9548fcfca66ce0e0d8b)\n\n##### Changed modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -2,6 +2,7 @@\n â”Š2â”Š2â”Šimport { QueryResult } from 'pg';\n â”Š3â”Š3â”Šimport sql from 'sql-template-strings';\n â”Š4â”Š4â”Šimport DataLoader from 'dataloader';\n+â”Š â”Š5â”Šimport format from 'date-fns/format';\n â”Š5â”Š6â”Šimport { Database } from '../common/database.provider';\n â”Š6â”Š7â”Šimport { PubSub } from '../common/pubsub.provider';\n â”Š7â”Š8â”Šimport { Chat } from '../../db';\n```\n```diff\n@@ -107,12 +108,55 @@\n â”Š107â”Š108â”Š    return rows;\n â”Š108â”Š109â”Š  }\n â”Š109â”Š110â”Š\n-â”Š110â”Š   â”Š  async findMessagesByChat(chatId: string) {\n-â”Š111â”Š   â”Š    const { rows } = await this.db.query(\n-â”Š112â”Š   â”Š      sql`SELECT * FROM messages WHERE chat_id = ${chatId}`\n+â”Š   â”Š111â”Š  async findMessagesByChat({\n+â”Š   â”Š112â”Š    chatId,\n+â”Š   â”Š113â”Š    limit,\n+â”Š   â”Š114â”Š    after,\n+â”Š   â”Š115â”Š  }: {\n+â”Š   â”Š116â”Š    chatId: string;\n+â”Š   â”Š117â”Š    limit: number;\n+â”Š   â”Š118â”Š    after?: number | null;\n+â”Š   â”Š119â”Š  }): Promise<{\n+â”Š   â”Š120â”Š    hasMore: boolean;\n+â”Š   â”Š121â”Š    cursor: number | null;\n+â”Š   â”Š122â”Š    messages: any[];\n+â”Š   â”Š123â”Š  }> {\n+â”Š   â”Š124â”Š    const query = sql`SELECT * FROM messages`;\n+â”Š   â”Š125â”Š    query.append(` WHERE chat_id = ${chatId}`);\n+â”Š   â”Š126â”Š\n+â”Š   â”Š127â”Š    if (after) {\n+â”Š   â”Š128â”Š      // the created_at is the cursor\n+â”Š   â”Š129â”Š      query.append(` AND created_at < ${cursorToDate(after)}`);\n+â”Š   â”Š130â”Š    }\n+â”Š   â”Š131â”Š\n+â”Š   â”Š132â”Š    query.append(` ORDER BY created_at DESC LIMIT ${limit}`);\n+â”Š   â”Š133â”Š\n+â”Š   â”Š134â”Š    const { rows: messages } = await this.db.query(query);\n+â”Š   â”Š135â”Š\n+â”Š   â”Š136â”Š    if (!messages) {\n+â”Š   â”Š137â”Š      return {\n+â”Š   â”Š138â”Š        hasMore: false,\n+â”Š   â”Š139â”Š        cursor: null,\n+â”Š   â”Š140â”Š        messages: [],\n+â”Š   â”Š141â”Š      };\n+â”Š   â”Š142â”Š    }\n+â”Š   â”Š143â”Š\n+â”Š   â”Š144â”Š    // so we send them as old -> new\n+â”Š   â”Š145â”Š    messages.reverse();\n+â”Š   â”Š146â”Š\n+â”Š   â”Š147â”Š    // cursor is a number representation of created_at\n+â”Š   â”Š148â”Š    const cursor = messages.length ? new Date(messages[0].created_at).getTime() : 0;\n+â”Š   â”Š149â”Š    const { rows: next } = await this.db.query(\n+â”Š   â”Š150â”Š      sql`SELECT * FROM messages WHERE chat_id = ${chatId} AND created_at < ${cursorToDate(\n+â”Š   â”Š151â”Š        cursor\n+â”Š   â”Š152â”Š      )} ORDER BY created_at DESC LIMIT 1`\n â”Š113â”Š153â”Š    );\n â”Š114â”Š154â”Š\n-â”Š115â”Š   â”Š    return rows;\n+â”Š   â”Š155â”Š    return {\n+â”Š   â”Š156â”Š      hasMore: next.length === 1, // means there's no more messages\n+â”Š   â”Š157â”Š      cursor,\n+â”Š   â”Š158â”Š      messages,\n+â”Š   â”Š159â”Š    };\n â”Š116â”Š160â”Š  }\n â”Š117â”Š161â”Š\n â”Š118â”Š162â”Š  async lastMessage(chatId: string) {\n```\n```diff\n@@ -280,3 +324,7 @@\n â”Š280â”Š324â”Š    }\n â”Š281â”Š325â”Š  }\n â”Š282â”Š326â”Š}\n+â”Š   â”Š327â”Š\n+â”Š   â”Š328â”Šfunction cursorToDate(cursor: number) {\n+â”Š   â”Š329â”Š  return `'${format(cursor, 'YYYY-MM-DD HH:mm:ss')}'`;\n+â”Š   â”Š330â”Š}\n```\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -111,7 +111,11 @@\n â”Š111â”Š111â”Š    },\n â”Š112â”Š112â”Š\n â”Š113â”Š113â”Š    async messages(chat, args, { injector }) {\n-â”Š114â”Š   â”Š      return injector.get(Chats).findMessagesByChat(chat.id);\n+â”Š   â”Š114â”Š      return injector.get(Chats).findMessagesByChat({\n+â”Š   â”Š115â”Š        chatId: chat.id,\n+â”Š   â”Š116â”Š        limit: args.limit,\n+â”Š   â”Š117â”Š        after: args.after,\n+â”Š   â”Š118â”Š      });\n â”Š115â”Š119â”Š    },\n â”Š116â”Š120â”Š\n â”Š117â”Š121â”Š    async lastMessage(chat, args, { injector }) {\n```\n\n[}]: #\n\nBecause the order of creation matters, messages are selected quite differently than before, we keep selecting all columns but records are ordered by the date of creation.\n\nThere's an interesting thing related to the cursor. If it's provided, we query for only those messages that happened before our cursor. This way we have a valid direction, fetching more messages means fetching older records.\n\nThe last message in the list becomes of course the `cursor`.\n\nIn order to calculate `hasMore` we need to apply the same conditions as above but with `LIMIT 1` and see if we get a result.\n\nSince the API part is done, let's take care of something much more complicated, which is always the UI...\n\nLet's plan it first. We know we want to fetch more messages while scrolling up. That means, Infinite Scroll with a corresponding request each time we hit the top. Because we implemented prefetching, we need to know what's the `limit`. React's Context might be helpful here. There was, of course, the change in GraphQL Schema we need to take care of too.\n\n### Apply schema changes\n\nSince we know what the plan is, let's start with schema changes. The `Chat.messages` is no longer a list, it's an object now.\n\n[{]: <helper> (diffStep \"15.6\" module=\"client\")\n\n#### [__Client__ Step 15.6: Apply MessagesResult type](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/5ef311ae9a89c85a58695bc0299ac510379c013a)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -27,7 +27,7 @@\n â”Š27â”Š27â”Š\n â”Š28â”Š28â”Š// eslint-disable-next-line\n â”Š29â”Š29â”Šconst getChatQuery = gql`\n-â”Š30â”Š  â”Š  query GetChat($chatId: ID!) {\n+â”Š  â”Š30â”Š  query GetChat($chatId: ID!, $limit: Int!, $after: Float) {\n â”Š31â”Š31â”Š    chat(chatId: $chatId) {\n â”Š32â”Š32â”Š      ...FullChat\n â”Š33â”Š33â”Š    }\n```\n\n##### Changed src&#x2F;graphql&#x2F;fragments&#x2F;fullChat.fragment.ts\n```diff\n@@ -1,14 +1,14 @@\n â”Š 1â”Š 1â”Šimport gql from 'graphql-tag';\n â”Š 2â”Š 2â”Šimport chat from './chat.fragment';\n-â”Š 3â”Š  â”Šimport message from './message.fragment';\n+â”Š  â”Š 3â”Šimport messagesResult from './messagesResult.fragment';\n â”Š 4â”Š 4â”Š\n â”Š 5â”Š 5â”Šexport default gql`\n â”Š 6â”Š 6â”Š  fragment FullChat on Chat {\n â”Š 7â”Š 7â”Š    ...Chat\n-â”Š 8â”Š  â”Š    messages {\n-â”Š 9â”Š  â”Š      ...Message\n+â”Š  â”Š 8â”Š    messages(limit: $limit, after: $after) @connection(key: \"messages\") {\n+â”Š  â”Š 9â”Š      ...MessagesResult\n â”Š10â”Š10â”Š    }\n â”Š11â”Š11â”Š  }\n â”Š12â”Š12â”Š  ${chat}\n-â”Š13â”Š  â”Š  ${message}\n+â”Š  â”Š13â”Š  ${messagesResult}\n â”Š14â”Š14â”Š`;\n```\n\n##### Added src&#x2F;graphql&#x2F;fragments&#x2F;messagesResult.fragment.ts\n```diff\n@@ -0,0 +1,13 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag';\n+â”Š  â”Š 2â”Šimport message from './message.fragment';\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šexport default gql`\n+â”Š  â”Š 5â”Š  fragment MessagesResult on MessagesResult {\n+â”Š  â”Š 6â”Š    cursor\n+â”Š  â”Š 7â”Š    hasMore\n+â”Š  â”Š 8â”Š    messages {\n+â”Š  â”Š 9â”Š      ...Message\n+â”Š  â”Š10â”Š    }\n+â”Š  â”Š11â”Š  }\n+â”Š  â”Š12â”Š  ${message}\n+â”Š  â”Š13â”Š`;\n```\n\n##### Changed src&#x2F;services&#x2F;cache.service.ts\n```diff\n@@ -61,9 +61,9 @@\n â”Š61â”Š61â”Š  if (fullChat === null || fullChat.messages === null) {\n â”Š62â”Š62â”Š    return;\n â”Š63â”Š63â”Š  }\n-â”Š64â”Š  â”Š  if (fullChat.messages.some((m: any) => m.id === message.id)) return;\n+â”Š  â”Š64â”Š  if (fullChat.messages.messages.some((m: any) => m.id === message.id)) return;\n â”Š65â”Š65â”Š\n-â”Š66â”Š  â”Š  fullChat.messages.push(message);\n+â”Š  â”Š66â”Š  fullChat.messages.messages.push(message);\n â”Š67â”Š67â”Š  fullChat.lastMessage = message;\n â”Š68â”Š68â”Š\n â”Š69â”Š69â”Š  client.writeFragment({\n```\n\n[}]: #\n\nNow we need reflect those changes in generated hooks by running:\n\n    yarn codegen\n\nOkay, let's move on!\n\n### Infinite Scrolling\n\nNow this Infinite Scroll thing. The core concept is to ask for more data, once a user's scrollbar hits the top edge of the screen.\n\n[{]: <helper> (diffStep \"15.2\" module=\"client\")\n\n#### [__Client__ Step 15.2: Basics for infinite scroll](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/824853fc0e0b3db7cfb829ec51f6038b732ef15d)\n\n##### Added src&#x2F;hooks&#x2F;use-infinite-scroll.ts\n```diff\n@@ -0,0 +1,32 @@\n+â”Š  â”Š 1â”Šimport { useEffect, useCallback, RefObject } from 'react';\n+â”Š  â”Š 2â”Š\n+â”Š  â”Š 3â”Šexport const useInfiniteScroll = ({\n+â”Š  â”Š 4â”Š  ref,\n+â”Š  â”Š 5â”Š  onLoadMore,\n+â”Š  â”Š 6â”Š}: {\n+â”Š  â”Š 7â”Š  onLoadMore: Function;\n+â”Š  â”Š 8â”Š  ref: RefObject<HTMLElement>;\n+â”Š  â”Š 9â”Š}) => {\n+â”Š  â”Š10â”Š  const handleScroll = useCallback(() => {\n+â”Š  â”Š11â”Š    if (ref.current!.scrollTop === 0) {\n+â”Š  â”Š12â”Š      // loads more if scrolled to top\n+â”Š  â”Š13â”Š      onLoadMore();\n+â”Š  â”Š14â”Š    }\n+â”Š  â”Š15â”Š  }, [ref, onLoadMore]);\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š  useEffect(() => {\n+â”Š  â”Š18â”Š    const elem = ref.current;\n+â”Š  â”Š19â”Š\n+â”Š  â”Š20â”Š    if (!elem) {\n+â”Š  â”Š21â”Š      return;\n+â”Š  â”Š22â”Š    }\n+â”Š  â”Š23â”Š\n+â”Š  â”Š24â”Š    elem.addEventListener('scroll', handleScroll);\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Š    return () => {\n+â”Š  â”Š27â”Š      elem!.removeEventListener('scroll', handleScroll);\n+â”Š  â”Š28â”Š    };\n+â”Š  â”Š29â”Š  }, [ref, handleScroll]);\n+â”Š  â”Š30â”Š};\n+â”Š  â”Š31â”Š\n+â”Š  â”Š32â”Šexport default useInfiniteScroll;\n```\n\n[}]: #\n\nOur `useInfiniteScroll` hook requires:\n\n- `ref` is a reference of a HTML element\n- `onLoadMore` calls the part component back and asks for data\n\nWe used `useEffect` to add and remove a scroll event listener. The function lives as long as `ref` and `onLoadMore` stay the same, that's because we simply make use of them in `handleScroll` function. The `handleScroll` function calls `onLoadMore` when a user scrolled to the top.\n\nIt all looks fine at first, but we still need to prevent calling back once fetching is in progress.\n\n[{]: <helper> (diffStep \"15.3\" module=\"client\")\n\n#### [__Client__ Step 15.3: Prevent calling back once fetching is in progress](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/c850dc5905aae90d8a385a04159c211fa4062ed3)\n\n##### Changed src&#x2F;hooks&#x2F;use-infinite-scroll.ts\n```diff\n@@ -1,4 +1,4 @@\n-â”Š1â”Š â”Šimport { useEffect, useCallback, RefObject } from 'react';\n+â”Š â”Š1â”Šimport { useState, useEffect, useCallback, RefObject } from 'react';\n â”Š2â”Š2â”Š\n â”Š3â”Š3â”Šexport const useInfiniteScroll = ({\n â”Š4â”Š4â”Š  ref,\n```\n```diff\n@@ -7,12 +7,13 @@\n â”Š 7â”Š 7â”Š  onLoadMore: Function;\n â”Š 8â”Š 8â”Š  ref: RefObject<HTMLElement>;\n â”Š 9â”Š 9â”Š}) => {\n+â”Š  â”Š10â”Š  const [isFetching, setIsFetching] = useState(false);\n â”Š10â”Š11â”Š  const handleScroll = useCallback(() => {\n-â”Š11â”Š  â”Š    if (ref.current!.scrollTop === 0) {\n-â”Š12â”Š  â”Š      // loads more if scrolled to top\n-â”Š13â”Š  â”Š      onLoadMore();\n+â”Š  â”Š12â”Š    if (ref.current!.scrollTop === 0 && isFetching === false) {\n+â”Š  â”Š13â”Š      // starts to fetch if scrolled to top and fetching is not in progress\n+â”Š  â”Š14â”Š      setIsFetching(true);\n â”Š14â”Š15â”Š    }\n-â”Š15â”Š  â”Š  }, [ref, onLoadMore]);\n+â”Š  â”Š16â”Š  }, [ref, isFetching]);\n â”Š16â”Š17â”Š\n â”Š17â”Š18â”Š  useEffect(() => {\n â”Š18â”Š19â”Š    const elem = ref.current;\n```\n```diff\n@@ -27,6 +28,13 @@\n â”Š27â”Š28â”Š      elem!.removeEventListener('scroll', handleScroll);\n â”Š28â”Š29â”Š    };\n â”Š29â”Š30â”Š  }, [ref, handleScroll]);\n+â”Š  â”Š31â”Š\n+â”Š  â”Š32â”Š  // loads more if fetching has started\n+â”Š  â”Š33â”Š  useEffect(() => {\n+â”Š  â”Š34â”Š    if (isFetching) {\n+â”Š  â”Š35â”Š      onLoadMore();\n+â”Š  â”Š36â”Š    }\n+â”Š  â”Š37â”Š  }, [isFetching, onLoadMore]);\n â”Š30â”Š38â”Š};\n â”Š31â”Š39â”Š\n â”Š32â”Š40â”Šexport default useInfiniteScroll;\n```\n\n[}]: #\n\nThat's why `isFetching` state is necessary but as you can tell, we don't set it to `false`.\n\n[{]: <helper> (diffStep \"15.4\" module=\"client\")\n\n#### [__Client__ Step 15.4: Allow to notify when finished](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/e3b7bbd9b5bb880d4e00e38aff39d20c025f636f)\n\n##### Changed src&#x2F;hooks&#x2F;use-infinite-scroll.ts\n```diff\n@@ -6,7 +6,7 @@\n â”Š 6â”Š 6â”Š}: {\n â”Š 7â”Š 7â”Š  onLoadMore: Function;\n â”Š 8â”Š 8â”Š  ref: RefObject<HTMLElement>;\n-â”Š 9â”Š  â”Š}) => {\n+â”Š  â”Š 9â”Š}): [boolean, () => void] => {\n â”Š10â”Š10â”Š  const [isFetching, setIsFetching] = useState(false);\n â”Š11â”Š11â”Š  const handleScroll = useCallback(() => {\n â”Š12â”Š12â”Š    if (ref.current!.scrollTop === 0 && isFetching === false) {\n```\n```diff\n@@ -35,6 +35,12 @@\n â”Š35â”Š35â”Š      onLoadMore();\n â”Š36â”Š36â”Š    }\n â”Š37â”Š37â”Š  }, [isFetching, onLoadMore]);\n+â”Š  â”Š38â”Š\n+â”Š  â”Š39â”Š  const stopFetching = useCallback(() => {\n+â”Š  â”Š40â”Š    setIsFetching(false);\n+â”Š  â”Š41â”Š  }, []);\n+â”Š  â”Š42â”Š\n+â”Š  â”Š43â”Š  return [isFetching, stopFetching];\n â”Š38â”Š44â”Š};\n â”Š39â”Š45â”Š\n â”Š40â”Š46â”Šexport default useInfiniteScroll;\n```\n\n[}]: #\n\nWe want the consumer of the hook to tell it when fetching is finished, that's why we expose the state with `stopFetching` function.\n\nThe next issue that appears right away is related to the case when there's no more data to fetch.\n\n[{]: <helper> (diffStep \"15.5\" module=\"client\")\n\n#### [__Client__ Step 15.5: Fetch only if there is more data](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/5a848de830a19b81d0c988262840659e1aa33aec)\n\n##### Changed src&#x2F;hooks&#x2F;use-infinite-scroll.ts\n```diff\n@@ -2,18 +2,20 @@\n â”Š 2â”Š 2â”Š\n â”Š 3â”Š 3â”Šexport const useInfiniteScroll = ({\n â”Š 4â”Š 4â”Š  ref,\n+â”Š  â”Š 5â”Š  hasMore,\n â”Š 5â”Š 6â”Š  onLoadMore,\n â”Š 6â”Š 7â”Š}: {\n â”Š 7â”Š 8â”Š  onLoadMore: Function;\n+â”Š  â”Š 9â”Š  hasMore: boolean;\n â”Š 8â”Š10â”Š  ref: RefObject<HTMLElement>;\n â”Š 9â”Š11â”Š}): [boolean, () => void] => {\n â”Š10â”Š12â”Š  const [isFetching, setIsFetching] = useState(false);\n â”Š11â”Š13â”Š  const handleScroll = useCallback(() => {\n-â”Š12â”Š  â”Š    if (ref.current!.scrollTop === 0 && isFetching === false) {\n-â”Š13â”Š  â”Š      // starts to fetch if scrolled to top and fetching is not in progress\n+â”Š  â”Š14â”Š    if (ref.current!.scrollTop === 0 && isFetching === false && hasMore) {\n+â”Š  â”Š15â”Š      // starts to fetch if scrolled to top, fetching is not in progress and has more data\n â”Š14â”Š16â”Š      setIsFetching(true);\n â”Š15â”Š17â”Š    }\n-â”Š16â”Š  â”Š  }, [ref, isFetching]);\n+â”Š  â”Š18â”Š  }, [ref, isFetching, hasMore]);\n â”Š17â”Š19â”Š\n â”Š18â”Š20â”Š  useEffect(() => {\n â”Š19â”Š21â”Š    const elem = ref.current;\n```\n\n[}]: #\n\nPfff... The hook part is done!\n\n### Pagination\n\nPagination is partially implemented thanks to Infinite Scrolling but the thing we need to still apply is React's context. It will be a central place of storing `limit` and `after` values, so they could be shared across multiple components and not passed directly from one to another.\n\n[{]: <helper> (diffStep \"15.7\" module=\"client\")\n\n#### [__Client__ Step 15.7: Implement pagination with context and hooks](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/54c7abe97837b57c58af8d7075b39abe4ae778c1)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -1,6 +1,6 @@\n â”Š1â”Š1â”Šimport gql from 'graphql-tag';\n â”Š2â”Š2â”Šimport React from 'react';\n-â”Š3â”Š â”Šimport { useCallback } from 'react';\n+â”Š â”Š3â”Šimport { useCallback, useState, useContext, useEffect } from 'react';\n â”Š4â”Š4â”Šimport { Redirect } from 'react-router-dom';\n â”Š5â”Š5â”Šimport { useApolloClient } from '@apollo/react-hooks';\n â”Š6â”Š6â”Šimport styled from 'styled-components';\n```\n```diff\n@@ -45,6 +45,48 @@\n â”Š45â”Š45â”Š  ${fragments.message}\n â”Š46â”Š46â”Š`;\n â”Š47â”Š47â”Š\n+â”Š  â”Š48â”Šconst PaginationContext = React.createContext({\n+â”Š  â”Š49â”Š  after: 0,\n+â”Š  â”Š50â”Š  limit: 20,\n+â”Š  â”Š51â”Š  /**\n+â”Š  â”Š52â”Š   * Sets new cursor\n+â”Š  â”Š53â”Š   */\n+â”Š  â”Š54â”Š  setAfter: (after: number) => {},\n+â”Š  â”Š55â”Š  /**\n+â”Š  â”Š56â”Š   * Resets `after` value to its inital state (null) so\n+â”Š  â”Š57â”Š   */\n+â”Š  â”Š58â”Š  reset: () => {},\n+â”Š  â”Š59â”Š});\n+â”Š  â”Š60â”Š\n+â”Š  â”Š61â”Šconst usePagination = () => {\n+â”Š  â”Š62â”Š  const pagination = useContext(PaginationContext);\n+â”Š  â”Š63â”Š\n+â”Š  â”Š64â”Š  // Resets the pagination every time a component did unmount\n+â”Š  â”Š65â”Š  useEffect(() => {\n+â”Š  â”Š66â”Š    return () => {\n+â”Š  â”Š67â”Š      pagination.reset();\n+â”Š  â”Š68â”Š    };\n+â”Š  â”Š69â”Š  }, [pagination]);\n+â”Š  â”Š70â”Š\n+â”Š  â”Š71â”Š  return pagination;\n+â”Š  â”Š72â”Š};\n+â”Š  â”Š73â”Š\n+â”Š  â”Š74â”Šexport const ChatPaginationProvider = ({ children }: { children: any }) => {\n+â”Š  â”Š75â”Š  const [after, setAfter] = useState<number | null>(null);\n+â”Š  â”Š76â”Š\n+â”Š  â”Š77â”Š  return (\n+â”Š  â”Š78â”Š    <PaginationContext.Provider\n+â”Š  â”Š79â”Š      value={{\n+â”Š  â”Š80â”Š        limit: 20,\n+â”Š  â”Š81â”Š        after: after!,\n+â”Š  â”Š82â”Š        setAfter,\n+â”Š  â”Š83â”Š        reset: () => setAfter(null),\n+â”Š  â”Š84â”Š      }}>\n+â”Š  â”Š85â”Š      {children}\n+â”Š  â”Š86â”Š    </PaginationContext.Provider>\n+â”Š  â”Š87â”Š  );\n+â”Š  â”Š88â”Š};\n+â”Š  â”Š89â”Š\n â”Š48â”Š90â”Šexport const useGetChatPrefetch = () => {\n â”Š49â”Š91â”Š  const client = useApolloClient();\n```\n\n[}]: #\n\nWe implemented three things:\n\n- `PaginationContext` is simple, it stores the values but also allows to set a new one for `after` or even bring it all back to the initial state.\n- `usePagination` hook is there so components could use `PaginationContext` and to make sure we reset it when component unmounts.\n- `ChatPaginationProvider` provides the logic and core functionality\n\nSince the pagination is almost ready, let's make use of it in `useGetChatPrefetch` hook and `ChatRoomScreen` component.\n\n[{]: <helper> (diffStep \"15.8\" module=\"client\")\n\n#### [__Client__ Step 15.8: Use pagination limit and after props](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/4ad1ef7281217bc4a877bbe804b272d2a3a55079)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -89,12 +89,15 @@\n â”Š 89â”Š 89â”Š\n â”Š 90â”Š 90â”Šexport const useGetChatPrefetch = () => {\n â”Š 91â”Š 91â”Š  const client = useApolloClient();\n+â”Š   â”Š 92â”Š  const { limit, after } = usePagination();\n â”Š 92â”Š 93â”Š\n â”Š 93â”Š 94â”Š  return (chatId: string) => {\n â”Š 94â”Š 95â”Š    client.query<GetChatQuery, GetChatQueryVariables>({\n â”Š 95â”Š 96â”Š      query: GetChatDocument,\n â”Š 96â”Š 97â”Š      variables: {\n â”Š 97â”Š 98â”Š        chatId,\n+â”Š   â”Š 99â”Š        after,\n+â”Š   â”Š100â”Š        limit,\n â”Š 98â”Š101â”Š      },\n â”Š 99â”Š102â”Š    });\n â”Š100â”Š103â”Š  };\n```\n```diff\n@@ -109,8 +112,9 @@\n â”Š109â”Š112â”Š  history,\n â”Š110â”Š113â”Š  chatId,\n â”Š111â”Š114â”Š}) => {\n+â”Š   â”Š115â”Š  const { after, limit } = usePagination();\n â”Š112â”Š116â”Š  const { data, loading } = useGetChatQuery({\n-â”Š113â”Š   â”Š    variables: { chatId },\n+â”Š   â”Š117â”Š    variables: { chatId, after, limit },\n â”Š114â”Š118â”Š  });\n â”Š115â”Š119â”Š\n â”Š116â”Š120â”Šconst [addMessage] = useAddMessageMutation();\n```\n\n[}]: #\n\nThis won't work yet because there's nothing that creates the context.\n\n[{]: <helper> (diffStep \"15.9\" module=\"client\")\n\n#### [__Client__ Step 15.9: Use ChatPaginationProvider](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/45dd10e9aa39f48024e754dda1dd383632622804)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -108,10 +108,7 @@\n â”Š108â”Š108â”Š  history: History;\n â”Š109â”Š109â”Š}\n â”Š110â”Š110â”Š\n-â”Š111â”Š   â”Šconst ChatRoomScreen: React.FC<ChatRoomScreenParams> = ({\n-â”Š112â”Š   â”Š  history,\n-â”Š113â”Š   â”Š  chatId,\n-â”Š114â”Š   â”Š}) => {\n+â”Š   â”Š111â”Šconst ChatRoom: React.FC<ChatRoomScreenParams> = ({ history, chatId }) => {\n â”Š115â”Š112â”Š  const { after, limit } = usePagination();\n â”Š116â”Š113â”Š  const { data, loading } = useGetChatQuery({\n â”Š117â”Š114â”Š    variables: { chatId, after, limit },\n```\n```diff\n@@ -176,4 +173,15 @@\n â”Š176â”Š173â”Š  );\n â”Š177â”Š174â”Š};\n â”Š178â”Š175â”Š\n+â”Š   â”Š176â”Šconst ChatRoomScreen: React.FC<ChatRoomScreenParams> = ({\n+â”Š   â”Š177â”Š  history,\n+â”Š   â”Š178â”Š  chatId,\n+â”Š   â”Š179â”Š}) => {\n+â”Š   â”Š180â”Š  return (\n+â”Š   â”Š181â”Š    <ChatPaginationProvider>\n+â”Š   â”Š182â”Š      <ChatRoom history={history} chatId={chatId} />\n+â”Š   â”Š183â”Š    </ChatPaginationProvider>\n+â”Š   â”Š184â”Š  );\n+â”Š   â”Š185â”Š};\n+â”Š   â”Š186â”Š\n â”Š179â”Š187â”Šexport default ChatRoomScreen;\n```\n\n[}]: #\n\nWe had to split the `ChatRoomScreen` into two pieces. One that includes `ChatPaginationProvider` and produces `chatId` and the other that keeps pretty much everything else. This way the tree of child components, starting from `ChatRoom` share the same context.\n\n### Fetching more messages\n\nEverything is set up, we can now move on and consume the `useInfiniteScroll` in the `MessagesList` component.\n\n[{]: <helper> (diffStep \"15.10\" module=\"client\")\n\n#### [__Client__ Step 15.10: Make use of infinite scroll in MessagesList component](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/8bb0caffd9bc07fc4643c15045cd2b6078e45ca9)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;MessagesList.tsx\n```diff\n@@ -3,14 +3,27 @@\n â”Š 3â”Š 3â”Šimport { useEffect, useRef } from 'react';\n â”Š 4â”Š 4â”Šimport ReactDOM from 'react-dom';\n â”Š 5â”Š 5â”Šimport styled, { css } from 'styled-components';\n+â”Š  â”Š 6â”Šimport { useInfiniteScroll } from '../../hooks/use-infinite-scroll';\n â”Š 6â”Š 7â”Š\n â”Š 7â”Š 8â”Šconst Container = styled.div`\n+â”Š  â”Š 9â”Š  position: relative;\n â”Š 8â”Š10â”Š  display: block;\n â”Š 9â”Š11â”Š  flex: 2;\n â”Š10â”Š12â”Š  overflow-y: overlay;\n â”Š11â”Š13â”Š  padding: 0 15px;\n â”Š12â”Š14â”Š`;\n â”Š13â”Š15â”Š\n+â”Š  â”Š16â”Šconst LoadingMore = styled.div`\n+â”Š  â”Š17â”Š  height: 30px;\n+â”Š  â”Š18â”Š  line-height: 30px;\n+â”Š  â”Š19â”Š  position: absolute;\n+â”Š  â”Š20â”Š  top: 0;\n+â”Š  â”Š21â”Š  right: 0;\n+â”Š  â”Š22â”Š  bottom: 0;\n+â”Š  â”Š23â”Š  left: 0;\n+â”Š  â”Š24â”Š  text-align: center;\n+â”Š  â”Š25â”Š`;\n+â”Š  â”Š26â”Š\n â”Š14â”Š27â”Štype StyledProp = {\n â”Š15â”Š28â”Š  isMine: any;\n â”Š16â”Š29â”Š};\n```\n```diff\n@@ -89,19 +102,36 @@\n â”Š 89â”Š102â”Š}\n â”Š 90â”Š103â”Šinterface MessagesListProps {\n â”Š 91â”Š104â”Š  messages: Array<Message>;\n+â”Š   â”Š105â”Š  loadMore: Function;\n+â”Š   â”Š106â”Š  hasMore: boolean;\n â”Š 92â”Š107â”Š}\n â”Š 93â”Š108â”Š\n-â”Š 94â”Š   â”Šconst MessagesList: React.FC<MessagesListProps> = ({ messages }) => {\n-â”Š 95â”Š   â”Š  const selfRef = useRef(null);\n+â”Š   â”Š109â”Šconst MessagesList: React.FC<MessagesListProps> = ({\n+â”Š   â”Š110â”Š  messages,\n+â”Š   â”Š111â”Š  loadMore,\n+â”Š   â”Š112â”Š  hasMore,\n+â”Š   â”Š113â”Š}) => {\n+â”Š   â”Š114â”Š  const selfRef = useRef<HTMLDivElement>(null);\n+â”Š   â”Š115â”Š  const [fetching, stopFetching] = useInfiniteScroll({\n+â”Š   â”Š116â”Š    onLoadMore: loadMore,\n+â”Š   â”Š117â”Š    hasMore,\n+â”Š   â”Š118â”Š    ref: selfRef!,\n+â”Š   â”Š119â”Š  });\n â”Š 96â”Š120â”Š\n â”Š 97â”Š121â”Š  useEffect(() => {\n â”Š 98â”Š122â”Š    if (!selfRef.current) return;\n+â”Š   â”Š123â”Š\n+â”Š   â”Š124â”Š    if (fetching) {\n+â”Š   â”Š125â”Š      stopFetching();\n+â”Š   â”Š126â”Š    }\n+â”Š   â”Š127â”Š\n â”Š 99â”Š128â”Š    const selfDOMNode = ReactDOM.findDOMNode(selfRef.current) as HTMLElement;\n â”Š100â”Š129â”Š    selfDOMNode.scrollTop = Number.MAX_SAFE_INTEGER;\n-â”Š101â”Š   â”Š  }, [messages.length]);\n+â”Š   â”Š130â”Š  }, [messages.length, selfRef, fetching, stopFetching]);\n â”Š102â”Š131â”Š\n â”Š103â”Š132â”Š  return (\n â”Š104â”Š133â”Š    <Container ref={selfRef}>\n+â”Š   â”Š134â”Š      {fetching && <LoadingMore>{'Loading more messages...'}</LoadingMore>}\n â”Š105â”Š135â”Š      {messages.map((message: any) => (\n â”Š106â”Š136â”Š        <MessageItem\n â”Š107â”Š137â”Š          data-testid=\"message-item\"\n```\n\n[}]: #\n\nWe added the `LoadingMore` component with *Loading more messages...* text in it that pops out when fetching is in progress.\nBecause the `MessagesList` is not responsible of quering data we don't know exactly when it's completed but we can assume, it happens once the length of `messages` changes.\nWe also pass `onLoadMore` and `hasMore` props to the parent component and the `useInfiniteScroll` uses `MessagesList` as the element we're going to scroll in.\n\nThere's also one more thing that could be turned into a hook, it's the logic responsible for scrolling to bottom of the page, every time `messages` changes.\n\n[{]: <helper> (diffStep \"15.11\" module=\"client\")\n\n#### [__Client__ Step 15.11: Implement a hook responsible for scrolling](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/ce62102a6cf4e420fc3cb93cd625a1fdf6ab0ffa)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;MessagesList.tsx\n```diff\n@@ -1,9 +1,9 @@\n â”Š1â”Š1â”Šimport moment from 'moment';\n â”Š2â”Š2â”Šimport React from 'react';\n â”Š3â”Š3â”Šimport { useEffect, useRef } from 'react';\n-â”Š4â”Š â”Šimport ReactDOM from 'react-dom';\n â”Š5â”Š4â”Šimport styled, { css } from 'styled-components';\n â”Š6â”Š5â”Šimport { useInfiniteScroll } from '../../hooks/use-infinite-scroll';\n+â”Š â”Š6â”Šimport { useAdjustedScroll } from '../../hooks/use-adjusted-scroll';\n â”Š7â”Š7â”Š\n â”Š8â”Š8â”Šconst Container = styled.div`\n â”Š9â”Š9â”Š  position: relative;\n```\n```diff\n@@ -117,17 +117,19 @@\n â”Š117â”Š117â”Š    hasMore,\n â”Š118â”Š118â”Š    ref: selfRef!,\n â”Š119â”Š119â”Š  });\n+â”Š   â”Š120â”Š  const adjustScroll = useAdjustedScroll(selfRef);\n â”Š120â”Š121â”Š\n â”Š121â”Š122â”Š  useEffect(() => {\n â”Š122â”Š123â”Š    if (!selfRef.current) return;\n â”Š123â”Š124â”Š\n â”Š124â”Š125â”Š    if (fetching) {\n â”Š125â”Š126â”Š      stopFetching();\n+â”Š   â”Š127â”Š      adjustScroll();\n+â”Š   â”Š128â”Š    } else {\n+â”Š   â”Š129â”Š      // scroll to the most recent message\n+â”Š   â”Š130â”Š      adjustScroll(true);\n â”Š126â”Š131â”Š    }\n-â”Š127â”Š   â”Š\n-â”Š128â”Š   â”Š    const selfDOMNode = ReactDOM.findDOMNode(selfRef.current) as HTMLElement;\n-â”Š129â”Š   â”Š    selfDOMNode.scrollTop = Number.MAX_SAFE_INTEGER;\n-â”Š130â”Š   â”Š  }, [messages.length, selfRef, fetching, stopFetching]);\n+â”Š   â”Š132â”Š  }, [messages.length, selfRef, fetching, stopFetching, adjustScroll]);\n â”Š131â”Š133â”Š\n â”Š132â”Š134â”Š  return (\n â”Š133â”Š135â”Š    <Container ref={selfRef}>\n```\n\n##### Added src&#x2F;hooks&#x2F;use-adjusted-scroll.ts\n```diff\n@@ -0,0 +1,35 @@\n+â”Š  â”Š 1â”Šimport { useState, useCallback, RefObject } from 'react';\n+â”Š  â”Š 2â”Šimport * as ReactDOM from 'react-dom';\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šexport const useAdjustedScroll = (ref: RefObject<HTMLElement>) => {\n+â”Š  â”Š 5â”Š  const [previousScroll, setPreviousScroll] = useState<{\n+â”Š  â”Š 6â”Š    top: number;\n+â”Š  â”Š 7â”Š    height: number;\n+â”Š  â”Š 8â”Š  }>();\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Š  /**\n+â”Š  â”Š11â”Š   * Scrolls to the previous position or completely to bottom (on demand)\n+â”Š  â”Š12â”Š   */\n+â”Š  â”Š13â”Š  const adjust = useCallback(\n+â”Š  â”Š14â”Š    (scrollToBottom?: boolean) => {\n+â”Š  â”Š15â”Š      if (!ref.current) return;\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š      const node = ReactDOM.findDOMNode(ref.current) as HTMLElement;\n+â”Š  â”Š18â”Š      const height =\n+â”Š  â”Š19â”Š        !scrollToBottom && previousScroll\n+â”Š  â”Š20â”Š          ? previousScroll.height\n+â”Š  â”Š21â”Š          : node.clientHeight;\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Š      node.scrollTop = node.scrollHeight - height;\n+â”Š  â”Š24â”Š\n+â”Š  â”Š25â”Š      // saves current scroll details\n+â”Š  â”Š26â”Š      setPreviousScroll({\n+â”Š  â”Š27â”Š        top: node.scrollTop,\n+â”Š  â”Š28â”Š        height: node.scrollHeight,\n+â”Š  â”Š29â”Š      });\n+â”Š  â”Š30â”Š    },\n+â”Š  â”Š31â”Š    [ref, previousScroll]\n+â”Š  â”Š32â”Š  );\n+â”Š  â”Š33â”Š\n+â”Š  â”Š34â”Š  return adjust;\n+â”Š  â”Š35â”Š};\n```\n\n[}]: #\n\nWe also added some extra functionality there. Because we don't want to scroll to bottom when a new message is added, the function returned by `useAdjustedScroll` accepts now an argument.\n\nWe did the `MessagesList`, now let's move onto real data and the `ChatRoom` component.\n\n[{]: <helper> (diffStep \"15.12\" module=\"client\")\n\n#### [__Client__ Step 15.12: Implement pagination in ChatRoom component](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/023ec267f568c01cd5a2255c0fc0ee4d8046d927)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -109,7 +109,7 @@\n â”Š109â”Š109â”Š}\n â”Š110â”Š110â”Š\n â”Š111â”Š111â”Šconst ChatRoom: React.FC<ChatRoomScreenParams> = ({ history, chatId }) => {\n-â”Š112â”Š   â”Š  const { after, limit } = usePagination();\n+â”Š   â”Š112â”Š  const { after, limit, setAfter } = usePagination();\n â”Š113â”Š113â”Š  const { data, loading } = useGetChatQuery({\n â”Š114â”Š114â”Š    variables: { chatId, after, limit },\n â”Š115â”Š115â”Š  });\n```\n```diff\n@@ -150,6 +150,14 @@\n â”Š150â”Š150â”Š    [data, chatId, addMessage]\n â”Š151â”Š151â”Š  );\n â”Š152â”Š152â”Š\n+â”Š   â”Š153â”Š  useEffect(() => {\n+â”Š   â”Š154â”Š    if (!after) {\n+â”Š   â”Š155â”Š      return;\n+â”Š   â”Š156â”Š    }\n+â”Š   â”Š157â”Š\n+â”Š   â”Š158â”Š    // every time after changes its value, fetch more messages\n+â”Š   â”Š159â”Š  }, [after]);\n+â”Š   â”Š160â”Š\n â”Š153â”Š161â”Š  if (data === undefined) {\n â”Š154â”Š162â”Š    return null;\n â”Š155â”Š163â”Š  }\n```\n```diff\n@@ -167,7 +175,13 @@\n â”Š167â”Š175â”Š  return (\n â”Š168â”Š176â”Š    <Container>\n â”Š169â”Š177â”Š      <ChatNavbar chat={chat} history={history} />\n-â”Š170â”Š   â”Š      {chat.messages && <MessagesList messages={chat.messages} />}\n+â”Š   â”Š178â”Š      {chat.messages && (\n+â”Š   â”Š179â”Š        <MessagesList\n+â”Š   â”Š180â”Š          messages={chat.messages.messages}\n+â”Š   â”Š181â”Š          hasMore={chat.messages.hasMore}\n+â”Š   â”Š182â”Š          loadMore={() => setAfter(chat.messages.cursor!)}\n+â”Š   â”Š183â”Š        />\n+â”Š   â”Š184â”Š      )}\n â”Š171â”Š185â”Š      <MessageInput onSendMessage={onSendMessage} />\n â”Š172â”Š186â”Š    </Container>\n â”Š173â”Š187â”Š  );\n```\n\n[}]: #\n\nAs you see above, every time the `MessagesList` asks for more messages, the `after` changes its value to `chat.messages.cursor` which means that's a new \"end\" of the list and we need to fill it up.\n\nRight now we just have a logic and a place to do it but we still need to make a GraphQL call.\n\nFortunately, Apollo lets you do pagination with a method called `fetchMore`. You need to specify what query and variables to use for the update, and how to merge the new query result with the existing data on the client. How exactly you do that will determine what kind of pagination you are implementing, in our case it's cursor-based.\n\nBut there's a catch!\n\nIt's related to how Apollo stores query results in cache. When we update the variables, in our case it's the `after` that changes quite a lot, a new record is created that is totally unrelated to the original query. That's because Apollo uses a combination of variables and query string to produce a key.\n\nAn example:\n\n\n```graphql\n{\n  query getUser($id: ID!) {\n    user(id: $id) {\n      name\n    }\n  }\n}\n```\n\nThe result of `getUser` query will be saved under `user({\"id\":2})` key.\n\nThis is a huge problem, it breaks imperative store updates but that's why `@connection` directive exists. It directs Apollo to use a stable store key for paginated queries, so every `useQuery()` or `fetchMore()` is being placed in the same space.\n\nWith all that knowledge, let's implement the last puzzle piece!\n\n[{]: <helper> (diffStep \"15.13\" module=\"client\")\n\n#### [__Client__ Step 15.13: Use fetchMore to load more messages](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/9964a2857263598e2520a9f96394244686ee2383)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -110,7 +110,7 @@\n â”Š110â”Š110â”Š\n â”Š111â”Š111â”Šconst ChatRoom: React.FC<ChatRoomScreenParams> = ({ history, chatId }) => {\n â”Š112â”Š112â”Š  const { after, limit, setAfter } = usePagination();\n-â”Š113â”Š   â”Š  const { data, loading } = useGetChatQuery({\n+â”Š   â”Š113â”Š  const { data, loading, fetchMore } = useGetChatQuery({\n â”Š114â”Š114â”Š    variables: { chatId, after, limit },\n â”Š115â”Š115â”Š  });\n â”Š116â”Š116â”Š\n```\n```diff\n@@ -156,7 +156,30 @@\n â”Š156â”Š156â”Š    }\n â”Š157â”Š157â”Š\n â”Š158â”Š158â”Š    // every time after changes its value, fetch more messages\n-â”Š159â”Š   â”Š  }, [after]);\n+â”Š   â”Š159â”Š    fetchMore({\n+â”Š   â”Š160â”Š      variables: {\n+â”Š   â”Š161â”Š        after,\n+â”Š   â”Š162â”Š        limit,\n+â”Š   â”Š163â”Š      },\n+â”Š   â”Š164â”Š      updateQuery(prev, { fetchMoreResult }) {\n+â”Š   â”Š165â”Š        const messages = [\n+â”Š   â”Š166â”Š          ...fetchMoreResult!.chat!.messages.messages,\n+â”Š   â”Š167â”Š          ...prev.chat!.messages.messages,\n+â”Š   â”Š168â”Š        ];\n+â”Š   â”Š169â”Š\n+â”Š   â”Š170â”Š        return {\n+â”Š   â”Š171â”Š          ...prev,\n+â”Š   â”Š172â”Š          chat: {\n+â”Š   â”Š173â”Š            ...prev.chat!,\n+â”Š   â”Š174â”Š            messages: {\n+â”Š   â”Š175â”Š              ...fetchMoreResult!.chat!.messages,\n+â”Š   â”Š176â”Š              messages,\n+â”Š   â”Š177â”Š            },\n+â”Š   â”Š178â”Š          },\n+â”Š   â”Š179â”Š        };\n+â”Š   â”Š180â”Š      },\n+â”Š   â”Š181â”Š    });\n+â”Š   â”Š182â”Š  }, [after, limit, fetchMore]);\n â”Š160â”Š183â”Š\n â”Š161â”Š184â”Š  if (data === undefined) {\n â”Š162â”Š185â”Š    return null;\n```\n\n[}]: #\n\nAs you see, we mutate the store as usual and we put fetched messages before the existing ones. Remember, it's from older to newer.\n\n### Looking at the bundle size\n\nWe can't of course forget about one of the most important aspects of optimization, the size of the application. As bundle size increases, both the parsing time and the time of the request takes longer.\n\nHow can we check what libraries and source files are shipped within the produced bundle?\n\nThere are many tools that analyze it for us but we're going to use only one of them, just for educational purpose.\n\n      $ yarn add -D source-map-explorer\n\nWe're going to add the `size` npm script in which we point the `source-map-explorer` to transpiled js files.\n\n[{]: <helper> (diffStep \"15.14\" module=\"client\")\n\n#### [__Client__ Step 15.14: Explore bundle size](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/70a9ecc8c7b408aedf5ea755cdc8037444d2f9cc)\n\n##### Changed package.json\n```diff\n@@ -50,7 +50,8 @@\n â”Š50â”Š50â”Š    \"test\": \"TZ=\\\"Asia/Jerusalem\\\" react-scripts test\",\n â”Š51â”Š51â”Š    \"eject\": \"react-scripts eject\",\n â”Š52â”Š52â”Š    \"codegen\": \"gql-gen\",\n-â”Š53â”Š  â”Š    \"format\": \"prettier \\\"**/*.{ts,tsx,css,graphql}\\\" --write\"\n+â”Š  â”Š53â”Š    \"format\": \"prettier \\\"**/*.{ts,tsx,css,graphql}\\\" --write\",\n+â”Š  â”Š54â”Š    \"size\": \"source-map-explorer 'build/static/js/*.js'\"\n â”Š54â”Š55â”Š  },\n â”Š55â”Š56â”Š  \"eslintConfig\": {\n â”Š56â”Š57â”Š    \"extends\": \"react-app\"\n```\n```diff\n@@ -70,6 +71,7 @@\n â”Š70â”Š71â”Š  \"devDependencies\": {\n â”Š71â”Š72â”Š    \"@testing-library/jest-dom\": \"4.0.0\",\n â”Š72â”Š73â”Š    \"@testing-library/react\": \"9.1.0\",\n-â”Š73â”Š  â”Š    \"jest-fetch-mock\": \"2.1.2\"\n+â”Š  â”Š74â”Š    \"jest-fetch-mock\": \"2.1.2\",\n+â”Š  â”Š75â”Š    \"source-map-explorer\": \"2.0.1\"\n â”Š74â”Š76â”Š  }\n â”Š75â”Š77â”Š}ðŸš«â†µ\n```\n\n[}]: #\n\nLet's see it in action, run:\n\n    $ yarn build && yarn size\n\nThat's what you should see:\n\n![Source Map Explorer](../../../assets/step17/img-10.png \"Source Map Explorer\")\n\nIt's interactive so you can dive deeper and deeper into those blocks but in general it shows what libraries and files are included in the produced output with their size(not minified and not gzipped).\n\n![Source Map Explorer](../../../assets/step17/img-11.png \"Source Map Explorer with moment highlighted\")\n\nFor example, we see that `moment` takes almost _53.49KB_ which is enourmous. In fact we only use its `format` method. The reason is that the library is not well tree-shakable. There are plugins for webpack (or any other build tool) that helps with it but we're going to use an alternative instead. We're going to replace it with `date-fns`.\n\n[{]: <helper> (diffStep \"15.15\" module=\"client\")\n\n#### [__Client__ Step 15.15: Replace moment with date-fns](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/e93841016bab94b75a645b273f1b7228a3ed0b50)\n\n##### Changed package.json\n```diff\n@@ -30,9 +30,9 @@\n â”Š30â”Š30â”Š    \"graphql\": \"14.4.2\",\n â”Š31â”Š31â”Š    \"apollo-link-ws\": \"1.0.18\",\n â”Š32â”Š32â”Š    \"apollo-utilities\": \"1.3.2\",\n+â”Š  â”Š33â”Š    \"date-fns\": \"1.30.1\",\n â”Š33â”Š34â”Š    \"graphql-tag\": \"2.10.1\",\n â”Š34â”Š35â”Š    \"history\": \"4.9.0\",\n-â”Š35â”Š  â”Š    \"moment\": \"2.24.0\",\n â”Š36â”Š36â”Š    \"prettier\": \"1.18.2\",\n â”Š37â”Š37â”Š    \"react\": \"16.9.0\",\n â”Š38â”Š38â”Š    \"react-dom\": \"16.9.0\",\n```\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;MessagesList.tsx\n```diff\n@@ -1,4 +1,4 @@\n-â”Š1â”Š â”Šimport moment from 'moment';\n+â”Š â”Š1â”Šimport format from 'date-fns/format';\n â”Š2â”Š2â”Šimport React from 'react';\n â”Š3â”Š3â”Šimport { useEffect, useRef } from 'react';\n â”Š4â”Š4â”Šimport styled, { css } from 'styled-components';\n```\n```diff\n@@ -141,7 +141,7 @@\n â”Š141â”Š141â”Š          key={message.id}>\n â”Š142â”Š142â”Š          <Contents data-testid=\"message-content\">{message.content}</Contents>\n â”Š143â”Š143â”Š          <Timestamp data-testid=\"message-date\">\n-â”Š144â”Š   â”Š            {moment(message.createdAt).format('HH:mm')}\n+â”Š   â”Š144â”Š            {format(message.createdAt, 'HH:mm')}\n â”Š145â”Š145â”Š          </Timestamp>\n â”Š146â”Š146â”Š        </MessageItem>\n â”Š147â”Š147â”Š      ))}\n```\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -1,5 +1,5 @@\n â”Š1â”Š1â”Šimport React from 'react';\n-â”Š2â”Š â”Šimport moment from 'moment';\n+â”Š â”Š2â”Šimport format from 'date-fns/format';\n â”Š3â”Š3â”Šimport { List, ListItem } from '@material-ui/core';\n â”Š4â”Š4â”Šimport styled from 'styled-components';\n â”Š5â”Š5â”Šimport { useCallback } from 'react';\n```\n```diff\n@@ -104,7 +104,7 @@\n â”Š104â”Š104â”Š                    {chat.lastMessage.content}\n â”Š105â”Š105â”Š                  </MessageContent>\n â”Š106â”Š106â”Š                  <MessageDate data-testid=\"date\">\n-â”Š107â”Š   â”Š                    {moment(chat.lastMessage.createdAt).format('HH:mm')}\n+â”Š   â”Š107â”Š                    {format(chat.lastMessage.createdAt, 'HH:mm')}\n â”Š108â”Š108â”Š                  </MessageDate>\n â”Š109â”Š109â”Š                </React.Fragment>\n â”Š110â”Š110â”Š              )}\n```\n\n[}]: #\n\nNow when you run:\n\n    $ yarn build && yarn size\n\nYou should see the following results.\n\n![Source Map Explorer](../../../assets/step17/img-12.png \"Source Map Explorer with date-fns\")\n\nThe bundle size is a bit smaller and `date-fns` takes only _8.93KB_ which in comparison to _53.49KB_ is a significant change!\n\n## Load testing\n\nLoad testing, in short, is about finding the limit of an application and figure out how to push it even more. We simulate a stressful behavior and apply that to the server until it crashes. Weâ€™re trying to answer the question of how the api deals with a pressure.\n\nWhen to do load testing?\nI would say at least before and after major changes, when pre-launching and just from time to time to prevent regressions.\n\nBefore doing load testing, we need to prepare a bit first. Right now we use `ts-node` to run the server but it would be faster to run it directly using `node`, just to avoid on-the-fly transpilation of TypeScript files.\n\nIn order to do it, we need to define the `outDir` in `tsconfig.json` and add a build step.\n\n[{]: <helper> (diffStep \"14.12\" module=\"server\")\n\n#### [__Server__ Step 14.12: Produce transpiled code](https://github.com/Urigo/WhatsApp-Clone-Server/commit/5708d5846800446d4d9dd14a643d815da92da624)\n\n##### Changed .circleci&#x2F;config.yml\n```diff\n@@ -18,6 +18,9 @@\n â”Š18â”Š18â”Š      - run:\n â”Š19â”Š19â”Š          name: Install Dependencies\n â”Š20â”Š20â”Š          command: yarn\n+â”Š  â”Š21â”Š      - run:\n+â”Š  â”Š22â”Š          name: Build\n+â”Š  â”Š23â”Š          command: yarn build\n â”Š21â”Š24â”Š      - run:\n â”Š22â”Š25â”Š          name: Test\n â”Š23â”Š26â”Š          command: yarn test\n```\n\n##### Changed .gitignore\n```diff\n@@ -1,3 +1,4 @@\n+â”Š â”Š1â”Šdist\n â”Š1â”Š2â”Šnode_modules\n â”Š2â”Š3â”Šnpm-debug.log\n â”Š3â”Š4â”Štest-results/\n```\n\n##### Changed package.json\n```diff\n@@ -9,6 +9,8 @@\n â”Š 9â”Š 9â”Š  \"scripts\": {\n â”Š10â”Š10â”Š    \"prestart\": \"yarn codegen\",\n â”Š11â”Š11â”Š    \"start\": \"ts-node index.ts\",\n+â”Š  â”Š12â”Š    \"prebuild\": \"yarn codegen\",\n+â”Š  â”Š13â”Š    \"build\": \"tsc\",\n â”Š12â”Š14â”Š    \"test\": \"TZ=\\\"Asia/Jerusalem\\\" jest --runInBand --forceExit\",\n â”Š13â”Š15â”Š    \"codegen\": \"gql-gen\",\n â”Š14â”Š16â”Š    \"format\": \"prettier \\\"**/*.ts\\\" --write\"\n```\n\n##### Changed tsconfig.json\n```diff\n@@ -1,5 +1,6 @@\n â”Š1â”Š1â”Š{\n â”Š2â”Š2â”Š  \"compilerOptions\": {\n+â”Š â”Š3â”Š    \"outDir\": \"dist\",\n â”Š3â”Š4â”Š    \"target\": \"es2018\",\n â”Š4â”Š5â”Š    \"module\": \"commonjs\",\n â”Š5â”Š6â”Š    \"lib\": [\n```\n\n[}]: #\n\nNext, the script to actually run the server:\n\n[{]: <helper> (diffStep \"14.13\" files=\"package.json\" module=\"server\")\n\n#### [__Server__ Step 14.13: Prepare for production](https://github.com/Urigo/WhatsApp-Clone-Server/commit/f80770dce6559f7cff9936c0fdd8787487f1391e)\n\n##### Changed package.json\n```diff\n@@ -10,6 +10,7 @@\n â”Š10â”Š10â”Š    \"prestart\": \"yarn codegen\",\n â”Š11â”Š11â”Š    \"start\": \"ts-node index.ts\",\n â”Š12â”Š12â”Š    \"prebuild\": \"yarn codegen\",\n+â”Š  â”Š13â”Š    \"prod\": \"node dist/index.js\",\n â”Š13â”Š14â”Š    \"build\": \"tsc\",\n â”Š14â”Š15â”Š    \"test\": \"TZ=\\\"Asia/Jerusalem\\\" jest --runInBand --forceExit\",\n â”Š15â”Š16â”Š    \"codegen\": \"gql-gen\",\n```\n\n[}]: #\n\nOnce itâ€™s ready, we can move on to tooling.\n\n### Artillery\n\nArtillery is an open-source load testing and functional testing toolkit. Itâ€™s API is vast but we will focus on the core part of it which is relevant to this chapter. Artillery is available as a npm package:\n\n    $ yarn add -D artillery\n\nThe only step to use Artillery is to set it up. We will create the `artillery.yml` file, like this:\n\n[{]: <helper> (diffStep \"14.15\" module=\"server\")\n\n#### [__Server__ Step 14.15: Add artillery config](https://github.com/Urigo/WhatsApp-Clone-Server/commit/237cce305eaf31299f7acb7b6d287032191465f0)\n\n##### Added artillery.yml\n```diff\n@@ -0,0 +1,72 @@\n+â”Š  â”Š 1â”Šconfig:\n+â”Š  â”Š 2â”Š  target: 'http://localhost:4000/graphql'\n+â”Š  â”Š 3â”Š  phases:\n+â”Š  â”Š 4â”Š    - duration: 120\n+â”Š  â”Š 5â”Š      arrivalRate: 5\n+â”Š  â”Š 6â”Š      rampTo: 20\n+â”Š  â”Š 7â”Šscenarios:\n+â”Š  â”Š 8â”Š  - name: 'Sign in, send a new message and fetch a list of chats'\n+â”Š  â”Š 9â”Š    flow:\n+â”Š  â”Š10â”Š      - post:\n+â”Š  â”Š11â”Š          url: '/'\n+â”Š  â”Š12â”Š          json:\n+â”Š  â”Š13â”Š            variables:\n+â”Š  â”Š14â”Š              username: 'ray'\n+â”Š  â”Š15â”Š              password: '111'\n+â”Š  â”Š16â”Š            query: |\n+â”Š  â”Š17â”Š              mutation SignIn($username: String!, $password: String!) {\n+â”Š  â”Š18â”Š                signIn(username: $username, password: $password) {\n+â”Š  â”Š19â”Š                  id\n+â”Š  â”Š20â”Š                }\n+â”Š  â”Š21â”Š              }\n+â”Š  â”Š22â”Š      - post:\n+â”Š  â”Š23â”Š          url: '/'\n+â”Š  â”Š24â”Š          json:\n+â”Š  â”Š25â”Š            query: |\n+â”Š  â”Š26â”Š              mutation message {\n+â”Š  â”Š27â”Š                addMessage(chatId: \"1\", content: \"artillery\") {\n+â”Š  â”Š28â”Š                  id\n+â”Š  â”Š29â”Š                }\n+â”Š  â”Š30â”Š              }\n+â”Š  â”Š31â”Š      - post:\n+â”Š  â”Š32â”Š          url: '/'\n+â”Š  â”Š33â”Š          json:\n+â”Š  â”Š34â”Š            variables:\n+â”Š  â”Š35â”Š              limit: 20\n+â”Š  â”Š36â”Š            query: |\n+â”Š  â”Š37â”Š              fragment User on User {\n+â”Š  â”Š38â”Š                id\n+â”Š  â”Š39â”Š                name\n+â”Š  â”Š40â”Š                picture\n+â”Š  â”Š41â”Š              }\n+â”Š  â”Š42â”Š              fragment Message on Message {\n+â”Š  â”Š43â”Š                id\n+â”Š  â”Š44â”Š                content\n+â”Š  â”Š45â”Š                chat {\n+â”Š  â”Š46â”Š                  id\n+â”Š  â”Š47â”Š                }\n+â”Š  â”Š48â”Š                sender {\n+â”Š  â”Š49â”Š                  ...User\n+â”Š  â”Š50â”Š                }\n+â”Š  â”Š51â”Š                recipient {\n+â”Š  â”Š52â”Š                  ...User\n+â”Š  â”Š53â”Š                }\n+â”Š  â”Š54â”Š              }\n+â”Š  â”Š55â”Š              query GetChats($limit: Int!) {\n+â”Š  â”Š56â”Š                chats {\n+â”Š  â”Š57â”Š                  id\n+â”Š  â”Š58â”Š                  name\n+â”Š  â”Š59â”Š                  picture\n+â”Š  â”Š60â”Š                  lastMessage {\n+â”Š  â”Š61â”Š                    ...Message\n+â”Š  â”Š62â”Š                  }\n+â”Š  â”Š63â”Š                  messages(limit: $limit) {\n+â”Š  â”Š64â”Š                    messages {\n+â”Š  â”Š65â”Š                      ...Message\n+â”Š  â”Š66â”Š                    }\n+â”Š  â”Š67â”Š                  }\n+â”Š  â”Š68â”Š                  participants {\n+â”Š  â”Š69â”Š                    ...User\n+â”Š  â”Š70â”Š                  }\n+â”Š  â”Š71â”Š                }\n+â”Š  â”Š72â”Š              }\n```\n\n[}]: #\n\nAs you can see, the config file is built of two sections. First one is named `config` and it defines whatâ€™s our target and how the traffic should look like. We used one phase but it could have many. The `duration` parameter is to define how long the phase should take. The `arrivalRate` defines how many virtual users per second are going to hit the target and the `rampTo` directs Artillery to increase this number up to 20, at the middle of the phase.\n\nThe next section, called `scenarios`, is all about the actual requests. In our case, we want to authenticate user, submit a new message and fetch an entire list of chats with their messages at the end. Artillery shares cookies between request of the same virtual user, keep that on mind.\n\nWe used Ray as the user and fairly similar operations to what the client app sends. That should closely represent the actual usage of the API.\n\nEverything is fine with that config but we need to find the limit, to push even more. That's why we'll also add a second config with a bit more heavier traffic, something to simulate the more real life environment. It's pretty much the same setup except phases. First, we \"warms up\" the server for 2 minutes, same amount of times goes next with double the traffic, then we keep it for 5 minutes. At the end, we want to crash the server so we send nearly 100 virtual users per second for an entire minute. This way we know when it cracks.\n\n[{]: <helper> (diffStep \"14.16\" module=\"server\")\n\n#### [__Server__ Step 14.16: Artillery config to find a limit](https://github.com/Urigo/WhatsApp-Clone-Server/commit/7a6a509012f33d639637758007e82be3678c5139)\n\n##### Added artillery-limit.yml\n```diff\n@@ -0,0 +1,77 @@\n+â”Š  â”Š 1â”Šconfig:\n+â”Š  â”Š 2â”Š  target: 'http://localhost:4000/graphql'\n+â”Š  â”Š 3â”Š  phases:\n+â”Š  â”Š 4â”Š    - duration: 120\n+â”Š  â”Š 5â”Š      arrivalRate: 5\n+â”Š  â”Š 6â”Š    - duration: 120\n+â”Š  â”Š 7â”Š      arrivalRate: 10\n+â”Š  â”Š 8â”Š    - duration: 300\n+â”Š  â”Š 9â”Š      arrivalRate: 10\n+â”Š  â”Š10â”Š    - duration: 60\n+â”Š  â”Š11â”Š      arrivalRate: 100\n+â”Š  â”Š12â”Šscenarios:\n+â”Š  â”Š13â”Š  - name: 'Sign in, send a new message and fetch a list of chats'\n+â”Š  â”Š14â”Š    flow:\n+â”Š  â”Š15â”Š      - post:\n+â”Š  â”Š16â”Š          url: '/'\n+â”Š  â”Š17â”Š          json:\n+â”Š  â”Š18â”Š            variables:\n+â”Š  â”Š19â”Š              username: 'ray'\n+â”Š  â”Š20â”Š              password: '111'\n+â”Š  â”Š21â”Š            query: |\n+â”Š  â”Š22â”Š              mutation SignIn($username: String!, $password: String!) {\n+â”Š  â”Š23â”Š                signIn(username: $username, password: $password) {\n+â”Š  â”Š24â”Š                  id\n+â”Š  â”Š25â”Š                }\n+â”Š  â”Š26â”Š              }\n+â”Š  â”Š27â”Š      - post:\n+â”Š  â”Š28â”Š          url: '/'\n+â”Š  â”Š29â”Š          json:\n+â”Š  â”Š30â”Š            query: |\n+â”Š  â”Š31â”Š              mutation message {\n+â”Š  â”Š32â”Š                addMessage(chatId: \"1\", content: \"artillery\") {\n+â”Š  â”Š33â”Š                  id\n+â”Š  â”Š34â”Š                }\n+â”Š  â”Š35â”Š              }\n+â”Š  â”Š36â”Š      - post:\n+â”Š  â”Š37â”Š          url: '/'\n+â”Š  â”Š38â”Š          json:\n+â”Š  â”Š39â”Š            variables:\n+â”Š  â”Š40â”Š              limit: 20\n+â”Š  â”Š41â”Š            query: |\n+â”Š  â”Š42â”Š              fragment User on User {\n+â”Š  â”Š43â”Š                id\n+â”Š  â”Š44â”Š                name\n+â”Š  â”Š45â”Š                picture\n+â”Š  â”Š46â”Š              }\n+â”Š  â”Š47â”Š              fragment Message on Message {\n+â”Š  â”Š48â”Š                id\n+â”Š  â”Š49â”Š                content\n+â”Š  â”Š50â”Š                chat {\n+â”Š  â”Š51â”Š                  id\n+â”Š  â”Š52â”Š                }\n+â”Š  â”Š53â”Š                sender {\n+â”Š  â”Š54â”Š                  ...User\n+â”Š  â”Š55â”Š                }\n+â”Š  â”Š56â”Š                recipient {\n+â”Š  â”Š57â”Š                  ...User\n+â”Š  â”Š58â”Š                }\n+â”Š  â”Š59â”Š              }\n+â”Š  â”Š60â”Š              query GetChats($limit: Int!) {\n+â”Š  â”Š61â”Š                chats {\n+â”Š  â”Š62â”Š                  id\n+â”Š  â”Š63â”Š                  name\n+â”Š  â”Š64â”Š                  picture\n+â”Š  â”Š65â”Š                  lastMessage {\n+â”Š  â”Š66â”Š                    ...Message\n+â”Š  â”Š67â”Š                  }\n+â”Š  â”Š68â”Š                  messages(limit: $limit) {\n+â”Š  â”Š69â”Š                    messages {\n+â”Š  â”Š70â”Š                      ...Message\n+â”Š  â”Š71â”Š                    }\n+â”Š  â”Š72â”Š                  }\n+â”Š  â”Š73â”Š                  participants {\n+â”Š  â”Š74â”Š                    ...User\n+â”Š  â”Š75â”Š                  }\n+â”Š  â”Š76â”Š                }\n+â”Š  â”Š77â”Š              }ðŸš«â†µ\n```\n\n[}]: #\n\nOnce everything is ready, let's add npm scripts, one for a normal traffic and a second with the much more users:\n\n[{]: <helper> (diffStep \"14.17\" module=\"server\")\n\n#### [__Server__ Step 14.17: Add loadtest scripts](https://github.com/Urigo/WhatsApp-Clone-Server/commit/81129e17ed5afd4daea5f1ad3c9d021bc06ae9d9)\n\n##### Changed package.json\n```diff\n@@ -14,7 +14,9 @@\n â”Š14â”Š14â”Š    \"build\": \"tsc\",\n â”Š15â”Š15â”Š    \"test\": \"TZ=\\\"Asia/Jerusalem\\\" jest --runInBand --forceExit\",\n â”Š16â”Š16â”Š    \"codegen\": \"gql-gen\",\n-â”Š17â”Š  â”Š    \"format\": \"prettier \\\"**/*.ts\\\" --write\"\n+â”Š  â”Š17â”Š    \"format\": \"prettier \\\"**/*.ts\\\" --write\",\n+â”Š  â”Š18â”Š    \"loadtest\": \"yarn artillery run artillery.yml > loadtest.log\",\n+â”Š  â”Š19â”Š    \"loadtest:limit\": \"yarn artillery run artillery-limit.yml > loadtest.log\"\n â”Š18â”Š20â”Š  },\n â”Š19â”Š21â”Š  \"jest-junit\": {\n â”Š20â”Š22â”Š    \"outputDirectory\": \"./test-results\"\n```\n\n[}]: #\n\nYou probably noticed that we stream the output to the `loadtest.log` file and that's just to read the results in a bit more pleasent way, than in the terminal.\n\nLetâ€™s start the server and run artillery:\n\n    $ yarn build && yarn start\n    $ yarn loadtest\n\nYouâ€™ll see a loading indicator, might take a while but when it completes, you should see something like this in `loadtest.log` file:\n\n```\nSummary report @ 15:00:58(+0200) 2019-05-30\n  Scenarios launched:  1506\n  Scenarios completed: 1506\n  Requests completed:  4518\n  RPS sent: 37.35\n  Request latency:\n    min: 3.5\n    max: 115.7\n    median: 18.6\n    p95: 54.4\n    p99: 66.2\n  Scenario counts:\n    Sign in, send a new message and fetch a list of chats: 1506 (100%)\n  Codes:\n    200: 4518\n```\n\nWe ran the scenario 1506 times, all were completed and the total number of requests was 4518.  The **RPS** means requests per second.\n\nThe metrics in **Request latency** are in milliseconds. We see what was the shortest request and so on. These **p95** and **p99** values mean that for 95% of virtual users, the latency was 54.4ms or lower, for 99% it was 66.2ms. All requests finished with 200 status code.\n\nYou might also automate that process and integrate Artillery CLI with CI/CI systems or even send metrics to external monitoring systems.\n\n### Apollo Engine\n\nLet's bring back the Apollo Engine once again. It will be helpful to analyze the load testing results.\n\nOn the **Metrics** page, you will see the following view:\n\n![Metrics](../../../assets/step17/img-13.png \"Metrics\")\n\nClick on the filter and set a custom date range to match the time you were load testing. Just to filter out other requests.\n\n![Filter](../../../assets/step17/img-14.png \"Filter\")\n\nBy default, Apollo Engine counts all operations, but you can pick the one youâ€™re interesting in. We donâ€™t do it and inspect them all.\n\n![List](../../../assets/step17/img-15.png \"List of operations\")\n\nOn the main part of the view, you should see â€œLast day overviewâ€ panel.\n\n![Overview](../../../assets/step17/img-16.png \"Last day overview\")\n\nAs you can see, all operations we ran are listed there and no error occurred.\n\n![Request Rate](../../../assets/step17/img-17.png \"Request Rate Over Time\")\n\nNext section shows the Requests Per Minute (rpm) metric over time. Itâ€™s useful to understand which operations are sent more often than others.\n\n![Request 1](../../../assets/step17/img-18.png \"Request Latency Over time\")\n![Request 2](../../../assets/step17/img-19.png \"Request Latency Distribution\")\n\nLast two panels are there to understand at what number of requests the latency increases and to show the correlation between them. We see a distribution of the processing time (the horizontal axis) and the number of operations. It also has p50, p75, p90 and p99 marks on it."
          }
        ]
      },
      {
        "releaseVersion": "0.2.0",
        "releaseDate": "2019-08-11 20:27:00 +0200",
        "tagName": "master@0.2.0",
        "tagRevision": "c956985a1f666c2c0bebd5fdf46e5d4278f46ba3",
        "historyRevision": "aa58403ac914a2484f3bdcd810f604ed1469ee7f",
        "changesDiff": "diff --git a/.tortilla/manuals/templates/root.tmpl b/.tortilla/manuals/templates/root.tmpl\nindex 4586208..557c1e4 100644\n--- a/.tortilla/manuals/templates/root.tmpl\n+++ b/.tortilla/manuals/templates/root.tmpl\n@@ -1,8 +1,12 @@\n ![whatsapp-clone](https://user-images.githubusercontent.com/7648874/54141944-9f801a80-4461-11e9-85a1-bcb161d9a6c6.png)\n\n+!(https://www.youtube.com/watch?v=omsHNP4Vjhc)\n+\n Whatsapp Clone is a free and open-source tutorial that will guide you step-by-step on how to create a full-stack,\n mobile, hybrid web application from scratch.\n\n+- [Skip to just clone the finished application](#cloning-the-finished-app)\n+\n The software world is evolving quickly, and oftentimes people find themselves left behind, even the most experienced ones.\n The purpose of this tutorial is not only to demonstrate how to create a full application with the latest technologies, but also\n to keep up to date with the ever-changing development ecosystem.\n@@ -55,6 +59,13 @@ You can track our progress and comment your suggestions, since everything is bas\n - [Road map](https://docs.google.com/document/d/1p2Zio6Js2eoFfHs9CjIMF6jTuNyD4eQEHlgEAKhAqM8/edit?usp=sharing)\n - [Chapter manuals] (https://drive.google.com/open?id=1ITxOniS_S3sgZfunLvtJ1L9P6Fj1YOLlFHhoQPjT3S0)\n\n+## Cloning the finished app\n+\n+If you want to simply clone and run the app locally in it's finished,\n+first clone the [Server repository](https://github.com/Urigo/WhatsApp-Clone-server) and follow the instructions on the README there.\n+\n+Then clone the [React Client repository](https://github.com/Urigo/WhatsApp-Clone-Client-React) and follow the instructions there carefully.\n+\n **Migration instructions included**\n\n There are many great tutorials out there, but almost none of them shows you what changes you should make in your app in order to be aligned with a new version of a certain technology.\n@@ -67,6 +78,10 @@ This way you can easily notice the changes in APIs and migrate your app in no ti\n\n **Prerequisites for WhatsApp Clone**\n\n+> Even if you don't have experience with the technologies below you might still be able to start the tutorial and pick things along the way.\n+> If you struggle with anything during the tutorial, contact us on the forum or on Github with your questions.\n+> It will help us make sure that the tutorial is good for beginners as well\n+\n - JavaScript - https://javascript.info/\n - TypeScript\n - JSX\n@@ -77,16 +92,13 @@ This way you can easily notice the changes in APIs and migrate your app in no ti\n - React\n - SQL\n\n-> Even if you don't have experience with the technologies above you might be able to start the tutorial and pick things along the way.\n-> If you struggle with anything, contact us on the forum or on Github with your questions.\n-\n OS operations such as navigating to a folder, or creating a folder, are all gonna be written in Bash, but the instructions are OS agnostic and can be applied on any machine that is web-compatible.\n\n Make sure you have the latest global dependencies on your computer before starting the tutorial:\n\n **[Node](https://nodejs.org/)**\n\n-Install [nvm](https://github.com/nvm-sh/nvm) by running the following command in your command line:\n+Install [nvm](https://github.com/nvm-sh/nvm) by running the following command in your [command line](https://www.wikihow.com/Get-to-the-Command-Line-on-a-Mac):\n\n     $ curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.34.0/install.sh | bash\n\n@@ -110,20 +122,32 @@ That is also useful in case you get stuck.\n\n Currently, Whatsapp Clone includes the following chapters:\n\n-- [Step 1: Creating a basic React APP with a basic view.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/final/.tortilla/manuals/views/step1.md)\n-- [Step 2: Styling with Material-UI and Styled-Components.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/final/.tortilla/manuals/views/step2.md)\n-- [Step 3: Setting a basic Node.JS server with basic a basic REST endpoint.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/final/.tortilla/manuals/views/step3.md)\n-- [Step 4: Transition to GraphQL.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/final/.tortilla/manuals/views/step4.md)\n-- [Step 5: Testing.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/final/.tortilla/manuals/views/step5.md)\n-- [Step 6: Creating an app router and implementing a chat room.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/final/.tortilla/manuals/views/step6.md)\n-- [Step 7: Caching with Apollo-Client.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/final/.tortilla/manuals/views/step7.md)\n-- [Step 8: Sending messages with GraphQL mutations.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/final/.tortilla/manuals/views/step8.md)\n-- [Step 9: Type safety with GraphQL Code Generator.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/final/.tortilla/manuals/views/step9.md)\n-- [Step 10: Live updates with GraphQL subscriptions.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/final/.tortilla/manuals/views/step10.md)\n-- [Step 11: Users.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/final/.tortilla/manuals/views/step11.md)\n-- [Step 12: Adding and removing chats.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/final/.tortilla/manuals/views/step12.md)\n-- [Step 13: Authentication.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/final/.tortilla/manuals/views/step13.md)\n-- Step 14: Your choice! Submit a request [here](https://github.com/Urigo/WhatsApp-Clone-Client-React/issues)\n+- [Step 1: Creating a basic React APP with a basic view.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step1.md)\n+- [Step 2: Styling with Material-UI and Styled-Components.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step2.md)\n+- [Step 3: Setting a basic Node.JS server with basic a basic REST endpoint.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step3.md)\n+- [Step 4: Transition to GraphQL.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step4.md)\n+- [Step 5: Testing.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step5.md)\n+- [Step 6: Creating an app router and implementing a chat room.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step6.md)\n+- [Step 7: Caching with Apollo-Client.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step7.md)\n+- [Step 8: Sending messages with GraphQL mutations.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step8.md)\n+- [Step 9: Type safety with GraphQL Code Generator.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step9.md)\n+- [Step 10: Live updates with GraphQL subscriptions.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step10.md)\n+- [Step 11: Users.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step11.md)\n+- [Step 12: Adding and removing chats.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step12.md)\n+- [Step 13: Authentication.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step13.md)\n+- [Step 14: Migrating to PostgreSQL.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step14.md)\n+- [Step 15: Using a REST API.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step15.md)\n+- [Step 16: Modularity.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step16.md)\n+- [Step 17: Performance.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step17.md)\n+- Step 18: Your choice! Submit a request [here](https://github.com/Urigo/WhatsApp-Clone-Client-React/issues)\n\n Whatsapp Clone is updated on a regular basis, so you should expect more steps and extensions with time.\n You can keep track of our [road map](https://docs.google.com/document/d/1p2Zio6Js2eoFfHs9CjIMF6jTuNyD4eQEHlgEAKhAqM8/edit?usp=sharing) to see whatâ€™s upcoming.\n+\n+### External contributors\n+\n+* [jsparvath](https://github.com/jsparvath)\n+* [Akirtovskis](https://github.com/Akirtovskis)\n+* [MStokluska](https://github.com/MStokluska)\n+* [milenazuccarelli](https://github.com/milenazuccarelli)\n+* [itsmylife](https://github.com/itsmylife)\ndiff --git a/.tortilla/manuals/templates/step1.tmpl b/.tortilla/manuals/templates/step1.tmpl\nindex 380cc0d..79f48c4 100644\n--- a/.tortilla/manuals/templates/step1.tmpl\n+++ b/.tortilla/manuals/templates/step1.tmpl\n@@ -22,6 +22,8 @@ It will create a directory called `whatsapp-clone-client` inside the current fol\n Inside that directory, it will generate the initial project structure and install the needed dependencies.\n No configuration or complicated folder structures, just the files you need to build your app.\n\n+### Review the generated code\n+\n > In our project, we're gonna use [TypeScript](https://www.typescriptlang.org/) (indicated by the `--typescript` command).\n > The main advantage of using TypeScript over using plain JavaScript is that if we want, we get to tell the compiler what types and data structures we expect in certain places,\n > so that the compiler (which unlike a human never forgets) will remind us when we make a mistake and assume something that is not true.\n@@ -35,7 +37,7 @@ Inside the newly created project, you can run some built-in commands:\n\n \t$ yarn start\n\n-Runs the app in development mode. Open `http://localhost:3000` to view it in the browser:\n+Runs the app in development mode. Open `[http://localhost:3000](http://localhost:3000)` to view it in the browser:\n\n ![boilerplate-page](https://user-images.githubusercontent.com/7648874/54026782-025f8080-41da-11e9-9a4e-796fe15e8d03.png)\n\n@@ -46,6 +48,8 @@ Let's look at what create-react-app has created for us in order to understand ev\n First thing, let's look at what webpage is being served to the browser.\n That webpage in `index.html` that sits under the `public` folder.\n\n+{{{ diffStep \"root\" module=\"client\" files=\"public/index.html\" }}}\n+\n As you can see, this file is a regular HTML file. You will want to edit it's `<title>` to name our real app:\n\n {{{ diffStep \"1.1\" module=\"client\" files=\"public/index.html\" }}}\n@@ -65,7 +69,10 @@ Now the HTML file has in it's <body> tag just one `<div id=\"root\"></div>` tag wh\n So how do we get the nice React logo that is being rendered onto our screen?\n\n `create-react-app` has scripts that will run the `src/index.tsx` file together with our HTML template, so let's look what this file is doing.\n-The important thing to see here is the `React` is calling it's render method and telling it to render the `App` component into a document where `id` equals `root`.\n+\n+{{{ diffStep \"root\" module=\"client\" files=\"public/index.html\" }}}\n+\n+The important thing to see here is that `React` is calling it's render method and telling it to render the `App` component into a document where `id` equals `root`.\n\n So now you know where React is coming into our html template.\n\n@@ -83,10 +90,15 @@ Getting React, it is simply calling it by name instead of a path. That means tha\n\n Under dependencies you can see all the libraries our app currently depends on.\n\n+{{{ diffStep \"root\" module=\"client\" files=\"package.json\" }}}\n+\n You can also see other values in there like `scripts`, which will teach `yarn` new commands that we can use.\n The right side will name the command and the left would be the actual command that it will run.\n\n-Another file that got created is `tsconfig.json`.\n+Another file that got created is `tsconfig.json`:\n+\n+{{{ diffStep \"root\" module=\"client\" files=\"tsconfig.json\" }}}\n+\n That file specifies options for the Typescript compiler when it takes our code and transforms it from Typescript into Javascript.\n\n Some noticeable configuration options for that file are:\n@@ -98,7 +110,9 @@ If you know that your app would run only on newer browsers or a Node environment\n\n For the full set of options, check out the [official docs](https://www.typescriptlang.org/docs/handbook/compiler-options.html);\n\n-Now, let's look at our App's code in `src/App.tsx`.\n+Now, let's look at our App's code in `src/App.tsx`:\n+\n+{{{ diffStep \"root\" module=\"client\" files=\"App.tsx\" }}}\n\n We can see that our app is just a function named `App`.\n\n@@ -119,21 +133,23 @@ something will import our component.\n\n The last thing we haven't explained is the following part: `App: React.FC`.\n Those are Typescript typings. Everything after `:` describes the types of the `App` variable and has no affect on the behavior and execution of the app.\n-It will tell Typescript what `App` is suppose to look so that in case we make a mistake Typescript will warn us before we get the app running.\n+It will tell Typescript how `App` is supposed to look like, so that in case we make a mistake, Typescript will warn us before we get the app running.\n\n So what are the types of React.FC?  You can check it out inside by using command+click on it's name.\n You see that it accepts `P` as props into the component and needs to return `React.Element` or `null`.\n\n-Let's test this out, add a Typescript interface named `AppProps` and put that it includes a property called `name` of type string.\n+Let's test out how typescript typings work: Declare a Typescript interface named `AppProps` that includes a property called `name` of type string. Now use that interface to describe the shape that app's props should have: update the line that declares app to `const App: React.FC<AppProps> = ({name}) => {`\n+\n+Now open the file `src/index.tsx`.\n+You can see that our editor is calling out that there is an error in our code because no name prop is passed to the App component.\n\n-Now let's try to return something invalid. `\"some string\"`, or `1+1`.\n-You can see that our editor is calling out that there are errors in our code.\n+You will encounter those errors a lot as you develop.\n+Always read the errors all the way. Take your time to understand each sentence there because that will save you a lot of time.\n+That is true also when you are not programming and just encounter errors in the apps you are using...\n\n-You will encounter those error a lot as you develop.\n-Always read the errors all the way. Understand each sentence there because that will save you a lot of time.\n+As the error message suggests, give the App component a name prop. If you pass a prop that is not a string like `true` or `1+1`, TypeScript will let you know with an error.\n\n-Ok we now know the component doesn't get anything into itself so let's make sure the typings reflect that as well.\n-The default for React.FC is that there are no props passed inside so if we'll bring that back but keep sending the `name` value from `index.tsx` in the code, you should now get an error.\n+The default for React.FC is that there are no props passed inside so if we'll bring that back but keep sending the `name` value from `index.tsx` in the code, you should now get an error because you are passing a props that the component doesn't accept.\n\n Those errors can be very useful when your app grows.\n Make sure to define types on the component itself like we have done now. It would make it easier to identify the issues.\n@@ -145,7 +161,7 @@ Later on we'll learn better strategies of sorting our styles and making\n sure they are not touching components that we don't want them to affect.\n\n Next file - `App.test.tsx`.\n-This file contains automatic tests to make sure our app is doing what it's suppose to do.\n+This file contains automatic tests to make sure our app is doing what it's supposed to do.\n\n We are programmers, that means that many times our job is to take something manual and making it automatic.\n That's why we should also strive to automate things we do ourselves.\n@@ -169,7 +185,7 @@ you can see the `^` sign.  That means that every time someone will get this code\n We don't want that. We want to first be notified when a new version is out and we want to explicitly update it.\n\n That's why we need to add 2 things into our code:\n-First, to delete all `^`.\n+First, to delete all `^` (while also let's update all dependencies to their current latest).\n\n {{{ diffStep \"1.2\" module=\"client\" files=\"package.json\" }}}\n\n@@ -196,6 +212,26 @@ Here is a nice guide to start: https://try.github.io/.\n You can check out the `.gitignore` file create-react-app has set up for us in the root folder.\n That file will tell `.git` what not to save and not to upload.\n\n+## Code formatting\n+\n+Some developers write code in a different style than others and it might be annoying while doing code reviews or even merging conflicts. That's why we want to make it consistent. We're going to use **Prettier** which has an opinionated set of styling rules and supports many languages. Your IDE most likely supports it too.\n+\n+    $ yarn add prettier\n+\n+We're going to define a npm script called `format`, few styling rules and we're also going to ignore *node_modules*:\n+\n+{{{ diffStep \"1.3\" module=\"client\" files=\"package.json, .prettierrc.yml, .prettierignore\" }}}\n+\n+Now let's run:\n+\n+    $ yarn format\n+\n+Prettier should format your code:\n+\n+{{{ diffStep \"1.3\" module=\"client\" files=\"src/App.tsx\" }}}\n+\n+> Remember to run `yarn prettier` before you comit your changes!\n+\n **End of intro**\n\n Assuming that everything is set, we will now create our first screen - `ChatsListScreen`.\n@@ -216,11 +252,11 @@ First let's remove the current React code and add our own code into it.\n\n For now, let's create fake data on our HTML.\n\n-Add this data will be changed and we are not going to manually add HTML tags every time there is a new message, let's move our data into a JSON structure.\n+As this data will be changed and we are not going to manually add HTML tags every time there is a new message, let's move our data into a JSON structure.\n For now it would be a structure we will manually create.\n-That way we can make our React component already behave like our final version.\n+That way we can already make our React component behave like our final version.\n\n-{{{ diffStep \"1.3\" module=\"client\" files=\"App.tsx\" }}}\n+{{{ diffStep \"1.4\" module=\"client\" files=\"App.tsx\" }}}\n\n If all we do in the function is just returning a value, instead of `const App: React.FC = () => { return () };` we can also do `const App: React.FC = () => ();`\n So let's use that for our ChatsList component.\n@@ -233,15 +269,15 @@ As we don't use those styles and logos anymore, we can delete the `src/App.css`\n\n Now let's move ChatsList into it's own component:\n\n-{{{ diffStep \"1.4\" module=\"client\" files=\"ChatsList.tsx\" }}}\n+{{{ diffStep \"1.5\" module=\"client\" files=\"ChatsList.tsx\" }}}\n\n and let's import that component into the App component and use the shorter syntax for the functional component:\n\n-{{{ diffStep \"1.4\" module=\"client\" files=\"App.tsx\" }}}\n+{{{ diffStep \"1.5\" module=\"client\" files=\"App.tsx\" }}}\n\n and let's do the same for our Navbar:\n\n-{{{ diffStep \"1.5\" module=\"client\" }}}\n+{{{ diffStep \"1.6\" module=\"client\" }}}\n\n React apps tend to store React.Components under a directory located at `src/components`, and so we're gonna follow this pattern.\n We will create a directory called ChatsListScreen in the `components` dir where we're simply gonna import and put together the Navbar and ChatsList components.\n@@ -254,7 +290,7 @@ This is how the contents of that directory should look like:\n\n We will use the `index.tsx` file to define that component, this way we can import it using the directory name:\n\n-{{{ diffStep \"1.6\" module=\"client\" }}}\n+{{{ diffStep \"1.7\" module=\"client\" }}}\n\n Now, we have our app rendering our view, but it is completely static and manual in the code.\n\n@@ -265,18 +301,18 @@ So let's create a file that lists just the data of our chats and then make our R\n\n We will create the file in a JSON format:\n\n-{{{ diffStep \"1.7\" module=\"client\" files=\"db.ts\" }}}\n+{{{ diffStep \"1.8\" module=\"client\" files=\"db.ts\" }}}\n\n We are giving IDs for the values just like a database gives a unique id for each value.\n\n-The is so we can reference specific values, for example,\n+This is so we can reference specific values, for example,\n last message would actually reference the other array instead of duplicating the values.\n\n Now let's change ChatsList component to import the data from that file.\n Then to use the Javascript [map](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/map)\n function to render a line for each data entry:\n\n-{{{ diffStep \"1.7\" module=\"client\" files=\"ChatsList.tsx\" }}}\n+{{{ diffStep \"1.8\" module=\"client\" files=\"ChatsList.tsx\" }}}\n\n When running `map` on the `chats` array, it will run a function for each entry in the array and return a value.\n The function will receive the current entry as a parameter.\n@@ -289,9 +325,9 @@ If you'll remove that and render again you will see the following error inside t\n By telling React how to identify and distinguish each element using the `key` value we help solve that problem and also making React faster.\n Read [here](https://reactjs.org/docs/lists-and-keys.html) for more in depth explanation.\n\n-Now that we rendered a line for each chat, let's add also the last message's content and creation date for each chat:\n+Now that we've rendered a line for each chat, let's add also the last message's content and creation date for each chat:\n\n-{{{ diffStep \"1.8\" module=\"client\" }}}\n+{{{ diffStep \"1.9\" module=\"client\" }}}\n\n Try to run the app again.\n\n@@ -300,7 +336,7 @@ This is because Typescript is smart enough and tells us there might be no last m\n So we add a check.\n Remember to always check for null or undefined if optional, donâ€™t write shorter write safer:\n\n-{{{ diffStep \"1.9\" module=\"client\" }}}\n+{{{ diffStep \"1.10\" module=\"client\" }}}\n\n Now let's try again.\n\n@@ -308,7 +344,7 @@ Now we have a syntax error - A JSX return value can't have more then a single ro\n So in order to return a root element from the function but still display multiple elements in the same level,\n we can use [React.Fragment](https://reactjs.org/docs/fragments.html) to wrap the returned elements:\n\n-{{{ diffStep \"1.10\" module=\"client\" }}}\n+{{{ diffStep \"1.11\" module=\"client\" }}}\n\n\n Let's try again.  This time it looks like the format is not correct, so let's format the date using the `moment` library.\n@@ -323,7 +359,7 @@ To install:\n\n And now let's import the library by it's name, wrap the value of each chat and call the `format` function with our requested format:\n\n-{{{ diffStep \"1.11\" module=\"client\" files=\"ChatsList.tsx\" }}}\n+{{{ diffStep \"1.12\" module=\"client\" files=\"ChatsList.tsx\" }}}\n\n\n If you'll try to run the app you'll see that everything is there, but it's not hard to notice that it's missing some style:\ndiff --git a/.tortilla/manuals/templates/step10.tmpl b/.tortilla/manuals/templates/step10.tmpl\nindex 6486d3b..40b085b 100644\n--- a/.tortilla/manuals/templates/step10.tmpl\n+++ b/.tortilla/manuals/templates/step10.tmpl\n@@ -92,11 +92,17 @@ The WS url can be composed by simply running a regular expression over the `REAC\n\n Our subscription listeners should live globally across our application and shouldn't be bound to a specific component, thus we will create an external service which will be responsible of doing so. Using that service, we will update our GraphQL data-store any time a new message has been added. We will define a `messageAdded` subscription in a dedicated file under the `src/graphql/subscriptions` dir where all our subscriptions will be defined and exported:\n\n-TODO: - but they are anyway. Itâ€™s just a standalone function that is used in a component. Which makes no difference.\n+[comment]: # (but they are anyway. Itâ€™s just a standalone function that is used in a component. Which makes no difference.)\n\n {{{ diffStep 10.2 module=\"client\" }}}\n\n-Now we will create the service under the path `services/cache.service.ts`. Like any other GraphQL operation, `react-apollo-hooks` provides us with a dedicated React hook for subscriptions called `useSubscription`. Given the subscription document and the `onSubscriptionData` callback we can handle incoming changes. We will be using GraphQL Code Generator to generate typed subscription hooks, as the `typescript-react-apollo` plug-in supports it right out of the box. First let's update the `codegen.yml` file to look for documents in the `graphql/subscriptions` dir:\n+Now we will create the service under the path `services/cache.service.ts`.\n+Like any other GraphQL operation, `@apollo/react-hooks` provides us with a dedicated React hook for subscriptions called `useSubscription`.\n+\n+Given the subscription document and the `onSubscriptionData` callback we can handle incoming changes.\n+We will be using GraphQL Code Generator to generate typed subscription hooks, as the `typescript-react-apollo` plug-in supports it right out of the box.\n+\n+First let's update the `codegen.yml` file to look for documents in the `graphql/subscriptions` dir:\n\n {{{ diffStep 10.3 module=\"client\" }}}\n\ndiff --git a/.tortilla/manuals/templates/step11.tmpl b/.tortilla/manuals/templates/step11.tmpl\nindex 6c58875..a4d11d5 100644\n--- a/.tortilla/manuals/templates/step11.tmpl\n+++ b/.tortilla/manuals/templates/step11.tmpl\n@@ -33,12 +33,23 @@ Now we will update the resolvers to fetch data relatively to the current user lo\n\n {{{ diffStep 8.2 module=\"server\" files=\"schema, tests\" }}}\n\n-Now if we will get back to the app and refresh the page, we should see a new chats list which is only relevant to Ray Edwards. Earlier in this chapter, we've defined a new `isMine` field on the `Message` type. This field is useful because now we can differentiate between messages that are mine and messages that belong to the recipient. We can use that information to distinct between messages in our UI.\n+Now if we will get back to the app and refresh the page, we should see a new chats list which is only relevant to Ray Edwards.\n+Earlier in this chapter, we've defined a new `isMine` field on the `Message` type.\n+This field is useful because now we can differentiate between messages that are mine and messages that belong to the recipient.\n+We can use that information to distinct between messages in our UI.\n+\n+But we should also take into account the current user when we publish real-time subscription events.\n+\n+We will check if there is a logged in user and if the users is part of the actual conversation before we publish:\n+\n+{{{ diffStep 8.3 module=\"server\" }}}\n\n Let's first download a new image that will help us achieve the new style and save it under the [`src/public/assets/message-yours.png`](https://github.com/Urigo/WhatsApp-Clone-Client-React/blob/cordova/public/assets/message-other.png?raw=true) path. Then let's implement the new style:\n\n {{{ diffStep 11.1 module=\"client\" files=\"src/components\" }}}\n\n+{{{ diffStep 11.1 module=\"client\" files=\"message.fragment.ts\" }}}\n+\n This is how the updated `ChatRoomScreen` should look like:\n\n\n@@ -126,12 +137,11 @@ We will use this function to wrap the right components in our appâ€™s router. No\n\n Assuming that youâ€™re not logged-in, if youâ€™ll try to force navigate to the `/chats` route you should be automatically redirected to the `/sign-in` form. We will finish the chapter here as we wanna keep things simple and gradual. Itâ€™s true that we havenâ€™t implemented true authentication, but that would be addressed soon further in this tutorial.\n\n----------\n-\n-TODO: minor change, which might be helpful for people in long term. Thatâ€™s a small but powerful thing to know about in TypeScript\n-+ recipient: chat.participants.find(p => p !== currentUser.id)!\n-- recipient: chat.participants.find(p => p !== currentUser.id) as string\n-\n+{{#noop}}\n+  TODO: minor change, which might be helpful for people in long term. Thatâ€™s a small but powerful thing to know about in TypeScript\n+  + recipient: chat.participants.find(p => p !== currentUser.id)!\n+  - recipient: chat.participants.find(p => p !== currentUser.id) as string\n\n-TODO: I donâ€™t think we need `if (props.history.location.pathname === '/sign-in') return null`\n-since withAuth HOC is not used on `AuthScreen` component\n\\ No newline at end of file\n+  TODO: I donâ€™t think we need `if (props.history.location.pathname === '/sign-in') return null`\n+  since withAuth HOC is not used on `AuthScreen` component\n+{{/noop}}\ndiff --git a/.tortilla/manuals/templates/step12.tmpl b/.tortilla/manuals/templates/step12.tmpl\nindex aaf2562..a05c46b 100644\n--- a/.tortilla/manuals/templates/step12.tmpl\n+++ b/.tortilla/manuals/templates/step12.tmpl\n@@ -78,7 +78,10 @@ And we will update the `cache.service` to listen to the new subscription and upd\n\n {{{ diffStep 12.5 module=\"client\" files=\"cache.service\" }}}\n\n-We will also update the `ChatRoomScreen` to redirect us to the `/chats` route if the chat was not found. The render method of the component will be re-triggered automatically by `react-apollo-hooks` if the cached result of `useGetChat()` hook has changed, which means that even if you didnâ€™t actively remove the chat, you will still be redirected as a result:\n+We will also update the `ChatRoomScreen` to redirect us to the `/chats` route if the chat was not found.\n+\n+The render method of the component will be re-triggered automatically by `@apollo/react-hooks` if the cached result of `useGetChat()` hook has changed,\n+which means that even if you didnâ€™t actively remove the chat, you will still be redirected as a result:\n\n {{{ diffStep 12.5 module=\"client\" files=\"ChatRoom\" }}}\n\ndiff --git a/.tortilla/manuals/templates/step13.tmpl b/.tortilla/manuals/templates/step13.tmpl\nindex 803b11c..f853cde 100644\n--- a/.tortilla/manuals/templates/step13.tmpl\n+++ b/.tortilla/manuals/templates/step13.tmpl\n@@ -35,7 +35,7 @@ We will first start with the `signIn` mutation, so we can test it against pre-de\n\n And we will implement the `signIn` mutation:\n\n-{{{ diffStep 10.2 module=\"server\" files=\"schema\" }}}\n+{{{ diffStep 10.2 module=\"server\" }}}\n\n As you can see we use a special secret before we encrypt the username with JWT. The same secret will be used later on to decrypt the token back into username when getting requests. If someone malicious will get a hold of that password, he can fabricate an authentication token for every user that he wants, **thus itâ€™s important to choose a strong secret**.\n\n@@ -61,15 +61,23 @@ mutation signIn(username: 'ray', password: '111') {\n\n Now if we would look at the value of `document.cookie` we should see a key named `authToken` with a JWT token and the `ChatsListScreen` should show the chats which are relevant to `ray`. To complete the sign-in flow we would need to update the `AuthScreen` and the `auth.service` to use username and password and the actual `sign-in` mutation weâ€™ve just implemented.\n\n-To check if weâ€™re authorized to visit a route, not only we would need to check if we have the `authToken` cookie defined, but we would also need to validate it against the server to see that it actually references a real user. For that we will implement `Query.me` which will send us back the current user logged in directly from the context:\n+Now back to the `auth.service`, we will replace the `signIn()` method implementation with one that actually calls the `signIn` mutation in our API. We will start by defining the mutation:\n\n-{{{ diffStep 10.5 module=\"server\" }}}\n+{{{ diffStep 13.2 module=\"client\" files=\"graphql/mutations\" }}}\n+\n+Updating `codegen.yml` to include the file we've just added in the generation process:\n\n-Now back to the `auth.service`, we will replace the `signIn()` method implementation with one that actually calls the `signIn` mutation in our API:\n+{{{ diffStep 13.2 module=\"client\" files=\"codegen.yml\" }}}\n\n-{{{ diffStep 13.2 module=\"client\" }}}\n+And finally, we will update the service to use the generated mutation method `useSignInMutation()`:\n\n-And we will use the GraphQL query weâ€™ve just implemented to check if the user actually exists within the DB before we proceed to the restricted route:\n+{{{ diffStep 13.2 module=\"client\" files=\"auth.service.ts\" }}}\n+\n+To check if weâ€™re authorized to visit a route, not only we would need to check if we have the `authToken` cookie defined, but we would also need to validate it against the server to see that it actually references a real user. For that we will implement `Query.me` which will send us back the current user logged in directly from the context:\n+\n+{{{ diffStep 10.5 module=\"server\" }}}\n+\n+Now will use the GraphQL query weâ€™ve just implemented to check if the user actually exists within the DB before we proceed to the restricted route:\n\n {{{ diffStep 13.3 module=\"client\" }}}\n\n@@ -109,10 +117,10 @@ And then we will make the necessary changes in the `AuthScreen`:\n\n The authentication flow is complete! To test it out, you can create a new user, log in with it and start chatting with other users.\n\n-------------\n-\n-TODO: maybe use HttpOnly in cookie\n-save userâ€™s id or data in localStorage so we can guess if a user is logged in or not and later on invalidate it\n-we send a password in its raw form over the wire\n-Error message: â€œreq.password and req.passwordConfirm don't matchâ€ looks odd, should be â€œPasswords donâ€™t matchâ€\n-Why is `const maySignUp = useCallback(() => {` a useCallback and not useMemo for example? We do use a value there.\n+{{#noop}}\n+  TODO: maybe use HttpOnly in cookie\n+  save userâ€™s id or data in localStorage so we can guess if a user is logged in or not and later on invalidate it\n+  we send a password in its raw form over the wire\n+  Error message: â€œreq.password and req.passwordConfirm don't matchâ€ looks odd, should be â€œPasswords donâ€™t matchâ€\n+  Why is `const maySignUp = useCallback(() => {` a useCallback and not useMemo for example? We do use a value there.\n+{{/noop}}\ndiff --git a/.tortilla/manuals/templates/step14.tmpl b/.tortilla/manuals/templates/step14.tmpl\nindex 8541c20..78f85f0 100644\n--- a/.tortilla/manuals/templates/step14.tmpl\n+++ b/.tortilla/manuals/templates/step14.tmpl\n@@ -42,29 +42,41 @@ You can read more about those relations in [here](https://www.techrepublic.com/a\n In existing entity declarations and schema, we have 6 relationships;\n\n * Message has a One To Many relationship under the name of `chat` inside our schema; so one message can have one chat while one chat can have multiple messages.\n-    gql```\n-    type Message { chat: Chat }\n-    ```\n+\n+```gql\n+type Message { chat: Chat }\n+```\n+\n * Message has another One To Many relationship under the name of `sender`` inside our schema; so one message can have one sender while one sender user can have multiple messages.\n-    gql```\n-    type Message { sender: User }\n-    ```\n+\n+```gql\n+type Message { sender: User }\n+```\n+\n * Message has one more One To Many relationship under the name of `recipient`` inside our schema; so one message can have one recipient while one recipient user can have multiple messages.\n-    gql```\n-    type Message { recipient: User }\n-    ```\n+\n+```gql\n+type Message { recipient: User }\n+```\n+\n * Chat has a One To Many relationship under the name of `messages`, because one chat can have multiple messages while one message can have only one chat. Notice that this relationship is the reversed version of the first relationship in Message.\n-    gql```\n-    `type Chat { messages: [Message] }\n-    ```\n+\n+```gql\n+`type Chat { messages: [Message] }\n+```\n+\n * Chat has another Many To Many relationship under the name of `participants`, because one chat can have multiple participants while a participant can have multiple chats as well.\n-    gql```\n-    type Chat { participants: [User] }\n-    ```\n+\n+```gql\n+type Chat { participants: [User] }\n+```\n+\n * User has a Many To Many relationship under the name of `chats`, because one user can have multiple chats, while it has the same situation for chats.\n-    gql```\n-    type User { chats: [Chat] }\n-    ```\n+\n+```gql\n+type User { chats: [Chat] }\n+```\n+\n\n So we should decide the dependencies between each other to add columns and tables to our database.\n\n@@ -140,6 +152,17 @@ If you have Debian package manager on your machine, you can install PostgreSQL i\n\n Check [https://www.postgresql.org/download/](PostgreSQL website) for installation instructions on other environments.\n\n+Following above link, after initializing the database using:\n+```\n+postgresql-setup initdb\n+```\n+Navigate to /var/lib/pgsql/11/data/pg_hba.conf and edit IPv4 local connections to:\n+```\n+# IPv4 local connections:\n+host    all             all             127.0.0.1/32            trust\n+```\n+By doing so you are setting PostgreSQL permissions so your WhatsApp server can access the database.\n+\n **Creating Database, Database User and Tables**\n\n > Make sure you have installed PostgreSQL on your environment first!\n@@ -283,7 +306,7 @@ We should update our entity typings according to our new database tables and col\n\n We need to update the `resetDb` function to add a sample data to our new relational database instead of in-memory database. But we will call `resetDb` if it is asked by using the environmental variable.\n\n-{{{diffStep 11.5 module=\"server\" files=\"db\"}}}\n+{{{diffStep 11.5 module=\"server\" }}}\n\n > When you update tables with your own ID values, you have to update `SEQUENCE`; because PostgreSQL calculates the next ID value using `SEQUENCE`s.\n\n@@ -314,6 +337,13 @@ We should update tests to use SQL instead of in-memory database.\n\n {{{diffStep 11.8 module=\"server\" files=\"test\"}}}\n\n+> Because we are running tests against a database, we need to first make sure they run serially, one after the other,\n+> using Jest's `runInBand` option.\n+> Also, because during the test we will access a resource (DB) that will keep living, we need to tell Jest to close itself\n+> after the test is done, using the `forceExit` option\n+\n+{{{diffStep 11.8 module=\"server\" files=\"package.json\"}}}\n+\n **Remove in-memory database**\n\n We can remove all the stuff related to in-memory database now.\ndiff --git a/.tortilla/manuals/templates/step15.tmpl b/.tortilla/manuals/templates/step15.tmpl\nindex 7ab1c4a..48266ef 100644\n--- a/.tortilla/manuals/templates/step15.tmpl\n+++ b/.tortilla/manuals/templates/step15.tmpl\n@@ -23,11 +23,11 @@ Copy the response, create a new file called types/unsplash.ts in your vscode edi\n\n Now we can finally implement the REST API call in our picture resolver:\n\n-{{{ diffStep \"12.1\" module=\"client\" files=\"schema/resolvers.ts\" }}}\n+{{{ diffStep \"12.1\" module=\"server\" files=\"schema/resolvers.ts\" }}}\n\n In order to test it, we have to remove the picture from one of the users and re-run the server with the `RESET_DB=true` environment variable:\n\n-{{{ diffStep \"12.1\" module=\"client\" files=\"db.ts\" }}}\n+{{{ diffStep \"12.1\" module=\"server\" files=\"db.ts\" }}}\n\n\n ## Track the API\n@@ -40,7 +40,7 @@ First letâ€™s install the safe-api middleware:\n\n Then letâ€™s use it inside our resolver:\n\n-{{{ diffStep \"12.2\" module=\"client\" files=\"schema/resolvers.ts\" }}}\n+{{{ diffStep \"12.2\" module=\"server\" files=\"schema/resolvers.ts\" }}}\n\n Now launch the client in order to retrieve the picture field multiple times.\n\n@@ -48,7 +48,7 @@ If you look inside the logs directory you will notice that it generated some gra\n\n Now we need to remove `types/unsplash.ts` and generate some Typescript typings out of the schema. Do do so we can use the graphql-code-generator:\n\n-{{{ diffStep \"12.3\" module=\"client\" files=\".gitignore, codegen.yml\" }}}\n+{{{ diffStep \"12.3\" module=\"server\" files=\".gitignore, codegen.yml\" }}}\n\n     yarn codegen\n\n@@ -60,20 +60,20 @@ Weâ€™re not done yet, there is still room for improvement. Instead of using axio\n     yarn remove axios @types/axios\n     yarn add apollo-datasource-rest\n\n-{{{ diffStep \"12.4\" module=\"client\" files=\"schema/unsplash.api.ts\" }}}\n+{{{ diffStep \"12.4\" module=\"server\" files=\"schema/unsplash.api.ts\" }}}\n\n We created the UnsplashApi class, which extends RESTDataSource. In the constructor you need to set the baseUrl (after calling super() to run the constructor of the base class). You also need to create a willSendRequest method to set the authentication headers for each call. Then itâ€™s simply a matter of creating a getRandomPhoto method to perform the actual REST API call. Instead of calling axios you will have to call the get method of the class (which in turn gets inherited from its RESTDataSource base class): the API is very similar to the axios one.\n\n In order to access the data source from the resolvers we need to tell Apollo to put them on the context for every request. We shouldnâ€™t use the context field, because that would lead to circular dependencies. Instead we need to use the dataSources field:\n\n-{{{ diffStep \"12.4\" module=\"client\" files=\"index.ts\" }}}\n+{{{ diffStep \"12.4\" module=\"server\" files=\"index.ts\" }}}\n\n Now we need to update the typings for our context and run the graphq-code-generator again:\n\n-{{{ diffStep \"12.4\" module=\"client\" files=\"context.ts\" }}}\n+{{{ diffStep \"12.4\" module=\"server\" files=\"context.ts\" }}}\n\n     yarn codegen\n\n Now it should be pretty easy to modify our resolver in order to use our just created datasource:\n\n-{{{ diffStep \"12.4\" module=\"client\" files=\"schema/resolvers.ts\" }}}\n+{{{ diffStep \"12.4\" module=\"server\" files=\"schema/resolvers.ts\" }}}\ndiff --git a/.tortilla/manuals/templates/step16.tmpl b/.tortilla/manuals/templates/step16.tmpl\nnew file mode 100644\nindex 0000000..a9913c6\n--- /dev/null\n+++ b/.tortilla/manuals/templates/step16.tmpl\n@@ -0,0 +1,374 @@\n+This chapter is focused entirely on how to organize a GraphQL API. By far, our project's schema looks simple and keeping SDL and resolvers in two files is really enough.\n+\n+## Issues we face when GraphQL API grows\n+\n+Usually, every app starts small and the difficulty of maintenance grows while features are being implemented. I believe that you should always start small and see how a project involves. You could look up many articles about best practices of organising a project but they bring no benefit when your project is small. You don't want to jump between files in order to find what you're looking for, it should be intuitive. I agree a proper folder structure helps but if your schema has 100 lines of code then it makes no sense to split it into 5 files with 20 LOC each. The schema is so small that it won't hurt you when you hit the wall and separation will be necessary but until it happens you can easily move on with the project.\n+\n+Bigger project means more people, more people means teams. In the current state of the app, they might interrupt each other and that eventually affects productivity.\n+Lack of separation makes the schema harder to maintain, especially once it grows rapidly.\n+\n+## That's why modularity is a thing!\n+\n+In order to improve and solve those issues we would have to split an API into many pieces.\n+Those might be files, even folders, doesn't really matter because the goal is to keep relevant chunks of code in one place, conceptually called module.\n+\n+If done right, one team won't disturb another and it also helps to understand an entire codebase just by looking at those modules or even learn a feature because everything related to it is within a single module.\n+\n+There's also a very important aspect, reusability. Most APIs have something in common, the first thing that comes to mind is authentication and user mechanism in general.\n+When working with modules, it gets easier to share those.\n+\n+## Many ways to organize an API\n+\n+GraphQL specification explains just the language and how to form an API. Managing codebase, that's on our side.\n+\n+Since we're talking about modularity, let's see possible implementations.\n+\n+The first thing on mind are files and folders. Putting relevant logic in a file won't scale well once we add more things, like business logic for example. Which means we need folders, that's for sure.\n+\n+Okay, so the next question, how to store SDL and resolvers. Do we want to have them stored together or keep them separated?\n+\n+I'm a big fan of the former because in schema-first approach the SDL is written first and you see exactly how to construct resolvers. The latter would require to jump between files or have them opened side-by-side.\n+Another benefit shows up when you add, remove or just change part of a schema, less likely that you'll miss something.\n+\n+But as always, there are things you can't do with that approach.\n+One that pops into my head right away is an IDE supportâ€¦ ?\n+< guys, any ideas? >\n+\n+Let's talk about modularity in terms of SDL.\n+We know how to define types in GraphQL but what if a type is a sum of many features?\n+There two ways to do it. One is to use the `extend` keyword, another to define a type multiple type. Both gave the same effect, all is merged into one type after all.\n+\n+But there are few major differences.\n+\n+The `extend` keyword is obviously a part of the specification so IDEs and most tools support it. It feels more natural than the second option.\n+\n+Defining the same type multiple times is the opposite. It might feel odd, not many IDEs and\n+tools support it so you have to add a library that handles it but on the other way you don't care if there's already a type or not, you just make sure there's one with proper fields, no matter what. It might also warn you when fields overlap.\n+\n+## Modularized schema\n+\n+There are couple solutions to help you modularize the schema and we will look at 3 of them.\n+\n+First, let's start by defining 3 modules:\n+\n+- common - things we want to share with all the rest\n+- users - everything related to users\n+- chats - core logic of WhatsApp\n+\n+### Using directories\n+\n+The simplest and most obvious solution would be to split what we have and move that into directories.\n+\n+Starting with common module. We need to create a folder at `/modules/common` and a `index.ts` file in it:\n+\n+{{{ diffStep \"13.1\" module=\"server\" files=\"modules/common/index.ts\" }}}\n+\n+You can see a pattern here, two things are being exported, one with type definitions and the other with resolvers. Why those `_dummy` fields? We want to use `extend` keyword, that require a base type and GraphQL doesn't accept empty objects.\n+\n+Now, let's do the same but with Users module:\n+\n+{{{ diffStep \"13.1\" module=\"server\" files=\"modules/users/index.ts\" }}}\n+\n+And Chats module:\n+\n+{{{ diffStep \"13.1\" module=\"server\" files=\"modules/chats/index.ts\" }}}\n+\n+Seems like modules are ready but we still need to create a Schema out of them.\n+\n+{{{ diffStep \"13.1\" module=\"server\" files=\"schema/index.ts\" }}}\n+\n+Because we moved everything from `resolvers.ts` and `typeDefs.graphql` files, those can now be removed.\n+\n+The last thing we need to adjust is the GraphQL Code Generator's config, in `codegen.yml`:\n+\n+{{{ diffStep \"13.1\" module=\"server\" files=\"codegen.yml\" }}}\n+\n+We no longer keep all type definitions in one place and all documents are wrapped with `gql` tag, the codegen is smart enough to find those.\n+\n+### Using Apollo Modules\n+\n+An alternative to the previous solution and far more interesting is a module feature of Apollo Server.\n+\n+Let's see how it all might look like when using Apollo Server's modules:\n+\n+{{{ diffStep \"13.2\" module=\"server\" files=\"index.ts\" }}}\n+\n+The `modules` of ApolloServer accepts an array of objects with `resolvers` and `typeDefs` properties. That's exactly what we exported and that's why we can use esmodules directly.\n+\n+Because we no longer use `schema.ts`, let's remove it.\n+\n+If you would run the server right now, you will see a lot of warnings about missing index signatures. It's definitely nothing to worry about and can be easily fixed by using `useIndexSignature` flag of codegen:\n+\n+{{{ diffStep \"13.2\" module=\"server\" files=\"codegen.yml\" }}}\n+\n+You might ask how is that different from what we have already implemented. The code is a bit simpler because the merging part is done by Apollo Server. We get some helpful messages when type's definition is missing but one of the modules was extending it and also when there are duplicates. Apollo Modules are very straightforward and basic but maybe that's all you really need in a project.\n+\n+### Using GraphQL Modules\n+\n+There's an another alternative option that forces good patterns and providess a nice to work with API. It's called GraphQL Modules.\n+The main goal is to help organize an API and allow to develop it across multiple teams.\n+\n+yarn add @graphql-modules/core\n+\n+Same as Apollo Server's modules, has useful warnings and messages but you can use it with any implementation of GraphQL server.\n+\n+```ts\n+import { GraphQLModule } from â€˜@graphql-modules/core';\n+\n+export default = new GraphQLModule({\n+  name: 'common',\n+  typeDefs,\n+  resolvers\n+});\n+```\n+\n+It's a bit similar to what we have in Apollo Modules but as you probably noticed, it's wrapped within `GraphQLModule` class. The class manages a business logic, SDL, resolvers and dependencies between modules.\n+\n+> An important thing to be aware of, GraphQL Modules encapsulates every module. To get a better understanding, think of it as CSS Modules.\n+\n+Now that you know some basics, let's implement the simplest of all modules:\n+\n+{{{ diffStep \"13.3\" module=\"server\" files=\"modules/common/index.ts\" }}}\n+\n+As we mentioned, there's no global context so we moved the common parts into Common module.\n+\n+Let's take care of other two modules and migrate `modules/users/index.ts` first:\n+\n+{{{ diffStep \"13.3\" module=\"server\" files=\"modules/users/index.ts\" }}}\n+\n+Just like with Common, we also moved related context but there's a totally new thing called `imports`. In order to let Users module see Common's contents (types, resolvers, context etc) we need to include it in the dependencies.\n+\n+Now `Chats` that depends on `Users` and `Common` modules:\n+\n+{{{ diffStep \"13.3\" module=\"server\" files=\"modules/chats/index.ts\" }}}\n+\n+Since every module is now a GraphQL Module, we can take care of how to use them in the ApolloServer.\n+\n+To make things easier, we're going to create a module that's called `Root` and represents our API.\n+\n+```ts\n+export const rootModule = new GraphQLModule({\n+  name: 'root',\n+  imports: [usersModule, chatsModule],\n+});\n+```\n+\n+We want to pass `schema` and `context` to ApolloServer:\n+\n+```ts\n+const server = new ApolloServer({\n+  schema: rootModule.schema,\n+  context: rootModule.context,\n+  // ...\n+```\n+\n+Now with all that knowledge, take a look at all changes at once:\n+\n+{{{ diffStep \"13.3\" module=\"server\" files=\"index.ts\" }}}\n+\n+#### Migrate Unsplash API to Chats\n+\n+We still make use of global context which won't work with GraphQL Modules. To be more specific, it's not the context definition itself but the thing that's being added by ApolloServer, Data Sources.\n+\n+The `RESTDataSource` is of course more than a class but in case of Unsplash API we won't loose any important features except the HTTP client. We're going to use `axios` instead:\n+\n+yarn add axios\n+\n+We've got everything now so let's migrate UnsplashAPI class and move it from `schema/unsplash.api.ts` under `modules/chats`!\n+\n+{{{ diffStep \"13.3\" module=\"server\" files=\"modules/chats/unsplash.api.ts\" }}}\n+\n+There is no big differences between now and what we had before, the only thing that's changed is the way we make http requests.\n+\n+The `UnsplashAPI` can be now removed from `dataSources` and moved under Chats module's context:\n+\n+{{{ diffStep \"13.3\" module=\"server\" files=\"index.ts\" }}}\n+\n+{{{ diffStep \"13.3\" module=\"server\" files=\"context.ts\" }}}\n+\n+{{{ diffStep \"13.3\" module=\"server\" files=\"modules/chats/index.ts\" }}}\n+\n+#### Dependency Injection in GraphQL Modules\n+\n+The major feature of GraphQL Modules is the Dependency Injection. It's optional, you don't have to use it until it's really necessary. Even though WhatsApp clone doesn't need it yet, we're going to talk about DI and implement a simple thing, just for educational purpose.\n+\n+If you're familiar with Dependency Injection then you will get it straight away. If not, please read about it here or here (**links**).\n+\n+To start working with DI, we we need to install two packages:\n+\n+yarn add @graphql-modules/di reflect-metadata\n+\n+Let's now adjust the context type and import `reflect-metadata` into the project:\n+\n+{{{ diffStep \"13.5\" module=\"server\" files=\"context.ts\" }}}\n+\n+{{{ diffStep \"13.5\" module=\"server\" files=\"index.ts\" }}}\n+\n+In short, Iependency Injection will instantiate classes, manage dependencies between them and so on and in addition to that, the GraphQL Modules allows to define when each provider / class should be created. We call it scopes.\n+\n+- Application scope - provider is created when application starts (default)\n+- Session - providers are constructed in the beginning of the network request, then kept until the network request is closed\n+- Request - creates an instance each time you request it from the injector\n+\n+Because our `UnsplashApi` doesn't have to be recreated on every request, we can easily use Application scope, which is the default. The `Injectable` decorator is just to attach some metadata to the class.\n+\n+{{{ diffStep \"13.5\" module=\"server\" files=\"modules/chats/unsplash.api.ts\" }}}\n+\n+Here's how to register the UnsplashApi provider in Chats module:\n+\n+{{{ diffStep \"13.5\" module=\"server\" files=\"modules/chats/index.ts\" }}}\n+\n+Please also take a look at `injector.get(UnsplashApi)` part. There's `injector` instance in every module's context that allows to consume providers and everything that is defined within DI. You simply pass a class / token to the `get` method and GraphQL Modules takes care of the rest.\n+\n+**What are the benefits of DI?**\n+\n+You can have a different implementation of Users based on the same interface. Maybe right now you're using PostgreSQL but at some point a project will be migrated to MongoDB. You could do it through GraphQL context, of course but with Dependency Injection, GraphQL Modules is able to tell you exactly what's missing and where. It reduces boiler plate because instantiation is done by the injector, code is loosely coupled.\n+\n+Helps maintainability but also comes with few disadvantages. It's a bit complex concept to learn and what could be done on compile time (TypeScript) is moved to run-time.\n+\n+You might find DI useful while testing. Let's say you want to test a query that involves `UnsplashApi` provider, you simply replace it with a mocked version without touching the context or internals and you get the expected result every single time.\n+\n+We know there's only one provider by far, the `UnsplashApi`, but we're going to implement more and more in following steps.\n+\n+#### Continuing with DI\n+\n+We want to have everything easily accesible and DI helps with that so let's move on and continue migrating things.\n+\n+One of the shared objects is database connection and we're going to create a Database provider:\n+\n+{{{ diffStep \"13.6\" module=\"server\" files=\"modules/common/database.provider.ts\" }}}\n+\n+Things we did there:\n+- Session scope was used, which makes sure our provider is created and destroyed on every GraphQL Operation\n+- `onRequest` hook is called when a GraphQL Operation starts and we create a database connection in it.\n+- `onResponse` hook is triggered when GraphQL Response is about to be sent to the consumer, so we destroy the connection there.\n+- `getClient` method exposes the connection\n+- `Pool` in constructor means we expect `Pool` to be injected into `Database` provider.\n+\n+Now we can define `Pool` token and register `Database`:\n+\n+{{{ diffStep \"13.6\" module=\"server\" files=\"modules/common/index.ts\" }}}\n+\n+{{{ diffStep \"13.6\" module=\"server\" files=\"modules/index.ts\" }}}\n+\n+#### Creating Users and Chats services\n+\n+It's not really recommended to put logic in resolvers so we're going to create a layer with business logic. A good example of that are Users and Chats modules so let's start with the former.\n+\n+We're going to create `Users` service and move `Query.users` logic into `findAllExcept` method:\n+\n+{{{ diffStep \"13.7\" module=\"server\" files=\"modules/users/users.provider.ts,modules/users/index.ts\" }}}\n+\n+A very interesting thing to notice is `@Inject()` decorator.\n+\n+```ts\n+@Inject() private db: Database;\n+```\n+\n+The @Inject, well... injects `Database` provider as `db` property so you don't have to use the `constructor`.\n+\n+Back to the Users service. It's very similar to what we did with the `UnsplashApi` so let's move on and implement more methods.\n+\n+{{{ diffStep \"13.8\" module=\"server\" }}}\n+{{{ diffStep \"13.9\" module=\"server\" }}}\n+\n+Let's now implement `Chats` service with two basic methods:\n+\n+{{{ diffStep \"13.10\" module=\"server\" }}}\n+\n+It looks exatly like `Users` and also has only `database` provider in it.\n+\n+We're going to move on and more things:\n+\n+{{{ diffStep \"13.11\" module=\"server\" }}}\n+{{{ diffStep \"13.12\" module=\"server\" }}}\n+{{{ diffStep \"13.13\" module=\"server\" }}}\n+{{{ diffStep \"13.14\" module=\"server\" }}}\n+{{{ diffStep \"13.15\" module=\"server\" }}}\n+\n+#### Sharing PubSub\n+\n+One of things that are still in the context is `PubSub`. Because we're moving an entire business logic into a separate layer and as part of GraphQL Module's providers we need to make sure that PubSub is accessible throug DI.\n+\n+Let's register the PubSub and migrate resolvers:\n+\n+{{{ diffStep \"13.16\" module=\"server\" }}}\n+\n+Now, we're going to use `PubSub` within `Chats` service:\n+\n+{{{ diffStep \"13.17\" module=\"server\" }}}\n+{{{ diffStep \"13.18\" module=\"server\" }}}\n+{{{ diffStep \"13.19\" module=\"server\" }}}\n+\n+#### Implementing Auth service\n+\n+The last missing piece of our \"context migration\" journey is `currentUser` object. We're going to define the `Auth` service.\n+\n+{{{ diffStep \"13.20\" module=\"server\" files=\"modules/users/auth.provider.ts\" }}}\n+\n+It still needs to be registered and few resolvers in Users module have to be migrated:\n+\n+{{{ diffStep \"13.20\" module=\"server\" files=\"modules/users/index.ts, context.ts\" }}}\n+\n+Now let's use the Auth service in Chats:\n+\n+{{{ diffStep \"13.20\" module=\"server\" files=\"modules/chats/index.ts\" }}}\n+\n+Because we no longer need `db` instance in the context, let's remove it:\n+\n+{{{ diffStep \"13.21\" module=\"server\" }}}\n+\n+Besides the `currentUser` method we're going to have two more, one to sign in and the other to sign up:\n+\n+{{{ diffStep \"13.22\" module=\"server\" }}}\n+{{{ diffStep \"13.23\" module=\"server\" }}}\n+\n+#### Exposing server instance\n+\n+If you would run `yarn test` right now, you will see a lot of errors, every test will fail. That's because we changed our setup but we didn't adjusted tests.\n+\n+We're going to change the setup of tests as well so whenever we do something on server it won't affect them. Instead of exposing schema and context as we did before, we're going to base the tests on a ready to use ApolloServer instance.\n+\n+In order to achieve it, we need to separate ApolloServer from other server related logic.\n+\n+{{{ diffStep \"13.24\" module=\"server\" }}}\n+{{{ diffStep \"13.25\" module=\"server\" }}}\n+\n+There's one thing that changed and might break our tests, this line fix it:\n+\n+{{{ diffStep \"13.26\" module=\"server\" }}}\n+\n+Remember when I said about benefits of Dependency Injection? Here's one of them. We create a function that overwrites the `currentUser` method so it always returns a specific user.\n+\n+{{{ diffStep \"13.27\" module=\"server\" }}}\n+\n+Let's now migrate all tests and see how easier it is now to manage those. Because we use ApolloServer's instance, we don't need to understand how it's implemented.\n+\n+{{{ diffStep \"13.28\" module=\"server\" }}}\n+\n+## Adjusting client\n+\n+We still need to update `codegen.yml` in the client app because of the changes we introduced in this chapter:\n+\n+{{{ diffStep \"14.1\" module=\"client\" }}}\n+\n+## Many ways to write GraphQL\n+\n+Weâ€™re going to discuss what are the possible options of building GraphQL API and why schema-first approach was our choice.\n+\n+The main ingredient of a GraphQL API is, of course the schema. Itâ€™s built out of type definitions where each of them describes a piece of data, connections between them and how data is actually resolved.\n+\n+The way we develop all of it changes the way we work with the API.\n+\n+We could define two main approaches:\n+  - schema-first\n+  - resolver-first\n+\n+The former means design comes before code, the latter vice-versa.\n+\n+In schema-first development you start with SDL, resolvers and code go next. Schema is sort of a contract between teams and also between frontend and backend. With schema-first approach itâ€™s easier to cooperate, discuss and write a better API. Because the SDL is written upfront, the frontend developers can use a mocked version of it and start working on the product while the backend team does the API, in parallel.\n+There are of course some pain points. Once schema is splitted into SDL and resolvers itâ€™s hard to keep them in sync and thatâ€™s why things like GraphQL Code Generator were developed, to add type safety on top of all.\n+\n+The resolver-first approach is a bit different. The schema is defined programmatically, which usually means itâ€™s more flexible and combined with TypeScript or Flow gives you type-safety out of the box.\n+\n+We think itâ€™s less readable than having a SDL and thereâ€™s a lack of separation between schema and code which might be a blocker for some teams.\ndiff --git a/.tortilla/manuals/templates/step17.tmpl b/.tortilla/manuals/templates/step17.tmpl\nnew file mode 100644\nindex 0000000..a0e2c2e\n--- /dev/null\n+++ b/.tortilla/manuals/templates/step17.tmpl\n@@ -0,0 +1,655 @@\n+In this part of the tutorial we're going to do a bit different work than in previous chapters. We'll analyze the code instead of writing it, including both the API and the web application.\n+\n+## API Performance\n+\n+First, let's start with the GraphQL API.\n+\n+### Finding bottlenecks\n+\n+In order to implement fixes and do improvements we need to understand which part of the API needs help. There's still not many tools around GraphQL in terms of analytics and inspection but there's one highly useful, it's called **Apollo Engine**.\n+\n+Since we're going to use it, you need to register an account at [engine.apollographql.com](https://engine.apollographql.com/) and create a service. Please then follow [the \"How to configure an Apollo project\" instructions](https://www.apollographql.com/docs/platform/schema-registry/#using-the-schema-registry).\n+\n+Once you're ready, please start the server and run this command:\n+\n+    $ apollo service:push\n+\n+To collect the data, let's play with the client app for some time. After that, go to Engine's website.\n+\n+Here's one of graphs with timing of an operation. We can understand when each resolver takes place and how much time it consumes. Some resolvers happen in parallel.\n+The `< 1ms` says it was a very simple computation or an element resolved immediately.\n+\n+We find it very useful to understand how operation behaves.\n+\n+![Resolvers](../../../assets/step17/img-01.png \"Resolvers\")\n+\n+Let's go through an entire query to find fields fetched multiple times. The most obvious field is `isMine`. We see it's computed twice for almost 4 and 5 milliseconds.\n+In order to find out what does it mean, we need to look at the code. The resolver gets the currently logged in user from the `Auth` service and its `currentUser`. Each time the method is invoked, a query to PostgreSQL is made. We ask for that data multiple times, once in `lastMessage` and also in every message from the list.\n+\n+We could deduplicate the SQL queries! In order to do that the most obvious library that pops to my mind is Dataloader.\n+\n+Let's install the package and discuss it afterwards:\n+\n+    npm install dataloader\n+\n+The Dataloader is a library created and maintained by Facebook. It's main purpose is to turn equivalent requests into a single execution. Sounds like a perfect solution, right? It actually is.\n+\n+A short explaination of how Dataloader works.\n+\n+```ts\n+async function fetchUser(id: number): Promise<User> {\n+  // Resolves asynchronously, after less than 1s.\n+  return db.users.findOne(id);\n+}\n+\n+async function fetchUsers(ids: number[]): Promise<User[]> {\n+  const users = ids.map(id => fetchUser(id));\n+  return Promise.all(users);\n+}\n+\n+const loader = new Dataloader(keys => fetchUsers(keys));\n+\n+async function main() {\n+  const user1 = await loader.load(1);\n+  const user2 = await loader.load(2);\n+\n+  // Later on user #1 is fetched again.\n+  // It resolves immediately.\n+  const member1 = await loader.load(1);\n+}\n+```\n+\n+Think of the Dataloader as a class that has a `Map` object in it, its keys are of course unique and each value is a `Promise`.\n+Every time you ask for something, Dataloader looks for it in the `Map`. When there's already something, the `Promise` is returned but if there's none the provided function is invoked and a new `Promise` is created. This way equivalent requests share the same `Promise`.\n+\n+> It's important to know that the `Map` object grows until the DataLoader is released, that's why it's recommended to keep `Dataloader` in GraphQL's context.\n+\n+Let's implement `Dataloader` in our `Database` service:\n+\n+{{{ diffStep \"14.1\" module=\"server\" files=\"modules/common/database.provider.ts\" }}}\n+\n+The key is created based on SQL statement and its values and we also turned off batching because it's important to execute SQL operations sequentially.\n+There's also a new method called `query`, to execute SQL statements through Dataloader. It also reduces a boilerplate of asking for db client and executing a query every time we do SQL in resolvers and providers.\n+\n+Now we need to apply that change in all providers:\n+\n+{{{ diffStep \"14.1\" module=\"server\" files=\"modules/users/users.provider.ts, modules/chats/chats.provider.ts\" }}}\n+\n+Deduplication is done but the `currentUser` method does more than just that. It verifies the auth token extracted from a request's cookie. This could be avoided by an assignment to a private prop and a simple if statement.\n+\n+{{{ diffStep \"14.2\" module=\"server\" }}}\n+\n+![Resolvers](../../../assets/step17/img-02.png \"Resolvers\")\n+\n+As you can see at the graph above, we reduced an execution time of `isMine` field from 4ms and 5ms to less than 1. That applies for all calls, all messages so it scales well and won't grow as list of messages increases.\n+\n+But there's more... We see `chat` field being computed over and over again. So again, let's repeat the same steps.\n+The `Message.chat` resolver asks `Chats` service and its `findChatById` method which makes a SQL call.\n+\n+The deduplication logic, we introduced in the previous step, helps to immediately resolve all `Message.chat` fields except the first occurrence but there's still a space for improvements.\n+\n+The `Query.chats` resolver is invoked before the `Message.chat` which means at this point, we already have knowledge about the chats.\n+\n+Let's implement a caching logic for chats so we could reuse them. We will do it in few steps.\n+\n+First, because we're going to use `Dataloader`, `Chats` class should have private and public API.\n+\n+{{{ diffStep \"14.3\" module=\"server\" }}}\n+\n+The private method is responsible for quering data from the database but the public one is to allow communication between the service and its consumers.\n+It's also there so we could switch to using Dataloader later on.\n+\n+We did that to `findChatsByUser` but there are more:\n+\n+{{{ diffStep \"14.4\" module=\"server\" }}}\n+{{{ diffStep \"14.5\" module=\"server\" }}}\n+\n+> Because those private methods are just to query data, make sure they all return untouched `row` object.\n+\n+Now's the most interesting part, Dataloader.\n+\n+{{{ diffStep \"14.6\" module=\"server\" }}}\n+\n+We introduced `ChatsKey` that is a union type, to standarize the input value. Those helper methods like `isChatsByUser` and `isChatByUser` are there to decide what should be fetched.\n+\n+In every public method that we previously changed, there's now Dataloader in use but that's not entirely what we're trying to achieve.\n+\n+The caching mechanism is not yet completed. We deduplicate requests but in some cases, we ask for chats that are already there, so we need to intercept our dataloader logic and introduce caching.\n+\n+{{{ diffStep \"14.7\" module=\"server\" }}}\n+\n+Whenever we ask for a single chat that is available, it's being resolved right away but we still need to write data to the cache.\n+\n+{{{ diffStep \"14.8\" module=\"server\" }}}\n+\n+Let's look at charts in Apollo Engine.\n+\n+![Resolvers](../../../assets/step17/img-03.png \"Resolvers\")\n+\n+We cut off `Message.chat` to less than 1ms.\n+\n+The `Chat.name` and `Chat.picture` resolvers share the same logic and since Database service is wrapped with DataLoader, we make a single SQL query. Unfortunately, it's not visible on the graph.\n+\n+Let's summarize our work. **We made the GetChat operation almost 60% faster on average** and it's just based on one chat with one message. The number would be much much higher on a bigger scale.\n+\n+### Preventing issues\n+\n+The Apollo Engine has another interesting feature. Itâ€™s called Alerts. You set a threshold for all operations or a specific one and whenever it takes longer, you get a notification on Slack. But thereâ€™s a catch, you need to pay in order to unlock it.\n+\n+Weâ€™re working on something similar but entirely open-sourced. Itâ€™s an extension of ApolloServer that lets you track operations and get exactly what you would get from the engine but self-hosted.\n+\n+## UI Performance\n+\n+The part would be the User Interface and the web app in general.\n+\n+### Metrics\n+\n+There's a highly recommended and very comprehensive publication written by Philip Walton (Engineer at Google) called [\"User-centric Performance Metrics\"](https://developers.google.com/web/fundamentals/performance/user-centric-performance-metrics) that was an inspiration for this chapter. Weâ€™re going to talk in short about measuring render performance of a web application.\n+\n+Letâ€™s base this chapter on real data. First, open the app and go to Performance tab of Chrome DevTools.\n+\n+![Record](../../../assets/step17/img-04.png \"Record\")\n+\n+Now click on â€œStart profiling and reload pageâ€. After itâ€™s done you should see the following:\n+\n+![All panels](../../../assets/step17/img-05.png \"All panels\")\n+\n+Right now it may not make a lot of sense, so weâ€™re going to start with something basic.\n+\n+Thereâ€™s many different kinds of charts but we will cover only few of them: Network, Frames, Timings and Main.\n+\n+Letâ€™s check out the Timings section and explain few important performance metrics.\n+\n+- DCL - DOMContentLoaded Event\n+- L - Onload Event\n+- FP - First Paint\n+- FCP - First Contentful Paint\n+- FMP - First Meaningful Paint\n+\n+Thereâ€™s also another one that is not visible on the timeline but also not less important, TTI - Time to Interactive.\n+\n+We will focus on FP, FCP, FMP and TTI.\n+\n+The primary difference between the two metrics is **First Paint** marks the point when the browser renders anything that is visually different from what was on the screen prior to navigation. By contrast, **First Contentful Paint** is the point when the browser renders the first bit of content from the DOM, which may be text, an image, SVG, or even a `<canvas>` element.\n+\n+The **First Meaningful Paint** should mark the point when something useful was rendered. It might mean an input box on Google, video player on YouTube or in our case, a list of chats.\n+\n+The **Time To Interactive** metric marks the point at which the application is both visually rendered and capable of reliably responding to user input.\n+\n+Now with all that knowledge we can move on to something more practical, the **Frames panel**. The main purpose here is to see whatâ€™s rendered at given time. In our case, the first paint was made after over 200ms, which is not a bad result at all but see that huge blank space next to it.\n+\n+The **Network section**, is going to help us out here and give some pointers of what might be a reason of it. Itâ€™s a timeline that explains when each request was made and how long it took to resolve.\n+\n+![Network section](../../../assets/step17/img-06.png \"Network section\")\n+\n+What do we see here? One of the first requests are js files and we need those to bootstrap and render the app. Thatâ€™s the reason of the blank page.\n+\n+We could improve that by either Server-Side Rendering or using a Service Worker.\n+\n+### Rendering improvements\n+\n+#### Server-Side Rendering\n+\n+Implementing SSR means you run the app on server, before itâ€™s being shipped to the client and the documentâ€™s content is not just `<html><body><app></app></body></html>` but an actual markup with all the components in it. Because itâ€™s a part of the document, the browser can already display something meaningful and after js files are loaded, the app bootstraps on the client and it becomes interactive. There is one caveat. Wherever you ship the app it has to be able to run node js.\n+\n+#### Store Rehydration\n+\n+When talking SSR itâ€™s worth to mention GraphQL and related technique called Store Rehydration. API calls are an important part of an application and plays a huge role in SSR.\n+\n+GraphQL operations are called once components are mounted which means the cache is filled up and why not reuse it on client.\n+\n+How would it work? Data is extracted from the apolloâ€™s cache and passed within a document. After itâ€™s received by the browser, the app runs and so does the Apollo Client. While it happens we look for the data and fill up the cache. Now whenever a component calls a GraphQL operation, the result is already in the cache and resolves immediately.\n+\n+#### Service Worker\n+\n+Another approach is a bit different. By using a Service Worker, weâ€™re able to control and cache requests, including js files, images etc. On the first visit, the app loads exactly the same as without SSR but the next visits are a bit faster. Itâ€™s because the Service Worker is registered after you close the app and of course we canâ€™t cache things that werenâ€™t fetched yet.\n+\n+Both techniques are not mutually exclusive and we highly recommend to use both.\n+\n+![Main section](../../../assets/step17/img-07.png \"Main section\")\n+\n+The next section weâ€™re going to talk about is the **Main panel**, a flame chart of activity on the main thread. You see those blocks? They represent an event, the wider it is the longer it took. One of the most important things to remember is to avoid long events since they block the thread.\n+The longest event on our timeline is the Evaluate Script event that involves `main.js`. The file contains all the libraries and the core functionality, those are needed to run the app. By making it lighter we would decrease the time of the first render.\n+We already do something to reduce the bundle size, This technique we use is called code-splitting and it allows to split one piece of code into multiple files which are lazy loaded.\n+It cuts off the size of the main bundle and the rest is loaded on demand, letâ€™s say login page is in a different chunk than list of chats.\n+\n+### Tooling\n+\n+Thereâ€™s one tool built into Chrome DevTools called Lighthouse that allows to measure, collect metrics and get helpful tips on how to improve the performance and where are the pain points.\n+\n+Hereâ€™s the example:\n+\n+![Lighthouse results](../../../assets/step17/img-08.png \"Lighthouse results\")\n+\n+Once your app is optimized you want to prevent regressions. Lighthouse has you covered! It may run as part of Continuous Integration and prevents deployment when key metrics regress or drop below a certain threshold.\n+\n+## Making the app feels instant\n+\n+Dealing with slow network can be hard so let's simulate that situation. After all, running the application on local host will always result in low response times.\n+\n+Luckily most browser come with a built in solution for that - we can simulate a slow network by defining the throttle level:\n+\n+![Throttling](../../../assets/step17/img-09.png \"Throttling\")\n+\n+If we will refresh the application, we should notice a significant slow down the first time we load each screen; about few seconds to load each of them. To ensure that this is really caused by a slow network and not by anything else, we can open the dev-tools of our browser (letâ€™s assume you use Chrome) and under the `network` tab we should notice the network activity times.\n+\n+> More information about monitoring network activity and throttling it using the Chromeâ€™s dev-tools can be found in [the official dev-tools docs page](https://developers.google.com/web/tools/chrome-devtools/network/).\n+\n+To solve these issues there are a couple of changes weâ€™re gonna make in the way we fetch and manage data.\n+\n+### Optimistic UI\n+\n+As you know, pretty much in all cases, everything in Apollo flows through its cache. If a requested data is in there, a query is resolved right away. Mutations are a bit different, they have to reach the server every single time. Seems like nothing we can do about it but fortunately we can simulate the mutation, predict the result and make Apollo treat it as a temporary data. Which means, the appâ€™s state and all components are updated and the change is visible instantly after itâ€™s made.\n+\n+In case of the WhatsApp clone, whenever a new message is sent, we will see it right away, on the screen, doesnâ€™t matter if the network is low or even super fast. You may experience the similar behavior on Facebookâ€™s Messenger.\n+\n+\n+```graphql\n+  mutation AddMessage($chatId: ID!, $content: String!) {\n+    addMessage(chatId: $chatId, content: $content) {\n+      ...Message\n+    }\n+  }\n+```\n+\n+```graphql\n+  addMessage({\n+    variables: { chatId, content },\n+    optimisticResponse: {\n+      __typename: 'Mutation',\n+      addMessage: {\n+        __typename: 'Message',\n+        id: Math.random().toString(36).substr(2, 9),\n+        createdAt: new Date(),\n+        isMine: true,\n+        chat: {\n+          __typename: 'Chat',\n+          id: chatId,\n+        },\n+        content,\n+      }\n+    },\n+    update: (client, { data: { addMessage } }) => {\n+      writeMessage(client, addMessage);\n+    },\n+  })\n+```\n+\n+We used words â€œpredictâ€ and â€œsimulateâ€, what if the mutation behaves differently or whatâ€™s more interesting, it fails. Apollo handles that as well. The â€œrealâ€ response overwrites the fake one and the store is reverted back to the original state.\n+\n+### Prefetching data\n+\n+Another technique but with a bit different purpose is about fetching data in advance. In some situations, you might be able to predict which page/component is going to be entered next.\n+\n+Letâ€™s base it on a real example. The WhatsApp clone has a page with a list of chats. The component that represents the page, calls a GraphQL operation to fetch that list. Right now, when user clicks on one of the chats, heâ€™s redirected to a partially empty page because of the ongoing GraphQL request. What if we could fetch that data in advance? Thatâ€™s what this technique is about. We could predict userâ€™s next move based on a simple mouse event or even by using Artificial Intelligence and data collected by Google Analytics, so whenever the move actually happens, the data is already in the cache.\n+\n+{{{ diffStep \"15.1\" module=\"client\" files=\"src/components/ChatRoomScreen/index.tsx\" }}}\n+\n+We created the `useGetChatPrefetch` hook that gets ApolloClient instance through `useApolloClient` and returns a function to prefetch data. In this case we request `GetChat` operation. Because Apollo deduplicates queries, we won't make multiple http calls, we're safe.\n+\n+The actual usage of `useGetChatPrefetch`, happens on `mouse entered` event:\n+\n+{{{ diffStep \"15.1\" module=\"client\" files=\"src/components/ChatsListScreen/ChatsList.tsx\" }}}\n+\n+Now, the same but with the list of users:\n+\n+{{{ diffStep \"15.1\" module=\"client\" files=\"src/components/ChatsListScreen/AddChatButton.tsx\" }}}\n+{{{ diffStep \"15.1\" module=\"client\" files=\"src/components/ChatsListScreen/ChatsList.tsx\" }}}\n+\n+### Splitting and Deferring Queries\n+\n+Prefetching is an easy way to make your applications UI feel faster. You can use mouse events to predict the data that could be needed. This is powerful and works perfectly on the browser, but can not be applied to a mobile device.\n+\n+One solution for improving the UI experience would be the usage of fragments to preload more data in a query, but loading huge amounts of data (that you probably never show to the user) is expensive.\n+\n+Another solution would be to **split huge queries into two smaller queries**:\n+\n+- The first one could load data which is already in the store. This means that it can be displayed instantly.\n+- The second query could load data which is not in the store yet and must be fetched from the server first.\n+\n+This solution gives you the benefit of not fetching too much data, as well as the possibility to show some part of the views data before the server responds.\n+\n+This could be used in our messaging app to load chatâ€™s information and messages separately. This way we will see the title and the image instantly, because itâ€™s already in the cache but messages will be loaded afterwards. UX will benefit a lot.\n+\n+Thereâ€™s also something very similar conceptually to Query Splitting but instead of separating queries we keep everything in one operation and annotate the parts that should be deferred. The annotation is, of course a directive and itâ€™s called **`@defer`**.\n+\n+Once the `@defer` is used, the server returns an initial response without waiting for deferred fields to resolve, using null as placeholders for them. Then, it streams patches for each deferred field asynchronously as they resolve. Thanks to that, we maintain one operation but decide how it behaves.\n+\n+> Right now, this feature is not well supported in Apollo Server so we donâ€™t recommend to use it yet. Keep it on mind though.\n+\n+### Dealing with rendering issues\n+\n+The most naive thing we can do to start noticing performance issues would be loading TONS of data to our app, and make sure that each view is absolutely overwhelmed with information. This way performance issues will start rising above the surface pretty quickly. To do that, we will edit the `resetDb()` method on the server so it can generate large quantities of data. The most comfortable way of controlling that behavior would be through an environment variable that will tell the reset method how much iterations it should run. The more iterations, the more data would be fabricated:\n+\n+{{{ diffStep \"15.10\" module=\"server\" }}}\n+\n+Itâ€™s important to note that weâ€™ve generated the data in a very specific way where a single user will be the center of the network of data. This way when we log in with that user, we should see our views packed. If it wasnâ€™t for that we would have just had large quantities of data in the DB, but none of it would appear to the end-user.\n+\n+Now, we will restart the server and this time run it differently. We will provide `FAKED_DB` with a value of `100` which should connect us to 100 messages per single view:\n+\n+    RESET_DB=true FAKED_DB=100 yarn start\n+\n+Now make sure that the application is running and log-in with the first user of Ray Edwards using the credentials:\n+\n+    username: ray\n+    passowrd: 111\n+\n+Now try to navigate around between the `ChatsScreen` and `ChatBoxScreen`. Youâ€™ll notice that each transition takes a long time until it shows the data. Itâ€™s obviously something which is related to rendering and not data transportation, because the slowdown also happens the second time you visit a view, a point where the fetched data should have already been stored by Apollo in cache. So weâ€™ve already detected one performance issue we should deal with.\n+\n+### Pagination\n+\n+To solve it, there are couple of changes weâ€™re gonna make in the way we ask for data, messages will be fetched dynamically based on our scrolling position.\n+\n+With these changes, the requests will be splitted into smaller chunks, and React DOM wonâ€™t have to deal with a lot of data the first time it loads. There are few challenges that may arise from this implementation:\n+\n+- Representing queries in a way that they can be loaded in chunks\n+- Sending requests and updating the view dynamically\n+- Maintaining updates from subscriptions\n+\n+To start with, we will first take on the task of improving initialization times. We will release the pressure by fetching only the first 20 messages. This way when we visit a chat, it should be loaded faster.\n+\n+For that we're going to implement cursor-based pagination. We will add `after` and `limit` arguments to `Chat.messages` that could be used to fetch a specific snapshot of available messages.\n+\n+- `after` is optional and marks the point where the last fetch ended (what is the last element of a received list)\n+- `limit` is required, defines amount of data\n+\n+A common design pattern for fetching data snapshots from a GraphQL back-end is called [Relay](https://facebook.github.io/relay/docs/en/graphql-server-specification.html). Relay provides a robust solution which is suitable for things like search engines.\n+\n+We will define our own version of it.\n+\n+{{{ diffStep \"14.9\" module=\"server\" }}}\n+\n+The `MessagesResult` is built of:\n+\n+- `cursor` - marks the end of a fetched list\n+- `hasMore` - tells if there's more data to ask for\n+- `message` - has the same type as `Chat.messages` previously had\n+\n+Because the cursor marks the edge of received data, it has to be something we could use while sorting. The most obvious choice is the date of creation, so `created_at` column of `messages` table.\n+\n+It's stored as `YYYY-MM-DD HH:mm:ss` but we want to expose it as something easier to work with, let's say a `number`.\n+\n+In order to do it quickly, let's add `date-fns` package:\n+\n+    npm install date-fns\n+\n+It has `format` method that will help us to do conversions.\n+\n+We need to the logic of `Chats.findMessagesByChat` method.\n+\n+{{{ diffStep \"14.11\" module=\"server\" }}}\n+\n+Because the order of creation matters, messages are selected quite differently than before, we keep selecting all columns but records are ordered by the date of creation.\n+\n+There's an interesting thing related to the cursor. If it's provided, we query for only those messages that happened before our cursor. This way we have a valid direction, fetching more messages means fetching older records.\n+\n+The last message in the list becomes of course the `cursor`.\n+\n+In order to calculate `hasMore` we need to apply the same conditions as above but with `LIMIT 1` and see if we get a result.\n+\n+Since the API part is done, let's take care of something much more complicated, which is always the UI...\n+\n+Let's plan it first. We know we want to fetch more messages while scrolling up. That means, Infinite Scroll with a corresponding request each time we hit the top. Because we implemented prefetching, we need to know what's the `limit`. React's Context might be helpful here. There was, of course, the change in GraphQL Schema we need to take care of too.\n+\n+### Apply schema changes\n+\n+Since we know what the plan is, let's start with schema changes. The `Chat.messages` is no longer a list, it's an object now.\n+\n+{{{ diffStep \"15.6\" module=\"client\" }}}\n+\n+Now we need reflect those changes in generated hooks by running:\n+\n+    yarn codegen\n+\n+Okay, let's move on!\n+\n+### Infinite Scrolling\n+\n+Now this Infinite Scroll thing. The core concept is to ask for more data, once a user's scrollbar hits the top edge of the screen.\n+\n+{{{ diffStep \"15.2\" module=\"client\" }}}\n+\n+Our `useInfiniteScroll` hook requires:\n+\n+- `ref` is a reference of a HTML element\n+- `onLoadMore` calls the part component back and asks for data\n+\n+We used `useEffect` to add and remove a scroll event listener. The function lives as long as `ref` and `onLoadMore` stay the same, that's because we simply make use of them in `handleScroll` function. The `handleScroll` function calls `onLoadMore` when a user scrolled to the top.\n+\n+It all looks fine at first, but we still need to prevent calling back once fetching is in progress.\n+\n+{{{ diffStep \"15.3\" module=\"client\" }}}\n+\n+That's why `isFetching` state is necessary but as you can tell, we don't set it to `false`.\n+\n+{{{ diffStep \"15.4\" module=\"client\" }}}\n+\n+We want the consumer of the hook to tell it when fetching is finished, that's why we expose the state with `stopFetching` function.\n+\n+The next issue that appears right away is related to the case when there's no more data to fetch.\n+\n+{{{ diffStep \"15.5\" module=\"client\" }}}\n+\n+Pfff... The hook part is done!\n+\n+### Pagination\n+\n+Pagination is partially implemented thanks to Infinite Scrolling but the thing we need to still apply is React's context. It will be a central place of storing `limit` and `after` values, so they could be shared across multiple components and not passed directly from one to another.\n+\n+{{{ diffStep \"15.7\" module=\"client\" }}}\n+\n+We implemented three things:\n+\n+- `PaginationContext` is simple, it stores the values but also allows to set a new one for `after` or even bring it all back to the initial state.\n+- `usePagination` hook is there so components could use `PaginationContext` and to make sure we reset it when component unmounts.\n+- `ChatPaginationProvider` provides the logic and core functionality\n+\n+Since the pagination is almost ready, let's make use of it in `useGetChatPrefetch` hook and `ChatRoomScreen` component.\n+\n+{{{ diffStep \"15.8\" module=\"client\" }}}\n+\n+This won't work yet because there's nothing that creates the context.\n+\n+{{{ diffStep \"15.9\" module=\"client\" }}}\n+\n+We had to split the `ChatRoomScreen` into two pieces. One that includes `ChatPaginationProvider` and produces `chatId` and the other that keeps pretty much everything else. This way the tree of child components, starting from `ChatRoom` share the same context.\n+\n+### Fetching more messages\n+\n+Everything is set up, we can now move on and consume the `useInfiniteScroll` in the `MessagesList` component.\n+\n+{{{ diffStep \"15.10\" module=\"client\" }}}\n+\n+We added the `LoadingMore` component with *Loading more messages...* text in it that pops out when fetching is in progress.\n+Because the `MessagesList` is not responsible of quering data we don't know exactly when it's completed but we can assume, it happens once the length of `messages` changes.\n+We also pass `onLoadMore` and `hasMore` props to the parent component and the `useInfiniteScroll` uses `MessagesList` as the element we're going to scroll in.\n+\n+There's also one more thing that could be turned into a hook, it's the logic responsible for scrolling to bottom of the page, every time `messages` changes.\n+\n+{{{ diffStep \"15.11\" module=\"client\" }}}\n+\n+We also added some extra functionality there. Because we don't want to scroll to bottom when a new message is added, the function returned by `useAdjustedScroll` accepts now an argument.\n+\n+We did the `MessagesList`, now let's move onto real data and the `ChatRoom` component.\n+\n+{{{ diffStep \"15.12\" module=\"client\" }}}\n+\n+As you see above, every time the `MessagesList` asks for more messages, the `after` changes its value to `chat.messages.cursor` which means that's a new \"end\" of the list and we need to fill it up.\n+\n+Right now we just have a logic and a place to do it but we still need to make a GraphQL call.\n+\n+Fortunately, Apollo lets you do pagination with a method called `fetchMore`. You need to specify what query and variables to use for the update, and how to merge the new query result with the existing data on the client. How exactly you do that will determine what kind of pagination you are implementing, in our case it's cursor-based.\n+\n+But there's a catch!\n+\n+It's related to how Apollo stores query results in cache. When we update the variables, in our case it's the `after` that changes quite a lot, a new record is created that is totally unrelated to the original query. That's because Apollo uses a combination of variables and query string to produce a key.\n+\n+An example:\n+\n+\n+```graphql\n+{\n+  query getUser($id: ID!) {\n+    user(id: $id) {\n+      name\n+    }\n+  }\n+}\n+```\n+\n+The result of `getUser` query will be saved under `user({\"id\":2})` key.\n+\n+This is a huge problem, it breaks imperative store updates but that's why `@connection` directive exists. It directs Apollo to use a stable store key for paginated queries, so every `useQuery()` or `fetchMore()` is being placed in the same space.\n+\n+With all that knowledge, let's implement the last puzzle piece!\n+\n+{{{ diffStep \"15.13\" module=\"client\" }}}\n+\n+As you see, we mutate the store as usual and we put fetched messages before the existing ones. Remember, it's from older to newer.\n+\n+### Looking at the bundle size\n+\n+We can't of course forget about one of the most important aspects of optimization, the size of the application. As bundle size increases, both the parsing time and the time of the request takes longer.\n+\n+How can we check what libraries and source files are shipped within the produced bundle?\n+\n+There are many tools that analyze it for us but we're going to use only one of them, just for educational purpose.\n+\n+      $ yarn add -D source-map-explorer\n+\n+We're going to add the `size` npm script in which we point the `source-map-explorer` to transpiled js files.\n+\n+{{{ diffStep \"15.14\" module=\"client\" }}}\n+\n+Let's see it in action, run:\n+\n+    $ yarn build && yarn size\n+\n+That's what you should see:\n+\n+![Source Map Explorer](../../../assets/step17/img-10.png \"Source Map Explorer\")\n+\n+It's interactive so you can dive deeper and deeper into those blocks but in general it shows what libraries and files are included in the produced output with their size(not minified and not gzipped).\n+\n+![Source Map Explorer](../../../assets/step17/img-11.png \"Source Map Explorer with moment highlighted\")\n+\n+For example, we see that `moment` takes almost _53.49KB_ which is enourmous. In fact we only use its `format` method. The reason is that the library is not well tree-shakable. There are plugins for webpack (or any other build tool) that helps with it but we're going to use an alternative instead. We're going to replace it with `date-fns`.\n+\n+{{{ diffStep \"15.15\" module=\"client\" }}}\n+\n+Now when you run:\n+\n+    $ yarn build && yarn size\n+\n+You should see the following results.\n+\n+![Source Map Explorer](../../../assets/step17/img-12.png \"Source Map Explorer with date-fns\")\n+\n+The bundle size is a bit smaller and `date-fns` takes only _8.93KB_ which in comparison to _53.49KB_ is a significant change!\n+\n+## Load testing\n+\n+Load testing, in short, is about finding the limit of an application and figure out how to push it even more. We simulate a stressful behavior and apply that to the server until it crashes. Weâ€™re trying to answer the question of how the api deals with a pressure.\n+\n+When to do load testing?\n+I would say at least before and after major changes, when pre-launching and just from time to time to prevent regressions.\n+\n+Before doing load testing, we need to prepare a bit first. Right now we use `ts-node` to run the server but it would be faster to run it directly using `node`, just to avoid on-the-fly transpilation of TypeScript files.\n+\n+In order to do it, we need to define the `outDir` in `tsconfig.json` and add a build step.\n+\n+{{{ diffStep \"14.12\" module=\"server\" }}}\n+\n+Next, the script to actually run the server:\n+\n+{{{ diffStep \"14.13\" module=\"server\" files=\"package.json\" }}}\n+\n+Once itâ€™s ready, we can move on to tooling.\n+\n+### Artillery\n+\n+Artillery is an open-source load testing and functional testing toolkit. Itâ€™s API is vast but we will focus on the core part of it which is relevant to this chapter. Artillery is available as a npm package:\n+\n+    $ yarn add -D artillery\n+\n+The only step to use Artillery is to set it up. We will create the `artillery.yml` file, like this:\n+\n+{{{ diffStep \"14.15\" module=\"server\" }}}\n+\n+As you can see, the config file is built of two sections. First one is named `config` and it defines whatâ€™s our target and how the traffic should look like. We used one phase but it could have many. The `duration` parameter is to define how long the phase should take. The `arrivalRate` defines how many virtual users per second are going to hit the target and the `rampTo` directs Artillery to increase this number up to 20, at the middle of the phase.\n+\n+The next section, called `scenarios`, is all about the actual requests. In our case, we want to authenticate user, submit a new message and fetch an entire list of chats with their messages at the end. Artillery shares cookies between request of the same virtual user, keep that on mind.\n+\n+We used Ray as the user and fairly similar operations to what the client app sends. That should closely represent the actual usage of the API.\n+\n+Everything is fine with that config but we need to find the limit, to push even more. That's why we'll also add a second config with a bit more heavier traffic, something to simulate the more real life environment. It's pretty much the same setup except phases. First, we \"warms up\" the server for 2 minutes, same amount of times goes next with double the traffic, then we keep it for 5 minutes. At the end, we want to crash the server so we send nearly 100 virtual users per second for an entire minute. This way we know when it cracks.\n+\n+{{{ diffStep \"14.16\" module=\"server\" }}}\n+\n+Once everything is ready, let's add npm scripts, one for a normal traffic and a second with the much more users:\n+\n+{{{ diffStep \"14.17\" module=\"server\" }}}\n+\n+You probably noticed that we stream the output to the `loadtest.log` file and that's just to read the results in a bit more pleasent way, than in the terminal.\n+\n+Letâ€™s start the server and run artillery:\n+\n+    $ yarn build && yarn start\n+    $ yarn loadtest\n+\n+Youâ€™ll see a loading indicator, might take a while but when it completes, you should see something like this in `loadtest.log` file:\n+\n+```\n+Summary report @ 15:00:58(+0200) 2019-05-30\n+  Scenarios launched:  1506\n+  Scenarios completed: 1506\n+  Requests completed:  4518\n+  RPS sent: 37.35\n+  Request latency:\n+    min: 3.5\n+    max: 115.7\n+    median: 18.6\n+    p95: 54.4\n+    p99: 66.2\n+  Scenario counts:\n+    Sign in, send a new message and fetch a list of chats: 1506 (100%)\n+  Codes:\n+    200: 4518\n+```\n+\n+We ran the scenario 1506 times, all were completed and the total number of requests was 4518.  The **RPS** means requests per second.\n+\n+The metrics in **Request latency** are in milliseconds. We see what was the shortest request and so on. These **p95** and **p99** values mean that for 95% of virtual users, the latency was 54.4ms or lower, for 99% it was 66.2ms. All requests finished with 200 status code.\n+\n+You might also automate that process and integrate Artillery CLI with CI/CI systems or even send metrics to external monitoring systems.\n+\n+### Apollo Engine\n+\n+Let's bring back the Apollo Engine once again. It will be helpful to analyze the load testing results.\n+\n+On the **Metrics** page, you will see the following view:\n+\n+![Metrics](../../../assets/step17/img-13.png \"Metrics\")\n+\n+Click on the filter and set a custom date range to match the time you were load testing. Just to filter out other requests.\n+\n+![Filter](../../../assets/step17/img-14.png \"Filter\")\n+\n+By default, Apollo Engine counts all operations, but you can pick the one youâ€™re interesting in. We donâ€™t do it and inspect them all.\n+\n+![List](../../../assets/step17/img-15.png \"List of operations\")\n+\n+On the main part of the view, you should see â€œLast day overviewâ€ panel.\n+\n+![Overview](../../../assets/step17/img-16.png \"Last day overview\")\n+\n+As you can see, all operations we ran are listed there and no error occurred.\n+\n+![Request Rate](../../../assets/step17/img-17.png \"Request Rate Over Time\")\n+\n+Next section shows the Requests Per Minute (rpm) metric over time. Itâ€™s useful to understand which operations are sent more often than others.\n+\n+![Request 1](../../../assets/step17/img-18.png \"Request Latency Over time\")\n+![Request 2](../../../assets/step17/img-19.png \"Request Latency Distribution\")\n+\n+Last two panels are there to understand at what number of requests the latency increases and to show the correlation between them. We see a distribution of the processing time (the horizontal axis) and the number of operations. It also has p50, p75, p90 and p99 marks on it.\ndiff --git a/.tortilla/manuals/templates/step2.tmpl b/.tortilla/manuals/templates/step2.tmpl\nindex f0dbebe..03d4219 100644\n--- a/.tortilla/manuals/templates/step2.tmpl\n+++ b/.tortilla/manuals/templates/step2.tmpl\n@@ -1,6 +1,6 @@\n Now it's time to style our app.\n\n-We can edit styles manually but we can also usie ready made components that have already been styled and shared in the community.\n+We can edit styles manually but we can also use ready made components that have already been styled and shared in the community.\n\n In this chapter we will do both.\n\n@@ -18,7 +18,7 @@ As we move further in this tutorial you should have a better grasp of Material a\n\n We will start off by installing some of the needed material libraries and its Typescript types library:\n\n-    $ yarn add @material-ui/core @material-ui/icons @types/material-ui\n+    $ yarn add @material-ui/core @material-ui/icons\n\n `@material-ui/core` includes core component of Material-UI such as Input, Popover, Modal, etc, and `@material-ui/icons` includes a set of icons.\n Material is very generic and has a built in theming system which can be controlled by simply setting few variables,\n@@ -84,7 +84,7 @@ and another was the fact that we could encapsulate our UI into a set of separate\n But when it comes to CSS, we are still using it like before, having no encapsulation between different definitions and files.\n\n [Styled-components](https://www.styled-components.com/) is a relatively new library that will transpile a given string into a CSS string and will encapsulate it under a `React.Component`.\n-Bringing the same concepts from React into the way we write styles, so we ca define our styles programmatically.\n+Bringing the same concepts from React into the way we write styles, so we can define our styles programmatically.\n With JavaScript in-hand you naturally have more control over our styles and its encapsulation, which makes it a very powerful tool.\n\n Here's one way to style a button using styled-components:\ndiff --git a/.tortilla/manuals/templates/step3.tmpl b/.tortilla/manuals/templates/step3.tmpl\nindex bac6af8..9fb50ce 100644\n--- a/.tortilla/manuals/templates/step3.tmpl\n+++ b/.tortilla/manuals/templates/step3.tmpl\n@@ -40,7 +40,9 @@ Just to make sure that things work, we will add an `index.js` file which will pr\n\n And we will add a startup script to the `package.json` file called `start`:\n\n-    \"start\": \"node index.js\"\n+    \"scripts\": {\n+      \"start\": \"node index.js\"\n+    }\n\n NPM-scripts are just a way to defined an alias for commands. Now we only have one simple script,\n but it can turn out to be something very complex depending on our server, so it can be very useful.\n@@ -87,7 +89,7 @@ so let's use tools to track when files change and make them run the code automat\n\n And we will update the npm-script `start` to use `ts-node`, since we wanna use TypeScript, and not JavaScript directly:\n\n-    start: ts-node index.ts\n+    \"start\": \"ts-node index.ts\"\n\n We can test the startup of our server again by running `$ yarn start` and we should see the message \"hello world\" printed to the console.\n\n@@ -109,18 +111,39 @@ This is how the route should look like:\n\n We can use the\n\n-        `$ curl localhost:4000/_ping`\n+        $ curl localhost:4000/_ping\n\n command to send a request to the server and we should get a \"pong\", assuming that the server available on that URL.\n+\n+**Code formatting**\n+\n+Just like we talked in the first chapter, some developers write code in a different style than others and since we want to make it consistent, we're going to use **Prettier**.\n+\n+    $ yarn add -D prettier\n+\n+We're going to define a npm script called `format`, few styling rules and we're also going to ignore *node_modules*:\n+\n+{{{ diffStep \"1.4\" module=\"server\" files=\"package.json, .prettierrc.yml, .prettierignore\" }}}\n+\n+Now let's run:\n+\n+    $ yarn format\n+\n+Prettier should format your code:\n+\n+{{{ diffStep \"1.4\" module=\"server\" files=\"index.ts\" }}}\n+\n+> Remember to run `yarn prettier` before you comit your changes!\n+\n The `GET /chats` should be implemented similarly, only the response is different. Instead of returning \"pong\" we will return the data-mock for our chats:\n\n-{{{ diffStep \"1.4\" module=\"server\" files=\"index.ts, db.ts\" }}}\n+{{{ diffStep \"1.5\" module=\"server\" files=\"index.ts, db.ts\" }}}\n\n TODO: Mention `_req`\n\n-Check we can get the chats by running:\n+Check that we can get the chats by running:\n\n-        `$ curl localhost:4000/chats`\n+        $ curl localhost:4000/chats\n\n Unlike the previous route, we used the `.json()` method this time around to send a response. This will simply stringify the given JSON and set the right headers.\n Similarly to the client, we've defined the db mock in a dedicated file, as this is easier to maintain and look at.\n@@ -137,7 +160,7 @@ and its Typescript types:\n\n     $ yarn add --dev @types/cors\n\n-{{{ diffStep \"1.4\" module=\"server\" files=\"index.ts\" }}}\n+{{{ diffStep \"1.6\" module=\"server\" files=\"index.ts\" }}}\n\n The server is now ready to use!\n\n@@ -236,4 +259,4 @@ TODO: New diff for the `lib` folder update\n\n TODO: why `useMemo(fn, [true])` instead of `useEffect(fn, [])` ?\n\n-TODO: Move to hooks in a separate commit and later change to call the server\n+TODO: Move to hooks in a separate commit and later change to call the server\n\\ No newline at end of file\ndiff --git a/.tortilla/manuals/templates/step4.tmpl b/.tortilla/manuals/templates/step4.tmpl\nindex 0d3700e..d886d45 100644\n--- a/.tortilla/manuals/templates/step4.tmpl\n+++ b/.tortilla/manuals/templates/step4.tmpl\n@@ -171,13 +171,12 @@ Essentially GraphQL is connected into a HTTP endpoint, usually under `POST /grap\n Luckily, we don't have to implement that. A team called [Apollo](https://www.apollographql.com/) already did it for us, so we can use their implementation.\n We will install the required packages:\n\n-    $ yarn add apollo-server-express body-parser graphql\n-    $ yarn add --dev @types/body-parser @types/graphql\n+    $ yarn add apollo-server-express graphql\n+    $ yarn add --dev @types/graphql\n\n - [`graphql`](https://www.npmjs.com/package/graphql) - The core package of GraphQL that includes the resolvers for basic data-types.\n - [`apollo-server-express`](https://www.npmjs.com/package/apollo-server-express) - Apollo's implementation for the GraphQL Express REST endpoint.\n-- [`body-parser`](https://www.npmjs.com/package/body-parser) - Parse incoming request bodies in a middleware before your handlers, available under the req.body property.\n-- `@types/â€¦` - TypeScript definitions. Notice that we didn't need to install Apollo's types library. That is because Apollo themselves writes their source code in Typescript so\n+- `@types/graphql` - TypeScript definitions. Notice that we didn't need to install Apollo's types library. That is because Apollo themselves writes their source code in Typescript so\n we get a ready Typescript code directly from their library.\n\n We can now connect Apollo's middleware under the `/graphql` route:\n@@ -192,6 +191,14 @@ As you can see, the middleware requires a schema. A schema is composed mainly ou\n We will start first by defining the types.\n All we have to do is to copy-paste the contents of the schema that was shown earlier into a new file called `typeDefs.graphql`:\n\n+Note that some of the fields have exclamation mark at the end and it means that the field is non-nullable,\n+meaning that the GraphQL service promises to always give you a value when you query this field.\n+\n+Chats Query is even more interesting case with two exclamation marks `[Chat!]!`.\n+\n+The outer exclamation mark means that if you run this query it will always return an array of zero or more items (never null)\n+and inner exclamation mark means that every item of returned array will be of type `Chat` and never be null.\n+\n {{{ diffStep \"2.2\" module=\"server\" files=\"schema/typeDefs.graphql\" }}}\n\n The `.graphql` file extension is just a more convenient way to work with a GraphQL schema. The exported result should be a simple string that we can use to compose our GraphQL schema. The clear advantage of working with a dedicated file is that we get to have syntax highlight.\n@@ -268,7 +275,6 @@ In the next chapter, we will continue working on the UI of our front-end applica\n\n -------\n TODO: Start with calling the  `graphql` function just on the server to show how it works.\n-TODO: Separate step for body parser.\n TODO: Example middlewares in Node\n TODO: Mention the vs code extension\n\ndiff --git a/.tortilla/manuals/templates/step5.tmpl b/.tortilla/manuals/templates/step5.tmpl\nindex ba9132d..6cd88af 100644\n--- a/.tortilla/manuals/templates/step5.tmpl\n+++ b/.tortilla/manuals/templates/step5.tmpl\n@@ -48,11 +48,11 @@ Now we're gonna write a basic test for the `<ChatsList />` component. In the tes\n\n Now we can select various HTML elements with a query selector when we test the component. We will install a couple of packages that will assist us in implementing the test:\n\n-  $ yarn add jest-fetch-mock jest-dom react-testing-library\n+    $ yarn add jest-fetch-mock @testing-library/jest-dom @testing-library/react\n\n - The [`jest-fetch-mock`](https://www.npmjs.com/package/jest-fetch-mock) package can mock responses emitted by the Fetch API.\n-- The [`jest-dom`](https://www.npmjs.com/package/jsdom) package will add custom matchers that will help us examine HTML contents of DOM elements.\n-- The [`react-testing-library`](https://www.npmjs.com/package/react-testing-library) package contains utility methods that will help us test React.Components with Jest.\n+- The [`@testing-library/jest-dom`](https://www.npmjs.com/package/@testing-library/jest-dom) package will add custom matchers that will help us examine HTML contents of DOM elements.\n+- The [`@testing-library/react`](https://www.npmjs.com/package/@testing-library/react) package contains utility methods that will help us test React.Components with Jest.\n\n Next, we will create a file under the `src` folder called `setupTests.ts`. This file is loaded configured automatically by `create-react-app` and loaded by Jest, and we can use it to set up our testing environment according to our needs (like said earlier, Jest can be configured, so this file path can be changed). We will use that file to define a fake Fetch API using the `jest-fetch-mock` library:\n\n@@ -106,6 +106,9 @@ so we can run the tests with `$ yarn test`:\n\n This is how our `package.json` should look like at this point:\n\n+> Notice we have lines there that mention `jest-junit`.\n+> Those are needed for our own tutorial CI, you don't have to use it.\n+\n {{{ diffStep \"3.1\" module=\"server\" files=\"package.json\" }}}\n\n Now we're gonna test the `chats` query in our GraphQL schema. To do so, we will setup an Apollo Client and send a query request to our back-end, and then we will match the received response with a pre-defined snapshot. Luckily, we don't have to set an actual client, since the tests and the implementation of the back-end live right next to each other, thus, we will install a package which will help us achieving so:\ndiff --git a/.tortilla/manuals/templates/step6.tmpl b/.tortilla/manuals/templates/step6.tmpl\nindex cf3c983..f8fd9e4 100644\n--- a/.tortilla/manuals/templates/step6.tmpl\n+++ b/.tortilla/manuals/templates/step6.tmpl\n@@ -4,14 +4,14 @@ In order to navigate between different screens, we will setup a router.\n Since we're gonna have to screens in our app now - `ChatsListScreen` and `ChatRoomScreen`, we will need a router that will be able to alternate between them.\n We will be using the [`react-router-dom`](https://www.npmjs.com/package/react-router-dom) package to manage the routes of the application:\n\n-    $ yarn add react-router-dom\n+    $ yarn add react-router-dom @types/react-router-dom\n\n And we will implement a router directly in the `<App />` component:\n\n {{{ diffStep 6.1 module=\"client\" files=\"App\" }}}\n\n The purpose of a router is to make route managing easy and declarative.\n-It will take care of managing the history within our app and parameterizing certain screens according to our need.\n+It will take care of managing the history within our app and parameterize certain screens according to our need.\n Essentially it's a wrap around the `window.history` object which is also compatible with React.\n I recommend you to go through the [official MDN docs](https://developer.mozilla.org/en-US/docs/Web/API/History) if you're not yet familiar with the concept.\n\n@@ -169,6 +169,10 @@ Now that we have all 3 components, we will put them all together in the main `in\n\n {{{ diffStep 6.6 module=\"client\" files=\"index\" }}}\n\n+And let's also send the new required `history` props to our `ChatRoomScreen` component:\n+\n+{{{ diffStep 6.6 module=\"client\" files=\"App.tsx\" }}}\n+\n The view is complete! However the `MessageInput` is not bound to our messages list.\n We will use the triggered callback to update the chat state, whose changes should appear in the `MessagesList` component in the following render phase:\n\ndiff --git a/.tortilla/manuals/templates/step7.tmpl b/.tortilla/manuals/templates/step7.tmpl\nindex 2c24150..614f1d0 100644\n--- a/.tortilla/manuals/templates/step7.tmpl\n+++ b/.tortilla/manuals/templates/step7.tmpl\n@@ -34,17 +34,19 @@ We will create a new file in the `src` directory called `client.ts` and inside w\n {{{ diffStep 7.1 module=\"client\" files=\"client\" }}}\n\n Although the client can be used directly and integrated into any UI framework, it would be the most comfortable to use a wrap around it which is suitable for React.\n-For that we will use a package called [`react-apollo-hooks`](https://www.npmjs.com/package/react-apollo-hooks) which includes a set of [React hooks](https://reactjs.org/docs/hooks-intro.html) that can connect between our Apollo-Client and target React.Component:\n+For that we will use Apollo's React Hooks package called [`@apollo/react-hooks`](https://github.com/apollographql/react-apollo) which includes a set of\n+[React hooks](https://reactjs.org/docs/hooks-intro.html) that can connect between our Apollo-Client and target React.Component:\n\n-    $ yarn add react-apollo-hooks graphql-tag graphql\n+    $ yarn add @apollo/react-hooks graphql-tag graphql\n\n-With `react-apollo-hooks` we can use the `useQuery()` hook to fetch data from our GraphQL API.\n-The `graphql-tag` package is used to parse the GraphQL string to an [AST](https://en.wikipedia.org/wiki/Abstract_syntax_tree), something which is required when using Apollo Client. Example:\n+With `@apollo/react-hooks` we can use the `useQuery()` hook to fetch data from our GraphQL API.\n+The `graphql-tag` package is used to parse the GraphQL string to an [AST](https://en.wikipedia.org/wiki/Abstract_syntax_tree),\n+something which is required when using Apollo Client. Example:\n\n\n ```\n import gql from 'graphql-tag';\n-import { useQuery } from 'react-apollo-hooks';\n+import { useQuery } from '@apollo/react-hooks';\n\n const GET_DOGS = gql`\n   {\ndiff --git a/.tortilla/manuals/templates/step8.tmpl b/.tortilla/manuals/templates/step8.tmpl\nindex f3a2022..ec76daf 100644\n--- a/.tortilla/manuals/templates/step8.tmpl\n+++ b/.tortilla/manuals/templates/step8.tmpl\n@@ -6,13 +6,17 @@ a method for sending and applying mutations in our back-end.\n\n **What are GraphQL mutations?**\n\n-If you have an API endpoint that alters data, like inserting data into a database or altering data already in a database,\n+If you have an API endpoint that alters data, like inserting data into a database or altering data that's already in a database,\n you should make this endpoint a `Mutation` rather than a `Query`.\n This is as simple as making the API endpoint part of the top-level `Mutation` type instead of the top-level `Query` type.\n\n-It's often convenient to have a mutation that maps to a database create or update operation, return the same thing that the server stored.\n+Mutation is a remote procedure call (RPC), meaning it is used to trigger a function on the server,\n+but unlike other protocols which have RPCs, GraphQL Mutation also includes a query, which means the client can ask for data\n+once the operation is complete.\n+\n+It's often convenient to have a mutation that maps to a database create or update operation and have it return the same thing that the server stored.\n That way, if you modify the data on the server, the client can learn about those modifications.\n-**A GraphQL mutation is like a GraphQL query, only with side effects**.\n+You can also think about a GraphQL Mutation as a ** GraphQL query, only with side effects**.\n It's equivalent to GET (query) and POST/PUT (mutation) in the context of REST API.\n\n Below is a sample GraphQL mutation request:\n@@ -34,10 +38,17 @@ In this chapter we want to have the ability to send messages, thus we will have\n\n {{{ diffStep 5.1 module=\"server\" files=\"typeDefs\" }}}\n\n-Note that our mutation resolver `addMessage` receives a `chatId`. This is because when adding a message, we should update both the messages collection, and the correlated chat document. Mutations are resolved exactly like any other type in our resolvers manifest. The new resolver should look like this:\n+Note that our mutation resolver `addMessage` receives a `chatId` and it is a non-optional parameter.\n+This is because when adding a message, we should update both the messages collection, and the correlated chat document.\n+\n+Mutations are resolved exactly like any other type in our resolvers manifest. The new resolver should look like this:\n\n {{{ diffStep 5.1 module=\"server\" files=\"resolvers\" }}}\n\n+When we add a message, we first find the right chat,\n+then we generate a new message ID that is bigger then all the previous messages (when we'll move to a real database it will do that for us)\n+and push the message into the right chat.\n+\n In terms of testing, we will use a temporary solution for now to reset the DB each time we test a mutation. Since we make a modification in the DB, we need to make sure that each test is completely agnostic and doesn't affect one another, thus, we will export a `resetDB()` method from our `db.ts` module:\n\n {{{ diffStep 5.2 module=\"server\" files=\"db.ts\" }}}\n@@ -51,7 +62,7 @@ Now we have the infrastructure set for sending a new message and we can start us\n **How to use a GraphQL mutation?**\n\n Like in the previous chapters, we're gonna use a React hook so we can run a mutation more efficiently in a React.Component.\n-For this we're gonna use the [`useMutation()`](https://github.com/trojanowski/react-apollo-hooks#usemutation) react hook.\n+For this we're gonna use the [`useMutation()`](https://www.apollographql.com/docs/react/essentials/mutations/#the-usemutation-hook) react hook.\n The first argument of the hook is the mutation string, and the second one is the [mutation options](https://www.apollographql.com/docs/react/api/apollo-client.html#ApolloClient.mutate).\n We're gonna provide our mutation call with a single option called `optimisticResponse`.\n\ndiff --git a/.tortilla/manuals/templates/step9.tmpl b/.tortilla/manuals/templates/step9.tmpl\nindex 4c87613..b577028 100644\n--- a/.tortilla/manuals/templates/step9.tmpl\n+++ b/.tortilla/manuals/templates/step9.tmpl\n@@ -31,7 +31,7 @@ export type ChatQuery = {\n\n ```\n\n-So later on we can use it with `react-apollo-hooks` like so:\n+So later on we can use it with `@apollo/react-hooks` like so:\n\n ```ts\n useQuery<ChatsQuery>(getChatsQuery)\n@@ -94,6 +94,11 @@ Now if you'll run `$ npm run codegen` you should see that a new file `types/grap\n\n {{{ diffStep 6.1 module=\"server\" files=\".gitignore\" }}}\n\n+Now to make sure we always get the updated types, let's add a task that would run automatically before we start the server.\n+`prestart` is a saved word that means that when we run `yarn start` it will run that task automatically before running the script in `start`:\n+\n+{{{ diffStep 6.1 module=\"server\" files=\"package.json\" }}}\n+\n Now we can import the `IResolvers` type from the file we've just created and use it in the `resolvers.ts` file to ensure our resolvers handlers have the right signature:\n\n {{{ diffStep 6.2 module=\"server\" }}}\ndiff --git a/assets/step17/img-01.png b/assets/step17/img-01.png\nnew file mode 100644\nindex 0000000..1eef108\nBinary files /dev/null and b/assets/step17/img-01.png differ\ndiff --git a/assets/step17/img-02.png b/assets/step17/img-02.png\nnew file mode 100644\nindex 0000000..f4fda88\nBinary files /dev/null and b/assets/step17/img-02.png differ\ndiff --git a/assets/step17/img-03.png b/assets/step17/img-03.png\nnew file mode 100644\nindex 0000000..e44720e\nBinary files /dev/null and b/assets/step17/img-03.png differ\ndiff --git a/assets/step17/img-04.png b/assets/step17/img-04.png\nnew file mode 100644\nindex 0000000..5348f1d\nBinary files /dev/null and b/assets/step17/img-04.png differ\ndiff --git a/assets/step17/img-05.png b/assets/step17/img-05.png\nnew file mode 100644\nindex 0000000..0e3f415\nBinary files /dev/null and b/assets/step17/img-05.png differ\ndiff --git a/assets/step17/img-06.png b/assets/step17/img-06.png\nnew file mode 100644\nindex 0000000..3de7403\nBinary files /dev/null and b/assets/step17/img-06.png differ\ndiff --git a/assets/step17/img-07.png b/assets/step17/img-07.png\nnew file mode 100644\nindex 0000000..9e78e34\nBinary files /dev/null and b/assets/step17/img-07.png differ\ndiff --git a/assets/step17/img-08.png b/assets/step17/img-08.png\nnew file mode 100644\nindex 0000000..cf31e14\nBinary files /dev/null and b/assets/step17/img-08.png differ\ndiff --git a/assets/step17/img-09.png b/assets/step17/img-09.png\nnew file mode 100644\nindex 0000000..a7e0cd9\nBinary files /dev/null and b/assets/step17/img-09.png differ\ndiff --git a/assets/step17/img-10.png b/assets/step17/img-10.png\nnew file mode 100644\nindex 0000000..5b53c72\nBinary files /dev/null and b/assets/step17/img-10.png differ\ndiff --git a/assets/step17/img-11.png b/assets/step17/img-11.png\nnew file mode 100644\nindex 0000000..3de262c\nBinary files /dev/null and b/assets/step17/img-11.png differ\ndiff --git a/assets/step17/img-12.png b/assets/step17/img-12.png\nnew file mode 100644\nindex 0000000..cfda6aa\nBinary files /dev/null and b/assets/step17/img-12.png differ\ndiff --git a/assets/step17/img-13.png b/assets/step17/img-13.png\nnew file mode 100644\nindex 0000000..4a09e7e\nBinary files /dev/null and b/assets/step17/img-13.png differ\ndiff --git a/assets/step17/img-14.png b/assets/step17/img-14.png\nnew file mode 100644\nindex 0000000..b90083b\nBinary files /dev/null and b/assets/step17/img-14.png differ\ndiff --git a/assets/step17/img-15.png b/assets/step17/img-15.png\nnew file mode 100644\nindex 0000000..476d6df\nBinary files /dev/null and b/assets/step17/img-15.png differ\ndiff --git a/assets/step17/img-16.png b/assets/step17/img-16.png\nnew file mode 100644\nindex 0000000..bc22bc5\nBinary files /dev/null and b/assets/step17/img-16.png differ\ndiff --git a/assets/step17/img-17.png b/assets/step17/img-17.png\nnew file mode 100644\nindex 0000000..9833904\nBinary files /dev/null and b/assets/step17/img-17.png differ\ndiff --git a/assets/step17/img-18.png b/assets/step17/img-18.png\nnew file mode 100644\nindex 0000000..81bc4c6\nBinary files /dev/null and b/assets/step17/img-18.png differ\ndiff --git a/assets/step17/img-19.png b/assets/step17/img-19.png\nnew file mode 100644\nindex 0000000..bd991ab\nBinary files /dev/null and b/assets/step17/img-19.png differ\ndiff --git a/client/.circleci/config.yml b/client/.circleci/config.yml\nnew file mode 100644\nindex 0000000..d1069b2\n--- /dev/null\n+++ b/client/.circleci/config.yml\n@@ -0,0 +1,31 @@\n+version: 2\n+jobs:\n+  build:\n+    working_directory: ~/app/\n+    docker:\n+      - image: circleci/node:12.7.0\n+    steps:\n+      - checkout\n+      - restore_cache:\n+          name: Restore Yarn Package Cache\n+          keys:\n+            - yarn-packages-{{ checksum \"package.json\" }}\n+      - run:\n+          name: Clone Server\n+          command: git clone https://github.com/Urigo/WhatsApp-Clone-Server.git --branch master-step14 --single-branch ../WhatsApp-Clone-Server\n+      - run:\n+          name: Install Dependencies\n+          command: yarn\n+      - run:\n+          name: Build\n+          command: yarn build\n+      - run:\n+          name: Test\n+          command: yarn test\n+      - store_test_results:\n+          path: test-results\n+      - save_cache:\n+          name: Save Yarn Package Cache\n+          key: yarn-packages-{{ checksum \"package.json\" }}\n+          paths:\n+            - ~/.cache/yarn\ndiff --git a/client/.prettierignore b/client/.prettierignore\nnew file mode 100644\nindex 0000000..b512c09\n--- /dev/null\n+++ b/client/.prettierignore\n@@ -0,0 +1 @@\n+node_modules\n\\ No newline at end of file\ndiff --git a/client/.prettierrc.yml b/client/.prettierrc.yml\nnew file mode 100644\nindex 0000000..137e486\n--- /dev/null\n+++ b/client/.prettierrc.yml\n@@ -0,0 +1,4 @@\n+trailingComma: 'es5'\n+tabWidth: 2\n+singleQuote: true\n+jsxBracketSameLine: true\ndiff --git a/client/codegen.yml b/client/codegen.yml\nindex 7faedfa..e1c0339 100644\n--- a/client/codegen.yml\n+++ b/client/codegen.yml\n@@ -1,9 +1,10 @@\n-schema: ../Whatsapp-Clone-Server/schema/typeDefs.graphql\n+schema: ../WhatsApp-Clone-Server/modules/*/*.ts\n documents:\n   - ./src/components/**/*.tsx\n   - ./src/graphql/fragments/**/*.ts\n   - ./src/graphql/queries/**/*.ts\n   - ./src/graphql/subscriptions/**/*.ts\n+  - ./src/graphql/mutations/**/*.ts\n overwrite: true\n generates:\n   ./src/graphql/types.tsx:\ndiff --git a/client/package.json b/client/package.json\nindex f1093db..35ee4ba 100644\n--- a/client/package.json\n+++ b/client/package.json\n@@ -2,50 +2,56 @@\n   \"name\": \"whatsapp-clone-client\",\n   \"version\": \"0.1.0\",\n   \"private\": true,\n+  \"repository\": {\n+    \"type\": \"git\",\n+    \"url\": \"https://github.com/Urigo/WhatsApp-Clone-Client-React.git\"\n+  },\n   \"dependencies\": {\n-    \"@graphql-codegen/add\": \"1.2.0\",\n-    \"@graphql-codegen/cli\": \"1.2.0\",\n-    \"@graphql-codegen/typescript\": \"1.2.0\",\n-    \"@graphql-codegen/typescript-operations\": \"1.2.0\",\n-    \"@graphql-codegen/typescript-react-apollo\": \"1.2.0\",\n-    \"@material-ui/core\": \"3.9.3\",\n-    \"@material-ui/icons\": \"3.0.2\",\n+    \"@apollo/react-hooks\": \"3.0.0\",\n+    \"@graphql-codegen/add\": \"1.5.0\",\n+    \"@graphql-codegen/cli\": \"1.5.0\",\n+    \"@graphql-codegen/typescript\": \"1.5.0\",\n+    \"@graphql-codegen/typescript-operations\": \"1.5.0\",\n+    \"@graphql-codegen/typescript-react-apollo\": \"1.5.0\",\n+    \"@material-ui/core\": \"4.3.2\",\n+    \"@material-ui/icons\": \"4.2.1\",\n     \"@types/history\": \"4.7.2\",\n-    \"@types/jest\": \"24.0.13\",\n-    \"@types/material-ui\": \"0.21.6\",\n-    \"@types/node\": \"12.0.1\",\n-    \"@types/react\": \"16.8.17\",\n-    \"@types/react-dom\": \"16.8.4\",\n-    \"@types/react-router-dom\": \"4.3.3\",\n-    \"@types/styled-components\": \"4.1.14\",\n-    \"apollo-cache-inmemory\": \"1.5.1\",\n-    \"apollo-client\": \"2.5.1\",\n-    \"apollo-link\": \"1.2.11\",\n-    \"apollo-link-http\": \"1.5.14\",\n+    \"@types/jest\": \"24.0.17\",\n+    \"@types/node\": \"12.7.1\",\n+    \"@types/react\": \"16.8.23\",\n+    \"@types/react-dom\": \"16.8.5\",\n+    \"@types/react-router-dom\": \"4.3.4\",\n+    \"@types/styled-components\": \"4.1.18\",\n+    \"apollo-cache-inmemory\": \"1.6.3\",\n+    \"apollo-client\": \"2.6.4\",\n+    \"apollo-link\": \"1.2.12\",\n+    \"apollo-link-http\": \"1.5.15\",\n     \"apollo-link-mock\": \"1.0.1\",\n-    \"graphql\": \"14.3.1\",\n-    \"apollo-link-ws\": \"1.0.17\",\n-    \"apollo-utilities\": \"1.2.1\",\n+    \"graphql\": \"14.4.2\",\n+    \"apollo-link-ws\": \"1.0.18\",\n+    \"apollo-utilities\": \"1.3.2\",\n+    \"date-fns\": \"1.30.1\",\n     \"graphql-tag\": \"2.10.1\",\n     \"history\": \"4.9.0\",\n-    \"moment\": \"2.24.0\",\n-    \"react\": \"16.8.6\",\n-    \"react-apollo\": \"2.5.6\",\n-    \"react-apollo-hooks\": \"0.4.5\",\n-    \"react-dom\": \"16.8.6\",\n-    \"react-router-dom\": \"5.0.0\",\n+    \"prettier\": \"1.18.2\",\n+    \"react\": \"16.9.0\",\n+    \"react-dom\": \"16.9.0\",\n+    \"react-router-dom\": \"5.0.1\",\n     \"react-router-transition\": \"1.3.0\",\n-    \"react-scripts\": \"3.0.1\",\n-    \"styled-components\": \"4.2.0\",\n+    \"react-scripts\": \"3.1.0\",\n+    \"styled-components\": \"4.3.2\",\n     \"subscriptions-transport-ws\": \"0.9.16\",\n-    \"typescript\": \"3.4.5\"\n+    \"typescript\": \"3.5.3\"\n   },\n   \"scripts\": {\n+    \"prebuild\": \"yarn codegen\",\n     \"start\": \"react-scripts start\",\n     \"build\": \"react-scripts build\",\n-    \"test\": \"react-scripts test\",\n+    \"test\": \"TZ=\\\"Asia/Jerusalem\\\" react-scripts test\",\n     \"eject\": \"react-scripts eject\",\n-    \"codegen\": \"gql-gen\"\n+    \"codegen\": \"gql-gen\",\n+    \"format\": \"prettier \\\"**/*.{ts,tsx,css,graphql}\\\" --write\",\n+    \"size\": \"source-map-explorer 'build/static/js/*.js'\"\n   },\n   \"eslintConfig\": {\n     \"extends\": \"react-app\"\n@@ -63,8 +69,9 @@\n     ]\n   },\n   \"devDependencies\": {\n-    \"jest-dom\": \"3.2.1\",\n+    \"@testing-library/jest-dom\": \"4.0.0\",\n+    \"@testing-library/react\": \"9.1.0\",\n     \"jest-fetch-mock\": \"2.1.2\",\n-    \"react-testing-library\": \"7.0.0\"\n+    \"source-map-explorer\": \"2.0.1\"\n   }\n-}\n+}\n\\ No newline at end of file\ndiff --git a/client/public/chat-background.jpg b/client/public/assets/chat-background.jpg\nsimilarity index 100%\nrename from client/public/chat-background.jpg\nrename to client/public/assets/chat-background.jpg\ndiff --git a/client/public/message-mine.png b/client/public/assets/message-mine.png\nsimilarity index 100%\nrename from client/public/message-mine.png\nrename to client/public/assets/message-mine.png\ndiff --git a/client/public/message-other.png b/client/public/assets/message-other.png\nsimilarity index 100%\nrename from client/public/message-other.png\nrename to client/public/assets/message-other.png\ndiff --git a/client/public/whatsapp-icon.png b/client/public/assets/whatsapp-icon.png\nsimilarity index 100%\nrename from client/public/whatsapp-icon.png\nrename to client/public/assets/whatsapp-icon.png\ndiff --git a/client/renovate.json b/client/renovate.json\nindex a80069a..bc92851 100644\n--- a/client/renovate.json\n+++ b/client/renovate.json\n@@ -2,7 +2,6 @@\n   \"extends\": [\"config:base\", \":rebaseStalePrs\"],\n   \"baseBranches\": [\n     \"master\",\n-    \"master-root\",\n     \"master-step1\",\n     \"master-step2\",\n     \"master-step3\",\ndiff --git a/client/src/App.test.tsx b/client/src/App.test.tsx\nindex c5d9cc9..9786fcb 100644\n--- a/client/src/App.test.tsx\n+++ b/client/src/App.test.tsx\n@@ -1,17 +1,24 @@\n import React from 'react';\n-import { ApolloProvider } from 'react-apollo-hooks';\n+import { ApolloProvider } from '@apollo/react-hooks';\n import ReactDOM from 'react-dom';\n import App from './App';\n import { mockApolloClient } from './test-helpers';\n+import * as subscriptions from './graphql/subscriptions';\n\n it('renders without crashing', () => {\n-  const client = mockApolloClient();\n+  const client = mockApolloClient([\n+    {\n+      request: { query: subscriptions.messageAdded },\n+      result: { data: {} }\n+    }\n+  ]);\n   const div = document.createElement('div');\n\n   ReactDOM.render(\n     <ApolloProvider client={client}>\n       <App />\n-    </ApolloProvider>\n-  , div);\n+    </ApolloProvider>,\n+    div\n+  );\n   ReactDOM.unmountComponentAtNode(div);\n });\ndiff --git a/client/src/App.tsx b/client/src/App.tsx\nindex 85131f7..5ddba0c 100644\n--- a/client/src/App.tsx\n+++ b/client/src/App.tsx\n@@ -1,5 +1,10 @@\n import React from 'react';\n-import { BrowserRouter, Route, Redirect, RouteComponentProps } from 'react-router-dom';\n+import {\n+  BrowserRouter,\n+  Route,\n+  Redirect,\n+  RouteComponentProps,\n+} from 'react-router-dom';\n import AuthScreen from './components/AuthScreen';\n import ChatRoomScreen from './components/ChatRoomScreen';\n import ChatsListScreen from './components/ChatsListScreen';\n@@ -10,13 +15,18 @@ import { withAuth } from './services/auth.service';\n const App: React.FC = () => (\n   <BrowserRouter>\n     <AnimatedSwitch>\n-      <Route exact path=\"/sign-in\" component={AuthScreen} />\n+      <Route exact path=\"/sign-(in|up)\" component={AuthScreen} />\n       <Route exact path=\"/chats\" component={withAuth(ChatsListScreen)} />\n\n-      <Route exact path=\"/chats/:chatId\" component={withAuth(\n-        ({ match, history }: RouteComponentProps<{ chatId: string }>) =>\n-        (<ChatRoomScreen chatId={match.params.chatId} history={history} />)\n-      )} />\n+      <Route\n+        exact\n+        path=\"/chats/:chatId\"\n+        component={withAuth(\n+          ({ match, history }: RouteComponentProps<{ chatId: string }>) => (\n+            <ChatRoomScreen chatId={match.params.chatId} history={history} />\n+          )\n+        )}\n+      />\n\n       <Route exact path=\"/new-chat\" component={withAuth(ChatCreationScreen)} />\n     </AnimatedSwitch>\n@@ -24,8 +34,6 @@ const App: React.FC = () => (\n   </BrowserRouter>\n );\n\n-const redirectToChats = () => (\n-  <Redirect to=\"/chats\" />\n-);\n+const redirectToChats = () => <Redirect to=\"/chats\" />;\n\n-export default App;\n\\ No newline at end of file\n+export default App;\ndiff --git a/client/src/client.ts b/client/src/client.ts\nindex 8f5217f..052fc11 100644\n--- a/client/src/client.ts\n+++ b/client/src/client.ts\n@@ -25,12 +25,10 @@ const terminatingLink = split(\n   ({ query }) => {\n     const { kind, operation } = getMainDefinition(query);\n     // If this is a subscription query, use wsLink, otherwise use httpLink\n-    return (\n-      kind === 'OperationDefinition' && operation === 'subscription'\n-    );\n+    return kind === 'OperationDefinition' && operation === 'subscription';\n   },\n   wsLink,\n-  httpLink,\n+  httpLink\n );\n\n const link = ApolloLink.from([terminatingLink]);\ndiff --git a/client/src/components/AnimatedSwitch.tsx b/client/src/components/AnimatedSwitch.tsx\nindex c1f1cbc..8fa5b13 100644\n--- a/client/src/components/AnimatedSwitch.tsx\n+++ b/client/src/components/AnimatedSwitch.tsx\n@@ -3,7 +3,8 @@ import { AnimatedSwitch, spring } from 'react-router-transition';\n import styled from 'styled-components';\n\n // A workaround to make test pass\n-const SwitchComponent = process.env.NODE_ENV === 'test' ? Switch : AnimatedSwitch;\n+const SwitchComponent =\n+  process.env.NODE_ENV === 'test' ? Switch : AnimatedSwitch;\n\n const glide = (val: number) =>\n   spring(val, {\n@@ -11,11 +12,11 @@ const glide = (val: number) =>\n     damping: 24,\n   });\n\n-const mapStyles = (styles :any) => ({\n+const mapStyles = (styles: any) => ({\n   transform: `translateX(${styles.offset}%)`,\n });\n\n-const MyAnimatedSwitch =  styled(SwitchComponent).attrs(() => ({\n+const MyAnimatedSwitch = styled(SwitchComponent).attrs(() => ({\n   atEnter: { offset: 100 },\n   atLeave: { offset: glide(-100) },\n   atActive: { offset: glide(0) },\n@@ -32,6 +33,6 @@ const MyAnimatedSwitch =  styled(SwitchComponent).attrs(() => ({\n     height: 100vh;\n     width: 100vw;\n   }\n-`\n+`;\n\n export default MyAnimatedSwitch;\ndiff --git a/client/src/components/AuthScreen/SignInForm.test.tsx b/client/src/components/AuthScreen/SignInForm.test.tsx\nindex da27593..b52c578 100644\n--- a/client/src/components/AuthScreen/SignInForm.test.tsx\n+++ b/client/src/components/AuthScreen/SignInForm.test.tsx\n@@ -1,81 +1,163 @@\n import { createMemoryHistory } from 'history';\n import React from 'react';\n-import { cleanup, render, fireEvent, wait, waitForElement } from 'react-testing-library';\n+import { ApolloProvider } from '@apollo/react-hooks';\n+import { act, cleanup, render, fireEvent, wait, waitForElement } from '@testing-library/react';\n import SignInForm from './SignInForm';\n+import { SignInDocument } from '../../graphql/types';\n+import { mockApolloClient } from '../../test-helpers';\n\n describe('SignInForm', () => {\n   afterEach(cleanup);\n-  afterEach(() => fetch.resetMocks());\n\n   it('enables sign-in button when filled in', async () => {\n     const history = createMemoryHistory();\n-\n-    {\n-      const { container, getByTestId } = render(<SignInForm history={history} />);\n-      const usernameInput = getByTestId('username-input').querySelector('input');\n-      const passwordInput = getByTestId('password-input').querySelector('input');\n-      const signInButton = getByTestId('sign-in-button') as HTMLButtonElement;\n-\n-      expect(signInButton.disabled).toEqual(true);\n-\n+    const client = mockApolloClient();\n+\n+    let getByTestId: any = null;\n+\n+    act(() => {\n+      getByTestId = render(\n+        <ApolloProvider client={client}>\n+          <SignInForm history={history} />\n+        </ApolloProvider>\n+      ).getByTestId;\n+    });\n+\n+    const signInButton = await waitForElement(() =>\n+      getByTestId('sign-in-button') as HTMLButtonElement\n+    );\n+    const usernameInput = await waitForElement(() =>\n+      getByTestId('username-input').querySelector('input')\n+    );\n+    const passwordInput = await waitForElement(() =>\n+      getByTestId('password-input').querySelector('input')\n+    );\n+\n+    expect(signInButton.disabled).toEqual(true);\n+\n+    act(() => {\n       fireEvent.change(usernameInput, { target: { value: 'username' } });\n       fireEvent.change(passwordInput, { target: { value: 'password' } });\n+    });\n\n-      await waitForElement(() => usernameInput);\n-      await waitForElement(() => passwordInput);\n-\n-      expect(signInButton.disabled).toEqual(false);\n-    }\n+    await wait(() =>\n+      expect(signInButton.disabled).toEqual(false)\n+    )\n   });\n\n   it('prints server error if input was wrong', async () => {\n     const history = createMemoryHistory();\n\n-    fetchMock.mockRejectOnce(new Error('sign-in failed'));\n-\n-    {\n-      const { container, getByTestId } = render(<SignInForm history={history} />);\n-      const usernameInput = getByTestId('username-input').querySelector('input');\n-      const passwordInput = getByTestId('password-input').querySelector('input');\n-      const signInButton = getByTestId('sign-in-button') as HTMLButtonElement;\n-      const errorMessage = getByTestId('error-message');\n-\n+    const client = mockApolloClient([\n+      {\n+        request: {\n+          query: SignInDocument,\n+          variables: {\n+            username: 'username',\n+            password: 'password'\n+          }\n+        },\n+        get result() { throw Error('sign-in failed') },\n+      }\n+    ]);\n+\n+    let getByTestId: any = null;\n+\n+    act(() => {\n+      getByTestId = render(\n+        <ApolloProvider client={client}>\n+          <SignInForm history={history} />\n+        </ApolloProvider>\n+      ).getByTestId;\n+    });\n+\n+    const signInButton = await waitForElement(() =>\n+      getByTestId('sign-in-button') as HTMLButtonElement\n+    );\n+    const usernameInput = await waitForElement(() =>\n+      getByTestId('username-input').querySelector('input')\n+    );\n+    const passwordInput = await waitForElement(() =>\n+      getByTestId('password-input').querySelector('input')\n+    );\n+\n+    act(() => {\n       fireEvent.change(usernameInput, { target: { value: 'username' } });\n       fireEvent.change(passwordInput, { target: { value: 'password' } });\n+    });\n+\n+    await wait(() =>\n+      expect(usernameInput.value).toEqual('username')\n+    );\n\n-      await waitForElement(() => usernameInput);\n-      await waitForElement(() => passwordInput);\n+    await wait(() =>\n+      expect(passwordInput.value).toEqual('password')\n+    );\n\n+    act(() => {\n       fireEvent.click(signInButton);\n+    });\n\n-      await waitForElement(() => errorMessage);\n+    const errorMessage = await waitForElement(() =>\n+      getByTestId('error-message')\n+    );\n\n-      expect(errorMessage.innerHTML).toEqual('sign-in failed');\n-    }\n+    await wait(() => expect(errorMessage.innerHTML).toContain('sign-in failed'));\n   });\n\n   it('navigates to /chats if everything went right', async () => {\n     const history = createMemoryHistory();\n\n-    fetchMock.mockResponseOnce('success');\n-\n-    {\n-      const { container, getByTestId } = render(<SignInForm history={history} />);\n-      const usernameInput = getByTestId('username-input').querySelector('input');\n-      const passwordInput = getByTestId('password-input').querySelector('input');\n-      const signInButton = getByTestId('sign-in-button') as HTMLButtonElement;\n-\n+    const client = mockApolloClient([\n+      {\n+        request: {\n+          query: SignInDocument,\n+          variables: {\n+            username: 'username',\n+            password: 'password'\n+          }\n+        },\n+        result: { data: {} }\n+      }\n+    ]);\n+\n+    let getByTestId: any = null;\n+\n+    act(() => {\n+      getByTestId = render(\n+        <ApolloProvider client={client}>\n+          <SignInForm history={history} />\n+        </ApolloProvider>\n+      ).getByTestId;\n+    })\n+\n+    const usernameInput = await waitForElement(() =>\n+      getByTestId('username-input').querySelector('input')\n+    );\n+    const passwordInput = await waitForElement(() =>\n+      getByTestId('password-input').querySelector('input')\n+    );\n+    const signInButton = await waitForElement(() =>\n+      getByTestId('sign-in-button') as HTMLButtonElement\n+    );\n+\n+    act(() => {\n       fireEvent.change(usernameInput, { target: { value: 'username' } });\n       fireEvent.change(passwordInput, { target: { value: 'password' } });\n+    });\n+\n+    await wait(() =>\n+      expect(usernameInput.value).toEqual('username')\n+    );\n\n-      await waitForElement(() => usernameInput);\n-      await waitForElement(() => passwordInput);\n+    await wait(() =>\n+      expect(passwordInput.value).toEqual('password')\n+    );\n\n+    act(() => {\n       fireEvent.click(signInButton);\n+    });\n\n-      await wait(() =>\n-        expect(history.location.pathname).toEqual('/chats')\n-      );\n-    }\n+    await wait(() => expect(history.location.pathname).toEqual('/chats'));\n   });\n-});\n+});\n\\ No newline at end of file\ndiff --git a/client/src/components/AuthScreen/SignInForm.tsx b/client/src/components/AuthScreen/SignInForm.tsx\nindex fa21d64..cb62e7d 100644\n--- a/client/src/components/AuthScreen/SignInForm.tsx\n+++ b/client/src/components/AuthScreen/SignInForm.tsx\n@@ -1,6 +1,6 @@\n import React from 'react';\n import { useCallback, useState } from 'react';\n-import { signIn } from '../../services/auth.service';\n+import { useSignIn } from '../../services/auth.service';\n import {\n   SignForm,\n   ActualForm,\n@@ -16,6 +16,7 @@ const SignInForm: React.FC<RouteComponentProps<any>> = ({ history }) => {\n   const [username, setUsername] = useState('');\n   const [password, setPassword] = useState('');\n   const [error, setError] = useState('');\n+  const [signIn] = useSignIn();\n\n   const onUsernameChange = useCallback(({ target }) => {\n     setError('');\n@@ -32,14 +33,14 @@ const SignInForm: React.FC<RouteComponentProps<any>> = ({ history }) => {\n   }, [username, password]);\n\n   const handleSignIn = useCallback(() => {\n-    signIn({ username, password })\n+    signIn({ variables: { username, password } })\n       .then(() => {\n-        history.replace('/chats')\n+        history.replace('/chats');\n       })\n       .catch(error => {\n-        setError(error.message || error)\n+        setError(error.message || error);\n       });\n-  }, [username, password, history]);\n+  }, [username, password, history, signIn]);\n\n   return (\n     <SignForm>\n@@ -70,8 +71,7 @@ const SignInForm: React.FC<RouteComponentProps<any>> = ({ history }) => {\n           color=\"secondary\"\n           variant=\"contained\"\n           disabled={!maySignIn()}\n-          onClick={handleSignIn}\n-        >\n+          onClick={handleSignIn}>\n           Sign in\n         </Button>\n         <ErrorMessage data-testid=\"error-message\">{error}</ErrorMessage>\ndiff --git a/client/src/components/AuthScreen/SignUpForm.test.tsx b/client/src/components/AuthScreen/SignUpForm.test.tsx\nindex 669e45d..7582a18 100644\n--- a/client/src/components/AuthScreen/SignUpForm.test.tsx\n+++ b/client/src/components/AuthScreen/SignUpForm.test.tsx\n@@ -1,99 +1,225 @@\n import { createMemoryHistory } from 'history';\n import React from 'react';\n-import { cleanup, render, fireEvent, wait, waitForElement } from 'react-testing-library';\n+import { ApolloProvider } from '@apollo/react-hooks';\n+import { act, cleanup, render, fireEvent, wait, waitForElement } from '@testing-library/react';\n import SignUpForm from './SignUpForm';\n+import { SignUpDocument } from '../../graphql/types';\n+import { mockApolloClient } from '../../test-helpers';\n\n describe('SignUpForm', () => {\n   afterEach(cleanup);\n-  afterEach(() => fetch.resetMocks());\n\n   it('enables sign-up button when filled in', async () => {\n     const history = createMemoryHistory();\n-\n-    {\n-      const { container, getByTestId } = render(<SignUpForm history={history} />);\n-      const nameInput = getByTestId('name-input').querySelector('input');\n-      const usernameInput = getByTestId('username-input').querySelector('input');\n-      const passwordInput = getByTestId('password-input').querySelector('input');\n-      const passwordConfirmInput = getByTestId('password-confirm-input').querySelector('input');\n-      const signUpButton = getByTestId('sign-up-button') as HTMLButtonElement;\n-\n-      expect(signUpButton.disabled).toEqual(true);\n-\n+    const client = mockApolloClient();\n+\n+    let getByTestId: any = null;\n+\n+    act(() => {\n+      getByTestId = render(\n+        <ApolloProvider client={client}>\n+          <SignUpForm history={history} />\n+        </ApolloProvider>\n+      ).getByTestId;\n+    });\n+\n+    const nameInput = await waitForElement(() =>\n+      getByTestId('name-input').querySelector('input')\n+    );\n+    const usernameInput = await waitForElement(() =>\n+      getByTestId('username-input').querySelector('input')\n+    );\n+    const passwordInput = await waitForElement(() =>\n+      getByTestId('password-input').querySelector('input')\n+    );\n+    const passwordConfirmInput = await waitForElement(() =>\n+      getByTestId('password-confirm-input').querySelector('input')\n+    );\n+    const signUpButton = await waitForElement(() =>\n+      getByTestId('sign-up-button') as HTMLButtonElement\n+    );\n+\n+    expect(signUpButton.disabled).toEqual(true);\n+\n+    act(() => {\n       fireEvent.change(nameInput, { target: { value: 'User Name' } });\n       fireEvent.change(usernameInput, { target: { value: 'username' } });\n       fireEvent.change(passwordInput, { target: { value: 'password' } });\n       fireEvent.change(passwordConfirmInput, { target: { value: 'password' } });\n+    });\n+\n+    await wait(() =>\n+      expect(nameInput.value).toEqual('User Name')\n+    );\n\n-      await waitForElement(() => nameInput);\n-      await waitForElement(() => usernameInput);\n-      await waitForElement(() => passwordInput);\n-      await waitForElement(() => passwordConfirmInput);\n+    await wait(() =>\n+      expect(usernameInput.value).toEqual('username')\n+    );\n\n-      expect(signUpButton.disabled).toEqual(false);\n-    }\n+    await wait(() =>\n+      expect(passwordInput.value).toEqual('password')\n+    );\n+\n+    await wait(() =>\n+      expect(passwordConfirmInput.value).toEqual('password')\n+    );\n+\n+    await wait(() =>\n+      expect(signUpButton.disabled).toEqual(false)\n+    )\n   });\n\n   it('prints server error if input was wrong', async () => {\n     const history = createMemoryHistory();\n\n-    fetchMock.mockRejectOnce(new Error('sign-up failed'));\n-\n-    {\n-      const { container, getByTestId } = render(<SignUpForm history={history} />);\n-      const nameInput = getByTestId('name-input').querySelector('input');\n-      const usernameInput = getByTestId('username-input').querySelector('input');\n-      const passwordInput = getByTestId('password-input').querySelector('input');\n-      const passwordConfirmInput = getByTestId('password-confirm-input').querySelector('input');\n-      const signUpButton = getByTestId('sign-up-button') as HTMLButtonElement;\n-      const errorMessage = getByTestId('error-message');\n-\n+    const client = mockApolloClient([\n+      {\n+        request: {\n+          query: SignUpDocument,\n+          variables: {\n+            name: 'User Name',\n+            username: 'username',\n+            password: 'password',\n+            passwordConfirm: 'password'\n+          }\n+        },\n+        get result() { throw Error('sign-up failed') }\n+      }\n+    ]);\n+\n+    let getByTestId: any = null;\n+\n+    act(() => {\n+      getByTestId = render(\n+        <ApolloProvider client={client}>\n+          <SignUpForm history={history} />\n+        </ApolloProvider>\n+      ).getByTestId;\n+    });\n+\n+    const nameInput = await waitForElement(() =>\n+      getByTestId('name-input').querySelector('input')\n+    );\n+    const usernameInput = await waitForElement(() =>\n+      getByTestId('username-input').querySelector('input')\n+    );\n+    const passwordInput = await waitForElement(() =>\n+      getByTestId('password-input').querySelector('input')\n+    );\n+    const passwordConfirmInput = await waitForElement(() =>\n+      getByTestId('password-confirm-input').querySelector('input')\n+    );\n+    const signUpButton = await waitForElement(() =>\n+      getByTestId('sign-up-button') as HTMLButtonElement\n+    );\n+\n+    act(() => {\n       fireEvent.change(nameInput, { target: { value: 'User Name' } });\n       fireEvent.change(usernameInput, { target: { value: 'username' } });\n       fireEvent.change(passwordInput, { target: { value: 'password' } });\n       fireEvent.change(passwordConfirmInput, { target: { value: 'password' } });\n+    });\n\n-      await waitForElement(() => nameInput);\n-      await waitForElement(() => usernameInput);\n-      await waitForElement(() => passwordInput);\n-      await waitForElement(() => passwordConfirmInput);\n+    await wait(() =>\n+      expect(nameInput.value).toEqual('User Name')\n+    );\n\n+    await wait(() =>\n+      expect(usernameInput.value).toEqual('username')\n+    );\n+\n+    await wait(() =>\n+      expect(passwordInput.value).toEqual('password')\n+    );\n+\n+    await wait(() =>\n+      expect(passwordConfirmInput.value).toEqual('password')\n+    );\n+\n+    act(() => {\n       fireEvent.click(signUpButton);\n+    });\n\n-      await waitForElement(() => errorMessage);\n+    const errorMessage = await waitForElement(() =>\n+      getByTestId('error-message')\n+    );\n\n-      expect(errorMessage.innerHTML).toEqual('sign-up failed');\n-    }\n+    await wait(() =>expect(errorMessage.innerHTML).toContain('sign-up failed'));\n   });\n\n   it('navigates to /sign-in if everything went right', async () => {\n     const history = createMemoryHistory();\n\n-    fetchMock.mockResponseOnce('success');\n-\n-    {\n-      const { container, getByTestId } = render(<SignUpForm history={history} />);\n-      const nameInput = getByTestId('name-input').querySelector('input');\n-      const usernameInput = getByTestId('username-input').querySelector('input');\n-      const passwordInput = getByTestId('password-input').querySelector('input');\n-      const passwordConfirmInput = getByTestId('password-confirm-input').querySelector('input');\n-      const signUpButton = getByTestId('sign-up-button') as HTMLButtonElement;\n-\n+    const client = mockApolloClient([\n+      {\n+        request: {\n+          query: SignUpDocument,\n+          variables: {\n+            name: 'User Name',\n+            username: 'username',\n+            password: 'password',\n+            passwordConfirm: 'password'\n+          }\n+        },\n+        result: { data: {} }\n+      }\n+    ]);\n+\n+    let getByTestId: any = null;\n+\n+    act(() => {\n+      getByTestId = render(\n+        <ApolloProvider client={client}>\n+          <SignUpForm history={history} />\n+        </ApolloProvider>\n+      ).getByTestId;\n+    });\n+\n+    const nameInput = await waitForElement(() =>\n+      getByTestId('name-input').querySelector('input')\n+    );\n+    const usernameInput = await waitForElement(() =>\n+      getByTestId('username-input').querySelector('input')\n+    );\n+    const passwordInput = await waitForElement(() =>\n+      getByTestId('password-input').querySelector('input')\n+    );\n+    const passwordConfirmInput = await waitForElement(() =>\n+      getByTestId('password-confirm-input').querySelector('input')\n+    );\n+    const signUpButton = await waitForElement(() =>\n+      getByTestId('sign-up-button') as HTMLButtonElement\n+    );\n+\n+    act(() => {\n       fireEvent.change(nameInput, { target: { value: 'User Name' } });\n       fireEvent.change(usernameInput, { target: { value: 'username' } });\n       fireEvent.change(passwordInput, { target: { value: 'password' } });\n       fireEvent.change(passwordConfirmInput, { target: { value: 'password' } });\n+    });\n+\n+    await wait(() =>\n+      expect(nameInput.value).toEqual('User Name')\n+    );\n+\n+    await wait(() =>\n+      expect(usernameInput.value).toEqual('username')\n+    );\n+\n+    await wait(() =>\n+      expect(passwordInput.value).toEqual('password')\n+    );\n\n-      await waitForElement(() => nameInput);\n-      await waitForElement(() => usernameInput);\n-      await waitForElement(() => passwordInput);\n-      await waitForElement(() => passwordConfirmInput);\n+    await wait(() =>\n+      expect(passwordConfirmInput.value).toEqual('password')\n+    );\n\n+    act(() => {\n       fireEvent.click(signUpButton);\n+    });\n\n-      await wait(() =>\n-        expect(history.location.pathname).toEqual('/sign-in')\n-      );\n-    }\n+    await wait(() =>\n+      expect(history.location.pathname).toEqual('/sign-in')\n+    );\n   });\n-});\n+});\n\\ No newline at end of file\ndiff --git a/client/src/components/AuthScreen/SignUpForm.tsx b/client/src/components/AuthScreen/SignUpForm.tsx\nindex b7fcd69..6515138 100644\n--- a/client/src/components/AuthScreen/SignUpForm.tsx\n+++ b/client/src/components/AuthScreen/SignUpForm.tsx\n@@ -1,6 +1,6 @@\n import React from 'react';\n import { useCallback, useState } from 'react';\n-import { signUp } from '../../services/auth.service';\n+import { useSignUp } from '../../services/auth.service';\n import {\n   SignForm,\n   ActualForm,\n@@ -18,6 +18,7 @@ const SignUpForm: React.FC<RouteComponentProps<any>> = ({ history }) => {\n   const [password, setPassword] = useState('');\n   const [passwordConfirm, setPasswordConfirm] = useState('');\n   const [error, setError] = useState('');\n+  const [signUp] = useSignUp()\n\n   const updateName = useCallback(({ target }) => {\n     setError('');\n@@ -44,14 +45,14 @@ const SignUpForm: React.FC<RouteComponentProps<any>> = ({ history }) => {\n   }, [name, username, password, passwordConfirm]);\n\n   const handleSignUp = useCallback(() => {\n-    signUp({ username, password, passwordConfirm, name })\n+    signUp({ variables: { username, password, passwordConfirm, name } })\n       .then(() => {\n-        history.replace('/sign-in')\n+        history.replace('/sign-in');\n       })\n       .catch(error => {\n-        setError(error.message || error)\n+        setError(error.message || error);\n       });\n-  }, [name, username, password, passwordConfirm, history]);\n+  }, [name, username, password, passwordConfirm, history, signUp]);\n\n   return (\n     <SignForm>\n@@ -62,8 +63,7 @@ const SignUpForm: React.FC<RouteComponentProps<any>> = ({ history }) => {\n             float: 'left',\n             width: 'calc(50% - 10px)',\n             paddingRight: '10px',\n-          }}\n-        >\n+          }}>\n           <TextField\n             data-testid=\"name-input\"\n             label=\"Name\"\n@@ -86,8 +86,7 @@ const SignUpForm: React.FC<RouteComponentProps<any>> = ({ history }) => {\n             float: 'right',\n             width: 'calc(50% - 10px)',\n             paddingLeft: '10px',\n-          }}\n-        >\n+          }}>\n           <TextField\n             data-testid=\"password-input\"\n             label=\"Password\"\n@@ -113,8 +112,7 @@ const SignUpForm: React.FC<RouteComponentProps<any>> = ({ history }) => {\n           color=\"secondary\"\n           variant=\"contained\"\n           disabled={!maySignUp()}\n-          onClick={handleSignUp}\n-        >\n+          onClick={handleSignUp}>\n           Sign up\n         </Button>\n         <ErrorMessage data-testid=\"error-message\">{error}</ErrorMessage>\n@@ -123,4 +121,4 @@ const SignUpForm: React.FC<RouteComponentProps<any>> = ({ history }) => {\n   );\n };\n\n-export default SignUpForm;\n\\ No newline at end of file\n+export default SignUpForm;\ndiff --git a/client/src/components/AuthScreen/form-components.ts b/client/src/components/AuthScreen/form-components.ts\nindex 00c8c9d..124082b 100644\n--- a/client/src/components/AuthScreen/form-components.ts\n+++ b/client/src/components/AuthScreen/form-components.ts\n@@ -2,28 +2,28 @@ import MaterialButton from '@material-ui/core/Button';\n import MaterialTextField from '@material-ui/core/TextField';\n import styled from 'styled-components';\n\n-export const SignForm = styled.div `\n+export const SignForm = styled.div`\n   height: calc(100% - 265px);\n `;\n\n-export const ActualForm = styled.form `\n+export const ActualForm = styled.form`\n   padding: 20px;\n `;\n\n-export const Section = styled.div `\n+export const Section = styled.div`\n   padding-bottom: 35px;\n `;\n\n-export const Legend = styled.legend `\n+export const Legend = styled.legend`\n   font-weight: bold;\n   color: white;\n `;\n\n-export const Label = styled.label `\n+export const Label = styled.label`\n   color: white !important;\n `;\n\n-export const Input = styled.input `\n+export const Input = styled.input`\n   color: white;\n\n   &::placeholder {\n@@ -31,7 +31,7 @@ export const Input = styled.input `\n   }\n `;\n\n-export const TextField = styled(MaterialTextField) `\n+export const TextField = styled(MaterialTextField)`\n   width: 100%;\n   position: relative;\n\n@@ -50,9 +50,9 @@ export const TextField = styled(MaterialTextField) `\n   label {\n     color: white !important;\n   }\n-` as typeof MaterialTextField;\n+`;\n\n-export const Button = styled(MaterialButton) `\n+export const Button = styled(MaterialButton)`\n   width: 100px;\n   display: block !important;\n   margin: auto !important;\n@@ -65,9 +65,9 @@ export const Button = styled(MaterialButton) `\n   &:not([disabled]) {\n     color: white;\n   }\n-` as typeof MaterialButton;\n+`;\n\n-export const ErrorMessage = styled.div `\n+export const ErrorMessage = styled.div`\n   position: fixed;\n   color: red;\n   font-size: 15px;\ndiff --git a/client/src/components/AuthScreen/index.tsx b/client/src/components/AuthScreen/index.tsx\nindex c6cdfe0..ed009c8 100644\n--- a/client/src/components/AuthScreen/index.tsx\n+++ b/client/src/components/AuthScreen/index.tsx\n@@ -7,7 +7,7 @@ import SignInForm from './SignInForm';\n import SignUpForm from './SignUpForm';\n import { RouteComponentProps } from 'react-router-dom';\n\n-const Container = styled.div `\n+const Container = styled.div`\n   background: radial-gradient(rgb(34, 65, 67), rgb(17, 48, 50)),\n     url(/assets/chat-background.jpg) no-repeat;\n   background-size: cover;\n@@ -15,11 +15,11 @@ const Container = styled.div `\n   color: white;\n `;\n\n-const Intro = styled.div `\n+const Intro = styled.div`\n   height: 265px;\n `;\n\n-const Icon = styled.img `\n+const Icon = styled.img`\n   width: 125px;\n   height: auto;\n   margin-left: auto;\n@@ -28,14 +28,14 @@ const Icon = styled.img `\n   display: block;\n `;\n\n-const Title = styled.h2 `\n+const Title = styled.h2`\n   width: 100%;\n   text-align: center;\n   color: white;\n `;\n\n // eslint-disable-next-line\n-const Alternative = styled.div `\n+const Alternative = styled.div`\n   position: fixed;\n   bottom: 10px;\n   left: 10px;\n@@ -45,7 +45,10 @@ const Alternative = styled.div `\n   }\n `;\n\n-const AuthScreen: React.FC<RouteComponentProps<any>> = ({ history, location }) => {\n+const AuthScreen: React.FC<RouteComponentProps<any>> = ({\n+  history,\n+  location,\n+}) => {\n   const alternative = useMemo(() => {\n     if (location.pathname === '/sign-in') {\n       const handleSignUp = () => {\n@@ -54,11 +57,11 @@ const AuthScreen: React.FC<RouteComponentProps<any>> = ({ history, location }) =\n\n       return (\n         <Alternative>\n-          Don't have an account yet? <label onClick={handleSignUp}>Sign up!</label>\n+          Don't have an account yet?{' '}\n+          <label onClick={handleSignUp}>Sign up!</label>\n         </Alternative>\n       );\n-    }\n-    else {\n+    } else {\n       const handleSignIn = () => {\n         history.replace('/sign-in');\n       };\n@@ -86,4 +89,4 @@ const AuthScreen: React.FC<RouteComponentProps<any>> = ({ history, location }) =\n   );\n };\n\n-export default AuthScreen;\n\\ No newline at end of file\n+export default AuthScreen;\ndiff --git a/client/src/components/ChatCreationScreen/ChatCreationNavbar.test.tsx b/client/src/components/ChatCreationScreen/ChatCreationNavbar.test.tsx\nindex 0454ed0..5490495 100644\n--- a/client/src/components/ChatCreationScreen/ChatCreationNavbar.test.tsx\n+++ b/client/src/components/ChatCreationScreen/ChatCreationNavbar.test.tsx\n@@ -1,6 +1,6 @@\n import { createMemoryHistory } from 'history';\n import React from 'react';\n-import { cleanup, render, fireEvent, wait } from 'react-testing-library';\n+import { cleanup, render, fireEvent, wait } from '@testing-library/react';\n import ChatCreationNavbar from './ChatCreationNavbar';\n\n describe('ChatCreationNavbar', () => {\n@@ -11,18 +11,16 @@ describe('ChatCreationNavbar', () => {\n\n     history.push('/new-chat');\n\n-    await wait(() =>\n-      expect(history.location.pathname).toEqual('/new-chat')\n-    );\n+    await wait(() => expect(history.location.pathname).toEqual('/new-chat'));\n\n     {\n-      const { container, getByTestId } = render(<ChatCreationNavbar history={history} />);\n+      const { container, getByTestId } = render(\n+        <ChatCreationNavbar history={history} />\n+      );\n\n       fireEvent.click(getByTestId('back-button'));\n\n-      await wait(() =>\n-        expect(history.location.pathname).toEqual('/chats')\n-      );\n+      await wait(() => expect(history.location.pathname).toEqual('/chats'));\n     }\n   });\n });\ndiff --git a/client/src/components/ChatCreationScreen/ChatCreationNavbar.tsx b/client/src/components/ChatCreationScreen/ChatCreationNavbar.tsx\nindex c537475..794c15c 100644\n--- a/client/src/components/ChatCreationScreen/ChatCreationNavbar.tsx\n+++ b/client/src/components/ChatCreationScreen/ChatCreationNavbar.tsx\n@@ -5,27 +5,27 @@ import { useCallback } from 'react';\n import styled from 'styled-components';\n import { History } from 'history';\n\n-const Container = styled(Toolbar) `\n+const Container = styled(Toolbar)`\n   display: flex;\n   background-color: var(--primary-bg);\n   color: var(--primary-text);\n   font-size: 20px;\n   line-height: 40px;\n-` as typeof Toolbar;\n+`;\n\n-const BackButton = styled(Button) `\n+const BackButton = styled(Button)`\n   svg {\n     color: var(--primary-text);\n   }\n-` as typeof Button;\n+`;\n\n-const Title = styled.div `\n+const Title = styled.div`\n   flex: 1;\n `;\n\n interface ChildComponentProps {\n   history: History;\n-};\n+}\n\n const ChatCreationNavbar: React.FC<ChildComponentProps> = ({ history }) => {\n   const navBack = useCallback(() => {\n@@ -42,5 +42,4 @@ const ChatCreationNavbar: React.FC<ChildComponentProps> = ({ history }) => {\n   );\n };\n\n-\n export default ChatCreationNavbar;\ndiff --git a/client/src/components/ChatCreationScreen/index.tsx b/client/src/components/ChatCreationScreen/index.tsx\nindex 70f8a5a..a9b3cc8 100644\n--- a/client/src/components/ChatCreationScreen/index.tsx\n+++ b/client/src/components/ChatCreationScreen/index.tsx\n@@ -10,13 +10,13 @@ import { useAddChatMutation } from '../../graphql/types';\n import { writeChat } from '../../services/cache.service';\n\n // eslint-disable-next-line\n-const Container = styled.div `\n+const Container = styled.div`\n   height: calc(100% - 56px);\n   overflow-y: overlay;\n `;\n\n // eslint-disable-next-line\n-const StyledUsersList = styled(UsersList) `\n+const StyledUsersList = styled(UsersList)`\n   height: calc(100% - 56px);\n `;\n\n@@ -31,36 +31,38 @@ gql`\n\n interface ChildComponentProps {\n   history: History;\n-};\n+}\n\n const ChatCreationScreen: React.FC<ChildComponentProps> = ({ history }) => {\n-  const addChat = useAddChatMutation({\n-    update: (client, { data: { addChat } }) => {\n-      writeChat(client, addChat);\n-    }\n-  });\n+  const [addChat] = useAddChatMutation();\n\n-  const onUserPick = useCallback((user) => {\n-    addChat({\n-      optimisticResponse: {\n-        __typename: 'Mutation',\n-        addChat: {\n-          __typename: 'Chat',\n-          id: Math.random().toString(36).substr(2, 9),\n-          name: user.name,\n-          picture: user.picture,\n-          lastMessage: null,\n+  const onUserPick = useCallback(\n+    user => addChat({\n+        optimisticResponse: {\n+          __typename: 'Mutation',\n+          addChat: {\n+            __typename: 'Chat',\n+            id: Math.random()\n+              .toString(36)\n+              .substr(2, 9),\n+            name: user.name,\n+            picture: user.picture,\n+            lastMessage: null,\n+          },\n+        },\n+        variables: {\n+          recipientId: user.id,\n         },\n-      },\n-      variables: {\n-        recipientId: user.id,\n-      },\n-    }).then(({ data }) => {\n-      if (data !== null) {\n-        history.push(`/chats/${data.addChat.id}`);\n-      }\n-    })\n-  }, [addChat, history]);\n+        update: (client, { data: { addChat } }) => {\n+          writeChat(client, addChat);\n+        },\n+      }).then(result => {\n+        if (result && result.data !== null) {\n+          history.push(`/chats/${result.data!.addChat!.id}`);\n+        }\n+      }),\n+    [addChat, history]\n+  );\n\n   return (\n     <div>\ndiff --git a/client/src/components/ChatRoomScreen/ChatNavbar.test.tsx b/client/src/components/ChatRoomScreen/ChatNavbar.test.tsx\nindex 9c61f69..8659b0c 100644\n--- a/client/src/components/ChatRoomScreen/ChatNavbar.test.tsx\n+++ b/client/src/components/ChatRoomScreen/ChatNavbar.test.tsx\n@@ -1,7 +1,7 @@\n import { createMemoryHistory } from 'history';\n import React from 'react';\n-import { ApolloProvider } from 'react-apollo-hooks';\n-import { cleanup, render, fireEvent, wait } from 'react-testing-library';\n+import { ApolloProvider } from '@apollo/react-hooks';\n+import { cleanup, render, fireEvent, wait } from '@testing-library/react';\n import { mockApolloClient } from '../../test-helpers';\n import ChatNavbar from './ChatNavbar';\n import { RemoveChatDocument } from '../../graphql/types';\n@@ -12,40 +12,69 @@ describe('ChatNavbar', () => {\n   it('renders chat data', () => {\n     const client = mockApolloClient();\n\n+    const time = new Date('1 Jan 2019 GMT');\n     const chat = {\n       id: '1',\n       name: 'Foo Bar',\n       picture: 'https://localhost:4000/picture.jpg',\n+      messages: [\n+        {\n+          id: '1',\n+          content: 'foo',\n+          createdAt: time,\n+        },\n+        {\n+          id: '2',\n+          content: 'bar',\n+          createdAt: time,\n+        },\n+      ]\n     };\n\n+    const history = createMemoryHistory();\n+\n     {\n       const { container, getByTestId } = render(\n         <ApolloProvider client={client}>\n-          <ChatNavbar chat={chat} />\n+          <ChatNavbar chat={chat} history={history}/>\n         </ApolloProvider>\n       );\n\n       expect(getByTestId('chat-name')).toHaveTextContent('Foo Bar');\n-      expect(getByTestId('chat-picture')).toHaveAttribute('src', 'https://localhost:4000/picture.jpg');\n+      expect(getByTestId('chat-picture')).toHaveAttribute(\n+        'src',\n+        'https://localhost:4000/picture.jpg'\n+      );\n     }\n-  })\n+  });\n\n   it('goes back on arrow click', async () => {\n     const client = mockApolloClient();\n\n+    const time = new Date('1 Jan 2019 GMT');\n     const chat = {\n       id: '1',\n       name: 'Foo Bar',\n       picture: 'https://localhost:4000/picture.jpg',\n+      messages: [\n+        {\n+          id: '1',\n+          content: 'foo',\n+          createdAt: time,\n+        },\n+        {\n+          id: '2',\n+          content: 'bar',\n+          createdAt: time,\n+        },\n+      ]\n     };\n\n     const history = createMemoryHistory();\n\n     history.push('/chats/1');\n\n-    await wait(() =>\n-      expect(history.location.pathname).toEqual('/chats/1')\n-    )\n+    await wait(() => expect(history.location.pathname).toEqual('/chats/1'));\n\n     {\n       const { container, getByTestId } = render(\n@@ -56,9 +85,7 @@ describe('ChatNavbar', () => {\n\n       fireEvent.click(getByTestId('back-button'));\n\n-      await wait(() =>\n-        expect(history.location.pathname).toEqual('/chats')\n-      );\n+      await wait(() => expect(history.location.pathname).toEqual('/chats'));\n     }\n   });\n\n@@ -71,25 +98,36 @@ describe('ChatNavbar', () => {\n         },\n         result: {\n           data: {\n-            removeChat: '1'\n-          }\n-        }\n+            removeChat: '1',\n+          },\n+        },\n       },\n     ]);\n\n+    const time = new Date('1 Jan 2019 GMT');\n     const chat = {\n       id: '1',\n       name: 'Foo Bar',\n       picture: 'https://localhost:4000/picture.jpg',\n+      messages: [\n+        {\n+          id: '1',\n+          content: 'foo',\n+          createdAt: time,\n+        },\n+        {\n+          id: '2',\n+          content: 'bar',\n+          createdAt: time,\n+        },\n+      ]\n     };\n\n     const history = createMemoryHistory();\n\n     history.push('/chats/1');\n\n-    await wait(() =>\n-      expect(history.location.pathname).toEqual('/chats/1')\n-    );\n+    await wait(() => expect(history.location.pathname).toEqual('/chats/1'));\n\n     {\n       const { container, getByTestId } = render(\n@@ -100,9 +138,7 @@ describe('ChatNavbar', () => {\n\n       fireEvent.click(getByTestId('delete-button'));\n\n-      await wait(() =>\n-        expect(history.location.pathname).toEqual('/chats')\n-      );\n+      await wait(() => expect(history.location.pathname).toEqual('/chats'));\n     }\n-  })\n-});\n\\ No newline at end of file\n+  });\n+});\ndiff --git a/client/src/components/ChatRoomScreen/ChatNavbar.tsx b/client/src/components/ChatRoomScreen/ChatNavbar.tsx\nindex 92f06ab..579e973 100644\n--- a/client/src/components/ChatRoomScreen/ChatNavbar.tsx\n+++ b/client/src/components/ChatRoomScreen/ChatNavbar.tsx\n@@ -10,27 +10,27 @@ import { History } from 'history';\n import { useRemoveChatMutation } from '../../graphql/types';\n import { eraseChat } from '../../services/cache.service';\n\n-const Container = styled(Toolbar) `\n+const Container = styled(Toolbar)`\n   padding: 0;\n   display: flex;\n   flex-direction: row;\n   background-color: var(--primary-bg);\n   color: var(--primary-text);\n-` as typeof Toolbar;\n+`;\n\n-const BackButton = styled(Button) `\n+const BackButton = styled(Button)`\n   svg {\n     color: var(--primary-text);\n   }\n-` as typeof Button;\n+`;\n\n-const Rest = styled.div `\n+const Rest = styled.div`\n   flex: 1;\n   display: flex;\n   justify-content: flex-end;\n-`\n+`;\n\n-const Picture = styled.img `\n+const Picture = styled.img`\n   height: 40px;\n   width: 40px;\n   margin-top: 3px;\n@@ -40,13 +40,13 @@ const Picture = styled.img `\n   border-radius: 50%;\n `;\n\n-const Name = styled.div `\n+const Name = styled.div`\n   line-height: 56px;\n `;\n\n const DeleteButton = styled(Button)`\n   color: var(--primary-text) !important;\n-` as typeof Button;\n+`;\n\n export const removeChatMutation = gql`\n   mutation RemoveChat($chatId: ID!) {\n@@ -61,21 +61,21 @@ interface ChatNavbarProps {\n     name?: string | null;\n     id: string;\n   };\n-};\n+}\n\n const ChatNavbar: React.FC<ChatNavbarProps> = ({ chat, history }) => {\n-  const removeChat = useRemoveChatMutation({\n+  const [removeChat] = useRemoveChatMutation({\n     variables: {\n-      chatId: chat.id\n+      chatId: chat.id,\n     },\n     update: (client, { data: { removeChat } }) => {\n       eraseChat(client, removeChat);\n-    }\n+    },\n   });\n\n   const handleRemoveChat = useCallback(() => {\n     removeChat().then(() => {\n-      history.replace('/chats')\n+      history.replace('/chats');\n     });\n   }, [removeChat, history]);\n\n@@ -103,4 +103,4 @@ const ChatNavbar: React.FC<ChatNavbarProps> = ({ chat, history }) => {\n   );\n };\n\n-export default ChatNavbar;\n\\ No newline at end of file\n+export default ChatNavbar;\ndiff --git a/client/src/components/ChatRoomScreen/MessageInput.test.tsx b/client/src/components/ChatRoomScreen/MessageInput.test.tsx\nindex 973de60..dfe35e7 100644\n--- a/client/src/components/ChatRoomScreen/MessageInput.test.tsx\n+++ b/client/src/components/ChatRoomScreen/MessageInput.test.tsx\n@@ -1,6 +1,12 @@\n import { createMemoryHistory } from 'history';\n import React from 'react';\n-import { cleanup, render, fireEvent, wait, waitForElement } from 'react-testing-library';\n+import {\n+  cleanup,\n+  render,\n+  fireEvent,\n+  wait,\n+  waitForElement,\n+} from '@testing-library/react';\n import MessageInput from './MessageInput';\n\n describe('MessageInput;', () => {\n@@ -10,7 +16,9 @@ describe('MessageInput;', () => {\n     const onSendMessage = jest.fn(() => {});\n\n     {\n-      const { container, getByTestId } = render(<MessageInput onSendMessage={onSendMessage} />);\n+      const { container, getByTestId } = render(\n+        <MessageInput onSendMessage={onSendMessage} />\n+      );\n       const messageInput = getByTestId('message-input');\n       const sendButton = getByTestId('send-button');\n\n@@ -20,9 +28,7 @@ describe('MessageInput;', () => {\n\n       fireEvent.click(sendButton);\n\n-      await wait(() =>\n-        expect(onSendMessage.mock.calls.length).toBe(1)\n-      );\n+      await wait(() => expect(onSendMessage.mock.calls.length).toBe(1));\n     }\n   });\n\n@@ -30,18 +36,22 @@ describe('MessageInput;', () => {\n     const onSendMessage = jest.fn(() => {});\n\n     {\n-      const { container, getByTestId } = render(<MessageInput onSendMessage={onSendMessage} />);\n+      const { container, getByTestId } = render(\n+        <MessageInput onSendMessage={onSendMessage} />\n+      );\n       const messageInput = getByTestId('message-input');\n\n       fireEvent.change(messageInput, { target: { value: 'foo' } });\n\n       await waitForElement(() => messageInput);\n\n-      fireEvent.keyPress(messageInput, { key: 'Enter', code: 13, charCode: 13 });\n+      fireEvent.keyPress(messageInput, {\n+        key: 'Enter',\n+        code: 13,\n+        charCode: 13,\n+      });\n\n-      await wait(() =>\n-        expect(onSendMessage.mock.calls.length).toBe(1)\n-      );\n+      await wait(() => expect(onSendMessage.mock.calls.length).toBe(1));\n     }\n   });\n-});\n\\ No newline at end of file\n+});\ndiff --git a/client/src/components/ChatRoomScreen/MessageInput.tsx b/client/src/components/ChatRoomScreen/MessageInput.tsx\nindex 266cfbd..e28bd55 100644\n--- a/client/src/components/ChatRoomScreen/MessageInput.tsx\n+++ b/client/src/components/ChatRoomScreen/MessageInput.tsx\n@@ -11,7 +11,7 @@ const Container = styled.div`\n   width: calc(100% - 10px);\n `;\n\n-const ActualInput = styled.input `\n+const ActualInput = styled.input`\n   width: calc(100% - 50px);\n   border: none;\n   border-radius: 999px;\n@@ -25,7 +25,7 @@ const ActualInput = styled.input `\n   line-height: 45px;\n `;\n\n-const SendButton = styled(Button) `\n+const SendButton = styled(Button)`\n   min-width: 50px !important;\n   width: 50px !important;\n   border-radius: 999px !important;\n@@ -38,14 +38,14 @@ const SendButton = styled(Button) `\n   svg {\n     margin-left: -3px;\n   }\n-` as typeof Button;\n+`;\n\n interface MessageInputProps {\n   onSendMessage(content: string): any;\n }\n\n const MessageInput: React.FC<MessageInputProps> = ({ onSendMessage }) => {\n-  const [message, setMessage] = useState(\"\");\n+  const [message, setMessage] = useState('');\n\n   const onKeyPress = (e: any) => {\n     if (e.charCode === 13) {\n@@ -60,9 +60,9 @@ const MessageInput: React.FC<MessageInputProps> = ({ onSendMessage }) => {\n   const submitMessage = () => {\n     if (!message) return;\n\n-    setMessage(\"\");\n+    setMessage('');\n\n-    if (typeof onSendMessage === \"function\") {\n+    if (typeof onSendMessage === 'function') {\n       onSendMessage(message);\n     }\n   };\n@@ -81,12 +81,11 @@ const MessageInput: React.FC<MessageInputProps> = ({ onSendMessage }) => {\n         data-testid=\"send-button\"\n         variant=\"contained\"\n         color=\"primary\"\n-        onClick={submitMessage}\n-      >\n+        onClick={submitMessage}>\n         <SendIcon />\n       </SendButton>\n     </Container>\n   );\n };\n\n-export default MessageInput;\n\\ No newline at end of file\n+export default MessageInput;\ndiff --git a/client/src/components/ChatRoomScreen/MessagesList.test.tsx b/client/src/components/ChatRoomScreen/MessagesList.test.tsx\nindex 57aa03d..d5c1333 100644\n--- a/client/src/components/ChatRoomScreen/MessagesList.test.tsx\n+++ b/client/src/components/ChatRoomScreen/MessagesList.test.tsx\n@@ -1,37 +1,47 @@\n import { createMemoryHistory } from 'history';\n import React from 'react';\n-import { cleanup, render, fireEvent, wait, getByTestId } from 'react-testing-library';\n+import {\n+  cleanup,\n+  render,\n+  fireEvent,\n+  wait,\n+  getByTestId,\n+} from '@testing-library/react';\n import MessagesList from './MessagesList';\n\n describe('MessagesList', () => {\n   afterEach(cleanup);\n\n+  const time = new Date('1 Jan 2019 GMT');\n+\n   it('renders messages data', () => {\n     const messages = [\n       {\n         id: '1',\n         content: 'foo',\n-        createdAt: new Date('14 Jun 2017 00:00:00 PDT').toUTCString(),\n+        createdAt: time,\n       },\n       {\n         id: '2',\n         content: 'bar',\n-        createdAt: new Date('17 Jun 2017 00:01:00 PDT').toUTCString(),\n+        createdAt: time,\n       },\n     ];\n\n     let message1, message2;\n     {\n-      const { container, getAllByTestId, getByTestId } = render(<MessagesList messages={messages} />);\n+      const { container, getAllByTestId, getByTestId } = render(\n+        <MessagesList messages={messages} />\n+      );\n       const match = getAllByTestId('message-item');\n       message1 = match[0];\n       message2 = match[1];\n     }\n\n     expect(getByTestId(message1, 'message-content')).toHaveTextContent('foo');\n-    expect(getByTestId(message1, 'message-date')).toHaveTextContent('10:00');\n+    expect(getByTestId(message1, 'message-date')).toHaveTextContent('02:00');\n\n     expect(getByTestId(message2, 'message-content')).toHaveTextContent('bar');\n-    expect(getByTestId(message2, 'message-date')).toHaveTextContent('10:01');\n+    expect(getByTestId(message2, 'message-date')).toHaveTextContent('02:00');\n   });\n-});\n\\ No newline at end of file\n+});\ndiff --git a/client/src/components/ChatRoomScreen/MessagesList.tsx b/client/src/components/ChatRoomScreen/MessagesList.tsx\nindex 5a6d418..7597c8a 100644\n--- a/client/src/components/ChatRoomScreen/MessagesList.tsx\n+++ b/client/src/components/ChatRoomScreen/MessagesList.tsx\n@@ -1,21 +1,34 @@\n-import moment from 'moment';\n+import format from 'date-fns/format';\n import React from 'react';\n import { useEffect, useRef } from 'react';\n-import ReactDOM from 'react-dom';\n import styled, { css } from 'styled-components';\n+import { useInfiniteScroll } from '../../hooks/use-infinite-scroll';\n+import { useAdjustedScroll } from '../../hooks/use-adjusted-scroll';\n\n const Container = styled.div`\n+  position: relative;\n   display: block;\n   flex: 2;\n   overflow-y: overlay;\n   padding: 0 15px;\n `;\n\n-type StyledProp = {\n+const LoadingMore = styled.div`\n+  height: 30px;\n+  line-height: 30px;\n+  position: absolute;\n+  top: 0;\n+  right: 0;\n+  bottom: 0;\n+  left: 0;\n+  text-align: center;\n+`;\n+\n+type StyledProp = {\n   isMine: any;\n };\n\n-const MessageItem = styled.div `\n+const MessageItem = styled.div`\n   display: inline-block;\n   position: relative;\n   max-width: 100%;\n@@ -42,36 +55,39 @@ const MessageItem = styled.div `\n     background-size: contain;\n   }\n\n-  ${(props: StyledProp) => props.isMine ? css `\n-    float: right;\n-    background-color: #dcf8c6;\n-\n-    &::before {\n-      right: -11px;\n-      background-image: url(/assets/message-mine.png);\n-    }\n-  ` : css `\n-    float: left;\n-    background-color: #fff;\n-\n-    &::before {\n-      left: -11px;\n-      background-image: url(/assets/message-other.png);\n-    }\n-  `}\n+  ${(props: StyledProp) =>\n+    props.isMine\n+      ? css`\n+          float: right;\n+          background-color: #dcf8c6;\n+\n+          &::before {\n+            right: -11px;\n+            background-image: url(/assets/message-mine.png);\n+          }\n+        `\n+      : css`\n+          float: left;\n+          background-color: #fff;\n+\n+          &::before {\n+            left: -11px;\n+            background-image: url(/assets/message-other.png);\n+          }\n+        `}\n `;\n\n-const Contents = styled.div `\n+const Contents = styled.div`\n   padding: 5px 7px;\n   word-wrap: break-word;\n\n   &::after {\n-    content: ' \\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0';\n+    content: ' \\\\00a0\\\\00a0\\\\00a0\\\\00a0\\\\00a0\\\\00a0\\\\00a0\\\\00a0\\\\00a0\\\\00a0\\\\00a0\\\\00a0\\\\00a0\\\\00a0\\\\00a0\\\\00a0\\\\00a0\\\\00a0\\\\00a0';\n     display: inline;\n   }\n `;\n\n-const Timestamp = styled.div `\n+const Timestamp = styled.div`\n   position: absolute;\n   bottom: 2px;\n   right: 7px;\n@@ -86,31 +102,51 @@ interface Message {\n }\n interface MessagesListProps {\n   messages: Array<Message>;\n+  loadMore: Function;\n+  hasMore: boolean;\n }\n\n-const MessagesList: React.FC<MessagesListProps> = ({ messages }) => {\n-  const selfRef = useRef(null);\n+const MessagesList: React.FC<MessagesListProps> = ({\n+  messages,\n+  loadMore,\n+  hasMore,\n+}) => {\n+  const selfRef = useRef<HTMLDivElement>(null);\n+  const [fetching, stopFetching] = useInfiniteScroll({\n+    onLoadMore: loadMore,\n+    hasMore,\n+    ref: selfRef!,\n+  });\n+  const adjustScroll = useAdjustedScroll(selfRef);\n\n   useEffect(() => {\n     if (!selfRef.current) return;\n-    const selfDOMNode = ReactDOM.findDOMNode(selfRef.current) as HTMLElement;\n-    selfDOMNode.scrollTop = Number.MAX_SAFE_INTEGER;\n-  }, [messages.length]);\n+\n+    if (fetching) {\n+      stopFetching();\n+      adjustScroll();\n+    } else {\n+      // scroll to the most recent message\n+      adjustScroll(true);\n+    }\n+  }, [messages.length, selfRef, fetching, stopFetching, adjustScroll]);\n\n   return (\n     <Container ref={selfRef}>\n+      {fetching && <LoadingMore>{'Loading more messages...'}</LoadingMore>}\n       {messages.map((message: any) => (\n         <MessageItem\n           data-testid=\"message-item\"\n           isMine={message.isMine}\n-          key={message.id}\n-        >\n+          key={message.id}>\n           <Contents data-testid=\"message-content\">{message.content}</Contents>\n-          <Timestamp data-testid=\"message-date\">{moment(message.createdAt).format('HH:mm')}</Timestamp>\n+          <Timestamp data-testid=\"message-date\">\n+            {format(message.createdAt, 'HH:mm')}\n+          </Timestamp>\n         </MessageItem>\n       ))}\n     </Container>\n   );\n };\n\n-export default MessagesList;\n\\ No newline at end of file\n+export default MessagesList;\ndiff --git a/client/src/components/ChatRoomScreen/index.tsx b/client/src/components/ChatRoomScreen/index.tsx\nindex f109d67..1d80607 100644\n--- a/client/src/components/ChatRoomScreen/index.tsx\n+++ b/client/src/components/ChatRoomScreen/index.tsx\n@@ -1,17 +1,24 @@\n import gql from 'graphql-tag';\n import React from 'react';\n-import { useCallback } from 'react';\n+import { useCallback, useState, useContext, useEffect } from 'react';\n import { Redirect } from 'react-router-dom';\n+import { useApolloClient } from '@apollo/react-hooks';\n import styled from 'styled-components';\n import ChatNavbar from './ChatNavbar';\n import MessageInput from './MessageInput';\n import MessagesList from './MessagesList';\n import { History } from 'history';\n-import { useGetChatQuery, useAddMessageMutation } from '../../graphql/types';\n+import {\n+  useGetChatQuery,\n+  useAddMessageMutation,\n+  GetChatQuery,\n+  GetChatQueryVariables,\n+  GetChatDocument,\n+} from '../../graphql/types';\n import * as fragments from '../../graphql/fragments';\n import { writeMessage } from '../../services/cache.service';\n\n- const Container = styled.div `\n+const Container = styled.div`\n   background: url(/assets/chat-background.jpg);\n   display: flex;\n   flex-flow: column;\n@@ -19,8 +26,8 @@ import { writeMessage } from '../../services/cache.service';\n `;\n\n // eslint-disable-next-line\n-const getChatQuery = gql `\n-  query GetChat($chatId: ID!) {\n+const getChatQuery = gql`\n+  query GetChat($chatId: ID!, $limit: Int!, $after: Float) {\n     chat(chatId: $chatId) {\n       ...FullChat\n     }\n@@ -29,7 +36,7 @@ const getChatQuery = gql `\n `;\n\n // eslint-disable-next-line\n-const addMessageMutation = gql `\n+const addMessageMutation = gql`\n   mutation AddMessage($chatId: ID!, $content: String!) {\n     addMessage(chatId: $chatId, content: $content) {\n       ...Message\n@@ -38,45 +45,141 @@ const addMessageMutation = gql `\n   ${fragments.message}\n `;\n\n+const PaginationContext = React.createContext({\n+  after: 0,\n+  limit: 20,\n+  /**\n+   * Sets new cursor\n+   */\n+  setAfter: (after: number) => {},\n+  /**\n+   * Resets `after` value to its inital state (null) so\n+   */\n+  reset: () => {},\n+});\n+\n+const usePagination = () => {\n+  const pagination = useContext(PaginationContext);\n+\n+  // Resets the pagination every time a component did unmount\n+  useEffect(() => {\n+    return () => {\n+      pagination.reset();\n+    };\n+  }, [pagination]);\n+\n+  return pagination;\n+};\n+\n+export const ChatPaginationProvider = ({ children }: { children: any }) => {\n+  const [after, setAfter] = useState<number | null>(null);\n+\n+  return (\n+    <PaginationContext.Provider\n+      value={{\n+        limit: 20,\n+        after: after!,\n+        setAfter,\n+        reset: () => setAfter(null),\n+      }}>\n+      {children}\n+    </PaginationContext.Provider>\n+  );\n+};\n+\n+export const useGetChatPrefetch = () => {\n+  const client = useApolloClient();\n+  const { limit, after } = usePagination();\n+\n+  return (chatId: string) => {\n+    client.query<GetChatQuery, GetChatQueryVariables>({\n+      query: GetChatDocument,\n+      variables: {\n+        chatId,\n+        after,\n+        limit,\n+      },\n+    });\n+  };\n+};\n+\n interface ChatRoomScreenParams {\n-  chatId: string\n+  chatId: string;\n   history: History;\n-};\n+}\n\n-const ChatRoomScreen: React.FC<ChatRoomScreenParams> = ({ history, chatId }) => {\n-  const { data, loading } = useGetChatQuery({\n-    variables: { chatId }\n+const ChatRoom: React.FC<ChatRoomScreenParams> = ({ history, chatId }) => {\n+  const { after, limit, setAfter } = usePagination();\n+  const { data, loading, fetchMore } = useGetChatQuery({\n+    variables: { chatId, after, limit },\n   });\n\n-  const addMessage = useAddMessageMutation();\n+const [addMessage] = useAddMessageMutation();\n\n-  const onSendMessage = useCallback((content: string) => {\n+  const onSendMessage = useCallback(\n+    (content: string) => {\n+      if (data === undefined) {\n+        return null;\n+      }\n+      const chat = data.chat;\n+      if (chat === null) return null;\n\n-    if (data === undefined) { return null; }\n-    const chat = data.chat;\n-    if (chat === null) return null;\n+      addMessage({\n+        variables: { chatId, content },\n+        optimisticResponse: {\n+          __typename: 'Mutation',\n+          addMessage: {\n+            __typename: 'Message',\n+            id: Math.random()\n+              .toString(36)\n+              .substr(2, 9),\n+            createdAt: new Date(),\n+            isMine: true,\n+            chat: {\n+              __typename: 'Chat',\n+              id: chatId,\n+            },\n+            content,\n+          },\n+        },\n+        update: (client, { data: { addMessage } }) => {\n+          writeMessage(client, addMessage);\n+        },\n+      });\n+    },\n+    [data, chatId, addMessage]\n+  );\n\n-    addMessage({\n-      variables: { chatId, content },\n-      optimisticResponse: {\n-        __typename: 'Mutation',\n-        addMessage: {\n-          __typename: 'Message',\n-          id: Math.random().toString(36).substr(2, 9),\n-          createdAt: new Date(),\n-          isMine: true,\n+  useEffect(() => {\n+    if (!after) {\n+      return;\n+    }\n+\n+    // every time after changes its value, fetch more messages\n+    fetchMore({\n+      variables: {\n+        after,\n+        limit,\n+      },\n+      updateQuery(prev, { fetchMoreResult }) {\n+        const messages = [\n+          ...fetchMoreResult!.chat!.messages.messages,\n+          ...prev.chat!.messages.messages,\n+        ];\n+\n+        return {\n+          ...prev,\n           chat: {\n-            __typename: 'Chat',\n-            id: chatId,\n+            ...prev.chat!,\n+            messages: {\n+              ...fetchMoreResult!.chat!.messages,\n+              messages,\n+            },\n           },\n-          content,\n-        }\n-      },\n-      update: (client, { data: { addMessage } }) => {\n-        writeMessage(client, addMessage);\n+        };\n       },\n-    })\n-  }, [data, chatId, addMessage]);\n+    });\n+  }, [after, limit, fetchMore]);\n\n   if (data === undefined) {\n     return null;\n@@ -89,20 +192,33 @@ const ChatRoomScreen: React.FC<ChatRoomScreenParams> = ({ history, chatId }) =>\n\n   // Chat was probably removed from cache by the subscription handler\n   if (!chat) {\n-    return (\n-      <Redirect to=\"/chats\" />\n-    );\n+    return <Redirect to=\"/chats\" />;\n   }\n\n   return (\n     <Container>\n       <ChatNavbar chat={chat} history={history} />\n       {chat.messages && (\n-        <MessagesList messages={chat.messages} />\n+        <MessagesList\n+          messages={chat.messages.messages}\n+          hasMore={chat.messages.hasMore}\n+          loadMore={() => setAfter(chat.messages.cursor!)}\n+        />\n       )}\n-      <MessageInput onSendMessage={onSendMessage}/>\n+      <MessageInput onSendMessage={onSendMessage} />\n     </Container>\n   );\n };\n\n-export default ChatRoomScreen;\n\\ No newline at end of file\n+const ChatRoomScreen: React.FC<ChatRoomScreenParams> = ({\n+  history,\n+  chatId,\n+}) => {\n+  return (\n+    <ChatPaginationProvider>\n+      <ChatRoom history={history} chatId={chatId} />\n+    </ChatPaginationProvider>\n+  );\n+};\n+\n+export default ChatRoomScreen;\ndiff --git a/client/src/components/ChatsListScreen/AddChatButton.test.tsx b/client/src/components/ChatsListScreen/AddChatButton.test.tsx\nindex 8a21aff..6c30fa9 100644\n--- a/client/src/components/ChatsListScreen/AddChatButton.test.tsx\n+++ b/client/src/components/ChatsListScreen/AddChatButton.test.tsx\n@@ -1,22 +1,27 @@\n import { createMemoryHistory } from 'history';\n+import { ApolloProvider } from '@apollo/react-hooks';\n import React from 'react';\n-import { cleanup, render, fireEvent, wait } from 'react-testing-library';\n+import { cleanup, render, fireEvent, wait } from '@testing-library/react';\n import AddChatButton from './AddChatButton';\n+import { mockApolloClient } from '../../test-helpers';\n\n describe('AddChatButton', () => {\n   afterEach(cleanup);\n\n   it('goes back on arrow click', async () => {\n     const history = createMemoryHistory();\n+    const client = mockApolloClient();\n\n     {\n-      const { container, getByTestId } = render(<AddChatButton history={history} />);\n+      const { container, getByTestId } = render(\n+        <ApolloProvider client={client}>\n+          <AddChatButton history={history} />\n+        </ApolloProvider>\n+      );\n\n       fireEvent.click(getByTestId('new-chat-button'));\n\n-      await wait(() =>\n-        expect(history.location.pathname).toEqual('/new-chat')\n-      );\n+      await wait(() => expect(history.location.pathname).toEqual('/new-chat'));\n     }\n   });\n });\ndiff --git a/client/src/components/ChatsListScreen/AddChatButton.tsx b/client/src/components/ChatsListScreen/AddChatButton.tsx\nindex d14fc44..53470e0 100644\n--- a/client/src/components/ChatsListScreen/AddChatButton.tsx\n+++ b/client/src/components/ChatsListScreen/AddChatButton.tsx\n@@ -3,8 +3,9 @@ import ChatIcon from '@material-ui/icons/Chat';\n import React from 'react';\n import styled from 'styled-components';\n import { History } from 'history';\n+import { useUsersPrefetch } from '../UsersList';\n\n-const Container = styled.div `\n+const Container = styled.div`\n   position: fixed;\n   right: 10px;\n   bottom: 10px;\n@@ -18,27 +19,28 @@ const Container = styled.div `\n     color: white;\n   }\n `;\n+\n interface ChildComponentProps {\n   history: History;\n-};\n+}\n\n const AddChatButton: React.FC<ChildComponentProps> = ({ history }) => {\n+  const prefetchUsers = useUsersPrefetch();\n   const onClick = () => {\n-    history.push('/new-chat')\n+    history.push('/new-chat');\n   };\n\n   return (\n-    <Container>\n+    <Container onMouseEnter={() => prefetchUsers()}>\n       <Button\n         data-testid=\"new-chat-button\"\n         variant=\"contained\"\n         color=\"secondary\"\n-        onClick={onClick}\n-      >\n+        onClick={onClick}>\n         <ChatIcon />\n       </Button>\n     </Container>\n   );\n };\n\n-export default AddChatButton;\n\\ No newline at end of file\n+export default AddChatButton;\ndiff --git a/client/src/components/ChatsListScreen/ChatsList.test.tsx b/client/src/components/ChatsListScreen/ChatsList.test.tsx\nindex 33447b8..8c55e3b 100644\n--- a/client/src/components/ChatsListScreen/ChatsList.test.tsx\n+++ b/client/src/components/ChatsListScreen/ChatsList.test.tsx\n@@ -1,7 +1,13 @@\n import React from 'react';\n-import { ApolloProvider } from 'react-apollo-hooks';\n+import { ApolloProvider } from '@apollo/react-hooks';\n import ReactDOM from 'react-dom';\n-import { cleanup, render, fireEvent, wait, waitForDomChange } from 'react-testing-library';\n+import {\n+  cleanup,\n+  render,\n+  fireEvent,\n+  wait,\n+  waitForDomChange,\n+} from '@testing-library/react';\n import { createBrowserHistory } from 'history';\n import { mockApolloClient } from '../../test-helpers';\n import ChatsList, { getChatsQuery } from './ChatsList';\n@@ -10,7 +16,11 @@ import * as queries from '../../graphql/queries';\n describe('ChatsList', () => {\n   afterEach(() => {\n     cleanup();\n-    window.location.pathname = '/';\n+    delete window.location;\n+\n+    window.location = {\n+        href: '/',\n+    };\n   });\n\n   it('renders fetched chats data', async () => {\n@@ -29,7 +39,7 @@ describe('ChatsList', () => {\n                   __typename: 'Message',\n                   id: 1,\n                   content: 'Hello',\n-                  createdAt: new Date('14 Jun 2017 00:00:00 PDT').toUTCString(),\n+                  createdAt: new Date('1 Jan 2019 GMT'),\n                   isMine: true,\n                   chat: {\n                     __typename: 'Chat',\n@@ -43,19 +53,24 @@ describe('ChatsList', () => {\n       },\n     ]);\n\n+    const history = createBrowserHistory();\n+\n     {\n       const { container, getByTestId } = render(\n         <ApolloProvider client={client}>\n-          <ChatsList />\n+          <ChatsList history={history}/>\n         </ApolloProvider>\n       );\n\n       await waitForDomChange({ container });\n\n       expect(getByTestId('name')).toHaveTextContent('Foo Bar');\n-      expect(getByTestId('picture')).toHaveAttribute('src', 'https://localhost:4000/picture.jpg');\n+      expect(getByTestId('picture')).toHaveAttribute(\n+        'src',\n+        'https://localhost:4000/picture.jpg'\n+      );\n       expect(getByTestId('content')).toHaveTextContent('Hello');\n-      expect(getByTestId('date')).toHaveTextContent('10:00');\n+      expect(getByTestId('date')).toHaveTextContent('02:00');\n     }\n   });\n\n@@ -75,7 +90,7 @@ describe('ChatsList', () => {\n                   __typename: 'Message',\n                   id: 1,\n                   content: 'Hello',\n-                  createdAt: new Date(0),\n+                  createdAt: new Date('1 Jan 2019 GMT'),\n                   isMine: true,\n                   chat: {\n                     __typename: 'Chat',\n@@ -89,7 +104,7 @@ describe('ChatsList', () => {\n       },\n     ]);\n\n-     const history = createBrowserHistory();\n+    const history = createBrowserHistory();\n\n     {\n       const { container, getByTestId } = render(\n@@ -98,31 +113,11 @@ describe('ChatsList', () => {\n         </ApolloProvider>\n       );\n\n-       await waitForDomChange({ container });\n+      await waitForDomChange({ container });\n\n-       fireEvent.click(getByTestId('chat'));\n+      fireEvent.click(getByTestId('chat'));\n\n-       await wait(() =>\n-        expect(history.location.pathname).toEqual('/chats/1')\n-      );\n+      await wait(() => expect(history.location.pathname).toEqual('/chats/1'));\n     }\n   });\n });\n-\n-// IMPORTANT\n-// Below is a temporary hack to suppress warnings generated by a React bug.\n-// Source: https://github.com/testing-library/react-testing-library/issues/281\n-// @todo: remove this when React 16.9.0 is stable and we upgrade.\n-const originalError = console.error;\n-beforeAll(() => {\n-  console.error = (...args: string[]) => {\n-    if (/Warning.*not wrapped in act/.test(args[0])) {\n-      return;\n-    }\n-    originalError.call(console, ...args);\n-  };\n-});\n-\n-afterAll(() => {\n-  console.error = originalError;\n-});\ndiff --git a/client/src/components/ChatsListScreen/ChatsList.tsx b/client/src/components/ChatsListScreen/ChatsList.tsx\nindex c5fd34a..f4bcfa2 100644\n--- a/client/src/components/ChatsListScreen/ChatsList.tsx\n+++ b/client/src/components/ChatsListScreen/ChatsList.tsx\n@@ -1,34 +1,35 @@\n import React from 'react';\n-import moment from 'moment';\n+import format from 'date-fns/format';\n import { List, ListItem } from '@material-ui/core';\n import styled from 'styled-components';\n import { useCallback } from 'react';\n import { History } from 'history';\n import { useChatsQuery } from '../../graphql/types';\n+import { useGetChatPrefetch } from '../ChatRoomScreen';\n\n-const Container = styled.div `\n+const Container = styled.div`\n   height: calc(100% - 56px);\n   overflow-y: overlay;\n `;\n\n-const StyledList = styled(List) `\n+const StyledList = styled(List)`\n   padding: 0 !important;\n-` as typeof List;\n+`;\n\n-const StyledListItem = styled(ListItem) `\n+const StyledListItem = styled(ListItem)`\n   height: 76px;\n   padding: 0 15px;\n   display: flex;\n-` as typeof ListItem;\n+`;\n\n-const ChatPicture = styled.img `\n+const ChatPicture = styled.img`\n   height: 50px;\n   width: 50px;\n   object-fit: cover;\n   border-radius: 50%;\n `;\n\n-const ChatInfo = styled.div `\n+const ChatInfo = styled.div`\n   width: calc(100% - 60px);\n   height: 46px;\n   padding: 15px 0;\n@@ -37,11 +38,11 @@ const ChatInfo = styled.div `\n   position: relative;\n `;\n\n-const ChatName = styled.div `\n+const ChatName = styled.div`\n   margin-top: 5px;\n `;\n\n-const MessageContent = styled.div `\n+const MessageContent = styled.div`\n   color: gray;\n   font-size: 15px;\n   margin-top: 5px;\n@@ -50,7 +51,7 @@ const MessageContent = styled.div `\n   white-space: nowrap;\n `;\n\n-const MessageDate = styled.div `\n+const MessageDate = styled.div`\n   position: absolute;\n   color: gray;\n   top: 20px;\n@@ -59,35 +60,52 @@ const MessageDate = styled.div `\n `;\n\n interface ChatsListProps {\n-  history : History;\n-};\n+  history: History;\n+}\n\n const ChatsList: React.FC<ChatsListProps> = ({ history }) => {\n-\n-  const navToChat = useCallback((chat) => {\n-    history.push(`chats/${chat.id}`)\n-  }, [history]);\n+  const navToChat = useCallback(\n+    chat => {\n+      history.push(`chats/${chat.id}`);\n+    },\n+    [history]\n+  );\n+  const prefetchChat = useGetChatPrefetch();\n\n   const { data } = useChatsQuery();\n\n   if (data === undefined || data.chats === undefined) {\n     return null;\n   }\n-\n   let chats = data.chats;\n\n   return (\n     <Container>\n       <StyledList>\n         {chats.map((chat: any) => (\n-          <StyledListItem key={chat.id} data-testid=\"chat\" button onClick={navToChat.bind(null, chat)}>\n-            <ChatPicture data-testid=\"picture\" src={chat.picture} alt=\"Profile\"/>\n+          <StyledListItem\n+            key={chat.id}\n+            data-testid=\"chat\"\n+            button\n+            onClick={navToChat.bind(null, chat)}\n+            onMouseEnter={() => {\n+              prefetchChat(chat.id);\n+            }}>\n+            <ChatPicture\n+              data-testid=\"picture\"\n+              src={chat.picture}\n+              alt=\"Profile\"\n+            />\n             <ChatInfo>\n               <ChatName data-testid=\"name\">{chat.name}</ChatName>\n               {chat.lastMessage && (\n                 <React.Fragment>\n-                  <MessageContent data-testid=\"content\">{chat.lastMessage.content}</MessageContent>\n-                  <MessageDate data-testid=\"date\">{moment(chat.lastMessage.createdAt).format('HH:mm')}</MessageDate>\n+                  <MessageContent data-testid=\"content\">\n+                    {chat.lastMessage.content}\n+                  </MessageContent>\n+                  <MessageDate data-testid=\"date\">\n+                    {format(chat.lastMessage.createdAt, 'HH:mm')}\n+                  </MessageDate>\n                 </React.Fragment>\n               )}\n             </ChatInfo>\n@@ -95,7 +113,7 @@ const ChatsList: React.FC<ChatsListProps> = ({ history }) => {\n         ))}\n       </StyledList>\n     </Container>\n-  )\n+  );\n };\n\n-export default ChatsList;\n\\ No newline at end of file\n+export default ChatsList;\ndiff --git a/client/src/components/ChatsListScreen/ChatsNavbar.tsx b/client/src/components/ChatsListScreen/ChatsNavbar.tsx\nindex 9ef163a..e17eaad 100644\n--- a/client/src/components/ChatsListScreen/ChatsNavbar.tsx\n+++ b/client/src/components/ChatsListScreen/ChatsNavbar.tsx\n@@ -3,35 +3,37 @@ import { Button, Toolbar } from '@material-ui/core';\n import styled from 'styled-components';\n import SignOutIcon from '@material-ui/icons/PowerSettingsNew';\n import { useCallback } from 'react';\n-import { signOut } from '../../services/auth.service';\n+import { useSignOut } from '../../services/auth.service';\n import { History } from 'history';\n\n-const Container = styled(Toolbar) `\n+const Container = styled(Toolbar)`\n   display: flex;\n   background-color: var(--primary-bg);\n   color: var(--primary-text);\n   font-size: 20px;\n   line-height: 40px;\n-` as typeof Toolbar;\n+`;\n\n-const Title = styled.div `\n+const Title = styled.div`\n   flex: 1;\n `;\n\n-const LogoutButton = styled(Button) `\n+const LogoutButton = styled(Button)`\n   color: var(--primary-text) !important;\n-` as typeof Button;\n+`;\n\n interface ChildComponentProps {\n   history: History;\n-};\n+}\n\n const ChatsNavbar: React.FC<ChildComponentProps> = ({ history }) => {\n+  const signOut = useSignOut();\n+\n   const handleSignOut = useCallback(() => {\n     signOut().then(() => {\n-      history.replace('/sign-in')\n+      history.replace('/sign-in');\n     });\n-  }, [history]);\n+  }, [history, signOut]);\n\n   return (\n     <Container>\n@@ -43,4 +45,4 @@ const ChatsNavbar: React.FC<ChildComponentProps> = ({ history }) => {\n   );\n };\n\n-export default ChatsNavbar;\n\\ No newline at end of file\n+export default ChatsNavbar;\ndiff --git a/client/src/components/ChatsListScreen/index.tsx b/client/src/components/ChatsListScreen/index.tsx\nindex 4451ea2..2d0416c 100644\n--- a/client/src/components/ChatsListScreen/index.tsx\n+++ b/client/src/components/ChatsListScreen/index.tsx\n@@ -5,13 +5,13 @@ import styled from 'styled-components';\n import { History } from 'history';\n import AddChatButton from './AddChatButton';\n\n-const Container = styled.div `\n+const Container = styled.div`\n   height: 100vh;\n `;\n\n interface ChatsListScreenProps {\n-  history : History;\n-};\n+  history: History;\n+}\n\n const ChatsListScreen: React.FC<ChatsListScreenProps> = ({ history }) => (\n   <Container>\n@@ -21,4 +21,4 @@ const ChatsListScreen: React.FC<ChatsListScreenProps> = ({ history }) => (\n   </Container>\n );\n\n-export default ChatsListScreen;\n\\ No newline at end of file\n+export default ChatsListScreen;\ndiff --git a/client/src/components/UsersList.test.tsx b/client/src/components/UsersList.test.tsx\nindex 5af11e0..3e50d59 100644\n--- a/client/src/components/UsersList.test.tsx\n+++ b/client/src/components/UsersList.test.tsx\n@@ -1,6 +1,12 @@\n import React from 'react';\n-import { ApolloProvider } from 'react-apollo-hooks';\n-import { cleanup, render, fireEvent, wait, waitForDomChange } from 'react-testing-library';\n+import { ApolloProvider } from '@apollo/react-hooks';\n+import {\n+  cleanup,\n+  render,\n+  fireEvent,\n+  wait,\n+  waitForDomChange,\n+} from '@testing-library/react';\n import { mockApolloClient } from '../test-helpers';\n import UsersList, { UsersListQuery } from './UsersList';\n import * as queries from '../graphql/queries';\n@@ -37,9 +43,12 @@ describe('UsersList', () => {\n       await waitForDomChange({ container });\n\n       expect(getByTestId('name')).toHaveTextContent('Charles Dickhead');\n-      expect(getByTestId('picture')).toHaveAttribute('src', 'https://localhost:4000/dick.jpg');\n+      expect(getByTestId('picture')).toHaveAttribute(\n+        'src',\n+        'https://localhost:4000/dick.jpg'\n+      );\n     }\n-  })\n+  });\n\n   it('triggers onUserPick() callback on user-item click', async () => {\n     const client = mockApolloClient([\n@@ -73,12 +82,12 @@ describe('UsersList', () => {\n\n       fireEvent.click(getByTestId('user'));\n\n-      await wait(() =>\n-        expect(onUserPick.mock.calls.length).toBe(1)\n-      );\n+      await wait(() => expect(onUserPick.mock.calls.length).toBe(1));\n\n       expect(onUserPick.mock.calls[0][0].name).toEqual('Charles Dickhead');\n-      expect(onUserPick.mock.calls[0][0].picture).toEqual('https://localhost:4000/dick.jpg');\n+      expect(onUserPick.mock.calls[0][0].picture).toEqual(\n+        'https://localhost:4000/dick.jpg'\n+      );\n     }\n   });\n });\ndiff --git a/client/src/components/UsersList.tsx b/client/src/components/UsersList.tsx\nindex 0fbf394..3d66768 100644\n--- a/client/src/components/UsersList.tsx\n+++ b/client/src/components/UsersList.tsx\n@@ -3,28 +3,29 @@ import MaterialItem from '@material-ui/core/ListItem';\n import gql from 'graphql-tag';\n import React from 'react';\n import styled from 'styled-components';\n+import { useApolloClient } from '@apollo/react-hooks';\n+import { useUsersListQuery, User, UsersListDocument } from '../graphql/types';\n import * as fragments from '../graphql/fragments';\n-import { useUsersListQuery, User } from '../graphql/types';\n\n-const ActualList = styled(MaterialList) `\n+const ActualList = styled(MaterialList)`\n   padding: 0;\n-` as typeof MaterialList;\n+`;\n\n-const UserItem = styled(MaterialItem) `\n+const UserItem = styled(MaterialItem)`\n   position: relative;\n   padding: 7.5px 15px;\n   display: flex;\n   cursor: pinter;\n-` as typeof MaterialItem;\n+`;\n\n-const ProfilePicture = styled.img `\n+const ProfilePicture = styled.img`\n   height: 50px;\n   width: 50px;\n   object-fit: cover;\n   border-radius: 50%;\n `;\n\n-const Name = styled.div `\n+const Name = styled.div`\n   padding-left: 15px;\n   font-weight: bold;\n `;\n@@ -38,11 +39,23 @@ export const UsersListQuery = gql`\n   ${fragments.user}\n `;\n\n+export const useUsersPrefetch = () => {\n+  const client = useApolloClient();\n+\n+  return () => {\n+    client.query({\n+      query: UsersListDocument,\n+    });\n+  };\n+};\n+\n interface ChildComponentProps {\n   onUserPick: any;\n-};\n+}\n\n-const UsersList: React.FC<ChildComponentProps> = ({ onUserPick = (user: User) => {} }) => {\n+const UsersList: React.FC<ChildComponentProps> = ({\n+  onUserPick = (user: User) => {},\n+}) => {\n   const { data, loading: loadingUsers } = useUsersListQuery();\n\n   if (data === undefined) return null;\n@@ -50,21 +63,21 @@ const UsersList: React.FC<ChildComponentProps> = ({ onUserPick = (user: User) =>\n\n   return (\n     <ActualList>\n-      {!loadingUsers && users.map(user => (\n-        <UserItem\n-          key={user.id}\n-          data-testid=\"user\"\n-          onClick={onUserPick.bind(null, user)}\n-          button\n-        >\n-          {(user !== null && user.picture !== null) &&\n-            <React.Fragment>\n-              <ProfilePicture data-testid=\"picture\" src={user.picture} />\n-              <Name data-testid=\"name\">{user.name}</Name>\n-            </React.Fragment>\n-          }\n-        </UserItem>\n-      ))}\n+      {!loadingUsers &&\n+        users.map(user => (\n+          <UserItem\n+            key={user.id}\n+            data-testid=\"user\"\n+            onClick={onUserPick.bind(null, user)}\n+            button>\n+            {user !== null && user.picture !== null && (\n+              <React.Fragment>\n+                <ProfilePicture data-testid=\"picture\" src={user.picture} />\n+                <Name data-testid=\"name\">{user.name}</Name>\n+              </React.Fragment>\n+            )}\n+          </UserItem>\n+        ))}\n     </ActualList>\n   );\n };\ndiff --git a/client/src/graphql/fragments/fullChat.fragment.ts b/client/src/graphql/fragments/fullChat.fragment.ts\nindex 26998e4..2d2cd30 100644\n--- a/client/src/graphql/fragments/fullChat.fragment.ts\n+++ b/client/src/graphql/fragments/fullChat.fragment.ts\n@@ -1,14 +1,14 @@\n import gql from 'graphql-tag';\n import chat from './chat.fragment';\n-import message from './message.fragment';\n+import messagesResult from './messagesResult.fragment';\n\n export default gql`\n   fragment FullChat on Chat {\n     ...Chat\n-    messages {\n-      ...Message\n+    messages(limit: $limit, after: $after) @connection(key: \"messages\") {\n+      ...MessagesResult\n     }\n   }\n   ${chat}\n-  ${message}\n+  ${messagesResult}\n `;\ndiff --git a/client/src/graphql/fragments/messagesResult.fragment.ts b/client/src/graphql/fragments/messagesResult.fragment.ts\nnew file mode 100644\nindex 0000000..b1131f0\n--- /dev/null\n+++ b/client/src/graphql/fragments/messagesResult.fragment.ts\n@@ -0,0 +1,13 @@\n+import gql from 'graphql-tag';\n+import message from './message.fragment';\n+\n+export default gql`\n+  fragment MessagesResult on MessagesResult {\n+    cursor\n+    hasMore\n+    messages {\n+      ...Message\n+    }\n+  }\n+  ${message}\n+`;\ndiff --git a/client/src/graphql/mutations/index.ts b/client/src/graphql/mutations/index.ts\nnew file mode 100644\nindex 0000000..b4db188\n--- /dev/null\n+++ b/client/src/graphql/mutations/index.ts\n@@ -0,0 +1 @@\n+export { default as signIn } from './signIn.mutation'\ndiff --git a/client/src/graphql/mutations/signIn.mutation.ts b/client/src/graphql/mutations/signIn.mutation.ts\nnew file mode 100644\nindex 0000000..582afd6\n--- /dev/null\n+++ b/client/src/graphql/mutations/signIn.mutation.ts\n@@ -0,0 +1,9 @@\n+import gql from 'graphql-tag'\n+\n+export default gql`\n+  mutation signIn($username: String!, $password: String!) {\n+    signIn(username: $username, password: $password) {\n+      id\n+    }\n+  }\n+`\ndiff --git a/client/src/graphql/mutations/signUp.mutation.ts b/client/src/graphql/mutations/signUp.mutation.ts\nnew file mode 100644\nindex 0000000..041f137\n--- /dev/null\n+++ b/client/src/graphql/mutations/signUp.mutation.ts\n@@ -0,0 +1,9 @@\n+import gql from 'graphql-tag'\n+\n+export default gql`\n+  mutation signUp($name: String!, $username: String!, $password: String!, $passwordConfirm: String!) {\n+    signUp(name: $name, username: $username, password: $password, passwordConfirm: $passwordConfirm) {\n+      id\n+    }\n+  }\n+`\ndiff --git a/client/src/graphql/subscriptions/messageAdded.subscription.ts b/client/src/graphql/subscriptions/messageAdded.subscription.ts\nindex 382c755..ad284f8 100644\n--- a/client/src/graphql/subscriptions/messageAdded.subscription.ts\n+++ b/client/src/graphql/subscriptions/messageAdded.subscription.ts\n@@ -1,7 +1,7 @@\n import gql from 'graphql-tag';\n import * as fragments from '../fragments';\n\n-export default gql `\n+export default gql`\n   subscription MessageAdded {\n     messageAdded {\n       ...Message\ndiff --git a/client/src/hooks/use-adjusted-scroll.ts b/client/src/hooks/use-adjusted-scroll.ts\nnew file mode 100644\nindex 0000000..94173e4\n--- /dev/null\n+++ b/client/src/hooks/use-adjusted-scroll.ts\n@@ -0,0 +1,35 @@\n+import { useState, useCallback, RefObject } from 'react';\n+import * as ReactDOM from 'react-dom';\n+\n+export const useAdjustedScroll = (ref: RefObject<HTMLElement>) => {\n+  const [previousScroll, setPreviousScroll] = useState<{\n+    top: number;\n+    height: number;\n+  }>();\n+\n+  /**\n+   * Scrolls to the previous position or completely to bottom (on demand)\n+   */\n+  const adjust = useCallback(\n+    (scrollToBottom?: boolean) => {\n+      if (!ref.current) return;\n+\n+      const node = ReactDOM.findDOMNode(ref.current) as HTMLElement;\n+      const height =\n+        !scrollToBottom && previousScroll\n+          ? previousScroll.height\n+          : node.clientHeight;\n+\n+      node.scrollTop = node.scrollHeight - height;\n+\n+      // saves current scroll details\n+      setPreviousScroll({\n+        top: node.scrollTop,\n+        height: node.scrollHeight,\n+      });\n+    },\n+    [ref, previousScroll]\n+  );\n+\n+  return adjust;\n+};\ndiff --git a/client/src/hooks/use-infinite-scroll.ts b/client/src/hooks/use-infinite-scroll.ts\nnew file mode 100644\nindex 0000000..1872801\n--- /dev/null\n+++ b/client/src/hooks/use-infinite-scroll.ts\n@@ -0,0 +1,48 @@\n+import { useState, useEffect, useCallback, RefObject } from 'react';\n+\n+export const useInfiniteScroll = ({\n+  ref,\n+  hasMore,\n+  onLoadMore,\n+}: {\n+  onLoadMore: Function;\n+  hasMore: boolean;\n+  ref: RefObject<HTMLElement>;\n+}): [boolean, () => void] => {\n+  const [isFetching, setIsFetching] = useState(false);\n+  const handleScroll = useCallback(() => {\n+    if (ref.current!.scrollTop === 0 && isFetching === false && hasMore) {\n+      // starts to fetch if scrolled to top, fetching is not in progress and has more data\n+      setIsFetching(true);\n+    }\n+  }, [ref, isFetching, hasMore]);\n+\n+  useEffect(() => {\n+    const elem = ref.current;\n+\n+    if (!elem) {\n+      return;\n+    }\n+\n+    elem.addEventListener('scroll', handleScroll);\n+\n+    return () => {\n+      elem!.removeEventListener('scroll', handleScroll);\n+    };\n+  }, [ref, handleScroll]);\n+\n+  // loads more if fetching has started\n+  useEffect(() => {\n+    if (isFetching) {\n+      onLoadMore();\n+    }\n+  }, [isFetching, onLoadMore]);\n+\n+  const stopFetching = useCallback(() => {\n+    setIsFetching(false);\n+  }, []);\n+\n+  return [isFetching, stopFetching];\n+};\n+\n+export default useInfiniteScroll;\ndiff --git a/client/src/index.tsx b/client/src/index.tsx\nindex e953ef2..bf3b781 100644\n--- a/client/src/index.tsx\n+++ b/client/src/index.tsx\n@@ -1,7 +1,7 @@\n-import { MuiThemeProvider, createMuiTheme } from '@material-ui/core/styles'\n+import { MuiThemeProvider, createMuiTheme } from '@material-ui/core/styles';\n import React from 'react';\n import ReactDOM from 'react-dom';\n-import { ApolloProvider } from 'react-apollo-hooks';\n+import { ApolloProvider } from '@apollo/react-hooks';\n import './index.css';\n import App from './App';\n import client from './client';\n@@ -12,18 +12,16 @@ const theme = createMuiTheme({\n     primary: { main: '#2c6157' },\n     secondary: { main: '#6fd056' },\n   },\n-  typography: {\n-    useNextVariants: true,\n-  },\n-})\n+});\n\n ReactDOM.render(\n   <MuiThemeProvider theme={theme}>\n     <ApolloProvider client={client}>\n       <App />\n     </ApolloProvider>\n-  </MuiThemeProvider>\n-, document.getElementById('root'));\n+  </MuiThemeProvider>,\n+  document.getElementById('root')\n+);\n\n // If you want your app to work offline and load faster, you can change\n // unregister() to register() below. Note this comes with some pitfalls.\ndiff --git a/client/src/react-app-env.d.ts b/client/src/react-app-env.d.ts\nindex c148f59..048e7ba 100644\n--- a/client/src/react-app-env.d.ts\n+++ b/client/src/react-app-env.d.ts\n@@ -1,3 +1,3 @@\n /// <reference types=\"react-scripts\" />\n\n-declare module \"react-router-transition\";\n\\ No newline at end of file\n+declare module 'react-router-transition';\ndiff --git a/client/src/services/auth.service.tsx b/client/src/services/auth.service.tsx\nindex 8ae9e7f..f810509 100644\n--- a/client/src/services/auth.service.tsx\n+++ b/client/src/services/auth.service.tsx\n@@ -1,29 +1,29 @@\n import React from 'react';\n-import { useContext } from 'react';\n+import { useContext, useCallback } from 'react';\n+import { useApolloClient } from '@apollo/react-hooks';\n import { Redirect } from 'react-router-dom';\n-import client from '../client';\n-import { useMeQuery, User } from '../graphql/types';\n+import { useMeQuery, User, useSignInMutation, useSignUpMutation } from '../graphql/types';\n import { useCacheService } from './cache.service';\n-import gql from 'graphql-tag';\n\n-const MyContext = React.createContext<User|null>(null);\n+const MyContext = React.createContext<User | null>(null);\n\n export const useMe = () => {\n   return useContext(MyContext);\n };\n\n-export const withAuth = <P extends object>(Component: React.ComponentType<P>) => {\n+export const withAuth = <P extends object>(\n+  Component: React.ComponentType<P>\n+) => {\n   return (props: any) => {\n     if (!isSignedIn()) {\n       if (props.history.location.pathname === '/sign-in') {\n         return null;\n       }\n\n-      return (\n-        <Redirect to=\"/sign-in\" />\n-      );\n+      return <Redirect to=\"/sign-in\" />;\n     }\n\n+    const signOut = useSignOut();\n     const { data, error, loading } = useMeQuery();\n\n     useCacheService();\n@@ -46,45 +46,20 @@ export const withAuth = <P extends object>(Component: React.ComponentType<P>) =>\n   };\n };\n\n-export const signIn = ({ username, password }: { username: string, password: string}) => {\n-  return client.mutate({\n-    mutation: gql`\n-      mutation signIn($username: String!, $password: String!) {\n-        signIn(username: $username, password: $password) {\n-          id\n-        }\n-      }\n-    `,\n-    variables: {\n-      username,\n-      password\n-    }\n-  });\n-};\n+export const useSignIn = useSignInMutation;\n+export const useSignUp = useSignUpMutation;\n\n-export const signUp = ({ name, username, password, passwordConfirm }:\n-  {name: string, username: string, password: string, passwordConfirm: string}) => {\n-  return client.mutate({\n-    mutation: gql`\n-      mutation signUp($name: String!, $username: String!, $password: String!, $passwordConfirm: String!) {\n-        signUp(name: $name, username: $username, password: $password, passwordConfirm: $passwordConfirm) {\n-          id\n-        }\n-      }\n-    `,\n-    variables: {\n-      name,\n-      username,\n-      password,\n-      passwordConfirm\n-    }\n-  });\n-};\n+export const useSignOut = () => {\n+  const client = useApolloClient()\n\n-export const signOut = () => {\n-  document.cookie = `authToken=;expires=${new Date(0)}`;\n+  return useCallback(() => {\n+    // \"expires\" represents the lifespan of a cookie. Beyond that date the cookie will\n+    // be deleted by the browser. \"expires\" cannot be viewed from \"document.cookie\"\n+    document.cookie = `authToken=;expires=${new Date(0)}`;\n\n-  return client.clearStore();\n+    // Clear cache\n+    return client.clearStore();\n+  }, [client])\n };\n\n export const isSignedIn = () => {\ndiff --git a/client/src/services/cache.service.ts b/client/src/services/cache.service.ts\nindex 0b54829..06ed21b 100644\n--- a/client/src/services/cache.service.ts\n+++ b/client/src/services/cache.service.ts\n@@ -19,7 +19,7 @@ export const useCacheService = () => {\n       if (data) {\n         writeMessage(client, data.messageAdded);\n       }\n-    }\n+    },\n   });\n\n   useChatAddedSubscription({\n@@ -27,7 +27,7 @@ export const useCacheService = () => {\n       if (data) {\n         writeChat(client, data.chatAdded);\n       }\n-    }\n+    },\n   });\n\n   useChatRemovedSubscription({\n@@ -35,7 +35,7 @@ export const useCacheService = () => {\n       if (data) {\n         eraseChat(client, data.chatRemoved);\n       }\n-    }\n+    },\n   });\n };\n\n@@ -45,21 +45,25 @@ export const writeMessage = (client: Client, message: MessageFragment) => {\n\n   const chatIdFromStore = defaultDataIdFromObject(message.chat);\n\n-  if (chatIdFromStore === null) { return; }\n+  if (chatIdFromStore === null) {\n+    return;\n+  }\n   try {\n     fullChat = client.readFragment<FullChat>({\n       id: chatIdFromStore,\n       fragment: fragments.fullChat,\n       fragmentName: 'FullChat',\n-    })\n+    });\n   } catch (e) {\n     return;\n   }\n\n-  if (fullChat === null || fullChat.messages === null) { return; }\n-  if (fullChat.messages.some((m: any) => m.id === message.id)) return;\n+  if (fullChat === null || fullChat.messages === null) {\n+    return;\n+  }\n+  if (fullChat.messages.messages.some((m: any) => m.id === message.id)) return;\n\n-  fullChat.messages.push(message);\n+  fullChat.messages.messages.push(message);\n   fullChat.lastMessage = message;\n\n   client.writeFragment({\n@@ -69,22 +73,22 @@ export const writeMessage = (client: Client, message: MessageFragment) => {\n     data: fullChat,\n   });\n\n-\n   let data;\n   try {\n     data = client.readQuery({\n       query: queries.chats,\n-    })\n+    });\n   } catch (e) {\n     return;\n-  };\n+  }\n\n-  if (data === undefined || data.chats === undefined) {\n+  if (!data || data === null) {\n+    return null;\n+  }\n+  if (!data.chats || data.chats === undefined) {\n     return null;\n   }\n-\n   const chats = data.chats;\n-  if (!chats) return;\n\n   const chatIndex = chats.findIndex((c: any) => {\n     if (message === null || message.chat === null) return -1;\n@@ -101,10 +105,9 @@ export const writeMessage = (client: Client, message: MessageFragment) => {\n     query: queries.chats,\n     data: { chats: chats },\n   });\n-}\n+};\n\n export const writeChat = (client: Client, chat: ChatFragment) => {\n-\n   const chatId = defaultDataIdFromObject(chat);\n   if (chatId === null) {\n     return;\n@@ -115,15 +118,15 @@ export const writeChat = (client: Client, chat: ChatFragment) => {\n     fragment: fragments.chat,\n     fragmentName: 'Chat',\n     data: chat,\n-  })\n+  });\n\n   let data;\n   try {\n     data = client.readQuery({\n       query: queries.chats,\n-    })\n+    });\n   } catch (e) {\n-    return;\n+    return;\n   }\n\n   if (!data) return;\n@@ -133,18 +136,18 @@ export const writeChat = (client: Client, chat: ChatFragment) => {\n   if (!chats) return;\n   if (chats.some((c: any) => c.id === chat.id)) return;\n\n-  chats.unshift(chat)\n+  chats.unshift(chat);\n\n   client.writeQuery({\n     query: queries.chats,\n     data: { chats },\n   });\n-}\n+};\n\n export const eraseChat = (client: Client, chatId: string) => {\n   const chatType = {\n     __typename: 'Chat',\n-    id: chatId\n+    id: chatId,\n   };\n\n   const chatIdFromObject = defaultDataIdFromObject(chatType);\n@@ -157,7 +160,7 @@ export const eraseChat = (client: Client, chatId: string) => {\n     fragment: fragments.fullChat,\n     fragmentName: 'FullChat',\n     data: null,\n-  })\n+  });\n\n   let data;\n   try {\n@@ -185,4 +188,4 @@ export const eraseChat = (client: Client, chatId: string) => {\n     query: queries.chats,\n     data: { chats: chats },\n   });\n-}\n+};\ndiff --git a/client/src/setupTests.ts b/client/src/setupTests.ts\nindex c42be90..0d5b8c1 100644\n--- a/client/src/setupTests.ts\n+++ b/client/src/setupTests.ts\n@@ -1,7 +1,7 @@\n-import 'jest-dom/extend-expect'\n-import { GlobalWithFetchMock } from 'jest-fetch-mock'\n-import { act } from 'react-testing-library'\n+import '@testing-library/jest-dom/extend-expect';\n+import { GlobalWithFetchMock } from 'jest-fetch-mock';\n+import { act } from '@testing-library/react';\n\n-const customGlobal: GlobalWithFetchMock = global as GlobalWithFetchMock\n-customGlobal.fetch = require('jest-fetch-mock')\n-customGlobal.fetchMock = customGlobal.fetch\n+const customGlobal: GlobalWithFetchMock = global as GlobalWithFetchMock;\n+customGlobal.fetch = require('jest-fetch-mock');\n+customGlobal.fetchMock = customGlobal.fetch;\ndiff --git a/package.json b/package.json\nindex 008b058..6408034 100644\n--- a/package.json\n+++ b/package.json\n@@ -5,5 +5,23 @@\n   \"repository\": {\n     \"type\": \"git\",\n     \"url\": \"https://github.com/Urigo/WhatsApp-Clone-Tutorial.git\"\n-  }\n+  },\n+  \"keywords\": [\n+    \"chat\",\n+    \"whatsapp\",\n+    \"nodejs\",\n+    \"node\",\n+    \"postgres\",\n+    \"postgresql\",\n+    \"sql\",\n+    \"graphql\",\n+    \"typescript\",\n+    \"javascript\",\n+    \"react\",\n+    \"reactjs\",\n+    \"fullstack\",\n+    \"websocket\",\n+    \"socketio\",\n+    \"performance\"\n+  ]\n }\ndiff --git a/server/.circleci/config.yml b/server/.circleci/config.yml\nnew file mode 100644\nindex 0000000..952918d\n--- /dev/null\n+++ b/server/.circleci/config.yml\n@@ -0,0 +1,33 @@\n+version: 2\n+jobs:\n+  build:\n+    working_directory: ~/server/\n+    docker:\n+      - image: circleci/node:12.7.0\n+      - image: postgres:11.5-alpine\n+        environment:\n+          POSTGRES_PASSWORD: testpassword\n+          POSTGRES_USER: testuser\n+          POSTGRES_DB: whatsapp\n+    steps:\n+      - checkout\n+      - restore_cache:\n+          name: Restore Yarn Package Cache\n+          keys:\n+            - yarn-packages-{{ checksum \"yarn.lock\" }}\n+      - run:\n+          name: Install Dependencies\n+          command: yarn\n+      - run:\n+          name: Build\n+          command: yarn build\n+      - run:\n+          name: Test\n+          command: yarn test\n+      - store_test_results:\n+          path: test-results\n+      - save_cache:\n+          name: Save Yarn Package Cache\n+          key: yarn-packages-{{ checksum \"yarn.lock\" }}\n+          paths:\n+            - ~/.cache/yarn\n\\ No newline at end of file\ndiff --git a/server/.gitignore b/server/.gitignore\nindex ba92242..979c3a7 100644\n--- a/server/.gitignore\n+++ b/server/.gitignore\n@@ -1,4 +1,6 @@\n+dist\n node_modules\n npm-debug.log\n+test-results/\n types/graphql.d.ts\n-types/unsplash.d.ts\n+types/unsplash.d.ts\n\\ No newline at end of file\ndiff --git a/server/.prettierignore b/server/.prettierignore\nnew file mode 100644\nindex 0000000..b512c09\n--- /dev/null\n+++ b/server/.prettierignore\n@@ -0,0 +1 @@\n+node_modules\n\\ No newline at end of file\ndiff --git a/server/.prettierrc.yml b/server/.prettierrc.yml\nnew file mode 100644\nindex 0000000..3250279\n--- /dev/null\n+++ b/server/.prettierrc.yml\n@@ -0,0 +1,4 @@\n+trailingComma: 'es5'\n+tabWidth: 2\n+singleQuote: true\n+parser: 'typescript'\ndiff --git a/server/app.ts b/server/app.ts\nindex 943a214..f0ab7e0 100644\n--- a/server/app.ts\n+++ b/server/app.ts\n@@ -1,15 +1,14 @@\n-import bodyParser from 'body-parser'\n-import cors from 'cors'\n-import cookieParser from 'cookie-parser'\n-import express from 'express'\n-import { origin } from './env'\n+import cors from 'cors';\n+import cookieParser from 'cookie-parser';\n+import express from 'express';\n+import { origin } from './env';\n\n-export const app = express()\n+export const app = express();\n\n-app.use(cors({ credentials: true, origin }))\n-app.use(bodyParser.json())\n-app.use(cookieParser())\n+app.use(cors({ credentials: true, origin }));\n+app.use(express.json());\n+app.use(cookieParser());\n\n app.get('/_ping', (req, res) => {\n-  res.send('pong')\n-})\n+  res.send('pong');\n+});\ndiff --git a/server/artillery-limit.yml b/server/artillery-limit.yml\nnew file mode 100644\nindex 0000000..357786a\n--- /dev/null\n+++ b/server/artillery-limit.yml\n@@ -0,0 +1,77 @@\n+config:\n+  target: 'http://localhost:4000/graphql'\n+  phases:\n+    - duration: 120\n+      arrivalRate: 5\n+    - duration: 120\n+      arrivalRate: 10\n+    - duration: 300\n+      arrivalRate: 10\n+    - duration: 60\n+      arrivalRate: 100\n+scenarios:\n+  - name: 'Sign in, send a new message and fetch a list of chats'\n+    flow:\n+      - post:\n+          url: '/'\n+          json:\n+            variables:\n+              username: 'ray'\n+              password: '111'\n+            query: |\n+              mutation SignIn($username: String!, $password: String!) {\n+                signIn(username: $username, password: $password) {\n+                  id\n+                }\n+              }\n+      - post:\n+          url: '/'\n+          json:\n+            query: |\n+              mutation message {\n+                addMessage(chatId: \"1\", content: \"artillery\") {\n+                  id\n+                }\n+              }\n+      - post:\n+          url: '/'\n+          json:\n+            variables:\n+              limit: 20\n+            query: |\n+              fragment User on User {\n+                id\n+                name\n+                picture\n+              }\n+              fragment Message on Message {\n+                id\n+                content\n+                chat {\n+                  id\n+                }\n+                sender {\n+                  ...User\n+                }\n+                recipient {\n+                  ...User\n+                }\n+              }\n+              query GetChats($limit: Int!) {\n+                chats {\n+                  id\n+                  name\n+                  picture\n+                  lastMessage {\n+                    ...Message\n+                  }\n+                  messages(limit: $limit) {\n+                    messages {\n+                      ...Message\n+                    }\n+                  }\n+                  participants {\n+                    ...User\n+                  }\n+                }\n+              }\n\\ No newline at end of file\ndiff --git a/server/artillery.yml b/server/artillery.yml\nnew file mode 100644\nindex 0000000..b590173\n--- /dev/null\n+++ b/server/artillery.yml\n@@ -0,0 +1,72 @@\n+config:\n+  target: 'http://localhost:4000/graphql'\n+  phases:\n+    - duration: 120\n+      arrivalRate: 5\n+      rampTo: 20\n+scenarios:\n+  - name: 'Sign in, send a new message and fetch a list of chats'\n+    flow:\n+      - post:\n+          url: '/'\n+          json:\n+            variables:\n+              username: 'ray'\n+              password: '111'\n+            query: |\n+              mutation SignIn($username: String!, $password: String!) {\n+                signIn(username: $username, password: $password) {\n+                  id\n+                }\n+              }\n+      - post:\n+          url: '/'\n+          json:\n+            query: |\n+              mutation message {\n+                addMessage(chatId: \"1\", content: \"artillery\") {\n+                  id\n+                }\n+              }\n+      - post:\n+          url: '/'\n+          json:\n+            variables:\n+              limit: 20\n+            query: |\n+              fragment User on User {\n+                id\n+                name\n+                picture\n+              }\n+              fragment Message on Message {\n+                id\n+                content\n+                chat {\n+                  id\n+                }\n+                sender {\n+                  ...User\n+                }\n+                recipient {\n+                  ...User\n+                }\n+              }\n+              query GetChats($limit: Int!) {\n+                chats {\n+                  id\n+                  name\n+                  picture\n+                  lastMessage {\n+                    ...Message\n+                  }\n+                  messages(limit: $limit) {\n+                    messages {\n+                      ...Message\n+                    }\n+                  }\n+                  participants {\n+                    ...User\n+                  }\n+                }\n+              }\ndiff --git a/server/codegen.yml b/server/codegen.yml\nindex 9542ce7..7bc10b7 100644\n--- a/server/codegen.yml\n+++ b/server/codegen.yml\n@@ -1,7 +1,7 @@\n overwrite: true\n generates:\n   ./types/graphql.d.ts:\n-    schema: ./modules/*/*.ts\n+    schema: ./modules/*/index.ts\n     plugins:\n       - typescript\n       - typescript-resolvers\ndiff --git a/server/db.ts b/server/db.ts\nindex cd3c287..96b9287 100644\n--- a/server/db.ts\n+++ b/server/db.ts\n@@ -1,38 +1,78 @@\n-import { Pool } from \"pg\";\n-import sql from 'sql-template-strings'\n-import { resetDb as envResetDb } from './env'\n+import { Pool } from 'pg';\n+import sql from 'sql-template-strings';\n+import faker from 'faker';\n+import addMinutes from 'date-fns/add_minutes';\n+import { resetDb as envResetDb, fakedDb } from './env';\n\n export type User = {\n-  id: string\n-  name: string\n-  username: string\n-  password: string\n-  picture: string\n-}\n+  id: string;\n+  name: string;\n+  username: string;\n+  password: string;\n+  picture: string;\n+};\n\n export type Message = {\n-  id: string\n-  content: string\n-  created_at: Date\n-  chat_id: string\n-  sender_user_id: string\n-}\n+  id: string;\n+  content: string;\n+  created_at: Date;\n+  chat_id: string;\n+  sender_user_id: string;\n+};\n\n export type Chat = {\n-  id: string\n-}\n+  id: string;\n+};\n\n-export const pool = new Pool({\n+export const dbConfig = {\n   host: 'localhost',\n-  port: 5432,\n+  port: process.env.DB_PORT ? parseInt(process.env.DB_PORT) : 5432,\n   user: 'testuser',\n   password: 'testpassword',\n-  database: 'whatsapp'\n-})\n+  database: 'whatsapp',\n+};\n\n-export const resetDb = async () => {\n+export let pool: Pool = new Pool(dbConfig);\n\n-  await pool.query(sql`DELETE FROM users`)\n+export async function initDb(): Promise<void> {\n+  // Clear tables\n+  await pool.query(sql`DROP TABLE IF EXISTS messages;`);\n+  await pool.query(sql`DROP TABLE IF EXISTS chats_users;`);\n+  await pool.query(sql`DROP TABLE IF EXISTS users;`);\n+  await pool.query(sql`DROP TABLE IF EXISTS chats;`);\n+\n+  // Create tables\n+  await pool.query(sql`CREATE TABLE chats(\n+    id SERIAL PRIMARY KEY\n+  );`);\n+  await pool.query(sql`CREATE TABLE users(\n+    id SERIAL PRIMARY KEY,\n+    username VARCHAR (50) UNIQUE NOT NULL,\n+    name VARCHAR (50) NOT NULL,\n+    password VARCHAR (255) NOT NULL,\n+    picture VARCHAR (255) NOT NULL\n+  );`);\n+  await pool.query(sql`CREATE TABLE chats_users(\n+    chat_id INTEGER NOT NULL REFERENCES chats(id) ON DELETE CASCADE,\n+    user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE\n+  );`);\n+\n+  await pool.query(sql`CREATE TABLE messages(\n+    id SERIAL PRIMARY KEY,\n+    content VARCHAR (355) NOT NULL,\n+    created_at TIMESTAMP NOT NULL DEFAULT NOW(),\n+    chat_id INTEGER NOT NULL REFERENCES chats(id) ON DELETE CASCADE,\n+    sender_user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE\n+  );`);\n+\n+  // Privileges\n+  await pool.query(\n+    sql`GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO testuser;`\n+  );\n+}\n+\n+export const resetDb = async () => {\n+  await initDb();\n\n   const sampleUsers = [\n     {\n@@ -70,18 +110,26 @@ export const resetDb = async () => {\n       password: '$2a$08$6.mbXqsDX82ZZ7q5d8Osb..JrGSsNp4R3IKj7mxgF6YGT0OmMw242', // 555\n       picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n     },\n-  ]\n+  ];\n\n   for (const sampleUser of sampleUsers) {\n     await pool.query(sql`\n       INSERT INTO users(id, name, username, password, picture)\n-      VALUES(${sampleUser.id}, ${sampleUser.name}, ${sampleUser.username}, ${sampleUser.password}, ${sampleUser.picture})\n-    `)\n+      VALUES(${sampleUser.id}, ${sampleUser.name}, ${sampleUser.username}, ${\n+      sampleUser.password\n+    }, ${sampleUser.picture})\n+    `);\n   }\n\n-  await pool.query(sql`SELECT setval('users_id_seq', (SELECT max(id) FROM users))`)\n+  await pool.query(\n+    sql`SELECT setval('users_id_seq', (SELECT max(id) FROM users))`\n+  );\n\n-  await pool.query(sql`DELETE FROM chats`)\n+  await pool.query(\n+    sql`SELECT setval('users_id_seq', (SELECT max(id) FROM users))`\n+  );\n+\n+  await pool.query(sql`DELETE FROM chats`);\n\n   const sampleChats = [\n     {\n@@ -96,18 +144,20 @@ export const resetDb = async () => {\n     {\n       id: '4',\n     },\n-  ]\n+  ];\n\n   for (const sampleChat of sampleChats) {\n     await pool.query(sql`\n       INSERT INTO chats(id)\n       VALUES(${sampleChat.id})\n-    `)\n+    `);\n   }\n\n-  await pool.query(sql`SELECT setval('chats_id_seq', (SELECT max(id) FROM chats))`)\n+  await pool.query(\n+    sql`SELECT setval('chats_id_seq', (SELECT max(id) FROM chats))`\n+  );\n\n-  await pool.query(sql`DELETE FROM chats_users`)\n+  await pool.query(sql`DELETE FROM chats_users`);\n\n   const sampleChatsUsers = [\n     {\n@@ -142,59 +192,83 @@ export const resetDb = async () => {\n       chat_id: '4',\n       user_id: '5',\n     },\n-  ]\n+  ];\n\n   for (const sampleChatUser of sampleChatsUsers) {\n     await pool.query(sql`\n       INSERT INTO chats_users(chat_id, user_id)\n       VALUES(${sampleChatUser.chat_id}, ${sampleChatUser.user_id})\n-    `)\n+    `);\n   }\n\n-  await pool.query(sql`DELETE FROM messages`)\n+  await pool.query(sql`DELETE FROM messages`);\n+\n+  const baseTime = new Date('1 Jan 2019 GMT').getTime();\n\n   const sampleMessages = [\n     {\n       id: '1',\n-      content: \"You on your way?\",\n-      created_at: new Date(new Date('1-1-2019').getTime() - 60 * 1000 * 1000),\n+      content: 'You on your way?',\n+      created_at: new Date(baseTime - 60 * 1000 * 1000),\n       chat_id: '1',\n       sender_user_id: '1',\n     },\n     {\n       id: '2',\n       content: \"Hey, it's me\",\n-      created_at: new Date(new Date('1-1-2019').getTime() - 2 * 60 * 1000 * 1000),\n+      created_at: new Date(baseTime - 2 * 60 * 1000 * 1000),\n       chat_id: '2',\n       sender_user_id: '1',\n     },\n     {\n       id: '3',\n-      content: \"I should buy a boat\",\n-      created_at: new Date(new Date('1-1-2019').getTime() - 24 * 60 * 1000 * 1000),\n+      content: 'I should buy a boat',\n+      created_at: new Date(baseTime - 24 * 60 * 1000 * 1000),\n       chat_id: '3',\n       sender_user_id: '1',\n     },\n     {\n       id: '4',\n-      content: \"This is wicked good ice cream.\",\n-      created_at: new Date(new Date('1-1-2019').getTime() - 14 * 24 * 60 * 1000 * 1000),\n+      content: 'This is wicked good ice cream.',\n+      created_at: new Date(baseTime - 14 * 24 * 60 * 1000 * 1000),\n       chat_id: '4',\n       sender_user_id: '1',\n     },\n-  ]\n+  ];\n+\n+  if (fakedDb) {\n+    addFakedMessages(sampleMessages, fakedDb);\n+  }\n\n   for (const sampleMessage of sampleMessages) {\n     await pool.query(sql`\n       INSERT INTO messages(id, content, created_at, chat_id, sender_user_id)\n-      VALUES(${sampleMessage.id}, ${sampleMessage.content}, ${sampleMessage.created_at}, ${sampleMessage.chat_id}, ${sampleMessage.sender_user_id})\n-    `)\n+      VALUES(${sampleMessage.id}, ${sampleMessage.content}, ${\n+      sampleMessage.created_at\n+    }, ${sampleMessage.chat_id}, ${sampleMessage.sender_user_id})\n+    `);\n   }\n\n-  await pool.query(sql`SELECT setval('messages_id_seq', (SELECT max(id) FROM messages))`)\n+  await pool.query(\n+    sql`SELECT setval('messages_id_seq', (SELECT max(id) FROM messages))`\n+  );\n+};\n+\n+function addFakedMessages(messages: Message[], count: number) {\n+  const message = messages[0];\n+  const date = message.created_at;\n+  const id = messages.length + 1;\n\n+  new Array(count).fill(0).forEach((_, i) => {\n+    messages.push({\n+      ...message,\n+      id: `${id + i}`,\n+      content: faker.lorem.sentence(4),\n+      created_at: addMinutes(date, i + 1),\n+    });\n+  });\n }\n\n if (envResetDb) {\n-  resetDb()\n+  resetDb();\n }\ndiff --git a/server/env.ts b/server/env.ts\nindex d6b5023..b9c6573 100644\n--- a/server/env.ts\n+++ b/server/env.ts\n@@ -1,7 +1,10 @@\n export const expiration = process.env.JWT_EXPIRATION_MS\n-  ?  parseInt(process.env.JWT_EXPIRATION_MS)\n-  : 24 * 60 * 60 * 1000\n-export const secret = process.env.JWT_SECRET || '70p53cr37'\n-export const origin = process.env.ORIGIN || 'http://localhost:3000'\n-export const port = process.env.PORT || 4000\n+  ? parseInt(process.env.JWT_EXPIRATION_MS)\n+  : 24 * 60 * 60 * 1000;\n+export const secret = process.env.JWT_SECRET || '70p53cr37';\n+export const origin = process.env.ORIGIN || 'http://localhost:3000';\n+export const port = process.env.PORT || 4000;\n export const resetDb = process.env.RESET_DB || false;\n+export const fakedDb = process.env.FAKED_DB\n+  ? parseInt(process.env.FAKED_DB, 10)\n+  : 0;\ndiff --git a/server/index.ts b/server/index.ts\nindex 39dd8b0..72d5893 100644\n--- a/server/index.ts\n+++ b/server/index.ts\n@@ -1,17 +1,17 @@\n-import http from 'http'\n-import { app } from './app'\n-import { origin, port } from './env'\n+import http from 'http';\n+import { app } from './app';\n+import { origin, port } from './env';\n import { server } from './server';\n\n server.applyMiddleware({\n   app,\n   path: '/graphql',\n   cors: { credentials: true, origin },\n-})\n+});\n\n-const httpServer = http.createServer(app)\n-server.installSubscriptionHandlers(httpServer)\n+const httpServer = http.createServer(app);\n+server.installSubscriptionHandlers(httpServer);\n\n httpServer.listen(port, () => {\n-  console.log(`Server is listening on port ${port}`)\n-})\n+  console.log(`Server is listening on port ${port}`);\n+});\ndiff --git a/server/modules/chats/chats.provider.ts b/server/modules/chats/chats.provider.ts\nindex 3659604..9ecf6bc 100644\n--- a/server/modules/chats/chats.provider.ts\n+++ b/server/modules/chats/chats.provider.ts\n@@ -1,7 +1,24 @@\n import { Injectable, Inject, ProviderScope } from '@graphql-modules/di';\n+import { QueryResult } from 'pg';\n import sql from 'sql-template-strings';\n+import DataLoader from 'dataloader';\n+import format from 'date-fns/format';\n import { Database } from '../common/database.provider';\n import { PubSub } from '../common/pubsub.provider';\n+import { Chat } from '../../db';\n+\n+type ChatsByUser = { userId: string };\n+type ChatByUser = { userId: string; chatId: string };\n+type ChatById = { chatId: string };\n+type ChatsKey = ChatById | ChatByUser | ChatsByUser;\n+\n+function isChatsByUser(query: any): query is ChatsByUser {\n+  return query.userId && !query.chatId;\n+}\n+\n+function isChatByUser(query: any): query is ChatByUser {\n+  return query.userId && query.chatId;\n+}\n\n @Injectable({\n   scope: ProviderScope.Session,\n@@ -10,50 +27,140 @@ export class Chats {\n   @Inject() private db: Database;\n   @Inject() private pubsub: PubSub;\n\n+  private chatsCache = new Map<string, Chat>();\n+  private loaders = {\n+    chats: new DataLoader<ChatsKey, QueryResult['rows']>(keys => {\n+      return Promise.all(\n+        keys.map(async query => {\n+          if (isChatsByUser(query)) {\n+            return this._findChatsByUser(query.userId);\n+          }\n+\n+          if (this.chatsCache.has(query.chatId)) {\n+            return [this._readChatFromCache(query.chatId)];\n+          }\n+\n+          if (isChatByUser(query)) {\n+            return this._findChatByUser(query);\n+          }\n+\n+          return this._findChatById(query.chatId);\n+        })\n+      );\n+    }),\n+  };\n+\n   async findChatsByUser(userId: string) {\n-    const db = await this.db.getClient();\n+    return this.loaders.chats.load({ userId });\n+  }\n\n-    const { rows } = await db.query(sql`\n+  private async _findChatsByUser(userId: string) {\n+    const { rows } = await this.db.query(sql`\n       SELECT chats.* FROM chats, chats_users\n       WHERE chats.id = chats_users.chat_id\n       AND chats_users.user_id = ${userId}\n     `);\n\n+    rows.forEach(row => {\n+      this._writeChatToCache(row);\n+    });\n+\n     return rows;\n   }\n\n   async findChatByUser({ chatId, userId }: { chatId: string; userId: string }) {\n-    const db = await this.db.getClient();\n-    const { rows } = await db.query(sql`\n+    const rows = await this.loaders.chats.load({ chatId, userId });\n+\n+    return rows[0] || null;\n+  }\n+\n+  private async _findChatByUser({\n+    chatId,\n+    userId,\n+  }: {\n+    chatId: string;\n+    userId: string;\n+  }) {\n+    const { rows } = await this.db.query(sql`\n       SELECT chats.* FROM chats, chats_users\n       WHERE chats_users.chat_id = ${chatId}\n       AND chats.id = chats_users.chat_id\n       AND chats_users.user_id = ${userId}\n     `);\n\n-    return rows[0] || null;\n+    this._writeChatToCache(rows[0]);\n+\n+    return rows;\n   }\n\n   async findChatById(chatId: string) {\n-    const db = await this.db.getClient();\n-    const { rows } = await db.query(sql`\n+    const rows = await this.loaders.chats.load({ chatId });\n+    return rows[0] || null;\n+  }\n+\n+  private async _findChatById(chatId: string) {\n+    const { rows } = await this.db.query(sql`\n       SELECT * FROM chats WHERE id = ${chatId}\n     `);\n-    return rows[0] || null;\n+\n+    this._writeChatToCache(rows[0]);\n+\n+    return rows;\n   }\n\n-  async findMessagesByChat(chatId: string) {\n-    const db = await this.db.getClient();\n-    const { rows } = await db.query(\n-      sql`SELECT * FROM messages WHERE chat_id = ${chatId}`,\n+  async findMessagesByChat({\n+    chatId,\n+    limit,\n+    after,\n+  }: {\n+    chatId: string;\n+    limit: number;\n+    after?: number | null;\n+  }): Promise<{\n+    hasMore: boolean;\n+    cursor: number | null;\n+    messages: any[];\n+  }> {\n+    const query = sql`SELECT * FROM messages`;\n+    query.append(` WHERE chat_id = ${chatId}`);\n+\n+    if (after) {\n+      // the created_at is the cursor\n+      query.append(` AND created_at < ${cursorToDate(after)}`);\n+    }\n+\n+    query.append(` ORDER BY created_at DESC LIMIT ${limit}`);\n+\n+    const { rows: messages } = await this.db.query(query);\n+\n+    if (!messages) {\n+      return {\n+        hasMore: false,\n+        cursor: null,\n+        messages: [],\n+      };\n+    }\n+\n+    // so we send them as old -> new\n+    messages.reverse();\n+\n+    // cursor is a number representation of created_at\n+    const cursor = messages.length ? new Date(messages[0].created_at).getTime() : 0;\n+    const { rows: next } = await this.db.query(\n+      sql`SELECT * FROM messages WHERE chat_id = ${chatId} AND created_at < ${cursorToDate(\n+        cursor\n+      )} ORDER BY created_at DESC LIMIT 1`\n     );\n\n-    return rows;\n+    return {\n+      hasMore: next.length === 1, // means there's no more messages\n+      cursor,\n+      messages,\n+    };\n   }\n\n   async lastMessage(chatId: string) {\n-    const db = await this.db.getClient();\n-    const { rows } = await db.query(sql`\n+    const { rows } = await this.db.query(sql`\n       SELECT * FROM messages\n       WHERE chat_id = ${chatId}\n       ORDER BY created_at DESC\n@@ -64,8 +171,7 @@ export class Chats {\n   }\n\n   async firstRecipient({ chatId, userId }: { chatId: string; userId: string }) {\n-    const db = await this.db.getClient();\n-    const { rows } = await db.query(sql`\n+    const { rows } = await this.db.query(sql`\n       SELECT users.* FROM users, chats_users\n       WHERE users.id != ${userId}\n       AND users.id = chats_users.user_id\n@@ -76,8 +182,7 @@ export class Chats {\n   }\n\n   async participants(chatId: string) {\n-    const db = await this.db.getClient();\n-    const { rows } = await db.query(sql`\n+    const { rows } = await this.db.query(sql`\n       SELECT users.* FROM users, chats_users\n       WHERE chats_users.chat_id = ${chatId}\n       AND chats_users.user_id = users.id\n@@ -87,8 +192,7 @@ export class Chats {\n   }\n\n   async isParticipant({ chatId, userId }: { chatId: string; userId: string }) {\n-    const db = await this.db.getClient();\n-    const { rows } = await db.query(sql`\n+    const { rows } = await this.db.query(sql`\n       SELECT * FROM chats_users\n       WHERE chat_id = ${chatId}\n       AND user_id = ${userId}\n@@ -106,8 +210,7 @@ export class Chats {\n     userId: string;\n     content: string;\n   }) {\n-    const db = await this.db.getClient();\n-    const { rows } = await db.query(sql`\n+    const { rows } = await this.db.query(sql`\n       INSERT INTO messages(chat_id, sender_user_id, content)\n       VALUES(${chatId}, ${userId}, ${content})\n       RETURNING *\n@@ -129,8 +232,7 @@ export class Chats {\n     userId: string;\n     recipientId: string;\n   }) {\n-    const db = await this.db.getClient();\n-    const { rows } = await db.query(sql`\n+    const { rows } = await this.db.query(sql`\n       SELECT chats.* FROM chats, (SELECT * FROM chats_users WHERE user_id = ${userId}) AS chats_of_current_user, chats_users\n       WHERE chats_users.chat_id = chats_of_current_user.chat_id\n       AND chats.id = chats_users.chat_id\n@@ -143,9 +245,9 @@ export class Chats {\n     }\n\n     try {\n-      await db.query('BEGIN');\n+      await this.db.query('BEGIN');\n\n-      const { rows } = await db.query(sql`\n+      const { rows } = await this.db.query(sql`\n         INSERT INTO chats\n         DEFAULT VALUES\n         RETURNING *\n@@ -153,17 +255,17 @@ export class Chats {\n\n       const chatAdded = rows[0];\n\n-      await db.query(sql`\n+      await this.db.query(sql`\n         INSERT INTO chats_users(chat_id, user_id)\n         VALUES(${chatAdded.id}, ${userId})\n       `);\n\n-      await db.query(sql`\n+      await this.db.query(sql`\n         INSERT INTO chats_users(chat_id, user_id)\n         VALUES(${chatAdded.id}, ${recipientId})\n       `);\n\n-      await db.query('COMMIT');\n+      await this.db.query('COMMIT');\n\n       this.pubsub.publish('chatAdded', {\n         chatAdded,\n@@ -171,18 +273,16 @@ export class Chats {\n\n       return chatAdded;\n     } catch (e) {\n-      await db.query('ROLLBACK');\n+      await this.db.query('ROLLBACK');\n       throw e;\n     }\n   }\n\n   async removeChat({ chatId, userId }: { chatId: string; userId: string }) {\n-    const db = await this.db.getClient();\n-\n     try {\n-      await db.query('BEGIN');\n+      await this.db.query('BEGIN');\n\n-      const { rows } = await db.query(sql`\n+      const { rows } = await this.db.query(sql`\n         SELECT chats.* FROM chats, chats_users\n         WHERE id = ${chatId}\n         AND chats.id = chats_users.chat_id\n@@ -192,11 +292,11 @@ export class Chats {\n       const chat = rows[0];\n\n       if (!chat) {\n-        await db.query('ROLLBACK');\n+        await this.db.query('ROLLBACK');\n         return null;\n       }\n\n-      await db.query(sql`\n+      await this.db.query(sql`\n         DELETE FROM chats WHERE chats.id = ${chatId}\n       `);\n\n@@ -205,12 +305,26 @@ export class Chats {\n         targetChat: chat,\n       });\n\n-      await db.query('COMMIT');\n+      await this.db.query('COMMIT');\n\n       return chatId;\n     } catch (e) {\n-      await db.query('ROLLBACK');\n+      await this.db.query('ROLLBACK');\n       throw e;\n     }\n   }\n+\n+  private _readChatFromCache(chatId: string) {\n+    return this.chatsCache.get(chatId);\n+  }\n+\n+  private _writeChatToCache(chat?: Chat) {\n+    if (chat) {\n+      this.chatsCache.set(chat.id, chat);\n+    }\n+  }\n+}\n+\n+function cursorToDate(cursor: number) {\n+  return `'${format(cursor, 'YYYY-MM-DD HH:mm:ss')}'`;\n }\ndiff --git a/server/modules/chats/index.ts b/server/modules/chats/index.ts\nindex a8dd8ff..708b6ab 100644\n--- a/server/modules/chats/index.ts\n+++ b/server/modules/chats/index.ts\n@@ -21,12 +21,18 @@ const typeDefs = gql`\n     isMine: Boolean!\n   }\n\n+  type MessagesResult {\n+    cursor: Float\n+    hasMore: Boolean!\n+    messages: [Message!]!\n+  }\n+\n   type Chat {\n     id: ID!\n     name: String\n     picture: String\n     lastMessage: Message\n-    messages: [Message!]!\n+    messages(limit: Int!, after: Float): MessagesResult!\n     participants: [User!]!\n   }\n\n@@ -105,7 +111,11 @@ const resolvers: Resolvers = {\n     },\n\n     async messages(chat, args, { injector }) {\n-      return injector.get(Chats).findMessagesByChat(chat.id);\n+      return injector.get(Chats).findMessagesByChat({\n+        chatId: chat.id,\n+        limit: args.limit,\n+        after: args.after,\n+      });\n     },\n\n     async lastMessage(chat, args, { injector }) {\n@@ -120,7 +130,7 @@ const resolvers: Resolvers = {\n   Query: {\n     async chats(root, args, { injector }) {\n       const currentUser = await injector.get(Auth).currentUser();\n-\n+\n       if (!currentUser) return [];\n\n       return injector.get(Chats).findChatsByUser(currentUser.id);\n@@ -150,7 +160,7 @@ const resolvers: Resolvers = {\n\n     async addChat(root, { recipientId }, { injector }) {\n       const currentUser = await injector.get(Auth).currentUser();\n-\n+\n       if (!currentUser) return null;\n\n       return injector\n@@ -175,7 +185,7 @@ const resolvers: Resolvers = {\n         async (\n           { messageAdded }: { messageAdded: Message },\n           args,\n-          { injector },\n+          { injector }\n         ) => {\n           const currentUser = await injector.get(Auth).currentUser();\n\n@@ -185,7 +195,7 @@ const resolvers: Resolvers = {\n             chatId: messageAdded.chat_id,\n             userId: currentUser.id,\n           });\n-        },\n+        }\n       ),\n     },\n\n@@ -193,11 +203,7 @@ const resolvers: Resolvers = {\n       subscribe: withFilter(\n         (root, args, { injector }) =>\n           injector.get(PubSub).asyncIterator('chatAdded'),\n-        async (\n-          { chatAdded }: { chatAdded: Chat },\n-          args,\n-          { injector },\n-        ) => {\n+        async ({ chatAdded }: { chatAdded: Chat }, args, { injector }) => {\n           const currentUser = await injector.get(Auth).currentUser();\n\n           if (!currentUser) return false;\n@@ -206,7 +212,7 @@ const resolvers: Resolvers = {\n             chatId: chatAdded.id,\n             userId: currentUser.id,\n           });\n-        },\n+        }\n       ),\n     },\n\n@@ -214,20 +220,16 @@ const resolvers: Resolvers = {\n       subscribe: withFilter(\n         (root, args, { injector }) =>\n           injector.get(PubSub).asyncIterator('chatRemoved'),\n-        async (\n-          { targetChat }: { targetChat: Chat },\n-          args,\n-          { injector },\n-        ) => {\n+        async ({ targetChat }: { targetChat: Chat }, args, { injector }) => {\n           const currentUser = await injector.get(Auth).currentUser();\n-\n+\n           if (!currentUser) return false;\n\n           return injector.get(Chats).isParticipant({\n             chatId: targetChat.id,\n             userId: currentUser.id,\n           });\n-        },\n+        }\n       ),\n     },\n   },\ndiff --git a/server/modules/chats/unsplash.api.ts b/server/modules/chats/unsplash.api.ts\nindex cb993f0..7b08c81 100644\n--- a/server/modules/chats/unsplash.api.ts\n+++ b/server/modules/chats/unsplash.api.ts\n@@ -36,7 +36,7 @@ export class UnsplashApi {\n         provider: 'Unsplash',\n         method: 'RandomPhoto',\n         location: resolve(__dirname, '../logs/main'),\n-      },\n+      }\n     );\n\n     try {\ndiff --git a/server/modules/common/database.provider.ts b/server/modules/common/database.provider.ts\nindex 4e72c6a..6798a4e 100644\n--- a/server/modules/common/database.provider.ts\n+++ b/server/modules/common/database.provider.ts\n@@ -1,14 +1,41 @@\n import { Injectable, ProviderScope } from '@graphql-modules/di';\n import { OnResponse } from '@graphql-modules/core';\n-import { Pool, PoolClient } from 'pg';\n+import { Pool, PoolClient, QueryResult } from 'pg';\n+import { SQLStatement } from 'sql-template-strings';\n+import Dataloader from 'dataloader';\n\n @Injectable({\n   scope: ProviderScope.Session,\n })\n export class Database implements OnResponse {\n   private instance: PoolClient;\n+  private loader: Dataloader<string | SQLStatement, QueryResult>;\n\n-  constructor(private pool: Pool) {}\n+  constructor(private pool: Pool) {\n+    this.loader = new Dataloader(\n+      queries =>\n+        Promise.all(\n+          queries.map(async query => {\n+            const db = await this.getClient();\n+            return db.query(query);\n+          })\n+        ),\n+      {\n+        cacheKeyFn: (key: string | SQLStatement) => {\n+          let id: string;\n+\n+          if (typeof key === 'string') {\n+            id = key;\n+          } else {\n+            id = key.text + ' - ' + JSON.stringify(key.values);\n+          }\n+\n+          return id;\n+        },\n+        batch: false,\n+      }\n+    );\n+  }\n\n   async onRequest() {\n     this.instance = await this.pool.connect();\n@@ -20,7 +47,11 @@ export class Database implements OnResponse {\n     }\n   }\n\n-  async getClient() {\n+  private getClient() {\n     return this.instance;\n   }\n-}\n\\ No newline at end of file\n+\n+  query(query: SQLStatement | string) {\n+    return this.loader.load(query);\n+  }\n+}\ndiff --git a/server/modules/common/index.ts b/server/modules/common/index.ts\nindex ddad1f0..bff47ab 100644\n--- a/server/modules/common/index.ts\n+++ b/server/modules/common/index.ts\n@@ -32,7 +32,7 @@ const resolvers: Resolvers = {\n\n const pubsub = new PostgresPubSub({\n   host: 'localhost',\n-  port: 5432,\n+  port: process.env.DB_PORT ? parseInt(process.env.DB_PORT) : 5432,\n   user: 'testuser',\n   password: 'testpassword',\n   database: 'whatsapp',\ndiff --git a/server/modules/common/pubsub.provider.ts b/server/modules/common/pubsub.provider.ts\nindex d1455e2..cf85ba4 100644\n--- a/server/modules/common/pubsub.provider.ts\n+++ b/server/modules/common/pubsub.provider.ts\n@@ -1 +1 @@\n-export { PubSub } from 'apollo-server-express';\n\\ No newline at end of file\n+export { PubSub } from 'apollo-server-express';\ndiff --git a/server/modules/users/auth.provider.ts b/server/modules/users/auth.provider.ts\nindex a781b82..2d06a37 100644\n--- a/server/modules/users/auth.provider.ts\n+++ b/server/modules/users/auth.provider.ts\n@@ -14,9 +14,10 @@ import { User } from '../../db';\n export class Auth {\n   @Inject() private users: Users;\n   @Inject() private module: ModuleSessionInfo;\n+  private _currentUser: User;\n\n   private get req() {\n-    return this.module.session.req;\n+    return this.module.session.req || this.module.session.request;\n   }\n\n   private get res(): Response {\n@@ -55,7 +56,7 @@ export class Auth {\n     username: string;\n   }) {\n     validateLength('req.name', name, 3, 50);\n-    validateLength('req.username', name, 3, 18);\n+    validateLength('req.username', username, 3, 18);\n     validatePassword('req.password', password);\n\n     if (password !== passwordConfirm) {\n@@ -74,16 +75,21 @@ export class Auth {\n       password,\n     });\n   }\n-\n+\n   async currentUser(): Promise<User | null> {\n+    if (this._currentUser) {\n+      return this._currentUser;\n+    }\n+\n     if (this.req.cookies.authToken) {\n       const username = jwt.verify(this.req.cookies.authToken, secret) as string;\n\n       if (username) {\n-        return this.users.findByUsername(username);\n+        this._currentUser = await this.users.findByUsername(username);\n+        return this._currentUser;\n       }\n     }\n\n     return null;\n   }\n-}\n\\ No newline at end of file\n+}\ndiff --git a/server/modules/users/index.ts b/server/modules/users/index.ts\nindex 93e30ea..74f7601 100644\n--- a/server/modules/users/index.ts\n+++ b/server/modules/users/index.ts\n@@ -35,7 +35,7 @@ const resolvers: Resolvers = {\n     },\n     async users(root, args, { injector }) {\n       const currentUser = await injector.get(Auth).currentUser();\n-\n+\n       if (!currentUser) return [];\n\n       return injector.get(Users).findAllExcept(currentUser.id);\n@@ -43,11 +43,17 @@ const resolvers: Resolvers = {\n   },\n   Mutation: {\n     async signIn(root, { username, password }, { injector }) {\n-      return injector.get(Auth).signIn({username, password});\n+      return injector.get(Auth).signIn({ username, password });\n     },\n\n-    async signUp(root, { name, username, password, passwordConfirm }, { injector }) {\n-      return injector.get(Auth).signUp({name, username, password, passwordConfirm });\n+    async signUp(\n+      root,\n+      { name, username, password, passwordConfirm },\n+      { injector }\n+    ) {\n+      return injector\n+        .get(Auth)\n+        .signUp({ name, username, password, passwordConfirm });\n     },\n   },\n };\n@@ -57,5 +63,5 @@ export default new GraphQLModule({\n   typeDefs,\n   resolvers,\n   imports: () => [commonModule],\n-  providers: () => [Users, Auth]\n+  providers: () => [Users, Auth],\n });\ndiff --git a/server/modules/users/users.provider.ts b/server/modules/users/users.provider.ts\nindex daf32fd..2651863 100644\n--- a/server/modules/users/users.provider.ts\n+++ b/server/modules/users/users.provider.ts\n@@ -3,6 +3,8 @@ import sql from 'sql-template-strings';\n import bcrypt from 'bcrypt';\n import { Database } from '../common/database.provider';\n\n+const DEFAULT_PROFILE_PIC = 'https://raw.githubusercontent.com/Urigo/WhatsApp-Clone-Client-React/legacy/public/assets/default-profile-pic.jpg'\n+\n @Injectable({\n   scope: ProviderScope.Session,\n })\n@@ -10,27 +12,24 @@ export class Users {\n   @Inject() private db: Database;\n\n   async findById(userId: string) {\n-    const db = await this.db.getClient();\n-    const { rows } = await db.query(\n-      sql`SELECT * FROM users WHERE id = ${userId}`,\n+    const { rows } = await this.db.query(\n+      sql`SELECT * FROM users WHERE id = ${userId}`\n     );\n\n     return rows[0] || null;\n   }\n\n   async findAllExcept(userId: string) {\n-    const db = await this.db.getClient();\n-    const { rows } = await db.query(\n-      sql`SELECT * FROM users WHERE id != ${userId}`,\n+    const { rows } = await this.db.query(\n+      sql`SELECT * FROM users WHERE id != ${userId}`\n     );\n\n     return rows;\n   }\n\n   async findByUsername(username: string) {\n-    const db = await this.db.getClient();\n-    const { rows } = await db.query(\n-      sql`SELECT * FROM users WHERE username = ${username}`,\n+    const { rows } = await this.db.query(\n+      sql`SELECT * FROM users WHERE username = ${username}`\n     );\n\n     return rows[0] || null;\n@@ -45,15 +44,14 @@ export class Users {\n     name: string;\n     password: string;\n   }) {\n-    const db = await this.db.getClient();\n     const passwordHash = bcrypt.hashSync(password, bcrypt.genSaltSync(8));\n-    const createdUserQuery = await db.query(sql`\n+    const createdUserQuery = await this.db.query(sql`\n         INSERT INTO users(password, picture, username, name)\n-        VALUES(${passwordHash}, '', ${username}, ${name})\n+        VALUES(${passwordHash}, ${DEFAULT_PROFILE_PIC}, ${username}, ${name})\n         RETURNING *\n       `);\n     const user = createdUserQuery.rows[0];\n\n     return user;\n   }\n-}\n\\ No newline at end of file\n+}\ndiff --git a/server/package.json b/server/package.json\nindex 30019b0..e484c4b 100644\n--- a/server/package.json\n+++ b/server/package.json\n@@ -7,58 +7,84 @@\n   },\n   \"private\": true,\n   \"scripts\": {\n+    \"prestart\": \"yarn codegen\",\n     \"start\": \"ts-node index.ts\",\n-    \"test\": \"jest --runInBand\",\n-    \"codegen\": \"gql-gen\"\n+    \"prebuild\": \"yarn codegen\",\n+    \"prod\": \"node dist/index.js\",\n+    \"build\": \"tsc\",\n+    \"test\": \"TZ=\\\"Asia/Jerusalem\\\" jest --runInBand --forceExit\",\n+    \"codegen\": \"gql-gen\",\n+    \"format\": \"prettier \\\"**/*.ts\\\" --write\",\n+    \"loadtest\": \"yarn artillery run artillery.yml > loadtest.log\",\n+    \"loadtest:limit\": \"yarn artillery run artillery-limit.yml > loadtest.log\"\n+  },\n+  \"jest-junit\": {\n+    \"outputDirectory\": \"./test-results\"\n   },\n   \"devDependencies\": {\n-    \"@graphql-codegen/cli\": \"1.0.3\",\n-    \"@graphql-codegen/typescript\": \"1.0.3\",\n-    \"@graphql-codegen/typescript-resolvers\": \"1.0.3\",\n+    \"@graphql-codegen/cli\": \"1.5.0\",\n+    \"@graphql-codegen/typescript\": \"1.5.0\",\n+    \"@graphql-codegen/typescript-resolvers\": \"1.5.0\",\n     \"@types/bcrypt\": \"3.0.0\",\n-    \"@types/body-parser\": \"1.17.0\",\n+    \"@types/cors\": \"2.8.5\",\n+    \"@types/cookie\": \"0.3.3\",\n     \"@types/cookie-parser\": \"1.4.1\",\n-    \"@types/cors\": \"2.8.4\",\n-    \"@types/express\": \"4.16.1\",\n-    \"@types/graphql\": \"14.0.7\",\n+    \"@types/express\": \"4.17.0\",\n+    \"@types/faker\": \"4.1.5\",\n+    \"@types/graphql\": \"14.2.3\",\n     \"@types/graphql-iso-date\": \"3.3.1\",\n-    \"@types/jest\": \"24.0.11\",\n-    \"@types/jsonwebtoken\": \"8.3.2\",\n-    \"@types/lodash\": \"4.14.126\",\n-    \"@types/node\": \"11.11.0\",\n-    \"@types/pg\": \"^7.4.14\",\n-    \"jest\": \"24.5.0\",\n-    \"ts-jest\": \"24.0.0\",\n-    \"ts-node\": \"8.0.3\",\n-    \"typescript\": \"3.3.3333\"\n+    \"@types/jest\": \"24.0.17\",\n+    \"@types/jsonwebtoken\": \"8.3.3\",\n+    \"@types/lodash\": \"4.14.136\",\n+    \"@types/node\": \"12.7.1\",\n+    \"@types/pg\": \"7.4.14\",\n+    \"artillery\": \"1.6.0-28\",\n+    \"jest\": \"24.8.0\",\n+    \"jest-junit\": \"7.0.0\",\n+    \"prettier\": \"1.18.2\",\n+    \"ts-jest\": \"24.0.2\",\n+    \"ts-node\": \"8.3.0\",\n+    \"typescript\": \"3.5.3\"\n   },\n   \"dependencies\": {\n-    \"@graphql-modules/core\": \"0.7.1\",\n-    \"@graphql-modules/di\": \"0.7.1\",\n-    \"@safe-api/middleware\": \"^0.0.2\",\n-    \"apollo-datasource-rest\": \"^0.4.0\",\n-    \"apollo-server-express\": \"2.4.8\",\n-    \"apollo-server-testing\": \"2.4.8\",\n-    \"axios\": \"0.18.0\",\n-    \"bcrypt\": \"3.0.5\",\n-    \"body-parser\": \"1.18.3\",\n-    \"cookie-parser\": \"1.4.4\",\n+    \"@graphql-modules/core\": \"0.7.9\",\n+    \"@graphql-modules/di\": \"0.7.9\",\n+    \"@safe-api/middleware\": \"0.0.2\",\n+    \"apollo-datasource-rest\": \"0.6.1\",\n+    \"apollo-server-express\": \"2.8.1\",\n+    \"apollo-server-testing\": \"2.8.1\",\n+    \"axios\": \"0.19.0\",\n+    \"bcrypt\": \"3.0.6\",\n+    \"cookie\": \"0.4.0\",\n     \"cors\": \"2.8.5\",\n-    \"express\": \"4.16.4\",\n-    \"graphql\": \"14.1.1\",\n+    \"cookie-parser\": \"1.4.4\",\n+    \"dataloader\": \"1.4.0\",\n+    \"date-fns\": \"1.30.1\",\n+    \"express\": \"4.17.1\",\n+    \"faker\": \"4.1.0\",\n+    \"graphql\": \"14.4.2\",\n     \"graphql-import\": \"0.7.1\",\n     \"graphql-iso-date\": \"3.6.1\",\n-    \"graphql-postgres-subscriptions\": \"^1.0.5\",\n-    \"graphql-tools\": \"4.0.4\",\n+    \"graphql-postgres-subscriptions\": \"1.0.5\",\n+    \"graphql-tools\": \"4.0.5\",\n     \"jsonwebtoken\": \"8.5.1\",\n-    \"lodash\": \"4.17.11\",\n-    \"pg\": \"^7.10.0\",\n+    \"lodash\": \"4.17.15\",\n+    \"pg\": \"7.12.1\",\n     \"reflect-metadata\": \"0.1.13\",\n-    \"sql-template-strings\": \"^2.2.2\"\n+    \"sql-template-strings\": \"2.2.2\"\n   },\n   \"jest\": {\n     \"transform\": {\n       \"^.+\\\\.(js|jsx|ts|tsx)$\": \"<rootDir>/node_modules/ts-jest\"\n-    }\n+    },\n+    \"globals\": {\n+      \"ts-jest\": {\n+        \"diagnostics\": false\n+      }\n+    },\n+    \"reporters\": [\n+      \"default\",\n+      \"jest-junit\"\n+    ]\n   }\n-}\n+}\n\\ No newline at end of file\ndiff --git a/server/server.ts b/server/server.ts\nindex 43e68ac..ce1b8bb 100644\n--- a/server/server.ts\n+++ b/server/server.ts\n@@ -1,16 +1,29 @@\n import 'reflect-metadata';\n-import { ApolloServer } from 'apollo-server-express'\n-import { GraphQLModule } from '@graphql-modules/core'\n+import { ApolloServer } from 'apollo-server-express';\n+import { GraphQLModule } from '@graphql-modules/core';\n+import cookie from 'cookie';\n\n-import usersModule from './modules/users'\n-import chatsModule from './modules/chats'\n+import usersModule from './modules/users';\n+import chatsModule from './modules/chats';\n\n export const rootModule = new GraphQLModule({\n   name: 'root',\n-  imports: [usersModule, chatsModule]\n-})\n+  imports: [usersModule, chatsModule],\n+});\n\n export const server = new ApolloServer({\n   schema: rootModule.schema,\n-  context: rootModule.context\n-})\n+  context: (session: any) => {\n+    if (session.connection) {\n+      const req = session.connection.context.session.request;\n+      const cookies = req.headers.cookie;\n+\n+      if (cookies) {\n+        req.cookies = cookie.parse(cookies);\n+      }\n+    }\n+\n+    return rootModule.context(session);\n+  },\n+  subscriptions: rootModule.subscriptions,\n+});\ndiff --git a/server/tests/mocks/auth.provider.ts b/server/tests/mocks/auth.provider.ts\nindex 074f62c..6f2d5af 100644\n--- a/server/tests/mocks/auth.provider.ts\n+++ b/server/tests/mocks/auth.provider.ts\n@@ -7,7 +7,7 @@ export function mockAuth(userId: number) {\n   class AuthMock extends Auth {\n     async currentUser() {\n       const { rows } = await pool.query(\n-        sql`SELECT * FROM users WHERE id = ${userId}`,\n+        sql`SELECT * FROM users WHERE id = ${userId}`\n       );\n       return rows[0];\n     }\n@@ -18,4 +18,4 @@ export function mockAuth(userId: number) {\n     useClass: AuthMock,\n     overwrite: true,\n   });\n-}\n\\ No newline at end of file\n+}\ndiff --git a/server/tests/mutations/addChat.test.ts b/server/tests/mutations/addChat.test.ts\nindex ad369f2..2c33de7 100644\n--- a/server/tests/mutations/addChat.test.ts\n+++ b/server/tests/mutations/addChat.test.ts\n@@ -1,20 +1,20 @@\n-import { createTestClient } from 'apollo-server-testing'\n-import { gql } from 'apollo-server-express'\n+import { createTestClient } from 'apollo-server-testing';\n+import { gql } from 'apollo-server-express';\n import { server } from '../../server';\n-import { resetDb } from '../../db'\n+import { resetDb } from '../../db';\n import { mockAuth } from '../mocks/auth.provider';\n\n describe('Mutation.addChat', () => {\n-  beforeEach(resetDb)\n+  beforeEach(resetDb);\n\n   it('creates a new chat between current user and specified recipient', async () => {\n     mockAuth(2);\n\n-    const { query, mutate } = createTestClient(server)\n+    const { query, mutate } = createTestClient(server);\n\n     const addChatRes = await mutate({\n       variables: { recipientId: '3' },\n-      mutation: gql `\n+      mutation: gql`\n         mutation AddChat($recipientId: ID!) {\n           addChat(recipientId: $recipientId) {\n             id\n@@ -25,15 +25,15 @@ describe('Mutation.addChat', () => {\n           }\n         }\n       `,\n-    })\n+    });\n\n-    expect(addChatRes.data).toBeDefined()\n-    expect(addChatRes.errors).toBeUndefined()\n-    expect(addChatRes.data).toMatchSnapshot()\n+    expect(addChatRes.data).toBeDefined();\n+    expect(addChatRes.errors).toBeUndefined();\n+    expect(addChatRes.data).toMatchSnapshot();\n\n     const getChatRes = await query({\n       variables: { chatId: '5' },\n-      query: gql `\n+      query: gql`\n         query GetChat($chatId: ID!) {\n           chat(chatId: $chatId) {\n             id\n@@ -44,21 +44,21 @@ describe('Mutation.addChat', () => {\n           }\n         }\n       `,\n-    })\n+    });\n\n-    expect(getChatRes.data).toBeDefined()\n-    expect(getChatRes.errors).toBeUndefined()\n-    expect(getChatRes.data).toMatchSnapshot()\n-  })\n+    expect(getChatRes.data).toBeDefined();\n+    expect(getChatRes.errors).toBeUndefined();\n+    expect(getChatRes.data).toMatchSnapshot();\n+  });\n\n   it('returns the existing chat if so', async () => {\n     mockAuth(1);\n\n-    const { query, mutate } = createTestClient(server)\n+    const { query, mutate } = createTestClient(server);\n\n     const addChatRes = await mutate({\n       variables: { recipientId: '2' },\n-      mutation: gql `\n+      mutation: gql`\n         mutation AddChat($recipientId: ID!) {\n           addChat(recipientId: $recipientId) {\n             id\n@@ -69,10 +69,10 @@ describe('Mutation.addChat', () => {\n           }\n         }\n       `,\n-    })\n+    });\n\n-    expect(addChatRes.data).toBeDefined()\n-    expect(addChatRes.errors).toBeUndefined()\n-    expect(addChatRes.data).toMatchSnapshot()\n-  })\n-})\n+    expect(addChatRes.data).toBeDefined();\n+    expect(addChatRes.errors).toBeUndefined();\n+    expect(addChatRes.data).toMatchSnapshot();\n+  });\n+});\ndiff --git a/server/tests/mutations/addMessage.test.ts b/server/tests/mutations/addMessage.test.ts\nindex ec98e08..60e2995 100644\n--- a/server/tests/mutations/addMessage.test.ts\n+++ b/server/tests/mutations/addMessage.test.ts\n@@ -1,20 +1,20 @@\n-import { createTestClient } from 'apollo-server-testing'\n-import { gql } from 'apollo-server-express'\n+import { createTestClient } from 'apollo-server-testing';\n+import { gql } from 'apollo-server-express';\n import { server } from '../../server';\n-import { resetDb } from '../../db'\n+import { resetDb } from '../../db';\n import { mockAuth } from '../mocks/auth.provider';\n\n describe('Mutation.addMessage', () => {\n-  beforeEach(resetDb)\n+  beforeEach(resetDb);\n\n   it('should add message to specified chat', async () => {\n     mockAuth(1);\n\n-    const { query, mutate } = createTestClient(server)\n+    const { query, mutate } = createTestClient(server);\n\n     const addMessageRes = await mutate({\n       variables: { chatId: '1', content: 'Hello World' },\n-      mutation: gql `\n+      mutation: gql`\n         mutation AddMessage($chatId: ID!, $content: String!) {\n           addMessage(chatId: $chatId, content: $content) {\n             id\n@@ -22,15 +22,15 @@ describe('Mutation.addMessage', () => {\n           }\n         }\n       `,\n-    })\n+    });\n\n-    expect(addMessageRes.data).toBeDefined()\n-    expect(addMessageRes.errors).toBeUndefined()\n-    expect(addMessageRes.data).toMatchSnapshot()\n+    expect(addMessageRes.data).toBeDefined();\n+    expect(addMessageRes.errors).toBeUndefined();\n+    expect(addMessageRes.data).toMatchSnapshot();\n\n     const getChatRes = await query({\n       variables: { chatId: '1' },\n-      query: gql `\n+      query: gql`\n         query GetChat($chatId: ID!) {\n           chat(chatId: $chatId) {\n             id\n@@ -41,10 +41,10 @@ describe('Mutation.addMessage', () => {\n           }\n         }\n       `,\n-    })\n+    });\n\n-    expect(getChatRes.data).toBeDefined()\n-    expect(getChatRes.errors).toBeUndefined()\n-    expect(getChatRes.data).toMatchSnapshot()\n-  })\n-})\n+    expect(getChatRes.data).toBeDefined();\n+    expect(getChatRes.errors).toBeUndefined();\n+    expect(getChatRes.data).toMatchSnapshot();\n+  });\n+});\ndiff --git a/server/tests/mutations/removeChat.test.ts b/server/tests/mutations/removeChat.test.ts\nindex 010232d..25425d4 100644\n--- a/server/tests/mutations/removeChat.test.ts\n+++ b/server/tests/mutations/removeChat.test.ts\n@@ -1,33 +1,33 @@\n-import { createTestClient } from 'apollo-server-testing'\n-import { gql } from 'apollo-server-express'\n+import { createTestClient } from 'apollo-server-testing';\n+import { gql } from 'apollo-server-express';\n import { server } from '../../server';\n-import { resetDb } from '../../db'\n+import { resetDb } from '../../db';\n import { mockAuth } from '../mocks/auth.provider';\n\n describe('Mutation.removeChat', () => {\n-  beforeEach(resetDb)\n+  beforeEach(resetDb);\n\n   it('removes chat by id', async () => {\n     mockAuth(1);\n\n-    const { query, mutate } = createTestClient(server)\n+    const { query, mutate } = createTestClient(server);\n\n     const addChatRes = await mutate({\n       variables: { chatId: '1' },\n-      mutation: gql `\n+      mutation: gql`\n         mutation RemoveChat($chatId: ID!) {\n           removeChat(chatId: $chatId)\n         }\n       `,\n-    })\n+    });\n\n-    expect(addChatRes.data).toBeDefined()\n-    expect(addChatRes.errors).toBeUndefined()\n-    expect(addChatRes.data!.removeChat).toEqual('1')\n+    expect(addChatRes.data).toBeDefined();\n+    expect(addChatRes.errors).toBeUndefined();\n+    expect(addChatRes.data!.removeChat).toEqual('1');\n\n     const getChatRes = await query({\n       variables: { chatId: '1' },\n-      query: gql `\n+      query: gql`\n         query GetChat($chatId: ID!) {\n           chat(chatId: $chatId) {\n             id\n@@ -38,10 +38,10 @@ describe('Mutation.removeChat', () => {\n           }\n         }\n       `,\n-    })\n+    });\n\n-    expect(addChatRes.data).toBeDefined()\n-    expect(getChatRes.errors).toBeUndefined()\n-    expect(addChatRes.data!.chat).toBeUndefined()\n-  })\n-})\n+    expect(addChatRes.data).toBeDefined();\n+    expect(getChatRes.errors).toBeUndefined();\n+    expect(addChatRes.data!.chat).toBeUndefined();\n+  });\n+});\ndiff --git a/server/tests/queries/__snapshots__/getChat.test.ts.snap b/server/tests/queries/__snapshots__/getChat.test.ts.snap\nindex 64b1e2b..628b2cd 100644\n--- a/server/tests/queries/__snapshots__/getChat.test.ts.snap\n+++ b/server/tests/queries/__snapshots__/getChat.test.ts.snap\n@@ -6,7 +6,7 @@ Object {\n     \"id\": \"1\",\n     \"lastMessage\": Object {\n       \"content\": \"You on your way?\",\n-      \"createdAt\": \"2018-12-31T06:20:00.000Z\",\n+      \"createdAt\": \"2018-12-31T07:20:00.000Z\",\n       \"id\": \"1\",\n     },\n     \"name\": \"Ethan Gonzalez\",\ndiff --git a/server/tests/queries/__snapshots__/getChats.test.ts.snap b/server/tests/queries/__snapshots__/getChats.test.ts.snap\nindex 1bd3a67..951f50a 100644\n--- a/server/tests/queries/__snapshots__/getChats.test.ts.snap\n+++ b/server/tests/queries/__snapshots__/getChats.test.ts.snap\n@@ -7,7 +7,7 @@ Object {\n       \"id\": \"1\",\n       \"lastMessage\": Object {\n         \"content\": \"You on your way?\",\n-        \"createdAt\": \"2018-12-31T06:20:00.000Z\",\n+        \"createdAt\": \"2018-12-31T07:20:00.000Z\",\n         \"id\": \"1\",\n       },\n       \"name\": \"Ethan Gonzalez\",\n@@ -17,7 +17,7 @@ Object {\n       \"id\": \"2\",\n       \"lastMessage\": Object {\n         \"content\": \"Hey, it's me\",\n-        \"createdAt\": \"2018-12-30T13:40:00.000Z\",\n+        \"createdAt\": \"2018-12-30T14:40:00.000Z\",\n         \"id\": \"2\",\n       },\n       \"name\": \"Bryan Wallace\",\n@@ -27,7 +27,7 @@ Object {\n       \"id\": \"3\",\n       \"lastMessage\": Object {\n         \"content\": \"I should buy a boat\",\n-        \"createdAt\": \"2018-12-15T07:00:00.000Z\",\n+        \"createdAt\": \"2018-12-15T08:00:00.000Z\",\n         \"id\": \"3\",\n       },\n       \"name\": \"Avery Stewart\",\n@@ -37,7 +37,7 @@ Object {\n       \"id\": \"4\",\n       \"lastMessage\": Object {\n         \"content\": \"This is wicked good ice cream.\",\n-        \"createdAt\": \"2018-05-12T15:00:00.000Z\",\n+        \"createdAt\": \"2018-05-12T16:00:00.000Z\",\n         \"id\": \"4\",\n       },\n       \"name\": \"Katie Peterson\",\ndiff --git a/server/tests/queries/getChat.test.ts b/server/tests/queries/getChat.test.ts\nindex 0e63918..db5ad8a 100644\n--- a/server/tests/queries/getChat.test.ts\n+++ b/server/tests/queries/getChat.test.ts\n@@ -1,20 +1,20 @@\n-import { createTestClient } from 'apollo-server-testing'\n-import { gql } from 'apollo-server-express'\n+import { createTestClient } from 'apollo-server-testing';\n+import { gql } from 'apollo-server-express';\n import { server } from '../../server';\n import { resetDb } from '../../db';\n import { mockAuth } from '../mocks/auth.provider';\n\n describe('Query.chat', () => {\n-  beforeEach(resetDb)\n-\n+  beforeEach(resetDb);\n+\n   it('should fetch specified chat', async () => {\n     mockAuth(1);\n\n-    const { query } = createTestClient(server)\n+    const { query } = createTestClient(server);\n\n     const res = await query({\n       variables: { chatId: '1' },\n-      query: gql `\n+      query: gql`\n         query GetChat($chatId: ID!) {\n           chat(chatId: $chatId) {\n             id\n@@ -28,10 +28,10 @@ describe('Query.chat', () => {\n           }\n         }\n       `,\n-    })\n+    });\n\n-    expect(res.data).toBeDefined()\n-    expect(res.errors).toBeUndefined()\n-    expect(res.data).toMatchSnapshot()\n-  })\n-})\n+    expect(res.data).toBeDefined();\n+    expect(res.errors).toBeUndefined();\n+    expect(res.data).toMatchSnapshot();\n+  });\n+});\ndiff --git a/server/tests/queries/getChats.test.ts b/server/tests/queries/getChats.test.ts\nindex 171aa10..f416ee7 100644\n--- a/server/tests/queries/getChats.test.ts\n+++ b/server/tests/queries/getChats.test.ts\n@@ -1,19 +1,19 @@\n-import { createTestClient } from 'apollo-server-testing'\n-import { gql } from 'apollo-server-express'\n+import { createTestClient } from 'apollo-server-testing';\n+import { gql } from 'apollo-server-express';\n import { server } from '../../server';\n import { resetDb } from '../../db';\n import { mockAuth } from '../mocks/auth.provider';\n\n describe('Query.chats', () => {\n-  beforeEach(resetDb)\n-\n+  beforeEach(resetDb);\n+\n   it('should fetch all chats', async () => {\n     mockAuth(1);\n\n-    const { query } = createTestClient(server)\n+    const { query } = createTestClient(server);\n\n     const res = await query({\n-      query: gql `\n+      query: gql`\n         query GetChats {\n           chats {\n             id\n@@ -27,10 +27,10 @@ describe('Query.chats', () => {\n           }\n         }\n       `,\n-    })\n+    });\n\n-    expect(res.data).toBeDefined()\n-    expect(res.errors).toBeUndefined()\n-    expect(res.data).toMatchSnapshot()\n-  })\n-})\n+    expect(res.data).toBeDefined();\n+    expect(res.errors).toBeUndefined();\n+    expect(res.data).toMatchSnapshot();\n+  });\n+});\ndiff --git a/server/tests/queries/getMe.test.ts b/server/tests/queries/getMe.test.ts\nindex 022c28e..6a74b42 100644\n--- a/server/tests/queries/getMe.test.ts\n+++ b/server/tests/queries/getMe.test.ts\n@@ -1,19 +1,19 @@\n-import { createTestClient } from 'apollo-server-testing'\n-import { gql } from 'apollo-server-express'\n+import { createTestClient } from 'apollo-server-testing';\n+import { gql } from 'apollo-server-express';\n import { server } from '../../server';\n import { resetDb } from '../../db';\n import { mockAuth } from '../mocks/auth.provider';\n\n describe('Query.me', () => {\n-  beforeEach(resetDb)\n-\n+  beforeEach(resetDb);\n+\n   it('should fetch current user', async () => {\n-    mockAuth(1)\n+    mockAuth(1);\n\n-    const { query } = createTestClient(server)\n+    const { query } = createTestClient(server);\n\n     const res = await query({\n-      query: gql `\n+      query: gql`\n         query GetMe {\n           me {\n             id\n@@ -22,10 +22,10 @@ describe('Query.me', () => {\n           }\n         }\n       `,\n-    })\n+    });\n\n-    expect(res.data).toBeDefined()\n-    expect(res.errors).toBeUndefined()\n-    expect(res.data).toMatchSnapshot()\n-  })\n-})\n+    expect(res.data).toBeDefined();\n+    expect(res.errors).toBeUndefined();\n+    expect(res.data).toMatchSnapshot();\n+  });\n+});\ndiff --git a/server/tests/queries/getUsers.test.ts b/server/tests/queries/getUsers.test.ts\nindex 47ac87a..7e26598 100644\n--- a/server/tests/queries/getUsers.test.ts\n+++ b/server/tests/queries/getUsers.test.ts\n@@ -1,19 +1,19 @@\n-import { createTestClient } from 'apollo-server-testing'\n-import { gql } from 'apollo-server-express'\n+import { createTestClient } from 'apollo-server-testing';\n+import { gql } from 'apollo-server-express';\n import { server } from '../../server';\n import { resetDb } from '../../db';\n import { mockAuth } from '../mocks/auth.provider';\n\n describe('Query.getUsers', () => {\n-  beforeEach(resetDb)\n-\n+  beforeEach(resetDb);\n+\n   it('should fetch all users except the one signed-in', async () => {\n     mockAuth(1);\n\n-    const { query } = createTestClient(server)\n+    const { query } = createTestClient(server);\n\n     let res = await query({\n-      query: gql `\n+      query: gql`\n         query GetUsers {\n           users {\n             id\n@@ -22,16 +22,16 @@ describe('Query.getUsers', () => {\n           }\n         }\n       `,\n-    })\n+    });\n\n-    expect(res.data).toBeDefined()\n-    expect(res.errors).toBeUndefined()\n-    expect(res.data).toMatchSnapshot()\n+    expect(res.data).toBeDefined();\n+    expect(res.errors).toBeUndefined();\n+    expect(res.data).toMatchSnapshot();\n\n     mockAuth(2);\n\n     res = await query({\n-      query: gql `\n+      query: gql`\n         query GetUsers {\n           users {\n             id\n@@ -40,10 +40,10 @@ describe('Query.getUsers', () => {\n           }\n         }\n       `,\n-    })\n+    });\n\n-    expect(res.data).toBeDefined()\n-    expect(res.errors).toBeUndefined()\n-    expect(res.data).toMatchSnapshot()\n-  })\n-})\n+    expect(res.data).toBeDefined();\n+    expect(res.errors).toBeUndefined();\n+    expect(res.data).toMatchSnapshot();\n+  });\n+});\ndiff --git a/server/tsconfig.json b/server/tsconfig.json\nindex fe56553..d9d5ac7 100644\n--- a/server/tsconfig.json\n+++ b/server/tsconfig.json\n@@ -1,16 +1,21 @@\n {\n   \"compilerOptions\": {\n+    \"outDir\": \"dist\",\n     \"target\": \"es2018\",\n     \"module\": \"commonjs\",\n     \"lib\": [\n       \"es2018\",\n       \"esnext.asynciterable\"\n     ],\n+    \"skipLibCheck\": true,\n     \"strict\": true,\n     \"strictFunctionTypes\": false,\n     \"strictPropertyInitialization\": false,\n     \"esModuleInterop\": true,\n     \"experimentalDecorators\": true,\n     \"emitDecoratorMetadata\": true\n-  }\n+  },\n+  \"exclude\": [\n+    \"./tests/\"\n+  ]\n }\ndiff --git a/server/types/apollo-server-testing.d.ts b/server/types/apollo-server-testing.d.ts\nindex e9d9b94..554c277 100644\n--- a/server/types/apollo-server-testing.d.ts\n+++ b/server/types/apollo-server-testing.d.ts\n@@ -19,7 +19,7 @@ declare module 'apollo-server-testing' {\n   };\n\n   export const createTestClient: <TVariables>(\n-    server: ApolloServerBase,\n+    server: ApolloServerBase\n   ) => {\n     query: (query: Query<TVariables>) => Promise<GraphQLResponse>;\n     mutate: (mutation: Mutation<TVariables>) => Promise<GraphQLResponse>;\ndiff --git a/server/validators.ts b/server/validators.ts\nindex 341d955..7559c52 100644\n--- a/server/validators.ts\n+++ b/server/validators.ts\n@@ -1,43 +1,43 @@\n export const validatePassword = (ctx: string, str: string) => {\n   if (typeof str !== 'string') {\n-    throw TypeError(`${ctx} must be a string`)\n+    throw TypeError(`${ctx} must be a string`);\n   }\n\n-  validateLength(ctx, str, 8, 30)\n+  validateLength(ctx, str, 8, 30);\n\n   if (!/[a-zA-Z]+/.test(str)) {\n-    throw TypeError(`${ctx} must contain english letters`)\n+    throw TypeError(`${ctx} must contain english letters`);\n   }\n\n   if (!/\\d+/.test(str)) {\n-    throw TypeError(`${ctx} must contain numbers`)\n+    throw TypeError(`${ctx} must contain numbers`);\n   }\n\n   if (!/[^\\da-zA-Z]+/.test(str)) {\n-    throw TypeError(`${ctx} must contain special charachters`)\n+    throw TypeError(`${ctx} must contain special charachters`);\n   }\n-}\n+};\n\n export const validateLength = (ctx: string, str: string, ...args: number[]) => {\n-  let min, max\n+  let min, max;\n\n   if (args.length === 1) {\n-    min = 0\n-    max = args[0]\n+    min = 0;\n+    max = args[0];\n   } else {\n-    min = args[0]\n-    max = args[1]\n+    min = args[0];\n+    max = args[1];\n   }\n\n   if (typeof str !== 'string') {\n-    throw TypeError(`${ctx} must be a string`)\n+    throw TypeError(`${ctx} must be a string`);\n   }\n\n   if (str.length < min) {\n-    throw TypeError(`${ctx} must be at least ${min} chars long`)\n+    throw TypeError(`${ctx} must be at least ${min} chars long`);\n   }\n\n   if (str.length > max) {\n-    throw TypeError(`${ctx} must contain ${max} chars at most`)\n+    throw TypeError(`${ctx} must contain ${max} chars at most`);\n   }\n-}\n+};\n",
        "manuals": [
          {
            "manualTitle": "Whatsapp Clone Tutorial",
            "stepRevision": "41cc9b737957b8451253754067d5bd0295e2bdf4",
            "manualView": "![whatsapp-clone](https://user-images.githubusercontent.com/7648874/54141944-9f801a80-4461-11e9-85a1-bcb161d9a6c6.png)\n\n!(https://www.youtube.com/watch?v=omsHNP4Vjhc)\n\nWhatsapp Clone is a free and open-source tutorial that will guide you step-by-step on how to create a full-stack,\nmobile, hybrid web application from scratch.\n\n- [Skip to just clone the finished application](#cloning-the-finished-app)\n\nThe software world is evolving quickly, and oftentimes people find themselves left behind, even the most experienced ones.\nThe purpose of this tutorial is not only to demonstrate how to create a full application with the latest technologies, but also\nto keep up to date with the ever-changing development ecosystem.\n\nThis tutorial is for anyone who has ever asked themselves one of the following questions:\n\n- How do people build an app today?\n- What are the currently leading technologies in the ecosystem?\n- What are the best practices for using technology XXX?\n- What is the purpose of technology XXX?\n- How does technology XXX work?\n- How do I use technology XXX?\n- How do I migrate to the new version of technology XXX?\n- Why should I use technology XXX over technology YYY?\n\nAll of the above and more can be answered in the tutorial. Whether youâ€™re a beginner, intermediate or a professional,\nwe will have the answers youâ€™re looking for.\n\n**What technologies does Whatsapp Clone uses?**\n\nThe version of the Whatsapp Clone you are looking at, uses:\n\n- [React (with Hooks and Suspense)](http://react.com)\n- [Styled-Components](https://styled-components.com)\n- [Material-UI](https://material-ui.com)\n- [TypeScript](https://typescriptlang.org)\n- [Apollo GraphQL](https://www.apollographql.com)\n- [GraphQL Code Generator](http://graphql-code-generator.com)\n- [GraphQL Modules](https://graphql-modules.com)\n- [PostgreSQL](https://www.postgresql.org/)\n- [GraphQL Inspector](https://graphql-inspector.com/)\n\nThe point of this tutorial is not to be bound to a certain technology, but rather keep itself aligned with the ecosystem.\nWhen a new technology comes out, and itâ€™s better and more popular, Whatsapp Clone will upgrade to use it (together with full migration instructions).\n\n**P2P tutorial for the community by the community**\n\nKeeping tutorials up to date is not an easy task.\nThat's why we've created the Tortilla Tutorial Framework that makes it easy to write and update tutorials.\nAlso, the WhatsApp clone is completely open source in order for the community to give its feedback, help and fork ideas.\nHere are the repositories the tutorial is made of:\n\n- [Whatsapp Clone - Client](https://github.com/Urigo/WhatsApp-Clone-Client-React)\n- [Whatsapp Clone - Server](https://github.com/Urigo/WhatsApp-Clone-server)\n- [Whatsapp Clone - Script's text](https://github.com/Urigo/WhatsApp-Clone-Tutorial)\n\nWeâ€™ve also made sure to publish some important documents so you can get more involved.\nYou can track our progress and comment your suggestions, since everything is based on Google Docs and is updated live:\n\n- [Road map](https://docs.google.com/document/d/1p2Zio6Js2eoFfHs9CjIMF6jTuNyD4eQEHlgEAKhAqM8/edit?usp=sharing)\n- [Chapter manuals] (https://drive.google.com/open?id=1ITxOniS_S3sgZfunLvtJ1L9P6Fj1YOLlFHhoQPjT3S0)\n\n## Cloning the finished app\n\nIf you want to simply clone and run the app locally in it's finished,\nfirst clone the [Server repository](https://github.com/Urigo/WhatsApp-Clone-server) and follow the instructions on the README there.\n\nThen clone the [React Client repository](https://github.com/Urigo/WhatsApp-Clone-Client-React) and follow the instructions there carefully.\n\n**Migration instructions included**\n\nThere are many great tutorials out there, but almost none of them shows you what changes you should make in your app in order to be aligned with a new version of a certain technology.\nAs technologies are being updated by the minute, some changes are minor and insignificant,\nbut often times a breaking change will be made in which case we need to know how we can adapt to that change.\nThanks to the [Tortilla platform](https://tortilla.academy), we can provide you with a git-diff that will show you what changes were made between each and every released version of the Whatsapp Clone tutorial since the beginning of history.\nThis way you can easily notice the changes in APIs and migrate your app in no time.\n\n![tutorial-versions-diff](https://user-images.githubusercontent.com/7648874/54142148-0f8ea080-4462-11e9-9522-ec9997b76169.png)\n\n**Prerequisites for WhatsApp Clone**\n\n> Even if you don't have experience with the technologies below you might still be able to start the tutorial and pick things along the way.\n> If you struggle with anything during the tutorial, contact us on the forum or on Github with your questions.\n> It will help us make sure that the tutorial is good for beginners as well\n\n- JavaScript - https://javascript.info/\n- TypeScript\n- JSX\n- HTML\n- CSS\n- Node.JS\n- npm & Yarn\n- React\n- SQL\n\nOS operations such as navigating to a folder, or creating a folder, are all gonna be written in Bash, but the instructions are OS agnostic and can be applied on any machine that is web-compatible.\n\nMake sure you have the latest global dependencies on your computer before starting the tutorial:\n\n**[Node](https://nodejs.org/)**\n\nInstall [nvm](https://github.com/nvm-sh/nvm) by running the following command in your [command line](https://www.wikihow.com/Get-to-the-Command-Line-on-a-Mac):\n\n    $ curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.34.0/install.sh | bash\n\nThen install the latest version of Node by running the following:\n\n    $ nvm install node\n\n**[Yarn](https://yarnpkg.com)**\n\nFollow the instructions [here](https://yarnpkg.com/en/docs/install#mac-stable).\n\n\n**Whatâ€™s on the tutorial?**\n\nWhatsapp Clone is built chronologically, from the most basic, to more higher level features, so we recommend you to follow the tutorial in the right order.\nEach step is focused on a different subject, so by the end of it youâ€™ll have a new feature and a new set of knowledge that you can start implementing in your everyday scenario immediately.\n\nIf you feel like you want to skip or focus on a specific subject, on each step you can download the full app code till that point in time.\n\nThat is also useful in case you get stuck.\n\nCurrently, Whatsapp Clone includes the following chapters:\n\n- [Step 1: Creating a basic React APP with a basic view.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step1.md)\n- [Step 2: Styling with Material-UI and Styled-Components.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step2.md)\n- [Step 3: Setting a basic Node.JS server with basic a basic REST endpoint.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step3.md)\n- [Step 4: Transition to GraphQL.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step4.md)\n- [Step 5: Testing.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step5.md)\n- [Step 6: Creating an app router and implementing a chat room.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step6.md)\n- [Step 7: Caching with Apollo-Client.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step7.md)\n- [Step 8: Sending messages with GraphQL mutations.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step8.md)\n- [Step 9: Type safety with GraphQL Code Generator.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step9.md)\n- [Step 10: Live updates with GraphQL subscriptions.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step10.md)\n- [Step 11: Users.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step11.md)\n- [Step 12: Adding and removing chats.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step12.md)\n- [Step 13: Authentication.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step13.md)\n- [Step 14: Migrating to PostgreSQL.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step14.md)\n- [Step 15: Using a REST API.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step15.md)\n- [Step 16: Modularity.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step16.md)\n- [Step 17: Performance.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/master/.tortilla/manuals/views/step17.md)\n- Step 18: Your choice! Submit a request [here](https://github.com/Urigo/WhatsApp-Clone-Client-React/issues)\n\nWhatsapp Clone is updated on a regular basis, so you should expect more steps and extensions with time.\nYou can keep track of our [road map](https://docs.google.com/document/d/1p2Zio6Js2eoFfHs9CjIMF6jTuNyD4eQEHlgEAKhAqM8/edit?usp=sharing) to see whatâ€™s upcoming.\n\n### External contributors\n\n* [jsparvath](https://github.com/jsparvath)\n* [Akirtovskis](https://github.com/Akirtovskis)\n* [MStokluska](https://github.com/MStokluska)\n* [milenazuccarelli](https://github.com/milenazuccarelli)\n* [itsmylife](https://github.com/itsmylife)"
          },
          {
            "manualTitle": "Step 1: Creating a basic React APP with a basic view",
            "stepRevision": "8a268ee50ebf3a1b3a1e1eea47b75a152f128760",
            "manualView": "The first thing we will do in the tutorial is to start with the UI (User Interface).\nThat is the visible part of our app that our users will see and interact with.\n\nIn this chapter we will learn how to create a basic React app.\nThe app will contain a basic view that will render a list of conversations within our app.\nWe will gradually create our app, so for now, instead of using real data, we will use in-memory fake data instead of calling a server.\n\nIn order to save time, instead of starting from scratch, we will use a boilerplate to kick-start our application.\nWhen it comes to React apps, the most popular boilerplate is [`create-react-app`](https://github.com/facebook/create-react-app)\nwhich is also officially maintained by Facebook, the creators of [React](https://reactjs.org/).\n\nWe'll launch `create-react-app` using `yarn create` (so we won't need to install `create-react-app` permanently),\nand run the `react-app` command to create the basis for our WhatsApp Clone.\n\nIn your command line, navigate to the folder you want to put your app's folder in and run:\n\n    $ yarn create react-app whatsapp-clone-client --typescript\n\n> Note how we used the `client` postfix. That's because we're planning to create a server as well on later chapters.\n\nIt will create a directory called `whatsapp-clone-client` inside the current folder.\nInside that directory, it will generate the initial project structure and install the needed dependencies.\nNo configuration or complicated folder structures, just the files you need to build your app.\n\n### Review the generated code\n\n> In our project, we're gonna use [TypeScript](https://www.typescriptlang.org/) (indicated by the `--typescript` command).\n> The main advantage of using TypeScript over using plain JavaScript is that if we want, we get to tell the compiler what types and data structures we expect in certain places,\n> so that the compiler (which unlike a human never forgets) will remind us when we make a mistake and assume something that is not true.\n> The more information we will provide to the compiler, the more the compiler will be able to help us.\n\nOnce the installation is done, you can open your project folder:\n\n\t$ cd whatsapp-clone-client\n\nInside the newly created project, you can run some built-in commands:\n\n\t$ yarn start\n\nRuns the app in development mode. Open `[http://localhost:3000](http://localhost:3000)` to view it in the browser:\n\n![boilerplate-page](https://user-images.githubusercontent.com/7648874/54026782-025f8080-41da-11e9-9a4e-796fe15e8d03.png)\n\n### create-react-app\n\nLet's look at what create-react-app has created for us in order to understand everything that's going on.\n\nFirst thing, let's look at what webpage is being served to the browser.\nThat webpage in `index.html` that sits under the `public` folder.\n\n[{]: <helper> (diffStep \"root\" files=\"public/index.html\" module=\"client\")\n\n#### [Whatsapp Clone Client](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/3285e0c7df54bb4705b18f6ce53f667d443cbf0e)\n\n##### Added public&#x2F;index.html\n```diff\n@@ -0,0 +1,38 @@\n+â”Š  â”Š 1â”Š<!DOCTYPE html>\n+â”Š  â”Š 2â”Š<html lang=\"en\">\n+â”Š  â”Š 3â”Š  <head>\n+â”Š  â”Š 4â”Š    <meta charset=\"utf-8\" />\n+â”Š  â”Š 5â”Š    <link rel=\"shortcut icon\" href=\"%PUBLIC_URL%/favicon.ico\" />\n+â”Š  â”Š 6â”Š    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\n+â”Š  â”Š 7â”Š    <meta name=\"theme-color\" content=\"#000000\" />\n+â”Š  â”Š 8â”Š    <!--\n+â”Š  â”Š 9â”Š      manifest.json provides metadata used when your web app is installed on a\n+â”Š  â”Š10â”Š      user's mobile device or desktop. See https://developers.google.com/web/fundamentals/web-app-manifest/\n+â”Š  â”Š11â”Š    -->\n+â”Š  â”Š12â”Š    <link rel=\"manifest\" href=\"%PUBLIC_URL%/manifest.json\" />\n+â”Š  â”Š13â”Š    <!--\n+â”Š  â”Š14â”Š      Notice the use of %PUBLIC_URL% in the tags above.\n+â”Š  â”Š15â”Š      It will be replaced with the URL of the `public` folder during the build.\n+â”Š  â”Š16â”Š      Only files inside the `public` folder can be referenced from the HTML.\n+â”Š  â”Š17â”Š\n+â”Š  â”Š18â”Š      Unlike \"/favicon.ico\" or \"favicon.ico\", \"%PUBLIC_URL%/favicon.ico\" will\n+â”Š  â”Š19â”Š      work correctly both with client-side routing and a non-root public URL.\n+â”Š  â”Š20â”Š      Learn how to configure a non-root public URL by running `npm run build`.\n+â”Š  â”Š21â”Š    -->\n+â”Š  â”Š22â”Š    <title>React App</title>\n+â”Š  â”Š23â”Š  </head>\n+â”Š  â”Š24â”Š  <body>\n+â”Š  â”Š25â”Š    <noscript>You need to enable JavaScript to run this app.</noscript>\n+â”Š  â”Š26â”Š    <div id=\"root\"></div>\n+â”Š  â”Š27â”Š    <!--\n+â”Š  â”Š28â”Š      This HTML file is a template.\n+â”Š  â”Š29â”Š      If you open it directly in the browser, you will see an empty page.\n+â”Š  â”Š30â”Š\n+â”Š  â”Š31â”Š      You can add webfonts, meta tags, or analytics to this file.\n+â”Š  â”Š32â”Š      The build step will place the bundled scripts into the <body> tag.\n+â”Š  â”Š33â”Š\n+â”Š  â”Š34â”Š      To begin the development, run `npm start` or `yarn start`.\n+â”Š  â”Š35â”Š      To create a production bundle, use `npm run build` or `yarn build`.\n+â”Š  â”Š36â”Š    -->\n+â”Š  â”Š37â”Š  </body>\n+â”Š  â”Š38â”Š</html>\n```\n\n[}]: #\n\nAs you can see, this file is a regular HTML file. You will want to edit it's `<title>` to name our real app:\n\n[{]: <helper> (diffStep \"1.1\" files=\"public/index.html\" module=\"client\")\n\n#### [__Client__ Step 1.1: Rename the app](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/4e69eb75bf1b7bd90c3882a8a4a6c802752785a7)\n\n##### Changed public&#x2F;index.html\n```diff\n@@ -19,7 +19,7 @@\n â”Š19â”Š19â”Š      work correctly both with client-side routing and a non-root public URL.\n â”Š20â”Š20â”Š      Learn how to configure a non-root public URL by running `npm run build`.\n â”Š21â”Š21â”Š    -->\n-â”Š22â”Š  â”Š    <title>React App</title>\n+â”Š  â”Š22â”Š    <title>WhatsApp Clone</title>\n â”Š23â”Š23â”Š  </head>\n â”Š24â”Š24â”Š  <body>\n â”Š25â”Š25â”Š    <noscript>You need to enable JavaScript to run this app.</noscript>\n```\n\n[}]: #\n\nIn the `public` folder we will place assets that are not going to change, like `favicon.ico`, static images and the HTML templates.\n\nWhen we will prepare to app for production, a script from `create-react-app` will place those assets in a build folder and reference them into the\nHTML template.\n\nAnother file in the `public` folder is the `manifest.json` file that gives browsers information about our app in case the users will install the app permanently on their\nmobile phones or desktop apps.\nYou can read more about it here: https://developers.google.com/web/fundamentals/web-app-manifest/.\n\n[{]: <helper> (diffStep \"1.1\" files=\"public/manifest.json\" module=\"client\")\n\n#### [__Client__ Step 1.1: Rename the app](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/4e69eb75bf1b7bd90c3882a8a4a6c802752785a7)\n\n##### Changed public&#x2F;manifest.json\n```diff\n@@ -1,6 +1,6 @@\n â”Š1â”Š1â”Š{\n-â”Š2â”Š â”Š  \"short_name\": \"React App\",\n-â”Š3â”Š â”Š  \"name\": \"Create React App Sample\",\n+â”Š â”Š2â”Š  \"short_name\": \"WhatsApp Clone\",\n+â”Š â”Š3â”Š  \"name\": \"An open source chat app\",\n â”Š4â”Š4â”Š  \"icons\": [\n â”Š5â”Š5â”Š    {\n â”Š6â”Š6â”Š      \"src\": \"favicon.ico\",\n```\n\n[}]: #\n\nNow the HTML file has in it's <body> tag just one `<div id=\"root\"></div>` tag which is empty.\nSo how do we get the nice React logo that is being rendered onto our screen?\n\n`create-react-app` has scripts that will run the `src/index.tsx` file together with our HTML template, so let's look what this file is doing.\n\n[{]: <helper> (diffStep \"root\" files=\"public/index.html\" module=\"client\")\n\n#### [Whatsapp Clone Client](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/3285e0c7df54bb4705b18f6ce53f667d443cbf0e)\n\n##### Added public&#x2F;index.html\n```diff\n@@ -0,0 +1,38 @@\n+â”Š  â”Š 1â”Š<!DOCTYPE html>\n+â”Š  â”Š 2â”Š<html lang=\"en\">\n+â”Š  â”Š 3â”Š  <head>\n+â”Š  â”Š 4â”Š    <meta charset=\"utf-8\" />\n+â”Š  â”Š 5â”Š    <link rel=\"shortcut icon\" href=\"%PUBLIC_URL%/favicon.ico\" />\n+â”Š  â”Š 6â”Š    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\n+â”Š  â”Š 7â”Š    <meta name=\"theme-color\" content=\"#000000\" />\n+â”Š  â”Š 8â”Š    <!--\n+â”Š  â”Š 9â”Š      manifest.json provides metadata used when your web app is installed on a\n+â”Š  â”Š10â”Š      user's mobile device or desktop. See https://developers.google.com/web/fundamentals/web-app-manifest/\n+â”Š  â”Š11â”Š    -->\n+â”Š  â”Š12â”Š    <link rel=\"manifest\" href=\"%PUBLIC_URL%/manifest.json\" />\n+â”Š  â”Š13â”Š    <!--\n+â”Š  â”Š14â”Š      Notice the use of %PUBLIC_URL% in the tags above.\n+â”Š  â”Š15â”Š      It will be replaced with the URL of the `public` folder during the build.\n+â”Š  â”Š16â”Š      Only files inside the `public` folder can be referenced from the HTML.\n+â”Š  â”Š17â”Š\n+â”Š  â”Š18â”Š      Unlike \"/favicon.ico\" or \"favicon.ico\", \"%PUBLIC_URL%/favicon.ico\" will\n+â”Š  â”Š19â”Š      work correctly both with client-side routing and a non-root public URL.\n+â”Š  â”Š20â”Š      Learn how to configure a non-root public URL by running `npm run build`.\n+â”Š  â”Š21â”Š    -->\n+â”Š  â”Š22â”Š    <title>React App</title>\n+â”Š  â”Š23â”Š  </head>\n+â”Š  â”Š24â”Š  <body>\n+â”Š  â”Š25â”Š    <noscript>You need to enable JavaScript to run this app.</noscript>\n+â”Š  â”Š26â”Š    <div id=\"root\"></div>\n+â”Š  â”Š27â”Š    <!--\n+â”Š  â”Š28â”Š      This HTML file is a template.\n+â”Š  â”Š29â”Š      If you open it directly in the browser, you will see an empty page.\n+â”Š  â”Š30â”Š\n+â”Š  â”Š31â”Š      You can add webfonts, meta tags, or analytics to this file.\n+â”Š  â”Š32â”Š      The build step will place the bundled scripts into the <body> tag.\n+â”Š  â”Š33â”Š\n+â”Š  â”Š34â”Š      To begin the development, run `npm start` or `yarn start`.\n+â”Š  â”Š35â”Š      To create a production bundle, use `npm run build` or `yarn build`.\n+â”Š  â”Š36â”Š    -->\n+â”Š  â”Š37â”Š  </body>\n+â”Š  â”Š38â”Š</html>\n```\n\n[}]: #\n\nThe important thing to see here is that `React` is calling it's render method and telling it to render the `App` component into a document where `id` equals `root`.\n\nSo now you know where React is coming into our html template.\n\nBut where does the `App` React component comes from and where does `React` itself comes from?\n\nThe `index.tsx` file imports this code from outside of the file using the `import` command.\n\nIn the case of the `App` component, we can see it bring it from the path './App', which is in the same folder ('src').\n\nGetting React, it is simply calling it by name instead of a path. That means that the import will automatically look for a folder named `react` under the `node-modules` folder.\n\n`node-modules` is a default folder which will include all of the libraries we want to use in our app.\n\n[yarn](https://yarnpkg.com) will install those libraries according to the dependencies listed inside the `package.json` file, so let's look into that.\n\nUnder dependencies you can see all the libraries our app currently depends on.\n\n[{]: <helper> (diffStep \"root\" files=\"package.json\" module=\"client\")\n\n#### [Whatsapp Clone Client](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/3285e0c7df54bb4705b18f6ce53f667d443cbf0e)\n\n##### Added package.json\n```diff\n@@ -0,0 +1,40 @@\n+â”Š  â”Š 1â”Š{\n+â”Š  â”Š 2â”Š  \"name\": \"whatsapp-clone-client\",\n+â”Š  â”Š 3â”Š  \"version\": \"0.1.0\",\n+â”Š  â”Š 4â”Š  \"private\": true,\n+â”Š  â”Š 5â”Š  \"repository\": {\n+â”Š  â”Š 6â”Š    \"type\": \"git\",\n+â”Š  â”Š 7â”Š    \"url\": \"https://github.com/Urigo/WhatsApp-Clone-Client-React.git\"\n+â”Š  â”Š 8â”Š  },\n+â”Š  â”Š 9â”Š  \"dependencies\": {\n+â”Š  â”Š10â”Š    \"@types/jest\": \"24.0.13\",\n+â”Š  â”Š11â”Š    \"@types/node\": \"12.0.1\",\n+â”Š  â”Š12â”Š    \"@types/react\": \"16.8.17\",\n+â”Š  â”Š13â”Š    \"@types/react-dom\": \"16.8.4\",\n+â”Š  â”Š14â”Š    \"react\": \"^16.8.6\",\n+â”Š  â”Š15â”Š    \"react-dom\": \"^16.8.6\",\n+â”Š  â”Š16â”Š    \"react-scripts\": \"3.0.1\",\n+â”Š  â”Š17â”Š    \"typescript\": \"3.4.5\"\n+â”Š  â”Š18â”Š  },\n+â”Š  â”Š19â”Š  \"scripts\": {\n+â”Š  â”Š20â”Š    \"start\": \"react-scripts start\",\n+â”Š  â”Š21â”Š    \"build\": \"react-scripts build\",\n+â”Š  â”Š22â”Š    \"test\": \"TZ=\\\"Asia/Jerusalem\\\" react-scripts test\",\n+â”Š  â”Š23â”Š    \"eject\": \"react-scripts eject\"\n+â”Š  â”Š24â”Š  },\n+â”Š  â”Š25â”Š  \"eslintConfig\": {\n+â”Š  â”Š26â”Š    \"extends\": \"react-app\"\n+â”Š  â”Š27â”Š  },\n+â”Š  â”Š28â”Š  \"browserslist\": {\n+â”Š  â”Š29â”Š    \"production\": [\n+â”Š  â”Š30â”Š      \">0.2%\",\n+â”Š  â”Š31â”Š      \"not dead\",\n+â”Š  â”Š32â”Š      \"not op_mini all\"\n+â”Š  â”Š33â”Š    ],\n+â”Š  â”Š34â”Š    \"development\": [\n+â”Š  â”Š35â”Š      \"last 1 chrome version\",\n+â”Š  â”Š36â”Š      \"last 1 firefox version\",\n+â”Š  â”Š37â”Š      \"last 1 safari version\"\n+â”Š  â”Š38â”Š    ]\n+â”Š  â”Š39â”Š  }\n+â”Š  â”Š40â”Š}\n```\n\n[}]: #\n\nYou can also see other values in there like `scripts`, which will teach `yarn` new commands that we can use.\nThe right side will name the command and the left would be the actual command that it will run.\n\nAnother file that got created is `tsconfig.json`:\n\n[{]: <helper> (diffStep \"root\" files=\"tsconfig.json\" module=\"client\")\n\n#### [Whatsapp Clone Client](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/3285e0c7df54bb4705b18f6ce53f667d443cbf0e)\n\n##### Added tsconfig.json\n```diff\n@@ -0,0 +1,25 @@\n+â”Š  â”Š 1â”Š{\n+â”Š  â”Š 2â”Š  \"compilerOptions\": {\n+â”Š  â”Š 3â”Š    \"target\": \"es5\",\n+â”Š  â”Š 4â”Š    \"lib\": [\n+â”Š  â”Š 5â”Š      \"dom\",\n+â”Š  â”Š 6â”Š      \"dom.iterable\",\n+â”Š  â”Š 7â”Š      \"esnext\"\n+â”Š  â”Š 8â”Š    ],\n+â”Š  â”Š 9â”Š    \"allowJs\": true,\n+â”Š  â”Š10â”Š    \"skipLibCheck\": true,\n+â”Š  â”Š11â”Š    \"esModuleInterop\": true,\n+â”Š  â”Š12â”Š    \"allowSyntheticDefaultImports\": true,\n+â”Š  â”Š13â”Š    \"strict\": true,\n+â”Š  â”Š14â”Š    \"forceConsistentCasingInFileNames\": true,\n+â”Š  â”Š15â”Š    \"module\": \"esnext\",\n+â”Š  â”Š16â”Š    \"moduleResolution\": \"node\",\n+â”Š  â”Š17â”Š    \"resolveJsonModule\": true,\n+â”Š  â”Š18â”Š    \"isolatedModules\": true,\n+â”Š  â”Š19â”Š    \"noEmit\": true,\n+â”Š  â”Š20â”Š    \"jsx\": \"preserve\"\n+â”Š  â”Š21â”Š  },\n+â”Š  â”Š22â”Š  \"include\": [\n+â”Š  â”Š23â”Š    \"src\"\n+â”Š  â”Š24â”Š  ]\n+â”Š  â”Š25â”Š}\n```\n\n[}]: #\n\nThat file specifies options for the Typescript compiler when it takes our code and transforms it from Typescript into Javascript.\n\nSome noticeable configuration options for that file are:\n\n* `target` - What kind of Javascript should the compilers output? in our case `es5` is the version of Javascript that is supported by many browsers.\nIf you know that your app would run only on newer browsers or a Node environment, you can change that value to a newer version and gain performance improvements.\n* `lib` - If you are using new syntax from Javascript, the compiler can add to it's output libraries that would help you support the new syntax even if the browsers don't know those.\n* `strict` - We can give Typescript a lot of information or not so much. The more we give it the more it can help us. adding the strict option will make the compiler warn us when we won't give it enough information.\n\nFor the full set of options, check out the [official docs](https://www.typescriptlang.org/docs/handbook/compiler-options.html);\n\nNow, let's look at our App's code in `src/App.tsx`:\n\n[{]: <helper> (diffStep \"root\" files=\"App.tsx\" module=\"client\")\n\n#### [Whatsapp Clone Client](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/3285e0c7df54bb4705b18f6ce53f667d443cbf0e)\n\n##### Added src&#x2F;App.tsx\n```diff\n@@ -0,0 +1,26 @@\n+â”Š  â”Š 1â”Šimport React from 'react';\n+â”Š  â”Š 2â”Šimport logo from './logo.svg';\n+â”Š  â”Š 3â”Šimport './App.css';\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šconst App: React.FC = () => {\n+â”Š  â”Š 6â”Š  return (\n+â”Š  â”Š 7â”Š    <div className=\"App\">\n+â”Š  â”Š 8â”Š      <header className=\"App-header\">\n+â”Š  â”Š 9â”Š        <img src={logo} className=\"App-logo\" alt=\"logo\" />\n+â”Š  â”Š10â”Š        <p>\n+â”Š  â”Š11â”Š          Edit <code>src/App.tsx</code> and save to reload.\n+â”Š  â”Š12â”Š        </p>\n+â”Š  â”Š13â”Š        <a\n+â”Š  â”Š14â”Š          className=\"App-link\"\n+â”Š  â”Š15â”Š          href=\"https://reactjs.org\"\n+â”Š  â”Š16â”Š          target=\"_blank\"\n+â”Š  â”Š17â”Š          rel=\"noopener noreferrer\"\n+â”Š  â”Š18â”Š        >\n+â”Š  â”Š19â”Š          Learn React\n+â”Š  â”Š20â”Š        </a>\n+â”Š  â”Š21â”Š      </header>\n+â”Š  â”Š22â”Š    </div>\n+â”Š  â”Š23â”Š  );\n+â”Š  â”Š24â”Š}\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Šexport default App;\n```\n\n[}]: #\n\nWe can see that our app is just a function named `App`.\n\n`const App` means we declare a variable named `App` and `const` means it cannot be changed after it has been declared (you can't do `App = XX;` later in the app);\n\nNext we assign App with a function. Something like: `const App = () => {}`.\nThat way of creating functions is called `arrow functions`. It is almost equivalent to `const App = function(){}`.\nSo it is a function that doesn't accept any parameters into it.\n\nThat function returns `jsx`. A visual language from React that describes how our component should look like.\n\nSo all a React component is, is simply a function that returns how it look like.\n\nWe then export this function so that React could import it from `index.tsx`.\n\nIn our own component we will import things like the logo and styles that the component uses and those will be imported together with it each time\nsomething will import our component.\n\nThe last thing we haven't explained is the following part: `App: React.FC`.\nThose are Typescript typings. Everything after `:` describes the types of the `App` variable and has no affect on the behavior and execution of the app.\nIt will tell Typescript how `App` is supposed to look like, so that in case we make a mistake, Typescript will warn us before we get the app running.\n\nSo what are the types of React.FC?  You can check it out inside by using command+click on it's name.\nYou see that it accepts `P` as props into the component and needs to return `React.Element` or `null`.\n\nLet's test out how typescript typings work: Declare a Typescript interface named `AppProps` that includes a property called `name` of type string. Now use that interface to describe the shape that app's props should have: update the line that declares app to `const App: React.FC<AppProps> = ({name}) => {`\n\nNow open the file `src/index.tsx`.\nYou can see that our editor is calling out that there is an error in our code because no name prop is passed to the App component.\n\nYou will encounter those errors a lot as you develop.\nAlways read the errors all the way. Take your time to understand each sentence there because that will save you a lot of time.\nThat is true also when you are not programming and just encounter errors in the apps you are using...\n\nAs the error message suggests, give the App component a name prop. If you pass a prop that is not a string like `true` or `1+1`, TypeScript will let you know with an error.\n\nThe default for React.FC is that there are no props passed inside so if we'll bring that back but keep sending the `name` value from `index.tsx` in the code, you should now get an error because you are passing a props that the component doesn't accept.\n\nThose errors can be very useful when your app grows.\nMake sure to define types on the component itself like we have done now. It would make it easier to identify the issues.\n\nNext, we have `App.css`. This is used to style our App component.\nPlay around with changing some of the values and see how it changes your view.\nRight now the link between the styles and the components is done by class names (`App-header`, etc).\nLater on we'll learn better strategies of sorting our styles and making\nsure they are not touching components that we don't want them to affect.\n\nNext file - `App.test.tsx`.\nThis file contains automatic tests to make sure our app is doing what it's supposed to do.\n\nWe are programmers, that means that many times our job is to take something manual and making it automatic.\nThat's why we should also strive to automate things we do ourselves.\nType checking is one area, testing is another.  If we can automate tests and run them all the time, it can save us a lot of time\nand bring us a lot of confidence that when we change our code, we haven't destroyed anything.\n\nThe testing tool that create-react-app provides us with is [Jest](https://jestjs.io/).\n\nRight now we have only one simple test - it renders the App React component and makes sure nothing crashes.\nRun the test by running `yarn test` in the command line.\n\nNow go and remove the export from the app component. see how the tests picked up immediately that something is wrong.\n\nIn a later chapter we'll learn how to test more things to make sure we get guarantees that things are working as expected.\n\n## Pin dependencies and save-exact\n\nCheckout the package versions on the `package.json` file.\n\nyou can see the `^` sign.  That means that every time someone will get this code and run `yarn`, what `yarn` will do is to get the newest version on that range.\nWe don't want that. We want to first be notified when a new version is out and we want to explicitly update it.\n\nThat's why we need to add 2 things into our code:\nFirst, to delete all `^` (while also let's update all dependencies to their current latest).\n\n[{]: <helper> (diffStep \"1.2\" files=\"package.json\" module=\"client\")\n\n#### [__Client__ Step 1.2: Pin dependencies](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/fba8842263675a5653d2947f26c99341672a8a19)\n\n##### Changed package.json\n```diff\n@@ -7,14 +7,14 @@\n â”Š 7â”Š 7â”Š    \"url\": \"https://github.com/Urigo/WhatsApp-Clone-Client-React.git\"\n â”Š 8â”Š 8â”Š  },\n â”Š 9â”Š 9â”Š  \"dependencies\": {\n-â”Š10â”Š  â”Š    \"@types/jest\": \"24.0.13\",\n-â”Š11â”Š  â”Š    \"@types/node\": \"12.0.1\",\n-â”Š12â”Š  â”Š    \"@types/react\": \"16.8.17\",\n-â”Š13â”Š  â”Š    \"@types/react-dom\": \"16.8.4\",\n-â”Š14â”Š  â”Š    \"react\": \"^16.8.6\",\n-â”Š15â”Š  â”Š    \"react-dom\": \"^16.8.6\",\n-â”Š16â”Š  â”Š    \"react-scripts\": \"3.0.1\",\n-â”Š17â”Š  â”Š    \"typescript\": \"3.4.5\"\n+â”Š  â”Š10â”Š    \"@types/jest\": \"24.0.17\",\n+â”Š  â”Š11â”Š    \"@types/node\": \"12.7.1\",\n+â”Š  â”Š12â”Š    \"@types/react\": \"16.8.23\",\n+â”Š  â”Š13â”Š    \"@types/react-dom\": \"16.8.5\",\n+â”Š  â”Š14â”Š    \"react\": \"16.9.0\",\n+â”Š  â”Š15â”Š    \"react-dom\": \"16.9.0\",\n+â”Š  â”Š16â”Š    \"react-scripts\": \"3.1.0\",\n+â”Š  â”Š17â”Š    \"typescript\": \"3.5.3\"\n â”Š18â”Š18â”Š  },\n â”Š19â”Š19â”Š  \"scripts\": {\n â”Š20â”Š20â”Š    \"start\": \"react-scripts start\",\n```\n```diff\n@@ -37,4 +37,4 @@\n â”Š37â”Š37â”Š      \"last 1 safari version\"\n â”Š38â”Š38â”Š    ]\n â”Š39â”Š39â”Š  }\n-â”Š40â”Š  â”Š}\n+â”Š  â”Š40â”Š}ðŸš«â†µ\n```\n\n[}]: #\n\nSecond, to add the following command that will make each `yarn add <package-name>` command automatically add the library without any additions or `^` signs into it.\n\n[{]: <helper> (diffStep \"1.2\" files=\".npmrc\" module=\"client\")\n\n#### [__Client__ Step 1.2: Pin dependencies](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/fba8842263675a5653d2947f26c99341672a8a19)\n\n##### Added .npmrc\n```diff\n@@ -0,0 +1 @@\n+â”Š â”Š1â”Šsave-exact=true\n```\n\n[}]: #\n\nThere is no need to upgrade your dependencies at all. If they work it's ok. But, it is highly recommended.\nPackages keep improving all the time with important things that would help your app and will save you time.\nIf you make it a routine to upgrade it makes it much easier then to upgrade every couple of months.\nIn order to discover if there are new versions of libraries there are 2 options.\n\nOne is to manually run a check every day or so to find new packages out there.\nYou can do that by going to your command line in the root folder of the project and type `yarn outdated`.\n\nBut if you want to get notified when there is a new version of your dependencies, you can check out [Renovate](https://github.com/renovatebot/renovate).\nIf your project is hosted somewhere, for example Github, it will analyze your `package.json` and submit a new PR when a new release happened from one of your dependencies.\n\n## git and saving your code on Github\n\nIf you want to save your code somewhere where you can track versions, using [git](https://git-scm.com/book/en/v2) and [Github](https://guides.github.com/activities/hello-world/) is a good choice.\nHere is a nice guide to start: https://try.github.io/.\n\nYou can check out the `.gitignore` file create-react-app has set up for us in the root folder.\nThat file will tell `.git` what not to save and not to upload.\n\n## Code formatting\n\nSome developers write code in a different style than others and it might be annoying while doing code reviews or even merging conflicts. That's why we want to make it consistent. We're going to use **Prettier** which has an opinionated set of styling rules and supports many languages. Your IDE most likely supports it too.\n\n    $ yarn add prettier\n\nWe're going to define a npm script called `format`, few styling rules and we're also going to ignore *node_modules*:\n\n[{]: <helper> (diffStep \"1.3\" files=\"package.json, .prettierrc.yml, .prettierignore\" module=\"client\")\n\n#### [__Client__ Step 1.3: Use Prettier](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/7fbf1a47622e7eceeda4d0cacfc695248b4cd1f5)\n\n##### Added .prettierignore\n```diff\n@@ -0,0 +1 @@\n+â”Š â”Š1â”Šnode_modulesðŸš«â†µ\n```\n\n##### Added .prettierrc.yml\n```diff\n@@ -0,0 +1,4 @@\n+â”Š â”Š1â”ŠtrailingComma: 'es5'\n+â”Š â”Š2â”ŠtabWidth: 2\n+â”Š â”Š3â”ŠsingleQuote: true\n+â”Š â”Š4â”ŠjsxBracketSameLine: true\n```\n\n##### Changed package.json\n```diff\n@@ -11,6 +11,7 @@\n â”Š11â”Š11â”Š    \"@types/node\": \"12.7.1\",\n â”Š12â”Š12â”Š    \"@types/react\": \"16.8.23\",\n â”Š13â”Š13â”Š    \"@types/react-dom\": \"16.8.5\",\n+â”Š  â”Š14â”Š    \"prettier\": \"1.18.2\",\n â”Š14â”Š15â”Š    \"react\": \"16.9.0\",\n â”Š15â”Š16â”Š    \"react-dom\": \"16.9.0\",\n â”Š16â”Š17â”Š    \"react-scripts\": \"3.1.0\",\n```\n```diff\n@@ -20,7 +21,8 @@\n â”Š20â”Š21â”Š    \"start\": \"react-scripts start\",\n â”Š21â”Š22â”Š    \"build\": \"react-scripts build\",\n â”Š22â”Š23â”Š    \"test\": \"TZ=\\\"Asia/Jerusalem\\\" react-scripts test\",\n-â”Š23â”Š  â”Š    \"eject\": \"react-scripts eject\"\n+â”Š  â”Š24â”Š    \"eject\": \"react-scripts eject\",\n+â”Š  â”Š25â”Š    \"format\": \"prettier \\\"**/*.{ts,tsx,css,graphql}\\\" --write\"\n â”Š24â”Š26â”Š  },\n â”Š25â”Š27â”Š  \"eslintConfig\": {\n â”Š26â”Š28â”Š    \"extends\": \"react-app\"\n```\n\n[}]: #\n\nNow let's run:\n\n    $ yarn format\n\nPrettier should format your code:\n\n[{]: <helper> (diffStep \"1.3\" files=\"src/App.tsx\" module=\"client\")\n\n#### [__Client__ Step 1.3: Use Prettier](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/7fbf1a47622e7eceeda4d0cacfc695248b4cd1f5)\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -14,13 +14,12 @@\n â”Š14â”Š14â”Š          className=\"App-link\"\n â”Š15â”Š15â”Š          href=\"https://reactjs.org\"\n â”Š16â”Š16â”Š          target=\"_blank\"\n-â”Š17â”Š  â”Š          rel=\"noopener noreferrer\"\n-â”Š18â”Š  â”Š        >\n+â”Š  â”Š17â”Š          rel=\"noopener noreferrer\">\n â”Š19â”Š18â”Š          Learn React\n â”Š20â”Š19â”Š        </a>\n â”Š21â”Š20â”Š      </header>\n â”Š22â”Š21â”Š    </div>\n â”Š23â”Š22â”Š  );\n-â”Š24â”Š  â”Š}\n+â”Š  â”Š23â”Š};\n â”Š25â”Š24â”Š\n â”Š26â”Š25â”Šexport default App;\n```\n\n[}]: #\n\n> Remember to run `yarn prettier` before you comit your changes!\n\n**End of intro**\n\nAssuming that everything is set, we will now create our first screen - `ChatsListScreen`.\nThe ChatsListScreen component is responsible for showing the active conversations within our app.\n\nIt's best to first schematically plan how our view's gonna look like.\nThis would help us illustrate the intended view and also understand which React.Components / elements take part in it.\nThis is how our screen's gonna look like:\n\n![chatslistscreen](https://user-images.githubusercontent.com/7648874/54027873-01305280-41de-11e9-9df0-5ad9c9c2f226.png)\n\nLet's break down the image above and see what components are we gonna have in the `ChatsListScreen`:\n\n- Navbar -  Which should contain a simple static title for now.\n- ChatsList - Where each item's gonna contain some data regards the user we're chatting with and information about the chat.\n\nFirst let's remove the current React code and add our own code into it.\n\nFor now, let's create fake data on our HTML.\n\nAs this data will be changed and we are not going to manually add HTML tags every time there is a new message, let's move our data into a JSON structure.\nFor now it would be a structure we will manually create.\nThat way we can already make our React component behave like our final version.\n\n[{]: <helper> (diffStep \"1.4\" files=\"App.tsx\" module=\"client\")\n\n#### [__Client__ Step 1.4: Create ChatsList screen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/7f863186eb09e5250defd7b77fa3b09c4d58032d)\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -1,23 +1,31 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n-â”Š 2â”Š  â”Šimport logo from './logo.svg';\n-â”Š 3â”Š  â”Šimport './App.css';\n â”Š 4â”Š 2â”Š\n â”Š 5â”Š 3â”Šconst App: React.FC = () => {\n â”Š 6â”Š 4â”Š  return (\n-â”Š 7â”Š  â”Š    <div className=\"App\">\n-â”Š 8â”Š  â”Š      <header className=\"App-header\">\n-â”Š 9â”Š  â”Š        <img src={logo} className=\"App-logo\" alt=\"logo\" />\n-â”Š10â”Š  â”Š        <p>\n-â”Š11â”Š  â”Š          Edit <code>src/App.tsx</code> and save to reload.\n-â”Š12â”Š  â”Š        </p>\n-â”Š13â”Š  â”Š        <a\n-â”Š14â”Š  â”Š          className=\"App-link\"\n-â”Š15â”Š  â”Š          href=\"https://reactjs.org\"\n-â”Š16â”Š  â”Š          target=\"_blank\"\n-â”Š17â”Š  â”Š          rel=\"noopener noreferrer\">\n-â”Š18â”Š  â”Š          Learn React\n-â”Š19â”Š  â”Š        </a>\n-â”Š20â”Š  â”Š      </header>\n+â”Š  â”Š 5â”Š    <div>\n+â”Š  â”Š 6â”Š      <div>Whatsapp Clone</div>\n+â”Š  â”Š 7â”Š      <div>\n+â”Š  â”Š 8â”Š        <ul>\n+â”Š  â”Š 9â”Š          <li>\n+â”Š  â”Š10â”Š            <img\n+â”Š  â”Š11â”Š              src=\"https://randomuser.me/api/portraits/thumb/men/1.jpg\"\n+â”Š  â”Š12â”Š              alt=\"Profile\"\n+â”Š  â”Š13â”Š            />\n+â”Š  â”Š14â”Š            <div>Ethan Gonzalez</div>\n+â”Š  â”Š15â”Š            <div>You on your way?</div>\n+â”Š  â”Š16â”Š            <div>10:25</div>\n+â”Š  â”Š17â”Š          </li>\n+â”Š  â”Š18â”Š          <li>\n+â”Š  â”Š19â”Š            <img\n+â”Š  â”Š20â”Š              src=\"https://randomuser.me/api/portraits/thumb/men/2.jpg\"\n+â”Š  â”Š21â”Š              alt=\"Profile\"\n+â”Š  â”Š22â”Š            />\n+â”Š  â”Š23â”Š            <div>Bryan Wallace</div>\n+â”Š  â”Š24â”Š            <div>Hey, it's me</div>\n+â”Š  â”Š25â”Š            <div>13:27</div>\n+â”Š  â”Š26â”Š          </li>\n+â”Š  â”Š27â”Š        </ul>\n+â”Š  â”Š28â”Š      </div>\n â”Š21â”Š29â”Š    </div>\n â”Š22â”Š30â”Š  );\n â”Š23â”Š31â”Š};\n```\n\n[}]: #\n\nIf all we do in the function is just returning a value, instead of `const App: React.FC = () => { return () };` we can also do `const App: React.FC = () => ();`\nSo let's use that for our ChatsList component.\n\nWe have to import React to make sure it will work.\nWe also have to export our component function so that the `App` component would be able to import it.\n(You can't import Javascript variables from a file if that file won't explicitly export it).\n\nAs we don't use those styles and logos anymore, we can delete the `src/App.css` and the `src/logo.svg` files from our app.\n\nNow let's move ChatsList into it's own component:\n\n[{]: <helper> (diffStep \"1.5\" files=\"ChatsList.tsx\" module=\"client\")\n\n#### [__Client__ Step 1.5: Move ChatsList to a component](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/239691f25412d4f54f42ce2d87f4365e29cf7806)\n\n##### Added src&#x2F;components&#x2F;ChatsList.tsx\n```diff\n@@ -0,0 +1,22 @@\n+â”Š  â”Š 1â”Šimport React from 'react';\n+â”Š  â”Š 2â”Š\n+â”Š  â”Š 3â”Šconst ChatsList: React.FC = () => (\n+â”Š  â”Š 4â”Š  <div>\n+â”Š  â”Š 5â”Š    <ul>\n+â”Š  â”Š 6â”Š        <li>\n+â”Š  â”Š 7â”Š          <img src=\"https://randomuser.me/api/portraits/thumb/men/1.jpg\" alt=\"Profile\"/>\n+â”Š  â”Š 8â”Š          <div>Ethan Gonzalez</div>\n+â”Š  â”Š 9â”Š            <div>You on your way?</div>\n+â”Š  â”Š10â”Š            <div>10:25</div>\n+â”Š  â”Š11â”Š        </li>\n+â”Š  â”Š12â”Š        <li>\n+â”Š  â”Š13â”Š          <img src=\"https://randomuser.me/api/portraits/thumb/men/2.jpg\" alt=\"Profile\"/>\n+â”Š  â”Š14â”Š          <div>Bryan Wallace</div>\n+â”Š  â”Š15â”Š            <div>Hey, it's me</div>\n+â”Š  â”Š16â”Š            <div>13:27</div>\n+â”Š  â”Š17â”Š        </li>\n+â”Š  â”Š18â”Š    </ul>\n+â”Š  â”Š19â”Š  </div>\n+â”Š  â”Š20â”Š);\n+â”Š  â”Š21â”Š\n+â”Š  â”Š22â”Šexport default ChatsList;ðŸš«â†µ\n```\n\n[}]: #\n\nand let's import that component into the App component and use the shorter syntax for the functional component:\n\n[{]: <helper> (diffStep \"1.5\" files=\"App.tsx\" module=\"client\")\n\n#### [__Client__ Step 1.5: Move ChatsList to a component](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/239691f25412d4f54f42ce2d87f4365e29cf7806)\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -1,31 +1,13 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n+â”Š  â”Š 2â”Šimport ChatsList from './components/ChatsList';\n â”Š 2â”Š 3â”Š\n â”Š 3â”Š 4â”Šconst App: React.FC = () => {\n â”Š 4â”Š 5â”Š  return (\n â”Š 5â”Š 6â”Š    <div>\n-â”Š 6â”Š  â”Š      <div>Whatsapp Clone</div>\n â”Š 7â”Š 7â”Š      <div>\n-â”Š 8â”Š  â”Š        <ul>\n-â”Š 9â”Š  â”Š          <li>\n-â”Š10â”Š  â”Š            <img\n-â”Š11â”Š  â”Š              src=\"https://randomuser.me/api/portraits/thumb/men/1.jpg\"\n-â”Š12â”Š  â”Š              alt=\"Profile\"\n-â”Š13â”Š  â”Š            />\n-â”Š14â”Š  â”Š            <div>Ethan Gonzalez</div>\n-â”Š15â”Š  â”Š            <div>You on your way?</div>\n-â”Š16â”Š  â”Š            <div>10:25</div>\n-â”Š17â”Š  â”Š          </li>\n-â”Š18â”Š  â”Š          <li>\n-â”Š19â”Š  â”Š            <img\n-â”Š20â”Š  â”Š              src=\"https://randomuser.me/api/portraits/thumb/men/2.jpg\"\n-â”Š21â”Š  â”Š              alt=\"Profile\"\n-â”Š22â”Š  â”Š            />\n-â”Š23â”Š  â”Š            <div>Bryan Wallace</div>\n-â”Š24â”Š  â”Š            <div>Hey, it's me</div>\n-â”Š25â”Š  â”Š            <div>13:27</div>\n-â”Š26â”Š  â”Š          </li>\n-â”Š27â”Š  â”Š        </ul>\n+â”Š  â”Š 8â”Š        Whatsapp Clone\n â”Š28â”Š 9â”Š      </div>\n+â”Š  â”Š10â”Š      <ChatsList />\n â”Š29â”Š11â”Š    </div>\n â”Š30â”Š12â”Š  );\n â”Š31â”Š13â”Š};\n```\n\n[}]: #\n\nand let's do the same for our Navbar:\n\n[{]: <helper> (diffStep \"1.6\" module=\"client\")\n\n#### [__Client__ Step 1.6: Move ChatsNavbar to a component](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/6bfc354df157450d5ac8f62a37c0bcb0986beeae)\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -1,12 +1,11 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n â”Š 2â”Š 2â”Šimport ChatsList from './components/ChatsList';\n+â”Š  â”Š 3â”Šimport ChatsNavbar from './components/ChatsNavbar';\n â”Š 3â”Š 4â”Š\n â”Š 4â”Š 5â”Šconst App: React.FC = () => {\n â”Š 5â”Š 6â”Š  return (\n â”Š 6â”Š 7â”Š    <div>\n-â”Š 7â”Š  â”Š      <div>\n-â”Š 8â”Š  â”Š        Whatsapp Clone\n-â”Š 9â”Š  â”Š      </div>\n+â”Š  â”Š 8â”Š      <ChatsNavbar />\n â”Š10â”Š 9â”Š      <ChatsList />\n â”Š11â”Š10â”Š    </div>\n â”Š12â”Š11â”Š  );\n```\n\n##### Changed src&#x2F;components&#x2F;ChatsList.tsx\n```diff\n@@ -3,20 +3,26 @@\n â”Š 3â”Š 3â”Šconst ChatsList: React.FC = () => (\n â”Š 4â”Š 4â”Š  <div>\n â”Š 5â”Š 5â”Š    <ul>\n-â”Š 6â”Š  â”Š        <li>\n-â”Š 7â”Š  â”Š          <img src=\"https://randomuser.me/api/portraits/thumb/men/1.jpg\" alt=\"Profile\"/>\n-â”Š 8â”Š  â”Š          <div>Ethan Gonzalez</div>\n-â”Š 9â”Š  â”Š            <div>You on your way?</div>\n-â”Š10â”Š  â”Š            <div>10:25</div>\n-â”Š11â”Š  â”Š        </li>\n-â”Š12â”Š  â”Š        <li>\n-â”Š13â”Š  â”Š          <img src=\"https://randomuser.me/api/portraits/thumb/men/2.jpg\" alt=\"Profile\"/>\n-â”Š14â”Š  â”Š          <div>Bryan Wallace</div>\n-â”Š15â”Š  â”Š            <div>Hey, it's me</div>\n-â”Š16â”Š  â”Š            <div>13:27</div>\n-â”Š17â”Š  â”Š        </li>\n+â”Š  â”Š 6â”Š      <li>\n+â”Š  â”Š 7â”Š        <img\n+â”Š  â”Š 8â”Š          src=\"https://randomuser.me/api/portraits/thumb/men/1.jpg\"\n+â”Š  â”Š 9â”Š          alt=\"Profile\"\n+â”Š  â”Š10â”Š        />\n+â”Š  â”Š11â”Š        <div>Ethan Gonzalez</div>\n+â”Š  â”Š12â”Š        <div>You on your way?</div>\n+â”Š  â”Š13â”Š        <div>10:25</div>\n+â”Š  â”Š14â”Š      </li>\n+â”Š  â”Š15â”Š      <li>\n+â”Š  â”Š16â”Š        <img\n+â”Š  â”Š17â”Š          src=\"https://randomuser.me/api/portraits/thumb/men/2.jpg\"\n+â”Š  â”Š18â”Š          alt=\"Profile\"\n+â”Š  â”Š19â”Š        />\n+â”Š  â”Š20â”Š        <div>Bryan Wallace</div>\n+â”Š  â”Š21â”Š        <div>Hey, it's me</div>\n+â”Š  â”Š22â”Š        <div>13:27</div>\n+â”Š  â”Š23â”Š      </li>\n â”Š18â”Š24â”Š    </ul>\n â”Š19â”Š25â”Š  </div>\n â”Š20â”Š26â”Š);\n â”Š21â”Š27â”Š\n-â”Š22â”Š  â”Šexport default ChatsList;ðŸš«â†µ\n+â”Š  â”Š28â”Šexport default ChatsList;\n```\n\n##### Added src&#x2F;components&#x2F;ChatsNavbar.tsx\n```diff\n@@ -0,0 +1,5 @@\n+â”Š â”Š1â”Šimport React from 'react';\n+â”Š â”Š2â”Š\n+â”Š â”Š3â”Šconst ChatsNavbar: React.FC = () => <div>Whatsapp Clone</div>;\n+â”Š â”Š4â”Š\n+â”Š â”Š5â”Šexport default ChatsNavbar;\n```\n\n[}]: #\n\nReact apps tend to store React.Components under a directory located at `src/components`, and so we're gonna follow this pattern.\nWe will create a directory called ChatsListScreen in the `components` dir where we're simply gonna import and put together the Navbar and ChatsList components.\nThis is how the contents of that directory should look like:\n\n    ChatsListScreen\n    â”œâ”€â”€ index.tsx\n    â”œâ”€â”€ ChatsList\n    â””â”€â”€ ChatsNavbar\n\nWe will use the `index.tsx` file to define that component, this way we can import it using the directory name:\n\n[{]: <helper> (diffStep \"1.7\" module=\"client\")\n\n#### [__Client__ Step 1.7: Move all ChatsListScreen into a folder](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/105189dfd6e499ac0fd3fe4cb3b0ca0da8316aed)\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -1,14 +1,10 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n-â”Š 2â”Š  â”Šimport ChatsList from './components/ChatsList';\n-â”Š 3â”Š  â”Šimport ChatsNavbar from './components/ChatsNavbar';\n+â”Š  â”Š 2â”Šimport ChatsListScreen from './components/ChatsListScreen';\n â”Š 4â”Š 3â”Š\n-â”Š 5â”Š  â”Šconst App: React.FC = () => {\n-â”Š 6â”Š  â”Š  return (\n-â”Š 7â”Š  â”Š    <div>\n-â”Š 8â”Š  â”Š      <ChatsNavbar />\n-â”Š 9â”Š  â”Š      <ChatsList />\n-â”Š10â”Š  â”Š    </div>\n-â”Š11â”Š  â”Š  );\n-â”Š12â”Š  â”Š};\n+â”Š  â”Š 4â”Šconst App: React.FC = () => (\n+â”Š  â”Š 5â”Š  <div>\n+â”Š  â”Š 6â”Š    <ChatsListScreen />\n+â”Š  â”Š 7â”Š  </div>\n+â”Š  â”Š 8â”Š);\n â”Š13â”Š 9â”Š\n â”Š14â”Š10â”Šexport default App;\n```\n\n##### Renamed from src&#x2F;components&#x2F;ChatsList.tsx to src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n\n\n##### Renamed from src&#x2F;components&#x2F;ChatsNavbar.tsx to src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsNavbar.tsx\n\n\n##### Added src&#x2F;components&#x2F;ChatsListScreen&#x2F;index.tsx\n```diff\n@@ -0,0 +1,12 @@\n+â”Š  â”Š 1â”Šimport React from 'react';\n+â”Š  â”Š 2â”Šimport ChatsNavbar from './ChatsNavbar';\n+â”Š  â”Š 3â”Šimport ChatsList from './ChatsList';\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šconst ChatsListScreen: React.FC = () => (\n+â”Š  â”Š 6â”Š  <div>\n+â”Š  â”Š 7â”Š    <ChatsNavbar />\n+â”Š  â”Š 8â”Š    <ChatsList />\n+â”Š  â”Š 9â”Š  </div>\n+â”Š  â”Š10â”Š);\n+â”Š  â”Š11â”Š\n+â”Š  â”Š12â”Šexport default ChatsListScreen;\n```\n\n[}]: #\n\nNow, we have our app rendering our view, but it is completely static and manual in the code.\n\nIf we had 10 messages, we wouldn't want to type all of those HTML tags again and again.\nAlso if the data will change, the app should do this update itself without the need of hand written code.\n\nSo let's create a file that lists just the data of our chats and then make our React component render a line for each entry in that file.\n\nWe will create the file in a JSON format:\n\n[{]: <helper> (diffStep \"1.8\" files=\"db.ts\" module=\"client\")\n\n#### [__Client__ Step 1.8: Attach unique keys to ChatsList](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/764a7968450531f959a7fe1a6f1e902a3b08574c)\n\n##### Added src&#x2F;db.ts\n```diff\n@@ -0,0 +1,49 @@\n+â”Š  â”Š 1â”Šexport const messages = [\n+â”Š  â”Š 2â”Š  {\n+â”Š  â”Š 3â”Š    id: '1',\n+â”Š  â”Š 4â”Š    content: 'You on your way?',\n+â”Š  â”Š 5â”Š    createdAt: new Date(Date.now() - 60 * 1000 * 1000),\n+â”Š  â”Š 6â”Š  },\n+â”Š  â”Š 7â”Š  {\n+â”Š  â”Š 8â”Š    id: '2',\n+â”Š  â”Š 9â”Š    content: \"Hey, it's me\",\n+â”Š  â”Š10â”Š    createdAt: new Date(Date.now() - 2 * 60 * 1000 * 1000),\n+â”Š  â”Š11â”Š  },\n+â”Š  â”Š12â”Š  {\n+â”Š  â”Š13â”Š    id: '3',\n+â”Š  â”Š14â”Š    content: 'I should buy a boat',\n+â”Š  â”Š15â”Š    createdAt: new Date(Date.now() - 24 * 60 * 1000 * 1000),\n+â”Š  â”Š16â”Š  },\n+â”Š  â”Š17â”Š  {\n+â”Š  â”Š18â”Š    id: '4',\n+â”Š  â”Š19â”Š    content: 'This is wicked good ice cream.',\n+â”Š  â”Š20â”Š    createdAt: new Date(Date.now() - 14 * 24 * 60 * 1000 * 1000),\n+â”Š  â”Š21â”Š  },\n+â”Š  â”Š22â”Š];\n+â”Š  â”Š23â”Š\n+â”Š  â”Š24â”Šexport const chats = [\n+â”Š  â”Š25â”Š  {\n+â”Š  â”Š26â”Š    id: '1',\n+â”Š  â”Š27â”Š    name: 'Ethan Gonzalez',\n+â”Š  â”Š28â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n+â”Š  â”Š29â”Š    lastMessage: messages.find(m => m.id === '1'),\n+â”Š  â”Š30â”Š  },\n+â”Š  â”Š31â”Š  {\n+â”Š  â”Š32â”Š    id: '2',\n+â”Š  â”Š33â”Š    name: 'Bryan Wallace',\n+â”Š  â”Š34â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n+â”Š  â”Š35â”Š    lastMessage: messages.find(m => m.id === '2'),\n+â”Š  â”Š36â”Š  },\n+â”Š  â”Š37â”Š  {\n+â”Š  â”Š38â”Š    id: '3',\n+â”Š  â”Š39â”Š    name: 'Avery Stewart',\n+â”Š  â”Š40â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n+â”Š  â”Š41â”Š    lastMessage: messages.find(m => m.id === '3'),\n+â”Š  â”Š42â”Š  },\n+â”Š  â”Š43â”Š  {\n+â”Š  â”Š44â”Š    id: '4',\n+â”Š  â”Š45â”Š    name: 'Katie Peterson',\n+â”Š  â”Š46â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n+â”Š  â”Š47â”Š    lastMessage: messages.find(m => m.id === '4'),\n+â”Š  â”Š48â”Š  },\n+â”Š  â”Š49â”Š];\n```\n\n[}]: #\n\nWe are giving IDs for the values just like a database gives a unique id for each value.\n\nThis is so we can reference specific values, for example,\nlast message would actually reference the other array instead of duplicating the values.\n\nNow let's change ChatsList component to import the data from that file.\nThen to use the Javascript [map](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/map)\nfunction to render a line for each data entry:\n\n[{]: <helper> (diffStep \"1.8\" files=\"ChatsList.tsx\" module=\"client\")\n\n#### [__Client__ Step 1.8: Attach unique keys to ChatsList](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/764a7968450531f959a7fe1a6f1e902a3b08574c)\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -1,26 +1,15 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n+â”Š  â”Š 2â”Šimport { chats } from '../../db';\n â”Š 2â”Š 3â”Š\n â”Š 3â”Š 4â”Šconst ChatsList: React.FC = () => (\n â”Š 4â”Š 5â”Š  <div>\n â”Š 5â”Š 6â”Š    <ul>\n-â”Š 6â”Š  â”Š      <li>\n-â”Š 7â”Š  â”Š        <img\n-â”Š 8â”Š  â”Š          src=\"https://randomuser.me/api/portraits/thumb/men/1.jpg\"\n-â”Š 9â”Š  â”Š          alt=\"Profile\"\n-â”Š10â”Š  â”Š        />\n-â”Š11â”Š  â”Š        <div>Ethan Gonzalez</div>\n-â”Š12â”Š  â”Š        <div>You on your way?</div>\n-â”Š13â”Š  â”Š        <div>10:25</div>\n-â”Š14â”Š  â”Š      </li>\n-â”Š15â”Š  â”Š      <li>\n-â”Š16â”Š  â”Š        <img\n-â”Š17â”Š  â”Š          src=\"https://randomuser.me/api/portraits/thumb/men/2.jpg\"\n-â”Š18â”Š  â”Š          alt=\"Profile\"\n-â”Š19â”Š  â”Š        />\n-â”Š20â”Š  â”Š        <div>Bryan Wallace</div>\n-â”Š21â”Š  â”Š        <div>Hey, it's me</div>\n-â”Š22â”Š  â”Š        <div>13:27</div>\n-â”Š23â”Š  â”Š      </li>\n+â”Š  â”Š 7â”Š      {chats.map(chat => (\n+â”Š  â”Š 8â”Š        <li key={chat.id}>\n+â”Š  â”Š 9â”Š          <img src={chat.picture} alt=\"Profile\" />\n+â”Š  â”Š10â”Š          <div>{chat.name}</div>\n+â”Š  â”Š11â”Š        </li>\n+â”Š  â”Š12â”Š      ))}\n â”Š24â”Š13â”Š    </ul>\n â”Š25â”Š14â”Š  </div>\n â”Š26â”Š15â”Š);\n```\n\n[}]: #\n\nWhen running `map` on the `chats` array, it will run a function for each entry in the array and return a value.\nThe function will receive the current entry as a parameter.\nIn our case the function will get the current function and will return a JSX line with the data of that specific chat.\n\nNotice we are also adding the `key` tag with the ID of each chat.\nIf you'll remove that and render again you will see the following error inside the console of your [Chrome developer tools](https://developers.google.com/web/tools/chrome-devtools/):\n`Warning: Each child in a list should have a unique \"key\" prop`.\n\nBy telling React how to identify and distinguish each element using the `key` value we help solve that problem and also making React faster.\nRead [here](https://reactjs.org/docs/lists-and-keys.html) for more in depth explanation.\n\nNow that we've rendered a line for each chat, let's add also the last message's content and creation date for each chat:\n\n[{]: <helper> (diffStep \"1.9\" module=\"client\")\n\n#### [__Client__ Step 1.9: Failed try to add last message to ChatsList](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/e1e7f8ece37a4713bb603d7b159229d4459536e3)\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -8,6 +8,8 @@\n â”Š 8â”Š 8â”Š        <li key={chat.id}>\n â”Š 9â”Š 9â”Š          <img src={chat.picture} alt=\"Profile\" />\n â”Š10â”Š10â”Š          <div>{chat.name}</div>\n+â”Š  â”Š11â”Š          <div>{chat.lastMessage.content}</div>\n+â”Š  â”Š12â”Š          <div>{chat.lastMessage.createdAt}</div>\n â”Š11â”Š13â”Š        </li>\n â”Š12â”Š14â”Š      ))}\n â”Š13â”Š15â”Š    </ul>\n```\n\n[}]: #\n\nTry to run the app again.\n\nYou can see we get a Typescript error.\nThis is because Typescript is smart enough and tells us there might be no last message.\nSo we add a check.\nRemember to always check for null or undefined if optional, donâ€™t write shorter write safer:\n\n[{]: <helper> (diffStep \"1.10\" module=\"client\")\n\n#### [__Client__ Step 1.10: Second failed try to add last message to ChatsList](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/bf6bc55de6098f41a94298ac714270d7e278cd43)\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -8,8 +8,10 @@\n â”Š 8â”Š 8â”Š        <li key={chat.id}>\n â”Š 9â”Š 9â”Š          <img src={chat.picture} alt=\"Profile\" />\n â”Š10â”Š10â”Š          <div>{chat.name}</div>\n+â”Š  â”Š11â”Š          {chat.lastMessage && (\n â”Š11â”Š12â”Š          <div>{chat.lastMessage.content}</div>\n â”Š12â”Š13â”Š          <div>{chat.lastMessage.createdAt}</div>\n+â”Š  â”Š14â”Š          )}\n â”Š13â”Š15â”Š        </li>\n â”Š14â”Š16â”Š      ))}\n â”Š15â”Š17â”Š    </ul>\n```\n\n[}]: #\n\nNow let's try again.\n\nNow we have a syntax error - A JSX return value can't have more then a single root Element.\nSo in order to return a root element from the function but still display multiple elements in the same level,\nwe can use [React.Fragment](https://reactjs.org/docs/fragments.html) to wrap the returned elements:\n\n[{]: <helper> (diffStep \"1.11\" module=\"client\")\n\n#### [__Client__ Step 1.11: Third failed try to add last message to ChatsList](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/1246f4dcaa98cdf968b6a548b04cfbb5bbb62762)\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -9,8 +9,10 @@\n â”Š 9â”Š 9â”Š          <img src={chat.picture} alt=\"Profile\" />\n â”Š10â”Š10â”Š          <div>{chat.name}</div>\n â”Š11â”Š11â”Š          {chat.lastMessage && (\n-â”Š12â”Š  â”Š          <div>{chat.lastMessage.content}</div>\n-â”Š13â”Š  â”Š          <div>{chat.lastMessage.createdAt}</div>\n+â”Š  â”Š12â”Š            <React.Fragment>\n+â”Š  â”Š13â”Š              <div>{chat.lastMessage.content}</div>\n+â”Š  â”Š14â”Š              <div>{chat.lastMessage.createdAt}</div>\n+â”Š  â”Š15â”Š            </React.Fragment>\n â”Š14â”Š16â”Š          )}\n â”Š15â”Š17â”Š        </li>\n â”Š16â”Š18â”Š      ))}\n```\n\n[}]: #\n\n\nLet's try again.  This time it looks like the format is not correct, so let's format the date using the `moment` library.\n\nLet's install the [`moment`](https://momentjs.com/) library to wrap `lastMessage.createdAt` with a better format.\nMoment has the ability to wrap date objects nicely and rewrite them in a pretty format.\nThis way we can have an elegant time format at which the message was sent e.g. `11:34`.\nTo install:\n\n\t$ yarn add moment\n\n\nAnd now let's import the library by it's name, wrap the value of each chat and call the `format` function with our requested format:\n\n[{]: <helper> (diffStep \"1.12\" files=\"ChatsList.tsx\" module=\"client\")\n\n#### [__Client__ Step 1.12: Success adding last message to ChatsList](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/6b332cbc0ee36aa2fb9715847ce49a4a8cd4e1d0)\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -1,5 +1,6 @@\n â”Š1â”Š1â”Šimport React from 'react';\n â”Š2â”Š2â”Šimport { chats } from '../../db';\n+â”Š â”Š3â”Šimport moment from 'moment';\n â”Š3â”Š4â”Š\n â”Š4â”Š5â”Šconst ChatsList: React.FC = () => (\n â”Š5â”Š6â”Š  <div>\n```\n```diff\n@@ -11,7 +12,7 @@\n â”Š11â”Š12â”Š          {chat.lastMessage && (\n â”Š12â”Š13â”Š            <React.Fragment>\n â”Š13â”Š14â”Š              <div>{chat.lastMessage.content}</div>\n-â”Š14â”Š  â”Š              <div>{chat.lastMessage.createdAt}</div>\n+â”Š  â”Š15â”Š              <div>{moment(chat.lastMessage.createdAt).format('HH:mm')}</div>\n â”Š15â”Š16â”Š            </React.Fragment>\n â”Š16â”Š17â”Š          )}\n â”Š17â”Š18â”Š        </li>\n```\n\n[}]: #\n\n\nIf you'll try to run the app you'll see that everything is there, but it's not hard to notice that it's missing some style:\n\n![naked-chats-list](https://user-images.githubusercontent.com/7648874/54028578-73099b80-41e0-11e9-803a-7469300acb06.png)\n\nIn the next chapter we will take care of styling our application with [Material-UI](https://material-ui.com/) and [styled-components](https://www.styled-components.com/) - we will give it the desired look and make it more user friendly. For now the ChatsListScreen serves no purpose, because you can't really do anything with it, but it can be used as a great basis to build on top of as we make progress.\n\nTODO: Define and use Prettier.\nTODO: Editor and Prettier, extensions - Auto Import, GitLens, npm Intellisense, TypeScript Importer - works when Auto Import doesn't\nTODO: react-dev-tools, go through everything on dev tools.\nTODO: build. show built code. show it on file and show it on the browser.\nTODO: Go through all of https://facebook.github.io/create-react-app/docs/\nTODO: Should we talk about Storybook?\nTODO: Should we use â€œâ€ or â€˜â€™?\nTODO: Should we use date-fns instead of moment?"
          },
          {
            "manualTitle": "Step 2: Styling with Material UI and styled-components",
            "stepRevision": "d486d2cb7c9ca0a54c4c7677904f317ca568c5f5",
            "manualView": "Now it's time to style our app.\n\nWe can edit styles manually but we can also use ready made components that have already been styled and shared in the community.\n\nIn this chapter we will do both.\n\nFirst, we would also use [Material-UI](https://material-ui.com/) - a library with a set of React components that implements Google's Material Design.\nWhat's good about it is that the design is already implemented right out of the box.\nNot only that, but it also includes a set of icons which are free to use.\n\nThere are many things that Material-UI can offer, and it's not easy to follow it up, especially with the constantly evolving and improving API.\nThe best way to go with it, is to identify a component you need, and then look for it in the [official website](https://material-ui.com/).\nAnd when it comes to searching for icons, they can be found on the [material.io](https://material-ui.com/) website through the search bar.\n\nAs we move further in this tutorial you should have a better grasp of Material and how to use it.\n\n![material-ui-icons](https://user-images.githubusercontent.com/7648874/54141504-c853e000-4460-11e9-94b5-aae98ec9a1e3.png)\n\nWe will start off by installing some of the needed material libraries and its Typescript types library:\n\n    $ yarn add @material-ui/core @material-ui/icons\n\n`@material-ui/core` includes core component of Material-UI such as Input, Popover, Modal, etc, and `@material-ui/icons` includes a set of icons.\nMaterial is very generic and has a built in theming system which can be controlled by simply setting few variables,\nwhich is exactly what we're gonna need in our app.\n\nIn our app we're mainly gonna use 2 colors:\n\n- Primary #306759\n- Secondary #79e352\n\nThe easiest way to reference colors without repeating yourself is through Themes.\nTheme definition can easily be done in Material using the MuiThemeProvider component:\n\n[{]: <helper> (diffStep \"2.2\" module=\"client\")\n\n#### [__Client__ Step 2.2: Setup Material-UI theme](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/2b239c20e1651fa3be1dc6b4cc93e8fc924ba871)\n\n##### Changed src&#x2F;index.tsx\n```diff\n@@ -1,10 +1,23 @@\n+â”Š  â”Š 1â”Šimport { MuiThemeProvider, createMuiTheme } from '@material-ui/core/styles';\n â”Š 1â”Š 2â”Šimport React from 'react';\n â”Š 2â”Š 3â”Šimport ReactDOM from 'react-dom';\n â”Š 3â”Š 4â”Šimport './index.css';\n â”Š 4â”Š 5â”Šimport App from './App';\n â”Š 5â”Š 6â”Šimport * as serviceWorker from './serviceWorker';\n â”Š 6â”Š 7â”Š\n-â”Š 7â”Š  â”ŠReactDOM.render(<App />, document.getElementById('root'));\n+â”Š  â”Š 8â”Šconst theme = createMuiTheme({\n+â”Š  â”Š 9â”Š  palette: {\n+â”Š  â”Š10â”Š    primary: { main: '#2c6157' },\n+â”Š  â”Š11â”Š    secondary: { main: '#6fd056' },\n+â”Š  â”Š12â”Š  },\n+â”Š  â”Š13â”Š});\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”ŠReactDOM.render(\n+â”Š  â”Š16â”Š  <MuiThemeProvider theme={theme}>\n+â”Š  â”Š17â”Š    <App />\n+â”Š  â”Š18â”Š  </MuiThemeProvider>,\n+â”Š  â”Š19â”Š  document.getElementById('root')\n+â”Š  â”Š20â”Š);\n â”Š 8â”Š21â”Š\n â”Š 9â”Š22â”Š// If you want your app to work offline and load faster, you can change\n â”Š10â”Š23â”Š// unregister() to register() below. Note this comes with some pitfalls.\n```\n\n[}]: #\n\n\nWe create a `palette` of the themes together with any other definitions for the theme, and then we wrap our app with a React component\nfrom the `material-ui` library to provide those definitions to all of our App's components when they need them.\n\nOnce we have it set, the colors should be available to use in our application by simply providing the \"color\" prop to the component instance whose color we would like to change:\n\n```diff\n<Button color=\"primary\">Primary</Button>\n<Button color=\"secondary\">Secondary</Button>\n```\n\nIn our app, we're also gonna use CSS directly to change its colors, therefore it would be handy to have these theme variables available to us through CSS.\nTo do so, we will have a second definition of these variables in `index.css`, at the `:root` level of our application.\n\nThat feels like a small duplication but this will help us use them in styled components directly.\nAlso that means you can view the variables in chrome-dev-tools.\n\n[{]: <helper> (diffStep \"2.3\" module=\"client\")\n\n#### [__Client__ Step 2.3: Setup CSS theme vars](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/d598b5802688c39a162054877b0c8bfb542fdcc3)\n\n##### Changed src&#x2F;index.css\n```diff\n@@ -1,3 +1,10 @@\n+â”Š  â”Š 1â”Š:root {\n+â”Š  â”Š 2â”Š  --primary-bg: #2c6157;\n+â”Š  â”Š 3â”Š  --secondary-bg: #6fd056;\n+â”Š  â”Š 4â”Š  --primary-text: white;\n+â”Š  â”Š 5â”Š  --secondary-text: white;\n+â”Š  â”Š 6â”Š}\n+â”Š  â”Š 7â”Š\n â”Š 1â”Š 8â”Šbody {\n â”Š 2â”Š 9â”Š  margin: 0;\n â”Š 3â”Š10â”Š  padding: 0;\n```\n\n[}]: #\n\n`:root` is a pseudo element that simply represents the root node, which will make the colors available in all elements.\nNormally, it works like JavaScript's scoping system and it will make variables available only to the current node and to its children, NOT its parents.\nCSS vars can be used like so:\n\n```css\n  color: var(--primary-text);\n  background-color: var(--primary-bg);\n```\n\nMore information about CSS variables can be found in the [official MDN docs](https://developer.mozilla.org/en-US/docs/Web/CSS/Using_CSS_variables).\n\nSo getting back to the ChatsListScreen, we will wrap the ChatsNavbar with Material's <Toolbar /> component:\n\n[{]: <helper> (diffStep \"2.4\" files=\"ChatsNavbar.tsx\" module=\"client\")\n\n#### [__Client__ Step 2.4: Use Material components](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/f50304bd5b124719c027ee867345fd2650620a28)\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsNavbar.tsx\n```diff\n@@ -1,5 +1,6 @@\n â”Š1â”Š1â”Šimport React from 'react';\n+â”Š â”Š2â”Šimport { Toolbar } from '@material-ui/core';\n â”Š2â”Š3â”Š\n-â”Š3â”Š â”Šconst ChatsNavbar: React.FC = () => <div>Whatsapp Clone</div>;\n+â”Š â”Š4â”Šconst ChatsNavbar: React.FC = () => <Toolbar>Whatsapp Clone</Toolbar>;\n â”Š4â”Š5â”Š\n â”Š5â”Š6â”Šexport default ChatsNavbar;\n```\n\n[}]: #\n\nAnd we will replace the `<ul />` and `<li />` elements with Material's `<List />` and `<ListItem />` in ChatsList:\n\n[{]: <helper> (diffStep \"2.4\" files=\"ChatsList.tsx\" module=\"client\")\n\n#### [__Client__ Step 2.4: Use Material components](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/f50304bd5b124719c027ee867345fd2650620a28)\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -1,12 +1,13 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n â”Š 2â”Š 2â”Šimport { chats } from '../../db';\n â”Š 3â”Š 3â”Šimport moment from 'moment';\n+â”Š  â”Š 4â”Šimport { List, ListItem } from '@material-ui/core';\n â”Š 4â”Š 5â”Š\n â”Š 5â”Š 6â”Šconst ChatsList: React.FC = () => (\n â”Š 6â”Š 7â”Š  <div>\n-â”Š 7â”Š  â”Š    <ul>\n+â”Š  â”Š 8â”Š    <List>\n â”Š 8â”Š 9â”Š      {chats.map(chat => (\n-â”Š 9â”Š  â”Š        <li key={chat.id}>\n+â”Š  â”Š10â”Š        <ListItem key={chat.id} button>\n â”Š10â”Š11â”Š          <img src={chat.picture} alt=\"Profile\" />\n â”Š11â”Š12â”Š          <div>{chat.name}</div>\n â”Š12â”Š13â”Š          {chat.lastMessage && (\n```\n```diff\n@@ -15,9 +16,9 @@\n â”Š15â”Š16â”Š              <div>{moment(chat.lastMessage.createdAt).format('HH:mm')}</div>\n â”Š16â”Š17â”Š            </React.Fragment>\n â”Š17â”Š18â”Š          )}\n-â”Š18â”Š  â”Š        </li>\n+â”Š  â”Š19â”Š        </ListItem>\n â”Š19â”Š20â”Š      ))}\n-â”Š20â”Š  â”Š    </ul>\n+â”Š  â”Š21â”Š    </List>\n â”Š21â”Š22â”Š  </div>\n â”Š22â”Š23â”Š);\n â”Š23â”Š24â”Š\n```\n\n[}]: #\n\nThanks to the `button` attribute, the Material component can give our list a more vibrant feeling and that will display a nice ripple effect once an item is clicked,\nsomething that could have taken a long time to implement manually.\n\nNow that we are using existing styled components, it's time to customize them to look exactly like we want them to look.\nWhen we write styles, we usually use CSS.\n\nOne of the important concepts that React brought us was the fact we could use just Javascript to describe our components\nand another was the fact that we could encapsulate our UI into a set of separated components.\n\nBut when it comes to CSS, we are still using it like before, having no encapsulation between different definitions and files.\n\n[Styled-components](https://www.styled-components.com/) is a relatively new library that will transpile a given string into a CSS string and will encapsulate it under a `React.Component`.\nBringing the same concepts from React into the way we write styles, so we can define our styles programmatically.\nWith JavaScript in-hand you naturally have more control over our styles and its encapsulation, which makes it a very powerful tool.\n\nHere's one way to style a button using styled-components:\n\n```js\nimport styled, { css } from 'styled-components';\n\nconst Button = styled.button`\n  background: transparent;\n  border-radius: 3px;\n  border: 2px solid palevioletred;\n  color: palevioletred;\n  margin: 0.5em 1em;\n  padding: 0.25em 1em;\n\n  ${props => props.primary && css`\n    background: palevioletred;\n    color: white;\n  `}\n`;\n```\n\n* `styled` is coming from the `styled-components` library. When we call `styled.button` that means we are extending a button component from styled.\n* `Button` will become a full React componnet with the extended styled we specified\n* Like a React component, we can send props into our component. And like a React function, we can write Javascript code that interact and respond to those props.\nIn our case, just like a check we've done before in TSX to render something only if it exists, here only if we have a `primary` property, we will add extra styles to our component.\nThe created Button is actually a React.Component, so an instance of it can be created with ease like any other component:\n* `css` is telling Styled components that the string literal that comes after describes CSS styles.\n\n```jsx\n  <Button primary />\n```\n\nBut as this is just like a component, we should type it just like we type component, defining what properties it should get in:\n\n```tsx\nimport styled, { css } from 'styled-components';\n\ninterface ButtonProps {\n  readonly primary: any;\n};\n\nconst Button = styled.button<ButtonProps>`\n  background: transparent;\n  border-radius: 3px;\n  border: 2px solid palevioletred;\n  color: palevioletred;\n  margin: 0.5em 1em;\n  padding: 0.25em 1em;\n\n  ${props => props.primary && css`\n    background: palevioletred;\n    color: white;\n  `}\n`;\n```\n\nMore information about styled-components can be found in the official [docs page](https://www.styled-components.com/docs).\n\nNow, we will use `styled-components` to create new React.Components which are bound into a style-sheet.\nThis way when we create new instances of them, the components will be styled right out of the box. Example:\n\n```jsx\nconst Button = styled.button `\n  border-radius: 999px;\n`\n\nconst RedButton = styled(Button) `\n  color: red;\n`\n\nconst GreenButton = styled(Button) `\n  color: green;\n`\n\nconst BlueButton = styled(Button) `\n  color: blue;\n`\n\nconst Dashboard = (\n  <div>\n    <RedButton />\n    <GreenButton />\n    <BlueButton />\n  </div>\n)\n```\n\nThe clear advantage of such working strategy is that all the styles are encapsulated, unlike traditional CSS where style rules can easily collide and be merged unintentionally.\nRemember that **`styled-components` operates per component, not globally**.\n\nWe will start off by installing `styled-components` and its Typescript types library:\n\n    $ yarn add styled-components @types/styled-components\n\nNow, let's use `styled-components` our `ChatsListScreen`:\n\n[{]: <helper> (diffStep \"2.5\" files=\"index.tsx\" module=\"client\")\n\n#### [__Client__ Step 2.5: Add style with styled-components](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/4afe8f3400e8bbf39a0744ec4da835e3ce1604e6)\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;index.tsx\n```diff\n@@ -1,12 +1,17 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n â”Š 2â”Š 2â”Šimport ChatsNavbar from './ChatsNavbar';\n â”Š 3â”Š 3â”Šimport ChatsList from './ChatsList';\n+â”Š  â”Š 4â”Šimport styled from 'styled-components';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šconst Container = styled.div`\n+â”Š  â”Š 7â”Š  height: 100vh;\n+â”Š  â”Š 8â”Š`;\n â”Š 4â”Š 9â”Š\n â”Š 5â”Š10â”Šconst ChatsListScreen: React.FC = () => (\n-â”Š 6â”Š  â”Š  <div>\n+â”Š  â”Š11â”Š  <Container>\n â”Š 7â”Š12â”Š    <ChatsNavbar />\n â”Š 8â”Š13â”Š    <ChatsList />\n-â”Š 9â”Š  â”Š  </div>\n+â”Š  â”Š14â”Š  </Container>\n â”Š10â”Š15â”Š);\n â”Š11â”Š16â”Š\n â”Š12â”Š17â”Šexport default ChatsListScreen;\n```\n\n[}]: #\n\nHere you can see that we've created a new component called `Container`.\nThat component is extending `div` and adds some styles into it.\nThen we've replaced the `div` element with the new, enhanced `div` called `Container`.\n\nWith this we know for sure that the styles we applied for `Container` won't affect any other component in our app.\n\n[{]: <helper> (diffStep \"2.5\" files=\"ChatsNavbar.tsx\" module=\"client\")\n\n#### [__Client__ Step 2.5: Add style with styled-components](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/4afe8f3400e8bbf39a0744ec4da835e3ce1604e6)\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsNavbar.tsx\n```diff\n@@ -1,6 +1,14 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n â”Š 2â”Š 2â”Šimport { Toolbar } from '@material-ui/core';\n+â”Š  â”Š 3â”Šimport styled from 'styled-components';\n â”Š 3â”Š 4â”Š\n-â”Š 4â”Š  â”Šconst ChatsNavbar: React.FC = () => <Toolbar>Whatsapp Clone</Toolbar>;\n+â”Š  â”Š 5â”Šconst Container = styled(Toolbar)`\n+â”Š  â”Š 6â”Š  background-color: var(--primary-bg);\n+â”Š  â”Š 7â”Š  color: var(--primary-text);\n+â”Š  â”Š 8â”Š  font-size: 20px;\n+â”Š  â”Š 9â”Š  line-height: 40px;\n+â”Š  â”Š10â”Š`;\n+â”Š  â”Š11â”Š\n+â”Š  â”Š12â”Šconst ChatsNavbar: React.FC = () => <Container>Whatsapp Clone</Container>;\n â”Š 5â”Š13â”Š\n â”Š 6â”Š14â”Šexport default ChatsNavbar;\n```\n\n[}]: #\n\nHere you can see we've done the same, but instead of extending a built-in component from styled-component,\nwe enhanced the `Toolbar` component from `material-ui.\n\nNotice that we also called the wrapper `Container` but again it has no affect on any component outside of our specific component.\n\n> Notice that we've added Typescript type inference `as typeof Toolbar` at the end. That's because of an issue that suppose to be fixed when we'll upgrade to material-ui v4.\n\nLet's finish this off by doing the same in our last component:\n\n[{]: <helper> (diffStep \"2.5\" files=\"ChatsList.tsx\" module=\"client\")\n\n#### [__Client__ Step 2.5: Add style with styled-components](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/4afe8f3400e8bbf39a0744ec4da835e3ce1604e6)\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -2,24 +2,81 @@\n â”Š 2â”Š 2â”Šimport { chats } from '../../db';\n â”Š 3â”Š 3â”Šimport moment from 'moment';\n â”Š 4â”Š 4â”Šimport { List, ListItem } from '@material-ui/core';\n+â”Š  â”Š 5â”Šimport styled from 'styled-components';\n â”Š 5â”Š 6â”Š\n-â”Š 6â”Š  â”Šconst ChatsList: React.FC = () => (\n-â”Š 7â”Š  â”Š  <div>\n-â”Š 8â”Š  â”Š    <List>\n+â”Š  â”Š 7â”Šconst Container = styled.div`\n+â”Š  â”Š 8â”Š  height: calc(100% - 56px);\n+â”Š  â”Š 9â”Š  overflow-y: overlay;\n+â”Š  â”Š10â”Š`;\n+â”Š  â”Š11â”Š\n+â”Š  â”Š12â”Šconst StyledList = styled(List)`\n+â”Š  â”Š13â”Š  padding: 0 !important;\n+â”Š  â”Š14â”Š`;\n+â”Š  â”Š15â”Š\n+â”Š  â”Š16â”Šconst StyledListItem = styled(ListItem)`\n+â”Š  â”Š17â”Š  height: 76px;\n+â”Š  â”Š18â”Š  padding: 0 15px;\n+â”Š  â”Š19â”Š  display: flex;\n+â”Š  â”Š20â”Š`;\n+â”Š  â”Š21â”Š\n+â”Š  â”Š22â”Šconst ChatPicture = styled.img`\n+â”Š  â”Š23â”Š  height: 50px;\n+â”Š  â”Š24â”Š  width: 50px;\n+â”Š  â”Š25â”Š  object-fit: cover;\n+â”Š  â”Š26â”Š  border-radius: 50%;\n+â”Š  â”Š27â”Š`;\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Šconst ChatInfo = styled.div`\n+â”Š  â”Š30â”Š  width: calc(100% - 60px);\n+â”Š  â”Š31â”Š  height: 46px;\n+â”Š  â”Š32â”Š  padding: 15px 0;\n+â”Š  â”Š33â”Š  margin-left: 10px;\n+â”Š  â”Š34â”Š  border-bottom: 0.5px solid silver;\n+â”Š  â”Š35â”Š  position: relative;\n+â”Š  â”Š36â”Š`;\n+â”Š  â”Š37â”Š\n+â”Š  â”Š38â”Šconst ChatName = styled.div`\n+â”Š  â”Š39â”Š  margin-top: 5px;\n+â”Š  â”Š40â”Š`;\n+â”Š  â”Š41â”Š\n+â”Š  â”Š42â”Šconst MessageContent = styled.div`\n+â”Š  â”Š43â”Š  color: gray;\n+â”Š  â”Š44â”Š  font-size: 15px;\n+â”Š  â”Š45â”Š  margin-top: 5px;\n+â”Š  â”Š46â”Š  text-overflow: ellipsis;\n+â”Š  â”Š47â”Š  overflow: hidden;\n+â”Š  â”Š48â”Š  white-space: nowrap;\n+â”Š  â”Š49â”Š`;\n+â”Š  â”Š50â”Š\n+â”Š  â”Š51â”Šconst MessageDate = styled.div`\n+â”Š  â”Š52â”Š  position: absolute;\n+â”Š  â”Š53â”Š  color: gray;\n+â”Š  â”Š54â”Š  top: 20px;\n+â”Š  â”Š55â”Š  right: 0;\n+â”Š  â”Š56â”Š  font-size: 13px;\n+â”Š  â”Š57â”Š`;\n+â”Š  â”Š58â”Š\n+â”Š  â”Š59â”Šconst ChatsList = () => (\n+â”Š  â”Š60â”Š  <Container>\n+â”Š  â”Š61â”Š    <StyledList>\n â”Š 9â”Š62â”Š      {chats.map(chat => (\n-â”Š10â”Š  â”Š        <ListItem key={chat.id} button>\n-â”Š11â”Š  â”Š          <img src={chat.picture} alt=\"Profile\" />\n-â”Š12â”Š  â”Š          <div>{chat.name}</div>\n-â”Š13â”Š  â”Š          {chat.lastMessage && (\n-â”Š14â”Š  â”Š            <React.Fragment>\n-â”Š15â”Š  â”Š              <div>{chat.lastMessage.content}</div>\n-â”Š16â”Š  â”Š              <div>{moment(chat.lastMessage.createdAt).format('HH:mm')}</div>\n-â”Š17â”Š  â”Š            </React.Fragment>\n-â”Š18â”Š  â”Š          )}\n-â”Š19â”Š  â”Š        </ListItem>\n+â”Š  â”Š63â”Š        <StyledListItem key={chat.id} button>\n+â”Š  â”Š64â”Š          <ChatPicture src={chat.picture} alt=\"Profile\" />\n+â”Š  â”Š65â”Š          <ChatInfo>\n+â”Š  â”Š66â”Š            <ChatName>{chat.name}</ChatName>\n+â”Š  â”Š67â”Š            {chat.lastMessage && (\n+â”Š  â”Š68â”Š              <React.Fragment>\n+â”Š  â”Š69â”Š                <MessageContent>{chat.lastMessage.content}</MessageContent>\n+â”Š  â”Š70â”Š                <MessageDate>\n+â”Š  â”Š71â”Š                  {moment(chat.lastMessage.createdAt).format('HH:mm')}\n+â”Š  â”Š72â”Š                </MessageDate>\n+â”Š  â”Š73â”Š              </React.Fragment>\n+â”Š  â”Š74â”Š            )}\n+â”Š  â”Š75â”Š          </ChatInfo>\n+â”Š  â”Š76â”Š        </StyledListItem>\n â”Š20â”Š77â”Š      ))}\n-â”Š21â”Š  â”Š    </List>\n-â”Š22â”Š  â”Š  </div>\n+â”Š  â”Š78â”Š    </StyledList>\n+â”Š  â”Š79â”Š  </Container>\n â”Š23â”Š80â”Š);\n â”Š24â”Š81â”Š\n â”Š25â”Š82â”Šexport default ChatsList;\n```\n\n[}]: #\n\nNotice that we've changed the structure of the HTML of the `ChatsList` component.\nWe've added the ChatInfo to allow better alignment of the elements.\n\nWe're done styling `ChatsListScreen`. We will keep using the same principles to style the rest of the components in our application. The final result should look like so:\n\n![screenshot](https://user-images.githubusercontent.com/7648874/54141766-40baa100-4461-11e9-8dd0-59edcfdb3b84.png)\n\n\nTODO: What do people think about https://www.styled-components.com/docs/tooling#babel-plugin, should we use it here?"
          },
          {
            "manualTitle": "Step 3: Setup a basic Node.JS server with a basic REST endpoint",
            "stepRevision": "16ad1efc78026518b08392fbe17166303b0ad754",
            "manualView": "Currently we have a running app with a single screen which looks stylish and presents some data to the user.\n\nThere is something missing though - The data that we are displaying can't be changed in any way.\n\nbut even if we'll change the data, there is still a more fundamental issue - all of the data lives on the client.\n\nThat means that each client has it's own copy of the data and the data is not shared between them,\nif a client will create a new message, only that client will have the new message and not the client that the message was sent to.\n\nAlso if the client will shut down, all data will be lost.\n\nSo how can we have a place to put data that is being shared between all clients?\n\nWe should find a central machine that all clients will connect to and get the data from.\nIf some client wants to create a new message, it will create it on that central machine so that the next time another clients will ask for the available messages,\nall those messages will be available on the central machine.\n\nThat central machine that stores data is called a database. and the machine that communicates between the database and the client is called a server.\n\nIn this step, we will write a NodeJS server (server that runs using the Javascript language) and will expose a REST endpoint that will serve the data-mock.\nWe will build the REST application using [Express](https://www.npmjs.com/package/express).\nFurther in this tutorial, we will migrate to using a real data-base with real I/O from the user, because at this point, if the server will shut down, all data will be lost.\n\nThe plan is to have a server up and running at `localhost:4000` that will expose a `GET /chats` route.\nUnlike our client application, we're not gonna use any boilerplate and we're gonna set everything up manually.\n\nRight outside the client project, we will create a new directory called `whatsapp-clone-server` in which we will start creating our server:\n\n    $ mkdir whatsapp-clone-server\n    $ cd whatsapp-clone-server\n\nThen we will use `Yarn` to initialize a new project:\n\n    $ yarn init -yp\n\nThere's nothing special about this command, it only creates a basic `package.json` file.\nJust to make sure that things work, we will add an `index.js` file which will print `\"hello world\"` to the console.\n\n[{]: <helper> (diffStep \"1.1\" files=\"index.js\" module=\"server\")\n\n#### [__Server__ Step 1.1: Create start script](https://github.com/Urigo/WhatsApp-Clone-Server/commit/d403cd8817a32d36b80ede879382b358a487c632)\n\n##### Added index.js\n```diff\n@@ -0,0 +1 @@\n+â”Š â”Š1â”Šconsole.log('hello world')\n```\n\n[}]: #\n\nAnd we will add a startup script to the `package.json` file called `start`:\n\n    \"scripts\": {\n      \"start\": \"node index.js\"\n    }\n\nNPM-scripts are just a way to defined an alias for commands. Now we only have one simple script,\nbut it can turn out to be something very complex depending on our server, so it can be very useful.\nMore about npm-scripts can be found in the [official NPM docs](https://docs.npmjs.com/misc/scripts).\n\nNow we can run our server by running `$ yarn start` and we should see the message \"hello world\" printed to the console, as expected.\n\nLike in our client's app, we will be using TypeScript.\nIn order to use TypeScript we will install few packages:\n\n    $ yarn add --dev typescript ts-node @types/node\n\n> Note how we used the `--dev` flag. It is a good practice to separate between production dependencies and development dependencies.\nThat way when you deploy your server to the real environment, you won't install the unnecessary development dependencies there.\nMore about the `--dev` option can be read in the [NPM-install docs](https://docs.npmjs.com/cli/install).\n\n- The [`typescript`](https://www.npmjs.com/package/typescript) package is TypeScript's core transpiler.\n- [`ts-node`](https://www.npmjs.com/package/ts-node) is an interpreter that will transpile required `.ts` files into JavaScript at runtime.\n- [`@types/node`](https://www.npmjs.com/package/@types/node) will make the appropriate definitions for a Node.JS environment.\n\n> You can read more about the `@types` monorepo in the [official GitHub repository](https://github.com/DefinitelyTyped/DefinitelyTyped).\n\nWe will rename the `index.js` file to `index.ts`:\n\n    $ mv index.js index.ts\n\nNow we need to compile the `ts` file to turn it into a Javascript file the Node can run.\n\nFor that we will use Typescript and its `tsc` command.\nThe command has many options, but instead of writing them in the command line, we can specify them in a `tsconfig.json` file at the root of the project.\n\nOur server is gonna use the following `tsconfig.json` file, feel free to make the necessary modifications based on your needs:\n\n[{]: <helper> (diffStep \"1.2\" files=\"tsconfig.json\" module=\"server\")\n\n#### [__Server__ Step 1.2: Setup TypeScript](https://github.com/Urigo/WhatsApp-Clone-Server/commit/c5c16f7c4fad7331d0397b405f13df1b5bbbe32e)\n\n##### Added tsconfig.json\n```diff\n@@ -0,0 +1,17 @@\n+â”Š  â”Š 1â”Š{\n+â”Š  â”Š 2â”Š  \"compilerOptions\": {\n+â”Š  â”Š 3â”Š    \"target\": \"es2018\",\n+â”Š  â”Š 4â”Š    \"module\": \"commonjs\",\n+â”Š  â”Š 5â”Š    \"lib\": [\n+â”Š  â”Š 6â”Š      \"es2018\",\n+â”Š  â”Š 7â”Š      \"esnext.asynciterable\"\n+â”Š  â”Š 8â”Š    ],\n+â”Š  â”Š 9â”Š    \"skipLibCheck\": true,\n+â”Š  â”Š10â”Š    \"strict\": true,\n+â”Š  â”Š11â”Š    \"strictFunctionTypes\": false,\n+â”Š  â”Š12â”Š    \"strictPropertyInitialization\": false,\n+â”Š  â”Š13â”Š    \"esModuleInterop\": true,\n+â”Š  â”Š14â”Š    \"experimentalDecorators\": true,\n+â”Š  â”Š15â”Š    \"emitDecoratorMetadata\": true\n+â”Š  â”Š16â”Š  }\n+â”Š  â”Š17â”Š}\n```\n\n[}]: #\n\nWe need to tell Typescript which files to compile. Those are in the `include` key.\n\nNow let's run `tsc` and see what happens.\n\nWe've got a new `index.js` file!  Now let's run it by running `node index.js`.\n\nThat's great, but doing this work each time we change a file can be annoying,\nso let's use tools to track when files change and make them run the code automatically after.\n\nAnd we will update the npm-script `start` to use `ts-node`, since we wanna use TypeScript, and not JavaScript directly:\n\n    \"start\": \"ts-node index.ts\"\n\nWe can test the startup of our server again by running `$ yarn start` and we should see the message \"hello world\" printed to the console.\n\nThe skeleton of the project is set and we can move on to implementing the REST API.\n\nLike we said at the beginning, we will be using Express to setup the API. Express is a wrapper around the native [Node.JS \"http\"](https://nodejs.org/api/http.html) library which is responsible for handling HTTP requests.\nYes, it can also be used directly, but Express is much more comfortable and has an amazing ecosystem built around it.\nLet's install Express and its TypeScript definitions:\n\n    $ yarn add express\n    $ yarn add --dev @types/express\n\nBefore we implement the `GET /chats` route we will implement a `GET /_ping` route. This route will be used to determine whether the server is up and running or not, and how fast the connection is based on the response time.\nFor every request sent to this route, we should expect a response saying \"pong\".\nSome call it \"heartbeat\", because this route is being tested repeatedly by the hosting machine to check if it's alive, just like a heartbeat in a way.\nThis is how the route should look like:\n\n[{]: <helper> (diffStep \"1.3\" files=\"index.ts\" module=\"server\")\n\n#### [__Server__ Step 1.3: Setup a Express with a basic health check route](https://github.com/Urigo/WhatsApp-Clone-Server/commit/a378e7225f4956e0d9ff705f863ecf50451fe4c0)\n\n##### Changed index.ts\n```diff\n@@ -1 +1,13 @@\n-â”Š 1â”Š  â”Šconsole.log('hello world')\n+â”Š  â”Š 1â”Šimport express from 'express'\n+â”Š  â”Š 2â”Š\n+â”Š  â”Š 3â”Šconst app = express()\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šapp.get('/_ping', (req, res) => {\n+â”Š  â”Š 6â”Š  res.send('pong')\n+â”Š  â”Š 7â”Š})\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Šconst port = process.env.PORT || 4000\n+â”Š  â”Š10â”Š\n+â”Š  â”Š11â”Šapp.listen(port, () => {\n+â”Š  â”Š12â”Š  console.log(`Server is listening on port ${port}`)\n+â”Š  â”Š13â”Š})\n```\n\n[}]: #\n\nWe can use the\n\n        $ curl localhost:4000/_ping\n\ncommand to send a request to the server and we should get a \"pong\", assuming that the server available on that URL.\n\n**Code formatting**\n\nJust like we talked in the first chapter, some developers write code in a different style than others and since we want to make it consistent, we're going to use **Prettier**.\n\n    $ yarn add -D prettier\n\nWe're going to define a npm script called `format`, few styling rules and we're also going to ignore *node_modules*:\n\n[{]: <helper> (diffStep \"1.4\" files=\"package.json, .prettierrc.yml, .prettierignore\" module=\"server\")\n\n#### [__Server__ Step 1.4: Use Prettier](https://github.com/Urigo/WhatsApp-Clone-Server/commit/40c625badade840022de64e7f0cf266859476c19)\n\n##### Added .prettierignore\n```diff\n@@ -0,0 +1 @@\n+â”Š â”Š1â”Šnode_modulesðŸš«â†µ\n```\n\n##### Added .prettierrc.yml\n```diff\n@@ -0,0 +1,4 @@\n+â”Š â”Š1â”ŠtrailingComma: 'es5'\n+â”Š â”Š2â”ŠtabWidth: 2\n+â”Š â”Š3â”ŠsingleQuote: true\n+â”Š â”Š4â”Šparser: 'typescript'\n```\n\n##### Changed package.json\n```diff\n@@ -7,11 +7,13 @@\n â”Š 7â”Š 7â”Š  },\n â”Š 8â”Š 8â”Š  \"private\": true,\n â”Š 9â”Š 9â”Š  \"scripts\": {\n-â”Š10â”Š  â”Š    \"start\": \"ts-node index.ts\"\n+â”Š  â”Š10â”Š    \"start\": \"ts-node index.ts\",\n+â”Š  â”Š11â”Š    \"format\": \"prettier \\\"**/*.ts\\\" --write\"\n â”Š11â”Š12â”Š  },\n â”Š12â”Š13â”Š  \"devDependencies\": {\n â”Š13â”Š14â”Š    \"@types/express\": \"4.17.0\",\n â”Š14â”Š15â”Š    \"@types/node\": \"12.7.1\",\n+â”Š  â”Š16â”Š    \"prettier\": \"1.18.2\",\n â”Š15â”Š17â”Š    \"ts-node\": \"8.3.0\",\n â”Š16â”Š18â”Š    \"typescript\": \"3.5.3\"\n â”Š17â”Š19â”Š  },\n```\n\n[}]: #\n\nNow let's run:\n\n    $ yarn format\n\nPrettier should format your code:\n\n[{]: <helper> (diffStep \"1.4\" files=\"index.ts\" module=\"server\")\n\n#### [__Server__ Step 1.4: Use Prettier](https://github.com/Urigo/WhatsApp-Clone-Server/commit/40c625badade840022de64e7f0cf266859476c19)\n\n##### Changed index.ts\n```diff\n@@ -1,13 +1,13 @@\n-â”Š 1â”Š  â”Šimport express from 'express'\n+â”Š  â”Š 1â”Šimport express from 'express';\n â”Š 2â”Š 2â”Š\n-â”Š 3â”Š  â”Šconst app = express()\n+â”Š  â”Š 3â”Šconst app = express();\n â”Š 4â”Š 4â”Š\n â”Š 5â”Š 5â”Šapp.get('/_ping', (req, res) => {\n-â”Š 6â”Š  â”Š  res.send('pong')\n-â”Š 7â”Š  â”Š})\n+â”Š  â”Š 6â”Š  res.send('pong');\n+â”Š  â”Š 7â”Š});\n â”Š 8â”Š 8â”Š\n-â”Š 9â”Š  â”Šconst port = process.env.PORT || 4000\n+â”Š  â”Š 9â”Šconst port = process.env.PORT || 4000;\n â”Š10â”Š10â”Š\n â”Š11â”Š11â”Šapp.listen(port, () => {\n-â”Š12â”Š  â”Š  console.log(`Server is listening on port ${port}`)\n-â”Š13â”Š  â”Š})\n+â”Š  â”Š12â”Š  console.log(`Server is listening on port ${port}`);\n+â”Š  â”Š13â”Š});\n```\n\n[}]: #\n\n> Remember to run `yarn prettier` before you comit your changes!\n\nThe `GET /chats` should be implemented similarly, only the response is different. Instead of returning \"pong\" we will return the data-mock for our chats:\n\n[{]: <helper> (diffStep \"1.5\" files=\"index.ts, db.ts\" module=\"server\")\n\n#### [__Server__ Step 1.5: Create GET /chats route](https://github.com/Urigo/WhatsApp-Clone-Server/commit/4e2a58908f297ccb51734eddc4526db7ddb04a70)\n\n##### Added db.ts\n```diff\n@@ -0,0 +1,51 @@\n+â”Š  â”Š 1â”Šexport const messages = [\n+â”Š  â”Š 2â”Š  {\n+â”Š  â”Š 3â”Š    id: '1',\n+â”Š  â”Š 4â”Š    content: 'You on your way?',\n+â”Š  â”Š 5â”Š    createdAt: new Date(new Date('1-1-2019').getTime() - 60 * 1000 * 1000),\n+â”Š  â”Š 6â”Š  },\n+â”Š  â”Š 7â”Š  {\n+â”Š  â”Š 8â”Š    id: '2',\n+â”Š  â”Š 9â”Š    content: \"Hey, it's me\",\n+â”Š  â”Š10â”Š    createdAt: new Date(new Date('1-1-2019').getTime() - 2 * 60 * 1000 * 1000),\n+â”Š  â”Š11â”Š  },\n+â”Š  â”Š12â”Š  {\n+â”Š  â”Š13â”Š    id: '3',\n+â”Š  â”Š14â”Š    content: 'I should buy a boat',\n+â”Š  â”Š15â”Š    createdAt: new Date(new Date('1-1-2019').getTime() - 24 * 60 * 1000 * 1000),\n+â”Š  â”Š16â”Š  },\n+â”Š  â”Š17â”Š  {\n+â”Š  â”Š18â”Š    id: '4',\n+â”Š  â”Š19â”Š    content: 'This is wicked good ice cream.',\n+â”Š  â”Š20â”Š    createdAt: new Date(\n+â”Š  â”Š21â”Š      new Date('1-1-2019').getTime() - 14 * 24 * 60 * 1000 * 1000\n+â”Š  â”Š22â”Š    ),\n+â”Š  â”Š23â”Š  },\n+â”Š  â”Š24â”Š];\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Šexport const chats = [\n+â”Š  â”Š27â”Š  {\n+â”Š  â”Š28â”Š    id: '1',\n+â”Š  â”Š29â”Š    name: 'Ethan Gonzalez',\n+â”Š  â”Š30â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n+â”Š  â”Š31â”Š    lastMessage: '1',\n+â”Š  â”Š32â”Š  },\n+â”Š  â”Š33â”Š  {\n+â”Š  â”Š34â”Š    id: '2',\n+â”Š  â”Š35â”Š    name: 'Bryan Wallace',\n+â”Š  â”Š36â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n+â”Š  â”Š37â”Š    lastMessage: '2',\n+â”Š  â”Š38â”Š  },\n+â”Š  â”Š39â”Š  {\n+â”Š  â”Š40â”Š    id: '3',\n+â”Š  â”Š41â”Š    name: 'Avery Stewart',\n+â”Š  â”Š42â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n+â”Š  â”Š43â”Š    lastMessage: '3',\n+â”Š  â”Š44â”Š  },\n+â”Š  â”Š45â”Š  {\n+â”Š  â”Š46â”Š    id: '4',\n+â”Š  â”Š47â”Š    name: 'Katie Peterson',\n+â”Š  â”Š48â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n+â”Š  â”Š49â”Š    lastMessage: '4',\n+â”Š  â”Š50â”Š  },\n+â”Š  â”Š51â”Š];\n```\n\n##### Changed index.ts\n```diff\n@@ -1,4 +1,5 @@\n â”Š1â”Š1â”Šimport express from 'express';\n+â”Š â”Š2â”Šimport { chats } from './db';\n â”Š2â”Š3â”Š\n â”Š3â”Š4â”Šconst app = express();\n â”Š4â”Š5â”Š\n```\n```diff\n@@ -6,6 +7,10 @@\n â”Š 6â”Š 7â”Š  res.send('pong');\n â”Š 7â”Š 8â”Š});\n â”Š 8â”Š 9â”Š\n+â”Š  â”Š10â”Šapp.get('/chats', (req, res) => {\n+â”Š  â”Š11â”Š  res.json(chats);\n+â”Š  â”Š12â”Š});\n+â”Š  â”Š13â”Š\n â”Š 9â”Š14â”Šconst port = process.env.PORT || 4000;\n â”Š10â”Š15â”Š\n â”Š11â”Š16â”Šapp.listen(port, () => {\n```\n\n[}]: #\n\nTODO: Mention `_req`\n\nCheck that we can get the chats by running:\n\n        $ curl localhost:4000/chats\n\nUnlike the previous route, we used the `.json()` method this time around to send a response. This will simply stringify the given JSON and set the right headers.\nSimilarly to the client, we've defined the db mock in a dedicated file, as this is easier to maintain and look at.\n\nIt's also recommended to connect a middleware called [`cors`](https://www.npmjs.com/package/cors) which will enable cross-origin requests.\nWithout it we will only be able to make requests in localhost, something which is likely to limit us in the future because we would probably host our server somewhere separate than the client application.\nWithout it it will also be impossible to call the server from our client app.\nLet's install the `cors` library and load it with the Express `middleware()` function:\n\n    $ yarn add cors\n\nand its Typescript types:\n\n\n    $ yarn add --dev @types/cors\n\n[{]: <helper> (diffStep \"1.6\" files=\"index.ts\" module=\"server\")\n\n#### [__Server__ Step 1.6: Use CORS](https://github.com/Urigo/WhatsApp-Clone-Server/commit/c3e831816c00bac03e25f7986c54ba35148c6cc2)\n\n##### Changed index.ts\n```diff\n@@ -1,8 +1,11 @@\n+â”Š  â”Š 1â”Šimport cors from 'cors';\n â”Š 1â”Š 2â”Šimport express from 'express';\n â”Š 2â”Š 3â”Šimport { chats } from './db';\n â”Š 3â”Š 4â”Š\n â”Š 4â”Š 5â”Šconst app = express();\n â”Š 5â”Š 6â”Š\n+â”Š  â”Š 7â”Šapp.use(cors());\n+â”Š  â”Š 8â”Š\n â”Š 6â”Š 9â”Šapp.get('/_ping', (req, res) => {\n â”Š 7â”Š10â”Š  res.send('pong');\n â”Š 8â”Š11â”Š});\n```\n\n[}]: #\n\nThe server is now ready to use!\n\nSo getting back to the client, first we will define our server's URL under the `.env` file:\n\n[{]: <helper> (diffStep \"3.1\" module=\"client\")\n\n#### [__Client__ Step 3.1: Define server URL](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/8c337befeb7f58db236492f5edd7bfb67138b720)\n\n##### Added .env\n```diff\n@@ -0,0 +1 @@\n+â”Š â”Š1â”ŠREACT_APP_SERVER_URL=http://localhost:4000ðŸš«â†µ\n```\n\n[}]: #\n\nThis will make our server's URL available under the `process.env.REACT_APP_SERVER_URL` member expression and it will be replaced with a fixed value at build time, just like macros.\nThe `.env` file is a file which will automatically be loaded to `process.env` by the [`dotenv`](https://www.npmjs.com/package/dotenv) NPM package.\n`react-scripts` then filters environment variables which have a `REACT_APP_` prefix and provides the created JSON to a Webpack plugin called [DefinePlugin](https://webpack.js.org/plugins/define-plugin/), which will result in the macro effect.\n\nNow let's move back into our React app folder.\nWe will now replace the local data-mock usage with a fetch from the server.\nFor that we can use the native [fetch API](https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API),\nhowever, it needs to be used in the right life-cycle hook of the React.Component.\n\nThere are 2 naive approaches for that:\n\n- Calling `fetch()` outside the component, but this way that chats will be fetched even if we're not even intending to create an instance of the component.\n\n```js\nfetch().then(() => /* ... */)\nconst MyComponent = () => {}\n```\n\n- Calling `fetch()` inside the component, but then it will be invoked whenever the component is re-rendered.\n\n```js\nconst MyComponent = () => {\n  fetch().then(() => /* ... */)\n}\n```\n\nThese 2 approaches indeed work, but they both fail to deliver what's necessary on the right time.\nIn addition, there's no way to properly coordinate async function calls with the render method of the component.\n\n**Introducing: React hooks**\n\nWith React hooks we can invoke the desired logic in the right life-cycle stage of the target component.\nThis way we can avoid potential memory leaks or extra calculations.\nTo implement a proper `fetch()`, we will be using 2 React hooks:\n\n- [`React.useState()`](https://reactjs.org/docs/hooks-reference.html#usestate) - which is used to get and set a state of the component - will be used to store the chats fetched from the server.\n\n```js\nconst [value, setValue] = useState(initialValue);\n```\n\n- [`React.useMemo()`](https://reactjs.org/docs/hooks-reference.html#usememo) - which is used to run a computation only once certain conditions were met - will be used to run the `fetch()` function only once the component has mounted.\n\n```js\nconst memoizedValue = useMemo(calcFn, [cond1, cond2, ...conds]);\n```\n\nThe result of that approach will look like this, in the context of our ChatsList component:\n\n[{]: <helper> (diffStep \"3.2\" module=\"client\")\n\n#### [__Client__ Step 3.2: Fetch chats using native fetch API instead of mock DB](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/d6573fadea63f4368f5145edc467730e3f9e2c8b)\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -1,8 +1,8 @@\n â”Š1â”Š1â”Šimport React from 'react';\n-â”Š2â”Š â”Šimport { chats } from '../../db';\n â”Š3â”Š2â”Šimport moment from 'moment';\n â”Š4â”Š3â”Šimport { List, ListItem } from '@material-ui/core';\n â”Š5â”Š4â”Šimport styled from 'styled-components';\n+â”Š â”Š5â”Šimport { useState, useMemo } from 'react';\n â”Š6â”Š6â”Š\n â”Š7â”Š7â”Šconst Container = styled.div`\n â”Š8â”Š8â”Š  height: calc(100% - 56px);\n```\n```diff\n@@ -56,27 +56,37 @@\n â”Š56â”Š56â”Š  font-size: 13px;\n â”Š57â”Š57â”Š`;\n â”Š58â”Š58â”Š\n-â”Š59â”Š  â”Šconst ChatsList = () => (\n-â”Š60â”Š  â”Š  <Container>\n-â”Š61â”Š  â”Š    <StyledList>\n-â”Š62â”Š  â”Š      {chats.map(chat => (\n-â”Š63â”Š  â”Š        <StyledListItem key={chat.id} button>\n-â”Š64â”Š  â”Š          <ChatPicture src={chat.picture} alt=\"Profile\" />\n-â”Š65â”Š  â”Š          <ChatInfo>\n-â”Š66â”Š  â”Š            <ChatName>{chat.name}</ChatName>\n-â”Š67â”Š  â”Š            {chat.lastMessage && (\n-â”Š68â”Š  â”Š              <React.Fragment>\n-â”Š69â”Š  â”Š                <MessageContent>{chat.lastMessage.content}</MessageContent>\n-â”Š70â”Š  â”Š                <MessageDate>\n-â”Š71â”Š  â”Š                  {moment(chat.lastMessage.createdAt).format('HH:mm')}\n-â”Š72â”Š  â”Š                </MessageDate>\n-â”Š73â”Š  â”Š              </React.Fragment>\n-â”Š74â”Š  â”Š            )}\n-â”Š75â”Š  â”Š          </ChatInfo>\n-â”Š76â”Š  â”Š        </StyledListItem>\n-â”Š77â”Š  â”Š      ))}\n-â”Š78â”Š  â”Š    </StyledList>\n-â”Š79â”Š  â”Š  </Container>\n-â”Š80â”Š  â”Š);\n+â”Š  â”Š59â”Šconst ChatsList = () => {\n+â”Š  â”Š60â”Š  const [chats, setChats] = useState<any[]>([]);\n+â”Š  â”Š61â”Š\n+â”Š  â”Š62â”Š  useMemo(async () => {\n+â”Š  â”Š63â”Š    const body = await fetch(`${process.env.REACT_APP_SERVER_URL}/chats`);\n+â”Š  â”Š64â”Š    const chats = await body.json();\n+â”Š  â”Š65â”Š    setChats(chats);\n+â”Š  â”Š66â”Š  }, []);\n+â”Š  â”Š67â”Š\n+â”Š  â”Š68â”Š  return (\n+â”Š  â”Š69â”Š    <Container>\n+â”Š  â”Š70â”Š      <StyledList>\n+â”Š  â”Š71â”Š        {chats.map(chat => (\n+â”Š  â”Š72â”Š          <StyledListItem key={chat!.id} button>\n+â”Š  â”Š73â”Š            <ChatPicture src={chat.picture} alt=\"Profile\" />\n+â”Š  â”Š74â”Š            <ChatInfo>\n+â”Š  â”Š75â”Š              <ChatName>{chat.name}</ChatName>\n+â”Š  â”Š76â”Š              {chat.lastMessage && (\n+â”Š  â”Š77â”Š                <React.Fragment>\n+â”Š  â”Š78â”Š                  <MessageContent>{chat.lastMessage.content}</MessageContent>\n+â”Š  â”Š79â”Š                  <MessageDate>\n+â”Š  â”Š80â”Š                    {moment(chat.lastMessage.createdAt).format('HH:mm')}\n+â”Š  â”Š81â”Š                  </MessageDate>\n+â”Š  â”Š82â”Š                </React.Fragment>\n+â”Š  â”Š83â”Š              )}\n+â”Š  â”Š84â”Š            </ChatInfo>\n+â”Š  â”Š85â”Š          </StyledListItem>\n+â”Š  â”Š86â”Š        ))}\n+â”Š  â”Š87â”Š      </StyledList>\n+â”Š  â”Š88â”Š    </Container>\n+â”Š  â”Š89â”Š  );\n+â”Š  â”Š90â”Š};\n â”Š81â”Š91â”Š\n â”Š82â”Š92â”Šexport default ChatsList;\n```\n\n##### Deleted src&#x2F;db.ts\n```diff\n@@ -1,49 +0,0 @@\n-â”Š 1â”Š  â”Šexport const messages = [\n-â”Š 2â”Š  â”Š  {\n-â”Š 3â”Š  â”Š    id: '1',\n-â”Š 4â”Š  â”Š    content: 'You on your way?',\n-â”Š 5â”Š  â”Š    createdAt: new Date(Date.now() - 60 * 1000 * 1000),\n-â”Š 6â”Š  â”Š  },\n-â”Š 7â”Š  â”Š  {\n-â”Š 8â”Š  â”Š    id: '2',\n-â”Š 9â”Š  â”Š    content: \"Hey, it's me\",\n-â”Š10â”Š  â”Š    createdAt: new Date(Date.now() - 2 * 60 * 1000 * 1000),\n-â”Š11â”Š  â”Š  },\n-â”Š12â”Š  â”Š  {\n-â”Š13â”Š  â”Š    id: '3',\n-â”Š14â”Š  â”Š    content: 'I should buy a boat',\n-â”Š15â”Š  â”Š    createdAt: new Date(Date.now() - 24 * 60 * 1000 * 1000),\n-â”Š16â”Š  â”Š  },\n-â”Š17â”Š  â”Š  {\n-â”Š18â”Š  â”Š    id: '4',\n-â”Š19â”Š  â”Š    content: 'This is wicked good ice cream.',\n-â”Š20â”Š  â”Š    createdAt: new Date(Date.now() - 14 * 24 * 60 * 1000 * 1000),\n-â”Š21â”Š  â”Š  },\n-â”Š22â”Š  â”Š];\n-â”Š23â”Š  â”Š\n-â”Š24â”Š  â”Šexport const chats = [\n-â”Š25â”Š  â”Š  {\n-â”Š26â”Š  â”Š    id: '1',\n-â”Š27â”Š  â”Š    name: 'Ethan Gonzalez',\n-â”Š28â”Š  â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n-â”Š29â”Š  â”Š    lastMessage: messages.find(m => m.id === '1'),\n-â”Š30â”Š  â”Š  },\n-â”Š31â”Š  â”Š  {\n-â”Š32â”Š  â”Š    id: '2',\n-â”Š33â”Š  â”Š    name: 'Bryan Wallace',\n-â”Š34â”Š  â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n-â”Š35â”Š  â”Š    lastMessage: messages.find(m => m.id === '2'),\n-â”Š36â”Š  â”Š  },\n-â”Š37â”Š  â”Š  {\n-â”Š38â”Š  â”Š    id: '3',\n-â”Š39â”Š  â”Š    name: 'Avery Stewart',\n-â”Š40â”Š  â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n-â”Š41â”Š  â”Š    lastMessage: messages.find(m => m.id === '3'),\n-â”Š42â”Š  â”Š  },\n-â”Š43â”Š  â”Š  {\n-â”Š44â”Š  â”Š    id: '4',\n-â”Š45â”Š  â”Š    name: 'Katie Peterson',\n-â”Š46â”Š  â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n-â”Š47â”Š  â”Š    lastMessage: messages.find(m => m.id === '4'),\n-â”Š48â”Š  â”Š  },\n-â”Š49â”Š  â”Š];\n```\n\n[}]: #\n\n> It's recommended to read about React hooks and their basic concept at the [official React docs page](https://reactjs.org/docs/hooks-overview.html).\n\nAt this point we can get rid of `db.ts` file in the client, since we don't use it anymore:\n\n    $ rm src/db.ts\n\nThat's it. Our ChatsListScreen is now connected to a working back-end.\nIn the next step we will upgrade our REST API into a GraphQL API and we will create a basis for a more robust back-end.\n\n-------------\nTODO:\n\nFirst, `tsc` has a `--watch` option so that if the Typescript files changed it will compile them again and spit new Javascript files.\n\nThen we need to rerun the Node server everytime the output Javascript files has changed.\n[nodemon](https://github.com/remy/nodemon) is a tool that tracks file and if the files changed it will re-run our node server.\n\nLet's create a new npm script called \"watch\" and make it run both tools:\n\nTODO: New diff\n\nTODO: https://stackoverflow.com/a/39172660/1426570\n\nTODO: Better watch, also watch and copy schema files (maybe in a later chapter)?\n\nTODO: concurrently - because it works on all environments\n\nTODO: Explain what -r register command does in Node and in Jest\n\nTODO: Talk about the difference between graphql-import and graphql-import-node\n\nTODO: Show debugging\n\n\nIt's a bit annoying that we get the compiled file right next to our Typescript file, so let's move it into a separate folder:\n\nTODO: New diff for the `lib` folder update\n\nTODO: why `useMemo(fn, [true])` instead of `useEffect(fn, [])` ?\n\nTODO: Move to hooks in a separate commit and later change to call the server"
          },
          {
            "manualTitle": "Step 4: Transition to GraphQL",
            "stepRevision": "f19f693c934b29b27418441df1637ed184ccecc7",
            "manualView": "**What is GraphQL?**\n\n[GraphQL](https://graphql.org/) is a query language invented by Facebook, and it's used to query data within from a schema.\nIn our case, we will create a schema for the data that our server exposes through its API.\nIt allows clients to define the structure of the data required, and the exact same structure of data will be returned from the server,\ntherefore preventing excessively large amounts of data from being returned.\nUnlike REST, GraphQL APIs are organized in terms of types and fields, not endpoints.\n\nEven if we use GraphQL without a server, it can save us a lot of code and work becuase it can transform data in a very easy way from a schema to a query.\n\nCurrently in our app, if we'd like to get its chats we would send a GET request to `/chats`.\nWith GraphQL it would be done differently with a string that describes the data that we would like to get:\n\n```graphql\nchats {\n  id\n  name\n  picture\n  lastMessage {\n    id\n    content\n    createdAt\n  }\n}\n```\n\n> Above: An illustration of a potential GraphQL query sent to our Whatsapp API\n\n**Why GraphQL and not REST?**\n\nREST has been used for many more years and has proven itself to work well, and it's completely agnostic to the implementation of the back-end.\nHowever, when it comes to data projection and aggregation, it fails to deliver.\n\nWhen using REST, often times you'll find yourself performing multiple requests to execute a single query of data.\nNot only that, you might even end up with additional data that is not necessary.\nEither way, the process would result in slower and heavier response.\n\nWith GraphQL we donâ€™t have that kind of problem. The API is based on a schema built from many entities that we call object types.\nThink of GraphQL as something similar to TypeScript but for API.\nObject types are like interfaces, they describe the shape of an entity.\n\nIn TypeScript you would describe a Chat as:\n\n```\ninterface Chat {\n  id: string;\n  name: string;\n  picture: string;\n  lastMessage: Message;\n}\n\ninterface Message {\n  id: string;\n  content: string;\n  createdAt: number;\n}\n```\n\nGraphQL:\n\n```\ntype Chat {\n  id: String\n  name: String\n  picture: String\n  lastMessage: Message\n}\n\ntype Message {\n  id: String\n  content: String\n  createdAt: Float\n}\n```\n\nLooks pretty similar?\n\nSo this is the definition of the available data, now let's see how we can pick and structure data from it using a query:\n\n```graphql\n# request\nchats {\n  id\n  name\n  picture\n  lastMessage {\n    id\n    content\n    createdAt\n  }\n}\n```\n\nWe think itâ€™s pretty straightforward to understand what do you fetch by just looking at the query above.\n\n![graphql-request](https://user-images.githubusercontent.com/7648874/54133620-5aec8300-4451-11e9-9bda-a459dc48f57c.png)\n\nIf you would execute that query the result might look like this:\n\n```js\n// response\n{\n  chats: [{\n    id: â€œ1â€,\n    name: â€œEthan Gonzalezâ€,\n    picture: â€œhttps://randomuser.me/api/portraits/thumb/men/1.jpgâ€,\n    lastMessage: {\n      id: â€œ1â€,\n      content: \"You on your way?\",\n      createdAt: 1234567890\n  }]\n}\n```\n\nYou'll get exactly what you asked for with a single request. GraphQL provides a dynamic API while REST doesn't.\n\n**GraphQL schema, in a nutshell**\n\nLike said earlier,  GraphQL APIs are organized in terms of types and fields.\nThat means that our app data should be described with a schema, where each field's gonna have a resolver - the handler that will return the corresponding data.\nThings will be much clearer as we move further.\n\nLet's try to describe our app's data with a GraphQL schema and then dive into it:\n\n```graphql\nscalar Date\n\ntype Message {\n  id: ID!\n  content: String!\n  createdAt: Date!\n}\n\ntype Chat {\n  id: ID!\n  name: String!\n  picture: String\n  lastMessage: Message\n}\n\ntype Query {\n  chats: [Chat!]!\n}\n```\n\nThe schema is self explanatory in terms of what data it's compatible with. Supported built-in scalar types in GraphQL are:\n\n- Int: Signed 32â€bit integer\n- Float: Signed double-precision floating-point value\n- String: UTFâ€8 character sequence\n- Boolean: true or false\n- ID (serialized as String): A unique identifier, often used to refetch an object or as the key for a cache.\nWhile serialized as a String, ID signifies that it is not intended to be humanâ€readable\n\nAny custom scalar can be declared with the `scalar` keyword, and custom types can be declared with the `type` keyword.\nHowever, you should know that some types are reserved by GraphQL itself; `Query` is one of them.\nThe `Query` type will be used as the root for received queries by the clients, which means that we can send queries which start with the `chats` field.\nOther reserved types are:\n\n- `type Query` - reserved for [GraphQL queries](https://graphql.org/learn/queries/#mutations).\n- `type Mutation` - reserved for [GraphQL mutations.](https://graphql.github.io/learn/queries/)\n- `type Subscription` - reserved for [GraphQL subscriptions.](https://www.apollographql.com/docs/react/advanced/subscriptions.html)\n\n> As we're not gonna go through the entire GraphQL API, it's recommended to go through the [official learn section of the GraphQL website](https://graphql.org/learn/), but the information so far will definitely help you kick-start, plus the upcoming implementation.\n\n**Getting started**\n\nWe will be implementing a GraphQL mechanism for the client and for the server.\nWe will start with the server as things will make more sense, and we will be able to test it before we proceed into the client.\nEssentially GraphQL is connected into a HTTP endpoint, usually under `POST /graphql`, and so this is exactly what we're gonna do, connect the endpoint handler.\nLuckily, we don't have to implement that. A team called [Apollo](https://www.apollographql.com/) already did it for us, so we can use their implementation.\nWe will install the required packages:\n\n    $ yarn add apollo-server-express graphql\n    $ yarn add --dev @types/graphql\n\n- [`graphql`](https://www.npmjs.com/package/graphql) - The core package of GraphQL that includes the resolvers for basic data-types.\n- [`apollo-server-express`](https://www.npmjs.com/package/apollo-server-express) - Apollo's implementation for the GraphQL Express REST endpoint.\n- `@types/graphql` - TypeScript definitions. Notice that we didn't need to install Apollo's types library. That is because Apollo themselves writes their source code in Typescript so\nwe get a ready Typescript code directly from their library.\n\nWe can now connect Apollo's middleware under the `/graphql` route:\n\n[{]: <helper> (diffStep \"2.1\" files=\"index.ts\" module=\"server\")\n\n#### [__Server__ Step 2.1: Setup Apollo GraphQL](https://github.com/Urigo/WhatsApp-Clone-Server/commit/518294229532482433b1020e2875f41323ef753b)\n\n##### Changed index.ts\n```diff\n@@ -1,10 +1,13 @@\n+â”Š  â”Š 1â”Šimport { ApolloServer, gql } from 'apollo-server-express';\n â”Š 1â”Š 2â”Šimport cors from 'cors';\n â”Š 2â”Š 3â”Šimport express from 'express';\n â”Š 3â”Š 4â”Šimport { chats } from './db';\n+â”Š  â”Š 5â”Šimport schema from './schema';\n â”Š 4â”Š 6â”Š\n â”Š 5â”Š 7â”Šconst app = express();\n â”Š 6â”Š 8â”Š\n â”Š 7â”Š 9â”Šapp.use(cors());\n+â”Š  â”Š10â”Šapp.use(express.json());\n â”Š 8â”Š11â”Š\n â”Š 9â”Š12â”Šapp.get('/_ping', (req, res) => {\n â”Š10â”Š13â”Š  res.send('pong');\n```\n```diff\n@@ -14,6 +17,13 @@\n â”Š14â”Š17â”Š  res.json(chats);\n â”Š15â”Š18â”Š});\n â”Š16â”Š19â”Š\n+â”Š  â”Š20â”Šconst server = new ApolloServer({ schema });\n+â”Š  â”Š21â”Š\n+â”Š  â”Š22â”Šserver.applyMiddleware({\n+â”Š  â”Š23â”Š  app,\n+â”Š  â”Š24â”Š  path: '/graphql',\n+â”Š  â”Š25â”Š});\n+â”Š  â”Š26â”Š\n â”Š17â”Š27â”Šconst port = process.env.PORT || 4000;\n â”Š18â”Š28â”Š\n â”Š19â”Š29â”Šapp.listen(port, () => {\n```\n\n[}]: #\n\nAs you can see, the middleware requires a schema. A schema is composed mainly out of 2 fields:\n\n- `typeDefs` (type definitions) - the schema types we wrote earlier this chapter for chats.\n- `resolvers` - The handlers that will provide the data for each field in `typeDefs`.\n\nWe will start first by defining the types.\nAll we have to do is to copy-paste the contents of the schema that was shown earlier into a new file called `typeDefs.graphql`:\n\nNote that some of the fields have exclamation mark at the end and it means that the field is non-nullable,\nmeaning that the GraphQL service promises to always give you a value when you query this field.\n\nChats Query is even more interesting case with two exclamation marks `[Chat!]!`.\n\nThe outer exclamation mark means that if you run this query it will always return an array of zero or more items (never null)\nand inner exclamation mark means that every item of returned array will be of type `Chat` and never be null.\n\n[{]: <helper> (diffStep \"2.2\" files=\"schema/typeDefs.graphql\" module=\"server\")\n\n#### [__Server__ Step 2.2: Create a basic GraphQL schema](https://github.com/Urigo/WhatsApp-Clone-Server/commit/d50c0ab351325b171874e2082374e6f32c3397f0)\n\n##### Added schema&#x2F;typeDefs.graphql\n```diff\n@@ -0,0 +1,18 @@\n+â”Š  â”Š 1â”Šscalar Date\n+â”Š  â”Š 2â”Š\n+â”Š  â”Š 3â”Štype Message {\n+â”Š  â”Š 4â”Š  id: ID!\n+â”Š  â”Š 5â”Š  content: String!\n+â”Š  â”Š 6â”Š  createdAt: Date!\n+â”Š  â”Š 7â”Š}\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Štype Chat {\n+â”Š  â”Š10â”Š  id: ID!\n+â”Š  â”Š11â”Š  name: String!\n+â”Š  â”Š12â”Š  picture: String\n+â”Š  â”Š13â”Š  lastMessage: Message\n+â”Š  â”Š14â”Š}\n+â”Š  â”Š15â”Š\n+â”Š  â”Š16â”Štype Query {\n+â”Š  â”Š17â”Š  chats: [Chat!]!\n+â”Š  â”Š18â”Š}\n```\n\n[}]: #\n\nThe `.graphql` file extension is just a more convenient way to work with a GraphQL schema. The exported result should be a simple string that we can use to compose our GraphQL schema. The clear advantage of working with a dedicated file is that we get to have syntax highlight.\n\nNow we will implement the resolvers. Resolvers are presented in a JSON object where each resolver name should match the field name it represents. You can read more about resolvers in [Apollo's official docs for resolvers](https://www.apollographql.com/docs/tutorial/resolvers.html). This is how our resolvers should look like:\n\n[{]: <helper> (diffStep \"2.2\" files=\"schema/resolvers.ts\" module=\"server\")\n\n#### [__Server__ Step 2.2: Create a basic GraphQL schema](https://github.com/Urigo/WhatsApp-Clone-Server/commit/d50c0ab351325b171874e2082374e6f32c3397f0)\n\n##### Added schema&#x2F;resolvers.ts\n```diff\n@@ -0,0 +1,14 @@\n+â”Š  â”Š 1â”Šimport { GraphQLDateTime } from 'graphql-iso-date';\n+â”Š  â”Š 2â”Šimport { chats } from '../db';\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šconst resolvers = {\n+â”Š  â”Š 5â”Š  Date: GraphQLDateTime,\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Š  Query: {\n+â”Š  â”Š 8â”Š    chats() {\n+â”Š  â”Š 9â”Š      return chats;\n+â”Š  â”Š10â”Š    },\n+â”Š  â”Š11â”Š  },\n+â”Š  â”Š12â”Š};\n+â”Š  â”Š13â”Š\n+â”Š  â”Š14â”Šexport default resolvers;\n```\n\n[}]: #\n\nFor now it's extremely simple, we map the chats query directly into the database collection. Each field in the resolvers object should match the GraphQL type it represents in the schema. Since we don't have any logic now, we should not implement any resolvers for the rest of the types, the data will simply be forwarded as is.\n\nNote that we've implemented a custom scalar named `Date` and we resolved it with an NPM package. Let's install it:\n\n    $ yarn add graphql-iso-date\n    $ yarn add --dev @types/graphql-iso-date\n\nFinal thing that we have to do would be combining the resolvers and the type-defs under a single GraphQL schema.\n\n[{]: <helper> (diffStep \"2.2\" files=\"index.ts\" module=\"server\")\n\n#### [__Server__ Step 2.2: Create a basic GraphQL schema](https://github.com/Urigo/WhatsApp-Clone-Server/commit/d50c0ab351325b171874e2082374e6f32c3397f0)\n\n##### Added schema&#x2F;index.ts\n```diff\n@@ -0,0 +1,7 @@\n+â”Š â”Š1â”Šimport { importSchema } from 'graphql-import';\n+â”Š â”Š2â”Šimport { makeExecutableSchema } from 'graphql-tools';\n+â”Š â”Š3â”Šimport resolvers from './resolvers';\n+â”Š â”Š4â”Š\n+â”Š â”Š5â”Šconst typeDefs = importSchema('schema/typeDefs.graphql');\n+â”Š â”Š6â”Š\n+â”Š â”Š7â”Šexport default makeExecutableSchema({ resolvers, typeDefs });\n```\n\n[}]: #\n\n[`graphql-tools`](https://www.npmjs.com/package/graphql-tools) is a library with a set of utilities that will help us create a schema that will be compatible with Apollo's API:\n\n    $ yarn add graphql-tools graphql-import\n\nThere's one optimization however that we should make in the our DB. Right now, the each chat document has a direct reference to a message via the `lastMessage` field. Practically speaking, this is NOT how the data sits in the DB. The `lastMessage` should only hold the ID for the correlated message, and then in the Node.JS app we should **resolve** it according to our needs. Let's make the appropriate changes in the DB then:\n\n[{]: <helper> (diffStep \"2.3\" files=\"db.ts\" module=\"server\")\n\n#### [__Server__ Step 2.3: Resolve Chat.lastMessage](https://github.com/Urigo/WhatsApp-Clone-Server/commit/5a32bb8fc315119aa8c4729d35633f6b93669e1d)\n\n\n\n[}]: #\n\nAnd a resolver to the `lastMessage` field:\n\n[{]: <helper> (diffStep \"2.3\" files=\"schema/resolvers.ts\" module=\"server\")\n\n#### [__Server__ Step 2.3: Resolve Chat.lastMessage](https://github.com/Urigo/WhatsApp-Clone-Server/commit/5a32bb8fc315119aa8c4729d35633f6b93669e1d)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,9 +1,15 @@\n â”Š 1â”Š 1â”Šimport { GraphQLDateTime } from 'graphql-iso-date';\n-â”Š 2â”Š  â”Šimport { chats } from '../db';\n+â”Š  â”Š 2â”Šimport { chats, messages } from '../db';\n â”Š 3â”Š 3â”Š\n â”Š 4â”Š 4â”Šconst resolvers = {\n â”Š 5â”Š 5â”Š  Date: GraphQLDateTime,\n â”Š 6â”Š 6â”Š\n+â”Š  â”Š 7â”Š  Chat: {\n+â”Š  â”Š 8â”Š    lastMessage(chat: any) {\n+â”Š  â”Š 9â”Š      return messages.find(m => m.id === chat.lastMessage);\n+â”Š  â”Š10â”Š    },\n+â”Š  â”Š11â”Š  },\n+â”Š  â”Š12â”Š\n â”Š 7â”Š13â”Š  Query: {\n â”Š 8â”Š14â”Š    chats() {\n â”Š 9â”Š15â”Š      return chats;\n```\n\n[}]: #\n\nThe first argument of the resolver is the raw chat data received by the DB, and the returned result should be the mapped value which we would like to return to the client.\n\nAs we get further in this tutorial we should get a better grasp regards resolvers and their API, since we will have to deal with more logic and complexity within our Node.JS app.\n\nAssuming that the server is running, we can already test our GraphQL endpoint. Because it's exposed to us via a REST endpoint, we can use a `$ curl` command to send a request to `GET localhost:4000/graphql` and get a response with all the data. Again, the query that we're gonna use to fetch the chats is:\n\n```graphql\nchats {\n  id\n  name\n  picture\n  lastMessage {\n    id\n    content\n    createdAt\n  }\n}\n```\n\nThe one-liner version of it with a `$ curl` command looks like so:\n\n    curl \\\n      -X POST \\\n      -H \"Content-Type: application/json\" \\\n      --data '{ \"query\": \"{ chats { id name picture lastMessage { id content createdAt } } }\" }' \\\n      localhost:4000/graphql\n\nAs a response we should get the data-mock for our chats stored in the server. Since we have that in place, we can go ahead and delete our implementation for the `GET /chats` route.\n\nAnother way to test and inspect our GraphQL schema would be by using an IDE for the browser called [GraphQL Playground](https://github.com/prisma/graphql-playground).\nApollo-Server ships with it right out of the box and can be used right away by navigating to the `http://localhost:4000/graphql` URL from the browser.\n\n[![](https://i.imgur.com/AE5W6OW.png)](https://graphqlbin.com/v2/6RQ6TM)\n\nSo getting back to the client, all we have to do is to change the fetching URL in the ChatsList component to use our newly implemented GraphQL REST endpoint:\n\n[{]: <helper> (diffStep \"4.1\" module=\"client\")\n\n#### [__Client__ Step 4.1: Replace REST call with GraphQL call](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/a72881aeac713874845e8cd64ce44981279f5f32)\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -56,12 +56,35 @@\n â”Š56â”Š56â”Š  font-size: 13px;\n â”Š57â”Š57â”Š`;\n â”Š58â”Š58â”Š\n+â”Š  â”Š59â”Šconst getChatsQuery = `\n+â”Š  â”Š60â”Š  query GetChats {\n+â”Š  â”Š61â”Š    chats {\n+â”Š  â”Š62â”Š      id\n+â”Š  â”Š63â”Š      name\n+â”Š  â”Š64â”Š      picture\n+â”Š  â”Š65â”Š      lastMessage {\n+â”Š  â”Š66â”Š        id\n+â”Š  â”Š67â”Š        content\n+â”Š  â”Š68â”Š        createdAt\n+â”Š  â”Š69â”Š      }\n+â”Š  â”Š70â”Š    }\n+â”Š  â”Š71â”Š  }\n+â”Š  â”Š72â”Š`;\n+â”Š  â”Š73â”Š\n â”Š59â”Š74â”Šconst ChatsList = () => {\n â”Š60â”Š75â”Š  const [chats, setChats] = useState<any[]>([]);\n â”Š61â”Š76â”Š\n â”Š62â”Š77â”Š  useMemo(async () => {\n-â”Š63â”Š  â”Š    const body = await fetch(`${process.env.REACT_APP_SERVER_URL}/chats`);\n-â”Š64â”Š  â”Š    const chats = await body.json();\n+â”Š  â”Š78â”Š    const body = await fetch(`${process.env.REACT_APP_SERVER_URL}/graphql`, {\n+â”Š  â”Š79â”Š      method: 'POST',\n+â”Š  â”Š80â”Š      headers: {\n+â”Š  â”Š81â”Š        'Content-Type': 'application/json',\n+â”Š  â”Š82â”Š      },\n+â”Š  â”Š83â”Š      body: JSON.stringify({ query: getChatsQuery }),\n+â”Š  â”Š84â”Š    });\n+â”Š  â”Š85â”Š    const {\n+â”Š  â”Š86â”Š      data: { chats },\n+â”Š  â”Š87â”Š    } = await body.json();\n â”Š65â”Š88â”Š    setChats(chats);\n â”Š66â”Š89â”Š  }, []);\n```\n\n[}]: #\n\nThe received data should be similar to the previous one.\nNo further changes are required.\n\nIn the next chapter, we will continue working on the UI of our front-end application and we will add a new screen to the flow - the `ChatRoomScreen`.\n\n-------\nTODO: Start with calling the  `graphql` function just on the server to show how it works.\nTODO: Example middlewares in Node\nTODO: Mention the vs code extension\n\nTODO: Introduce the scalar type later on\n\nTODO: Start without Apollo and add it later, in the same file.\nTODO: remove `gql` import becuase it's unused\nTODO: Add visualizations of how GraphQL works\nTODO: import { loadSchema } from 'graphql-toolkit'; and install it\n\nTODO: What DB change is that?\nTODO: Type `lastMessage(chat: any) {`\nTOOD: Change `m` to `currentIteratedMessage`\n\nTODO: Why adding headers? and go through the code\n\nTODO: Talk about working with document node and not with makeExacutableSchema\n```\n×–×” ×œ× ×ž×©× ×” ×‘×ª×›×œ×¡, ×›×™ ApolloServer ×‘×›×œ ×ž×§×¨×” ×™×¢×©×” ×œ×–×” ×§×™×ž×¤×•×œ\n×”× ×§×•×“×” ×”×™× ×©×œ× ×¦×¨×™×š ×œ×§×ž×¤×œ ×¤×¢×ž×™×™× ×œGraphQLSchema\n×¤×©×•×˜ ×¢×“×™×£ ×©××ª ×”×§×™×ž×¤×•×œ ×™×¢×©×” ×”×¨×›×™×‘ ×”××—×¨×•×Ÿ ×©×”×•×œ×š ×œ×”×©×ª×ž×© ×‘typeDefs\n\nDocumentNode => DocumentNode (cheap, easy, no checks)\nDocumentNode => GraphQLSchema (compile AST, does all checking, might throw exceptions, expensive)\nGraphQLSchema => DocumentNode (printed version, might lost AST features such as directives)\n```"
          },
          {
            "manualTitle": "Step 5: Testing",
            "stepRevision": "d7a615119e785eb4124b95058c60e8411fc2ddfa",
            "manualView": "Testing is a crucial part when writing an application, especially if we're planning to publish it or make it a commercial thing. Before we hand someone a product, of any kind, we wanna make sure that it passes certain quality checks. We're signed on that product and so it's very important to ensure that it functions properly according our expectations, otherwise wouldn't wanna use it and will look for alternatives.\n\nIn the context of software, we constantly make changes. It's also inevitable to make all features completely independent from one another, so something in the app is likely to break as we upgrade it or maintain it. That's why we need to write a set of tests that can be run on demand, so when we implement a new feature we can simply run the tests and see what feature broke due to most recent changes.\n\nThere are currently 3 main testing frameworks in the NPM ecosystem: [Jasmine](https://jasmine.github.io/), [Mocha](https://mochajs.org/), and [Jest](https://jestjs.io/). Each testing framework has its pros, and cons, and at the end of the day it's a matter of preference. In our application we're gonna use [Jest](https://jestjs.io/) - a testing framework which was developed by Facebook. What's good about Jest is that it can be used to test both client and server logic, because it runs as a Node.JS application, but it also emulates the browser environment whenever we run it, thanks to [JSDOM](https://github.com/jsdom/jsdom).\n\n![jest](https://user-images.githubusercontent.com/7648874/54493900-e2ce0380-490f-11e9-8075-be4a236c7c38.png)\n\nIn this chapter we will learn how to test the React.Components in the client, and Apollo-GraphQL resolvers in the server. There are 3 kinds of tests:\n\n- Unit tests - which are used to test a single component, independently from other components in our system.\n- Integration tests - which are used to test a component in relation to other components in our systems (how well do they co-work with each other).\n- e2e tests (end to end) - which are used to test a complete, from the moment I clicked on a button in the user interface until the data gets back from the server and shown on the screen.\n\nThe efficiency of the tests go from bottom to top (unit -> e2e), but the maintenance and complexity go from bottom to top (e2e -> unit). Accordingly we will need to find a good balance where we donâ€™t spend too much time on writing tests yet have a good indicator for how well our system functions. So we should write a lot of unit tests, a good amount of integration tests and a handful of e2e tests.\n\n![tests-types-table](https://user-images.githubusercontent.com/7648874/54494121-fed2a480-4911-11e9-9370-694ec989729b.png)\n\nWe will start with the client as itâ€™s much easier, because Jest is set and ready to use right out of the box thanks to `create-react-app`.\n\n**Client - Testing React.Components**\n\nThanks to `create-react-app`, we have Jest set and ready to use right out of the box, so we can start writing tests right away. I you'll look at the `src` you'll see a file called `App.test.tsx`, which simply ensures that the component can be rendered without crashing.\n\n```jsx\nimport React from 'react';\nimport ReactDOM from 'react-dom';\nimport App from './App';\n\nit('renders without crashing', () => {\n  const div = document.createElement('div');\n  ReactDOM.render(<App />, div);\n  ReactDOM.unmountComponentAtNode(div);\n});\n```\n\nThis is not a typical test that you're likely to find in a React project, but it demonstrates very well how Jest can be used to test DOM related issues. If you'll run `$ npm run test` (or `$ yarn test`) in the command line and then press `a`, you should see the following output:\n\n![report](https://user-images.githubusercontent.com/7648874/54341429-eabe4700-4674-11e9-8e76-3aaaf7fec79a.png)\n\nJest will automatically run for every file that ends with a `.test.xxx` extension. This is very convenient because the tests can live right next to the component, and you don't need to lookup for it across the project. This behavior can be modified by configuring Jest in the `package.json` file under the `\"jest\"` field. More information about configuring Jest can be found in the official[ configuration documentation](https://jestjs.io/docs/en/configuration).\n\n> If you get a warning message regards wrapping the component with `act()` - this is a known issue with hooks and should have a proper solution soon. More about this issue and progress regards its fix can be found in this [GitHub thread](https://github.com/facebook/react/issues/14769#issuecomment-470097212).\n\nNow we're gonna write a basic test for the `<ChatsList />` component. In the test, we'll mock a fake response from the server, and examine the contents of rendered HTML. Since the HTML of the component is a dynamic thing and is constantly subject to changes, it would be a good idea to annotate it with `data-testid` attributes so it can be tested regardless of its structure:\n\n[{]: <helper> (diffStep \"5.1\" files=\"ChatsList.tsx\" module=\"client\")\n\n#### [__Client__ Step 5.1: Add data-testid attributes](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/a7289789bb8fc4e88f7ce5898309f1e0bbfb0bf3)\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -92,14 +92,20 @@\n â”Š 92â”Š 92â”Š    <Container>\n â”Š 93â”Š 93â”Š      <StyledList>\n â”Š 94â”Š 94â”Š        {chats.map(chat => (\n-â”Š 95â”Š   â”Š          <StyledListItem key={chat!.id} button>\n-â”Š 96â”Š   â”Š            <ChatPicture src={chat.picture} alt=\"Profile\" />\n+â”Š   â”Š 95â”Š          <StyledListItem key={chat.id} button>\n+â”Š   â”Š 96â”Š            <ChatPicture\n+â”Š   â”Š 97â”Š              data-testid=\"picture\"\n+â”Š   â”Š 98â”Š              src={chat.picture}\n+â”Š   â”Š 99â”Š              alt=\"Profile\"\n+â”Š   â”Š100â”Š            />\n â”Š 97â”Š101â”Š            <ChatInfo>\n-â”Š 98â”Š   â”Š              <ChatName>{chat.name}</ChatName>\n+â”Š   â”Š102â”Š              <ChatName data-testid=\"name\">{chat.name}</ChatName>\n â”Š 99â”Š103â”Š              {chat.lastMessage && (\n â”Š100â”Š104â”Š                <React.Fragment>\n-â”Š101â”Š   â”Š                  <MessageContent>{chat.lastMessage.content}</MessageContent>\n-â”Š102â”Š   â”Š                  <MessageDate>\n+â”Š   â”Š105â”Š                  <MessageContent data-testid=\"content\">\n+â”Š   â”Š106â”Š                    {chat.lastMessage.content}\n+â”Š   â”Š107â”Š                  </MessageContent>\n+â”Š   â”Š108â”Š                  <MessageDate data-testid=\"date\">\n â”Š103â”Š109â”Š                    {moment(chat.lastMessage.createdAt).format('HH:mm')}\n â”Š104â”Š110â”Š                  </MessageDate>\n â”Š105â”Š111â”Š                </React.Fragment>\n```\n\n[}]: #\n\nNow we can select various HTML elements with a query selector when we test the component. We will install a couple of packages that will assist us in implementing the test:\n\n    $ yarn add jest-fetch-mock @testing-library/jest-dom @testing-library/react\n\n- The [`jest-fetch-mock`](https://www.npmjs.com/package/jest-fetch-mock) package can mock responses emitted by the Fetch API.\n- The [`@testing-library/jest-dom`](https://www.npmjs.com/package/@testing-library/jest-dom) package will add custom matchers that will help us examine HTML contents of DOM elements.\n- The [`@testing-library/react`](https://www.npmjs.com/package/@testing-library/react) package contains utility methods that will help us test React.Components with Jest.\n\nNext, we will create a file under the `src` folder called `setupTests.ts`. This file is loaded configured automatically by `create-react-app` and loaded by Jest, and we can use it to set up our testing environment according to our needs (like said earlier, Jest can be configured, so this file path can be changed). We will use that file to define a fake Fetch API using the `jest-fetch-mock` library:\n\n[{]: <helper> (diffStep \"5.2\" files=\"src/setupTests.ts\" module=\"client\")\n\n#### [__Client__ Step 5.2: Setup tests](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/b8c5decbacf5d092775a4a006ba0dd1ac33838a2)\n\n##### Added src&#x2F;setupTests.ts\n```diff\n@@ -0,0 +1,7 @@\n+â”Š â”Š1â”Šimport '@testing-library/jest-dom/extend-expect';\n+â”Š â”Š2â”Šimport { GlobalWithFetchMock } from 'jest-fetch-mock';\n+â”Š â”Š3â”Šimport { act } from '@testing-library/react';\n+â”Š â”Š4â”Š\n+â”Š â”Š5â”Šconst customGlobal: GlobalWithFetchMock = global as GlobalWithFetchMock;\n+â”Š â”Š6â”ŠcustomGlobal.fetch = require('jest-fetch-mock');\n+â”Š â”Š7â”ŠcustomGlobal.fetchMock = customGlobal.fetch;\n```\n\n[}]: #\n\nWe will create another file called `ChatsList.test.tsx`, right next to the `<ChatsList />` component under the `ChatsListScreen` directory, and inside we will implement our test. The test should follow these steps:\n\n- Mock the response to contain a fake chat, so we won't need to make an actual call to our GraphQL API.\n- We will create a new instance of `<ChatsList />` and render it in a container element.\n- We will wait for changes in the DOM caused by `setState()`.\n- We will test the contents of the container.\n\nAnd this is how the implementation should look like:\n\n[{]: <helper> (diffStep \"5.3\" files=\"src/components/ChatsListScreen/ChatsList.test.tsx\" module=\"client\")\n\n#### [__Client__ Step 5.3: Test ChatsList](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/998a8ec6c09d2708301f2752f5c8d0d7633e78d3)\n\n##### Added src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.test.tsx\n```diff\n@@ -0,0 +1,43 @@\n+â”Š  â”Š 1â”Šimport React from 'react';\n+â”Š  â”Š 2â”Šimport ReactDOM from 'react-dom';\n+â”Š  â”Š 3â”Šimport { cleanup, render, waitForDomChange } from '@testing-library/react';\n+â”Š  â”Š 4â”Šimport ChatsList from './ChatsList';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šdescribe('ChatsList', () => {\n+â”Š  â”Š 7â”Š  afterEach(cleanup);\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Š  it('renders fetched chats data', async () => {\n+â”Š  â”Š10â”Š    fetchMock.mockResponseOnce(\n+â”Š  â”Š11â”Š      JSON.stringify({\n+â”Š  â”Š12â”Š        data: {\n+â”Š  â”Š13â”Š          chats: [\n+â”Š  â”Š14â”Š            {\n+â”Š  â”Š15â”Š              id: 1,\n+â”Š  â”Š16â”Š              name: 'Foo Bar',\n+â”Š  â”Š17â”Š              picture: 'https://localhost:4000/picture.jpg',\n+â”Š  â”Š18â”Š              lastMessage: {\n+â”Š  â”Š19â”Š                id: 1,\n+â”Š  â”Š20â”Š                content: 'Hello',\n+â”Š  â”Š21â”Š                createdAt: new Date('1 Jan 2019 GMT'),\n+â”Š  â”Š22â”Š              },\n+â”Š  â”Š23â”Š            },\n+â”Š  â”Š24â”Š          ],\n+â”Š  â”Š25â”Š        },\n+â”Š  â”Š26â”Š      })\n+â”Š  â”Š27â”Š    );\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š    {\n+â”Š  â”Š30â”Š      const { container, getByTestId } = render(<ChatsList />);\n+â”Š  â”Š31â”Š\n+â”Š  â”Š32â”Š      await waitForDomChange({ container });\n+â”Š  â”Š33â”Š\n+â”Š  â”Š34â”Š      expect(getByTestId('name')).toHaveTextContent('Foo Bar');\n+â”Š  â”Š35â”Š      expect(getByTestId('picture')).toHaveAttribute(\n+â”Š  â”Š36â”Š        'src',\n+â”Š  â”Š37â”Š        'https://localhost:4000/picture.jpg'\n+â”Š  â”Š38â”Š      );\n+â”Š  â”Š39â”Š      expect(getByTestId('content')).toHaveTextContent('Hello');\n+â”Š  â”Š40â”Š      expect(getByTestId('date')).toHaveTextContent('02:00');\n+â”Š  â”Š41â”Š    }\n+â”Š  â”Š42â”Š  });\n+â”Š  â”Š43â”Š});ðŸš«â†µ\n```\n\n[}]: #\n\n> Jest API is vast but pretty intuitive for the most part. It mostly consists of test descriptors and matchers. [Here's a full list of all matchers which are built into Jest's API](https://jestjs.io/docs/en/expect). Always make sure to work against it when writing tests, for optimal results.\n\nWe will now move on to testing the server where we will learn how to setup Jest manually and test it against a GraphQL API.\n\n**Server - Testing GraphQL resolvers**\n\nTo set-up Jest, we will run the following in the command line:\n\n    $ yarn add --dev jest @types/jest ts-jest\n\n\nThis will basically install Jest and make it useable with TypeScript.\nIn addition, we will need to specify the file pattern that we would like to transform with [`ts-jest`](https://www.npmjs.com/package/ts-jest), by adding the following section to `package.json`:\n\n```\n{\n  \"jest\": {\n    \"transform\": {\n      \"^.+\\\\.(js|jsx|ts|tsx)$\": \"<rootDir>/node_modules/ts-jest\"\n    }\n  }\n}\n```\n\nWe will also add a `\"test\"` script in the `package.json` file,\nso we can run the tests with `$ yarn test`:\n\n```\n{\n  \"scripts\": {\n    \"test\": \"jest\"\n  }\n}\n```\n\nThis is how our `package.json` should look like at this point:\n\n> Notice we have lines there that mention `jest-junit`.\n> Those are needed for our own tutorial CI, you don't have to use it.\n\n[{]: <helper> (diffStep \"3.1\" files=\"package.json\" module=\"server\")\n\n#### [__Server__ Step 3.1: Install and configure Jest](https://github.com/Urigo/WhatsApp-Clone-Server/commit/15baf438c199472dbc7842a5268052e840bc1a47)\n\n##### Changed package.json\n```diff\n@@ -8,15 +8,23 @@\n â”Š 8â”Š 8â”Š  \"private\": true,\n â”Š 9â”Š 9â”Š  \"scripts\": {\n â”Š10â”Š10â”Š    \"start\": \"ts-node index.ts\",\n+â”Š  â”Š11â”Š    \"test\": \"TZ=\\\"Asia/Jerusalem\\\" jest\",\n â”Š11â”Š12â”Š    \"format\": \"prettier \\\"**/*.ts\\\" --write\"\n â”Š12â”Š13â”Š  },\n+â”Š  â”Š14â”Š  \"jest-junit\": {\n+â”Š  â”Š15â”Š    \"outputDirectory\": \"./test-results\"\n+â”Š  â”Š16â”Š  },\n â”Š13â”Š17â”Š  \"devDependencies\": {\n â”Š14â”Š18â”Š    \"@types/cors\": \"2.8.5\",\n â”Š15â”Š19â”Š    \"@types/express\": \"4.17.0\",\n â”Š16â”Š20â”Š    \"@types/graphql\": \"14.2.3\",\n â”Š17â”Š21â”Š    \"@types/graphql-iso-date\": \"3.3.1\",\n+â”Š  â”Š22â”Š    \"@types/jest\": \"24.0.17\",\n â”Š18â”Š23â”Š    \"@types/node\": \"12.7.1\",\n+â”Š  â”Š24â”Š    \"jest\": \"24.8.0\",\n+â”Š  â”Š25â”Š    \"jest-junit\": \"7.0.0\",\n â”Š19â”Š26â”Š    \"prettier\": \"1.18.2\",\n+â”Š  â”Š27â”Š    \"ts-jest\": \"24.0.2\",\n â”Š20â”Š28â”Š    \"ts-node\": \"8.3.0\",\n â”Š21â”Š29â”Š    \"typescript\": \"3.5.3\"\n â”Š22â”Š30â”Š  },\n```\n```diff\n@@ -28,5 +36,19 @@\n â”Š28â”Š36â”Š    \"graphql-import\": \"0.7.1\",\n â”Š29â”Š37â”Š    \"graphql-iso-date\": \"3.6.1\",\n â”Š30â”Š38â”Š    \"graphql-tools\": \"4.0.5\"\n+â”Š  â”Š39â”Š  },\n+â”Š  â”Š40â”Š  \"jest\": {\n+â”Š  â”Š41â”Š    \"transform\": {\n+â”Š  â”Š42â”Š      \"^.+\\\\.(js|jsx|ts|tsx)$\": \"<rootDir>/node_modules/ts-jest\"\n+â”Š  â”Š43â”Š    },\n+â”Š  â”Š44â”Š    \"globals\": {\n+â”Š  â”Š45â”Š      \"ts-jest\": {\n+â”Š  â”Š46â”Š        \"diagnostics\": false\n+â”Š  â”Š47â”Š      }\n+â”Š  â”Š48â”Š    },\n+â”Š  â”Š49â”Š    \"reporters\": [\n+â”Š  â”Š50â”Š      \"default\",\n+â”Š  â”Š51â”Š      \"jest-junit\"\n+â”Š  â”Š52â”Š    ]\n â”Š31â”Š53â”Š  }\n â”Š32â”Š54â”Š}ðŸš«â†µ\n```\n\n[}]: #\n\nNow we're gonna test the `chats` query in our GraphQL schema. To do so, we will setup an Apollo Client and send a query request to our back-end, and then we will match the received response with a pre-defined snapshot. Luckily, we don't have to set an actual client, since the tests and the implementation of the back-end live right next to each other, thus, we will install a package which will help us achieving so:\n\n    $ yarn add --dev apollo-server-testing\n\nWe will define the test suite under the `tests/queries` folder in a file called `getChats.test.ts`:\n\n[{]: <helper> (diffStep \"3.2\" files=\"tests/queries/getChats.test.ts\" module=\"server\")\n\n#### [__Server__ Step 3.2: Test Query.chats](https://github.com/Urigo/WhatsApp-Clone-Server/commit/5782a8e2176c05badf1a28b73cee86416f396fc4)\n\n##### Added tests&#x2F;queries&#x2F;getChats.test.ts\n```diff\n@@ -0,0 +1,32 @@\n+â”Š  â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n+â”Š  â”Š 2â”Šimport { ApolloServer, gql } from 'apollo-server-express';\n+â”Š  â”Š 3â”Šimport schema from '../../schema';\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šdescribe('Query.chats', () => {\n+â”Š  â”Š 6â”Š  it('should fetch all chats', async () => {\n+â”Š  â”Š 7â”Š    const server = new ApolloServer({ schema });\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Š    const { query } = createTestClient(server);\n+â”Š  â”Š10â”Š\n+â”Š  â”Š11â”Š    const res = await query({\n+â”Š  â”Š12â”Š      query: gql`\n+â”Š  â”Š13â”Š        query GetChats {\n+â”Š  â”Š14â”Š          chats {\n+â”Š  â”Š15â”Š            id\n+â”Š  â”Š16â”Š            name\n+â”Š  â”Š17â”Š            picture\n+â”Š  â”Š18â”Š            lastMessage {\n+â”Š  â”Š19â”Š              id\n+â”Š  â”Š20â”Š              content\n+â”Š  â”Š21â”Š              createdAt\n+â”Š  â”Š22â”Š            }\n+â”Š  â”Š23â”Š          }\n+â”Š  â”Š24â”Š        }\n+â”Š  â”Š25â”Š      `,\n+â”Š  â”Š26â”Š    });\n+â”Š  â”Š27â”Š\n+â”Š  â”Š28â”Š    expect(res.data).toBeDefined();\n+â”Š  â”Š29â”Š    expect(res.errors).toBeUndefined();\n+â”Š  â”Š30â”Š    expect(res.data).toMatchSnapshot();\n+â”Š  â”Š31â”Š  });\n+â”Š  â”Š32â”Š});\n```\n\n[}]: #\n\nIn the test function, we create a new instance of the Apollo-GraphQL server using our schema, and we query some data against it thanks to the fake client created by [`apollo-server-testing`](https://www.npmjs.com/package/apollo-server-testing).\n\nThe `.toMatchSnapshot()` matcher will call the `toString()` method on the examined object and will test it against a predefined snapshot.\nThe snapshot will automatically be created once we run the test for the first time and will be stored under the `__snapshot__` directory.\nThis means that the first test run will always pass. This is useful because you can later on observe and adjust manually the snapshot manually without having to write it from scratch.\n\nSo let's do our first test run for the server:\n\n    $ yarn test\n\nThe expected result should be a projection of the data stored in the `db.ts` file.\n\n[{]: <helper> (diffStep \"3.2\" files=\"tests/queries/__snapshots__\" module=\"server\")\n\n#### [__Server__ Step 3.2: Test Query.chats](https://github.com/Urigo/WhatsApp-Clone-Server/commit/5782a8e2176c05badf1a28b73cee86416f396fc4)\n\n##### Added tests&#x2F;queries&#x2F;\\__snapshots__&#x2F;getChats.test.ts.snap\n```diff\n@@ -0,0 +1,48 @@\n+â”Š  â”Š 1â”Š// Jest Snapshot v1, https://goo.gl/fbAQLP\n+â”Š  â”Š 2â”Š\n+â”Š  â”Š 3â”Šexports[`Query.chats should fetch all chats 1`] = `\n+â”Š  â”Š 4â”ŠObject {\n+â”Š  â”Š 5â”Š  \"chats\": Array [\n+â”Š  â”Š 6â”Š    Object {\n+â”Š  â”Š 7â”Š      \"id\": \"1\",\n+â”Š  â”Š 8â”Š      \"lastMessage\": Object {\n+â”Š  â”Š 9â”Š        \"content\": \"You on your way?\",\n+â”Š  â”Š10â”Š        \"createdAt\": \"2018-12-30T23:20:00.000Z\",\n+â”Š  â”Š11â”Š        \"id\": \"1\",\n+â”Š  â”Š12â”Š      },\n+â”Š  â”Š13â”Š      \"name\": \"Ethan Gonzalez\",\n+â”Š  â”Š14â”Š      \"picture\": \"https://randomuser.me/api/portraits/thumb/men/1.jpg\",\n+â”Š  â”Š15â”Š    },\n+â”Š  â”Š16â”Š    Object {\n+â”Š  â”Š17â”Š      \"id\": \"2\",\n+â”Š  â”Š18â”Š      \"lastMessage\": Object {\n+â”Š  â”Š19â”Š        \"content\": \"Hey, it's me\",\n+â”Š  â”Š20â”Š        \"createdAt\": \"2018-12-30T06:40:00.000Z\",\n+â”Š  â”Š21â”Š        \"id\": \"2\",\n+â”Š  â”Š22â”Š      },\n+â”Š  â”Š23â”Š      \"name\": \"Bryan Wallace\",\n+â”Š  â”Š24â”Š      \"picture\": \"https://randomuser.me/api/portraits/thumb/men/2.jpg\",\n+â”Š  â”Š25â”Š    },\n+â”Š  â”Š26â”Š    Object {\n+â”Š  â”Š27â”Š      \"id\": \"3\",\n+â”Š  â”Š28â”Š      \"lastMessage\": Object {\n+â”Š  â”Š29â”Š        \"content\": \"I should buy a boat\",\n+â”Š  â”Š30â”Š        \"createdAt\": \"2018-12-15T00:00:00.000Z\",\n+â”Š  â”Š31â”Š        \"id\": \"3\",\n+â”Š  â”Š32â”Š      },\n+â”Š  â”Š33â”Š      \"name\": \"Avery Stewart\",\n+â”Š  â”Š34â”Š      \"picture\": \"https://randomuser.me/api/portraits/thumb/women/1.jpg\",\n+â”Š  â”Š35â”Š    },\n+â”Š  â”Š36â”Š    Object {\n+â”Š  â”Š37â”Š      \"id\": \"4\",\n+â”Š  â”Š38â”Š      \"lastMessage\": Object {\n+â”Š  â”Š39â”Š        \"content\": \"This is wicked good ice cream.\",\n+â”Š  â”Š40â”Š        \"createdAt\": \"2018-05-12T08:00:00.000Z\",\n+â”Š  â”Š41â”Š        \"id\": \"4\",\n+â”Š  â”Š42â”Š      },\n+â”Š  â”Š43â”Š      \"name\": \"Katie Peterson\",\n+â”Š  â”Š44â”Š      \"picture\": \"https://randomuser.me/api/portraits/thumb/women/2.jpg\",\n+â”Š  â”Š45â”Š    },\n+â”Š  â”Š46â”Š  ],\n+â”Š  â”Š47â”Š}\n+â”Š  â”Š48â”Š`;\n```\n\n[}]: #\n\nAlways be sure to observe the snapshot before moving on! The received result isn't necessarily what you'd expect. Also it's not a good practice to store production data in the snapshot because it's subject to changes. Normally we would set up another instance of the DB for testing purposes, but since our DB is a mock and doesn't represent real data, there's no need to at this stage.\n\nNow that we have the required knowledge regards testing and Jest's API, we will implement tests throughout the tutorial as a trivial thing. We will not go through each and every new matcher that we introduce, as it is self explanatory and there's too much of them. Be sure to work against [this full list of matchers](https://jestjs.io/docs/en/expect) when working with Jest.\n\nIn the next chapter we will continue expanding our application by adding a `<ChatRoomScreen />`.\n\n----------\nTODO: Check what changed on testing in create-react-app 3.0 https://facebook.github.io/create-react-app/docs/running-tests\n\nTODO: I think ts-jest could be configured in a simpler way, but need to check\n\t{ preset: 'ts-jest' }\n\nTODO: I donâ€™t like using jestâ€™s toMatchSnapshot() to compare operationâ€™s result that comes from the real GraphQL Schema (with resolvers).\nIt might change quite a lot and break tests. That data might be huge and hard to be validated by looking at it. Maybe checking a structure is a better approach?\n\nTODO: Why ts-jest?\n\nTODO: Change into tortilla diff:\n\nTODO: Change into Tortilla diif:\n\nTODO: Test with UTC timezone so it would work on all computers\n\nTODO: const server = new ApolloServer({ typeDefs }); // easier, no need to compile the schema before"
          },
          {
            "manualTitle": "Step 6: Creating an app router and implementing a chat room",
            "stepRevision": "ed147a9c5f342a79b3710475641e11928f090309",
            "manualView": "In this chapter we will learn how to build a chat room screen.\nIn order to navigate between different screens, we will setup a router.\n\nSince we're gonna have to screens in our app now - `ChatsListScreen` and `ChatRoomScreen`, we will need a router that will be able to alternate between them.\nWe will be using the [`react-router-dom`](https://www.npmjs.com/package/react-router-dom) package to manage the routes of the application:\n\n    $ yarn add react-router-dom @types/react-router-dom\n\nAnd we will implement a router directly in the `<App />` component:\n\n[{]: <helper> (diffStep 6.1 files=\"App\" module=\"client\")\n\n#### [__Client__ Step 6.1: Add router](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/06f782dec1978ee305f31a9dca25129194e21728)\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -1,10 +1,18 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n+â”Š  â”Š 2â”Šimport { BrowserRouter, Route, Redirect, Switch } from 'react-router-dom';\n+â”Š  â”Š 3â”Šimport ChatRoomScreen from './components/ChatRoomScreen';\n â”Š 2â”Š 4â”Šimport ChatsListScreen from './components/ChatsListScreen';\n â”Š 3â”Š 5â”Š\n â”Š 4â”Š 6â”Šconst App: React.FC = () => (\n-â”Š 5â”Š  â”Š  <div>\n-â”Š 6â”Š  â”Š    <ChatsListScreen />\n-â”Š 7â”Š  â”Š  </div>\n+â”Š  â”Š 7â”Š  <BrowserRouter>\n+â”Š  â”Š 8â”Š    <Switch>\n+â”Š  â”Š 9â”Š      <Route exact path=\"/chats\" component={ChatsListScreen} />\n+â”Š  â”Š10â”Š      <Route exact path=\"/chats/:chatId\" component={ChatRoomScreen} />\n+â”Š  â”Š11â”Š    </Switch>\n+â”Š  â”Š12â”Š    <Route exact path=\"/\" render={redirectToChats} />\n+â”Š  â”Š13â”Š  </BrowserRouter>\n â”Š 8â”Š14â”Š);\n â”Š 9â”Š15â”Š\n+â”Š  â”Š16â”Šconst redirectToChats = () => <Redirect to=\"/chats\" />;\n+â”Š  â”Š17â”Š\n â”Š10â”Š18â”Šexport default App;\n```\n\n[}]: #\n\nThe purpose of a router is to make route managing easy and declarative.\nIt will take care of managing the history within our app and parameterize certain screens according to our need.\nEssentially it's a wrap around the `window.history` object which is also compatible with React.\nI recommend you to go through the [official MDN docs](https://developer.mozilla.org/en-US/docs/Web/API/History) if you're not yet familiar with the concept.\n\nThe `<Route />` component represents a path for a route in our application. Using the colon syntax (`:chatId`) we basically tell the router that the `/chat` route should be followed by a string whose value can later on be addressed via a parameter called `chatId` when navigating to the route. So here's a sum-up of the routes manifest:\n\n\n\n*   `/chats` - will navigate to the `ChatsListScreen`.\n*   `/chat/:chatId` - e.g. `/chat/1`, will navigate to the `ChatRoomScreen` and will parameterize it to show data which is related to chat ID 1.\n*   Any other route will fallback to the `/chats` route which will redirect us to the `ChatsListScreen`.\n\nNow we will implement the `ChatRoomScreen` so the router can function properly.\nFor now we will make it a plain screen which simply prints out the information of the chat that was clicked so we can have a complete flow,\nand then we will take care of the rest.\n\nTo do so, we will first implement the `chat` query in our backend.\nThis would be a parameterized query that will provide us with a specific chat according to the received ID,\nand it will be used by the new screen as soon as it is initialized.\nFirst we would update the `Chat` type to contain a `messages` field:\n\n[{]: <helper> (diffStep 4.1 files=\"typeDefs.graphql\" module=\"server\")\n\n#### [__Server__ Step 4.1: Add messages field to Chat type](https://github.com/Urigo/WhatsApp-Clone-Server/commit/5f8481fccc24ac3490b97727d49d5648d17feaff)\n\n##### Changed schema&#x2F;typeDefs.graphql\n```diff\n@@ -11,6 +11,7 @@\n â”Š11â”Š11â”Š  name: String!\n â”Š12â”Š12â”Š  picture: String\n â”Š13â”Š13â”Š  lastMessage: Message\n+â”Š  â”Š14â”Š  messages: [Message!]!\n â”Š14â”Š15â”Š}\n â”Š15â”Š16â”Š\n â”Š16â”Š17â”Štype Query {\n```\n\n[}]: #\n\nThen we will create the appropriate resolver:\n\n[{]: <helper> (diffStep 4.1 files=\"resolvers.ts\" module=\"server\")\n\n#### [__Server__ Step 4.1: Add messages field to Chat type](https://github.com/Urigo/WhatsApp-Clone-Server/commit/5f8481fccc24ac3490b97727d49d5648d17feaff)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -5,6 +5,10 @@\n â”Š 5â”Š 5â”Š  Date: GraphQLDateTime,\n â”Š 6â”Š 6â”Š\n â”Š 7â”Š 7â”Š  Chat: {\n+â”Š  â”Š 8â”Š    messages(chat: any) {\n+â”Š  â”Š 9â”Š      return messages.filter(m => chat.messages.includes(m.id));\n+â”Š  â”Š10â”Š    },\n+â”Š  â”Š11â”Š\n â”Š 8â”Š12â”Š    lastMessage(chat: any) {\n â”Š 9â”Š13â”Š      return messages.find(m => m.id === chat.lastMessage);\n â”Š10â”Š14â”Š    },\n```\n\n[}]: #\n\nAnd then we will update our DB mock to be aligned with these changes:\n\n[{]: <helper> (diffStep 4.1 files=\"db\" module=\"server\")\n\n#### [__Server__ Step 4.1: Add messages field to Chat type](https://github.com/Urigo/WhatsApp-Clone-Server/commit/5f8481fccc24ac3490b97727d49d5648d17feaff)\n\n##### Changed db.ts\n```diff\n@@ -29,23 +29,27 @@\n â”Š29â”Š29â”Š    name: 'Ethan Gonzalez',\n â”Š30â”Š30â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n â”Š31â”Š31â”Š    lastMessage: '1',\n+â”Š  â”Š32â”Š    messages: ['1'],\n â”Š32â”Š33â”Š  },\n â”Š33â”Š34â”Š  {\n â”Š34â”Š35â”Š    id: '2',\n â”Š35â”Š36â”Š    name: 'Bryan Wallace',\n â”Š36â”Š37â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n â”Š37â”Š38â”Š    lastMessage: '2',\n+â”Š  â”Š39â”Š    messages: ['2'],\n â”Š38â”Š40â”Š  },\n â”Š39â”Š41â”Š  {\n â”Š40â”Š42â”Š    id: '3',\n â”Š41â”Š43â”Š    name: 'Avery Stewart',\n â”Š42â”Š44â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n â”Š43â”Š45â”Š    lastMessage: '3',\n+â”Š  â”Š46â”Š    messages: ['3'],\n â”Š44â”Š47â”Š  },\n â”Š45â”Š48â”Š  {\n â”Š46â”Š49â”Š    id: '4',\n â”Š47â”Š50â”Š    name: 'Katie Peterson',\n â”Š48â”Š51â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n â”Š49â”Š52â”Š    lastMessage: '4',\n+â”Š  â”Š53â”Š    messages: ['4'],\n â”Š50â”Š54â”Š  },\n â”Š51â”Š55â”Š];\n```\n\n[}]: #\n\nThis means that when we resolve `Chat.lastMessage`, we should get it directly from the `Chat.messages` field:\n\n[{]: <helper> (diffStep 4.2 module=\"server\")\n\n#### [__Server__ Step 4.2: Resolve last message based on messages array](https://github.com/Urigo/WhatsApp-Clone-Server/commit/6edda809195de096e68ae82598fe3d87f43c49a2)\n\n##### Changed db.ts\n```diff\n@@ -28,28 +28,24 @@\n â”Š28â”Š28â”Š    id: '1',\n â”Š29â”Š29â”Š    name: 'Ethan Gonzalez',\n â”Š30â”Š30â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n-â”Š31â”Š  â”Š    lastMessage: '1',\n â”Š32â”Š31â”Š    messages: ['1'],\n â”Š33â”Š32â”Š  },\n â”Š34â”Š33â”Š  {\n â”Š35â”Š34â”Š    id: '2',\n â”Š36â”Š35â”Š    name: 'Bryan Wallace',\n â”Š37â”Š36â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n-â”Š38â”Š  â”Š    lastMessage: '2',\n â”Š39â”Š37â”Š    messages: ['2'],\n â”Š40â”Š38â”Š  },\n â”Š41â”Š39â”Š  {\n â”Š42â”Š40â”Š    id: '3',\n â”Š43â”Š41â”Š    name: 'Avery Stewart',\n â”Š44â”Š42â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n-â”Š45â”Š  â”Š    lastMessage: '3',\n â”Š46â”Š43â”Š    messages: ['3'],\n â”Š47â”Š44â”Š  },\n â”Š48â”Š45â”Š  {\n â”Š49â”Š46â”Š    id: '4',\n â”Š50â”Š47â”Š    name: 'Katie Peterson',\n â”Š51â”Š48â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n-â”Š52â”Š  â”Š    lastMessage: '4',\n â”Š53â”Š49â”Š    messages: ['4'],\n â”Š54â”Š50â”Š  },\n â”Š55â”Š51â”Š];\n```\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -10,7 +10,9 @@\n â”Š10â”Š10â”Š    },\n â”Š11â”Š11â”Š\n â”Š12â”Š12â”Š    lastMessage(chat: any) {\n-â”Š13â”Š  â”Š      return messages.find(m => m.id === chat.lastMessage);\n+â”Š  â”Š13â”Š      const lastMessage = chat.messages[chat.messages.length - 1];\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”Š      return messages.find(m => m.id === lastMessage);\n â”Š14â”Š16â”Š    },\n â”Š15â”Š17â”Š  },\n```\n\n[}]: #\n\nNow that we have an updated schema which is relevant to the new screen that we would like to add, we will declare a new query called `chat`:\n\n[{]: <helper> (diffStep 4.3 files=\"schema/typeDefs\" module=\"server\")\n\n#### [__Server__ Step 4.3: Add chat field to Query type](https://github.com/Urigo/WhatsApp-Clone-Server/commit/c3de0fe0184817b21e7c6f2246220db38d3b937d)\n\n##### Changed schema&#x2F;typeDefs.graphql\n```diff\n@@ -16,4 +16,5 @@\n â”Š16â”Š16â”Š\n â”Š17â”Š17â”Štype Query {\n â”Š18â”Š18â”Š  chats: [Chat!]!\n+â”Š  â”Š19â”Š  chat(chatId: ID!): Chat\n â”Š19â”Š20â”Š}\n```\n\n[}]: #\n\nNote that unlike the `chats` query, this time we have a parameter. The parameters are provided to the resolver function as the second parameter as a JSON. Using the provided parameter - the chat ID, we will find and return the relevant chat from the DB:\n\n[{]: <helper> (diffStep 4.3 files=\"schema/resolvers\" module=\"server\")\n\n#### [__Server__ Step 4.3: Add chat field to Query type](https://github.com/Urigo/WhatsApp-Clone-Server/commit/c3de0fe0184817b21e7c6f2246220db38d3b937d)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -20,6 +20,10 @@\n â”Š20â”Š20â”Š    chats() {\n â”Š21â”Š21â”Š      return chats;\n â”Š22â”Š22â”Š    },\n+â”Š  â”Š23â”Š\n+â”Š  â”Š24â”Š    chat(root: any, { chatId }: any) {\n+â”Š  â”Š25â”Š      return chats.find(c => c.id === chatId);\n+â”Š  â”Š26â”Š    },\n â”Š23â”Š27â”Š  },\n â”Š24â”Š28â”Š};\n â”Š25â”Š29â”Š\n```\n\n[}]: #\n\n> More about the resolver signature can be read in [Apollo-GraphQL's official docs page](https://www.apollographql.com/docs/apollo-server/essentials/data.html#type-signature).\n\nNow we will add a test suite:\n\n[{]: <helper> (diffStep 4.3 files=\"tests/queries/getChat.test\" module=\"server\")\n\n#### [__Server__ Step 4.3: Add chat field to Query type](https://github.com/Urigo/WhatsApp-Clone-Server/commit/c3de0fe0184817b21e7c6f2246220db38d3b937d)\n\n##### Added tests&#x2F;queries&#x2F;getChat.test.ts\n```diff\n@@ -0,0 +1,33 @@\n+â”Š  â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n+â”Š  â”Š 2â”Šimport { ApolloServer, gql } from 'apollo-server-express';\n+â”Š  â”Š 3â”Šimport schema from '../../schema';\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šdescribe('Query.chat', () => {\n+â”Š  â”Š 6â”Š  it('should fetch specified chat', async () => {\n+â”Š  â”Š 7â”Š    const server = new ApolloServer({ schema });\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Š    const { query } = createTestClient(server);\n+â”Š  â”Š10â”Š\n+â”Š  â”Š11â”Š    const res = await query({\n+â”Š  â”Š12â”Š      variables: { chatId: '1' },\n+â”Š  â”Š13â”Š      query: gql`\n+â”Š  â”Š14â”Š        query GetChat($chatId: ID!) {\n+â”Š  â”Š15â”Š          chat(chatId: $chatId) {\n+â”Š  â”Š16â”Š            id\n+â”Š  â”Š17â”Š            name\n+â”Š  â”Š18â”Š            picture\n+â”Š  â”Š19â”Š            lastMessage {\n+â”Š  â”Š20â”Š              id\n+â”Š  â”Š21â”Š              content\n+â”Š  â”Š22â”Š              createdAt\n+â”Š  â”Š23â”Š            }\n+â”Š  â”Š24â”Š          }\n+â”Š  â”Š25â”Š        }\n+â”Š  â”Š26â”Š      `,\n+â”Š  â”Š27â”Š    });\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š    expect(res.data).toBeDefined();\n+â”Š  â”Š30â”Š    expect(res.errors).toBeUndefined();\n+â”Š  â”Š31â”Š    expect(res.data).toMatchSnapshot();\n+â”Š  â”Š32â”Š  });\n+â”Š  â”Š33â”Š});\n```\n\n[}]: #\n\nWe can observe the snapshot created by Jest to get a better understanding of how the response should look like:\n\n[{]: <helper> (diffStep 4.3 files=\"__snapshot__\" module=\"server\")\n\n#### [__Server__ Step 4.3: Add chat field to Query type](https://github.com/Urigo/WhatsApp-Clone-Server/commit/c3de0fe0184817b21e7c6f2246220db38d3b937d)\n\n\n\n[}]: #\n\nIf you experience any TypeScript related issues with the following error:\n\n```\nObject literal may only specify known properties, and 'variables' does not exist in type 'Query'.\n```\n\nAdd the following declaration file to your project:\n\n[{]: <helper> (diffStep 4.3 files=\"types\" module=\"server\")\n\n#### [__Server__ Step 4.3: Add chat field to Query type](https://github.com/Urigo/WhatsApp-Clone-Server/commit/c3de0fe0184817b21e7c6f2246220db38d3b937d)\n\n##### Added types&#x2F;apollo-server-testing.d.ts\n```diff\n@@ -0,0 +1,27 @@\n+â”Š  â”Š 1â”Šdeclare module 'apollo-server-testing' {\n+â”Š  â”Š 2â”Š  import { ApolloServerBase } from 'apollo-server-core';\n+â”Š  â”Š 3â”Š  import { print, DocumentNode } from 'graphql';\n+â”Š  â”Š 4â”Š  import { GraphQLResponse } from 'graphql-extensions';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Š  type StringOrAst = string | DocumentNode;\n+â”Š  â”Š 7â”Š\n+â”Š  â”Š 8â”Š  // A query must not come with a mutation (and vice versa).\n+â”Š  â”Š 9â”Š  type Query<TVariables> = {\n+â”Š  â”Š10â”Š    query: StringOrAst;\n+â”Š  â”Š11â”Š    mutation?: undefined;\n+â”Š  â”Š12â”Š    variables?: TVariables;\n+â”Š  â”Š13â”Š  };\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”Š  type Mutation<TVariables> = {\n+â”Š  â”Š16â”Š    mutation: StringOrAst;\n+â”Š  â”Š17â”Š    query?: undefined;\n+â”Š  â”Š18â”Š    variables?: TVariables;\n+â”Š  â”Š19â”Š  };\n+â”Š  â”Š20â”Š\n+â”Š  â”Š21â”Š  export const createTestClient: <TVariables>(\n+â”Š  â”Š22â”Š    server: ApolloServerBase\n+â”Š  â”Š23â”Š  ) => {\n+â”Š  â”Š24â”Š    query: (query: Query<TVariables>) => Promise<GraphQLResponse>;\n+â”Š  â”Š25â”Š    mutate: (mutation: Mutation<TVariables>) => Promise<GraphQLResponse>;\n+â”Š  â”Š26â”Š  };\n+â”Š  â”Š27â”Š}\n```\n\n[}]: #\n\nThis is a [known issue](https://github.com/apollographql/apollo-server/issues/2172) in the `apollo-server-testing` package and has a pending [fix PR](https://github.com/apollographql/apollo-server/pull/2307).\nNow getting back to the client, let's implement a basic version of the `ChatRoomScreen` where we will fetch the new query and print it to the screen:\n\n[{]: <helper> (diffStep 6.2 module=\"client\")\n\n#### [__Client__ Step 6.2: Add basic ChatRoomScreen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/254ebdcdd7e5784de91e834a72e3e01a7528c30a)\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -1,5 +1,11 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n-â”Š 2â”Š  â”Šimport { BrowserRouter, Route, Redirect, Switch } from 'react-router-dom';\n+â”Š  â”Š 2â”Šimport {\n+â”Š  â”Š 3â”Š  BrowserRouter,\n+â”Š  â”Š 4â”Š  Route,\n+â”Š  â”Š 5â”Š  Redirect,\n+â”Š  â”Š 6â”Š  Switch,\n+â”Š  â”Š 7â”Š  RouteComponentProps,\n+â”Š  â”Š 8â”Š} from 'react-router-dom';\n â”Š 3â”Š 9â”Šimport ChatRoomScreen from './components/ChatRoomScreen';\n â”Š 4â”Š10â”Šimport ChatsListScreen from './components/ChatsListScreen';\n â”Š 5â”Š11â”Š\n```\n```diff\n@@ -7,7 +13,14 @@\n â”Š 7â”Š13â”Š  <BrowserRouter>\n â”Š 8â”Š14â”Š    <Switch>\n â”Š 9â”Š15â”Š      <Route exact path=\"/chats\" component={ChatsListScreen} />\n-â”Š10â”Š  â”Š      <Route exact path=\"/chats/:chatId\" component={ChatRoomScreen} />\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š      <Route\n+â”Š  â”Š18â”Š        exact\n+â”Š  â”Š19â”Š        path=\"/chats/:chatId\"\n+â”Š  â”Š20â”Š        component={({ match }: RouteComponentProps<{ chatId: string }>) => (\n+â”Š  â”Š21â”Š          <ChatRoomScreen chatId={match.params.chatId} />\n+â”Š  â”Š22â”Š        )}\n+â”Š  â”Š23â”Š      />\n â”Š11â”Š24â”Š    </Switch>\n â”Š12â”Š25â”Š    <Route exact path=\"/\" render={redirectToChats} />\n â”Š13â”Š26â”Š  </BrowserRouter>\n```\n\n##### Added src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -0,0 +1,76 @@\n+â”Š  â”Š 1â”Šimport React from 'react';\n+â”Š  â”Š 2â”Šimport { useMemo, useState } from 'react';\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šconst getChatQuery = `\n+â”Š  â”Š 5â”Š  query GetChat($chatId: ID!) {\n+â”Š  â”Š 6â”Š    chat(chatId: $chatId) {\n+â”Š  â”Š 7â”Š      id\n+â”Š  â”Š 8â”Š      name\n+â”Š  â”Š 9â”Š      picture\n+â”Š  â”Š10â”Š      messages {\n+â”Š  â”Š11â”Š        id\n+â”Š  â”Š12â”Š        content\n+â”Š  â”Š13â”Š        createdAt\n+â”Š  â”Š14â”Š      }\n+â”Š  â”Š15â”Š    }\n+â”Š  â”Š16â”Š  }\n+â”Š  â”Š17â”Š`;\n+â”Š  â”Š18â”Š\n+â”Š  â”Š19â”Šinterface ChatRoomScreenParams {\n+â”Š  â”Š20â”Š  chatId: string;\n+â”Š  â”Š21â”Š}\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Šinterface ChatQueryMessage {\n+â”Š  â”Š24â”Š  id: string;\n+â”Š  â”Š25â”Š  content: string;\n+â”Š  â”Š26â”Š  createdAt: Date;\n+â”Š  â”Š27â”Š}\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Šinterface ChatQueryResult {\n+â”Š  â”Š30â”Š  id: string;\n+â”Š  â”Š31â”Š  name: string;\n+â”Š  â”Š32â”Š  picture: string;\n+â”Š  â”Š33â”Š  messages: Array<ChatQueryMessage>;\n+â”Š  â”Š34â”Š}\n+â”Š  â”Š35â”Š\n+â”Š  â”Š36â”Štype OptionalChatQueryResult = ChatQueryResult | null;\n+â”Š  â”Š37â”Š\n+â”Š  â”Š38â”Šconst ChatRoomScreen: React.FC<ChatRoomScreenParams> = ({ chatId }) => {\n+â”Š  â”Š39â”Š  const [chat, setChat] = useState<OptionalChatQueryResult>(null);\n+â”Š  â”Š40â”Š\n+â”Š  â”Š41â”Š  useMemo(async () => {\n+â”Š  â”Š42â”Š    const body = await fetch(`${process.env.REACT_APP_SERVER_URL}/graphql`, {\n+â”Š  â”Š43â”Š      method: 'POST',\n+â”Š  â”Š44â”Š      headers: {\n+â”Š  â”Š45â”Š        'Content-Type': 'application/json',\n+â”Š  â”Š46â”Š      },\n+â”Š  â”Š47â”Š      body: JSON.stringify({\n+â”Š  â”Š48â”Š        query: getChatQuery,\n+â”Š  â”Š49â”Š        variables: { chatId },\n+â”Š  â”Š50â”Š      }),\n+â”Š  â”Š51â”Š    });\n+â”Š  â”Š52â”Š    const {\n+â”Š  â”Š53â”Š      data: { chat },\n+â”Š  â”Š54â”Š    } = await body.json();\n+â”Š  â”Š55â”Š    setChat(chat);\n+â”Š  â”Š56â”Š  }, [chatId]);\n+â”Š  â”Š57â”Š\n+â”Š  â”Š58â”Š  if (!chat) return null;\n+â”Š  â”Š59â”Š\n+â”Š  â”Š60â”Š  return (\n+â”Š  â”Š61â”Š    <div>\n+â”Š  â”Š62â”Š      <img src={chat.picture} alt=\"Profile\" />\n+â”Š  â”Š63â”Š      <div>{chat.name}</div>\n+â”Š  â”Š64â”Š      <ul>\n+â”Š  â”Š65â”Š        {chat.messages.map(message => (\n+â”Š  â”Š66â”Š          <li key={message.id}>\n+â”Š  â”Š67â”Š            <div>{message.content}</div>\n+â”Š  â”Š68â”Š            <div>{message.createdAt}</div>\n+â”Š  â”Š69â”Š          </li>\n+â”Š  â”Š70â”Š        ))}\n+â”Š  â”Š71â”Š      </ul>\n+â”Š  â”Š72â”Š    </div>\n+â”Š  â”Š73â”Š  );\n+â”Š  â”Š74â”Š};\n+â”Š  â”Š75â”Š\n+â”Š  â”Š76â”Šexport default ChatRoomScreen;\n```\n\n[}]: #\n\nNote how we used the `match.params.chatId` variable to get the selected chat ID.\nThe `match` prop is defined and provided to us by the `<Route />` component, since it interfaces directly with the `ChatRoomScreen`.\nMore about that can be read in the [official docs page](https://reacttraining.com/react-router/core/api/match).\n\nIn many examples online, you can see people pass the `match` prop directly to the component.\nThe main issue with that is that this makes the component being usable only by a router, but the truth is that the component\ndoesn't care if it's consumed by a router or another parents component as long as they will pass the `chatId` prop.\n\nSo we need to make sure the interface of the ChatRoom component defines those requierements right.\n\nNext we will call our server from the component with the right query and store the result on a `useState` hook.\n\nNow, because we are using GraphQL, we know the types of the result that we are going to get, so let's create Typescript interfaces that\ndescribe the data we're going to get from the server.\n\nIf you'll run the application and type `/chats/1` in the URL bar, this is what you should see on the screen:\n\n![naked-chat](https://user-images.githubusercontent.com/7648874/54664314-d4096b80-4b1e-11e9-9e06-1323cf7b0abe.png)\n\nThe view has no styling at all but it should be fixed in a moment.\nTo make navigation more convenient we will add an `onClick` listener for each chat item in the `ChatsList`.\nUsing the [history](https://reacttraining.com/react-router/core/api/history) object, provided to us by the `<Route />` component,\nwe will navigate to the correlated `ChatRoomScreen`:\n\nFirst let's install the `history` package:\n\n    $ yarn add history @types/history\n\n[{]: <helper> (diffStep 6.3 module=\"client\")\n\n#### [__Client__ Step 6.3: Navigate to chat on click](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/2f8fc842d727962a092558c01b72179cc0e3be6b)\n\n##### Changed package.json\n```diff\n@@ -9,12 +9,14 @@\n â”Š 9â”Š 9â”Š  \"dependencies\": {\n â”Š10â”Š10â”Š    \"@material-ui/core\": \"4.3.2\",\n â”Š11â”Š11â”Š    \"@material-ui/icons\": \"4.2.1\",\n+â”Š  â”Š12â”Š    \"@types/history\": \"4.7.2\",\n â”Š12â”Š13â”Š    \"@types/jest\": \"24.0.17\",\n â”Š13â”Š14â”Š    \"@types/node\": \"12.7.1\",\n â”Š14â”Š15â”Š    \"@types/react\": \"16.8.23\",\n â”Š15â”Š16â”Š    \"@types/react-dom\": \"16.8.5\",\n â”Š16â”Š17â”Š    \"@types/react-router-dom\": \"4.3.4\",\n â”Š17â”Š18â”Š    \"@types/styled-components\": \"4.1.18\",\n+â”Š  â”Š19â”Š    \"history\": \"4.9.0\",\n â”Š18â”Š20â”Š    \"moment\": \"2.24.0\",\n â”Š19â”Š21â”Š    \"prettier\": \"1.18.2\",\n â”Š20â”Š22â”Š    \"react\": \"16.9.0\",\n```\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -2,7 +2,8 @@\n â”Š2â”Š2â”Šimport moment from 'moment';\n â”Š3â”Š3â”Šimport { List, ListItem } from '@material-ui/core';\n â”Š4â”Š4â”Šimport styled from 'styled-components';\n-â”Š5â”Š â”Šimport { useState, useMemo } from 'react';\n+â”Š â”Š5â”Šimport { useCallback, useState, useMemo } from 'react';\n+â”Š â”Š6â”Šimport { History } from 'history';\n â”Š6â”Š7â”Š\n â”Š7â”Š8â”Šconst Container = styled.div`\n â”Š8â”Š9â”Š  height: calc(100% - 56px);\n```\n```diff\n@@ -71,7 +72,11 @@\n â”Š71â”Š72â”Š  }\n â”Š72â”Š73â”Š`;\n â”Š73â”Š74â”Š\n-â”Š74â”Š  â”Šconst ChatsList = () => {\n+â”Š  â”Š75â”Šinterface ChatsListProps {\n+â”Š  â”Š76â”Š  history: History;\n+â”Š  â”Š77â”Š}\n+â”Š  â”Š78â”Š\n+â”Š  â”Š79â”Šconst ChatsList: React.FC<ChatsListProps> = ({ history }) => {\n â”Š75â”Š80â”Š  const [chats, setChats] = useState<any[]>([]);\n â”Š76â”Š81â”Š\n â”Š77â”Š82â”Š  useMemo(async () => {\n```\n```diff\n@@ -88,11 +93,22 @@\n â”Š 88â”Š 93â”Š    setChats(chats);\n â”Š 89â”Š 94â”Š  }, []);\n â”Š 90â”Š 95â”Š\n+â”Š   â”Š 96â”Š  const navToChat = useCallback(\n+â”Š   â”Š 97â”Š    chat => {\n+â”Š   â”Š 98â”Š      history.push(`chats/${chat.id}`);\n+â”Š   â”Š 99â”Š    },\n+â”Š   â”Š100â”Š    [history]\n+â”Š   â”Š101â”Š  );\n+â”Š   â”Š102â”Š\n â”Š 91â”Š103â”Š  return (\n â”Š 92â”Š104â”Š    <Container>\n â”Š 93â”Š105â”Š      <StyledList>\n â”Š 94â”Š106â”Š        {chats.map(chat => (\n-â”Š 95â”Š   â”Š          <StyledListItem key={chat.id} button>\n+â”Š   â”Š107â”Š          <StyledListItem\n+â”Š   â”Š108â”Š            key={chat.id}\n+â”Š   â”Š109â”Š            data-testid=\"chat\"\n+â”Š   â”Š110â”Š            button\n+â”Š   â”Š111â”Š            onClick={navToChat.bind(null, chat)}>\n â”Š 96â”Š112â”Š            <ChatPicture\n â”Š 97â”Š113â”Š              data-testid=\"picture\"\n â”Š 98â”Š114â”Š              src={chat.picture}\n```\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;index.tsx\n```diff\n@@ -2,15 +2,20 @@\n â”Š 2â”Š 2â”Šimport ChatsNavbar from './ChatsNavbar';\n â”Š 3â”Š 3â”Šimport ChatsList from './ChatsList';\n â”Š 4â”Š 4â”Šimport styled from 'styled-components';\n+â”Š  â”Š 5â”Šimport { History } from 'history';\n â”Š 5â”Š 6â”Š\n â”Š 6â”Š 7â”Šconst Container = styled.div`\n â”Š 7â”Š 8â”Š  height: 100vh;\n â”Š 8â”Š 9â”Š`;\n â”Š 9â”Š10â”Š\n-â”Š10â”Š  â”Šconst ChatsListScreen: React.FC = () => (\n+â”Š  â”Š11â”Šinterface ChatsListScreenProps {\n+â”Š  â”Š12â”Š  history: History;\n+â”Š  â”Š13â”Š}\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”Šconst ChatsListScreen: React.FC<ChatsListScreenProps> = ({ history }) => (\n â”Š11â”Š16â”Š  <Container>\n â”Š12â”Š17â”Š    <ChatsNavbar />\n-â”Š13â”Š  â”Š    <ChatsList />\n+â”Š  â”Š18â”Š    <ChatsList history={history} />\n â”Š14â”Š19â”Š  </Container>\n â”Š15â”Š20â”Š);\n```\n\n[}]: #\n\nAnd add test the new logic:\n\n[{]: <helper> (diffStep 6.4 module=\"client\")\n\n#### [__Client__ Step 6.4: Test new navigation logic](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/376c013ced53a780bf711fe5933c7c1f2fb6983c)\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.test.tsx\n```diff\n@@ -1,10 +1,24 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n â”Š 2â”Š 2â”Šimport ReactDOM from 'react-dom';\n-â”Š 3â”Š  â”Šimport { cleanup, render, waitForDomChange } from '@testing-library/react';\n+â”Š  â”Š 3â”Šimport {\n+â”Š  â”Š 4â”Š  cleanup,\n+â”Š  â”Š 5â”Š  render,\n+â”Š  â”Š 6â”Š  fireEvent,\n+â”Š  â”Š 7â”Š  wait,\n+â”Š  â”Š 8â”Š  waitForDomChange,\n+â”Š  â”Š 9â”Š} from '@testing-library/react';\n â”Š 4â”Š10â”Šimport ChatsList from './ChatsList';\n+â”Š  â”Š11â”Šimport { createBrowserHistory } from 'history';\n â”Š 5â”Š12â”Š\n â”Š 6â”Š13â”Šdescribe('ChatsList', () => {\n-â”Š 7â”Š  â”Š  afterEach(cleanup);\n+â”Š  â”Š14â”Š  afterEach(() => {\n+â”Š  â”Š15â”Š    cleanup();\n+â”Š  â”Š16â”Š    delete window.location;\n+â”Š  â”Š17â”Š\n+â”Š  â”Š18â”Š    window.location = {\n+â”Š  â”Š19â”Š        href: '/',\n+â”Š  â”Š20â”Š    };\n+â”Š  â”Š21â”Š  });\n â”Š 8â”Š22â”Š\n â”Š 9â”Š23â”Š  it('renders fetched chats data', async () => {\n â”Š10â”Š24â”Š    fetchMock.mockResponseOnce(\n```\n```diff\n@@ -40,4 +54,39 @@\n â”Š40â”Š54â”Š      expect(getByTestId('date')).toHaveTextContent('02:00');\n â”Š41â”Š55â”Š    }\n â”Š42â”Š56â”Š  });\n-â”Š43â”Š  â”Š});ðŸš«â†µ\n+â”Š  â”Š57â”Š\n+â”Š  â”Š58â”Š  it('should navigate to the target chat room on chat item click', async () => {\n+â”Š  â”Š59â”Š    fetchMock.mockResponseOnce(\n+â”Š  â”Š60â”Š      JSON.stringify({\n+â”Š  â”Š61â”Š        data: {\n+â”Š  â”Š62â”Š          chats: [\n+â”Š  â”Š63â”Š            {\n+â”Š  â”Š64â”Š              id: 1,\n+â”Š  â”Š65â”Š              name: 'Foo Bar',\n+â”Š  â”Š66â”Š              picture: 'https://localhost:4000/picture.jpg',\n+â”Š  â”Š67â”Š              lastMessage: {\n+â”Š  â”Š68â”Š                id: 1,\n+â”Š  â”Š69â”Š                content: 'Hello',\n+â”Š  â”Š70â”Š                createdAt: new Date('1 Jan 2019 GMT'),\n+â”Š  â”Š71â”Š              },\n+â”Š  â”Š72â”Š            },\n+â”Š  â”Š73â”Š          ],\n+â”Š  â”Š74â”Š        },\n+â”Š  â”Š75â”Š      })\n+â”Š  â”Š76â”Š    );\n+â”Š  â”Š77â”Š\n+â”Š  â”Š78â”Š    const history = createBrowserHistory();\n+â”Š  â”Š79â”Š\n+â”Š  â”Š80â”Š    {\n+â”Š  â”Š81â”Š      const { container, getByTestId } = render(\n+â”Š  â”Š82â”Š        <ChatsList history={history} />\n+â”Š  â”Š83â”Š      );\n+â”Š  â”Š84â”Š\n+â”Š  â”Š85â”Š      await waitForDomChange({ container });\n+â”Š  â”Š86â”Š\n+â”Š  â”Š87â”Š      fireEvent.click(getByTestId('chat'));\n+â”Š  â”Š88â”Š\n+â”Š  â”Š89â”Š      await wait(() => expect(history.location.pathname).toEqual('/chats/1'));\n+â”Š  â”Š90â”Š    }\n+â”Š  â”Š91â”Š  });\n+â”Š  â”Š92â”Š});\n```\n\n[}]: #\n\nIf you'll click on the chat item you'll see that the screen changes very suddenly.\nWe can smooth the transition by animating it with CSS.\nLuckily we don't need to implemented such mechanism manually because there's a package that can do that for us - [`react-router-transition`](https://www.npmjs.com/package/react-router-transition):\n\n    $ yarn add react-router-transition\n\nAnd let's add the mising types for the library:\n\n[{]: <helper> (diffStep 6.5 files=\"react-app-env.d.ts\" module=\"client\")\n\n#### [__Client__ Step 6.5: Animate route switching](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/629bf62829c9ea34cfe0f268e6dce7299c35253e)\n\n##### Changed src&#x2F;react-app-env.d.ts\n```diff\n@@ -1 +1,3 @@\n â”Š1â”Š1â”Š/// <reference types=\"react-scripts\" />\n+â”Š â”Š2â”Š\n+â”Š â”Š3â”Šdeclare module 'react-router-transition';\n```\n\n[}]: #\n\nUsing this package, we will create a custom `Switch` component that will play an animation for all its subordinate `Route` components.\nThe animation is defined by the user using a component called `AnimatedSwitch` as specified in the [package's docs page](http://maisano.github.io/react-router-transition/animated-switch/props).\nSo first, let's create our switch component that will play a smooth transition switching routes:\n\n[{]: <helper> (diffStep 6.5 files=\"AnimatedSwitch\" module=\"client\")\n\n#### [__Client__ Step 6.5: Animate route switching](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/629bf62829c9ea34cfe0f268e6dce7299c35253e)\n\n##### Added src&#x2F;components&#x2F;AnimatedSwitch.tsx\n```diff\n@@ -0,0 +1,38 @@\n+â”Š  â”Š 1â”Šimport { Switch } from 'react-router-dom';\n+â”Š  â”Š 2â”Šimport { AnimatedSwitch, spring } from 'react-router-transition';\n+â”Š  â”Š 3â”Šimport styled from 'styled-components';\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Š// A workaround to make test pass\n+â”Š  â”Š 6â”Šconst SwitchComponent =\n+â”Š  â”Š 7â”Š  process.env.NODE_ENV === 'test' ? Switch : AnimatedSwitch;\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Šconst glide = (val: number) =>\n+â”Š  â”Š10â”Š  spring(val, {\n+â”Š  â”Š11â”Š    stiffness: 174,\n+â”Š  â”Š12â”Š    damping: 24,\n+â”Š  â”Š13â”Š  });\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”Šconst mapStyles = (styles: any) => ({\n+â”Š  â”Š16â”Š  transform: `translateX(${styles.offset}%)`,\n+â”Š  â”Š17â”Š});\n+â”Š  â”Š18â”Š\n+â”Š  â”Š19â”Šconst MyAnimatedSwitch = styled(SwitchComponent).attrs(() => ({\n+â”Š  â”Š20â”Š  atEnter: { offset: 100 },\n+â”Š  â”Š21â”Š  atLeave: { offset: glide(-100) },\n+â”Š  â”Š22â”Š  atActive: { offset: glide(0) },\n+â”Š  â”Š23â”Š  mapStyles,\n+â”Š  â”Š24â”Š}))`\n+â”Š  â”Š25â”Š  position: relative;\n+â”Š  â”Š26â”Š  overflow: hidden;\n+â”Š  â”Š27â”Š  height: 100vh;\n+â”Š  â”Š28â”Š  width: 100vw;\n+â”Š  â”Š29â”Š\n+â”Š  â”Š30â”Š  > div {\n+â”Š  â”Š31â”Š    position: absolute;\n+â”Š  â”Š32â”Š    overflow: hidden;\n+â”Š  â”Š33â”Š    height: 100vh;\n+â”Š  â”Š34â”Š    width: 100vw;\n+â”Š  â”Š35â”Š  }\n+â”Š  â”Š36â”Š`;\n+â”Š  â”Š37â”Š\n+â”Š  â”Š38â”Šexport default MyAnimatedSwitch;\n```\n\n[}]: #\n\nAnd then replace it with the main `Switch` component in our app:\n\n[{]: <helper> (diffStep 6.5 files=\"App\" module=\"client\")\n\n#### [__Client__ Step 6.5: Animate route switching](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/629bf62829c9ea34cfe0f268e6dce7299c35253e)\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -3,15 +3,15 @@\n â”Š 3â”Š 3â”Š  BrowserRouter,\n â”Š 4â”Š 4â”Š  Route,\n â”Š 5â”Š 5â”Š  Redirect,\n-â”Š 6â”Š  â”Š  Switch,\n â”Š 7â”Š 6â”Š  RouteComponentProps,\n â”Š 8â”Š 7â”Š} from 'react-router-dom';\n â”Š 9â”Š 8â”Šimport ChatRoomScreen from './components/ChatRoomScreen';\n â”Š10â”Š 9â”Šimport ChatsListScreen from './components/ChatsListScreen';\n+â”Š  â”Š10â”Šimport AnimatedSwitch from './components/AnimatedSwitch';\n â”Š11â”Š11â”Š\n â”Š12â”Š12â”Šconst App: React.FC = () => (\n â”Š13â”Š13â”Š  <BrowserRouter>\n-â”Š14â”Š  â”Š    <Switch>\n+â”Š  â”Š14â”Š    <AnimatedSwitch>\n â”Š15â”Š15â”Š      <Route exact path=\"/chats\" component={ChatsListScreen} />\n â”Š16â”Š16â”Š\n â”Š17â”Š17â”Š      <Route\n```\n```diff\n@@ -21,7 +21,7 @@\n â”Š21â”Š21â”Š          <ChatRoomScreen chatId={match.params.chatId} />\n â”Š22â”Š22â”Š        )}\n â”Š23â”Š23â”Š      />\n-â”Š24â”Š  â”Š    </Switch>\n+â”Š  â”Š24â”Š    </AnimatedSwitch>\n â”Š25â”Š25â”Š    <Route exact path=\"/\" render={redirectToChats} />\n â”Š26â”Š26â”Š  </BrowserRouter>\n â”Š27â”Š27â”Š);\n```\n\n[}]: #\n\nBoth components act identically and thus there shall be no special treatment. Behold the new transition effect:\n\n![transition-demo](https://user-images.githubusercontent.com/7648874/54739398-ebb22400-4bf2-11e9-8d4c-2aeb65deeb92.gif)\n\nThe final screen will be composed out of 3 components:\n\n\n\n*   A navigation bar.\n*   A messages list.\n*   A message input.\n\nWe will create a new directory under the path `public/assets` and inside we will download and place a couple of assets which are necessary for our view:\n\n*   [chat-background.jpg](https://raw.githubusercontent.com/Urigo/WhatsApp-Clone-Client-Angular/master/src/assets/chat-background.jpg)\n*   [message-mine.png](https://raw.githubusercontent.com/Urigo/WhatsApp-Clone-Client-Angular/master/src/assets/message-mine.png)\n\nIn the main `index.ts` file of the screen we will simply import all 3 in the right order.\nWe will start with the most simple one - the `ChatRoomNavbar`.\nThe navbar should show the picture of the chat we're currently at and its name,\nalong with a back button that will bring us back to the `ChatsListScreen`:\n\n[{]: <helper> (diffStep 6.6 files=\"ChatNavbar\" module=\"client\")\n\n#### [__Client__ Step 6.6: Implement ChatRoomScreen components](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/c3e46a29f5dedfd51dc0f3c5218bb67ba99df3e1)\n\n##### Added src&#x2F;components&#x2F;ChatRoomScreen&#x2F;ChatNavbar.tsx\n```diff\n@@ -0,0 +1,59 @@\n+â”Š  â”Š 1â”Šimport Button from '@material-ui/core/Button';\n+â”Š  â”Š 2â”Šimport Toolbar from '@material-ui/core/Toolbar';\n+â”Š  â”Š 3â”Šimport ArrowBackIcon from '@material-ui/icons/ArrowBack';\n+â”Š  â”Š 4â”Šimport React from 'react';\n+â”Š  â”Š 5â”Šimport { useCallback } from 'react';\n+â”Š  â”Š 6â”Šimport styled from 'styled-components';\n+â”Š  â”Š 7â”Šimport { History } from 'history';\n+â”Š  â”Š 8â”Šimport { ChatQueryResult } from './index';\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Šconst Container = styled(Toolbar)`\n+â”Š  â”Š11â”Š  padding: 0;\n+â”Š  â”Š12â”Š  display: flex;\n+â”Š  â”Š13â”Š  flex-direction: row;\n+â”Š  â”Š14â”Š  background-color: var(--primary-bg);\n+â”Š  â”Š15â”Š  color: var(--primary-text);\n+â”Š  â”Š16â”Š`;\n+â”Š  â”Š17â”Š\n+â”Š  â”Š18â”Šconst BackButton = styled(Button)`\n+â”Š  â”Š19â”Š  svg {\n+â”Š  â”Š20â”Š    color: var(--primary-text);\n+â”Š  â”Š21â”Š  }\n+â”Š  â”Š22â”Š`;\n+â”Š  â”Š23â”Š\n+â”Š  â”Š24â”Šconst Picture = styled.img`\n+â”Š  â”Š25â”Š  height: 40px;\n+â”Š  â”Š26â”Š  width: 40px;\n+â”Š  â”Š27â”Š  margin-top: 3px;\n+â”Š  â”Š28â”Š  margin-left: -22px;\n+â”Š  â”Š29â”Š  object-fit: cover;\n+â”Š  â”Š30â”Š  padding: 5px;\n+â”Š  â”Š31â”Š  border-radius: 50%;\n+â”Š  â”Š32â”Š`;\n+â”Š  â”Š33â”Š\n+â”Š  â”Š34â”Šconst Name = styled.div`\n+â”Š  â”Š35â”Š  line-height: 56px;\n+â”Š  â”Š36â”Š`;\n+â”Š  â”Š37â”Š\n+â”Š  â”Š38â”Šinterface ChatNavbarProps {\n+â”Š  â”Š39â”Š  history: History;\n+â”Š  â”Š40â”Š  chat: ChatQueryResult;\n+â”Š  â”Š41â”Š}\n+â”Š  â”Š42â”Š\n+â”Š  â”Š43â”Šconst ChatNavbar: React.FC<ChatNavbarProps> = ({ chat, history }) => {\n+â”Š  â”Š44â”Š  const navBack = useCallback(() => {\n+â”Š  â”Š45â”Š    history.replace('/chats');\n+â”Š  â”Š46â”Š  }, [history]);\n+â”Š  â”Š47â”Š\n+â”Š  â”Š48â”Š  return (\n+â”Š  â”Š49â”Š    <Container>\n+â”Š  â”Š50â”Š      <BackButton onClick={navBack}>\n+â”Š  â”Š51â”Š        <ArrowBackIcon />\n+â”Š  â”Š52â”Š      </BackButton>\n+â”Š  â”Š53â”Š      <Picture src={chat.picture} />\n+â”Š  â”Š54â”Š      <Name>{chat.name}</Name>\n+â”Š  â”Š55â”Š    </Container>\n+â”Š  â”Š56â”Š  );\n+â”Š  â”Š57â”Š};\n+â”Š  â”Š58â”Š\n+â”Š  â”Š59â”Šexport default ChatNavbar;\n```\n\n[}]: #\n\nNext, would be the `MesagesList` component, where we will see a scrollable list of all the messages of the active chat:\n\n[{]: <helper> (diffStep 6.6 files=\"MessagesList\" module=\"client\")\n\n#### [__Client__ Step 6.6: Implement ChatRoomScreen components](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/c3e46a29f5dedfd51dc0f3c5218bb67ba99df3e1)\n\n##### Added src&#x2F;components&#x2F;ChatRoomScreen&#x2F;MessagesList.tsx\n```diff\n@@ -0,0 +1,78 @@\n+â”Š  â”Š 1â”Šimport moment from 'moment';\n+â”Š  â”Š 2â”Šimport React from 'react';\n+â”Š  â”Š 3â”Šimport styled from 'styled-components';\n+â”Š  â”Š 4â”Šimport { ChatQueryMessage } from './index';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šconst Container = styled.div`\n+â”Š  â”Š 7â”Š  display: block;\n+â”Š  â”Š 8â”Š  flex: 2;\n+â”Š  â”Š 9â”Š  overflow-y: overlay;\n+â”Š  â”Š10â”Š  padding: 0 15px;\n+â”Š  â”Š11â”Š`;\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Šconst MessageItem = styled.div`\n+â”Š  â”Š14â”Š  float: right;\n+â”Š  â”Š15â”Š  background-color: #dcf8c6;\n+â”Š  â”Š16â”Š  display: inline-block;\n+â”Š  â”Š17â”Š  position: relative;\n+â”Š  â”Š18â”Š  max-width: 100%;\n+â”Š  â”Š19â”Š  border-radius: 7px;\n+â”Š  â”Š20â”Š  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.15);\n+â”Š  â”Š21â”Š  margin-top: 10px;\n+â”Š  â”Š22â”Š  margin-bottom: 10px;\n+â”Š  â”Š23â”Š  clear: both;\n+â”Š  â”Š24â”Š\n+â”Š  â”Š25â”Š  &::after {\n+â”Š  â”Š26â”Š    content: '';\n+â”Š  â”Š27â”Š    display: table;\n+â”Š  â”Š28â”Š    clear: both;\n+â”Š  â”Š29â”Š  }\n+â”Š  â”Š30â”Š\n+â”Š  â”Š31â”Š  &::before {\n+â”Š  â”Š32â”Š    background-image: url(/assets/message-mine.png);\n+â”Š  â”Š33â”Š    content: '';\n+â”Š  â”Š34â”Š    position: absolute;\n+â”Š  â”Š35â”Š    bottom: 3px;\n+â”Š  â”Š36â”Š    width: 12px;\n+â”Š  â”Š37â”Š    height: 19px;\n+â”Š  â”Š38â”Š    right: -11px;\n+â”Š  â”Š39â”Š    background-position: 50% 50%;\n+â”Š  â”Š40â”Š    background-repeat: no-repeat;\n+â”Š  â”Š41â”Š    background-size: contain;\n+â”Š  â”Š42â”Š  }\n+â”Š  â”Š43â”Š`;\n+â”Š  â”Š44â”Š\n+â”Š  â”Š45â”Šconst Contents = styled.div`\n+â”Š  â”Š46â”Š  padding: 5px 7px;\n+â”Š  â”Š47â”Š  word-wrap: break-word;\n+â”Š  â”Š48â”Š\n+â”Š  â”Š49â”Š  &::after {\n+â”Š  â”Š50â”Š    content: ' \\\\00a0\\\\00a0\\\\00a0\\\\00a0\\\\00a0\\\\00a0\\\\00a0\\\\00a0\\\\00a0\\\\00a0\\\\00a0\\\\00a0\\\\00a0\\\\00a0\\\\00a0\\\\00a0\\\\00a0\\\\00a0\\\\00a0';\n+â”Š  â”Š51â”Š    display: inline;\n+â”Š  â”Š52â”Š  }\n+â”Š  â”Š53â”Š`;\n+â”Š  â”Š54â”Š\n+â”Š  â”Š55â”Šconst Timestamp = styled.div`\n+â”Š  â”Š56â”Š  position: absolute;\n+â”Š  â”Š57â”Š  bottom: 2px;\n+â”Š  â”Š58â”Š  right: 7px;\n+â”Š  â”Š59â”Š  color: gray;\n+â”Š  â”Š60â”Š  font-size: 12px;\n+â”Š  â”Š61â”Š`;\n+â”Š  â”Š62â”Š\n+â”Š  â”Š63â”Šinterface MessagesListProps {\n+â”Š  â”Š64â”Š  messages: Array<ChatQueryMessage>;\n+â”Š  â”Š65â”Š}\n+â”Š  â”Š66â”Š\n+â”Š  â”Š67â”Šconst MessagesList: React.FC<MessagesListProps> = ({ messages }) => (\n+â”Š  â”Š68â”Š  <Container>\n+â”Š  â”Š69â”Š    {messages.map((message: any) => (\n+â”Š  â”Š70â”Š      <MessageItem key={message.id}>\n+â”Š  â”Š71â”Š        <Contents>{message.content}</Contents>\n+â”Š  â”Š72â”Š        <Timestamp>{moment(message.createdAt).format('HH:mm')}</Timestamp>\n+â”Š  â”Š73â”Š      </MessageItem>\n+â”Š  â”Š74â”Š    ))}\n+â”Š  â”Š75â”Š  </Container>\n+â”Š  â”Š76â”Š);\n+â”Š  â”Š77â”Š\n+â”Š  â”Š78â”Šexport default MessagesList;\n```\n\n[}]: #\n\nAnd finally, would be the `MessageInput` component which will trigger an event whenever we type and submit a new message:\n\n[{]: <helper> (diffStep 6.6 files=\"MessageInput\" module=\"client\")\n\n#### [__Client__ Step 6.6: Implement ChatRoomScreen components](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/c3e46a29f5dedfd51dc0f3c5218bb67ba99df3e1)\n\n##### Added src&#x2F;components&#x2F;ChatRoomScreen&#x2F;MessageInput.tsx\n```diff\n@@ -0,0 +1,53 @@\n+â”Š  â”Š 1â”Šimport Button from '@material-ui/core/Button';\n+â”Š  â”Š 2â”Šimport SendIcon from '@material-ui/icons/Send';\n+â”Š  â”Š 3â”Šimport React from 'react';\n+â”Š  â”Š 4â”Šimport styled from 'styled-components';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šconst Container = styled.div`\n+â”Š  â”Š 7â”Š  display: flex;\n+â”Š  â”Š 8â”Š  height: 50px;\n+â”Š  â”Š 9â”Š  padding: 5px;\n+â”Š  â”Š10â”Š  width: calc(100% - 10px);\n+â”Š  â”Š11â”Š`;\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Šconst ActualInput = styled.input`\n+â”Š  â”Š14â”Š  width: calc(100% - 50px);\n+â”Š  â”Š15â”Š  border: none;\n+â”Š  â”Š16â”Š  border-radius: 999px;\n+â”Š  â”Š17â”Š  padding: 10px;\n+â”Š  â”Š18â”Š  padding-left: 20px;\n+â”Š  â”Š19â”Š  padding-right: 20px;\n+â”Š  â”Š20â”Š  font-size: 15px;\n+â”Š  â”Š21â”Š  outline: none;\n+â”Š  â”Š22â”Š  box-shadow: 0 1px silver;\n+â”Š  â”Š23â”Š  font-size: 18px;\n+â”Š  â”Š24â”Š  line-height: 45px;\n+â”Š  â”Š25â”Š`;\n+â”Š  â”Š26â”Š\n+â”Š  â”Š27â”Šconst SendButton = styled(Button)`\n+â”Š  â”Š28â”Š  min-width: 50px !important;\n+â”Š  â”Š29â”Š  width: 50px !important;\n+â”Š  â”Š30â”Š  border-radius: 999px !important;\n+â”Š  â”Š31â”Š  background-color: var(--primary-bg) !important;\n+â”Š  â”Š32â”Š  margin: 0 5px !important;\n+â”Š  â”Š33â”Š  margin-right: 0 !important;\n+â”Š  â”Š34â”Š  color: white !important;\n+â”Š  â”Š35â”Š  padding-left: 20px !important;\n+â”Š  â”Š36â”Š\n+â”Š  â”Š37â”Š  svg {\n+â”Š  â”Š38â”Š    margin-left: -3px;\n+â”Š  â”Š39â”Š  }\n+â”Š  â”Š40â”Š`;\n+â”Š  â”Š41â”Š\n+â”Š  â”Š42â”Šconst MessageInput: React.FC = () => {\n+â”Š  â”Š43â”Š  return (\n+â”Š  â”Š44â”Š    <Container>\n+â”Š  â”Š45â”Š      <ActualInput type=\"text\" placeholder=\"Type a message\" />\n+â”Š  â”Š46â”Š      <SendButton variant=\"contained\" color=\"primary\">\n+â”Š  â”Š47â”Š        <SendIcon />\n+â”Š  â”Š48â”Š      </SendButton>\n+â”Š  â”Š49â”Š    </Container>\n+â”Š  â”Š50â”Š  );\n+â”Š  â”Š51â”Š};\n+â”Š  â”Š52â”Š\n+â”Š  â”Š53â”Šexport default MessageInput;\n```\n\n[}]: #\n\nNow that we have all 3 components, we will put them all together in the main `index.ts` file:\n\n[{]: <helper> (diffStep 6.6 files=\"index\" module=\"client\")\n\n#### [__Client__ Step 6.6: Implement ChatRoomScreen components](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/c3e46a29f5dedfd51dc0f3c5218bb67ba99df3e1)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -1,5 +1,17 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n â”Š 2â”Š 2â”Šimport { useMemo, useState } from 'react';\n+â”Š  â”Š 3â”Šimport styled from 'styled-components';\n+â”Š  â”Š 4â”Šimport ChatNavbar from './ChatNavbar';\n+â”Š  â”Š 5â”Šimport MessageInput from './MessageInput';\n+â”Š  â”Š 6â”Šimport MessagesList from './MessagesList';\n+â”Š  â”Š 7â”Šimport { History } from 'history';\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Šconst Container = styled.div`\n+â”Š  â”Š10â”Š  background: url(/assets/chat-background.jpg);\n+â”Š  â”Š11â”Š  display: flex;\n+â”Š  â”Š12â”Š  flex-flow: column;\n+â”Š  â”Š13â”Š  height: 100vh;\n+â”Š  â”Š14â”Š`;\n â”Š 3â”Š15â”Š\n â”Š 4â”Š16â”Šconst getChatQuery = `\n â”Š 5â”Š17â”Š  query GetChat($chatId: ID!) {\n```\n```diff\n@@ -18,15 +30,16 @@\n â”Š18â”Š30â”Š\n â”Š19â”Š31â”Šinterface ChatRoomScreenParams {\n â”Š20â”Š32â”Š  chatId: string;\n+â”Š  â”Š33â”Š  history: History;\n â”Š21â”Š34â”Š}\n â”Š22â”Š35â”Š\n-â”Š23â”Š  â”Šinterface ChatQueryMessage {\n+â”Š  â”Š36â”Šexport interface ChatQueryMessage {\n â”Š24â”Š37â”Š  id: string;\n â”Š25â”Š38â”Š  content: string;\n â”Š26â”Š39â”Š  createdAt: Date;\n â”Š27â”Š40â”Š}\n â”Š28â”Š41â”Š\n-â”Š29â”Š  â”Šinterface ChatQueryResult {\n+â”Š  â”Š42â”Šexport interface ChatQueryResult {\n â”Š30â”Š43â”Š  id: string;\n â”Š31â”Š44â”Š  name: string;\n â”Š32â”Š45â”Š  picture: string;\n```\n```diff\n@@ -35,7 +48,10 @@\n â”Š35â”Š48â”Š\n â”Š36â”Š49â”Štype OptionalChatQueryResult = ChatQueryResult | null;\n â”Š37â”Š50â”Š\n-â”Š38â”Š  â”Šconst ChatRoomScreen: React.FC<ChatRoomScreenParams> = ({ chatId }) => {\n+â”Š  â”Š51â”Šconst ChatRoomScreen: React.FC<ChatRoomScreenParams> = ({\n+â”Š  â”Š52â”Š  history,\n+â”Š  â”Š53â”Š  chatId,\n+â”Š  â”Š54â”Š}) => {\n â”Š39â”Š55â”Š  const [chat, setChat] = useState<OptionalChatQueryResult>(null);\n â”Š40â”Š56â”Š\n â”Š41â”Š57â”Š  useMemo(async () => {\n```\n```diff\n@@ -58,18 +74,11 @@\n â”Š58â”Š74â”Š  if (!chat) return null;\n â”Š59â”Š75â”Š\n â”Š60â”Š76â”Š  return (\n-â”Š61â”Š  â”Š    <div>\n-â”Š62â”Š  â”Š      <img src={chat.picture} alt=\"Profile\" />\n-â”Š63â”Š  â”Š      <div>{chat.name}</div>\n-â”Š64â”Š  â”Š      <ul>\n-â”Š65â”Š  â”Š        {chat.messages.map(message => (\n-â”Š66â”Š  â”Š          <li key={message.id}>\n-â”Š67â”Š  â”Š            <div>{message.content}</div>\n-â”Š68â”Š  â”Š            <div>{message.createdAt}</div>\n-â”Š69â”Š  â”Š          </li>\n-â”Š70â”Š  â”Š        ))}\n-â”Š71â”Š  â”Š      </ul>\n-â”Š72â”Š  â”Š    </div>\n+â”Š  â”Š77â”Š    <Container>\n+â”Š  â”Š78â”Š      <ChatNavbar chat={chat} history={history} />\n+â”Š  â”Š79â”Š      {chat.messages && <MessagesList messages={chat.messages} />}\n+â”Š  â”Š80â”Š      <MessageInput />\n+â”Š  â”Š81â”Š    </Container>\n â”Š73â”Š82â”Š  );\n â”Š74â”Š83â”Š};\n```\n\n[}]: #\n\nAnd let's also send the new required `history` props to our `ChatRoomScreen` component:\n\n[{]: <helper> (diffStep 6.6 files=\"App.tsx\" module=\"client\")\n\n#### [__Client__ Step 6.6: Implement ChatRoomScreen components](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/c3e46a29f5dedfd51dc0f3c5218bb67ba99df3e1)\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -17,8 +17,11 @@\n â”Š17â”Š17â”Š      <Route\n â”Š18â”Š18â”Š        exact\n â”Š19â”Š19â”Š        path=\"/chats/:chatId\"\n-â”Š20â”Š  â”Š        component={({ match }: RouteComponentProps<{ chatId: string }>) => (\n-â”Š21â”Š  â”Š          <ChatRoomScreen chatId={match.params.chatId} />\n+â”Š  â”Š20â”Š        component={({\n+â”Š  â”Š21â”Š          match,\n+â”Š  â”Š22â”Š          history,\n+â”Š  â”Š23â”Š        }: RouteComponentProps<{ chatId: string }>) => (\n+â”Š  â”Š24â”Š          <ChatRoomScreen chatId={match.params.chatId} history={history} />\n â”Š22â”Š25â”Š        )}\n â”Š23â”Š26â”Š      />\n â”Š24â”Š27â”Š    </AnimatedSwitch>\n```\n\n[}]: #\n\nThe view is complete! However the `MessageInput` is not bound to our messages list.\nWe will use the triggered callback to update the chat state, whose changes should appear in the `MessagesList` component in the following render phase:\n\n[{]: <helper> (diffStep 6.7 module=\"client\")\n\n#### [__Client__ Step 6.7: Define onSendMessage callback](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/70ac2715ae7c2a352745a2a089961b92c949b364)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;MessageInput.tsx\n```diff\n@@ -2,6 +2,7 @@\n â”Š2â”Š2â”Šimport SendIcon from '@material-ui/icons/Send';\n â”Š3â”Š3â”Šimport React from 'react';\n â”Š4â”Š4â”Šimport styled from 'styled-components';\n+â”Š â”Š5â”Šimport { useState } from 'react';\n â”Š5â”Š6â”Š\n â”Š6â”Š7â”Šconst Container = styled.div`\n â”Š7â”Š8â”Š  display: flex;\n```\n```diff\n@@ -39,11 +40,43 @@\n â”Š39â”Š40â”Š  }\n â”Š40â”Š41â”Š`;\n â”Š41â”Š42â”Š\n-â”Š42â”Š  â”Šconst MessageInput: React.FC = () => {\n+â”Š  â”Š43â”Šinterface MessageInputProps {\n+â”Š  â”Š44â”Š  onSendMessage(content: string): any;\n+â”Š  â”Š45â”Š}\n+â”Š  â”Š46â”Š\n+â”Š  â”Š47â”Šconst MessageInput: React.FC<MessageInputProps> = ({ onSendMessage }) => {\n+â”Š  â”Š48â”Š  const [message, setMessage] = useState('');\n+â”Š  â”Š49â”Š\n+â”Š  â”Š50â”Š  const onKeyPress = (e: any) => {\n+â”Š  â”Š51â”Š    if (e.charCode === 13) {\n+â”Š  â”Š52â”Š      submitMessage();\n+â”Š  â”Š53â”Š    }\n+â”Š  â”Š54â”Š  };\n+â”Š  â”Š55â”Š\n+â”Š  â”Š56â”Š  const onChange = ({ target }: any) => {\n+â”Š  â”Š57â”Š    setMessage(target.value);\n+â”Š  â”Š58â”Š  };\n+â”Š  â”Š59â”Š\n+â”Š  â”Š60â”Š  const submitMessage = () => {\n+â”Š  â”Š61â”Š    if (!message) return;\n+â”Š  â”Š62â”Š\n+â”Š  â”Š63â”Š    setMessage('');\n+â”Š  â”Š64â”Š\n+â”Š  â”Š65â”Š    if (typeof onSendMessage === 'function') {\n+â”Š  â”Š66â”Š      onSendMessage(message);\n+â”Š  â”Š67â”Š    }\n+â”Š  â”Š68â”Š  };\n+â”Š  â”Š69â”Š\n â”Š43â”Š70â”Š  return (\n â”Š44â”Š71â”Š    <Container>\n-â”Š45â”Š  â”Š      <ActualInput type=\"text\" placeholder=\"Type a message\" />\n-â”Š46â”Š  â”Š      <SendButton variant=\"contained\" color=\"primary\">\n+â”Š  â”Š72â”Š      <ActualInput\n+â”Š  â”Š73â”Š        type=\"text\"\n+â”Š  â”Š74â”Š        placeholder=\"Type a message\"\n+â”Š  â”Š75â”Š        value={message}\n+â”Š  â”Š76â”Š        onKeyPress={onKeyPress}\n+â”Š  â”Š77â”Š        onChange={onChange}\n+â”Š  â”Š78â”Š      />\n+â”Š  â”Š79â”Š      <SendButton variant=\"contained\" color=\"primary\" onClick={submitMessage}>\n â”Š47â”Š80â”Š        <SendIcon />\n â”Š48â”Š81â”Š      </SendButton>\n â”Š49â”Š82â”Š    </Container>\n```\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -1,5 +1,5 @@\n â”Š1â”Š1â”Šimport React from 'react';\n-â”Š2â”Š â”Šimport { useMemo, useState } from 'react';\n+â”Š â”Š2â”Šimport { useCallback, useMemo, useState } from 'react';\n â”Š3â”Š3â”Šimport styled from 'styled-components';\n â”Š4â”Š4â”Šimport ChatNavbar from './ChatNavbar';\n â”Š5â”Š5â”Šimport MessageInput from './MessageInput';\n```\n```diff\n@@ -71,13 +71,31 @@\n â”Š 71â”Š 71â”Š    setChat(chat);\n â”Š 72â”Š 72â”Š  }, [chatId]);\n â”Š 73â”Š 73â”Š\n+â”Š   â”Š 74â”Š  const onSendMessage = useCallback(\n+â”Š   â”Š 75â”Š    (content: string) => {\n+â”Š   â”Š 76â”Š      if (!chat) return null;\n+â”Š   â”Š 77â”Š\n+â”Š   â”Š 78â”Š      const message = {\n+â”Š   â”Š 79â”Š        id: (chat.messages.length + 10).toString(),\n+â”Š   â”Š 80â”Š        createdAt: new Date(),\n+â”Š   â”Š 81â”Š        content,\n+â”Š   â”Š 82â”Š      };\n+â”Š   â”Š 83â”Š\n+â”Š   â”Š 84â”Š      setChat({\n+â”Š   â”Š 85â”Š        ...chat,\n+â”Š   â”Š 86â”Š        messages: chat.messages.concat(message),\n+â”Š   â”Š 87â”Š      });\n+â”Š   â”Š 88â”Š    },\n+â”Š   â”Š 89â”Š    [chat]\n+â”Š   â”Š 90â”Š  );\n+â”Š   â”Š 91â”Š\n â”Š 74â”Š 92â”Š  if (!chat) return null;\n â”Š 75â”Š 93â”Š\n â”Š 76â”Š 94â”Š  return (\n â”Š 77â”Š 95â”Š    <Container>\n â”Š 78â”Š 96â”Š      <ChatNavbar chat={chat} history={history} />\n â”Š 79â”Š 97â”Š      {chat.messages && <MessagesList messages={chat.messages} />}\n-â”Š 80â”Š   â”Š      <MessageInput />\n+â”Š   â”Š 98â”Š      <MessageInput onSendMessage={onSendMessage} />\n â”Š 81â”Š 99â”Š    </Container>\n â”Š 82â”Š100â”Š  );\n â”Š 83â”Š101â”Š};\n```\n\n[}]: #\n\nThis is how the entire flow should look like:\n\n![flow-demo](https://user-images.githubusercontent.com/7648874/54739741-27012280-4bf4-11e9-97cb-c715482e2e70.gif)\n\nAn edge case that should be taken care of is when the messages list length in the view exceeds the length of the container,\nin which case we will have to scroll down to the bottom of the view.\nThis way we can keep track of the most recent message.\nWe will use `ReactDOM` to retrieve the native HTML element of the container and change the position of the scroller whenever a messages was sent:\n\n[{]: <helper> (diffStep 6.8 module=\"client\")\n\n#### [__Client__ Step 6.8: Reset scroller on message sent](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/e9eef0c91cf4dd3d3ada8d3a789821bd50ea535e)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;MessagesList.tsx\n```diff\n@@ -1,5 +1,7 @@\n â”Š1â”Š1â”Šimport moment from 'moment';\n â”Š2â”Š2â”Šimport React from 'react';\n+â”Š â”Š3â”Šimport { useEffect, useRef } from 'react';\n+â”Š â”Š4â”Šimport ReactDOM from 'react-dom';\n â”Š3â”Š5â”Šimport styled from 'styled-components';\n â”Š4â”Š6â”Šimport { ChatQueryMessage } from './index';\n â”Š5â”Š7â”Š\n```\n```diff\n@@ -64,15 +66,26 @@\n â”Š64â”Š66â”Š  messages: Array<ChatQueryMessage>;\n â”Š65â”Š67â”Š}\n â”Š66â”Š68â”Š\n-â”Š67â”Š  â”Šconst MessagesList: React.FC<MessagesListProps> = ({ messages }) => (\n-â”Š68â”Š  â”Š  <Container>\n-â”Š69â”Š  â”Š    {messages.map((message: any) => (\n-â”Š70â”Š  â”Š      <MessageItem key={message.id}>\n-â”Š71â”Š  â”Š        <Contents>{message.content}</Contents>\n-â”Š72â”Š  â”Š        <Timestamp>{moment(message.createdAt).format('HH:mm')}</Timestamp>\n-â”Š73â”Š  â”Š      </MessageItem>\n-â”Š74â”Š  â”Š    ))}\n-â”Š75â”Š  â”Š  </Container>\n-â”Š76â”Š  â”Š);\n+â”Š  â”Š69â”Šconst MessagesList: React.FC<MessagesListProps> = ({ messages }) => {\n+â”Š  â”Š70â”Š  const selfRef = useRef(null);\n+â”Š  â”Š71â”Š\n+â”Š  â”Š72â”Š  useEffect(() => {\n+â”Š  â”Š73â”Š    if (!selfRef.current) return;\n+â”Š  â”Š74â”Š\n+â”Š  â”Š75â”Š    const selfDOMNode = ReactDOM.findDOMNode(selfRef.current) as HTMLElement;\n+â”Š  â”Š76â”Š    selfDOMNode.scrollTop = Number.MAX_SAFE_INTEGER;\n+â”Š  â”Š77â”Š  }, [messages.length]);\n+â”Š  â”Š78â”Š\n+â”Š  â”Š79â”Š  return (\n+â”Š  â”Š80â”Š    <Container ref={selfRef}>\n+â”Š  â”Š81â”Š      {messages.map((message: any) => (\n+â”Š  â”Š82â”Š        <MessageItem key={message.id}>\n+â”Š  â”Š83â”Š          <Contents>{message.content}</Contents>\n+â”Š  â”Š84â”Š          <Timestamp>{moment(message.createdAt).format('HH:mm')}</Timestamp>\n+â”Š  â”Š85â”Š        </MessageItem>\n+â”Š  â”Š86â”Š      ))}\n+â”Š  â”Š87â”Š    </Container>\n+â”Š  â”Š88â”Š  );\n+â”Š  â”Š89â”Š};\n â”Š77â”Š90â”Š\n â”Š78â”Š91â”Šexport default MessagesList;\n```\n\n[}]: #\n\nBefore we wrap things up, we should also test our components.\nSince the new components have a direct control over the app's history,\nwe should also find a way to simulate it in our tests.\nBecause `react-dom-router` uses the [`history`](https://www.npmjs.com/package/history) package under the hood,\nthat means that we can use that package to inject a custom history object directly into the tested components:\n\n[{]: <helper> (diffStep 6.9 files=\"components\" module=\"client\")\n\n#### [__Client__ Step 6.9: Test ChatRoomScreen child components](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/ca8bb375307c36c608422220594206186966b212)\n\n##### Added src&#x2F;components&#x2F;ChatRoomScreen&#x2F;ChatNavbar.test.tsx\n```diff\n@@ -0,0 +1,79 @@\n+â”Š  â”Š 1â”Šimport { createMemoryHistory } from 'history';\n+â”Š  â”Š 2â”Šimport React from 'react';\n+â”Š  â”Š 3â”Šimport { cleanup, render, fireEvent, wait } from '@testing-library/react';\n+â”Š  â”Š 4â”Šimport ChatNavbar from './ChatNavbar';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šdescribe('ChatNavbar', () => {\n+â”Š  â”Š 7â”Š  afterEach(cleanup);\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Š  it('renders chat data', () => {\n+â”Š  â”Š10â”Š\n+â”Š  â”Š11â”Š    const time = new Date('1 Jan 2019 GMT');\n+â”Š  â”Š12â”Š    const chat = {\n+â”Š  â”Š13â”Š      id: '1',\n+â”Š  â”Š14â”Š      name: 'Foo Bar',\n+â”Š  â”Š15â”Š      picture: 'https://localhost:4000/picture.jpg',\n+â”Š  â”Š16â”Š      messages: [\n+â”Š  â”Š17â”Š        {\n+â”Š  â”Š18â”Š          id: '1',\n+â”Š  â”Š19â”Š          content: 'foo',\n+â”Š  â”Š20â”Š          createdAt: time,\n+â”Š  â”Š21â”Š        },\n+â”Š  â”Š22â”Š        {\n+â”Š  â”Š23â”Š          id: '2',\n+â”Š  â”Š24â”Š          content: 'bar',\n+â”Š  â”Š25â”Š          createdAt: time,\n+â”Š  â”Š26â”Š        },\n+â”Š  â”Š27â”Š      ]\n+â”Š  â”Š28â”Š    };\n+â”Š  â”Š29â”Š\n+â”Š  â”Š30â”Š    const history = createMemoryHistory();\n+â”Š  â”Š31â”Š\n+â”Š  â”Š32â”Š    {\n+â”Š  â”Š33â”Š      const { container, getByTestId } = render(<ChatNavbar chat={chat} history={history}/>);\n+â”Š  â”Š34â”Š\n+â”Š  â”Š35â”Š      expect(getByTestId('chat-name')).toHaveTextContent('Foo Bar');\n+â”Š  â”Š36â”Š      expect(getByTestId('chat-picture')).toHaveAttribute(\n+â”Š  â”Š37â”Š        'src',\n+â”Š  â”Š38â”Š        'https://localhost:4000/picture.jpg'\n+â”Š  â”Š39â”Š      );\n+â”Š  â”Š40â”Š    }\n+â”Š  â”Š41â”Š  });\n+â”Š  â”Š42â”Š\n+â”Š  â”Š43â”Š  it('goes back on arrow click', async () => {\n+â”Š  â”Š44â”Š    const time = new Date('1 Jan 2019 GMT');\n+â”Š  â”Š45â”Š    const chat = {\n+â”Š  â”Š46â”Š      id: '1',\n+â”Š  â”Š47â”Š      name: 'Foo Bar',\n+â”Š  â”Š48â”Š      picture: 'https://localhost:4000/picture.jpg',\n+â”Š  â”Š49â”Š      messages: [\n+â”Š  â”Š50â”Š        {\n+â”Š  â”Š51â”Š          id: '1',\n+â”Š  â”Š52â”Š          content: 'foo',\n+â”Š  â”Š53â”Š          createdAt: time,\n+â”Š  â”Š54â”Š        },\n+â”Š  â”Š55â”Š        {\n+â”Š  â”Š56â”Š          id: '2',\n+â”Š  â”Š57â”Š          content: 'bar',\n+â”Š  â”Š58â”Š          createdAt: time,\n+â”Š  â”Š59â”Š        },\n+â”Š  â”Š60â”Š      ]\n+â”Š  â”Š61â”Š    };\n+â”Š  â”Š62â”Š\n+â”Š  â”Š63â”Š    const history = createMemoryHistory();\n+â”Š  â”Š64â”Š\n+â”Š  â”Š65â”Š    history.push('/chats/1');\n+â”Š  â”Š66â”Š\n+â”Š  â”Š67â”Š    await wait(() => expect(history.location.pathname).toEqual('/chats/1'));\n+â”Š  â”Š68â”Š\n+â”Š  â”Š69â”Š    {\n+â”Š  â”Š70â”Š      const { container, getByTestId } = render(\n+â”Š  â”Š71â”Š        <ChatNavbar chat={chat} history={history} />\n+â”Š  â”Š72â”Š      );\n+â”Š  â”Š73â”Š\n+â”Š  â”Š74â”Š      fireEvent.click(getByTestId('back-button'));\n+â”Š  â”Š75â”Š\n+â”Š  â”Š76â”Š      await wait(() => expect(history.location.pathname).toEqual('/chats'));\n+â”Š  â”Š77â”Š    }\n+â”Š  â”Š78â”Š  });\n+â”Š  â”Š79â”Š});\n```\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;ChatNavbar.tsx\n```diff\n@@ -47,11 +47,11 @@\n â”Š47â”Š47â”Š\n â”Š48â”Š48â”Š  return (\n â”Š49â”Š49â”Š    <Container>\n-â”Š50â”Š  â”Š      <BackButton onClick={navBack}>\n+â”Š  â”Š50â”Š      <BackButton data-testid=\"back-button\" onClick={navBack}>\n â”Š51â”Š51â”Š        <ArrowBackIcon />\n â”Š52â”Š52â”Š      </BackButton>\n-â”Š53â”Š  â”Š      <Picture src={chat.picture} />\n-â”Š54â”Š  â”Š      <Name>{chat.name}</Name>\n+â”Š  â”Š53â”Š      <Picture data-testid=\"chat-picture\" src={chat.picture} />\n+â”Š  â”Š54â”Š      <Name data-testid=\"chat-name\">{chat.name}</Name>\n â”Š55â”Š55â”Š    </Container>\n â”Š56â”Š56â”Š  );\n â”Š57â”Š57â”Š};\n```\n\n##### Added src&#x2F;components&#x2F;ChatRoomScreen&#x2F;MessageInput.test.tsx\n```diff\n@@ -0,0 +1,57 @@\n+â”Š  â”Š 1â”Šimport { createMemoryHistory } from 'history';\n+â”Š  â”Š 2â”Šimport React from 'react';\n+â”Š  â”Š 3â”Šimport {\n+â”Š  â”Š 4â”Š  cleanup,\n+â”Š  â”Š 5â”Š  render,\n+â”Š  â”Š 6â”Š  fireEvent,\n+â”Š  â”Š 7â”Š  wait,\n+â”Š  â”Š 8â”Š  waitForElement,\n+â”Š  â”Š 9â”Š} from '@testing-library/react';\n+â”Š  â”Š10â”Šimport MessageInput from './MessageInput';\n+â”Š  â”Š11â”Š\n+â”Š  â”Š12â”Šdescribe('MessageInput;', () => {\n+â”Š  â”Š13â”Š  afterEach(cleanup);\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”Š  it('triggers callback on send button click', async () => {\n+â”Š  â”Š16â”Š    const onSendMessage = jest.fn(() => {});\n+â”Š  â”Š17â”Š\n+â”Š  â”Š18â”Š    {\n+â”Š  â”Š19â”Š      const { container, getByTestId } = render(\n+â”Š  â”Š20â”Š        <MessageInput onSendMessage={onSendMessage} />\n+â”Š  â”Š21â”Š      );\n+â”Š  â”Š22â”Š      const messageInput = getByTestId('message-input');\n+â”Š  â”Š23â”Š      const sendButton = getByTestId('send-button');\n+â”Š  â”Š24â”Š\n+â”Š  â”Š25â”Š      fireEvent.change(messageInput, { target: { value: 'foo' } });\n+â”Š  â”Š26â”Š\n+â”Š  â”Š27â”Š      await waitForElement(() => messageInput);\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š      fireEvent.click(sendButton);\n+â”Š  â”Š30â”Š\n+â”Š  â”Š31â”Š      await wait(() => expect(onSendMessage.mock.calls.length).toBe(1));\n+â”Š  â”Š32â”Š    }\n+â”Š  â”Š33â”Š  });\n+â”Š  â”Š34â”Š\n+â”Š  â”Š35â”Š  it('triggers callback on Enter press', async () => {\n+â”Š  â”Š36â”Š    const onSendMessage = jest.fn(() => {});\n+â”Š  â”Š37â”Š\n+â”Š  â”Š38â”Š    {\n+â”Š  â”Š39â”Š      const { container, getByTestId } = render(\n+â”Š  â”Š40â”Š        <MessageInput onSendMessage={onSendMessage} />\n+â”Š  â”Š41â”Š      );\n+â”Š  â”Š42â”Š      const messageInput = getByTestId('message-input');\n+â”Š  â”Š43â”Š\n+â”Š  â”Š44â”Š      fireEvent.change(messageInput, { target: { value: 'foo' } });\n+â”Š  â”Š45â”Š\n+â”Š  â”Š46â”Š      await waitForElement(() => messageInput);\n+â”Š  â”Š47â”Š\n+â”Š  â”Š48â”Š      fireEvent.keyPress(messageInput, {\n+â”Š  â”Š49â”Š        key: 'Enter',\n+â”Š  â”Š50â”Š        code: 13,\n+â”Š  â”Š51â”Š        charCode: 13,\n+â”Š  â”Š52â”Š      });\n+â”Š  â”Š53â”Š\n+â”Š  â”Š54â”Š      await wait(() => expect(onSendMessage.mock.calls.length).toBe(1));\n+â”Š  â”Š55â”Š    }\n+â”Š  â”Š56â”Š  });\n+â”Š  â”Š57â”Š});\n```\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;MessageInput.tsx\n```diff\n@@ -70,13 +70,18 @@\n â”Š70â”Š70â”Š  return (\n â”Š71â”Š71â”Š    <Container>\n â”Š72â”Š72â”Š      <ActualInput\n+â”Š  â”Š73â”Š        data-testid=\"message-input\"\n â”Š73â”Š74â”Š        type=\"text\"\n â”Š74â”Š75â”Š        placeholder=\"Type a message\"\n â”Š75â”Š76â”Š        value={message}\n â”Š76â”Š77â”Š        onKeyPress={onKeyPress}\n â”Š77â”Š78â”Š        onChange={onChange}\n â”Š78â”Š79â”Š      />\n-â”Š79â”Š  â”Š      <SendButton variant=\"contained\" color=\"primary\" onClick={submitMessage}>\n+â”Š  â”Š80â”Š      <SendButton\n+â”Š  â”Š81â”Š        data-testid=\"send-button\"\n+â”Š  â”Š82â”Š        variant=\"contained\"\n+â”Š  â”Š83â”Š        color=\"primary\"\n+â”Š  â”Š84â”Š        onClick={submitMessage}>\n â”Š80â”Š85â”Š        <SendIcon />\n â”Š81â”Š86â”Š      </SendButton>\n â”Š82â”Š87â”Š    </Container>\n```\n\n##### Added src&#x2F;components&#x2F;ChatRoomScreen&#x2F;MessagesList.test.tsx\n```diff\n@@ -0,0 +1,47 @@\n+â”Š  â”Š 1â”Šimport { createMemoryHistory } from 'history';\n+â”Š  â”Š 2â”Šimport React from 'react';\n+â”Š  â”Š 3â”Šimport {\n+â”Š  â”Š 4â”Š  cleanup,\n+â”Š  â”Š 5â”Š  render,\n+â”Š  â”Š 6â”Š  fireEvent,\n+â”Š  â”Š 7â”Š  wait,\n+â”Š  â”Š 8â”Š  getByTestId,\n+â”Š  â”Š 9â”Š} from '@testing-library/react';\n+â”Š  â”Š10â”Šimport MessagesList from './MessagesList';\n+â”Š  â”Š11â”Š\n+â”Š  â”Š12â”Šdescribe('MessagesList', () => {\n+â”Š  â”Š13â”Š  afterEach(cleanup);\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”Š  const time = new Date('1 Jan 2019 GMT');\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š  it('renders messages data', () => {\n+â”Š  â”Š18â”Š    const messages = [\n+â”Š  â”Š19â”Š      {\n+â”Š  â”Š20â”Š        id: '1',\n+â”Š  â”Š21â”Š        content: 'foo',\n+â”Š  â”Š22â”Š        createdAt: time,\n+â”Š  â”Š23â”Š      },\n+â”Š  â”Š24â”Š      {\n+â”Š  â”Š25â”Š        id: '2',\n+â”Š  â”Š26â”Š        content: 'bar',\n+â”Š  â”Š27â”Š        createdAt: time,\n+â”Š  â”Š28â”Š      },\n+â”Š  â”Š29â”Š    ];\n+â”Š  â”Š30â”Š\n+â”Š  â”Š31â”Š    let message1, message2;\n+â”Š  â”Š32â”Š    {\n+â”Š  â”Š33â”Š      const { container, getAllByTestId, getByTestId } = render(\n+â”Š  â”Š34â”Š        <MessagesList messages={messages} />\n+â”Š  â”Š35â”Š      );\n+â”Š  â”Š36â”Š      const match = getAllByTestId('message-item');\n+â”Š  â”Š37â”Š      message1 = match[0];\n+â”Š  â”Š38â”Š      message2 = match[1];\n+â”Š  â”Š39â”Š    }\n+â”Š  â”Š40â”Š\n+â”Š  â”Š41â”Š    expect(getByTestId(message1, 'message-content')).toHaveTextContent('foo');\n+â”Š  â”Š42â”Š    expect(getByTestId(message1, 'message-date')).toHaveTextContent('02:00');\n+â”Š  â”Š43â”Š\n+â”Š  â”Š44â”Š    expect(getByTestId(message2, 'message-content')).toHaveTextContent('bar');\n+â”Š  â”Š45â”Š    expect(getByTestId(message2, 'message-date')).toHaveTextContent('02:00');\n+â”Š  â”Š46â”Š  });\n+â”Š  â”Š47â”Š});\n```\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;MessagesList.tsx\n```diff\n@@ -79,9 +79,11 @@\n â”Š79â”Š79â”Š  return (\n â”Š80â”Š80â”Š    <Container ref={selfRef}>\n â”Š81â”Š81â”Š      {messages.map((message: any) => (\n-â”Š82â”Š  â”Š        <MessageItem key={message.id}>\n-â”Š83â”Š  â”Š          <Contents>{message.content}</Contents>\n-â”Š84â”Š  â”Š          <Timestamp>{moment(message.createdAt).format('HH:mm')}</Timestamp>\n+â”Š  â”Š82â”Š        <MessageItem data-testid=\"message-item\" key={message.id}>\n+â”Š  â”Š83â”Š          <Contents data-testid=\"message-content\">{message.content}</Contents>\n+â”Š  â”Š84â”Š          <Timestamp data-testid=\"message-date\">\n+â”Š  â”Š85â”Š            {moment(message.createdAt).format('HH:mm')}\n+â”Š  â”Š86â”Š          </Timestamp>\n â”Š85â”Š87â”Š        </MessageItem>\n â”Š86â”Š88â”Š      ))}\n â”Š87â”Š89â”Š    </Container>\n```\n\n[}]: #\n\nThere are many things which are incomplete in the current implementation. The functionality exists in the UI, but no messages are really being sent and stored in the database. In the next chapters we will learn how to:\n\n\n\n*   Cache query results with Apollo-Client.\n*   Send messages with GraphQL mutations\n\n--------\nTODO: Add this to router chapter - https://www.pluralsight.com/guides/react-router-typescript\nAnd this - https://stackoverflow.com/questions/49342390/typescript-how-to-add-type-check-for-history-object-in-react\n\nTODO: https://medium.com/@jrwebdev/react-higher-order-component-patterns-in-typescript-42278f7590fb\n\nTODO: https://www.cypress.io/blog/2019/05/13/code-create-react-app-v3-and-its-cypress-tests-using-typescript/#\n\nTODO: Schema says thereâ€™s always an array with messages, is it really true? Is newly created chat resolves an empty array, null will throw an error?\n\nTODO: Same thing with `chats: [Chat!]!`, do we always return an array here?\n\nTODO: _root and type all resolvers\n\nTODO: How to import schema together with jest, should I changed from ts-jest?\n\nTODO: remove all that part including the file in the commit\n\nTODO: Add all the new files and changes on 6.6\n\nTODO: Add all the new files and changes on 6.7"
          },
          {
            "manualTitle": "Step 7: Caching with Apollo-Client",
            "stepRevision": "4c9fd6075cce720f80b6ecc3dc669f06648652a7",
            "manualView": "In the previous step we've implemented a `ChatRoomScreen` where we were able to view each chat's messages list by clicking on a chat item from the main screen.\nIt all looks functional, however, there's a significant optimization issue - each time we navigate into a `ChatRoomScreen`,\nwe need to re-fetch the data related to the target chat.\n\nThe solution for that would be [caching](https://en.wikipedia.org/wiki/Cache_(computing)) the fetch result,\nso it can be re-used once we re-enter a screen that we've visited before.\nFor now things are fairly simple so the caching mechanism can be implemented manually,\nbut things are gonna get tougher when we add more queries or things like message sending and profile updating to the mix,\nso it's not gonna be an easy task.\n\nLuckily, in the Apollo team they've invented a solution that works right out of the box and integrates perfectly with Apollo-GraphQL server - [Apollo-GraphQL client](https://www.apollographql.com/docs/link/#apollo-client).\n\n\n![caching](https://user-images.githubusercontent.com/7648874/54871150-f505e100-4dea-11e9-9e2d-439fbf3eaebe.png)\n\n\n\nApollo-Client is a wrap around our GraphQL endpoint which essentially uses HTTP requests (and further on [web-sockets](https://en.wikipedia.org/wiki/WebSocket), but we will get there), something that we've implemented manually so far.\nNot only it can be used to fetch data, but it will also cache the result of the query so it can be seamlessly re-used when we request the same data.\nThis means that we will need to setup an Apollo-Client and replace all our `fetch()` calls with `client.query()` call.\nMore about Apollo-Client's API further in this tutorial, but let's start configuring it.\nFirst we will install few essential NPM packages:\n\n    $ yarn add apollo-client apollo-cache-inmemory apollo-link apollo-link-http\n\n\n\n*   [`apollo-client`](https://www.npmjs.com/package/apollo-client) - Apollo-Client's core package, as we explained earlier.\n*   [`apollo-cache-inmemory`](https://www.npmjs.com/package/apollo-cache-inmemory) - The data store that will be used to cache the results.\n*   [`apollo-link-http`](https://www.npmjs.com/package/apollo-link-http) - Get GraphQL results over a network using HTTP fetch.\n\nWe will create a new file in the `src` directory called `client.ts` and inside we will export the client:\n\n[{]: <helper> (diffStep 7.1 files=\"client\" module=\"client\")\n\n#### [__Client__ Step 7.1: Add Apollo client](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/29bc1d969ec984c052c75f640fde7aba69afd956)\n\n##### Added src&#x2F;client.ts\n```diff\n@@ -0,0 +1,16 @@\n+â”Š  â”Š 1â”Šimport { InMemoryCache } from 'apollo-cache-inmemory';\n+â”Š  â”Š 2â”Šimport { ApolloClient } from 'apollo-client';\n+â”Š  â”Š 3â”Šimport { HttpLink } from 'apollo-link-http';\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šconst httpUri = process.env.REACT_APP_SERVER_URL + '/graphql';\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Šconst httpLink = new HttpLink({\n+â”Š  â”Š 8â”Š  uri: httpUri,\n+â”Š  â”Š 9â”Š});\n+â”Š  â”Š10â”Š\n+â”Š  â”Š11â”Šconst inMemoryCache = new InMemoryCache();\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Šexport default new ApolloClient({\n+â”Š  â”Š14â”Š  link: httpLink,\n+â”Š  â”Š15â”Š  cache: inMemoryCache,\n+â”Š  â”Š16â”Š});\n```\n\n[}]: #\n\nAlthough the client can be used directly and integrated into any UI framework, it would be the most comfortable to use a wrap around it which is suitable for React.\nFor that we will use Apollo's React Hooks package called [`@apollo/react-hooks`](https://github.com/apollographql/react-apollo) which includes a set of\n[React hooks](https://reactjs.org/docs/hooks-intro.html) that can connect between our Apollo-Client and target React.Component:\n\n    $ yarn add @apollo/react-hooks graphql-tag graphql\n\nWith `@apollo/react-hooks` we can use the `useQuery()` hook to fetch data from our GraphQL API.\nThe `graphql-tag` package is used to parse the GraphQL string to an [AST](https://en.wikipedia.org/wiki/Abstract_syntax_tree),\nsomething which is required when using Apollo Client. Example:\n\n\n```\nimport gql from 'graphql-tag';\nimport { useQuery } from '@apollo/react-hooks';\n\nconst GET_DOGS = gql`\n  {\n    dogs {\n      id\n      breed\n    }\n  }\n`;\n\nconst Dogs = () => {\n  const { data, error, loading } = useQuery(GET_DOGS);\n  if (loading) {\n    return <div>Loading...</div>;\n  };\n  if (error) {\n    return <div>Error! {error.message}</div>;\n  };\n\n  return (\n    <ul>\n      {data.dogs.map(dog => (\n        <li key={dog.id}>{dog.breed}</li>\n      ))}\n    </ul>\n  );\n};\n```\n\n\nThe package requires a small setup so that imported hooks can use our Apollo-Client:\n\n[{]: <helper> (diffStep 7.2 files=\"index\" module=\"client\")\n\n#### [__Client__ Step 7.2: Provide Apollo client](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/497ccd0de62d80a49c8d45ecc62f81a575d845e9)\n\n##### Changed src&#x2F;index.tsx\n```diff\n@@ -1,8 +1,10 @@\n â”Š 1â”Š 1â”Šimport { MuiThemeProvider, createMuiTheme } from '@material-ui/core/styles';\n â”Š 2â”Š 2â”Šimport React from 'react';\n â”Š 3â”Š 3â”Šimport ReactDOM from 'react-dom';\n+â”Š  â”Š 4â”Šimport { ApolloProvider } from '@apollo/react-hooks';\n â”Š 4â”Š 5â”Šimport './index.css';\n â”Š 5â”Š 6â”Šimport App from './App';\n+â”Š  â”Š 7â”Šimport client from './client';\n â”Š 6â”Š 8â”Šimport * as serviceWorker from './serviceWorker';\n â”Š 7â”Š 9â”Š\n â”Š 8â”Š10â”Šconst theme = createMuiTheme({\n```\n```diff\n@@ -14,7 +16,9 @@\n â”Š14â”Š16â”Š\n â”Š15â”Š17â”ŠReactDOM.render(\n â”Š16â”Š18â”Š  <MuiThemeProvider theme={theme}>\n-â”Š17â”Š  â”Š    <App />\n+â”Š  â”Š19â”Š    <ApolloProvider client={client}>\n+â”Š  â”Š20â”Š      <App />\n+â”Š  â”Š21â”Š    </ApolloProvider>\n â”Š18â”Š22â”Š  </MuiThemeProvider>,\n â”Š19â”Š23â”Š  document.getElementById('root')\n â”Š20â”Š24â”Š);\n```\n\n[}]: #\n\nThe code above uses the [Context/Provider](https://reactjs.org/docs/context.html) API, thus the client is now known globally.\nNow that we can use the `useQuery()` hook, there's no need to use the native Fetch API anymore.\nLet's replace all our Fetch API call instances with a React hook:\n\n[{]: <helper> (diffStep 7.3 files=\"components\" module=\"client\")\n\n#### [__Client__ Step 7.3: Replace fetch() calls with Apollo useQuery()](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/3cb954b39a73f5a25866d9197b8f52d4786b0a11)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -1,5 +1,7 @@\n+â”Š â”Š1â”Šimport gql from 'graphql-tag';\n â”Š1â”Š2â”Šimport React from 'react';\n-â”Š2â”Š â”Šimport { useCallback, useMemo, useState } from 'react';\n+â”Š â”Š3â”Šimport { useCallback } from 'react';\n+â”Š â”Š4â”Šimport { useApolloClient, useQuery } from '@apollo/react-hooks';\n â”Š3â”Š5â”Šimport styled from 'styled-components';\n â”Š4â”Š6â”Šimport ChatNavbar from './ChatNavbar';\n â”Š5â”Š7â”Šimport MessageInput from './MessageInput';\n```\n```diff\n@@ -13,7 +15,7 @@\n â”Š13â”Š15â”Š  height: 100vh;\n â”Š14â”Š16â”Š`;\n â”Š15â”Š17â”Š\n-â”Š16â”Š  â”Šconst getChatQuery = `\n+â”Š  â”Š18â”Šconst getChatQuery = gql`\n â”Š17â”Š19â”Š  query GetChat($chatId: ID!) {\n â”Š18â”Š20â”Š    chat(chatId: $chatId) {\n â”Š19â”Š21â”Š      id\n```\n```diff\n@@ -52,24 +54,12 @@\n â”Š52â”Š54â”Š  history,\n â”Š53â”Š55â”Š  chatId,\n â”Š54â”Š56â”Š}) => {\n-â”Š55â”Š  â”Š  const [chat, setChat] = useState<OptionalChatQueryResult>(null);\n-â”Š56â”Š  â”Š\n-â”Š57â”Š  â”Š  useMemo(async () => {\n-â”Š58â”Š  â”Š    const body = await fetch(`${process.env.REACT_APP_SERVER_URL}/graphql`, {\n-â”Š59â”Š  â”Š      method: 'POST',\n-â”Š60â”Š  â”Š      headers: {\n-â”Š61â”Š  â”Š        'Content-Type': 'application/json',\n-â”Š62â”Š  â”Š      },\n-â”Š63â”Š  â”Š      body: JSON.stringify({\n-â”Š64â”Š  â”Š        query: getChatQuery,\n-â”Š65â”Š  â”Š        variables: { chatId },\n-â”Š66â”Š  â”Š      }),\n-â”Š67â”Š  â”Š    });\n-â”Š68â”Š  â”Š    const {\n-â”Š69â”Š  â”Š      data: { chat },\n-â”Š70â”Š  â”Š    } = await body.json();\n-â”Š71â”Š  â”Š    setChat(chat);\n-â”Š72â”Š  â”Š  }, [chatId]);\n+â”Š  â”Š57â”Š  const client = useApolloClient();\n+â”Š  â”Š58â”Š  const {\n+â”Š  â”Š59â”Š    data: { chat },\n+â”Š  â”Š60â”Š  } = useQuery<any>(getChatQuery, {\n+â”Š  â”Š61â”Š    variables: { chatId },\n+â”Š  â”Š62â”Š  });\n â”Š73â”Š63â”Š\n â”Š74â”Š64â”Š  const onSendMessage = useCallback(\n â”Š75â”Š65â”Š    (content: string) => {\n```\n```diff\n@@ -79,14 +69,21 @@\n â”Š79â”Š69â”Š        id: (chat.messages.length + 10).toString(),\n â”Š80â”Š70â”Š        createdAt: new Date(),\n â”Š81â”Š71â”Š        content,\n+â”Š  â”Š72â”Š        __typename: 'Chat',\n â”Š82â”Š73â”Š      };\n â”Š83â”Š74â”Š\n-â”Š84â”Š  â”Š      setChat({\n-â”Š85â”Š  â”Š        ...chat,\n-â”Š86â”Š  â”Š        messages: chat.messages.concat(message),\n+â”Š  â”Š75â”Š      client.writeQuery({\n+â”Š  â”Š76â”Š        query: getChatQuery,\n+â”Š  â”Š77â”Š        variables: { chatId },\n+â”Š  â”Š78â”Š        data: {\n+â”Š  â”Š79â”Š          chat: {\n+â”Š  â”Š80â”Š            ...chat,\n+â”Š  â”Š81â”Š            messages: chat.messages.concat(message),\n+â”Š  â”Š82â”Š          },\n+â”Š  â”Š83â”Š        },\n â”Š87â”Š84â”Š      });\n â”Š88â”Š85â”Š    },\n-â”Š89â”Š  â”Š    [chat]\n+â”Š  â”Š86â”Š    [chat, chatId, client]\n â”Š90â”Š87â”Š  );\n â”Š91â”Š88â”Š\n â”Š92â”Š89â”Š  if (!chat) return null;\n```\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -2,8 +2,10 @@\n â”Š 2â”Š 2â”Šimport moment from 'moment';\n â”Š 3â”Š 3â”Šimport { List, ListItem } from '@material-ui/core';\n â”Š 4â”Š 4â”Šimport styled from 'styled-components';\n-â”Š 5â”Š  â”Šimport { useCallback, useState, useMemo } from 'react';\n+â”Š  â”Š 5â”Šimport { useCallback } from 'react';\n â”Š 6â”Š 6â”Šimport { History } from 'history';\n+â”Š  â”Š 7â”Šimport gql from 'graphql-tag';\n+â”Š  â”Š 8â”Šimport { useQuery } from '@apollo/react-hooks';\n â”Š 7â”Š 9â”Š\n â”Š 8â”Š10â”Šconst Container = styled.div`\n â”Š 9â”Š11â”Š  height: calc(100% - 56px);\n```\n```diff\n@@ -57,7 +59,7 @@\n â”Š57â”Š59â”Š  font-size: 13px;\n â”Š58â”Š60â”Š`;\n â”Š59â”Š61â”Š\n-â”Š60â”Š  â”Šconst getChatsQuery = `\n+â”Š  â”Š62â”Šconst getChatsQuery = gql`\n â”Š61â”Š63â”Š  query GetChats {\n â”Š62â”Š64â”Š    chats {\n â”Š63â”Š65â”Š      id\n```\n```diff\n@@ -77,21 +79,7 @@\n â”Š77â”Š79â”Š}\n â”Š78â”Š80â”Š\n â”Š79â”Š81â”Šconst ChatsList: React.FC<ChatsListProps> = ({ history }) => {\n-â”Š80â”Š  â”Š  const [chats, setChats] = useState<any[]>([]);\n-â”Š81â”Š  â”Š\n-â”Š82â”Š  â”Š  useMemo(async () => {\n-â”Š83â”Š  â”Š    const body = await fetch(`${process.env.REACT_APP_SERVER_URL}/graphql`, {\n-â”Š84â”Š  â”Š      method: 'POST',\n-â”Š85â”Š  â”Š      headers: {\n-â”Š86â”Š  â”Š        'Content-Type': 'application/json',\n-â”Š87â”Š  â”Š      },\n-â”Š88â”Š  â”Š      body: JSON.stringify({ query: getChatsQuery }),\n-â”Š89â”Š  â”Š    });\n-â”Š90â”Š  â”Š    const {\n-â”Š91â”Š  â”Š      data: { chats },\n-â”Š92â”Š  â”Š    } = await body.json();\n-â”Š93â”Š  â”Š    setChats(chats);\n-â”Š94â”Š  â”Š  }, []);\n+â”Š  â”Š82â”Š  const { data } = useQuery<any>(getChatsQuery);\n â”Š95â”Š83â”Š\n â”Š96â”Š84â”Š  const navToChat = useCallback(\n â”Š97â”Š85â”Š    chat => {\n```\n```diff\n@@ -100,10 +88,15 @@\n â”Š100â”Š 88â”Š    [history]\n â”Š101â”Š 89â”Š  );\n â”Š102â”Š 90â”Š\n+â”Š   â”Š 91â”Š  if (data === undefined || data.chats === undefined) {\n+â”Š   â”Š 92â”Š    return null;\n+â”Š   â”Š 93â”Š  }\n+â”Š   â”Š 94â”Š  let chats = data.chats;\n+â”Š   â”Š 95â”Š\n â”Š103â”Š 96â”Š  return (\n â”Š104â”Š 97â”Š    <Container>\n â”Š105â”Š 98â”Š      <StyledList>\n-â”Š106â”Š   â”Š        {chats.map(chat => (\n+â”Š   â”Š 99â”Š        {chats.map((chat: any) => (\n â”Š107â”Š100â”Š          <StyledListItem\n â”Š108â”Š101â”Š            key={chat.id}\n â”Š109â”Š102â”Š            data-testid=\"chat\"\n```\n\n[}]: #\n\nYou can see that we've fetched the query using Apollo client, and we removed the `setChat` call because Apollo will know automatically to place the results in the cache.\n\nAnd you can see we can also work directly with the cache.\n\nOn the `OnSendMessage` function we take the new message and push it to Apollo Client's cache.\n\nNow if we'll scroll to another screen and come back, the messages will still be displayed there.\n\nYou can see that we've added the `__typename` when we push a new chat to the cache.\nThat's how Apollo Client knows where to place the results.\n\nThe replacement is finished. Note that we removed the usage of `useMemo()` - because Apollo has an internal cache mechanism, there's no need to memoize the result anymore.\nWe also used the [`writeQuery()`](https://www.apollographql.com/docs/react/features/caching.html#writequery-and-writefragment) method to edit the stored result in the cache, so in the next render phase we would have an updated chat with the newly added message.\n\nWe shouldn't see any change at all in the view and the response time, since we're running it locally, but if we will take a look at the `network` tab in the browser's dev-tools we should notice the differences:\n\n**before**\n\n![fetch](https://user-images.githubusercontent.com/7648874/54871305-e5879780-4dec-11e9-87bb-3279e9e18342.png)\n\n**after**\n\n![apollo](https://user-images.githubusercontent.com/7648874/54871319-1bc51700-4ded-11e9-9001-d5518bedf9ad.png)\n\n> Above: ChatsListScreen -> ChatRoomScreen -> ChatsListScreen -> ChatRoomScreen\n\nThis test is obviously very rough, but the deviation is so big that you don't need any accuracy to emphasize the difference.\nThe blue stripes represents the requests made and the time they took. Before we had about 6 request phases, while after we had only 3 of them.\n\nSince we don't use the Fetch API anymore, we will also need to update our tests.\nRight now we mock the response from the fetch API, but a more appropriate way would be creating a fake Apollo Client where we will be able to mock the results.\nFor that we will install a package called [`apollo-link-mock`](https://www.npmjs.com/package/apollo-link-mock):\n\n    $ yarn add --dev apollo-link-mock\n\nAnd we will create a `test-helpers.ts` file under the `src` directory that will contain the utility function for creating a fake Apollo Client:\n\n[{]: <helper> (diffStep 7.4 files=\"test-helpers\" module=\"client\")\n\n#### [__Client__ Step 7.4: Mock Apollo requests in tests](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/d33ab1d68df53f3b424c986410b8259dfc04f1a1)\n\n##### Added src&#x2F;test-helpers.ts\n```diff\n@@ -0,0 +1,10 @@\n+â”Š  â”Š 1â”Šimport { InMemoryCache } from 'apollo-cache-inmemory';\n+â”Š  â”Š 2â”Šimport { ApolloClient } from 'apollo-client';\n+â”Š  â”Š 3â”Šimport { MockLink } from 'apollo-link-mock';\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šexport const mockApolloClient = (mocks: any) => {\n+â”Š  â”Š 6â”Š  return new ApolloClient({\n+â”Š  â”Š 7â”Š    cache: new InMemoryCache(),\n+â”Š  â”Š 8â”Š    link: new MockLink(mocks),\n+â”Š  â”Š 9â”Š  });\n+â”Š  â”Š10â”Š};\n```\n\n[}]: #\n\nThe fake client accepts an array of mocks where each mock object will have a `request` key that will contain details about the request and a `result` key which will contain the mocked result.\nYou should get a better understanding of how it works now that we will replace the fake Fetch calls with fake Apollo Clients:\n\n[{]: <helper> (diffStep 7.4 files=\"src/components\" module=\"client\")\n\n#### [__Client__ Step 7.4: Mock Apollo requests in tests](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/d33ab1d68df53f3b424c986410b8259dfc04f1a1)\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.test.tsx\n```diff\n@@ -1,4 +1,5 @@\n â”Š1â”Š1â”Šimport React from 'react';\n+â”Š â”Š2â”Šimport { ApolloProvider } from '@apollo/react-hooks';\n â”Š2â”Š3â”Šimport ReactDOM from 'react-dom';\n â”Š3â”Š4â”Šimport {\n â”Š4â”Š5â”Š  cleanup,\n```\n```diff\n@@ -7,8 +8,9 @@\n â”Š 7â”Š 8â”Š  wait,\n â”Š 8â”Š 9â”Š  waitForDomChange,\n â”Š 9â”Š10â”Š} from '@testing-library/react';\n-â”Š10â”Š  â”Šimport ChatsList from './ChatsList';\n â”Š11â”Š11â”Šimport { createBrowserHistory } from 'history';\n+â”Š  â”Š12â”Šimport { mockApolloClient } from '../../test-helpers';\n+â”Š  â”Š13â”Šimport ChatsList, { getChatsQuery } from './ChatsList';\n â”Š12â”Š14â”Š\n â”Š13â”Š15â”Šdescribe('ChatsList', () => {\n â”Š14â”Š16â”Š  afterEach(() => {\n```\n```diff\n@@ -21,27 +23,38 @@\n â”Š21â”Š23â”Š  });\n â”Š22â”Š24â”Š\n â”Š23â”Š25â”Š  it('renders fetched chats data', async () => {\n-â”Š24â”Š  â”Š    fetchMock.mockResponseOnce(\n-â”Š25â”Š  â”Š      JSON.stringify({\n-â”Š26â”Š  â”Š        data: {\n-â”Š27â”Š  â”Š          chats: [\n-â”Š28â”Š  â”Š            {\n-â”Š29â”Š  â”Š              id: 1,\n-â”Š30â”Š  â”Š              name: 'Foo Bar',\n-â”Š31â”Š  â”Š              picture: 'https://localhost:4000/picture.jpg',\n-â”Š32â”Š  â”Š              lastMessage: {\n+â”Š  â”Š26â”Š    const client = mockApolloClient([\n+â”Š  â”Š27â”Š      {\n+â”Š  â”Š28â”Š        request: { query: getChatsQuery },\n+â”Š  â”Š29â”Š        result: {\n+â”Š  â”Š30â”Š          data: {\n+â”Š  â”Š31â”Š            chats: [\n+â”Š  â”Š32â”Š              {\n+â”Š  â”Š33â”Š                __typename: 'Chat',\n â”Š33â”Š34â”Š                id: 1,\n-â”Š34â”Š  â”Š                content: 'Hello',\n-â”Š35â”Š  â”Š                createdAt: new Date('1 Jan 2019 GMT'),\n+â”Š  â”Š35â”Š                name: 'Foo Bar',\n+â”Š  â”Š36â”Š                picture: 'https://localhost:4000/picture.jpg',\n+â”Š  â”Š37â”Š                lastMessage: {\n+â”Š  â”Š38â”Š                  __typename: 'Message',\n+â”Š  â”Š39â”Š                  id: 1,\n+â”Š  â”Š40â”Š                  content: 'Hello',\n+â”Š  â”Š41â”Š                  createdAt: new Date('1 Jan 2019 GMT'),\n+â”Š  â”Š42â”Š                },\n â”Š36â”Š43â”Š              },\n-â”Š37â”Š  â”Š            },\n-â”Š38â”Š  â”Š          ],\n+â”Š  â”Š44â”Š            ],\n+â”Š  â”Š45â”Š          },\n â”Š39â”Š46â”Š        },\n-â”Š40â”Š  â”Š      })\n-â”Š41â”Š  â”Š    );\n+â”Š  â”Š47â”Š      },\n+â”Š  â”Š48â”Š    ]);\n+â”Š  â”Š49â”Š\n+â”Š  â”Š50â”Š    const history = createBrowserHistory();\n â”Š42â”Š51â”Š\n â”Š43â”Š52â”Š    {\n-â”Š44â”Š  â”Š      const { container, getByTestId } = render(<ChatsList />);\n+â”Š  â”Š53â”Š      const { container, getByTestId } = render(\n+â”Š  â”Š54â”Š        <ApolloProvider client={client}>\n+â”Š  â”Š55â”Š          <ChatsList history={history}/>\n+â”Š  â”Š56â”Š        </ApolloProvider>\n+â”Š  â”Š57â”Š      );\n â”Š45â”Š58â”Š\n â”Š46â”Š59â”Š      await waitForDomChange({ container });\n â”Š47â”Š60â”Š\n```\n```diff\n@@ -56,30 +69,37 @@\n â”Š 56â”Š 69â”Š  });\n â”Š 57â”Š 70â”Š\n â”Š 58â”Š 71â”Š  it('should navigate to the target chat room on chat item click', async () => {\n-â”Š 59â”Š   â”Š    fetchMock.mockResponseOnce(\n-â”Š 60â”Š   â”Š      JSON.stringify({\n-â”Š 61â”Š   â”Š        data: {\n-â”Š 62â”Š   â”Š          chats: [\n-â”Š 63â”Š   â”Š            {\n-â”Š 64â”Š   â”Š              id: 1,\n-â”Š 65â”Š   â”Š              name: 'Foo Bar',\n-â”Š 66â”Š   â”Š              picture: 'https://localhost:4000/picture.jpg',\n-â”Š 67â”Š   â”Š              lastMessage: {\n+â”Š   â”Š 72â”Š    const client = mockApolloClient([\n+â”Š   â”Š 73â”Š      {\n+â”Š   â”Š 74â”Š        request: { query: getChatsQuery },\n+â”Š   â”Š 75â”Š        result: {\n+â”Š   â”Š 76â”Š          data: {\n+â”Š   â”Š 77â”Š            chats: [\n+â”Š   â”Š 78â”Š              {\n+â”Š   â”Š 79â”Š                __typename: 'Chat',\n â”Š 68â”Š 80â”Š                id: 1,\n-â”Š 69â”Š   â”Š                content: 'Hello',\n-â”Š 70â”Š   â”Š                createdAt: new Date('1 Jan 2019 GMT'),\n+â”Š   â”Š 81â”Š                name: 'Foo Bar',\n+â”Š   â”Š 82â”Š                picture: 'https://localhost:4000/picture.jpg',\n+â”Š   â”Š 83â”Š                lastMessage: {\n+â”Š   â”Š 84â”Š                  __typename: 'Message',\n+â”Š   â”Š 85â”Š                  id: 1,\n+â”Š   â”Š 86â”Š                  content: 'Hello',\n+â”Š   â”Š 87â”Š                  createdAt: new Date('1 Jan 2019 GMT'),\n+â”Š   â”Š 88â”Š                },\n â”Š 71â”Š 89â”Š              },\n-â”Š 72â”Š   â”Š            },\n-â”Š 73â”Š   â”Š          ],\n+â”Š   â”Š 90â”Š            ],\n+â”Š   â”Š 91â”Š          },\n â”Š 74â”Š 92â”Š        },\n-â”Š 75â”Š   â”Š      })\n-â”Š 76â”Š   â”Š    );\n+â”Š   â”Š 93â”Š      },\n+â”Š   â”Š 94â”Š    ]);\n â”Š 77â”Š 95â”Š\n â”Š 78â”Š 96â”Š    const history = createBrowserHistory();\n â”Š 79â”Š 97â”Š\n â”Š 80â”Š 98â”Š    {\n â”Š 81â”Š 99â”Š      const { container, getByTestId } = render(\n-â”Š 82â”Š   â”Š        <ChatsList history={history} />\n+â”Š   â”Š100â”Š        <ApolloProvider client={client}>\n+â”Š   â”Š101â”Š          <ChatsList history={history} />\n+â”Š   â”Š102â”Š        </ApolloProvider>\n â”Š 83â”Š103â”Š      );\n â”Š 84â”Š104â”Š\n â”Š 85â”Š105â”Š      await waitForDomChange({ container });\n```\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -59,7 +59,7 @@\n â”Š59â”Š59â”Š  font-size: 13px;\n â”Š60â”Š60â”Š`;\n â”Š61â”Š61â”Š\n-â”Š62â”Š  â”Šconst getChatsQuery = gql`\n+â”Š  â”Š62â”Šexport const getChatsQuery = gql`\n â”Š63â”Š63â”Š  query GetChats {\n â”Š64â”Š64â”Š    chats {\n â”Š65â”Š65â”Š      id\n```\n\n[}]: #\n\nWe are telling Apollo mock to give a certain result each time it gets a specific query.\n\nNote how we used the `ApolloProvider` component to provide the target component with the fake Apollo Client.\nLike so, any other component which uses Apollo Client should be wrapped with an ApolloProvider when rendering it, otherwise it will not function as intended:\n\n[{]: <helper> (diffStep 7.4 files=\"src/App\" module=\"client\")\n\n#### [__Client__ Step 7.4: Mock Apollo requests in tests](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/d33ab1d68df53f3b424c986410b8259dfc04f1a1)\n\n##### Changed src&#x2F;App.test.tsx\n```diff\n@@ -1,9 +1,18 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n+â”Š  â”Š 2â”Šimport { ApolloProvider } from '@apollo/react-hooks';\n â”Š 2â”Š 3â”Šimport ReactDOM from 'react-dom';\n â”Š 3â”Š 4â”Šimport App from './App';\n+â”Š  â”Š 5â”Šimport { mockApolloClient } from './test-helpers';\n â”Š 4â”Š 6â”Š\n â”Š 5â”Š 7â”Šit('renders without crashing', () => {\n+â”Š  â”Š 8â”Š  const client = mockApolloClient();\n â”Š 6â”Š 9â”Š  const div = document.createElement('div');\n-â”Š 7â”Š  â”Š  ReactDOM.render(<App />, div);\n+â”Š  â”Š10â”Š\n+â”Š  â”Š11â”Š  ReactDOM.render(\n+â”Š  â”Š12â”Š    <ApolloProvider client={client}>\n+â”Š  â”Š13â”Š      <App />\n+â”Š  â”Š14â”Š    </ApolloProvider>,\n+â”Š  â”Š15â”Š    div\n+â”Š  â”Š16â”Š  );\n â”Š 8â”Š17â”Š  ReactDOM.unmountComponentAtNode(div);\n â”Š 9â”Š18â”Š});\n```\n\n[}]: #\n\nThat's it for this chapter. There's one thing missing to make our `ChatRoomScreen` functional and that would be actually sending a message to the backend and updating the DB. In the next chapter we will learn how to do exactly that with our new Apollo-Client.\n\n\n--------------------\n\nTODO: Change the whole intro.\n\nTODO: I think we might want to explain the cache in more details\nhow itâ€™s normalized\nhow some parts update automatically and some do not\nwhatâ€™s the smallest unit stored in the cache\nand other stuff\nthis might help later on with optimistic responses and mutations in general\n\nTODO: Remove all label code\n\nTODO: Create a drawing of the cache.\nTODO: Change typename from Chat to Message\n\nTODO: Explain a bit about Apollo links."
          },
          {
            "manualTitle": "Step 8: Sending messages with GraphQL mutations",
            "stepRevision": "eeddb5bcd82d2f8683ada87f66669d4a1fb4fa42",
            "manualView": "The view and the functionality for updating the component's state when sending a message already exists.\nThe thing is that messages are not really being sent, we only update the memory in the client.\n\nIf so, how exactly can we send messages and store them in the DB? For this purpose we're gonna learn about GraphQL mutations -\na method for sending and applying mutations in our back-end.\n\n**What are GraphQL mutations?**\n\nIf you have an API endpoint that alters data, like inserting data into a database or altering data that's already in a database,\nyou should make this endpoint a `Mutation` rather than a `Query`.\nThis is as simple as making the API endpoint part of the top-level `Mutation` type instead of the top-level `Query` type.\n\nMutation is a remote procedure call (RPC), meaning it is used to trigger a function on the server,\nbut unlike other protocols which have RPCs, GraphQL Mutation also includes a query, which means the client can ask for data\nonce the operation is complete.\n\nIt's often convenient to have a mutation that maps to a database create or update operation and have it return the same thing that the server stored.\nThat way, if you modify the data on the server, the client can learn about those modifications.\nYou can also think about a GraphQL Mutation as a ** GraphQL query, only with side effects**.\nIt's equivalent to GET (query) and POST/PUT (mutation) in the context of REST API.\n\nBelow is a sample GraphQL mutation request:\n\n```graphql\nmutation AddMessage($chatId: ID!) {\n  addMessage(chatId: $chatId) {\n    id\n    contents\n    createdAt\n  }\n}\n```\n\n**How to implement a GraphQL mutation?**\n\nSince GraphQL is schema based, we will need to create a new type called `Mutation` in the `typeDefs.graphql` file.\nIn this chapter we want to have the ability to send messages, thus we will have a field named `addMessage` in the new mutation type:\n\n[{]: <helper> (diffStep 5.1 files=\"typeDefs\" module=\"server\")\n\n#### [__Server__ Step 5.1: Add addMessage() mutation](https://github.com/Urigo/WhatsApp-Clone-Server/commit/da0694ede7c4bdd262e4da48e515fb838d9db9a3)\n\n##### Changed schema&#x2F;typeDefs.graphql\n```diff\n@@ -18,3 +18,7 @@\n â”Š18â”Š18â”Š  chats: [Chat!]!\n â”Š19â”Š19â”Š  chat(chatId: ID!): Chat\n â”Š20â”Š20â”Š}\n+â”Š  â”Š21â”Š\n+â”Š  â”Š22â”Štype Mutation {\n+â”Š  â”Š23â”Š  addMessage(chatId: ID!, content: String!): Message\n+â”Š  â”Š24â”Š}\n```\n\n[}]: #\n\nNote that our mutation resolver `addMessage` receives a `chatId` and it is a non-optional parameter.\nThis is because when adding a message, we should update both the messages collection, and the correlated chat document.\n\nMutations are resolved exactly like any other type in our resolvers manifest. The new resolver should look like this:\n\n[{]: <helper> (diffStep 5.1 files=\"resolvers\" module=\"server\")\n\n#### [__Server__ Step 5.1: Add addMessage() mutation](https://github.com/Urigo/WhatsApp-Clone-Server/commit/da0694ede7c4bdd262e4da48e515fb838d9db9a3)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -25,6 +25,32 @@\n â”Š25â”Š25â”Š      return chats.find(c => c.id === chatId);\n â”Š26â”Š26â”Š    },\n â”Š27â”Š27â”Š  },\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š  Mutation: {\n+â”Š  â”Š30â”Š    addMessage(root: any, { chatId, content }: any) {\n+â”Š  â”Š31â”Š      const chatIndex = chats.findIndex(c => c.id === chatId);\n+â”Š  â”Š32â”Š\n+â”Š  â”Š33â”Š      if (chatIndex === -1) return null;\n+â”Š  â”Š34â”Š\n+â”Š  â”Š35â”Š      const chat = chats[chatIndex];\n+â”Š  â”Š36â”Š\n+â”Š  â”Š37â”Š      const messagesIds = messages.map(currentMessage => Number(currentMessage.id));\n+â”Š  â”Š38â”Š      const messageId = String(Math.max(...messagesIds) + 1);\n+â”Š  â”Š39â”Š      const message = {\n+â”Š  â”Š40â”Š        id: messageId,\n+â”Š  â”Š41â”Š        createdAt: new Date(),\n+â”Š  â”Š42â”Š        content,\n+â”Š  â”Š43â”Š      };\n+â”Š  â”Š44â”Š\n+â”Š  â”Š45â”Š      messages.push(message);\n+â”Š  â”Š46â”Š      chat.messages.push(messageId);\n+â”Š  â”Š47â”Š      // The chat will appear at the top of the ChatsList component\n+â”Š  â”Š48â”Š      chats.splice(chatIndex, 1);\n+â”Š  â”Š49â”Š      chats.unshift(chat);\n+â”Š  â”Š50â”Š\n+â”Š  â”Š51â”Š      return message;\n+â”Š  â”Š52â”Š    },\n+â”Š  â”Š53â”Š  },\n â”Š28â”Š54â”Š};\n â”Š29â”Š55â”Š\n â”Š30â”Š56â”Šexport default resolvers;\n```\n\n[}]: #\n\nWhen we add a message, we first find the right chat,\nthen we generate a new message ID that is bigger then all the previous messages (when we'll move to a real database it will do that for us)\nand push the message into the right chat.\n\nIn terms of testing, we will use a temporary solution for now to reset the DB each time we test a mutation. Since we make a modification in the DB, we need to make sure that each test is completely agnostic and doesn't affect one another, thus, we will export a `resetDB()` method from our `db.ts` module:\n\n[{]: <helper> (diffStep 5.2 files=\"db.ts\" module=\"server\")\n\n#### [__Server__ Step 5.2: Test addMessage() mutation](https://github.com/Urigo/WhatsApp-Clone-Server/commit/1d4cf3bfa4fd7afe7c339917145823630fa30a6d)\n\n##### Changed db.ts\n```diff\n@@ -1,51 +1,83 @@\n-â”Š 1â”Š  â”Šexport const messages = [\n-â”Š 2â”Š  â”Š  {\n-â”Š 3â”Š  â”Š    id: '1',\n-â”Š 4â”Š  â”Š    content: 'You on your way?',\n-â”Š 5â”Š  â”Š    createdAt: new Date(new Date('1-1-2019').getTime() - 60 * 1000 * 1000),\n-â”Š 6â”Š  â”Š  },\n-â”Š 7â”Š  â”Š  {\n-â”Š 8â”Š  â”Š    id: '2',\n-â”Š 9â”Š  â”Š    content: \"Hey, it's me\",\n-â”Š10â”Š  â”Š    createdAt: new Date(new Date('1-1-2019').getTime() - 2 * 60 * 1000 * 1000),\n-â”Š11â”Š  â”Š  },\n-â”Š12â”Š  â”Š  {\n-â”Š13â”Š  â”Š    id: '3',\n-â”Š14â”Š  â”Š    content: 'I should buy a boat',\n-â”Š15â”Š  â”Š    createdAt: new Date(new Date('1-1-2019').getTime() - 24 * 60 * 1000 * 1000),\n-â”Š16â”Š  â”Š  },\n-â”Š17â”Š  â”Š  {\n-â”Š18â”Š  â”Š    id: '4',\n-â”Š19â”Š  â”Š    content: 'This is wicked good ice cream.',\n-â”Š20â”Š  â”Š    createdAt: new Date(\n-â”Š21â”Š  â”Š      new Date('1-1-2019').getTime() - 14 * 24 * 60 * 1000 * 1000\n-â”Š22â”Š  â”Š    ),\n-â”Š23â”Š  â”Š  },\n-â”Š24â”Š  â”Š];\n+â”Š  â”Š 1â”Šexport type Message = {\n+â”Š  â”Š 2â”Š  id: string;\n+â”Š  â”Š 3â”Š  content: string;\n+â”Š  â”Š 4â”Š  createdAt: Date;\n+â”Š  â”Š 5â”Š};\n â”Š25â”Š 6â”Š\n-â”Š26â”Š  â”Šexport const chats = [\n-â”Š27â”Š  â”Š  {\n-â”Š28â”Š  â”Š    id: '1',\n-â”Š29â”Š  â”Š    name: 'Ethan Gonzalez',\n-â”Š30â”Š  â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n-â”Š31â”Š  â”Š    messages: ['1'],\n-â”Š32â”Š  â”Š  },\n-â”Š33â”Š  â”Š  {\n-â”Š34â”Š  â”Š    id: '2',\n-â”Š35â”Š  â”Š    name: 'Bryan Wallace',\n-â”Š36â”Š  â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n-â”Š37â”Š  â”Š    messages: ['2'],\n-â”Š38â”Š  â”Š  },\n-â”Š39â”Š  â”Š  {\n-â”Š40â”Š  â”Š    id: '3',\n-â”Š41â”Š  â”Š    name: 'Avery Stewart',\n-â”Š42â”Š  â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n-â”Š43â”Š  â”Š    messages: ['3'],\n-â”Š44â”Š  â”Š  },\n-â”Š45â”Š  â”Š  {\n-â”Š46â”Š  â”Š    id: '4',\n-â”Š47â”Š  â”Š    name: 'Katie Peterson',\n-â”Š48â”Š  â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n-â”Š49â”Š  â”Š    messages: ['4'],\n-â”Š50â”Š  â”Š  },\n-â”Š51â”Š  â”Š];\n+â”Š  â”Š 7â”Šexport type Chat = {\n+â”Š  â”Š 8â”Š  id: string;\n+â”Š  â”Š 9â”Š  name: string;\n+â”Š  â”Š10â”Š  picture: string;\n+â”Š  â”Š11â”Š  messages: string[];\n+â”Š  â”Š12â”Š};\n+â”Š  â”Š13â”Š\n+â”Š  â”Š14â”Šexport const messages: Message[] = [];\n+â”Š  â”Š15â”Šexport const chats: Chat[] = [];\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Šexport const resetDb = () => {\n+â”Š  â”Š18â”Š  messages.splice(\n+â”Š  â”Š19â”Š    0,\n+â”Š  â”Š20â”Š    Infinity,\n+â”Š  â”Š21â”Š    ...[\n+â”Š  â”Š22â”Š      {\n+â”Š  â”Š23â”Š        id: '1',\n+â”Š  â”Š24â”Š        content: 'You on your way?',\n+â”Š  â”Š25â”Š        createdAt: new Date(new Date('1-1-2019').getTime() - 60 * 1000 * 1000),\n+â”Š  â”Š26â”Š      },\n+â”Š  â”Š27â”Š      {\n+â”Š  â”Š28â”Š        id: '2',\n+â”Š  â”Š29â”Š        content: \"Hey, it's me\",\n+â”Š  â”Š30â”Š        createdAt: new Date(\n+â”Š  â”Š31â”Š          new Date('1-1-2019').getTime() - 2 * 60 * 1000 * 1000\n+â”Š  â”Š32â”Š        ),\n+â”Š  â”Š33â”Š      },\n+â”Š  â”Š34â”Š      {\n+â”Š  â”Š35â”Š        id: '3',\n+â”Š  â”Š36â”Š        content: 'I should buy a boat',\n+â”Š  â”Š37â”Š        createdAt: new Date(\n+â”Š  â”Š38â”Š          new Date('1-1-2019').getTime() - 24 * 60 * 1000 * 1000\n+â”Š  â”Š39â”Š        ),\n+â”Š  â”Š40â”Š      },\n+â”Š  â”Š41â”Š      {\n+â”Š  â”Š42â”Š        id: '4',\n+â”Š  â”Š43â”Š        content: 'This is wicked good ice cream.',\n+â”Š  â”Š44â”Š        createdAt: new Date(\n+â”Š  â”Š45â”Š          new Date('1-1-2019').getTime() - 14 * 24 * 60 * 1000 * 1000\n+â”Š  â”Š46â”Š        ),\n+â”Š  â”Š47â”Š      },\n+â”Š  â”Š48â”Š    ]\n+â”Š  â”Š49â”Š  );\n+â”Š  â”Š50â”Š\n+â”Š  â”Š51â”Š  chats.splice(\n+â”Š  â”Š52â”Š    0,\n+â”Š  â”Š53â”Š    Infinity,\n+â”Š  â”Š54â”Š    ...[\n+â”Š  â”Š55â”Š      {\n+â”Š  â”Š56â”Š        id: '1',\n+â”Š  â”Š57â”Š        name: 'Ethan Gonzalez',\n+â”Š  â”Š58â”Š        picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n+â”Š  â”Š59â”Š        messages: ['1'],\n+â”Š  â”Š60â”Š      },\n+â”Š  â”Š61â”Š      {\n+â”Š  â”Š62â”Š        id: '2',\n+â”Š  â”Š63â”Š        name: 'Bryan Wallace',\n+â”Š  â”Š64â”Š        picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n+â”Š  â”Š65â”Š        messages: ['2'],\n+â”Š  â”Š66â”Š      },\n+â”Š  â”Š67â”Š      {\n+â”Š  â”Š68â”Š        id: '3',\n+â”Š  â”Š69â”Š        name: 'Avery Stewart',\n+â”Š  â”Š70â”Š        picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n+â”Š  â”Š71â”Š        messages: ['3'],\n+â”Š  â”Š72â”Š      },\n+â”Š  â”Š73â”Š      {\n+â”Š  â”Š74â”Š        id: '4',\n+â”Š  â”Š75â”Š        name: 'Katie Peterson',\n+â”Š  â”Š76â”Š        picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n+â”Š  â”Š77â”Š        messages: ['4'],\n+â”Š  â”Š78â”Š      },\n+â”Š  â”Š79â”Š    ]\n+â”Š  â”Š80â”Š  );\n+â”Š  â”Š81â”Š};\n+â”Š  â”Š82â”Š\n+â”Š  â”Š83â”ŠresetDb();\n```\n\n[}]: #\n\nAnd we will use the `beforeEach()` test hook to reset the `chats` and `messages` collections:\n\n[{]: <helper> (diffStep 5.2 files=\"tests\" module=\"server\")\n\n#### [__Server__ Step 5.2: Test addMessage() mutation](https://github.com/Urigo/WhatsApp-Clone-Server/commit/1d4cf3bfa4fd7afe7c339917145823630fa30a6d)\n\n##### Added tests&#x2F;mutations&#x2F;\\__snapshots__&#x2F;addMessage.test.ts.snap\n```diff\n@@ -0,0 +1,22 @@\n+â”Š  â”Š 1â”Š// Jest Snapshot v1, https://goo.gl/fbAQLP\n+â”Š  â”Š 2â”Š\n+â”Š  â”Š 3â”Šexports[`Mutation.addMessage should add message to specified chat 1`] = `\n+â”Š  â”Š 4â”ŠObject {\n+â”Š  â”Š 5â”Š  \"addMessage\": Object {\n+â”Š  â”Š 6â”Š    \"content\": \"Hello World\",\n+â”Š  â”Š 7â”Š    \"id\": \"5\",\n+â”Š  â”Š 8â”Š  },\n+â”Š  â”Š 9â”Š}\n+â”Š  â”Š10â”Š`;\n+â”Š  â”Š11â”Š\n+â”Š  â”Š12â”Šexports[`Mutation.addMessage should add message to specified chat 2`] = `\n+â”Š  â”Š13â”ŠObject {\n+â”Š  â”Š14â”Š  \"chat\": Object {\n+â”Š  â”Š15â”Š    \"id\": \"1\",\n+â”Š  â”Š16â”Š    \"lastMessage\": Object {\n+â”Š  â”Š17â”Š      \"content\": \"Hello World\",\n+â”Š  â”Š18â”Š      \"id\": \"5\",\n+â”Š  â”Š19â”Š    },\n+â”Š  â”Š20â”Š  },\n+â”Š  â”Š21â”Š}\n+â”Š  â”Š22â”Š`;\n```\n\n##### Added tests&#x2F;mutations&#x2F;addMessage.test.ts\n```diff\n@@ -0,0 +1,49 @@\n+â”Š  â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n+â”Š  â”Š 2â”Šimport { ApolloServer, gql } from 'apollo-server-express';\n+â”Š  â”Š 3â”Šimport schema from '../../schema';\n+â”Š  â”Š 4â”Šimport { resetDb } from '../../db';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šdescribe('Mutation.addMessage', () => {\n+â”Š  â”Š 7â”Š  beforeEach(resetDb);\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Š  it('should add message to specified chat', async () => {\n+â”Š  â”Š10â”Š    const server = new ApolloServer({ schema });\n+â”Š  â”Š11â”Š\n+â”Š  â”Š12â”Š    const { query, mutate } = createTestClient(server);\n+â”Š  â”Š13â”Š\n+â”Š  â”Š14â”Š    const addMessageRes = await mutate({\n+â”Š  â”Š15â”Š      variables: { chatId: '1', content: 'Hello World' },\n+â”Š  â”Š16â”Š      mutation: gql`\n+â”Š  â”Š17â”Š        mutation AddMessage($chatId: ID!, $content: String!) {\n+â”Š  â”Š18â”Š          addMessage(chatId: $chatId, content: $content) {\n+â”Š  â”Š19â”Š            id\n+â”Š  â”Š20â”Š            content\n+â”Š  â”Š21â”Š          }\n+â”Š  â”Š22â”Š        }\n+â”Š  â”Š23â”Š      `,\n+â”Š  â”Š24â”Š    });\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Š    expect(addMessageRes.data).toBeDefined();\n+â”Š  â”Š27â”Š    expect(addMessageRes.errors).toBeUndefined();\n+â”Š  â”Š28â”Š    expect(addMessageRes.data).toMatchSnapshot();\n+â”Š  â”Š29â”Š\n+â”Š  â”Š30â”Š    const getChatRes = await query({\n+â”Š  â”Š31â”Š      variables: { chatId: '1' },\n+â”Š  â”Š32â”Š      query: gql`\n+â”Š  â”Š33â”Š        query GetChat($chatId: ID!) {\n+â”Š  â”Š34â”Š          chat(chatId: $chatId) {\n+â”Š  â”Š35â”Š            id\n+â”Š  â”Š36â”Š            lastMessage {\n+â”Š  â”Š37â”Š              id\n+â”Š  â”Š38â”Š              content\n+â”Š  â”Š39â”Š            }\n+â”Š  â”Š40â”Š          }\n+â”Š  â”Š41â”Š        }\n+â”Š  â”Š42â”Š      `,\n+â”Š  â”Š43â”Š    });\n+â”Š  â”Š44â”Š\n+â”Š  â”Š45â”Š    expect(getChatRes.data).toBeDefined();\n+â”Š  â”Š46â”Š    expect(getChatRes.errors).toBeUndefined();\n+â”Š  â”Š47â”Š    expect(getChatRes.data).toMatchSnapshot();\n+â”Š  â”Š48â”Š  });\n+â”Š  â”Š49â”Š});\n```\n\n[}]: #\n\nNow we have the infrastructure set for sending a new message and we can start using it in our client.\n\n**How to use a GraphQL mutation?**\n\nLike in the previous chapters, we're gonna use a React hook so we can run a mutation more efficiently in a React.Component.\nFor this we're gonna use the [`useMutation()`](https://www.apollographql.com/docs/react/essentials/mutations/#the-usemutation-hook) react hook.\nThe first argument of the hook is the mutation string, and the second one is the [mutation options](https://www.apollographql.com/docs/react/api/apollo-client.html#ApolloClient.mutate).\nWe're gonna provide our mutation call with a single option called `optimisticResponse`.\n\nOptimistic response is a common pattern that will update the state of the component twice so we can have a better UX: First it updates the component's state with the predicted result,\nand then it will update the state with the actual result.\n\n\n\n![optimistic_response](https://user-images.githubusercontent.com/7648874/54883302-859df900-4e9f-11e9-9eb7-a98108cd2482.png)\n\n\nThis is how the component should look like:\n\n[{]: <helper> (diffStep 8.1 module=\"client\")\n\n#### [__Client__ Step 8.1: Send message with a GraphQL mutation](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/3e489ba57c131a42e357585d29f703e67521f757)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -1,7 +1,7 @@\n â”Š1â”Š1â”Šimport gql from 'graphql-tag';\n â”Š2â”Š2â”Šimport React from 'react';\n â”Š3â”Š3â”Šimport { useCallback } from 'react';\n-â”Š4â”Š â”Šimport { useApolloClient, useQuery } from '@apollo/react-hooks';\n+â”Š â”Š4â”Šimport { useQuery, useMutation } from '@apollo/react-hooks';\n â”Š5â”Š5â”Šimport styled from 'styled-components';\n â”Š6â”Š6â”Šimport ChatNavbar from './ChatNavbar';\n â”Š7â”Š7â”Šimport MessageInput from './MessageInput';\n```\n```diff\n@@ -30,6 +30,16 @@\n â”Š30â”Š30â”Š  }\n â”Š31â”Š31â”Š`;\n â”Š32â”Š32â”Š\n+â”Š  â”Š33â”Šconst addMessageMutation = gql`\n+â”Š  â”Š34â”Š  mutation AddMessage($chatId: ID!, $content: String!) {\n+â”Š  â”Š35â”Š    addMessage(chatId: $chatId, content: $content) {\n+â”Š  â”Š36â”Š      id\n+â”Š  â”Š37â”Š      content\n+â”Š  â”Š38â”Š      createdAt\n+â”Š  â”Š39â”Š    }\n+â”Š  â”Š40â”Š  }\n+â”Š  â”Š41â”Š`;\n+â”Š  â”Š42â”Š\n â”Š33â”Š43â”Šinterface ChatRoomScreenParams {\n â”Š34â”Š44â”Š  chatId: string;\n â”Š35â”Š45â”Š  history: History;\n```\n```diff\n@@ -54,36 +64,43 @@\n â”Š 54â”Š 64â”Š  history,\n â”Š 55â”Š 65â”Š  chatId,\n â”Š 56â”Š 66â”Š}) => {\n-â”Š 57â”Š   â”Š  const client = useApolloClient();\n â”Š 58â”Š 67â”Š  const {\n â”Š 59â”Š 68â”Š    data: { chat },\n â”Š 60â”Š 69â”Š  } = useQuery<any>(getChatQuery, {\n â”Š 61â”Š 70â”Š    variables: { chatId },\n â”Š 62â”Š 71â”Š  });\n+â”Š   â”Š 72â”Š  const [addMessage] = useMutation(addMessageMutation);\n â”Š 63â”Š 73â”Š\n â”Š 64â”Š 74â”Š  const onSendMessage = useCallback(\n â”Š 65â”Š 75â”Š    (content: string) => {\n-â”Š 66â”Š   â”Š      if (!chat) return null;\n-â”Š 67â”Š   â”Š\n-â”Š 68â”Š   â”Š      const message = {\n-â”Š 69â”Š   â”Š        id: (chat.messages.length + 10).toString(),\n-â”Š 70â”Š   â”Š        createdAt: new Date(),\n-â”Š 71â”Š   â”Š        content,\n-â”Š 72â”Š   â”Š        __typename: 'Chat',\n-â”Š 73â”Š   â”Š      };\n-â”Š 74â”Š   â”Š\n-â”Š 75â”Š   â”Š      client.writeQuery({\n-â”Š 76â”Š   â”Š        query: getChatQuery,\n-â”Š 77â”Š   â”Š        variables: { chatId },\n-â”Š 78â”Š   â”Š        data: {\n-â”Š 79â”Š   â”Š          chat: {\n-â”Š 80â”Š   â”Š            ...chat,\n-â”Š 81â”Š   â”Š            messages: chat.messages.concat(message),\n+â”Š   â”Š 76â”Š      addMessage({\n+â”Š   â”Š 77â”Š        variables: { chatId, content },\n+â”Š   â”Š 78â”Š        optimisticResponse: {\n+â”Š   â”Š 79â”Š          __typename: 'Mutation',\n+â”Š   â”Š 80â”Š          addMessage: {\n+â”Š   â”Š 81â”Š            __typename: 'Message',\n+â”Š   â”Š 82â”Š            id: Math.random()\n+â”Š   â”Š 83â”Š              .toString(36)\n+â”Š   â”Š 84â”Š              .substr(2, 9),\n+â”Š   â”Š 85â”Š            createdAt: new Date(),\n+â”Š   â”Š 86â”Š            content,\n â”Š 82â”Š 87â”Š          },\n â”Š 83â”Š 88â”Š        },\n+â”Š   â”Š 89â”Š        update: (client, { data: { addMessage } }) => {\n+â”Š   â”Š 90â”Š          client.writeQuery({\n+â”Š   â”Š 91â”Š            query: getChatQuery,\n+â”Š   â”Š 92â”Š            variables: { chatId },\n+â”Š   â”Š 93â”Š            data: {\n+â”Š   â”Š 94â”Š              chat: {\n+â”Š   â”Š 95â”Š                ...chat,\n+â”Š   â”Š 96â”Š                messages: chat.messages.concat(addMessage),\n+â”Š   â”Š 97â”Š              },\n+â”Š   â”Š 98â”Š            },\n+â”Š   â”Š 99â”Š          });\n+â”Š   â”Š100â”Š        },\n â”Š 84â”Š101â”Š      });\n â”Š 85â”Š102â”Š    },\n-â”Š 86â”Š   â”Š    [chat, chatId, client]\n+â”Š   â”Š103â”Š    [chat, chatId, addMessage]\n â”Š 87â”Š104â”Š  );\n â”Š 88â”Š105â”Š\n â”Š 89â”Š106â”Š  if (!chat) return null;\n```\n\n[}]: #\n\nNote that unlike `useQuery()`, `useMutation()` returns a callback that will run the mutation only once called, NOT immediately.\nSeemingly, everything works fine, but if you'll try to navigate from `ChatsListScreen` to `ChatRoomScreen`, send a message, and then go back, you'll see that the last message was not updated.\nSo why is that exactly?\n\n**Cache updating**\n\nAs explained in the previous chapter, Apollo-Client will cache all the results in a data-store.\nLater on, rather than re-fetching the data, it will look up for the result in the store and will serve it to you in case it exists.\nThat means, that even though we ran the mutation and updated the data on the server, our data-store is still left behind and it needs to be updated as well,\notherwise Apollo-Client will see nothing wrong with the outcome.\n\nApollo-Client stores the data in a hash, where the key represents the query and the value represents the retrieved result.\nThis means that the cache will need to be updated for:\n\n\n*   `chats` query - which we already did, without really diving into the reason behind it.\n*   `chat(chatId: $chatId)` where `chatId` is the chat that was just mutated.\n\nIndeed, a query will be duplicated for each and every distinct set of parameters.\nSo potentially our data-store can grow infinite amount of times, and we will need to take care of it and manage it correctly, so things won't get out of hand.\n\nTo update a query, we will first export the `getChats` query to a separate file so it can be imported in the `ChatRoomScreen`.\nWe will define all our GraphQL assets under the `src/graphql` directory:\n\n[{]: <helper> (diffStep 8.2 files=\"graphql\" module=\"client\")\n\n#### [__Client__ Step 8.2: Rewrite lastMessage to chats query](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/c5e205c4655f13b96ae1efff866e08256ff6f39a)\n\n##### Added src&#x2F;graphql&#x2F;queries&#x2F;chats.query.ts\n```diff\n@@ -0,0 +1,16 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag';\n+â”Š  â”Š 2â”Š\n+â”Š  â”Š 3â”Šexport default gql`\n+â”Š  â”Š 4â”Š  query Chats {\n+â”Š  â”Š 5â”Š    chats {\n+â”Š  â”Š 6â”Š      id\n+â”Š  â”Š 7â”Š      name\n+â”Š  â”Š 8â”Š      picture\n+â”Š  â”Š 9â”Š      lastMessage {\n+â”Š  â”Š10â”Š        id\n+â”Š  â”Š11â”Š        content\n+â”Š  â”Š12â”Š        createdAt\n+â”Š  â”Š13â”Š      }\n+â”Š  â”Š14â”Š    }\n+â”Š  â”Š15â”Š  }\n+â”Š  â”Š16â”Š`;\n```\n\n##### Added src&#x2F;graphql&#x2F;queries&#x2F;index.ts\n```diff\n@@ -0,0 +1 @@\n+â”Š â”Š1â”Šexport { default as chats } from './chats.query';\n```\n\n[}]: #\n\nAnd then we will read the memoized result from the store using [`client.readQuery`](https://www.apollographql.com/docs/react/features/caching.html#readquery),\nupdate it, and then rewrite it using [`client.writeQuery`](https://www.apollographql.com/docs/react/features/caching.html#writequery-and-writefragment).\nWe can gain access to the client object via the `update` callback which will be triggered right after the mutation has been successfully executed.\nThis is how it should look like:\n\n[{]: <helper> (diffStep 8.2 files=\"components\" module=\"client\")\n\n#### [__Client__ Step 8.2: Rewrite lastMessage to chats query](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/c5e205c4655f13b96ae1efff866e08256ff6f39a)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -7,6 +7,7 @@\n â”Š 7â”Š 7â”Šimport MessageInput from './MessageInput';\n â”Š 8â”Š 8â”Šimport MessagesList from './MessagesList';\n â”Š 9â”Š 9â”Šimport { History } from 'history';\n+â”Š  â”Š10â”Šimport * as queries from '../../graphql/queries';\n â”Š10â”Š11â”Š\n â”Š11â”Š12â”Šconst Container = styled.div`\n â”Š12â”Š13â”Š  background: url(/assets/chat-background.jpg);\n```\n```diff\n@@ -60,6 +61,10 @@\n â”Š60â”Š61â”Š\n â”Š61â”Š62â”Štype OptionalChatQueryResult = ChatQueryResult | null;\n â”Š62â”Š63â”Š\n+â”Š  â”Š64â”Šinterface ChatsResult {\n+â”Š  â”Š65â”Š  chats: any[];\n+â”Š  â”Š66â”Š}\n+â”Š  â”Š67â”Š\n â”Š63â”Š68â”Šconst ChatRoomScreen: React.FC<ChatRoomScreenParams> = ({\n â”Š64â”Š69â”Š  history,\n â”Š65â”Š70â”Š  chatId,\n```\n```diff\n@@ -97,6 +102,37 @@\n â”Š 97â”Š102â”Š              },\n â”Š 98â”Š103â”Š            },\n â”Š 99â”Š104â”Š          });\n+â”Š   â”Š105â”Š\n+â”Š   â”Š106â”Š          let data;\n+â”Š   â”Š107â”Š          try {\n+â”Š   â”Š108â”Š            data = client.readQuery<ChatsResult>({\n+â”Š   â”Š109â”Š              query: queries.chats,\n+â”Š   â”Š110â”Š            });\n+â”Š   â”Š111â”Š          } catch (e) {\n+â”Š   â”Š112â”Š            return;\n+â”Š   â”Š113â”Š          }\n+â”Š   â”Š114â”Š\n+â”Š   â”Š115â”Š          if (!data || data === null) {\n+â”Š   â”Š116â”Š            return null;\n+â”Š   â”Š117â”Š          }\n+â”Š   â”Š118â”Š          if (!data.chats || data.chats === undefined) {\n+â”Š   â”Š119â”Š            return null;\n+â”Š   â”Š120â”Š          }\n+â”Š   â”Š121â”Š          const chats = data.chats;\n+â”Š   â”Š122â”Š\n+â”Š   â”Š123â”Š          const chatIndex = chats.findIndex((c: any) => c.id === chatId);\n+â”Š   â”Š124â”Š          if (chatIndex === -1) return;\n+â”Š   â”Š125â”Š          const chatWhereAdded = chats[chatIndex];\n+â”Š   â”Š126â”Š\n+â”Š   â”Š127â”Š          chatWhereAdded.lastMessage = addMessage;\n+â”Š   â”Š128â”Š          // The chat will appear at the top of the ChatsList component\n+â”Š   â”Š129â”Š          chats.splice(chatIndex, 1);\n+â”Š   â”Š130â”Š          chats.unshift(chatWhereAdded);\n+â”Š   â”Š131â”Š\n+â”Š   â”Š132â”Š          client.writeQuery({\n+â”Š   â”Š133â”Š            query: queries.chats,\n+â”Š   â”Š134â”Š            data: { chats: chats },\n+â”Š   â”Š135â”Š          });\n â”Š100â”Š136â”Š        },\n â”Š101â”Š137â”Š      });\n â”Š102â”Š138â”Š    },\n```\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.test.tsx\n```diff\n@@ -11,6 +11,7 @@\n â”Š11â”Š11â”Šimport { createBrowserHistory } from 'history';\n â”Š12â”Š12â”Šimport { mockApolloClient } from '../../test-helpers';\n â”Š13â”Š13â”Šimport ChatsList, { getChatsQuery } from './ChatsList';\n+â”Š  â”Š14â”Šimport * as queries from '../../graphql/queries';\n â”Š14â”Š15â”Š\n â”Š15â”Š16â”Šdescribe('ChatsList', () => {\n â”Š16â”Š17â”Š  afterEach(() => {\n```\n```diff\n@@ -25,7 +26,7 @@\n â”Š25â”Š26â”Š  it('renders fetched chats data', async () => {\n â”Š26â”Š27â”Š    const client = mockApolloClient([\n â”Š27â”Š28â”Š      {\n-â”Š28â”Š  â”Š        request: { query: getChatsQuery },\n+â”Š  â”Š29â”Š        request: { query: queries.chats },\n â”Š29â”Š30â”Š        result: {\n â”Š30â”Š31â”Š          data: {\n â”Š31â”Š32â”Š            chats: [\n```\n```diff\n@@ -71,7 +72,7 @@\n â”Š71â”Š72â”Š  it('should navigate to the target chat room on chat item click', async () => {\n â”Š72â”Š73â”Š    const client = mockApolloClient([\n â”Š73â”Š74â”Š      {\n-â”Š74â”Š  â”Š        request: { query: getChatsQuery },\n+â”Š  â”Š75â”Š        request: { query: queries.chats },\n â”Š75â”Š76â”Š        result: {\n â”Š76â”Š77â”Š          data: {\n â”Š77â”Š78â”Š            chats: [\n```\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -4,8 +4,8 @@\n â”Š 4â”Š 4â”Šimport styled from 'styled-components';\n â”Š 5â”Š 5â”Šimport { useCallback } from 'react';\n â”Š 6â”Š 6â”Šimport { History } from 'history';\n-â”Š 7â”Š  â”Šimport gql from 'graphql-tag';\n â”Š 8â”Š 7â”Šimport { useQuery } from '@apollo/react-hooks';\n+â”Š  â”Š 8â”Šimport * as queries from '../../graphql/queries';\n â”Š 9â”Š 9â”Š\n â”Š10â”Š10â”Šconst Container = styled.div`\n â”Š11â”Š11â”Š  height: calc(100% - 56px);\n```\n```diff\n@@ -59,27 +59,12 @@\n â”Š59â”Š59â”Š  font-size: 13px;\n â”Š60â”Š60â”Š`;\n â”Š61â”Š61â”Š\n-â”Š62â”Š  â”Šexport const getChatsQuery = gql`\n-â”Š63â”Š  â”Š  query GetChats {\n-â”Š64â”Š  â”Š    chats {\n-â”Š65â”Š  â”Š      id\n-â”Š66â”Š  â”Š      name\n-â”Š67â”Š  â”Š      picture\n-â”Š68â”Š  â”Š      lastMessage {\n-â”Š69â”Š  â”Š        id\n-â”Š70â”Š  â”Š        content\n-â”Š71â”Š  â”Š        createdAt\n-â”Š72â”Š  â”Š      }\n-â”Š73â”Š  â”Š    }\n-â”Š74â”Š  â”Š  }\n-â”Š75â”Š  â”Š`;\n-â”Š76â”Š  â”Š\n â”Š77â”Š62â”Šinterface ChatsListProps {\n â”Š78â”Š63â”Š  history: History;\n â”Š79â”Š64â”Š}\n â”Š80â”Š65â”Š\n â”Š81â”Š66â”Šconst ChatsList: React.FC<ChatsListProps> = ({ history }) => {\n-â”Š82â”Š  â”Š  const { data } = useQuery<any>(getChatsQuery);\n+â”Š  â”Š67â”Š  const { data } = useQuery<any>(queries.chats);\n â”Š83â”Š68â”Š\n â”Š84â”Š69â”Š  const navToChat = useCallback(\n â”Š85â”Š70â”Š    chat => {\n```\n\n[}]: #\n\nRight now what happens is that we update a single chat document twice: Once for the `chats` query and another time for the `chat($chatId)` query.\nThis work is redundant and become more complex as we add more `chat` related queries.\nTo solve it, we can define and use a [GraphQL fragment](https://www.apollographql.com/docs/react/advanced/fragments.html).\n\n**Using Fragments**\n\nA GraphQL fragment is a shared piece of query logic.\n\n```graphql\nfragment NameParts on Person {\n  firstName\n  lastName\n}\n\nquery GetPerson {\n  people(id: \"7\") {\n    ...NameParts\n    avatar(size: LARGE)\n  }\n}\n```\n\nIt's important to note that the component after the `on` clause is designated for the type we are selecting from. In this case, `people` is of type `Person` and we want to select the `firstName` and `lastName` fields from `people(id: \"7\")`.\n\nApollo maps the fragment ID to its retrieved data in the store. By default, Apollo will compose the fragment ID out of the entity type and the ID of the document. For example, for a `Chat` document with an ID of `7`, the fragment ID would be `Chat:7`. This behavior can be modified, but there's no need to.\n\nWe will define the following fragments in our app:\n\n\n\n*   `Message` - represents a message\n*   `Chat` - represents a chat, **without its messages list**.\n*   `FullChat` - represents a chat, **including its messages list**.\n\nOnce we define the fragments we can start embedding them in our queries. We will create a new directory path `src/graphql/fragments`, and inside we will create a dedicated fragment file for each fragment type: `message.fragment.ts`, `chat.fragment.ts` and `fullChat.fragment.ts`:\n\n[{]: <helper> (diffStep 8.3 files=\"graphql/fragments\" module=\"client\")\n\n#### [__Client__ Step 8.3: Update queries to use GraphQL fragments](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/444ee471e1868f94ca95825165446a733df444a2)\n\n##### Added src&#x2F;graphql&#x2F;fragments&#x2F;chat.fragment.ts\n```diff\n@@ -0,0 +1,14 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag';\n+â”Š  â”Š 2â”Šimport message from './message.fragment';\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šexport default gql`\n+â”Š  â”Š 5â”Š  fragment Chat on Chat {\n+â”Š  â”Š 6â”Š    id\n+â”Š  â”Š 7â”Š    name\n+â”Š  â”Š 8â”Š    picture\n+â”Š  â”Š 9â”Š    lastMessage {\n+â”Š  â”Š10â”Š      ...Message\n+â”Š  â”Š11â”Š    }\n+â”Š  â”Š12â”Š  }\n+â”Š  â”Š13â”Š  ${message}\n+â”Š  â”Š14â”Š`;\n```\n\n##### Added src&#x2F;graphql&#x2F;fragments&#x2F;fullChat.fragment.ts\n```diff\n@@ -0,0 +1,14 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag';\n+â”Š  â”Š 2â”Šimport chat from './chat.fragment';\n+â”Š  â”Š 3â”Šimport message from './message.fragment';\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šexport default gql`\n+â”Š  â”Š 6â”Š  fragment FullChat on Chat {\n+â”Š  â”Š 7â”Š    ...Chat\n+â”Š  â”Š 8â”Š    messages {\n+â”Š  â”Š 9â”Š      ...Message\n+â”Š  â”Š10â”Š    }\n+â”Š  â”Š11â”Š  }\n+â”Š  â”Š12â”Š  ${chat}\n+â”Š  â”Š13â”Š  ${message}\n+â”Š  â”Š14â”Š`;\n```\n\n##### Added src&#x2F;graphql&#x2F;fragments&#x2F;index.ts\n```diff\n@@ -0,0 +1,3 @@\n+â”Š â”Š1â”Šexport { default as chat } from './chat.fragment';\n+â”Š â”Š2â”Šexport { default as fullChat } from './fullChat.fragment';\n+â”Š â”Š3â”Šexport { default as message } from './message.fragment';\n```\n\n##### Added src&#x2F;graphql&#x2F;fragments&#x2F;message.fragment.ts\n```diff\n@@ -0,0 +1,9 @@\n+â”Š â”Š1â”Šimport gql from 'graphql-tag';\n+â”Š â”Š2â”Š\n+â”Š â”Š3â”Šexport default gql`\n+â”Š â”Š4â”Š  fragment Message on Message {\n+â”Š â”Š5â”Š    id\n+â”Š â”Š6â”Š    createdAt\n+â”Š â”Š7â”Š    content\n+â”Š â”Š8â”Š  }\n+â”Š â”Š9â”Š`;\n```\n\n[}]: #\n\nAnd now that we have the fragments available to us, let's embed them in the relevant queries:\n\n[{]: <helper> (diffStep 8.3 files=\"components, graphql/queries\" module=\"client\")\n\n#### [__Client__ Step 8.3: Update queries to use GraphQL fragments](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/444ee471e1868f94ca95825165446a733df444a2)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -8,6 +8,7 @@\n â”Š 8â”Š 8â”Šimport MessagesList from './MessagesList';\n â”Š 9â”Š 9â”Šimport { History } from 'history';\n â”Š10â”Š10â”Šimport * as queries from '../../graphql/queries';\n+â”Š  â”Š11â”Šimport * as fragments from '../../graphql/fragments';\n â”Š11â”Š12â”Š\n â”Š12â”Š13â”Šconst Container = styled.div`\n â”Š13â”Š14â”Š  background: url(/assets/chat-background.jpg);\n```\n```diff\n@@ -19,26 +20,19 @@\n â”Š19â”Š20â”Šconst getChatQuery = gql`\n â”Š20â”Š21â”Š  query GetChat($chatId: ID!) {\n â”Š21â”Š22â”Š    chat(chatId: $chatId) {\n-â”Š22â”Š  â”Š      id\n-â”Š23â”Š  â”Š      name\n-â”Š24â”Š  â”Š      picture\n-â”Š25â”Š  â”Š      messages {\n-â”Š26â”Š  â”Š        id\n-â”Š27â”Š  â”Š        content\n-â”Š28â”Š  â”Š        createdAt\n-â”Š29â”Š  â”Š      }\n+â”Š  â”Š23â”Š      ...FullChat\n â”Š30â”Š24â”Š    }\n â”Š31â”Š25â”Š  }\n+â”Š  â”Š26â”Š  ${fragments.fullChat}\n â”Š32â”Š27â”Š`;\n â”Š33â”Š28â”Š\n â”Š34â”Š29â”Šconst addMessageMutation = gql`\n â”Š35â”Š30â”Š  mutation AddMessage($chatId: ID!, $content: String!) {\n â”Š36â”Š31â”Š    addMessage(chatId: $chatId, content: $content) {\n-â”Š37â”Š  â”Š      id\n-â”Š38â”Š  â”Š      content\n-â”Š39â”Š  â”Š      createdAt\n+â”Š  â”Š32â”Š      ...Message\n â”Š40â”Š33â”Š    }\n â”Š41â”Š34â”Š  }\n+â”Š  â”Š35â”Š  ${fragments.message}\n â”Š42â”Š36â”Š`;\n â”Š43â”Š37â”Š\n â”Š44â”Š38â”Šinterface ChatRoomScreenParams {\n```\n\n##### Changed src&#x2F;graphql&#x2F;queries&#x2F;chats.query.ts\n```diff\n@@ -1,16 +1,11 @@\n â”Š 1â”Š 1â”Šimport gql from 'graphql-tag';\n+â”Š  â”Š 2â”Šimport * as fragments from '../fragments';\n â”Š 2â”Š 3â”Š\n â”Š 3â”Š 4â”Šexport default gql`\n â”Š 4â”Š 5â”Š  query Chats {\n â”Š 5â”Š 6â”Š    chats {\n-â”Š 6â”Š  â”Š      id\n-â”Š 7â”Š  â”Š      name\n-â”Š 8â”Š  â”Š      picture\n-â”Š 9â”Š  â”Š      lastMessage {\n-â”Š10â”Š  â”Š        id\n-â”Š11â”Š  â”Š        content\n-â”Š12â”Š  â”Š        createdAt\n-â”Š13â”Š  â”Š      }\n+â”Š  â”Š 7â”Š      ...Chat\n â”Š14â”Š 8â”Š    }\n â”Š15â”Š 9â”Š  }\n+â”Š  â”Š10â”Š  ${fragments.chat}\n â”Š16â”Š11â”Š`;\n```\n\n[}]: #\n\nSimilarly to query rewriting, we will use the [`readFragment()`](https://www.apollographql.com/docs/react/features/caching.html#readfragment) and [`writeFragment()`](https://www.apollographql.com/docs/react/features/caching.html#writefragment) methods in the same way to rewrite the fragments. When working with a fragment we need to compose its ID, just like explained earlier. The default mapping function called `defaultDataIdFromObject` can be imported from `apollo-cache-inmemory` and be used to specify the fragment that we would like to read/write. Accordingly, we're gonna replace all our query re-writings with fragments re-writings, as we don't need them anymore:\n\n[{]: <helper> (diffStep 8.4 module=\"client\")\n\n#### [__Client__ Step 8.4: Rewrite fragments](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/395817cc75f3cea26cf4151dfd9479ac889f24e4)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -1,3 +1,4 @@\n+â”Š â”Š1â”Šimport { defaultDataIdFromObject } from 'apollo-cache-inmemory';\n â”Š1â”Š2â”Šimport gql from 'graphql-tag';\n â”Š2â”Š3â”Šimport React from 'react';\n â”Š3â”Š4â”Šimport { useCallback } from 'react';\n```\n```diff\n@@ -86,15 +87,38 @@\n â”Š 86â”Š 87â”Š          },\n â”Š 87â”Š 88â”Š        },\n â”Š 88â”Š 89â”Š        update: (client, { data: { addMessage } }) => {\n-â”Š 89â”Š   â”Š          client.writeQuery({\n-â”Š 90â”Š   â”Š            query: getChatQuery,\n-â”Š 91â”Š   â”Š            variables: { chatId },\n-â”Š 92â”Š   â”Š            data: {\n-â”Š 93â”Š   â”Š              chat: {\n-â”Š 94â”Š   â”Š                ...chat,\n-â”Š 95â”Š   â”Š                messages: chat.messages.concat(addMessage),\n-â”Š 96â”Š   â”Š              },\n-â”Š 97â”Š   â”Š            },\n+â”Š   â”Š 90â”Š          type FullChat = { [key: string]: any };\n+â”Š   â”Š 91â”Š          let fullChat;\n+â”Š   â”Š 92â”Š          const chatIdFromStore = defaultDataIdFromObject(chat);\n+â”Š   â”Š 93â”Š\n+â”Š   â”Š 94â”Š          if (chatIdFromStore === null) {\n+â”Š   â”Š 95â”Š            return;\n+â”Š   â”Š 96â”Š          }\n+â”Š   â”Š 97â”Š\n+â”Š   â”Š 98â”Š          try {\n+â”Š   â”Š 99â”Š            fullChat = client.readFragment<FullChat>({\n+â”Š   â”Š100â”Š              id: chatIdFromStore,\n+â”Š   â”Š101â”Š              fragment: fragments.fullChat,\n+â”Š   â”Š102â”Š              fragmentName: 'FullChat',\n+â”Š   â”Š103â”Š            });\n+â”Š   â”Š104â”Š          } catch (e) {\n+â”Š   â”Š105â”Š            return;\n+â”Š   â”Š106â”Š          }\n+â”Š   â”Š107â”Š\n+â”Š   â”Š108â”Š          if (fullChat === null) {\n+â”Š   â”Š109â”Š            return;\n+â”Š   â”Š110â”Š          }\n+â”Š   â”Š111â”Š          if (fullChat.messages.some((m: any) => m.id === addMessage.id))\n+â”Š   â”Š112â”Š            return;\n+â”Š   â”Š113â”Š\n+â”Š   â”Š114â”Š          fullChat.messages.push(addMessage);\n+â”Š   â”Š115â”Š          fullChat.lastMessage = addMessage;\n+â”Š   â”Š116â”Š\n+â”Š   â”Š117â”Š          client.writeFragment({\n+â”Š   â”Š118â”Š            id: chatIdFromStore,\n+â”Š   â”Š119â”Š            fragment: fragments.fullChat,\n+â”Š   â”Š120â”Š            fragmentName: 'FullChat',\n+â”Š   â”Š121â”Š            data: fullChat,\n â”Š 98â”Š122â”Š          });\n â”Š 99â”Š123â”Š\n â”Š100â”Š124â”Š          let data;\n```\n```diff\n@@ -118,7 +142,6 @@\n â”Š118â”Š142â”Š          if (chatIndex === -1) return;\n â”Š119â”Š143â”Š          const chatWhereAdded = chats[chatIndex];\n â”Š120â”Š144â”Š\n-â”Š121â”Š   â”Š          chatWhereAdded.lastMessage = addMessage;\n â”Š122â”Š145â”Š          // The chat will appear at the top of the ChatsList component\n â”Š123â”Š146â”Š          chats.splice(chatIndex, 1);\n â”Š124â”Š147â”Š          chats.unshift(chatWhereAdded);\n```\n\n[}]: #\n\n\n----------\nTODO: Isnâ€™t `chats.splice(0, Infinity, ...[ â€¦ ])` the same as `chats = [...]` ?\nI see an explanation of apollo-cache but it makes you feel itâ€™s the fragment thatâ€™s being cached, which is not true, itâ€™s the object type.\nWe shouldnâ€™t use `defaultDataIdFromObject` directly from `apollo-cache-inmemory` but define it somewhere in our code and use that. It might change in the future and then we would have to do it in 500 files.\nI would explain a lot more than it is now, about the caching. It should be based on a simpler example and show that when an entity `Foo:1` is modified, the change reflects in all component. We should describe how itâ€™s stored, as references and not real data and so on.\n\nTODO: Better fragments naming and convensions"
          },
          {
            "manualTitle": "Step 9: Type safety with GraphQL Code Generator",
            "stepRevision": "d0a149939f202121b12d958644f637a71bdd5d79",
            "manualView": "So far we've been just writing code. If there was an error we would most likely discover it during runtime. As a reminder, we've created a project which is based on TypeScript, but we haven't really took any advantage of TypeScript's type safety mechanism. Currently, the TypeScript compiler is configured to work on loose mode, so any object which is not bound to any type will be converted to `any` - a type which is compatible with any type of casting and will ignore type errors.\n\nSo far it's been very convenient because we've only started to learn about building an app and the ecosystem around it, but for a long term project it's would be very handy to take a full advantage of TypeScript and not let it go under the radar. So where exactly are we missing type checkings? In the core of our project - when dealing with GraphQL documents.\n\nWhen we run a query, or a mutation, we wanna make sure that we use the received data correctly, based on its intended shape and form. For example, given the following GraphQL query:\n\n```graphql\nquery Chats {\n  chats {\n    id\n    name\n    picture\n  }\n}\n```\n\nWe want to have the following TypeScript type:\n\n```ts\nexport type Chat = {\n  __typename?: \"Chat\"\n  id: string\n  name: string\n  picture: string\n}\n\nexport type ChatQuery = {\n  __typename?: \"Query\"\n  chats: Chats[]\n}\n\n```\n\nSo later on we can use it with `@apollo/react-hooks` like so:\n\n```ts\nuseQuery<ChatsQuery>(getChatsQuery)\n```\n\nEverything looks nice in theory, but the main issue that arises from having type definitions is that we need to maintain and sync 2 similar code bases:\nA GraphQL schema and TypeScript type definitions.\nBoth are essentially the same, and if so, why do we even need to maintain 2 code bases?\nIsn't there a tool which does that for us? A question which brings us straight to the point of the chapter.\n\n**Introducing: GraphQL Code Generator**\n\nWith [GraphQL Code Generator](https://graphql-code-generator.com/) we can generate TypeScript definitions given a GraphQL schema, and a set of GraphQL documents if they are presented to us.\n\n\n\n![graphql-codegen](https://user-images.githubusercontent.com/7648874/54940897-9f564380-4f66-11e9-9891-3b994a1daef1.png)\n\n\nGraphQL Code Generator is a simple CLI tool that operates based on a configuration file and can generate TypeScript types for both Client and Server.\nWe will start with generating types for the server.\n\nIn the server project, install GraphQL Code Generator via Yarn\n\n    $ yarn add @graphql-codegen/cli --dev\n\nNow GraphQL Code Generator can be used directly from the `scripts` section in the `package.json` file using the `gql-gen` binary.\nWe're gonna call the code generation script \"codegen\":\n\n```json\n{\n  \"codegen\": \"gql-gen\"\n}\n```\n\nThis command will automatically be referenced to a configuration file in the root of our project called `codegen.yml`.\nThe essence of this file is to provide the code generator with the GraphQL schema, GraphQL documents, the output path of the type definition file/s and a set of plug-ins.\nMore about the configuration file can be found in the [official website](https://graphql-code-generator.com/docs/getting-started/codegen-config).\n\nIn the server project, we will generate the `types/graphql.d.ts` file and we will use a couple of plug-ins to do that:\n\n\n\n*   `@graphql-codegen/typescript` - Will generate the core TypeScript types from our GraphQL schema.\n*   `@graphql-codegen/typescript-resolvers` - Will generate resolvers signatures with the generated TypeScript types.\n\n> A full list of available plugins is available [here](https://graphql-code-generator.com/docs/plugins/). In addition, you can write your own [custom plugin](https://graphql-code-generator.com/docs/custom-codegen/write-your-plugin).\n\nLet's install these 2 plugins:\n\n    $ yarn add @graphql-codegen/typescript @graphql-codegen/typescript-resolvers --dev\n\nAnd write the `codegen.yml` file:\n\n[{]: <helper> (diffStep 6.1 files=\"codegen.yml\" module=\"server\")\n\n#### [__Server__ Step 6.1: Setup GraphQL Code Generator](https://github.com/Urigo/WhatsApp-Clone-Server/commit/bebe157b86a10586d8de927c6c9f1074a885331d)\n\n##### Added codegen.yml\n```diff\n@@ -0,0 +1,16 @@\n+â”Š  â”Š 1â”Šschema: ./schema/typeDefs.graphql\n+â”Š  â”Š 2â”Šoverwrite: true\n+â”Š  â”Š 3â”Šgenerates:\n+â”Š  â”Š 4â”Š  ./types/graphql.d.ts:\n+â”Š  â”Š 5â”Š    plugins:\n+â”Š  â”Š 6â”Š      - typescript\n+â”Š  â”Š 7â”Š      - typescript-resolvers\n+â”Š  â”Š 8â”Š    config:\n+â”Š  â”Š 9â”Š      mappers:\n+â”Š  â”Š10â”Š        # import { Message } from '../db'\n+â”Š  â”Š11â”Š        # The root types of Message resolvers\n+â”Š  â”Š12â”Š        Message: ../db#Message\n+â”Š  â”Š13â”Š        Chat: ../db#Chat\n+â”Š  â”Š14â”Š      scalars:\n+â”Š  â”Š15â”Š        # e.g. Message.createdAt will be of type Date\n+â”Š  â”Š16â”Š        Date: Date\n```\n\n[}]: #\n\n> See inline comments to learn more about our configuration setup.\n\nNow if you'll run `$ npm run codegen` you should see that a new file `types/graphql.d.ts` has been generated with all the necessary TypeScript types. Since these types are very likely to change as we extend our schema, there's no need to include them in our project, thus it's recommended to add the appropriate .gitignore rule:\n\n[{]: <helper> (diffStep 6.1 files=\".gitignore\" module=\"server\")\n\n#### [__Server__ Step 6.1: Setup GraphQL Code Generator](https://github.com/Urigo/WhatsApp-Clone-Server/commit/bebe157b86a10586d8de927c6c9f1074a885331d)\n\n##### Changed .gitignore\n```diff\n@@ -1,3 +1,4 @@\n â”Š1â”Š1â”Šnode_modules\n â”Š2â”Š2â”Šnpm-debug.log\n-â”Š3â”Š â”Štest-results/ðŸš«â†µ\n+â”Š â”Š3â”Štest-results/\n+â”Š â”Š4â”Štypes/graphql.d.tsðŸš«â†µ\n```\n\n[}]: #\n\nNow to make sure we always get the updated types, let's add a task that would run automatically before we start the server.\n`prestart` is a saved word that means that when we run `yarn start` it will run that task automatically before running the script in `start`:\n\n[{]: <helper> (diffStep 6.1 files=\"package.json\" module=\"server\")\n\n#### [__Server__ Step 6.1: Setup GraphQL Code Generator](https://github.com/Urigo/WhatsApp-Clone-Server/commit/bebe157b86a10586d8de927c6c9f1074a885331d)\n\n##### Changed package.json\n```diff\n@@ -7,14 +7,19 @@\n â”Š 7â”Š 7â”Š  },\n â”Š 8â”Š 8â”Š  \"private\": true,\n â”Š 9â”Š 9â”Š  \"scripts\": {\n+â”Š  â”Š10â”Š    \"prestart\": \"yarn codegen\",\n â”Š10â”Š11â”Š    \"start\": \"ts-node index.ts\",\n â”Š11â”Š12â”Š    \"test\": \"TZ=\\\"Asia/Jerusalem\\\" jest\",\n+â”Š  â”Š13â”Š    \"codegen\": \"gql-gen\",\n â”Š12â”Š14â”Š    \"format\": \"prettier \\\"**/*.ts\\\" --write\"\n â”Š13â”Š15â”Š  },\n â”Š14â”Š16â”Š  \"jest-junit\": {\n â”Š15â”Š17â”Š    \"outputDirectory\": \"./test-results\"\n â”Š16â”Š18â”Š  },\n â”Š17â”Š19â”Š  \"devDependencies\": {\n+â”Š  â”Š20â”Š    \"@graphql-codegen/cli\": \"1.5.0\",\n+â”Š  â”Š21â”Š    \"@graphql-codegen/typescript\": \"1.5.0\",\n+â”Š  â”Š22â”Š    \"@graphql-codegen/typescript-resolvers\": \"1.5.0\",\n â”Š18â”Š23â”Š    \"@types/cors\": \"2.8.5\",\n â”Š19â”Š24â”Š    \"@types/express\": \"4.17.0\",\n â”Š20â”Š25â”Š    \"@types/graphql\": \"14.2.3\",\n```\n\n[}]: #\n\nNow we can import the `IResolvers` type from the file we've just created and use it in the `resolvers.ts` file to ensure our resolvers handlers have the right signature:\n\n[{]: <helper> (diffStep 6.2 module=\"server\")\n\n#### [__Server__ Step 6.2: Type resolvers](https://github.com/Urigo/WhatsApp-Clone-Server/commit/c934563f79c8b739ee32ca6e887a7b0884502104)\n\n##### Changed schema&#x2F;index.ts\n```diff\n@@ -1,7 +1,10 @@\n â”Š 1â”Š 1â”Šimport { importSchema } from 'graphql-import';\n-â”Š 2â”Š  â”Šimport { makeExecutableSchema } from 'graphql-tools';\n+â”Š  â”Š 2â”Šimport { makeExecutableSchema, IResolvers } from 'graphql-tools';\n â”Š 3â”Š 3â”Šimport resolvers from './resolvers';\n â”Š 4â”Š 4â”Š\n â”Š 5â”Š 5â”Šconst typeDefs = importSchema('schema/typeDefs.graphql');\n â”Š 6â”Š 6â”Š\n-â”Š 7â”Š  â”Šexport default makeExecutableSchema({ resolvers, typeDefs });\n+â”Š  â”Š 7â”Šexport default makeExecutableSchema({\n+â”Š  â”Š 8â”Š  resolvers: resolvers as IResolvers,\n+â”Š  â”Š 9â”Š  typeDefs,\n+â”Š  â”Š10â”Š});\n```\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,18 +1,19 @@\n â”Š 1â”Š 1â”Šimport { GraphQLDateTime } from 'graphql-iso-date';\n-â”Š 2â”Š  â”Šimport { chats, messages } from '../db';\n+â”Š  â”Š 2â”Šimport { Message, chats, messages } from '../db';\n+â”Š  â”Š 3â”Šimport { Resolvers } from '../types/graphql';\n â”Š 3â”Š 4â”Š\n-â”Š 4â”Š  â”Šconst resolvers = {\n+â”Š  â”Š 5â”Šconst resolvers: Resolvers = {\n â”Š 5â”Š 6â”Š  Date: GraphQLDateTime,\n â”Š 6â”Š 7â”Š\n â”Š 7â”Š 8â”Š  Chat: {\n-â”Š 8â”Š  â”Š    messages(chat: any) {\n+â”Š  â”Š 9â”Š    messages(chat) {\n â”Š 9â”Š10â”Š      return messages.filter(m => chat.messages.includes(m.id));\n â”Š10â”Š11â”Š    },\n â”Š11â”Š12â”Š\n-â”Š12â”Š  â”Š    lastMessage(chat: any) {\n+â”Š  â”Š13â”Š    lastMessage(chat) {\n â”Š13â”Š14â”Š      const lastMessage = chat.messages[chat.messages.length - 1];\n â”Š14â”Š15â”Š\n-â”Š15â”Š  â”Š      return messages.find(m => m.id === lastMessage);\n+â”Š  â”Š16â”Š      return messages.find(m => m.id === lastMessage) || null;\n â”Š16â”Š17â”Š    },\n â”Š17â”Š18â”Š  },\n â”Š18â”Š19â”Š\n```\n```diff\n@@ -21,13 +22,13 @@\n â”Š21â”Š22â”Š      return chats;\n â”Š22â”Š23â”Š    },\n â”Š23â”Š24â”Š\n-â”Š24â”Š  â”Š    chat(root: any, { chatId }: any) {\n-â”Š25â”Š  â”Š      return chats.find(c => c.id === chatId);\n+â”Š  â”Š25â”Š    chat(root, { chatId }) {\n+â”Š  â”Š26â”Š      return chats.find(c => c.id === chatId) || null;\n â”Š26â”Š27â”Š    },\n â”Š27â”Š28â”Š  },\n â”Š28â”Š29â”Š\n â”Š29â”Š30â”Š  Mutation: {\n-â”Š30â”Š  â”Š    addMessage(root: any, { chatId, content }: any) {\n+â”Š  â”Š31â”Š    addMessage(root, { chatId, content }) {\n â”Š31â”Š32â”Š      const chatIndex = chats.findIndex(c => c.id === chatId);\n â”Š32â”Š33â”Š\n â”Š33â”Š34â”Š      if (chatIndex === -1) return null;\n```\n```diff\n@@ -36,7 +37,7 @@\n â”Š36â”Š37â”Š\n â”Š37â”Š38â”Š      const messagesIds = messages.map(currentMessage => Number(currentMessage.id));\n â”Š38â”Š39â”Š      const messageId = String(Math.max(...messagesIds) + 1);\n-â”Š39â”Š  â”Š      const message = {\n+â”Š  â”Š40â”Š      const message: Message = {\n â”Š40â”Š41â”Š        id: messageId,\n â”Š41â”Š42â”Š        createdAt: new Date(),\n â”Š42â”Š43â”Š        content,\n```\n\n[}]: #\n\nWe will now repeat the same process in the client with few tweaks. Again, we will install GraphQL Code Generator:\n\n    $ yarn add @graphql-codegen/cli --dev\n\nAnd we will define a script:\n\n```json\n{\n  \"codegen\": \"gql-gen\"\n}\n```\n\nThis time around, because we're in the client, we will define a set of glob paths that will specify which files contain GraphQL documents.\nGraphQL Code Generator is smart enough to automatically recognize the documents within these files by looking at the `gql` template literal calls using the `typescript-operations` package.\nWe will be using a plugin called `typescript-react-apollo` to generate React/Apollo-GraphQL hooks that can be used in our function components.\nLet's install the necessary plugins:\n\n    $ yarn add @graphql-codegen/cli @graphql-codegen/typescript @graphql-codegen/typescript-operations @graphql-codegen/typescript-react-apollo @graphql-codegen/add\n\n\nAnd we will write the `codegen.yml` file:\n\n[{]: <helper> (diffStep 9.1 files=\"codegen.yml\" module=\"client\")\n\n#### [__Client__ Step 9.1: Setup GraphQL Code Generator](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/5c1f40f687e82a15a412a002630631fe2328f7c7)\n\n##### Added codegen.yml\n```diff\n@@ -0,0 +1,20 @@\n+â”Š  â”Š 1â”Šschema: ../WhatsApp-Clone-Server/schema/typeDefs.graphql\n+â”Š  â”Š 2â”Šdocuments:\n+â”Š  â”Š 3â”Š  - ./src/components/**/*.tsx\n+â”Š  â”Š 4â”Š  - ./src/graphql/fragments/**/*.ts\n+â”Š  â”Š 5â”Š  - ./src/graphql/queries/**/*.ts\n+â”Š  â”Š 6â”Šoverwrite: true\n+â”Š  â”Š 7â”Šgenerates:\n+â”Š  â”Š 8â”Š  ./src/graphql/types.tsx:\n+â”Š  â”Š 9â”Š    plugins:\n+â”Š  â”Š10â”Š      - add: '/* eslint-disable */'\n+â”Š  â”Š11â”Š      - typescript\n+â”Š  â”Š12â”Š      - typescript-operations\n+â”Š  â”Š13â”Š      - typescript-react-apollo\n+â”Š  â”Š14â”Š    # The combined options of all provided plug-ins\n+â”Š  â”Š15â”Š    # More information about the options below:\n+â”Š  â”Š16â”Š    # graphql-code-generator.com/docs/plugins/typescript-react-apollo#configuration\n+â”Š  â”Š17â”Š    config:\n+â”Š  â”Š18â”Š      withHOC: false\n+â”Š  â”Š19â”Š      withHooks: true\n+â”Š  â”Š20â”Š      withComponent: false\n```\n\n[}]: #\n\nNotice that we sent the schema as a local path.\nWe could have also provided a GraphQL endpoint that exposes a GraphQL schema.\nThis way if there's an existing running GraphQL API, we can generate TypeScript types out of it, such as GitHub's GraphQL API.\nThe advantages of providing a local path is that the server doesn't have to be running in order to generate types, which is more comfortable in development, and we can bypass authentication if the endpoint is guarded with such mechanism.\nThis will be useful in further chapters when we're introduced to the concept of authentication.\n\nBe sure to add a .gitignore rule because we want to run the generator every time there is a change and don't want to rely on old generated types:\n\n[{]: <helper> (diffStep 9.1 files=\".gitignore\" module=\"client\")\n\n#### [__Client__ Step 9.1: Setup GraphQL Code Generator](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/5c1f40f687e82a15a412a002630631fe2328f7c7)\n\n##### Changed .gitignore\n```diff\n@@ -21,3 +21,5 @@\n â”Š21â”Š21â”Šnpm-debug.log*\n â”Š22â”Š22â”Šyarn-debug.log*\n â”Š23â”Š23â”Šyarn-error.log*\n+â”Š  â”Š24â”Š\n+â”Š  â”Š25â”Šsrc/graphql/types.tsx\n```\n\n[}]: #\n\nNow we have TypeScript types available to us and we can replace `useQuery()` and `useMutation()` calls with the generated React hooks.\nLet's use those and also remove all the old manual typings:\n\n[{]: <helper> (diffStep 9.2 module=\"client\")\n\n#### [__Client__ Step 9.2: Use GraphQL Codegen hooks](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/e288cfe6c8b95992a94e1947c74454f6e8f963a3)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;ChatNavbar.tsx\n```diff\n@@ -5,7 +5,6 @@\n â”Š 5â”Š 5â”Šimport { useCallback } from 'react';\n â”Š 6â”Š 6â”Šimport styled from 'styled-components';\n â”Š 7â”Š 7â”Šimport { History } from 'history';\n-â”Š 8â”Š  â”Šimport { ChatQueryResult } from './index';\n â”Š 9â”Š 8â”Š\n â”Š10â”Š 9â”Šconst Container = styled(Toolbar)`\n â”Š11â”Š10â”Š  padding: 0;\n```\n```diff\n@@ -37,7 +36,10 @@\n â”Š37â”Š36â”Š\n â”Š38â”Š37â”Šinterface ChatNavbarProps {\n â”Š39â”Š38â”Š  history: History;\n-â”Š40â”Š  â”Š  chat: ChatQueryResult;\n+â”Š  â”Š39â”Š  chat?: {\n+â”Š  â”Š40â”Š    picture?: string | null;\n+â”Š  â”Š41â”Š    name?: string | null;\n+â”Š  â”Š42â”Š  };\n â”Š41â”Š43â”Š}\n â”Š42â”Š44â”Š\n â”Š43â”Š45â”Šconst ChatNavbar: React.FC<ChatNavbarProps> = ({ chat, history }) => {\n```\n```diff\n@@ -50,8 +52,12 @@\n â”Š50â”Š52â”Š      <BackButton data-testid=\"back-button\" onClick={navBack}>\n â”Š51â”Š53â”Š        <ArrowBackIcon />\n â”Š52â”Š54â”Š      </BackButton>\n-â”Š53â”Š  â”Š      <Picture data-testid=\"chat-picture\" src={chat.picture} />\n-â”Š54â”Š  â”Š      <Name data-testid=\"chat-name\">{chat.name}</Name>\n+â”Š  â”Š55â”Š      {chat && chat.picture && chat.name && (\n+â”Š  â”Š56â”Š        <React.Fragment>\n+â”Š  â”Š57â”Š          <Picture data-testid=\"chat-picture\" src={chat.picture} />\n+â”Š  â”Š58â”Š          <Name data-testid=\"chat-name\">{chat.name}</Name>\n+â”Š  â”Š59â”Š        </React.Fragment>\n+â”Š  â”Š60â”Š      )}\n â”Š55â”Š61â”Š    </Container>\n â”Š56â”Š62â”Š  );\n â”Š57â”Š63â”Š};\n```\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;MessagesList.tsx\n```diff\n@@ -3,7 +3,6 @@\n â”Š3â”Š3â”Šimport { useEffect, useRef } from 'react';\n â”Š4â”Š4â”Šimport ReactDOM from 'react-dom';\n â”Š5â”Š5â”Šimport styled from 'styled-components';\n-â”Š6â”Š â”Šimport { ChatQueryMessage } from './index';\n â”Š7â”Š6â”Š\n â”Š8â”Š7â”Šconst Container = styled.div`\n â”Š9â”Š8â”Š  display: block;\n```\n```diff\n@@ -62,8 +61,13 @@\n â”Š62â”Š61â”Š  font-size: 12px;\n â”Š63â”Š62â”Š`;\n â”Š64â”Š63â”Š\n+â”Š  â”Š64â”Šinterface Message {\n+â”Š  â”Š65â”Š  id: string | null;\n+â”Š  â”Š66â”Š  content: string | null;\n+â”Š  â”Š67â”Š  createdAt: string | null;\n+â”Š  â”Š68â”Š}\n â”Š65â”Š69â”Šinterface MessagesListProps {\n-â”Š66â”Š  â”Š  messages: Array<ChatQueryMessage>;\n+â”Š  â”Š70â”Š  messages: Array<Message>;\n â”Š67â”Š71â”Š}\n â”Š68â”Š72â”Š\n â”Š69â”Š73â”Šconst MessagesList: React.FC<MessagesListProps> = ({ messages }) => {\n```\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -2,12 +2,12 @@\n â”Š 2â”Š 2â”Šimport gql from 'graphql-tag';\n â”Š 3â”Š 3â”Šimport React from 'react';\n â”Š 4â”Š 4â”Šimport { useCallback } from 'react';\n-â”Š 5â”Š  â”Šimport { useQuery, useMutation } from '@apollo/react-hooks';\n â”Š 6â”Š 5â”Šimport styled from 'styled-components';\n â”Š 7â”Š 6â”Šimport ChatNavbar from './ChatNavbar';\n â”Š 8â”Š 7â”Šimport MessageInput from './MessageInput';\n â”Š 9â”Š 8â”Šimport MessagesList from './MessagesList';\n â”Š10â”Š 9â”Šimport { History } from 'history';\n+â”Š  â”Š10â”Šimport { ChatsQuery, useGetChatQuery, useAddMessageMutation } from '../../graphql/types';\n â”Š11â”Š11â”Šimport * as queries from '../../graphql/queries';\n â”Š12â”Š12â”Šimport * as fragments from '../../graphql/fragments';\n â”Š13â”Š13â”Š\n```\n```diff\n@@ -18,6 +18,7 @@\n â”Š18â”Š18â”Š  height: 100vh;\n â”Š19â”Š19â”Š`;\n â”Š20â”Š20â”Š\n+â”Š  â”Š21â”Š// eslint-disable-next-line\n â”Š21â”Š22â”Šconst getChatQuery = gql`\n â”Š22â”Š23â”Š  query GetChat($chatId: ID!) {\n â”Š23â”Š24â”Š    chat(chatId: $chatId) {\n```\n```diff\n@@ -27,6 +28,7 @@\n â”Š27â”Š28â”Š  ${fragments.fullChat}\n â”Š28â”Š29â”Š`;\n â”Š29â”Š30â”Š\n+â”Š  â”Š31â”Š// eslint-disable-next-line\n â”Š30â”Š32â”Šconst addMessageMutation = gql`\n â”Š31â”Š33â”Š  mutation AddMessage($chatId: ID!, $content: String!) {\n â”Š32â”Š34â”Š    addMessage(chatId: $chatId, content: $content) {\n```\n```diff\n@@ -41,21 +43,6 @@\n â”Š41â”Š43â”Š  history: History;\n â”Š42â”Š44â”Š}\n â”Š43â”Š45â”Š\n-â”Š44â”Š  â”Šexport interface ChatQueryMessage {\n-â”Š45â”Š  â”Š  id: string;\n-â”Š46â”Š  â”Š  content: string;\n-â”Š47â”Š  â”Š  createdAt: Date;\n-â”Š48â”Š  â”Š}\n-â”Š49â”Š  â”Š\n-â”Š50â”Š  â”Šexport interface ChatQueryResult {\n-â”Š51â”Š  â”Š  id: string;\n-â”Š52â”Š  â”Š  name: string;\n-â”Š53â”Š  â”Š  picture: string;\n-â”Š54â”Š  â”Š  messages: Array<ChatQueryMessage>;\n-â”Š55â”Š  â”Š}\n-â”Š56â”Š  â”Š\n-â”Š57â”Š  â”Štype OptionalChatQueryResult = ChatQueryResult | null;\n-â”Š58â”Š  â”Š\n â”Š59â”Š46â”Šinterface ChatsResult {\n â”Š60â”Š47â”Š  chats: any[];\n â”Š61â”Š48â”Š}\n```\n```diff\n@@ -64,15 +51,20 @@\n â”Š64â”Š51â”Š  history,\n â”Š65â”Š52â”Š  chatId,\n â”Š66â”Š53â”Š}) => {\n-â”Š67â”Š  â”Š  const {\n-â”Š68â”Š  â”Š    data: { chat },\n-â”Š69â”Š  â”Š  } = useQuery<any>(getChatQuery, {\n+â”Š  â”Š54â”Š  const { data, loading } = useGetChatQuery({\n â”Š70â”Š55â”Š    variables: { chatId },\n â”Š71â”Š56â”Š  });\n-â”Š72â”Š  â”Š  const [addMessage] = useMutation(addMessageMutation);\n+â”Š  â”Š57â”Š\n+â”Š  â”Š58â”Šconst [addMessage] = useAddMessageMutation();\n â”Š73â”Š59â”Š\n â”Š74â”Š60â”Š  const onSendMessage = useCallback(\n â”Š75â”Š61â”Š    (content: string) => {\n+â”Š  â”Š62â”Š      if (data === undefined) {\n+â”Š  â”Š63â”Š        return null;\n+â”Š  â”Š64â”Š      }\n+â”Š  â”Š65â”Š      const chat = data.chat;\n+â”Š  â”Š66â”Š      if (chat === null) return null;\n+â”Š  â”Š67â”Š\n â”Š76â”Š68â”Š      addMessage({\n â”Š77â”Š69â”Š        variables: { chatId, content },\n â”Š78â”Š70â”Š        optimisticResponse: {\n```\n```diff\n@@ -89,12 +81,12 @@\n â”Š 89â”Š 81â”Š        update: (client, { data: { addMessage } }) => {\n â”Š 90â”Š 82â”Š          type FullChat = { [key: string]: any };\n â”Š 91â”Š 83â”Š          let fullChat;\n+â”Š   â”Š 84â”Š\n â”Š 92â”Š 85â”Š          const chatIdFromStore = defaultDataIdFromObject(chat);\n â”Š 93â”Š 86â”Š\n â”Š 94â”Š 87â”Š          if (chatIdFromStore === null) {\n â”Š 95â”Š 88â”Š            return;\n â”Š 96â”Š 89â”Š          }\n-â”Š 97â”Š   â”Š\n â”Š 98â”Š 90â”Š          try {\n â”Š 99â”Š 91â”Š            fullChat = client.readFragment<FullChat>({\n â”Š100â”Š 92â”Š              id: chatIdFromStore,\n```\n```diff\n@@ -105,11 +97,10 @@\n â”Š105â”Š 97â”Š            return;\n â”Š106â”Š 98â”Š          }\n â”Š107â”Š 99â”Š\n-â”Š108â”Š   â”Š          if (fullChat === null) {\n+â”Š   â”Š100â”Š          if (fullChat === null || fullChat.messages === null) {\n â”Š109â”Š101â”Š            return;\n â”Š110â”Š102â”Š          }\n-â”Š111â”Š   â”Š          if (fullChat.messages.some((m: any) => m.id === addMessage.id))\n-â”Š112â”Š   â”Š            return;\n+â”Š   â”Š103â”Š          if (fullChat.messages.some((currentMessage: any) => currentMessage.id === addMessage.id)) return;\n â”Š113â”Š104â”Š\n â”Š114â”Š105â”Š          fullChat.messages.push(addMessage);\n â”Š115â”Š106â”Š          fullChat.lastMessage = addMessage;\n```\n```diff\n@@ -121,24 +112,24 @@\n â”Š121â”Š112â”Š            data: fullChat,\n â”Š122â”Š113â”Š          });\n â”Š123â”Š114â”Š\n-â”Š124â”Š   â”Š          let data;\n+â”Š   â”Š115â”Š          let data: ChatsQuery | null;\n â”Š125â”Š116â”Š          try {\n-â”Š126â”Š   â”Š            data = client.readQuery<ChatsResult>({\n+â”Š   â”Š117â”Š            data = client.readQuery({\n â”Š127â”Š118â”Š              query: queries.chats,\n â”Š128â”Š119â”Š            });\n â”Š129â”Š120â”Š          } catch (e) {\n â”Š130â”Š121â”Š            return;\n â”Š131â”Š122â”Š          }\n â”Š132â”Š123â”Š\n-â”Š133â”Š   â”Š          if (!data || data === null) {\n-â”Š134â”Š   â”Š            return null;\n-â”Š135â”Š   â”Š          }\n-â”Š136â”Š   â”Š          if (!data.chats || data.chats === undefined) {\n+â”Š   â”Š124â”Š          if (!data || !data.chats) {\n â”Š137â”Š125â”Š            return null;\n â”Š138â”Š126â”Š          }\n â”Š139â”Š127â”Š          const chats = data.chats;\n â”Š140â”Š128â”Š\n-â”Š141â”Š   â”Š          const chatIndex = chats.findIndex((c: any) => c.id === chatId);\n+â”Š   â”Š129â”Š          const chatIndex = chats.findIndex((c: any) => {\n+â”Š   â”Š130â”Š            if (addMessage === null || addMessage.chat === null) return -1;\n+â”Š   â”Š131â”Š            return c.id === addMessage.chat.id;\n+â”Š   â”Š132â”Š          });\n â”Š142â”Š133â”Š          if (chatIndex === -1) return;\n â”Š143â”Š134â”Š          const chatWhereAdded = chats[chatIndex];\n â”Š144â”Š135â”Š\n```\n```diff\n@@ -153,10 +144,17 @@\n â”Š153â”Š144â”Š        },\n â”Š154â”Š145â”Š      });\n â”Š155â”Š146â”Š    },\n-â”Š156â”Š   â”Š    [chat, chatId, addMessage]\n+â”Š   â”Š147â”Š    [data, chatId, addMessage]\n â”Š157â”Š148â”Š  );\n â”Š158â”Š149â”Š\n-â”Š159â”Š   â”Š  if (!chat) return null;\n+â”Š   â”Š150â”Š  if (data === undefined) {\n+â”Š   â”Š151â”Š    return null;\n+â”Š   â”Š152â”Š  }\n+â”Š   â”Š153â”Š  const chat = data.chat;\n+â”Š   â”Š154â”Š  const loadingChat = loading;\n+â”Š   â”Š155â”Š\n+â”Š   â”Š156â”Š  if (loadingChat) return null;\n+â”Š   â”Š157â”Š  if (chat === null) return null;\n â”Š160â”Š158â”Š\n â”Š161â”Š159â”Š  return (\n â”Š162â”Š160â”Š    <Container>\n```\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -4,8 +4,7 @@\n â”Š 4â”Š 4â”Šimport styled from 'styled-components';\n â”Š 5â”Š 5â”Šimport { useCallback } from 'react';\n â”Š 6â”Š 6â”Šimport { History } from 'history';\n-â”Š 7â”Š  â”Šimport { useQuery } from '@apollo/react-hooks';\n-â”Š 8â”Š  â”Šimport * as queries from '../../graphql/queries';\n+â”Š  â”Š 7â”Šimport { useChatsQuery } from '../../graphql/types';\n â”Š 9â”Š 8â”Š\n â”Š10â”Š 9â”Šconst Container = styled.div`\n â”Š11â”Š10â”Š  height: calc(100% - 56px);\n```\n```diff\n@@ -64,8 +63,6 @@\n â”Š64â”Š63â”Š}\n â”Š65â”Š64â”Š\n â”Š66â”Š65â”Šconst ChatsList: React.FC<ChatsListProps> = ({ history }) => {\n-â”Š67â”Š  â”Š  const { data } = useQuery<any>(queries.chats);\n-â”Š68â”Š  â”Š\n â”Š69â”Š66â”Š  const navToChat = useCallback(\n â”Š70â”Š67â”Š    chat => {\n â”Š71â”Š68â”Š      history.push(`chats/${chat.id}`);\n```\n```diff\n@@ -73,6 +70,8 @@\n â”Š73â”Š70â”Š    [history]\n â”Š74â”Š71â”Š  );\n â”Š75â”Š72â”Š\n+â”Š  â”Š73â”Š  const { data } = useChatsQuery();\n+â”Š  â”Š74â”Š\n â”Š76â”Š75â”Š  if (data === undefined || data.chats === undefined) {\n â”Š77â”Š76â”Š    return null;\n â”Š78â”Š77â”Š  }\n```\n\n[}]: #\n\nTo test if things are working properly, we can address a non existing field in one of the retrieved query results, for example `chat.foo` in `useGetChatQuery()`.\nWe should receive the following typing error when trying to run the project:\n\n```\nTypeScript error: Property 'foo' does not exist on type '{ __typename?: \"Chat\"; } & { __typename?: \"Chat\"; } & { messages: ({ __typename?: \"Message\"; } & { __typename?: \"Message\"; } & Pick<Message, \"id\" | \"createdAt\" | \"content\">)[]; } & { __typename?: \"Chat\"; } & Pick<...> & { ...; }'.  TS2339\n\n    44 |   const addMessage = useAddMessageMutation()\n    45 |\n  > 46 |   console.log(chat.foo)\n       |                    ^\n    47 |\n    48 |   const onSendMessage = useCallback((content) => {\n    49 |     addMessage({\n```\n\nTODO: Mappers are not explained - The root types of Message resolvers - doesnâ€™t say much\nwe donâ€™t need to use `resolvers as IResolvers`, thereâ€™s a flag for it, in codegen\n\nTODO: Change `gql-gen` to `graphql-codegen`"
          },
          {
            "manualTitle": "Step 10: Live updates with GraphQL subscriptions",
            "stepRevision": "5b88a2be67b69a8f0826a171b67558e24c0bbe8b",
            "manualView": "So far we've been developing the app and we've been treating it as if there's no other users; we're the only one exists.\nThis approach is true when we want to develop a UI and focus on UX, but comes a point where we need to start thinking on a macro level.\nOur app is social interactive, and if things work properly for me, it doesn't mean that it works properly to the fellow I'm chatting with.\nIt's inevitable to have an authentication system in our app, hence we need to take care of things before we get to that stage.\n\nTry to open 2 instances of the app in 2 separate tabs/windows, and navigate into the same chat room.\nTry to send a message with one instance and notice that the second instance doesn't update unless we refresh the page.\n\n\n![ezgif com-video-to-gif (2)](https://user-images.githubusercontent.com/7648874/55079371-fbd87080-50d6-11e9-8ade-5ffeed6eaf8d.gif)\n\n\nThis issue is very important and should be addressed, because a chat is all about sending and receiving messages on a lively basis.\nThis issue was expected, as there's no mechanism that would trigger and listen to changes in the back-end.\nIn this chapter we're gonna address that issue by implementing exactly that mechanism.\n\n**Introducing: GraphQL Subscriptions**\n\n[GraphQL subscriptions](https://github.com/apollographql/graphql-subscriptions) is a mechanism that works on [web-sockets](https://en.wikipedia.org/wiki/WebSocket) and live communication; clients can subscribe to it and be notified regards specific changes that happen in the back-end. Notifications will be triggered manually by us and can be provided with parameters that provide additional information regards the triggered event. For example, a `messageAdded` will be published with the new message, and will notify all clients who are subscribed to that event. Once the subscribers are notified, they can respond as they would like to, such as updating the UI.\n\n\n\n![subscription-notifications](https://user-images.githubusercontent.com/7648874/55079462-30e4c300-50d7-11e9-8399-7706da2a9cff.png)\n\n\nA subscription is presented in our GraphQL schema as a separate type called `Subscription`, where each field represents an event name along with its return type.\nLike any other GraphQL type, each field should be match with a resolver where we handle the request.\n\nIn this chapter we will implement the `messageAdded` subscription, so users can be notified when it happens and update the messages list to contain the new message.\n\n**Implementing a subscription**\n\nWe will start by creating a new `Subscription` type in our GraphQL schema with the field `messageAdded`:\n\n[{]: <helper> (diffStep 7.1 module=\"server\")\n\n#### [__Server__ Step 7.1: Add subscription type with messageAdded](https://github.com/Urigo/WhatsApp-Clone-Server/commit/314aba0c70eab163568f8dc3079667f8d21f2149)\n\n##### Changed schema&#x2F;typeDefs.graphql\n```diff\n@@ -22,3 +22,7 @@\n â”Š22â”Š22â”Štype Mutation {\n â”Š23â”Š23â”Š  addMessage(chatId: ID!, content: String!): Message\n â”Š24â”Š24â”Š}\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Štype Subscription {\n+â”Š  â”Š27â”Š  messageAdded: Message!\n+â”Š  â”Š28â”Š}\n```\n\n[}]: #\n\nChanges are triggered using an event-emitter like object called `PubSub`. This can be done using the `PubSub.prototype.publish` method. We will create a new instance of it and will provide it via the [context](https://www.apollographql.com/docs/apollo-server/essentials/data#context) - a common pattern for providing objects which are useful for the execution of the resolvers:\n\nTODO: Explain what the context is\n\n[{]: <helper> (diffStep 7.2 module=\"server\")\n\n#### [__Server__ Step 7.2: Provide a new instance of PubSub to context](https://github.com/Urigo/WhatsApp-Clone-Server/commit/e55610b08457be01e9c40ed563733a9aacd17cbb)\n\n##### Changed index.ts\n```diff\n@@ -1,4 +1,4 @@\n-â”Š1â”Š â”Šimport { ApolloServer, gql } from 'apollo-server-express';\n+â”Š â”Š1â”Šimport { ApolloServer, gql, PubSub } from 'apollo-server-express';\n â”Š2â”Š2â”Šimport cors from 'cors';\n â”Š3â”Š3â”Šimport express from 'express';\n â”Š4â”Š4â”Šimport schema from './schema';\n```\n```diff\n@@ -12,7 +12,11 @@\n â”Š12â”Š12â”Š  res.send('pong');\n â”Š13â”Š13â”Š});\n â”Š14â”Š14â”Š\n-â”Š15â”Š  â”Šconst server = new ApolloServer({ schema });\n+â”Š  â”Š15â”Šconst pubsub = new PubSub();\n+â”Š  â”Š16â”Šconst server = new ApolloServer({\n+â”Š  â”Š17â”Š  schema,\n+â”Š  â”Š18â”Š  context: () => ({ pubsub }),\n+â”Š  â”Š19â”Š});\n â”Š16â”Š20â”Š\n â”Š17â”Š21â”Šserver.applyMiddleware({\n â”Š18â”Š22â”Š  app,\n```\n\n[}]: #\n\nInside the `addMessage` resolver we will publish a new event called `messageAdded`. The 3rd argument of the resolver will be the context object that we've just defined in the previous step, where we can use the pubsub instance. The TypeScript type of our context can be directly defined and generated by CodeGen through the `codegen.yml` file. This can be specified under the `ContextType` field with the file path that contains the context followed by the name of the exported object, like so:\n\n[{]: <helper> (diffStep 7.3 module=\"server\")\n\n#### [__Server__ Step 7.3: Define Context type](https://github.com/Urigo/WhatsApp-Clone-Server/commit/5b43a1bf8e6ef1bad385f0ac089f9a15231e0d42)\n\n##### Changed codegen.yml\n```diff\n@@ -6,6 +6,7 @@\n â”Š 6â”Š 6â”Š      - typescript\n â”Š 7â”Š 7â”Š      - typescript-resolvers\n â”Š 8â”Š 8â”Š    config:\n+â”Š  â”Š 9â”Š      contextType: ../context#MyContext\n â”Š 9â”Š10â”Š      mappers:\n â”Š10â”Š11â”Š        # import { Message } from '../db'\n â”Š11â”Š12â”Š        # The root types of Message resolvers\n```\n\n##### Added context.ts\n```diff\n@@ -0,0 +1,5 @@\n+â”Š â”Š1â”Šimport { PubSub } from 'apollo-server-express';\n+â”Š â”Š2â”Š\n+â”Š â”Š3â”Šexport type MyContext = {\n+â”Š â”Š4â”Š  pubsub: PubSub;\n+â”Š â”Š5â”Š};\n```\n\n[}]: #\n\nThe event will be published right after the message was pushed into the messages collection, because order is a crucial thing. We don't want to notify our users unless the change has been made. The event will have a single parameter which represents the new message.\n\n[{]: <helper> (diffStep 7.4 module=\"server\")\n\n#### [__Server__ Step 7.4: Publish message added event](https://github.com/Urigo/WhatsApp-Clone-Server/commit/61fc49b0da1a3a4609596cb8b46100d92458c876)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -28,7 +28,7 @@\n â”Š28â”Š28â”Š  },\n â”Š29â”Š29â”Š\n â”Š30â”Š30â”Š  Mutation: {\n-â”Š31â”Š  â”Š    addMessage(root, { chatId, content }) {\n+â”Š  â”Š31â”Š    addMessage(root, { chatId, content }, { pubsub }) {\n â”Š32â”Š32â”Š      const chatIndex = chats.findIndex(c => c.id === chatId);\n â”Š33â”Š33â”Š\n â”Š34â”Š34â”Š      if (chatIndex === -1) return null;\n```\n```diff\n@@ -49,6 +49,10 @@\n â”Š49â”Š49â”Š      chats.splice(chatIndex, 1);\n â”Š50â”Š50â”Š      chats.unshift(chat);\n â”Š51â”Š51â”Š\n+â”Š  â”Š52â”Š      pubsub.publish('messageAdded', {\n+â”Š  â”Š53â”Š        messageAdded: message,\n+â”Š  â”Š54â”Š      });\n+â”Š  â”Š55â”Š\n â”Š52â”Š56â”Š      return message;\n â”Š53â”Š57â”Š    },\n â”Š54â”Š58â”Š  },\n```\n\n##### Changed tests&#x2F;mutations&#x2F;addMessage.test.ts\n```diff\n@@ -1,5 +1,5 @@\n â”Š1â”Š1â”Šimport { createTestClient } from 'apollo-server-testing';\n-â”Š2â”Š â”Šimport { ApolloServer, gql } from 'apollo-server-express';\n+â”Š â”Š2â”Šimport { ApolloServer, PubSub, gql } from 'apollo-server-express';\n â”Š3â”Š3â”Šimport schema from '../../schema';\n â”Š4â”Š4â”Šimport { resetDb } from '../../db';\n â”Š5â”Š5â”Š\n```\n```diff\n@@ -7,7 +7,10 @@\n â”Š 7â”Š 7â”Š  beforeEach(resetDb);\n â”Š 8â”Š 8â”Š\n â”Š 9â”Š 9â”Š  it('should add message to specified chat', async () => {\n-â”Š10â”Š  â”Š    const server = new ApolloServer({ schema });\n+â”Š  â”Š10â”Š    const server = new ApolloServer({\n+â”Š  â”Š11â”Š      schema,\n+â”Š  â”Š12â”Š      context: () => ({ pubsub: new PubSub() }),\n+â”Š  â”Š13â”Š    });\n â”Š11â”Š14â”Š\n â”Š12â”Š15â”Š    const { query, mutate } = createTestClient(server);\n```\n\n[}]: #\n\nA subscription resolver behaves differently and thus should be implemented differently. Using the `pubsub.asyncIterator` instance, we can specify which events are relevant for the subscription, for example, all clients who are subscribers of the `chatUpdated` subscription will be notified when `messageAdded`, `messageRemoved` and `chatInfoChanged` events were triggered. For now, we will have a 1 to 1 relationship between the `messageAdded` event and `messageAdded` subscription. In code, it should look like this:\n\n[{]: <helper> (diffStep 7.5 module=\"server\")\n\n#### [__Server__ Step 7.5: Add Subscription.messageAdded resolver](https://github.com/Urigo/WhatsApp-Clone-Server/commit/6ca01b98512ca1a36af2c6e06da089b89e04e135)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -56,6 +56,13 @@\n â”Š56â”Š56â”Š      return message;\n â”Š57â”Š57â”Š    },\n â”Š58â”Š58â”Š  },\n+â”Š  â”Š59â”Š\n+â”Š  â”Š60â”Š  Subscription: {\n+â”Š  â”Š61â”Š    messageAdded: {\n+â”Š  â”Š62â”Š      subscribe: (root, args, { pubsub }) =>\n+â”Š  â”Š63â”Š        pubsub.asyncIterator('messageAdded'),\n+â”Š  â”Š64â”Š    },\n+â”Š  â”Š65â”Š  },\n â”Š59â”Š66â”Š};\n â”Š60â”Š67â”Š\n â”Š61â”Š68â”Šexport default resolvers;\n```\n\n[}]: #\n\nThe idea behind the `pubsub.asyncIterator` method is that it returns an [`Iterator`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Iterators_and_Generators#Iterators) like object, where each value is a promise that will be resolved when the relevant events are triggered. By default, the parameter that has a similar name to the subscription will be returned as a response, e.g. `messageAdded` parameter will be sent back to the subscribers. This behavior can be modified as explained [here](https://github.com/apollographql/graphql-subscriptions#payload-manipulation), but it's very unlikely and not necessary for our use case.\n\nAs mentioned at the beginning of this article, there needs to be an open connection between the client and the server so live updates can happen. There are serveral methods for doing so, but the 2 most popular ones are:\n\n\n\n*   Based on polling with HTTP protocol\n*   Based on web-sockets (WS protocol)\n\nHTTP polling means that each amount of time an HTTP request will be made to the server where potential changes can be sent back to us at any given time. HTTP requests are very reliable, but the problem with them is that they contain a lot of information in their headers, so even if we sent an empty request, it might be still very heavy due to cookies, user-agent, language, request type, etc.\n\nWith web-sockets, once a connection has been established, it will remain open and it will only send the information which is relevant for the current session, so it's much faster. The communication is between the server and the client is bi-directional when it comes to web-sockets, which means that a user can spontaneously receive information from the server, as long as the communication channel remains open.\n\n> More information about the advantages of Web Sockets over HTTP can be found at [websocket.org](http://websocket.org/quantum.html)\n\nThe subscription mechanism can be installed using the `server.installSubscriptionHandlers`. It will use the WS protocol by default and will fallback to HTTP polling if there were troubles establishing a connection via WS protocol:\n\n[{]: <helper> (diffStep 7.6 module=\"server\")\n\n#### [__Server__ Step 7.6: Install subscription handlers](https://github.com/Urigo/WhatsApp-Clone-Server/commit/ec7bceb1ac111cd9bdb7c99bb4b8794ec49b4287)\n\n##### Changed index.ts\n```diff\n@@ -1,6 +1,7 @@\n â”Š1â”Š1â”Šimport { ApolloServer, gql, PubSub } from 'apollo-server-express';\n â”Š2â”Š2â”Šimport cors from 'cors';\n â”Š3â”Š3â”Šimport express from 'express';\n+â”Š â”Š4â”Šimport http from 'http';\n â”Š4â”Š5â”Šimport schema from './schema';\n â”Š5â”Š6â”Š\n â”Š6â”Š7â”Šconst app = express();\n```\n```diff\n@@ -23,8 +24,11 @@\n â”Š23â”Š24â”Š  path: '/graphql',\n â”Š24â”Š25â”Š});\n â”Š25â”Š26â”Š\n+â”Š  â”Š27â”Šconst httpServer = http.createServer(app);\n+â”Š  â”Š28â”Šserver.installSubscriptionHandlers(httpServer);\n+â”Š  â”Š29â”Š\n â”Š26â”Š30â”Šconst port = process.env.PORT || 4000;\n â”Š27â”Š31â”Š\n-â”Š28â”Š  â”Šapp.listen(port, () => {\n+â”Š  â”Š32â”ŠhttpServer.listen(port, () => {\n â”Š29â”Š33â”Š  console.log(`Server is listening on port ${port}`);\n â”Š30â”Š34â”Š});\n```\n\n[}]: #\n\nNow we have everything set and we can start listening to subscriptions and react to to triggered changes.\n\n**Using subscriptions**\n\nTo support subscriptions we need to establish a WS connection. For that we will need to update our Apollo client. We will install a couple of packages that will enable such feature:\n\n    $ yarn add subscriptions-transport-ws apollo-link apollo-link-ws apollo-utilities\n\n\n*   [`subscriptions-transport-ws`](https://www.npmjs.com/package/subscriptions-transport-ws) - a transport layer that understands how client and GraphQL API communicates with each other. The spec has GQL_INIT GQL_UPDATE GQL_DATA events.\n*   [`apollo-link-ws`](https://www.npmjs.com/package/apollo-link-ws) - Will establish a WS connection.\n*   [`apollo-link`](https://www.npmjs.com/package/apollo-link) - Will enable WS and HTTP connections co-exist in a single client.\n*   [`apollo-utilities`](https://www.npmjs.com/package/apollo-utilities) - Includes utility functions that will help us analyze a GraphQL AST.\n\nThe WS url can be composed by simply running a regular expression over the `REACT_APP_SERVER_URL` environment variable and is unnecessary to be stored separately. Here's how our new client should look like: \\\n\n\n[{]: <helper> (diffStep 10.1 files=\"client\" module=\"client\")\n\n#### [__Client__ Step 10.1: Setup WS link](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/554f5694c59eddcbcf68813a2b70c752298d343e)\n\n##### Changed src&#x2F;client.ts\n```diff\n@@ -1,16 +1,40 @@\n â”Š 1â”Š 1â”Šimport { InMemoryCache } from 'apollo-cache-inmemory';\n â”Š 2â”Š 2â”Šimport { ApolloClient } from 'apollo-client';\n+â”Š  â”Š 3â”Šimport { getMainDefinition } from 'apollo-utilities';\n â”Š 3â”Š 4â”Šimport { HttpLink } from 'apollo-link-http';\n+â”Š  â”Š 5â”Šimport { WebSocketLink } from 'apollo-link-ws';\n+â”Š  â”Š 6â”Šimport { ApolloLink, split } from 'apollo-link';\n â”Š 4â”Š 7â”Š\n â”Š 5â”Š 8â”Šconst httpUri = process.env.REACT_APP_SERVER_URL + '/graphql';\n+â”Š  â”Š 9â”Šconst wsUri = httpUri.replace(/^https?/, 'ws');\n â”Š 6â”Š10â”Š\n â”Š 7â”Š11â”Šconst httpLink = new HttpLink({\n â”Š 8â”Š12â”Š  uri: httpUri,\n â”Š 9â”Š13â”Š});\n â”Š10â”Š14â”Š\n+â”Š  â”Š15â”Šconst wsLink = new WebSocketLink({\n+â”Š  â”Š16â”Š  uri: wsUri,\n+â”Š  â”Š17â”Š  options: {\n+â”Š  â”Š18â”Š    // Automatic reconnect in case of connection error\n+â”Š  â”Š19â”Š    reconnect: true,\n+â”Š  â”Š20â”Š  },\n+â”Š  â”Š21â”Š});\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Šconst terminatingLink = split(\n+â”Š  â”Š24â”Š  ({ query }) => {\n+â”Š  â”Š25â”Š    const { kind, operation } = getMainDefinition(query);\n+â”Š  â”Š26â”Š    // If this is a subscription query, use wsLink, otherwise use httpLink\n+â”Š  â”Š27â”Š    return kind === 'OperationDefinition' && operation === 'subscription';\n+â”Š  â”Š28â”Š  },\n+â”Š  â”Š29â”Š  wsLink,\n+â”Š  â”Š30â”Š  httpLink\n+â”Š  â”Š31â”Š);\n+â”Š  â”Š32â”Š\n+â”Š  â”Š33â”Šconst link = ApolloLink.from([terminatingLink]);\n+â”Š  â”Š34â”Š\n â”Š11â”Š35â”Šconst inMemoryCache = new InMemoryCache();\n â”Š12â”Š36â”Š\n â”Š13â”Š37â”Šexport default new ApolloClient({\n-â”Š14â”Š  â”Š  link: httpLink,\n+â”Š  â”Š38â”Š  link,\n â”Š15â”Š39â”Š  cache: inMemoryCache,\n â”Š16â”Š40â”Š});\n```\n\n[}]: #\n\nOur subscription listeners should live globally across our application and shouldn't be bound to a specific component, thus we will create an external service which will be responsible of doing so. Using that service, we will update our GraphQL data-store any time a new message has been added. We will define a `messageAdded` subscription in a dedicated file under the `src/graphql/subscriptions` dir where all our subscriptions will be defined and exported:\n\n[comment]: # (but they are anyway. Itâ€™s just a standalone function that is used in a component. Which makes no difference.)\n\n[{]: <helper> (diffStep 10.2 module=\"client\")\n\n#### [__Client__ Step 10.2: Add messageAdded subscription document](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/383eb6a56cf604956f19fc8b51f17058e3fa6194)\n\n##### Added src&#x2F;graphql&#x2F;subscriptions&#x2F;index.ts\n```diff\n@@ -0,0 +1 @@\n+â”Š â”Š1â”Šexport { default as messageAdded } from './messageAdded.subscription';\n```\n\n##### Added src&#x2F;graphql&#x2F;subscriptions&#x2F;messageAdded.subscription.ts\n```diff\n@@ -0,0 +1,11 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag';\n+â”Š  â”Š 2â”Šimport * as fragments from '../fragments';\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šexport default gql`\n+â”Š  â”Š 5â”Š  subscription MessageAdded {\n+â”Š  â”Š 6â”Š    messageAdded {\n+â”Š  â”Š 7â”Š      ...Message\n+â”Š  â”Š 8â”Š    }\n+â”Š  â”Š 9â”Š  }\n+â”Š  â”Š10â”Š  ${fragments.message}\n+â”Š  â”Š11â”Š`;\n```\n\n[}]: #\n\nNow we will create the service under the path `services/cache.service.ts`.\nLike any other GraphQL operation, `@apollo/react-hooks` provides us with a dedicated React hook for subscriptions called `useSubscription`.\n\nGiven the subscription document and the `onSubscriptionData` callback we can handle incoming changes.\nWe will be using GraphQL Code Generator to generate typed subscription hooks, as the `typescript-react-apollo` plug-in supports it right out of the box.\n\nFirst let's update the `codegen.yml` file to look for documents in the `graphql/subscriptions` dir:\n\n[{]: <helper> (diffStep 10.3 module=\"client\")\n\n#### [__Client__ Step 10.3: Include subscription documents in codegen.yml](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/999d5181400cf216ee6f8b9e575dfd54236f724f)\n\n##### Changed codegen.yml\n```diff\n@@ -3,6 +3,7 @@\n â”Š3â”Š3â”Š  - ./src/components/**/*.tsx\n â”Š4â”Š4â”Š  - ./src/graphql/fragments/**/*.ts\n â”Š5â”Š5â”Š  - ./src/graphql/queries/**/*.ts\n+â”Š â”Š6â”Š  - ./src/graphql/subscriptions/**/*.ts\n â”Š6â”Š7â”Šoverwrite: true\n â”Š7â”Š8â”Šgenerates:\n â”Š8â”Š9â”Š  ./src/graphql/types.tsx:\n```\n\n[}]: #\n\nAnd then we will type the code generation command:\n\n    $ npm run codegen\n\nNow we can import and use the newly generated hook `useMessageAddedSubscription` in the `cache.service`. Like mentioned earlier, we will be using the `onSubscriptionData` callback to retrieve the change that was sent by the server and we will use it to re-write our cache. In this case we will be writing a new fragment for the incoming message, and we will update the correlated chat:\n\n[{]: <helper> (diffStep 10.4 files=\"cache.service\" module=\"client\")\n\n#### [__Client__ Step 10.4: Update cache on message added](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/9d4030533d12c4df52c26f814dbe51047e101077)\n\n##### Added src&#x2F;services&#x2F;cache.service.ts\n```diff\n@@ -0,0 +1,86 @@\n+â”Š  â”Š 1â”Šimport { DataProxy } from 'apollo-cache';\n+â”Š  â”Š 2â”Šimport { defaultDataIdFromObject } from 'apollo-cache-inmemory';\n+â”Š  â”Š 3â”Šimport { ApolloClient } from 'apollo-client';\n+â”Š  â”Š 4â”Šimport * as fragments from '../graphql/fragments';\n+â”Š  â”Š 5â”Šimport * as queries from '../graphql/queries';\n+â”Š  â”Š 6â”Šimport { MessageFragment, useMessageAddedSubscription } from '../graphql/types';\n+â”Š  â”Š 7â”Š\n+â”Š  â”Š 8â”Štype Client = ApolloClient<any> | DataProxy;\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Šexport const useCacheService = () => {\n+â”Š  â”Š11â”Š  useMessageAddedSubscription({\n+â”Š  â”Š12â”Š    onSubscriptionData: ({ client, subscriptionData: { data } }) => {\n+â”Š  â”Š13â”Š      if (data) {\n+â”Š  â”Š14â”Š        writeMessage(client, data.messageAdded);\n+â”Š  â”Š15â”Š      }\n+â”Š  â”Š16â”Š    },\n+â”Š  â”Š17â”Š  });\n+â”Š  â”Š18â”Š};\n+â”Š  â”Š19â”Š\n+â”Š  â”Š20â”Šexport const writeMessage = (client: Client, message: MessageFragment) => {\n+â”Š  â”Š21â”Š  type FullChat = { [key: string]: any };\n+â”Š  â”Š22â”Š  let fullChat;\n+â”Š  â”Š23â”Š\n+â”Š  â”Š24â”Š  const chatIdFromStore = defaultDataIdFromObject(message.chat);\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Š  if (chatIdFromStore === null) {\n+â”Š  â”Š27â”Š    return;\n+â”Š  â”Š28â”Š  }\n+â”Š  â”Š29â”Š  try {\n+â”Š  â”Š30â”Š    fullChat = client.readFragment<FullChat>({\n+â”Š  â”Š31â”Š      id: chatIdFromStore,\n+â”Š  â”Š32â”Š      fragment: fragments.fullChat,\n+â”Š  â”Š33â”Š      fragmentName: 'FullChat',\n+â”Š  â”Š34â”Š    });\n+â”Š  â”Š35â”Š  } catch (e) {\n+â”Š  â”Š36â”Š    return;\n+â”Š  â”Š37â”Š  }\n+â”Š  â”Š38â”Š\n+â”Š  â”Š39â”Š  if (fullChat === null || fullChat.messages === null) {\n+â”Š  â”Š40â”Š    return;\n+â”Š  â”Š41â”Š  }\n+â”Š  â”Š42â”Š  if (fullChat.messages.some((m: any) => m.id === message.id)) return;\n+â”Š  â”Š43â”Š\n+â”Š  â”Š44â”Š  fullChat.messages.push(message);\n+â”Š  â”Š45â”Š  fullChat.lastMessage = message;\n+â”Š  â”Š46â”Š\n+â”Š  â”Š47â”Š  client.writeFragment({\n+â”Š  â”Š48â”Š    id: chatIdFromStore,\n+â”Š  â”Š49â”Š    fragment: fragments.fullChat,\n+â”Š  â”Š50â”Š    fragmentName: 'FullChat',\n+â”Š  â”Š51â”Š    data: fullChat,\n+â”Š  â”Š52â”Š  });\n+â”Š  â”Š53â”Š\n+â”Š  â”Š54â”Š  let data;\n+â”Š  â”Š55â”Š  try {\n+â”Š  â”Š56â”Š    data = client.readQuery({\n+â”Š  â”Š57â”Š      query: queries.chats,\n+â”Š  â”Š58â”Š    });\n+â”Š  â”Š59â”Š  } catch (e) {\n+â”Š  â”Š60â”Š    return;\n+â”Š  â”Š61â”Š  }\n+â”Š  â”Š62â”Š\n+â”Š  â”Š63â”Š  if (!data || data === null) {\n+â”Š  â”Š64â”Š    return null;\n+â”Š  â”Š65â”Š  }\n+â”Š  â”Š66â”Š  if (!data.chats || data.chats === undefined) {\n+â”Š  â”Š67â”Š    return null;\n+â”Š  â”Š68â”Š  }\n+â”Š  â”Š69â”Š  const chats = data.chats;\n+â”Š  â”Š70â”Š\n+â”Š  â”Š71â”Š  const chatIndex = chats.findIndex((c: any) => {\n+â”Š  â”Š72â”Š    if (message === null || message.chat === null) return -1;\n+â”Š  â”Š73â”Š    return c.id === message.chat.id;\n+â”Š  â”Š74â”Š  });\n+â”Š  â”Š75â”Š  if (chatIndex === -1) return;\n+â”Š  â”Š76â”Š  const chatWhereAdded = chats[chatIndex];\n+â”Š  â”Š77â”Š\n+â”Š  â”Š78â”Š  // The chat will appear at the top of the ChatsList component\n+â”Š  â”Š79â”Š  chats.splice(chatIndex, 1);\n+â”Š  â”Š80â”Š  chats.unshift(chatWhereAdded);\n+â”Š  â”Š81â”Š\n+â”Š  â”Š82â”Š  client.writeQuery({\n+â”Š  â”Š83â”Š    query: queries.chats,\n+â”Š  â”Š84â”Š    data: { chats: chats },\n+â”Š  â”Š85â”Š  });\n+â”Š  â”Š86â”Š};\n```\n\n[}]: #\n\nWe will also use the exported `writeMessage()` function in the `ChatRoomScreen` so we won't have any code duplications:\n\n[{]: <helper> (diffStep 10.4 files=\"ChatRoom\" module=\"client\")\n\n#### [__Client__ Step 10.4: Update cache on message added](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/9d4030533d12c4df52c26f814dbe51047e101077)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -1,4 +1,3 @@\n-â”Š1â”Š â”Šimport { defaultDataIdFromObject } from 'apollo-cache-inmemory';\n â”Š2â”Š1â”Šimport gql from 'graphql-tag';\n â”Š3â”Š2â”Šimport React from 'react';\n â”Š4â”Š3â”Šimport { useCallback } from 'react';\n```\n```diff\n@@ -7,9 +6,9 @@\n â”Š 7â”Š 6â”Šimport MessageInput from './MessageInput';\n â”Š 8â”Š 7â”Šimport MessagesList from './MessagesList';\n â”Š 9â”Š 8â”Šimport { History } from 'history';\n-â”Š10â”Š  â”Šimport { ChatsQuery, useGetChatQuery, useAddMessageMutation } from '../../graphql/types';\n-â”Š11â”Š  â”Šimport * as queries from '../../graphql/queries';\n+â”Š  â”Š 9â”Šimport { useGetChatQuery, useAddMessageMutation } from '../../graphql/types';\n â”Š12â”Š10â”Šimport * as fragments from '../../graphql/fragments';\n+â”Š  â”Š11â”Šimport { writeMessage } from '../../services/cache.service';\n â”Š13â”Š12â”Š\n â”Š14â”Š13â”Šconst Container = styled.div`\n â”Š15â”Š14â”Š  background: url(/assets/chat-background.jpg);\n```\n```diff\n@@ -43,10 +42,6 @@\n â”Š43â”Š42â”Š  history: History;\n â”Š44â”Š43â”Š}\n â”Š45â”Š44â”Š\n-â”Š46â”Š  â”Šinterface ChatsResult {\n-â”Š47â”Š  â”Š  chats: any[];\n-â”Š48â”Š  â”Š}\n-â”Š49â”Š  â”Š\n â”Š50â”Š45â”Šconst ChatRoomScreen: React.FC<ChatRoomScreenParams> = ({\n â”Š51â”Š46â”Š  history,\n â”Š52â”Š47â”Š  chatId,\n```\n```diff\n@@ -79,68 +74,7 @@\n â”Š 79â”Š 74â”Š          },\n â”Š 80â”Š 75â”Š        },\n â”Š 81â”Š 76â”Š        update: (client, { data: { addMessage } }) => {\n-â”Š 82â”Š   â”Š          type FullChat = { [key: string]: any };\n-â”Š 83â”Š   â”Š          let fullChat;\n-â”Š 84â”Š   â”Š\n-â”Š 85â”Š   â”Š          const chatIdFromStore = defaultDataIdFromObject(chat);\n-â”Š 86â”Š   â”Š\n-â”Š 87â”Š   â”Š          if (chatIdFromStore === null) {\n-â”Š 88â”Š   â”Š            return;\n-â”Š 89â”Š   â”Š          }\n-â”Š 90â”Š   â”Š          try {\n-â”Š 91â”Š   â”Š            fullChat = client.readFragment<FullChat>({\n-â”Š 92â”Š   â”Š              id: chatIdFromStore,\n-â”Š 93â”Š   â”Š              fragment: fragments.fullChat,\n-â”Š 94â”Š   â”Š              fragmentName: 'FullChat',\n-â”Š 95â”Š   â”Š            });\n-â”Š 96â”Š   â”Š          } catch (e) {\n-â”Š 97â”Š   â”Š            return;\n-â”Š 98â”Š   â”Š          }\n-â”Š 99â”Š   â”Š\n-â”Š100â”Š   â”Š          if (fullChat === null || fullChat.messages === null) {\n-â”Š101â”Š   â”Š            return;\n-â”Š102â”Š   â”Š          }\n-â”Š103â”Š   â”Š          if (fullChat.messages.some((currentMessage: any) => currentMessage.id === addMessage.id)) return;\n-â”Š104â”Š   â”Š\n-â”Š105â”Š   â”Š          fullChat.messages.push(addMessage);\n-â”Š106â”Š   â”Š          fullChat.lastMessage = addMessage;\n-â”Š107â”Š   â”Š\n-â”Š108â”Š   â”Š          client.writeFragment({\n-â”Š109â”Š   â”Š            id: chatIdFromStore,\n-â”Š110â”Š   â”Š            fragment: fragments.fullChat,\n-â”Š111â”Š   â”Š            fragmentName: 'FullChat',\n-â”Š112â”Š   â”Š            data: fullChat,\n-â”Š113â”Š   â”Š          });\n-â”Š114â”Š   â”Š\n-â”Š115â”Š   â”Š          let data: ChatsQuery | null;\n-â”Š116â”Š   â”Š          try {\n-â”Š117â”Š   â”Š            data = client.readQuery({\n-â”Š118â”Š   â”Š              query: queries.chats,\n-â”Š119â”Š   â”Š            });\n-â”Š120â”Š   â”Š          } catch (e) {\n-â”Š121â”Š   â”Š            return;\n-â”Š122â”Š   â”Š          }\n-â”Š123â”Š   â”Š\n-â”Š124â”Š   â”Š          if (!data || !data.chats) {\n-â”Š125â”Š   â”Š            return null;\n-â”Š126â”Š   â”Š          }\n-â”Š127â”Š   â”Š          const chats = data.chats;\n-â”Š128â”Š   â”Š\n-â”Š129â”Š   â”Š          const chatIndex = chats.findIndex((c: any) => {\n-â”Š130â”Š   â”Š            if (addMessage === null || addMessage.chat === null) return -1;\n-â”Š131â”Š   â”Š            return c.id === addMessage.chat.id;\n-â”Š132â”Š   â”Š          });\n-â”Š133â”Š   â”Š          if (chatIndex === -1) return;\n-â”Š134â”Š   â”Š          const chatWhereAdded = chats[chatIndex];\n-â”Š135â”Š   â”Š\n-â”Š136â”Š   â”Š          // The chat will appear at the top of the ChatsList component\n-â”Š137â”Š   â”Š          chats.splice(chatIndex, 1);\n-â”Š138â”Š   â”Š          chats.unshift(chatWhereAdded);\n-â”Š139â”Š   â”Š\n-â”Š140â”Š   â”Š          client.writeQuery({\n-â”Š141â”Š   â”Š            query: queries.chats,\n-â”Š142â”Š   â”Š            data: { chats: chats },\n-â”Š143â”Š   â”Š          });\n+â”Š   â”Š 77â”Š          writeMessage(client, addMessage);\n â”Š144â”Š 78â”Š        },\n â”Š145â”Š 79â”Š      });\n â”Š146â”Š 80â”Š    },\n```\n\n[}]: #\n\nOne thing missing that you might notice is that we're trying to retrieve the chat from the received message, unfortunately our GraphQL schema doesn't support it and we will need to add it. On the server, we will add a `chat` field to the `Message` type in the GraphQL schema, and we will implement a resolver which will lookup for the chat in the chats collection:\n\n[{]: <helper> (diffStep 7.7 module=\"server\")\n\n#### [__Server__ Step 7.7: Add Message.chat resolver](https://github.com/Urigo/WhatsApp-Clone-Server/commit/b50dbdd62c90c46daf5c3e035cbba042f88fc76e)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -5,6 +5,12 @@\n â”Š 5â”Š 5â”Šconst resolvers: Resolvers = {\n â”Š 6â”Š 6â”Š  Date: GraphQLDateTime,\n â”Š 7â”Š 7â”Š\n+â”Š  â”Š 8â”Š  Message: {\n+â”Š  â”Š 9â”Š    chat(message) {\n+â”Š  â”Š10â”Š      return chats.find(c => c.messages.some(m => m === message.id)) || null;\n+â”Š  â”Š11â”Š    },\n+â”Š  â”Š12â”Š  },\n+â”Š  â”Š13â”Š\n â”Š 8â”Š14â”Š  Chat: {\n â”Š 9â”Š15â”Š    messages(chat) {\n â”Š10â”Š16â”Š      return messages.filter(m => chat.messages.includes(m.id));\n```\n\n##### Changed schema&#x2F;typeDefs.graphql\n```diff\n@@ -4,6 +4,7 @@\n â”Š 4â”Š 4â”Š  id: ID!\n â”Š 5â”Š 5â”Š  content: String!\n â”Š 6â”Š 6â”Š  createdAt: Date!\n+â”Š  â”Š 7â”Š  chat: Chat\n â”Š 7â”Š 8â”Š}\n â”Š 8â”Š 9â”Š\n â”Š 9â”Š10â”Štype Chat {\n```\n\n[}]: #\n\nNow that we have it supported we can update the `Message` fragment in the client to include that information. We don't need the entire chat, only its ID, since the fragment ID composition is done out of an ID and type name:\n\n[{]: <helper> (diffStep 10.5 module=\"client\")\n\n#### [__Client__ Step 10.5: Add chat.id to message fragment](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/61f15e7b06b6859ad6340fdfc741d78d30df19a9)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -70,6 +70,10 @@\n â”Š70â”Š70â”Š              .toString(36)\n â”Š71â”Š71â”Š              .substr(2, 9),\n â”Š72â”Š72â”Š            createdAt: new Date(),\n+â”Š  â”Š73â”Š            chat: {\n+â”Š  â”Š74â”Š              __typename: 'Chat',\n+â”Š  â”Š75â”Š              id: chatId,\n+â”Š  â”Š76â”Š            },\n â”Š73â”Š77â”Š            content,\n â”Š74â”Š78â”Š          },\n â”Š75â”Š79â”Š        },\n```\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.test.tsx\n```diff\n@@ -40,6 +40,10 @@\n â”Š40â”Š40â”Š                  id: 1,\n â”Š41â”Š41â”Š                  content: 'Hello',\n â”Š42â”Š42â”Š                  createdAt: new Date('1 Jan 2019 GMT'),\n+â”Š  â”Š43â”Š                  chat: {\n+â”Š  â”Š44â”Š                    __typename: 'Chat',\n+â”Š  â”Š45â”Š                    id: 1,\n+â”Š  â”Š46â”Š                  },\n â”Š43â”Š47â”Š                },\n â”Š44â”Š48â”Š              },\n â”Š45â”Š49â”Š            ],\n```\n```diff\n@@ -86,6 +90,10 @@\n â”Š86â”Š90â”Š                  id: 1,\n â”Š87â”Š91â”Š                  content: 'Hello',\n â”Š88â”Š92â”Š                  createdAt: new Date('1 Jan 2019 GMT'),\n+â”Š  â”Š93â”Š                  chat: {\n+â”Š  â”Š94â”Š                    __typename: 'Chat',\n+â”Š  â”Š95â”Š                    id: 1,\n+â”Š  â”Š96â”Š                  },\n â”Š89â”Š97â”Š                },\n â”Š90â”Š98â”Š              },\n â”Š91â”Š99â”Š            ],\n```\n\n##### Changed src&#x2F;graphql&#x2F;fragments&#x2F;message.fragment.ts\n```diff\n@@ -5,5 +5,8 @@\n â”Š 5â”Š 5â”Š    id\n â”Š 6â”Š 6â”Š    createdAt\n â”Š 7â”Š 7â”Š    content\n+â”Š  â”Š 8â”Š    chat {\n+â”Š  â”Š 9â”Š      id\n+â”Š  â”Š10â”Š    }\n â”Š 8â”Š11â”Š  }\n â”Š 9â”Š12â”Š`;\n```\n\n[}]: #\n\nFinally, we will import the `useCacheService` React hook that we've just created and we will use it in our main `App` component. This means that the cache service will start listening for changes right as the app component is mounted:\n\n[{]: <helper> (diffStep 10.6 module=\"client\")\n\n#### [__Client__ Step 10.6: Use cache service](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/4145fbf4304271e4f2fb1991b7a9b882c43d34a9)\n\n##### Changed src&#x2F;App.test.tsx\n```diff\n@@ -3,9 +3,15 @@\n â”Š 3â”Š 3â”Šimport ReactDOM from 'react-dom';\n â”Š 4â”Š 4â”Šimport App from './App';\n â”Š 5â”Š 5â”Šimport { mockApolloClient } from './test-helpers';\n+â”Š  â”Š 6â”Šimport * as subscriptions from './graphql/subscriptions';\n â”Š 6â”Š 7â”Š\n â”Š 7â”Š 8â”Šit('renders without crashing', () => {\n-â”Š 8â”Š  â”Š  const client = mockApolloClient();\n+â”Š  â”Š 9â”Š  const client = mockApolloClient([\n+â”Š  â”Š10â”Š    {\n+â”Š  â”Š11â”Š      request: { query: subscriptions.messageAdded },\n+â”Š  â”Š12â”Š      result: { data: {} }\n+â”Š  â”Š13â”Š    }\n+â”Š  â”Š14â”Š  ]);\n â”Š 9â”Š15â”Š  const div = document.createElement('div');\n â”Š10â”Š16â”Š\n â”Š11â”Š17â”Š  ReactDOM.render(\n```\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -8,26 +8,31 @@\n â”Š 8â”Š 8â”Šimport ChatRoomScreen from './components/ChatRoomScreen';\n â”Š 9â”Š 9â”Šimport ChatsListScreen from './components/ChatsListScreen';\n â”Š10â”Š10â”Šimport AnimatedSwitch from './components/AnimatedSwitch';\n+â”Š  â”Š11â”Šimport { useCacheService } from './services/cache.service';\n â”Š11â”Š12â”Š\n-â”Š12â”Š  â”Šconst App: React.FC = () => (\n-â”Š13â”Š  â”Š  <BrowserRouter>\n-â”Š14â”Š  â”Š    <AnimatedSwitch>\n-â”Š15â”Š  â”Š      <Route exact path=\"/chats\" component={ChatsListScreen} />\n+â”Š  â”Š13â”Šconst App: React.FC = () => {\n+â”Š  â”Š14â”Š  useCacheService();\n â”Š16â”Š15â”Š\n-â”Š17â”Š  â”Š      <Route\n-â”Š18â”Š  â”Š        exact\n-â”Š19â”Š  â”Š        path=\"/chats/:chatId\"\n-â”Š20â”Š  â”Š        component={({\n-â”Š21â”Š  â”Š          match,\n-â”Š22â”Š  â”Š          history,\n-â”Š23â”Š  â”Š        }: RouteComponentProps<{ chatId: string }>) => (\n-â”Š24â”Š  â”Š          <ChatRoomScreen chatId={match.params.chatId} history={history} />\n-â”Š25â”Š  â”Š        )}\n-â”Š26â”Š  â”Š      />\n-â”Š27â”Š  â”Š    </AnimatedSwitch>\n-â”Š28â”Š  â”Š    <Route exact path=\"/\" render={redirectToChats} />\n-â”Š29â”Š  â”Š  </BrowserRouter>\n-â”Š30â”Š  â”Š);\n+â”Š  â”Š16â”Š  return (\n+â”Š  â”Š17â”Š    <BrowserRouter>\n+â”Š  â”Š18â”Š      <AnimatedSwitch>\n+â”Š  â”Š19â”Š        <Route exact path=\"/chats\" component={ChatsListScreen} />\n+â”Š  â”Š20â”Š\n+â”Š  â”Š21â”Š        <Route\n+â”Š  â”Š22â”Š          exact\n+â”Š  â”Š23â”Š          path=\"/chats/:chatId\"\n+â”Š  â”Š24â”Š          component={({\n+â”Š  â”Š25â”Š            match,\n+â”Š  â”Š26â”Š            history,\n+â”Š  â”Š27â”Š          }: RouteComponentProps<{ chatId: string }>) => (\n+â”Š  â”Š28â”Š            <ChatRoomScreen chatId={match.params.chatId} history={history} />\n+â”Š  â”Š29â”Š          )}\n+â”Š  â”Š30â”Š        />\n+â”Š  â”Š31â”Š      </AnimatedSwitch>\n+â”Š  â”Š32â”Š      <Route exact path=\"/\" render={redirectToChats} />\n+â”Š  â”Š33â”Š    </BrowserRouter>\n+â”Š  â”Š34â”Š  );\n+â”Š  â”Š35â”Š};\n â”Š31â”Š36â”Š\n â”Š32â”Š37â”Šconst redirectToChats = () => <Redirect to=\"/chats\" />;\n```\n\n[}]: #\n\nSubscription handling is complete! If you'll try to repeat the same process again where you check messages updating between 2 instances of the app, you should see them both update.\n\n-------\n\nTODO: `useCacheService` shouldnâ€™t be called like that since itâ€™s related to message events and cache updates are only side-effects."
          },
          {
            "manualTitle": "Step 11: Users",
            "stepRevision": "5591a133f618d7081f7ac9db3387313984377a10",
            "manualView": "Our chat app is pretty functional. We can pick a chat from the chats list and we can send messages. It's not hard to notice that one of the most important mechanisms is missing, which is relating a chat or a message to a specific user. Even though we can send messages, it's basically pointless unless someone else receives it. In this chapter we will create a new users collection with pre-defined documents and we will learn how to simulate authentication programmatically so we can test the new mechanism.\n\n**Reshaping the back-end**\n\nTo implement this feature we need to rethink our back-end and reshape the way our GraphQL schema is structured. Right now we only have 2 entities: Chat and Message, which are connected like so:\n\n\n\n![chat-message-orm](https://user-images.githubusercontent.com/7648874/55325929-0faa1b00-54b9-11e9-8868-7a8ed3edcda1.png)\n\n\nWe want to have a new User entity where each user will have Chats he participates in and Messages he owns. Therefore, our new GraphQL schema should look like something like this:\n\n\n\n![chat-message-user-orm](https://user-images.githubusercontent.com/7648874/55325935-146ecf00-54b9-11e9-8c0f-bc3b63cbe676.png)\n\nThis change would require us to update the GraphQL type definitions and handlers, the DB models, and the codegen configuration file:\n\n[{]: <helper> (diffStep 8.1 module=\"server\")\n\n#### [__Server__ Step 8.1: Add User type](https://github.com/Urigo/WhatsApp-Clone-Server/commit/918cd92692c74d1099023ac934522c3bf98b8517)\n\n##### Changed codegen.yml\n```diff\n@@ -10,6 +10,7 @@\n â”Š10â”Š10â”Š      mappers:\n â”Š11â”Š11â”Š        # import { Message } from '../db'\n â”Š12â”Š12â”Š        # The root types of Message resolvers\n+â”Š  â”Š13â”Š        User: ../db#User\n â”Š13â”Š14â”Š        Message: ../db#Message\n â”Š14â”Š15â”Š        Chat: ../db#Chat\n â”Š15â”Š16â”Š      scalars:\n```\n\n##### Changed db.ts\n```diff\n@@ -1,20 +1,60 @@\n+â”Š  â”Š 1â”Šexport type User = {\n+â”Š  â”Š 2â”Š  id: string;\n+â”Š  â”Š 3â”Š  name: string;\n+â”Š  â”Š 4â”Š  picture: string;\n+â”Š  â”Š 5â”Š};\n+â”Š  â”Š 6â”Š\n â”Š 1â”Š 7â”Šexport type Message = {\n â”Š 2â”Š 8â”Š  id: string;\n â”Š 3â”Š 9â”Š  content: string;\n â”Š 4â”Š10â”Š  createdAt: Date;\n+â”Š  â”Š11â”Š  sender: string;\n+â”Š  â”Š12â”Š  recipient: string;\n â”Š 5â”Š13â”Š};\n â”Š 6â”Š14â”Š\n â”Š 7â”Š15â”Šexport type Chat = {\n â”Š 8â”Š16â”Š  id: string;\n-â”Š 9â”Š  â”Š  name: string;\n-â”Š10â”Š  â”Š  picture: string;\n â”Š11â”Š17â”Š  messages: string[];\n+â”Š  â”Š18â”Š  participants: string[];\n â”Š12â”Š19â”Š};\n â”Š13â”Š20â”Š\n+â”Š  â”Š21â”Šexport const users: User[] = [];\n â”Š14â”Š22â”Šexport const messages: Message[] = [];\n â”Š15â”Š23â”Šexport const chats: Chat[] = [];\n â”Š16â”Š24â”Š\n â”Š17â”Š25â”Šexport const resetDb = () => {\n+â”Š  â”Š26â”Š  users.splice(\n+â”Š  â”Š27â”Š    0,\n+â”Š  â”Š28â”Š    Infinity,\n+â”Š  â”Š29â”Š    ...[\n+â”Š  â”Š30â”Š      {\n+â”Š  â”Š31â”Š        id: '1',\n+â”Š  â”Š32â”Š        name: 'Ray Edwards',\n+â”Š  â”Š33â”Š        picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n+â”Š  â”Š34â”Š      },\n+â”Š  â”Š35â”Š      {\n+â”Š  â”Š36â”Š        id: '2',\n+â”Š  â”Š37â”Š        name: 'Ethan Gonzalez',\n+â”Š  â”Š38â”Š        picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n+â”Š  â”Š39â”Š      },\n+â”Š  â”Š40â”Š      {\n+â”Š  â”Š41â”Š        id: '3',\n+â”Š  â”Š42â”Š        name: 'Bryan Wallace',\n+â”Š  â”Š43â”Š        picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n+â”Š  â”Š44â”Š      },\n+â”Š  â”Š45â”Š      {\n+â”Š  â”Š46â”Š        id: '4',\n+â”Š  â”Š47â”Š        name: 'Avery Stewart',\n+â”Š  â”Š48â”Š        picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n+â”Š  â”Š49â”Š      },\n+â”Š  â”Š50â”Š      {\n+â”Š  â”Š51â”Š        id: '5',\n+â”Š  â”Š52â”Š        name: 'Katie Peterson',\n+â”Š  â”Š53â”Š        picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n+â”Š  â”Š54â”Š      },\n+â”Š  â”Š55â”Š    ]\n+â”Š  â”Š56â”Š  );\n+â”Š  â”Š57â”Š\n â”Š18â”Š58â”Š  messages.splice(\n â”Š19â”Š59â”Š    0,\n â”Š20â”Š60â”Š    Infinity,\n```\n```diff\n@@ -23,6 +63,8 @@\n â”Š23â”Š63â”Š        id: '1',\n â”Š24â”Š64â”Š        content: 'You on your way?',\n â”Š25â”Š65â”Š        createdAt: new Date(new Date('1-1-2019').getTime() - 60 * 1000 * 1000),\n+â”Š  â”Š66â”Š        sender: '1',\n+â”Š  â”Š67â”Š        recipient: '2',\n â”Š26â”Š68â”Š      },\n â”Š27â”Š69â”Š      {\n â”Š28â”Š70â”Š        id: '2',\n```\n```diff\n@@ -30,6 +72,8 @@\n â”Š30â”Š72â”Š        createdAt: new Date(\n â”Š31â”Š73â”Š          new Date('1-1-2019').getTime() - 2 * 60 * 1000 * 1000\n â”Š32â”Š74â”Š        ),\n+â”Š  â”Š75â”Š        sender: '1',\n+â”Š  â”Š76â”Š        recipient: '3',\n â”Š33â”Š77â”Š      },\n â”Š34â”Š78â”Š      {\n â”Š35â”Š79â”Š        id: '3',\n```\n```diff\n@@ -37,6 +81,8 @@\n â”Š37â”Š81â”Š        createdAt: new Date(\n â”Š38â”Š82â”Š          new Date('1-1-2019').getTime() - 24 * 60 * 1000 * 1000\n â”Š39â”Š83â”Š        ),\n+â”Š  â”Š84â”Š        sender: '1',\n+â”Š  â”Š85â”Š        recipient: '4',\n â”Š40â”Š86â”Š      },\n â”Š41â”Š87â”Š      {\n â”Š42â”Š88â”Š        id: '4',\n```\n```diff\n@@ -44,6 +90,8 @@\n â”Š44â”Š90â”Š        createdAt: new Date(\n â”Š45â”Š91â”Š          new Date('1-1-2019').getTime() - 14 * 24 * 60 * 1000 * 1000\n â”Š46â”Š92â”Š        ),\n+â”Š  â”Š93â”Š        sender: '1',\n+â”Š  â”Š94â”Š        recipient: '5',\n â”Š47â”Š95â”Š      },\n â”Š48â”Š96â”Š    ]\n â”Š49â”Š97â”Š  );\n```\n```diff\n@@ -54,26 +102,22 @@\n â”Š 54â”Š102â”Š    ...[\n â”Š 55â”Š103â”Š      {\n â”Š 56â”Š104â”Š        id: '1',\n-â”Š 57â”Š   â”Š        name: 'Ethan Gonzalez',\n-â”Š 58â”Š   â”Š        picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n+â”Š   â”Š105â”Š        participants: ['1', '2'],\n â”Š 59â”Š106â”Š        messages: ['1'],\n â”Š 60â”Š107â”Š      },\n â”Š 61â”Š108â”Š      {\n â”Š 62â”Š109â”Š        id: '2',\n-â”Š 63â”Š   â”Š        name: 'Bryan Wallace',\n-â”Š 64â”Š   â”Š        picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n+â”Š   â”Š110â”Š        participants: ['1', '3'],\n â”Š 65â”Š111â”Š        messages: ['2'],\n â”Š 66â”Š112â”Š      },\n â”Š 67â”Š113â”Š      {\n â”Š 68â”Š114â”Š        id: '3',\n-â”Š 69â”Š   â”Š        name: 'Avery Stewart',\n-â”Š 70â”Š   â”Š        picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n+â”Š   â”Š115â”Š        participants: ['1', '4'],\n â”Š 71â”Š116â”Š        messages: ['3'],\n â”Š 72â”Š117â”Š      },\n â”Š 73â”Š118â”Š      {\n â”Š 74â”Š119â”Š        id: '4',\n-â”Š 75â”Š   â”Š        name: 'Katie Peterson',\n-â”Š 76â”Š   â”Š        picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n+â”Š   â”Š120â”Š        participants: ['1', '5'],\n â”Š 77â”Š121â”Š        messages: ['4'],\n â”Š 78â”Š122â”Š      },\n â”Š 79â”Š123â”Š    ]\n```\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,5 +1,5 @@\n â”Š1â”Š1â”Šimport { GraphQLDateTime } from 'graphql-iso-date';\n-â”Š2â”Š â”Šimport { Message, chats, messages } from '../db';\n+â”Š â”Š2â”Šimport { User, Message, chats, messages, users } from '../db';\n â”Š3â”Š3â”Šimport { Resolvers } from '../types/graphql';\n â”Š4â”Š4â”Š\n â”Š5â”Š5â”Šconst resolvers: Resolvers = {\n```\n```diff\n@@ -9,9 +9,27 @@\n â”Š 9â”Š 9â”Š    chat(message) {\n â”Š10â”Š10â”Š      return chats.find(c => c.messages.some(m => m === message.id)) || null;\n â”Š11â”Š11â”Š    },\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Š    sender(message) {\n+â”Š  â”Š14â”Š      return users.find(u => u.id === message.sender) || null;\n+â”Š  â”Š15â”Š    },\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š    recipient(message) {\n+â”Š  â”Š18â”Š      return users.find(u => u.id === message.recipient) || null;\n+â”Š  â”Š19â”Š    },\n â”Š12â”Š20â”Š  },\n â”Š13â”Š21â”Š\n â”Š14â”Š22â”Š  Chat: {\n+â”Š  â”Š23â”Š    name() {\n+â”Š  â”Š24â”Š      // TODO: Resolve in relation to current user\n+â”Š  â”Š25â”Š      return null;\n+â”Š  â”Š26â”Š    },\n+â”Š  â”Š27â”Š\n+â”Š  â”Š28â”Š    picture() {\n+â”Š  â”Š29â”Š      // TODO: Resolve in relation to current user\n+â”Š  â”Š30â”Š      return null;\n+â”Š  â”Š31â”Š    },\n+â”Š  â”Š32â”Š\n â”Š15â”Š33â”Š    messages(chat) {\n â”Š16â”Š34â”Š      return messages.filter(m => chat.messages.includes(m.id));\n â”Š17â”Š35â”Š    },\n```\n```diff\n@@ -21,6 +39,12 @@\n â”Š21â”Š39â”Š\n â”Š22â”Š40â”Š      return messages.find(m => m.id === lastMessage) || null;\n â”Š23â”Š41â”Š    },\n+â”Š  â”Š42â”Š\n+â”Š  â”Š43â”Š    participants(chat) {\n+â”Š  â”Š44â”Š      return chat.participants\n+â”Š  â”Š45â”Š        .map(p => users.find(u => u.id === p))\n+â”Š  â”Š46â”Š        .filter(Boolean) as User[];\n+â”Š  â”Š47â”Š    },\n â”Š24â”Š48â”Š  },\n â”Š25â”Š49â”Š\n â”Š26â”Š50â”Š  Query: {\n```\n```diff\n@@ -46,6 +70,8 @@\n â”Š46â”Š70â”Š      const message: Message = {\n â”Š47â”Š71â”Š        id: messageId,\n â”Š48â”Š72â”Š        createdAt: new Date(),\n+â”Š  â”Š73â”Š        sender: '', // TODO: Fill-in\n+â”Š  â”Š74â”Š        recipient: '', // TODO: Fill-in\n â”Š49â”Š75â”Š        content,\n â”Š50â”Š76â”Š      };\n â”Š51â”Š77â”Š\n```\n\n##### Changed schema&#x2F;typeDefs.graphql\n```diff\n@@ -1,18 +1,28 @@\n â”Š 1â”Š 1â”Šscalar Date\n â”Š 2â”Š 2â”Š\n+â”Š  â”Š 3â”Štype User {\n+â”Š  â”Š 4â”Š  id: ID!\n+â”Š  â”Š 5â”Š  name: String!\n+â”Š  â”Š 6â”Š  picture: String\n+â”Š  â”Š 7â”Š}\n+â”Š  â”Š 8â”Š\n â”Š 3â”Š 9â”Štype Message {\n â”Š 4â”Š10â”Š  id: ID!\n â”Š 5â”Š11â”Š  content: String!\n â”Š 6â”Š12â”Š  createdAt: Date!\n â”Š 7â”Š13â”Š  chat: Chat\n+â”Š  â”Š14â”Š  sender: User\n+â”Š  â”Š15â”Š  recipient: User\n+â”Š  â”Š16â”Š  isMine: Boolean!\n â”Š 8â”Š17â”Š}\n â”Š 9â”Š18â”Š\n â”Š10â”Š19â”Štype Chat {\n â”Š11â”Š20â”Š  id: ID!\n-â”Š12â”Š  â”Š  name: String!\n+â”Š  â”Š21â”Š  name: String\n â”Š13â”Š22â”Š  picture: String\n â”Š14â”Š23â”Š  lastMessage: Message\n â”Š15â”Š24â”Š  messages: [Message!]!\n+â”Š  â”Š25â”Š  participants: [User!]!\n â”Š16â”Š26â”Š}\n â”Š17â”Š27â”Š\n â”Š18â”Š28â”Štype Query {\n```\n\n[}]: #\n\nEven though we made these changes, the app remained the same. That's because the Query type haven't changed at all, and we still serve the same data as before. What we need to do is to edit the Query resolvers to serve data based on the user that is currently logged-in to the app in the current session. Before we go all in with a robust authentication system, it would be smarter to simulate it, so we can test our app and see that everything works as intended.\n\nFor now, let's assume that we're logged in with user of ID 1 - Ray Edwards. Codewise, this would mean that we will need to have the current user defined on the resolver context. In the main file, let's add the `currentUser` field to the context using a simple `find()` method from our `users` collection:\n\n[{]: <helper> (diffStep 8.2 files=\"index.ts\" module=\"server\")\n\n#### [__Server__ Step 8.2: Resolve queries in relation to current user](https://github.com/Urigo/WhatsApp-Clone-Server/commit/0eddca83cb566af4418ca98fcf2963a84c29516c)\n\n##### Changed index.ts\n```diff\n@@ -2,6 +2,7 @@\n â”Š2â”Š2â”Šimport cors from 'cors';\n â”Š3â”Š3â”Šimport express from 'express';\n â”Š4â”Š4â”Šimport http from 'http';\n+â”Š â”Š5â”Šimport { users } from './db';\n â”Š5â”Š6â”Šimport schema from './schema';\n â”Š6â”Š7â”Š\n â”Š7â”Š8â”Šconst app = express();\n```\n```diff\n@@ -16,7 +17,10 @@\n â”Š16â”Š17â”Šconst pubsub = new PubSub();\n â”Š17â”Š18â”Šconst server = new ApolloServer({\n â”Š18â”Š19â”Š  schema,\n-â”Š19â”Š  â”Š  context: () => ({ pubsub }),\n+â”Š  â”Š20â”Š  context: () => ({\n+â”Š  â”Š21â”Š    currentUser: users.find(u => u.id === '1'),\n+â”Š  â”Š22â”Š    pubsub,\n+â”Š  â”Š23â”Š  }),\n â”Š20â”Š24â”Š});\n â”Š21â”Š25â”Š\n â”Š22â”Š26â”Šserver.applyMiddleware({\n```\n\n[}]: #\n\nAnd we will update the context type:\n\n[{]: <helper> (diffStep 8.2 files=\"context\" module=\"server\")\n\n#### [__Server__ Step 8.2: Resolve queries in relation to current user](https://github.com/Urigo/WhatsApp-Clone-Server/commit/0eddca83cb566af4418ca98fcf2963a84c29516c)\n\n##### Changed context.ts\n```diff\n@@ -1,5 +1,7 @@\n â”Š1â”Š1â”Šimport { PubSub } from 'apollo-server-express';\n+â”Š â”Š2â”Šimport { User } from './db';\n â”Š2â”Š3â”Š\n â”Š3â”Š4â”Šexport type MyContext = {\n â”Š4â”Š5â”Š  pubsub: PubSub;\n+â”Š â”Š6â”Š  currentUser: User;\n â”Š5â”Š7â”Š};\n```\n\n[}]: #\n\nNow we will update the resolvers to fetch data relatively to the current user logged in. If there's no user logged in, the resolvers should return `null`, as the client is not authorized to view the data he requested:\n\n[{]: <helper> (diffStep 8.2 files=\"schema, tests\" module=\"server\")\n\n#### [__Server__ Step 8.2: Resolve queries in relation to current user](https://github.com/Urigo/WhatsApp-Clone-Server/commit/0eddca83cb566af4418ca98fcf2963a84c29516c)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -17,17 +17,35 @@\n â”Š17â”Š17â”Š    recipient(message) {\n â”Š18â”Š18â”Š      return users.find(u => u.id === message.recipient) || null;\n â”Š19â”Š19â”Š    },\n+â”Š  â”Š20â”Š\n+â”Š  â”Š21â”Š    isMine(message, args, { currentUser }) {\n+â”Š  â”Š22â”Š      return message.sender === currentUser.id;\n+â”Š  â”Š23â”Š    },\n â”Š20â”Š24â”Š  },\n â”Š21â”Š25â”Š\n â”Š22â”Š26â”Š  Chat: {\n-â”Š23â”Š  â”Š    name() {\n-â”Š24â”Š  â”Š      // TODO: Resolve in relation to current user\n-â”Š25â”Š  â”Š      return null;\n+â”Š  â”Š27â”Š    name(chat, args, { currentUser }) {\n+â”Š  â”Š28â”Š      if (!currentUser) return null;\n+â”Š  â”Š29â”Š\n+â”Š  â”Š30â”Š      const participantId = chat.participants.find(p => p !== currentUser.id);\n+â”Š  â”Š31â”Š\n+â”Š  â”Š32â”Š      if (!participantId) return null;\n+â”Š  â”Š33â”Š\n+â”Š  â”Š34â”Š      const participant = users.find(u => u.id === participantId);\n+â”Š  â”Š35â”Š\n+â”Š  â”Š36â”Š      return participant ? participant.name : null;\n â”Š26â”Š37â”Š    },\n â”Š27â”Š38â”Š\n-â”Š28â”Š  â”Š    picture() {\n-â”Š29â”Š  â”Š      // TODO: Resolve in relation to current user\n-â”Š30â”Š  â”Š      return null;\n+â”Š  â”Š39â”Š    picture(chat, args, { currentUser }) {\n+â”Š  â”Š40â”Š      if (!currentUser) return null;\n+â”Š  â”Š41â”Š\n+â”Š  â”Š42â”Š      const participantId = chat.participants.find(p => p !== currentUser.id);\n+â”Š  â”Š43â”Š\n+â”Š  â”Š44â”Š      if (!participantId) return null;\n+â”Š  â”Š45â”Š\n+â”Š  â”Š46â”Š      const participant = users.find(u => u.id === participantId);\n+â”Š  â”Š47â”Š\n+â”Š  â”Š48â”Š      return participant ? participant.picture : null;\n â”Š31â”Š49â”Š    },\n â”Š32â”Š50â”Š\n â”Š33â”Š51â”Š    messages(chat) {\n```\n```diff\n@@ -48,30 +66,41 @@\n â”Š 48â”Š 66â”Š  },\n â”Š 49â”Š 67â”Š\n â”Š 50â”Š 68â”Š  Query: {\n-â”Š 51â”Š   â”Š    chats() {\n-â”Š 52â”Š   â”Š      return chats;\n+â”Š   â”Š 69â”Š    chats(root, args, { currentUser }) {\n+â”Š   â”Š 70â”Š      if (!currentUser) return [];\n+â”Š   â”Š 71â”Š\n+â”Š   â”Š 72â”Š      return chats.filter(c => c.participants.includes(currentUser.id));\n â”Š 53â”Š 73â”Š    },\n â”Š 54â”Š 74â”Š\n-â”Š 55â”Š   â”Š    chat(root, { chatId }) {\n-â”Š 56â”Š   â”Š      return chats.find(c => c.id === chatId) || null;\n+â”Š   â”Š 75â”Š    chat(root, { chatId }, { currentUser }) {\n+â”Š   â”Š 76â”Š      if (!currentUser) return null;\n+â”Š   â”Š 77â”Š\n+â”Š   â”Š 78â”Š      const chat = chats.find(c => c.id === chatId);\n+â”Š   â”Š 79â”Š\n+â”Š   â”Š 80â”Š      if (!chat) return null;\n+â”Š   â”Š 81â”Š\n+â”Š   â”Š 82â”Š      return chat.participants.includes(currentUser.id) ? chat : null;\n â”Š 57â”Š 83â”Š    },\n â”Š 58â”Š 84â”Š  },\n â”Š 59â”Š 85â”Š\n â”Š 60â”Š 86â”Š  Mutation: {\n-â”Š 61â”Š   â”Š    addMessage(root, { chatId, content }, { pubsub }) {\n+â”Š   â”Š 87â”Š    addMessage(root, { chatId, content }, { currentUser, pubsub }) {\n+â”Š   â”Š 88â”Š      if (!currentUser) return null;\n+â”Š   â”Š 89â”Š\n â”Š 62â”Š 90â”Š      const chatIndex = chats.findIndex(c => c.id === chatId);\n â”Š 63â”Š 91â”Š\n â”Š 64â”Š 92â”Š      if (chatIndex === -1) return null;\n â”Š 65â”Š 93â”Š\n â”Š 66â”Š 94â”Š      const chat = chats[chatIndex];\n+â”Š   â”Š 95â”Š      if (!chat.participants.includes(currentUser.id)) return null;\n â”Š 67â”Š 96â”Š\n â”Š 68â”Š 97â”Š      const messagesIds = messages.map(currentMessage => Number(currentMessage.id));\n â”Š 69â”Š 98â”Š      const messageId = String(Math.max(...messagesIds) + 1);\n â”Š 70â”Š 99â”Š      const message: Message = {\n â”Š 71â”Š100â”Š        id: messageId,\n â”Š 72â”Š101â”Š        createdAt: new Date(),\n-â”Š 73â”Š   â”Š        sender: '', // TODO: Fill-in\n-â”Š 74â”Š   â”Š        recipient: '', // TODO: Fill-in\n+â”Š   â”Š102â”Š        sender: currentUser.id,\n+â”Š   â”Š103â”Š        recipient: chat.participants.find(p => p !== currentUser.id) as string,\n â”Š 75â”Š104â”Š        content,\n â”Š 76â”Š105â”Š      };\n â”Š 77â”Š106â”Š\n```\n\n##### Changed tests&#x2F;mutations&#x2F;addMessage.test.ts\n```diff\n@@ -1,7 +1,7 @@\n â”Š1â”Š1â”Šimport { createTestClient } from 'apollo-server-testing';\n â”Š2â”Š2â”Šimport { ApolloServer, PubSub, gql } from 'apollo-server-express';\n â”Š3â”Š3â”Šimport schema from '../../schema';\n-â”Š4â”Š â”Šimport { resetDb } from '../../db';\n+â”Š â”Š4â”Šimport { resetDb, users } from '../../db';\n â”Š5â”Š5â”Š\n â”Š6â”Š6â”Šdescribe('Mutation.addMessage', () => {\n â”Š7â”Š7â”Š  beforeEach(resetDb);\n```\n```diff\n@@ -9,7 +9,10 @@\n â”Š 9â”Š 9â”Š  it('should add message to specified chat', async () => {\n â”Š10â”Š10â”Š    const server = new ApolloServer({\n â”Š11â”Š11â”Š      schema,\n-â”Š12â”Š  â”Š      context: () => ({ pubsub: new PubSub() }),\n+â”Š  â”Š12â”Š      context: () => ({\n+â”Š  â”Š13â”Š        pubsub: new PubSub(),\n+â”Š  â”Š14â”Š        currentUser: users[0],\n+â”Š  â”Š15â”Š      }),\n â”Š13â”Š16â”Š    });\n â”Š14â”Š17â”Š\n â”Š15â”Š18â”Š    const { query, mutate } = createTestClient(server);\n```\n\n##### Changed tests&#x2F;queries&#x2F;getChat.test.ts\n```diff\n@@ -1,10 +1,16 @@\n â”Š 1â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n â”Š 2â”Š 2â”Šimport { ApolloServer, gql } from 'apollo-server-express';\n â”Š 3â”Š 3â”Šimport schema from '../../schema';\n+â”Š  â”Š 4â”Šimport { users } from '../../db';\n â”Š 4â”Š 5â”Š\n â”Š 5â”Š 6â”Šdescribe('Query.chat', () => {\n â”Š 6â”Š 7â”Š  it('should fetch specified chat', async () => {\n-â”Š 7â”Š  â”Š    const server = new ApolloServer({ schema });\n+â”Š  â”Š 8â”Š    const server = new ApolloServer({\n+â”Š  â”Š 9â”Š      schema,\n+â”Š  â”Š10â”Š      context: () => ({\n+â”Š  â”Š11â”Š        currentUser: users[0],\n+â”Š  â”Š12â”Š      }),\n+â”Š  â”Š13â”Š    });\n â”Š 8â”Š14â”Š\n â”Š 9â”Š15â”Š    const { query } = createTestClient(server);\n â”Š10â”Š16â”Š\n```\n\n##### Changed tests&#x2F;queries&#x2F;getChats.test.ts\n```diff\n@@ -1,10 +1,16 @@\n â”Š 1â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n â”Š 2â”Š 2â”Šimport { ApolloServer, gql } from 'apollo-server-express';\n â”Š 3â”Š 3â”Šimport schema from '../../schema';\n+â”Š  â”Š 4â”Šimport { users } from '../../db';\n â”Š 4â”Š 5â”Š\n â”Š 5â”Š 6â”Šdescribe('Query.chats', () => {\n â”Š 6â”Š 7â”Š  it('should fetch all chats', async () => {\n-â”Š 7â”Š  â”Š    const server = new ApolloServer({ schema });\n+â”Š  â”Š 8â”Š    const server = new ApolloServer({\n+â”Š  â”Š 9â”Š      schema,\n+â”Š  â”Š10â”Š      context: () => ({\n+â”Š  â”Š11â”Š        currentUser: users[0],\n+â”Š  â”Š12â”Š      }),\n+â”Š  â”Š13â”Š    });\n â”Š 8â”Š14â”Š\n â”Š 9â”Š15â”Š    const { query } = createTestClient(server);\n```\n\n[}]: #\n\nNow if we will get back to the app and refresh the page, we should see a new chats list which is only relevant to Ray Edwards.\nEarlier in this chapter, we've defined a new `isMine` field on the `Message` type.\nThis field is useful because now we can differentiate between messages that are mine and messages that belong to the recipient.\nWe can use that information to distinct between messages in our UI.\n\nBut we should also take into account the current user when we publish real-time subscription events.\n\nWe will check if there is a logged in user and if the users is part of the actual conversation before we publish:\n\n[{]: <helper> (diffStep 8.3 module=\"server\")\n\n#### [__Server__ Step 8.3: Resolve subscriptions in relation to current user](https://github.com/Urigo/WhatsApp-Clone-Server/commit/0cc13e7f8fdec3dccc65e44fcf6d2fc0151ba71c)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,3 +1,4 @@\n+â”Š â”Š1â”Šimport { withFilter } from 'apollo-server-express';\n â”Š1â”Š2â”Šimport { GraphQLDateTime } from 'graphql-iso-date';\n â”Š2â”Š3â”Šimport { User, Message, chats, messages, users } from '../db';\n â”Š3â”Š4â”Šimport { Resolvers } from '../types/graphql';\n```\n```diff\n@@ -120,8 +121,16 @@\n â”Š120â”Š121â”Š\n â”Š121â”Š122â”Š  Subscription: {\n â”Š122â”Š123â”Š    messageAdded: {\n-â”Š123â”Š   â”Š      subscribe: (root, args, { pubsub }) =>\n-â”Š124â”Š   â”Š        pubsub.asyncIterator('messageAdded'),\n+â”Š   â”Š124â”Š      subscribe: withFilter(\n+â”Š   â”Š125â”Š        (root, args, { pubsub }) => pubsub.asyncIterator('messageAdded'),\n+â”Š   â”Š126â”Š        ({ messageAdded }, args, { currentUser }) => {\n+â”Š   â”Š127â”Š          if (!currentUser) return false;\n+â”Š   â”Š128â”Š\n+â”Š   â”Š129â”Š          return [messageAdded.sender, messageAdded.recipient].includes(\n+â”Š   â”Š130â”Š            currentUser.id\n+â”Š   â”Š131â”Š          );\n+â”Š   â”Š132â”Š        }\n+â”Š   â”Š133â”Š      ),\n â”Š125â”Š134â”Š    },\n â”Š126â”Š135â”Š  },\n â”Š127â”Š136â”Š};\n```\n\n[}]: #\n\nLet's first download a new image that will help us achieve the new style and save it under the [`src/public/assets/message-yours.png`](https://github.com/Urigo/WhatsApp-Clone-Client-React/blob/cordova/public/assets/message-other.png?raw=true) path. Then let's implement the new style:\n\n[{]: <helper> (diffStep 11.1 files=\"src/components\" module=\"client\")\n\n#### [__Client__ Step 11.1: Distinguish messages](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/96c866eeebc64fd9f11bbfa988025c01d9438484)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;MessagesList.tsx\n```diff\n@@ -2,7 +2,7 @@\n â”Š2â”Š2â”Šimport React from 'react';\n â”Š3â”Š3â”Šimport { useEffect, useRef } from 'react';\n â”Š4â”Š4â”Šimport ReactDOM from 'react-dom';\n-â”Š5â”Š â”Šimport styled from 'styled-components';\n+â”Š â”Š5â”Šimport styled, { css } from 'styled-components';\n â”Š6â”Š6â”Š\n â”Š7â”Š7â”Šconst Container = styled.div`\n â”Š8â”Š8â”Š  display: block;\n```\n```diff\n@@ -11,9 +11,11 @@\n â”Š11â”Š11â”Š  padding: 0 15px;\n â”Š12â”Š12â”Š`;\n â”Š13â”Š13â”Š\n+â”Š  â”Š14â”Štype StyledProp = {\n+â”Š  â”Š15â”Š  isMine: any;\n+â”Š  â”Š16â”Š};\n+â”Š  â”Š17â”Š\n â”Š14â”Š18â”Šconst MessageItem = styled.div`\n-â”Š15â”Š  â”Š  float: right;\n-â”Š16â”Š  â”Š  background-color: #dcf8c6;\n â”Š17â”Š19â”Š  display: inline-block;\n â”Š18â”Š20â”Š  position: relative;\n â”Š19â”Š21â”Š  max-width: 100%;\n```\n```diff\n@@ -30,17 +32,36 @@\n â”Š30â”Š32â”Š  }\n â”Š31â”Š33â”Š\n â”Š32â”Š34â”Š  &::before {\n-â”Š33â”Š  â”Š    background-image: url(/assets/message-mine.png);\n â”Š34â”Š35â”Š    content: '';\n â”Š35â”Š36â”Š    position: absolute;\n â”Š36â”Š37â”Š    bottom: 3px;\n â”Š37â”Š38â”Š    width: 12px;\n â”Š38â”Š39â”Š    height: 19px;\n-â”Š39â”Š  â”Š    right: -11px;\n â”Š40â”Š40â”Š    background-position: 50% 50%;\n â”Š41â”Š41â”Š    background-repeat: no-repeat;\n â”Š42â”Š42â”Š    background-size: contain;\n â”Š43â”Š43â”Š  }\n+â”Š  â”Š44â”Š\n+â”Š  â”Š45â”Š  ${(props: StyledProp) =>\n+â”Š  â”Š46â”Š    props.isMine\n+â”Š  â”Š47â”Š      ? css`\n+â”Š  â”Š48â”Š          float: right;\n+â”Š  â”Š49â”Š          background-color: #dcf8c6;\n+â”Š  â”Š50â”Š\n+â”Š  â”Š51â”Š          &::before {\n+â”Š  â”Š52â”Š            right: -11px;\n+â”Š  â”Š53â”Š            background-image: url(/assets/message-mine.png);\n+â”Š  â”Š54â”Š          }\n+â”Š  â”Š55â”Š        `\n+â”Š  â”Š56â”Š      : css`\n+â”Š  â”Š57â”Š          float: left;\n+â”Š  â”Š58â”Š          background-color: #fff;\n+â”Š  â”Š59â”Š\n+â”Š  â”Š60â”Š          &::before {\n+â”Š  â”Š61â”Š            left: -11px;\n+â”Š  â”Š62â”Š            background-image: url(/assets/message-other.png);\n+â”Š  â”Š63â”Š          }\n+â”Š  â”Š64â”Š        `}\n â”Š44â”Š65â”Š`;\n â”Š45â”Š66â”Š\n â”Š46â”Š67â”Šconst Contents = styled.div`\n```\n```diff\n@@ -75,7 +96,6 @@\n â”Š 75â”Š 96â”Š\n â”Š 76â”Š 97â”Š  useEffect(() => {\n â”Š 77â”Š 98â”Š    if (!selfRef.current) return;\n-â”Š 78â”Š   â”Š\n â”Š 79â”Š 99â”Š    const selfDOMNode = ReactDOM.findDOMNode(selfRef.current) as HTMLElement;\n â”Š 80â”Š100â”Š    selfDOMNode.scrollTop = Number.MAX_SAFE_INTEGER;\n â”Š 81â”Š101â”Š  }, [messages.length]);\n```\n```diff\n@@ -83,7 +103,10 @@\n â”Š 83â”Š103â”Š  return (\n â”Š 84â”Š104â”Š    <Container ref={selfRef}>\n â”Š 85â”Š105â”Š      {messages.map((message: any) => (\n-â”Š 86â”Š   â”Š        <MessageItem data-testid=\"message-item\" key={message.id}>\n+â”Š   â”Š106â”Š        <MessageItem\n+â”Š   â”Š107â”Š          data-testid=\"message-item\"\n+â”Š   â”Š108â”Š          isMine={message.isMine}\n+â”Š   â”Š109â”Š          key={message.id}>\n â”Š 87â”Š110â”Š          <Contents data-testid=\"message-content\">{message.content}</Contents>\n â”Š 88â”Š111â”Š          <Timestamp data-testid=\"message-date\">\n â”Š 89â”Š112â”Š            {moment(message.createdAt).format('HH:mm')}\n```\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -70,6 +70,7 @@\n â”Š70â”Š70â”Š              .toString(36)\n â”Š71â”Š71â”Š              .substr(2, 9),\n â”Š72â”Š72â”Š            createdAt: new Date(),\n+â”Š  â”Š73â”Š            isMine: true,\n â”Š73â”Š74â”Š            chat: {\n â”Š74â”Š75â”Š              __typename: 'Chat',\n â”Š75â”Š76â”Š              id: chatId,\n```\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.test.tsx\n```diff\n@@ -40,6 +40,7 @@\n â”Š40â”Š40â”Š                  id: 1,\n â”Š41â”Š41â”Š                  content: 'Hello',\n â”Š42â”Š42â”Š                  createdAt: new Date('1 Jan 2019 GMT'),\n+â”Š  â”Š43â”Š                  isMine: true,\n â”Š43â”Š44â”Š                  chat: {\n â”Š44â”Š45â”Š                    __typename: 'Chat',\n â”Š45â”Š46â”Š                    id: 1,\n```\n```diff\n@@ -90,6 +91,7 @@\n â”Š90â”Š91â”Š                  id: 1,\n â”Š91â”Š92â”Š                  content: 'Hello',\n â”Š92â”Š93â”Š                  createdAt: new Date('1 Jan 2019 GMT'),\n+â”Š  â”Š94â”Š                  isMine: true,\n â”Š93â”Š95â”Š                  chat: {\n â”Š94â”Š96â”Š                    __typename: 'Chat',\n â”Š95â”Š97â”Š                    id: 1,\n```\n\n[}]: #\n\n[{]: <helper> (diffStep 11.1 files=\"message.fragment.ts\" module=\"client\")\n\n#### [__Client__ Step 11.1: Distinguish messages](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/96c866eeebc64fd9f11bbfa988025c01d9438484)\n\n##### Changed src&#x2F;graphql&#x2F;fragments&#x2F;message.fragment.ts\n```diff\n@@ -5,6 +5,7 @@\n â”Š 5â”Š 5â”Š    id\n â”Š 6â”Š 6â”Š    createdAt\n â”Š 7â”Š 7â”Š    content\n+â”Š  â”Š 8â”Š    isMine\n â”Š 8â”Š 9â”Š    chat {\n â”Š 9â”Š10â”Š      id\n â”Š10â”Š11â”Š    }\n```\n\n[}]: #\n\nThis is how the updated `ChatRoomScreen` should look like:\n\n\n\n![chat-room-screen](https://user-images.githubusercontent.com/7648874/55326701-face8700-54ba-11e9-877e-0b7dd71a1b68.png)\n\n\n\nWe can use a temporary solution to log-in and alternate between different users. This would be a good way to test data authorization without implementing an authentication mechanism. One way to know which user is logged in is via [cookies](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies).\n\nCookies are just text files which are stored locally on your computer and they contain key-value data maps. Cookies will be sent automatically by the browser with every HTTP request under the `Cookie` header. The header can be parsed and read by the server and this way inform it about the state of the client. Cookie values can also be set by the server by sending back a response which contain a `Set-Cookie` header. The browser will automatically write these cookies because of its specification and how it works.\n\nThis is how you can set cookies on the client:\n\n```js\ndocument.cookie = \"yummy_cookie=choco\"\ndocument.cookie = \"tasty_cookie=strawberry\"\n// logs \"yummy_cookie=choco; tasty_cookie=strawberry\"\n```\n\nAnd this is how further requests would look like:\n\n```\nGET /sample_page.html HTTP/2.0\nHost: www.example.org\nCookie: yummy_cookie=choco; tasty_cookie=strawberry\n```\n\nUsing this method we can set the current user's ID. Open your browser's dev-console, and type the following:\n\n```js\n// Ray Edwards\ndocument.cookie = 'currentUserId=1'\n```\n\nTo be able to send cookies with Apollo Client, we need to set the [`credentials`](https://www.apollographql.com/docs/react/recipes/authentication#cookie) option to \"include\" when creating the HTTP link:\n\n[{]: <helper> (diffStep 11.2 module=\"client\")\n\n#### [__Client__ Step 11.2: Support credentials](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/9e521ee15caa3121ac5c471d4707d159668ce289)\n\n##### Changed src&#x2F;client.ts\n```diff\n@@ -10,6 +10,7 @@\n â”Š10â”Š10â”Š\n â”Š11â”Š11â”Šconst httpLink = new HttpLink({\n â”Š12â”Š12â”Š  uri: httpUri,\n+â”Š  â”Š13â”Š  credentials: 'include',\n â”Š13â”Š14â”Š});\n â”Š14â”Š15â”Š\n â”Š15â”Š16â”Šconst wsLink = new WebSocketLink({\n```\n\n[}]: #\n\nThis will set the [`Access-Control-Allow-Credentials`](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Credentials) header to â€œincludeâ€ with each HTTP request which is necessary when using the POST method. In correlation to that, we would need to configure the server to be able to receive and set cookies. This can be done via CORS options like so:\n\n[{]: <helper> (diffStep 8.4 files=\"index.ts\" module=\"server\")\n\n#### [__Server__ Step 8.4: Support credentials](https://github.com/Urigo/WhatsApp-Clone-Server/commit/f48f487d13f6ad6d23c709509e1708617d570ea9)\n\n##### Changed index.ts\n```diff\n@@ -7,7 +7,8 @@\n â”Š 7â”Š 7â”Š\n â”Š 8â”Š 8â”Šconst app = express();\n â”Š 9â”Š 9â”Š\n-â”Š10â”Š  â”Šapp.use(cors());\n+â”Š  â”Š10â”Šconst origin = process.env.ORIGIN || 'http://localhost:3000';\n+â”Š  â”Š11â”Šapp.use(cors({ credentials: true, origin }));\n â”Š11â”Š12â”Šapp.use(express.json());\n â”Š12â”Š13â”Š\n â”Š13â”Š14â”Šapp.get('/_ping', (req, res) => {\n```\n```diff\n@@ -26,6 +27,7 @@\n â”Š26â”Š27â”Šserver.applyMiddleware({\n â”Š27â”Š28â”Š  app,\n â”Š28â”Š29â”Š  path: '/graphql',\n+â”Š  â”Š30â”Š  cors: { credentials: true, origin },\n â”Š29â”Š31â”Š});\n â”Š30â”Š32â”Š\n â”Š31â”Š33â”Šconst httpServer = http.createServer(app);\n```\n\n[}]: #\n\nSo how exactly does one retrieve the values of the cookies? Like mentioned earlier, each and every request will have them set on the `cookie` header, so one way would be by reading the header directly, but a more convenient way would be using an Express middleware called [`cookie-parser`](https://www.npmjs.com/package/cookie-parser):\n\n    $ yarn add cookie-parser\n\n[{]: <helper> (diffStep 8.5 files=\"index.ts\" module=\"server\")\n\n#### [__Server__ Step 8.5: Use cookie parser](https://github.com/Urigo/WhatsApp-Clone-Server/commit/09c9e96b499d40e12fb574baeb8582c3e0414dab)\n\n##### Changed index.ts\n```diff\n@@ -1,5 +1,6 @@\n â”Š1â”Š1â”Šimport { ApolloServer, gql, PubSub } from 'apollo-server-express';\n â”Š2â”Š2â”Šimport cors from 'cors';\n+â”Š â”Š3â”Šimport cookieParser from 'cookie-parser';\n â”Š3â”Š4â”Šimport express from 'express';\n â”Š4â”Š5â”Šimport http from 'http';\n â”Š5â”Š6â”Šimport { users } from './db';\n```\n```diff\n@@ -10,6 +11,7 @@\n â”Š10â”Š11â”Šconst origin = process.env.ORIGIN || 'http://localhost:3000';\n â”Š11â”Š12â”Šapp.use(cors({ credentials: true, origin }));\n â”Š12â”Š13â”Šapp.use(express.json());\n+â”Š  â”Š14â”Šapp.use(cookieParser());\n â”Š13â”Š15â”Š\n â”Š14â”Š16â”Šapp.get('/_ping', (req, res) => {\n â”Š15â”Š17â”Š  res.send('pong');\n```\n\n[}]: #\n\n`cookie-parser` will read the `Cookie` header, it will parse it into a JSON and will define it on `req.cookies`. Since weâ€™re using Apollo-Server with Express, the `req` object should be accessible as the first argument in the `context` function. This means that we can use the `currentUserId` from the cookies to fetch the current user from our users collection and define it on the context object:\n\n[{]: <helper> (diffStep 8.6 module=\"server\")\n\n#### [__Server__ Step 8.6: Define current user based on cookies](https://github.com/Urigo/WhatsApp-Clone-Server/commit/53d05969f0225ee37588d94bf4174ef1c6d603d1)\n\n##### Changed index.ts\n```diff\n@@ -1,6 +1,7 @@\n â”Š1â”Š1â”Šimport { ApolloServer, gql, PubSub } from 'apollo-server-express';\n â”Š2â”Š2â”Šimport cors from 'cors';\n â”Š3â”Š3â”Šimport cookieParser from 'cookie-parser';\n+â”Š â”Š4â”Šimport cookie from 'cookie';\n â”Š4â”Š5â”Šimport express from 'express';\n â”Š5â”Š6â”Šimport http from 'http';\n â”Š6â”Š7â”Šimport { users } from './db';\n```\n```diff\n@@ -20,10 +21,30 @@\n â”Š20â”Š21â”Šconst pubsub = new PubSub();\n â”Š21â”Š22â”Šconst server = new ApolloServer({\n â”Š22â”Š23â”Š  schema,\n-â”Š23â”Š  â”Š  context: () => ({\n-â”Š24â”Š  â”Š    currentUser: users.find(u => u.id === '1'),\n-â”Š25â”Š  â”Š    pubsub,\n-â”Š26â”Š  â”Š  }),\n+â”Š  â”Š24â”Š  context: (session: any) => {\n+â”Š  â”Š25â”Š    // Access the request object\n+â”Š  â”Š26â”Š    let req = session.connection\n+â”Š  â”Š27â”Š      ? session.connection.context.request\n+â”Š  â”Š28â”Š      : session.req;\n+â”Š  â”Š29â”Š\n+â”Š  â”Š30â”Š    // It's subscription\n+â”Š  â”Š31â”Š    if (session.connection) {\n+â”Š  â”Š32â”Š      req.cookies = cookie.parse(req.headers.cookie || '');\n+â”Š  â”Š33â”Š    }\n+â”Š  â”Š34â”Š\n+â”Š  â”Š35â”Š    return {\n+â”Š  â”Š36â”Š      currentUser: users.find(u => u.id === req.cookies.currentUserId),\n+â”Š  â”Š37â”Š      pubsub,\n+â”Š  â”Š38â”Š    };\n+â”Š  â”Š39â”Š  },\n+â”Š  â”Š40â”Š  subscriptions: {\n+â”Š  â”Š41â”Š    onConnect(params, ws, ctx) {\n+â”Š  â”Š42â”Š      // pass the request object to context\n+â”Š  â”Š43â”Š      return {\n+â”Š  â”Š44â”Š        request: ctx.request,\n+â”Š  â”Š45â”Š      };\n+â”Š  â”Š46â”Š    },\n+â”Š  â”Š47â”Š  },\n â”Š27â”Š48â”Š});\n â”Š28â”Š49â”Š\n â”Š29â”Š50â”Šserver.applyMiddleware({\n```\n\n##### Changed package.json\n```diff\n@@ -21,6 +21,7 @@\n â”Š21â”Š21â”Š    \"@graphql-codegen/typescript\": \"1.5.0\",\n â”Š22â”Š22â”Š    \"@graphql-codegen/typescript-resolvers\": \"1.5.0\",\n â”Š23â”Š23â”Š    \"@types/cors\": \"2.8.5\",\n+â”Š  â”Š24â”Š    \"@types/cookie\": \"0.3.3\",\n â”Š24â”Š25â”Š    \"@types/cookie-parser\": \"1.4.1\",\n â”Š25â”Š26â”Š    \"@types/express\": \"4.17.0\",\n â”Š26â”Š27â”Š    \"@types/graphql\": \"14.2.3\",\n```\n```diff\n@@ -37,6 +38,7 @@\n â”Š37â”Š38â”Š  \"dependencies\": {\n â”Š38â”Š39â”Š    \"apollo-server-express\": \"2.8.1\",\n â”Š39â”Š40â”Š    \"apollo-server-testing\": \"2.8.1\",\n+â”Š  â”Š41â”Š    \"cookie\": \"0.4.0\",\n â”Š40â”Š42â”Š    \"cors\": \"2.8.5\",\n â”Š41â”Š43â”Š    \"cookie-parser\": \"1.4.4\",\n â”Š42â”Š44â”Š    \"express\": \"4.17.1\",\n```\n\n[}]: #\n\nNow you can go ahead and change the value of the `currentUserId` cookie and see how it affects the view anytime you refresh the page. Needless to say that this is not the most convenient way to switch between users, so weâ€™re gonna implement a dedicated screen that will set the cookies for us.\n\nAll the auth related logic should go into a dedicated service since it can serve us vastly across the application, not just for a single component. Thus we will create a new service called `auth.service`, which will contain 3 basic functions for now: `signIn()`, `signOut()` and `isSignedIn():\n\n[{]: <helper> (diffStep 11.3 module=\"client\")\n\n#### [__Client__ Step 11.3: Add basic auth.service](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/f44d9ed9230d9be03a1607227163115f8a9031f1)\n\n##### Added src&#x2F;services&#x2F;auth.service.tsx\n```diff\n@@ -0,0 +1,26 @@\n+â”Š  â”Š 1â”Šimport { useCallback } from 'react'\n+â”Š  â”Š 2â”Šimport { useApolloClient } from '@apollo/react-hooks'\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šexport const signIn = (currentUserId: string) => {\n+â”Š  â”Š 5â”Š  document.cookie = `currentUserId=${currentUserId}`;\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Š  // This will become async in the near future\n+â”Š  â”Š 8â”Š  return Promise.resolve();\n+â”Š  â”Š 9â”Š};\n+â”Š  â”Š10â”Š\n+â”Š  â”Š11â”Šexport const useSignOut = () => {\n+â”Š  â”Š12â”Š  const client = useApolloClient()\n+â”Š  â”Š13â”Š\n+â”Š  â”Š14â”Š  return useCallback(() => {\n+â”Š  â”Š15â”Š    // \"expires\" represents the lifespan of a cookie. Beyond that date the cookie will\n+â”Š  â”Š16â”Š    // be deleted by the browser. \"expires\" cannot be viewed from \"document.cookie\"\n+â”Š  â”Š17â”Š    document.cookie = `currentUserId=;expires=${new Date(0)}`;\n+â”Š  â”Š18â”Š\n+â”Š  â”Š19â”Š    // Clear cache\n+â”Š  â”Š20â”Š    return client.clearStore();\n+â”Š  â”Š21â”Š  }, [client])\n+â”Š  â”Š22â”Š};\n+â”Š  â”Š23â”Š\n+â”Š  â”Š24â”Šexport const isSignedIn = () => {\n+â”Š  â”Š25â”Š  return /currentUserId=.+(;|$)/.test(document.cookie);\n+â”Š  â”Š26â”Š};\n```\n\n[}]: #\n\nNow we will implement the `AuthScreen`. For now this screen should be fairly simple. It should contain a single `TextField` to specify the current user ID, and a `sign-in` button that will call the `signIn()` method with the specified ID. Once it does so, we will be proceeded to the `ChatsListScreen`. First we will download and save the following assets:\n\n- [`src/public/assets/whatsapp-icon.ping`](https://github.com/Urigo/WhatsApp-Clone-Client-React/raw/wip/cookie-auth/public/assets/whatsapp-icon.png)\n\n[{]: <helper> (diffStep 11.4 files=\"components\" module=\"client\")\n\n#### [__Client__ Step 11.4: Add AuthScreen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/d3d7617fff1138b7e91da2ce4cdab5fcd205e352)\n\n##### Added src&#x2F;components&#x2F;AuthScreen&#x2F;index.tsx\n```diff\n@@ -0,0 +1,167 @@\n+â”Š   â”Š  1â”Šimport MaterialButton from '@material-ui/core/Button';\n+â”Š   â”Š  2â”Šimport MaterialTextField from '@material-ui/core/TextField';\n+â”Š   â”Š  3â”Šimport React from 'react';\n+â”Š   â”Š  4â”Šimport { useCallback, useState } from 'react';\n+â”Š   â”Š  5â”Šimport styled from 'styled-components';\n+â”Š   â”Š  6â”Šimport { signIn } from '../../services/auth.service';\n+â”Š   â”Š  7â”Šimport { RouteComponentProps } from 'react-router-dom';\n+â”Š   â”Š  8â”Š\n+â”Š   â”Š  9â”Šconst Container = styled.div`\n+â”Š   â”Š 10â”Š  height: 100%;\n+â”Š   â”Š 11â”Š  background: radial-gradient(rgb(34, 65, 67), rgb(17, 48, 50)),\n+â”Š   â”Š 12â”Š    url(/assets/chat-background.jpg) no-repeat;\n+â”Š   â”Š 13â”Š  background-size: cover;\n+â”Š   â”Š 14â”Š  background-blend-mode: multiply;\n+â”Š   â”Š 15â”Š  color: white;\n+â”Š   â”Š 16â”Š`;\n+â”Š   â”Š 17â”Š\n+â”Š   â”Š 18â”Šconst Intro = styled.div`\n+â”Š   â”Š 19â”Š  height: 265px;\n+â”Š   â”Š 20â”Š`;\n+â”Š   â”Š 21â”Š\n+â”Š   â”Š 22â”Šconst Icon = styled.img`\n+â”Š   â”Š 23â”Š  width: 125px;\n+â”Š   â”Š 24â”Š  height: auto;\n+â”Š   â”Š 25â”Š  margin-left: auto;\n+â”Š   â”Š 26â”Š  margin-right: auto;\n+â”Š   â”Š 27â”Š  padding-top: 70px;\n+â”Š   â”Š 28â”Š  display: block;\n+â”Š   â”Š 29â”Š`;\n+â”Š   â”Š 30â”Š\n+â”Š   â”Š 31â”Šconst Title = styled.h2`\n+â”Š   â”Š 32â”Š  width: 100%;\n+â”Š   â”Š 33â”Š  text-align: center;\n+â”Š   â”Š 34â”Š  color: white;\n+â”Š   â”Š 35â”Š`;\n+â”Š   â”Š 36â”Š\n+â”Š   â”Š 37â”Š// eslint-disable-next-line\n+â”Š   â”Š 38â”Šconst Alternative = styled.div`\n+â”Š   â”Š 39â”Š  position: fixed;\n+â”Š   â”Š 40â”Š  bottom: 10px;\n+â”Š   â”Š 41â”Š  left: 10px;\n+â”Š   â”Š 42â”Š\n+â”Š   â”Š 43â”Š  a {\n+â”Š   â”Š 44â”Š    color: var(--secondary-bg);\n+â”Š   â”Š 45â”Š  }\n+â”Š   â”Š 46â”Š`;\n+â”Š   â”Š 47â”Š\n+â”Š   â”Š 48â”Šconst SignInForm = styled.div`\n+â”Š   â”Š 49â”Š  height: calc(100% - 265px);\n+â”Š   â”Š 50â”Š`;\n+â”Š   â”Š 51â”Š\n+â”Š   â”Š 52â”Šconst ActualForm = styled.form`\n+â”Š   â”Š 53â”Š  padding: 20px;\n+â”Š   â”Š 54â”Š`;\n+â”Š   â”Š 55â”Š\n+â”Š   â”Š 56â”Šconst Section = styled.div`\n+â”Š   â”Š 57â”Š  width: 100%;\n+â”Š   â”Š 58â”Š  padding-bottom: 35px;\n+â”Š   â”Š 59â”Š`;\n+â”Š   â”Š 60â”Š\n+â”Š   â”Š 61â”Šconst Legend = styled.legend`\n+â”Š   â”Š 62â”Š  font-weight: bold;\n+â”Š   â”Š 63â”Š  color: white;\n+â”Š   â”Š 64â”Š`;\n+â”Š   â”Š 65â”Š\n+â”Š   â”Š 66â”Š// eslint-disable-next-line\n+â”Š   â”Š 67â”Šconst Label = styled.label`\n+â”Š   â”Š 68â”Š  color: white !important;\n+â”Š   â”Š 69â”Š`;\n+â”Š   â”Š 70â”Š\n+â”Š   â”Š 71â”Š// eslint-disable-next-line\n+â”Š   â”Š 72â”Šconst Input = styled.input`\n+â”Š   â”Š 73â”Š  color: white;\n+â”Š   â”Š 74â”Š\n+â”Š   â”Š 75â”Š  &::placeholder {\n+â”Š   â”Š 76â”Š    color: var(--primary-bg);\n+â”Š   â”Š 77â”Š  }\n+â”Š   â”Š 78â”Š`;\n+â”Š   â”Š 79â”Š\n+â”Š   â”Š 80â”Šconst TextField = styled(MaterialTextField)`\n+â”Š   â”Š 81â”Š  width: 100%;\n+â”Š   â”Š 82â”Š  position: relative;\n+â”Š   â”Š 83â”Š\n+â”Š   â”Š 84â”Š  > div::before {\n+â”Š   â”Š 85â”Š    border-color: white !important;\n+â”Š   â”Š 86â”Š  }\n+â”Š   â”Š 87â”Š\n+â”Š   â”Š 88â”Š  input {\n+â”Š   â”Š 89â”Š    color: white !important;\n+â”Š   â”Š 90â”Š\n+â”Š   â”Š 91â”Š    &::placeholder {\n+â”Š   â”Š 92â”Š      color: var(--primary-bg) !important;\n+â”Š   â”Š 93â”Š    }\n+â”Š   â”Š 94â”Š  }\n+â”Š   â”Š 95â”Š\n+â”Š   â”Š 96â”Š  label {\n+â”Š   â”Š 97â”Š    color: white !important;\n+â”Š   â”Š 98â”Š  }\n+â”Š   â”Š 99â”Š`;\n+â”Š   â”Š100â”Š\n+â”Š   â”Š101â”Šconst Button = styled(MaterialButton)`\n+â”Š   â”Š102â”Š  width: 100px;\n+â”Š   â”Š103â”Š  display: block !important;\n+â”Š   â”Š104â”Š  margin: auto !important;\n+â”Š   â”Š105â”Š  background-color: var(--secondary-bg) !important;\n+â”Š   â”Š106â”Š\n+â”Š   â”Š107â”Š  &[disabled] {\n+â”Š   â”Š108â”Š    color: #38a81c;\n+â”Š   â”Š109â”Š  }\n+â”Š   â”Š110â”Š\n+â”Š   â”Š111â”Š  &:not([disabled]) {\n+â”Š   â”Š112â”Š    color: white;\n+â”Š   â”Š113â”Š  }\n+â”Š   â”Š114â”Š`;\n+â”Š   â”Š115â”Š\n+â”Š   â”Š116â”Šconst AuthScreen: React.FC<RouteComponentProps<any>> = ({ history }) => {\n+â”Š   â”Š117â”Š  const [userId, setUserId] = useState('');\n+â”Š   â”Š118â”Š\n+â”Š   â”Š119â”Š  const onUserIdChange = useCallback(({ target }) => {\n+â”Š   â”Š120â”Š    setUserId(target.value);\n+â”Š   â”Š121â”Š  }, []);\n+â”Š   â”Š122â”Š\n+â”Š   â”Š123â”Š  const maySignIn = useCallback(() => {\n+â”Š   â”Š124â”Š    return !!userId;\n+â”Š   â”Š125â”Š  }, [userId]);\n+â”Š   â”Š126â”Š\n+â”Š   â”Š127â”Š  const handleSignIn = useCallback(() => {\n+â”Š   â”Š128â”Š    signIn(userId).then(() => {\n+â”Š   â”Š129â”Š      history.replace('/chats');\n+â”Š   â”Š130â”Š    });\n+â”Š   â”Š131â”Š  }, [userId, history]);\n+â”Š   â”Š132â”Š\n+â”Š   â”Š133â”Š  return (\n+â”Š   â”Š134â”Š    <Container>\n+â”Š   â”Š135â”Š      <Intro>\n+â”Š   â”Š136â”Š        <Icon src=\"assets/whatsapp-icon.png\" className=\"AuthScreen-icon\" />\n+â”Š   â”Š137â”Š        <Title className=\"AuthScreen-title\">WhatsApp</Title>\n+â”Š   â”Š138â”Š      </Intro>\n+â”Š   â”Š139â”Š      <SignInForm>\n+â”Š   â”Š140â”Š        <ActualForm>\n+â”Š   â”Š141â”Š          <Legend>Sign in</Legend>\n+â”Š   â”Š142â”Š          <Section>\n+â”Š   â”Š143â”Š            <TextField\n+â”Š   â”Š144â”Š              data-testid=\"user-id-input\"\n+â”Š   â”Š145â”Š              label=\"User ID\"\n+â”Š   â”Š146â”Š              value={userId}\n+â”Š   â”Š147â”Š              onChange={onUserIdChange}\n+â”Š   â”Š148â”Š              margin=\"normal\"\n+â”Š   â”Š149â”Š              placeholder=\"Enter current user ID\"\n+â”Š   â”Š150â”Š            />\n+â”Š   â”Š151â”Š          </Section>\n+â”Š   â”Š152â”Š          <Button\n+â”Š   â”Š153â”Š            data-testid=\"sign-in-button\"\n+â”Š   â”Š154â”Š            type=\"button\"\n+â”Š   â”Š155â”Š            color=\"secondary\"\n+â”Š   â”Š156â”Š            variant=\"contained\"\n+â”Š   â”Š157â”Š            disabled={!maySignIn()}\n+â”Š   â”Š158â”Š            onClick={handleSignIn}>\n+â”Š   â”Š159â”Š            Sign in\n+â”Š   â”Š160â”Š          </Button>\n+â”Š   â”Š161â”Š        </ActualForm>\n+â”Š   â”Š162â”Š      </SignInForm>\n+â”Š   â”Š163â”Š    </Container>\n+â”Š   â”Š164â”Š  );\n+â”Š   â”Š165â”Š};\n+â”Š   â”Š166â”Š\n+â”Š   â”Š167â”Šexport default AuthScreen;\n```\n\n[}]: #\n\nAccordingly we will define a new `/sign-in` route that will render the `AuthScreen` weâ€™re under that path name:\n\n[{]: <helper> (diffStep 11.4 files=\"App\" module=\"client\")\n\n#### [__Client__ Step 11.4: Add AuthScreen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/d3d7617fff1138b7e91da2ce4cdab5fcd205e352)\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -5,6 +5,7 @@\n â”Š 5â”Š 5â”Š  Redirect,\n â”Š 6â”Š 6â”Š  RouteComponentProps,\n â”Š 7â”Š 7â”Š} from 'react-router-dom';\n+â”Š  â”Š 8â”Šimport AuthScreen from './components/AuthScreen';\n â”Š 8â”Š 9â”Šimport ChatRoomScreen from './components/ChatRoomScreen';\n â”Š 9â”Š10â”Šimport ChatsListScreen from './components/ChatsListScreen';\n â”Š10â”Š11â”Šimport AnimatedSwitch from './components/AnimatedSwitch';\n```\n```diff\n@@ -16,6 +17,7 @@\n â”Š16â”Š17â”Š  return (\n â”Š17â”Š18â”Š    <BrowserRouter>\n â”Š18â”Š19â”Š      <AnimatedSwitch>\n+â”Š  â”Š20â”Š        <Route exact path=\"/sign-(in|up)\" component={AuthScreen} />\n â”Š19â”Š21â”Š        <Route exact path=\"/chats\" component={ChatsListScreen} />\n â”Š20â”Š22â”Š\n â”Š21â”Š23â”Š        <Route\n```\n\n[}]: #\n\nThis is how the new screen should look like:\n\n![auth-screen](https://user-images.githubusercontent.com/7648874/55606715-7a56a180-57ac-11e9-8eea-2da5931cccf5.png)\n\nNow letâ€™s type the `/sign-in` route in our browserâ€™s navigation bar and assign a user ID, see how it affects what chats we see in the `ChatsListScreen`. Youâ€™ve probably noticed that thereâ€™s no way to escape from the `/chats` route unless we edit the browserâ€™s navigation bar manually. To fix that, we will add a new sign-out button to the navbar of the `ChatsListScreen` that will call the `signOut()` method anytime we click on it, and will bring us back to the `AuthScreen`:\n\n[{]: <helper> (diffStep 11.5 module=\"client\")\n\n#### [__Client__ Step 11.5: Add sign-out button that ChatsNavbar](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/f9f6958aefb5ab2215f7b92b14a81887cd26a8bb)\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsNavbar.tsx\n```diff\n@@ -1,14 +1,48 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n-â”Š 2â”Š  â”Šimport { Toolbar } from '@material-ui/core';\n+â”Š  â”Š 2â”Šimport { Button, Toolbar } from '@material-ui/core';\n â”Š 3â”Š 3â”Šimport styled from 'styled-components';\n+â”Š  â”Š 4â”Šimport SignOutIcon from '@material-ui/icons/PowerSettingsNew';\n+â”Š  â”Š 5â”Šimport { useCallback } from 'react';\n+â”Š  â”Š 6â”Šimport { useSignOut } from '../../services/auth.service';\n+â”Š  â”Š 7â”Šimport { History } from 'history';\n â”Š 4â”Š 8â”Š\n â”Š 5â”Š 9â”Šconst Container = styled(Toolbar)`\n+â”Š  â”Š10â”Š  display: flex;\n â”Š 6â”Š11â”Š  background-color: var(--primary-bg);\n â”Š 7â”Š12â”Š  color: var(--primary-text);\n â”Š 8â”Š13â”Š  font-size: 20px;\n â”Š 9â”Š14â”Š  line-height: 40px;\n â”Š10â”Š15â”Š`;\n â”Š11â”Š16â”Š\n-â”Š12â”Š  â”Šconst ChatsNavbar: React.FC = () => <Container>Whatsapp Clone</Container>;\n+â”Š  â”Š17â”Šconst Title = styled.div`\n+â”Š  â”Š18â”Š  flex: 1;\n+â”Š  â”Š19â”Š`;\n+â”Š  â”Š20â”Š\n+â”Š  â”Š21â”Šconst LogoutButton = styled(Button)`\n+â”Š  â”Š22â”Š  color: var(--primary-text) !important;\n+â”Š  â”Š23â”Š`;\n+â”Š  â”Š24â”Š\n+â”Š  â”Š25â”Šinterface ChildComponentProps {\n+â”Š  â”Š26â”Š  history: History;\n+â”Š  â”Š27â”Š}\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Šconst ChatsNavbar: React.FC<ChildComponentProps> = ({ history }) => {\n+â”Š  â”Š30â”Š  const signOut = useSignOut();\n+â”Š  â”Š31â”Š\n+â”Š  â”Š32â”Š  const handleSignOut = useCallback(() => {\n+â”Š  â”Š33â”Š    signOut().then(() => {\n+â”Š  â”Š34â”Š      history.replace('/sign-in');\n+â”Š  â”Š35â”Š    });\n+â”Š  â”Š36â”Š  }, [history, signOut]);\n+â”Š  â”Š37â”Š\n+â”Š  â”Š38â”Š  return (\n+â”Š  â”Š39â”Š    <Container>\n+â”Š  â”Š40â”Š      <Title>Whatsapp Clone</Title>\n+â”Š  â”Š41â”Š      <LogoutButton data-testid=\"sign-out-button\" onClick={handleSignOut}>\n+â”Š  â”Š42â”Š        <SignOutIcon />\n+â”Š  â”Š43â”Š      </LogoutButton>\n+â”Š  â”Š44â”Š    </Container>\n+â”Š  â”Š45â”Š  );\n+â”Š  â”Š46â”Š};\n â”Š13â”Š47â”Š\n â”Š14â”Š48â”Šexport default ChatsNavbar;\n```\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;index.tsx\n```diff\n@@ -14,7 +14,7 @@\n â”Š14â”Š14â”Š\n â”Š15â”Š15â”Šconst ChatsListScreen: React.FC<ChatsListScreenProps> = ({ history }) => (\n â”Š16â”Š16â”Š  <Container>\n-â”Š17â”Š  â”Š    <ChatsNavbar />\n+â”Š  â”Š17â”Š    <ChatsNavbar history={history} />\n â”Š18â”Š18â”Š    <ChatsList history={history} />\n â”Š19â”Š19â”Š  </Container>\n â”Š20â”Š20â”Š);\n```\n\n[}]: #\n\nAt this point weâ€™ve got everything we need, but we will add a small touch to improve the user experience and make it feel more complete. Users who arenâ€™t logged in shouldnâ€™t be able to view any screen besides the `AuthScreen`. First they need to sign-in, and only then they will be able to view the `ChatsListScreen` and `ChatRoomScreen`. To achieve that, we will wrap all the components which require authentication before we provide them into their routes. This wrap will basically check whether a user is logged in or not by reading the cookies, and if not we will be redirected to the `/sign-in` route. Letâ€™s implement that wrap in the `auth.service` and call it `withAuth()`:\n\n[{]: <helper> (diffStep 11.6 files=\"auth.service\" module=\"client\")\n\n#### [__Client__ Step 11.6: Add withAuth() route wrapper](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/e83ac7e57cdd657d58baa009c8b27341e5427012)\n\n##### Changed src&#x2F;services&#x2F;auth.service.tsx\n```diff\n@@ -1,5 +1,26 @@\n-â”Š 1â”Š  â”Šimport { useCallback } from 'react'\n-â”Š 2â”Š  â”Šimport { useApolloClient } from '@apollo/react-hooks'\n+â”Š  â”Š 1â”Šimport React from 'react';\n+â”Š  â”Š 2â”Šimport { useCallback } from 'react';\n+â”Š  â”Š 3â”Šimport { useApolloClient } from '@apollo/react-hooks';\n+â”Š  â”Š 4â”Šimport { Redirect } from 'react-router-dom';\n+â”Š  â”Š 5â”Šimport { useCacheService } from './cache.service';\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Šexport const withAuth = <P extends object>(\n+â”Š  â”Š 8â”Š  Component: React.ComponentType<P>\n+â”Š  â”Š 9â”Š) => {\n+â”Š  â”Š10â”Š  return (props: any) => {\n+â”Š  â”Š11â”Š    if (!isSignedIn()) {\n+â”Š  â”Š12â”Š      if (props.history.location.pathname === '/sign-in') {\n+â”Š  â”Š13â”Š        return null;\n+â”Š  â”Š14â”Š      }\n+â”Š  â”Š15â”Š\n+â”Š  â”Š16â”Š      return <Redirect to=\"/sign-in\" />;\n+â”Š  â”Š17â”Š    }\n+â”Š  â”Š18â”Š\n+â”Š  â”Š19â”Š    useCacheService();\n+â”Š  â”Š20â”Š\n+â”Š  â”Š21â”Š    return <Component {...props as P} />;\n+â”Š  â”Š22â”Š  };\n+â”Š  â”Š23â”Š};\n â”Š 3â”Š24â”Š\n â”Š 4â”Š25â”Šexport const signIn = (currentUserId: string) => {\n â”Š 5â”Š26â”Š  document.cookie = `currentUserId=${currentUserId}`;\n```\n\n[}]: #\n\nWe will use this function to wrap the right components in our appâ€™s router. Note that since we used the `useCacheService()` directly in the `withAuth()` method, thereâ€™s no need to use it in the router itself anymore. This makes a lot more sense since thereâ€™s no need to stay subscribed to data that you're not gonna receive from the first place unless youâ€™re logged-in:\n\n[{]: <helper> (diffStep 11.6 files=\"App\" module=\"client\")\n\n#### [__Client__ Step 11.6: Add withAuth() route wrapper](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/e83ac7e57cdd657d58baa009c8b27341e5427012)\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -9,32 +9,27 @@\n â”Š 9â”Š 9â”Šimport ChatRoomScreen from './components/ChatRoomScreen';\n â”Š10â”Š10â”Šimport ChatsListScreen from './components/ChatsListScreen';\n â”Š11â”Š11â”Šimport AnimatedSwitch from './components/AnimatedSwitch';\n-â”Š12â”Š  â”Šimport { useCacheService } from './services/cache.service';\n+â”Š  â”Š12â”Šimport { withAuth } from './services/auth.service';\n â”Š13â”Š13â”Š\n-â”Š14â”Š  â”Šconst App: React.FC = () => {\n-â”Š15â”Š  â”Š  useCacheService();\n+â”Š  â”Š14â”Šconst App: React.FC = () => (\n+â”Š  â”Š15â”Š  <BrowserRouter>\n+â”Š  â”Š16â”Š    <AnimatedSwitch>\n+â”Š  â”Š17â”Š      <Route exact path=\"/sign-(in|up)\" component={AuthScreen} />\n+â”Š  â”Š18â”Š      <Route exact path=\"/chats\" component={withAuth(ChatsListScreen)} />\n â”Š16â”Š19â”Š\n-â”Š17â”Š  â”Š  return (\n-â”Š18â”Š  â”Š    <BrowserRouter>\n-â”Š19â”Š  â”Š      <AnimatedSwitch>\n-â”Š20â”Š  â”Š        <Route exact path=\"/sign-(in|up)\" component={AuthScreen} />\n-â”Š21â”Š  â”Š        <Route exact path=\"/chats\" component={ChatsListScreen} />\n-â”Š22â”Š  â”Š\n-â”Š23â”Š  â”Š        <Route\n-â”Š24â”Š  â”Š          exact\n-â”Š25â”Š  â”Š          path=\"/chats/:chatId\"\n-â”Š26â”Š  â”Š          component={({\n-â”Š27â”Š  â”Š            match,\n-â”Š28â”Š  â”Š            history,\n-â”Š29â”Š  â”Š          }: RouteComponentProps<{ chatId: string }>) => (\n+â”Š  â”Š20â”Š      <Route\n+â”Š  â”Š21â”Š        exact\n+â”Š  â”Š22â”Š        path=\"/chats/:chatId\"\n+â”Š  â”Š23â”Š        component={withAuth(\n+â”Š  â”Š24â”Š          ({ match, history }: RouteComponentProps<{ chatId: string }>) => (\n â”Š30â”Š25â”Š            <ChatRoomScreen chatId={match.params.chatId} history={history} />\n-â”Š31â”Š  â”Š          )}\n-â”Š32â”Š  â”Š        />\n-â”Š33â”Š  â”Š      </AnimatedSwitch>\n-â”Š34â”Š  â”Š      <Route exact path=\"/\" render={redirectToChats} />\n-â”Š35â”Š  â”Š    </BrowserRouter>\n-â”Š36â”Š  â”Š  );\n-â”Š37â”Š  â”Š};\n+â”Š  â”Š26â”Š          )\n+â”Š  â”Š27â”Š        )}\n+â”Š  â”Š28â”Š      />\n+â”Š  â”Š29â”Š    </AnimatedSwitch>\n+â”Š  â”Š30â”Š    <Route exact path=\"/\" render={redirectToChats} />\n+â”Š  â”Š31â”Š  </BrowserRouter>\n+â”Š  â”Š32â”Š);\n â”Š38â”Š33â”Š\n â”Š39â”Š34â”Šconst redirectToChats = () => <Redirect to=\"/chats\" />;\n â”Š40â”Š35â”Š\n```\n\n[}]: #\n\nAssuming that youâ€™re not logged-in, if youâ€™ll try to force navigate to the `/chats` route you should be automatically redirected to the `/sign-in` form. We will finish the chapter here as we wanna keep things simple and gradual. Itâ€™s true that we havenâ€™t implemented true authentication, but that would be addressed soon further in this tutorial."
          },
          {
            "manualTitle": "Step 12: Adding and removing chats",
            "stepRevision": "dd0acad8b07d153109a0ab974ea42e0cb457e889",
            "manualView": "Now that the users system is ready it would be a lot more comfortable to implement a chat creation feature. In the original Whatsapp, you can create a new chat based on your available contacts - a list of your contacts will appear on the screen and by picking one of the items youâ€™ll basically be able to start chatting with the selected contact. However, since in our app we donâ€™t have any real contacts (yet), we will implement the chats creation feature based on all available users in our DB. By picking a user from the users list we will be able to start chatting with it.\n\n![demo](https://user-images.githubusercontent.com/7648874/55896445-e4c67200-5bf0-11e9-9c1c-88318642ef81.gif)\n\nTo be able to fetch users in our system we will need to add a new query called `users`. The `users` query will retrieve all users except for current user:\n\n[{]: <helper> (diffStep 9.1 module=\"server\")\n\n#### [__Server__ Step 9.1: Add Query.users](https://github.com/Urigo/WhatsApp-Clone-Server/commit/99359d301cf37dedd7c71c8a8474c2880b10fc99)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -82,6 +82,12 @@\n â”Š82â”Š82â”Š\n â”Š83â”Š83â”Š      return chat.participants.includes(currentUser.id) ? chat : null;\n â”Š84â”Š84â”Š    },\n+â”Š  â”Š85â”Š\n+â”Š  â”Š86â”Š    users(root, args, { currentUser }) {\n+â”Š  â”Š87â”Š      if (!currentUser) return [];\n+â”Š  â”Š88â”Š\n+â”Š  â”Š89â”Š      return users.filter(u => u.id !== currentUser.id);\n+â”Š  â”Š90â”Š    },\n â”Š85â”Š91â”Š  },\n â”Š86â”Š92â”Š\n â”Š87â”Š93â”Š  Mutation: {\n```\n\n##### Changed schema&#x2F;typeDefs.graphql\n```diff\n@@ -28,6 +28,7 @@\n â”Š28â”Š28â”Štype Query {\n â”Š29â”Š29â”Š  chats: [Chat!]!\n â”Š30â”Š30â”Š  chat(chatId: ID!): Chat\n+â”Š  â”Š31â”Š  users: [User!]!\n â”Š31â”Š32â”Š}\n â”Š32â”Š33â”Š\n â”Š33â”Š34â”Štype Mutation {\n```\n\n##### Added tests&#x2F;queries&#x2F;\\__snapshots__&#x2F;getUsers.test.ts.snap\n```diff\n@@ -0,0 +1,55 @@\n+â”Š  â”Š 1â”Š// Jest Snapshot v1, https://goo.gl/fbAQLP\n+â”Š  â”Š 2â”Š\n+â”Š  â”Š 3â”Šexports[`Query.getUsers should fetch all users except the one signed-in 1`] = `\n+â”Š  â”Š 4â”ŠObject {\n+â”Š  â”Š 5â”Š  \"users\": Array [\n+â”Š  â”Š 6â”Š    Object {\n+â”Š  â”Š 7â”Š      \"id\": \"2\",\n+â”Š  â”Š 8â”Š      \"name\": \"Ethan Gonzalez\",\n+â”Š  â”Š 9â”Š      \"picture\": \"https://randomuser.me/api/portraits/thumb/men/1.jpg\",\n+â”Š  â”Š10â”Š    },\n+â”Š  â”Š11â”Š    Object {\n+â”Š  â”Š12â”Š      \"id\": \"3\",\n+â”Š  â”Š13â”Š      \"name\": \"Bryan Wallace\",\n+â”Š  â”Š14â”Š      \"picture\": \"https://randomuser.me/api/portraits/thumb/men/2.jpg\",\n+â”Š  â”Š15â”Š    },\n+â”Š  â”Š16â”Š    Object {\n+â”Š  â”Š17â”Š      \"id\": \"4\",\n+â”Š  â”Š18â”Š      \"name\": \"Avery Stewart\",\n+â”Š  â”Š19â”Š      \"picture\": \"https://randomuser.me/api/portraits/thumb/women/1.jpg\",\n+â”Š  â”Š20â”Š    },\n+â”Š  â”Š21â”Š    Object {\n+â”Š  â”Š22â”Š      \"id\": \"5\",\n+â”Š  â”Š23â”Š      \"name\": \"Katie Peterson\",\n+â”Š  â”Š24â”Š      \"picture\": \"https://randomuser.me/api/portraits/thumb/women/2.jpg\",\n+â”Š  â”Š25â”Š    },\n+â”Š  â”Š26â”Š  ],\n+â”Š  â”Š27â”Š}\n+â”Š  â”Š28â”Š`;\n+â”Š  â”Š29â”Š\n+â”Š  â”Š30â”Šexports[`Query.getUsers should fetch all users except the one signed-in 2`] = `\n+â”Š  â”Š31â”ŠObject {\n+â”Š  â”Š32â”Š  \"users\": Array [\n+â”Š  â”Š33â”Š    Object {\n+â”Š  â”Š34â”Š      \"id\": \"1\",\n+â”Š  â”Š35â”Š      \"name\": \"Ray Edwards\",\n+â”Š  â”Š36â”Š      \"picture\": \"https://randomuser.me/api/portraits/thumb/lego/1.jpg\",\n+â”Š  â”Š37â”Š    },\n+â”Š  â”Š38â”Š    Object {\n+â”Š  â”Š39â”Š      \"id\": \"3\",\n+â”Š  â”Š40â”Š      \"name\": \"Bryan Wallace\",\n+â”Š  â”Š41â”Š      \"picture\": \"https://randomuser.me/api/portraits/thumb/men/2.jpg\",\n+â”Š  â”Š42â”Š    },\n+â”Š  â”Š43â”Š    Object {\n+â”Š  â”Š44â”Š      \"id\": \"4\",\n+â”Š  â”Š45â”Š      \"name\": \"Avery Stewart\",\n+â”Š  â”Š46â”Š      \"picture\": \"https://randomuser.me/api/portraits/thumb/women/1.jpg\",\n+â”Š  â”Š47â”Š    },\n+â”Š  â”Š48â”Š    Object {\n+â”Š  â”Š49â”Š      \"id\": \"5\",\n+â”Š  â”Š50â”Š      \"name\": \"Katie Peterson\",\n+â”Š  â”Š51â”Š      \"picture\": \"https://randomuser.me/api/portraits/thumb/women/2.jpg\",\n+â”Š  â”Š52â”Š    },\n+â”Š  â”Š53â”Š  ],\n+â”Š  â”Š54â”Š}\n+â”Š  â”Š55â”Š`;\n```\n\n##### Added tests&#x2F;queries&#x2F;getUsers.test.ts\n```diff\n@@ -0,0 +1,51 @@\n+â”Š  â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n+â”Š  â”Š 2â”Šimport { ApolloServer, gql } from 'apollo-server-express';\n+â”Š  â”Š 3â”Šimport schema from '../../schema';\n+â”Š  â”Š 4â”Šimport { users } from '../../db';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šdescribe('Query.getUsers', () => {\n+â”Š  â”Š 7â”Š  it('should fetch all users except the one signed-in', async () => {\n+â”Š  â”Š 8â”Š    let currentUser = users[0];\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Š    const server = new ApolloServer({\n+â”Š  â”Š11â”Š      schema,\n+â”Š  â”Š12â”Š      context: () => ({ currentUser }),\n+â”Š  â”Š13â”Š    });\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”Š    const { query } = createTestClient(server);\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š    let res = await query({\n+â”Š  â”Š18â”Š      query: gql`\n+â”Š  â”Š19â”Š        query GetUsers {\n+â”Š  â”Š20â”Š          users {\n+â”Š  â”Š21â”Š            id\n+â”Š  â”Š22â”Š            name\n+â”Š  â”Š23â”Š            picture\n+â”Š  â”Š24â”Š          }\n+â”Š  â”Š25â”Š        }\n+â”Š  â”Š26â”Š      `,\n+â”Š  â”Š27â”Š    });\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š    expect(res.data).toBeDefined();\n+â”Š  â”Š30â”Š    expect(res.errors).toBeUndefined();\n+â”Š  â”Š31â”Š    expect(res.data).toMatchSnapshot();\n+â”Š  â”Š32â”Š\n+â”Š  â”Š33â”Š    currentUser = users[1];\n+â”Š  â”Š34â”Š\n+â”Š  â”Š35â”Š    res = await query({\n+â”Š  â”Š36â”Š      query: gql`\n+â”Š  â”Š37â”Š        query GetUsers {\n+â”Š  â”Š38â”Š          users {\n+â”Š  â”Š39â”Š            id\n+â”Š  â”Š40â”Š            name\n+â”Š  â”Š41â”Š            picture\n+â”Š  â”Š42â”Š          }\n+â”Š  â”Š43â”Š        }\n+â”Š  â”Š44â”Š      `,\n+â”Š  â”Š45â”Š    });\n+â”Š  â”Š46â”Š\n+â”Š  â”Š47â”Š    expect(res.data).toBeDefined();\n+â”Š  â”Š48â”Š    expect(res.errors).toBeUndefined();\n+â”Š  â”Š49â”Š    expect(res.data).toMatchSnapshot();\n+â”Š  â”Š50â”Š  });\n+â”Š  â”Š51â”Š});\n```\n\n[}]: #\n\nThis query will be reflected in a component called `UsersList`. First we will define and export a new fragment called `User`:\n\n[{]: <helper> (diffStep 12.1 files=\"graphql/fragments\" module=\"client\")\n\n#### [__Client__ Step 12.1: Add basic ChatCreationScreen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/ca9ada37bc11311bef601debb77d87c3c5a770c9)\n\n##### Changed src&#x2F;graphql&#x2F;fragments&#x2F;index.ts\n```diff\n@@ -1,3 +1,4 @@\n â”Š1â”Š1â”Šexport { default as chat } from './chat.fragment';\n â”Š2â”Š2â”Šexport { default as fullChat } from './fullChat.fragment';\n â”Š3â”Š3â”Šexport { default as message } from './message.fragment';\n+â”Š â”Š4â”Šexport { default as user } from './user.fragment';\n```\n\n##### Added src&#x2F;graphql&#x2F;fragments&#x2F;user.fragment.ts\n```diff\n@@ -0,0 +1,9 @@\n+â”Š â”Š1â”Šimport gql from 'graphql-tag';\n+â”Š â”Š2â”Š\n+â”Š â”Š3â”Šexport default gql`\n+â”Š â”Š4â”Š  fragment User on User {\n+â”Š â”Š5â”Š    id\n+â”Š â”Š6â”Š    name\n+â”Š â”Š7â”Š    picture\n+â”Š â”Š8â”Š  }\n+â”Š â”Š9â”Š`;\n```\n\n[}]: #\n\nAnd then we will implement the `UsersList` component which is going to use the `users` query with the `User` fragment:\n\n[{]: <helper> (diffStep 12.1 files=\"UsersList\" module=\"client\")\n\n#### [__Client__ Step 12.1: Add basic ChatCreationScreen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/ca9ada37bc11311bef601debb77d87c3c5a770c9)\n\n##### Added src&#x2F;components&#x2F;UsersList.test.tsx\n```diff\n@@ -0,0 +1,46 @@\n+â”Š  â”Š 1â”Šimport React from 'react';\n+â”Š  â”Š 2â”Šimport { ApolloProvider } from '@apollo/react-hooks';\n+â”Š  â”Š 3â”Šimport { cleanup, render, waitForDomChange } from '@testing-library/react';\n+â”Š  â”Š 4â”Šimport { mockApolloClient } from '../test-helpers';\n+â”Š  â”Š 5â”Šimport UsersList, { UsersListQuery } from './UsersList';\n+â”Š  â”Š 6â”Šimport * as queries from '../graphql/queries';\n+â”Š  â”Š 7â”Š\n+â”Š  â”Š 8â”Šdescribe('UsersList', () => {\n+â”Š  â”Š 9â”Š  afterEach(cleanup);\n+â”Š  â”Š10â”Š\n+â”Š  â”Š11â”Š  it('renders fetched users data', async () => {\n+â”Š  â”Š12â”Š    const client = mockApolloClient([\n+â”Š  â”Š13â”Š      {\n+â”Š  â”Š14â”Š        request: { query: UsersListQuery },\n+â”Š  â”Š15â”Š        result: {\n+â”Š  â”Š16â”Š          data: {\n+â”Š  â”Š17â”Š            users: [\n+â”Š  â”Š18â”Š              {\n+â”Š  â”Š19â”Š                __typename: 'User',\n+â”Š  â”Š20â”Š                id: 1,\n+â”Š  â”Š21â”Š                name: 'Charles Dickhead',\n+â”Š  â”Š22â”Š                picture: 'https://localhost:4000/dick.jpg',\n+â”Š  â”Š23â”Š              },\n+â”Š  â”Š24â”Š            ],\n+â”Š  â”Š25â”Š          },\n+â”Š  â”Š26â”Š        },\n+â”Š  â”Š27â”Š      },\n+â”Š  â”Š28â”Š    ]);\n+â”Š  â”Š29â”Š\n+â”Š  â”Š30â”Š    {\n+â”Š  â”Š31â”Š      const { container, getByTestId } = render(\n+â”Š  â”Š32â”Š        <ApolloProvider client={client}>\n+â”Š  â”Š33â”Š          <UsersList />\n+â”Š  â”Š34â”Š        </ApolloProvider>\n+â”Š  â”Š35â”Š      );\n+â”Š  â”Š36â”Š\n+â”Š  â”Š37â”Š      await waitForDomChange({ container });\n+â”Š  â”Š38â”Š\n+â”Š  â”Š39â”Š      expect(getByTestId('name')).toHaveTextContent('Charles Dickhead');\n+â”Š  â”Š40â”Š      expect(getByTestId('picture')).toHaveAttribute(\n+â”Š  â”Š41â”Š        'src',\n+â”Š  â”Š42â”Š        'https://localhost:4000/dick.jpg'\n+â”Š  â”Š43â”Š      );\n+â”Š  â”Š44â”Š    }\n+â”Š  â”Š45â”Š  });\n+â”Š  â”Š46â”Š});\n```\n\n##### Added src&#x2F;components&#x2F;UsersList.tsx\n```diff\n@@ -0,0 +1,64 @@\n+â”Š  â”Š 1â”Šimport MaterialList from '@material-ui/core/List';\n+â”Š  â”Š 2â”Šimport MaterialItem from '@material-ui/core/ListItem';\n+â”Š  â”Š 3â”Šimport gql from 'graphql-tag';\n+â”Š  â”Š 4â”Šimport React from 'react';\n+â”Š  â”Š 5â”Šimport styled from 'styled-components';\n+â”Š  â”Š 6â”Šimport * as fragments from '../graphql/fragments';\n+â”Š  â”Š 7â”Šimport { useUsersListQuery } from '../graphql/types';\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Šconst ActualList = styled(MaterialList)`\n+â”Š  â”Š10â”Š  padding: 0;\n+â”Š  â”Š11â”Š`;\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Šconst UserItem = styled(MaterialItem)`\n+â”Š  â”Š14â”Š  position: relative;\n+â”Š  â”Š15â”Š  padding: 7.5px 15px;\n+â”Š  â”Š16â”Š  display: flex;\n+â”Š  â”Š17â”Š  cursor: pinter;\n+â”Š  â”Š18â”Š`;\n+â”Š  â”Š19â”Š\n+â”Š  â”Š20â”Šconst ProfilePicture = styled.img`\n+â”Š  â”Š21â”Š  height: 50px;\n+â”Š  â”Š22â”Š  width: 50px;\n+â”Š  â”Š23â”Š  object-fit: cover;\n+â”Š  â”Š24â”Š  border-radius: 50%;\n+â”Š  â”Š25â”Š`;\n+â”Š  â”Š26â”Š\n+â”Š  â”Š27â”Šconst Name = styled.div`\n+â”Š  â”Š28â”Š  padding-left: 15px;\n+â”Š  â”Š29â”Š  font-weight: bold;\n+â”Š  â”Š30â”Š`;\n+â”Š  â”Š31â”Š\n+â”Š  â”Š32â”Šexport const UsersListQuery = gql`\n+â”Š  â”Š33â”Š  query UsersList {\n+â”Š  â”Š34â”Š    users {\n+â”Š  â”Š35â”Š      ...User\n+â”Š  â”Š36â”Š    }\n+â”Š  â”Š37â”Š  }\n+â”Š  â”Š38â”Š  ${fragments.user}\n+â”Š  â”Š39â”Š`;\n+â”Š  â”Š40â”Š\n+â”Š  â”Š41â”Šconst UsersList: React.FC = () => {\n+â”Š  â”Š42â”Š  const { data, loading: loadingUsers } = useUsersListQuery();\n+â”Š  â”Š43â”Š\n+â”Š  â”Š44â”Š  if (data === undefined) return null;\n+â”Š  â”Š45â”Š  const users = data.users;\n+â”Š  â”Š46â”Š\n+â”Š  â”Š47â”Š  return (\n+â”Š  â”Š48â”Š    <ActualList>\n+â”Š  â”Š49â”Š      {!loadingUsers &&\n+â”Š  â”Š50â”Š        users.map(user => (\n+â”Š  â”Š51â”Š          <UserItem key={user.id} button>\n+â”Š  â”Š52â”Š            {user !== null && user.picture !== null && (\n+â”Š  â”Š53â”Š              <React.Fragment>\n+â”Š  â”Š54â”Š                <ProfilePicture data-testid=\"picture\" src={user.picture} />\n+â”Š  â”Š55â”Š                <Name data-testid=\"name\">{user.name}</Name>\n+â”Š  â”Š56â”Š              </React.Fragment>\n+â”Š  â”Š57â”Š            )}\n+â”Š  â”Š58â”Š          </UserItem>\n+â”Š  â”Š59â”Š        ))}\n+â”Š  â”Š60â”Š    </ActualList>\n+â”Š  â”Š61â”Š  );\n+â”Š  â”Š62â”Š};\n+â”Š  â”Š63â”Š\n+â”Š  â”Š64â”Šexport default UsersList;\n```\n\n[}]: #\n\nThe list is likely to change when a new user signs-up. We will implement a subscription and live-update the list further this tutorial when we go through authentication. Now we will implement a new screen component called `ChatCreationScreen`. The screen will simply render the `UsersList` along with a navigation bar:\n\n[{]: <helper> (diffStep 12.1 files=\"ChatCreationScreen\" module=\"client\")\n\n#### [__Client__ Step 12.1: Add basic ChatCreationScreen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/ca9ada37bc11311bef601debb77d87c3c5a770c9)\n\n##### Added src&#x2F;components&#x2F;ChatCreationScreen&#x2F;ChatCreationNavbar.test.tsx\n```diff\n@@ -0,0 +1,26 @@\n+â”Š  â”Š 1â”Šimport { createMemoryHistory } from 'history';\n+â”Š  â”Š 2â”Šimport React from 'react';\n+â”Š  â”Š 3â”Šimport { cleanup, render, fireEvent, wait } from '@testing-library/react';\n+â”Š  â”Š 4â”Šimport ChatCreationNavbar from './ChatCreationNavbar';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šdescribe('ChatCreationNavbar', () => {\n+â”Š  â”Š 7â”Š  afterEach(cleanup);\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Š  it('goes back on arrow click', async () => {\n+â”Š  â”Š10â”Š    const history = createMemoryHistory();\n+â”Š  â”Š11â”Š\n+â”Š  â”Š12â”Š    history.push('/new-chat');\n+â”Š  â”Š13â”Š\n+â”Š  â”Š14â”Š    await wait(() => expect(history.location.pathname).toEqual('/new-chat'));\n+â”Š  â”Š15â”Š\n+â”Š  â”Š16â”Š    {\n+â”Š  â”Š17â”Š      const { container, getByTestId } = render(\n+â”Š  â”Š18â”Š        <ChatCreationNavbar history={history} />\n+â”Š  â”Š19â”Š      );\n+â”Š  â”Š20â”Š\n+â”Š  â”Š21â”Š      fireEvent.click(getByTestId('back-button'));\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Š      await wait(() => expect(history.location.pathname).toEqual('/chats'));\n+â”Š  â”Š24â”Š    }\n+â”Š  â”Š25â”Š  });\n+â”Š  â”Š26â”Š});\n```\n\n##### Added src&#x2F;components&#x2F;ChatCreationScreen&#x2F;ChatCreationNavbar.tsx\n```diff\n@@ -0,0 +1,45 @@\n+â”Š  â”Š 1â”Šimport ArrowBackIcon from '@material-ui/icons/ArrowBack';\n+â”Š  â”Š 2â”Šimport { Toolbar, Button } from '@material-ui/core';\n+â”Š  â”Š 3â”Šimport React from 'react';\n+â”Š  â”Š 4â”Šimport { useCallback } from 'react';\n+â”Š  â”Š 5â”Šimport styled from 'styled-components';\n+â”Š  â”Š 6â”Šimport { History } from 'history';\n+â”Š  â”Š 7â”Š\n+â”Š  â”Š 8â”Šconst Container = styled(Toolbar)`\n+â”Š  â”Š 9â”Š  display: flex;\n+â”Š  â”Š10â”Š  background-color: var(--primary-bg);\n+â”Š  â”Š11â”Š  color: var(--primary-text);\n+â”Š  â”Š12â”Š  font-size: 20px;\n+â”Š  â”Š13â”Š  line-height: 40px;\n+â”Š  â”Š14â”Š`;\n+â”Š  â”Š15â”Š\n+â”Š  â”Š16â”Šconst BackButton = styled(Button)`\n+â”Š  â”Š17â”Š  svg {\n+â”Š  â”Š18â”Š    color: var(--primary-text);\n+â”Š  â”Š19â”Š  }\n+â”Š  â”Š20â”Š`;\n+â”Š  â”Š21â”Š\n+â”Š  â”Š22â”Šconst Title = styled.div`\n+â”Š  â”Š23â”Š  flex: 1;\n+â”Š  â”Š24â”Š`;\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Šinterface ChildComponentProps {\n+â”Š  â”Š27â”Š  history: History;\n+â”Š  â”Š28â”Š}\n+â”Š  â”Š29â”Š\n+â”Š  â”Š30â”Šconst ChatCreationNavbar: React.FC<ChildComponentProps> = ({ history }) => {\n+â”Š  â”Š31â”Š  const navBack = useCallback(() => {\n+â”Š  â”Š32â”Š    history.replace('/chats');\n+â”Š  â”Š33â”Š  }, [history]);\n+â”Š  â”Š34â”Š\n+â”Š  â”Š35â”Š  return (\n+â”Š  â”Š36â”Š    <Container>\n+â”Š  â”Š37â”Š      <BackButton data-testid=\"back-button\" onClick={navBack}>\n+â”Š  â”Š38â”Š        <ArrowBackIcon />\n+â”Š  â”Š39â”Š      </BackButton>\n+â”Š  â”Š40â”Š      <Title>Create Chat</Title>\n+â”Š  â”Š41â”Š    </Container>\n+â”Š  â”Š42â”Š  );\n+â”Š  â”Š43â”Š};\n+â”Š  â”Š44â”Š\n+â”Š  â”Š45â”Šexport default ChatCreationNavbar;\n```\n\n##### Added src&#x2F;components&#x2F;ChatCreationScreen&#x2F;index.tsx\n```diff\n@@ -0,0 +1,29 @@\n+â”Š  â”Š 1â”Šimport React from 'react';\n+â”Š  â”Š 2â”Šimport styled from 'styled-components';\n+â”Š  â”Š 3â”Šimport UsersList from '../UsersList';\n+â”Š  â”Š 4â”Šimport ChatCreationNavbar from './ChatCreationNavbar';\n+â”Š  â”Š 5â”Šimport { History } from 'history';\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Š// eslint-disable-next-line\n+â”Š  â”Š 8â”Šconst Container = styled.div`\n+â”Š  â”Š 9â”Š  height: calc(100% - 56px);\n+â”Š  â”Š10â”Š  overflow-y: overlay;\n+â”Š  â”Š11â”Š`;\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Š// eslint-disable-next-line\n+â”Š  â”Š14â”Šconst StyledUsersList = styled(UsersList)`\n+â”Š  â”Š15â”Š  height: calc(100% - 56px);\n+â”Š  â”Š16â”Š`;\n+â”Š  â”Š17â”Š\n+â”Š  â”Š18â”Šinterface ChildComponentProps {\n+â”Š  â”Š19â”Š  history: History;\n+â”Š  â”Š20â”Š}\n+â”Š  â”Š21â”Š\n+â”Š  â”Š22â”Šconst ChatCreationScreen: React.FC<ChildComponentProps> = ({ history }) => (\n+â”Š  â”Š23â”Š  <div>\n+â”Š  â”Š24â”Š    <ChatCreationNavbar history={history} />\n+â”Š  â”Š25â”Š    <UsersList />\n+â”Š  â”Š26â”Š  </div>\n+â”Š  â”Š27â”Š);\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Šexport default ChatCreationScreen;\n```\n\n[}]: #\n\nThe screen will be available under the route `/new-chat`. The new route will be restricted, since only authenticated users should be able to access it:\n\n[{]: <helper> (diffStep 12.1 files=\"App\" module=\"client\")\n\n#### [__Client__ Step 12.1: Add basic ChatCreationScreen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/ca9ada37bc11311bef601debb77d87c3c5a770c9)\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -8,6 +8,7 @@\n â”Š 8â”Š 8â”Šimport AuthScreen from './components/AuthScreen';\n â”Š 9â”Š 9â”Šimport ChatRoomScreen from './components/ChatRoomScreen';\n â”Š10â”Š10â”Šimport ChatsListScreen from './components/ChatsListScreen';\n+â”Š  â”Š11â”Šimport ChatCreationScreen from './components/ChatCreationScreen';\n â”Š11â”Š12â”Šimport AnimatedSwitch from './components/AnimatedSwitch';\n â”Š12â”Š13â”Šimport { withAuth } from './services/auth.service';\n â”Š13â”Š14â”Š\n```\n```diff\n@@ -26,6 +27,8 @@\n â”Š26â”Š27â”Š          )\n â”Š27â”Š28â”Š        )}\n â”Š28â”Š29â”Š      />\n+â”Š  â”Š30â”Š\n+â”Š  â”Š31â”Š      <Route exact path=\"/new-chat\" component={withAuth(ChatCreationScreen)} />\n â”Š29â”Š32â”Š    </AnimatedSwitch>\n â”Š30â”Š33â”Š    <Route exact path=\"/\" render={redirectToChats} />\n â”Š31â”Š34â”Š  </BrowserRouter>\n```\n\n[}]: #\n\nthe `/new-chat` route will be accessible directly from the main `ChatsListScreen`. We will implement a navigation button which is gonna have a fixed position at the bottom right corner of the screen:\n\n[{]: <helper> (diffStep 12.1 files=\"AddChatButton\" module=\"client\")\n\n#### [__Client__ Step 12.1: Add basic ChatCreationScreen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/ca9ada37bc11311bef601debb77d87c3c5a770c9)\n\n##### Added src&#x2F;components&#x2F;ChatsListScreen&#x2F;AddChatButton.test.tsx\n```diff\n@@ -0,0 +1,27 @@\n+â”Š  â”Š 1â”Šimport { createMemoryHistory } from 'history';\n+â”Š  â”Š 2â”Šimport { ApolloProvider } from '@apollo/react-hooks';\n+â”Š  â”Š 3â”Šimport React from 'react';\n+â”Š  â”Š 4â”Šimport { cleanup, render, fireEvent, wait } from '@testing-library/react';\n+â”Š  â”Š 5â”Šimport AddChatButton from './AddChatButton';\n+â”Š  â”Š 6â”Šimport { mockApolloClient } from '../../test-helpers';\n+â”Š  â”Š 7â”Š\n+â”Š  â”Š 8â”Šdescribe('AddChatButton', () => {\n+â”Š  â”Š 9â”Š  afterEach(cleanup);\n+â”Š  â”Š10â”Š\n+â”Š  â”Š11â”Š  it('goes back on arrow click', async () => {\n+â”Š  â”Š12â”Š    const history = createMemoryHistory();\n+â”Š  â”Š13â”Š    const client = mockApolloClient();\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”Š    {\n+â”Š  â”Š16â”Š      const { container, getByTestId } = render(\n+â”Š  â”Š17â”Š        <ApolloProvider client={client}>\n+â”Š  â”Š18â”Š          <AddChatButton history={history} />\n+â”Š  â”Š19â”Š        </ApolloProvider>\n+â”Š  â”Š20â”Š      );\n+â”Š  â”Š21â”Š\n+â”Š  â”Š22â”Š      fireEvent.click(getByTestId('new-chat-button'));\n+â”Š  â”Š23â”Š\n+â”Š  â”Š24â”Š      await wait(() => expect(history.location.pathname).toEqual('/new-chat'));\n+â”Š  â”Š25â”Š    }\n+â”Š  â”Š26â”Š  });\n+â”Š  â”Š27â”Š});\n```\n\n##### Added src&#x2F;components&#x2F;ChatsListScreen&#x2F;AddChatButton.tsx\n```diff\n@@ -0,0 +1,43 @@\n+â”Š  â”Š 1â”Šimport Button from '@material-ui/core/Button';\n+â”Š  â”Š 2â”Šimport ChatIcon from '@material-ui/icons/Chat';\n+â”Š  â”Š 3â”Šimport React from 'react';\n+â”Š  â”Š 4â”Šimport styled from 'styled-components';\n+â”Š  â”Š 5â”Šimport { History } from 'history';\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Šconst Container = styled.div`\n+â”Š  â”Š 8â”Š  position: fixed;\n+â”Š  â”Š 9â”Š  right: 10px;\n+â”Š  â”Š10â”Š  bottom: 10px;\n+â”Š  â”Š11â”Š\n+â”Š  â”Š12â”Š  button {\n+â”Š  â”Š13â”Š    min-width: 50px;\n+â”Š  â”Š14â”Š    width: 50px;\n+â”Š  â”Š15â”Š    height: 50px;\n+â”Š  â”Š16â”Š    border-radius: 999px;\n+â”Š  â”Š17â”Š    background-color: var(--secondary-bg);\n+â”Š  â”Š18â”Š    color: white;\n+â”Š  â”Š19â”Š  }\n+â”Š  â”Š20â”Š`;\n+â”Š  â”Š21â”Šinterface ChildComponentProps {\n+â”Š  â”Š22â”Š  history: History;\n+â”Š  â”Š23â”Š}\n+â”Š  â”Š24â”Š\n+â”Š  â”Š25â”Šconst AddChatButton: React.FC<ChildComponentProps> = ({ history }) => {\n+â”Š  â”Š26â”Š  const onClick = () => {\n+â”Š  â”Š27â”Š    history.push('/new-chat');\n+â”Š  â”Š28â”Š  };\n+â”Š  â”Š29â”Š\n+â”Š  â”Š30â”Š  return (\n+â”Š  â”Š31â”Š    <Container>\n+â”Š  â”Š32â”Š      <Button\n+â”Š  â”Š33â”Š        data-testid=\"new-chat-button\"\n+â”Š  â”Š34â”Š        variant=\"contained\"\n+â”Š  â”Š35â”Š        color=\"secondary\"\n+â”Š  â”Š36â”Š        onClick={onClick}>\n+â”Š  â”Š37â”Š        <ChatIcon />\n+â”Š  â”Š38â”Š      </Button>\n+â”Š  â”Š39â”Š    </Container>\n+â”Š  â”Š40â”Š  );\n+â”Š  â”Š41â”Š};\n+â”Š  â”Š42â”Š\n+â”Š  â”Š43â”Šexport default AddChatButton;\n```\n\n[}]: #\n\nAnd then we will render it in the `ChatsListScreen`:\n\n[{]: <helper> (diffStep 12.1 files=\"ChatsListScreen/index\" module=\"client\")\n\n#### [__Client__ Step 12.1: Add basic ChatCreationScreen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/ca9ada37bc11311bef601debb77d87c3c5a770c9)\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;index.tsx\n```diff\n@@ -3,6 +3,7 @@\n â”Š3â”Š3â”Šimport ChatsList from './ChatsList';\n â”Š4â”Š4â”Šimport styled from 'styled-components';\n â”Š5â”Š5â”Šimport { History } from 'history';\n+â”Š â”Š6â”Šimport AddChatButton from './AddChatButton';\n â”Š6â”Š7â”Š\n â”Š7â”Š8â”Šconst Container = styled.div`\n â”Š8â”Š9â”Š  height: 100vh;\n```\n```diff\n@@ -16,6 +17,7 @@\n â”Š16â”Š17â”Š  <Container>\n â”Š17â”Š18â”Š    <ChatsNavbar history={history} />\n â”Š18â”Š19â”Š    <ChatsList history={history} />\n+â”Š  â”Š20â”Š    <AddChatButton history={history} />\n â”Š19â”Š21â”Š  </Container>\n â”Š20â”Š22â”Š);\n â”Š21â”Š23â”Š\n```\n\n[}]: #\n\nFor now we can only observe the users list. Our goal now is to be able to start chatting with a user once it has been clicked. First we will need to add a new mutation called `addChat` which will create a new chat document and add it to the chats collection. If the chat already exists we will return the existing instance. This behavior will help us navigate to the desired `ChatRoomScreen`, whether it exists or not:\n\n[{]: <helper> (diffStep 9.2 module=\"server\")\n\n#### [__Server__ Step 9.2: Add Mutation.addChat](https://github.com/Urigo/WhatsApp-Clone-Server/commit/c86ef2f1d09f8613540817e9fe5636c5a8250f6d)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,6 +1,6 @@\n â”Š1â”Š1â”Šimport { withFilter } from 'apollo-server-express';\n â”Š2â”Š2â”Šimport { GraphQLDateTime } from 'graphql-iso-date';\n-â”Š3â”Š â”Šimport { User, Message, chats, messages, users } from '../db';\n+â”Š â”Š3â”Šimport { User, Message, Chat, chats, messages, users } from '../db';\n â”Š4â”Š4â”Šimport { Resolvers } from '../types/graphql';\n â”Š5â”Š5â”Š\n â”Š6â”Š6â”Šconst resolvers: Resolvers = {\n```\n```diff\n@@ -123,6 +123,31 @@\n â”Š123â”Š123â”Š\n â”Š124â”Š124â”Š      return message;\n â”Š125â”Š125â”Š    },\n+â”Š   â”Š126â”Š\n+â”Š   â”Š127â”Š    addChat(root, { recipientId }, { currentUser }) {\n+â”Š   â”Š128â”Š      if (!currentUser) return null;\n+â”Š   â”Š129â”Š      if (!users.some(u => u.id === recipientId)) return null;\n+â”Š   â”Š130â”Š\n+â”Š   â”Š131â”Š      let chat = chats.find(\n+â”Š   â”Š132â”Š        c =>\n+â”Š   â”Š133â”Š          c.participants.includes(currentUser.id) &&\n+â”Š   â”Š134â”Š          c.participants.includes(recipientId)\n+â”Š   â”Š135â”Š      );\n+â”Š   â”Š136â”Š\n+â”Š   â”Š137â”Š      if (chat) return chat;\n+â”Š   â”Š138â”Š\n+â”Š   â”Š139â”Š      const chatsIds = chats.map(c => Number(c.id));\n+â”Š   â”Š140â”Š\n+â”Š   â”Š141â”Š      chat = {\n+â”Š   â”Š142â”Š        id: String(Math.max(...chatsIds) + 1),\n+â”Š   â”Š143â”Š        participants: [currentUser.id, recipientId],\n+â”Š   â”Š144â”Š        messages: [],\n+â”Š   â”Š145â”Š      };\n+â”Š   â”Š146â”Š\n+â”Š   â”Š147â”Š      chats.push(chat);\n+â”Š   â”Š148â”Š\n+â”Š   â”Š149â”Š      return chat;\n+â”Š   â”Š150â”Š    },\n â”Š126â”Š151â”Š  },\n â”Š127â”Š152â”Š\n â”Š128â”Š153â”Š  Subscription: {\n```\n\n##### Changed schema&#x2F;typeDefs.graphql\n```diff\n@@ -33,6 +33,7 @@\n â”Š33â”Š33â”Š\n â”Š34â”Š34â”Štype Mutation {\n â”Š35â”Š35â”Š  addMessage(chatId: ID!, content: String!): Message\n+â”Š  â”Š36â”Š  addChat(recipientId: ID!): Chat\n â”Š36â”Š37â”Š}\n â”Š37â”Š38â”Š\n â”Š38â”Š39â”Štype Subscription {\n```\n\n##### Added tests&#x2F;mutations&#x2F;\\__snapshots__&#x2F;addChat.test.ts.snap\n```diff\n@@ -0,0 +1,52 @@\n+â”Š  â”Š 1â”Š// Jest Snapshot v1, https://goo.gl/fbAQLP\n+â”Š  â”Š 2â”Š\n+â”Š  â”Š 3â”Šexports[`Mutation.addChat creates a new chat between current user and specified recipient 1`] = `\n+â”Š  â”Š 4â”ŠObject {\n+â”Š  â”Š 5â”Š  \"addChat\": Object {\n+â”Š  â”Š 6â”Š    \"id\": \"5\",\n+â”Š  â”Š 7â”Š    \"name\": \"Bryan Wallace\",\n+â”Š  â”Š 8â”Š    \"participants\": Array [\n+â”Š  â”Š 9â”Š      Object {\n+â”Š  â”Š10â”Š        \"id\": \"2\",\n+â”Š  â”Š11â”Š      },\n+â”Š  â”Š12â”Š      Object {\n+â”Š  â”Š13â”Š        \"id\": \"3\",\n+â”Š  â”Š14â”Š      },\n+â”Š  â”Š15â”Š    ],\n+â”Š  â”Š16â”Š  },\n+â”Š  â”Š17â”Š}\n+â”Š  â”Š18â”Š`;\n+â”Š  â”Š19â”Š\n+â”Š  â”Š20â”Šexports[`Mutation.addChat creates a new chat between current user and specified recipient 2`] = `\n+â”Š  â”Š21â”ŠObject {\n+â”Š  â”Š22â”Š  \"chat\": Object {\n+â”Š  â”Š23â”Š    \"id\": \"5\",\n+â”Š  â”Š24â”Š    \"name\": \"Bryan Wallace\",\n+â”Š  â”Š25â”Š    \"participants\": Array [\n+â”Š  â”Š26â”Š      Object {\n+â”Š  â”Š27â”Š        \"id\": \"2\",\n+â”Š  â”Š28â”Š      },\n+â”Š  â”Š29â”Š      Object {\n+â”Š  â”Š30â”Š        \"id\": \"3\",\n+â”Š  â”Š31â”Š      },\n+â”Š  â”Š32â”Š    ],\n+â”Š  â”Š33â”Š  },\n+â”Š  â”Š34â”Š}\n+â”Š  â”Š35â”Š`;\n+â”Š  â”Š36â”Š\n+â”Š  â”Š37â”Šexports[`Mutation.addChat returns the existing chat if so 1`] = `\n+â”Š  â”Š38â”ŠObject {\n+â”Š  â”Š39â”Š  \"addChat\": Object {\n+â”Š  â”Š40â”Š    \"id\": \"1\",\n+â”Š  â”Š41â”Š    \"name\": \"Ethan Gonzalez\",\n+â”Š  â”Š42â”Š    \"participants\": Array [\n+â”Š  â”Š43â”Š      Object {\n+â”Š  â”Š44â”Š        \"id\": \"1\",\n+â”Š  â”Š45â”Š      },\n+â”Š  â”Š46â”Š      Object {\n+â”Š  â”Š47â”Š        \"id\": \"2\",\n+â”Š  â”Š48â”Š      },\n+â”Š  â”Š49â”Š    ],\n+â”Š  â”Š50â”Š  },\n+â”Š  â”Š51â”Š}\n+â”Š  â”Š52â”Š`;\n```\n\n##### Added tests&#x2F;mutations&#x2F;addChat.test.ts\n```diff\n@@ -0,0 +1,89 @@\n+â”Š  â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n+â”Š  â”Š 2â”Šimport { ApolloServer, PubSub, gql } from 'apollo-server-express';\n+â”Š  â”Š 3â”Šimport schema from '../../schema';\n+â”Š  â”Š 4â”Šimport { resetDb, users } from '../../db';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šdescribe('Mutation.addChat', () => {\n+â”Š  â”Š 7â”Š  beforeEach(resetDb);\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Š  it('creates a new chat between current user and specified recipient', async () => {\n+â”Š  â”Š10â”Š    const server = new ApolloServer({\n+â”Š  â”Š11â”Š      schema,\n+â”Š  â”Š12â”Š      context: () => ({\n+â”Š  â”Š13â”Š        pubsub: new PubSub(),\n+â”Š  â”Š14â”Š        currentUser: users[1],\n+â”Š  â”Š15â”Š      }),\n+â”Š  â”Š16â”Š    });\n+â”Š  â”Š17â”Š\n+â”Š  â”Š18â”Š    const { query, mutate } = createTestClient(server);\n+â”Š  â”Š19â”Š\n+â”Š  â”Š20â”Š    const addChatRes = await mutate({\n+â”Š  â”Š21â”Š      variables: { recipientId: '3' },\n+â”Š  â”Š22â”Š      mutation: gql`\n+â”Š  â”Š23â”Š        mutation AddChat($recipientId: ID!) {\n+â”Š  â”Š24â”Š          addChat(recipientId: $recipientId) {\n+â”Š  â”Š25â”Š            id\n+â”Š  â”Š26â”Š            name\n+â”Š  â”Š27â”Š            participants {\n+â”Š  â”Š28â”Š              id\n+â”Š  â”Š29â”Š            }\n+â”Š  â”Š30â”Š          }\n+â”Š  â”Š31â”Š        }\n+â”Š  â”Š32â”Š      `,\n+â”Š  â”Š33â”Š    });\n+â”Š  â”Š34â”Š\n+â”Š  â”Š35â”Š    expect(addChatRes.data).toBeDefined();\n+â”Š  â”Š36â”Š    expect(addChatRes.errors).toBeUndefined();\n+â”Š  â”Š37â”Š    expect(addChatRes.data).toMatchSnapshot();\n+â”Š  â”Š38â”Š\n+â”Š  â”Š39â”Š    const getChatRes = await query({\n+â”Š  â”Š40â”Š      variables: { chatId: '5' },\n+â”Š  â”Š41â”Š      query: gql`\n+â”Š  â”Š42â”Š        query GetChat($chatId: ID!) {\n+â”Š  â”Š43â”Š          chat(chatId: $chatId) {\n+â”Š  â”Š44â”Š            id\n+â”Š  â”Š45â”Š            name\n+â”Š  â”Š46â”Š            participants {\n+â”Š  â”Š47â”Š              id\n+â”Š  â”Š48â”Š            }\n+â”Š  â”Š49â”Š          }\n+â”Š  â”Š50â”Š        }\n+â”Š  â”Š51â”Š      `,\n+â”Š  â”Š52â”Š    });\n+â”Š  â”Š53â”Š\n+â”Š  â”Š54â”Š    expect(getChatRes.data).toBeDefined();\n+â”Š  â”Š55â”Š    expect(getChatRes.errors).toBeUndefined();\n+â”Š  â”Š56â”Š    expect(getChatRes.data).toMatchSnapshot();\n+â”Š  â”Š57â”Š  });\n+â”Š  â”Š58â”Š\n+â”Š  â”Š59â”Š  it('returns the existing chat if so', async () => {\n+â”Š  â”Š60â”Š    const server = new ApolloServer({\n+â”Š  â”Š61â”Š      schema,\n+â”Š  â”Š62â”Š      context: () => ({\n+â”Š  â”Š63â”Š        pubsub: new PubSub(),\n+â”Š  â”Š64â”Š        currentUser: users[0],\n+â”Š  â”Š65â”Š      }),\n+â”Š  â”Š66â”Š    });\n+â”Š  â”Š67â”Š\n+â”Š  â”Š68â”Š    const { query, mutate } = createTestClient(server);\n+â”Š  â”Š69â”Š\n+â”Š  â”Š70â”Š    const addChatRes = await mutate({\n+â”Š  â”Š71â”Š      variables: { recipientId: '2' },\n+â”Š  â”Š72â”Š      mutation: gql`\n+â”Š  â”Š73â”Š        mutation AddChat($recipientId: ID!) {\n+â”Š  â”Š74â”Š          addChat(recipientId: $recipientId) {\n+â”Š  â”Š75â”Š            id\n+â”Š  â”Š76â”Š            name\n+â”Š  â”Š77â”Š            participants {\n+â”Š  â”Š78â”Š              id\n+â”Š  â”Š79â”Š            }\n+â”Š  â”Š80â”Š          }\n+â”Š  â”Š81â”Š        }\n+â”Š  â”Š82â”Š      `,\n+â”Š  â”Š83â”Š    });\n+â”Š  â”Š84â”Š\n+â”Š  â”Š85â”Š    expect(addChatRes.data).toBeDefined();\n+â”Š  â”Š86â”Š    expect(addChatRes.errors).toBeUndefined();\n+â”Š  â”Š87â”Š    expect(addChatRes.data).toMatchSnapshot();\n+â”Š  â”Š88â”Š  });\n+â”Š  â”Š89â”Š});\n```\n\n[}]: #\n\nTo use the new mutation, we will define a new callback called `onUserPick` in the `UsersList` so it can be used from the `ChatCreationScreen`:\n\n[{]: <helper> (diffStep 12.2 files=\"UsersList\" module=\"client\")\n\n#### [__Client__ Step 12.2: Create chat on user pick](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/de1c1495742f075c2487bfa2be3c0fdaf91ede62)\n\n##### Changed src&#x2F;components&#x2F;UsersList.test.tsx\n```diff\n@@ -1,6 +1,12 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n â”Š 2â”Š 2â”Šimport { ApolloProvider } from '@apollo/react-hooks';\n-â”Š 3â”Š  â”Šimport { cleanup, render, waitForDomChange } from '@testing-library/react';\n+â”Š  â”Š 3â”Šimport {\n+â”Š  â”Š 4â”Š  cleanup,\n+â”Š  â”Š 5â”Š  render,\n+â”Š  â”Š 6â”Š  fireEvent,\n+â”Š  â”Š 7â”Š  wait,\n+â”Š  â”Š 8â”Š  waitForDomChange,\n+â”Š  â”Š 9â”Š} from '@testing-library/react';\n â”Š 4â”Š10â”Šimport { mockApolloClient } from '../test-helpers';\n â”Š 5â”Š11â”Šimport UsersList, { UsersListQuery } from './UsersList';\n â”Š 6â”Š12â”Šimport * as queries from '../graphql/queries';\n```\n```diff\n@@ -43,4 +49,45 @@\n â”Š43â”Š49â”Š      );\n â”Š44â”Š50â”Š    }\n â”Š45â”Š51â”Š  });\n+â”Š  â”Š52â”Š\n+â”Š  â”Š53â”Š  it('triggers onUserPick() callback on user-item click', async () => {\n+â”Š  â”Š54â”Š    const client = mockApolloClient([\n+â”Š  â”Š55â”Š      {\n+â”Š  â”Š56â”Š        request: { query: UsersListQuery },\n+â”Š  â”Š57â”Š        result: {\n+â”Š  â”Š58â”Š          data: {\n+â”Š  â”Š59â”Š            users: [\n+â”Š  â”Š60â”Š              {\n+â”Š  â”Š61â”Š                __typename: 'User',\n+â”Š  â”Š62â”Š                id: 1,\n+â”Š  â”Š63â”Š                name: 'Charles Dickhead',\n+â”Š  â”Š64â”Š                picture: 'https://localhost:4000/dick.jpg',\n+â”Š  â”Š65â”Š              },\n+â”Š  â”Š66â”Š            ],\n+â”Š  â”Š67â”Š          },\n+â”Š  â”Š68â”Š        },\n+â”Š  â”Š69â”Š      },\n+â”Š  â”Š70â”Š    ]);\n+â”Š  â”Š71â”Š\n+â”Š  â”Š72â”Š    const onUserPick = jest.fn(() => {});\n+â”Š  â”Š73â”Š\n+â”Š  â”Š74â”Š    {\n+â”Š  â”Š75â”Š      const { container, getByTestId } = render(\n+â”Š  â”Š76â”Š        <ApolloProvider client={client}>\n+â”Š  â”Š77â”Š          <UsersList onUserPick={onUserPick} />\n+â”Š  â”Š78â”Š        </ApolloProvider>\n+â”Š  â”Š79â”Š      );\n+â”Š  â”Š80â”Š\n+â”Š  â”Š81â”Š      await waitForDomChange({ container });\n+â”Š  â”Š82â”Š\n+â”Š  â”Š83â”Š      fireEvent.click(getByTestId('user'));\n+â”Š  â”Š84â”Š\n+â”Š  â”Š85â”Š      await wait(() => expect(onUserPick.mock.calls.length).toBe(1));\n+â”Š  â”Š86â”Š\n+â”Š  â”Š87â”Š      expect(onUserPick.mock.calls[0][0].name).toEqual('Charles Dickhead');\n+â”Š  â”Š88â”Š      expect(onUserPick.mock.calls[0][0].picture).toEqual(\n+â”Š  â”Š89â”Š        'https://localhost:4000/dick.jpg'\n+â”Š  â”Š90â”Š      );\n+â”Š  â”Š91â”Š    }\n+â”Š  â”Š92â”Š  });\n â”Š46â”Š93â”Š});\n```\n\n##### Changed src&#x2F;components&#x2F;UsersList.tsx\n```diff\n@@ -4,7 +4,7 @@\n â”Š 4â”Š 4â”Šimport React from 'react';\n â”Š 5â”Š 5â”Šimport styled from 'styled-components';\n â”Š 6â”Š 6â”Šimport * as fragments from '../graphql/fragments';\n-â”Š 7â”Š  â”Šimport { useUsersListQuery } from '../graphql/types';\n+â”Š  â”Š 7â”Šimport { useUsersListQuery, User } from '../graphql/types';\n â”Š 8â”Š 8â”Š\n â”Š 9â”Š 9â”Šconst ActualList = styled(MaterialList)`\n â”Š10â”Š10â”Š  padding: 0;\n```\n```diff\n@@ -38,7 +38,13 @@\n â”Š38â”Š38â”Š  ${fragments.user}\n â”Š39â”Š39â”Š`;\n â”Š40â”Š40â”Š\n-â”Š41â”Š  â”Šconst UsersList: React.FC = () => {\n+â”Š  â”Š41â”Šinterface ChildComponentProps {\n+â”Š  â”Š42â”Š  onUserPick: any;\n+â”Š  â”Š43â”Š}\n+â”Š  â”Š44â”Š\n+â”Š  â”Š45â”Šconst UsersList: React.FC<ChildComponentProps> = ({\n+â”Š  â”Š46â”Š  onUserPick = (user: User) => {},\n+â”Š  â”Š47â”Š}) => {\n â”Š42â”Š48â”Š  const { data, loading: loadingUsers } = useUsersListQuery();\n â”Š43â”Š49â”Š\n â”Š44â”Š50â”Š  if (data === undefined) return null;\n```\n```diff\n@@ -48,7 +54,11 @@\n â”Š48â”Š54â”Š    <ActualList>\n â”Š49â”Š55â”Š      {!loadingUsers &&\n â”Š50â”Š56â”Š        users.map(user => (\n-â”Š51â”Š  â”Š          <UserItem key={user.id} button>\n+â”Š  â”Š57â”Š          <UserItem\n+â”Š  â”Š58â”Š            key={user.id}\n+â”Š  â”Š59â”Š            data-testid=\"user\"\n+â”Š  â”Š60â”Š            onClick={onUserPick.bind(null, user)}\n+â”Š  â”Š61â”Š            button>\n â”Š52â”Š62â”Š            {user !== null && user.picture !== null && (\n â”Š53â”Š63â”Š              <React.Fragment>\n â”Š54â”Š64â”Š                <ProfilePicture data-testid=\"picture\" src={user.picture} />\n```\n\n[}]: #\n\nIn the `ChatCreationScreen/index.tsx` module, we will define an `AddChat` document with `graphql-tag`. Using the `$ yarn codegen` command we can generate the correlated React mutation hook and use it as the `onUserPick` callback:\n\n[{]: <helper> (diffStep 12.2 files=\"ChatCreationScreen/index\" module=\"client\")\n\n#### [__Client__ Step 12.2: Create chat on user pick](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/de1c1495742f075c2487bfa2be3c0fdaf91ede62)\n\n##### Changed src&#x2F;components&#x2F;ChatCreationScreen&#x2F;index.tsx\n```diff\n@@ -1,8 +1,12 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag';\n â”Š 1â”Š 2â”Šimport React from 'react';\n+â”Š  â”Š 3â”Šimport { useCallback } from 'react';\n â”Š 2â”Š 4â”Šimport styled from 'styled-components';\n+â”Š  â”Š 5â”Šimport * as fragments from '../../graphql/fragments';\n â”Š 3â”Š 6â”Šimport UsersList from '../UsersList';\n â”Š 4â”Š 7â”Šimport ChatCreationNavbar from './ChatCreationNavbar';\n â”Š 5â”Š 8â”Šimport { History } from 'history';\n+â”Š  â”Š 9â”Šimport { useAddChatMutation } from '../../graphql/types';\n â”Š 6â”Š10â”Š\n â”Š 7â”Š11â”Š// eslint-disable-next-line\n â”Š 8â”Š12â”Šconst Container = styled.div`\n```\n```diff\n@@ -15,15 +19,53 @@\n â”Š15â”Š19â”Š  height: calc(100% - 56px);\n â”Š16â”Š20â”Š`;\n â”Š17â”Š21â”Š\n+â”Š  â”Š22â”Šgql`\n+â”Š  â”Š23â”Š  mutation AddChat($recipientId: ID!) {\n+â”Š  â”Š24â”Š    addChat(recipientId: $recipientId) {\n+â”Š  â”Š25â”Š      ...Chat\n+â”Š  â”Š26â”Š    }\n+â”Š  â”Š27â”Š  }\n+â”Š  â”Š28â”Š  ${fragments.chat}\n+â”Š  â”Š29â”Š`;\n+â”Š  â”Š30â”Š\n â”Š18â”Š31â”Šinterface ChildComponentProps {\n â”Š19â”Š32â”Š  history: History;\n â”Š20â”Š33â”Š}\n â”Š21â”Š34â”Š\n-â”Š22â”Š  â”Šconst ChatCreationScreen: React.FC<ChildComponentProps> = ({ history }) => (\n-â”Š23â”Š  â”Š  <div>\n-â”Š24â”Š  â”Š    <ChatCreationNavbar history={history} />\n-â”Š25â”Š  â”Š    <UsersList />\n-â”Š26â”Š  â”Š  </div>\n-â”Š27â”Š  â”Š);\n+â”Š  â”Š35â”Šconst ChatCreationScreen: React.FC<ChildComponentProps> = ({ history }) => {\n+â”Š  â”Š36â”Š  const [addChat] = useAddChatMutation();\n+â”Š  â”Š37â”Š\n+â”Š  â”Š38â”Š  const onUserPick = useCallback(\n+â”Š  â”Š39â”Š    user => addChat({\n+â”Š  â”Š40â”Š        optimisticResponse: {\n+â”Š  â”Š41â”Š          __typename: 'Mutation',\n+â”Š  â”Š42â”Š          addChat: {\n+â”Š  â”Š43â”Š            __typename: 'Chat',\n+â”Š  â”Š44â”Š            id: Math.random()\n+â”Š  â”Š45â”Š              .toString(36)\n+â”Š  â”Š46â”Š              .substr(2, 9),\n+â”Š  â”Š47â”Š            name: user.name,\n+â”Š  â”Š48â”Š            picture: user.picture,\n+â”Š  â”Š49â”Š            lastMessage: null,\n+â”Š  â”Š50â”Š          },\n+â”Š  â”Š51â”Š        },\n+â”Š  â”Š52â”Š        variables: {\n+â”Š  â”Š53â”Š          recipientId: user.id,\n+â”Š  â”Š54â”Š        },\n+â”Š  â”Š55â”Š      }).then(result => {\n+â”Š  â”Š56â”Š        if (result && result.data !== null) {\n+â”Š  â”Š57â”Š          history.push(`/chats/${result.data!.addChat!.id}`);\n+â”Š  â”Š58â”Š        }\n+â”Š  â”Š59â”Š      }),\n+â”Š  â”Š60â”Š    [addChat, history]\n+â”Š  â”Š61â”Š  );\n+â”Š  â”Š62â”Š\n+â”Š  â”Š63â”Š  return (\n+â”Š  â”Š64â”Š    <div>\n+â”Š  â”Š65â”Š      <ChatCreationNavbar history={history} />\n+â”Š  â”Š66â”Š      <UsersList onUserPick={onUserPick} />\n+â”Š  â”Š67â”Š    </div>\n+â”Š  â”Š68â”Š  );\n+â”Š  â”Š69â”Š};\n â”Š28â”Š70â”Š\n â”Š29â”Š71â”Šexport default ChatCreationScreen;\n```\n\n[}]: #\n\nChats can now be created, you can test out the function by signing in with different users. However, the chats list in the `ChatsListScreen` will not be updated unless we refresh the page manually. In the server project, we will define a new subscription called `chatAdded`. The subscription should be broadcasted to the current user only if he is a participant of the published chat:\n\n[{]: <helper> (diffStep 9.3 module=\"server\")\n\n#### [__Server__ Step 9.3: Add Subscription.chatAdded](https://github.com/Urigo/WhatsApp-Clone-Server/commit/81dc8f862c13ef6dee22d6e5a42d1bb38d6882e6)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -124,7 +124,7 @@\n â”Š124â”Š124â”Š      return message;\n â”Š125â”Š125â”Š    },\n â”Š126â”Š126â”Š\n-â”Š127â”Š   â”Š    addChat(root, { recipientId }, { currentUser }) {\n+â”Š   â”Š127â”Š    addChat(root, { recipientId }, { currentUser, pubsub }) {\n â”Š128â”Š128â”Š      if (!currentUser) return null;\n â”Š129â”Š129â”Š      if (!users.some(u => u.id === recipientId)) return null;\n â”Š130â”Š130â”Š\n```\n```diff\n@@ -146,6 +146,10 @@\n â”Š146â”Š146â”Š\n â”Š147â”Š147â”Š      chats.push(chat);\n â”Š148â”Š148â”Š\n+â”Š   â”Š149â”Š      pubsub.publish('chatAdded', {\n+â”Š   â”Š150â”Š        chatAdded: chat,\n+â”Š   â”Š151â”Š      });\n+â”Š   â”Š152â”Š\n â”Š149â”Š153â”Š      return chat;\n â”Š150â”Š154â”Š    },\n â”Š151â”Š155â”Š  },\n```\n```diff\n@@ -163,6 +167,17 @@\n â”Š163â”Š167â”Š        }\n â”Š164â”Š168â”Š      ),\n â”Š165â”Š169â”Š    },\n+â”Š   â”Š170â”Š\n+â”Š   â”Š171â”Š    chatAdded: {\n+â”Š   â”Š172â”Š      subscribe: withFilter(\n+â”Š   â”Š173â”Š        (root, args, { pubsub }) => pubsub.asyncIterator('chatAdded'),\n+â”Š   â”Š174â”Š        ({ chatAdded }: { chatAdded: Chat }, args, { currentUser }) => {\n+â”Š   â”Š175â”Š          if (!currentUser) return false;\n+â”Š   â”Š176â”Š\n+â”Š   â”Š177â”Š          return chatAdded.participants.some(p => p === currentUser.id);\n+â”Š   â”Š178â”Š        }\n+â”Š   â”Š179â”Š      ),\n+â”Š   â”Š180â”Š    },\n â”Š166â”Š181â”Š  },\n â”Š167â”Š182â”Š};\n â”Š168â”Š183â”Š\n```\n\n##### Changed schema&#x2F;typeDefs.graphql\n```diff\n@@ -38,4 +38,5 @@\n â”Š38â”Š38â”Š\n â”Š39â”Š39â”Štype Subscription {\n â”Š40â”Š40â”Š  messageAdded: Message!\n+â”Š  â”Š41â”Š  chatAdded: Chat!\n â”Š41â”Š42â”Š}\n```\n\n[}]: #\n\nNow we will listen to the new subscription in the client and update the cache. First we will define the subscription document:\n\n[{]: <helper> (diffStep 12.3 files=\"graphql/subscriptions\" module=\"client\")\n\n#### [__Client__ Step 12.3: Write chat on chatAdded](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/5073d686317caffb352e53f4b1819314caac3e11)\n\n##### Added src&#x2F;graphql&#x2F;subscriptions&#x2F;chatAdded.subscription.ts\n```diff\n@@ -0,0 +1,11 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag';\n+â”Š  â”Š 2â”Šimport * as fragments from '../fragments';\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šexport default gql`\n+â”Š  â”Š 5â”Š  subscription ChatAdded {\n+â”Š  â”Š 6â”Š    chatAdded {\n+â”Š  â”Š 7â”Š      ...Chat\n+â”Š  â”Š 8â”Š    }\n+â”Š  â”Š 9â”Š  }\n+â”Š  â”Š10â”Š  ${fragments.chat}\n+â”Š  â”Š11â”Š`;\n```\n\n##### Changed src&#x2F;graphql&#x2F;subscriptions&#x2F;index.ts\n```diff\n@@ -1 +1,2 @@\n â”Š1â”Š1â”Šexport { default as messageAdded } from './messageAdded.subscription';\n+â”Š â”Š2â”Šexport { default as chatAdded } from './chatAdded.subscription';\n```\n\n[}]: #\n\nAnd then we will update the `cache.service` to write the broadcasted chat to the store. We will write the fragment, and we will also update the `chats` query to contain the new chat. We will also check if the chat already exists before we update the query, because remember, the `addChat` mutation will return the chat even if it already exists, not if it was created only:\n\n[{]: <helper> (diffStep 12.3 module=\"client\")\n\n#### [__Client__ Step 12.3: Write chat on chatAdded](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/5073d686317caffb352e53f4b1819314caac3e11)\n\n##### Changed src&#x2F;components&#x2F;ChatCreationScreen&#x2F;index.tsx\n```diff\n@@ -7,6 +7,7 @@\n â”Š 7â”Š 7â”Šimport ChatCreationNavbar from './ChatCreationNavbar';\n â”Š 8â”Š 8â”Šimport { History } from 'history';\n â”Š 9â”Š 9â”Šimport { useAddChatMutation } from '../../graphql/types';\n+â”Š  â”Š10â”Šimport { writeChat } from '../../services/cache.service';\n â”Š10â”Š11â”Š\n â”Š11â”Š12â”Š// eslint-disable-next-line\n â”Š12â”Š13â”Šconst Container = styled.div`\n```\n```diff\n@@ -52,6 +53,9 @@\n â”Š52â”Š53â”Š        variables: {\n â”Š53â”Š54â”Š          recipientId: user.id,\n â”Š54â”Š55â”Š        },\n+â”Š  â”Š56â”Š        update: (client, { data: { addChat } }) => {\n+â”Š  â”Š57â”Š          writeChat(client, addChat);\n+â”Š  â”Š58â”Š        },\n â”Š55â”Š59â”Š      }).then(result => {\n â”Š56â”Š60â”Š        if (result && result.data !== null) {\n â”Š57â”Š61â”Š          history.push(`/chats/${result.data!.addChat!.id}`);\n```\n\n##### Added src&#x2F;graphql&#x2F;subscriptions&#x2F;chatAdded.subscription.ts\n```diff\n@@ -0,0 +1,11 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag';\n+â”Š  â”Š 2â”Šimport * as fragments from '../fragments';\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šexport default gql`\n+â”Š  â”Š 5â”Š  subscription ChatAdded {\n+â”Š  â”Š 6â”Š    chatAdded {\n+â”Š  â”Š 7â”Š      ...Chat\n+â”Š  â”Š 8â”Š    }\n+â”Š  â”Š 9â”Š  }\n+â”Š  â”Š10â”Š  ${fragments.chat}\n+â”Š  â”Š11â”Š`;\n```\n\n##### Changed src&#x2F;graphql&#x2F;subscriptions&#x2F;index.ts\n```diff\n@@ -1 +1,2 @@\n â”Š1â”Š1â”Šexport { default as messageAdded } from './messageAdded.subscription';\n+â”Š â”Š2â”Šexport { default as chatAdded } from './chatAdded.subscription';\n```\n\n##### Changed src&#x2F;services&#x2F;cache.service.ts\n```diff\n@@ -3,7 +3,12 @@\n â”Š 3â”Š 3â”Šimport { ApolloClient } from 'apollo-client';\n â”Š 4â”Š 4â”Šimport * as fragments from '../graphql/fragments';\n â”Š 5â”Š 5â”Šimport * as queries from '../graphql/queries';\n-â”Š 6â”Š  â”Šimport { MessageFragment, useMessageAddedSubscription } from '../graphql/types';\n+â”Š  â”Š 6â”Šimport {\n+â”Š  â”Š 7â”Š  MessageFragment,\n+â”Š  â”Š 8â”Š  ChatFragment,\n+â”Š  â”Š 9â”Š  useMessageAddedSubscription,\n+â”Š  â”Š10â”Š  useChatAddedSubscription,\n+â”Š  â”Š11â”Š} from '../graphql/types';\n â”Š 7â”Š12â”Š\n â”Š 8â”Š13â”Štype Client = ApolloClient<any> | DataProxy;\n â”Š 9â”Š14â”Š\n```\n```diff\n@@ -15,6 +20,14 @@\n â”Š15â”Š20â”Š      }\n â”Š16â”Š21â”Š    },\n â”Š17â”Š22â”Š  });\n+â”Š  â”Š23â”Š\n+â”Š  â”Š24â”Š  useChatAddedSubscription({\n+â”Š  â”Š25â”Š    onSubscriptionData: ({ client, subscriptionData: { data } }) => {\n+â”Š  â”Š26â”Š      if (data) {\n+â”Š  â”Š27â”Š        writeChat(client, data.chatAdded);\n+â”Š  â”Š28â”Š      }\n+â”Š  â”Š29â”Š    },\n+â”Š  â”Š30â”Š  });\n â”Š18â”Š31â”Š};\n â”Š19â”Š32â”Š\n â”Š20â”Š33â”Šexport const writeMessage = (client: Client, message: MessageFragment) => {\n```\n```diff\n@@ -84,3 +97,40 @@\n â”Š 84â”Š 97â”Š    data: { chats: chats },\n â”Š 85â”Š 98â”Š  });\n â”Š 86â”Š 99â”Š};\n+â”Š   â”Š100â”Š\n+â”Š   â”Š101â”Šexport const writeChat = (client: Client, chat: ChatFragment) => {\n+â”Š   â”Š102â”Š  const chatId = defaultDataIdFromObject(chat);\n+â”Š   â”Š103â”Š  if (chatId === null) {\n+â”Š   â”Š104â”Š    return;\n+â”Š   â”Š105â”Š  }\n+â”Š   â”Š106â”Š\n+â”Š   â”Š107â”Š  client.writeFragment({\n+â”Š   â”Š108â”Š    id: chatId,\n+â”Š   â”Š109â”Š    fragment: fragments.chat,\n+â”Š   â”Š110â”Š    fragmentName: 'Chat',\n+â”Š   â”Š111â”Š    data: chat,\n+â”Š   â”Š112â”Š  });\n+â”Š   â”Š113â”Š\n+â”Š   â”Š114â”Š  let data;\n+â”Š   â”Š115â”Š  try {\n+â”Š   â”Š116â”Š    data = client.readQuery({\n+â”Š   â”Š117â”Š      query: queries.chats,\n+â”Š   â”Š118â”Š    });\n+â”Š   â”Š119â”Š  } catch (e) {\n+â”Š   â”Š120â”Š    return;\n+â”Š   â”Š121â”Š  }\n+â”Š   â”Š122â”Š\n+â”Š   â”Š123â”Š  if (!data) return;\n+â”Š   â”Š124â”Š\n+â”Š   â”Š125â”Š  const chats = data.chats;\n+â”Š   â”Š126â”Š\n+â”Š   â”Š127â”Š  if (!chats) return;\n+â”Š   â”Š128â”Š  if (chats.some((c: any) => c.id === chat.id)) return;\n+â”Š   â”Š129â”Š\n+â”Š   â”Š130â”Š  chats.unshift(chat);\n+â”Š   â”Š131â”Š\n+â”Š   â”Š132â”Š  client.writeQuery({\n+â”Š   â”Š133â”Š    query: queries.chats,\n+â”Š   â”Š134â”Š    data: { chats },\n+â”Š   â”Š135â”Š  });\n+â”Š   â”Š136â”Š};\n```\n\n[}]: #\n\nNow we can create new chats, and the chats list would be updated, without refreshing the page. You can also test it with 2 separate sessions in the browser and see how each tab/window affects the other. Lastly, we will implement a chat removal function. This is important as we donâ€™t want to garbage our chats collection, sometimes we would like to clean up some of them.\n\nIn the back-end, letâ€™s implement the `removeChat` mutation. The chat can only be removed only if the current user is one of the chatâ€™s participants. The mutation will also remove all the messages which are related to the target chat, since weâ€™re not gonna use them anymore. The chat will be removed for all participants. This is not exactly the behavior of the original Whatsapp, but to keep things simple we will go with that solution:\n\n[{]: <helper> (diffStep 9.4 module=\"server\")\n\n#### [__Server__ Step 9.4: Add Mutation.removeChat](https://github.com/Urigo/WhatsApp-Clone-Server/commit/3c7140974205f2fc34e4394488fd8b8f6d8c9a27)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -152,6 +152,30 @@\n â”Š152â”Š152â”Š\n â”Š153â”Š153â”Š      return chat;\n â”Š154â”Š154â”Š    },\n+â”Š   â”Š155â”Š\n+â”Š   â”Š156â”Š    removeChat(root, { chatId }, { currentUser }) {\n+â”Š   â”Š157â”Š      if (!currentUser) return null;\n+â”Š   â”Š158â”Š\n+â”Š   â”Š159â”Š      const chatIndex = chats.findIndex(c => c.id === chatId);\n+â”Š   â”Š160â”Š\n+â”Š   â”Š161â”Š      if (chatIndex === -1) return null;\n+â”Š   â”Š162â”Š\n+â”Š   â”Š163â”Š      const chat = chats[chatIndex];\n+â”Š   â”Š164â”Š\n+â”Š   â”Š165â”Š      if (!chat.participants.some(p => p === currentUser.id)) return null;\n+â”Š   â”Š166â”Š\n+â”Š   â”Š167â”Š      chat.messages.forEach(chatMessage => {\n+â”Š   â”Š168â”Š        const chatMessageIndex = messages.findIndex(m => m.id === chatMessage);\n+â”Š   â”Š169â”Š\n+â”Š   â”Š170â”Š        if (chatMessageIndex !== -1) {\n+â”Š   â”Š171â”Š          messages.splice(chatMessageIndex, 1);\n+â”Š   â”Š172â”Š        }\n+â”Š   â”Š173â”Š      });\n+â”Š   â”Š174â”Š\n+â”Š   â”Š175â”Š      chats.splice(chatIndex, 1);\n+â”Š   â”Š176â”Š\n+â”Š   â”Š177â”Š      return chatId;\n+â”Š   â”Š178â”Š    },\n â”Š155â”Š179â”Š  },\n â”Š156â”Š180â”Š\n â”Š157â”Š181â”Š  Subscription: {\n```\n\n##### Changed schema&#x2F;typeDefs.graphql\n```diff\n@@ -34,6 +34,7 @@\n â”Š34â”Š34â”Štype Mutation {\n â”Š35â”Š35â”Š  addMessage(chatId: ID!, content: String!): Message\n â”Š36â”Š36â”Š  addChat(recipientId: ID!): Chat\n+â”Š  â”Š37â”Š  removeChat(chatId: ID!): ID\n â”Š37â”Š38â”Š}\n â”Š38â”Š39â”Š\n â”Š39â”Š40â”Štype Subscription {\n```\n\n##### Added tests&#x2F;mutations&#x2F;removeChat.test.ts\n```diff\n@@ -0,0 +1,52 @@\n+â”Š  â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n+â”Š  â”Š 2â”Šimport { ApolloServer, PubSub, gql } from 'apollo-server-express';\n+â”Š  â”Š 3â”Šimport schema from '../../schema';\n+â”Š  â”Š 4â”Šimport { resetDb, users } from '../../db';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šdescribe('Mutation.removeChat', () => {\n+â”Š  â”Š 7â”Š  beforeEach(resetDb);\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Š  it('removes chat by id', async () => {\n+â”Š  â”Š10â”Š    const server = new ApolloServer({\n+â”Š  â”Š11â”Š      schema,\n+â”Š  â”Š12â”Š      context: () => ({\n+â”Š  â”Š13â”Š        pubsub: new PubSub(),\n+â”Š  â”Š14â”Š        currentUser: users[0],\n+â”Š  â”Š15â”Š      }),\n+â”Š  â”Š16â”Š    });\n+â”Š  â”Š17â”Š\n+â”Š  â”Š18â”Š    const { query, mutate } = createTestClient(server);\n+â”Š  â”Š19â”Š\n+â”Š  â”Š20â”Š    const addChatRes = await mutate({\n+â”Š  â”Š21â”Š      variables: { chatId: '1' },\n+â”Š  â”Š22â”Š      mutation: gql`\n+â”Š  â”Š23â”Š        mutation RemoveChat($chatId: ID!) {\n+â”Š  â”Š24â”Š          removeChat(chatId: $chatId)\n+â”Š  â”Š25â”Š        }\n+â”Š  â”Š26â”Š      `,\n+â”Š  â”Š27â”Š    });\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š    expect(addChatRes.data).toBeDefined();\n+â”Š  â”Š30â”Š    expect(addChatRes.errors).toBeUndefined();\n+â”Š  â”Š31â”Š    expect(addChatRes.data!.removeChat).toEqual('1');\n+â”Š  â”Š32â”Š\n+â”Š  â”Š33â”Š    const getChatRes = await query({\n+â”Š  â”Š34â”Š      variables: { chatId: '1' },\n+â”Š  â”Š35â”Š      query: gql`\n+â”Š  â”Š36â”Š        query GetChat($chatId: ID!) {\n+â”Š  â”Š37â”Š          chat(chatId: $chatId) {\n+â”Š  â”Š38â”Š            id\n+â”Š  â”Š39â”Š            name\n+â”Š  â”Š40â”Š            participants {\n+â”Š  â”Š41â”Š              id\n+â”Š  â”Š42â”Š            }\n+â”Š  â”Š43â”Š          }\n+â”Š  â”Š44â”Š        }\n+â”Š  â”Š45â”Š      `,\n+â”Š  â”Š46â”Š    });\n+â”Š  â”Š47â”Š\n+â”Š  â”Š48â”Š    expect(addChatRes.data).toBeDefined();\n+â”Š  â”Š49â”Š    expect(getChatRes.errors).toBeUndefined();\n+â”Š  â”Š50â”Š    expect(addChatRes.data!.chat).toBeUndefined();\n+â”Š  â”Š51â”Š  });\n+â”Š  â”Š52â”Š});\n```\n\n[}]: #\n\nIn the client app, a chat could be removed directly from the `ChatRoomScreen`. On the top right corner, right on the navbar, we will add a dispose button that will call the `removeChat` mutation. Just like we did before, we will define the mutation document with `graphql-tag` and generate the correlated hook with CodeGen:\n\n[{]: <helper> (diffStep 12.4 module=\"client\")\n\n#### [__Client__ Step 12.4: Add chat removal function](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/d22638a4f5b418c26eedacbc4da04f6a1138008e)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;ChatNavbar.test.tsx\n```diff\n@@ -1,12 +1,16 @@\n â”Š 1â”Š 1â”Šimport { createMemoryHistory } from 'history';\n â”Š 2â”Š 2â”Šimport React from 'react';\n+â”Š  â”Š 3â”Šimport { ApolloProvider } from '@apollo/react-hooks';\n â”Š 3â”Š 4â”Šimport { cleanup, render, fireEvent, wait } from '@testing-library/react';\n+â”Š  â”Š 5â”Šimport { mockApolloClient } from '../../test-helpers';\n â”Š 4â”Š 6â”Šimport ChatNavbar from './ChatNavbar';\n+â”Š  â”Š 7â”Šimport { RemoveChatDocument } from '../../graphql/types';\n â”Š 5â”Š 8â”Š\n â”Š 6â”Š 9â”Šdescribe('ChatNavbar', () => {\n â”Š 7â”Š10â”Š  afterEach(cleanup);\n â”Š 8â”Š11â”Š\n â”Š 9â”Š12â”Š  it('renders chat data', () => {\n+â”Š  â”Š13â”Š    const client = mockApolloClient();\n â”Š10â”Š14â”Š\n â”Š11â”Š15â”Š    const time = new Date('1 Jan 2019 GMT');\n â”Š12â”Š16â”Š    const chat = {\n```\n```diff\n@@ -30,7 +34,11 @@\n â”Š30â”Š34â”Š    const history = createMemoryHistory();\n â”Š31â”Š35â”Š\n â”Š32â”Š36â”Š    {\n-â”Š33â”Š  â”Š      const { container, getByTestId } = render(<ChatNavbar chat={chat} history={history}/>);\n+â”Š  â”Š37â”Š      const { container, getByTestId } = render(\n+â”Š  â”Š38â”Š        <ApolloProvider client={client}>\n+â”Š  â”Š39â”Š          <ChatNavbar chat={chat} history={history}/>\n+â”Š  â”Š40â”Š        </ApolloProvider>\n+â”Š  â”Š41â”Š      );\n â”Š34â”Š42â”Š\n â”Š35â”Š43â”Š      expect(getByTestId('chat-name')).toHaveTextContent('Foo Bar');\n â”Š36â”Š44â”Š      expect(getByTestId('chat-picture')).toHaveAttribute(\n```\n```diff\n@@ -41,6 +49,8 @@\n â”Š41â”Š49â”Š  });\n â”Š42â”Š50â”Š\n â”Š43â”Š51â”Š  it('goes back on arrow click', async () => {\n+â”Š  â”Š52â”Š    const client = mockApolloClient();\n+â”Š  â”Š53â”Š\n â”Š44â”Š54â”Š    const time = new Date('1 Jan 2019 GMT');\n â”Š45â”Š55â”Š    const chat = {\n â”Š46â”Š56â”Š      id: '1',\n```\n```diff\n@@ -68,7 +78,9 @@\n â”Š68â”Š78â”Š\n â”Š69â”Š79â”Š    {\n â”Š70â”Š80â”Š      const { container, getByTestId } = render(\n-â”Š71â”Š  â”Š        <ChatNavbar chat={chat} history={history} />\n+â”Š  â”Š81â”Š        <ApolloProvider client={client}>\n+â”Š  â”Š82â”Š          <ChatNavbar chat={chat} history={history} />\n+â”Š  â”Š83â”Š        </ApolloProvider>\n â”Š72â”Š84â”Š      );\n â”Š73â”Š85â”Š\n â”Š74â”Š86â”Š      fireEvent.click(getByTestId('back-button'));\n```\n```diff\n@@ -76,4 +88,57 @@\n â”Š 76â”Š 88â”Š      await wait(() => expect(history.location.pathname).toEqual('/chats'));\n â”Š 77â”Š 89â”Š    }\n â”Š 78â”Š 90â”Š  });\n+â”Š   â”Š 91â”Š\n+â”Š   â”Š 92â”Š  it('goes back on chat removal', async () => {\n+â”Š   â”Š 93â”Š    const client = mockApolloClient([\n+â”Š   â”Š 94â”Š      {\n+â”Š   â”Š 95â”Š        request: {\n+â”Š   â”Š 96â”Š          query: RemoveChatDocument,\n+â”Š   â”Š 97â”Š          variables: { chatId: '1' },\n+â”Š   â”Š 98â”Š        },\n+â”Š   â”Š 99â”Š        result: {\n+â”Š   â”Š100â”Š          data: {\n+â”Š   â”Š101â”Š            removeChat: '1',\n+â”Š   â”Š102â”Š          },\n+â”Š   â”Š103â”Š        },\n+â”Š   â”Š104â”Š      },\n+â”Š   â”Š105â”Š    ]);\n+â”Š   â”Š106â”Š\n+â”Š   â”Š107â”Š    const time = new Date('1 Jan 2019 GMT');\n+â”Š   â”Š108â”Š    const chat = {\n+â”Š   â”Š109â”Š      id: '1',\n+â”Š   â”Š110â”Š      name: 'Foo Bar',\n+â”Š   â”Š111â”Š      picture: 'https://localhost:4000/picture.jpg',\n+â”Š   â”Š112â”Š      messages: [\n+â”Š   â”Š113â”Š        {\n+â”Š   â”Š114â”Š          id: '1',\n+â”Š   â”Š115â”Š          content: 'foo',\n+â”Š   â”Š116â”Š          createdAt: time,\n+â”Š   â”Š117â”Š        },\n+â”Š   â”Š118â”Š        {\n+â”Š   â”Š119â”Š          id: '2',\n+â”Š   â”Š120â”Š          content: 'bar',\n+â”Š   â”Š121â”Š          createdAt: time,\n+â”Š   â”Š122â”Š        },\n+â”Š   â”Š123â”Š      ]\n+â”Š   â”Š124â”Š    };\n+â”Š   â”Š125â”Š\n+â”Š   â”Š126â”Š    const history = createMemoryHistory();\n+â”Š   â”Š127â”Š\n+â”Š   â”Š128â”Š    history.push('/chats/1');\n+â”Š   â”Š129â”Š\n+â”Š   â”Š130â”Š    await wait(() => expect(history.location.pathname).toEqual('/chats/1'));\n+â”Š   â”Š131â”Š\n+â”Š   â”Š132â”Š    {\n+â”Š   â”Š133â”Š      const { container, getByTestId } = render(\n+â”Š   â”Š134â”Š        <ApolloProvider client={client}>\n+â”Š   â”Š135â”Š          <ChatNavbar chat={chat} history={history} />\n+â”Š   â”Š136â”Š        </ApolloProvider>\n+â”Š   â”Š137â”Š      );\n+â”Š   â”Š138â”Š\n+â”Š   â”Š139â”Š      fireEvent.click(getByTestId('delete-button'));\n+â”Š   â”Š140â”Š\n+â”Š   â”Š141â”Š      await wait(() => expect(history.location.pathname).toEqual('/chats'));\n+â”Š   â”Š142â”Š    }\n+â”Š   â”Š143â”Š  });\n â”Š 79â”Š144â”Š});\n```\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;ChatNavbar.tsx\n```diff\n@@ -1,10 +1,13 @@\n â”Š 1â”Š 1â”Šimport Button from '@material-ui/core/Button';\n â”Š 2â”Š 2â”Šimport Toolbar from '@material-ui/core/Toolbar';\n â”Š 3â”Š 3â”Šimport ArrowBackIcon from '@material-ui/icons/ArrowBack';\n+â”Š  â”Š 4â”Šimport DeleteIcon from '@material-ui/icons/Delete';\n+â”Š  â”Š 5â”Šimport gql from 'graphql-tag';\n â”Š 4â”Š 6â”Šimport React from 'react';\n â”Š 5â”Š 7â”Šimport { useCallback } from 'react';\n â”Š 6â”Š 8â”Šimport styled from 'styled-components';\n â”Š 7â”Š 9â”Šimport { History } from 'history';\n+â”Š  â”Š10â”Šimport { useRemoveChatMutation } from '../../graphql/types';\n â”Š 8â”Š11â”Š\n â”Š 9â”Š12â”Šconst Container = styled(Toolbar)`\n â”Š10â”Š13â”Š  padding: 0;\n```\n```diff\n@@ -20,6 +23,12 @@\n â”Š20â”Š23â”Š  }\n â”Š21â”Š24â”Š`;\n â”Š22â”Š25â”Š\n+â”Š  â”Š26â”Šconst Rest = styled.div`\n+â”Š  â”Š27â”Š  flex: 1;\n+â”Š  â”Š28â”Š  display: flex;\n+â”Š  â”Š29â”Š  justify-content: flex-end;\n+â”Š  â”Š30â”Š`;\n+â”Š  â”Š31â”Š\n â”Š23â”Š32â”Šconst Picture = styled.img`\n â”Š24â”Š33â”Š  height: 40px;\n â”Š25â”Š34â”Š  width: 40px;\n```\n```diff\n@@ -34,15 +43,38 @@\n â”Š34â”Š43â”Š  line-height: 56px;\n â”Š35â”Š44â”Š`;\n â”Š36â”Š45â”Š\n+â”Š  â”Š46â”Šconst DeleteButton = styled(Button)`\n+â”Š  â”Š47â”Š  color: var(--primary-text) !important;\n+â”Š  â”Š48â”Š`;\n+â”Š  â”Š49â”Š\n+â”Š  â”Š50â”Šexport const removeChatMutation = gql`\n+â”Š  â”Š51â”Š  mutation RemoveChat($chatId: ID!) {\n+â”Š  â”Š52â”Š    removeChat(chatId: $chatId)\n+â”Š  â”Š53â”Š  }\n+â”Š  â”Š54â”Š`;\n+â”Š  â”Š55â”Š\n â”Š37â”Š56â”Šinterface ChatNavbarProps {\n â”Š38â”Š57â”Š  history: History;\n-â”Š39â”Š  â”Š  chat?: {\n+â”Š  â”Š58â”Š  chat: {\n â”Š40â”Š59â”Š    picture?: string | null;\n â”Š41â”Š60â”Š    name?: string | null;\n+â”Š  â”Š61â”Š    id: string;\n â”Š42â”Š62â”Š  };\n â”Š43â”Š63â”Š}\n â”Š44â”Š64â”Š\n â”Š45â”Š65â”Šconst ChatNavbar: React.FC<ChatNavbarProps> = ({ chat, history }) => {\n+â”Š  â”Š66â”Š  const [removeChat] = useRemoveChatMutation({\n+â”Š  â”Š67â”Š    variables: {\n+â”Š  â”Š68â”Š      chatId: chat.id,\n+â”Š  â”Š69â”Š    },\n+â”Š  â”Š70â”Š  });\n+â”Š  â”Š71â”Š\n+â”Š  â”Š72â”Š  const handleRemoveChat = useCallback(() => {\n+â”Š  â”Š73â”Š    removeChat().then(() => {\n+â”Š  â”Š74â”Š      history.replace('/chats');\n+â”Š  â”Š75â”Š    });\n+â”Š  â”Š76â”Š  }, [removeChat, history]);\n+â”Š  â”Š77â”Š\n â”Š46â”Š78â”Š  const navBack = useCallback(() => {\n â”Š47â”Š79â”Š    history.replace('/chats');\n â”Š48â”Š80â”Š  }, [history]);\n```\n```diff\n@@ -58,6 +90,11 @@\n â”Š 58â”Š 90â”Š          <Name data-testid=\"chat-name\">{chat.name}</Name>\n â”Š 59â”Š 91â”Š        </React.Fragment>\n â”Š 60â”Š 92â”Š      )}\n+â”Š   â”Š 93â”Š      <Rest>\n+â”Š   â”Š 94â”Š        <DeleteButton data-testid=\"delete-button\" onClick={handleRemoveChat}>\n+â”Š   â”Š 95â”Š          <DeleteIcon />\n+â”Š   â”Š 96â”Š        </DeleteButton>\n+â”Š   â”Š 97â”Š      </Rest>\n â”Š 61â”Š 98â”Š    </Container>\n â”Š 62â”Š 99â”Š  );\n â”Š 63â”Š100â”Š};\n```\n\n[}]: #\n\nNormally this is a dangerous behavior because we wipe out the entire history without any warnings, which is not recommended. For tutoring purposes only we will keep it the way it is, because it makes things simple and easier to understand.\n\nTo be able to update the chats list cache, we will implement a `chatRemoved` subscription. The subscription will be broadcasted only to those whoâ€™re participants of the published chat:\n\n[{]: <helper> (diffStep 9.5 module=\"server\")\n\n#### [__Server__ Step 9.5: Add Subscription.chatRemoved](https://github.com/Urigo/WhatsApp-Clone-Server/commit/bebbeab7a7830928616641ebf84ac94f6fb2e317)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -153,7 +153,7 @@\n â”Š153â”Š153â”Š      return chat;\n â”Š154â”Š154â”Š    },\n â”Š155â”Š155â”Š\n-â”Š156â”Š   â”Š    removeChat(root, { chatId }, { currentUser }) {\n+â”Š   â”Š156â”Š    removeChat(root, { chatId }, { currentUser, pubsub }) {\n â”Š157â”Š157â”Š      if (!currentUser) return null;\n â”Š158â”Š158â”Š\n â”Š159â”Š159â”Š      const chatIndex = chats.findIndex(c => c.id === chatId);\n```\n```diff\n@@ -174,6 +174,11 @@\n â”Š174â”Š174â”Š\n â”Š175â”Š175â”Š      chats.splice(chatIndex, 1);\n â”Š176â”Š176â”Š\n+â”Š   â”Š177â”Š      pubsub.publish('chatRemoved', {\n+â”Š   â”Š178â”Š        chatRemoved: chat.id,\n+â”Š   â”Š179â”Š        targetChat: chat,\n+â”Š   â”Š180â”Š      });\n+â”Š   â”Š181â”Š\n â”Š177â”Š182â”Š      return chatId;\n â”Š178â”Š183â”Š    },\n â”Š179â”Š184â”Š  },\n```\n```diff\n@@ -202,6 +207,17 @@\n â”Š202â”Š207â”Š        }\n â”Š203â”Š208â”Š      ),\n â”Š204â”Š209â”Š    },\n+â”Š   â”Š210â”Š\n+â”Š   â”Š211â”Š    chatRemoved: {\n+â”Š   â”Š212â”Š      subscribe: withFilter(\n+â”Š   â”Š213â”Š        (root, args, { pubsub }) => pubsub.asyncIterator('chatRemoved'),\n+â”Š   â”Š214â”Š        ({ targetChat }: { targetChat: Chat }, args, { currentUser }) => {\n+â”Š   â”Š215â”Š          if (!currentUser) return false;\n+â”Š   â”Š216â”Š\n+â”Š   â”Š217â”Š          return targetChat.participants.some(p => p === currentUser.id);\n+â”Š   â”Š218â”Š        }\n+â”Š   â”Š219â”Š      ),\n+â”Š   â”Š220â”Š    },\n â”Š205â”Š221â”Š  },\n â”Š206â”Š222â”Š};\n â”Š207â”Š223â”Š\n```\n\n##### Changed schema&#x2F;typeDefs.graphql\n```diff\n@@ -40,4 +40,5 @@\n â”Š40â”Š40â”Štype Subscription {\n â”Š41â”Š41â”Š  messageAdded: Message!\n â”Š42â”Š42â”Š  chatAdded: Chat!\n+â”Š  â”Š43â”Š  chatRemoved: ID!\n â”Š43â”Š44â”Š}\n```\n\n[}]: #\n\nIn the client, we will define the right subscription document:\n\n[{]: <helper> (diffStep 12.5 files=\"graphql/subscriptions\" module=\"client\")\n\n#### [__Client__ Step 12.5: Update cache on chat removal](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/5ddbaac06696a7d8ca78223cf5f9a0f527e71608)\n\n##### Added src&#x2F;graphql&#x2F;subscriptions&#x2F;chatRemoved.subscription.ts\n```diff\n@@ -0,0 +1,7 @@\n+â”Š â”Š1â”Šimport gql from 'graphql-tag';\n+â”Š â”Š2â”Š\n+â”Š â”Š3â”Šexport default gql`\n+â”Š â”Š4â”Š  subscription ChatRemoved {\n+â”Š â”Š5â”Š    chatRemoved\n+â”Š â”Š6â”Š  }\n+â”Š â”Š7â”Š`;\n```\n\n##### Changed src&#x2F;graphql&#x2F;subscriptions&#x2F;index.ts\n```diff\n@@ -1,2 +1,3 @@\n â”Š1â”Š1â”Šexport { default as messageAdded } from './messageAdded.subscription';\n â”Š2â”Š2â”Šexport { default as chatAdded } from './chatAdded.subscription';\n+â”Š â”Š3â”Šexport { default as chatRemoved } from './chatRemoved.subscription';\n```\n\n[}]: #\n\nAnd we will update the `cache.service` to listen to the new subscription and update the `chats` query accordingly. When we deal with the fragment, we remove the `FullChat` fragment because it consists of the `Chat` fragment. If it was the other way around, we would still have some data leftovers from the `FullChat` on the fragment, because of how Apollo-Cache manages the store:\n\n[{]: <helper> (diffStep 12.5 files=\"cache.service\" module=\"client\")\n\n#### [__Client__ Step 12.5: Update cache on chat removal](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/5ddbaac06696a7d8ca78223cf5f9a0f527e71608)\n\n##### Changed src&#x2F;services&#x2F;cache.service.ts\n```diff\n@@ -8,6 +8,7 @@\n â”Š 8â”Š 8â”Š  ChatFragment,\n â”Š 9â”Š 9â”Š  useMessageAddedSubscription,\n â”Š10â”Š10â”Š  useChatAddedSubscription,\n+â”Š  â”Š11â”Š  useChatRemovedSubscription,\n â”Š11â”Š12â”Š} from '../graphql/types';\n â”Š12â”Š13â”Š\n â”Š13â”Š14â”Štype Client = ApolloClient<any> | DataProxy;\n```\n```diff\n@@ -28,6 +29,14 @@\n â”Š28â”Š29â”Š      }\n â”Š29â”Š30â”Š    },\n â”Š30â”Š31â”Š  });\n+â”Š  â”Š32â”Š\n+â”Š  â”Š33â”Š  useChatRemovedSubscription({\n+â”Š  â”Š34â”Š    onSubscriptionData: ({ client, subscriptionData: { data } }) => {\n+â”Š  â”Š35â”Š      if (data) {\n+â”Š  â”Š36â”Š        eraseChat(client, data.chatRemoved);\n+â”Š  â”Š37â”Š      }\n+â”Š  â”Š38â”Š    },\n+â”Š  â”Š39â”Š  });\n â”Š31â”Š40â”Š};\n â”Š32â”Š41â”Š\n â”Š33â”Š42â”Šexport const writeMessage = (client: Client, message: MessageFragment) => {\n```\n```diff\n@@ -134,3 +143,49 @@\n â”Š134â”Š143â”Š    data: { chats },\n â”Š135â”Š144â”Š  });\n â”Š136â”Š145â”Š};\n+â”Š   â”Š146â”Š\n+â”Š   â”Š147â”Šexport const eraseChat = (client: Client, chatId: string) => {\n+â”Š   â”Š148â”Š  const chatType = {\n+â”Š   â”Š149â”Š    __typename: 'Chat',\n+â”Š   â”Š150â”Š    id: chatId,\n+â”Š   â”Š151â”Š  };\n+â”Š   â”Š152â”Š\n+â”Š   â”Š153â”Š  const chatIdFromObject = defaultDataIdFromObject(chatType);\n+â”Š   â”Š154â”Š  if (chatIdFromObject === null) {\n+â”Š   â”Š155â”Š    return;\n+â”Š   â”Š156â”Š  }\n+â”Š   â”Š157â”Š\n+â”Š   â”Š158â”Š  client.writeFragment({\n+â”Š   â”Š159â”Š    id: chatIdFromObject,\n+â”Š   â”Š160â”Š    fragment: fragments.fullChat,\n+â”Š   â”Š161â”Š    fragmentName: 'FullChat',\n+â”Š   â”Š162â”Š    data: null,\n+â”Š   â”Š163â”Š  });\n+â”Š   â”Š164â”Š\n+â”Š   â”Š165â”Š  let data;\n+â”Š   â”Š166â”Š  try {\n+â”Š   â”Š167â”Š    data = client.readQuery({\n+â”Š   â”Š168â”Š      query: queries.chats,\n+â”Š   â”Š169â”Š    });\n+â”Š   â”Š170â”Š  } catch (e) {\n+â”Š   â”Š171â”Š    return;\n+â”Š   â”Š172â”Š  }\n+â”Š   â”Š173â”Š\n+â”Š   â”Š174â”Š  if (!data || !data.chats) return;\n+â”Š   â”Š175â”Š\n+â”Š   â”Š176â”Š  const chats = data.chats;\n+â”Š   â”Š177â”Š\n+â”Š   â”Š178â”Š  if (!chats) return;\n+â”Š   â”Š179â”Š\n+â”Š   â”Š180â”Š  const chatIndex = chats.findIndex((c: any) => c.id === chatId);\n+â”Š   â”Š181â”Š\n+â”Š   â”Š182â”Š  if (chatIndex === -1) return;\n+â”Š   â”Š183â”Š\n+â”Š   â”Š184â”Š  // The chat will appear at the top of the ChatsList component\n+â”Š   â”Š185â”Š  chats.splice(chatIndex, 1);\n+â”Š   â”Š186â”Š\n+â”Š   â”Š187â”Š  client.writeQuery({\n+â”Š   â”Š188â”Š    query: queries.chats,\n+â”Š   â”Š189â”Š    data: { chats: chats },\n+â”Š   â”Š190â”Š  });\n+â”Š   â”Š191â”Š};\n```\n\n[}]: #\n\nWe will also update the `ChatRoomScreen` to redirect us to the `/chats` route if the chat was not found.\n\nThe render method of the component will be re-triggered automatically by `@apollo/react-hooks` if the cached result of `useGetChat()` hook has changed,\nwhich means that even if you didnâ€™t actively remove the chat, you will still be redirected as a result:\n\n[{]: <helper> (diffStep 12.5 files=\"ChatRoom\" module=\"client\")\n\n#### [__Client__ Step 12.5: Update cache on chat removal](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/5ddbaac06696a7d8ca78223cf5f9a0f527e71608)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;ChatNavbar.tsx\n```diff\n@@ -8,6 +8,7 @@\n â”Š 8â”Š 8â”Šimport styled from 'styled-components';\n â”Š 9â”Š 9â”Šimport { History } from 'history';\n â”Š10â”Š10â”Šimport { useRemoveChatMutation } from '../../graphql/types';\n+â”Š  â”Š11â”Šimport { eraseChat } from '../../services/cache.service';\n â”Š11â”Š12â”Š\n â”Š12â”Š13â”Šconst Container = styled(Toolbar)`\n â”Š13â”Š14â”Š  padding: 0;\n```\n```diff\n@@ -67,6 +68,9 @@\n â”Š67â”Š68â”Š    variables: {\n â”Š68â”Š69â”Š      chatId: chat.id,\n â”Š69â”Š70â”Š    },\n+â”Š  â”Š71â”Š    update: (client, { data: { removeChat } }) => {\n+â”Š  â”Š72â”Š      eraseChat(client, removeChat);\n+â”Š  â”Š73â”Š    },\n â”Š70â”Š74â”Š  });\n â”Š71â”Š75â”Š\n â”Š72â”Š76â”Š  const handleRemoveChat = useCallback(() => {\n```\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -1,6 +1,7 @@\n â”Š1â”Š1â”Šimport gql from 'graphql-tag';\n â”Š2â”Š2â”Šimport React from 'react';\n â”Š3â”Š3â”Šimport { useCallback } from 'react';\n+â”Š â”Š4â”Šimport { Redirect } from 'react-router-dom';\n â”Š4â”Š5â”Šimport styled from 'styled-components';\n â”Š5â”Š6â”Šimport ChatNavbar from './ChatNavbar';\n â”Š6â”Š7â”Šimport MessageInput from './MessageInput';\n```\n```diff\n@@ -95,6 +96,11 @@\n â”Š 95â”Š 96â”Š  if (loadingChat) return null;\n â”Š 96â”Š 97â”Š  if (chat === null) return null;\n â”Š 97â”Š 98â”Š\n+â”Š   â”Š 99â”Š  // Chat was probably removed from cache by the subscription handler\n+â”Š   â”Š100â”Š  if (!chat) {\n+â”Š   â”Š101â”Š    return <Redirect to=\"/chats\" />;\n+â”Š   â”Š102â”Š  }\n+â”Š   â”Š103â”Š\n â”Š 98â”Š104â”Š  return (\n â”Š 99â”Š105â”Š    <Container>\n â”Š100â”Š106â”Š      <ChatNavbar chat={chat} history={history} />\n```\n\n[}]: #\n\nTODO: maybe mention that ApolloCache doesnâ€™t have Garbage Collector so even though the object is removed, everything else related to it says in cache."
          },
          {
            "manualTitle": "Step 13: Authentication",
            "stepRevision": "4d17a483cc2cc22f40e80e6d0257329314af6025",
            "manualView": "In the previous step weâ€™ve set the ground for the authentication system in our app. We have a users collection which can be used to distinguish which data the client is authorized to view, and we have a context handler which can retrieve the current user logged in based on the received value of the `cookie` header. Itâ€™s definitely a good starting point, but it misses a lot of things.\n\nIn this chapter we will implement a cookie-based authentication system. There are many ways to implement an authentication system in an app, but cookie-based authentication is one of the most popular ones, hence we will go with that method. Essentially the authentication flow in our app should look very simple: a user will be able to sign-in with a dedicated screen, and if he doesnâ€™t own an account he can use the sign-up screen to create a new one. The more complicated part in this flow is the back-end, which is the core of this chapter. So before we get into the implementation, we need to understand the authentication process:\n\n- A user logs in with a username and a password.\nThe server compares the received username and password to the ones stored in the database.\n- If the comparison was successful, the server will generate a token and will set it as a cookie.\n- Each time a request is sent, the server will retrieve the username from the stored token on the cookie header and will send data back accordingly.\n\n![auth-flow](https://user-images.githubusercontent.com/7648874/55929679-55e94200-5c50-11e9-9fe7-54ad6194a572.png)\n\nThe stored token will save us the hassle of re-specifying the username and password over and over again each and every request. Itâ€™s important to note that everything in the authentication process is encrypted, **sensitive information will never be stored or sent in its raw form**, otherwise data might be stolen in case of a DB breach or a request hijacking. This is what it means for our app:\n\n- Passwords will always be stored in an encrypted form in the DB using an algorithm called [Bcrypt](https://en.wikipedia.org/wiki/Bcrypt). Bcrypt has the ability to compare the password in its raw form to the encrypted one, which can help us authorize the user.\n\n- Tokens are self contained. That means that once we decode the encrypted string we can get a hold of the username string. This form of encrypted tokens is called [Json Web Token (JWT)](https://jwt.io/).\n\n> We're not going to elaborate about the algorithm behind each encryption method because we want to focus more on practicality, although it's very much recommended to understand how each method works before proceeding.\n\nThe implementation will follow the principles above. Authentication is a hot topic in the GraphQL world and there are several ways of doing so. We will start with the back-end and set the infrastructure for authentication, and then we will move on to the front-end.\n\nWeâ€™re gonna expose 2 new mutations from GraphQL Schema: `signIn` and `signUp`. `/sign-out` is unnecessary because it can be done locally by deleting the right cookie. Our back-end is gonna grow bigger so first we will separate the Express app from the Apollo Server instance, and extract the env vars to a dedicated module:\n\n[{]: <helper> (diffStep 10.1 module=\"server\")\n\n#### [__Server__ Step 10.1: Separate app into a different module](https://github.com/Urigo/WhatsApp-Clone-Server/commit/9b546e6b0b65bc9bf25e8bcc5cb6c15a0ef57c00)\n\n##### Added app.ts\n```diff\n@@ -0,0 +1,14 @@\n+â”Š  â”Š 1â”Šimport cors from 'cors';\n+â”Š  â”Š 2â”Šimport cookieParser from 'cookie-parser';\n+â”Š  â”Š 3â”Šimport express from 'express';\n+â”Š  â”Š 4â”Šimport { origin } from './env';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šexport const app = express();\n+â”Š  â”Š 7â”Š\n+â”Š  â”Š 8â”Šapp.use(cors({ credentials: true, origin }));\n+â”Š  â”Š 9â”Šapp.use(express.json());\n+â”Š  â”Š10â”Šapp.use(cookieParser());\n+â”Š  â”Š11â”Š\n+â”Š  â”Š12â”Šapp.get('/_ping', (req, res) => {\n+â”Š  â”Š13â”Š  res.send('pong');\n+â”Š  â”Š14â”Š});\n```\n\n##### Added env.ts\n```diff\n@@ -0,0 +1,2 @@\n+â”Š â”Š1â”Šexport const origin = process.env.ORIGIN || 'http://localhost:3000';\n+â”Š â”Š2â”Šexport const port = process.env.PORT || 4000;\n```\n\n##### Changed index.ts\n```diff\n@@ -1,23 +1,11 @@\n â”Š 1â”Š 1â”Šimport { ApolloServer, gql, PubSub } from 'apollo-server-express';\n-â”Š 2â”Š  â”Šimport cors from 'cors';\n-â”Š 3â”Š  â”Šimport cookieParser from 'cookie-parser';\n â”Š 4â”Š 2â”Šimport cookie from 'cookie';\n-â”Š 5â”Š  â”Šimport express from 'express';\n â”Š 6â”Š 3â”Šimport http from 'http';\n+â”Š  â”Š 4â”Šimport { app } from './app';\n â”Š 7â”Š 5â”Šimport { users } from './db';\n+â”Š  â”Š 6â”Šimport { origin, port } from './env';\n â”Š 8â”Š 7â”Šimport schema from './schema';\n â”Š 9â”Š 8â”Š\n-â”Š10â”Š  â”Šconst app = express();\n-â”Š11â”Š  â”Š\n-â”Š12â”Š  â”Šconst origin = process.env.ORIGIN || 'http://localhost:3000';\n-â”Š13â”Š  â”Šapp.use(cors({ credentials: true, origin }));\n-â”Š14â”Š  â”Šapp.use(express.json());\n-â”Š15â”Š  â”Šapp.use(cookieParser());\n-â”Š16â”Š  â”Š\n-â”Š17â”Š  â”Šapp.get('/_ping', (req, res) => {\n-â”Š18â”Š  â”Š  res.send('pong');\n-â”Š19â”Š  â”Š});\n-â”Š20â”Š  â”Š\n â”Š21â”Š 9â”Šconst pubsub = new PubSub();\n â”Š22â”Š10â”Šconst server = new ApolloServer({\n â”Š23â”Š11â”Š  schema,\n```\n```diff\n@@ -56,8 +44,6 @@\n â”Š56â”Š44â”Šconst httpServer = http.createServer(app);\n â”Š57â”Š45â”Šserver.installSubscriptionHandlers(httpServer);\n â”Š58â”Š46â”Š\n-â”Š59â”Š  â”Šconst port = process.env.PORT || 4000;\n-â”Š60â”Š  â”Š\n â”Š61â”Š47â”ŠhttpServer.listen(port, () => {\n â”Š62â”Š48â”Š  console.log(`Server is listening on port ${port}`);\n â”Š63â”Š49â”Š});\n```\n\n[}]: #\n\nWe will first start with the `signIn` mutation, so we can test it against pre-defined user credentials, and then we will proceed to implementing the `signUp` mutation. It would be a lot easier to progress this way. For that we will install a couple of packages:\n\n- `bcrypt` - which is responsible for running a one-way encryption against received passwords before theyâ€™re stored in the DB.\n- `jsonwebtoken` - responsible for encrypting the logged-in username before itâ€™s set as a cooky and decrypting it once itâ€™s sent back with a request.\n\n    $ yarn add bcrypt jsonwebtoken\n\n\n    $ yarn add --dev @types/bcrypt @types/jsonwebtoken\n\nAnd we will implement the `signIn` mutation:\n\n[{]: <helper> (diffStep 10.2 module=\"server\")\n\n#### [__Server__ Step 10.2: Add signIn mutation](https://github.com/Urigo/WhatsApp-Clone-Server/commit/f98ed57a45730114149cf14989eb516116f2545a)\n\n##### Changed context.ts\n```diff\n@@ -1,7 +1,9 @@\n â”Š1â”Š1â”Šimport { PubSub } from 'apollo-server-express';\n â”Š2â”Š2â”Šimport { User } from './db';\n+â”Š â”Š3â”Šimport { Response } from 'express';\n â”Š3â”Š4â”Š\n â”Š4â”Š5â”Šexport type MyContext = {\n â”Š5â”Š6â”Š  pubsub: PubSub;\n â”Š6â”Š7â”Š  currentUser: User;\n+â”Š â”Š8â”Š  res: Response;\n â”Š7â”Š9â”Š};\n```\n\n##### Changed env.ts\n```diff\n@@ -1,2 +1,6 @@\n+â”Š â”Š1â”Šexport const expiration = process.env.JWT_EXPIRATION_MS\n+â”Š â”Š2â”Š  ? parseInt(process.env.JWT_EXPIRATION_MS)\n+â”Š â”Š3â”Š  : 24 * 60 * 60 * 1000;\n+â”Š â”Š4â”Šexport const secret = process.env.JWT_SECRET || '70p53cr37';\n â”Š1â”Š5â”Šexport const origin = process.env.ORIGIN || 'http://localhost:3000';\n â”Š2â”Š6â”Šexport const port = process.env.PORT || 4000;\n```\n\n##### Changed index.ts\n```diff\n@@ -23,6 +23,7 @@\n â”Š23â”Š23â”Š    return {\n â”Š24â”Š24â”Š      currentUser: users.find(u => u.id === req.cookies.currentUserId),\n â”Š25â”Š25â”Š      pubsub,\n+â”Š  â”Š26â”Š      res: session.res,\n â”Š26â”Š27â”Š    };\n â”Š27â”Š28â”Š  },\n â”Š28â”Š29â”Š  subscriptions: {\n```\n\n##### Changed package.json\n```diff\n@@ -20,6 +20,7 @@\n â”Š20â”Š20â”Š    \"@graphql-codegen/cli\": \"1.5.0\",\n â”Š21â”Š21â”Š    \"@graphql-codegen/typescript\": \"1.5.0\",\n â”Š22â”Š22â”Š    \"@graphql-codegen/typescript-resolvers\": \"1.5.0\",\n+â”Š  â”Š23â”Š    \"@types/bcrypt\": \"3.0.0\",\n â”Š23â”Š24â”Š    \"@types/cors\": \"2.8.5\",\n â”Š24â”Š25â”Š    \"@types/cookie\": \"0.3.3\",\n â”Š25â”Š26â”Š    \"@types/cookie-parser\": \"1.4.1\",\n```\n```diff\n@@ -27,6 +28,7 @@\n â”Š27â”Š28â”Š    \"@types/graphql\": \"14.2.3\",\n â”Š28â”Š29â”Š    \"@types/graphql-iso-date\": \"3.3.1\",\n â”Š29â”Š30â”Š    \"@types/jest\": \"24.0.17\",\n+â”Š  â”Š31â”Š    \"@types/jsonwebtoken\": \"8.3.3\",\n â”Š30â”Š32â”Š    \"@types/node\": \"12.7.1\",\n â”Š31â”Š33â”Š    \"jest\": \"24.8.0\",\n â”Š32â”Š34â”Š    \"jest-junit\": \"7.0.0\",\n```\n```diff\n@@ -38,6 +40,7 @@\n â”Š38â”Š40â”Š  \"dependencies\": {\n â”Š39â”Š41â”Š    \"apollo-server-express\": \"2.8.1\",\n â”Š40â”Š42â”Š    \"apollo-server-testing\": \"2.8.1\",\n+â”Š  â”Š43â”Š    \"bcrypt\": \"3.0.6\",\n â”Š41â”Š44â”Š    \"cookie\": \"0.4.0\",\n â”Š42â”Š45â”Š    \"cors\": \"2.8.5\",\n â”Š43â”Š46â”Š    \"cookie-parser\": \"1.4.4\",\n```\n```diff\n@@ -45,7 +48,8 @@\n â”Š45â”Š48â”Š    \"graphql\": \"14.4.2\",\n â”Š46â”Š49â”Š    \"graphql-import\": \"0.7.1\",\n â”Š47â”Š50â”Š    \"graphql-iso-date\": \"3.6.1\",\n-â”Š48â”Š  â”Š    \"graphql-tools\": \"4.0.5\"\n+â”Š  â”Š51â”Š    \"graphql-tools\": \"4.0.5\",\n+â”Š  â”Š52â”Š    \"jsonwebtoken\": \"8.5.1\"\n â”Š49â”Š53â”Š  },\n â”Š50â”Š54â”Š  \"jest\": {\n â”Š51â”Š55â”Š    \"transform\": {\n```\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -2,6 +2,9 @@\n â”Š 2â”Š 2â”Šimport { GraphQLDateTime } from 'graphql-iso-date';\n â”Š 3â”Š 3â”Šimport { User, Message, Chat, chats, messages, users } from '../db';\n â”Š 4â”Š 4â”Šimport { Resolvers } from '../types/graphql';\n+â”Š  â”Š 5â”Šimport { secret, expiration } from '../env';\n+â”Š  â”Š 6â”Šimport bcrypt from 'bcrypt';\n+â”Š  â”Š 7â”Šimport jwt from 'jsonwebtoken';\n â”Š 5â”Š 8â”Š\n â”Š 6â”Š 9â”Šconst resolvers: Resolvers = {\n â”Š 7â”Š10â”Š  Date: GraphQLDateTime,\n```\n```diff\n@@ -91,6 +94,26 @@\n â”Š 91â”Š 94â”Š  },\n â”Š 92â”Š 95â”Š\n â”Š 93â”Š 96â”Š  Mutation: {\n+â”Š   â”Š 97â”Š    signIn(root, { username, password }, { res }) {\n+â”Š   â”Š 98â”Š      const user = users.find(u => u.username === username);\n+â”Š   â”Š 99â”Š\n+â”Š   â”Š100â”Š      if (!user) {\n+â”Š   â”Š101â”Š        throw new Error('user not found');\n+â”Š   â”Š102â”Š      }\n+â”Š   â”Š103â”Š\n+â”Š   â”Š104â”Š      const passwordsMatch = bcrypt.compareSync(password, user.password);\n+â”Š   â”Š105â”Š\n+â”Š   â”Š106â”Š      if (!passwordsMatch) {\n+â”Š   â”Š107â”Š        throw new Error('password is incorrect');\n+â”Š   â”Š108â”Š      }\n+â”Š   â”Š109â”Š\n+â”Š   â”Š110â”Š      const authToken = jwt.sign(username, secret);\n+â”Š   â”Š111â”Š\n+â”Š   â”Š112â”Š      res.cookie('authToken', authToken, { maxAge: expiration });\n+â”Š   â”Š113â”Š\n+â”Š   â”Š114â”Š      return user;\n+â”Š   â”Š115â”Š    },\n+â”Š   â”Š116â”Š\n â”Š 94â”Š117â”Š    addMessage(root, { chatId, content }, { currentUser, pubsub }) {\n â”Š 95â”Š118â”Š      if (!currentUser) return null;\n â”Š 96â”Š119â”Š\n```\n\n##### Changed schema&#x2F;typeDefs.graphql\n```diff\n@@ -32,6 +32,7 @@\n â”Š32â”Š32â”Š}\n â”Š33â”Š33â”Š\n â”Š34â”Š34â”Štype Mutation {\n+â”Š  â”Š35â”Š  signIn(username: String!, password: String!): User\n â”Š35â”Š36â”Š  addMessage(chatId: ID!, content: String!): Message\n â”Š36â”Š37â”Š  addChat(recipientId: ID!): Chat\n â”Š37â”Š38â”Š  removeChat(chatId: ID!): ID\n```\n\n[}]: #\n\nAs you can see we use a special secret before we encrypt the username with JWT. The same secret will be used later on to decrypt the token back into username when getting requests. If someone malicious will get a hold of that password, he can fabricate an authentication token for every user that he wants, **thus itâ€™s important to choose a strong secret**.\n\nWhen building the context for our GraphQL resolvers, we will decode the received cookie with JWT using the same secret to determine the username who made the request. Once we have that username, we can simply retrieve the original user from the DB and define it on the context:\n\n[{]: <helper> (diffStep 10.3 module=\"server\")\n\n#### [__Server__ Step 10.3: Get current user from auth token](https://github.com/Urigo/WhatsApp-Clone-Server/commit/da613d30ed4a469b1d084d9b979ac78a68472b6a)\n\n##### Changed index.ts\n```diff\n@@ -1,9 +1,10 @@\n â”Š 1â”Š 1â”Šimport { ApolloServer, gql, PubSub } from 'apollo-server-express';\n â”Š 2â”Š 2â”Šimport cookie from 'cookie';\n â”Š 3â”Š 3â”Šimport http from 'http';\n+â”Š  â”Š 4â”Šimport jwt from 'jsonwebtoken';\n â”Š 4â”Š 5â”Šimport { app } from './app';\n â”Š 5â”Š 6â”Šimport { users } from './db';\n-â”Š 6â”Š  â”Šimport { origin, port } from './env';\n+â”Š  â”Š 7â”Šimport { origin, port, secret } from './env';\n â”Š 7â”Š 8â”Šimport schema from './schema';\n â”Š 8â”Š 9â”Š\n â”Š 9â”Š10â”Šconst pubsub = new PubSub();\n```\n```diff\n@@ -20,8 +21,14 @@\n â”Š20â”Š21â”Š      req.cookies = cookie.parse(req.headers.cookie || '');\n â”Š21â”Š22â”Š    }\n â”Š22â”Š23â”Š\n+â”Š  â”Š24â”Š    let currentUser;\n+â”Š  â”Š25â”Š    if (req.cookies.authToken) {\n+â”Š  â”Š26â”Š      const username = jwt.verify(req.cookies.authToken, secret) as string;\n+â”Š  â”Š27â”Š      currentUser = username && users.find(u => u.username === username);\n+â”Š  â”Š28â”Š    }\n+â”Š  â”Š29â”Š\n â”Š23â”Š30â”Š    return {\n-â”Š24â”Š  â”Š      currentUser: users.find(u => u.id === req.cookies.currentUserId),\n+â”Š  â”Š31â”Š      currentUser,\n â”Š25â”Š32â”Š      pubsub,\n â”Š26â”Š33â”Š      res: session.res,\n â”Š27â”Š34â”Š    };\n```\n\n[}]: #\n\nYou might have noticed that the User schema has been updated, because we try to address the `user.username` property. The authentication in our app will be done with a username and a password; accordingly, we will update our User type definitions and the user documents in the users collection mock. The credentials that weâ€™re going to store can actually be used to sign-in to our app:\n\n[{]: <helper> (diffStep 10.4 module=\"server\")\n\n#### [__Server__ Step 10.4: Update user schema to contain credentials](https://github.com/Urigo/WhatsApp-Clone-Server/commit/1dce817ea95dffa5ebd0e80edf0670e33dcf5ca7)\n\n##### Changed db.ts\n```diff\n@@ -1,6 +1,8 @@\n â”Š1â”Š1â”Šexport type User = {\n â”Š2â”Š2â”Š  id: string;\n â”Š3â”Š3â”Š  name: string;\n+â”Š â”Š4â”Š  username: string;\n+â”Š â”Š5â”Š  password: string;\n â”Š4â”Š6â”Š  picture: string;\n â”Š5â”Š7â”Š};\n â”Š6â”Š8â”Š\n```\n```diff\n@@ -30,26 +32,41 @@\n â”Š30â”Š32â”Š      {\n â”Š31â”Š33â”Š        id: '1',\n â”Š32â”Š34â”Š        name: 'Ray Edwards',\n+â”Š  â”Š35â”Š        username: 'ray',\n+â”Š  â”Š36â”Š        password:\n+â”Š  â”Š37â”Š          '$2a$08$NO9tkFLCoSqX1c5wk3s7z.JfxaVMKA.m7zUDdDwEquo4rvzimQeJm', // 111\n â”Š33â”Š38â”Š        picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n â”Š34â”Š39â”Š      },\n â”Š35â”Š40â”Š      {\n â”Š36â”Š41â”Š        id: '2',\n â”Š37â”Š42â”Š        name: 'Ethan Gonzalez',\n+â”Š  â”Š43â”Š        username: 'ethan',\n+â”Š  â”Š44â”Š        password:\n+â”Š  â”Š45â”Š          '$2a$08$xE4FuCi/ifxjL2S8CzKAmuKLwv18ktksSN.F3XYEnpmcKtpbpeZgO', // 222\n â”Š38â”Š46â”Š        picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n â”Š39â”Š47â”Š      },\n â”Š40â”Š48â”Š      {\n â”Š41â”Š49â”Š        id: '3',\n â”Š42â”Š50â”Š        name: 'Bryan Wallace',\n+â”Š  â”Š51â”Š        username: 'bryan',\n+â”Š  â”Š52â”Š        password:\n+â”Š  â”Š53â”Š          '$2a$08$UHgH7J8G6z1mGQn2qx2kdeWv0jvgHItyAsL9hpEUI3KJmhVW5Q1d.', // 333\n â”Š43â”Š54â”Š        picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n â”Š44â”Š55â”Š      },\n â”Š45â”Š56â”Š      {\n â”Š46â”Š57â”Š        id: '4',\n â”Š47â”Š58â”Š        name: 'Avery Stewart',\n+â”Š  â”Š59â”Š        username: 'avery',\n+â”Š  â”Š60â”Š        password:\n+â”Š  â”Š61â”Š          '$2a$08$wR1k5Q3T9FC7fUgB7Gdb9Os/GV7dGBBf4PLlWT7HERMFhmFDt47xi', // 444\n â”Š48â”Š62â”Š        picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n â”Š49â”Š63â”Š      },\n â”Š50â”Š64â”Š      {\n â”Š51â”Š65â”Š        id: '5',\n â”Š52â”Š66â”Š        name: 'Katie Peterson',\n+â”Š  â”Š67â”Š        username: 'katie',\n+â”Š  â”Š68â”Š        password:\n+â”Š  â”Š69â”Š          '$2a$08$6.mbXqsDX82ZZ7q5d8Osb..JrGSsNp4R3IKj7mxgF6YGT0OmMw242', // 555\n â”Š53â”Š70â”Š        picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n â”Š54â”Š71â”Š      },\n â”Š55â”Š72â”Š    ]\n```\n\n[}]: #\n\nTo test it out, we will run our front-end application and open the dev-console. Using the Apollo Client we will send a request to the `signIn` mutation. We can use the credentials of one of the users stored in the DB. As for now all our restricted routes are observing the `currentUserId` cookie. This is wrong and no longer relevant. Letâ€™s change the `withAuth()` method to observe the `authToken` cookie so we can test our new mutation successfully:\n\n[{]: <helper> (diffStep 13.1 module=\"client\")\n\n#### [__Client__ Step 13.1: Use authToken cookie](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/4073e345548b20cc6747cde618afee5f86169e69)\n\n##### Changed src&#x2F;services&#x2F;auth.service.tsx\n```diff\n@@ -22,8 +22,8 @@\n â”Š22â”Š22â”Š  };\n â”Š23â”Š23â”Š};\n â”Š24â”Š24â”Š\n-â”Š25â”Š  â”Šexport const signIn = (currentUserId: string) => {\n-â”Š26â”Š  â”Š  document.cookie = `currentUserId=${currentUserId}`;\n+â”Š  â”Š25â”Šexport const signIn = (authToken: string) => {\n+â”Š  â”Š26â”Š  document.cookie = `authToken=${authToken}`;\n â”Š27â”Š27â”Š\n â”Š28â”Š28â”Š  // This will become async in the near future\n â”Š29â”Š29â”Š  return Promise.resolve();\n```\n```diff\n@@ -35,7 +35,7 @@\n â”Š35â”Š35â”Š  return useCallback(() => {\n â”Š36â”Š36â”Š    // \"expires\" represents the lifespan of a cookie. Beyond that date the cookie will\n â”Š37â”Š37â”Š    // be deleted by the browser. \"expires\" cannot be viewed from \"document.cookie\"\n-â”Š38â”Š  â”Š    document.cookie = `currentUserId=;expires=${new Date(0)}`;\n+â”Š  â”Š38â”Š    document.cookie = `authToken=;expires=${new Date(0)}`;\n â”Š39â”Š39â”Š\n â”Š40â”Š40â”Š    // Clear cache\n â”Š41â”Š41â”Š    return client.clearStore();\n```\n```diff\n@@ -43,5 +43,5 @@\n â”Š43â”Š43â”Š};\n â”Š44â”Š44â”Š\n â”Š45â”Š45â”Šexport const isSignedIn = () => {\n-â”Š46â”Š  â”Š  return /currentUserId=.+(;|$)/.test(document.cookie);\n+â”Š  â”Š46â”Š  return /authToken=.+(;|$)/.test(document.cookie);\n â”Š47â”Š47â”Š};\n```\n\n[}]: #\n\nNow we can perform the signIn. It would be a good idea to signIn with the first user - `ray`, since all the DB mock is built around him:\n\n```js\nmutation signIn(username: 'ray', password: '111') {\n  id\n}\n```\n\nNow if we would look at the value of `document.cookie` we should see a key named `authToken` with a JWT token and the `ChatsListScreen` should show the chats which are relevant to `ray`. To complete the sign-in flow we would need to update the `AuthScreen` and the `auth.service` to use username and password and the actual `sign-in` mutation weâ€™ve just implemented.\n\nNow back to the `auth.service`, we will replace the `signIn()` method implementation with one that actually calls the `signIn` mutation in our API. We will start by defining the mutation:\n\n[{]: <helper> (diffStep 13.2 files=\"graphql/mutations\" module=\"client\")\n\n#### [__Client__ Step 13.2: Update auth service to call signIn mutation](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/fea20049d17ed9b68329bbeb6f8194facded1cc4)\n\n##### Added src&#x2F;graphql&#x2F;mutations&#x2F;index.ts\n```diff\n@@ -0,0 +1 @@\n+â”Š â”Š1â”Šexport { default as signIn } from './signIn.mutation'\n```\n\n##### Added src&#x2F;graphql&#x2F;mutations&#x2F;signIn.mutation.ts\n```diff\n@@ -0,0 +1,9 @@\n+â”Š â”Š1â”Šimport gql from 'graphql-tag'\n+â”Š â”Š2â”Š\n+â”Š â”Š3â”Šexport default gql`\n+â”Š â”Š4â”Š  mutation signIn($username: String!, $password: String!) {\n+â”Š â”Š5â”Š    signIn(username: $username, password: $password) {\n+â”Š â”Š6â”Š      id\n+â”Š â”Š7â”Š    }\n+â”Š â”Š8â”Š  }\n+â”Š â”Š9â”Š`\n```\n\n[}]: #\n\nUpdating `codegen.yml` to include the file we've just added in the generation process:\n\n[{]: <helper> (diffStep 13.2 files=\"codegen.yml\" module=\"client\")\n\n#### [__Client__ Step 13.2: Update auth service to call signIn mutation](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/fea20049d17ed9b68329bbeb6f8194facded1cc4)\n\n##### Changed codegen.yml\n```diff\n@@ -4,6 +4,7 @@\n â”Š 4â”Š 4â”Š  - ./src/graphql/fragments/**/*.ts\n â”Š 5â”Š 5â”Š  - ./src/graphql/queries/**/*.ts\n â”Š 6â”Š 6â”Š  - ./src/graphql/subscriptions/**/*.ts\n+â”Š  â”Š 7â”Š  - ./src/graphql/mutations/**/*.ts\n â”Š 7â”Š 8â”Šoverwrite: true\n â”Š 8â”Š 9â”Šgenerates:\n â”Š 9â”Š10â”Š  ./src/graphql/types.tsx:\n```\n\n[}]: #\n\nAnd finally, we will update the service to use the generated mutation method `useSignInMutation()`:\n\n[{]: <helper> (diffStep 13.2 files=\"auth.service.ts\" module=\"client\")\n\n#### [__Client__ Step 13.2: Update auth service to call signIn mutation](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/fea20049d17ed9b68329bbeb6f8194facded1cc4)\n\n##### Changed src&#x2F;services&#x2F;auth.service.tsx\n```diff\n@@ -2,6 +2,7 @@\n â”Š2â”Š2â”Šimport { useCallback } from 'react';\n â”Š3â”Š3â”Šimport { useApolloClient } from '@apollo/react-hooks';\n â”Š4â”Š4â”Šimport { Redirect } from 'react-router-dom';\n+â”Š â”Š5â”Šimport { useSignInMutation } from '../graphql/types';\n â”Š5â”Š6â”Šimport { useCacheService } from './cache.service';\n â”Š6â”Š7â”Š\n â”Š7â”Š8â”Šexport const withAuth = <P extends object>(\n```\n```diff\n@@ -22,12 +23,7 @@\n â”Š22â”Š23â”Š  };\n â”Š23â”Š24â”Š};\n â”Š24â”Š25â”Š\n-â”Š25â”Š  â”Šexport const signIn = (authToken: string) => {\n-â”Š26â”Š  â”Š  document.cookie = `authToken=${authToken}`;\n-â”Š27â”Š  â”Š\n-â”Š28â”Š  â”Š  // This will become async in the near future\n-â”Š29â”Š  â”Š  return Promise.resolve();\n-â”Š30â”Š  â”Š};\n+â”Š  â”Š26â”Šexport const useSignIn = useSignInMutation;\n â”Š31â”Š27â”Š\n â”Š32â”Š28â”Šexport const useSignOut = () => {\n â”Š33â”Š29â”Š  const client = useApolloClient()\n```\n\n[}]: #\n\nTo check if weâ€™re authorized to visit a route, not only we would need to check if we have the `authToken` cookie defined, but we would also need to validate it against the server to see that it actually references a real user. For that we will implement `Query.me` which will send us back the current user logged in directly from the context:\n\n[{]: <helper> (diffStep 10.5 module=\"server\")\n\n#### [__Server__ Step 10.5: Add Query.me](https://github.com/Urigo/WhatsApp-Clone-Server/commit/9aac1b062bc647eec28685954a0b95e65153f119)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -70,6 +70,10 @@\n â”Š70â”Š70â”Š  },\n â”Š71â”Š71â”Š\n â”Š72â”Š72â”Š  Query: {\n+â”Š  â”Š73â”Š    me(root, args, { currentUser }) {\n+â”Š  â”Š74â”Š      return currentUser || null;\n+â”Š  â”Š75â”Š    },\n+â”Š  â”Š76â”Š\n â”Š73â”Š77â”Š    chats(root, args, { currentUser }) {\n â”Š74â”Š78â”Š      if (!currentUser) return [];\n â”Š75â”Š79â”Š\n```\n\n##### Changed schema&#x2F;typeDefs.graphql\n```diff\n@@ -26,6 +26,7 @@\n â”Š26â”Š26â”Š}\n â”Š27â”Š27â”Š\n â”Š28â”Š28â”Štype Query {\n+â”Š  â”Š29â”Š  me: User\n â”Š29â”Š30â”Š  chats: [Chat!]!\n â”Š30â”Š31â”Š  chat(chatId: ID!): Chat\n â”Š31â”Š32â”Š  users: [User!]!\n```\n\n##### Added tests&#x2F;queries&#x2F;getMe.test.ts\n```diff\n@@ -0,0 +1,33 @@\n+â”Š  â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n+â”Š  â”Š 2â”Šimport { ApolloServer, gql } from 'apollo-server-express';\n+â”Š  â”Š 3â”Šimport schema from '../../schema';\n+â”Š  â”Š 4â”Šimport { users } from '../../db';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šdescribe('Query.me', () => {\n+â”Š  â”Š 7â”Š  it('should fetch current user', async () => {\n+â”Š  â”Š 8â”Š    const server = new ApolloServer({\n+â”Š  â”Š 9â”Š      schema,\n+â”Š  â”Š10â”Š      context: () => ({\n+â”Š  â”Š11â”Š        currentUser: users[0],\n+â”Š  â”Š12â”Š      }),\n+â”Š  â”Š13â”Š    });\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”Š    const { query } = createTestClient(server);\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š    const res = await query({\n+â”Š  â”Š18â”Š      query: gql`\n+â”Š  â”Š19â”Š        query GetMe {\n+â”Š  â”Š20â”Š          me {\n+â”Š  â”Š21â”Š            id\n+â”Š  â”Š22â”Š            name\n+â”Š  â”Š23â”Š            picture\n+â”Š  â”Š24â”Š          }\n+â”Š  â”Š25â”Š        }\n+â”Š  â”Š26â”Š      `,\n+â”Š  â”Š27â”Š    });\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š    expect(res.data).toBeDefined();\n+â”Š  â”Š30â”Š    expect(res.errors).toBeUndefined();\n+â”Š  â”Š31â”Š    expect(res.data).toMatchSnapshot();\n+â”Š  â”Š32â”Š  });\n+â”Š  â”Š33â”Š});\n```\n\n[}]: #\n\nNow will use the GraphQL query weâ€™ve just implemented to check if the user actually exists within the DB before we proceed to the restricted route:\n\n[{]: <helper> (diffStep 13.3 module=\"client\")\n\n#### [__Client__ Step 13.3: Validate auth token against the back-end on restricted route](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/b0dfe4ead731a61bae1afcea9955ebe20e13f213)\n\n##### Added src&#x2F;graphql&#x2F;queries&#x2F;me.query.ts\n```diff\n@@ -0,0 +1,11 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag';\n+â”Š  â”Š 2â”Šimport * as fragments from '../fragments';\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šexport default gql`\n+â”Š  â”Š 5â”Š  query Me {\n+â”Š  â”Š 6â”Š    me {\n+â”Š  â”Š 7â”Š      ...User\n+â”Š  â”Š 8â”Š    }\n+â”Š  â”Š 9â”Š  }\n+â”Š  â”Š10â”Š  ${fragments.user}\n+â”Š  â”Š11â”Š`;\n```\n\n##### Changed src&#x2F;services&#x2F;auth.service.tsx\n```diff\n@@ -1,10 +1,16 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n-â”Š 2â”Š  â”Šimport { useCallback } from 'react';\n+â”Š  â”Š 2â”Šimport { useContext, useCallback } from 'react';\n â”Š 3â”Š 3â”Šimport { useApolloClient } from '@apollo/react-hooks';\n â”Š 4â”Š 4â”Šimport { Redirect } from 'react-router-dom';\n-â”Š 5â”Š  â”Šimport { useSignInMutation } from '../graphql/types';\n+â”Š  â”Š 5â”Šimport { useMeQuery, User, useSignInMutation } from '../graphql/types';\n â”Š 6â”Š 6â”Šimport { useCacheService } from './cache.service';\n â”Š 7â”Š 7â”Š\n+â”Š  â”Š 8â”Šconst MyContext = React.createContext<User | null>(null);\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Šexport const useMe = () => {\n+â”Š  â”Š11â”Š  return useContext(MyContext);\n+â”Š  â”Š12â”Š};\n+â”Š  â”Š13â”Š\n â”Š 8â”Š14â”Šexport const withAuth = <P extends object>(\n â”Š 9â”Š15â”Š  Component: React.ComponentType<P>\n â”Š10â”Š16â”Š) => {\n```\n```diff\n@@ -17,9 +23,26 @@\n â”Š17â”Š23â”Š      return <Redirect to=\"/sign-in\" />;\n â”Š18â”Š24â”Š    }\n â”Š19â”Š25â”Š\n+â”Š  â”Š26â”Š    const signOut = useSignOut();\n+â”Š  â”Š27â”Š    const { data, error, loading } = useMeQuery();\n+â”Š  â”Š28â”Š\n â”Š20â”Š29â”Š    useCacheService();\n â”Š21â”Š30â”Š\n-â”Š22â”Š  â”Š    return <Component {...props as P} />;\n+â”Š  â”Š31â”Š    if (loading) return null;\n+â”Š  â”Š32â”Š\n+â”Š  â”Š33â”Š    if (data === undefined) return null;\n+â”Š  â”Š34â”Š\n+â”Š  â”Š35â”Š    if (error || !data.me) {\n+â”Š  â”Š36â”Š      signOut();\n+â”Š  â”Š37â”Š\n+â”Š  â”Š38â”Š      return <Redirect to=\"/sign-in\" />;\n+â”Š  â”Š39â”Š    }\n+â”Š  â”Š40â”Š\n+â”Š  â”Š41â”Š    return (\n+â”Š  â”Š42â”Š      <MyContext.Provider value={data.me}>\n+â”Š  â”Š43â”Š        <Component {...props as P} />\n+â”Š  â”Š44â”Š      </MyContext.Provider>\n+â”Š  â”Š45â”Š    );\n â”Š23â”Š46â”Š  };\n â”Š24â”Š47â”Š};\n```\n\n[}]: #\n\nwe will use the new query to try and fetch the user directly from the back-end, and we will only proceed if the user was actually found. In addition, we will replace the `signIn()` method to call `signIn` mutation:\n\n[{]: <helper> (diffStep 13.4 module=\"client\")\n\n#### [__Client__ Step 13.4: Add username and password to AuthScreen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/75fe7bad78cc660fb353c5f5a0849882507018c0)\n\n##### Changed src&#x2F;components&#x2F;AuthScreen&#x2F;index.tsx\n```diff\n@@ -3,7 +3,7 @@\n â”Š3â”Š3â”Šimport React from 'react';\n â”Š4â”Š4â”Šimport { useCallback, useState } from 'react';\n â”Š5â”Š5â”Šimport styled from 'styled-components';\n-â”Š6â”Š â”Šimport { signIn } from '../../services/auth.service';\n+â”Š â”Š6â”Šimport { useSignIn } from '../../services/auth.service';\n â”Š7â”Š7â”Šimport { RouteComponentProps } from 'react-router-dom';\n â”Š8â”Š8â”Š\n â”Š9â”Š9â”Šconst Container = styled.div`\n```\n```diff\n@@ -114,21 +114,35 @@\n â”Š114â”Š114â”Š`;\n â”Š115â”Š115â”Š\n â”Š116â”Š116â”Šconst AuthScreen: React.FC<RouteComponentProps<any>> = ({ history }) => {\n-â”Š117â”Š   â”Š  const [userId, setUserId] = useState('');\n+â”Š   â”Š117â”Š  const [username, setUsername] = useState('');\n+â”Š   â”Š118â”Š  const [password, setPassword] = useState('');\n+â”Š   â”Š119â”Š  // eslint-disable-next-line\n+â”Š   â”Š120â”Š  const [error, setError] = useState('');\n+â”Š   â”Š121â”Š  const [signIn] = useSignIn();\n+â”Š   â”Š122â”Š\n+â”Š   â”Š123â”Š  const onUsernameChange = useCallback(({ target }) => {\n+â”Š   â”Š124â”Š    setError('');\n+â”Š   â”Š125â”Š    setUsername(target.value);\n+â”Š   â”Š126â”Š  }, []);\n â”Š118â”Š127â”Š\n-â”Š119â”Š   â”Š  const onUserIdChange = useCallback(({ target }) => {\n-â”Š120â”Š   â”Š    setUserId(target.value);\n+â”Š   â”Š128â”Š  const onPasswordChange = useCallback(({ target }) => {\n+â”Š   â”Š129â”Š    setError('');\n+â”Š   â”Š130â”Š    setPassword(target.value);\n â”Š121â”Š131â”Š  }, []);\n â”Š122â”Š132â”Š\n â”Š123â”Š133â”Š  const maySignIn = useCallback(() => {\n-â”Š124â”Š   â”Š    return !!userId;\n-â”Š125â”Š   â”Š  }, [userId]);\n+â”Š   â”Š134â”Š    return !!(username && password);\n+â”Š   â”Š135â”Š  }, [username, password]);\n â”Š126â”Š136â”Š\n â”Š127â”Š137â”Š  const handleSignIn = useCallback(() => {\n-â”Š128â”Š   â”Š    signIn(userId).then(() => {\n-â”Š129â”Š   â”Š      history.replace('/chats');\n-â”Š130â”Š   â”Š    });\n-â”Š131â”Š   â”Š  }, [userId, history]);\n+â”Š   â”Š138â”Š    signIn({ variables: { username, password } })\n+â”Š   â”Š139â”Š      .then(() => {\n+â”Š   â”Š140â”Š        history.push('/chats');\n+â”Š   â”Š141â”Š      })\n+â”Š   â”Š142â”Š      .catch(error => {\n+â”Š   â”Š143â”Š        setError(error.message || error);\n+â”Š   â”Š144â”Š      });\n+â”Š   â”Š145â”Š  }, [username, password, history, signIn]);\n â”Š132â”Š146â”Š\n â”Š133â”Š147â”Š  return (\n â”Š134â”Š148â”Š    <Container>\n```\n```diff\n@@ -141,12 +155,21 @@\n â”Š141â”Š155â”Š          <Legend>Sign in</Legend>\n â”Š142â”Š156â”Š          <Section>\n â”Š143â”Š157â”Š            <TextField\n-â”Š144â”Š   â”Š              data-testid=\"user-id-input\"\n-â”Š145â”Š   â”Š              label=\"User ID\"\n-â”Š146â”Š   â”Š              value={userId}\n-â”Š147â”Š   â”Š              onChange={onUserIdChange}\n+â”Š   â”Š158â”Š              className=\"AuthScreen-text-field\"\n+â”Š   â”Š159â”Š              label=\"Username\"\n+â”Š   â”Š160â”Š              value={username}\n+â”Š   â”Š161â”Š              onChange={onUsernameChange}\n+â”Š   â”Š162â”Š              margin=\"normal\"\n+â”Š   â”Š163â”Š              placeholder=\"Enter your username\"\n+â”Š   â”Š164â”Š            />\n+â”Š   â”Š165â”Š            <TextField\n+â”Š   â”Š166â”Š              className=\"AuthScreen-text-field\"\n+â”Š   â”Š167â”Š              label=\"Password\"\n+â”Š   â”Š168â”Š              type=\"password\"\n+â”Š   â”Š169â”Š              value={password}\n+â”Š   â”Š170â”Š              onChange={onPasswordChange}\n â”Š148â”Š171â”Š              margin=\"normal\"\n-â”Š149â”Š   â”Š              placeholder=\"Enter current user ID\"\n+â”Š   â”Š172â”Š              placeholder=\"Enter your password\"\n â”Š150â”Š173â”Š            />\n â”Š151â”Š174â”Š          </Section>\n â”Š152â”Š175â”Š          <Button\n```\n\n[}]: #\n\nThe behavior of the updated screen should be identical to what we had so far. To complete the flow weâ€™ll need a way to signUp. When we signing-up we will need the following parameters: `name`, `username`, `password` and `passwordConfirm`. In addition we will need to run certain validations against the parameters:\n\n- The name must be at least 3 and at most 50 characters long.\n- The username must be at least 3 and at most 18 characters long.\n- A password must be at least 8 and at most 30 characters long. In addition, it should contain English letters, numbers, and special characters.\n\nFor that we will implement a dedicated validations module:\n\n[{]: <helper> (diffStep 10.6 files=\"validators\" module=\"server\")\n\n#### [__Server__ Step 10.6: Add signUp mutation](https://github.com/Urigo/WhatsApp-Clone-Server/commit/a2c89664cca1d7cdceb54a195a693bca77db78fa)\n\n##### Added validators.ts\n```diff\n@@ -0,0 +1,43 @@\n+â”Š  â”Š 1â”Šexport const validatePassword = (ctx: string, str: string) => {\n+â”Š  â”Š 2â”Š  if (typeof str !== 'string') {\n+â”Š  â”Š 3â”Š    throw TypeError(`${ctx} must be a string`);\n+â”Š  â”Š 4â”Š  }\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Š  validateLength(ctx, str, 8, 30);\n+â”Š  â”Š 7â”Š\n+â”Š  â”Š 8â”Š  if (!/[a-zA-Z]+/.test(str)) {\n+â”Š  â”Š 9â”Š    throw TypeError(`${ctx} must contain english letters`);\n+â”Š  â”Š10â”Š  }\n+â”Š  â”Š11â”Š\n+â”Š  â”Š12â”Š  if (!/\\d+/.test(str)) {\n+â”Š  â”Š13â”Š    throw TypeError(`${ctx} must contain numbers`);\n+â”Š  â”Š14â”Š  }\n+â”Š  â”Š15â”Š\n+â”Š  â”Š16â”Š  if (!/[^\\da-zA-Z]+/.test(str)) {\n+â”Š  â”Š17â”Š    throw TypeError(`${ctx} must contain special charachters`);\n+â”Š  â”Š18â”Š  }\n+â”Š  â”Š19â”Š};\n+â”Š  â”Š20â”Š\n+â”Š  â”Š21â”Šexport const validateLength = (ctx: string, str: string, ...args: number[]) => {\n+â”Š  â”Š22â”Š  let min, max;\n+â”Š  â”Š23â”Š\n+â”Š  â”Š24â”Š  if (args.length === 1) {\n+â”Š  â”Š25â”Š    min = 0;\n+â”Š  â”Š26â”Š    max = args[0];\n+â”Š  â”Š27â”Š  } else {\n+â”Š  â”Š28â”Š    min = args[0];\n+â”Š  â”Š29â”Š    max = args[1];\n+â”Š  â”Š30â”Š  }\n+â”Š  â”Š31â”Š\n+â”Š  â”Š32â”Š  if (typeof str !== 'string') {\n+â”Š  â”Š33â”Š    throw TypeError(`${ctx} must be a string`);\n+â”Š  â”Š34â”Š  }\n+â”Š  â”Š35â”Š\n+â”Š  â”Š36â”Š  if (str.length < min) {\n+â”Š  â”Š37â”Š    throw TypeError(`${ctx} must be at least ${min} chars long`);\n+â”Š  â”Š38â”Š  }\n+â”Š  â”Š39â”Š\n+â”Š  â”Š40â”Š  if (str.length > max) {\n+â”Š  â”Š41â”Š    throw TypeError(`${ctx} must contain ${max} chars at most`);\n+â”Š  â”Š42â”Š  }\n+â”Š  â”Š43â”Š};\n```\n\n[}]: #\n\nAnd we will implement the resolver and schema for the `signUp` mutation:\n\n[{]: <helper> (diffStep 10.6 files=\"schema\" module=\"server\")\n\n#### [__Server__ Step 10.6: Add signUp mutation](https://github.com/Urigo/WhatsApp-Clone-Server/commit/a2c89664cca1d7cdceb54a195a693bca77db78fa)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -5,6 +5,7 @@\n â”Š 5â”Š 5â”Šimport { secret, expiration } from '../env';\n â”Š 6â”Š 6â”Šimport bcrypt from 'bcrypt';\n â”Š 7â”Š 7â”Šimport jwt from 'jsonwebtoken';\n+â”Š  â”Š 8â”Šimport { validateLength, validatePassword } from '../validators';\n â”Š 8â”Š 9â”Š\n â”Š 9â”Š10â”Šconst resolvers: Resolvers = {\n â”Š10â”Š11â”Š  Date: GraphQLDateTime,\n```\n```diff\n@@ -118,6 +119,34 @@\n â”Š118â”Š119â”Š      return user;\n â”Š119â”Š120â”Š    },\n â”Š120â”Š121â”Š\n+â”Š   â”Š122â”Š    signUp(root, { name, username, password, passwordConfirm }) {\n+â”Š   â”Š123â”Š      validateLength('req.name', name, 3, 50);\n+â”Š   â”Š124â”Š      validateLength('req.username', username, 3, 18);\n+â”Š   â”Š125â”Š      validatePassword('req.password', password);\n+â”Š   â”Š126â”Š\n+â”Š   â”Š127â”Š      if (password !== passwordConfirm) {\n+â”Š   â”Š128â”Š        throw Error(\"req.password and req.passwordConfirm don't match\");\n+â”Š   â”Š129â”Š      }\n+â”Š   â”Š130â”Š\n+â”Š   â”Š131â”Š      if (users.some(u => u.username === username)) {\n+â”Š   â”Š132â”Š        throw Error('username already exists');\n+â”Š   â”Š133â”Š      }\n+â”Š   â”Š134â”Š\n+â”Š   â”Š135â”Š      const passwordHash = bcrypt.hashSync(password, bcrypt.genSaltSync(8));\n+â”Š   â”Š136â”Š\n+â”Š   â”Š137â”Š      const user: User = {\n+â”Š   â”Š138â”Š        id: String(users.length + 1),\n+â”Š   â”Š139â”Š        password: passwordHash,\n+â”Š   â”Š140â”Š        picture: '',\n+â”Š   â”Š141â”Š        username,\n+â”Š   â”Š142â”Š        name,\n+â”Š   â”Š143â”Š      };\n+â”Š   â”Š144â”Š\n+â”Š   â”Š145â”Š      users.push(user);\n+â”Š   â”Š146â”Š\n+â”Š   â”Š147â”Š      return user;\n+â”Š   â”Š148â”Š    },\n+â”Š   â”Š149â”Š\n â”Š121â”Š150â”Š    addMessage(root, { chatId, content }, { currentUser, pubsub }) {\n â”Š122â”Š151â”Š      if (!currentUser) return null;\n â”Š123â”Š152â”Š\n```\n\n##### Changed schema&#x2F;typeDefs.graphql\n```diff\n@@ -34,6 +34,7 @@\n â”Š34â”Š34â”Š\n â”Š35â”Š35â”Štype Mutation {\n â”Š36â”Š36â”Š  signIn(username: String!, password: String!): User\n+â”Š  â”Š37â”Š  signUp(name: String!, username: String!, password: String!, passwordConfirm: String!): User\n â”Š37â”Š38â”Š  addMessage(chatId: ID!, content: String!): Message\n â”Š38â”Š39â”Š  addChat(recipientId: ID!): Chat\n â”Š39â”Š40â”Š  removeChat(chatId: ID!): ID\n```\n\n[}]: #\n\nBefore encrypting the password we append a string called â€œsaltâ€ to it. Even though the passwords are stored encrypted in the DB, a hacker might use a dictionary of common passwords in their encrypted form to decipher the original password. When adding salt to a password which is essentially a random string, the hacker cannot use a dictionary anymore since he would need to know the salt. Hypothetically, the hacker can get a hold of the salt and re-generate the entire dictionary, however that would take too long because of the way Bcrypt is designed to work.\n\nGoing back to the client, we will implement a new `signUp()` method in the `auth.service` that will call the `signUp` mutation:\n\n[{]: <helper> (diffStep 13.5 module=\"client\")\n\n#### [__Client__ Step 13.5: Add signUp() method to auth.service](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/7c5d57dc055a53955486c11479a2c8e5011ece92)\n\n##### Added src&#x2F;graphql&#x2F;mutations&#x2F;signUp.mutation.ts\n```diff\n@@ -0,0 +1,9 @@\n+â”Š â”Š1â”Šimport gql from 'graphql-tag'\n+â”Š â”Š2â”Š\n+â”Š â”Š3â”Šexport default gql`\n+â”Š â”Š4â”Š  mutation signUp($name: String!, $username: String!, $password: String!, $passwordConfirm: String!) {\n+â”Š â”Š5â”Š    signUp(name: $name, username: $username, password: $password, passwordConfirm: $passwordConfirm) {\n+â”Š â”Š6â”Š      id\n+â”Š â”Š7â”Š    }\n+â”Š â”Š8â”Š  }\n+â”Š â”Š9â”Š`\n```\n\n##### Changed src&#x2F;services&#x2F;auth.service.tsx\n```diff\n@@ -2,7 +2,7 @@\n â”Š2â”Š2â”Šimport { useContext, useCallback } from 'react';\n â”Š3â”Š3â”Šimport { useApolloClient } from '@apollo/react-hooks';\n â”Š4â”Š4â”Šimport { Redirect } from 'react-router-dom';\n-â”Š5â”Š â”Šimport { useMeQuery, User, useSignInMutation } from '../graphql/types';\n+â”Š â”Š5â”Šimport { useMeQuery, User, useSignInMutation, useSignUpMutation } from '../graphql/types';\n â”Š6â”Š6â”Šimport { useCacheService } from './cache.service';\n â”Š7â”Š7â”Š\n â”Š8â”Š8â”Šconst MyContext = React.createContext<User | null>(null);\n```\n```diff\n@@ -47,6 +47,7 @@\n â”Š47â”Š47â”Š};\n â”Š48â”Š48â”Š\n â”Š49â”Š49â”Šexport const useSignIn = useSignInMutation;\n+â”Š  â”Š50â”Šexport const useSignUp = useSignUpMutation;\n â”Š50â”Š51â”Š\n â”Š51â”Š52â”Šexport const useSignOut = () => {\n â”Š52â”Š53â”Š  const client = useApolloClient()\n```\n\n[}]: #\n\nNow we will implement a dedicated `SignUpForm` that we can use to perform the sign-up. Instead of implementing a new screen, we will use the `AuthScreen` to alternate between the `SignInForm` and the `SignUpForm` using `AnimatedSwitch`. This way we can have a container component that is common for both forms, and we will be able to switch between the two very smoothly. We will first define a new `/sign-up` route in our router:\n\n[{]: <helper> (diffStep 13.6 module=\"client\")\n\n#### [__Client__ Step 13.6: Split AuthScreen into SignInForm and SignUpForm](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/37ed707e175aa1b70bc720633c93e815e768a740)\n\n##### Added src&#x2F;components&#x2F;AuthScreen&#x2F;SignInForm.test.tsx\n```diff\n@@ -0,0 +1,163 @@\n+â”Š   â”Š  1â”Šimport { createMemoryHistory } from 'history';\n+â”Š   â”Š  2â”Šimport React from 'react';\n+â”Š   â”Š  3â”Šimport { ApolloProvider } from '@apollo/react-hooks';\n+â”Š   â”Š  4â”Šimport { act, cleanup, render, fireEvent, wait, waitForElement } from '@testing-library/react';\n+â”Š   â”Š  5â”Šimport SignInForm from './SignInForm';\n+â”Š   â”Š  6â”Šimport { SignInDocument } from '../../graphql/types';\n+â”Š   â”Š  7â”Šimport { mockApolloClient } from '../../test-helpers';\n+â”Š   â”Š  8â”Š\n+â”Š   â”Š  9â”Šdescribe('SignInForm', () => {\n+â”Š   â”Š 10â”Š  afterEach(cleanup);\n+â”Š   â”Š 11â”Š\n+â”Š   â”Š 12â”Š  it('enables sign-in button when filled in', async () => {\n+â”Š   â”Š 13â”Š    const history = createMemoryHistory();\n+â”Š   â”Š 14â”Š    const client = mockApolloClient();\n+â”Š   â”Š 15â”Š\n+â”Š   â”Š 16â”Š    let getByTestId: any = null;\n+â”Š   â”Š 17â”Š\n+â”Š   â”Š 18â”Š    act(() => {\n+â”Š   â”Š 19â”Š      getByTestId = render(\n+â”Š   â”Š 20â”Š        <ApolloProvider client={client}>\n+â”Š   â”Š 21â”Š          <SignInForm history={history} />\n+â”Š   â”Š 22â”Š        </ApolloProvider>\n+â”Š   â”Š 23â”Š      ).getByTestId;\n+â”Š   â”Š 24â”Š    });\n+â”Š   â”Š 25â”Š\n+â”Š   â”Š 26â”Š    const signInButton = await waitForElement(() =>\n+â”Š   â”Š 27â”Š      getByTestId('sign-in-button') as HTMLButtonElement\n+â”Š   â”Š 28â”Š    );\n+â”Š   â”Š 29â”Š    const usernameInput = await waitForElement(() =>\n+â”Š   â”Š 30â”Š      getByTestId('username-input').querySelector('input')\n+â”Š   â”Š 31â”Š    );\n+â”Š   â”Š 32â”Š    const passwordInput = await waitForElement(() =>\n+â”Š   â”Š 33â”Š      getByTestId('password-input').querySelector('input')\n+â”Š   â”Š 34â”Š    );\n+â”Š   â”Š 35â”Š\n+â”Š   â”Š 36â”Š    expect(signInButton.disabled).toEqual(true);\n+â”Š   â”Š 37â”Š\n+â”Š   â”Š 38â”Š    act(() => {\n+â”Š   â”Š 39â”Š      fireEvent.change(usernameInput, { target: { value: 'username' } });\n+â”Š   â”Š 40â”Š      fireEvent.change(passwordInput, { target: { value: 'password' } });\n+â”Š   â”Š 41â”Š    });\n+â”Š   â”Š 42â”Š\n+â”Š   â”Š 43â”Š    await wait(() =>\n+â”Š   â”Š 44â”Š      expect(signInButton.disabled).toEqual(false)\n+â”Š   â”Š 45â”Š    )\n+â”Š   â”Š 46â”Š  });\n+â”Š   â”Š 47â”Š\n+â”Š   â”Š 48â”Š  it('prints server error if input was wrong', async () => {\n+â”Š   â”Š 49â”Š    const history = createMemoryHistory();\n+â”Š   â”Š 50â”Š\n+â”Š   â”Š 51â”Š    const client = mockApolloClient([\n+â”Š   â”Š 52â”Š      {\n+â”Š   â”Š 53â”Š        request: {\n+â”Š   â”Š 54â”Š          query: SignInDocument,\n+â”Š   â”Š 55â”Š          variables: {\n+â”Š   â”Š 56â”Š            username: 'username',\n+â”Š   â”Š 57â”Š            password: 'password'\n+â”Š   â”Š 58â”Š          }\n+â”Š   â”Š 59â”Š        },\n+â”Š   â”Š 60â”Š        get result() { throw Error('sign-in failed') },\n+â”Š   â”Š 61â”Š      }\n+â”Š   â”Š 62â”Š    ]);\n+â”Š   â”Š 63â”Š\n+â”Š   â”Š 64â”Š    let getByTestId: any = null;\n+â”Š   â”Š 65â”Š\n+â”Š   â”Š 66â”Š    act(() => {\n+â”Š   â”Š 67â”Š      getByTestId = render(\n+â”Š   â”Š 68â”Š        <ApolloProvider client={client}>\n+â”Š   â”Š 69â”Š          <SignInForm history={history} />\n+â”Š   â”Š 70â”Š        </ApolloProvider>\n+â”Š   â”Š 71â”Š      ).getByTestId;\n+â”Š   â”Š 72â”Š    });\n+â”Š   â”Š 73â”Š\n+â”Š   â”Š 74â”Š    const signInButton = await waitForElement(() =>\n+â”Š   â”Š 75â”Š      getByTestId('sign-in-button') as HTMLButtonElement\n+â”Š   â”Š 76â”Š    );\n+â”Š   â”Š 77â”Š    const usernameInput = await waitForElement(() =>\n+â”Š   â”Š 78â”Š      getByTestId('username-input').querySelector('input')\n+â”Š   â”Š 79â”Š    );\n+â”Š   â”Š 80â”Š    const passwordInput = await waitForElement(() =>\n+â”Š   â”Š 81â”Š      getByTestId('password-input').querySelector('input')\n+â”Š   â”Š 82â”Š    );\n+â”Š   â”Š 83â”Š\n+â”Š   â”Š 84â”Š    act(() => {\n+â”Š   â”Š 85â”Š      fireEvent.change(usernameInput, { target: { value: 'username' } });\n+â”Š   â”Š 86â”Š      fireEvent.change(passwordInput, { target: { value: 'password' } });\n+â”Š   â”Š 87â”Š    });\n+â”Š   â”Š 88â”Š\n+â”Š   â”Š 89â”Š    await wait(() =>\n+â”Š   â”Š 90â”Š      expect(usernameInput.value).toEqual('username')\n+â”Š   â”Š 91â”Š    );\n+â”Š   â”Š 92â”Š\n+â”Š   â”Š 93â”Š    await wait(() =>\n+â”Š   â”Š 94â”Š      expect(passwordInput.value).toEqual('password')\n+â”Š   â”Š 95â”Š    );\n+â”Š   â”Š 96â”Š\n+â”Š   â”Š 97â”Š    act(() => {\n+â”Š   â”Š 98â”Š      fireEvent.click(signInButton);\n+â”Š   â”Š 99â”Š    });\n+â”Š   â”Š100â”Š\n+â”Š   â”Š101â”Š    const errorMessage = await waitForElement(() =>\n+â”Š   â”Š102â”Š      getByTestId('error-message')\n+â”Š   â”Š103â”Š    );\n+â”Š   â”Š104â”Š\n+â”Š   â”Š105â”Š    await wait(() => expect(errorMessage.innerHTML).toContain('sign-in failed'));\n+â”Š   â”Š106â”Š  });\n+â”Š   â”Š107â”Š\n+â”Š   â”Š108â”Š  it('navigates to /chats if everything went right', async () => {\n+â”Š   â”Š109â”Š    const history = createMemoryHistory();\n+â”Š   â”Š110â”Š\n+â”Š   â”Š111â”Š    const client = mockApolloClient([\n+â”Š   â”Š112â”Š      {\n+â”Š   â”Š113â”Š        request: {\n+â”Š   â”Š114â”Š          query: SignInDocument,\n+â”Š   â”Š115â”Š          variables: {\n+â”Š   â”Š116â”Š            username: 'username',\n+â”Š   â”Š117â”Š            password: 'password'\n+â”Š   â”Š118â”Š          }\n+â”Š   â”Š119â”Š        },\n+â”Š   â”Š120â”Š        result: { data: {} }\n+â”Š   â”Š121â”Š      }\n+â”Š   â”Š122â”Š    ]);\n+â”Š   â”Š123â”Š\n+â”Š   â”Š124â”Š    let getByTestId: any = null;\n+â”Š   â”Š125â”Š\n+â”Š   â”Š126â”Š    act(() => {\n+â”Š   â”Š127â”Š      getByTestId = render(\n+â”Š   â”Š128â”Š        <ApolloProvider client={client}>\n+â”Š   â”Š129â”Š          <SignInForm history={history} />\n+â”Š   â”Š130â”Š        </ApolloProvider>\n+â”Š   â”Š131â”Š      ).getByTestId;\n+â”Š   â”Š132â”Š    })\n+â”Š   â”Š133â”Š\n+â”Š   â”Š134â”Š    const usernameInput = await waitForElement(() =>\n+â”Š   â”Š135â”Š      getByTestId('username-input').querySelector('input')\n+â”Š   â”Š136â”Š    );\n+â”Š   â”Š137â”Š    const passwordInput = await waitForElement(() =>\n+â”Š   â”Š138â”Š      getByTestId('password-input').querySelector('input')\n+â”Š   â”Š139â”Š    );\n+â”Š   â”Š140â”Š    const signInButton = await waitForElement(() =>\n+â”Š   â”Š141â”Š      getByTestId('sign-in-button') as HTMLButtonElement\n+â”Š   â”Š142â”Š    );\n+â”Š   â”Š143â”Š\n+â”Š   â”Š144â”Š    act(() => {\n+â”Š   â”Š145â”Š      fireEvent.change(usernameInput, { target: { value: 'username' } });\n+â”Š   â”Š146â”Š      fireEvent.change(passwordInput, { target: { value: 'password' } });\n+â”Š   â”Š147â”Š    });\n+â”Š   â”Š148â”Š\n+â”Š   â”Š149â”Š    await wait(() =>\n+â”Š   â”Š150â”Š      expect(usernameInput.value).toEqual('username')\n+â”Š   â”Š151â”Š    );\n+â”Š   â”Š152â”Š\n+â”Š   â”Š153â”Š    await wait(() =>\n+â”Š   â”Š154â”Š      expect(passwordInput.value).toEqual('password')\n+â”Š   â”Š155â”Š    );\n+â”Š   â”Š156â”Š\n+â”Š   â”Š157â”Š    act(() => {\n+â”Š   â”Š158â”Š      fireEvent.click(signInButton);\n+â”Š   â”Š159â”Š    });\n+â”Š   â”Š160â”Š\n+â”Š   â”Š161â”Š    await wait(() => expect(history.location.pathname).toEqual('/chats'));\n+â”Š   â”Š162â”Š  });\n+â”Š   â”Š163â”Š});ðŸš«â†µ\n```\n\n##### Added src&#x2F;components&#x2F;AuthScreen&#x2F;SignInForm.tsx\n```diff\n@@ -0,0 +1,83 @@\n+â”Š  â”Š 1â”Šimport React from 'react';\n+â”Š  â”Š 2â”Šimport { useCallback, useState } from 'react';\n+â”Š  â”Š 3â”Šimport { useSignIn } from '../../services/auth.service';\n+â”Š  â”Š 4â”Šimport {\n+â”Š  â”Š 5â”Š  SignForm,\n+â”Š  â”Š 6â”Š  ActualForm,\n+â”Š  â”Š 7â”Š  Legend,\n+â”Š  â”Š 8â”Š  Section,\n+â”Š  â”Š 9â”Š  TextField,\n+â”Š  â”Š10â”Š  Button,\n+â”Š  â”Š11â”Š  ErrorMessage,\n+â”Š  â”Š12â”Š} from './form-components';\n+â”Š  â”Š13â”Šimport { RouteComponentProps } from 'react-router-dom';\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”Šconst SignInForm: React.FC<RouteComponentProps<any>> = ({ history }) => {\n+â”Š  â”Š16â”Š  const [username, setUsername] = useState('');\n+â”Š  â”Š17â”Š  const [password, setPassword] = useState('');\n+â”Š  â”Š18â”Š  const [error, setError] = useState('');\n+â”Š  â”Š19â”Š  const [signIn] = useSignIn();\n+â”Š  â”Š20â”Š\n+â”Š  â”Š21â”Š  const onUsernameChange = useCallback(({ target }) => {\n+â”Š  â”Š22â”Š    setError('');\n+â”Š  â”Š23â”Š    setUsername(target.value);\n+â”Š  â”Š24â”Š  }, []);\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Š  const onPasswordChange = useCallback(({ target }) => {\n+â”Š  â”Š27â”Š    setError('');\n+â”Š  â”Š28â”Š    setPassword(target.value);\n+â”Š  â”Š29â”Š  }, []);\n+â”Š  â”Š30â”Š\n+â”Š  â”Š31â”Š  const maySignIn = useCallback(() => {\n+â”Š  â”Š32â”Š    return !!(username && password);\n+â”Š  â”Š33â”Š  }, [username, password]);\n+â”Š  â”Š34â”Š\n+â”Š  â”Š35â”Š  const handleSignIn = useCallback(() => {\n+â”Š  â”Š36â”Š    signIn({ variables: { username, password } })\n+â”Š  â”Š37â”Š      .then(() => {\n+â”Š  â”Š38â”Š        history.replace('/chats');\n+â”Š  â”Š39â”Š      })\n+â”Š  â”Š40â”Š      .catch(error => {\n+â”Š  â”Š41â”Š        setError(error.message || error);\n+â”Š  â”Š42â”Š      });\n+â”Š  â”Š43â”Š  }, [username, password, history, signIn]);\n+â”Š  â”Š44â”Š\n+â”Š  â”Š45â”Š  return (\n+â”Š  â”Š46â”Š    <SignForm>\n+â”Š  â”Š47â”Š      <ActualForm>\n+â”Š  â”Š48â”Š        <Legend>Sign in</Legend>\n+â”Š  â”Š49â”Š        <Section style={{ width: '100%' }}>\n+â”Š  â”Š50â”Š          <TextField\n+â”Š  â”Š51â”Š            data-testid=\"username-input\"\n+â”Š  â”Š52â”Š            label=\"Username\"\n+â”Š  â”Š53â”Š            value={username}\n+â”Š  â”Š54â”Š            onChange={onUsernameChange}\n+â”Š  â”Š55â”Š            margin=\"normal\"\n+â”Š  â”Š56â”Š            placeholder=\"Enter your username\"\n+â”Š  â”Š57â”Š          />\n+â”Š  â”Š58â”Š          <TextField\n+â”Š  â”Š59â”Š            data-testid=\"password-input\"\n+â”Š  â”Š60â”Š            label=\"Password\"\n+â”Š  â”Š61â”Š            type=\"password\"\n+â”Š  â”Š62â”Š            value={password}\n+â”Š  â”Š63â”Š            onChange={onPasswordChange}\n+â”Š  â”Š64â”Š            margin=\"normal\"\n+â”Š  â”Š65â”Š            placeholder=\"Enter your password\"\n+â”Š  â”Š66â”Š          />\n+â”Š  â”Š67â”Š        </Section>\n+â”Š  â”Š68â”Š        <Button\n+â”Š  â”Š69â”Š          data-testid=\"sign-in-button\"\n+â”Š  â”Š70â”Š          type=\"button\"\n+â”Š  â”Š71â”Š          color=\"secondary\"\n+â”Š  â”Š72â”Š          variant=\"contained\"\n+â”Š  â”Š73â”Š          disabled={!maySignIn()}\n+â”Š  â”Š74â”Š          onClick={handleSignIn}>\n+â”Š  â”Š75â”Š          Sign in\n+â”Š  â”Š76â”Š        </Button>\n+â”Š  â”Š77â”Š        <ErrorMessage data-testid=\"error-message\">{error}</ErrorMessage>\n+â”Š  â”Š78â”Š      </ActualForm>\n+â”Š  â”Š79â”Š    </SignForm>\n+â”Š  â”Š80â”Š  );\n+â”Š  â”Š81â”Š};\n+â”Š  â”Š82â”Š\n+â”Š  â”Š83â”Šexport default SignInForm;\n```\n\n##### Added src&#x2F;components&#x2F;AuthScreen&#x2F;SignUpForm.test.tsx\n```diff\n@@ -0,0 +1,225 @@\n+â”Š   â”Š  1â”Šimport { createMemoryHistory } from 'history';\n+â”Š   â”Š  2â”Šimport React from 'react';\n+â”Š   â”Š  3â”Šimport { ApolloProvider } from '@apollo/react-hooks';\n+â”Š   â”Š  4â”Šimport { act, cleanup, render, fireEvent, wait, waitForElement } from '@testing-library/react';\n+â”Š   â”Š  5â”Šimport SignUpForm from './SignUpForm';\n+â”Š   â”Š  6â”Šimport { SignUpDocument } from '../../graphql/types';\n+â”Š   â”Š  7â”Šimport { mockApolloClient } from '../../test-helpers';\n+â”Š   â”Š  8â”Š\n+â”Š   â”Š  9â”Šdescribe('SignUpForm', () => {\n+â”Š   â”Š 10â”Š  afterEach(cleanup);\n+â”Š   â”Š 11â”Š\n+â”Š   â”Š 12â”Š  it('enables sign-up button when filled in', async () => {\n+â”Š   â”Š 13â”Š    const history = createMemoryHistory();\n+â”Š   â”Š 14â”Š    const client = mockApolloClient();\n+â”Š   â”Š 15â”Š\n+â”Š   â”Š 16â”Š    let getByTestId: any = null;\n+â”Š   â”Š 17â”Š\n+â”Š   â”Š 18â”Š    act(() => {\n+â”Š   â”Š 19â”Š      getByTestId = render(\n+â”Š   â”Š 20â”Š        <ApolloProvider client={client}>\n+â”Š   â”Š 21â”Š          <SignUpForm history={history} />\n+â”Š   â”Š 22â”Š        </ApolloProvider>\n+â”Š   â”Š 23â”Š      ).getByTestId;\n+â”Š   â”Š 24â”Š    });\n+â”Š   â”Š 25â”Š\n+â”Š   â”Š 26â”Š    const nameInput = await waitForElement(() =>\n+â”Š   â”Š 27â”Š      getByTestId('name-input').querySelector('input')\n+â”Š   â”Š 28â”Š    );\n+â”Š   â”Š 29â”Š    const usernameInput = await waitForElement(() =>\n+â”Š   â”Š 30â”Š      getByTestId('username-input').querySelector('input')\n+â”Š   â”Š 31â”Š    );\n+â”Š   â”Š 32â”Š    const passwordInput = await waitForElement(() =>\n+â”Š   â”Š 33â”Š      getByTestId('password-input').querySelector('input')\n+â”Š   â”Š 34â”Š    );\n+â”Š   â”Š 35â”Š    const passwordConfirmInput = await waitForElement(() =>\n+â”Š   â”Š 36â”Š      getByTestId('password-confirm-input').querySelector('input')\n+â”Š   â”Š 37â”Š    );\n+â”Š   â”Š 38â”Š    const signUpButton = await waitForElement(() =>\n+â”Š   â”Š 39â”Š      getByTestId('sign-up-button') as HTMLButtonElement\n+â”Š   â”Š 40â”Š    );\n+â”Š   â”Š 41â”Š\n+â”Š   â”Š 42â”Š    expect(signUpButton.disabled).toEqual(true);\n+â”Š   â”Š 43â”Š\n+â”Š   â”Š 44â”Š    act(() => {\n+â”Š   â”Š 45â”Š      fireEvent.change(nameInput, { target: { value: 'User Name' } });\n+â”Š   â”Š 46â”Š      fireEvent.change(usernameInput, { target: { value: 'username' } });\n+â”Š   â”Š 47â”Š      fireEvent.change(passwordInput, { target: { value: 'password' } });\n+â”Š   â”Š 48â”Š      fireEvent.change(passwordConfirmInput, { target: { value: 'password' } });\n+â”Š   â”Š 49â”Š    });\n+â”Š   â”Š 50â”Š\n+â”Š   â”Š 51â”Š    await wait(() =>\n+â”Š   â”Š 52â”Š      expect(nameInput.value).toEqual('User Name')\n+â”Š   â”Š 53â”Š    );\n+â”Š   â”Š 54â”Š\n+â”Š   â”Š 55â”Š    await wait(() =>\n+â”Š   â”Š 56â”Š      expect(usernameInput.value).toEqual('username')\n+â”Š   â”Š 57â”Š    );\n+â”Š   â”Š 58â”Š\n+â”Š   â”Š 59â”Š    await wait(() =>\n+â”Š   â”Š 60â”Š      expect(passwordInput.value).toEqual('password')\n+â”Š   â”Š 61â”Š    );\n+â”Š   â”Š 62â”Š\n+â”Š   â”Š 63â”Š    await wait(() =>\n+â”Š   â”Š 64â”Š      expect(passwordConfirmInput.value).toEqual('password')\n+â”Š   â”Š 65â”Š    );\n+â”Š   â”Š 66â”Š\n+â”Š   â”Š 67â”Š    await wait(() =>\n+â”Š   â”Š 68â”Š      expect(signUpButton.disabled).toEqual(false)\n+â”Š   â”Š 69â”Š    )\n+â”Š   â”Š 70â”Š  });\n+â”Š   â”Š 71â”Š\n+â”Š   â”Š 72â”Š  it('prints server error if input was wrong', async () => {\n+â”Š   â”Š 73â”Š    const history = createMemoryHistory();\n+â”Š   â”Š 74â”Š\n+â”Š   â”Š 75â”Š    const client = mockApolloClient([\n+â”Š   â”Š 76â”Š      {\n+â”Š   â”Š 77â”Š        request: {\n+â”Š   â”Š 78â”Š          query: SignUpDocument,\n+â”Š   â”Š 79â”Š          variables: {\n+â”Š   â”Š 80â”Š            name: 'User Name',\n+â”Š   â”Š 81â”Š            username: 'username',\n+â”Š   â”Š 82â”Š            password: 'password',\n+â”Š   â”Š 83â”Š            passwordConfirm: 'password'\n+â”Š   â”Š 84â”Š          }\n+â”Š   â”Š 85â”Š        },\n+â”Š   â”Š 86â”Š        get result() { throw Error('sign-up failed') }\n+â”Š   â”Š 87â”Š      }\n+â”Š   â”Š 88â”Š    ]);\n+â”Š   â”Š 89â”Š\n+â”Š   â”Š 90â”Š    let getByTestId: any = null;\n+â”Š   â”Š 91â”Š\n+â”Š   â”Š 92â”Š    act(() => {\n+â”Š   â”Š 93â”Š      getByTestId = render(\n+â”Š   â”Š 94â”Š        <ApolloProvider client={client}>\n+â”Š   â”Š 95â”Š          <SignUpForm history={history} />\n+â”Š   â”Š 96â”Š        </ApolloProvider>\n+â”Š   â”Š 97â”Š      ).getByTestId;\n+â”Š   â”Š 98â”Š    });\n+â”Š   â”Š 99â”Š\n+â”Š   â”Š100â”Š    const nameInput = await waitForElement(() =>\n+â”Š   â”Š101â”Š      getByTestId('name-input').querySelector('input')\n+â”Š   â”Š102â”Š    );\n+â”Š   â”Š103â”Š    const usernameInput = await waitForElement(() =>\n+â”Š   â”Š104â”Š      getByTestId('username-input').querySelector('input')\n+â”Š   â”Š105â”Š    );\n+â”Š   â”Š106â”Š    const passwordInput = await waitForElement(() =>\n+â”Š   â”Š107â”Š      getByTestId('password-input').querySelector('input')\n+â”Š   â”Š108â”Š    );\n+â”Š   â”Š109â”Š    const passwordConfirmInput = await waitForElement(() =>\n+â”Š   â”Š110â”Š      getByTestId('password-confirm-input').querySelector('input')\n+â”Š   â”Š111â”Š    );\n+â”Š   â”Š112â”Š    const signUpButton = await waitForElement(() =>\n+â”Š   â”Š113â”Š      getByTestId('sign-up-button') as HTMLButtonElement\n+â”Š   â”Š114â”Š    );\n+â”Š   â”Š115â”Š\n+â”Š   â”Š116â”Š    act(() => {\n+â”Š   â”Š117â”Š      fireEvent.change(nameInput, { target: { value: 'User Name' } });\n+â”Š   â”Š118â”Š      fireEvent.change(usernameInput, { target: { value: 'username' } });\n+â”Š   â”Š119â”Š      fireEvent.change(passwordInput, { target: { value: 'password' } });\n+â”Š   â”Š120â”Š      fireEvent.change(passwordConfirmInput, { target: { value: 'password' } });\n+â”Š   â”Š121â”Š    });\n+â”Š   â”Š122â”Š\n+â”Š   â”Š123â”Š    await wait(() =>\n+â”Š   â”Š124â”Š      expect(nameInput.value).toEqual('User Name')\n+â”Š   â”Š125â”Š    );\n+â”Š   â”Š126â”Š\n+â”Š   â”Š127â”Š    await wait(() =>\n+â”Š   â”Š128â”Š      expect(usernameInput.value).toEqual('username')\n+â”Š   â”Š129â”Š    );\n+â”Š   â”Š130â”Š\n+â”Š   â”Š131â”Š    await wait(() =>\n+â”Š   â”Š132â”Š      expect(passwordInput.value).toEqual('password')\n+â”Š   â”Š133â”Š    );\n+â”Š   â”Š134â”Š\n+â”Š   â”Š135â”Š    await wait(() =>\n+â”Š   â”Š136â”Š      expect(passwordConfirmInput.value).toEqual('password')\n+â”Š   â”Š137â”Š    );\n+â”Š   â”Š138â”Š\n+â”Š   â”Š139â”Š    act(() => {\n+â”Š   â”Š140â”Š      fireEvent.click(signUpButton);\n+â”Š   â”Š141â”Š    });\n+â”Š   â”Š142â”Š\n+â”Š   â”Š143â”Š    const errorMessage = await waitForElement(() =>\n+â”Š   â”Š144â”Š      getByTestId('error-message')\n+â”Š   â”Š145â”Š    );\n+â”Š   â”Š146â”Š\n+â”Š   â”Š147â”Š    await wait(() =>expect(errorMessage.innerHTML).toContain('sign-up failed'));\n+â”Š   â”Š148â”Š  });\n+â”Š   â”Š149â”Š\n+â”Š   â”Š150â”Š  it('navigates to /sign-in if everything went right', async () => {\n+â”Š   â”Š151â”Š    const history = createMemoryHistory();\n+â”Š   â”Š152â”Š\n+â”Š   â”Š153â”Š    const client = mockApolloClient([\n+â”Š   â”Š154â”Š      {\n+â”Š   â”Š155â”Š        request: {\n+â”Š   â”Š156â”Š          query: SignUpDocument,\n+â”Š   â”Š157â”Š          variables: {\n+â”Š   â”Š158â”Š            name: 'User Name',\n+â”Š   â”Š159â”Š            username: 'username',\n+â”Š   â”Š160â”Š            password: 'password',\n+â”Š   â”Š161â”Š            passwordConfirm: 'password'\n+â”Š   â”Š162â”Š          }\n+â”Š   â”Š163â”Š        },\n+â”Š   â”Š164â”Š        result: { data: {} }\n+â”Š   â”Š165â”Š      }\n+â”Š   â”Š166â”Š    ]);\n+â”Š   â”Š167â”Š\n+â”Š   â”Š168â”Š    let getByTestId: any = null;\n+â”Š   â”Š169â”Š\n+â”Š   â”Š170â”Š    act(() => {\n+â”Š   â”Š171â”Š      getByTestId = render(\n+â”Š   â”Š172â”Š        <ApolloProvider client={client}>\n+â”Š   â”Š173â”Š          <SignUpForm history={history} />\n+â”Š   â”Š174â”Š        </ApolloProvider>\n+â”Š   â”Š175â”Š      ).getByTestId;\n+â”Š   â”Š176â”Š    });\n+â”Š   â”Š177â”Š\n+â”Š   â”Š178â”Š    const nameInput = await waitForElement(() =>\n+â”Š   â”Š179â”Š      getByTestId('name-input').querySelector('input')\n+â”Š   â”Š180â”Š    );\n+â”Š   â”Š181â”Š    const usernameInput = await waitForElement(() =>\n+â”Š   â”Š182â”Š      getByTestId('username-input').querySelector('input')\n+â”Š   â”Š183â”Š    );\n+â”Š   â”Š184â”Š    const passwordInput = await waitForElement(() =>\n+â”Š   â”Š185â”Š      getByTestId('password-input').querySelector('input')\n+â”Š   â”Š186â”Š    );\n+â”Š   â”Š187â”Š    const passwordConfirmInput = await waitForElement(() =>\n+â”Š   â”Š188â”Š      getByTestId('password-confirm-input').querySelector('input')\n+â”Š   â”Š189â”Š    );\n+â”Š   â”Š190â”Š    const signUpButton = await waitForElement(() =>\n+â”Š   â”Š191â”Š      getByTestId('sign-up-button') as HTMLButtonElement\n+â”Š   â”Š192â”Š    );\n+â”Š   â”Š193â”Š\n+â”Š   â”Š194â”Š    act(() => {\n+â”Š   â”Š195â”Š      fireEvent.change(nameInput, { target: { value: 'User Name' } });\n+â”Š   â”Š196â”Š      fireEvent.change(usernameInput, { target: { value: 'username' } });\n+â”Š   â”Š197â”Š      fireEvent.change(passwordInput, { target: { value: 'password' } });\n+â”Š   â”Š198â”Š      fireEvent.change(passwordConfirmInput, { target: { value: 'password' } });\n+â”Š   â”Š199â”Š    });\n+â”Š   â”Š200â”Š\n+â”Š   â”Š201â”Š    await wait(() =>\n+â”Š   â”Š202â”Š      expect(nameInput.value).toEqual('User Name')\n+â”Š   â”Š203â”Š    );\n+â”Š   â”Š204â”Š\n+â”Š   â”Š205â”Š    await wait(() =>\n+â”Š   â”Š206â”Š      expect(usernameInput.value).toEqual('username')\n+â”Š   â”Š207â”Š    );\n+â”Š   â”Š208â”Š\n+â”Š   â”Š209â”Š    await wait(() =>\n+â”Š   â”Š210â”Š      expect(passwordInput.value).toEqual('password')\n+â”Š   â”Š211â”Š    );\n+â”Š   â”Š212â”Š\n+â”Š   â”Š213â”Š    await wait(() =>\n+â”Š   â”Š214â”Š      expect(passwordConfirmInput.value).toEqual('password')\n+â”Š   â”Š215â”Š    );\n+â”Š   â”Š216â”Š\n+â”Š   â”Š217â”Š    act(() => {\n+â”Š   â”Š218â”Š      fireEvent.click(signUpButton);\n+â”Š   â”Š219â”Š    });\n+â”Š   â”Š220â”Š\n+â”Š   â”Š221â”Š    await wait(() =>\n+â”Š   â”Š222â”Š      expect(history.location.pathname).toEqual('/sign-in')\n+â”Š   â”Š223â”Š    );\n+â”Š   â”Š224â”Š  });\n+â”Š   â”Š225â”Š});ðŸš«â†µ\n```\n\n##### Added src&#x2F;components&#x2F;AuthScreen&#x2F;SignUpForm.tsx\n```diff\n@@ -0,0 +1,124 @@\n+â”Š   â”Š  1â”Šimport React from 'react';\n+â”Š   â”Š  2â”Šimport { useCallback, useState } from 'react';\n+â”Š   â”Š  3â”Šimport { useSignUp } from '../../services/auth.service';\n+â”Š   â”Š  4â”Šimport {\n+â”Š   â”Š  5â”Š  SignForm,\n+â”Š   â”Š  6â”Š  ActualForm,\n+â”Š   â”Š  7â”Š  Legend,\n+â”Š   â”Š  8â”Š  Section,\n+â”Š   â”Š  9â”Š  TextField,\n+â”Š   â”Š 10â”Š  Button,\n+â”Š   â”Š 11â”Š  ErrorMessage,\n+â”Š   â”Š 12â”Š} from './form-components';\n+â”Š   â”Š 13â”Šimport { RouteComponentProps } from 'react-router-dom';\n+â”Š   â”Š 14â”Š\n+â”Š   â”Š 15â”Šconst SignUpForm: React.FC<RouteComponentProps<any>> = ({ history }) => {\n+â”Š   â”Š 16â”Š  const [name, setName] = useState('');\n+â”Š   â”Š 17â”Š  const [username, setUsername] = useState('');\n+â”Š   â”Š 18â”Š  const [password, setPassword] = useState('');\n+â”Š   â”Š 19â”Š  const [passwordConfirm, setPasswordConfirm] = useState('');\n+â”Š   â”Š 20â”Š  const [error, setError] = useState('');\n+â”Š   â”Š 21â”Š  const [signUp] = useSignUp()\n+â”Š   â”Š 22â”Š\n+â”Š   â”Š 23â”Š  const updateName = useCallback(({ target }) => {\n+â”Š   â”Š 24â”Š    setError('');\n+â”Š   â”Š 25â”Š    setName(target.value);\n+â”Š   â”Š 26â”Š  }, []);\n+â”Š   â”Š 27â”Š\n+â”Š   â”Š 28â”Š  const updateUsername = useCallback(({ target }) => {\n+â”Š   â”Š 29â”Š    setError('');\n+â”Š   â”Š 30â”Š    setUsername(target.value);\n+â”Š   â”Š 31â”Š  }, []);\n+â”Š   â”Š 32â”Š\n+â”Š   â”Š 33â”Š  const updatePassword = useCallback(({ target }) => {\n+â”Š   â”Š 34â”Š    setError('');\n+â”Š   â”Š 35â”Š    setPassword(target.value);\n+â”Š   â”Š 36â”Š  }, []);\n+â”Š   â”Š 37â”Š\n+â”Š   â”Š 38â”Š  const updatePasswordConfirm = useCallback(({ target }) => {\n+â”Š   â”Š 39â”Š    setError('');\n+â”Š   â”Š 40â”Š    setPasswordConfirm(target.value);\n+â”Š   â”Š 41â”Š  }, []);\n+â”Š   â”Š 42â”Š\n+â”Š   â”Š 43â”Š  const maySignUp = useCallback(() => {\n+â”Š   â”Š 44â”Š    return !!(name && username && password && password === passwordConfirm);\n+â”Š   â”Š 45â”Š  }, [name, username, password, passwordConfirm]);\n+â”Š   â”Š 46â”Š\n+â”Š   â”Š 47â”Š  const handleSignUp = useCallback(() => {\n+â”Š   â”Š 48â”Š    signUp({ variables: { username, password, passwordConfirm, name } })\n+â”Š   â”Š 49â”Š      .then(() => {\n+â”Š   â”Š 50â”Š        history.replace('/sign-in');\n+â”Š   â”Š 51â”Š      })\n+â”Š   â”Š 52â”Š      .catch(error => {\n+â”Š   â”Š 53â”Š        setError(error.message || error);\n+â”Š   â”Š 54â”Š      });\n+â”Š   â”Š 55â”Š  }, [name, username, password, passwordConfirm, history, signUp]);\n+â”Š   â”Š 56â”Š\n+â”Š   â”Š 57â”Š  return (\n+â”Š   â”Š 58â”Š    <SignForm>\n+â”Š   â”Š 59â”Š      <ActualForm>\n+â”Š   â”Š 60â”Š        <Legend>Sign up</Legend>\n+â”Š   â”Š 61â”Š        <Section\n+â”Š   â”Š 62â”Š          style={{\n+â”Š   â”Š 63â”Š            float: 'left',\n+â”Š   â”Š 64â”Š            width: 'calc(50% - 10px)',\n+â”Š   â”Š 65â”Š            paddingRight: '10px',\n+â”Š   â”Š 66â”Š          }}>\n+â”Š   â”Š 67â”Š          <TextField\n+â”Š   â”Š 68â”Š            data-testid=\"name-input\"\n+â”Š   â”Š 69â”Š            label=\"Name\"\n+â”Š   â”Š 70â”Š            value={name}\n+â”Š   â”Š 71â”Š            onChange={updateName}\n+â”Š   â”Š 72â”Š            autoComplete=\"off\"\n+â”Š   â”Š 73â”Š            margin=\"normal\"\n+â”Š   â”Š 74â”Š          />\n+â”Š   â”Š 75â”Š          <TextField\n+â”Š   â”Š 76â”Š            data-testid=\"username-input\"\n+â”Š   â”Š 77â”Š            label=\"Username\"\n+â”Š   â”Š 78â”Š            value={username}\n+â”Š   â”Š 79â”Š            onChange={updateUsername}\n+â”Š   â”Š 80â”Š            autoComplete=\"off\"\n+â”Š   â”Š 81â”Š            margin=\"normal\"\n+â”Š   â”Š 82â”Š          />\n+â”Š   â”Š 83â”Š        </Section>\n+â”Š   â”Š 84â”Š        <Section\n+â”Š   â”Š 85â”Š          style={{\n+â”Š   â”Š 86â”Š            float: 'right',\n+â”Š   â”Š 87â”Š            width: 'calc(50% - 10px)',\n+â”Š   â”Š 88â”Š            paddingLeft: '10px',\n+â”Š   â”Š 89â”Š          }}>\n+â”Š   â”Š 90â”Š          <TextField\n+â”Š   â”Š 91â”Š            data-testid=\"password-input\"\n+â”Š   â”Š 92â”Š            label=\"Password\"\n+â”Š   â”Š 93â”Š            type=\"password\"\n+â”Š   â”Š 94â”Š            value={password}\n+â”Š   â”Š 95â”Š            onChange={updatePassword}\n+â”Š   â”Š 96â”Š            autoComplete=\"off\"\n+â”Š   â”Š 97â”Š            margin=\"normal\"\n+â”Š   â”Š 98â”Š          />\n+â”Š   â”Š 99â”Š          <TextField\n+â”Š   â”Š100â”Š            data-testid=\"password-confirm-input\"\n+â”Š   â”Š101â”Š            label=\"Confirm password\"\n+â”Š   â”Š102â”Š            type=\"password\"\n+â”Š   â”Š103â”Š            value={passwordConfirm}\n+â”Š   â”Š104â”Š            onChange={updatePasswordConfirm}\n+â”Š   â”Š105â”Š            autoComplete=\"off\"\n+â”Š   â”Š106â”Š            margin=\"normal\"\n+â”Š   â”Š107â”Š          />\n+â”Š   â”Š108â”Š        </Section>\n+â”Š   â”Š109â”Š        <Button\n+â”Š   â”Š110â”Š          data-testid=\"sign-up-button\"\n+â”Š   â”Š111â”Š          type=\"button\"\n+â”Š   â”Š112â”Š          color=\"secondary\"\n+â”Š   â”Š113â”Š          variant=\"contained\"\n+â”Š   â”Š114â”Š          disabled={!maySignUp()}\n+â”Š   â”Š115â”Š          onClick={handleSignUp}>\n+â”Š   â”Š116â”Š          Sign up\n+â”Š   â”Š117â”Š        </Button>\n+â”Š   â”Š118â”Š        <ErrorMessage data-testid=\"error-message\">{error}</ErrorMessage>\n+â”Š   â”Š119â”Š      </ActualForm>\n+â”Š   â”Š120â”Š    </SignForm>\n+â”Š   â”Š121â”Š  );\n+â”Š   â”Š122â”Š};\n+â”Š   â”Š123â”Š\n+â”Š   â”Š124â”Šexport default SignUpForm;\n```\n\n##### Added src&#x2F;components&#x2F;AuthScreen&#x2F;form-components.ts\n```diff\n@@ -0,0 +1,75 @@\n+â”Š  â”Š 1â”Šimport MaterialButton from '@material-ui/core/Button';\n+â”Š  â”Š 2â”Šimport MaterialTextField from '@material-ui/core/TextField';\n+â”Š  â”Š 3â”Šimport styled from 'styled-components';\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šexport const SignForm = styled.div`\n+â”Š  â”Š 6â”Š  height: calc(100% - 265px);\n+â”Š  â”Š 7â”Š`;\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Šexport const ActualForm = styled.form`\n+â”Š  â”Š10â”Š  padding: 20px;\n+â”Š  â”Š11â”Š`;\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Šexport const Section = styled.div`\n+â”Š  â”Š14â”Š  padding-bottom: 35px;\n+â”Š  â”Š15â”Š`;\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Šexport const Legend = styled.legend`\n+â”Š  â”Š18â”Š  font-weight: bold;\n+â”Š  â”Š19â”Š  color: white;\n+â”Š  â”Š20â”Š`;\n+â”Š  â”Š21â”Š\n+â”Š  â”Š22â”Šexport const Label = styled.label`\n+â”Š  â”Š23â”Š  color: white !important;\n+â”Š  â”Š24â”Š`;\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Šexport const Input = styled.input`\n+â”Š  â”Š27â”Š  color: white;\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š  &::placeholder {\n+â”Š  â”Š30â”Š    color: var(--primary-bg);\n+â”Š  â”Š31â”Š  }\n+â”Š  â”Š32â”Š`;\n+â”Š  â”Š33â”Š\n+â”Š  â”Š34â”Šexport const TextField = styled(MaterialTextField)`\n+â”Š  â”Š35â”Š  width: 100%;\n+â”Š  â”Š36â”Š  position: relative;\n+â”Š  â”Š37â”Š\n+â”Š  â”Š38â”Š  > div::before {\n+â”Š  â”Š39â”Š    border-color: white !important;\n+â”Š  â”Š40â”Š  }\n+â”Š  â”Š41â”Š\n+â”Š  â”Š42â”Š  input {\n+â”Š  â”Š43â”Š    color: white !important;\n+â”Š  â”Š44â”Š\n+â”Š  â”Š45â”Š    &::placeholder {\n+â”Š  â”Š46â”Š      color: var(--primary-bg) !important;\n+â”Š  â”Š47â”Š    }\n+â”Š  â”Š48â”Š  }\n+â”Š  â”Š49â”Š\n+â”Š  â”Š50â”Š  label {\n+â”Š  â”Š51â”Š    color: white !important;\n+â”Š  â”Š52â”Š  }\n+â”Š  â”Š53â”Š`;\n+â”Š  â”Š54â”Š\n+â”Š  â”Š55â”Šexport const Button = styled(MaterialButton)`\n+â”Š  â”Š56â”Š  width: 100px;\n+â”Š  â”Š57â”Š  display: block !important;\n+â”Š  â”Š58â”Š  margin: auto !important;\n+â”Š  â”Š59â”Š  background-color: var(--secondary-bg) !important;\n+â”Š  â”Š60â”Š\n+â”Š  â”Š61â”Š  &[disabled] {\n+â”Š  â”Š62â”Š    color: #38a81c;\n+â”Š  â”Š63â”Š  }\n+â”Š  â”Š64â”Š\n+â”Š  â”Š65â”Š  &:not([disabled]) {\n+â”Š  â”Š66â”Š    color: white;\n+â”Š  â”Š67â”Š  }\n+â”Š  â”Š68â”Š`;\n+â”Š  â”Š69â”Š\n+â”Š  â”Š70â”Šexport const ErrorMessage = styled.div`\n+â”Š  â”Š71â”Š  position: fixed;\n+â”Š  â”Š72â”Š  color: red;\n+â”Š  â”Š73â”Š  font-size: 15px;\n+â”Š  â”Š74â”Š  margin-top: 20px;\n+â”Š  â”Š75â”Š`;\n```\n\n##### Changed src&#x2F;components&#x2F;AuthScreen&#x2F;index.tsx\n```diff\n@@ -1,13 +1,13 @@\n-â”Š 1â”Š  â”Šimport MaterialButton from '@material-ui/core/Button';\n-â”Š 2â”Š  â”Šimport MaterialTextField from '@material-ui/core/TextField';\n â”Š 3â”Š 1â”Šimport React from 'react';\n-â”Š 4â”Š  â”Šimport { useCallback, useState } from 'react';\n+â”Š  â”Š 2â”Šimport { useMemo } from 'react';\n+â”Š  â”Š 3â”Šimport { Route } from 'react-router-dom';\n â”Š 5â”Š 4â”Šimport styled from 'styled-components';\n-â”Š 6â”Š  â”Šimport { useSignIn } from '../../services/auth.service';\n+â”Š  â”Š 5â”Šimport AnimatedSwitch from '../AnimatedSwitch';\n+â”Š  â”Š 6â”Šimport SignInForm from './SignInForm';\n+â”Š  â”Š 7â”Šimport SignUpForm from './SignUpForm';\n â”Š 7â”Š 8â”Šimport { RouteComponentProps } from 'react-router-dom';\n â”Š 8â”Š 9â”Š\n â”Š 9â”Š10â”Šconst Container = styled.div`\n-â”Š10â”Š  â”Š  height: 100%;\n â”Š11â”Š11â”Š  background: radial-gradient(rgb(34, 65, 67), rgb(17, 48, 50)),\n â”Š12â”Š12â”Š    url(/assets/chat-background.jpg) no-repeat;\n â”Š13â”Š13â”Š  background-size: cover;\n```\n```diff\n@@ -40,149 +40,51 @@\n â”Š 40â”Š 40â”Š  bottom: 10px;\n â”Š 41â”Š 41â”Š  left: 10px;\n â”Š 42â”Š 42â”Š\n-â”Š 43â”Š   â”Š  a {\n+â”Š   â”Š 43â”Š  label {\n â”Š 44â”Š 44â”Š    color: var(--secondary-bg);\n â”Š 45â”Š 45â”Š  }\n â”Š 46â”Š 46â”Š`;\n â”Š 47â”Š 47â”Š\n-â”Š 48â”Š   â”Šconst SignInForm = styled.div`\n-â”Š 49â”Š   â”Š  height: calc(100% - 265px);\n-â”Š 50â”Š   â”Š`;\n-â”Š 51â”Š   â”Š\n-â”Š 52â”Š   â”Šconst ActualForm = styled.form`\n-â”Š 53â”Š   â”Š  padding: 20px;\n-â”Š 54â”Š   â”Š`;\n-â”Š 55â”Š   â”Š\n-â”Š 56â”Š   â”Šconst Section = styled.div`\n-â”Š 57â”Š   â”Š  width: 100%;\n-â”Š 58â”Š   â”Š  padding-bottom: 35px;\n-â”Š 59â”Š   â”Š`;\n-â”Š 60â”Š   â”Š\n-â”Š 61â”Š   â”Šconst Legend = styled.legend`\n-â”Š 62â”Š   â”Š  font-weight: bold;\n-â”Š 63â”Š   â”Š  color: white;\n-â”Š 64â”Š   â”Š`;\n-â”Š 65â”Š   â”Š\n-â”Š 66â”Š   â”Š// eslint-disable-next-line\n-â”Š 67â”Š   â”Šconst Label = styled.label`\n-â”Š 68â”Š   â”Š  color: white !important;\n-â”Š 69â”Š   â”Š`;\n-â”Š 70â”Š   â”Š\n-â”Š 71â”Š   â”Š// eslint-disable-next-line\n-â”Š 72â”Š   â”Šconst Input = styled.input`\n-â”Š 73â”Š   â”Š  color: white;\n-â”Š 74â”Š   â”Š\n-â”Š 75â”Š   â”Š  &::placeholder {\n-â”Š 76â”Š   â”Š    color: var(--primary-bg);\n-â”Š 77â”Š   â”Š  }\n-â”Š 78â”Š   â”Š`;\n-â”Š 79â”Š   â”Š\n-â”Š 80â”Š   â”Šconst TextField = styled(MaterialTextField)`\n-â”Š 81â”Š   â”Š  width: 100%;\n-â”Š 82â”Š   â”Š  position: relative;\n-â”Š 83â”Š   â”Š\n-â”Š 84â”Š   â”Š  > div::before {\n-â”Š 85â”Š   â”Š    border-color: white !important;\n-â”Š 86â”Š   â”Š  }\n-â”Š 87â”Š   â”Š\n-â”Š 88â”Š   â”Š  input {\n-â”Š 89â”Š   â”Š    color: white !important;\n-â”Š 90â”Š   â”Š\n-â”Š 91â”Š   â”Š    &::placeholder {\n-â”Š 92â”Š   â”Š      color: var(--primary-bg) !important;\n+â”Š   â”Š 48â”Šconst AuthScreen: React.FC<RouteComponentProps<any>> = ({\n+â”Š   â”Š 49â”Š  history,\n+â”Š   â”Š 50â”Š  location,\n+â”Š   â”Š 51â”Š}) => {\n+â”Š   â”Š 52â”Š  const alternative = useMemo(() => {\n+â”Š   â”Š 53â”Š    if (location.pathname === '/sign-in') {\n+â”Š   â”Š 54â”Š      const handleSignUp = () => {\n+â”Š   â”Š 55â”Š        history.replace('/sign-up');\n+â”Š   â”Š 56â”Š      };\n+â”Š   â”Š 57â”Š\n+â”Š   â”Š 58â”Š      return (\n+â”Š   â”Š 59â”Š        <Alternative>\n+â”Š   â”Š 60â”Š          Don't have an account yet?{' '}\n+â”Š   â”Š 61â”Š          <label onClick={handleSignUp}>Sign up!</label>\n+â”Š   â”Š 62â”Š        </Alternative>\n+â”Š   â”Š 63â”Š      );\n+â”Š   â”Š 64â”Š    } else {\n+â”Š   â”Š 65â”Š      const handleSignIn = () => {\n+â”Š   â”Š 66â”Š        history.replace('/sign-in');\n+â”Š   â”Š 67â”Š      };\n+â”Š   â”Š 68â”Š\n+â”Š   â”Š 69â”Š      return (\n+â”Š   â”Š 70â”Š        <Alternative>\n+â”Š   â”Š 71â”Š          Already have an accout? <label onClick={handleSignIn}>Sign in!</label>\n+â”Š   â”Š 72â”Š        </Alternative>\n+â”Š   â”Š 73â”Š      );\n â”Š 93â”Š 74â”Š    }\n-â”Š 94â”Š   â”Š  }\n-â”Š 95â”Š   â”Š\n-â”Š 96â”Š   â”Š  label {\n-â”Š 97â”Š   â”Š    color: white !important;\n-â”Š 98â”Š   â”Š  }\n-â”Š 99â”Š   â”Š`;\n-â”Š100â”Š   â”Š\n-â”Š101â”Š   â”Šconst Button = styled(MaterialButton)`\n-â”Š102â”Š   â”Š  width: 100px;\n-â”Š103â”Š   â”Š  display: block !important;\n-â”Š104â”Š   â”Š  margin: auto !important;\n-â”Š105â”Š   â”Š  background-color: var(--secondary-bg) !important;\n-â”Š106â”Š   â”Š\n-â”Š107â”Š   â”Š  &[disabled] {\n-â”Š108â”Š   â”Š    color: #38a81c;\n-â”Š109â”Š   â”Š  }\n-â”Š110â”Š   â”Š\n-â”Š111â”Š   â”Š  &:not([disabled]) {\n-â”Š112â”Š   â”Š    color: white;\n-â”Š113â”Š   â”Š  }\n-â”Š114â”Š   â”Š`;\n-â”Š115â”Š   â”Š\n-â”Š116â”Š   â”Šconst AuthScreen: React.FC<RouteComponentProps<any>> = ({ history }) => {\n-â”Š117â”Š   â”Š  const [username, setUsername] = useState('');\n-â”Š118â”Š   â”Š  const [password, setPassword] = useState('');\n-â”Š119â”Š   â”Š  // eslint-disable-next-line\n-â”Š120â”Š   â”Š  const [error, setError] = useState('');\n-â”Š121â”Š   â”Š  const [signIn] = useSignIn();\n-â”Š122â”Š   â”Š\n-â”Š123â”Š   â”Š  const onUsernameChange = useCallback(({ target }) => {\n-â”Š124â”Š   â”Š    setError('');\n-â”Š125â”Š   â”Š    setUsername(target.value);\n-â”Š126â”Š   â”Š  }, []);\n-â”Š127â”Š   â”Š\n-â”Š128â”Š   â”Š  const onPasswordChange = useCallback(({ target }) => {\n-â”Š129â”Š   â”Š    setError('');\n-â”Š130â”Š   â”Š    setPassword(target.value);\n-â”Š131â”Š   â”Š  }, []);\n-â”Š132â”Š   â”Š\n-â”Š133â”Š   â”Š  const maySignIn = useCallback(() => {\n-â”Š134â”Š   â”Š    return !!(username && password);\n-â”Š135â”Š   â”Š  }, [username, password]);\n-â”Š136â”Š   â”Š\n-â”Š137â”Š   â”Š  const handleSignIn = useCallback(() => {\n-â”Š138â”Š   â”Š    signIn({ variables: { username, password } })\n-â”Š139â”Š   â”Š      .then(() => {\n-â”Š140â”Š   â”Š        history.push('/chats');\n-â”Š141â”Š   â”Š      })\n-â”Š142â”Š   â”Š      .catch(error => {\n-â”Š143â”Š   â”Š        setError(error.message || error);\n-â”Š144â”Š   â”Š      });\n-â”Š145â”Š   â”Š  }, [username, password, history, signIn]);\n+â”Š   â”Š 75â”Š  }, [location.pathname, history]);\n â”Š146â”Š 76â”Š\n â”Š147â”Š 77â”Š  return (\n-â”Š148â”Š   â”Š    <Container>\n-â”Š149â”Š   â”Š      <Intro>\n+â”Š   â”Š 78â”Š    <Container className=\"AuthScreen Screen\">\n+â”Š   â”Š 79â”Š      <Intro className=\"AuthScreen-intro\">\n â”Š150â”Š 80â”Š        <Icon src=\"assets/whatsapp-icon.png\" className=\"AuthScreen-icon\" />\n â”Š151â”Š 81â”Š        <Title className=\"AuthScreen-title\">WhatsApp</Title>\n â”Š152â”Š 82â”Š      </Intro>\n-â”Š153â”Š   â”Š      <SignInForm>\n-â”Š154â”Š   â”Š        <ActualForm>\n-â”Š155â”Š   â”Š          <Legend>Sign in</Legend>\n-â”Š156â”Š   â”Š          <Section>\n-â”Š157â”Š   â”Š            <TextField\n-â”Š158â”Š   â”Š              className=\"AuthScreen-text-field\"\n-â”Š159â”Š   â”Š              label=\"Username\"\n-â”Š160â”Š   â”Š              value={username}\n-â”Š161â”Š   â”Š              onChange={onUsernameChange}\n-â”Š162â”Š   â”Š              margin=\"normal\"\n-â”Š163â”Š   â”Š              placeholder=\"Enter your username\"\n-â”Š164â”Š   â”Š            />\n-â”Š165â”Š   â”Š            <TextField\n-â”Š166â”Š   â”Š              className=\"AuthScreen-text-field\"\n-â”Š167â”Š   â”Š              label=\"Password\"\n-â”Š168â”Š   â”Š              type=\"password\"\n-â”Š169â”Š   â”Š              value={password}\n-â”Š170â”Š   â”Š              onChange={onPasswordChange}\n-â”Š171â”Š   â”Š              margin=\"normal\"\n-â”Š172â”Š   â”Š              placeholder=\"Enter your password\"\n-â”Š173â”Š   â”Š            />\n-â”Š174â”Š   â”Š          </Section>\n-â”Š175â”Š   â”Š          <Button\n-â”Š176â”Š   â”Š            data-testid=\"sign-in-button\"\n-â”Š177â”Š   â”Š            type=\"button\"\n-â”Š178â”Š   â”Š            color=\"secondary\"\n-â”Š179â”Š   â”Š            variant=\"contained\"\n-â”Š180â”Š   â”Š            disabled={!maySignIn()}\n-â”Š181â”Š   â”Š            onClick={handleSignIn}>\n-â”Š182â”Š   â”Š            Sign in\n-â”Š183â”Š   â”Š          </Button>\n-â”Š184â”Š   â”Š        </ActualForm>\n-â”Š185â”Š   â”Š      </SignInForm>\n+â”Š   â”Š 83â”Š      <AnimatedSwitch>\n+â”Š   â”Š 84â”Š        <Route exact path=\"/sign-in\" component={SignInForm} />\n+â”Š   â”Š 85â”Š        <Route exact path=\"/sign-up\" component={SignUpForm} />\n+â”Š   â”Š 86â”Š      </AnimatedSwitch>\n+â”Š   â”Š 87â”Š      {alternative}\n â”Š186â”Š 88â”Š    </Container>\n â”Š187â”Š 89â”Š  );\n â”Š188â”Š 90â”Š};\n```\n\n[}]: #\n\nAnd then we will make the necessary changes in the `AuthScreen`:\n\n[{]: <helper> (diffStep 13.6 module=\"client\")\n\n#### [__Client__ Step 13.6: Split AuthScreen into SignInForm and SignUpForm](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/37ed707e175aa1b70bc720633c93e815e768a740)\n\n##### Added src&#x2F;components&#x2F;AuthScreen&#x2F;SignInForm.test.tsx\n```diff\n@@ -0,0 +1,163 @@\n+â”Š   â”Š  1â”Šimport { createMemoryHistory } from 'history';\n+â”Š   â”Š  2â”Šimport React from 'react';\n+â”Š   â”Š  3â”Šimport { ApolloProvider } from '@apollo/react-hooks';\n+â”Š   â”Š  4â”Šimport { act, cleanup, render, fireEvent, wait, waitForElement } from '@testing-library/react';\n+â”Š   â”Š  5â”Šimport SignInForm from './SignInForm';\n+â”Š   â”Š  6â”Šimport { SignInDocument } from '../../graphql/types';\n+â”Š   â”Š  7â”Šimport { mockApolloClient } from '../../test-helpers';\n+â”Š   â”Š  8â”Š\n+â”Š   â”Š  9â”Šdescribe('SignInForm', () => {\n+â”Š   â”Š 10â”Š  afterEach(cleanup);\n+â”Š   â”Š 11â”Š\n+â”Š   â”Š 12â”Š  it('enables sign-in button when filled in', async () => {\n+â”Š   â”Š 13â”Š    const history = createMemoryHistory();\n+â”Š   â”Š 14â”Š    const client = mockApolloClient();\n+â”Š   â”Š 15â”Š\n+â”Š   â”Š 16â”Š    let getByTestId: any = null;\n+â”Š   â”Š 17â”Š\n+â”Š   â”Š 18â”Š    act(() => {\n+â”Š   â”Š 19â”Š      getByTestId = render(\n+â”Š   â”Š 20â”Š        <ApolloProvider client={client}>\n+â”Š   â”Š 21â”Š          <SignInForm history={history} />\n+â”Š   â”Š 22â”Š        </ApolloProvider>\n+â”Š   â”Š 23â”Š      ).getByTestId;\n+â”Š   â”Š 24â”Š    });\n+â”Š   â”Š 25â”Š\n+â”Š   â”Š 26â”Š    const signInButton = await waitForElement(() =>\n+â”Š   â”Š 27â”Š      getByTestId('sign-in-button') as HTMLButtonElement\n+â”Š   â”Š 28â”Š    );\n+â”Š   â”Š 29â”Š    const usernameInput = await waitForElement(() =>\n+â”Š   â”Š 30â”Š      getByTestId('username-input').querySelector('input')\n+â”Š   â”Š 31â”Š    );\n+â”Š   â”Š 32â”Š    const passwordInput = await waitForElement(() =>\n+â”Š   â”Š 33â”Š      getByTestId('password-input').querySelector('input')\n+â”Š   â”Š 34â”Š    );\n+â”Š   â”Š 35â”Š\n+â”Š   â”Š 36â”Š    expect(signInButton.disabled).toEqual(true);\n+â”Š   â”Š 37â”Š\n+â”Š   â”Š 38â”Š    act(() => {\n+â”Š   â”Š 39â”Š      fireEvent.change(usernameInput, { target: { value: 'username' } });\n+â”Š   â”Š 40â”Š      fireEvent.change(passwordInput, { target: { value: 'password' } });\n+â”Š   â”Š 41â”Š    });\n+â”Š   â”Š 42â”Š\n+â”Š   â”Š 43â”Š    await wait(() =>\n+â”Š   â”Š 44â”Š      expect(signInButton.disabled).toEqual(false)\n+â”Š   â”Š 45â”Š    )\n+â”Š   â”Š 46â”Š  });\n+â”Š   â”Š 47â”Š\n+â”Š   â”Š 48â”Š  it('prints server error if input was wrong', async () => {\n+â”Š   â”Š 49â”Š    const history = createMemoryHistory();\n+â”Š   â”Š 50â”Š\n+â”Š   â”Š 51â”Š    const client = mockApolloClient([\n+â”Š   â”Š 52â”Š      {\n+â”Š   â”Š 53â”Š        request: {\n+â”Š   â”Š 54â”Š          query: SignInDocument,\n+â”Š   â”Š 55â”Š          variables: {\n+â”Š   â”Š 56â”Š            username: 'username',\n+â”Š   â”Š 57â”Š            password: 'password'\n+â”Š   â”Š 58â”Š          }\n+â”Š   â”Š 59â”Š        },\n+â”Š   â”Š 60â”Š        get result() { throw Error('sign-in failed') },\n+â”Š   â”Š 61â”Š      }\n+â”Š   â”Š 62â”Š    ]);\n+â”Š   â”Š 63â”Š\n+â”Š   â”Š 64â”Š    let getByTestId: any = null;\n+â”Š   â”Š 65â”Š\n+â”Š   â”Š 66â”Š    act(() => {\n+â”Š   â”Š 67â”Š      getByTestId = render(\n+â”Š   â”Š 68â”Š        <ApolloProvider client={client}>\n+â”Š   â”Š 69â”Š          <SignInForm history={history} />\n+â”Š   â”Š 70â”Š        </ApolloProvider>\n+â”Š   â”Š 71â”Š      ).getByTestId;\n+â”Š   â”Š 72â”Š    });\n+â”Š   â”Š 73â”Š\n+â”Š   â”Š 74â”Š    const signInButton = await waitForElement(() =>\n+â”Š   â”Š 75â”Š      getByTestId('sign-in-button') as HTMLButtonElement\n+â”Š   â”Š 76â”Š    );\n+â”Š   â”Š 77â”Š    const usernameInput = await waitForElement(() =>\n+â”Š   â”Š 78â”Š      getByTestId('username-input').querySelector('input')\n+â”Š   â”Š 79â”Š    );\n+â”Š   â”Š 80â”Š    const passwordInput = await waitForElement(() =>\n+â”Š   â”Š 81â”Š      getByTestId('password-input').querySelector('input')\n+â”Š   â”Š 82â”Š    );\n+â”Š   â”Š 83â”Š\n+â”Š   â”Š 84â”Š    act(() => {\n+â”Š   â”Š 85â”Š      fireEvent.change(usernameInput, { target: { value: 'username' } });\n+â”Š   â”Š 86â”Š      fireEvent.change(passwordInput, { target: { value: 'password' } });\n+â”Š   â”Š 87â”Š    });\n+â”Š   â”Š 88â”Š\n+â”Š   â”Š 89â”Š    await wait(() =>\n+â”Š   â”Š 90â”Š      expect(usernameInput.value).toEqual('username')\n+â”Š   â”Š 91â”Š    );\n+â”Š   â”Š 92â”Š\n+â”Š   â”Š 93â”Š    await wait(() =>\n+â”Š   â”Š 94â”Š      expect(passwordInput.value).toEqual('password')\n+â”Š   â”Š 95â”Š    );\n+â”Š   â”Š 96â”Š\n+â”Š   â”Š 97â”Š    act(() => {\n+â”Š   â”Š 98â”Š      fireEvent.click(signInButton);\n+â”Š   â”Š 99â”Š    });\n+â”Š   â”Š100â”Š\n+â”Š   â”Š101â”Š    const errorMessage = await waitForElement(() =>\n+â”Š   â”Š102â”Š      getByTestId('error-message')\n+â”Š   â”Š103â”Š    );\n+â”Š   â”Š104â”Š\n+â”Š   â”Š105â”Š    await wait(() => expect(errorMessage.innerHTML).toContain('sign-in failed'));\n+â”Š   â”Š106â”Š  });\n+â”Š   â”Š107â”Š\n+â”Š   â”Š108â”Š  it('navigates to /chats if everything went right', async () => {\n+â”Š   â”Š109â”Š    const history = createMemoryHistory();\n+â”Š   â”Š110â”Š\n+â”Š   â”Š111â”Š    const client = mockApolloClient([\n+â”Š   â”Š112â”Š      {\n+â”Š   â”Š113â”Š        request: {\n+â”Š   â”Š114â”Š          query: SignInDocument,\n+â”Š   â”Š115â”Š          variables: {\n+â”Š   â”Š116â”Š            username: 'username',\n+â”Š   â”Š117â”Š            password: 'password'\n+â”Š   â”Š118â”Š          }\n+â”Š   â”Š119â”Š        },\n+â”Š   â”Š120â”Š        result: { data: {} }\n+â”Š   â”Š121â”Š      }\n+â”Š   â”Š122â”Š    ]);\n+â”Š   â”Š123â”Š\n+â”Š   â”Š124â”Š    let getByTestId: any = null;\n+â”Š   â”Š125â”Š\n+â”Š   â”Š126â”Š    act(() => {\n+â”Š   â”Š127â”Š      getByTestId = render(\n+â”Š   â”Š128â”Š        <ApolloProvider client={client}>\n+â”Š   â”Š129â”Š          <SignInForm history={history} />\n+â”Š   â”Š130â”Š        </ApolloProvider>\n+â”Š   â”Š131â”Š      ).getByTestId;\n+â”Š   â”Š132â”Š    })\n+â”Š   â”Š133â”Š\n+â”Š   â”Š134â”Š    const usernameInput = await waitForElement(() =>\n+â”Š   â”Š135â”Š      getByTestId('username-input').querySelector('input')\n+â”Š   â”Š136â”Š    );\n+â”Š   â”Š137â”Š    const passwordInput = await waitForElement(() =>\n+â”Š   â”Š138â”Š      getByTestId('password-input').querySelector('input')\n+â”Š   â”Š139â”Š    );\n+â”Š   â”Š140â”Š    const signInButton = await waitForElement(() =>\n+â”Š   â”Š141â”Š      getByTestId('sign-in-button') as HTMLButtonElement\n+â”Š   â”Š142â”Š    );\n+â”Š   â”Š143â”Š\n+â”Š   â”Š144â”Š    act(() => {\n+â”Š   â”Š145â”Š      fireEvent.change(usernameInput, { target: { value: 'username' } });\n+â”Š   â”Š146â”Š      fireEvent.change(passwordInput, { target: { value: 'password' } });\n+â”Š   â”Š147â”Š    });\n+â”Š   â”Š148â”Š\n+â”Š   â”Š149â”Š    await wait(() =>\n+â”Š   â”Š150â”Š      expect(usernameInput.value).toEqual('username')\n+â”Š   â”Š151â”Š    );\n+â”Š   â”Š152â”Š\n+â”Š   â”Š153â”Š    await wait(() =>\n+â”Š   â”Š154â”Š      expect(passwordInput.value).toEqual('password')\n+â”Š   â”Š155â”Š    );\n+â”Š   â”Š156â”Š\n+â”Š   â”Š157â”Š    act(() => {\n+â”Š   â”Š158â”Š      fireEvent.click(signInButton);\n+â”Š   â”Š159â”Š    });\n+â”Š   â”Š160â”Š\n+â”Š   â”Š161â”Š    await wait(() => expect(history.location.pathname).toEqual('/chats'));\n+â”Š   â”Š162â”Š  });\n+â”Š   â”Š163â”Š});ðŸš«â†µ\n```\n\n##### Added src&#x2F;components&#x2F;AuthScreen&#x2F;SignInForm.tsx\n```diff\n@@ -0,0 +1,83 @@\n+â”Š  â”Š 1â”Šimport React from 'react';\n+â”Š  â”Š 2â”Šimport { useCallback, useState } from 'react';\n+â”Š  â”Š 3â”Šimport { useSignIn } from '../../services/auth.service';\n+â”Š  â”Š 4â”Šimport {\n+â”Š  â”Š 5â”Š  SignForm,\n+â”Š  â”Š 6â”Š  ActualForm,\n+â”Š  â”Š 7â”Š  Legend,\n+â”Š  â”Š 8â”Š  Section,\n+â”Š  â”Š 9â”Š  TextField,\n+â”Š  â”Š10â”Š  Button,\n+â”Š  â”Š11â”Š  ErrorMessage,\n+â”Š  â”Š12â”Š} from './form-components';\n+â”Š  â”Š13â”Šimport { RouteComponentProps } from 'react-router-dom';\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”Šconst SignInForm: React.FC<RouteComponentProps<any>> = ({ history }) => {\n+â”Š  â”Š16â”Š  const [username, setUsername] = useState('');\n+â”Š  â”Š17â”Š  const [password, setPassword] = useState('');\n+â”Š  â”Š18â”Š  const [error, setError] = useState('');\n+â”Š  â”Š19â”Š  const [signIn] = useSignIn();\n+â”Š  â”Š20â”Š\n+â”Š  â”Š21â”Š  const onUsernameChange = useCallback(({ target }) => {\n+â”Š  â”Š22â”Š    setError('');\n+â”Š  â”Š23â”Š    setUsername(target.value);\n+â”Š  â”Š24â”Š  }, []);\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Š  const onPasswordChange = useCallback(({ target }) => {\n+â”Š  â”Š27â”Š    setError('');\n+â”Š  â”Š28â”Š    setPassword(target.value);\n+â”Š  â”Š29â”Š  }, []);\n+â”Š  â”Š30â”Š\n+â”Š  â”Š31â”Š  const maySignIn = useCallback(() => {\n+â”Š  â”Š32â”Š    return !!(username && password);\n+â”Š  â”Š33â”Š  }, [username, password]);\n+â”Š  â”Š34â”Š\n+â”Š  â”Š35â”Š  const handleSignIn = useCallback(() => {\n+â”Š  â”Š36â”Š    signIn({ variables: { username, password } })\n+â”Š  â”Š37â”Š      .then(() => {\n+â”Š  â”Š38â”Š        history.replace('/chats');\n+â”Š  â”Š39â”Š      })\n+â”Š  â”Š40â”Š      .catch(error => {\n+â”Š  â”Š41â”Š        setError(error.message || error);\n+â”Š  â”Š42â”Š      });\n+â”Š  â”Š43â”Š  }, [username, password, history, signIn]);\n+â”Š  â”Š44â”Š\n+â”Š  â”Š45â”Š  return (\n+â”Š  â”Š46â”Š    <SignForm>\n+â”Š  â”Š47â”Š      <ActualForm>\n+â”Š  â”Š48â”Š        <Legend>Sign in</Legend>\n+â”Š  â”Š49â”Š        <Section style={{ width: '100%' }}>\n+â”Š  â”Š50â”Š          <TextField\n+â”Š  â”Š51â”Š            data-testid=\"username-input\"\n+â”Š  â”Š52â”Š            label=\"Username\"\n+â”Š  â”Š53â”Š            value={username}\n+â”Š  â”Š54â”Š            onChange={onUsernameChange}\n+â”Š  â”Š55â”Š            margin=\"normal\"\n+â”Š  â”Š56â”Š            placeholder=\"Enter your username\"\n+â”Š  â”Š57â”Š          />\n+â”Š  â”Š58â”Š          <TextField\n+â”Š  â”Š59â”Š            data-testid=\"password-input\"\n+â”Š  â”Š60â”Š            label=\"Password\"\n+â”Š  â”Š61â”Š            type=\"password\"\n+â”Š  â”Š62â”Š            value={password}\n+â”Š  â”Š63â”Š            onChange={onPasswordChange}\n+â”Š  â”Š64â”Š            margin=\"normal\"\n+â”Š  â”Š65â”Š            placeholder=\"Enter your password\"\n+â”Š  â”Š66â”Š          />\n+â”Š  â”Š67â”Š        </Section>\n+â”Š  â”Š68â”Š        <Button\n+â”Š  â”Š69â”Š          data-testid=\"sign-in-button\"\n+â”Š  â”Š70â”Š          type=\"button\"\n+â”Š  â”Š71â”Š          color=\"secondary\"\n+â”Š  â”Š72â”Š          variant=\"contained\"\n+â”Š  â”Š73â”Š          disabled={!maySignIn()}\n+â”Š  â”Š74â”Š          onClick={handleSignIn}>\n+â”Š  â”Š75â”Š          Sign in\n+â”Š  â”Š76â”Š        </Button>\n+â”Š  â”Š77â”Š        <ErrorMessage data-testid=\"error-message\">{error}</ErrorMessage>\n+â”Š  â”Š78â”Š      </ActualForm>\n+â”Š  â”Š79â”Š    </SignForm>\n+â”Š  â”Š80â”Š  );\n+â”Š  â”Š81â”Š};\n+â”Š  â”Š82â”Š\n+â”Š  â”Š83â”Šexport default SignInForm;\n```\n\n##### Added src&#x2F;components&#x2F;AuthScreen&#x2F;SignUpForm.test.tsx\n```diff\n@@ -0,0 +1,225 @@\n+â”Š   â”Š  1â”Šimport { createMemoryHistory } from 'history';\n+â”Š   â”Š  2â”Šimport React from 'react';\n+â”Š   â”Š  3â”Šimport { ApolloProvider } from '@apollo/react-hooks';\n+â”Š   â”Š  4â”Šimport { act, cleanup, render, fireEvent, wait, waitForElement } from '@testing-library/react';\n+â”Š   â”Š  5â”Šimport SignUpForm from './SignUpForm';\n+â”Š   â”Š  6â”Šimport { SignUpDocument } from '../../graphql/types';\n+â”Š   â”Š  7â”Šimport { mockApolloClient } from '../../test-helpers';\n+â”Š   â”Š  8â”Š\n+â”Š   â”Š  9â”Šdescribe('SignUpForm', () => {\n+â”Š   â”Š 10â”Š  afterEach(cleanup);\n+â”Š   â”Š 11â”Š\n+â”Š   â”Š 12â”Š  it('enables sign-up button when filled in', async () => {\n+â”Š   â”Š 13â”Š    const history = createMemoryHistory();\n+â”Š   â”Š 14â”Š    const client = mockApolloClient();\n+â”Š   â”Š 15â”Š\n+â”Š   â”Š 16â”Š    let getByTestId: any = null;\n+â”Š   â”Š 17â”Š\n+â”Š   â”Š 18â”Š    act(() => {\n+â”Š   â”Š 19â”Š      getByTestId = render(\n+â”Š   â”Š 20â”Š        <ApolloProvider client={client}>\n+â”Š   â”Š 21â”Š          <SignUpForm history={history} />\n+â”Š   â”Š 22â”Š        </ApolloProvider>\n+â”Š   â”Š 23â”Š      ).getByTestId;\n+â”Š   â”Š 24â”Š    });\n+â”Š   â”Š 25â”Š\n+â”Š   â”Š 26â”Š    const nameInput = await waitForElement(() =>\n+â”Š   â”Š 27â”Š      getByTestId('name-input').querySelector('input')\n+â”Š   â”Š 28â”Š    );\n+â”Š   â”Š 29â”Š    const usernameInput = await waitForElement(() =>\n+â”Š   â”Š 30â”Š      getByTestId('username-input').querySelector('input')\n+â”Š   â”Š 31â”Š    );\n+â”Š   â”Š 32â”Š    const passwordInput = await waitForElement(() =>\n+â”Š   â”Š 33â”Š      getByTestId('password-input').querySelector('input')\n+â”Š   â”Š 34â”Š    );\n+â”Š   â”Š 35â”Š    const passwordConfirmInput = await waitForElement(() =>\n+â”Š   â”Š 36â”Š      getByTestId('password-confirm-input').querySelector('input')\n+â”Š   â”Š 37â”Š    );\n+â”Š   â”Š 38â”Š    const signUpButton = await waitForElement(() =>\n+â”Š   â”Š 39â”Š      getByTestId('sign-up-button') as HTMLButtonElement\n+â”Š   â”Š 40â”Š    );\n+â”Š   â”Š 41â”Š\n+â”Š   â”Š 42â”Š    expect(signUpButton.disabled).toEqual(true);\n+â”Š   â”Š 43â”Š\n+â”Š   â”Š 44â”Š    act(() => {\n+â”Š   â”Š 45â”Š      fireEvent.change(nameInput, { target: { value: 'User Name' } });\n+â”Š   â”Š 46â”Š      fireEvent.change(usernameInput, { target: { value: 'username' } });\n+â”Š   â”Š 47â”Š      fireEvent.change(passwordInput, { target: { value: 'password' } });\n+â”Š   â”Š 48â”Š      fireEvent.change(passwordConfirmInput, { target: { value: 'password' } });\n+â”Š   â”Š 49â”Š    });\n+â”Š   â”Š 50â”Š\n+â”Š   â”Š 51â”Š    await wait(() =>\n+â”Š   â”Š 52â”Š      expect(nameInput.value).toEqual('User Name')\n+â”Š   â”Š 53â”Š    );\n+â”Š   â”Š 54â”Š\n+â”Š   â”Š 55â”Š    await wait(() =>\n+â”Š   â”Š 56â”Š      expect(usernameInput.value).toEqual('username')\n+â”Š   â”Š 57â”Š    );\n+â”Š   â”Š 58â”Š\n+â”Š   â”Š 59â”Š    await wait(() =>\n+â”Š   â”Š 60â”Š      expect(passwordInput.value).toEqual('password')\n+â”Š   â”Š 61â”Š    );\n+â”Š   â”Š 62â”Š\n+â”Š   â”Š 63â”Š    await wait(() =>\n+â”Š   â”Š 64â”Š      expect(passwordConfirmInput.value).toEqual('password')\n+â”Š   â”Š 65â”Š    );\n+â”Š   â”Š 66â”Š\n+â”Š   â”Š 67â”Š    await wait(() =>\n+â”Š   â”Š 68â”Š      expect(signUpButton.disabled).toEqual(false)\n+â”Š   â”Š 69â”Š    )\n+â”Š   â”Š 70â”Š  });\n+â”Š   â”Š 71â”Š\n+â”Š   â”Š 72â”Š  it('prints server error if input was wrong', async () => {\n+â”Š   â”Š 73â”Š    const history = createMemoryHistory();\n+â”Š   â”Š 74â”Š\n+â”Š   â”Š 75â”Š    const client = mockApolloClient([\n+â”Š   â”Š 76â”Š      {\n+â”Š   â”Š 77â”Š        request: {\n+â”Š   â”Š 78â”Š          query: SignUpDocument,\n+â”Š   â”Š 79â”Š          variables: {\n+â”Š   â”Š 80â”Š            name: 'User Name',\n+â”Š   â”Š 81â”Š            username: 'username',\n+â”Š   â”Š 82â”Š            password: 'password',\n+â”Š   â”Š 83â”Š            passwordConfirm: 'password'\n+â”Š   â”Š 84â”Š          }\n+â”Š   â”Š 85â”Š        },\n+â”Š   â”Š 86â”Š        get result() { throw Error('sign-up failed') }\n+â”Š   â”Š 87â”Š      }\n+â”Š   â”Š 88â”Š    ]);\n+â”Š   â”Š 89â”Š\n+â”Š   â”Š 90â”Š    let getByTestId: any = null;\n+â”Š   â”Š 91â”Š\n+â”Š   â”Š 92â”Š    act(() => {\n+â”Š   â”Š 93â”Š      getByTestId = render(\n+â”Š   â”Š 94â”Š        <ApolloProvider client={client}>\n+â”Š   â”Š 95â”Š          <SignUpForm history={history} />\n+â”Š   â”Š 96â”Š        </ApolloProvider>\n+â”Š   â”Š 97â”Š      ).getByTestId;\n+â”Š   â”Š 98â”Š    });\n+â”Š   â”Š 99â”Š\n+â”Š   â”Š100â”Š    const nameInput = await waitForElement(() =>\n+â”Š   â”Š101â”Š      getByTestId('name-input').querySelector('input')\n+â”Š   â”Š102â”Š    );\n+â”Š   â”Š103â”Š    const usernameInput = await waitForElement(() =>\n+â”Š   â”Š104â”Š      getByTestId('username-input').querySelector('input')\n+â”Š   â”Š105â”Š    );\n+â”Š   â”Š106â”Š    const passwordInput = await waitForElement(() =>\n+â”Š   â”Š107â”Š      getByTestId('password-input').querySelector('input')\n+â”Š   â”Š108â”Š    );\n+â”Š   â”Š109â”Š    const passwordConfirmInput = await waitForElement(() =>\n+â”Š   â”Š110â”Š      getByTestId('password-confirm-input').querySelector('input')\n+â”Š   â”Š111â”Š    );\n+â”Š   â”Š112â”Š    const signUpButton = await waitForElement(() =>\n+â”Š   â”Š113â”Š      getByTestId('sign-up-button') as HTMLButtonElement\n+â”Š   â”Š114â”Š    );\n+â”Š   â”Š115â”Š\n+â”Š   â”Š116â”Š    act(() => {\n+â”Š   â”Š117â”Š      fireEvent.change(nameInput, { target: { value: 'User Name' } });\n+â”Š   â”Š118â”Š      fireEvent.change(usernameInput, { target: { value: 'username' } });\n+â”Š   â”Š119â”Š      fireEvent.change(passwordInput, { target: { value: 'password' } });\n+â”Š   â”Š120â”Š      fireEvent.change(passwordConfirmInput, { target: { value: 'password' } });\n+â”Š   â”Š121â”Š    });\n+â”Š   â”Š122â”Š\n+â”Š   â”Š123â”Š    await wait(() =>\n+â”Š   â”Š124â”Š      expect(nameInput.value).toEqual('User Name')\n+â”Š   â”Š125â”Š    );\n+â”Š   â”Š126â”Š\n+â”Š   â”Š127â”Š    await wait(() =>\n+â”Š   â”Š128â”Š      expect(usernameInput.value).toEqual('username')\n+â”Š   â”Š129â”Š    );\n+â”Š   â”Š130â”Š\n+â”Š   â”Š131â”Š    await wait(() =>\n+â”Š   â”Š132â”Š      expect(passwordInput.value).toEqual('password')\n+â”Š   â”Š133â”Š    );\n+â”Š   â”Š134â”Š\n+â”Š   â”Š135â”Š    await wait(() =>\n+â”Š   â”Š136â”Š      expect(passwordConfirmInput.value).toEqual('password')\n+â”Š   â”Š137â”Š    );\n+â”Š   â”Š138â”Š\n+â”Š   â”Š139â”Š    act(() => {\n+â”Š   â”Š140â”Š      fireEvent.click(signUpButton);\n+â”Š   â”Š141â”Š    });\n+â”Š   â”Š142â”Š\n+â”Š   â”Š143â”Š    const errorMessage = await waitForElement(() =>\n+â”Š   â”Š144â”Š      getByTestId('error-message')\n+â”Š   â”Š145â”Š    );\n+â”Š   â”Š146â”Š\n+â”Š   â”Š147â”Š    await wait(() =>expect(errorMessage.innerHTML).toContain('sign-up failed'));\n+â”Š   â”Š148â”Š  });\n+â”Š   â”Š149â”Š\n+â”Š   â”Š150â”Š  it('navigates to /sign-in if everything went right', async () => {\n+â”Š   â”Š151â”Š    const history = createMemoryHistory();\n+â”Š   â”Š152â”Š\n+â”Š   â”Š153â”Š    const client = mockApolloClient([\n+â”Š   â”Š154â”Š      {\n+â”Š   â”Š155â”Š        request: {\n+â”Š   â”Š156â”Š          query: SignUpDocument,\n+â”Š   â”Š157â”Š          variables: {\n+â”Š   â”Š158â”Š            name: 'User Name',\n+â”Š   â”Š159â”Š            username: 'username',\n+â”Š   â”Š160â”Š            password: 'password',\n+â”Š   â”Š161â”Š            passwordConfirm: 'password'\n+â”Š   â”Š162â”Š          }\n+â”Š   â”Š163â”Š        },\n+â”Š   â”Š164â”Š        result: { data: {} }\n+â”Š   â”Š165â”Š      }\n+â”Š   â”Š166â”Š    ]);\n+â”Š   â”Š167â”Š\n+â”Š   â”Š168â”Š    let getByTestId: any = null;\n+â”Š   â”Š169â”Š\n+â”Š   â”Š170â”Š    act(() => {\n+â”Š   â”Š171â”Š      getByTestId = render(\n+â”Š   â”Š172â”Š        <ApolloProvider client={client}>\n+â”Š   â”Š173â”Š          <SignUpForm history={history} />\n+â”Š   â”Š174â”Š        </ApolloProvider>\n+â”Š   â”Š175â”Š      ).getByTestId;\n+â”Š   â”Š176â”Š    });\n+â”Š   â”Š177â”Š\n+â”Š   â”Š178â”Š    const nameInput = await waitForElement(() =>\n+â”Š   â”Š179â”Š      getByTestId('name-input').querySelector('input')\n+â”Š   â”Š180â”Š    );\n+â”Š   â”Š181â”Š    const usernameInput = await waitForElement(() =>\n+â”Š   â”Š182â”Š      getByTestId('username-input').querySelector('input')\n+â”Š   â”Š183â”Š    );\n+â”Š   â”Š184â”Š    const passwordInput = await waitForElement(() =>\n+â”Š   â”Š185â”Š      getByTestId('password-input').querySelector('input')\n+â”Š   â”Š186â”Š    );\n+â”Š   â”Š187â”Š    const passwordConfirmInput = await waitForElement(() =>\n+â”Š   â”Š188â”Š      getByTestId('password-confirm-input').querySelector('input')\n+â”Š   â”Š189â”Š    );\n+â”Š   â”Š190â”Š    const signUpButton = await waitForElement(() =>\n+â”Š   â”Š191â”Š      getByTestId('sign-up-button') as HTMLButtonElement\n+â”Š   â”Š192â”Š    );\n+â”Š   â”Š193â”Š\n+â”Š   â”Š194â”Š    act(() => {\n+â”Š   â”Š195â”Š      fireEvent.change(nameInput, { target: { value: 'User Name' } });\n+â”Š   â”Š196â”Š      fireEvent.change(usernameInput, { target: { value: 'username' } });\n+â”Š   â”Š197â”Š      fireEvent.change(passwordInput, { target: { value: 'password' } });\n+â”Š   â”Š198â”Š      fireEvent.change(passwordConfirmInput, { target: { value: 'password' } });\n+â”Š   â”Š199â”Š    });\n+â”Š   â”Š200â”Š\n+â”Š   â”Š201â”Š    await wait(() =>\n+â”Š   â”Š202â”Š      expect(nameInput.value).toEqual('User Name')\n+â”Š   â”Š203â”Š    );\n+â”Š   â”Š204â”Š\n+â”Š   â”Š205â”Š    await wait(() =>\n+â”Š   â”Š206â”Š      expect(usernameInput.value).toEqual('username')\n+â”Š   â”Š207â”Š    );\n+â”Š   â”Š208â”Š\n+â”Š   â”Š209â”Š    await wait(() =>\n+â”Š   â”Š210â”Š      expect(passwordInput.value).toEqual('password')\n+â”Š   â”Š211â”Š    );\n+â”Š   â”Š212â”Š\n+â”Š   â”Š213â”Š    await wait(() =>\n+â”Š   â”Š214â”Š      expect(passwordConfirmInput.value).toEqual('password')\n+â”Š   â”Š215â”Š    );\n+â”Š   â”Š216â”Š\n+â”Š   â”Š217â”Š    act(() => {\n+â”Š   â”Š218â”Š      fireEvent.click(signUpButton);\n+â”Š   â”Š219â”Š    });\n+â”Š   â”Š220â”Š\n+â”Š   â”Š221â”Š    await wait(() =>\n+â”Š   â”Š222â”Š      expect(history.location.pathname).toEqual('/sign-in')\n+â”Š   â”Š223â”Š    );\n+â”Š   â”Š224â”Š  });\n+â”Š   â”Š225â”Š});ðŸš«â†µ\n```\n\n##### Added src&#x2F;components&#x2F;AuthScreen&#x2F;SignUpForm.tsx\n```diff\n@@ -0,0 +1,124 @@\n+â”Š   â”Š  1â”Šimport React from 'react';\n+â”Š   â”Š  2â”Šimport { useCallback, useState } from 'react';\n+â”Š   â”Š  3â”Šimport { useSignUp } from '../../services/auth.service';\n+â”Š   â”Š  4â”Šimport {\n+â”Š   â”Š  5â”Š  SignForm,\n+â”Š   â”Š  6â”Š  ActualForm,\n+â”Š   â”Š  7â”Š  Legend,\n+â”Š   â”Š  8â”Š  Section,\n+â”Š   â”Š  9â”Š  TextField,\n+â”Š   â”Š 10â”Š  Button,\n+â”Š   â”Š 11â”Š  ErrorMessage,\n+â”Š   â”Š 12â”Š} from './form-components';\n+â”Š   â”Š 13â”Šimport { RouteComponentProps } from 'react-router-dom';\n+â”Š   â”Š 14â”Š\n+â”Š   â”Š 15â”Šconst SignUpForm: React.FC<RouteComponentProps<any>> = ({ history }) => {\n+â”Š   â”Š 16â”Š  const [name, setName] = useState('');\n+â”Š   â”Š 17â”Š  const [username, setUsername] = useState('');\n+â”Š   â”Š 18â”Š  const [password, setPassword] = useState('');\n+â”Š   â”Š 19â”Š  const [passwordConfirm, setPasswordConfirm] = useState('');\n+â”Š   â”Š 20â”Š  const [error, setError] = useState('');\n+â”Š   â”Š 21â”Š  const [signUp] = useSignUp()\n+â”Š   â”Š 22â”Š\n+â”Š   â”Š 23â”Š  const updateName = useCallback(({ target }) => {\n+â”Š   â”Š 24â”Š    setError('');\n+â”Š   â”Š 25â”Š    setName(target.value);\n+â”Š   â”Š 26â”Š  }, []);\n+â”Š   â”Š 27â”Š\n+â”Š   â”Š 28â”Š  const updateUsername = useCallback(({ target }) => {\n+â”Š   â”Š 29â”Š    setError('');\n+â”Š   â”Š 30â”Š    setUsername(target.value);\n+â”Š   â”Š 31â”Š  }, []);\n+â”Š   â”Š 32â”Š\n+â”Š   â”Š 33â”Š  const updatePassword = useCallback(({ target }) => {\n+â”Š   â”Š 34â”Š    setError('');\n+â”Š   â”Š 35â”Š    setPassword(target.value);\n+â”Š   â”Š 36â”Š  }, []);\n+â”Š   â”Š 37â”Š\n+â”Š   â”Š 38â”Š  const updatePasswordConfirm = useCallback(({ target }) => {\n+â”Š   â”Š 39â”Š    setError('');\n+â”Š   â”Š 40â”Š    setPasswordConfirm(target.value);\n+â”Š   â”Š 41â”Š  }, []);\n+â”Š   â”Š 42â”Š\n+â”Š   â”Š 43â”Š  const maySignUp = useCallback(() => {\n+â”Š   â”Š 44â”Š    return !!(name && username && password && password === passwordConfirm);\n+â”Š   â”Š 45â”Š  }, [name, username, password, passwordConfirm]);\n+â”Š   â”Š 46â”Š\n+â”Š   â”Š 47â”Š  const handleSignUp = useCallback(() => {\n+â”Š   â”Š 48â”Š    signUp({ variables: { username, password, passwordConfirm, name } })\n+â”Š   â”Š 49â”Š      .then(() => {\n+â”Š   â”Š 50â”Š        history.replace('/sign-in');\n+â”Š   â”Š 51â”Š      })\n+â”Š   â”Š 52â”Š      .catch(error => {\n+â”Š   â”Š 53â”Š        setError(error.message || error);\n+â”Š   â”Š 54â”Š      });\n+â”Š   â”Š 55â”Š  }, [name, username, password, passwordConfirm, history, signUp]);\n+â”Š   â”Š 56â”Š\n+â”Š   â”Š 57â”Š  return (\n+â”Š   â”Š 58â”Š    <SignForm>\n+â”Š   â”Š 59â”Š      <ActualForm>\n+â”Š   â”Š 60â”Š        <Legend>Sign up</Legend>\n+â”Š   â”Š 61â”Š        <Section\n+â”Š   â”Š 62â”Š          style={{\n+â”Š   â”Š 63â”Š            float: 'left',\n+â”Š   â”Š 64â”Š            width: 'calc(50% - 10px)',\n+â”Š   â”Š 65â”Š            paddingRight: '10px',\n+â”Š   â”Š 66â”Š          }}>\n+â”Š   â”Š 67â”Š          <TextField\n+â”Š   â”Š 68â”Š            data-testid=\"name-input\"\n+â”Š   â”Š 69â”Š            label=\"Name\"\n+â”Š   â”Š 70â”Š            value={name}\n+â”Š   â”Š 71â”Š            onChange={updateName}\n+â”Š   â”Š 72â”Š            autoComplete=\"off\"\n+â”Š   â”Š 73â”Š            margin=\"normal\"\n+â”Š   â”Š 74â”Š          />\n+â”Š   â”Š 75â”Š          <TextField\n+â”Š   â”Š 76â”Š            data-testid=\"username-input\"\n+â”Š   â”Š 77â”Š            label=\"Username\"\n+â”Š   â”Š 78â”Š            value={username}\n+â”Š   â”Š 79â”Š            onChange={updateUsername}\n+â”Š   â”Š 80â”Š            autoComplete=\"off\"\n+â”Š   â”Š 81â”Š            margin=\"normal\"\n+â”Š   â”Š 82â”Š          />\n+â”Š   â”Š 83â”Š        </Section>\n+â”Š   â”Š 84â”Š        <Section\n+â”Š   â”Š 85â”Š          style={{\n+â”Š   â”Š 86â”Š            float: 'right',\n+â”Š   â”Š 87â”Š            width: 'calc(50% - 10px)',\n+â”Š   â”Š 88â”Š            paddingLeft: '10px',\n+â”Š   â”Š 89â”Š          }}>\n+â”Š   â”Š 90â”Š          <TextField\n+â”Š   â”Š 91â”Š            data-testid=\"password-input\"\n+â”Š   â”Š 92â”Š            label=\"Password\"\n+â”Š   â”Š 93â”Š            type=\"password\"\n+â”Š   â”Š 94â”Š            value={password}\n+â”Š   â”Š 95â”Š            onChange={updatePassword}\n+â”Š   â”Š 96â”Š            autoComplete=\"off\"\n+â”Š   â”Š 97â”Š            margin=\"normal\"\n+â”Š   â”Š 98â”Š          />\n+â”Š   â”Š 99â”Š          <TextField\n+â”Š   â”Š100â”Š            data-testid=\"password-confirm-input\"\n+â”Š   â”Š101â”Š            label=\"Confirm password\"\n+â”Š   â”Š102â”Š            type=\"password\"\n+â”Š   â”Š103â”Š            value={passwordConfirm}\n+â”Š   â”Š104â”Š            onChange={updatePasswordConfirm}\n+â”Š   â”Š105â”Š            autoComplete=\"off\"\n+â”Š   â”Š106â”Š            margin=\"normal\"\n+â”Š   â”Š107â”Š          />\n+â”Š   â”Š108â”Š        </Section>\n+â”Š   â”Š109â”Š        <Button\n+â”Š   â”Š110â”Š          data-testid=\"sign-up-button\"\n+â”Š   â”Š111â”Š          type=\"button\"\n+â”Š   â”Š112â”Š          color=\"secondary\"\n+â”Š   â”Š113â”Š          variant=\"contained\"\n+â”Š   â”Š114â”Š          disabled={!maySignUp()}\n+â”Š   â”Š115â”Š          onClick={handleSignUp}>\n+â”Š   â”Š116â”Š          Sign up\n+â”Š   â”Š117â”Š        </Button>\n+â”Š   â”Š118â”Š        <ErrorMessage data-testid=\"error-message\">{error}</ErrorMessage>\n+â”Š   â”Š119â”Š      </ActualForm>\n+â”Š   â”Š120â”Š    </SignForm>\n+â”Š   â”Š121â”Š  );\n+â”Š   â”Š122â”Š};\n+â”Š   â”Š123â”Š\n+â”Š   â”Š124â”Šexport default SignUpForm;\n```\n\n##### Added src&#x2F;components&#x2F;AuthScreen&#x2F;form-components.ts\n```diff\n@@ -0,0 +1,75 @@\n+â”Š  â”Š 1â”Šimport MaterialButton from '@material-ui/core/Button';\n+â”Š  â”Š 2â”Šimport MaterialTextField from '@material-ui/core/TextField';\n+â”Š  â”Š 3â”Šimport styled from 'styled-components';\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šexport const SignForm = styled.div`\n+â”Š  â”Š 6â”Š  height: calc(100% - 265px);\n+â”Š  â”Š 7â”Š`;\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Šexport const ActualForm = styled.form`\n+â”Š  â”Š10â”Š  padding: 20px;\n+â”Š  â”Š11â”Š`;\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Šexport const Section = styled.div`\n+â”Š  â”Š14â”Š  padding-bottom: 35px;\n+â”Š  â”Š15â”Š`;\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Šexport const Legend = styled.legend`\n+â”Š  â”Š18â”Š  font-weight: bold;\n+â”Š  â”Š19â”Š  color: white;\n+â”Š  â”Š20â”Š`;\n+â”Š  â”Š21â”Š\n+â”Š  â”Š22â”Šexport const Label = styled.label`\n+â”Š  â”Š23â”Š  color: white !important;\n+â”Š  â”Š24â”Š`;\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Šexport const Input = styled.input`\n+â”Š  â”Š27â”Š  color: white;\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š  &::placeholder {\n+â”Š  â”Š30â”Š    color: var(--primary-bg);\n+â”Š  â”Š31â”Š  }\n+â”Š  â”Š32â”Š`;\n+â”Š  â”Š33â”Š\n+â”Š  â”Š34â”Šexport const TextField = styled(MaterialTextField)`\n+â”Š  â”Š35â”Š  width: 100%;\n+â”Š  â”Š36â”Š  position: relative;\n+â”Š  â”Š37â”Š\n+â”Š  â”Š38â”Š  > div::before {\n+â”Š  â”Š39â”Š    border-color: white !important;\n+â”Š  â”Š40â”Š  }\n+â”Š  â”Š41â”Š\n+â”Š  â”Š42â”Š  input {\n+â”Š  â”Š43â”Š    color: white !important;\n+â”Š  â”Š44â”Š\n+â”Š  â”Š45â”Š    &::placeholder {\n+â”Š  â”Š46â”Š      color: var(--primary-bg) !important;\n+â”Š  â”Š47â”Š    }\n+â”Š  â”Š48â”Š  }\n+â”Š  â”Š49â”Š\n+â”Š  â”Š50â”Š  label {\n+â”Š  â”Š51â”Š    color: white !important;\n+â”Š  â”Š52â”Š  }\n+â”Š  â”Š53â”Š`;\n+â”Š  â”Š54â”Š\n+â”Š  â”Š55â”Šexport const Button = styled(MaterialButton)`\n+â”Š  â”Š56â”Š  width: 100px;\n+â”Š  â”Š57â”Š  display: block !important;\n+â”Š  â”Š58â”Š  margin: auto !important;\n+â”Š  â”Š59â”Š  background-color: var(--secondary-bg) !important;\n+â”Š  â”Š60â”Š\n+â”Š  â”Š61â”Š  &[disabled] {\n+â”Š  â”Š62â”Š    color: #38a81c;\n+â”Š  â”Š63â”Š  }\n+â”Š  â”Š64â”Š\n+â”Š  â”Š65â”Š  &:not([disabled]) {\n+â”Š  â”Š66â”Š    color: white;\n+â”Š  â”Š67â”Š  }\n+â”Š  â”Š68â”Š`;\n+â”Š  â”Š69â”Š\n+â”Š  â”Š70â”Šexport const ErrorMessage = styled.div`\n+â”Š  â”Š71â”Š  position: fixed;\n+â”Š  â”Š72â”Š  color: red;\n+â”Š  â”Š73â”Š  font-size: 15px;\n+â”Š  â”Š74â”Š  margin-top: 20px;\n+â”Š  â”Š75â”Š`;\n```\n\n##### Changed src&#x2F;components&#x2F;AuthScreen&#x2F;index.tsx\n```diff\n@@ -1,13 +1,13 @@\n-â”Š 1â”Š  â”Šimport MaterialButton from '@material-ui/core/Button';\n-â”Š 2â”Š  â”Šimport MaterialTextField from '@material-ui/core/TextField';\n â”Š 3â”Š 1â”Šimport React from 'react';\n-â”Š 4â”Š  â”Šimport { useCallback, useState } from 'react';\n+â”Š  â”Š 2â”Šimport { useMemo } from 'react';\n+â”Š  â”Š 3â”Šimport { Route } from 'react-router-dom';\n â”Š 5â”Š 4â”Šimport styled from 'styled-components';\n-â”Š 6â”Š  â”Šimport { useSignIn } from '../../services/auth.service';\n+â”Š  â”Š 5â”Šimport AnimatedSwitch from '../AnimatedSwitch';\n+â”Š  â”Š 6â”Šimport SignInForm from './SignInForm';\n+â”Š  â”Š 7â”Šimport SignUpForm from './SignUpForm';\n â”Š 7â”Š 8â”Šimport { RouteComponentProps } from 'react-router-dom';\n â”Š 8â”Š 9â”Š\n â”Š 9â”Š10â”Šconst Container = styled.div`\n-â”Š10â”Š  â”Š  height: 100%;\n â”Š11â”Š11â”Š  background: radial-gradient(rgb(34, 65, 67), rgb(17, 48, 50)),\n â”Š12â”Š12â”Š    url(/assets/chat-background.jpg) no-repeat;\n â”Š13â”Š13â”Š  background-size: cover;\n```\n```diff\n@@ -40,149 +40,51 @@\n â”Š 40â”Š 40â”Š  bottom: 10px;\n â”Š 41â”Š 41â”Š  left: 10px;\n â”Š 42â”Š 42â”Š\n-â”Š 43â”Š   â”Š  a {\n+â”Š   â”Š 43â”Š  label {\n â”Š 44â”Š 44â”Š    color: var(--secondary-bg);\n â”Š 45â”Š 45â”Š  }\n â”Š 46â”Š 46â”Š`;\n â”Š 47â”Š 47â”Š\n-â”Š 48â”Š   â”Šconst SignInForm = styled.div`\n-â”Š 49â”Š   â”Š  height: calc(100% - 265px);\n-â”Š 50â”Š   â”Š`;\n-â”Š 51â”Š   â”Š\n-â”Š 52â”Š   â”Šconst ActualForm = styled.form`\n-â”Š 53â”Š   â”Š  padding: 20px;\n-â”Š 54â”Š   â”Š`;\n-â”Š 55â”Š   â”Š\n-â”Š 56â”Š   â”Šconst Section = styled.div`\n-â”Š 57â”Š   â”Š  width: 100%;\n-â”Š 58â”Š   â”Š  padding-bottom: 35px;\n-â”Š 59â”Š   â”Š`;\n-â”Š 60â”Š   â”Š\n-â”Š 61â”Š   â”Šconst Legend = styled.legend`\n-â”Š 62â”Š   â”Š  font-weight: bold;\n-â”Š 63â”Š   â”Š  color: white;\n-â”Š 64â”Š   â”Š`;\n-â”Š 65â”Š   â”Š\n-â”Š 66â”Š   â”Š// eslint-disable-next-line\n-â”Š 67â”Š   â”Šconst Label = styled.label`\n-â”Š 68â”Š   â”Š  color: white !important;\n-â”Š 69â”Š   â”Š`;\n-â”Š 70â”Š   â”Š\n-â”Š 71â”Š   â”Š// eslint-disable-next-line\n-â”Š 72â”Š   â”Šconst Input = styled.input`\n-â”Š 73â”Š   â”Š  color: white;\n-â”Š 74â”Š   â”Š\n-â”Š 75â”Š   â”Š  &::placeholder {\n-â”Š 76â”Š   â”Š    color: var(--primary-bg);\n-â”Š 77â”Š   â”Š  }\n-â”Š 78â”Š   â”Š`;\n-â”Š 79â”Š   â”Š\n-â”Š 80â”Š   â”Šconst TextField = styled(MaterialTextField)`\n-â”Š 81â”Š   â”Š  width: 100%;\n-â”Š 82â”Š   â”Š  position: relative;\n-â”Š 83â”Š   â”Š\n-â”Š 84â”Š   â”Š  > div::before {\n-â”Š 85â”Š   â”Š    border-color: white !important;\n-â”Š 86â”Š   â”Š  }\n-â”Š 87â”Š   â”Š\n-â”Š 88â”Š   â”Š  input {\n-â”Š 89â”Š   â”Š    color: white !important;\n-â”Š 90â”Š   â”Š\n-â”Š 91â”Š   â”Š    &::placeholder {\n-â”Š 92â”Š   â”Š      color: var(--primary-bg) !important;\n+â”Š   â”Š 48â”Šconst AuthScreen: React.FC<RouteComponentProps<any>> = ({\n+â”Š   â”Š 49â”Š  history,\n+â”Š   â”Š 50â”Š  location,\n+â”Š   â”Š 51â”Š}) => {\n+â”Š   â”Š 52â”Š  const alternative = useMemo(() => {\n+â”Š   â”Š 53â”Š    if (location.pathname === '/sign-in') {\n+â”Š   â”Š 54â”Š      const handleSignUp = () => {\n+â”Š   â”Š 55â”Š        history.replace('/sign-up');\n+â”Š   â”Š 56â”Š      };\n+â”Š   â”Š 57â”Š\n+â”Š   â”Š 58â”Š      return (\n+â”Š   â”Š 59â”Š        <Alternative>\n+â”Š   â”Š 60â”Š          Don't have an account yet?{' '}\n+â”Š   â”Š 61â”Š          <label onClick={handleSignUp}>Sign up!</label>\n+â”Š   â”Š 62â”Š        </Alternative>\n+â”Š   â”Š 63â”Š      );\n+â”Š   â”Š 64â”Š    } else {\n+â”Š   â”Š 65â”Š      const handleSignIn = () => {\n+â”Š   â”Š 66â”Š        history.replace('/sign-in');\n+â”Š   â”Š 67â”Š      };\n+â”Š   â”Š 68â”Š\n+â”Š   â”Š 69â”Š      return (\n+â”Š   â”Š 70â”Š        <Alternative>\n+â”Š   â”Š 71â”Š          Already have an accout? <label onClick={handleSignIn}>Sign in!</label>\n+â”Š   â”Š 72â”Š        </Alternative>\n+â”Š   â”Š 73â”Š      );\n â”Š 93â”Š 74â”Š    }\n-â”Š 94â”Š   â”Š  }\n-â”Š 95â”Š   â”Š\n-â”Š 96â”Š   â”Š  label {\n-â”Š 97â”Š   â”Š    color: white !important;\n-â”Š 98â”Š   â”Š  }\n-â”Š 99â”Š   â”Š`;\n-â”Š100â”Š   â”Š\n-â”Š101â”Š   â”Šconst Button = styled(MaterialButton)`\n-â”Š102â”Š   â”Š  width: 100px;\n-â”Š103â”Š   â”Š  display: block !important;\n-â”Š104â”Š   â”Š  margin: auto !important;\n-â”Š105â”Š   â”Š  background-color: var(--secondary-bg) !important;\n-â”Š106â”Š   â”Š\n-â”Š107â”Š   â”Š  &[disabled] {\n-â”Š108â”Š   â”Š    color: #38a81c;\n-â”Š109â”Š   â”Š  }\n-â”Š110â”Š   â”Š\n-â”Š111â”Š   â”Š  &:not([disabled]) {\n-â”Š112â”Š   â”Š    color: white;\n-â”Š113â”Š   â”Š  }\n-â”Š114â”Š   â”Š`;\n-â”Š115â”Š   â”Š\n-â”Š116â”Š   â”Šconst AuthScreen: React.FC<RouteComponentProps<any>> = ({ history }) => {\n-â”Š117â”Š   â”Š  const [username, setUsername] = useState('');\n-â”Š118â”Š   â”Š  const [password, setPassword] = useState('');\n-â”Š119â”Š   â”Š  // eslint-disable-next-line\n-â”Š120â”Š   â”Š  const [error, setError] = useState('');\n-â”Š121â”Š   â”Š  const [signIn] = useSignIn();\n-â”Š122â”Š   â”Š\n-â”Š123â”Š   â”Š  const onUsernameChange = useCallback(({ target }) => {\n-â”Š124â”Š   â”Š    setError('');\n-â”Š125â”Š   â”Š    setUsername(target.value);\n-â”Š126â”Š   â”Š  }, []);\n-â”Š127â”Š   â”Š\n-â”Š128â”Š   â”Š  const onPasswordChange = useCallback(({ target }) => {\n-â”Š129â”Š   â”Š    setError('');\n-â”Š130â”Š   â”Š    setPassword(target.value);\n-â”Š131â”Š   â”Š  }, []);\n-â”Š132â”Š   â”Š\n-â”Š133â”Š   â”Š  const maySignIn = useCallback(() => {\n-â”Š134â”Š   â”Š    return !!(username && password);\n-â”Š135â”Š   â”Š  }, [username, password]);\n-â”Š136â”Š   â”Š\n-â”Š137â”Š   â”Š  const handleSignIn = useCallback(() => {\n-â”Š138â”Š   â”Š    signIn({ variables: { username, password } })\n-â”Š139â”Š   â”Š      .then(() => {\n-â”Š140â”Š   â”Š        history.push('/chats');\n-â”Š141â”Š   â”Š      })\n-â”Š142â”Š   â”Š      .catch(error => {\n-â”Š143â”Š   â”Š        setError(error.message || error);\n-â”Š144â”Š   â”Š      });\n-â”Š145â”Š   â”Š  }, [username, password, history, signIn]);\n+â”Š   â”Š 75â”Š  }, [location.pathname, history]);\n â”Š146â”Š 76â”Š\n â”Š147â”Š 77â”Š  return (\n-â”Š148â”Š   â”Š    <Container>\n-â”Š149â”Š   â”Š      <Intro>\n+â”Š   â”Š 78â”Š    <Container className=\"AuthScreen Screen\">\n+â”Š   â”Š 79â”Š      <Intro className=\"AuthScreen-intro\">\n â”Š150â”Š 80â”Š        <Icon src=\"assets/whatsapp-icon.png\" className=\"AuthScreen-icon\" />\n â”Š151â”Š 81â”Š        <Title className=\"AuthScreen-title\">WhatsApp</Title>\n â”Š152â”Š 82â”Š      </Intro>\n-â”Š153â”Š   â”Š      <SignInForm>\n-â”Š154â”Š   â”Š        <ActualForm>\n-â”Š155â”Š   â”Š          <Legend>Sign in</Legend>\n-â”Š156â”Š   â”Š          <Section>\n-â”Š157â”Š   â”Š            <TextField\n-â”Š158â”Š   â”Š              className=\"AuthScreen-text-field\"\n-â”Š159â”Š   â”Š              label=\"Username\"\n-â”Š160â”Š   â”Š              value={username}\n-â”Š161â”Š   â”Š              onChange={onUsernameChange}\n-â”Š162â”Š   â”Š              margin=\"normal\"\n-â”Š163â”Š   â”Š              placeholder=\"Enter your username\"\n-â”Š164â”Š   â”Š            />\n-â”Š165â”Š   â”Š            <TextField\n-â”Š166â”Š   â”Š              className=\"AuthScreen-text-field\"\n-â”Š167â”Š   â”Š              label=\"Password\"\n-â”Š168â”Š   â”Š              type=\"password\"\n-â”Š169â”Š   â”Š              value={password}\n-â”Š170â”Š   â”Š              onChange={onPasswordChange}\n-â”Š171â”Š   â”Š              margin=\"normal\"\n-â”Š172â”Š   â”Š              placeholder=\"Enter your password\"\n-â”Š173â”Š   â”Š            />\n-â”Š174â”Š   â”Š          </Section>\n-â”Š175â”Š   â”Š          <Button\n-â”Š176â”Š   â”Š            data-testid=\"sign-in-button\"\n-â”Š177â”Š   â”Š            type=\"button\"\n-â”Š178â”Š   â”Š            color=\"secondary\"\n-â”Š179â”Š   â”Š            variant=\"contained\"\n-â”Š180â”Š   â”Š            disabled={!maySignIn()}\n-â”Š181â”Š   â”Š            onClick={handleSignIn}>\n-â”Š182â”Š   â”Š            Sign in\n-â”Š183â”Š   â”Š          </Button>\n-â”Š184â”Š   â”Š        </ActualForm>\n-â”Š185â”Š   â”Š      </SignInForm>\n+â”Š   â”Š 83â”Š      <AnimatedSwitch>\n+â”Š   â”Š 84â”Š        <Route exact path=\"/sign-in\" component={SignInForm} />\n+â”Š   â”Š 85â”Š        <Route exact path=\"/sign-up\" component={SignUpForm} />\n+â”Š   â”Š 86â”Š      </AnimatedSwitch>\n+â”Š   â”Š 87â”Š      {alternative}\n â”Š186â”Š 88â”Š    </Container>\n â”Š187â”Š 89â”Š  );\n â”Š188â”Š 90â”Š};\n```\n\n[}]: #\n\n> Note how we used the `/sign-(in|up)` pattern to define the `signUp` mutation. This is because the request will be further redirected in the `AuthScreen`.\n\nThe authentication flow is complete! To test it out, you can create a new user, log in with it and start chatting with other users."
          },
          {
            "manualTitle": "Step 14: Migrating to PostgreSQL",
            "stepRevision": "c091b09bddc54dfe26720a50eef0ba2bc5836b47",
            "manualView": "**Which Relational Database? And Why?**\n\nWeâ€™ve used to have an in-memory database so far that keeps our entities on memory inside business logic so far. But in a real application we will need a real database system that keeps our data which is seperated from our business logic. In this part we will design our database according to the relational database principles with the benefits of SQL.\n\nWe prefer to use PostgreSQL from now on; because PostgreSQL is a Relational Database implementation that has tables, constraints, triggers, roles, stored procedures and views together with foreign tables from external data sources and many features from NoSQL.\n\n**Database Design**\n\nWhile we are defining our entity types and schema inside our array-based in-memory database, we have already designed the basic parts of them. In this part, we will design our relational database with base and relation tables regarding to them.\n\nInitially we can decide the base fields without relations;\n* User;\n    * `id`\n    * `name`\n    * `username`\n    * `password`\n    * `picture`\n* Message;\n    * `id`\n    * `content`\n    * `created_at`\n* Chat;\n    * `id`\n\nBefore creating tables, we should design our database structure according to [Database Normalization principles](https://www.essentialsql.com/get-ready-to-learn-sql-database-normalization-explained-in-simple-english/) to prevent duplicated data and modification anomalies.\n\nInitially we will have 3 base tables in our database; `user`, `chat`, `message`; and there are some relations between those 3 tables. These relations will be defined in other relation tables together with different primary key and foreign key definitions.\n\nThere are four types of relations in relational databases;\n\n* One to one\n    * This relationship means A entity type can have a relationship with only one instance of B entity type while B entity type can have a relationship with only one instance of A entity type. For example, one user can have only one profile while a profile belongs to only one user.\n* Many to one\n    * This relationship means A entity type can have a relationship with multiple instances of B entity type while B entity type can have a relationship with only one instance of A entity type. For example, a chat can have multiple messages while a message belongs to only one chat. But `many to one` as a word means multiple photos belong to the same chat.\n* One to many\n    * This relationship has the same logic with Many to one. However, `One to many` as a word means a chat can have multiple messages while those messages cannot have multiple chats but only one.\n* Many to many\n    * This relationship means A entity type can have a relationship with multiple instances of B entity type while B entity type can have a relationship with multiple instances of A entity type dependently or independently. For example; a chat can have multiple users, and a user can have multiple chats.\n\nYou can read more about those relations in [here](https://www.techrepublic.com/article/relational-databases-defining-relationships-between-database-tables/).\n\nIn existing entity declarations and schema, we have 6 relationships;\n\n* Message has a One To Many relationship under the name of `chat` inside our schema; so one message can have one chat while one chat can have multiple messages.\n\n```gql\ntype Message { chat: Chat }\n```\n\n* Message has another One To Many relationship under the name of `sender`` inside our schema; so one message can have one sender while one sender user can have multiple messages.\n\n```gql\ntype Message { sender: User }\n```\n\n* Message has one more One To Many relationship under the name of `recipient`` inside our schema; so one message can have one recipient while one recipient user can have multiple messages.\n\n```gql\ntype Message { recipient: User }\n```\n\n* Chat has a One To Many relationship under the name of `messages`, because one chat can have multiple messages while one message can have only one chat. Notice that this relationship is the reversed version of the first relationship in Message.\n\n```gql\n`type Chat { messages: [Message] }\n```\n\n* Chat has another Many To Many relationship under the name of `participants`, because one chat can have multiple participants while a participant can have multiple chats as well.\n\n```gql\ntype Chat { participants: [User] }\n```\n\n* User has a Many To Many relationship under the name of `chats`, because one user can have multiple chats, while it has the same situation for chats.\n\n```gql\ntype User { chats: [Chat] }\n```\n\n\nSo we should decide the dependencies between each other to add columns and tables to our database.\n\n* User is independent in all relationships, so we will keep its columns as it is\n* Message is dependent to User in two cases so we can define this relationship as two different new foreign keys pointing to Userâ€™s id under the columns `sender_user_id`. But we donâ€™t need `recipient_user_id` because `recipient` can be found under Chatâ€™s participants.\n* Chat is also independent because it will be better to keep those relations inside Message.\n* Message is dependent to Chat so we can define this relationship as a new foreign key that points to Chatâ€™s id under the column named `chat_id`.\n* We need to have another table that defines the relationship between multiple chats and users.\n\n> We donâ€™t need to duplicate relations in each entities, because SQL has the power to reverse each relations even if they are defined only in one entity. This is one of the rule of Database Normalization.\n\nFinally we can decide on our tables;\n\n* `chats` table;\n    * `id` ->\n        * `PRIMARY KEY` - `SERIAL`\n        * `SERIAL` will automatically increase the number of the new chat row. Check SQL docs about primary key and auto increment\n* `users` table;\n    * `id` ->\n        * `PRIMARY KEY` - `SERIAL`\n    * `name` ->\n        * `VARCHAR`\n    * `username` ->\n        * `VARCHAR` - `UNIQUE`\n        * `UNIQUE` means this value can exist in this table only once. We use this feature because `username` must be unique in users for each user\n    * `password` ->\n        * `VARCHAR`\n    * `picture` ->\n        * `VARCHAR`\n* `chats_users` table;\n    * `chat_id` ->\n        * `FOREIGN KEY` points to `chat.id` ->\n            * `ON DELETE` -> `CASCADE`.\n            * This means that if chat that has this id is deleted, this row will be deleted automatically as well.\n    * `user_id` ->\n        * FOREIGN KEY points to `user.id` ->\n            * `ON DELETE` -> `CASCADE`.\n* `messages` table;\n    * `id` ->\n        * `PRIMARY KEY` - `SERIAL`\n    * `content` ->\n        * `VARCHAR`\n    * `created_at` ->\n        * `TIMESTAMP` ->\n            * `DEFAULT_VALUE = now()`\n            * This means it will automatically set this to the current timestamp in the new row.\n    * `chat_id` ->\n        * `FOREIGN KEY` points to `chat.id` ->\n            * `ON DELETE` -> `CASCADE`\n            * This means that if chat that has this id is deleted, this row will be deleted automatically as well. So the message will be deleted immediately after the chat is deleted.\n    * `sender_user_id` ->\n        * `FOREIGN_KEY` points to `user.id`\n            * `ON DELETE` -> `CASCADE`\n            * This means that if user that has this id is deleted, this message will be deleted.\n\n> Notice that having a good dependency gives us an opportunity to benefit from `ON_DELETE` feature of SQL. Otherwise, we need to delete each dependent row manually by hand.\n\n**Installing PostgreSQL on your machine**\n\n***Windows / Mac OS X***\n\nYou can download one-click installer for Windows and Mac OS X. During the installation, you must define a password and keep it somewhere safe.\n\n[https://www.enterprisedb.com/downloads/postgres-postgresql-downloads](Download Installer)\n\n***Ubuntu / Debian***\n\nIf you have Debian package manager on your machine, you can install PostgreSQL in a single line in your Bash terminal;\n\n    $ sudo apt-get install postgresql postgresql-contrib\n\n***Other environments***\n\nCheck [https://www.postgresql.org/download/](PostgreSQL website) for installation instructions on other environments.\n\nFollowing above link, after initializing the database using:\n```\npostgresql-setup initdb\n```\nNavigate to /var/lib/pgsql/11/data/pg_hba.conf and edit IPv4 local connections to:\n```\n# IPv4 local connections:\nhost    all             all             127.0.0.1/32            trust\n```\nBy doing so you are setting PostgreSQL permissions so your WhatsApp server can access the database.\n\n**Creating Database, Database User and Tables**\n\n> Make sure you have installed PostgreSQL on your environment first!\n\nWe will use Bash terminal in order to access PostgreSQL using superuser;\n\n    $ su - postgres\n\nYou don't need to execute the previous command if you're using Windows. But you have to open the terminal with Administrator privileges.\n\n    $ psql template1\n\nThen we will see the following PostgreSQL console;\n\nbash```\nWelcome to psql 7.4.16, the PostgreSQL interactive terminal.\n\nType:  \\\\copyright for distribution terms\n       \\\\h for help with SQL commands\n       \\\\? for help on internal slash commands\n       \\\\g or terminate with semicolon to execute query\n       \\\\q to quit\n\ntemplate1\n```\n\nSo we can do the following SQL operations in order to create our new user, database and tables;\n\n* Create user for our database\n\n```sql\n    CREATE DATABASE whatsapp;\n```\n\n* Create database\n\n```sql\n    CREATE USER testuser WITH PASSWORD 'testpassword';\n```\n\n* Give permissions to that user\n\n```sql\n    GRANT ALL PRIVILEGES ON DATABASE whatsapp to testuser;\n```\n\n* Connect database\n\n```sql\n    \\connect whatsapp\n```\n\n* Create `chats` table\n\n```sql\n    CREATE TABLE chats(\n        id SERIAL PRIMARY KEY\n    );\n```\n\n* Create `users` table\n\n```sql\n    CREATE TABLE users(\n        id SERIAL PRIMARY KEY,\n        username VARCHAR (50) UNIQUE NOT NULL,\n        name VARCHAR (50) NOT NULL,\n        password VARCHAR (255) NOT NULL,\n        picture VARCHAR (255) NOT NULL\n    );\n```\n\n* Create `chats_users` table\n\n```sql\n    CREATE TABLE chats_users(\n        chat_id INTEGER NOT NULL REFERENCES chats(id) ON DELETE CASCADE,\n        user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE\n    );\n```\n\n* Create messages table;\n\n```sql\n    CREATE TABLE messages(\n        id SERIAL PRIMARY KEY,\n        content VARCHAR (355) NOT NULL,\n        created_at TIMESTAMP NOT NULL DEFAULT NOW(),\n        chat_id INTEGER NOT NULL REFERENCES chats(id) ON DELETE CASCADE,\n        sender_user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE\n    );\n```\n\n* Give access for those tables\n\n```sql\n    GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO testuser;\n    GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO testuser;\n```\n\n**Installing PostgreSQL on our backend project**\n\nAs we are using PostgreSQL, we will use `node-postgres` as our database client in the backend.\n\nFirst install necessary npm packages using yarn;\n\n\t$ yarn add pg\n\nAnd we will also need TypeScript definitions for better development experience;\n\n\t$ yarn add @types/pg --dev\n\nWe will use `sql` template literals (which is way easier and safer than native API) with [this package](https://github.com/felixfbecker/node-sql-template-strings) which allows you to have SQL highlighting in VSCode with (this extension)[https://marketplace.visualstudio.com/items?itemName=forbeslindesay.vscode-sql-template-literal].\n\n\t$ yarn add sql-template-strings\n\n**Connecting to our database**\n\nWe will use connection pooling to prevent connection leaks and benefit from transactions in our complicated SQL queries. [You can read more about the benefits of connection pooling.](https://node-postgres.com/features/pooling)\n\nFirst we need to create a connection pool using our connection credentials;\n\n[{]: <helper> (diffStep 11.2 files=\"db\" module=\"server\")\n\n#### [__Server__ Step 11.2: Connecting to database](https://github.com/Urigo/WhatsApp-Clone-Server/commit/965b612a5b861433483bf8aeeb75558b5f5724da)\n\n##### Changed db.ts\n```diff\n@@ -1,3 +1,5 @@\n+â”Š â”Š1â”Šimport { Pool } from 'pg';\n+â”Š â”Š2â”Š\n â”Š1â”Š3â”Šexport type User = {\n â”Š2â”Š4â”Š  id: string;\n â”Š3â”Š5â”Š  name: string;\n```\n```diff\n@@ -20,6 +22,16 @@\n â”Š20â”Š22â”Š  participants: string[];\n â”Š21â”Š23â”Š};\n â”Š22â”Š24â”Š\n+â”Š  â”Š25â”Šexport const dbConfig = {\n+â”Š  â”Š26â”Š  host: 'localhost',\n+â”Š  â”Š27â”Š  port: process.env.DB_PORT ? parseInt(process.env.DB_PORT) : 5432,\n+â”Š  â”Š28â”Š  user: 'testuser',\n+â”Š  â”Š29â”Š  password: 'testpassword',\n+â”Š  â”Š30â”Š  database: 'whatsapp',\n+â”Š  â”Š31â”Š};\n+â”Š  â”Š32â”Š\n+â”Š  â”Š33â”Šexport let pool: Pool = new Pool(dbConfig);\n+â”Š  â”Š34â”Š\n â”Š23â”Š35â”Šexport const users: User[] = [];\n â”Š24â”Š36â”Šexport const messages: Message[] = [];\n â”Š25â”Š37â”Šexport const chats: Chat[] = [];\n```\n\n[}]: #\n\n**Add Database Client to GraphQL Context**\n\nAfter that, we will request a client from this pool on each network request in our GraphQL context. So we need to update our context interface and context builder function.\n\n[{]: <helper> (diffStep 11.3 files=\"context, index\" module=\"server\")\n\n#### [__Server__ Step 11.3: Add Database Client to GraphQL Context](https://github.com/Urigo/WhatsApp-Clone-Server/commit/7c91b24ebb923e488563b8b862d34fec16dac649)\n\n##### Changed context.ts\n```diff\n@@ -1,9 +1,11 @@\n â”Š 1â”Š 1â”Šimport { PubSub } from 'apollo-server-express';\n â”Š 2â”Š 2â”Šimport { User } from './db';\n â”Š 3â”Š 3â”Šimport { Response } from 'express';\n+â”Š  â”Š 4â”Šimport { PoolClient } from 'pg';\n â”Š 4â”Š 5â”Š\n â”Š 5â”Š 6â”Šexport type MyContext = {\n â”Š 6â”Š 7â”Š  pubsub: PubSub;\n â”Š 7â”Š 8â”Š  currentUser: User;\n â”Š 8â”Š 9â”Š  res: Response;\n+â”Š  â”Š10â”Š  db: PoolClient;\n â”Š 9â”Š11â”Š};\n```\n\n##### Changed index.ts\n```diff\n@@ -3,14 +3,16 @@\n â”Š 3â”Š 3â”Šimport http from 'http';\n â”Š 4â”Š 4â”Šimport jwt from 'jsonwebtoken';\n â”Š 5â”Š 5â”Šimport { app } from './app';\n-â”Š 6â”Š  â”Šimport { users } from './db';\n+â”Š  â”Š 6â”Šimport { pool } from './db';\n â”Š 7â”Š 7â”Šimport { origin, port, secret } from './env';\n â”Š 8â”Š 8â”Šimport schema from './schema';\n+â”Š  â”Š 9â”Šimport { MyContext } from './context';\n+â”Š  â”Š10â”Šimport sql from 'sql-template-strings';\n â”Š 9â”Š11â”Š\n â”Š10â”Š12â”Šconst pubsub = new PubSub();\n â”Š11â”Š13â”Šconst server = new ApolloServer({\n â”Š12â”Š14â”Š  schema,\n-â”Š13â”Š  â”Š  context: (session: any) => {\n+â”Š  â”Š15â”Š  context: async (session: any) => {\n â”Š14â”Š16â”Š    // Access the request object\n â”Š15â”Š17â”Š    let req = session.connection\n â”Š16â”Š18â”Š      ? session.connection.context.request\n```\n```diff\n@@ -24,12 +26,24 @@\n â”Š24â”Š26â”Š    let currentUser;\n â”Š25â”Š27â”Š    if (req.cookies.authToken) {\n â”Š26â”Š28â”Š      const username = jwt.verify(req.cookies.authToken, secret) as string;\n-â”Š27â”Š  â”Š      currentUser = username && users.find(u => u.username === username);\n+â”Š  â”Š29â”Š      if (username) {\n+â”Š  â”Š30â”Š        const { rows } = await pool.query(\n+â”Š  â”Š31â”Š          sql`SELECT * FROM users WHERE username = ${username}`\n+â”Š  â”Š32â”Š        );\n+â”Š  â”Š33â”Š        currentUser = rows[0];\n+â”Š  â”Š34â”Š      }\n+â”Š  â”Š35â”Š    }\n+â”Š  â”Š36â”Š\n+â”Š  â”Š37â”Š    let db;\n+â”Š  â”Š38â”Š\n+â”Š  â”Š39â”Š    if (!session.connection) {\n+â”Š  â”Š40â”Š      db = await pool.connect();\n â”Š28â”Š41â”Š    }\n â”Š29â”Š42â”Š\n â”Š30â”Š43â”Š    return {\n â”Š31â”Š44â”Š      currentUser,\n â”Š32â”Š45â”Š      pubsub,\n+â”Š  â”Š46â”Š      db,\n â”Š33â”Š47â”Š      res: session.res,\n â”Š34â”Š48â”Š    };\n â”Š35â”Š49â”Š  },\n```\n```diff\n@@ -41,6 +55,11 @@\n â”Š41â”Š55â”Š      };\n â”Š42â”Š56â”Š    },\n â”Š43â”Š57â”Š  },\n+â”Š  â”Š58â”Š  formatResponse: (res: any, { context }: { context: MyContext }) => {\n+â”Š  â”Š59â”Š    context.db.release();\n+â”Š  â”Š60â”Š\n+â”Š  â”Š61â”Š    return res;\n+â”Š  â”Š62â”Š  },\n â”Š44â”Š63â”Š});\n â”Š45â”Š64â”Š\n â”Š46â”Š65â”Šserver.applyMiddleware({\n```\n\n[}]: #\n\n> However we need to release that client to the pool after the network connection ends to prevent connection leaks. So, letâ€™s use `formatResponse` to do this operation.\n> We don't need connection pooling for subscriptions, because it can cause the connection open in all websocket connection. That's why, we don't request a new client from the pool if it is a subscription.\n\n**Update entity typings**\n\nWe should update our entity typings according to our new database tables and columns.\n\n[{]: <helper> (diffStep 11.4 files=\"db\" module=\"server\")\n\n#### [__Server__ Step 11.4: Update Entity Types](https://github.com/Urigo/WhatsApp-Clone-Server/commit/6e5714844448566192b7e13db1ef76019e871921)\n\n##### Changed db.ts\n```diff\n@@ -11,15 +11,13 @@\n â”Š11â”Š11â”Šexport type Message = {\n â”Š12â”Š12â”Š  id: string;\n â”Š13â”Š13â”Š  content: string;\n-â”Š14â”Š  â”Š  createdAt: Date;\n-â”Š15â”Š  â”Š  sender: string;\n-â”Š16â”Š  â”Š  recipient: string;\n+â”Š  â”Š14â”Š  created_at: Date;\n+â”Š  â”Š15â”Š  chat_id: string;\n+â”Š  â”Š16â”Š  sender_user_id: string;\n â”Š17â”Š17â”Š};\n â”Š18â”Š18â”Š\n â”Š19â”Š19â”Šexport type Chat = {\n â”Š20â”Š20â”Š  id: string;\n-â”Š21â”Š  â”Š  messages: string[];\n-â”Š22â”Š  â”Š  participants: string[];\n â”Š23â”Š21â”Š};\n â”Š24â”Š22â”Š\n â”Š25â”Š23â”Šexport const dbConfig = {\n```\n\n[}]: #\n\n**Add Sample Data**\n\nWe need to update the `resetDb` function to add a sample data to our new relational database instead of in-memory database. But we will call `resetDb` if it is asked by using the environmental variable.\n\n[{]: <helper> (diffStep 11.5 module=\"server\")\n\n#### [__Server__ Step 11.5: Add Sample Data](https://github.com/Urigo/WhatsApp-Clone-Server/commit/87942facdf637d3054c9640cb0dc25300121ae3f)\n\n##### Changed db.ts\n```diff\n@@ -1,4 +1,6 @@\n â”Š1â”Š1â”Šimport { Pool } from 'pg';\n+â”Š â”Š2â”Šimport sql from 'sql-template-strings';\n+â”Š â”Š3â”Šimport { resetDb as envResetDb } from './env';\n â”Š2â”Š4â”Š\n â”Š3â”Š5â”Šexport type User = {\n â”Š4â”Š6â”Š  id: string;\n```\n```diff\n@@ -34,121 +36,181 @@\n â”Š 34â”Š 36â”Šexport const messages: Message[] = [];\n â”Š 35â”Š 37â”Šexport const chats: Chat[] = [];\n â”Š 36â”Š 38â”Š\n-â”Š 37â”Š   â”Šexport const resetDb = () => {\n-â”Š 38â”Š   â”Š  users.splice(\n-â”Š 39â”Š   â”Š    0,\n-â”Š 40â”Š   â”Š    Infinity,\n-â”Š 41â”Š   â”Š    ...[\n-â”Š 42â”Š   â”Š      {\n-â”Š 43â”Š   â”Š        id: '1',\n-â”Š 44â”Š   â”Š        name: 'Ray Edwards',\n-â”Š 45â”Š   â”Š        username: 'ray',\n-â”Š 46â”Š   â”Š        password:\n-â”Š 47â”Š   â”Š          '$2a$08$NO9tkFLCoSqX1c5wk3s7z.JfxaVMKA.m7zUDdDwEquo4rvzimQeJm', // 111\n-â”Š 48â”Š   â”Š        picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n-â”Š 49â”Š   â”Š      },\n-â”Š 50â”Š   â”Š      {\n-â”Š 51â”Š   â”Š        id: '2',\n-â”Š 52â”Š   â”Š        name: 'Ethan Gonzalez',\n-â”Š 53â”Š   â”Š        username: 'ethan',\n-â”Š 54â”Š   â”Š        password:\n-â”Š 55â”Š   â”Š          '$2a$08$xE4FuCi/ifxjL2S8CzKAmuKLwv18ktksSN.F3XYEnpmcKtpbpeZgO', // 222\n-â”Š 56â”Š   â”Š        picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n-â”Š 57â”Š   â”Š      },\n-â”Š 58â”Š   â”Š      {\n-â”Š 59â”Š   â”Š        id: '3',\n-â”Š 60â”Š   â”Š        name: 'Bryan Wallace',\n-â”Š 61â”Š   â”Š        username: 'bryan',\n-â”Š 62â”Š   â”Š        password:\n-â”Š 63â”Š   â”Š          '$2a$08$UHgH7J8G6z1mGQn2qx2kdeWv0jvgHItyAsL9hpEUI3KJmhVW5Q1d.', // 333\n-â”Š 64â”Š   â”Š        picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n-â”Š 65â”Š   â”Š      },\n-â”Š 66â”Š   â”Š      {\n-â”Š 67â”Š   â”Š        id: '4',\n-â”Š 68â”Š   â”Š        name: 'Avery Stewart',\n-â”Š 69â”Š   â”Š        username: 'avery',\n-â”Š 70â”Š   â”Š        password:\n-â”Š 71â”Š   â”Š          '$2a$08$wR1k5Q3T9FC7fUgB7Gdb9Os/GV7dGBBf4PLlWT7HERMFhmFDt47xi', // 444\n-â”Š 72â”Š   â”Š        picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n-â”Š 73â”Š   â”Š      },\n-â”Š 74â”Š   â”Š      {\n-â”Š 75â”Š   â”Š        id: '5',\n-â”Š 76â”Š   â”Š        name: 'Katie Peterson',\n-â”Š 77â”Š   â”Š        username: 'katie',\n-â”Š 78â”Š   â”Š        password:\n-â”Š 79â”Š   â”Š          '$2a$08$6.mbXqsDX82ZZ7q5d8Osb..JrGSsNp4R3IKj7mxgF6YGT0OmMw242', // 555\n-â”Š 80â”Š   â”Š        picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n-â”Š 81â”Š   â”Š      },\n-â”Š 82â”Š   â”Š    ]\n+â”Š   â”Š 39â”Šexport const resetDb = async () => {\n+â”Š   â”Š 40â”Š  await pool.query(sql`DELETE FROM users`);\n+â”Š   â”Š 41â”Š\n+â”Š   â”Š 42â”Š  const sampleUsers = [\n+â”Š   â”Š 43â”Š    {\n+â”Š   â”Š 44â”Š      id: '1',\n+â”Š   â”Š 45â”Š      name: 'Ray Edwards',\n+â”Š   â”Š 46â”Š      username: 'ray',\n+â”Š   â”Š 47â”Š      password: '$2a$08$NO9tkFLCoSqX1c5wk3s7z.JfxaVMKA.m7zUDdDwEquo4rvzimQeJm', // 111\n+â”Š   â”Š 48â”Š      picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n+â”Š   â”Š 49â”Š    },\n+â”Š   â”Š 50â”Š    {\n+â”Š   â”Š 51â”Š      id: '2',\n+â”Š   â”Š 52â”Š      name: 'Ethan Gonzalez',\n+â”Š   â”Š 53â”Š      username: 'ethan',\n+â”Š   â”Š 54â”Š      password: '$2a$08$xE4FuCi/ifxjL2S8CzKAmuKLwv18ktksSN.F3XYEnpmcKtpbpeZgO', // 222\n+â”Š   â”Š 55â”Š      picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n+â”Š   â”Š 56â”Š    },\n+â”Š   â”Š 57â”Š    {\n+â”Š   â”Š 58â”Š      id: '3',\n+â”Š   â”Š 59â”Š      name: 'Bryan Wallace',\n+â”Š   â”Š 60â”Š      username: 'bryan',\n+â”Š   â”Š 61â”Š      password: '$2a$08$UHgH7J8G6z1mGQn2qx2kdeWv0jvgHItyAsL9hpEUI3KJmhVW5Q1d.', // 333\n+â”Š   â”Š 62â”Š      picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n+â”Š   â”Š 63â”Š    },\n+â”Š   â”Š 64â”Š    {\n+â”Š   â”Š 65â”Š      id: '4',\n+â”Š   â”Š 66â”Š      name: 'Avery Stewart',\n+â”Š   â”Š 67â”Š      username: 'avery',\n+â”Š   â”Š 68â”Š      password: '$2a$08$wR1k5Q3T9FC7fUgB7Gdb9Os/GV7dGBBf4PLlWT7HERMFhmFDt47xi', // 444\n+â”Š   â”Š 69â”Š      picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n+â”Š   â”Š 70â”Š    },\n+â”Š   â”Š 71â”Š    {\n+â”Š   â”Š 72â”Š      id: '5',\n+â”Š   â”Š 73â”Š      name: 'Katie Peterson',\n+â”Š   â”Š 74â”Š      username: 'katie',\n+â”Š   â”Š 75â”Š      password: '$2a$08$6.mbXqsDX82ZZ7q5d8Osb..JrGSsNp4R3IKj7mxgF6YGT0OmMw242', // 555\n+â”Š   â”Š 76â”Š      picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n+â”Š   â”Š 77â”Š    },\n+â”Š   â”Š 78â”Š  ];\n+â”Š   â”Š 79â”Š\n+â”Š   â”Š 80â”Š  for (const sampleUser of sampleUsers) {\n+â”Š   â”Š 81â”Š    await pool.query(sql`\n+â”Š   â”Š 82â”Š      INSERT INTO users(id, name, username, password, picture)\n+â”Š   â”Š 83â”Š      VALUES(${sampleUser.id}, ${sampleUser.name}, ${sampleUser.username}, ${\n+â”Š   â”Š 84â”Š      sampleUser.password\n+â”Š   â”Š 85â”Š    }, ${sampleUser.picture})\n+â”Š   â”Š 86â”Š    `);\n+â”Š   â”Š 87â”Š  }\n+â”Š   â”Š 88â”Š\n+â”Š   â”Š 89â”Š  await pool.query(\n+â”Š   â”Š 90â”Š    sql`SELECT setval('users_id_seq', (SELECT max(id) FROM users))`\n â”Š 83â”Š 91â”Š  );\n â”Š 84â”Š 92â”Š\n-â”Š 85â”Š   â”Š  messages.splice(\n-â”Š 86â”Š   â”Š    0,\n-â”Š 87â”Š   â”Š    Infinity,\n-â”Š 88â”Š   â”Š    ...[\n-â”Š 89â”Š   â”Š      {\n-â”Š 90â”Š   â”Š        id: '1',\n-â”Š 91â”Š   â”Š        content: 'You on your way?',\n-â”Š 92â”Š   â”Š        createdAt: new Date(new Date('1-1-2019').getTime() - 60 * 1000 * 1000),\n-â”Š 93â”Š   â”Š        sender: '1',\n-â”Š 94â”Š   â”Š        recipient: '2',\n-â”Š 95â”Š   â”Š      },\n-â”Š 96â”Š   â”Š      {\n-â”Š 97â”Š   â”Š        id: '2',\n-â”Š 98â”Š   â”Š        content: \"Hey, it's me\",\n-â”Š 99â”Š   â”Š        createdAt: new Date(\n-â”Š100â”Š   â”Š          new Date('1-1-2019').getTime() - 2 * 60 * 1000 * 1000\n-â”Š101â”Š   â”Š        ),\n-â”Š102â”Š   â”Š        sender: '1',\n-â”Š103â”Š   â”Š        recipient: '3',\n-â”Š104â”Š   â”Š      },\n-â”Š105â”Š   â”Š      {\n-â”Š106â”Š   â”Š        id: '3',\n-â”Š107â”Š   â”Š        content: 'I should buy a boat',\n-â”Š108â”Š   â”Š        createdAt: new Date(\n-â”Š109â”Š   â”Š          new Date('1-1-2019').getTime() - 24 * 60 * 1000 * 1000\n-â”Š110â”Š   â”Š        ),\n-â”Š111â”Š   â”Š        sender: '1',\n-â”Š112â”Š   â”Š        recipient: '4',\n-â”Š113â”Š   â”Š      },\n-â”Š114â”Š   â”Š      {\n-â”Š115â”Š   â”Š        id: '4',\n-â”Š116â”Š   â”Š        content: 'This is wicked good ice cream.',\n-â”Š117â”Š   â”Š        createdAt: new Date(\n-â”Š118â”Š   â”Š          new Date('1-1-2019').getTime() - 14 * 24 * 60 * 1000 * 1000\n-â”Š119â”Š   â”Š        ),\n-â”Š120â”Š   â”Š        sender: '1',\n-â”Š121â”Š   â”Š        recipient: '5',\n-â”Š122â”Š   â”Š      },\n-â”Š123â”Š   â”Š    ]\n+â”Š   â”Š 93â”Š  await pool.query(sql`DELETE FROM chats`);\n+â”Š   â”Š 94â”Š\n+â”Š   â”Š 95â”Š  const sampleChats = [\n+â”Š   â”Š 96â”Š    {\n+â”Š   â”Š 97â”Š      id: '1',\n+â”Š   â”Š 98â”Š    },\n+â”Š   â”Š 99â”Š    {\n+â”Š   â”Š100â”Š      id: '2',\n+â”Š   â”Š101â”Š    },\n+â”Š   â”Š102â”Š    {\n+â”Š   â”Š103â”Š      id: '3',\n+â”Š   â”Š104â”Š    },\n+â”Š   â”Š105â”Š    {\n+â”Š   â”Š106â”Š      id: '4',\n+â”Š   â”Š107â”Š    },\n+â”Š   â”Š108â”Š  ];\n+â”Š   â”Š109â”Š\n+â”Š   â”Š110â”Š  for (const sampleChat of sampleChats) {\n+â”Š   â”Š111â”Š    await pool.query(sql`\n+â”Š   â”Š112â”Š      INSERT INTO chats(id)\n+â”Š   â”Š113â”Š      VALUES(${sampleChat.id})\n+â”Š   â”Š114â”Š    `);\n+â”Š   â”Š115â”Š  }\n+â”Š   â”Š116â”Š\n+â”Š   â”Š117â”Š  await pool.query(\n+â”Š   â”Š118â”Š    sql`SELECT setval('chats_id_seq', (SELECT max(id) FROM chats))`\n â”Š124â”Š119â”Š  );\n â”Š125â”Š120â”Š\n-â”Š126â”Š   â”Š  chats.splice(\n-â”Š127â”Š   â”Š    0,\n-â”Š128â”Š   â”Š    Infinity,\n-â”Š129â”Š   â”Š    ...[\n-â”Š130â”Š   â”Š      {\n-â”Š131â”Š   â”Š        id: '1',\n-â”Š132â”Š   â”Š        participants: ['1', '2'],\n-â”Š133â”Š   â”Š        messages: ['1'],\n-â”Š134â”Š   â”Š      },\n-â”Š135â”Š   â”Š      {\n-â”Š136â”Š   â”Š        id: '2',\n-â”Š137â”Š   â”Š        participants: ['1', '3'],\n-â”Š138â”Š   â”Š        messages: ['2'],\n-â”Š139â”Š   â”Š      },\n-â”Š140â”Š   â”Š      {\n-â”Š141â”Š   â”Š        id: '3',\n-â”Š142â”Š   â”Š        participants: ['1', '4'],\n-â”Š143â”Š   â”Š        messages: ['3'],\n-â”Š144â”Š   â”Š      },\n-â”Š145â”Š   â”Š      {\n-â”Š146â”Š   â”Š        id: '4',\n-â”Š147â”Š   â”Š        participants: ['1', '5'],\n-â”Š148â”Š   â”Š        messages: ['4'],\n-â”Š149â”Š   â”Š      },\n-â”Š150â”Š   â”Š    ]\n+â”Š   â”Š121â”Š  await pool.query(sql`DELETE FROM chats_users`);\n+â”Š   â”Š122â”Š\n+â”Š   â”Š123â”Š  const sampleChatsUsers = [\n+â”Š   â”Š124â”Š    {\n+â”Š   â”Š125â”Š      chat_id: '1',\n+â”Š   â”Š126â”Š      user_id: '1',\n+â”Š   â”Š127â”Š    },\n+â”Š   â”Š128â”Š    {\n+â”Š   â”Š129â”Š      chat_id: '1',\n+â”Š   â”Š130â”Š      user_id: '2',\n+â”Š   â”Š131â”Š    },\n+â”Š   â”Š132â”Š    {\n+â”Š   â”Š133â”Š      chat_id: '2',\n+â”Š   â”Š134â”Š      user_id: '1',\n+â”Š   â”Š135â”Š    },\n+â”Š   â”Š136â”Š    {\n+â”Š   â”Š137â”Š      chat_id: '2',\n+â”Š   â”Š138â”Š      user_id: '3',\n+â”Š   â”Š139â”Š    },\n+â”Š   â”Š140â”Š    {\n+â”Š   â”Š141â”Š      chat_id: '3',\n+â”Š   â”Š142â”Š      user_id: '1',\n+â”Š   â”Š143â”Š    },\n+â”Š   â”Š144â”Š    {\n+â”Š   â”Š145â”Š      chat_id: '3',\n+â”Š   â”Š146â”Š      user_id: '4',\n+â”Š   â”Š147â”Š    },\n+â”Š   â”Š148â”Š    {\n+â”Š   â”Š149â”Š      chat_id: '4',\n+â”Š   â”Š150â”Š      user_id: '1',\n+â”Š   â”Š151â”Š    },\n+â”Š   â”Š152â”Š    {\n+â”Š   â”Š153â”Š      chat_id: '4',\n+â”Š   â”Š154â”Š      user_id: '5',\n+â”Š   â”Š155â”Š    },\n+â”Š   â”Š156â”Š  ];\n+â”Š   â”Š157â”Š\n+â”Š   â”Š158â”Š  for (const sampleChatUser of sampleChatsUsers) {\n+â”Š   â”Š159â”Š    await pool.query(sql`\n+â”Š   â”Š160â”Š      INSERT INTO chats_users(chat_id, user_id)\n+â”Š   â”Š161â”Š      VALUES(${sampleChatUser.chat_id}, ${sampleChatUser.user_id})\n+â”Š   â”Š162â”Š    `);\n+â”Š   â”Š163â”Š  }\n+â”Š   â”Š164â”Š\n+â”Š   â”Š165â”Š  await pool.query(sql`DELETE FROM messages`);\n+â”Š   â”Š166â”Š\n+â”Š   â”Š167â”Š  const baseTime = new Date('1 Jan 2019 GMT').getTime();\n+â”Š   â”Š168â”Š\n+â”Š   â”Š169â”Š  const sampleMessages = [\n+â”Š   â”Š170â”Š    {\n+â”Š   â”Š171â”Š      id: '1',\n+â”Š   â”Š172â”Š      content: 'You on your way?',\n+â”Š   â”Š173â”Š      created_at: new Date(baseTime - 60 * 1000 * 1000),\n+â”Š   â”Š174â”Š      chat_id: '1',\n+â”Š   â”Š175â”Š      sender_user_id: '1',\n+â”Š   â”Š176â”Š    },\n+â”Š   â”Š177â”Š    {\n+â”Š   â”Š178â”Š      id: '2',\n+â”Š   â”Š179â”Š      content: \"Hey, it's me\",\n+â”Š   â”Š180â”Š      created_at: new Date(baseTime - 2 * 60 * 1000 * 1000),\n+â”Š   â”Š181â”Š      chat_id: '2',\n+â”Š   â”Š182â”Š      sender_user_id: '1',\n+â”Š   â”Š183â”Š    },\n+â”Š   â”Š184â”Š    {\n+â”Š   â”Š185â”Š      id: '3',\n+â”Š   â”Š186â”Š      content: 'I should buy a boat',\n+â”Š   â”Š187â”Š      created_at: new Date(baseTime - 24 * 60 * 1000 * 1000),\n+â”Š   â”Š188â”Š      chat_id: '3',\n+â”Š   â”Š189â”Š      sender_user_id: '1',\n+â”Š   â”Š190â”Š    },\n+â”Š   â”Š191â”Š    {\n+â”Š   â”Š192â”Š      id: '4',\n+â”Š   â”Š193â”Š      content: 'This is wicked good ice cream.',\n+â”Š   â”Š194â”Š      created_at: new Date(baseTime - 14 * 24 * 60 * 1000 * 1000),\n+â”Š   â”Š195â”Š      chat_id: '4',\n+â”Š   â”Š196â”Š      sender_user_id: '1',\n+â”Š   â”Š197â”Š    },\n+â”Š   â”Š198â”Š  ];\n+â”Š   â”Š199â”Š\n+â”Š   â”Š200â”Š  for (const sampleMessage of sampleMessages) {\n+â”Š   â”Š201â”Š    await pool.query(sql`\n+â”Š   â”Š202â”Š      INSERT INTO messages(id, content, created_at, chat_id, sender_user_id)\n+â”Š   â”Š203â”Š      VALUES(${sampleMessage.id}, ${sampleMessage.content}, ${\n+â”Š   â”Š204â”Š      sampleMessage.created_at\n+â”Š   â”Š205â”Š    }, ${sampleMessage.chat_id}, ${sampleMessage.sender_user_id})\n+â”Š   â”Š206â”Š    `);\n+â”Š   â”Š207â”Š  }\n+â”Š   â”Š208â”Š\n+â”Š   â”Š209â”Š  await pool.query(\n+â”Š   â”Š210â”Š    sql`SELECT setval('messages_id_seq', (SELECT max(id) FROM messages))`\n â”Š151â”Š211â”Š  );\n â”Š152â”Š212â”Š};\n â”Š153â”Š213â”Š\n-â”Š154â”Š   â”ŠresetDb();\n+â”Š   â”Š214â”Šif (envResetDb) {\n+â”Š   â”Š215â”Š  resetDb();\n+â”Š   â”Š216â”Š}\n```\n\n##### Changed env.ts\n```diff\n@@ -4,3 +4,4 @@\n â”Š4â”Š4â”Šexport const secret = process.env.JWT_SECRET || '70p53cr37';\n â”Š5â”Š5â”Šexport const origin = process.env.ORIGIN || 'http://localhost:3000';\n â”Š6â”Š6â”Šexport const port = process.env.PORT || 4000;\n+â”Š â”Š7â”Šexport const resetDb = process.env.RESET_DB || false;\n```\n\n[}]: #\n\n> When you update tables with your own ID values, you have to update `SEQUENCE`; because PostgreSQL calculates the next ID value using `SEQUENCE`s.\n\n**Updating Resolvers**\n\nWe will benefit from transactions for complicated SQL queries in mutation. Transactions will help us to rollback our changes if there is an exception in the middle of our operations.\n\n[{]: <helper> (diffStep 11.6 files=\"resolvers\" module=\"server\")\n\n#### [__Server__ Step 11.6: Updating Resolvers with SQL](https://github.com/Urigo/WhatsApp-Clone-Server/commit/3655ca3d93cdd1784b8324ed3539bc03b4526b09)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,72 +1,104 @@\n â”Š  1â”Š  1â”Šimport { withFilter } from 'apollo-server-express';\n â”Š  2â”Š  2â”Šimport { GraphQLDateTime } from 'graphql-iso-date';\n-â”Š  3â”Š   â”Šimport { User, Message, Chat, chats, messages, users } from '../db';\n+â”Š   â”Š  3â”Šimport { Message, Chat, pool } from '../db';\n â”Š  4â”Š  4â”Šimport { Resolvers } from '../types/graphql';\n â”Š  5â”Š  5â”Šimport { secret, expiration } from '../env';\n â”Š  6â”Š  6â”Šimport bcrypt from 'bcrypt';\n â”Š  7â”Š  7â”Šimport jwt from 'jsonwebtoken';\n â”Š  8â”Š  8â”Šimport { validateLength, validatePassword } from '../validators';\n+â”Š   â”Š  9â”Šimport sql from 'sql-template-strings';\n â”Š  9â”Š 10â”Š\n â”Š 10â”Š 11â”Šconst resolvers: Resolvers = {\n â”Š 11â”Š 12â”Š  Date: GraphQLDateTime,\n â”Š 12â”Š 13â”Š\n â”Š 13â”Š 14â”Š  Message: {\n-â”Š 14â”Š   â”Š    chat(message) {\n-â”Š 15â”Š   â”Š      return chats.find(c => c.messages.some(m => m === message.id)) || null;\n+â”Š   â”Š 15â”Š    createdAt(message) {\n+â”Š   â”Š 16â”Š      return new Date(message.created_at);\n â”Š 16â”Š 17â”Š    },\n â”Š 17â”Š 18â”Š\n-â”Š 18â”Š   â”Š    sender(message) {\n-â”Š 19â”Š   â”Š      return users.find(u => u.id === message.sender) || null;\n+â”Š   â”Š 19â”Š    async chat(message, args, { db }) {\n+â”Š   â”Š 20â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š 21â”Š        SELECT * FROM chats WHERE id = ${message.chat_id}\n+â”Š   â”Š 22â”Š      `);\n+â”Š   â”Š 23â”Š      return rows[0] || null;\n â”Š 20â”Š 24â”Š    },\n â”Š 21â”Š 25â”Š\n-â”Š 22â”Š   â”Š    recipient(message) {\n-â”Š 23â”Š   â”Š      return users.find(u => u.id === message.recipient) || null;\n+â”Š   â”Š 26â”Š    async sender(message, args, { db }) {\n+â”Š   â”Š 27â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š 28â”Š        SELECT * FROM users WHERE id = ${message.sender_user_id}\n+â”Š   â”Š 29â”Š      `);\n+â”Š   â”Š 30â”Š      return rows[0] || null;\n+â”Š   â”Š 31â”Š    },\n+â”Š   â”Š 32â”Š\n+â”Š   â”Š 33â”Š    async recipient(message, args, { db }) {\n+â”Š   â”Š 34â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š 35â”Š        SELECT users.* FROM users, chats_users\n+â”Š   â”Š 36â”Š        WHERE chats_users.user_id != ${message.sender_user_id}\n+â”Š   â”Š 37â”Š        AND chats_users.chat_id = ${message.chat_id}\n+â”Š   â”Š 38â”Š      `);\n+â”Š   â”Š 39â”Š      return rows[0] || null;\n â”Š 24â”Š 40â”Š    },\n â”Š 25â”Š 41â”Š\n â”Š 26â”Š 42â”Š    isMine(message, args, { currentUser }) {\n-â”Š 27â”Š   â”Š      return message.sender === currentUser.id;\n+â”Š   â”Š 43â”Š      return message.sender_user_id === currentUser.id;\n â”Š 28â”Š 44â”Š    },\n â”Š 29â”Š 45â”Š  },\n â”Š 30â”Š 46â”Š\n â”Š 31â”Š 47â”Š  Chat: {\n-â”Š 32â”Š   â”Š    name(chat, args, { currentUser }) {\n+â”Š   â”Š 48â”Š    async name(chat, args, { currentUser, db }) {\n â”Š 33â”Š 49â”Š      if (!currentUser) return null;\n â”Š 34â”Š 50â”Š\n-â”Š 35â”Š   â”Š      const participantId = chat.participants.find(p => p !== currentUser.id);\n+â”Š   â”Š 51â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š 52â”Š        SELECT users.* FROM users, chats_users\n+â”Š   â”Š 53â”Š        WHERE users.id != ${currentUser.id}\n+â”Š   â”Š 54â”Š        AND users.id = chats_users.user_id\n+â”Š   â”Š 55â”Š        AND chats_users.chat_id = ${chat.id}`);\n â”Š 36â”Š 56â”Š\n-â”Š 37â”Š   â”Š      if (!participantId) return null;\n-â”Š 38â”Š   â”Š\n-â”Š 39â”Š   â”Š      const participant = users.find(u => u.id === participantId);\n+â”Š   â”Š 57â”Š      const participant = rows[0];\n â”Š 40â”Š 58â”Š\n â”Š 41â”Š 59â”Š      return participant ? participant.name : null;\n â”Š 42â”Š 60â”Š    },\n â”Š 43â”Š 61â”Š\n-â”Š 44â”Š   â”Š    picture(chat, args, { currentUser }) {\n+â”Š   â”Š 62â”Š    async picture(chat, args, { currentUser, db }) {\n â”Š 45â”Š 63â”Š      if (!currentUser) return null;\n â”Š 46â”Š 64â”Š\n-â”Š 47â”Š   â”Š      const participantId = chat.participants.find(p => p !== currentUser.id);\n-â”Š 48â”Š   â”Š\n-â”Š 49â”Š   â”Š      if (!participantId) return null;\n+â”Š   â”Š 65â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š 66â”Š        SELECT users.* FROM users, chats_users\n+â”Š   â”Š 67â”Š        WHERE users.id != ${currentUser.id}\n+â”Š   â”Š 68â”Š        AND users.id = chats_users.user_id\n+â”Š   â”Š 69â”Š        AND chats_users.chat_id = ${chat.id}`);\n â”Š 50â”Š 70â”Š\n-â”Š 51â”Š   â”Š      const participant = users.find(u => u.id === participantId);\n+â”Š   â”Š 71â”Š      const participant = rows[0];\n â”Š 52â”Š 72â”Š\n â”Š 53â”Š 73â”Š      return participant ? participant.picture : null;\n â”Š 54â”Š 74â”Š    },\n â”Š 55â”Š 75â”Š\n-â”Š 56â”Š   â”Š    messages(chat) {\n-â”Š 57â”Š   â”Š      return messages.filter(m => chat.messages.includes(m.id));\n+â”Š   â”Š 76â”Š    async messages(chat, args, { db }) {\n+â”Š   â”Š 77â”Š      const { rows } = await db.query(\n+â”Š   â”Š 78â”Š        sql`SELECT * FROM messages WHERE chat_id = ${chat.id}`\n+â”Š   â”Š 79â”Š      );\n+â”Š   â”Š 80â”Š\n+â”Š   â”Š 81â”Š      return rows;\n â”Š 58â”Š 82â”Š    },\n â”Š 59â”Š 83â”Š\n-â”Š 60â”Š   â”Š    lastMessage(chat) {\n-â”Š 61â”Š   â”Š      const lastMessage = chat.messages[chat.messages.length - 1];\n+â”Š   â”Š 84â”Š    async lastMessage(chat, args, { db }) {\n+â”Š   â”Š 85â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š 86â”Š        SELECT * FROM messages\n+â”Š   â”Š 87â”Š        WHERE chat_id = ${chat.id}\n+â”Š   â”Š 88â”Š        ORDER BY created_at DESC\n+â”Š   â”Š 89â”Š        LIMIT 1`);\n â”Š 62â”Š 90â”Š\n-â”Š 63â”Š   â”Š      return messages.find(m => m.id === lastMessage) || null;\n+â”Š   â”Š 91â”Š      return rows[0];\n â”Š 64â”Š 92â”Š    },\n â”Š 65â”Š 93â”Š\n-â”Š 66â”Š   â”Š    participants(chat) {\n-â”Š 67â”Š   â”Š      return chat.participants\n-â”Š 68â”Š   â”Š        .map(p => users.find(u => u.id === p))\n-â”Š 69â”Š   â”Š        .filter(Boolean) as User[];\n+â”Š   â”Š 94â”Š    async participants(chat, args, { db }) {\n+â”Š   â”Š 95â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š 96â”Š        SELECT users.* FROM users, chats_users\n+â”Š   â”Š 97â”Š        WHERE chats_users.chat_id = ${chat.id}\n+â”Š   â”Š 98â”Š        AND chats_users.user_id = users.id\n+â”Š   â”Š 99â”Š      `);\n+â”Š   â”Š100â”Š\n+â”Š   â”Š101â”Š      return rows;\n â”Š 70â”Š102â”Š    },\n â”Š 71â”Š103â”Š  },\n â”Š 72â”Š104â”Š\n```\n```diff\n@@ -75,32 +107,48 @@\n â”Š 75â”Š107â”Š      return currentUser || null;\n â”Š 76â”Š108â”Š    },\n â”Š 77â”Š109â”Š\n-â”Š 78â”Š   â”Š    chats(root, args, { currentUser }) {\n+â”Š   â”Š110â”Š    async chats(root, args, { currentUser, db }) {\n â”Š 79â”Š111â”Š      if (!currentUser) return [];\n â”Š 80â”Š112â”Š\n-â”Š 81â”Š   â”Š      return chats.filter(c => c.participants.includes(currentUser.id));\n+â”Š   â”Š113â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š114â”Š        SELECT chats.* FROM chats, chats_users\n+â”Š   â”Š115â”Š        WHERE chats.id = chats_users.chat_id\n+â”Š   â”Š116â”Š        AND chats_users.user_id = ${currentUser.id}\n+â”Š   â”Š117â”Š      `);\n+â”Š   â”Š118â”Š\n+â”Š   â”Š119â”Š      return rows;\n â”Š 82â”Š120â”Š    },\n â”Š 83â”Š121â”Š\n-â”Š 84â”Š   â”Š    chat(root, { chatId }, { currentUser }) {\n+â”Š   â”Š122â”Š    async chat(root, { chatId }, { currentUser, db }) {\n â”Š 85â”Š123â”Š      if (!currentUser) return null;\n â”Š 86â”Š124â”Š\n-â”Š 87â”Š   â”Š      const chat = chats.find(c => c.id === chatId);\n+â”Š   â”Š125â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š126â”Š        SELECT chats.* FROM chats, chats_users\n+â”Š   â”Š127â”Š        WHERE chats_users.chat_id = ${chatId}\n+â”Š   â”Š128â”Š        AND chats.id = chats_users.chat_id\n+â”Š   â”Š129â”Š        AND chats_users.user_id = ${currentUser.id}\n+â”Š   â”Š130â”Š      `);\n â”Š 88â”Š131â”Š\n-â”Š 89â”Š   â”Š      if (!chat) return null;\n-â”Š 90â”Š   â”Š\n-â”Š 91â”Š   â”Š      return chat.participants.includes(currentUser.id) ? chat : null;\n+â”Š   â”Š132â”Š      return rows[0] ? rows[0] : null;\n â”Š 92â”Š133â”Š    },\n â”Š 93â”Š134â”Š\n-â”Š 94â”Š   â”Š    users(root, args, { currentUser }) {\n+â”Š   â”Š135â”Š    async users(root, args, { currentUser, db }) {\n â”Š 95â”Š136â”Š      if (!currentUser) return [];\n â”Š 96â”Š137â”Š\n-â”Š 97â”Š   â”Š      return users.filter(u => u.id !== currentUser.id);\n+â”Š   â”Š138â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š139â”Š        SELECT * FROM users WHERE users.id != ${currentUser.id}\n+â”Š   â”Š140â”Š      `);\n+â”Š   â”Š141â”Š\n+â”Š   â”Š142â”Š      return rows;\n â”Š 98â”Š143â”Š    },\n â”Š 99â”Š144â”Š  },\n â”Š100â”Š145â”Š\n â”Š101â”Š146â”Š  Mutation: {\n-â”Š102â”Š   â”Š    signIn(root, { username, password }, { res }) {\n-â”Š103â”Š   â”Š      const user = users.find(u => u.username === username);\n+â”Š   â”Š147â”Š    async signIn(root, { username, password }, { db, res }) {\n+â”Š   â”Š148â”Š      const { rows } = await db.query(\n+â”Š   â”Š149â”Š        sql`SELECT * FROM users WHERE username = ${username}`\n+â”Š   â”Š150â”Š      );\n+â”Š   â”Š151â”Š      const user = rows[0];\n â”Š104â”Š152â”Š\n â”Š105â”Š153â”Š      if (!user) {\n â”Š106â”Š154â”Š        throw new Error('user not found');\n```\n```diff\n@@ -119,7 +167,7 @@\n â”Š119â”Š167â”Š      return user;\n â”Š120â”Š168â”Š    },\n â”Š121â”Š169â”Š\n-â”Š122â”Š   â”Š    signUp(root, { name, username, password, passwordConfirm }) {\n+â”Š   â”Š170â”Š    async signUp(root, { name, username, password, passwordConfirm }, { db }) {\n â”Š123â”Š171â”Š      validateLength('req.name', name, 3, 50);\n â”Š124â”Š172â”Š      validateLength('req.username', username, 3, 18);\n â”Š125â”Š173â”Š      validatePassword('req.password', password);\n```\n```diff\n@@ -128,114 +176,131 @@\n â”Š128â”Š176â”Š        throw Error(\"req.password and req.passwordConfirm don't match\");\n â”Š129â”Š177â”Š      }\n â”Š130â”Š178â”Š\n-â”Š131â”Š   â”Š      if (users.some(u => u.username === username)) {\n+â”Š   â”Š179â”Š      const existingUserQuery = await db.query(\n+â”Š   â”Š180â”Š        sql`SELECT * FROM users WHERE username = ${username}`\n+â”Š   â”Š181â”Š      );\n+â”Š   â”Š182â”Š      if (existingUserQuery.rows[0]) {\n â”Š132â”Š183â”Š        throw Error('username already exists');\n â”Š133â”Š184â”Š      }\n â”Š134â”Š185â”Š\n â”Š135â”Š186â”Š      const passwordHash = bcrypt.hashSync(password, bcrypt.genSaltSync(8));\n â”Š136â”Š187â”Š\n-â”Š137â”Š   â”Š      const user: User = {\n-â”Š138â”Š   â”Š        id: String(users.length + 1),\n-â”Š139â”Š   â”Š        password: passwordHash,\n-â”Š140â”Š   â”Š        picture: '',\n-â”Š141â”Š   â”Š        username,\n-â”Š142â”Š   â”Š        name,\n-â”Š143â”Š   â”Š      };\n+â”Š   â”Š188â”Š      const createdUserQuery = await db.query(sql`\n+â”Š   â”Š189â”Š        INSERT INTO users(password, picture, username, name)\n+â”Š   â”Š190â”Š        VALUES(${passwordHash}, '', ${username}, ${name})\n+â”Š   â”Š191â”Š        RETURNING *\n+â”Š   â”Š192â”Š      `);\n â”Š144â”Š193â”Š\n-â”Š145â”Š   â”Š      users.push(user);\n+â”Š   â”Š194â”Š      const user = createdUserQuery.rows[0];\n â”Š146â”Š195â”Š\n â”Š147â”Š196â”Š      return user;\n â”Š148â”Š197â”Š    },\n â”Š149â”Š198â”Š\n-â”Š150â”Š   â”Š    addMessage(root, { chatId, content }, { currentUser, pubsub }) {\n+â”Š   â”Š199â”Š    async addMessage(root, { chatId, content }, { currentUser, pubsub, db }) {\n â”Š151â”Š200â”Š      if (!currentUser) return null;\n â”Š152â”Š201â”Š\n-â”Š153â”Š   â”Š      const chatIndex = chats.findIndex(c => c.id === chatId);\n-â”Š154â”Š   â”Š\n-â”Š155â”Š   â”Š      if (chatIndex === -1) return null;\n-â”Š156â”Š   â”Š\n-â”Š157â”Š   â”Š      const chat = chats[chatIndex];\n-â”Š158â”Š   â”Š      if (!chat.participants.includes(currentUser.id)) return null;\n-â”Š159â”Š   â”Š\n-â”Š160â”Š   â”Š      const messagesIds = messages.map(currentMessage => Number(currentMessage.id));\n-â”Š161â”Š   â”Š      const messageId = String(Math.max(...messagesIds) + 1);\n-â”Š162â”Š   â”Š      const message: Message = {\n-â”Š163â”Š   â”Š        id: messageId,\n-â”Š164â”Š   â”Š        createdAt: new Date(),\n-â”Š165â”Š   â”Š        sender: currentUser.id,\n-â”Š166â”Š   â”Š        recipient: chat.participants.find(p => p !== currentUser.id) as string,\n-â”Š167â”Š   â”Š        content,\n-â”Š168â”Š   â”Š      };\n+â”Š   â”Š202â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š203â”Š        INSERT INTO messages(chat_id, sender_user_id, content)\n+â”Š   â”Š204â”Š        VALUES(${chatId}, ${currentUser.id}, ${content})\n+â”Š   â”Š205â”Š        RETURNING *\n+â”Š   â”Š206â”Š      `);\n â”Š169â”Š207â”Š\n-â”Š170â”Š   â”Š      messages.push(message);\n-â”Š171â”Š   â”Š      chat.messages.push(messageId);\n-â”Š172â”Š   â”Š      // The chat will appear at the top of the ChatsList component\n-â”Š173â”Š   â”Š      chats.splice(chatIndex, 1);\n-â”Š174â”Š   â”Š      chats.unshift(chat);\n+â”Š   â”Š208â”Š      const messageAdded = rows[0];\n â”Š175â”Š209â”Š\n â”Š176â”Š210â”Š      pubsub.publish('messageAdded', {\n-â”Š177â”Š   â”Š        messageAdded: message,\n+â”Š   â”Š211â”Š        messageAdded,\n â”Š178â”Š212â”Š      });\n â”Š179â”Š213â”Š\n-â”Š180â”Š   â”Š      return message;\n+â”Š   â”Š214â”Š      return messageAdded;\n â”Š181â”Š215â”Š    },\n â”Š182â”Š216â”Š\n-â”Š183â”Š   â”Š    addChat(root, { recipientId }, { currentUser, pubsub }) {\n+â”Š   â”Š217â”Š    async addChat(root, { recipientId }, { currentUser, pubsub, db }) {\n â”Š184â”Š218â”Š      if (!currentUser) return null;\n-â”Š185â”Š   â”Š      if (!users.some(u => u.id === recipientId)) return null;\n â”Š186â”Š219â”Š\n-â”Š187â”Š   â”Š      let chat = chats.find(\n-â”Š188â”Š   â”Š        c =>\n-â”Š189â”Š   â”Š          c.participants.includes(currentUser.id) &&\n-â”Š190â”Š   â”Š          c.participants.includes(recipientId)\n-â”Š191â”Š   â”Š      );\n+â”Š   â”Š220â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š221â”Š        SELECT chats.* FROM chats, (SELECT * FROM chats_users WHERE user_id = ${\n+â”Š   â”Š222â”Š          currentUser.id\n+â”Š   â”Š223â”Š        }) AS chats_of_current_user, chats_users\n+â”Š   â”Š224â”Š        WHERE chats_users.chat_id = chats_of_current_user.chat_id\n+â”Š   â”Š225â”Š        AND chats.id = chats_users.chat_id\n+â”Š   â”Š226â”Š        AND chats_users.user_id = ${recipientId}\n+â”Š   â”Š227â”Š      `);\n+â”Š   â”Š228â”Š\n+â”Š   â”Š229â”Š      // If there is already a chat between these two users, return it\n+â”Š   â”Š230â”Š      if (rows[0]) {\n+â”Š   â”Š231â”Š        return rows[0];\n+â”Š   â”Š232â”Š      }\n â”Š192â”Š233â”Š\n-â”Š193â”Š   â”Š      if (chat) return chat;\n+â”Š   â”Š234â”Š      try {\n+â”Š   â”Š235â”Š        await db.query('BEGIN');\n â”Š194â”Š236â”Š\n-â”Š195â”Š   â”Š      const chatsIds = chats.map(c => Number(c.id));\n+â”Š   â”Š237â”Š        const { rows } = await db.query(sql`\n+â”Š   â”Š238â”Š          INSERT INTO chats\n+â”Š   â”Š239â”Š          DEFAULT VALUES\n+â”Š   â”Š240â”Š          RETURNING *\n+â”Š   â”Š241â”Š        `);\n â”Š196â”Š242â”Š\n-â”Š197â”Š   â”Š      chat = {\n-â”Š198â”Š   â”Š        id: String(Math.max(...chatsIds) + 1),\n-â”Š199â”Š   â”Š        participants: [currentUser.id, recipientId],\n-â”Š200â”Š   â”Š        messages: [],\n-â”Š201â”Š   â”Š      };\n+â”Š   â”Š243â”Š        const chatAdded = rows[0];\n â”Š202â”Š244â”Š\n-â”Š203â”Š   â”Š      chats.push(chat);\n+â”Š   â”Š245â”Š        await db.query(sql`\n+â”Š   â”Š246â”Š          INSERT INTO chats_users(chat_id, user_id)\n+â”Š   â”Š247â”Š          VALUES(${chatAdded.id}, ${currentUser.id})\n+â”Š   â”Š248â”Š        `);\n â”Š204â”Š249â”Š\n-â”Š205â”Š   â”Š      pubsub.publish('chatAdded', {\n-â”Š206â”Š   â”Š        chatAdded: chat,\n-â”Š207â”Š   â”Š      });\n+â”Š   â”Š250â”Š        await db.query(sql`\n+â”Š   â”Š251â”Š          INSERT INTO chats_users(chat_id, user_id)\n+â”Š   â”Š252â”Š          VALUES(${chatAdded.id}, ${recipientId})\n+â”Š   â”Š253â”Š        `);\n â”Š208â”Š254â”Š\n-â”Š209â”Š   â”Š      return chat;\n-â”Š210â”Š   â”Š    },\n+â”Š   â”Š255â”Š        await db.query('COMMIT');\n â”Š211â”Š256â”Š\n-â”Š212â”Š   â”Š    removeChat(root, { chatId }, { currentUser, pubsub }) {\n-â”Š213â”Š   â”Š      if (!currentUser) return null;\n+â”Š   â”Š257â”Š        pubsub.publish('chatAdded', {\n+â”Š   â”Š258â”Š          chatAdded,\n+â”Š   â”Š259â”Š        });\n â”Š214â”Š260â”Š\n-â”Š215â”Š   â”Š      const chatIndex = chats.findIndex(c => c.id === chatId);\n+â”Š   â”Š261â”Š        return chatAdded;\n+â”Š   â”Š262â”Š      } catch (e) {\n+â”Š   â”Š263â”Š        await db.query('ROLLBACK');\n+â”Š   â”Š264â”Š        throw e;\n+â”Š   â”Š265â”Š      }\n+â”Š   â”Š266â”Š    },\n â”Š216â”Š267â”Š\n-â”Š217â”Š   â”Š      if (chatIndex === -1) return null;\n+â”Š   â”Š268â”Š    async removeChat(root, { chatId }, { currentUser, pubsub, db }) {\n+â”Š   â”Š269â”Š      if (!currentUser) return null;\n â”Š218â”Š270â”Š\n-â”Š219â”Š   â”Š      const chat = chats[chatIndex];\n+â”Š   â”Š271â”Š      try {\n+â”Š   â”Š272â”Š        await db.query('BEGIN');\n â”Š220â”Š273â”Š\n-â”Š221â”Š   â”Š      if (!chat.participants.some(p => p === currentUser.id)) return null;\n+â”Š   â”Š274â”Š        const { rows } = await db.query(sql`\n+â”Š   â”Š275â”Š          SELECT chats.* FROM chats, chats_users\n+â”Š   â”Š276â”Š          WHERE id = ${chatId}\n+â”Š   â”Š277â”Š          AND chats.id = chats_users.chat_id\n+â”Š   â”Š278â”Š          AND chats_users.user_id = ${currentUser.id}\n+â”Š   â”Š279â”Š        `);\n â”Š222â”Š280â”Š\n-â”Š223â”Š   â”Š      chat.messages.forEach(chatMessage => {\n-â”Š224â”Š   â”Š        const chatMessageIndex = messages.findIndex(m => m.id === chatMessage);\n+â”Š   â”Š281â”Š        const chat = rows[0];\n â”Š225â”Š282â”Š\n-â”Š226â”Š   â”Š        if (chatMessageIndex !== -1) {\n-â”Š227â”Š   â”Š          messages.splice(chatMessageIndex, 1);\n+â”Š   â”Š283â”Š        if (!chat) {\n+â”Š   â”Š284â”Š          await db.query('ROLLBACK');\n+â”Š   â”Š285â”Š          return null;\n â”Š228â”Š286â”Š        }\n-â”Š229â”Š   â”Š      });\n â”Š230â”Š287â”Š\n-â”Š231â”Š   â”Š      chats.splice(chatIndex, 1);\n+â”Š   â”Š288â”Š        await db.query(sql`\n+â”Š   â”Š289â”Š          DELETE FROM chats WHERE chats.id = ${chatId}\n+â”Š   â”Š290â”Š        `);\n â”Š232â”Š291â”Š\n-â”Š233â”Š   â”Š      pubsub.publish('chatRemoved', {\n-â”Š234â”Š   â”Š        chatRemoved: chat.id,\n-â”Š235â”Š   â”Š        targetChat: chat,\n-â”Š236â”Š   â”Š      });\n+â”Š   â”Š292â”Š        pubsub.publish('chatRemoved', {\n+â”Š   â”Š293â”Š          chatRemoved: chat.id,\n+â”Š   â”Š294â”Š          targetChat: chat,\n+â”Š   â”Š295â”Š        });\n â”Š237â”Š296â”Š\n-â”Š238â”Š   â”Š      return chatId;\n+â”Š   â”Š297â”Š        await db.query('COMMIT');\n+â”Š   â”Š298â”Š\n+â”Š   â”Š299â”Š        return chatId;\n+â”Š   â”Š300â”Š      } catch (e) {\n+â”Š   â”Š301â”Š        await db.query('ROLLBACK');\n+â”Š   â”Š302â”Š        throw e;\n+â”Š   â”Š303â”Š      }\n â”Š239â”Š304â”Š    },\n â”Š240â”Š305â”Š  },\n â”Š241â”Š306â”Š\n```\n```diff\n@@ -243,12 +308,19 @@\n â”Š243â”Š308â”Š    messageAdded: {\n â”Š244â”Š309â”Š      subscribe: withFilter(\n â”Š245â”Š310â”Š        (root, args, { pubsub }) => pubsub.asyncIterator('messageAdded'),\n-â”Š246â”Š   â”Š        ({ messageAdded }, args, { currentUser }) => {\n+â”Š   â”Š311â”Š        async (\n+â”Š   â”Š312â”Š          { messageAdded }: { messageAdded: Message },\n+â”Š   â”Š313â”Š          args,\n+â”Š   â”Š314â”Š          { currentUser }\n+â”Š   â”Š315â”Š        ) => {\n â”Š247â”Š316â”Š          if (!currentUser) return false;\n â”Š248â”Š317â”Š\n-â”Š249â”Š   â”Š          return [messageAdded.sender, messageAdded.recipient].includes(\n-â”Š250â”Š   â”Š            currentUser.id\n-â”Š251â”Š   â”Š          );\n+â”Š   â”Š318â”Š          const { rows } = await pool.query(sql`\n+â”Š   â”Š319â”Š            SELECT * FROM chats_users\n+â”Š   â”Š320â”Š            WHERE chat_id = ${messageAdded.chat_id}\n+â”Š   â”Š321â”Š            AND user_id = ${currentUser.id}`);\n+â”Š   â”Š322â”Š\n+â”Š   â”Š323â”Š          return !!rows.length;\n â”Š252â”Š324â”Š        }\n â”Š253â”Š325â”Š      ),\n â”Š254â”Š326â”Š    },\n```\n```diff\n@@ -256,10 +328,15 @@\n â”Š256â”Š328â”Š    chatAdded: {\n â”Š257â”Š329â”Š      subscribe: withFilter(\n â”Š258â”Š330â”Š        (root, args, { pubsub }) => pubsub.asyncIterator('chatAdded'),\n-â”Š259â”Š   â”Š        ({ chatAdded }: { chatAdded: Chat }, args, { currentUser }) => {\n+â”Š   â”Š331â”Š        async ({ chatAdded }: { chatAdded: Chat }, args, { currentUser }) => {\n â”Š260â”Š332â”Š          if (!currentUser) return false;\n â”Š261â”Š333â”Š\n-â”Š262â”Š   â”Š          return chatAdded.participants.some(p => p === currentUser.id);\n+â”Š   â”Š334â”Š          const { rows } = await pool.query(sql`\n+â”Š   â”Š335â”Š            SELECT * FROM chats_users\n+â”Š   â”Š336â”Š            WHERE chat_id = ${chatAdded.id}\n+â”Š   â”Š337â”Š            AND user_id = ${currentUser.id}`);\n+â”Š   â”Š338â”Š\n+â”Š   â”Š339â”Š          return !!rows.length;\n â”Š263â”Š340â”Š        }\n â”Š264â”Š341â”Š      ),\n â”Š265â”Š342â”Š    },\n```\n```diff\n@@ -267,10 +344,15 @@\n â”Š267â”Š344â”Š    chatRemoved: {\n â”Š268â”Š345â”Š      subscribe: withFilter(\n â”Š269â”Š346â”Š        (root, args, { pubsub }) => pubsub.asyncIterator('chatRemoved'),\n-â”Š270â”Š   â”Š        ({ targetChat }: { targetChat: Chat }, args, { currentUser }) => {\n+â”Š   â”Š347â”Š        async ({ targetChat }: { targetChat: Chat }, args, { currentUser }) => {\n â”Š271â”Š348â”Š          if (!currentUser) return false;\n â”Š272â”Š349â”Š\n-â”Š273â”Š   â”Š          return targetChat.participants.some(p => p === currentUser.id);\n+â”Š   â”Š350â”Š          const { rows } = await pool.query(sql`\n+â”Š   â”Š351â”Š            SELECT * FROM chats_users\n+â”Š   â”Š352â”Š            WHERE chat_id = ${targetChat.id}\n+â”Š   â”Š353â”Š            AND user_id = ${currentUser.id}`);\n+â”Š   â”Š354â”Š\n+â”Š   â”Š355â”Š          return !!rows.length;\n â”Š274â”Š356â”Š        }\n â”Š275â”Š357â”Š      ),\n â”Š276â”Š358â”Š    },\n```\n\n[}]: #\n\n> We use `pool` itself instead of `db` from the context in the subscriptions. Remember we don't request for a new client from the pool in subscriptions.\n> If you use `pool.query`, it just opens a connection, does that operation and set the client free. In that case, you wouldn't be able to work with transactions which is not need in GraphQL Subscriptions.\n\n**Updating Subscriptions w/ PostgreSQL PubSub mechanism**\n\nApolloâ€™s default PubSub mechanism is not for production usage. So, we will use PostgreSQLâ€™s notify/listen for our PubSub mechanism in GraphQL Subscriptions.\n\nInstall the necessary packages;\n\n\t$ yarn add graphql-postgres-subscriptions\n\n[{]: <helper> (diffStep 11.7 files=\"index\" module=\"server\")\n\n#### [__Server__ Step 11.7: Updating Subscriptions w/ PostgreSQL PubSub mechanism](https://github.com/Urigo/WhatsApp-Clone-Server/commit/f7bfdf2addaf30f3a244c64459983747d5f12f8a)\n\n##### Changed index.ts\n```diff\n@@ -1,4 +1,4 @@\n-â”Š1â”Š â”Šimport { ApolloServer, gql, PubSub } from 'apollo-server-express';\n+â”Š â”Š1â”Šimport { ApolloServer } from 'apollo-server-express';\n â”Š2â”Š2â”Šimport cookie from 'cookie';\n â”Š3â”Š3â”Šimport http from 'http';\n â”Š4â”Š4â”Šimport jwt from 'jsonwebtoken';\n```\n```diff\n@@ -8,8 +8,15 @@\n â”Š 8â”Š 8â”Šimport schema from './schema';\n â”Š 9â”Š 9â”Šimport { MyContext } from './context';\n â”Š10â”Š10â”Šimport sql from 'sql-template-strings';\n+â”Š  â”Š11â”Šconst { PostgresPubSub } = require('graphql-postgres-subscriptions');\n â”Š11â”Š12â”Š\n-â”Š12â”Š  â”Šconst pubsub = new PubSub();\n+â”Š  â”Š13â”Šconst pubsub = new PostgresPubSub({\n+â”Š  â”Š14â”Š  host: 'localhost',\n+â”Š  â”Š15â”Š  port: process.env.DB_PORT ? parseInt(process.env.DB_PORT) : 5432,\n+â”Š  â”Š16â”Š  user: 'testuser',\n+â”Š  â”Š17â”Š  password: 'testpassword',\n+â”Š  â”Š18â”Š  database: 'whatsapp',\n+â”Š  â”Š19â”Š});\n â”Š13â”Š20â”Šconst server = new ApolloServer({\n â”Š14â”Š21â”Š  schema,\n â”Š15â”Š22â”Š  context: async (session: any) => {\n```\n\n[}]: #\n\n> Unfortunately `graphql-postgres-subscription` doesn't have TypeScript typings, so we have to import it using `require`.\n\n**Updating Tests**\n\nWe should update tests to use SQL instead of in-memory database.\n\n[{]: <helper> (diffStep 11.8 files=\"test\" module=\"server\")\n\n#### [__Server__ Step 11.8: Updating Tests with SQL](https://github.com/Urigo/WhatsApp-Clone-Server/commit/c7cc4cd99cd0c4bd279550285b60f2f7d7aec920)\n\n##### Changed tests&#x2F;mutations&#x2F;addChat.test.ts\n```diff\n@@ -1,18 +1,27 @@\n â”Š 1â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n â”Š 2â”Š 2â”Šimport { ApolloServer, PubSub, gql } from 'apollo-server-express';\n â”Š 3â”Š 3â”Šimport schema from '../../schema';\n-â”Š 4â”Š  â”Šimport { resetDb, users } from '../../db';\n+â”Š  â”Š 4â”Šimport { resetDb, pool } from '../../db';\n+â”Š  â”Š 5â”Šimport sql from 'sql-template-strings';\n+â”Š  â”Š 6â”Šimport { MyContext } from '../../context';\n â”Š 5â”Š 7â”Š\n â”Š 6â”Š 8â”Šdescribe('Mutation.addChat', () => {\n â”Š 7â”Š 9â”Š  beforeEach(resetDb);\n â”Š 8â”Š10â”Š\n â”Š 9â”Š11â”Š  it('creates a new chat between current user and specified recipient', async () => {\n+â”Š  â”Š12â”Š    const { rows } = await pool.query(sql`SELECT * FROM users WHERE id = 2`);\n+â”Š  â”Š13â”Š    const currentUser = rows[0];\n â”Š10â”Š14â”Š    const server = new ApolloServer({\n â”Š11â”Š15â”Š      schema,\n-â”Š12â”Š  â”Š      context: () => ({\n+â”Š  â”Š16â”Š      context: async () => ({\n â”Š13â”Š17â”Š        pubsub: new PubSub(),\n-â”Š14â”Š  â”Š        currentUser: users[1],\n+â”Š  â”Š18â”Š        currentUser,\n+â”Š  â”Š19â”Š        db: await pool.connect(),\n â”Š15â”Š20â”Š      }),\n+â”Š  â”Š21â”Š      formatResponse: (res: any, { context }: { context: MyContext }) => {\n+â”Š  â”Š22â”Š        context.db.release();\n+â”Š  â”Š23â”Š        return res;\n+â”Š  â”Š24â”Š      },\n â”Š16â”Š25â”Š    });\n â”Š17â”Š26â”Š\n â”Š18â”Š27â”Š    const { query, mutate } = createTestClient(server);\n```\n```diff\n@@ -57,12 +66,19 @@\n â”Š57â”Š66â”Š  });\n â”Š58â”Š67â”Š\n â”Š59â”Š68â”Š  it('returns the existing chat if so', async () => {\n+â”Š  â”Š69â”Š    const { rows } = await pool.query(sql`SELECT * FROM users WHERE id = 1`);\n+â”Š  â”Š70â”Š    const currentUser = rows[0];\n â”Š60â”Š71â”Š    const server = new ApolloServer({\n â”Š61â”Š72â”Š      schema,\n-â”Š62â”Š  â”Š      context: () => ({\n+â”Š  â”Š73â”Š      context: async () => ({\n â”Š63â”Š74â”Š        pubsub: new PubSub(),\n-â”Š64â”Š  â”Š        currentUser: users[0],\n+â”Š  â”Š75â”Š        currentUser,\n+â”Š  â”Š76â”Š        db: await pool.connect(),\n â”Š65â”Š77â”Š      }),\n+â”Š  â”Š78â”Š      formatResponse: (res: any, { context }: { context: MyContext }) => {\n+â”Š  â”Š79â”Š        context.db.release();\n+â”Š  â”Š80â”Š        return res;\n+â”Š  â”Š81â”Š      },\n â”Š66â”Š82â”Š    });\n â”Š67â”Š83â”Š\n â”Š68â”Š84â”Š    const { query, mutate } = createTestClient(server);\n```\n\n##### Changed tests&#x2F;mutations&#x2F;addMessage.test.ts\n```diff\n@@ -1,18 +1,27 @@\n â”Š 1â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n â”Š 2â”Š 2â”Šimport { ApolloServer, PubSub, gql } from 'apollo-server-express';\n â”Š 3â”Š 3â”Šimport schema from '../../schema';\n-â”Š 4â”Š  â”Šimport { resetDb, users } from '../../db';\n+â”Š  â”Š 4â”Šimport { resetDb, pool } from '../../db';\n+â”Š  â”Š 5â”Šimport sql from 'sql-template-strings';\n+â”Š  â”Š 6â”Šimport { MyContext } from '../../context';\n â”Š 5â”Š 7â”Š\n â”Š 6â”Š 8â”Šdescribe('Mutation.addMessage', () => {\n â”Š 7â”Š 9â”Š  beforeEach(resetDb);\n â”Š 8â”Š10â”Š\n â”Š 9â”Š11â”Š  it('should add message to specified chat', async () => {\n+â”Š  â”Š12â”Š    const { rows } = await pool.query(sql`SELECT * FROM users WHERE id = 1`);\n+â”Š  â”Š13â”Š    const currentUser = rows[0];\n â”Š10â”Š14â”Š    const server = new ApolloServer({\n â”Š11â”Š15â”Š      schema,\n-â”Š12â”Š  â”Š      context: () => ({\n+â”Š  â”Š16â”Š      context: async () => ({\n â”Š13â”Š17â”Š        pubsub: new PubSub(),\n-â”Š14â”Š  â”Š        currentUser: users[0],\n+â”Š  â”Š18â”Š        currentUser,\n+â”Š  â”Š19â”Š        db: await pool.connect(),\n â”Š15â”Š20â”Š      }),\n+â”Š  â”Š21â”Š      formatResponse: (res: any, { context }: { context: MyContext }) => {\n+â”Š  â”Š22â”Š        context.db.release();\n+â”Š  â”Š23â”Š        return res;\n+â”Š  â”Š24â”Š      },\n â”Š16â”Š25â”Š    });\n â”Š17â”Š26â”Š\n â”Š18â”Š27â”Š    const { query, mutate } = createTestClient(server);\n```\n\n##### Changed tests&#x2F;mutations&#x2F;removeChat.test.ts\n```diff\n@@ -1,18 +1,27 @@\n â”Š 1â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n â”Š 2â”Š 2â”Šimport { ApolloServer, PubSub, gql } from 'apollo-server-express';\n â”Š 3â”Š 3â”Šimport schema from '../../schema';\n-â”Š 4â”Š  â”Šimport { resetDb, users } from '../../db';\n+â”Š  â”Š 4â”Šimport { resetDb, pool } from '../../db';\n+â”Š  â”Š 5â”Šimport sql from 'sql-template-strings';\n+â”Š  â”Š 6â”Šimport { MyContext } from '../../context';\n â”Š 5â”Š 7â”Š\n â”Š 6â”Š 8â”Šdescribe('Mutation.removeChat', () => {\n â”Š 7â”Š 9â”Š  beforeEach(resetDb);\n â”Š 8â”Š10â”Š\n â”Š 9â”Š11â”Š  it('removes chat by id', async () => {\n+â”Š  â”Š12â”Š    const { rows } = await pool.query(sql`SELECT * FROM users WHERE id = 1`);\n+â”Š  â”Š13â”Š    const currentUser = rows[0];\n â”Š10â”Š14â”Š    const server = new ApolloServer({\n â”Š11â”Š15â”Š      schema,\n-â”Š12â”Š  â”Š      context: () => ({\n+â”Š  â”Š16â”Š      context: async () => ({\n â”Š13â”Š17â”Š        pubsub: new PubSub(),\n-â”Š14â”Š  â”Š        currentUser: users[0],\n+â”Š  â”Š18â”Š        currentUser,\n+â”Š  â”Š19â”Š        db: await pool.connect(),\n â”Š15â”Š20â”Š      }),\n+â”Š  â”Š21â”Š      formatResponse: (res: any, { context }: { context: MyContext }) => {\n+â”Š  â”Š22â”Š        context.db.release();\n+â”Š  â”Š23â”Š        return res;\n+â”Š  â”Š24â”Š      },\n â”Š16â”Š25â”Š    });\n â”Š17â”Š26â”Š\n â”Š18â”Š27â”Š    const { query, mutate } = createTestClient(server);\n```\n\n##### Changed tests&#x2F;queries&#x2F;getChat.test.ts\n```diff\n@@ -1,15 +1,26 @@\n â”Š 1â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n â”Š 2â”Š 2â”Šimport { ApolloServer, gql } from 'apollo-server-express';\n â”Š 3â”Š 3â”Šimport schema from '../../schema';\n-â”Š 4â”Š  â”Šimport { users } from '../../db';\n+â”Š  â”Š 4â”Šimport { pool, resetDb } from '../../db';\n+â”Š  â”Š 5â”Šimport sql from 'sql-template-strings';\n+â”Š  â”Š 6â”Šimport { MyContext } from '../../context';\n â”Š 5â”Š 7â”Š\n â”Š 6â”Š 8â”Šdescribe('Query.chat', () => {\n+â”Š  â”Š 9â”Š  beforeEach(resetDb);\n+â”Š  â”Š10â”Š\n â”Š 7â”Š11â”Š  it('should fetch specified chat', async () => {\n+â”Š  â”Š12â”Š    const { rows } = await pool.query(sql`SELECT * FROM users WHERE id = 1`);\n+â”Š  â”Š13â”Š    const currentUser = rows[0];\n â”Š 8â”Š14â”Š    const server = new ApolloServer({\n â”Š 9â”Š15â”Š      schema,\n-â”Š10â”Š  â”Š      context: () => ({\n-â”Š11â”Š  â”Š        currentUser: users[0],\n+â”Š  â”Š16â”Š      context: async () => ({\n+â”Š  â”Š17â”Š        currentUser,\n+â”Š  â”Š18â”Š        db: await pool.connect(),\n â”Š12â”Š19â”Š      }),\n+â”Š  â”Š20â”Š      formatResponse: (res: any, { context }: { context: MyContext }) => {\n+â”Š  â”Š21â”Š        context.db.release();\n+â”Š  â”Š22â”Š        return res;\n+â”Š  â”Š23â”Š      },\n â”Š13â”Š24â”Š    });\n â”Š14â”Š25â”Š\n â”Š15â”Š26â”Š    const { query } = createTestClient(server);\n```\n\n##### Changed tests&#x2F;queries&#x2F;getChats.test.ts\n```diff\n@@ -1,15 +1,26 @@\n â”Š 1â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n â”Š 2â”Š 2â”Šimport { ApolloServer, gql } from 'apollo-server-express';\n â”Š 3â”Š 3â”Šimport schema from '../../schema';\n-â”Š 4â”Š  â”Šimport { users } from '../../db';\n+â”Š  â”Š 4â”Šimport { pool, resetDb } from '../../db';\n+â”Š  â”Š 5â”Šimport sql from 'sql-template-strings';\n+â”Š  â”Š 6â”Šimport { MyContext } from '../../context';\n â”Š 5â”Š 7â”Š\n â”Š 6â”Š 8â”Šdescribe('Query.chats', () => {\n+â”Š  â”Š 9â”Š  beforeEach(resetDb);\n+â”Š  â”Š10â”Š\n â”Š 7â”Š11â”Š  it('should fetch all chats', async () => {\n+â”Š  â”Š12â”Š    const { rows } = await pool.query(sql`SELECT * FROM users WHERE id = 1`);\n+â”Š  â”Š13â”Š    const currentUser = rows[0];\n â”Š 8â”Š14â”Š    const server = new ApolloServer({\n â”Š 9â”Š15â”Š      schema,\n-â”Š10â”Š  â”Š      context: () => ({\n-â”Š11â”Š  â”Š        currentUser: users[0],\n+â”Š  â”Š16â”Š      context: async () => ({\n+â”Š  â”Š17â”Š        currentUser,\n+â”Š  â”Š18â”Š        db: await pool.connect(),\n â”Š12â”Š19â”Š      }),\n+â”Š  â”Š20â”Š      formatResponse: (res: any, { context }: { context: MyContext }) => {\n+â”Š  â”Š21â”Š        context.db.release();\n+â”Š  â”Š22â”Š        return res;\n+â”Š  â”Š23â”Š      },\n â”Š13â”Š24â”Š    });\n â”Š14â”Š25â”Š\n â”Š15â”Š26â”Š    const { query } = createTestClient(server);\n```\n\n##### Changed tests&#x2F;queries&#x2F;getMe.test.ts\n```diff\n@@ -1,15 +1,24 @@\n â”Š 1â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n â”Š 2â”Š 2â”Šimport { ApolloServer, gql } from 'apollo-server-express';\n â”Š 3â”Š 3â”Šimport schema from '../../schema';\n-â”Š 4â”Š  â”Šimport { users } from '../../db';\n+â”Š  â”Š 4â”Šimport { pool } from '../../db';\n+â”Š  â”Š 5â”Šimport sql from 'sql-template-strings';\n+â”Š  â”Š 6â”Šimport { MyContext } from '../../context';\n â”Š 5â”Š 7â”Š\n â”Š 6â”Š 8â”Šdescribe('Query.me', () => {\n â”Š 7â”Š 9â”Š  it('should fetch current user', async () => {\n+â”Š  â”Š10â”Š    const { rows } = await pool.query(sql`SELECT * FROM users WHERE id = 1`);\n+â”Š  â”Š11â”Š    const currentUser = rows[0];\n â”Š 8â”Š12â”Š    const server = new ApolloServer({\n â”Š 9â”Š13â”Š      schema,\n-â”Š10â”Š  â”Š      context: () => ({\n-â”Š11â”Š  â”Š        currentUser: users[0],\n+â”Š  â”Š14â”Š      context: async () => ({\n+â”Š  â”Š15â”Š        currentUser,\n+â”Š  â”Š16â”Š        db: await pool.connect(),\n â”Š12â”Š17â”Š      }),\n+â”Š  â”Š18â”Š      formatResponse: (res: any, { context }: { context: MyContext }) => {\n+â”Š  â”Š19â”Š        context.db.release();\n+â”Š  â”Š20â”Š        return res;\n+â”Š  â”Š21â”Š      },\n â”Š13â”Š22â”Š    });\n â”Š14â”Š23â”Š\n â”Š15â”Š24â”Š    const { query } = createTestClient(server);\n```\n\n##### Changed tests&#x2F;queries&#x2F;getUsers.test.ts\n```diff\n@@ -1,15 +1,27 @@\n â”Š 1â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n â”Š 2â”Š 2â”Šimport { ApolloServer, gql } from 'apollo-server-express';\n â”Š 3â”Š 3â”Šimport schema from '../../schema';\n-â”Š 4â”Š  â”Šimport { users } from '../../db';\n+â”Š  â”Š 4â”Šimport { pool } from '../../db';\n+â”Š  â”Š 5â”Šimport sql from 'sql-template-strings';\n+â”Š  â”Š 6â”Šimport { MyContext } from '../../context';\n â”Š 5â”Š 7â”Š\n â”Š 6â”Š 8â”Šdescribe('Query.getUsers', () => {\n â”Š 7â”Š 9â”Š  it('should fetch all users except the one signed-in', async () => {\n-â”Š 8â”Š  â”Š    let currentUser = users[0];\n-â”Š 9â”Š  â”Š\n+â”Š  â”Š10â”Š    const firstUserQuery = await pool.query(\n+â”Š  â”Š11â”Š      sql`SELECT * FROM users WHERE id = 1`\n+â”Š  â”Š12â”Š    );\n+â”Š  â”Š13â”Š    let currentUser = firstUserQuery.rows[0];\n+â”Š  â”Š14â”Š    const db = await pool.connect();\n â”Š10â”Š15â”Š    const server = new ApolloServer({\n â”Š11â”Š16â”Š      schema,\n-â”Š12â”Š  â”Š      context: () => ({ currentUser }),\n+â”Š  â”Š17â”Š      context: async () => ({\n+â”Š  â”Š18â”Š        currentUser,\n+â”Š  â”Š19â”Š        db: await pool.connect(),\n+â”Š  â”Š20â”Š      }),\n+â”Š  â”Š21â”Š      formatResponse: (res: any, { context }: { context: MyContext }) => {\n+â”Š  â”Š22â”Š        context.db.release();\n+â”Š  â”Š23â”Š        return res;\n+â”Š  â”Š24â”Š      },\n â”Š13â”Š25â”Š    });\n â”Š14â”Š26â”Š\n â”Š15â”Š27â”Š    const { query } = createTestClient(server);\n```\n```diff\n@@ -30,7 +42,10 @@\n â”Š30â”Š42â”Š    expect(res.errors).toBeUndefined();\n â”Š31â”Š43â”Š    expect(res.data).toMatchSnapshot();\n â”Š32â”Š44â”Š\n-â”Š33â”Š  â”Š    currentUser = users[1];\n+â”Š  â”Š45â”Š    const secondUserQuery = await pool.query(\n+â”Š  â”Š46â”Š      sql`SELECT * FROM users WHERE id = '2'`\n+â”Š  â”Š47â”Š    );\n+â”Š  â”Š48â”Š    currentUser = secondUserQuery.rows[0];\n â”Š34â”Š49â”Š\n â”Š35â”Š50â”Š    res = await query({\n â”Š36â”Š51â”Š      query: gql`\n```\n\n[}]: #\n\n> Because we are running tests against a database, we need to first make sure they run serially, one after the other,\n> using Jest's `runInBand` option.\n> Also, because during the test we will access a resource (DB) that will keep living, we need to tell Jest to close itself\n> after the test is done, using the `forceExit` option\n\n[{]: <helper> (diffStep 11.8 files=\"package.json\" module=\"server\")\n\n#### [__Server__ Step 11.8: Updating Tests with SQL](https://github.com/Urigo/WhatsApp-Clone-Server/commit/c7cc4cd99cd0c4bd279550285b60f2f7d7aec920)\n\n##### Changed package.json\n```diff\n@@ -9,7 +9,7 @@\n â”Š 9â”Š 9â”Š  \"scripts\": {\n â”Š10â”Š10â”Š    \"prestart\": \"yarn codegen\",\n â”Š11â”Š11â”Š    \"start\": \"ts-node index.ts\",\n-â”Š12â”Š  â”Š    \"test\": \"TZ=\\\"Asia/Jerusalem\\\" jest\",\n+â”Š  â”Š12â”Š    \"test\": \"TZ=\\\"Asia/Jerusalem\\\" jest --runInBand --forceExit\",\n â”Š13â”Š13â”Š    \"codegen\": \"gql-gen\",\n â”Š14â”Š14â”Š    \"format\": \"prettier \\\"**/*.ts\\\" --write\"\n â”Š15â”Š15â”Š  },\n```\n\n[}]: #\n\n**Remove in-memory database**\n\nWe can remove all the stuff related to in-memory database now.\n\n[{]: <helper> (diffStep 11.9 files=\"db\" module=\"server\")\n\n#### [__Server__ Step 11.9: Removing in-memory database](https://github.com/Urigo/WhatsApp-Clone-Server/commit/7240dfc0bc8ef2cc2e824eebd5871a95a1ad3359)\n\n##### Changed db.ts\n```diff\n@@ -32,10 +32,6 @@\n â”Š32â”Š32â”Š\n â”Š33â”Š33â”Šexport let pool: Pool = new Pool(dbConfig);\n â”Š34â”Š34â”Š\n-â”Š35â”Š  â”Šexport const users: User[] = [];\n-â”Š36â”Š  â”Šexport const messages: Message[] = [];\n-â”Š37â”Š  â”Šexport const chats: Chat[] = [];\n-â”Š38â”Š  â”Š\n â”Š39â”Š35â”Šexport async function initDb(): Promise<void> {\n â”Š40â”Š36â”Š  // Clear tables\n â”Š41â”Š37â”Š  await pool.query(sql`DROP TABLE IF EXISTS messages;`);\n```\n\n[}]: #"
          },
          {
            "manualTitle": "Step 15: Using a REST API",
            "stepRevision": "fe5b0e8a7080b755bb3da9eba491ce4649519ef7",
            "manualView": "Despite using GraphQL throughout all our app, we will soon meet the need to use some external API and chances are it will be REST.\nOur first idea could be to bridge the REST API through GraphQL, reproposing the very same API to the client. This approach is wrong, because our first concern should always be to provide the client with ready to use data in the best possible shape.\nThe client donâ€™t need to know that our GraphQL API is backed by a REST API, it doesnâ€™t have to pass headers required by the underlying API or do any kind of special considerations: our backend should take care of everything.\n\n## Retrieve a profile picture from a REST API\n\nIn this chapter we will discuss how to use an external API called Unsplash to retrieve random profile pictures for the users who didnâ€™t set any.\n\nStart heading to https://unsplash.com/developers and clicking on â€œRegister as a developerâ€. After registering you will have to create a new app: take note of the Access Key because weâ€™re going to need it.\n\nIf you look at the Documentation (https://unsplash.com/documentation#get-a-random-photo) youâ€™ll notice that in order to retrieve a random photo we have to query the /photos/random endpoint (GET method). We also have to pass some headers for the authent\ncation and some params for the search term and the orientation.\n\nOn the browser we would probably use the fetch api, but since on we node we would need a polyfill itâ€™s better to just use a full fledged library like axios:\n\n    yarn add axios\n    yarn add -D @types/axios\n\nBefore we start implementing, we want to create some typings for our endpoint, because ideally we would like to be aided by those typings during the development.\nIn order to do so we can use a Chrome extension like Advanced Rest Client to retrieve the response.\nSet the Method to GET, the Headers to Authorization: 'Client-ID 4d048cfb4383b407eff92e4a2a5ec36c0a866be85e64caafa588c110efad350d' and the Request URL to https://api.unsplash.com/photos/random, along with the params to query: 'portrait' and orientation: 'squarish'.\nCopy the response, create a new file called types/unsplash.ts in your vscode editor and run the command â€œPast JSON as Typesâ€ (you need to install the Past JSON as Code extension and press CTRL+P to open the run command prompt). That would be enough to automatically create the typings for the random photo endpoint.\n\nNow we can finally implement the REST API call in our picture resolver:\n\n[{]: <helper> (diffStep \"12.1\" files=\"schema/resolvers.ts\" module=\"server\")\n\n#### [__Server__ Step 12.1: Retrieve profile picture from REST API](https://github.com/Urigo/WhatsApp-Clone-Server/commit/e823efdbd0440151c3a0e9827c85a44f3f8659a7)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -7,6 +7,8 @@\n â”Š 7â”Š 7â”Šimport jwt from 'jsonwebtoken';\n â”Š 8â”Š 8â”Šimport { validateLength, validatePassword } from '../validators';\n â”Š 9â”Š 9â”Šimport sql from 'sql-template-strings';\n+â”Š  â”Š10â”Šimport axios from 'axios';\n+â”Š  â”Š11â”Šimport { RandomPhoto } from '../types/unsplash';\n â”Š10â”Š12â”Š\n â”Š11â”Š13â”Šconst resolvers: Resolvers = {\n â”Š12â”Š14â”Š  Date: GraphQLDateTime,\n```\n```diff\n@@ -70,7 +72,26 @@\n â”Š70â”Š72â”Š\n â”Š71â”Š73â”Š      const participant = rows[0];\n â”Š72â”Š74â”Š\n-â”Š73â”Š  â”Š      return participant ? participant.picture : null;\n+â”Š  â”Š75â”Š      if (participant && participant.picture) return participant.picture;\n+â”Š  â”Š76â”Š\n+â”Š  â”Š77â”Š      try {\n+â”Š  â”Š78â”Š        return (await axios.get<RandomPhoto>(\n+â”Š  â”Š79â”Š          'https://api.unsplash.com/photos/random',\n+â”Š  â”Š80â”Š          {\n+â”Š  â”Š81â”Š            params: {\n+â”Š  â”Š82â”Š              query: 'portrait',\n+â”Š  â”Š83â”Š              orientation: 'squarish',\n+â”Š  â”Š84â”Š            },\n+â”Š  â”Š85â”Š            headers: {\n+â”Š  â”Š86â”Š              Authorization:\n+â”Š  â”Š87â”Š                'Client-ID 4d048cfb4383b407eff92e4a2a5ec36c0a866be85e64caafa588c110efad350d',\n+â”Š  â”Š88â”Š            },\n+â”Š  â”Š89â”Š          }\n+â”Š  â”Š90â”Š        )).data.urls.small;\n+â”Š  â”Š91â”Š      } catch (err) {\n+â”Š  â”Š92â”Š        console.error('Cannot retrieve random photo:', err);\n+â”Š  â”Š93â”Š        return null;\n+â”Š  â”Š94â”Š      }\n â”Š74â”Š95â”Š    },\n â”Š75â”Š96â”Š\n â”Š76â”Š97â”Š    async messages(chat, args, { db }) {\n```\n\n[}]: #\n\nIn order to test it, we have to remove the picture from one of the users and re-run the server with the `RESET_DB=true` environment variable:\n\n[{]: <helper> (diffStep \"12.1\" files=\"db.ts\" module=\"server\")\n\n#### [__Server__ Step 12.1: Retrieve profile picture from REST API](https://github.com/Urigo/WhatsApp-Clone-Server/commit/e823efdbd0440151c3a0e9827c85a44f3f8659a7)\n\n##### Changed db.ts\n```diff\n@@ -123,6 +123,10 @@\n â”Š123â”Š123â”Š    sql`SELECT setval('users_id_seq', (SELECT max(id) FROM users))`\n â”Š124â”Š124â”Š  );\n â”Š125â”Š125â”Š\n+â”Š   â”Š126â”Š  await pool.query(\n+â”Š   â”Š127â”Š    sql`SELECT setval('users_id_seq', (SELECT max(id) FROM users))`\n+â”Š   â”Š128â”Š  );\n+â”Š   â”Š129â”Š\n â”Š126â”Š130â”Š  await pool.query(sql`DELETE FROM chats`);\n â”Š127â”Š131â”Š\n â”Š128â”Š132â”Š  const sampleChats = [\n```\n\n[}]: #\n\n\n## Track the API\n\nEven if our typings are working pretty well so far, not all REST APIs are versioned and the shape weâ€™ve got from the server could potentially change.\nIn order to keep an eye on it we could use the safe-api middleware in order to check for abnormal answers coming from the server and log them. We can also generate the typings automatically based on the response we get.\nFirst letâ€™s install the safe-api middleware:\n\n    yarn add @safe-api/middleware\n\nThen letâ€™s use it inside our resolver:\n\n[{]: <helper> (diffStep \"12.2\" files=\"schema/resolvers.ts\" module=\"server\")\n\n#### [__Server__ Step 12.2: Use safe-api](https://github.com/Urigo/WhatsApp-Clone-Server/commit/aa8d8ee2595c2f50a88742ab1e66813b556f6d1b)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -9,6 +9,8 @@\n â”Š 9â”Š 9â”Šimport sql from 'sql-template-strings';\n â”Š10â”Š10â”Šimport axios from 'axios';\n â”Š11â”Š11â”Šimport { RandomPhoto } from '../types/unsplash';\n+â”Š  â”Š12â”Šimport { trackProvider } from '@safe-api/middleware';\n+â”Š  â”Š13â”Šimport { resolve } from 'path';\n â”Š12â”Š14â”Š\n â”Š13â”Š15â”Šconst resolvers: Resolvers = {\n â”Š14â”Š16â”Š  Date: GraphQLDateTime,\n```\n```diff\n@@ -74,20 +76,38 @@\n â”Š 74â”Š 76â”Š\n â”Š 75â”Š 77â”Š      if (participant && participant.picture) return participant.picture;\n â”Š 76â”Š 78â”Š\n+â”Š   â”Š 79â”Š      interface RandomPhotoInput {\n+â”Š   â”Š 80â”Š        query: string;\n+â”Š   â”Š 81â”Š        orientation: 'landscape' | 'portrait' | 'squarish';\n+â”Š   â”Š 82â”Š      }\n+â”Š   â”Š 83â”Š\n+â”Š   â”Š 84â”Š      const trackedRandomPhoto = await trackProvider(\n+â”Š   â”Š 85â”Š        async ({ query, orientation }: RandomPhotoInput) =>\n+â”Š   â”Š 86â”Š          (await axios.get<RandomPhoto>(\n+â”Š   â”Š 87â”Š            'https://api.unsplash.com/photos/random',\n+â”Š   â”Š 88â”Š            {\n+â”Š   â”Š 89â”Š              params: {\n+â”Š   â”Š 90â”Š                query,\n+â”Š   â”Š 91â”Š                orientation,\n+â”Š   â”Š 92â”Š              },\n+â”Š   â”Š 93â”Š              headers: {\n+â”Š   â”Š 94â”Š                Authorization:\n+â”Š   â”Š 95â”Š                  'Client-ID 4d048cfb4383b407eff92e4a2a5ec36c0a866be85e64caafa588c110efad350d',\n+â”Š   â”Š 96â”Š              },\n+â”Š   â”Š 97â”Š            }\n+â”Š   â”Š 98â”Š          )).data,\n+â”Š   â”Š 99â”Š        {\n+â”Š   â”Š100â”Š          provider: 'Unsplash',\n+â”Š   â”Š101â”Š          method: 'RandomPhoto',\n+â”Š   â”Š102â”Š          location: resolve(__dirname, '../logs/main'),\n+â”Š   â”Š103â”Š        }\n+â”Š   â”Š104â”Š      );\n+â”Š   â”Š105â”Š\n â”Š 77â”Š106â”Š      try {\n-â”Š 78â”Š   â”Š        return (await axios.get<RandomPhoto>(\n-â”Š 79â”Š   â”Š          'https://api.unsplash.com/photos/random',\n-â”Š 80â”Š   â”Š          {\n-â”Š 81â”Š   â”Š            params: {\n-â”Š 82â”Š   â”Š              query: 'portrait',\n-â”Š 83â”Š   â”Š              orientation: 'squarish',\n-â”Š 84â”Š   â”Š            },\n-â”Š 85â”Š   â”Š            headers: {\n-â”Š 86â”Š   â”Š              Authorization:\n-â”Š 87â”Š   â”Š                'Client-ID 4d048cfb4383b407eff92e4a2a5ec36c0a866be85e64caafa588c110efad350d',\n-â”Š 88â”Š   â”Š            },\n-â”Š 89â”Š   â”Š          }\n-â”Š 90â”Š   â”Š        )).data.urls.small;\n+â”Š   â”Š107â”Š        return (await trackedRandomPhoto({\n+â”Š   â”Š108â”Š          query: 'portrait',\n+â”Š   â”Š109â”Š          orientation: 'squarish',\n+â”Š   â”Š110â”Š        })).urls.small;\n â”Š 91â”Š111â”Š      } catch (err) {\n â”Š 92â”Š112â”Š        console.error('Cannot retrieve random photo:', err);\n â”Š 93â”Š113â”Š        return null;\n```\n\n[}]: #\n\nNow launch the client in order to retrieve the picture field multiple times.\n\nIf you look inside the logs directory you will notice that it generated some graphql schema to represent the REST API. You will notice that each time we call the REST endpoint it generates a new schema, because a single response isnâ€™t generic enough to account for all possible responses. Ideally safe-api should be able to average multiple esponses in order to generate the least generic schema matching the given responses.\n\nNow we need to remove `types/unsplash.ts` and generate some Typescript typings out of the schema. Do do so we can use the graphql-code-generator:\n\n[{]: <helper> (diffStep \"12.3\" files=\".gitignore, codegen.yml\" module=\"server\")\n\n#### [__Server__ Step 12.3: Generate typings from safe-api](https://github.com/Urigo/WhatsApp-Clone-Server/commit/32b42d3fba3612bb408bb4d1f914ec5331bb3378)\n\n##### Changed .gitignore\n```diff\n@@ -1,4 +1,5 @@\n â”Š1â”Š1â”Šnode_modules\n â”Š2â”Š2â”Šnpm-debug.log\n â”Š3â”Š3â”Štest-results/\n-â”Š4â”Š â”Štypes/graphql.d.tsðŸš«â†µ\n+â”Š â”Š4â”Štypes/graphql.d.ts\n+â”Š â”Š5â”Štypes/unsplash.d.tsðŸš«â†µ\n```\n\n##### Changed codegen.yml\n```diff\n@@ -1,7 +1,7 @@\n-â”Š1â”Š â”Šschema: ./schema/typeDefs.graphql\n â”Š2â”Š1â”Šoverwrite: true\n â”Š3â”Š2â”Šgenerates:\n â”Š4â”Š3â”Š  ./types/graphql.d.ts:\n+â”Š â”Š4â”Š    schema: ./schema/typeDefs.graphql\n â”Š5â”Š5â”Š    plugins:\n â”Š6â”Š6â”Š      - typescript\n â”Š7â”Š7â”Š      - typescript-resolvers\n```\n```diff\n@@ -16,3 +16,7 @@\n â”Š16â”Š16â”Š      scalars:\n â”Š17â”Š17â”Š        # e.g. Message.createdAt will be of type Date\n â”Š18â”Š18â”Š        Date: Date\n+â”Š  â”Š19â”Š  ./types/unsplash.d.ts:\n+â”Š  â”Š20â”Š    schema: ./logs/main/Unsplash.RandomPhoto.graphql\n+â”Š  â”Š21â”Š    plugins:\n+â”Š  â”Š22â”Š      - typescript\n```\n\n[}]: #\n\n    yarn codegen\n\n\n## Apollo DataSources\n\nWeâ€™re not done yet, there is still room for improvement. Instead of using axios, we could use Apolloâ€™s Data Sources and take advantage of the built-in support for caching, deduplication and error handling.\n\n    yarn remove axios @types/axios\n    yarn add apollo-datasource-rest\n\n[{]: <helper> (diffStep \"12.4\" files=\"schema/unsplash.api.ts\" module=\"server\")\n\n#### [__Server__ Step 12.4: Use Apollo DataSources](https://github.com/Urigo/WhatsApp-Clone-Server/commit/272bf16fed9585ed8098416fb71f05a853937e6f)\n\n##### Added schema&#x2F;unsplash.api.ts\n```diff\n@@ -0,0 +1,45 @@\n+â”Š  â”Š 1â”Šimport { RESTDataSource, RequestOptions } from 'apollo-datasource-rest';\n+â”Š  â”Š 2â”Šimport { resolve } from 'path';\n+â”Š  â”Š 3â”Šimport { trackProvider } from '@safe-api/middleware';\n+â”Š  â”Š 4â”Šimport { RandomPhoto } from '../types/unsplash';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šinterface RandomPhotoInput {\n+â”Š  â”Š 7â”Š  query: string;\n+â”Š  â”Š 8â”Š  orientation: 'landscape' | 'portrait' | 'squarish';\n+â”Š  â”Š 9â”Š}\n+â”Š  â”Š10â”Š\n+â”Š  â”Š11â”Šexport class UnsplashApi extends RESTDataSource {\n+â”Š  â”Š12â”Š  constructor() {\n+â”Š  â”Š13â”Š    super();\n+â”Š  â”Š14â”Š    this.baseURL = 'https://api.unsplash.com/';\n+â”Š  â”Š15â”Š  }\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š  willSendRequest(request: RequestOptions) {\n+â”Š  â”Š18â”Š    request.headers.set(\n+â”Š  â”Š19â”Š      'Authorization',\n+â”Š  â”Š20â”Š      'Client-ID 4d048cfb4383b407eff92e4a2a5ec36c0a866be85e64caafa588c110efad350d'\n+â”Š  â”Š21â”Š    );\n+â”Š  â”Š22â”Š  }\n+â”Š  â”Š23â”Š\n+â”Š  â”Š24â”Š  async getRandomPhoto() {\n+â”Š  â”Š25â”Š    const trackedRandomPhoto = await trackProvider(\n+â”Š  â”Š26â”Š      ({ query, orientation }: RandomPhotoInput) =>\n+â”Š  â”Š27â”Š        this.get<RandomPhoto>('photos/random', { query, orientation }),\n+â”Š  â”Š28â”Š      {\n+â”Š  â”Š29â”Š        provider: 'Unsplash',\n+â”Š  â”Š30â”Š        method: 'RandomPhoto',\n+â”Š  â”Š31â”Š        location: resolve(__dirname, '../logs/main'),\n+â”Š  â”Š32â”Š      }\n+â”Š  â”Š33â”Š    );\n+â”Š  â”Š34â”Š\n+â”Š  â”Š35â”Š    try {\n+â”Š  â”Š36â”Š      return (await trackedRandomPhoto({\n+â”Š  â”Š37â”Š        query: 'portrait',\n+â”Š  â”Š38â”Š        orientation: 'squarish',\n+â”Š  â”Š39â”Š      })).urls.small;\n+â”Š  â”Š40â”Š    } catch (err) {\n+â”Š  â”Š41â”Š      console.error('Cannot retrieve random photo:', err);\n+â”Š  â”Š42â”Š      return null;\n+â”Š  â”Š43â”Š    }\n+â”Š  â”Š44â”Š  }\n+â”Š  â”Š45â”Š}\n```\n\n[}]: #\n\nWe created the UnsplashApi class, which extends RESTDataSource. In the constructor you need to set the baseUrl (after calling super() to run the constructor of the base class). You also need to create a willSendRequest method to set the authentication headers for each call. Then itâ€™s simply a matter of creating a getRandomPhoto method to perform the actual REST API call. Instead of calling axios you will have to call the get method of the class (which in turn gets inherited from its RESTDataSource base class): the API is very similar to the axios one.\n\nIn order to access the data source from the resolvers we need to tell Apollo to put them on the context for every request. We shouldnâ€™t use the context field, because that would lead to circular dependencies. Instead we need to use the dataSources field:\n\n[{]: <helper> (diffStep \"12.4\" files=\"index.ts\" module=\"server\")\n\n#### [__Server__ Step 12.4: Use Apollo DataSources](https://github.com/Urigo/WhatsApp-Clone-Server/commit/272bf16fed9585ed8098416fb71f05a853937e6f)\n\n##### Changed index.ts\n```diff\n@@ -8,6 +8,7 @@\n â”Š 8â”Š 8â”Šimport schema from './schema';\n â”Š 9â”Š 9â”Šimport { MyContext } from './context';\n â”Š10â”Š10â”Šimport sql from 'sql-template-strings';\n+â”Š  â”Š11â”Šimport { UnsplashApi } from './schema/unsplash.api';\n â”Š11â”Š12â”Šconst { PostgresPubSub } = require('graphql-postgres-subscriptions');\n â”Š12â”Š13â”Š\n â”Š13â”Š14â”Šconst pubsub = new PostgresPubSub({\n```\n```diff\n@@ -67,6 +68,9 @@\n â”Š67â”Š68â”Š\n â”Š68â”Š69â”Š    return res;\n â”Š69â”Š70â”Š  },\n+â”Š  â”Š71â”Š  dataSources: () => ({\n+â”Š  â”Š72â”Š    unsplashApi: new UnsplashApi(),\n+â”Š  â”Š73â”Š  }),\n â”Š70â”Š74â”Š});\n â”Š71â”Š75â”Š\n â”Š72â”Š76â”Šserver.applyMiddleware({\n```\n\n[}]: #\n\nNow we need to update the typings for our context and run the graphq-code-generator again:\n\n[{]: <helper> (diffStep \"12.4\" files=\"context.ts\" module=\"server\")\n\n#### [__Server__ Step 12.4: Use Apollo DataSources](https://github.com/Urigo/WhatsApp-Clone-Server/commit/272bf16fed9585ed8098416fb71f05a853937e6f)\n\n##### Changed context.ts\n```diff\n@@ -2,10 +2,14 @@\n â”Š 2â”Š 2â”Šimport { User } from './db';\n â”Š 3â”Š 3â”Šimport { Response } from 'express';\n â”Š 4â”Š 4â”Šimport { PoolClient } from 'pg';\n+â”Š  â”Š 5â”Šimport { UnsplashApi } from './schema/unsplash.api';\n â”Š 5â”Š 6â”Š\n â”Š 6â”Š 7â”Šexport type MyContext = {\n â”Š 7â”Š 8â”Š  pubsub: PubSub;\n â”Š 8â”Š 9â”Š  currentUser: User;\n â”Š 9â”Š10â”Š  res: Response;\n â”Š10â”Š11â”Š  db: PoolClient;\n+â”Š  â”Š12â”Š  dataSources: {\n+â”Š  â”Š13â”Š    unsplashApi: UnsplashApi;\n+â”Š  â”Š14â”Š  };\n â”Š11â”Š15â”Š};\n```\n\n[}]: #\n\n    yarn codegen\n\nNow it should be pretty easy to modify our resolver in order to use our just created datasource:\n\n[{]: <helper> (diffStep \"12.4\" files=\"schema/resolvers.ts\" module=\"server\")\n\n#### [__Server__ Step 12.4: Use Apollo DataSources](https://github.com/Urigo/WhatsApp-Clone-Server/commit/272bf16fed9585ed8098416fb71f05a853937e6f)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -7,10 +7,6 @@\n â”Š 7â”Š 7â”Šimport jwt from 'jsonwebtoken';\n â”Š 8â”Š 8â”Šimport { validateLength, validatePassword } from '../validators';\n â”Š 9â”Š 9â”Šimport sql from 'sql-template-strings';\n-â”Š10â”Š  â”Šimport axios from 'axios';\n-â”Š11â”Š  â”Šimport { RandomPhoto } from '../types/unsplash';\n-â”Š12â”Š  â”Šimport { trackProvider } from '@safe-api/middleware';\n-â”Š13â”Š  â”Šimport { resolve } from 'path';\n â”Š14â”Š10â”Š\n â”Š15â”Š11â”Šconst resolvers: Resolvers = {\n â”Š16â”Š12â”Š  Date: GraphQLDateTime,\n```\n```diff\n@@ -63,7 +59,7 @@\n â”Š63â”Š59â”Š      return participant ? participant.name : null;\n â”Š64â”Š60â”Š    },\n â”Š65â”Š61â”Š\n-â”Š66â”Š  â”Š    async picture(chat, args, { currentUser, db }) {\n+â”Š  â”Š62â”Š    async picture(chat, args, { currentUser, db, dataSources }) {\n â”Š67â”Š63â”Š      if (!currentUser) return null;\n â”Š68â”Š64â”Š\n â”Š69â”Š65â”Š      const { rows } = await db.query(sql`\n```\n```diff\n@@ -74,44 +70,9 @@\n â”Š 74â”Š 70â”Š\n â”Š 75â”Š 71â”Š      const participant = rows[0];\n â”Š 76â”Š 72â”Š\n-â”Š 77â”Š   â”Š      if (participant && participant.picture) return participant.picture;\n-â”Š 78â”Š   â”Š\n-â”Š 79â”Š   â”Š      interface RandomPhotoInput {\n-â”Š 80â”Š   â”Š        query: string;\n-â”Š 81â”Š   â”Š        orientation: 'landscape' | 'portrait' | 'squarish';\n-â”Š 82â”Š   â”Š      }\n-â”Š 83â”Š   â”Š\n-â”Š 84â”Š   â”Š      const trackedRandomPhoto = await trackProvider(\n-â”Š 85â”Š   â”Š        async ({ query, orientation }: RandomPhotoInput) =>\n-â”Š 86â”Š   â”Š          (await axios.get<RandomPhoto>(\n-â”Š 87â”Š   â”Š            'https://api.unsplash.com/photos/random',\n-â”Š 88â”Š   â”Š            {\n-â”Š 89â”Š   â”Š              params: {\n-â”Š 90â”Š   â”Š                query,\n-â”Š 91â”Š   â”Š                orientation,\n-â”Š 92â”Š   â”Š              },\n-â”Š 93â”Š   â”Š              headers: {\n-â”Š 94â”Š   â”Š                Authorization:\n-â”Š 95â”Š   â”Š                  'Client-ID 4d048cfb4383b407eff92e4a2a5ec36c0a866be85e64caafa588c110efad350d',\n-â”Š 96â”Š   â”Š              },\n-â”Š 97â”Š   â”Š            }\n-â”Š 98â”Š   â”Š          )).data,\n-â”Š 99â”Š   â”Š        {\n-â”Š100â”Š   â”Š          provider: 'Unsplash',\n-â”Š101â”Š   â”Š          method: 'RandomPhoto',\n-â”Š102â”Š   â”Š          location: resolve(__dirname, '../logs/main'),\n-â”Š103â”Š   â”Š        }\n-â”Š104â”Š   â”Š      );\n-â”Š105â”Š   â”Š\n-â”Š106â”Š   â”Š      try {\n-â”Š107â”Š   â”Š        return (await trackedRandomPhoto({\n-â”Š108â”Š   â”Š          query: 'portrait',\n-â”Š109â”Š   â”Š          orientation: 'squarish',\n-â”Š110â”Š   â”Š        })).urls.small;\n-â”Š111â”Š   â”Š      } catch (err) {\n-â”Š112â”Š   â”Š        console.error('Cannot retrieve random photo:', err);\n-â”Š113â”Š   â”Š        return null;\n-â”Š114â”Š   â”Š      }\n+â”Š   â”Š 73â”Š      return participant && participant.picture\n+â”Š   â”Š 74â”Š        ? participant.picture\n+â”Š   â”Š 75â”Š        : dataSources.unsplashApi.getRandomPhoto();\n â”Š115â”Š 76â”Š    },\n â”Š116â”Š 77â”Š\n â”Š117â”Š 78â”Š    async messages(chat, args, { db }) {\n```\n\n[}]: #"
          },
          {
            "manualTitle": "Step 16: Modularity",
            "stepRevision": "3a3153c9c557609119aba480f9e46985590bbb96",
            "manualView": "This chapter is focused entirely on how to organize a GraphQL API. By far, our project's schema looks simple and keeping SDL and resolvers in two files is really enough.\n\n## Issues we face when GraphQL API grows\n\nUsually, every app starts small and the difficulty of maintenance grows while features are being implemented. I believe that you should always start small and see how a project involves. You could look up many articles about best practices of organising a project but they bring no benefit when your project is small. You don't want to jump between files in order to find what you're looking for, it should be intuitive. I agree a proper folder structure helps but if your schema has 100 lines of code then it makes no sense to split it into 5 files with 20 LOC each. The schema is so small that it won't hurt you when you hit the wall and separation will be necessary but until it happens you can easily move on with the project.\n\nBigger project means more people, more people means teams. In the current state of the app, they might interrupt each other and that eventually affects productivity.\nLack of separation makes the schema harder to maintain, especially once it grows rapidly.\n\n## That's why modularity is a thing!\n\nIn order to improve and solve those issues we would have to split an API into many pieces.\nThose might be files, even folders, doesn't really matter because the goal is to keep relevant chunks of code in one place, conceptually called module.\n\nIf done right, one team won't disturb another and it also helps to understand an entire codebase just by looking at those modules or even learn a feature because everything related to it is within a single module.\n\nThere's also a very important aspect, reusability. Most APIs have something in common, the first thing that comes to mind is authentication and user mechanism in general.\nWhen working with modules, it gets easier to share those.\n\n## Many ways to organize an API\n\nGraphQL specification explains just the language and how to form an API. Managing codebase, that's on our side.\n\nSince we're talking about modularity, let's see possible implementations.\n\nThe first thing on mind are files and folders. Putting relevant logic in a file won't scale well once we add more things, like business logic for example. Which means we need folders, that's for sure.\n\nOkay, so the next question, how to store SDL and resolvers. Do we want to have them stored together or keep them separated?\n\nI'm a big fan of the former because in schema-first approach the SDL is written first and you see exactly how to construct resolvers. The latter would require to jump between files or have them opened side-by-side.\nAnother benefit shows up when you add, remove or just change part of a schema, less likely that you'll miss something.\n\nBut as always, there are things you can't do with that approach.\nOne that pops into my head right away is an IDE supportâ€¦ ?\n< guys, any ideas? >\n\nLet's talk about modularity in terms of SDL.\nWe know how to define types in GraphQL but what if a type is a sum of many features?\nThere two ways to do it. One is to use the `extend` keyword, another to define a type multiple type. Both gave the same effect, all is merged into one type after all.\n\nBut there are few major differences.\n\nThe `extend` keyword is obviously a part of the specification so IDEs and most tools support it. It feels more natural than the second option.\n\nDefining the same type multiple times is the opposite. It might feel odd, not many IDEs and\ntools support it so you have to add a library that handles it but on the other way you don't care if there's already a type or not, you just make sure there's one with proper fields, no matter what. It might also warn you when fields overlap.\n\n## Modularized schema\n\nThere are couple solutions to help you modularize the schema and we will look at 3 of them.\n\nFirst, let's start by defining 3 modules:\n\n- common - things we want to share with all the rest\n- users - everything related to users\n- chats - core logic of WhatsApp\n\n### Using directories\n\nThe simplest and most obvious solution would be to split what we have and move that into directories.\n\nStarting with common module. We need to create a folder at `/modules/common` and a `index.ts` file in it:\n\n[{]: <helper> (diffStep \"13.1\" files=\"modules/common/index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.1: Modularize schema](https://github.com/Urigo/WhatsApp-Clone-Server/commit/3ebfc0cdd075930c9db1985240fa1909c06a974a)\n\n##### Added modules&#x2F;common&#x2F;index.ts\n```diff\n@@ -0,0 +1,23 @@\n+â”Š  â”Š 1â”Šimport { gql } from 'apollo-server-express';\n+â”Š  â”Š 2â”Šimport { GraphQLDateTime } from 'graphql-iso-date';\n+â”Š  â”Š 3â”Šimport { Resolvers } from '../../types/graphql';\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šexport const typeDefs = gql`\n+â”Š  â”Š 6â”Š  scalar Date\n+â”Š  â”Š 7â”Š\n+â”Š  â”Š 8â”Š  type Query {\n+â”Š  â”Š 9â”Š    _dummy: Boolean\n+â”Š  â”Š10â”Š  }\n+â”Š  â”Š11â”Š\n+â”Š  â”Š12â”Š  type Mutation {\n+â”Š  â”Š13â”Š    _dummy: Boolean\n+â”Š  â”Š14â”Š  }\n+â”Š  â”Š15â”Š\n+â”Š  â”Š16â”Š  type Subscription {\n+â”Š  â”Š17â”Š    _dummy: Boolean\n+â”Š  â”Š18â”Š  }\n+â”Š  â”Š19â”Š`;\n+â”Š  â”Š20â”Š\n+â”Š  â”Š21â”Šexport const resolvers: Resolvers = {\n+â”Š  â”Š22â”Š  Date: GraphQLDateTime,\n+â”Š  â”Š23â”Š};\n```\n\n[}]: #\n\nYou can see a pattern here, two things are being exported, one with type definitions and the other with resolvers. Why those `_dummy` fields? We want to use `extend` keyword, that require a base type and GraphQL doesn't accept empty objects.\n\nNow, let's do the same but with Users module:\n\n[{]: <helper> (diffStep \"13.1\" files=\"modules/users/index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.1: Modularize schema](https://github.com/Urigo/WhatsApp-Clone-Server/commit/3ebfc0cdd075930c9db1985240fa1909c06a974a)\n\n##### Added modules&#x2F;users&#x2F;index.ts\n```diff\n@@ -0,0 +1,100 @@\n+â”Š   â”Š  1â”Šimport { gql } from 'apollo-server-express';\n+â”Š   â”Š  2â”Šimport sql from 'sql-template-strings';\n+â”Š   â”Š  3â”Šimport bcrypt from 'bcrypt';\n+â”Š   â”Š  4â”Šimport jwt from 'jsonwebtoken';\n+â”Š   â”Š  5â”Šimport { secret, expiration } from '../../env';\n+â”Š   â”Š  6â”Šimport { validateLength, validatePassword } from '../../validators';\n+â”Š   â”Š  7â”Šimport { Resolvers } from '../../types/graphql';\n+â”Š   â”Š  8â”Š\n+â”Š   â”Š  9â”Šexport const typeDefs = gql`\n+â”Š   â”Š 10â”Š  type User {\n+â”Š   â”Š 11â”Š    id: ID!\n+â”Š   â”Š 12â”Š    name: String!\n+â”Š   â”Š 13â”Š    picture: String\n+â”Š   â”Š 14â”Š  }\n+â”Š   â”Š 15â”Š\n+â”Š   â”Š 16â”Š  extend type Query {\n+â”Š   â”Š 17â”Š    me: User\n+â”Š   â”Š 18â”Š    users: [User!]!\n+â”Š   â”Š 19â”Š  }\n+â”Š   â”Š 20â”Š\n+â”Š   â”Š 21â”Š  extend type Mutation {\n+â”Š   â”Š 22â”Š    signIn(username: String!, password: String!): User\n+â”Š   â”Š 23â”Š    signUp(\n+â”Š   â”Š 24â”Š      name: String!\n+â”Š   â”Š 25â”Š      username: String!\n+â”Š   â”Š 26â”Š      password: String!\n+â”Š   â”Š 27â”Š      passwordConfirm: String!\n+â”Š   â”Š 28â”Š    ): User\n+â”Š   â”Š 29â”Š  }\n+â”Š   â”Š 30â”Š`;\n+â”Š   â”Š 31â”Š\n+â”Š   â”Š 32â”Šexport const resolvers: Resolvers = {\n+â”Š   â”Š 33â”Š  Query: {\n+â”Š   â”Š 34â”Š    me(root, args, { currentUser }) {\n+â”Š   â”Š 35â”Š      return currentUser || null;\n+â”Š   â”Š 36â”Š    },\n+â”Š   â”Š 37â”Š    async users(root, args, { currentUser, db }) {\n+â”Š   â”Š 38â”Š      if (!currentUser) return [];\n+â”Š   â”Š 39â”Š\n+â”Š   â”Š 40â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š 41â”Š        SELECT * FROM users WHERE users.id != ${currentUser.id}\n+â”Š   â”Š 42â”Š      `);\n+â”Š   â”Š 43â”Š\n+â”Š   â”Š 44â”Š      return rows;\n+â”Š   â”Š 45â”Š    },\n+â”Š   â”Š 46â”Š  },\n+â”Š   â”Š 47â”Š  Mutation: {\n+â”Š   â”Š 48â”Š    async signIn(root, { username, password }, { db, res }) {\n+â”Š   â”Š 49â”Š      const { rows } = await db.query(\n+â”Š   â”Š 50â”Š        sql`SELECT * FROM users WHERE username = ${username}`\n+â”Š   â”Š 51â”Š      );\n+â”Š   â”Š 52â”Š      const user = rows[0];\n+â”Š   â”Š 53â”Š\n+â”Š   â”Š 54â”Š      if (!user) {\n+â”Š   â”Š 55â”Š        throw new Error('user not found');\n+â”Š   â”Š 56â”Š      }\n+â”Š   â”Š 57â”Š\n+â”Š   â”Š 58â”Š      const passwordsMatch = bcrypt.compareSync(password, user.password);\n+â”Š   â”Š 59â”Š\n+â”Š   â”Š 60â”Š      if (!passwordsMatch) {\n+â”Š   â”Š 61â”Š        throw new Error('password is incorrect');\n+â”Š   â”Š 62â”Š      }\n+â”Š   â”Š 63â”Š\n+â”Š   â”Š 64â”Š      const authToken = jwt.sign(username, secret);\n+â”Š   â”Š 65â”Š\n+â”Š   â”Š 66â”Š      res.cookie('authToken', authToken, { maxAge: expiration });\n+â”Š   â”Š 67â”Š\n+â”Š   â”Š 68â”Š      return user;\n+â”Š   â”Š 69â”Š    },\n+â”Š   â”Š 70â”Š\n+â”Š   â”Š 71â”Š    async signUp(root, { name, username, password, passwordConfirm }, { db }) {\n+â”Š   â”Š 72â”Š      validateLength('req.name', name, 3, 50);\n+â”Š   â”Š 73â”Š      validateLength('req.username', username, 3, 18);\n+â”Š   â”Š 74â”Š      validatePassword('req.password', password);\n+â”Š   â”Š 75â”Š\n+â”Š   â”Š 76â”Š      if (password !== passwordConfirm) {\n+â”Š   â”Š 77â”Š        throw Error(\"req.password and req.passwordConfirm don't match\");\n+â”Š   â”Š 78â”Š      }\n+â”Š   â”Š 79â”Š\n+â”Š   â”Š 80â”Š      const existingUserQuery = await db.query(\n+â”Š   â”Š 81â”Š        sql`SELECT * FROM users WHERE username = ${username}`\n+â”Š   â”Š 82â”Š      );\n+â”Š   â”Š 83â”Š      if (existingUserQuery.rows[0]) {\n+â”Š   â”Š 84â”Š        throw Error('username already exists');\n+â”Š   â”Š 85â”Š      }\n+â”Š   â”Š 86â”Š\n+â”Š   â”Š 87â”Š      const passwordHash = bcrypt.hashSync(password, bcrypt.genSaltSync(8));\n+â”Š   â”Š 88â”Š\n+â”Š   â”Š 89â”Š      const createdUserQuery = await db.query(sql`\n+â”Š   â”Š 90â”Š        INSERT INTO users(password, picture, username, name)\n+â”Š   â”Š 91â”Š        VALUES(${passwordHash}, '', ${username}, ${name})\n+â”Š   â”Š 92â”Š        RETURNING *\n+â”Š   â”Š 93â”Š      `);\n+â”Š   â”Š 94â”Š\n+â”Š   â”Š 95â”Š      const user = createdUserQuery.rows[0];\n+â”Š   â”Š 96â”Š\n+â”Š   â”Š 97â”Š      return user;\n+â”Š   â”Š 98â”Š    },\n+â”Š   â”Š 99â”Š  },\n+â”Š   â”Š100â”Š};\n```\n\n[}]: #\n\nAnd Chats module:\n\n[{]: <helper> (diffStep \"13.1\" files=\"modules/chats/index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.1: Modularize schema](https://github.com/Urigo/WhatsApp-Clone-Server/commit/3ebfc0cdd075930c9db1985240fa1909c06a974a)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,16 +1,47 @@\n-â”Š 1â”Š  â”Šimport { withFilter } from 'apollo-server-express';\n-â”Š 2â”Š  â”Šimport { GraphQLDateTime } from 'graphql-iso-date';\n-â”Š 3â”Š  â”Šimport { Message, Chat, pool } from '../db';\n-â”Š 4â”Š  â”Šimport { Resolvers } from '../types/graphql';\n-â”Š 5â”Š  â”Šimport { secret, expiration } from '../env';\n-â”Š 6â”Š  â”Šimport bcrypt from 'bcrypt';\n-â”Š 7â”Š  â”Šimport jwt from 'jsonwebtoken';\n-â”Š 8â”Š  â”Šimport { validateLength, validatePassword } from '../validators';\n+â”Š  â”Š 1â”Šimport { gql, withFilter } from 'apollo-server-express';\n â”Š 9â”Š 2â”Šimport sql from 'sql-template-strings';\n-â”Š10â”Š  â”Š\n-â”Š11â”Š  â”Šconst resolvers: Resolvers = {\n-â”Š12â”Š  â”Š  Date: GraphQLDateTime,\n-â”Š13â”Š  â”Š\n+â”Š  â”Š 3â”Šimport { Message, Chat, pool } from '../../db';\n+â”Š  â”Š 4â”Šimport { Resolvers } from '../../types/graphql';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šexport const typeDefs = gql`\n+â”Š  â”Š 7â”Š  type Message {\n+â”Š  â”Š 8â”Š    id: ID!\n+â”Š  â”Š 9â”Š    content: String!\n+â”Š  â”Š10â”Š    createdAt: Date!\n+â”Š  â”Š11â”Š    chat: Chat\n+â”Š  â”Š12â”Š    sender: User\n+â”Š  â”Š13â”Š    recipient: User\n+â”Š  â”Š14â”Š    isMine: Boolean!\n+â”Š  â”Š15â”Š  }\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š  type Chat {\n+â”Š  â”Š18â”Š    id: ID!\n+â”Š  â”Š19â”Š    name: String\n+â”Š  â”Š20â”Š    picture: String\n+â”Š  â”Š21â”Š    lastMessage: Message\n+â”Š  â”Š22â”Š    messages: [Message!]!\n+â”Š  â”Š23â”Š    participants: [User!]!\n+â”Š  â”Š24â”Š  }\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Š  extend type Query {\n+â”Š  â”Š27â”Š    chats: [Chat!]!\n+â”Š  â”Š28â”Š    chat(chatId: ID!): Chat\n+â”Š  â”Š29â”Š  }\n+â”Š  â”Š30â”Š\n+â”Š  â”Š31â”Š  extend type Mutation {\n+â”Š  â”Š32â”Š    addMessage(chatId: ID!, content: String!): Message\n+â”Š  â”Š33â”Š    addChat(recipientId: ID!): Chat\n+â”Š  â”Š34â”Š    removeChat(chatId: ID!): ID\n+â”Š  â”Š35â”Š  }\n+â”Š  â”Š36â”Š\n+â”Š  â”Š37â”Š  extend type Subscription {\n+â”Š  â”Š38â”Š    messageAdded: Message!\n+â”Š  â”Š39â”Š    chatAdded: Chat!\n+â”Š  â”Š40â”Š    chatRemoved: ID!\n+â”Š  â”Š41â”Š  }\n+â”Š  â”Š42â”Š`;\n+â”Š  â”Š43â”Š\n+â”Š  â”Š44â”Šexport const resolvers: Resolvers = {\n â”Š14â”Š45â”Š  Message: {\n â”Š15â”Š46â”Š    createdAt(message) {\n â”Š16â”Š47â”Š      return new Date(message.created_at);\n```\n```diff\n@@ -105,10 +136,6 @@\n â”Š105â”Š136â”Š  },\n â”Š106â”Š137â”Š\n â”Š107â”Š138â”Š  Query: {\n-â”Š108â”Š   â”Š    me(root, args, { currentUser }) {\n-â”Š109â”Š   â”Š      return currentUser || null;\n-â”Š110â”Š   â”Š    },\n-â”Š111â”Š   â”Š\n â”Š112â”Š139â”Š    async chats(root, args, { currentUser, db }) {\n â”Š113â”Š140â”Š      if (!currentUser) return [];\n â”Š114â”Š141â”Š\n```\n```diff\n@@ -133,71 +160,9 @@\n â”Š133â”Š160â”Š\n â”Š134â”Š161â”Š      return rows[0] ? rows[0] : null;\n â”Š135â”Š162â”Š    },\n-â”Š136â”Š   â”Š\n-â”Š137â”Š   â”Š    async users(root, args, { currentUser, db }) {\n-â”Š138â”Š   â”Š      if (!currentUser) return [];\n-â”Š139â”Š   â”Š\n-â”Š140â”Š   â”Š      const { rows } = await db.query(sql`\n-â”Š141â”Š   â”Š        SELECT * FROM users WHERE users.id != ${currentUser.id}\n-â”Š142â”Š   â”Š      `);\n-â”Š143â”Š   â”Š\n-â”Š144â”Š   â”Š      return rows;\n-â”Š145â”Š   â”Š    },\n â”Š146â”Š163â”Š  },\n â”Š147â”Š164â”Š\n â”Š148â”Š165â”Š  Mutation: {\n-â”Š149â”Š   â”Š    async signIn(root, { username, password }, { db, res }) {\n-â”Š150â”Š   â”Š      const { rows } = await db.query(\n-â”Š151â”Š   â”Š        sql`SELECT * FROM users WHERE username = ${username}`\n-â”Š152â”Š   â”Š      );\n-â”Š153â”Š   â”Š      const user = rows[0];\n-â”Š154â”Š   â”Š\n-â”Š155â”Š   â”Š      if (!user) {\n-â”Š156â”Š   â”Š        throw new Error('user not found');\n-â”Š157â”Š   â”Š      }\n-â”Š158â”Š   â”Š\n-â”Š159â”Š   â”Š      const passwordsMatch = bcrypt.compareSync(password, user.password);\n-â”Š160â”Š   â”Š\n-â”Š161â”Š   â”Š      if (!passwordsMatch) {\n-â”Š162â”Š   â”Š        throw new Error('password is incorrect');\n-â”Š163â”Š   â”Š      }\n-â”Š164â”Š   â”Š\n-â”Š165â”Š   â”Š      const authToken = jwt.sign(username, secret);\n-â”Š166â”Š   â”Š\n-â”Š167â”Š   â”Š      res.cookie('authToken', authToken, { maxAge: expiration });\n-â”Š168â”Š   â”Š\n-â”Š169â”Š   â”Š      return user;\n-â”Š170â”Š   â”Š    },\n-â”Š171â”Š   â”Š\n-â”Š172â”Š   â”Š    async signUp(root, { name, username, password, passwordConfirm }, { db }) {\n-â”Š173â”Š   â”Š      validateLength('req.name', name, 3, 50);\n-â”Š174â”Š   â”Š      validateLength('req.username', username, 3, 18);\n-â”Š175â”Š   â”Š      validatePassword('req.password', password);\n-â”Š176â”Š   â”Š\n-â”Š177â”Š   â”Š      if (password !== passwordConfirm) {\n-â”Š178â”Š   â”Š        throw Error(\"req.password and req.passwordConfirm don't match\");\n-â”Š179â”Š   â”Š      }\n-â”Š180â”Š   â”Š\n-â”Š181â”Š   â”Š      const existingUserQuery = await db.query(\n-â”Š182â”Š   â”Š        sql`SELECT * FROM users WHERE username = ${username}`\n-â”Š183â”Š   â”Š      );\n-â”Š184â”Š   â”Š      if (existingUserQuery.rows[0]) {\n-â”Š185â”Š   â”Š        throw Error('username already exists');\n-â”Š186â”Š   â”Š      }\n-â”Š187â”Š   â”Š\n-â”Š188â”Š   â”Š      const passwordHash = bcrypt.hashSync(password, bcrypt.genSaltSync(8));\n-â”Š189â”Š   â”Š\n-â”Š190â”Š   â”Š      const createdUserQuery = await db.query(sql`\n-â”Š191â”Š   â”Š        INSERT INTO users(password, picture, username, name)\n-â”Š192â”Š   â”Š        VALUES(${passwordHash}, '', ${username}, ${name})\n-â”Š193â”Š   â”Š        RETURNING *\n-â”Š194â”Š   â”Š      `);\n-â”Š195â”Š   â”Š\n-â”Š196â”Š   â”Š      const user = createdUserQuery.rows[0];\n-â”Š197â”Š   â”Š\n-â”Š198â”Š   â”Š      return user;\n-â”Š199â”Š   â”Š    },\n-â”Š200â”Š   â”Š\n â”Š201â”Š166â”Š    async addMessage(root, { chatId, content }, { currentUser, pubsub, db }) {\n â”Š202â”Š167â”Š      if (!currentUser) return null;\n â”Š203â”Š168â”Š\n```\n```diff\n@@ -360,5 +325,3 @@\n â”Š360â”Š325â”Š    },\n â”Š361â”Š326â”Š  },\n â”Š362â”Š327â”Š};\n-â”Š363â”Š   â”Š\n-â”Š364â”Š   â”Šexport default resolvers;\n```\n\n[}]: #\n\nSeems like modules are ready but we still need to create a Schema out of them.\n\n[{]: <helper> (diffStep \"13.1\" files=\"schema/index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.1: Modularize schema](https://github.com/Urigo/WhatsApp-Clone-Server/commit/3ebfc0cdd075930c9db1985240fa1909c06a974a)\n\n##### Changed schema&#x2F;index.ts\n```diff\n@@ -1,10 +1,15 @@\n-â”Š 1â”Š  â”Šimport { importSchema } from 'graphql-import';\n â”Š 2â”Š 1â”Šimport { makeExecutableSchema, IResolvers } from 'graphql-tools';\n-â”Š 3â”Š  â”Šimport resolvers from './resolvers';\n-â”Š 4â”Š  â”Š\n-â”Š 5â”Š  â”Šconst typeDefs = importSchema('schema/typeDefs.graphql');\n+â”Š  â”Š 2â”Šimport { merge } from 'lodash';\n+â”Š  â”Š 3â”Šimport * as commonModule from '../modules/common';\n+â”Š  â”Š 4â”Šimport * as usersModule from '../modules/users';\n+â”Š  â”Š 5â”Šimport * as chatsModule from '../modules/chats';\n â”Š 6â”Š 6â”Š\n â”Š 7â”Š 7â”Šexport default makeExecutableSchema({\n-â”Š 8â”Š  â”Š  resolvers: resolvers as IResolvers,\n-â”Š 9â”Š  â”Š  typeDefs,\n+â”Š  â”Š 8â”Š  resolvers: merge(\n+â”Š  â”Š 9â”Š    {},\n+â”Š  â”Š10â”Š    commonModule.resolvers,\n+â”Š  â”Š11â”Š    usersModule.resolvers,\n+â”Š  â”Š12â”Š    chatsModule.resolvers\n+â”Š  â”Š13â”Š  ) as IResolvers,\n+â”Š  â”Š14â”Š  typeDefs: [commonModule.typeDefs, usersModule.typeDefs, chatsModule.typeDefs],\n â”Š10â”Š15â”Š});\n```\n\n[}]: #\n\nBecause we moved everything from `resolvers.ts` and `typeDefs.graphql` files, those can now be removed.\n\nThe last thing we need to adjust is the GraphQL Code Generator's config, in `codegen.yml`:\n\n[{]: <helper> (diffStep \"13.1\" files=\"codegen.yml\" module=\"server\")\n\n#### [__Server__ Step 13.1: Modularize schema](https://github.com/Urigo/WhatsApp-Clone-Server/commit/3ebfc0cdd075930c9db1985240fa1909c06a974a)\n\n##### Changed codegen.yml\n```diff\n@@ -1,7 +1,7 @@\n â”Š1â”Š1â”Šoverwrite: true\n â”Š2â”Š2â”Šgenerates:\n â”Š3â”Š3â”Š  ./types/graphql.d.ts:\n-â”Š4â”Š â”Š    schema: ./schema/typeDefs.graphql\n+â”Š â”Š4â”Š    schema: ./modules/*/index.ts\n â”Š5â”Š5â”Š    plugins:\n â”Š6â”Š6â”Š      - typescript\n â”Š7â”Š7â”Š      - typescript-resolvers\n```\n\n[}]: #\n\nWe no longer keep all type definitions in one place and all documents are wrapped with `gql` tag, the codegen is smart enough to find those.\n\n### Using Apollo Modules\n\nAn alternative to the previous solution and far more interesting is a module feature of Apollo Server.\n\nLet's see how it all might look like when using Apollo Server's modules:\n\n[{]: <helper> (diffStep \"13.2\" files=\"index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.2: Use Apollo Modules](https://github.com/Urigo/WhatsApp-Clone-Server/commit/425896652973f34082b328de393341179ac9bb4b)\n\n##### Changed index.ts\n```diff\n@@ -5,12 +5,15 @@\n â”Š 5â”Š 5â”Šimport { app } from './app';\n â”Š 6â”Š 6â”Šimport { pool } from './db';\n â”Š 7â”Š 7â”Šimport { origin, port, secret } from './env';\n-â”Š 8â”Š  â”Šimport schema from './schema';\n â”Š 9â”Š 8â”Šimport { MyContext } from './context';\n â”Š10â”Š 9â”Šimport sql from 'sql-template-strings';\n â”Š11â”Š10â”Šimport { UnsplashApi } from './schema/unsplash.api';\n â”Š12â”Š11â”Šconst { PostgresPubSub } = require('graphql-postgres-subscriptions');\n â”Š13â”Š12â”Š\n+â”Š  â”Š13â”Šimport * as commonModule from './modules/common';\n+â”Š  â”Š14â”Šimport * as usersModule from './modules/users';\n+â”Š  â”Š15â”Šimport * as chatsModule from './modules/chats';\n+â”Š  â”Š16â”Š\n â”Š14â”Š17â”Šconst pubsub = new PostgresPubSub({\n â”Š15â”Š18â”Š  host: 'localhost',\n â”Š16â”Š19â”Š  port: process.env.DB_PORT ? parseInt(process.env.DB_PORT) : 5432,\n```\n```diff\n@@ -19,7 +22,7 @@\n â”Š19â”Š22â”Š  database: 'whatsapp',\n â”Š20â”Š23â”Š});\n â”Š21â”Š24â”Šconst server = new ApolloServer({\n-â”Š22â”Š  â”Š  schema,\n+â”Š  â”Š25â”Š  modules: [commonModule, usersModule, chatsModule],\n â”Š23â”Š26â”Š  context: async (session: any) => {\n â”Š24â”Š27â”Š    // Access the request object\n â”Š25â”Š28â”Š    let req = session.connection\n```\n\n##### Deleted schema&#x2F;index.ts\n```diff\n@@ -1,15 +0,0 @@\n-â”Š 1â”Š  â”Šimport { makeExecutableSchema, IResolvers } from 'graphql-tools';\n-â”Š 2â”Š  â”Šimport { merge } from 'lodash';\n-â”Š 3â”Š  â”Šimport * as commonModule from '../modules/common';\n-â”Š 4â”Š  â”Šimport * as usersModule from '../modules/users';\n-â”Š 5â”Š  â”Šimport * as chatsModule from '../modules/chats';\n-â”Š 6â”Š  â”Š\n-â”Š 7â”Š  â”Šexport default makeExecutableSchema({\n-â”Š 8â”Š  â”Š  resolvers: merge(\n-â”Š 9â”Š  â”Š    {},\n-â”Š10â”Š  â”Š    commonModule.resolvers,\n-â”Š11â”Š  â”Š    usersModule.resolvers,\n-â”Š12â”Š  â”Š    chatsModule.resolvers\n-â”Š13â”Š  â”Š  ) as IResolvers,\n-â”Š14â”Š  â”Š  typeDefs: [commonModule.typeDefs, usersModule.typeDefs, chatsModule.typeDefs],\n-â”Š15â”Š  â”Š});\n```\n\n[}]: #\n\nThe `modules` of ApolloServer accepts an array of objects with `resolvers` and `typeDefs` properties. That's exactly what we exported and that's why we can use esmodules directly.\n\nBecause we no longer use `schema.ts`, let's remove it.\n\nIf you would run the server right now, you will see a lot of warnings about missing index signatures. It's definitely nothing to worry about and can be easily fixed by using `useIndexSignature` flag of codegen:\n\n[{]: <helper> (diffStep \"13.2\" files=\"codegen.yml\" module=\"server\")\n\n#### [__Server__ Step 13.2: Use Apollo Modules](https://github.com/Urigo/WhatsApp-Clone-Server/commit/425896652973f34082b328de393341179ac9bb4b)\n\n##### Changed codegen.yml\n```diff\n@@ -6,6 +6,7 @@\n â”Š 6â”Š 6â”Š      - typescript\n â”Š 7â”Š 7â”Š      - typescript-resolvers\n â”Š 8â”Š 8â”Š    config:\n+â”Š  â”Š 9â”Š      useIndexSignature: true\n â”Š 9â”Š10â”Š      contextType: ../context#MyContext\n â”Š10â”Š11â”Š      mappers:\n â”Š11â”Š12â”Š        # import { Message } from '../db'\n```\n\n[}]: #\n\nYou might ask how is that different from what we have already implemented. The code is a bit simpler because the merging part is done by Apollo Server. We get some helpful messages when type's definition is missing but one of the modules was extending it and also when there are duplicates. Apollo Modules are very straightforward and basic but maybe that's all you really need in a project.\n\n### Using GraphQL Modules\n\nThere's an another alternative option that forces good patterns and providess a nice to work with API. It's called GraphQL Modules.\nThe main goal is to help organize an API and allow to develop it across multiple teams.\n\nyarn add @graphql-modules/core\n\nSame as Apollo Server's modules, has useful warnings and messages but you can use it with any implementation of GraphQL server.\n\n```ts\nimport { GraphQLModule } from â€˜@graphql-modules/core';\n\nexport default = new GraphQLModule({\n  name: 'common',\n  typeDefs,\n  resolvers\n});\n```\n\nIt's a bit similar to what we have in Apollo Modules but as you probably noticed, it's wrapped within `GraphQLModule` class. The class manages a business logic, SDL, resolvers and dependencies between modules.\n\n> An important thing to be aware of, GraphQL Modules encapsulates every module. To get a better understanding, think of it as CSS Modules.\n\nNow that you know some basics, let's implement the simplest of all modules:\n\n[{]: <helper> (diffStep \"13.3\" files=\"modules/common/index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.3: Use GraphQL Modules](https://github.com/Urigo/WhatsApp-Clone-Server/commit/b293c5945a7947d9445caebcb243f76586dc65b6)\n\n##### Changed modules&#x2F;common&#x2F;index.ts\n```diff\n@@ -1,8 +1,12 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š 1â”Š 2â”Šimport { gql } from 'apollo-server-express';\n â”Š 2â”Š 3â”Šimport { GraphQLDateTime } from 'graphql-iso-date';\n+â”Š  â”Š 4â”Šimport { pool } from '../../db';\n â”Š 3â”Š 5â”Šimport { Resolvers } from '../../types/graphql';\n â”Š 4â”Š 6â”Š\n-â”Š 5â”Š  â”Šexport const typeDefs = gql`\n+â”Š  â”Š 7â”Šconst { PostgresPubSub } = require('graphql-postgres-subscriptions');\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Šconst typeDefs = gql`\n â”Š 6â”Š10â”Š  scalar Date\n â”Š 7â”Š11â”Š\n â”Š 8â”Š12â”Š  type Query {\n```\n```diff\n@@ -18,6 +22,33 @@\n â”Š18â”Š22â”Š  }\n â”Š19â”Š23â”Š`;\n â”Š20â”Š24â”Š\n-â”Š21â”Š  â”Šexport const resolvers: Resolvers = {\n+â”Š  â”Š25â”Šconst resolvers: Resolvers = {\n â”Š22â”Š26â”Š  Date: GraphQLDateTime,\n â”Š23â”Š27â”Š};\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Šconst pubsub = new PostgresPubSub({\n+â”Š  â”Š30â”Š  host: 'localhost',\n+â”Š  â”Š31â”Š  port: process.env.DB_PORT ? parseInt(process.env.DB_PORT) : 5432,\n+â”Š  â”Š32â”Š  user: 'testuser',\n+â”Š  â”Š33â”Š  password: 'testpassword',\n+â”Š  â”Š34â”Š  database: 'whatsapp',\n+â”Š  â”Š35â”Š});\n+â”Š  â”Š36â”Š\n+â”Š  â”Š37â”Šexport default new GraphQLModule({\n+â”Š  â”Š38â”Š  name: 'common',\n+â”Š  â”Š39â”Š  typeDefs,\n+â”Š  â”Š40â”Š  resolvers,\n+â”Š  â”Š41â”Š  async context({ res, connection }) {\n+â”Š  â”Š42â”Š    let db;\n+â”Š  â”Š43â”Š\n+â”Š  â”Š44â”Š    if (!connection) {\n+â”Š  â”Š45â”Š      db = await pool.connect();\n+â”Š  â”Š46â”Š    }\n+â”Š  â”Š47â”Š\n+â”Š  â”Š48â”Š    return {\n+â”Š  â”Š49â”Š      pubsub,\n+â”Š  â”Š50â”Š      res,\n+â”Š  â”Š51â”Š      db,\n+â”Š  â”Š52â”Š    };\n+â”Š  â”Š53â”Š  },\n+â”Š  â”Š54â”Š});\n```\n\n[}]: #\n\nAs we mentioned, there's no global context so we moved the common parts into Common module.\n\nLet's take care of other two modules and migrate `modules/users/index.ts` first:\n\n[{]: <helper> (diffStep \"13.3\" files=\"modules/users/index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.3: Use GraphQL Modules](https://github.com/Urigo/WhatsApp-Clone-Server/commit/b293c5945a7947d9445caebcb243f76586dc65b6)\n\n##### Changed modules&#x2F;users&#x2F;index.ts\n```diff\n@@ -1,12 +1,16 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š 1â”Š 2â”Šimport { gql } from 'apollo-server-express';\n+â”Š  â”Š 3â”Šimport cookie from 'cookie';\n â”Š 2â”Š 4â”Šimport sql from 'sql-template-strings';\n â”Š 3â”Š 5â”Šimport bcrypt from 'bcrypt';\n â”Š 4â”Š 6â”Šimport jwt from 'jsonwebtoken';\n+â”Š  â”Š 7â”Šimport commonModule from '../common';\n â”Š 5â”Š 8â”Šimport { secret, expiration } from '../../env';\n+â”Š  â”Š 9â”Šimport { pool } from '../../db';\n â”Š 6â”Š10â”Šimport { validateLength, validatePassword } from '../../validators';\n â”Š 7â”Š11â”Šimport { Resolvers } from '../../types/graphql';\n â”Š 8â”Š12â”Š\n-â”Š 9â”Š  â”Šexport const typeDefs = gql`\n+â”Š  â”Š13â”Šconst typeDefs = gql`\n â”Š10â”Š14â”Š  type User {\n â”Š11â”Š15â”Š    id: ID!\n â”Š12â”Š16â”Š    name: String!\n```\n```diff\n@@ -29,7 +33,7 @@\n â”Š29â”Š33â”Š  }\n â”Š30â”Š34â”Š`;\n â”Š31â”Š35â”Š\n-â”Š32â”Š  â”Šexport const resolvers: Resolvers = {\n+â”Š  â”Š36â”Šconst resolvers: Resolvers = {\n â”Š33â”Š37â”Š  Query: {\n â”Š34â”Š38â”Š    me(root, args, { currentUser }) {\n â”Š35â”Š39â”Š      return currentUser || null;\n```\n```diff\n@@ -98,3 +102,38 @@\n â”Š 98â”Š102â”Š    },\n â”Š 99â”Š103â”Š  },\n â”Š100â”Š104â”Š};\n+â”Š   â”Š105â”Š\n+â”Š   â”Š106â”Šexport default new GraphQLModule({\n+â”Š   â”Š107â”Š  name: 'users',\n+â”Š   â”Š108â”Š  typeDefs,\n+â”Š   â”Š109â”Š  resolvers,\n+â”Š   â”Š110â”Š  imports: () => [commonModule],\n+â”Š   â”Š111â”Š  async context(session) {\n+â”Š   â”Š112â”Š    let currentUser;\n+â”Š   â”Š113â”Š\n+â”Š   â”Š114â”Š    // Access the request object\n+â”Š   â”Š115â”Š    let req = session.connection\n+â”Š   â”Š116â”Š      ? session.connection.context.request\n+â”Š   â”Š117â”Š      : session.req;\n+â”Š   â”Š118â”Š\n+â”Š   â”Š119â”Š    // It's subscription\n+â”Š   â”Š120â”Š    if (session.connection) {\n+â”Š   â”Š121â”Š      req.cookies = cookie.parse(req.headers.cookie || '');\n+â”Š   â”Š122â”Š    }\n+â”Š   â”Š123â”Š\n+â”Š   â”Š124â”Š    if (req.cookies.authToken) {\n+â”Š   â”Š125â”Š      const username = jwt.verify(req.cookies.authToken, secret) as string;\n+â”Š   â”Š126â”Š\n+â”Š   â”Š127â”Š      if (username) {\n+â”Š   â”Š128â”Š        const { rows } = await pool.query(\n+â”Š   â”Š129â”Š          sql`SELECT * FROM users WHERE username = ${username}`\n+â”Š   â”Š130â”Š        );\n+â”Š   â”Š131â”Š        currentUser = rows[0];\n+â”Š   â”Š132â”Š      }\n+â”Š   â”Š133â”Š    }\n+â”Š   â”Š134â”Š\n+â”Š   â”Š135â”Š    return {\n+â”Š   â”Š136â”Š      currentUser,\n+â”Š   â”Š137â”Š    };\n+â”Š   â”Š138â”Š  },\n+â”Š   â”Š139â”Š});\n```\n\n[}]: #\n\nJust like with Common, we also moved related context but there's a totally new thing called `imports`. In order to let Users module see Common's contents (types, resolvers, context etc) we need to include it in the dependencies.\n\nNow `Chats` that depends on `Users` and `Common` modules:\n\n[{]: <helper> (diffStep \"13.3\" files=\"modules/chats/index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.3: Use GraphQL Modules](https://github.com/Urigo/WhatsApp-Clone-Server/commit/b293c5945a7947d9445caebcb243f76586dc65b6)\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -1,9 +1,12 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š 1â”Š 2â”Šimport { gql, withFilter } from 'apollo-server-express';\n â”Š 2â”Š 3â”Šimport sql from 'sql-template-strings';\n+â”Š  â”Š 4â”Šimport commonModule from '../common';\n+â”Š  â”Š 5â”Šimport usersModule from '../users';\n â”Š 3â”Š 6â”Šimport { Message, Chat, pool } from '../../db';\n â”Š 4â”Š 7â”Šimport { Resolvers } from '../../types/graphql';\n â”Š 5â”Š 8â”Š\n-â”Š 6â”Š  â”Šexport const typeDefs = gql`\n+â”Š  â”Š 9â”Šconst typeDefs = gql`\n â”Š 7â”Š10â”Š  type Message {\n â”Š 8â”Š11â”Š    id: ID!\n â”Š 9â”Š12â”Š    content: String!\n```\n```diff\n@@ -41,7 +44,7 @@\n â”Š41â”Š44â”Š  }\n â”Š42â”Š45â”Š`;\n â”Š43â”Š46â”Š\n-â”Š44â”Š  â”Šexport const resolvers: Resolvers = {\n+â”Š  â”Š47â”Šconst resolvers: Resolvers = {\n â”Š45â”Š48â”Š  Message: {\n â”Š46â”Š49â”Š    createdAt(message) {\n â”Š47â”Š50â”Š      return new Date(message.created_at);\n```\n```diff\n@@ -325,3 +328,10 @@\n â”Š325â”Š328â”Š    },\n â”Š326â”Š329â”Š  },\n â”Š327â”Š330â”Š};\n+â”Š   â”Š331â”Š\n+â”Š   â”Š332â”Šexport default new GraphQLModule({\n+â”Š   â”Š333â”Š  name: 'chats',\n+â”Š   â”Š334â”Š  typeDefs,\n+â”Š   â”Š335â”Š  resolvers,\n+â”Š   â”Š336â”Š  imports: () => [commonModule, usersModule],\n+â”Š   â”Š337â”Š});\n```\n\n[}]: #\n\nSince every module is now a GraphQL Module, we can take care of how to use them in the ApolloServer.\n\nTo make things easier, we're going to create a module that's called `Root` and represents our API.\n\n```ts\nexport const rootModule = new GraphQLModule({\n  name: 'root',\n  imports: [usersModule, chatsModule],\n});\n```\n\nWe want to pass `schema` and `context` to ApolloServer:\n\n```ts\nconst server = new ApolloServer({\n  schema: rootModule.schema,\n  context: rootModule.context,\n  // ...\n```\n\nNow with all that knowledge, take a look at all changes at once:\n\n[{]: <helper> (diffStep \"13.3\" files=\"index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.3: Use GraphQL Modules](https://github.com/Urigo/WhatsApp-Clone-Server/commit/b293c5945a7947d9445caebcb243f76586dc65b6)\n\n##### Changed index.ts\n```diff\n@@ -1,71 +1,23 @@\n â”Š 1â”Š 1â”Šimport { ApolloServer } from 'apollo-server-express';\n-â”Š 2â”Š  â”Šimport cookie from 'cookie';\n+â”Š  â”Š 2â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š 3â”Š 3â”Šimport http from 'http';\n-â”Š 4â”Š  â”Šimport jwt from 'jsonwebtoken';\n â”Š 5â”Š 4â”Šimport { app } from './app';\n-â”Š 6â”Š  â”Šimport { pool } from './db';\n-â”Š 7â”Š  â”Šimport { origin, port, secret } from './env';\n+â”Š  â”Š 5â”Šimport { origin, port } from './env';\n â”Š 8â”Š 6â”Šimport { MyContext } from './context';\n-â”Š 9â”Š  â”Šimport sql from 'sql-template-strings';\n â”Š10â”Š 7â”Šimport { UnsplashApi } from './schema/unsplash.api';\n-â”Š11â”Š  â”Šconst { PostgresPubSub } = require('graphql-postgres-subscriptions');\n â”Š12â”Š 8â”Š\n-â”Š13â”Š  â”Šimport * as commonModule from './modules/common';\n-â”Š14â”Š  â”Šimport * as usersModule from './modules/users';\n-â”Š15â”Š  â”Šimport * as chatsModule from './modules/chats';\n+â”Š  â”Š 9â”Šimport usersModule from './modules/users';\n+â”Š  â”Š10â”Šimport chatsModule from './modules/chats';\n â”Š16â”Š11â”Š\n-â”Š17â”Š  â”Šconst pubsub = new PostgresPubSub({\n-â”Š18â”Š  â”Š  host: 'localhost',\n-â”Š19â”Š  â”Š  port: process.env.DB_PORT ? parseInt(process.env.DB_PORT) : 5432,\n-â”Š20â”Š  â”Š  user: 'testuser',\n-â”Š21â”Š  â”Š  password: 'testpassword',\n-â”Š22â”Š  â”Š  database: 'whatsapp',\n+â”Š  â”Š12â”Šexport const rootModule = new GraphQLModule({\n+â”Š  â”Š13â”Š  name: 'root',\n+â”Š  â”Š14â”Š  imports: [usersModule, chatsModule],\n â”Š23â”Š15â”Š});\n-â”Š24â”Š  â”Šconst server = new ApolloServer({\n-â”Š25â”Š  â”Š  modules: [commonModule, usersModule, chatsModule],\n-â”Š26â”Š  â”Š  context: async (session: any) => {\n-â”Š27â”Š  â”Š    // Access the request object\n-â”Š28â”Š  â”Š    let req = session.connection\n-â”Š29â”Š  â”Š      ? session.connection.context.request\n-â”Š30â”Š  â”Š      : session.req;\n-â”Š31â”Š  â”Š\n-â”Š32â”Š  â”Š    // It's subscription\n-â”Š33â”Š  â”Š    if (session.connection) {\n-â”Š34â”Š  â”Š      req.cookies = cookie.parse(req.headers.cookie || '');\n-â”Š35â”Š  â”Š    }\n-â”Š36â”Š  â”Š\n-â”Š37â”Š  â”Š    let currentUser;\n-â”Š38â”Š  â”Š    if (req.cookies.authToken) {\n-â”Š39â”Š  â”Š      const username = jwt.verify(req.cookies.authToken, secret) as string;\n-â”Š40â”Š  â”Š      if (username) {\n-â”Š41â”Š  â”Š        const { rows } = await pool.query(\n-â”Š42â”Š  â”Š          sql`SELECT * FROM users WHERE username = ${username}`\n-â”Š43â”Š  â”Š        );\n-â”Š44â”Š  â”Š        currentUser = rows[0];\n-â”Š45â”Š  â”Š      }\n-â”Š46â”Š  â”Š    }\n-â”Š47â”Š  â”Š\n-â”Š48â”Š  â”Š    let db;\n â”Š49â”Š16â”Š\n-â”Š50â”Š  â”Š    if (!session.connection) {\n-â”Š51â”Š  â”Š      db = await pool.connect();\n-â”Š52â”Š  â”Š    }\n-â”Š53â”Š  â”Š\n-â”Š54â”Š  â”Š    return {\n-â”Š55â”Š  â”Š      currentUser,\n-â”Š56â”Š  â”Š      pubsub,\n-â”Š57â”Š  â”Š      db,\n-â”Š58â”Š  â”Š      res: session.res,\n-â”Š59â”Š  â”Š    };\n-â”Š60â”Š  â”Š  },\n-â”Š61â”Š  â”Š  subscriptions: {\n-â”Š62â”Š  â”Š    onConnect(params, ws, ctx) {\n-â”Š63â”Š  â”Š      // pass the request object to context\n-â”Š64â”Š  â”Š      return {\n-â”Š65â”Š  â”Š        request: ctx.request,\n-â”Š66â”Š  â”Š      };\n-â”Š67â”Š  â”Š    },\n-â”Š68â”Š  â”Š  },\n+â”Š  â”Š17â”Šconst server = new ApolloServer({\n+â”Š  â”Š18â”Š  schema: rootModule.schema,\n+â”Š  â”Š19â”Š  context: rootModule.context,\n+â”Š  â”Š20â”Š  subscriptions: rootModule.subscriptions,\n â”Š69â”Š21â”Š  formatResponse: (res: any, { context }: { context: MyContext }) => {\n â”Š70â”Š22â”Š    context.db.release();\n â”Š71â”Š23â”Š\n```\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -1,9 +1,12 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š 1â”Š 2â”Šimport { gql, withFilter } from 'apollo-server-express';\n â”Š 2â”Š 3â”Šimport sql from 'sql-template-strings';\n+â”Š  â”Š 4â”Šimport commonModule from '../common';\n+â”Š  â”Š 5â”Šimport usersModule from '../users';\n â”Š 3â”Š 6â”Šimport { Message, Chat, pool } from '../../db';\n â”Š 4â”Š 7â”Šimport { Resolvers } from '../../types/graphql';\n â”Š 5â”Š 8â”Š\n-â”Š 6â”Š  â”Šexport const typeDefs = gql`\n+â”Š  â”Š 9â”Šconst typeDefs = gql`\n â”Š 7â”Š10â”Š  type Message {\n â”Š 8â”Š11â”Š    id: ID!\n â”Š 9â”Š12â”Š    content: String!\n```\n```diff\n@@ -41,7 +44,7 @@\n â”Š41â”Š44â”Š  }\n â”Š42â”Š45â”Š`;\n â”Š43â”Š46â”Š\n-â”Š44â”Š  â”Šexport const resolvers: Resolvers = {\n+â”Š  â”Š47â”Šconst resolvers: Resolvers = {\n â”Š45â”Š48â”Š  Message: {\n â”Š46â”Š49â”Š    createdAt(message) {\n â”Š47â”Š50â”Š      return new Date(message.created_at);\n```\n```diff\n@@ -325,3 +328,10 @@\n â”Š325â”Š328â”Š    },\n â”Š326â”Š329â”Š  },\n â”Š327â”Š330â”Š};\n+â”Š   â”Š331â”Š\n+â”Š   â”Š332â”Šexport default new GraphQLModule({\n+â”Š   â”Š333â”Š  name: 'chats',\n+â”Š   â”Š334â”Š  typeDefs,\n+â”Š   â”Š335â”Š  resolvers,\n+â”Š   â”Š336â”Š  imports: () => [commonModule, usersModule],\n+â”Š   â”Š337â”Š});\n```\n\n##### Changed modules&#x2F;common&#x2F;index.ts\n```diff\n@@ -1,8 +1,12 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š 1â”Š 2â”Šimport { gql } from 'apollo-server-express';\n â”Š 2â”Š 3â”Šimport { GraphQLDateTime } from 'graphql-iso-date';\n+â”Š  â”Š 4â”Šimport { pool } from '../../db';\n â”Š 3â”Š 5â”Šimport { Resolvers } from '../../types/graphql';\n â”Š 4â”Š 6â”Š\n-â”Š 5â”Š  â”Šexport const typeDefs = gql`\n+â”Š  â”Š 7â”Šconst { PostgresPubSub } = require('graphql-postgres-subscriptions');\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Šconst typeDefs = gql`\n â”Š 6â”Š10â”Š  scalar Date\n â”Š 7â”Š11â”Š\n â”Š 8â”Š12â”Š  type Query {\n```\n```diff\n@@ -18,6 +22,33 @@\n â”Š18â”Š22â”Š  }\n â”Š19â”Š23â”Š`;\n â”Š20â”Š24â”Š\n-â”Š21â”Š  â”Šexport const resolvers: Resolvers = {\n+â”Š  â”Š25â”Šconst resolvers: Resolvers = {\n â”Š22â”Š26â”Š  Date: GraphQLDateTime,\n â”Š23â”Š27â”Š};\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Šconst pubsub = new PostgresPubSub({\n+â”Š  â”Š30â”Š  host: 'localhost',\n+â”Š  â”Š31â”Š  port: process.env.DB_PORT ? parseInt(process.env.DB_PORT) : 5432,\n+â”Š  â”Š32â”Š  user: 'testuser',\n+â”Š  â”Š33â”Š  password: 'testpassword',\n+â”Š  â”Š34â”Š  database: 'whatsapp',\n+â”Š  â”Š35â”Š});\n+â”Š  â”Š36â”Š\n+â”Š  â”Š37â”Šexport default new GraphQLModule({\n+â”Š  â”Š38â”Š  name: 'common',\n+â”Š  â”Š39â”Š  typeDefs,\n+â”Š  â”Š40â”Š  resolvers,\n+â”Š  â”Š41â”Š  async context({ res, connection }) {\n+â”Š  â”Š42â”Š    let db;\n+â”Š  â”Š43â”Š\n+â”Š  â”Š44â”Š    if (!connection) {\n+â”Š  â”Š45â”Š      db = await pool.connect();\n+â”Š  â”Š46â”Š    }\n+â”Š  â”Š47â”Š\n+â”Š  â”Š48â”Š    return {\n+â”Š  â”Š49â”Š      pubsub,\n+â”Š  â”Š50â”Š      res,\n+â”Š  â”Š51â”Š      db,\n+â”Š  â”Š52â”Š    };\n+â”Š  â”Š53â”Š  },\n+â”Š  â”Š54â”Š});\n```\n\n##### Changed modules&#x2F;users&#x2F;index.ts\n```diff\n@@ -1,12 +1,16 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š 1â”Š 2â”Šimport { gql } from 'apollo-server-express';\n+â”Š  â”Š 3â”Šimport cookie from 'cookie';\n â”Š 2â”Š 4â”Šimport sql from 'sql-template-strings';\n â”Š 3â”Š 5â”Šimport bcrypt from 'bcrypt';\n â”Š 4â”Š 6â”Šimport jwt from 'jsonwebtoken';\n+â”Š  â”Š 7â”Šimport commonModule from '../common';\n â”Š 5â”Š 8â”Šimport { secret, expiration } from '../../env';\n+â”Š  â”Š 9â”Šimport { pool } from '../../db';\n â”Š 6â”Š10â”Šimport { validateLength, validatePassword } from '../../validators';\n â”Š 7â”Š11â”Šimport { Resolvers } from '../../types/graphql';\n â”Š 8â”Š12â”Š\n-â”Š 9â”Š  â”Šexport const typeDefs = gql`\n+â”Š  â”Š13â”Šconst typeDefs = gql`\n â”Š10â”Š14â”Š  type User {\n â”Š11â”Š15â”Š    id: ID!\n â”Š12â”Š16â”Š    name: String!\n```\n```diff\n@@ -29,7 +33,7 @@\n â”Š29â”Š33â”Š  }\n â”Š30â”Š34â”Š`;\n â”Š31â”Š35â”Š\n-â”Š32â”Š  â”Šexport const resolvers: Resolvers = {\n+â”Š  â”Š36â”Šconst resolvers: Resolvers = {\n â”Š33â”Š37â”Š  Query: {\n â”Š34â”Š38â”Š    me(root, args, { currentUser }) {\n â”Š35â”Š39â”Š      return currentUser || null;\n```\n```diff\n@@ -98,3 +102,38 @@\n â”Š 98â”Š102â”Š    },\n â”Š 99â”Š103â”Š  },\n â”Š100â”Š104â”Š};\n+â”Š   â”Š105â”Š\n+â”Š   â”Š106â”Šexport default new GraphQLModule({\n+â”Š   â”Š107â”Š  name: 'users',\n+â”Š   â”Š108â”Š  typeDefs,\n+â”Š   â”Š109â”Š  resolvers,\n+â”Š   â”Š110â”Š  imports: () => [commonModule],\n+â”Š   â”Š111â”Š  async context(session) {\n+â”Š   â”Š112â”Š    let currentUser;\n+â”Š   â”Š113â”Š\n+â”Š   â”Š114â”Š    // Access the request object\n+â”Š   â”Š115â”Š    let req = session.connection\n+â”Š   â”Š116â”Š      ? session.connection.context.request\n+â”Š   â”Š117â”Š      : session.req;\n+â”Š   â”Š118â”Š\n+â”Š   â”Š119â”Š    // It's subscription\n+â”Š   â”Š120â”Š    if (session.connection) {\n+â”Š   â”Š121â”Š      req.cookies = cookie.parse(req.headers.cookie || '');\n+â”Š   â”Š122â”Š    }\n+â”Š   â”Š123â”Š\n+â”Š   â”Š124â”Š    if (req.cookies.authToken) {\n+â”Š   â”Š125â”Š      const username = jwt.verify(req.cookies.authToken, secret) as string;\n+â”Š   â”Š126â”Š\n+â”Š   â”Š127â”Š      if (username) {\n+â”Š   â”Š128â”Š        const { rows } = await pool.query(\n+â”Š   â”Š129â”Š          sql`SELECT * FROM users WHERE username = ${username}`\n+â”Š   â”Š130â”Š        );\n+â”Š   â”Š131â”Š        currentUser = rows[0];\n+â”Š   â”Š132â”Š      }\n+â”Š   â”Š133â”Š    }\n+â”Š   â”Š134â”Š\n+â”Š   â”Š135â”Š    return {\n+â”Š   â”Š136â”Š      currentUser,\n+â”Š   â”Š137â”Š    };\n+â”Š   â”Š138â”Š  },\n+â”Š   â”Š139â”Š});\n```\n\n[}]: #\n\n#### Migrate Unsplash API to Chats\n\nWe still make use of global context which won't work with GraphQL Modules. To be more specific, it's not the context definition itself but the thing that's being added by ApolloServer, Data Sources.\n\nThe `RESTDataSource` is of course more than a class but in case of Unsplash API we won't loose any important features except the HTTP client. We're going to use `axios` instead:\n\nyarn add axios\n\nWe've got everything now so let's migrate UnsplashAPI class and move it from `schema/unsplash.api.ts` under `modules/chats`!\n\n[{]: <helper> (diffStep \"13.3\" files=\"modules/chats/unsplash.api.ts\" module=\"server\")\n\n#### [__Server__ Step 13.3: Use GraphQL Modules](https://github.com/Urigo/WhatsApp-Clone-Server/commit/b293c5945a7947d9445caebcb243f76586dc65b6)\n\n\n\n[}]: #\n\nThere is no big differences between now and what we had before, the only thing that's changed is the way we make http requests.\n\nThe `UnsplashAPI` can be now removed from `dataSources` and moved under Chats module's context:\n\n[{]: <helper> (diffStep \"13.3\" files=\"index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.3: Use GraphQL Modules](https://github.com/Urigo/WhatsApp-Clone-Server/commit/b293c5945a7947d9445caebcb243f76586dc65b6)\n\n##### Changed index.ts\n```diff\n@@ -1,71 +1,23 @@\n â”Š 1â”Š 1â”Šimport { ApolloServer } from 'apollo-server-express';\n-â”Š 2â”Š  â”Šimport cookie from 'cookie';\n+â”Š  â”Š 2â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š 3â”Š 3â”Šimport http from 'http';\n-â”Š 4â”Š  â”Šimport jwt from 'jsonwebtoken';\n â”Š 5â”Š 4â”Šimport { app } from './app';\n-â”Š 6â”Š  â”Šimport { pool } from './db';\n-â”Š 7â”Š  â”Šimport { origin, port, secret } from './env';\n+â”Š  â”Š 5â”Šimport { origin, port } from './env';\n â”Š 8â”Š 6â”Šimport { MyContext } from './context';\n-â”Š 9â”Š  â”Šimport sql from 'sql-template-strings';\n â”Š10â”Š 7â”Šimport { UnsplashApi } from './schema/unsplash.api';\n-â”Š11â”Š  â”Šconst { PostgresPubSub } = require('graphql-postgres-subscriptions');\n â”Š12â”Š 8â”Š\n-â”Š13â”Š  â”Šimport * as commonModule from './modules/common';\n-â”Š14â”Š  â”Šimport * as usersModule from './modules/users';\n-â”Š15â”Š  â”Šimport * as chatsModule from './modules/chats';\n+â”Š  â”Š 9â”Šimport usersModule from './modules/users';\n+â”Š  â”Š10â”Šimport chatsModule from './modules/chats';\n â”Š16â”Š11â”Š\n-â”Š17â”Š  â”Šconst pubsub = new PostgresPubSub({\n-â”Š18â”Š  â”Š  host: 'localhost',\n-â”Š19â”Š  â”Š  port: process.env.DB_PORT ? parseInt(process.env.DB_PORT) : 5432,\n-â”Š20â”Š  â”Š  user: 'testuser',\n-â”Š21â”Š  â”Š  password: 'testpassword',\n-â”Š22â”Š  â”Š  database: 'whatsapp',\n+â”Š  â”Š12â”Šexport const rootModule = new GraphQLModule({\n+â”Š  â”Š13â”Š  name: 'root',\n+â”Š  â”Š14â”Š  imports: [usersModule, chatsModule],\n â”Š23â”Š15â”Š});\n-â”Š24â”Š  â”Šconst server = new ApolloServer({\n-â”Š25â”Š  â”Š  modules: [commonModule, usersModule, chatsModule],\n-â”Š26â”Š  â”Š  context: async (session: any) => {\n-â”Š27â”Š  â”Š    // Access the request object\n-â”Š28â”Š  â”Š    let req = session.connection\n-â”Š29â”Š  â”Š      ? session.connection.context.request\n-â”Š30â”Š  â”Š      : session.req;\n-â”Š31â”Š  â”Š\n-â”Š32â”Š  â”Š    // It's subscription\n-â”Š33â”Š  â”Š    if (session.connection) {\n-â”Š34â”Š  â”Š      req.cookies = cookie.parse(req.headers.cookie || '');\n-â”Š35â”Š  â”Š    }\n-â”Š36â”Š  â”Š\n-â”Š37â”Š  â”Š    let currentUser;\n-â”Š38â”Š  â”Š    if (req.cookies.authToken) {\n-â”Š39â”Š  â”Š      const username = jwt.verify(req.cookies.authToken, secret) as string;\n-â”Š40â”Š  â”Š      if (username) {\n-â”Š41â”Š  â”Š        const { rows } = await pool.query(\n-â”Š42â”Š  â”Š          sql`SELECT * FROM users WHERE username = ${username}`\n-â”Š43â”Š  â”Š        );\n-â”Š44â”Š  â”Š        currentUser = rows[0];\n-â”Š45â”Š  â”Š      }\n-â”Š46â”Š  â”Š    }\n-â”Š47â”Š  â”Š\n-â”Š48â”Š  â”Š    let db;\n â”Š49â”Š16â”Š\n-â”Š50â”Š  â”Š    if (!session.connection) {\n-â”Š51â”Š  â”Š      db = await pool.connect();\n-â”Š52â”Š  â”Š    }\n-â”Š53â”Š  â”Š\n-â”Š54â”Š  â”Š    return {\n-â”Š55â”Š  â”Š      currentUser,\n-â”Š56â”Š  â”Š      pubsub,\n-â”Š57â”Š  â”Š      db,\n-â”Š58â”Š  â”Š      res: session.res,\n-â”Š59â”Š  â”Š    };\n-â”Š60â”Š  â”Š  },\n-â”Š61â”Š  â”Š  subscriptions: {\n-â”Š62â”Š  â”Š    onConnect(params, ws, ctx) {\n-â”Š63â”Š  â”Š      // pass the request object to context\n-â”Š64â”Š  â”Š      return {\n-â”Š65â”Š  â”Š        request: ctx.request,\n-â”Š66â”Š  â”Š      };\n-â”Š67â”Š  â”Š    },\n-â”Š68â”Š  â”Š  },\n+â”Š  â”Š17â”Šconst server = new ApolloServer({\n+â”Š  â”Š18â”Š  schema: rootModule.schema,\n+â”Š  â”Š19â”Š  context: rootModule.context,\n+â”Š  â”Š20â”Š  subscriptions: rootModule.subscriptions,\n â”Š69â”Š21â”Š  formatResponse: (res: any, { context }: { context: MyContext }) => {\n â”Š70â”Š22â”Š    context.db.release();\n â”Š71â”Š23â”Š\n```\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -1,9 +1,12 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š 1â”Š 2â”Šimport { gql, withFilter } from 'apollo-server-express';\n â”Š 2â”Š 3â”Šimport sql from 'sql-template-strings';\n+â”Š  â”Š 4â”Šimport commonModule from '../common';\n+â”Š  â”Š 5â”Šimport usersModule from '../users';\n â”Š 3â”Š 6â”Šimport { Message, Chat, pool } from '../../db';\n â”Š 4â”Š 7â”Šimport { Resolvers } from '../../types/graphql';\n â”Š 5â”Š 8â”Š\n-â”Š 6â”Š  â”Šexport const typeDefs = gql`\n+â”Š  â”Š 9â”Šconst typeDefs = gql`\n â”Š 7â”Š10â”Š  type Message {\n â”Š 8â”Š11â”Š    id: ID!\n â”Š 9â”Š12â”Š    content: String!\n```\n```diff\n@@ -41,7 +44,7 @@\n â”Š41â”Š44â”Š  }\n â”Š42â”Š45â”Š`;\n â”Š43â”Š46â”Š\n-â”Š44â”Š  â”Šexport const resolvers: Resolvers = {\n+â”Š  â”Š47â”Šconst resolvers: Resolvers = {\n â”Š45â”Š48â”Š  Message: {\n â”Š46â”Š49â”Š    createdAt(message) {\n â”Š47â”Š50â”Š      return new Date(message.created_at);\n```\n```diff\n@@ -325,3 +328,10 @@\n â”Š325â”Š328â”Š    },\n â”Š326â”Š329â”Š  },\n â”Š327â”Š330â”Š};\n+â”Š   â”Š331â”Š\n+â”Š   â”Š332â”Šexport default new GraphQLModule({\n+â”Š   â”Š333â”Š  name: 'chats',\n+â”Š   â”Š334â”Š  typeDefs,\n+â”Š   â”Š335â”Š  resolvers,\n+â”Š   â”Š336â”Š  imports: () => [commonModule, usersModule],\n+â”Š   â”Š337â”Š});\n```\n\n##### Changed modules&#x2F;common&#x2F;index.ts\n```diff\n@@ -1,8 +1,12 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š 1â”Š 2â”Šimport { gql } from 'apollo-server-express';\n â”Š 2â”Š 3â”Šimport { GraphQLDateTime } from 'graphql-iso-date';\n+â”Š  â”Š 4â”Šimport { pool } from '../../db';\n â”Š 3â”Š 5â”Šimport { Resolvers } from '../../types/graphql';\n â”Š 4â”Š 6â”Š\n-â”Š 5â”Š  â”Šexport const typeDefs = gql`\n+â”Š  â”Š 7â”Šconst { PostgresPubSub } = require('graphql-postgres-subscriptions');\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Šconst typeDefs = gql`\n â”Š 6â”Š10â”Š  scalar Date\n â”Š 7â”Š11â”Š\n â”Š 8â”Š12â”Š  type Query {\n```\n```diff\n@@ -18,6 +22,33 @@\n â”Š18â”Š22â”Š  }\n â”Š19â”Š23â”Š`;\n â”Š20â”Š24â”Š\n-â”Š21â”Š  â”Šexport const resolvers: Resolvers = {\n+â”Š  â”Š25â”Šconst resolvers: Resolvers = {\n â”Š22â”Š26â”Š  Date: GraphQLDateTime,\n â”Š23â”Š27â”Š};\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Šconst pubsub = new PostgresPubSub({\n+â”Š  â”Š30â”Š  host: 'localhost',\n+â”Š  â”Š31â”Š  port: process.env.DB_PORT ? parseInt(process.env.DB_PORT) : 5432,\n+â”Š  â”Š32â”Š  user: 'testuser',\n+â”Š  â”Š33â”Š  password: 'testpassword',\n+â”Š  â”Š34â”Š  database: 'whatsapp',\n+â”Š  â”Š35â”Š});\n+â”Š  â”Š36â”Š\n+â”Š  â”Š37â”Šexport default new GraphQLModule({\n+â”Š  â”Š38â”Š  name: 'common',\n+â”Š  â”Š39â”Š  typeDefs,\n+â”Š  â”Š40â”Š  resolvers,\n+â”Š  â”Š41â”Š  async context({ res, connection }) {\n+â”Š  â”Š42â”Š    let db;\n+â”Š  â”Š43â”Š\n+â”Š  â”Š44â”Š    if (!connection) {\n+â”Š  â”Š45â”Š      db = await pool.connect();\n+â”Š  â”Š46â”Š    }\n+â”Š  â”Š47â”Š\n+â”Š  â”Š48â”Š    return {\n+â”Š  â”Š49â”Š      pubsub,\n+â”Š  â”Š50â”Š      res,\n+â”Š  â”Š51â”Š      db,\n+â”Š  â”Š52â”Š    };\n+â”Š  â”Š53â”Š  },\n+â”Š  â”Š54â”Š});\n```\n\n##### Changed modules&#x2F;users&#x2F;index.ts\n```diff\n@@ -1,12 +1,16 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š 1â”Š 2â”Šimport { gql } from 'apollo-server-express';\n+â”Š  â”Š 3â”Šimport cookie from 'cookie';\n â”Š 2â”Š 4â”Šimport sql from 'sql-template-strings';\n â”Š 3â”Š 5â”Šimport bcrypt from 'bcrypt';\n â”Š 4â”Š 6â”Šimport jwt from 'jsonwebtoken';\n+â”Š  â”Š 7â”Šimport commonModule from '../common';\n â”Š 5â”Š 8â”Šimport { secret, expiration } from '../../env';\n+â”Š  â”Š 9â”Šimport { pool } from '../../db';\n â”Š 6â”Š10â”Šimport { validateLength, validatePassword } from '../../validators';\n â”Š 7â”Š11â”Šimport { Resolvers } from '../../types/graphql';\n â”Š 8â”Š12â”Š\n-â”Š 9â”Š  â”Šexport const typeDefs = gql`\n+â”Š  â”Š13â”Šconst typeDefs = gql`\n â”Š10â”Š14â”Š  type User {\n â”Š11â”Š15â”Š    id: ID!\n â”Š12â”Š16â”Š    name: String!\n```\n```diff\n@@ -29,7 +33,7 @@\n â”Š29â”Š33â”Š  }\n â”Š30â”Š34â”Š`;\n â”Š31â”Š35â”Š\n-â”Š32â”Š  â”Šexport const resolvers: Resolvers = {\n+â”Š  â”Š36â”Šconst resolvers: Resolvers = {\n â”Š33â”Š37â”Š  Query: {\n â”Š34â”Š38â”Š    me(root, args, { currentUser }) {\n â”Š35â”Š39â”Š      return currentUser || null;\n```\n```diff\n@@ -98,3 +102,38 @@\n â”Š 98â”Š102â”Š    },\n â”Š 99â”Š103â”Š  },\n â”Š100â”Š104â”Š};\n+â”Š   â”Š105â”Š\n+â”Š   â”Š106â”Šexport default new GraphQLModule({\n+â”Š   â”Š107â”Š  name: 'users',\n+â”Š   â”Š108â”Š  typeDefs,\n+â”Š   â”Š109â”Š  resolvers,\n+â”Š   â”Š110â”Š  imports: () => [commonModule],\n+â”Š   â”Š111â”Š  async context(session) {\n+â”Š   â”Š112â”Š    let currentUser;\n+â”Š   â”Š113â”Š\n+â”Š   â”Š114â”Š    // Access the request object\n+â”Š   â”Š115â”Š    let req = session.connection\n+â”Š   â”Š116â”Š      ? session.connection.context.request\n+â”Š   â”Š117â”Š      : session.req;\n+â”Š   â”Š118â”Š\n+â”Š   â”Š119â”Š    // It's subscription\n+â”Š   â”Š120â”Š    if (session.connection) {\n+â”Š   â”Š121â”Š      req.cookies = cookie.parse(req.headers.cookie || '');\n+â”Š   â”Š122â”Š    }\n+â”Š   â”Š123â”Š\n+â”Š   â”Š124â”Š    if (req.cookies.authToken) {\n+â”Š   â”Š125â”Š      const username = jwt.verify(req.cookies.authToken, secret) as string;\n+â”Š   â”Š126â”Š\n+â”Š   â”Š127â”Š      if (username) {\n+â”Š   â”Š128â”Š        const { rows } = await pool.query(\n+â”Š   â”Š129â”Š          sql`SELECT * FROM users WHERE username = ${username}`\n+â”Š   â”Š130â”Š        );\n+â”Š   â”Š131â”Š        currentUser = rows[0];\n+â”Š   â”Š132â”Š      }\n+â”Š   â”Š133â”Š    }\n+â”Š   â”Š134â”Š\n+â”Š   â”Š135â”Š    return {\n+â”Š   â”Š136â”Š      currentUser,\n+â”Š   â”Š137â”Š    };\n+â”Š   â”Š138â”Š  },\n+â”Š   â”Š139â”Š});\n```\n\n[}]: #\n\n[{]: <helper> (diffStep \"13.3\" files=\"context.ts\" module=\"server\")\n\n#### [__Server__ Step 13.3: Use GraphQL Modules](https://github.com/Urigo/WhatsApp-Clone-Server/commit/b293c5945a7947d9445caebcb243f76586dc65b6)\n\n\n\n[}]: #\n\n[{]: <helper> (diffStep \"13.3\" files=\"modules/chats/index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.3: Use GraphQL Modules](https://github.com/Urigo/WhatsApp-Clone-Server/commit/b293c5945a7947d9445caebcb243f76586dc65b6)\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -1,9 +1,12 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š 1â”Š 2â”Šimport { gql, withFilter } from 'apollo-server-express';\n â”Š 2â”Š 3â”Šimport sql from 'sql-template-strings';\n+â”Š  â”Š 4â”Šimport commonModule from '../common';\n+â”Š  â”Š 5â”Šimport usersModule from '../users';\n â”Š 3â”Š 6â”Šimport { Message, Chat, pool } from '../../db';\n â”Š 4â”Š 7â”Šimport { Resolvers } from '../../types/graphql';\n â”Š 5â”Š 8â”Š\n-â”Š 6â”Š  â”Šexport const typeDefs = gql`\n+â”Š  â”Š 9â”Šconst typeDefs = gql`\n â”Š 7â”Š10â”Š  type Message {\n â”Š 8â”Š11â”Š    id: ID!\n â”Š 9â”Š12â”Š    content: String!\n```\n```diff\n@@ -41,7 +44,7 @@\n â”Š41â”Š44â”Š  }\n â”Š42â”Š45â”Š`;\n â”Š43â”Š46â”Š\n-â”Š44â”Š  â”Šexport const resolvers: Resolvers = {\n+â”Š  â”Š47â”Šconst resolvers: Resolvers = {\n â”Š45â”Š48â”Š  Message: {\n â”Š46â”Š49â”Š    createdAt(message) {\n â”Š47â”Š50â”Š      return new Date(message.created_at);\n```\n```diff\n@@ -325,3 +328,10 @@\n â”Š325â”Š328â”Š    },\n â”Š326â”Š329â”Š  },\n â”Š327â”Š330â”Š};\n+â”Š   â”Š331â”Š\n+â”Š   â”Š332â”Šexport default new GraphQLModule({\n+â”Š   â”Š333â”Š  name: 'chats',\n+â”Š   â”Š334â”Š  typeDefs,\n+â”Š   â”Š335â”Š  resolvers,\n+â”Š   â”Š336â”Š  imports: () => [commonModule, usersModule],\n+â”Š   â”Š337â”Š});\n```\n\n[}]: #\n\n#### Dependency Injection in GraphQL Modules\n\nThe major feature of GraphQL Modules is the Dependency Injection. It's optional, you don't have to use it until it's really necessary. Even though WhatsApp clone doesn't need it yet, we're going to talk about DI and implement a simple thing, just for educational purpose.\n\nIf you're familiar with Dependency Injection then you will get it straight away. If not, please read about it here or here (**links**).\n\nTo start working with DI, we we need to install two packages:\n\nyarn add @graphql-modules/di reflect-metadata\n\nLet's now adjust the context type and import `reflect-metadata` into the project:\n\n[{]: <helper> (diffStep \"13.5\" files=\"context.ts\" module=\"server\")\n\n#### [__Server__ Step 13.5: Use Dependency Injection](https://github.com/Urigo/WhatsApp-Clone-Server/commit/85a868d509c7edf2979c24b4cfe6dae7e069b047)\n\n##### Changed context.ts\n```diff\n@@ -1,13 +1,12 @@\n â”Š 1â”Š 1â”Šimport { PubSub } from 'apollo-server-express';\n+â”Š  â”Š 2â”Šimport { ModuleContext } from '@graphql-modules/core';\n â”Š 2â”Š 3â”Šimport { User } from './db';\n â”Š 3â”Š 4â”Šimport { Response } from 'express';\n â”Š 4â”Š 5â”Šimport { PoolClient } from 'pg';\n-â”Š 5â”Š  â”Šimport { UnsplashApi } from './modules/chats/unsplash.api';\n â”Š 6â”Š 6â”Š\n â”Š 7â”Š 7â”Šexport type MyContext = {\n â”Š 8â”Š 8â”Š  pubsub: PubSub;\n â”Š 9â”Š 9â”Š  currentUser: User;\n â”Š10â”Š10â”Š  res: Response;\n â”Š11â”Š11â”Š  db: PoolClient;\n-â”Š12â”Š  â”Š  unsplashApi: UnsplashApi;\n-â”Š13â”Š  â”Š};\n+â”Š  â”Š12â”Š} & ModuleContext;\n```\n\n[}]: #\n\n[{]: <helper> (diffStep \"13.5\" files=\"index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.5: Use Dependency Injection](https://github.com/Urigo/WhatsApp-Clone-Server/commit/85a868d509c7edf2979c24b4cfe6dae7e069b047)\n\n##### Changed index.ts\n```diff\n@@ -1,3 +1,4 @@\n+â”Š â”Š1â”Šimport 'reflect-metadata';\n â”Š1â”Š2â”Šimport { ApolloServer } from 'apollo-server-express';\n â”Š2â”Š3â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š3â”Š4â”Šimport http from 'http';\n```\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -11,7 +11,7 @@\n â”Š11â”Š11â”Š  type Message {\n â”Š12â”Š12â”Š    id: ID!\n â”Š13â”Š13â”Š    content: String!\n-â”Š14â”Š  â”Š    createdAt: Date!\n+â”Š  â”Š14â”Š    createdAt: DateTime!\n â”Š15â”Š15â”Š    chat: Chat\n â”Š16â”Š16â”Š    sender: User\n â”Š17â”Š17â”Š    recipient: User\n```\n```diff\n@@ -94,7 +94,7 @@\n â”Š 94â”Š 94â”Š      return participant ? participant.name : null;\n â”Š 95â”Š 95â”Š    },\n â”Š 96â”Š 96â”Š\n-â”Š 97â”Š   â”Š    async picture(chat, args, { currentUser, db, unsplashApi }) {\n+â”Š   â”Š 97â”Š    async picture(chat, args, { currentUser, db, injector }) {\n â”Š 98â”Š 98â”Š      if (!currentUser) return null;\n â”Š 99â”Š 99â”Š\n â”Š100â”Š100â”Š      const { rows } = await db.query(sql`\n```\n```diff\n@@ -107,7 +107,7 @@\n â”Š107â”Š107â”Š\n â”Š108â”Š108â”Š      return participant && participant.picture\n â”Š109â”Š109â”Š        ? participant.picture\n-â”Š110â”Š   â”Š        : unsplashApi.getRandomPhoto();\n+â”Š   â”Š110â”Š        : injector.get(UnsplashApi).getRandomPhoto();\n â”Š111â”Š111â”Š    },\n â”Š112â”Š112â”Š\n â”Š113â”Š113â”Š    async messages(chat, args, { db }) {\n```\n```diff\n@@ -335,9 +335,5 @@\n â”Š335â”Š335â”Š  typeDefs,\n â”Š336â”Š336â”Š  resolvers,\n â”Š337â”Š337â”Š  imports: () => [commonModule, usersModule],\n-â”Š338â”Š   â”Š  context() {\n-â”Š339â”Š   â”Š    return {\n-â”Š340â”Š   â”Š      unsplashApi: new UnsplashApi(),\n-â”Š341â”Š   â”Š    };\n-â”Š342â”Š   â”Š  },\n+â”Š   â”Š338â”Š  providers: () => [UnsplashApi],\n â”Š343â”Š339â”Š});\n```\n\n##### Changed modules&#x2F;common&#x2F;index.ts\n```diff\n@@ -7,7 +7,7 @@\n â”Š 7â”Š 7â”Šconst { PostgresPubSub } = require('graphql-postgres-subscriptions');\n â”Š 8â”Š 8â”Š\n â”Š 9â”Š 9â”Šconst typeDefs = gql`\n-â”Š10â”Š  â”Š  scalar Date\n+â”Š  â”Š10â”Š  scalar DateTime\n â”Š11â”Š11â”Š\n â”Š12â”Š12â”Š  type Query {\n â”Š13â”Š13â”Š    _dummy: Boolean\n```\n```diff\n@@ -23,7 +23,7 @@\n â”Š23â”Š23â”Š`;\n â”Š24â”Š24â”Š\n â”Š25â”Š25â”Šconst resolvers: Resolvers = {\n-â”Š26â”Š  â”Š  Date: GraphQLDateTime,\n+â”Š  â”Š26â”Š  DateTime: GraphQLDateTime,\n â”Š27â”Š27â”Š};\n â”Š28â”Š28â”Š\n â”Š29â”Š29â”Šconst pubsub = new PostgresPubSub({\n```\n\n[}]: #\n\nIn short, Iependency Injection will instantiate classes, manage dependencies between them and so on and in addition to that, the GraphQL Modules allows to define when each provider / class should be created. We call it scopes.\n\n- Application scope - provider is created when application starts (default)\n- Session - providers are constructed in the beginning of the network request, then kept until the network request is closed\n- Request - creates an instance each time you request it from the injector\n\nBecause our `UnsplashApi` doesn't have to be recreated on every request, we can easily use Application scope, which is the default. The `Injectable` decorator is just to attach some metadata to the class.\n\n[{]: <helper> (diffStep \"13.5\" files=\"modules/chats/unsplash.api.ts\" module=\"server\")\n\n#### [__Server__ Step 13.5: Use Dependency Injection](https://github.com/Urigo/WhatsApp-Clone-Server/commit/85a868d509c7edf2979c24b4cfe6dae7e069b047)\n\n##### Changed modules&#x2F;chats&#x2F;unsplash.api.ts\n```diff\n@@ -1,3 +1,4 @@\n+â”Š â”Š1â”Šimport { Injectable, ProviderScope } from '@graphql-modules/di';\n â”Š1â”Š2â”Šimport { resolve } from 'path';\n â”Š2â”Š3â”Šimport axios from 'axios';\n â”Š3â”Š4â”Šimport { trackProvider } from '@safe-api/middleware';\n```\n```diff\n@@ -8,6 +9,9 @@\n â”Š 8â”Š 9â”Š  orientation: 'landscape' | 'portrait' | 'squarish';\n â”Š 9â”Š10â”Š}\n â”Š10â”Š11â”Š\n+â”Š  â”Š12â”Š@Injectable({\n+â”Š  â”Š13â”Š  scope: ProviderScope.Application,\n+â”Š  â”Š14â”Š})\n â”Š11â”Š15â”Šexport class UnsplashApi {\n â”Š12â”Š16â”Š  baseURL = 'https://api.unsplash.com/';\n â”Š13â”Š17â”Š\n```\n\n[}]: #\n\nHere's how to register the UnsplashApi provider in Chats module:\n\n[{]: <helper> (diffStep \"13.5\" files=\"modules/chats/index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.5: Use Dependency Injection](https://github.com/Urigo/WhatsApp-Clone-Server/commit/85a868d509c7edf2979c24b4cfe6dae7e069b047)\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -11,7 +11,7 @@\n â”Š11â”Š11â”Š  type Message {\n â”Š12â”Š12â”Š    id: ID!\n â”Š13â”Š13â”Š    content: String!\n-â”Š14â”Š  â”Š    createdAt: Date!\n+â”Š  â”Š14â”Š    createdAt: DateTime!\n â”Š15â”Š15â”Š    chat: Chat\n â”Š16â”Š16â”Š    sender: User\n â”Š17â”Š17â”Š    recipient: User\n```\n```diff\n@@ -94,7 +94,7 @@\n â”Š 94â”Š 94â”Š      return participant ? participant.name : null;\n â”Š 95â”Š 95â”Š    },\n â”Š 96â”Š 96â”Š\n-â”Š 97â”Š   â”Š    async picture(chat, args, { currentUser, db, unsplashApi }) {\n+â”Š   â”Š 97â”Š    async picture(chat, args, { currentUser, db, injector }) {\n â”Š 98â”Š 98â”Š      if (!currentUser) return null;\n â”Š 99â”Š 99â”Š\n â”Š100â”Š100â”Š      const { rows } = await db.query(sql`\n```\n```diff\n@@ -107,7 +107,7 @@\n â”Š107â”Š107â”Š\n â”Š108â”Š108â”Š      return participant && participant.picture\n â”Š109â”Š109â”Š        ? participant.picture\n-â”Š110â”Š   â”Š        : unsplashApi.getRandomPhoto();\n+â”Š   â”Š110â”Š        : injector.get(UnsplashApi).getRandomPhoto();\n â”Š111â”Š111â”Š    },\n â”Š112â”Š112â”Š\n â”Š113â”Š113â”Š    async messages(chat, args, { db }) {\n```\n```diff\n@@ -335,9 +335,5 @@\n â”Š335â”Š335â”Š  typeDefs,\n â”Š336â”Š336â”Š  resolvers,\n â”Š337â”Š337â”Š  imports: () => [commonModule, usersModule],\n-â”Š338â”Š   â”Š  context() {\n-â”Š339â”Š   â”Š    return {\n-â”Š340â”Š   â”Š      unsplashApi: new UnsplashApi(),\n-â”Š341â”Š   â”Š    };\n-â”Š342â”Š   â”Š  },\n+â”Š   â”Š338â”Š  providers: () => [UnsplashApi],\n â”Š343â”Š339â”Š});\n```\n\n[}]: #\n\nPlease also take a look at `injector.get(UnsplashApi)` part. There's `injector` instance in every module's context that allows to consume providers and everything that is defined within DI. You simply pass a class / token to the `get` method and GraphQL Modules takes care of the rest.\n\n**What are the benefits of DI?**\n\nYou can have a different implementation of Users based on the same interface. Maybe right now you're using PostgreSQL but at some point a project will be migrated to MongoDB. You could do it through GraphQL context, of course but with Dependency Injection, GraphQL Modules is able to tell you exactly what's missing and where. It reduces boiler plate because instantiation is done by the injector, code is loosely coupled.\n\nHelps maintainability but also comes with few disadvantages. It's a bit complex concept to learn and what could be done on compile time (TypeScript) is moved to run-time.\n\nYou might find DI useful while testing. Let's say you want to test a query that involves `UnsplashApi` provider, you simply replace it with a mocked version without touching the context or internals and you get the expected result every single time.\n\nWe know there's only one provider by far, the `UnsplashApi`, but we're going to implement more and more in following steps.\n\n#### Continuing with DI\n\nWe want to have everything easily accesible and DI helps with that so let's move on and continue migrating things.\n\nOne of the shared objects is database connection and we're going to create a Database provider:\n\n[{]: <helper> (diffStep \"13.6\" files=\"modules/common/database.provider.ts\" module=\"server\")\n\n#### [__Server__ Step 13.6: Define Database provider](https://github.com/Urigo/WhatsApp-Clone-Server/commit/1b23403bfd6513916163dd6166f16c03708d7152)\n\n##### Added modules&#x2F;common&#x2F;database.provider.ts\n```diff\n@@ -0,0 +1,26 @@\n+â”Š  â”Š 1â”Šimport { Injectable, ProviderScope } from '@graphql-modules/di';\n+â”Š  â”Š 2â”Šimport { OnResponse } from '@graphql-modules/core';\n+â”Š  â”Š 3â”Šimport { Pool, PoolClient } from 'pg';\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Š@Injectable({\n+â”Š  â”Š 6â”Š  scope: ProviderScope.Session,\n+â”Š  â”Š 7â”Š})\n+â”Š  â”Š 8â”Šexport class Database implements OnResponse {\n+â”Š  â”Š 9â”Š  private instance: PoolClient;\n+â”Š  â”Š10â”Š\n+â”Š  â”Š11â”Š  constructor(private pool: Pool) {}\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Š  async onRequest() {\n+â”Š  â”Š14â”Š    this.instance = await this.pool.connect();\n+â”Š  â”Š15â”Š  }\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š  onResponse() {\n+â”Š  â”Š18â”Š    if (this.instance) {\n+â”Š  â”Š19â”Š      this.instance.release();\n+â”Š  â”Š20â”Š    }\n+â”Š  â”Š21â”Š  }\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Š  async getClient() {\n+â”Š  â”Š24â”Š    return this.instance;\n+â”Š  â”Š25â”Š  }\n+â”Š  â”Š26â”Š}\n```\n\n[}]: #\n\nThings we did there:\n- Session scope was used, which makes sure our provider is created and destroyed on every GraphQL Operation\n- `onRequest` hook is called when a GraphQL Operation starts and we create a database connection in it.\n- `onResponse` hook is triggered when GraphQL Response is about to be sent to the consumer, so we destroy the connection there.\n- `getClient` method exposes the connection\n- `Pool` in constructor means we expect `Pool` to be injected into `Database` provider.\n\nNow we can define `Pool` token and register `Database`:\n\n[{]: <helper> (diffStep \"13.6\" files=\"modules/common/index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.6: Define Database provider](https://github.com/Urigo/WhatsApp-Clone-Server/commit/1b23403bfd6513916163dd6166f16c03708d7152)\n\n##### Changed modules&#x2F;common&#x2F;index.ts\n```diff\n@@ -1,8 +1,10 @@\n â”Š 1â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š 2â”Š 2â”Šimport { gql } from 'apollo-server-express';\n â”Š 3â”Š 3â”Šimport { GraphQLDateTime } from 'graphql-iso-date';\n+â”Š  â”Š 4â”Šimport { Pool } from 'pg';\n â”Š 4â”Š 5â”Šimport { pool } from '../../db';\n â”Š 5â”Š 6â”Šimport { Resolvers } from '../../types/graphql';\n+â”Š  â”Š 7â”Šimport { Database } from './database.provider';\n â”Š 6â”Š 8â”Š\n â”Š 7â”Š 9â”Šconst { PostgresPubSub } = require('graphql-postgres-subscriptions');\n â”Š 8â”Š10â”Š\n```\n```diff\n@@ -38,6 +40,13 @@\n â”Š38â”Š40â”Š  name: 'common',\n â”Š39â”Š41â”Š  typeDefs,\n â”Š40â”Š42â”Š  resolvers,\n+â”Š  â”Š43â”Š  providers: () => [\n+â”Š  â”Š44â”Š    {\n+â”Š  â”Š45â”Š      provide: Pool,\n+â”Š  â”Š46â”Š      useValue: pool,\n+â”Š  â”Š47â”Š    },\n+â”Š  â”Š48â”Š    Database,\n+â”Š  â”Š49â”Š  ],\n â”Š41â”Š50â”Š  async context({ res, connection }) {\n â”Š42â”Š51â”Š    let db;\n```\n\n[}]: #\n\n[{]: <helper> (diffStep \"13.6\" files=\"modules/index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.6: Define Database provider](https://github.com/Urigo/WhatsApp-Clone-Server/commit/1b23403bfd6513916163dd6166f16c03708d7152)\n\n\n\n[}]: #\n\n#### Creating Users and Chats services\n\nIt's not really recommended to put logic in resolvers so we're going to create a layer with business logic. A good example of that are Users and Chats modules so let's start with the former.\n\nWe're going to create `Users` service and move `Query.users` logic into `findAllExcept` method:\n\n[{]: <helper> (diffStep \"13.7\" files=\"modules/users/users.provider.ts,modules/users/index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.7: Basic User provider](https://github.com/Urigo/WhatsApp-Clone-Server/commit/df12be9758506bba67114bfc2f303b10c34b2388)\n\n##### Changed modules&#x2F;users&#x2F;index.ts\n```diff\n@@ -9,6 +9,7 @@\n â”Š 9â”Š 9â”Šimport { pool } from '../../db';\n â”Š10â”Š10â”Šimport { validateLength, validatePassword } from '../../validators';\n â”Š11â”Š11â”Šimport { Resolvers } from '../../types/graphql';\n+â”Š  â”Š12â”Šimport { Users } from './users.provider';\n â”Š12â”Š13â”Š\n â”Š13â”Š14â”Šconst typeDefs = gql`\n â”Š14â”Š15â”Š  type User {\n```\n```diff\n@@ -38,14 +39,10 @@\n â”Š38â”Š39â”Š    me(root, args, { currentUser }) {\n â”Š39â”Š40â”Š      return currentUser || null;\n â”Š40â”Š41â”Š    },\n-â”Š41â”Š  â”Š    async users(root, args, { currentUser, db }) {\n+â”Š  â”Š42â”Š    async users(root, args, { currentUser, injector }) {\n â”Š42â”Š43â”Š      if (!currentUser) return [];\n â”Š43â”Š44â”Š\n-â”Š44â”Š  â”Š      const { rows } = await db.query(sql`\n-â”Š45â”Š  â”Š        SELECT * FROM users WHERE users.id != ${currentUser.id}\n-â”Š46â”Š  â”Š      `);\n-â”Š47â”Š  â”Š\n-â”Š48â”Š  â”Š      return rows;\n+â”Š  â”Š45â”Š      return injector.get(Users).findAllExcept(currentUser.id);\n â”Š49â”Š46â”Š    },\n â”Š50â”Š47â”Š  },\n â”Š51â”Š48â”Š  Mutation: {\n```\n```diff\n@@ -108,6 +105,7 @@\n â”Š108â”Š105â”Š  typeDefs,\n â”Š109â”Š106â”Š  resolvers,\n â”Š110â”Š107â”Š  imports: () => [commonModule],\n+â”Š   â”Š108â”Š  providers: () => [Users],\n â”Š111â”Š109â”Š  async context(session) {\n â”Š112â”Š110â”Š    let currentUser;\n â”Š113â”Š111â”Š\n```\n\n##### Added modules&#x2F;users&#x2F;users.provider.ts\n```diff\n@@ -0,0 +1,19 @@\n+â”Š  â”Š 1â”Šimport { Injectable, Inject, ProviderScope } from '@graphql-modules/di';\n+â”Š  â”Š 2â”Šimport sql from 'sql-template-strings';\n+â”Š  â”Š 3â”Šimport { Database } from '../common/database.provider';\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Š@Injectable({\n+â”Š  â”Š 6â”Š  scope: ProviderScope.Session,\n+â”Š  â”Š 7â”Š})\n+â”Š  â”Š 8â”Šexport class Users {\n+â”Š  â”Š 9â”Š  @Inject() private db: Database;\n+â”Š  â”Š10â”Š\n+â”Š  â”Š11â”Š  async findAllExcept(userId: string) {\n+â”Š  â”Š12â”Š    const db = await this.db.getClient();\n+â”Š  â”Š13â”Š    const { rows } = await db.query(\n+â”Š  â”Š14â”Š      sql`SELECT * FROM users WHERE id != ${userId}`\n+â”Š  â”Š15â”Š    );\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š    return rows;\n+â”Š  â”Š18â”Š  }\n+â”Š  â”Š19â”Š}\n```\n\n[}]: #\n\nA very interesting thing to notice is `@Inject()` decorator.\n\n```ts\n@Inject() private db: Database;\n```\n\nThe @Inject, well... injects `Database` provider as `db` property so you don't have to use the `constructor`.\n\nBack to the Users service. It's very similar to what we did with the `UnsplashApi` so let's move on and implement more methods.\n\n[{]: <helper> (diffStep \"13.8\" module=\"server\")\n\n#### [__Server__ Step 13.8: Implement newUser and findByUsername](https://github.com/Urigo/WhatsApp-Clone-Server/commit/b2d62bdc29323675ed5b432585bef1231b8c17ce)\n\n##### Changed modules&#x2F;users&#x2F;index.ts\n```diff\n@@ -46,11 +46,8 @@\n â”Š46â”Š46â”Š    },\n â”Š47â”Š47â”Š  },\n â”Š48â”Š48â”Š  Mutation: {\n-â”Š49â”Š  â”Š    async signIn(root, { username, password }, { db, res }) {\n-â”Š50â”Š  â”Š      const { rows } = await db.query(\n-â”Š51â”Š  â”Š        sql`SELECT * FROM users WHERE username = ${username}`\n-â”Š52â”Š  â”Š      );\n-â”Š53â”Š  â”Š      const user = rows[0];\n+â”Š  â”Š49â”Š    async signIn(root, { username, password }, { injector, res }) {\n+â”Š  â”Š50â”Š      const user = await injector.get(Users).findByUsername(username);\n â”Š54â”Š51â”Š\n â”Š55â”Š52â”Š      if (!user) {\n â”Š56â”Š53â”Š        throw new Error('user not found');\n```\n```diff\n@@ -69,7 +66,11 @@\n â”Š69â”Š66â”Š      return user;\n â”Š70â”Š67â”Š    },\n â”Š71â”Š68â”Š\n-â”Š72â”Š  â”Š    async signUp(root, { name, username, password, passwordConfirm }, { db }) {\n+â”Š  â”Š69â”Š    async signUp(\n+â”Š  â”Š70â”Š      root,\n+â”Š  â”Š71â”Š      { name, username, password, passwordConfirm },\n+â”Š  â”Š72â”Š      { injector }\n+â”Š  â”Š73â”Š    ) {\n â”Š73â”Š74â”Š      validateLength('req.name', name, 3, 50);\n â”Š74â”Š75â”Š      validateLength('req.username', username, 3, 18);\n â”Š75â”Š76â”Š      validatePassword('req.password', password);\n```\n```diff\n@@ -78,24 +79,18 @@\n â”Š 78â”Š 79â”Š        throw Error(\"req.password and req.passwordConfirm don't match\");\n â”Š 79â”Š 80â”Š      }\n â”Š 80â”Š 81â”Š\n-â”Š 81â”Š   â”Š      const existingUserQuery = await db.query(\n-â”Š 82â”Š   â”Š        sql`SELECT * FROM users WHERE username = ${username}`\n-â”Š 83â”Š   â”Š      );\n-â”Š 84â”Š   â”Š      if (existingUserQuery.rows[0]) {\n+â”Š   â”Š 82â”Š      const existingUser = await injector.get(Users).findByUsername(username);\n+â”Š   â”Š 83â”Š      if (existingUser) {\n â”Š 85â”Š 84â”Š        throw Error('username already exists');\n â”Š 86â”Š 85â”Š      }\n â”Š 87â”Š 86â”Š\n-â”Š 88â”Š   â”Š      const passwordHash = bcrypt.hashSync(password, bcrypt.genSaltSync(8));\n+â”Š   â”Š 87â”Š      const createdUser = await injector.get(Users).newUser({\n+â”Š   â”Š 88â”Š        username,\n+â”Š   â”Š 89â”Š        password,\n+â”Š   â”Š 90â”Š        name,\n+â”Š   â”Š 91â”Š      });\n â”Š 89â”Š 92â”Š\n-â”Š 90â”Š   â”Š      const createdUserQuery = await db.query(sql`\n-â”Š 91â”Š   â”Š        INSERT INTO users(password, picture, username, name)\n-â”Š 92â”Š   â”Š        VALUES(${passwordHash}, '', ${username}, ${name})\n-â”Š 93â”Š   â”Š        RETURNING *\n-â”Š 94â”Š   â”Š      `);\n-â”Š 95â”Š   â”Š\n-â”Š 96â”Š   â”Š      const user = createdUserQuery.rows[0];\n-â”Š 97â”Š   â”Š\n-â”Š 98â”Š   â”Š      return user;\n+â”Š   â”Š 93â”Š      return createdUser;\n â”Š 99â”Š 94â”Š    },\n â”Š100â”Š 95â”Š  },\n â”Š101â”Š 96â”Š};\n```\n\n##### Changed modules&#x2F;users&#x2F;users.provider.ts\n```diff\n@@ -1,7 +1,10 @@\n â”Š 1â”Š 1â”Šimport { Injectable, Inject, ProviderScope } from '@graphql-modules/di';\n â”Š 2â”Š 2â”Šimport sql from 'sql-template-strings';\n+â”Š  â”Š 3â”Šimport bcrypt from 'bcrypt';\n â”Š 3â”Š 4â”Šimport { Database } from '../common/database.provider';\n â”Š 4â”Š 5â”Š\n+â”Š  â”Š 6â”Šconst DEFAULT_PROFILE_PIC = 'https://raw.githubusercontent.com/Urigo/WhatsApp-Clone-Client-React/legacy/public/assets/default-profile-pic.jpg'\n+â”Š  â”Š 7â”Š\n â”Š 5â”Š 8â”Š@Injectable({\n â”Š 6â”Š 9â”Š  scope: ProviderScope.Session,\n â”Š 7â”Š10â”Š})\n```\n```diff\n@@ -16,4 +19,34 @@\n â”Š16â”Š19â”Š\n â”Š17â”Š20â”Š    return rows;\n â”Š18â”Š21â”Š  }\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Š  async findByUsername(username: string) {\n+â”Š  â”Š24â”Š    const db = await this.db.getClient();\n+â”Š  â”Š25â”Š    const { rows } = await db.query(\n+â”Š  â”Š26â”Š      sql`SELECT * FROM users WHERE username = ${username}`\n+â”Š  â”Š27â”Š    );\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š    return rows[0] || null;\n+â”Š  â”Š30â”Š  }\n+â”Š  â”Š31â”Š\n+â”Š  â”Š32â”Š  async newUser({\n+â”Š  â”Š33â”Š    username,\n+â”Š  â”Š34â”Š    name,\n+â”Š  â”Š35â”Š    password,\n+â”Š  â”Š36â”Š  }: {\n+â”Š  â”Š37â”Š    username: string;\n+â”Š  â”Š38â”Š    name: string;\n+â”Š  â”Š39â”Š    password: string;\n+â”Š  â”Š40â”Š  }) {\n+â”Š  â”Š41â”Š    const db = await this.db.getClient();\n+â”Š  â”Š42â”Š    const passwordHash = bcrypt.hashSync(password, bcrypt.genSaltSync(8));\n+â”Š  â”Š43â”Š    const createdUserQuery = await db.query(sql`\n+â”Š  â”Š44â”Š        INSERT INTO users(password, picture, username, name)\n+â”Š  â”Š45â”Š        VALUES(${passwordHash}, ${DEFAULT_PROFILE_PIC}, ${username}, ${name})\n+â”Š  â”Š46â”Š        RETURNING *\n+â”Š  â”Š47â”Š      `);\n+â”Š  â”Š48â”Š    const user = createdUserQuery.rows[0];\n+â”Š  â”Š49â”Š\n+â”Š  â”Š50â”Š    return user;\n+â”Š  â”Š51â”Š  }\n â”Š19â”Š52â”Š}\n```\n\n[}]: #\n[{]: <helper> (diffStep \"13.9\" module=\"server\")\n\n#### [__Server__ Step 13.9: Implement findById and use in Chats module](https://github.com/Urigo/WhatsApp-Clone-Server/commit/e3f092bf47b36d50dc76809b225a3874681c7f21)\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -6,6 +6,7 @@\n â”Š 6â”Š 6â”Šimport { Message, Chat, pool } from '../../db';\n â”Š 7â”Š 7â”Šimport { Resolvers } from '../../types/graphql';\n â”Š 8â”Š 8â”Šimport { UnsplashApi } from './unsplash.api';\n+â”Š  â”Š 9â”Šimport { Users } from './../users/users.provider';\n â”Š 9â”Š10â”Š\n â”Š10â”Š11â”Šconst typeDefs = gql`\n â”Š11â”Š12â”Š  type Message {\n```\n```diff\n@@ -58,11 +59,8 @@\n â”Š58â”Š59â”Š      return rows[0] || null;\n â”Š59â”Š60â”Š    },\n â”Š60â”Š61â”Š\n-â”Š61â”Š  â”Š    async sender(message, args, { db }) {\n-â”Š62â”Š  â”Š      const { rows } = await db.query(sql`\n-â”Š63â”Š  â”Š        SELECT * FROM users WHERE id = ${message.sender_user_id}\n-â”Š64â”Š  â”Š      `);\n-â”Š65â”Š  â”Š      return rows[0] || null;\n+â”Š  â”Š62â”Š    async sender(message, args, { injector }) {\n+â”Š  â”Š63â”Š      return injector.get(Users).findById(message.sender_user_id);\n â”Š66â”Š64â”Š    },\n â”Š67â”Š65â”Š\n â”Š68â”Š66â”Š    async recipient(message, args, { db }) {\n```\n\n##### Changed modules&#x2F;users&#x2F;users.provider.ts\n```diff\n@@ -11,6 +11,15 @@\n â”Š11â”Š11â”Šexport class Users {\n â”Š12â”Š12â”Š  @Inject() private db: Database;\n â”Š13â”Š13â”Š\n+â”Š  â”Š14â”Š  async findById(userId: string) {\n+â”Š  â”Š15â”Š    const db = await this.db.getClient();\n+â”Š  â”Š16â”Š    const { rows } = await db.query(\n+â”Š  â”Š17â”Š      sql`SELECT * FROM users WHERE id = ${userId}`\n+â”Š  â”Š18â”Š    );\n+â”Š  â”Š19â”Š\n+â”Š  â”Š20â”Š    return rows[0] || null;\n+â”Š  â”Š21â”Š  }\n+â”Š  â”Š22â”Š\n â”Š14â”Š23â”Š  async findAllExcept(userId: string) {\n â”Š15â”Š24â”Š    const db = await this.db.getClient();\n â”Š16â”Š25â”Š    const { rows } = await db.query(\n```\n\n[}]: #\n\nLet's now implement `Chats` service with two basic methods:\n\n[{]: <helper> (diffStep \"13.10\" module=\"server\")\n\n#### [__Server__ Step 13.10: Basic Chats provider](https://github.com/Urigo/WhatsApp-Clone-Server/commit/b9cdcc417c30a83cfc869cfb64d74d348414b33a)\n\n##### Added modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -0,0 +1,34 @@\n+â”Š  â”Š 1â”Šimport { Injectable, Inject, ProviderScope } from '@graphql-modules/di';\n+â”Š  â”Š 2â”Šimport sql from 'sql-template-strings';\n+â”Š  â”Š 3â”Šimport { Database } from '../common/database.provider';\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Š@Injectable({\n+â”Š  â”Š 6â”Š  scope: ProviderScope.Session,\n+â”Š  â”Š 7â”Š})\n+â”Š  â”Š 8â”Šexport class Chats {\n+â”Š  â”Š 9â”Š  @Inject() private db: Database;\n+â”Š  â”Š10â”Š\n+â”Š  â”Š11â”Š  async findChatsByUser(userId: string) {\n+â”Š  â”Š12â”Š    const db = await this.db.getClient();\n+â”Š  â”Š13â”Š\n+â”Š  â”Š14â”Š    const { rows } = await db.query(sql`\n+â”Š  â”Š15â”Š      SELECT chats.* FROM chats, chats_users\n+â”Š  â”Š16â”Š      WHERE chats.id = chats_users.chat_id\n+â”Š  â”Š17â”Š      AND chats_users.user_id = ${userId}\n+â”Š  â”Š18â”Š    `);\n+â”Š  â”Š19â”Š\n+â”Š  â”Š20â”Š    return rows;\n+â”Š  â”Š21â”Š  }\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Š  async findChatByUser({ chatId, userId }: { chatId: string; userId: string }) {\n+â”Š  â”Š24â”Š    const db = await this.db.getClient();\n+â”Š  â”Š25â”Š    const { rows } = await db.query(sql`\n+â”Š  â”Š26â”Š      SELECT chats.* FROM chats, chats_users\n+â”Š  â”Š27â”Š      WHERE chats_users.chat_id = ${chatId}\n+â”Š  â”Š28â”Š      AND chats.id = chats_users.chat_id\n+â”Š  â”Š29â”Š      AND chats_users.user_id = ${userId}\n+â”Š  â”Š30â”Š    `);\n+â”Š  â”Š31â”Š\n+â”Š  â”Š32â”Š    return rows[0] || null;\n+â”Š  â”Š33â”Š  }\n+â”Š  â”Š34â”Š}\n```\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -7,6 +7,7 @@\n â”Š 7â”Š 7â”Šimport { Resolvers } from '../../types/graphql';\n â”Š 8â”Š 8â”Šimport { UnsplashApi } from './unsplash.api';\n â”Š 9â”Š 9â”Šimport { Users } from './../users/users.provider';\n+â”Š  â”Š10â”Šimport { Chats } from './chats.provider';\n â”Š10â”Š11â”Š\n â”Š11â”Š12â”Šconst typeDefs = gql`\n â”Š12â”Š13â”Š  type Message {\n```\n```diff\n@@ -138,29 +139,18 @@\n â”Š138â”Š139â”Š  },\n â”Š139â”Š140â”Š\n â”Š140â”Š141â”Š  Query: {\n-â”Š141â”Š   â”Š    async chats(root, args, { currentUser, db }) {\n+â”Š   â”Š142â”Š    async chats(root, args, { currentUser, injector }) {\n â”Š142â”Š143â”Š      if (!currentUser) return [];\n â”Š143â”Š144â”Š\n-â”Š144â”Š   â”Š      const { rows } = await db.query(sql`\n-â”Š145â”Š   â”Š        SELECT chats.* FROM chats, chats_users\n-â”Š146â”Š   â”Š        WHERE chats.id = chats_users.chat_id\n-â”Š147â”Š   â”Š        AND chats_users.user_id = ${currentUser.id}\n-â”Š148â”Š   â”Š      `);\n-â”Š149â”Š   â”Š\n-â”Š150â”Š   â”Š      return rows;\n+â”Š   â”Š145â”Š      return injector.get(Chats).findChatsByUser(currentUser.id);\n â”Š151â”Š146â”Š    },\n â”Š152â”Š147â”Š\n-â”Š153â”Š   â”Š    async chat(root, { chatId }, { currentUser, db }) {\n+â”Š   â”Š148â”Š    async chat(root, { chatId }, { currentUser, injector }) {\n â”Š154â”Š149â”Š      if (!currentUser) return null;\n â”Š155â”Š150â”Š\n-â”Š156â”Š   â”Š      const { rows } = await db.query(sql`\n-â”Š157â”Š   â”Š        SELECT chats.* FROM chats, chats_users\n-â”Š158â”Š   â”Š        WHERE chats_users.chat_id = ${chatId}\n-â”Š159â”Š   â”Š        AND chats.id = chats_users.chat_id\n-â”Š160â”Š   â”Š        AND chats_users.user_id = ${currentUser.id}\n-â”Š161â”Š   â”Š      `);\n-â”Š162â”Š   â”Š\n-â”Š163â”Š   â”Š      return rows[0] ? rows[0] : null;\n+â”Š   â”Š151â”Š      return injector\n+â”Š   â”Š152â”Š        .get(Chats)\n+â”Š   â”Š153â”Š        .findChatByUser({ chatId, userId: currentUser.id });\n â”Š164â”Š154â”Š    },\n â”Š165â”Š155â”Š  },\n â”Š166â”Š156â”Š\n```\n```diff\n@@ -333,5 +323,5 @@\n â”Š333â”Š323â”Š  typeDefs,\n â”Š334â”Š324â”Š  resolvers,\n â”Š335â”Š325â”Š  imports: () => [commonModule, usersModule],\n-â”Š336â”Š   â”Š  providers: () => [UnsplashApi],\n+â”Š   â”Š326â”Š  providers: () => [UnsplashApi, Chats],\n â”Š337â”Š327â”Š});\n```\n\n[}]: #\n\nIt looks exatly like `Users` and also has only `database` provider in it.\n\nWe're going to move on and more things:\n\n[{]: <helper> (diffStep \"13.11\" module=\"server\")\n\n#### [__Server__ Step 13.11: Implement findChatById](https://github.com/Urigo/WhatsApp-Clone-Server/commit/9628bcdb5cb8b839bcdbf744b056aab1f637975b)\n\n##### Changed modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -31,4 +31,12 @@\n â”Š31â”Š31â”Š\n â”Š32â”Š32â”Š    return rows[0] || null;\n â”Š33â”Š33â”Š  }\n+â”Š  â”Š34â”Š\n+â”Š  â”Š35â”Š  async findChatById(chatId: string) {\n+â”Š  â”Š36â”Š    const db = await this.db.getClient();\n+â”Š  â”Š37â”Š    const { rows } = await db.query(sql`\n+â”Š  â”Š38â”Š      SELECT * FROM chats WHERE id = ${chatId}\n+â”Š  â”Š39â”Š    `);\n+â”Š  â”Š40â”Š    return rows[0] || null;\n+â”Š  â”Š41â”Š  }\n â”Š34â”Š42â”Š}\n```\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -53,11 +53,8 @@\n â”Š53â”Š53â”Š      return new Date(message.created_at);\n â”Š54â”Š54â”Š    },\n â”Š55â”Š55â”Š\n-â”Š56â”Š  â”Š    async chat(message, args, { db }) {\n-â”Š57â”Š  â”Š      const { rows } = await db.query(sql`\n-â”Š58â”Š  â”Š        SELECT * FROM chats WHERE id = ${message.chat_id}\n-â”Š59â”Š  â”Š      `);\n-â”Š60â”Š  â”Š      return rows[0] || null;\n+â”Š  â”Š56â”Š    async chat(message, args, { injector }) {\n+â”Š  â”Š57â”Š      return injector.get(Chats).findChatById(message.chat_id);\n â”Š61â”Š58â”Š    },\n â”Š62â”Š59â”Š\n â”Š63â”Š60â”Š    async sender(message, args, { injector }) {\n```\n\n[}]: #\n[{]: <helper> (diffStep \"13.12\" module=\"server\")\n\n#### [__Server__ Step 13.12: Find chat&#x27;s messages](https://github.com/Urigo/WhatsApp-Clone-Server/commit/51bc73fbe92622d9468b275985863e93995c1213)\n\n##### Changed modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -39,4 +39,25 @@\n â”Š39â”Š39â”Š    `);\n â”Š40â”Š40â”Š    return rows[0] || null;\n â”Š41â”Š41â”Š  }\n+â”Š  â”Š42â”Š\n+â”Š  â”Š43â”Š  async findMessagesByChat(chatId: string) {\n+â”Š  â”Š44â”Š    const db = await this.db.getClient();\n+â”Š  â”Š45â”Š    const { rows } = await db.query(\n+â”Š  â”Š46â”Š      sql`SELECT * FROM messages WHERE chat_id = ${chatId}`\n+â”Š  â”Š47â”Š    );\n+â”Š  â”Š48â”Š\n+â”Š  â”Š49â”Š    return rows;\n+â”Š  â”Š50â”Š  }\n+â”Š  â”Š51â”Š\n+â”Š  â”Š52â”Š  async lastMessage(chatId: string) {\n+â”Š  â”Š53â”Š    const db = await this.db.getClient();\n+â”Š  â”Š54â”Š    const { rows } = await db.query(sql`\n+â”Š  â”Š55â”Š      SELECT * FROM messages\n+â”Š  â”Š56â”Š      WHERE chat_id = ${chatId}\n+â”Š  â”Š57â”Š      ORDER BY created_at DESC\n+â”Š  â”Š58â”Š      LIMIT 1\n+â”Š  â”Š59â”Š    `);\n+â”Š  â”Š60â”Š\n+â”Š  â”Š61â”Š    return rows[0];\n+â”Š  â”Š62â”Š  }\n â”Š42â”Š63â”Š}\n```\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -106,22 +106,12 @@\n â”Š106â”Š106â”Š        : injector.get(UnsplashApi).getRandomPhoto();\n â”Š107â”Š107â”Š    },\n â”Š108â”Š108â”Š\n-â”Š109â”Š   â”Š    async messages(chat, args, { db }) {\n-â”Š110â”Š   â”Š      const { rows } = await db.query(\n-â”Š111â”Š   â”Š        sql`SELECT * FROM messages WHERE chat_id = ${chat.id}`\n-â”Š112â”Š   â”Š      );\n-â”Š113â”Š   â”Š\n-â”Š114â”Š   â”Š      return rows;\n+â”Š   â”Š109â”Š    async messages(chat, args, { injector }) {\n+â”Š   â”Š110â”Š      return injector.get(Chats).findMessagesByChat(chat.id);\n â”Š115â”Š111â”Š    },\n â”Š116â”Š112â”Š\n-â”Š117â”Š   â”Š    async lastMessage(chat, args, { db }) {\n-â”Š118â”Š   â”Š      const { rows } = await db.query(sql`\n-â”Š119â”Š   â”Š        SELECT * FROM messages\n-â”Š120â”Š   â”Š        WHERE chat_id = ${chat.id}\n-â”Š121â”Š   â”Š        ORDER BY created_at DESC\n-â”Š122â”Š   â”Š        LIMIT 1`);\n-â”Š123â”Š   â”Š\n-â”Š124â”Š   â”Š      return rows[0];\n+â”Š   â”Š113â”Š    async lastMessage(chat, args, { injector }) {\n+â”Š   â”Š114â”Š      return injector.get(Chats).lastMessage(chat.id);\n â”Š125â”Š115â”Š    },\n â”Š126â”Š116â”Š\n â”Š127â”Š117â”Š    async participants(chat, args, { db }) {\n```\n\n[}]: #\n[{]: <helper> (diffStep \"13.13\" module=\"server\")\n\n#### [__Server__ Step 13.13: Find first participant](https://github.com/Urigo/WhatsApp-Clone-Server/commit/119b435422a915d3de03d147550c4f09f090e358)\n\n##### Changed modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -60,4 +60,16 @@\n â”Š60â”Š60â”Š\n â”Š61â”Š61â”Š    return rows[0];\n â”Š62â”Š62â”Š  }\n+â”Š  â”Š63â”Š\n+â”Š  â”Š64â”Š  async firstRecipient({ chatId, userId }: { chatId: string; userId: string }) {\n+â”Š  â”Š65â”Š    const db = await this.db.getClient();\n+â”Š  â”Š66â”Š    const { rows } = await db.query(sql`\n+â”Š  â”Š67â”Š      SELECT users.* FROM users, chats_users\n+â”Š  â”Š68â”Š      WHERE users.id != ${userId}\n+â”Š  â”Š69â”Š      AND users.id = chats_users.user_id\n+â”Š  â”Š70â”Š      AND chats_users.chat_id = ${chatId}\n+â”Š  â”Š71â”Š    `);\n+â”Š  â”Š72â”Š\n+â”Š  â”Š73â”Š    return rows[0] || null;\n+â”Š  â”Š74â”Š  }\n â”Š63â”Š75â”Š}\n```\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -61,13 +61,11 @@\n â”Š61â”Š61â”Š      return injector.get(Users).findById(message.sender_user_id);\n â”Š62â”Š62â”Š    },\n â”Š63â”Š63â”Š\n-â”Š64â”Š  â”Š    async recipient(message, args, { db }) {\n-â”Š65â”Š  â”Š      const { rows } = await db.query(sql`\n-â”Š66â”Š  â”Š        SELECT users.* FROM users, chats_users\n-â”Š67â”Š  â”Š        WHERE chats_users.user_id != ${message.sender_user_id}\n-â”Š68â”Š  â”Š        AND chats_users.chat_id = ${message.chat_id}\n-â”Š69â”Š  â”Š      `);\n-â”Š70â”Š  â”Š      return rows[0] || null;\n+â”Š  â”Š64â”Š    async recipient(message, args, { injector }) {\n+â”Š  â”Š65â”Š      return injector.get(Chats).firstRecipient({\n+â”Š  â”Š66â”Š        chatId: message.chat_id,\n+â”Š  â”Š67â”Š        userId: message.sender_user_id,\n+â”Š  â”Š68â”Š      });\n â”Š71â”Š69â”Š    },\n â”Š72â”Š70â”Š\n â”Š73â”Š71â”Š    isMine(message, args, { currentUser }) {\n```\n```diff\n@@ -76,16 +74,13 @@\n â”Š76â”Š74â”Š  },\n â”Š77â”Š75â”Š\n â”Š78â”Š76â”Š  Chat: {\n-â”Š79â”Š  â”Š    async name(chat, args, { currentUser, db }) {\n+â”Š  â”Š77â”Š    async name(chat, args, { currentUser, injector }) {\n â”Š80â”Š78â”Š      if (!currentUser) return null;\n â”Š81â”Š79â”Š\n-â”Š82â”Š  â”Š      const { rows } = await db.query(sql`\n-â”Š83â”Š  â”Š        SELECT users.* FROM users, chats_users\n-â”Š84â”Š  â”Š        WHERE users.id != ${currentUser.id}\n-â”Š85â”Š  â”Š        AND users.id = chats_users.user_id\n-â”Š86â”Š  â”Š        AND chats_users.chat_id = ${chat.id}`);\n-â”Š87â”Š  â”Š\n-â”Š88â”Š  â”Š      const participant = rows[0];\n+â”Š  â”Š80â”Š      const participant = await injector.get(Chats).firstRecipient({\n+â”Š  â”Š81â”Š        chatId: chat.id,\n+â”Š  â”Š82â”Š        userId: currentUser.id,\n+â”Š  â”Š83â”Š      });\n â”Š89â”Š84â”Š\n â”Š90â”Š85â”Š      return participant ? participant.name : null;\n â”Š91â”Š86â”Š    },\n```\n```diff\n@@ -93,13 +88,10 @@\n â”Š 93â”Š 88â”Š    async picture(chat, args, { currentUser, db, injector }) {\n â”Š 94â”Š 89â”Š      if (!currentUser) return null;\n â”Š 95â”Š 90â”Š\n-â”Š 96â”Š   â”Š      const { rows } = await db.query(sql`\n-â”Š 97â”Š   â”Š        SELECT users.* FROM users, chats_users\n-â”Š 98â”Š   â”Š        WHERE users.id != ${currentUser.id}\n-â”Š 99â”Š   â”Š        AND users.id = chats_users.user_id\n-â”Š100â”Š   â”Š        AND chats_users.chat_id = ${chat.id}`);\n-â”Š101â”Š   â”Š\n-â”Š102â”Š   â”Š      const participant = rows[0];\n+â”Š   â”Š 91â”Š      const participant = await injector.get(Chats).firstRecipient({\n+â”Š   â”Š 92â”Š        chatId: chat.id,\n+â”Š   â”Š 93â”Š        userId: currentUser.id,\n+â”Š   â”Š 94â”Š      });\n â”Š103â”Š 95â”Š\n â”Š104â”Š 96â”Š      return participant && participant.picture\n â”Š105â”Š 97â”Š        ? participant.picture\n```\n\n[}]: #\n[{]: <helper> (diffStep \"13.14\" module=\"server\")\n\n#### [__Server__ Step 13.14: Find all participants](https://github.com/Urigo/WhatsApp-Clone-Server/commit/dff78358ace717af70ca9234245bdc4fe8fc905d)\n\n##### Changed modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -72,4 +72,15 @@\n â”Š72â”Š72â”Š\n â”Š73â”Š73â”Š    return rows[0] || null;\n â”Š74â”Š74â”Š  }\n+â”Š  â”Š75â”Š\n+â”Š  â”Š76â”Š  async participants(chatId: string) {\n+â”Š  â”Š77â”Š    const db = await this.db.getClient();\n+â”Š  â”Š78â”Š    const { rows } = await db.query(sql`\n+â”Š  â”Š79â”Š      SELECT users.* FROM users, chats_users\n+â”Š  â”Š80â”Š      WHERE chats_users.chat_id = ${chatId}\n+â”Š  â”Š81â”Š      AND chats_users.user_id = users.id\n+â”Š  â”Š82â”Š    `);\n+â”Š  â”Š83â”Š\n+â”Š  â”Š84â”Š    return rows;\n+â”Š  â”Š85â”Š  }\n â”Š75â”Š86â”Š}\n```\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -106,14 +106,8 @@\n â”Š106â”Š106â”Š      return injector.get(Chats).lastMessage(chat.id);\n â”Š107â”Š107â”Š    },\n â”Š108â”Š108â”Š\n-â”Š109â”Š   â”Š    async participants(chat, args, { db }) {\n-â”Š110â”Š   â”Š      const { rows } = await db.query(sql`\n-â”Š111â”Š   â”Š        SELECT users.* FROM users, chats_users\n-â”Š112â”Š   â”Š        WHERE chats_users.chat_id = ${chat.id}\n-â”Š113â”Š   â”Š        AND chats_users.user_id = users.id\n-â”Š114â”Š   â”Š      `);\n-â”Š115â”Š   â”Š\n-â”Š116â”Š   â”Š      return rows;\n+â”Š   â”Š109â”Š    async participants(chat, args, { injector }) {\n+â”Š   â”Š110â”Š      return injector.get(Chats).participants(chat.id);\n â”Š117â”Š111â”Š    },\n â”Š118â”Š112â”Š  },\n```\n\n[}]: #\n[{]: <helper> (diffStep \"13.15\" module=\"server\")\n\n#### [__Server__ Step 13.15: Check if a user belongs to a chat](https://github.com/Urigo/WhatsApp-Clone-Server/commit/b1991aa6ad418b2bb39eb650e70fa390adcdaa07)\n\n##### Changed modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -83,4 +83,15 @@\n â”Š83â”Š83â”Š\n â”Š84â”Š84â”Š    return rows;\n â”Š85â”Š85â”Š  }\n+â”Š  â”Š86â”Š\n+â”Š  â”Š87â”Š  async isParticipant({ chatId, userId }: { chatId: string; userId: string }) {\n+â”Š  â”Š88â”Š    const db = await this.db.getClient();\n+â”Š  â”Š89â”Š    const { rows } = await db.query(sql`\n+â”Š  â”Š90â”Š      SELECT * FROM chats_users\n+â”Š  â”Š91â”Š      WHERE chat_id = ${chatId}\n+â”Š  â”Š92â”Š      AND user_id = ${userId}\n+â”Š  â”Š93â”Š    `);\n+â”Š  â”Š94â”Š\n+â”Š  â”Š95â”Š    return !!rows.length;\n+â”Š  â”Š96â”Š  }\n â”Š86â”Š97â”Š}\n```\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -243,16 +243,14 @@\n â”Š243â”Š243â”Š        async (\n â”Š244â”Š244â”Š          { messageAdded }: { messageAdded: Message },\n â”Š245â”Š245â”Š          args,\n-â”Š246â”Š   â”Š          { currentUser }\n+â”Š   â”Š246â”Š          { currentUser, injector }\n â”Š247â”Š247â”Š        ) => {\n â”Š248â”Š248â”Š          if (!currentUser) return false;\n â”Š249â”Š249â”Š\n-â”Š250â”Š   â”Š          const { rows } = await pool.query(sql`\n-â”Š251â”Š   â”Š            SELECT * FROM chats_users\n-â”Š252â”Š   â”Š            WHERE chat_id = ${messageAdded.chat_id}\n-â”Š253â”Š   â”Š            AND user_id = ${currentUser.id}`);\n-â”Š254â”Š   â”Š\n-â”Š255â”Š   â”Š          return !!rows.length;\n+â”Š   â”Š250â”Š          return injector.get(Chats).isParticipant({\n+â”Š   â”Š251â”Š            chatId: messageAdded.chat_id,\n+â”Š   â”Š252â”Š            userId: currentUser.id,\n+â”Š   â”Š253â”Š          });\n â”Š256â”Š254â”Š        }\n â”Š257â”Š255â”Š      ),\n â”Š258â”Š256â”Š    },\n```\n```diff\n@@ -260,15 +258,17 @@\n â”Š260â”Š258â”Š    chatAdded: {\n â”Š261â”Š259â”Š      subscribe: withFilter(\n â”Š262â”Š260â”Š        (root, args, { pubsub }) => pubsub.asyncIterator('chatAdded'),\n-â”Š263â”Š   â”Š        async ({ chatAdded }: { chatAdded: Chat }, args, { currentUser }) => {\n+â”Š   â”Š261â”Š        async (\n+â”Š   â”Š262â”Š          { chatAdded }: { chatAdded: Chat },\n+â”Š   â”Š263â”Š          args,\n+â”Š   â”Š264â”Š          { currentUser, injector }\n+â”Š   â”Š265â”Š        ) => {\n â”Š264â”Š266â”Š          if (!currentUser) return false;\n â”Š265â”Š267â”Š\n-â”Š266â”Š   â”Š          const { rows } = await pool.query(sql`\n-â”Š267â”Š   â”Š            SELECT * FROM chats_users\n-â”Š268â”Š   â”Š            WHERE chat_id = ${chatAdded.id}\n-â”Š269â”Š   â”Š            AND user_id = ${currentUser.id}`);\n-â”Š270â”Š   â”Š\n-â”Š271â”Š   â”Š          return !!rows.length;\n+â”Š   â”Š268â”Š          return injector.get(Chats).isParticipant({\n+â”Š   â”Š269â”Š            chatId: chatAdded.id,\n+â”Š   â”Š270â”Š            userId: currentUser.id,\n+â”Š   â”Š271â”Š          });\n â”Š272â”Š272â”Š        }\n â”Š273â”Š273â”Š      ),\n â”Š274â”Š274â”Š    },\n```\n```diff\n@@ -276,15 +276,17 @@\n â”Š276â”Š276â”Š    chatRemoved: {\n â”Š277â”Š277â”Š      subscribe: withFilter(\n â”Š278â”Š278â”Š        (root, args, { pubsub }) => pubsub.asyncIterator('chatRemoved'),\n-â”Š279â”Š   â”Š        async ({ targetChat }: { targetChat: Chat }, args, { currentUser }) => {\n+â”Š   â”Š279â”Š        async (\n+â”Š   â”Š280â”Š          { targetChat }: { targetChat: Chat },\n+â”Š   â”Š281â”Š          args,\n+â”Š   â”Š282â”Š          { currentUser, injector }\n+â”Š   â”Š283â”Š        ) => {\n â”Š280â”Š284â”Š          if (!currentUser) return false;\n â”Š281â”Š285â”Š\n-â”Š282â”Š   â”Š          const { rows } = await pool.query(sql`\n-â”Š283â”Š   â”Š            SELECT * FROM chats_users\n-â”Š284â”Š   â”Š            WHERE chat_id = ${targetChat.id}\n-â”Š285â”Š   â”Š            AND user_id = ${currentUser.id}`);\n-â”Š286â”Š   â”Š\n-â”Š287â”Š   â”Š          return !!rows.length;\n+â”Š   â”Š286â”Š          return injector.get(Chats).isParticipant({\n+â”Š   â”Š287â”Š            chatId: targetChat.id,\n+â”Š   â”Š288â”Š            userId: currentUser.id,\n+â”Š   â”Š289â”Š          });\n â”Š288â”Š290â”Š        }\n â”Š289â”Š291â”Š      ),\n â”Š290â”Š292â”Š    },\n```\n\n[}]: #\n\n#### Sharing PubSub\n\nOne of things that are still in the context is `PubSub`. Because we're moving an entire business logic into a separate layer and as part of GraphQL Module's providers we need to make sure that PubSub is accessible throug DI.\n\nLet's register the PubSub and migrate resolvers:\n\n[{]: <helper> (diffStep \"13.16\" module=\"server\")\n\n#### [__Server__ Step 13.16: Move PubSub to Dependency Injection](https://github.com/Urigo/WhatsApp-Clone-Server/commit/1757d93e61e2abef92ac2f6e3e8a45d96716aa9d)\n\n##### Changed context.ts\n```diff\n@@ -1,11 +1,9 @@\n-â”Š 1â”Š  â”Šimport { PubSub } from 'apollo-server-express';\n â”Š 2â”Š 1â”Šimport { ModuleContext } from '@graphql-modules/core';\n â”Š 3â”Š 2â”Šimport { User } from './db';\n â”Š 4â”Š 3â”Šimport { Response } from 'express';\n â”Š 5â”Š 4â”Šimport { PoolClient } from 'pg';\n â”Š 6â”Š 5â”Š\n â”Š 7â”Š 6â”Šexport type MyContext = {\n-â”Š 8â”Š  â”Š  pubsub: PubSub;\n â”Š 9â”Š 7â”Š  currentUser: User;\n â”Š10â”Š 8â”Š  res: Response;\n â”Š11â”Š 9â”Š  db: PoolClient;\n```\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -8,6 +8,7 @@\n â”Š 8â”Š 8â”Šimport { UnsplashApi } from './unsplash.api';\n â”Š 9â”Š 9â”Šimport { Users } from './../users/users.provider';\n â”Š10â”Š10â”Šimport { Chats } from './chats.provider';\n+â”Š  â”Š11â”Šimport { PubSub } from '../common/pubsub.provider';\n â”Š11â”Š12â”Š\n â”Š12â”Š13â”Šconst typeDefs = gql`\n â”Š13â”Š14â”Š  type Message {\n```\n```diff\n@@ -128,7 +129,7 @@\n â”Š128â”Š129â”Š  },\n â”Š129â”Š130â”Š\n â”Š130â”Š131â”Š  Mutation: {\n-â”Š131â”Š   â”Š    async addMessage(root, { chatId, content }, { currentUser, pubsub, db }) {\n+â”Š   â”Š132â”Š    async addMessage(root, { chatId, content }, { currentUser, injector, db }) {\n â”Š132â”Š133â”Š      if (!currentUser) return null;\n â”Š133â”Š134â”Š\n â”Š134â”Š135â”Š      const { rows } = await db.query(sql`\n```\n```diff\n@@ -139,14 +140,14 @@\n â”Š139â”Š140â”Š\n â”Š140â”Š141â”Š      const messageAdded = rows[0];\n â”Š141â”Š142â”Š\n-â”Š142â”Š   â”Š      pubsub.publish('messageAdded', {\n+â”Š   â”Š143â”Š      injector.get(PubSub).publish('messageAdded', {\n â”Š143â”Š144â”Š        messageAdded,\n â”Š144â”Š145â”Š      });\n â”Š145â”Š146â”Š\n â”Š146â”Š147â”Š      return messageAdded;\n â”Š147â”Š148â”Š    },\n â”Š148â”Š149â”Š\n-â”Š149â”Š   â”Š    async addChat(root, { recipientId }, { currentUser, pubsub, db }) {\n+â”Š   â”Š150â”Š    async addChat(root, { recipientId }, { currentUser, injector, db }) {\n â”Š150â”Š151â”Š      if (!currentUser) return null;\n â”Š151â”Š152â”Š\n â”Š152â”Š153â”Š      const { rows } = await db.query(sql`\n```\n```diff\n@@ -186,7 +187,7 @@\n â”Š186â”Š187â”Š\n â”Š187â”Š188â”Š        await db.query('COMMIT');\n â”Š188â”Š189â”Š\n-â”Š189â”Š   â”Š        pubsub.publish('chatAdded', {\n+â”Š   â”Š190â”Š        injector.get(PubSub).publish('chatAdded', {\n â”Š190â”Š191â”Š          chatAdded,\n â”Š191â”Š192â”Š        });\n â”Š192â”Š193â”Š\n```\n```diff\n@@ -197,7 +198,7 @@\n â”Š197â”Š198â”Š      }\n â”Š198â”Š199â”Š    },\n â”Š199â”Š200â”Š\n-â”Š200â”Š   â”Š    async removeChat(root, { chatId }, { currentUser, pubsub, db }) {\n+â”Š   â”Š201â”Š    async removeChat(root, { chatId }, { currentUser, injector, db }) {\n â”Š201â”Š202â”Š      if (!currentUser) return null;\n â”Š202â”Š203â”Š\n â”Š203â”Š204â”Š      try {\n```\n```diff\n@@ -221,7 +222,7 @@\n â”Š221â”Š222â”Š          DELETE FROM chats WHERE chats.id = ${chatId}\n â”Š222â”Š223â”Š        `);\n â”Š223â”Š224â”Š\n-â”Š224â”Š   â”Š        pubsub.publish('chatRemoved', {\n+â”Š   â”Š225â”Š        injector.get(PubSub).publish('chatRemoved', {\n â”Š225â”Š226â”Š          chatRemoved: chat.id,\n â”Š226â”Š227â”Š          targetChat: chat,\n â”Š227â”Š228â”Š        });\n```\n```diff\n@@ -239,7 +240,8 @@\n â”Š239â”Š240â”Š  Subscription: {\n â”Š240â”Š241â”Š    messageAdded: {\n â”Š241â”Š242â”Š      subscribe: withFilter(\n-â”Š242â”Š   â”Š        (root, args, { pubsub }) => pubsub.asyncIterator('messageAdded'),\n+â”Š   â”Š243â”Š        (root, args, { injector }) =>\n+â”Š   â”Š244â”Š          injector.get(PubSub).asyncIterator('messageAdded'),\n â”Š243â”Š245â”Š        async (\n â”Š244â”Š246â”Š          { messageAdded }: { messageAdded: Message },\n â”Š245â”Š247â”Š          args,\n```\n```diff\n@@ -257,7 +259,8 @@\n â”Š257â”Š259â”Š\n â”Š258â”Š260â”Š    chatAdded: {\n â”Š259â”Š261â”Š      subscribe: withFilter(\n-â”Š260â”Š   â”Š        (root, args, { pubsub }) => pubsub.asyncIterator('chatAdded'),\n+â”Š   â”Š262â”Š        (root, args, { injector }) =>\n+â”Š   â”Š263â”Š          injector.get(PubSub).asyncIterator('chatAdded'),\n â”Š261â”Š264â”Š        async (\n â”Š262â”Š265â”Š          { chatAdded }: { chatAdded: Chat },\n â”Š263â”Š266â”Š          args,\n```\n```diff\n@@ -275,7 +278,8 @@\n â”Š275â”Š278â”Š\n â”Š276â”Š279â”Š    chatRemoved: {\n â”Š277â”Š280â”Š      subscribe: withFilter(\n-â”Š278â”Š   â”Š        (root, args, { pubsub }) => pubsub.asyncIterator('chatRemoved'),\n+â”Š   â”Š281â”Š        (root, args, { injector }) =>\n+â”Š   â”Š282â”Š          injector.get(PubSub).asyncIterator('chatRemoved'),\n â”Š279â”Š283â”Š        async (\n â”Š280â”Š284â”Š          { targetChat }: { targetChat: Chat },\n â”Š281â”Š285â”Š          args,\n```\n\n##### Changed modules&#x2F;common&#x2F;index.ts\n```diff\n@@ -1,10 +1,12 @@\n â”Š 1â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n+â”Š  â”Š 2â”Šimport { ProviderScope } from '@graphql-modules/di';\n â”Š 2â”Š 3â”Šimport { gql } from 'apollo-server-express';\n â”Š 3â”Š 4â”Šimport { GraphQLDateTime } from 'graphql-iso-date';\n â”Š 4â”Š 5â”Šimport { Pool } from 'pg';\n â”Š 5â”Š 6â”Šimport { pool } from '../../db';\n â”Š 6â”Š 7â”Šimport { Resolvers } from '../../types/graphql';\n â”Š 7â”Š 8â”Šimport { Database } from './database.provider';\n+â”Š  â”Š 9â”Šimport { PubSub } from './pubsub.provider';\n â”Š 8â”Š10â”Š\n â”Š 9â”Š11â”Šconst { PostgresPubSub } = require('graphql-postgres-subscriptions');\n â”Š10â”Š12â”Š\n```\n```diff\n@@ -45,6 +47,11 @@\n â”Š45â”Š47â”Š      provide: Pool,\n â”Š46â”Š48â”Š      useValue: pool,\n â”Š47â”Š49â”Š    },\n+â”Š  â”Š50â”Š    {\n+â”Š  â”Š51â”Š      provide: PubSub,\n+â”Š  â”Š52â”Š      scope: ProviderScope.Application,\n+â”Š  â”Š53â”Š      useValue: pubsub,\n+â”Š  â”Š54â”Š    },\n â”Š48â”Š55â”Š    Database,\n â”Š49â”Š56â”Š  ],\n â”Š50â”Š57â”Š  async context({ res, connection }) {\n```\n```diff\n@@ -55,7 +62,6 @@\n â”Š55â”Š62â”Š    }\n â”Š56â”Š63â”Š\n â”Š57â”Š64â”Š    return {\n-â”Š58â”Š  â”Š      pubsub,\n â”Š59â”Š65â”Š      res,\n â”Š60â”Š66â”Š      db,\n â”Š61â”Š67â”Š    };\n```\n\n##### Added modules&#x2F;common&#x2F;pubsub.provider.ts\n```diff\n@@ -0,0 +1 @@\n+â”Š â”Š1â”Šexport { PubSub } from 'apollo-server-express';\n```\n\n[}]: #\n\nNow, we're going to use `PubSub` within `Chats` service:\n\n[{]: <helper> (diffStep \"13.17\" module=\"server\")\n\n#### [__Server__ Step 13.17: Migrate addMessage to Chats provider](https://github.com/Urigo/WhatsApp-Clone-Server/commit/3bb3d25a5346273a685483d371ab7b9671fa881c)\n\n##### Changed modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -1,12 +1,14 @@\n â”Š 1â”Š 1â”Šimport { Injectable, Inject, ProviderScope } from '@graphql-modules/di';\n â”Š 2â”Š 2â”Šimport sql from 'sql-template-strings';\n â”Š 3â”Š 3â”Šimport { Database } from '../common/database.provider';\n+â”Š  â”Š 4â”Šimport { PubSub } from '../common/pubsub.provider';\n â”Š 4â”Š 5â”Š\n â”Š 5â”Š 6â”Š@Injectable({\n â”Š 6â”Š 7â”Š  scope: ProviderScope.Session,\n â”Š 7â”Š 8â”Š})\n â”Š 8â”Š 9â”Šexport class Chats {\n â”Š 9â”Š10â”Š  @Inject() private db: Database;\n+â”Š  â”Š11â”Š  @Inject() private pubsub: PubSub;\n â”Š10â”Š12â”Š\n â”Š11â”Š13â”Š  async findChatsByUser(userId: string) {\n â”Š12â”Š14â”Š    const db = await this.db.getClient();\n```\n```diff\n@@ -94,4 +96,29 @@\n â”Š 94â”Š 96â”Š\n â”Š 95â”Š 97â”Š    return !!rows.length;\n â”Š 96â”Š 98â”Š  }\n+â”Š   â”Š 99â”Š\n+â”Š   â”Š100â”Š  async addMessage({\n+â”Š   â”Š101â”Š    chatId,\n+â”Š   â”Š102â”Š    userId,\n+â”Š   â”Š103â”Š    content,\n+â”Š   â”Š104â”Š  }: {\n+â”Š   â”Š105â”Š    chatId: string;\n+â”Š   â”Š106â”Š    userId: string;\n+â”Š   â”Š107â”Š    content: string;\n+â”Š   â”Š108â”Š  }) {\n+â”Š   â”Š109â”Š    const db = await this.db.getClient();\n+â”Š   â”Š110â”Š    const { rows } = await db.query(sql`\n+â”Š   â”Š111â”Š      INSERT INTO messages(chat_id, sender_user_id, content)\n+â”Š   â”Š112â”Š      VALUES(${chatId}, ${userId}, ${content})\n+â”Š   â”Š113â”Š      RETURNING *\n+â”Š   â”Š114â”Š    `);\n+â”Š   â”Š115â”Š\n+â”Š   â”Š116â”Š    const messageAdded = rows[0];\n+â”Š   â”Š117â”Š\n+â”Š   â”Š118â”Š    this.pubsub.publish('messageAdded', {\n+â”Š   â”Š119â”Š      messageAdded,\n+â”Š   â”Š120â”Š    });\n+â”Š   â”Š121â”Š\n+â”Š   â”Š122â”Š    return messageAdded;\n+â”Š   â”Š123â”Š  }\n â”Š 97â”Š124â”Š}\n```\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -129,22 +129,12 @@\n â”Š129â”Š129â”Š  },\n â”Š130â”Š130â”Š\n â”Š131â”Š131â”Š  Mutation: {\n-â”Š132â”Š   â”Š    async addMessage(root, { chatId, content }, { currentUser, injector, db }) {\n+â”Š   â”Š132â”Š    async addMessage(root, { chatId, content }, { currentUser, injector }) {\n â”Š133â”Š133â”Š      if (!currentUser) return null;\n â”Š134â”Š134â”Š\n-â”Š135â”Š   â”Š      const { rows } = await db.query(sql`\n-â”Š136â”Š   â”Š        INSERT INTO messages(chat_id, sender_user_id, content)\n-â”Š137â”Š   â”Š        VALUES(${chatId}, ${currentUser.id}, ${content})\n-â”Š138â”Š   â”Š        RETURNING *\n-â”Š139â”Š   â”Š      `);\n-â”Š140â”Š   â”Š\n-â”Š141â”Š   â”Š      const messageAdded = rows[0];\n-â”Š142â”Š   â”Š\n-â”Š143â”Š   â”Š      injector.get(PubSub).publish('messageAdded', {\n-â”Š144â”Š   â”Š        messageAdded,\n-â”Š145â”Š   â”Š      });\n-â”Š146â”Š   â”Š\n-â”Š147â”Š   â”Š      return messageAdded;\n+â”Š   â”Š135â”Š      return injector\n+â”Š   â”Š136â”Š        .get(Chats)\n+â”Š   â”Š137â”Š        .addMessage({ chatId, content, userId: currentUser.id });\n â”Š148â”Š138â”Š    },\n â”Š149â”Š139â”Š\n â”Š150â”Š140â”Š    async addChat(root, { recipientId }, { currentUser, injector, db }) {\n```\n\n[}]: #\n[{]: <helper> (diffStep \"13.18\" module=\"server\")\n\n#### [__Server__ Step 13.18: Migrate addChat to Chats provider](https://github.com/Urigo/WhatsApp-Clone-Server/commit/fd983efdb6182024e55133449710581544751dab)\n\n##### Changed modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -121,4 +121,58 @@\n â”Š121â”Š121â”Š\n â”Š122â”Š122â”Š    return messageAdded;\n â”Š123â”Š123â”Š  }\n+â”Š   â”Š124â”Š\n+â”Š   â”Š125â”Š  async addChat({\n+â”Š   â”Š126â”Š    userId,\n+â”Š   â”Š127â”Š    recipientId,\n+â”Š   â”Š128â”Š  }: {\n+â”Š   â”Š129â”Š    userId: string;\n+â”Š   â”Š130â”Š    recipientId: string;\n+â”Š   â”Š131â”Š  }) {\n+â”Š   â”Š132â”Š    const db = await this.db.getClient();\n+â”Š   â”Š133â”Š    const { rows } = await db.query(sql`\n+â”Š   â”Š134â”Š      SELECT chats.* FROM chats, (SELECT * FROM chats_users WHERE user_id = ${userId}) AS chats_of_current_user, chats_users\n+â”Š   â”Š135â”Š      WHERE chats_users.chat_id = chats_of_current_user.chat_id\n+â”Š   â”Š136â”Š      AND chats.id = chats_users.chat_id\n+â”Š   â”Š137â”Š      AND chats_users.user_id = ${recipientId}\n+â”Š   â”Š138â”Š    `);\n+â”Š   â”Š139â”Š\n+â”Š   â”Š140â”Š    // If there is already a chat between these two users, return it\n+â”Š   â”Š141â”Š    if (rows[0]) {\n+â”Š   â”Š142â”Š      return rows[0];\n+â”Š   â”Š143â”Š    }\n+â”Š   â”Š144â”Š\n+â”Š   â”Š145â”Š    try {\n+â”Š   â”Š146â”Š      await db.query('BEGIN');\n+â”Š   â”Š147â”Š\n+â”Š   â”Š148â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š149â”Š        INSERT INTO chats\n+â”Š   â”Š150â”Š        DEFAULT VALUES\n+â”Š   â”Š151â”Š        RETURNING *\n+â”Š   â”Š152â”Š      `);\n+â”Š   â”Š153â”Š\n+â”Š   â”Š154â”Š      const chatAdded = rows[0];\n+â”Š   â”Š155â”Š\n+â”Š   â”Š156â”Š      await db.query(sql`\n+â”Š   â”Š157â”Š        INSERT INTO chats_users(chat_id, user_id)\n+â”Š   â”Š158â”Š        VALUES(${chatAdded.id}, ${userId})\n+â”Š   â”Š159â”Š      `);\n+â”Š   â”Š160â”Š\n+â”Š   â”Š161â”Š      await db.query(sql`\n+â”Š   â”Š162â”Š        INSERT INTO chats_users(chat_id, user_id)\n+â”Š   â”Š163â”Š        VALUES(${chatAdded.id}, ${recipientId})\n+â”Š   â”Š164â”Š      `);\n+â”Š   â”Š165â”Š\n+â”Š   â”Š166â”Š      await db.query('COMMIT');\n+â”Š   â”Š167â”Š\n+â”Š   â”Š168â”Š      this.pubsub.publish('chatAdded', {\n+â”Š   â”Š169â”Š        chatAdded,\n+â”Š   â”Š170â”Š      });\n+â”Š   â”Š171â”Š\n+â”Š   â”Š172â”Š      return chatAdded;\n+â”Š   â”Š173â”Š    } catch (e) {\n+â”Š   â”Š174â”Š      await db.query('ROLLBACK');\n+â”Š   â”Š175â”Š      throw e;\n+â”Š   â”Š176â”Š    }\n+â”Š   â”Š177â”Š  }\n â”Š124â”Š178â”Š}\n```\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -137,55 +137,12 @@\n â”Š137â”Š137â”Š        .addMessage({ chatId, content, userId: currentUser.id });\n â”Š138â”Š138â”Š    },\n â”Š139â”Š139â”Š\n-â”Š140â”Š   â”Š    async addChat(root, { recipientId }, { currentUser, injector, db }) {\n+â”Š   â”Š140â”Š    async addChat(root, { recipientId }, { currentUser, injector }) {\n â”Š141â”Š141â”Š      if (!currentUser) return null;\n â”Š142â”Š142â”Š\n-â”Š143â”Š   â”Š      const { rows } = await db.query(sql`\n-â”Š144â”Š   â”Š        SELECT chats.* FROM chats, (SELECT * FROM chats_users WHERE user_id = ${\n-â”Š145â”Š   â”Š          currentUser.id\n-â”Š146â”Š   â”Š        }) AS chats_of_current_user, chats_users\n-â”Š147â”Š   â”Š        WHERE chats_users.chat_id = chats_of_current_user.chat_id\n-â”Š148â”Š   â”Š        AND chats.id = chats_users.chat_id\n-â”Š149â”Š   â”Š        AND chats_users.user_id = ${recipientId}\n-â”Š150â”Š   â”Š      `);\n-â”Š151â”Š   â”Š\n-â”Š152â”Š   â”Š      // If there is already a chat between these two users, return it\n-â”Š153â”Š   â”Š      if (rows[0]) {\n-â”Š154â”Š   â”Š        return rows[0];\n-â”Š155â”Š   â”Š      }\n-â”Š156â”Š   â”Š\n-â”Š157â”Š   â”Š      try {\n-â”Š158â”Š   â”Š        await db.query('BEGIN');\n-â”Š159â”Š   â”Š\n-â”Š160â”Š   â”Š        const { rows } = await db.query(sql`\n-â”Š161â”Š   â”Š          INSERT INTO chats\n-â”Š162â”Š   â”Š          DEFAULT VALUES\n-â”Š163â”Š   â”Š          RETURNING *\n-â”Š164â”Š   â”Š        `);\n-â”Š165â”Š   â”Š\n-â”Š166â”Š   â”Š        const chatAdded = rows[0];\n-â”Š167â”Š   â”Š\n-â”Š168â”Š   â”Š        await db.query(sql`\n-â”Š169â”Š   â”Š          INSERT INTO chats_users(chat_id, user_id)\n-â”Š170â”Š   â”Š          VALUES(${chatAdded.id}, ${currentUser.id})\n-â”Š171â”Š   â”Š        `);\n-â”Š172â”Š   â”Š\n-â”Š173â”Š   â”Š        await db.query(sql`\n-â”Š174â”Š   â”Š          INSERT INTO chats_users(chat_id, user_id)\n-â”Š175â”Š   â”Š          VALUES(${chatAdded.id}, ${recipientId})\n-â”Š176â”Š   â”Š        `);\n-â”Š177â”Š   â”Š\n-â”Š178â”Š   â”Š        await db.query('COMMIT');\n-â”Š179â”Š   â”Š\n-â”Š180â”Š   â”Š        injector.get(PubSub).publish('chatAdded', {\n-â”Š181â”Š   â”Š          chatAdded,\n-â”Š182â”Š   â”Š        });\n-â”Š183â”Š   â”Š\n-â”Š184â”Š   â”Š        return chatAdded;\n-â”Š185â”Š   â”Š      } catch (e) {\n-â”Š186â”Š   â”Š        await db.query('ROLLBACK');\n-â”Š187â”Š   â”Š        throw e;\n-â”Š188â”Š   â”Š      }\n+â”Š   â”Š143â”Š      return injector\n+â”Š   â”Š144â”Š        .get(Chats)\n+â”Š   â”Š145â”Š        .addChat({ recipientId, userId: currentUser.id });\n â”Š189â”Š146â”Š    },\n â”Š190â”Š147â”Š\n â”Š191â”Š148â”Š    async removeChat(root, { chatId }, { currentUser, injector, db }) {\n```\n\n[}]: #\n[{]: <helper> (diffStep \"13.19\" module=\"server\")\n\n#### [__Server__ Step 13.19: Migrate removeChat to Chats provider](https://github.com/Urigo/WhatsApp-Clone-Server/commit/19ae2798137c4be1e072cdd4e7f1cb4a374aae76)\n\n##### Changed modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -175,4 +175,42 @@\n â”Š175â”Š175â”Š      throw e;\n â”Š176â”Š176â”Š    }\n â”Š177â”Š177â”Š  }\n+â”Š   â”Š178â”Š\n+â”Š   â”Š179â”Š  async removeChat({ chatId, userId }: { chatId: string; userId: string }) {\n+â”Š   â”Š180â”Š    const db = await this.db.getClient();\n+â”Š   â”Š181â”Š\n+â”Š   â”Š182â”Š    try {\n+â”Š   â”Š183â”Š      await db.query('BEGIN');\n+â”Š   â”Š184â”Š\n+â”Š   â”Š185â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š186â”Š        SELECT chats.* FROM chats, chats_users\n+â”Š   â”Š187â”Š        WHERE id = ${chatId}\n+â”Š   â”Š188â”Š        AND chats.id = chats_users.chat_id\n+â”Š   â”Š189â”Š        AND chats_users.user_id = ${userId}\n+â”Š   â”Š190â”Š      `);\n+â”Š   â”Š191â”Š\n+â”Š   â”Š192â”Š      const chat = rows[0];\n+â”Š   â”Š193â”Š\n+â”Š   â”Š194â”Š      if (!chat) {\n+â”Š   â”Š195â”Š        await db.query('ROLLBACK');\n+â”Š   â”Š196â”Š        return null;\n+â”Š   â”Š197â”Š      }\n+â”Š   â”Š198â”Š\n+â”Š   â”Š199â”Š      await db.query(sql`\n+â”Š   â”Š200â”Š        DELETE FROM chats WHERE chats.id = ${chatId}\n+â”Š   â”Š201â”Š      `);\n+â”Š   â”Š202â”Š\n+â”Š   â”Š203â”Š      this.pubsub.publish('chatRemoved', {\n+â”Š   â”Š204â”Š        chatRemoved: chat.id,\n+â”Š   â”Š205â”Š        targetChat: chat,\n+â”Š   â”Š206â”Š      });\n+â”Š   â”Š207â”Š\n+â”Š   â”Š208â”Š      await db.query('COMMIT');\n+â”Š   â”Š209â”Š\n+â”Š   â”Š210â”Š      return chatId;\n+â”Š   â”Š211â”Š    } catch (e) {\n+â”Š   â”Š212â”Š      await db.query('ROLLBACK');\n+â”Š   â”Š213â”Š      throw e;\n+â”Š   â”Š214â”Š    }\n+â”Š   â”Š215â”Š  }\n â”Š178â”Š216â”Š}\n```\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -145,42 +145,10 @@\n â”Š145â”Š145â”Š        .addChat({ recipientId, userId: currentUser.id });\n â”Š146â”Š146â”Š    },\n â”Š147â”Š147â”Š\n-â”Š148â”Š   â”Š    async removeChat(root, { chatId }, { currentUser, injector, db }) {\n+â”Š   â”Š148â”Š    async removeChat(root, { chatId }, { currentUser, injector }) {\n â”Š149â”Š149â”Š      if (!currentUser) return null;\n â”Š150â”Š150â”Š\n-â”Š151â”Š   â”Š      try {\n-â”Š152â”Š   â”Š        await db.query('BEGIN');\n-â”Š153â”Š   â”Š\n-â”Š154â”Š   â”Š        const { rows } = await db.query(sql`\n-â”Š155â”Š   â”Š          SELECT chats.* FROM chats, chats_users\n-â”Š156â”Š   â”Š          WHERE id = ${chatId}\n-â”Š157â”Š   â”Š          AND chats.id = chats_users.chat_id\n-â”Š158â”Š   â”Š          AND chats_users.user_id = ${currentUser.id}\n-â”Š159â”Š   â”Š        `);\n-â”Š160â”Š   â”Š\n-â”Š161â”Š   â”Š        const chat = rows[0];\n-â”Š162â”Š   â”Š\n-â”Š163â”Š   â”Š        if (!chat) {\n-â”Š164â”Š   â”Š          await db.query('ROLLBACK');\n-â”Š165â”Š   â”Š          return null;\n-â”Š166â”Š   â”Š        }\n-â”Š167â”Š   â”Š\n-â”Š168â”Š   â”Š        await db.query(sql`\n-â”Š169â”Š   â”Š          DELETE FROM chats WHERE chats.id = ${chatId}\n-â”Š170â”Š   â”Š        `);\n-â”Š171â”Š   â”Š\n-â”Š172â”Š   â”Š        injector.get(PubSub).publish('chatRemoved', {\n-â”Š173â”Š   â”Š          chatRemoved: chat.id,\n-â”Š174â”Š   â”Š          targetChat: chat,\n-â”Š175â”Š   â”Š        });\n-â”Š176â”Š   â”Š\n-â”Š177â”Š   â”Š        await db.query('COMMIT');\n-â”Š178â”Š   â”Š\n-â”Š179â”Š   â”Š        return chatId;\n-â”Š180â”Š   â”Š      } catch (e) {\n-â”Š181â”Š   â”Š        await db.query('ROLLBACK');\n-â”Š182â”Š   â”Š        throw e;\n-â”Š183â”Š   â”Š      }\n+â”Š   â”Š151â”Š      return injector.get(Chats).removeChat({ chatId, userId: currentUser.id });\n â”Š184â”Š152â”Š    },\n â”Š185â”Š153â”Š  },\n```\n\n[}]: #\n\n#### Implementing Auth service\n\nThe last missing piece of our \"context migration\" journey is `currentUser` object. We're going to define the `Auth` service.\n\n[{]: <helper> (diffStep \"13.20\" files=\"modules/users/auth.provider.ts\" module=\"server\")\n\n#### [__Server__ Step 13.20: Implement Auth provider with currentUser method](https://github.com/Urigo/WhatsApp-Clone-Server/commit/aaa3e5061eb0e2ca2f18a84c2618193ebefe7767)\n\n##### Added modules&#x2F;users&#x2F;auth.provider.ts\n```diff\n@@ -0,0 +1,30 @@\n+â”Š  â”Š 1â”Šimport { Injectable, Inject, ProviderScope } from '@graphql-modules/di';\n+â”Š  â”Š 2â”Šimport { ModuleSessionInfo } from '@graphql-modules/core';\n+â”Š  â”Š 3â”Šimport jwt from 'jsonwebtoken';\n+â”Š  â”Š 4â”Šimport { secret } from '../../env';\n+â”Š  â”Š 5â”Šimport { Users } from './users.provider';\n+â”Š  â”Š 6â”Šimport { User } from '../../db';\n+â”Š  â”Š 7â”Š\n+â”Š  â”Š 8â”Š@Injectable({\n+â”Š  â”Š 9â”Š  scope: ProviderScope.Session,\n+â”Š  â”Š10â”Š})\n+â”Š  â”Š11â”Šexport class Auth {\n+â”Š  â”Š12â”Š  @Inject() private users: Users;\n+â”Š  â”Š13â”Š  @Inject() private module: ModuleSessionInfo;\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”Š  private get req() {\n+â”Š  â”Š16â”Š    return this.module.session.req || this.module.session.request;\n+â”Š  â”Š17â”Š  }\n+â”Š  â”Š18â”Š\n+â”Š  â”Š19â”Š  async currentUser(): Promise<User | null> {\n+â”Š  â”Š20â”Š    if (this.req.cookies.authToken) {\n+â”Š  â”Š21â”Š      const username = jwt.verify(this.req.cookies.authToken, secret) as string;\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Š      if (username) {\n+â”Š  â”Š24â”Š        return this.users.findByUsername(username);\n+â”Š  â”Š25â”Š      }\n+â”Š  â”Š26â”Š    }\n+â”Š  â”Š27â”Š\n+â”Š  â”Š28â”Š    return null;\n+â”Š  â”Š29â”Š  }\n+â”Š  â”Š30â”Š}\n```\n\n[}]: #\n\nIt still needs to be registered and few resolvers in Users module have to be migrated:\n\n[{]: <helper> (diffStep \"13.20\" files=\"modules/users/index.ts, context.ts\" module=\"server\")\n\n#### [__Server__ Step 13.20: Implement Auth provider with currentUser method](https://github.com/Urigo/WhatsApp-Clone-Server/commit/aaa3e5061eb0e2ca2f18a84c2618193ebefe7767)\n\n##### Changed context.ts\n```diff\n@@ -1,10 +1,8 @@\n â”Š 1â”Š 1â”Šimport { ModuleContext } from '@graphql-modules/core';\n-â”Š 2â”Š  â”Šimport { User } from './db';\n â”Š 3â”Š 2â”Šimport { Response } from 'express';\n â”Š 4â”Š 3â”Šimport { PoolClient } from 'pg';\n â”Š 5â”Š 4â”Š\n â”Š 6â”Š 5â”Šexport type MyContext = {\n-â”Š 7â”Š  â”Š  currentUser: User;\n â”Š 8â”Š 6â”Š  res: Response;\n â”Š 9â”Š 7â”Š  db: PoolClient;\n â”Š10â”Š 8â”Š} & ModuleContext;\n```\n\n##### Changed modules&#x2F;users&#x2F;index.ts\n```diff\n@@ -1,6 +1,5 @@\n â”Š1â”Š1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š2â”Š2â”Šimport { gql } from 'apollo-server-express';\n-â”Š3â”Š â”Šimport cookie from 'cookie';\n â”Š4â”Š3â”Šimport sql from 'sql-template-strings';\n â”Š5â”Š4â”Šimport bcrypt from 'bcrypt';\n â”Š6â”Š5â”Šimport jwt from 'jsonwebtoken';\n```\n```diff\n@@ -10,6 +9,7 @@\n â”Š10â”Š 9â”Šimport { validateLength, validatePassword } from '../../validators';\n â”Š11â”Š10â”Šimport { Resolvers } from '../../types/graphql';\n â”Š12â”Š11â”Šimport { Users } from './users.provider';\n+â”Š  â”Š12â”Šimport { Auth } from './auth.provider';\n â”Š13â”Š13â”Š\n â”Š14â”Š14â”Šconst typeDefs = gql`\n â”Š15â”Š15â”Š  type User {\n```\n```diff\n@@ -36,10 +36,12 @@\n â”Š36â”Š36â”Š\n â”Š37â”Š37â”Šconst resolvers: Resolvers = {\n â”Š38â”Š38â”Š  Query: {\n-â”Š39â”Š  â”Š    me(root, args, { currentUser }) {\n-â”Š40â”Š  â”Š      return currentUser || null;\n+â”Š  â”Š39â”Š    me(root, args, { injector }) {\n+â”Š  â”Š40â”Š      return injector.get(Auth).currentUser();\n â”Š41â”Š41â”Š    },\n-â”Š42â”Š  â”Š    async users(root, args, { currentUser, injector }) {\n+â”Š  â”Š42â”Š    async users(root, args, { injector }) {\n+â”Š  â”Š43â”Š      const currentUser = await injector.get(Auth).currentUser();\n+â”Š  â”Š44â”Š\n â”Š43â”Š45â”Š      if (!currentUser) return [];\n â”Š44â”Š46â”Š\n â”Š45â”Š47â”Š      return injector.get(Users).findAllExcept(currentUser.id);\n```\n```diff\n@@ -100,33 +102,5 @@\n â”Š100â”Š102â”Š  typeDefs,\n â”Š101â”Š103â”Š  resolvers,\n â”Š102â”Š104â”Š  imports: () => [commonModule],\n-â”Š103â”Š   â”Š  providers: () => [Users],\n-â”Š104â”Š   â”Š  async context(session) {\n-â”Š105â”Š   â”Š    let currentUser;\n-â”Š106â”Š   â”Š\n-â”Š107â”Š   â”Š    // Access the request object\n-â”Š108â”Š   â”Š    let req = session.connection\n-â”Š109â”Š   â”Š      ? session.connection.context.request\n-â”Š110â”Š   â”Š      : session.req;\n-â”Š111â”Š   â”Š\n-â”Š112â”Š   â”Š    // It's subscription\n-â”Š113â”Š   â”Š    if (session.connection) {\n-â”Š114â”Š   â”Š      req.cookies = cookie.parse(req.headers.cookie || '');\n-â”Š115â”Š   â”Š    }\n-â”Š116â”Š   â”Š\n-â”Š117â”Š   â”Š    if (req.cookies.authToken) {\n-â”Š118â”Š   â”Š      const username = jwt.verify(req.cookies.authToken, secret) as string;\n-â”Š119â”Š   â”Š\n-â”Š120â”Š   â”Š      if (username) {\n-â”Š121â”Š   â”Š        const { rows } = await pool.query(\n-â”Š122â”Š   â”Š          sql`SELECT * FROM users WHERE username = ${username}`\n-â”Š123â”Š   â”Š        );\n-â”Š124â”Š   â”Š        currentUser = rows[0];\n-â”Š125â”Š   â”Š      }\n-â”Š126â”Š   â”Š    }\n-â”Š127â”Š   â”Š\n-â”Š128â”Š   â”Š    return {\n-â”Š129â”Š   â”Š      currentUser,\n-â”Š130â”Š   â”Š    };\n-â”Š131â”Š   â”Š  },\n+â”Š   â”Š105â”Š  providers: () => [Users, Auth],\n â”Š132â”Š106â”Š});\n```\n\n[}]: #\n\nNow let's use the Auth service in Chats:\n\n[{]: <helper> (diffStep \"13.20\" files=\"modules/chats/index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.20: Implement Auth provider with currentUser method](https://github.com/Urigo/WhatsApp-Clone-Server/commit/aaa3e5061eb0e2ca2f18a84c2618193ebefe7767)\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -7,6 +7,7 @@\n â”Š 7â”Š 7â”Šimport { Resolvers } from '../../types/graphql';\n â”Š 8â”Š 8â”Šimport { UnsplashApi } from './unsplash.api';\n â”Š 9â”Š 9â”Šimport { Users } from './../users/users.provider';\n+â”Š  â”Š10â”Šimport { Auth } from './../users/auth.provider';\n â”Š10â”Š11â”Šimport { Chats } from './chats.provider';\n â”Š11â”Š12â”Šimport { PubSub } from '../common/pubsub.provider';\n â”Š12â”Š13â”Š\n```\n```diff\n@@ -69,13 +70,16 @@\n â”Š69â”Š70â”Š      });\n â”Š70â”Š71â”Š    },\n â”Š71â”Š72â”Š\n-â”Š72â”Š  â”Š    isMine(message, args, { currentUser }) {\n-â”Š73â”Š  â”Š      return message.sender_user_id === currentUser.id;\n+â”Š  â”Š73â”Š    async isMine(message, args, { injector }) {\n+â”Š  â”Š74â”Š      const currentUser = await injector.get(Auth).currentUser();\n+â”Š  â”Š75â”Š      return message.sender_user_id === currentUser!.id;\n â”Š74â”Š76â”Š    },\n â”Š75â”Š77â”Š  },\n â”Š76â”Š78â”Š\n â”Š77â”Š79â”Š  Chat: {\n-â”Š78â”Š  â”Š    async name(chat, args, { currentUser, injector }) {\n+â”Š  â”Š80â”Š    async name(chat, args, { injector }) {\n+â”Š  â”Š81â”Š      const currentUser = await injector.get(Auth).currentUser();\n+â”Š  â”Š82â”Š\n â”Š79â”Š83â”Š      if (!currentUser) return null;\n â”Š80â”Š84â”Š\n â”Š81â”Š85â”Š      const participant = await injector.get(Chats).firstRecipient({\n```\n```diff\n@@ -86,7 +90,9 @@\n â”Š86â”Š90â”Š      return participant ? participant.name : null;\n â”Š87â”Š91â”Š    },\n â”Š88â”Š92â”Š\n-â”Š89â”Š  â”Š    async picture(chat, args, { currentUser, db, injector }) {\n+â”Š  â”Š93â”Š    async picture(chat, args, { injector }) {\n+â”Š  â”Š94â”Š      const currentUser = await injector.get(Auth).currentUser();\n+â”Š  â”Š95â”Š\n â”Š90â”Š96â”Š      if (!currentUser) return null;\n â”Š91â”Š97â”Š\n â”Š92â”Š98â”Š      const participant = await injector.get(Chats).firstRecipient({\n```\n```diff\n@@ -113,13 +119,17 @@\n â”Š113â”Š119â”Š  },\n â”Š114â”Š120â”Š\n â”Š115â”Š121â”Š  Query: {\n-â”Š116â”Š   â”Š    async chats(root, args, { currentUser, injector }) {\n+â”Š   â”Š122â”Š    async chats(root, args, { injector }) {\n+â”Š   â”Š123â”Š      const currentUser = await injector.get(Auth).currentUser();\n+â”Š   â”Š124â”Š\n â”Š117â”Š125â”Š      if (!currentUser) return [];\n â”Š118â”Š126â”Š\n â”Š119â”Š127â”Š      return injector.get(Chats).findChatsByUser(currentUser.id);\n â”Š120â”Š128â”Š    },\n â”Š121â”Š129â”Š\n-â”Š122â”Š   â”Š    async chat(root, { chatId }, { currentUser, injector }) {\n+â”Š   â”Š130â”Š    async chat(root, { chatId }, { injector }) {\n+â”Š   â”Š131â”Š      const currentUser = await injector.get(Auth).currentUser();\n+â”Š   â”Š132â”Š\n â”Š123â”Š133â”Š      if (!currentUser) return null;\n â”Š124â”Š134â”Š\n â”Š125â”Š135â”Š      return injector\n```\n```diff\n@@ -129,7 +139,9 @@\n â”Š129â”Š139â”Š  },\n â”Š130â”Š140â”Š\n â”Š131â”Š141â”Š  Mutation: {\n-â”Š132â”Š   â”Š    async addMessage(root, { chatId, content }, { currentUser, injector }) {\n+â”Š   â”Š142â”Š    async addMessage(root, { chatId, content }, { injector }) {\n+â”Š   â”Š143â”Š      const currentUser = await injector.get(Auth).currentUser();\n+â”Š   â”Š144â”Š\n â”Š133â”Š145â”Š      if (!currentUser) return null;\n â”Š134â”Š146â”Š\n â”Š135â”Š147â”Š      return injector\n```\n```diff\n@@ -137,7 +149,9 @@\n â”Š137â”Š149â”Š        .addMessage({ chatId, content, userId: currentUser.id });\n â”Š138â”Š150â”Š    },\n â”Š139â”Š151â”Š\n-â”Š140â”Š   â”Š    async addChat(root, { recipientId }, { currentUser, injector }) {\n+â”Š   â”Š152â”Š    async addChat(root, { recipientId }, { injector }) {\n+â”Š   â”Š153â”Š      const currentUser = await injector.get(Auth).currentUser();\n+â”Š   â”Š154â”Š\n â”Š141â”Š155â”Š      if (!currentUser) return null;\n â”Š142â”Š156â”Š\n â”Š143â”Š157â”Š      return injector\n```\n```diff\n@@ -145,7 +159,9 @@\n â”Š145â”Š159â”Š        .addChat({ recipientId, userId: currentUser.id });\n â”Š146â”Š160â”Š    },\n â”Š147â”Š161â”Š\n-â”Š148â”Š   â”Š    async removeChat(root, { chatId }, { currentUser, injector }) {\n+â”Š   â”Š162â”Š    async removeChat(root, { chatId }, { injector }) {\n+â”Š   â”Š163â”Š      const currentUser = await injector.get(Auth).currentUser();\n+â”Š   â”Š164â”Š\n â”Š149â”Š165â”Š      if (!currentUser) return null;\n â”Š150â”Š166â”Š\n â”Š151â”Š167â”Š      return injector.get(Chats).removeChat({ chatId, userId: currentUser.id });\n```\n```diff\n@@ -160,8 +176,10 @@\n â”Š160â”Š176â”Š        async (\n â”Š161â”Š177â”Š          { messageAdded }: { messageAdded: Message },\n â”Š162â”Š178â”Š          args,\n-â”Š163â”Š   â”Š          { currentUser, injector }\n+â”Š   â”Š179â”Š          { injector }\n â”Š164â”Š180â”Š        ) => {\n+â”Š   â”Š181â”Š          const currentUser = await injector.get(Auth).currentUser();\n+â”Š   â”Š182â”Š\n â”Š165â”Š183â”Š          if (!currentUser) return false;\n â”Š166â”Š184â”Š\n â”Š167â”Š185â”Š          return injector.get(Chats).isParticipant({\n```\n```diff\n@@ -176,11 +194,9 @@\n â”Š176â”Š194â”Š      subscribe: withFilter(\n â”Š177â”Š195â”Š        (root, args, { injector }) =>\n â”Š178â”Š196â”Š          injector.get(PubSub).asyncIterator('chatAdded'),\n-â”Š179â”Š   â”Š        async (\n-â”Š180â”Š   â”Š          { chatAdded }: { chatAdded: Chat },\n-â”Š181â”Š   â”Š          args,\n-â”Š182â”Š   â”Š          { currentUser, injector }\n-â”Š183â”Š   â”Š        ) => {\n+â”Š   â”Š197â”Š        async ({ chatAdded }: { chatAdded: Chat }, args, { injector }) => {\n+â”Š   â”Š198â”Š          const currentUser = await injector.get(Auth).currentUser();\n+â”Š   â”Š199â”Š\n â”Š184â”Š200â”Š          if (!currentUser) return false;\n â”Š185â”Š201â”Š\n â”Š186â”Š202â”Š          return injector.get(Chats).isParticipant({\n```\n```diff\n@@ -195,11 +211,9 @@\n â”Š195â”Š211â”Š      subscribe: withFilter(\n â”Š196â”Š212â”Š        (root, args, { injector }) =>\n â”Š197â”Š213â”Š          injector.get(PubSub).asyncIterator('chatRemoved'),\n-â”Š198â”Š   â”Š        async (\n-â”Š199â”Š   â”Š          { targetChat }: { targetChat: Chat },\n-â”Š200â”Š   â”Š          args,\n-â”Š201â”Š   â”Š          { currentUser, injector }\n-â”Š202â”Š   â”Š        ) => {\n+â”Š   â”Š214â”Š        async ({ targetChat }: { targetChat: Chat }, args, { injector }) => {\n+â”Š   â”Š215â”Š          const currentUser = await injector.get(Auth).currentUser();\n+â”Š   â”Š216â”Š\n â”Š203â”Š217â”Š          if (!currentUser) return false;\n â”Š204â”Š218â”Š\n â”Š205â”Š219â”Š          return injector.get(Chats).isParticipant({\n```\n\n[}]: #\n\nBecause we no longer need `db` instance in the context, let's remove it:\n\n[{]: <helper> (diffStep \"13.21\" module=\"server\")\n\n#### [__Server__ Step 13.21: Remove db from context](https://github.com/Urigo/WhatsApp-Clone-Server/commit/f6d4394c83a6acff100b4d269f1aadbf63f13979)\n\n##### Changed context.ts\n```diff\n@@ -1,8 +1,6 @@\n â”Š1â”Š1â”Šimport { ModuleContext } from '@graphql-modules/core';\n â”Š2â”Š2â”Šimport { Response } from 'express';\n-â”Š3â”Š â”Šimport { PoolClient } from 'pg';\n â”Š4â”Š3â”Š\n â”Š5â”Š4â”Šexport type MyContext = {\n â”Š6â”Š5â”Š  res: Response;\n-â”Š7â”Š â”Š  db: PoolClient;\n â”Š8â”Š6â”Š} & ModuleContext;\n```\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -1,9 +1,8 @@\n â”Š1â”Š1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š2â”Š2â”Šimport { gql, withFilter } from 'apollo-server-express';\n-â”Š3â”Š â”Šimport sql from 'sql-template-strings';\n â”Š4â”Š3â”Šimport commonModule from '../common';\n â”Š5â”Š4â”Šimport usersModule from '../users';\n-â”Š6â”Š â”Šimport { Message, Chat, pool } from '../../db';\n+â”Š â”Š5â”Šimport { Message, Chat } from '../../db';\n â”Š7â”Š6â”Šimport { Resolvers } from '../../types/graphql';\n â”Š8â”Š7â”Šimport { UnsplashApi } from './unsplash.api';\n â”Š9â”Š8â”Šimport { Users } from './../users/users.provider';\n```\n\n##### Changed modules&#x2F;common&#x2F;index.ts\n```diff\n@@ -54,16 +54,9 @@\n â”Š54â”Š54â”Š    },\n â”Š55â”Š55â”Š    Database,\n â”Š56â”Š56â”Š  ],\n-â”Š57â”Š  â”Š  async context({ res, connection }) {\n-â”Š58â”Š  â”Š    let db;\n-â”Š59â”Š  â”Š\n-â”Š60â”Š  â”Š    if (!connection) {\n-â”Š61â”Š  â”Š      db = await pool.connect();\n-â”Š62â”Š  â”Š    }\n-â”Š63â”Š  â”Š\n+â”Š  â”Š57â”Š  async context({ res }) {\n â”Š64â”Š58â”Š    return {\n â”Š65â”Š59â”Š      res,\n-â”Š66â”Š  â”Š      db,\n â”Š67â”Š60â”Š    };\n â”Š68â”Š61â”Š  },\n â”Š69â”Š62â”Š});\n```\n\n##### Changed modules&#x2F;users&#x2F;index.ts\n```diff\n@@ -1,11 +1,9 @@\n â”Š 1â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š 2â”Š 2â”Šimport { gql } from 'apollo-server-express';\n-â”Š 3â”Š  â”Šimport sql from 'sql-template-strings';\n â”Š 4â”Š 3â”Šimport bcrypt from 'bcrypt';\n â”Š 5â”Š 4â”Šimport jwt from 'jsonwebtoken';\n â”Š 6â”Š 5â”Šimport commonModule from '../common';\n â”Š 7â”Š 6â”Šimport { secret, expiration } from '../../env';\n-â”Š 8â”Š  â”Šimport { pool } from '../../db';\n â”Š 9â”Š 7â”Šimport { validateLength, validatePassword } from '../../validators';\n â”Š10â”Š 8â”Šimport { Resolvers } from '../../types/graphql';\n â”Š11â”Š 9â”Šimport { Users } from './users.provider';\n```\n\n[}]: #\n\nBesides the `currentUser` method we're going to have two more, one to sign in and the other to sign up:\n\n[{]: <helper> (diffStep \"13.22\" module=\"server\")\n\n#### [__Server__ Step 13.22: Move signUp logic to Auth provider](https://github.com/Urigo/WhatsApp-Clone-Server/commit/2c7c596a5890bff6d751e46317cc907835b14467)\n\n##### Changed modules&#x2F;users&#x2F;auth.provider.ts\n```diff\n@@ -2,6 +2,7 @@\n â”Š2â”Š2â”Šimport { ModuleSessionInfo } from '@graphql-modules/core';\n â”Š3â”Š3â”Šimport jwt from 'jsonwebtoken';\n â”Š4â”Š4â”Šimport { secret } from '../../env';\n+â”Š â”Š5â”Šimport { validateLength, validatePassword } from '../../validators';\n â”Š5â”Š6â”Šimport { Users } from './users.provider';\n â”Š6â”Š7â”Šimport { User } from '../../db';\n â”Š7â”Š8â”Š\n```\n```diff\n@@ -16,6 +17,38 @@\n â”Š16â”Š17â”Š    return this.module.session.req || this.module.session.request;\n â”Š17â”Š18â”Š  }\n â”Š18â”Š19â”Š\n+â”Š  â”Š20â”Š  async signUp({\n+â”Š  â”Š21â”Š    name,\n+â”Š  â”Š22â”Š    password,\n+â”Š  â”Š23â”Š    passwordConfirm,\n+â”Š  â”Š24â”Š    username,\n+â”Š  â”Š25â”Š  }: {\n+â”Š  â”Š26â”Š    name: string;\n+â”Š  â”Š27â”Š    password: string;\n+â”Š  â”Š28â”Š    passwordConfirm: string;\n+â”Š  â”Š29â”Š    username: string;\n+â”Š  â”Š30â”Š  }) {\n+â”Š  â”Š31â”Š    validateLength('req.name', name, 3, 50);\n+â”Š  â”Š32â”Š    validateLength('req.username', username, 3, 18);\n+â”Š  â”Š33â”Š    validatePassword('req.password', password);\n+â”Š  â”Š34â”Š\n+â”Š  â”Š35â”Š    if (password !== passwordConfirm) {\n+â”Š  â”Š36â”Š      throw Error(\"req.password and req.passwordConfirm don't match\");\n+â”Š  â”Š37â”Š    }\n+â”Š  â”Š38â”Š\n+â”Š  â”Š39â”Š    const existingUser = await this.users.findByUsername(username);\n+â”Š  â”Š40â”Š\n+â”Š  â”Š41â”Š    if (existingUser) {\n+â”Š  â”Š42â”Š      throw Error('username already exists');\n+â”Š  â”Š43â”Š    }\n+â”Š  â”Š44â”Š\n+â”Š  â”Š45â”Š    return this.users.newUser({\n+â”Š  â”Š46â”Š      username,\n+â”Š  â”Š47â”Š      name,\n+â”Š  â”Š48â”Š      password,\n+â”Š  â”Š49â”Š    });\n+â”Š  â”Š50â”Š  }\n+â”Š  â”Š51â”Š\n â”Š19â”Š52â”Š  async currentUser(): Promise<User | null> {\n â”Š20â”Š53â”Š    if (this.req.cookies.authToken) {\n â”Š21â”Š54â”Š      const username = jwt.verify(this.req.cookies.authToken, secret) as string;\n```\n\n##### Changed modules&#x2F;users&#x2F;index.ts\n```diff\n@@ -4,7 +4,6 @@\n â”Š 4â”Š 4â”Šimport jwt from 'jsonwebtoken';\n â”Š 5â”Š 5â”Šimport commonModule from '../common';\n â”Š 6â”Š 6â”Šimport { secret, expiration } from '../../env';\n-â”Š 7â”Š  â”Šimport { validateLength, validatePassword } from '../../validators';\n â”Š 8â”Š 7â”Šimport { Resolvers } from '../../types/graphql';\n â”Š 9â”Š 8â”Šimport { Users } from './users.provider';\n â”Š10â”Š 9â”Šimport { Auth } from './auth.provider';\n```\n```diff\n@@ -71,26 +70,9 @@\n â”Š71â”Š70â”Š      { name, username, password, passwordConfirm },\n â”Š72â”Š71â”Š      { injector }\n â”Š73â”Š72â”Š    ) {\n-â”Š74â”Š  â”Š      validateLength('req.name', name, 3, 50);\n-â”Š75â”Š  â”Š      validateLength('req.username', username, 3, 18);\n-â”Š76â”Š  â”Š      validatePassword('req.password', password);\n-â”Š77â”Š  â”Š\n-â”Š78â”Š  â”Š      if (password !== passwordConfirm) {\n-â”Š79â”Š  â”Š        throw Error(\"req.password and req.passwordConfirm don't match\");\n-â”Š80â”Š  â”Š      }\n-â”Š81â”Š  â”Š\n-â”Š82â”Š  â”Š      const existingUser = await injector.get(Users).findByUsername(username);\n-â”Š83â”Š  â”Š      if (existingUser) {\n-â”Š84â”Š  â”Š        throw Error('username already exists');\n-â”Š85â”Š  â”Š      }\n-â”Š86â”Š  â”Š\n-â”Š87â”Š  â”Š      const createdUser = await injector.get(Users).newUser({\n-â”Š88â”Š  â”Š        username,\n-â”Š89â”Š  â”Š        password,\n-â”Š90â”Š  â”Š        name,\n-â”Š91â”Š  â”Š      });\n-â”Š92â”Š  â”Š\n-â”Š93â”Š  â”Š      return createdUser;\n+â”Š  â”Š73â”Š      return injector\n+â”Š  â”Š74â”Š        .get(Auth)\n+â”Š  â”Š75â”Š        .signUp({ name, username, password, passwordConfirm });\n â”Š94â”Š76â”Š    },\n â”Š95â”Š77â”Š  },\n â”Š96â”Š78â”Š};\n```\n\n[}]: #\n[{]: <helper> (diffStep \"13.23\" module=\"server\")\n\n#### [__Server__ Step 13.23: Move signIn logic to Auth provider](https://github.com/Urigo/WhatsApp-Clone-Server/commit/c214138829460e0327907ffafcae76a8421a27aa)\n\n##### Changed context.ts\n```diff\n@@ -1,6 +1,3 @@\n â”Š1â”Š1â”Šimport { ModuleContext } from '@graphql-modules/core';\n-â”Š2â”Š â”Šimport { Response } from 'express';\n â”Š3â”Š2â”Š\n-â”Š4â”Š â”Šexport type MyContext = {\n-â”Š5â”Š â”Š  res: Response;\n-â”Š6â”Š â”Š} & ModuleContext;\n+â”Š â”Š3â”Šexport type MyContext = ModuleContext;\n```\n\n##### Changed modules&#x2F;common&#x2F;index.ts\n```diff\n@@ -54,9 +54,4 @@\n â”Š54â”Š54â”Š    },\n â”Š55â”Š55â”Š    Database,\n â”Š56â”Š56â”Š  ],\n-â”Š57â”Š  â”Š  async context({ res }) {\n-â”Š58â”Š  â”Š    return {\n-â”Š59â”Š  â”Š      res,\n-â”Š60â”Š  â”Š    };\n-â”Š61â”Š  â”Š  },\n â”Š62â”Š57â”Š});\n```\n\n##### Changed modules&#x2F;users&#x2F;auth.provider.ts\n```diff\n@@ -1,7 +1,9 @@\n â”Š1â”Š1â”Šimport { Injectable, Inject, ProviderScope } from '@graphql-modules/di';\n â”Š2â”Š2â”Šimport { ModuleSessionInfo } from '@graphql-modules/core';\n+â”Š â”Š3â”Šimport { Response } from 'express';\n+â”Š â”Š4â”Šimport bcrypt from 'bcrypt';\n â”Š3â”Š5â”Šimport jwt from 'jsonwebtoken';\n-â”Š4â”Š â”Šimport { secret } from '../../env';\n+â”Š â”Š6â”Šimport { secret, expiration } from '../../env';\n â”Š5â”Š7â”Šimport { validateLength, validatePassword } from '../../validators';\n â”Š6â”Š8â”Šimport { Users } from './users.provider';\n â”Š7â”Š9â”Šimport { User } from '../../db';\n```\n```diff\n@@ -17,6 +19,30 @@\n â”Š17â”Š19â”Š    return this.module.session.req || this.module.session.request;\n â”Š18â”Š20â”Š  }\n â”Š19â”Š21â”Š\n+â”Š  â”Š22â”Š  private get res(): Response {\n+â”Š  â”Š23â”Š    return this.module.session.res;\n+â”Š  â”Š24â”Š  }\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Š  async signIn({ username, password }: { username: string; password: string }) {\n+â”Š  â”Š27â”Š    const user = await this.users.findByUsername(username);\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š    if (!user) {\n+â”Š  â”Š30â”Š      throw new Error('user not found');\n+â”Š  â”Š31â”Š    }\n+â”Š  â”Š32â”Š\n+â”Š  â”Š33â”Š    const passwordsMatch = bcrypt.compareSync(password, user.password);\n+â”Š  â”Š34â”Š\n+â”Š  â”Š35â”Š    if (!passwordsMatch) {\n+â”Š  â”Š36â”Š      throw new Error('password is incorrect');\n+â”Š  â”Š37â”Š    }\n+â”Š  â”Š38â”Š\n+â”Š  â”Š39â”Š    const authToken = jwt.sign(username, secret);\n+â”Š  â”Š40â”Š\n+â”Š  â”Š41â”Š    this.res.cookie('authToken', authToken, { maxAge: expiration });\n+â”Š  â”Š42â”Š\n+â”Š  â”Š43â”Š    return user;\n+â”Š  â”Š44â”Š  }\n+â”Š  â”Š45â”Š\n â”Š20â”Š46â”Š  async signUp({\n â”Š21â”Š47â”Š    name,\n â”Š22â”Š48â”Š    password,\n```\n\n##### Changed modules&#x2F;users&#x2F;index.ts\n```diff\n@@ -1,9 +1,6 @@\n â”Š1â”Š1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š2â”Š2â”Šimport { gql } from 'apollo-server-express';\n-â”Š3â”Š â”Šimport bcrypt from 'bcrypt';\n-â”Š4â”Š â”Šimport jwt from 'jsonwebtoken';\n â”Š5â”Š3â”Šimport commonModule from '../common';\n-â”Š6â”Š â”Šimport { secret, expiration } from '../../env';\n â”Š7â”Š4â”Šimport { Resolvers } from '../../types/graphql';\n â”Š8â”Š5â”Šimport { Users } from './users.provider';\n â”Š9â”Š6â”Šimport { Auth } from './auth.provider';\n```\n```diff\n@@ -45,24 +42,8 @@\n â”Š45â”Š42â”Š    },\n â”Š46â”Š43â”Š  },\n â”Š47â”Š44â”Š  Mutation: {\n-â”Š48â”Š  â”Š    async signIn(root, { username, password }, { injector, res }) {\n-â”Š49â”Š  â”Š      const user = await injector.get(Users).findByUsername(username);\n-â”Š50â”Š  â”Š\n-â”Š51â”Š  â”Š      if (!user) {\n-â”Š52â”Š  â”Š        throw new Error('user not found');\n-â”Š53â”Š  â”Š      }\n-â”Š54â”Š  â”Š\n-â”Š55â”Š  â”Š      const passwordsMatch = bcrypt.compareSync(password, user.password);\n-â”Š56â”Š  â”Š\n-â”Š57â”Š  â”Š      if (!passwordsMatch) {\n-â”Š58â”Š  â”Š        throw new Error('password is incorrect');\n-â”Š59â”Š  â”Š      }\n-â”Š60â”Š  â”Š\n-â”Š61â”Š  â”Š      const authToken = jwt.sign(username, secret);\n-â”Š62â”Š  â”Š\n-â”Š63â”Š  â”Š      res.cookie('authToken', authToken, { maxAge: expiration });\n-â”Š64â”Š  â”Š\n-â”Š65â”Š  â”Š      return user;\n+â”Š  â”Š45â”Š    async signIn(root, { username, password }, { injector }) {\n+â”Š  â”Š46â”Š      return injector.get(Auth).signIn({ username, password });\n â”Š66â”Š47â”Š    },\n â”Š67â”Š48â”Š\n â”Š68â”Š49â”Š    async signUp(\n```\n\n[}]: #\n\n#### Exposing server instance\n\nIf you would run `yarn test` right now, you will see a lot of errors, every test will fail. That's because we changed our setup but we didn't adjusted tests.\n\nWe're going to change the setup of tests as well so whenever we do something on server it won't affect them. Instead of exposing schema and context as we did before, we're going to base the tests on a ready to use ApolloServer instance.\n\nIn order to achieve it, we need to separate ApolloServer from other server related logic.\n\n[{]: <helper> (diffStep \"13.24\" module=\"server\")\n\n#### [__Server__ Step 13.24: Move ApolloServer and RootModule into a separate file](https://github.com/Urigo/WhatsApp-Clone-Server/commit/3ce9203e3f501924fb47251bdeadbaed7ea11db2)\n\n##### Changed index.ts\n```diff\n@@ -1,35 +1,7 @@\n-â”Š 1â”Š  â”Šimport 'reflect-metadata';\n-â”Š 2â”Š  â”Šimport { ApolloServer } from 'apollo-server-express';\n-â”Š 3â”Š  â”Šimport { GraphQLModule } from '@graphql-modules/core';\n-â”Š 4â”Š  â”Šimport cookie from 'cookie';\n â”Š 5â”Š 1â”Šimport http from 'http';\n â”Š 6â”Š 2â”Šimport { app } from './app';\n â”Š 7â”Š 3â”Šimport { origin, port } from './env';\n-â”Š 8â”Š  â”Š\n-â”Š 9â”Š  â”Šimport usersModule from './modules/users';\n-â”Š10â”Š  â”Šimport chatsModule from './modules/chats';\n-â”Š11â”Š  â”Š\n-â”Š12â”Š  â”Šexport const rootModule = new GraphQLModule({\n-â”Š13â”Š  â”Š  name: 'root',\n-â”Š14â”Š  â”Š  imports: [usersModule, chatsModule],\n-â”Š15â”Š  â”Š});\n-â”Š16â”Š  â”Š\n-â”Š17â”Š  â”Šconst server = new ApolloServer({\n-â”Š18â”Š  â”Š  schema: rootModule.schema,\n-â”Š19â”Š  â”Š  context: (session: any) => {\n-â”Š20â”Š  â”Š    if (session.connection) {\n-â”Š21â”Š  â”Š      const req = session.connection.context.session.request;\n-â”Š22â”Š  â”Š      const cookies = req.headers.cookie;\n-â”Š23â”Š  â”Š\n-â”Š24â”Š  â”Š      if (cookies) {\n-â”Š25â”Š  â”Š        req.cookies = cookie.parse(cookies);\n-â”Š26â”Š  â”Š      }\n-â”Š27â”Š  â”Š    }\n-â”Š28â”Š  â”Š\n-â”Š29â”Š  â”Š    return rootModule.context(session);\n-â”Š30â”Š  â”Š  },\n-â”Š31â”Š  â”Š  subscriptions: rootModule.subscriptions,\n-â”Š32â”Š  â”Š});\n+â”Š  â”Š 4â”Šimport { server } from './server';\n â”Š33â”Š 5â”Š\n â”Š34â”Š 6â”Šserver.applyMiddleware({\n â”Š35â”Š 7â”Š  app,\n```\n\n##### Added server.ts\n```diff\n@@ -0,0 +1,29 @@\n+â”Š  â”Š 1â”Šimport 'reflect-metadata';\n+â”Š  â”Š 2â”Šimport { ApolloServer } from 'apollo-server-express';\n+â”Š  â”Š 3â”Šimport { GraphQLModule } from '@graphql-modules/core';\n+â”Š  â”Š 4â”Šimport cookie from 'cookie';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šimport usersModule from './modules/users';\n+â”Š  â”Š 7â”Šimport chatsModule from './modules/chats';\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Šexport const rootModule = new GraphQLModule({\n+â”Š  â”Š10â”Š  name: 'root',\n+â”Š  â”Š11â”Š  imports: [usersModule, chatsModule],\n+â”Š  â”Š12â”Š});\n+â”Š  â”Š13â”Š\n+â”Š  â”Š14â”Šconst server = new ApolloServer({\n+â”Š  â”Š15â”Š  schema: rootModule.schema,\n+â”Š  â”Š16â”Š  context: (session: any) => {\n+â”Š  â”Š17â”Š    if (session.connection) {\n+â”Š  â”Š18â”Š      const req = session.connection.context.session.request;\n+â”Š  â”Š19â”Š      const cookies = req.headers.cookie;\n+â”Š  â”Š20â”Š\n+â”Š  â”Š21â”Š      if (cookies) {\n+â”Š  â”Š22â”Š        req.cookies = cookie.parse(cookies);\n+â”Š  â”Š23â”Š      }\n+â”Š  â”Š24â”Š    }\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Š    return rootModule.context(session);\n+â”Š  â”Š27â”Š  },\n+â”Š  â”Š28â”Š  subscriptions: rootModule.subscriptions,\n+â”Š  â”Š29â”Š});\n```\n\n[}]: #\n[{]: <helper> (diffStep \"13.25\" module=\"server\")\n\n#### [__Server__ Step 13.25: Export server instance](https://github.com/Urigo/WhatsApp-Clone-Server/commit/8648ab8ab1c4a331441b51eccd029bea6e5f12c5)\n\n##### Changed server.ts\n```diff\n@@ -11,7 +11,7 @@\n â”Š11â”Š11â”Š  imports: [usersModule, chatsModule],\n â”Š12â”Š12â”Š});\n â”Š13â”Š13â”Š\n-â”Š14â”Š  â”Šconst server = new ApolloServer({\n+â”Š  â”Š14â”Šexport const server = new ApolloServer({\n â”Š15â”Š15â”Š  schema: rootModule.schema,\n â”Š16â”Š16â”Š  context: (session: any) => {\n â”Š17â”Š17â”Š    if (session.connection) {\n```\n\n[}]: #\n\nThere's one thing that changed and might break our tests, this line fix it:\n\n[{]: <helper> (diffStep \"13.26\" module=\"server\")\n\n#### [__Server__ Step 13.26: Define mocked version of Auth provider](https://github.com/Urigo/WhatsApp-Clone-Server/commit/7c7cbb908f2cfb6799d712d4d9a6f3180c8a443a)\n\n##### Added tests&#x2F;mocks&#x2F;auth.provider.ts\n```diff\n@@ -0,0 +1,21 @@\n+â”Š  â”Š 1â”Šimport sql from 'sql-template-strings';\n+â”Š  â”Š 2â”Šimport { Auth } from './../../modules/users/auth.provider';\n+â”Š  â”Š 3â”Šimport usersModule from './../../modules/users';\n+â”Š  â”Š 4â”Šimport { pool } from '../../db';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šexport function mockAuth(userId: number) {\n+â”Š  â”Š 7â”Š  class AuthMock extends Auth {\n+â”Š  â”Š 8â”Š    async currentUser() {\n+â”Š  â”Š 9â”Š      const { rows } = await pool.query(\n+â”Š  â”Š10â”Š        sql`SELECT * FROM users WHERE id = ${userId}`\n+â”Š  â”Š11â”Š      );\n+â”Š  â”Š12â”Š      return rows[0];\n+â”Š  â”Š13â”Š    }\n+â”Š  â”Š14â”Š  }\n+â”Š  â”Š15â”Š\n+â”Š  â”Š16â”Š  usersModule.injector.provide({\n+â”Š  â”Š17â”Š    provide: Auth,\n+â”Š  â”Š18â”Š    useClass: AuthMock,\n+â”Š  â”Š19â”Š    overwrite: true,\n+â”Š  â”Š20â”Š  });\n+â”Š  â”Š21â”Š}\n```\n\n[}]: #\n\nRemember when I said about benefits of Dependency Injection? Here's one of them. We create a function that overwrites the `currentUser` method so it always returns a specific user.\n\n[{]: <helper> (diffStep \"13.27\" module=\"server\")\n\n#### [__Server__ Step 13.27: Adjust tests](https://github.com/Urigo/WhatsApp-Clone-Server/commit/5ab6838fe0b48933496c01e88fb3d2822d97f7fc)\n\n##### Changed tests&#x2F;mutations&#x2F;addChat.test.ts\n```diff\n@@ -1,28 +1,14 @@\n â”Š 1â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n-â”Š 2â”Š  â”Šimport { ApolloServer, PubSub, gql } from 'apollo-server-express';\n-â”Š 3â”Š  â”Šimport { rootModule } from '../../index';\n-â”Š 4â”Š  â”Šimport { resetDb, pool } from '../../db';\n-â”Š 5â”Š  â”Šimport sql from 'sql-template-strings';\n-â”Š 6â”Š  â”Šimport { MyContext } from '../../context';\n+â”Š  â”Š 2â”Šimport { gql } from 'apollo-server-express';\n+â”Š  â”Š 3â”Šimport { server } from '../../server';\n+â”Š  â”Š 4â”Šimport { resetDb } from '../../db';\n+â”Š  â”Š 5â”Šimport { mockAuth } from '../mocks/auth.provider';\n â”Š 7â”Š 6â”Š\n â”Š 8â”Š 7â”Šdescribe('Mutation.addChat', () => {\n â”Š 9â”Š 8â”Š  beforeEach(resetDb);\n â”Š10â”Š 9â”Š\n â”Š11â”Š10â”Š  it('creates a new chat between current user and specified recipient', async () => {\n-â”Š12â”Š  â”Š    const { rows } = await pool.query(sql`SELECT * FROM users WHERE id = 2`);\n-â”Š13â”Š  â”Š    const currentUser = rows[0];\n-â”Š14â”Š  â”Š    const server = new ApolloServer({\n-â”Š15â”Š  â”Š      schema: rootModule.schema,\n-â”Š16â”Š  â”Š      context: async () => ({\n-â”Š17â”Š  â”Š        pubsub: new PubSub(),\n-â”Š18â”Š  â”Š        currentUser,\n-â”Š19â”Š  â”Š        db: await pool.connect(),\n-â”Š20â”Š  â”Š      }),\n-â”Š21â”Š  â”Š      formatResponse: (res: any, { context }: { context: MyContext }) => {\n-â”Š22â”Š  â”Š        context.db.release();\n-â”Š23â”Š  â”Š        return res;\n-â”Š24â”Š  â”Š      },\n-â”Š25â”Š  â”Š    });\n+â”Š  â”Š11â”Š    mockAuth(2);\n â”Š26â”Š12â”Š\n â”Š27â”Š13â”Š    const { query, mutate } = createTestClient(server);\n â”Š28â”Š14â”Š\n```\n```diff\n@@ -66,20 +52,7 @@\n â”Š66â”Š52â”Š  });\n â”Š67â”Š53â”Š\n â”Š68â”Š54â”Š  it('returns the existing chat if so', async () => {\n-â”Š69â”Š  â”Š    const { rows } = await pool.query(sql`SELECT * FROM users WHERE id = 1`);\n-â”Š70â”Š  â”Š    const currentUser = rows[0];\n-â”Š71â”Š  â”Š    const server = new ApolloServer({\n-â”Š72â”Š  â”Š      schema: rootModule.schema,\n-â”Š73â”Š  â”Š      context: async () => ({\n-â”Š74â”Š  â”Š        pubsub: new PubSub(),\n-â”Š75â”Š  â”Š        currentUser,\n-â”Š76â”Š  â”Š        db: await pool.connect(),\n-â”Š77â”Š  â”Š      }),\n-â”Š78â”Š  â”Š      formatResponse: (res: any, { context }: { context: MyContext }) => {\n-â”Š79â”Š  â”Š        context.db.release();\n-â”Š80â”Š  â”Š        return res;\n-â”Š81â”Š  â”Š      },\n-â”Š82â”Š  â”Š    });\n+â”Š  â”Š55â”Š    mockAuth(1);\n â”Š83â”Š56â”Š\n â”Š84â”Š57â”Š    const { query, mutate } = createTestClient(server);\n â”Š85â”Š58â”Š\n```\n\n##### Changed tests&#x2F;mutations&#x2F;addMessage.test.ts\n```diff\n@@ -1,28 +1,14 @@\n â”Š 1â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n-â”Š 2â”Š  â”Šimport { ApolloServer, PubSub, gql } from 'apollo-server-express';\n-â”Š 3â”Š  â”Šimport { rootModule } from '../../index';\n-â”Š 4â”Š  â”Šimport { resetDb, pool } from '../../db';\n-â”Š 5â”Š  â”Šimport sql from 'sql-template-strings';\n-â”Š 6â”Š  â”Šimport { MyContext } from '../../context';\n+â”Š  â”Š 2â”Šimport { gql } from 'apollo-server-express';\n+â”Š  â”Š 3â”Šimport { server } from '../../server';\n+â”Š  â”Š 4â”Šimport { resetDb } from '../../db';\n+â”Š  â”Š 5â”Šimport { mockAuth } from '../mocks/auth.provider';\n â”Š 7â”Š 6â”Š\n â”Š 8â”Š 7â”Šdescribe('Mutation.addMessage', () => {\n â”Š 9â”Š 8â”Š  beforeEach(resetDb);\n â”Š10â”Š 9â”Š\n â”Š11â”Š10â”Š  it('should add message to specified chat', async () => {\n-â”Š12â”Š  â”Š    const { rows } = await pool.query(sql`SELECT * FROM users WHERE id = 1`);\n-â”Š13â”Š  â”Š    const currentUser = rows[0];\n-â”Š14â”Š  â”Š    const server = new ApolloServer({\n-â”Š15â”Š  â”Š      schema: rootModule.schema,\n-â”Š16â”Š  â”Š      context: async () => ({\n-â”Š17â”Š  â”Š        pubsub: new PubSub(),\n-â”Š18â”Š  â”Š        currentUser,\n-â”Š19â”Š  â”Š        db: await pool.connect(),\n-â”Š20â”Š  â”Š      }),\n-â”Š21â”Š  â”Š      formatResponse: (res: any, { context }: { context: MyContext }) => {\n-â”Š22â”Š  â”Š        context.db.release();\n-â”Š23â”Š  â”Š        return res;\n-â”Š24â”Š  â”Š      },\n-â”Š25â”Š  â”Š    });\n+â”Š  â”Š11â”Š    mockAuth(1);\n â”Š26â”Š12â”Š\n â”Š27â”Š13â”Š    const { query, mutate } = createTestClient(server);\n â”Š28â”Š14â”Š\n```\n\n##### Changed tests&#x2F;mutations&#x2F;removeChat.test.ts\n```diff\n@@ -1,28 +1,14 @@\n â”Š 1â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n-â”Š 2â”Š  â”Šimport { ApolloServer, PubSub, gql } from 'apollo-server-express';\n-â”Š 3â”Š  â”Šimport { rootModule } from '../../index';\n-â”Š 4â”Š  â”Šimport { resetDb, pool } from '../../db';\n-â”Š 5â”Š  â”Šimport sql from 'sql-template-strings';\n-â”Š 6â”Š  â”Šimport { MyContext } from '../../context';\n+â”Š  â”Š 2â”Šimport { gql } from 'apollo-server-express';\n+â”Š  â”Š 3â”Šimport { server } from '../../server';\n+â”Š  â”Š 4â”Šimport { resetDb } from '../../db';\n+â”Š  â”Š 5â”Šimport { mockAuth } from '../mocks/auth.provider';\n â”Š 7â”Š 6â”Š\n â”Š 8â”Š 7â”Šdescribe('Mutation.removeChat', () => {\n â”Š 9â”Š 8â”Š  beforeEach(resetDb);\n â”Š10â”Š 9â”Š\n â”Š11â”Š10â”Š  it('removes chat by id', async () => {\n-â”Š12â”Š  â”Š    const { rows } = await pool.query(sql`SELECT * FROM users WHERE id = 1`);\n-â”Š13â”Š  â”Š    const currentUser = rows[0];\n-â”Š14â”Š  â”Š    const server = new ApolloServer({\n-â”Š15â”Š  â”Š      schema: rootModule.schema,\n-â”Š16â”Š  â”Š      context: async () => ({\n-â”Š17â”Š  â”Š        pubsub: new PubSub(),\n-â”Š18â”Š  â”Š        currentUser,\n-â”Š19â”Š  â”Š        db: await pool.connect(),\n-â”Š20â”Š  â”Š      }),\n-â”Š21â”Š  â”Š      formatResponse: (res: any, { context }: { context: MyContext }) => {\n-â”Š22â”Š  â”Š        context.db.release();\n-â”Š23â”Š  â”Š        return res;\n-â”Š24â”Š  â”Š      },\n-â”Š25â”Š  â”Š    });\n+â”Š  â”Š11â”Š    mockAuth(1);\n â”Š26â”Š12â”Š\n â”Š27â”Š13â”Š    const { query, mutate } = createTestClient(server);\n â”Š28â”Š14â”Š\n```\n\n##### Changed tests&#x2F;queries&#x2F;getChat.test.ts\n```diff\n@@ -1,27 +1,14 @@\n â”Š 1â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n-â”Š 2â”Š  â”Šimport { ApolloServer, gql } from 'apollo-server-express';\n-â”Š 3â”Š  â”Šimport { rootModule } from '../../index';\n-â”Š 4â”Š  â”Šimport { poolm resetDb } from '../../db';\n-â”Š 5â”Š  â”Šimport sql from 'sql-template-strings';\n-â”Š 6â”Š  â”Šimport { MyContext } from '../../context';\n+â”Š  â”Š 2â”Šimport { gql } from 'apollo-server-express';\n+â”Š  â”Š 3â”Šimport { server } from '../../server';\n+â”Š  â”Š 4â”Šimport { resetDb } from '../../db';\n+â”Š  â”Š 5â”Šimport { mockAuth } from '../mocks/auth.provider';\n â”Š 7â”Š 6â”Š\n â”Š 8â”Š 7â”Šdescribe('Query.chat', () => {\n â”Š 9â”Š 8â”Š  beforeEach(resetDb);\n â”Š10â”Š 9â”Š\n â”Š11â”Š10â”Š  it('should fetch specified chat', async () => {\n-â”Š12â”Š  â”Š    const { rows } = await pool.query(sql`SELECT * FROM users WHERE id = 1`);\n-â”Š13â”Š  â”Š    const currentUser = rows[0];\n-â”Š14â”Š  â”Š    const server = new ApolloServer({\n-â”Š15â”Š  â”Š      schema: rootModule.schema,\n-â”Š16â”Š  â”Š      context: async () => ({\n-â”Š17â”Š  â”Š        currentUser,\n-â”Š18â”Š  â”Š        db: await pool.connect(),\n-â”Š19â”Š  â”Š      }),\n-â”Š20â”Š  â”Š      formatResponse: (res: any, { context }: { context: MyContext }) => {\n-â”Š21â”Š  â”Š        context.db.release();\n-â”Š22â”Š  â”Š        return res;\n-â”Š23â”Š  â”Š      },\n-â”Š24â”Š  â”Š    });\n+â”Š  â”Š11â”Š    mockAuth(1);\n â”Š25â”Š12â”Š\n â”Š26â”Š13â”Š    const { query } = createTestClient(server);\n â”Š27â”Š14â”Š\n```\n\n##### Changed tests&#x2F;queries&#x2F;getChats.test.ts\n```diff\n@@ -1,27 +1,14 @@\n â”Š 1â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n-â”Š 2â”Š  â”Šimport { ApolloServer, gql } from 'apollo-server-express';\n-â”Š 3â”Š  â”Šimport { rootModule } from '../../index';\n-â”Š 4â”Š  â”Šimport { pool, resetDb } from '../../db';\n-â”Š 5â”Š  â”Šimport sql from 'sql-template-strings';\n-â”Š 6â”Š  â”Šimport { MyContext } from '../../context';\n+â”Š  â”Š 2â”Šimport { gql } from 'apollo-server-express';\n+â”Š  â”Š 3â”Šimport { server } from '../../server';\n+â”Š  â”Š 4â”Šimport { resetDb } from '../../db';\n+â”Š  â”Š 5â”Šimport { mockAuth } from '../mocks/auth.provider';\n â”Š 7â”Š 6â”Š\n â”Š 8â”Š 7â”Šdescribe('Query.chats', () => {\n â”Š 9â”Š 8â”Š  beforeEach(resetDb);\n â”Š10â”Š 9â”Š\n â”Š11â”Š10â”Š  it('should fetch all chats', async () => {\n-â”Š12â”Š  â”Š    const { rows } = await pool.query(sql`SELECT * FROM users WHERE id = 1`);\n-â”Š13â”Š  â”Š    const currentUser = rows[0];\n-â”Š14â”Š  â”Š    const server = new ApolloServer({\n-â”Š15â”Š  â”Š      schema: rootModule.schema,\n-â”Š16â”Š  â”Š      context: async () => ({\n-â”Š17â”Š  â”Š        currentUser,\n-â”Š18â”Š  â”Š        db: await pool.connect(),\n-â”Š19â”Š  â”Š      }),\n-â”Š20â”Š  â”Š      formatResponse: (res: any, { context }: { context: MyContext }) => {\n-â”Š21â”Š  â”Š        context.db.release();\n-â”Š22â”Š  â”Š        return res;\n-â”Š23â”Š  â”Š      },\n-â”Š24â”Š  â”Š    });\n+â”Š  â”Š11â”Š    mockAuth(1);\n â”Š25â”Š12â”Š\n â”Š26â”Š13â”Š    const { query } = createTestClient(server);\n â”Š27â”Š14â”Š\n```\n\n##### Changed tests&#x2F;queries&#x2F;getMe.test.ts\n```diff\n@@ -1,25 +1,14 @@\n â”Š 1â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n-â”Š 2â”Š  â”Šimport { ApolloServer, gql } from 'apollo-server-express';\n-â”Š 3â”Š  â”Šimport { rootModule } from '../../index';\n-â”Š 4â”Š  â”Šimport { pool } from '../../db';\n-â”Š 5â”Š  â”Šimport sql from 'sql-template-strings';\n-â”Š 6â”Š  â”Šimport { MyContext } from '../../context';\n+â”Š  â”Š 2â”Šimport { gql } from 'apollo-server-express';\n+â”Š  â”Š 3â”Šimport { server } from '../../server';\n+â”Š  â”Š 4â”Šimport { resetDb } from '../../db';\n+â”Š  â”Š 5â”Šimport { mockAuth } from '../mocks/auth.provider';\n â”Š 7â”Š 6â”Š\n â”Š 8â”Š 7â”Šdescribe('Query.me', () => {\n+â”Š  â”Š 8â”Š  beforeEach(resetDb);\n+â”Š  â”Š 9â”Š\n â”Š 9â”Š10â”Š  it('should fetch current user', async () => {\n-â”Š10â”Š  â”Š    const { rows } = await pool.query(sql`SELECT * FROM users WHERE id = 1`);\n-â”Š11â”Š  â”Š    const currentUser = rows[0];\n-â”Š12â”Š  â”Š    const server = new ApolloServer({\n-â”Š13â”Š  â”Š      schema: rootModule.schema,\n-â”Š14â”Š  â”Š      context: async () => ({\n-â”Š15â”Š  â”Š        currentUser,\n-â”Š16â”Š  â”Š        db: await pool.connect(),\n-â”Š17â”Š  â”Š      }),\n-â”Š18â”Š  â”Š      formatResponse: (res: any, { context }: { context: MyContext }) => {\n-â”Š19â”Š  â”Š        context.db.release();\n-â”Š20â”Š  â”Š        return res;\n-â”Š21â”Š  â”Š      },\n-â”Š22â”Š  â”Š    });\n+â”Š  â”Š11â”Š    mockAuth(1);\n â”Š23â”Š12â”Š\n â”Š24â”Š13â”Š    const { query } = createTestClient(server);\n â”Š25â”Š14â”Š\n```\n\n##### Changed tests&#x2F;queries&#x2F;getUsers.test.ts\n```diff\n@@ -1,28 +1,14 @@\n â”Š 1â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n-â”Š 2â”Š  â”Šimport { ApolloServer, gql } from 'apollo-server-express';\n-â”Š 3â”Š  â”Šimport { rootModule } from '../../index';\n-â”Š 4â”Š  â”Šimport { pool } from '../../db';\n-â”Š 5â”Š  â”Šimport sql from 'sql-template-strings';\n-â”Š 6â”Š  â”Šimport { MyContext } from '../../context';\n+â”Š  â”Š 2â”Šimport { gql } from 'apollo-server-express';\n+â”Š  â”Š 3â”Šimport { server } from '../../server';\n+â”Š  â”Š 4â”Šimport { resetDb } from '../../db';\n+â”Š  â”Š 5â”Šimport { mockAuth } from '../mocks/auth.provider';\n â”Š 7â”Š 6â”Š\n â”Š 8â”Š 7â”Šdescribe('Query.getUsers', () => {\n+â”Š  â”Š 8â”Š  beforeEach(resetDb);\n+â”Š  â”Š 9â”Š\n â”Š 9â”Š10â”Š  it('should fetch all users except the one signed-in', async () => {\n-â”Š10â”Š  â”Š    const firstUserQuery = await pool.query(\n-â”Š11â”Š  â”Š      sql`SELECT * FROM users WHERE id = 1`\n-â”Š12â”Š  â”Š    );\n-â”Š13â”Š  â”Š    let currentUser = firstUserQuery.rows[0];\n-â”Š14â”Š  â”Š    const db = await pool.connect();\n-â”Š15â”Š  â”Š    const server = new ApolloServer({\n-â”Š16â”Š  â”Š      schema: rootModule.schema,\n-â”Š17â”Š  â”Š      context: async () => ({\n-â”Š18â”Š  â”Š        currentUser,\n-â”Š19â”Š  â”Š        db: await pool.connect(),\n-â”Š20â”Š  â”Š      }),\n-â”Š21â”Š  â”Š      formatResponse: (res: any, { context }: { context: MyContext }) => {\n-â”Š22â”Š  â”Š        context.db.release();\n-â”Š23â”Š  â”Š        return res;\n-â”Š24â”Š  â”Š      },\n-â”Š25â”Š  â”Š    });\n+â”Š  â”Š11â”Š    mockAuth(1);\n â”Š26â”Š12â”Š\n â”Š27â”Š13â”Š    const { query } = createTestClient(server);\n â”Š28â”Š14â”Š\n```\n```diff\n@@ -42,10 +28,7 @@\n â”Š42â”Š28â”Š    expect(res.errors).toBeUndefined();\n â”Š43â”Š29â”Š    expect(res.data).toMatchSnapshot();\n â”Š44â”Š30â”Š\n-â”Š45â”Š  â”Š    const secondUserQuery = await pool.query(\n-â”Š46â”Š  â”Š      sql`SELECT * FROM users WHERE id = '2'`\n-â”Š47â”Š  â”Š    );\n-â”Š48â”Š  â”Š    currentUser = secondUserQuery.rows[0];\n+â”Š  â”Š31â”Š    mockAuth(2);\n â”Š49â”Š32â”Š\n â”Š50â”Š33â”Š    res = await query({\n â”Š51â”Š34â”Š      query: gql`\n```\n\n[}]: #\n\nLet's now migrate all tests and see how easier it is now to manage those. Because we use ApolloServer's instance, we don't need to understand how it's implemented.\n\n[{]: <helper> (diffStep \"13.28\" module=\"server\")\n\n#### Step 13.28: NOT FOUND!\n\n[}]: #\n\n## Adjusting client\n\nWe still need to update `codegen.yml` in the client app because of the changes we introduced in this chapter:\n\n[{]: <helper> (diffStep \"14.1\" module=\"client\")\n\n#### [__Client__ Step 14.1: Adjust to GraphQL Modules](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/ea910ae0cbcffd95c8df782c6faa7053969d0c26)\n\n##### Changed codegen.yml\n```diff\n@@ -1,4 +1,4 @@\n-â”Š1â”Š â”Šschema: ../WhatsApp-Clone-Server/schema/typeDefs.graphql\n+â”Š â”Š1â”Šschema: ../WhatsApp-Clone-Server/modules/*/*.ts\n â”Š2â”Š2â”Šdocuments:\n â”Š3â”Š3â”Š  - ./src/components/**/*.tsx\n â”Š4â”Š4â”Š  - ./src/graphql/fragments/**/*.ts\n```\n\n[}]: #\n\n## Many ways to write GraphQL\n\nWeâ€™re going to discuss what are the possible options of building GraphQL API and why schema-first approach was our choice.\n\nThe main ingredient of a GraphQL API is, of course the schema. Itâ€™s built out of type definitions where each of them describes a piece of data, connections between them and how data is actually resolved.\n\nThe way we develop all of it changes the way we work with the API.\n\nWe could define two main approaches:\n  - schema-first\n  - resolver-first\n\nThe former means design comes before code, the latter vice-versa.\n\nIn schema-first development you start with SDL, resolvers and code go next. Schema is sort of a contract between teams and also between frontend and backend. With schema-first approach itâ€™s easier to cooperate, discuss and write a better API. Because the SDL is written upfront, the frontend developers can use a mocked version of it and start working on the product while the backend team does the API, in parallel.\nThere are of course some pain points. Once schema is splitted into SDL and resolvers itâ€™s hard to keep them in sync and thatâ€™s why things like GraphQL Code Generator were developed, to add type safety on top of all.\n\nThe resolver-first approach is a bit different. The schema is defined programmatically, which usually means itâ€™s more flexible and combined with TypeScript or Flow gives you type-safety out of the box.\n\nWe think itâ€™s less readable than having a SDL and thereâ€™s a lack of separation between schema and code which might be a blocker for some teams."
          },
          {
            "manualTitle": "Step 17: Performance",
            "stepRevision": "67aa10b18aab47dc1ca2769830111e5c2e84741b",
            "manualView": "In this part of the tutorial we're going to do a bit different work than in previous chapters. We'll analyze the code instead of writing it, including both the API and the web application.\n\n## API Performance\n\nFirst, let's start with the GraphQL API.\n\n### Finding bottlenecks\n\nIn order to implement fixes and do improvements we need to understand which part of the API needs help. There's still not many tools around GraphQL in terms of analytics and inspection but there's one highly useful, it's called **Apollo Engine**.\n\nSince we're going to use it, you need to register an account at [engine.apollographql.com](https://engine.apollographql.com/) and create a service. Please then follow [the \"How to configure an Apollo project\" instructions](https://www.apollographql.com/docs/platform/schema-registry/#using-the-schema-registry).\n\nOnce you're ready, please start the server and run this command:\n\n    $ apollo service:push\n\nTo collect the data, let's play with the client app for some time. After that, go to Engine's website.\n\nHere's one of graphs with timing of an operation. We can understand when each resolver takes place and how much time it consumes. Some resolvers happen in parallel.\nThe `< 1ms` says it was a very simple computation or an element resolved immediately.\n\nWe find it very useful to understand how operation behaves.\n\n![Resolvers](../../../assets/step17/img-01.png \"Resolvers\")\n\nLet's go through an entire query to find fields fetched multiple times. The most obvious field is `isMine`. We see it's computed twice for almost 4 and 5 milliseconds.\nIn order to find out what does it mean, we need to look at the code. The resolver gets the currently logged in user from the `Auth` service and its `currentUser`. Each time the method is invoked, a query to PostgreSQL is made. We ask for that data multiple times, once in `lastMessage` and also in every message from the list.\n\nWe could deduplicate the SQL queries! In order to do that the most obvious library that pops to my mind is Dataloader.\n\nLet's install the package and discuss it afterwards:\n\n    npm install dataloader\n\nThe Dataloader is a library created and maintained by Facebook. It's main purpose is to turn equivalent requests into a single execution. Sounds like a perfect solution, right? It actually is.\n\nA short explaination of how Dataloader works.\n\n```ts\nasync function fetchUser(id: number): Promise<User> {\n  // Resolves asynchronously, after less than 1s.\n  return db.users.findOne(id);\n}\n\nasync function fetchUsers(ids: number[]): Promise<User[]> {\n  const users = ids.map(id => fetchUser(id));\n  return Promise.all(users);\n}\n\nconst loader = new Dataloader(keys => fetchUsers(keys));\n\nasync function main() {\n  const user1 = await loader.load(1);\n  const user2 = await loader.load(2);\n\n  // Later on user #1 is fetched again.\n  // It resolves immediately.\n  const member1 = await loader.load(1);\n}\n```\n\nThink of the Dataloader as a class that has a `Map` object in it, its keys are of course unique and each value is a `Promise`.\nEvery time you ask for something, Dataloader looks for it in the `Map`. When there's already something, the `Promise` is returned but if there's none the provided function is invoked and a new `Promise` is created. This way equivalent requests share the same `Promise`.\n\n> It's important to know that the `Map` object grows until the DataLoader is released, that's why it's recommended to keep `Dataloader` in GraphQL's context.\n\nLet's implement `Dataloader` in our `Database` service:\n\n[{]: <helper> (diffStep \"14.1\" files=\"modules/common/database.provider.ts\" module=\"server\")\n\n#### [__Server__ Step 14.1: Deduplicate SQL queries](https://github.com/Urigo/WhatsApp-Clone-Server/commit/6b2df83f1559bc905b3f9c1bcfda6cc7a8aef4e0)\n\n##### Changed modules&#x2F;common&#x2F;database.provider.ts\n```diff\n@@ -1,14 +1,41 @@\n â”Š 1â”Š 1â”Šimport { Injectable, ProviderScope } from '@graphql-modules/di';\n â”Š 2â”Š 2â”Šimport { OnResponse } from '@graphql-modules/core';\n-â”Š 3â”Š  â”Šimport { Pool, PoolClient } from 'pg';\n+â”Š  â”Š 3â”Šimport { Pool, PoolClient, QueryResult } from 'pg';\n+â”Š  â”Š 4â”Šimport { SQLStatement } from 'sql-template-strings';\n+â”Š  â”Š 5â”Šimport Dataloader from 'dataloader';\n â”Š 4â”Š 6â”Š\n â”Š 5â”Š 7â”Š@Injectable({\n â”Š 6â”Š 8â”Š  scope: ProviderScope.Session,\n â”Š 7â”Š 9â”Š})\n â”Š 8â”Š10â”Šexport class Database implements OnResponse {\n â”Š 9â”Š11â”Š  private instance: PoolClient;\n+â”Š  â”Š12â”Š  private loader: Dataloader<string | SQLStatement, QueryResult>;\n â”Š10â”Š13â”Š\n-â”Š11â”Š  â”Š  constructor(private pool: Pool) {}\n+â”Š  â”Š14â”Š  constructor(private pool: Pool) {\n+â”Š  â”Š15â”Š    this.loader = new Dataloader(\n+â”Š  â”Š16â”Š      queries =>\n+â”Š  â”Š17â”Š        Promise.all(\n+â”Š  â”Š18â”Š          queries.map(async query => {\n+â”Š  â”Š19â”Š            const db = await this.getClient();\n+â”Š  â”Š20â”Š            return db.query(query);\n+â”Š  â”Š21â”Š          })\n+â”Š  â”Š22â”Š        ),\n+â”Š  â”Š23â”Š      {\n+â”Š  â”Š24â”Š        cacheKeyFn: (key: string | SQLStatement) => {\n+â”Š  â”Š25â”Š          let id: string;\n+â”Š  â”Š26â”Š\n+â”Š  â”Š27â”Š          if (typeof key === 'string') {\n+â”Š  â”Š28â”Š            id = key;\n+â”Š  â”Š29â”Š          } else {\n+â”Š  â”Š30â”Š            id = key.text + ' - ' + JSON.stringify(key.values);\n+â”Š  â”Š31â”Š          }\n+â”Š  â”Š32â”Š\n+â”Š  â”Š33â”Š          return id;\n+â”Š  â”Š34â”Š        },\n+â”Š  â”Š35â”Š        batch: false,\n+â”Š  â”Š36â”Š      }\n+â”Š  â”Š37â”Š    );\n+â”Š  â”Š38â”Š  }\n â”Š12â”Š39â”Š\n â”Š13â”Š40â”Š  async onRequest() {\n â”Š14â”Š41â”Š    this.instance = await this.pool.connect();\n```\n```diff\n@@ -20,7 +47,11 @@\n â”Š20â”Š47â”Š    }\n â”Š21â”Š48â”Š  }\n â”Š22â”Š49â”Š\n-â”Š23â”Š  â”Š  async getClient() {\n+â”Š  â”Š50â”Š  private getClient() {\n â”Š24â”Š51â”Š    return this.instance;\n â”Š25â”Š52â”Š  }\n+â”Š  â”Š53â”Š\n+â”Š  â”Š54â”Š  query(query: SQLStatement | string) {\n+â”Š  â”Š55â”Š    return this.loader.load(query);\n+â”Š  â”Š56â”Š  }\n â”Š26â”Š57â”Š}\n```\n\n[}]: #\n\nThe key is created based on SQL statement and its values and we also turned off batching because it's important to execute SQL operations sequentially.\nThere's also a new method called `query`, to execute SQL statements through Dataloader. It also reduces a boilerplate of asking for db client and executing a query every time we do SQL in resolvers and providers.\n\nNow we need to apply that change in all providers:\n\n[{]: <helper> (diffStep \"14.1\" files=\"modules/users/users.provider.ts, modules/chats/chats.provider.ts\" module=\"server\")\n\n#### [__Server__ Step 14.1: Deduplicate SQL queries](https://github.com/Urigo/WhatsApp-Clone-Server/commit/6b2df83f1559bc905b3f9c1bcfda6cc7a8aef4e0)\n\n##### Changed modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -11,9 +11,7 @@\n â”Š11â”Š11â”Š  @Inject() private pubsub: PubSub;\n â”Š12â”Š12â”Š\n â”Š13â”Š13â”Š  async findChatsByUser(userId: string) {\n-â”Š14â”Š  â”Š    const db = await this.db.getClient();\n-â”Š15â”Š  â”Š\n-â”Š16â”Š  â”Š    const { rows } = await db.query(sql`\n+â”Š  â”Š14â”Š    const { rows } = await this.db.query(sql`\n â”Š17â”Š15â”Š      SELECT chats.* FROM chats, chats_users\n â”Š18â”Š16â”Š      WHERE chats.id = chats_users.chat_id\n â”Š19â”Š17â”Š      AND chats_users.user_id = ${userId}\n```\n```diff\n@@ -23,8 +21,7 @@\n â”Š23â”Š21â”Š  }\n â”Š24â”Š22â”Š\n â”Š25â”Š23â”Š  async findChatByUser({ chatId, userId }: { chatId: string; userId: string }) {\n-â”Š26â”Š  â”Š    const db = await this.db.getClient();\n-â”Š27â”Š  â”Š    const { rows } = await db.query(sql`\n+â”Š  â”Š24â”Š    const { rows } = await this.db.query(sql`\n â”Š28â”Š25â”Š      SELECT chats.* FROM chats, chats_users\n â”Š29â”Š26â”Š      WHERE chats_users.chat_id = ${chatId}\n â”Š30â”Š27â”Š      AND chats.id = chats_users.chat_id\n```\n```diff\n@@ -35,16 +32,14 @@\n â”Š35â”Š32â”Š  }\n â”Š36â”Š33â”Š\n â”Š37â”Š34â”Š  async findChatById(chatId: string) {\n-â”Š38â”Š  â”Š    const db = await this.db.getClient();\n-â”Š39â”Š  â”Š    const { rows } = await db.query(sql`\n+â”Š  â”Š35â”Š    const { rows } = await this.db.query(sql`\n â”Š40â”Š36â”Š      SELECT * FROM chats WHERE id = ${chatId}\n â”Š41â”Š37â”Š    `);\n â”Š42â”Š38â”Š    return rows[0] || null;\n â”Š43â”Š39â”Š  }\n â”Š44â”Š40â”Š\n â”Š45â”Š41â”Š  async findMessagesByChat(chatId: string) {\n-â”Š46â”Š  â”Š    const db = await this.db.getClient();\n-â”Š47â”Š  â”Š    const { rows } = await db.query(\n+â”Š  â”Š42â”Š    const { rows } = await this.db.query(\n â”Š48â”Š43â”Š      sql`SELECT * FROM messages WHERE chat_id = ${chatId}`\n â”Š49â”Š44â”Š    );\n â”Š50â”Š45â”Š\n```\n```diff\n@@ -52,8 +47,7 @@\n â”Š52â”Š47â”Š  }\n â”Š53â”Š48â”Š\n â”Š54â”Š49â”Š  async lastMessage(chatId: string) {\n-â”Š55â”Š  â”Š    const db = await this.db.getClient();\n-â”Š56â”Š  â”Š    const { rows } = await db.query(sql`\n+â”Š  â”Š50â”Š    const { rows } = await this.db.query(sql`\n â”Š57â”Š51â”Š      SELECT * FROM messages\n â”Š58â”Š52â”Š      WHERE chat_id = ${chatId}\n â”Š59â”Š53â”Š      ORDER BY created_at DESC\n```\n```diff\n@@ -64,8 +58,7 @@\n â”Š64â”Š58â”Š  }\n â”Š65â”Š59â”Š\n â”Š66â”Š60â”Š  async firstRecipient({ chatId, userId }: { chatId: string; userId: string }) {\n-â”Š67â”Š  â”Š    const db = await this.db.getClient();\n-â”Š68â”Š  â”Š    const { rows } = await db.query(sql`\n+â”Š  â”Š61â”Š    const { rows } = await this.db.query(sql`\n â”Š69â”Š62â”Š      SELECT users.* FROM users, chats_users\n â”Š70â”Š63â”Š      WHERE users.id != ${userId}\n â”Š71â”Š64â”Š      AND users.id = chats_users.user_id\n```\n```diff\n@@ -76,8 +69,7 @@\n â”Š76â”Š69â”Š  }\n â”Š77â”Š70â”Š\n â”Š78â”Š71â”Š  async participants(chatId: string) {\n-â”Š79â”Š  â”Š    const db = await this.db.getClient();\n-â”Š80â”Š  â”Š    const { rows } = await db.query(sql`\n+â”Š  â”Š72â”Š    const { rows } = await this.db.query(sql`\n â”Š81â”Š73â”Š      SELECT users.* FROM users, chats_users\n â”Š82â”Š74â”Š      WHERE chats_users.chat_id = ${chatId}\n â”Š83â”Š75â”Š      AND chats_users.user_id = users.id\n```\n```diff\n@@ -87,8 +79,7 @@\n â”Š87â”Š79â”Š  }\n â”Š88â”Š80â”Š\n â”Š89â”Š81â”Š  async isParticipant({ chatId, userId }: { chatId: string; userId: string }) {\n-â”Š90â”Š  â”Š    const db = await this.db.getClient();\n-â”Š91â”Š  â”Š    const { rows } = await db.query(sql`\n+â”Š  â”Š82â”Š    const { rows } = await this.db.query(sql`\n â”Š92â”Š83â”Š      SELECT * FROM chats_users\n â”Š93â”Š84â”Š      WHERE chat_id = ${chatId}\n â”Š94â”Š85â”Š      AND user_id = ${userId}\n```\n```diff\n@@ -106,8 +97,7 @@\n â”Š106â”Š 97â”Š    userId: string;\n â”Š107â”Š 98â”Š    content: string;\n â”Š108â”Š 99â”Š  }) {\n-â”Š109â”Š   â”Š    const db = await this.db.getClient();\n-â”Š110â”Š   â”Š    const { rows } = await db.query(sql`\n+â”Š   â”Š100â”Š    const { rows } = await this.db.query(sql`\n â”Š111â”Š101â”Š      INSERT INTO messages(chat_id, sender_user_id, content)\n â”Š112â”Š102â”Š      VALUES(${chatId}, ${userId}, ${content})\n â”Š113â”Š103â”Š      RETURNING *\n```\n```diff\n@@ -129,8 +119,7 @@\n â”Š129â”Š119â”Š    userId: string;\n â”Š130â”Š120â”Š    recipientId: string;\n â”Š131â”Š121â”Š  }) {\n-â”Š132â”Š   â”Š    const db = await this.db.getClient();\n-â”Š133â”Š   â”Š    const { rows } = await db.query(sql`\n+â”Š   â”Š122â”Š    const { rows } = await this.db.query(sql`\n â”Š134â”Š123â”Š      SELECT chats.* FROM chats, (SELECT * FROM chats_users WHERE user_id = ${userId}) AS chats_of_current_user, chats_users\n â”Š135â”Š124â”Š      WHERE chats_users.chat_id = chats_of_current_user.chat_id\n â”Š136â”Š125â”Š      AND chats.id = chats_users.chat_id\n```\n```diff\n@@ -143,9 +132,9 @@\n â”Š143â”Š132â”Š    }\n â”Š144â”Š133â”Š\n â”Š145â”Š134â”Š    try {\n-â”Š146â”Š   â”Š      await db.query('BEGIN');\n+â”Š   â”Š135â”Š      await this.db.query('BEGIN');\n â”Š147â”Š136â”Š\n-â”Š148â”Š   â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š137â”Š      const { rows } = await this.db.query(sql`\n â”Š149â”Š138â”Š        INSERT INTO chats\n â”Š150â”Š139â”Š        DEFAULT VALUES\n â”Š151â”Š140â”Š        RETURNING *\n```\n```diff\n@@ -153,17 +142,17 @@\n â”Š153â”Š142â”Š\n â”Š154â”Š143â”Š      const chatAdded = rows[0];\n â”Š155â”Š144â”Š\n-â”Š156â”Š   â”Š      await db.query(sql`\n+â”Š   â”Š145â”Š      await this.db.query(sql`\n â”Š157â”Š146â”Š        INSERT INTO chats_users(chat_id, user_id)\n â”Š158â”Š147â”Š        VALUES(${chatAdded.id}, ${userId})\n â”Š159â”Š148â”Š      `);\n â”Š160â”Š149â”Š\n-â”Š161â”Š   â”Š      await db.query(sql`\n+â”Š   â”Š150â”Š      await this.db.query(sql`\n â”Š162â”Š151â”Š        INSERT INTO chats_users(chat_id, user_id)\n â”Š163â”Š152â”Š        VALUES(${chatAdded.id}, ${recipientId})\n â”Š164â”Š153â”Š      `);\n â”Š165â”Š154â”Š\n-â”Š166â”Š   â”Š      await db.query('COMMIT');\n+â”Š   â”Š155â”Š      await this.db.query('COMMIT');\n â”Š167â”Š156â”Š\n â”Š168â”Š157â”Š      this.pubsub.publish('chatAdded', {\n â”Š169â”Š158â”Š        chatAdded,\n```\n```diff\n@@ -171,18 +160,16 @@\n â”Š171â”Š160â”Š\n â”Š172â”Š161â”Š      return chatAdded;\n â”Š173â”Š162â”Š    } catch (e) {\n-â”Š174â”Š   â”Š      await db.query('ROLLBACK');\n+â”Š   â”Š163â”Š      await this.db.query('ROLLBACK');\n â”Š175â”Š164â”Š      throw e;\n â”Š176â”Š165â”Š    }\n â”Š177â”Š166â”Š  }\n â”Š178â”Š167â”Š\n â”Š179â”Š168â”Š  async removeChat({ chatId, userId }: { chatId: string; userId: string }) {\n-â”Š180â”Š   â”Š    const db = await this.db.getClient();\n-â”Š181â”Š   â”Š\n â”Š182â”Š169â”Š    try {\n-â”Š183â”Š   â”Š      await db.query('BEGIN');\n+â”Š   â”Š170â”Š      await this.db.query('BEGIN');\n â”Š184â”Š171â”Š\n-â”Š185â”Š   â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š172â”Š      const { rows } = await this.db.query(sql`\n â”Š186â”Š173â”Š        SELECT chats.* FROM chats, chats_users\n â”Š187â”Š174â”Š        WHERE id = ${chatId}\n â”Š188â”Š175â”Š        AND chats.id = chats_users.chat_id\n```\n```diff\n@@ -192,11 +179,11 @@\n â”Š192â”Š179â”Š      const chat = rows[0];\n â”Š193â”Š180â”Š\n â”Š194â”Š181â”Š      if (!chat) {\n-â”Š195â”Š   â”Š        await db.query('ROLLBACK');\n+â”Š   â”Š182â”Š        await this.db.query('ROLLBACK');\n â”Š196â”Š183â”Š        return null;\n â”Š197â”Š184â”Š      }\n â”Š198â”Š185â”Š\n-â”Š199â”Š   â”Š      await db.query(sql`\n+â”Š   â”Š186â”Š      await this.db.query(sql`\n â”Š200â”Š187â”Š        DELETE FROM chats WHERE chats.id = ${chatId}\n â”Š201â”Š188â”Š      `);\n â”Š202â”Š189â”Š\n```\n```diff\n@@ -205,11 +192,11 @@\n â”Š205â”Š192â”Š        targetChat: chat,\n â”Š206â”Š193â”Š      });\n â”Š207â”Š194â”Š\n-â”Š208â”Š   â”Š      await db.query('COMMIT');\n+â”Š   â”Š195â”Š      await this.db.query('COMMIT');\n â”Š209â”Š196â”Š\n â”Š210â”Š197â”Š      return chatId;\n â”Š211â”Š198â”Š    } catch (e) {\n-â”Š212â”Š   â”Š      await db.query('ROLLBACK');\n+â”Š   â”Š199â”Š      await this.db.query('ROLLBACK');\n â”Š213â”Š200â”Š      throw e;\n â”Š214â”Š201â”Š    }\n â”Š215â”Š202â”Š  }\n```\n\n##### Changed modules&#x2F;users&#x2F;users.provider.ts\n```diff\n@@ -12,8 +12,7 @@\n â”Š12â”Š12â”Š  @Inject() private db: Database;\n â”Š13â”Š13â”Š\n â”Š14â”Š14â”Š  async findById(userId: string) {\n-â”Š15â”Š  â”Š    const db = await this.db.getClient();\n-â”Š16â”Š  â”Š    const { rows } = await db.query(\n+â”Š  â”Š15â”Š    const { rows } = await this.db.query(\n â”Š17â”Š16â”Š      sql`SELECT * FROM users WHERE id = ${userId}`\n â”Š18â”Š17â”Š    );\n â”Š19â”Š18â”Š\n```\n```diff\n@@ -21,8 +20,7 @@\n â”Š21â”Š20â”Š  }\n â”Š22â”Š21â”Š\n â”Š23â”Š22â”Š  async findAllExcept(userId: string) {\n-â”Š24â”Š  â”Š    const db = await this.db.getClient();\n-â”Š25â”Š  â”Š    const { rows } = await db.query(\n+â”Š  â”Š23â”Š    const { rows } = await this.db.query(\n â”Š26â”Š24â”Š      sql`SELECT * FROM users WHERE id != ${userId}`\n â”Š27â”Š25â”Š    );\n â”Š28â”Š26â”Š\n```\n```diff\n@@ -30,8 +28,7 @@\n â”Š30â”Š28â”Š  }\n â”Š31â”Š29â”Š\n â”Š32â”Š30â”Š  async findByUsername(username: string) {\n-â”Š33â”Š  â”Š    const db = await this.db.getClient();\n-â”Š34â”Š  â”Š    const { rows } = await db.query(\n+â”Š  â”Š31â”Š    const { rows } = await this.db.query(\n â”Š35â”Š32â”Š      sql`SELECT * FROM users WHERE username = ${username}`\n â”Š36â”Š33â”Š    );\n â”Š37â”Š34â”Š\n```\n```diff\n@@ -47,9 +44,8 @@\n â”Š47â”Š44â”Š    name: string;\n â”Š48â”Š45â”Š    password: string;\n â”Š49â”Š46â”Š  }) {\n-â”Š50â”Š  â”Š    const db = await this.db.getClient();\n â”Š51â”Š47â”Š    const passwordHash = bcrypt.hashSync(password, bcrypt.genSaltSync(8));\n-â”Š52â”Š  â”Š    const createdUserQuery = await db.query(sql`\n+â”Š  â”Š48â”Š    const createdUserQuery = await this.db.query(sql`\n â”Š53â”Š49â”Š        INSERT INTO users(password, picture, username, name)\n â”Š54â”Š50â”Š        VALUES(${passwordHash}, ${DEFAULT_PROFILE_PIC}, ${username}, ${name})\n â”Š55â”Š51â”Š        RETURNING *\n```\n\n[}]: #\n\nDeduplication is done but the `currentUser` method does more than just that. It verifies the auth token extracted from a request's cookie. This could be avoided by an assignment to a private prop and a simple if statement.\n\n[{]: <helper> (diffStep \"14.2\" module=\"server\")\n\n#### [__Server__ Step 14.2: Cache current user object](https://github.com/Urigo/WhatsApp-Clone-Server/commit/1613073143f323898af7b666770d8c350526c36c)\n\n##### Changed modules&#x2F;users&#x2F;auth.provider.ts\n```diff\n@@ -14,6 +14,7 @@\n â”Š14â”Š14â”Šexport class Auth {\n â”Š15â”Š15â”Š  @Inject() private users: Users;\n â”Š16â”Š16â”Š  @Inject() private module: ModuleSessionInfo;\n+â”Š  â”Š17â”Š  private _currentUser: User;\n â”Š17â”Š18â”Š\n â”Š18â”Š19â”Š  private get req() {\n â”Š19â”Š20â”Š    return this.module.session.req || this.module.session.request;\n```\n```diff\n@@ -76,11 +77,16 @@\n â”Š76â”Š77â”Š  }\n â”Š77â”Š78â”Š\n â”Š78â”Š79â”Š  async currentUser(): Promise<User | null> {\n+â”Š  â”Š80â”Š    if (this._currentUser) {\n+â”Š  â”Š81â”Š      return this._currentUser;\n+â”Š  â”Š82â”Š    }\n+â”Š  â”Š83â”Š\n â”Š79â”Š84â”Š    if (this.req.cookies.authToken) {\n â”Š80â”Š85â”Š      const username = jwt.verify(this.req.cookies.authToken, secret) as string;\n â”Š81â”Š86â”Š\n â”Š82â”Š87â”Š      if (username) {\n-â”Š83â”Š  â”Š        return this.users.findByUsername(username);\n+â”Š  â”Š88â”Š        this._currentUser = await this.users.findByUsername(username);\n+â”Š  â”Š89â”Š        return this._currentUser;\n â”Š84â”Š90â”Š      }\n â”Š85â”Š91â”Š    }\n```\n\n[}]: #\n\n![Resolvers](../../../assets/step17/img-02.png \"Resolvers\")\n\nAs you can see at the graph above, we reduced an execution time of `isMine` field from 4ms and 5ms to less than 1. That applies for all calls, all messages so it scales well and won't grow as list of messages increases.\n\nBut there's more... We see `chat` field being computed over and over again. So again, let's repeat the same steps.\nThe `Message.chat` resolver asks `Chats` service and its `findChatById` method which makes a SQL call.\n\nThe deduplication logic, we introduced in the previous step, helps to immediately resolve all `Message.chat` fields except the first occurrence but there's still a space for improvements.\n\nThe `Query.chats` resolver is invoked before the `Message.chat` which means at this point, we already have knowledge about the chats.\n\nLet's implement a caching logic for chats so we could reuse them. We will do it in few steps.\n\nFirst, because we're going to use `Dataloader`, `Chats` class should have private and public API.\n\n[{]: <helper> (diffStep \"14.3\" module=\"server\")\n\n#### [__Server__ Step 14.3: Separate db query from public API](https://github.com/Urigo/WhatsApp-Clone-Server/commit/ea8f3ab28755b7664be3103aa2f9b843ba43041e)\n\n##### Changed modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -11,6 +11,10 @@\n â”Š11â”Š11â”Š  @Inject() private pubsub: PubSub;\n â”Š12â”Š12â”Š\n â”Š13â”Š13â”Š  async findChatsByUser(userId: string) {\n+â”Š  â”Š14â”Š    return this._findChatsByUser(userId);\n+â”Š  â”Š15â”Š  }\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š  private async _findChatsByUser(userId: string) {\n â”Š14â”Š18â”Š    const { rows } = await this.db.query(sql`\n â”Š15â”Š19â”Š      SELECT chats.* FROM chats, chats_users\n â”Š16â”Š20â”Š      WHERE chats.id = chats_users.chat_id\n```\n\n[}]: #\n\nThe private method is responsible for quering data from the database but the public one is to allow communication between the service and its consumers.\nIt's also there so we could switch to using Dataloader later on.\n\nWe did that to `findChatsByUser` but there are more:\n\n[{]: <helper> (diffStep \"14.4\" module=\"server\")\n\n#### [__Server__ Step 14.4: Separate findChatByUser](https://github.com/Urigo/WhatsApp-Clone-Server/commit/e19542919106b4ab1eb9e77b638cd15a49ce80bb)\n\n##### Changed modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -25,6 +25,18 @@\n â”Š25â”Š25â”Š  }\n â”Š26â”Š26â”Š\n â”Š27â”Š27â”Š  async findChatByUser({ chatId, userId }: { chatId: string; userId: string }) {\n+â”Š  â”Š28â”Š    const rows = await this._findChatByUser({ chatId, userId });\n+â”Š  â”Š29â”Š\n+â”Š  â”Š30â”Š    return rows[0] || null;\n+â”Š  â”Š31â”Š  }\n+â”Š  â”Š32â”Š\n+â”Š  â”Š33â”Š  private async _findChatByUser({\n+â”Š  â”Š34â”Š    chatId,\n+â”Š  â”Š35â”Š    userId,\n+â”Š  â”Š36â”Š  }: {\n+â”Š  â”Š37â”Š    chatId: string;\n+â”Š  â”Š38â”Š    userId: string;\n+â”Š  â”Š39â”Š  }) {\n â”Š28â”Š40â”Š    const { rows } = await this.db.query(sql`\n â”Š29â”Š41â”Š      SELECT chats.* FROM chats, chats_users\n â”Š30â”Š42â”Š      WHERE chats_users.chat_id = ${chatId}\n```\n```diff\n@@ -32,7 +44,7 @@\n â”Š32â”Š44â”Š      AND chats_users.user_id = ${userId}\n â”Š33â”Š45â”Š    `);\n â”Š34â”Š46â”Š\n-â”Š35â”Š  â”Š    return rows[0] || null;\n+â”Š  â”Š47â”Š    return rows;\n â”Š36â”Š48â”Š  }\n â”Š37â”Š49â”Š\n â”Š38â”Š50â”Š  async findChatById(chatId: string) {\n```\n\n[}]: #\n[{]: <helper> (diffStep \"14.5\" module=\"server\")\n\n#### [__Server__ Step 14.5: Separate findChatById](https://github.com/Urigo/WhatsApp-Clone-Server/commit/094530894029881112f50eb9d3c617040f743061)\n\n##### Changed modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -48,10 +48,15 @@\n â”Š48â”Š48â”Š  }\n â”Š49â”Š49â”Š\n â”Š50â”Š50â”Š  async findChatById(chatId: string) {\n+â”Š  â”Š51â”Š    const rows = await this._findChatById(chatId);\n+â”Š  â”Š52â”Š    return rows[0] || null;\n+â”Š  â”Š53â”Š  }\n+â”Š  â”Š54â”Š\n+â”Š  â”Š55â”Š  private async _findChatById(chatId: string) {\n â”Š51â”Š56â”Š    const { rows } = await this.db.query(sql`\n â”Š52â”Š57â”Š      SELECT * FROM chats WHERE id = ${chatId}\n â”Š53â”Š58â”Š    `);\n-â”Š54â”Š  â”Š    return rows[0] || null;\n+â”Š  â”Š59â”Š    return rows;\n â”Š55â”Š60â”Š  }\n â”Š56â”Š61â”Š\n â”Š57â”Š62â”Š  async findMessagesByChat(chatId: string) {\n```\n\n[}]: #\n\n> Because those private methods are just to query data, make sure they all return untouched `row` object.\n\nNow's the most interesting part, Dataloader.\n\n[{]: <helper> (diffStep \"14.6\" module=\"server\")\n\n#### [__Server__ Step 14.6: Use Dataloader in Chats](https://github.com/Urigo/WhatsApp-Clone-Server/commit/fdc1013b0291a0195c7cdf487869e2fe26809e86)\n\n##### Changed modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -1,8 +1,23 @@\n â”Š 1â”Š 1â”Šimport { Injectable, Inject, ProviderScope } from '@graphql-modules/di';\n+â”Š  â”Š 2â”Šimport { QueryResult } from 'pg';\n â”Š 2â”Š 3â”Šimport sql from 'sql-template-strings';\n+â”Š  â”Š 4â”Šimport DataLoader from 'dataloader';\n â”Š 3â”Š 5â”Šimport { Database } from '../common/database.provider';\n â”Š 4â”Š 6â”Šimport { PubSub } from '../common/pubsub.provider';\n â”Š 5â”Š 7â”Š\n+â”Š  â”Š 8â”Štype ChatsByUser = { userId: string };\n+â”Š  â”Š 9â”Štype ChatByUser = { userId: string; chatId: string };\n+â”Š  â”Š10â”Štype ChatById = { chatId: string };\n+â”Š  â”Š11â”Štype ChatsKey = ChatById | ChatByUser | ChatsByUser;\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Šfunction isChatsByUser(query: any): query is ChatsByUser {\n+â”Š  â”Š14â”Š  return query.userId && !query.chatId;\n+â”Š  â”Š15â”Š}\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Šfunction isChatByUser(query: any): query is ChatByUser {\n+â”Š  â”Š18â”Š  return query.userId && query.chatId;\n+â”Š  â”Š19â”Š}\n+â”Š  â”Š20â”Š\n â”Š 6â”Š21â”Š@Injectable({\n â”Š 7â”Š22â”Š  scope: ProviderScope.Session,\n â”Š 8â”Š23â”Š})\n```\n```diff\n@@ -10,8 +25,26 @@\n â”Š10â”Š25â”Š  @Inject() private db: Database;\n â”Š11â”Š26â”Š  @Inject() private pubsub: PubSub;\n â”Š12â”Š27â”Š\n+â”Š  â”Š28â”Š  private loaders = {\n+â”Š  â”Š29â”Š    chats: new DataLoader<ChatsKey, QueryResult['rows']>(keys => {\n+â”Š  â”Š30â”Š      return Promise.all(\n+â”Š  â”Š31â”Š        keys.map(async query => {\n+â”Š  â”Š32â”Š          if (isChatsByUser(query)) {\n+â”Š  â”Š33â”Š            return this._findChatsByUser(query.userId);\n+â”Š  â”Š34â”Š          }\n+â”Š  â”Š35â”Š\n+â”Š  â”Š36â”Š          if (isChatByUser(query)) {\n+â”Š  â”Š37â”Š            return this._findChatByUser(query);\n+â”Š  â”Š38â”Š          }\n+â”Š  â”Š39â”Š\n+â”Š  â”Š40â”Š          return this._findChatById(query.chatId);\n+â”Š  â”Š41â”Š        })\n+â”Š  â”Š42â”Š      );\n+â”Š  â”Š43â”Š    }),\n+â”Š  â”Š44â”Š  };\n+â”Š  â”Š45â”Š\n â”Š13â”Š46â”Š  async findChatsByUser(userId: string) {\n-â”Š14â”Š  â”Š    return this._findChatsByUser(userId);\n+â”Š  â”Š47â”Š    return this.loaders.chats.load({ userId });\n â”Š15â”Š48â”Š  }\n â”Š16â”Š49â”Š\n â”Š17â”Š50â”Š  private async _findChatsByUser(userId: string) {\n```\n```diff\n@@ -25,7 +58,7 @@\n â”Š25â”Š58â”Š  }\n â”Š26â”Š59â”Š\n â”Š27â”Š60â”Š  async findChatByUser({ chatId, userId }: { chatId: string; userId: string }) {\n-â”Š28â”Š  â”Š    const rows = await this._findChatByUser({ chatId, userId });\n+â”Š  â”Š61â”Š    const rows = await this.loaders.chats.load({ chatId, userId });\n â”Š29â”Š62â”Š\n â”Š30â”Š63â”Š    return rows[0] || null;\n â”Š31â”Š64â”Š  }\n```\n```diff\n@@ -48,7 +81,7 @@\n â”Š48â”Š81â”Š  }\n â”Š49â”Š82â”Š\n â”Š50â”Š83â”Š  async findChatById(chatId: string) {\n-â”Š51â”Š  â”Š    const rows = await this._findChatById(chatId);\n+â”Š  â”Š84â”Š    const rows = await this.loaders.chats.load({ chatId });\n â”Š52â”Š85â”Š    return rows[0] || null;\n â”Š53â”Š86â”Š  }\n â”Š54â”Š87â”Š\n```\n\n##### Changed package.json\n```diff\n@@ -51,6 +51,7 @@\n â”Š51â”Š51â”Š    \"cookie\": \"0.4.0\",\n â”Š52â”Š52â”Š    \"cors\": \"2.8.5\",\n â”Š53â”Š53â”Š    \"cookie-parser\": \"1.4.4\",\n+â”Š  â”Š54â”Š    \"dataloader\": \"1.4.0\",\n â”Š54â”Š55â”Š    \"express\": \"4.17.1\",\n â”Š55â”Š56â”Š    \"graphql\": \"14.4.2\",\n â”Š56â”Š57â”Š    \"graphql-import\": \"0.7.1\",\n```\n\n[}]: #\n\nWe introduced `ChatsKey` that is a union type, to standarize the input value. Those helper methods like `isChatsByUser` and `isChatByUser` are there to decide what should be fetched.\n\nIn every public method that we previously changed, there's now Dataloader in use but that's not entirely what we're trying to achieve.\n\nThe caching mechanism is not yet completed. We deduplicate requests but in some cases, we ask for chats that are already there, so we need to intercept our dataloader logic and introduce caching.\n\n[{]: <helper> (diffStep \"14.7\" module=\"server\")\n\n#### [__Server__ Step 14.7: Implement caching for Chats](https://github.com/Urigo/WhatsApp-Clone-Server/commit/47cd872ff1e7b13bad8aa8598b778ad99d0b25eb)\n\n##### Changed modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -4,6 +4,7 @@\n â”Š 4â”Š 4â”Šimport DataLoader from 'dataloader';\n â”Š 5â”Š 5â”Šimport { Database } from '../common/database.provider';\n â”Š 6â”Š 6â”Šimport { PubSub } from '../common/pubsub.provider';\n+â”Š  â”Š 7â”Šimport { Chat } from '../../db';\n â”Š 7â”Š 8â”Š\n â”Š 8â”Š 9â”Štype ChatsByUser = { userId: string };\n â”Š 9â”Š10â”Štype ChatByUser = { userId: string; chatId: string };\n```\n```diff\n@@ -25,6 +26,7 @@\n â”Š25â”Š26â”Š  @Inject() private db: Database;\n â”Š26â”Š27â”Š  @Inject() private pubsub: PubSub;\n â”Š27â”Š28â”Š\n+â”Š  â”Š29â”Š  private chatsCache = new Map<string, Chat>();\n â”Š28â”Š30â”Š  private loaders = {\n â”Š29â”Š31â”Š    chats: new DataLoader<ChatsKey, QueryResult['rows']>(keys => {\n â”Š30â”Š32â”Š      return Promise.all(\n```\n```diff\n@@ -33,6 +35,10 @@\n â”Š33â”Š35â”Š            return this._findChatsByUser(query.userId);\n â”Š34â”Š36â”Š          }\n â”Š35â”Š37â”Š\n+â”Š  â”Š38â”Š          if (this.chatsCache.has(query.chatId)) {\n+â”Š  â”Š39â”Š            return [this._readChatFromCache(query.chatId)];\n+â”Š  â”Š40â”Š          }\n+â”Š  â”Š41â”Š\n â”Š36â”Š42â”Š          if (isChatByUser(query)) {\n â”Š37â”Š43â”Š            return this._findChatByUser(query);\n â”Š38â”Š44â”Š          }\n```\n```diff\n@@ -254,4 +260,14 @@\n â”Š254â”Š260â”Š      throw e;\n â”Š255â”Š261â”Š    }\n â”Š256â”Š262â”Š  }\n+â”Š   â”Š263â”Š\n+â”Š   â”Š264â”Š  private _readChatFromCache(chatId: string) {\n+â”Š   â”Š265â”Š    return this.chatsCache.get(chatId);\n+â”Š   â”Š266â”Š  }\n+â”Š   â”Š267â”Š\n+â”Š   â”Š268â”Š  private _writeChatToCache(chat?: Chat) {\n+â”Š   â”Š269â”Š    if (chat) {\n+â”Š   â”Š270â”Š      this.chatsCache.set(chat.id, chat);\n+â”Š   â”Š271â”Š    }\n+â”Š   â”Š272â”Š  }\n â”Š257â”Š273â”Š}\n```\n\n[}]: #\n\nWhenever we ask for a single chat that is available, it's being resolved right away but we still need to write data to the cache.\n\n[{]: <helper> (diffStep \"14.8\" module=\"server\")\n\n#### [__Server__ Step 14.8: Write chats to the cache](https://github.com/Urigo/WhatsApp-Clone-Server/commit/47dea9c524e2bd7a5b6751329e53e3328d3cccdc)\n\n##### Changed modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -60,6 +60,10 @@\n â”Š60â”Š60â”Š      AND chats_users.user_id = ${userId}\n â”Š61â”Š61â”Š    `);\n â”Š62â”Š62â”Š\n+â”Š  â”Š63â”Š    rows.forEach(row => {\n+â”Š  â”Š64â”Š      this._writeChatToCache(row);\n+â”Š  â”Š65â”Š    });\n+â”Š  â”Š66â”Š\n â”Š63â”Š67â”Š    return rows;\n â”Š64â”Š68â”Š  }\n â”Š65â”Š69â”Š\n```\n```diff\n@@ -83,6 +87,8 @@\n â”Š83â”Š87â”Š      AND chats_users.user_id = ${userId}\n â”Š84â”Š88â”Š    `);\n â”Š85â”Š89â”Š\n+â”Š  â”Š90â”Š    this._writeChatToCache(rows[0]);\n+â”Š  â”Š91â”Š\n â”Š86â”Š92â”Š    return rows;\n â”Š87â”Š93â”Š  }\n â”Š88â”Š94â”Š\n```\n```diff\n@@ -95,6 +101,9 @@\n â”Š 95â”Š101â”Š    const { rows } = await this.db.query(sql`\n â”Š 96â”Š102â”Š      SELECT * FROM chats WHERE id = ${chatId}\n â”Š 97â”Š103â”Š    `);\n+â”Š   â”Š104â”Š\n+â”Š   â”Š105â”Š    this._writeChatToCache(rows[0]);\n+â”Š   â”Š106â”Š\n â”Š 98â”Š107â”Š    return rows;\n â”Š 99â”Š108â”Š  }\n```\n\n[}]: #\n\nLet's look at charts in Apollo Engine.\n\n![Resolvers](../../../assets/step17/img-03.png \"Resolvers\")\n\nWe cut off `Message.chat` to less than 1ms.\n\nThe `Chat.name` and `Chat.picture` resolvers share the same logic and since Database service is wrapped with DataLoader, we make a single SQL query. Unfortunately, it's not visible on the graph.\n\nLet's summarize our work. **We made the GetChat operation almost 60% faster on average** and it's just based on one chat with one message. The number would be much much higher on a bigger scale.\n\n### Preventing issues\n\nThe Apollo Engine has another interesting feature. Itâ€™s called Alerts. You set a threshold for all operations or a specific one and whenever it takes longer, you get a notification on Slack. But thereâ€™s a catch, you need to pay in order to unlock it.\n\nWeâ€™re working on something similar but entirely open-sourced. Itâ€™s an extension of ApolloServer that lets you track operations and get exactly what you would get from the engine but self-hosted.\n\n## UI Performance\n\nThe part would be the User Interface and the web app in general.\n\n### Metrics\n\nThere's a highly recommended and very comprehensive publication written by Philip Walton (Engineer at Google) called [\"User-centric Performance Metrics\"](https://developers.google.com/web/fundamentals/performance/user-centric-performance-metrics) that was an inspiration for this chapter. Weâ€™re going to talk in short about measuring render performance of a web application.\n\nLetâ€™s base this chapter on real data. First, open the app and go to Performance tab of Chrome DevTools.\n\n![Record](../../../assets/step17/img-04.png \"Record\")\n\nNow click on â€œStart profiling and reload pageâ€. After itâ€™s done you should see the following:\n\n![All panels](../../../assets/step17/img-05.png \"All panels\")\n\nRight now it may not make a lot of sense, so weâ€™re going to start with something basic.\n\nThereâ€™s many different kinds of charts but we will cover only few of them: Network, Frames, Timings and Main.\n\nLetâ€™s check out the Timings section and explain few important performance metrics.\n\n- DCL - DOMContentLoaded Event\n- L - Onload Event\n- FP - First Paint\n- FCP - First Contentful Paint\n- FMP - First Meaningful Paint\n\nThereâ€™s also another one that is not visible on the timeline but also not less important, TTI - Time to Interactive.\n\nWe will focus on FP, FCP, FMP and TTI.\n\nThe primary difference between the two metrics is **First Paint** marks the point when the browser renders anything that is visually different from what was on the screen prior to navigation. By contrast, **First Contentful Paint** is the point when the browser renders the first bit of content from the DOM, which may be text, an image, SVG, or even a `<canvas>` element.\n\nThe **First Meaningful Paint** should mark the point when something useful was rendered. It might mean an input box on Google, video player on YouTube or in our case, a list of chats.\n\nThe **Time To Interactive** metric marks the point at which the application is both visually rendered and capable of reliably responding to user input.\n\nNow with all that knowledge we can move on to something more practical, the **Frames panel**. The main purpose here is to see whatâ€™s rendered at given time. In our case, the first paint was made after over 200ms, which is not a bad result at all but see that huge blank space next to it.\n\nThe **Network section**, is going to help us out here and give some pointers of what might be a reason of it. Itâ€™s a timeline that explains when each request was made and how long it took to resolve.\n\n![Network section](../../../assets/step17/img-06.png \"Network section\")\n\nWhat do we see here? One of the first requests are js files and we need those to bootstrap and render the app. Thatâ€™s the reason of the blank page.\n\nWe could improve that by either Server-Side Rendering or using a Service Worker.\n\n### Rendering improvements\n\n#### Server-Side Rendering\n\nImplementing SSR means you run the app on server, before itâ€™s being shipped to the client and the documentâ€™s content is not just `<html><body><app></app></body></html>` but an actual markup with all the components in it. Because itâ€™s a part of the document, the browser can already display something meaningful and after js files are loaded, the app bootstraps on the client and it becomes interactive. There is one caveat. Wherever you ship the app it has to be able to run node js.\n\n#### Store Rehydration\n\nWhen talking SSR itâ€™s worth to mention GraphQL and related technique called Store Rehydration. API calls are an important part of an application and plays a huge role in SSR.\n\nGraphQL operations are called once components are mounted which means the cache is filled up and why not reuse it on client.\n\nHow would it work? Data is extracted from the apolloâ€™s cache and passed within a document. After itâ€™s received by the browser, the app runs and so does the Apollo Client. While it happens we look for the data and fill up the cache. Now whenever a component calls a GraphQL operation, the result is already in the cache and resolves immediately.\n\n#### Service Worker\n\nAnother approach is a bit different. By using a Service Worker, weâ€™re able to control and cache requests, including js files, images etc. On the first visit, the app loads exactly the same as without SSR but the next visits are a bit faster. Itâ€™s because the Service Worker is registered after you close the app and of course we canâ€™t cache things that werenâ€™t fetched yet.\n\nBoth techniques are not mutually exclusive and we highly recommend to use both.\n\n![Main section](../../../assets/step17/img-07.png \"Main section\")\n\nThe next section weâ€™re going to talk about is the **Main panel**, a flame chart of activity on the main thread. You see those blocks? They represent an event, the wider it is the longer it took. One of the most important things to remember is to avoid long events since they block the thread.\nThe longest event on our timeline is the Evaluate Script event that involves `main.js`. The file contains all the libraries and the core functionality, those are needed to run the app. By making it lighter we would decrease the time of the first render.\nWe already do something to reduce the bundle size, This technique we use is called code-splitting and it allows to split one piece of code into multiple files which are lazy loaded.\nIt cuts off the size of the main bundle and the rest is loaded on demand, letâ€™s say login page is in a different chunk than list of chats.\n\n### Tooling\n\nThereâ€™s one tool built into Chrome DevTools called Lighthouse that allows to measure, collect metrics and get helpful tips on how to improve the performance and where are the pain points.\n\nHereâ€™s the example:\n\n![Lighthouse results](../../../assets/step17/img-08.png \"Lighthouse results\")\n\nOnce your app is optimized you want to prevent regressions. Lighthouse has you covered! It may run as part of Continuous Integration and prevents deployment when key metrics regress or drop below a certain threshold.\n\n## Making the app feels instant\n\nDealing with slow network can be hard so let's simulate that situation. After all, running the application on local host will always result in low response times.\n\nLuckily most browser come with a built in solution for that - we can simulate a slow network by defining the throttle level:\n\n![Throttling](../../../assets/step17/img-09.png \"Throttling\")\n\nIf we will refresh the application, we should notice a significant slow down the first time we load each screen; about few seconds to load each of them. To ensure that this is really caused by a slow network and not by anything else, we can open the dev-tools of our browser (letâ€™s assume you use Chrome) and under the `network` tab we should notice the network activity times.\n\n> More information about monitoring network activity and throttling it using the Chromeâ€™s dev-tools can be found in [the official dev-tools docs page](https://developers.google.com/web/tools/chrome-devtools/network/).\n\nTo solve these issues there are a couple of changes weâ€™re gonna make in the way we fetch and manage data.\n\n### Optimistic UI\n\nAs you know, pretty much in all cases, everything in Apollo flows through its cache. If a requested data is in there, a query is resolved right away. Mutations are a bit different, they have to reach the server every single time. Seems like nothing we can do about it but fortunately we can simulate the mutation, predict the result and make Apollo treat it as a temporary data. Which means, the appâ€™s state and all components are updated and the change is visible instantly after itâ€™s made.\n\nIn case of the WhatsApp clone, whenever a new message is sent, we will see it right away, on the screen, doesnâ€™t matter if the network is low or even super fast. You may experience the similar behavior on Facebookâ€™s Messenger.\n\n\n```graphql\n  mutation AddMessage($chatId: ID!, $content: String!) {\n    addMessage(chatId: $chatId, content: $content) {\n      ...Message\n    }\n  }\n```\n\n```graphql\n  addMessage({\n    variables: { chatId, content },\n    optimisticResponse: {\n      __typename: 'Mutation',\n      addMessage: {\n        __typename: 'Message',\n        id: Math.random().toString(36).substr(2, 9),\n        createdAt: new Date(),\n        isMine: true,\n        chat: {\n          __typename: 'Chat',\n          id: chatId,\n        },\n        content,\n      }\n    },\n    update: (client, { data: { addMessage } }) => {\n      writeMessage(client, addMessage);\n    },\n  })\n```\n\nWe used words â€œpredictâ€ and â€œsimulateâ€, what if the mutation behaves differently or whatâ€™s more interesting, it fails. Apollo handles that as well. The â€œrealâ€ response overwrites the fake one and the store is reverted back to the original state.\n\n### Prefetching data\n\nAnother technique but with a bit different purpose is about fetching data in advance. In some situations, you might be able to predict which page/component is going to be entered next.\n\nLetâ€™s base it on a real example. The WhatsApp clone has a page with a list of chats. The component that represents the page, calls a GraphQL operation to fetch that list. Right now, when user clicks on one of the chats, heâ€™s redirected to a partially empty page because of the ongoing GraphQL request. What if we could fetch that data in advance? Thatâ€™s what this technique is about. We could predict userâ€™s next move based on a simple mouse event or even by using Artificial Intelligence and data collected by Google Analytics, so whenever the move actually happens, the data is already in the cache.\n\n[{]: <helper> (diffStep \"15.1\" files=\"src/components/ChatRoomScreen/index.tsx\" module=\"client\")\n\n#### [__Client__ Step 15.1: Implement prefetching](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/5795bf6d2ac32f6f9b3bfd9cded8c4847670dbe0)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -2,12 +2,19 @@\n â”Š 2â”Š 2â”Šimport React from 'react';\n â”Š 3â”Š 3â”Šimport { useCallback } from 'react';\n â”Š 4â”Š 4â”Šimport { Redirect } from 'react-router-dom';\n+â”Š  â”Š 5â”Šimport { useApolloClient } from '@apollo/react-hooks';\n â”Š 5â”Š 6â”Šimport styled from 'styled-components';\n â”Š 6â”Š 7â”Šimport ChatNavbar from './ChatNavbar';\n â”Š 7â”Š 8â”Šimport MessageInput from './MessageInput';\n â”Š 8â”Š 9â”Šimport MessagesList from './MessagesList';\n â”Š 9â”Š10â”Šimport { History } from 'history';\n-â”Š10â”Š  â”Šimport { useGetChatQuery, useAddMessageMutation } from '../../graphql/types';\n+â”Š  â”Š11â”Šimport {\n+â”Š  â”Š12â”Š  useGetChatQuery,\n+â”Š  â”Š13â”Š  useAddMessageMutation,\n+â”Š  â”Š14â”Š  GetChatQuery,\n+â”Š  â”Š15â”Š  GetChatQueryVariables,\n+â”Š  â”Š16â”Š  GetChatDocument,\n+â”Š  â”Š17â”Š} from '../../graphql/types';\n â”Š11â”Š18â”Šimport * as fragments from '../../graphql/fragments';\n â”Š12â”Š19â”Šimport { writeMessage } from '../../services/cache.service';\n â”Š13â”Š20â”Š\n```\n```diff\n@@ -38,6 +45,19 @@\n â”Š38â”Š45â”Š  ${fragments.message}\n â”Š39â”Š46â”Š`;\n â”Š40â”Š47â”Š\n+â”Š  â”Š48â”Šexport const useGetChatPrefetch = () => {\n+â”Š  â”Š49â”Š  const client = useApolloClient();\n+â”Š  â”Š50â”Š\n+â”Š  â”Š51â”Š  return (chatId: string) => {\n+â”Š  â”Š52â”Š    client.query<GetChatQuery, GetChatQueryVariables>({\n+â”Š  â”Š53â”Š      query: GetChatDocument,\n+â”Š  â”Š54â”Š      variables: {\n+â”Š  â”Š55â”Š        chatId,\n+â”Š  â”Š56â”Š      },\n+â”Š  â”Š57â”Š    });\n+â”Š  â”Š58â”Š  };\n+â”Š  â”Š59â”Š};\n+â”Š  â”Š60â”Š\n â”Š41â”Š61â”Šinterface ChatRoomScreenParams {\n â”Š42â”Š62â”Š  chatId: string;\n â”Š43â”Š63â”Š  history: History;\n```\n\n[}]: #\n\nWe created the `useGetChatPrefetch` hook that gets ApolloClient instance through `useApolloClient` and returns a function to prefetch data. In this case we request `GetChat` operation. Because Apollo deduplicates queries, we won't make multiple http calls, we're safe.\n\nThe actual usage of `useGetChatPrefetch`, happens on `mouse entered` event:\n\n[{]: <helper> (diffStep \"15.1\" files=\"src/components/ChatsListScreen/ChatsList.tsx\" module=\"client\")\n\n#### [__Client__ Step 15.1: Implement prefetching](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/5795bf6d2ac32f6f9b3bfd9cded8c4847670dbe0)\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -5,6 +5,7 @@\n â”Š 5â”Š 5â”Šimport { useCallback } from 'react';\n â”Š 6â”Š 6â”Šimport { History } from 'history';\n â”Š 7â”Š 7â”Šimport { useChatsQuery } from '../../graphql/types';\n+â”Š  â”Š 8â”Šimport { useGetChatPrefetch } from '../ChatRoomScreen';\n â”Š 8â”Š 9â”Š\n â”Š 9â”Š10â”Šconst Container = styled.div`\n â”Š10â”Š11â”Š  height: calc(100% - 56px);\n```\n```diff\n@@ -69,6 +70,7 @@\n â”Š69â”Š70â”Š    },\n â”Š70â”Š71â”Š    [history]\n â”Š71â”Š72â”Š  );\n+â”Š  â”Š73â”Š  const prefetchChat = useGetChatPrefetch();\n â”Š72â”Š74â”Š\n â”Š73â”Š75â”Š  const { data } = useChatsQuery();\n â”Š74â”Š76â”Š\n```\n```diff\n@@ -85,7 +87,10 @@\n â”Š85â”Š87â”Š            key={chat.id}\n â”Š86â”Š88â”Š            data-testid=\"chat\"\n â”Š87â”Š89â”Š            button\n-â”Š88â”Š  â”Š            onClick={navToChat.bind(null, chat)}>\n+â”Š  â”Š90â”Š            onClick={navToChat.bind(null, chat)}\n+â”Š  â”Š91â”Š            onMouseEnter={() => {\n+â”Š  â”Š92â”Š              prefetchChat(chat.id);\n+â”Š  â”Š93â”Š            }}>\n â”Š89â”Š94â”Š            <ChatPicture\n â”Š90â”Š95â”Š              data-testid=\"picture\"\n â”Š91â”Š96â”Š              src={chat.picture}\n```\n\n[}]: #\n\nNow, the same but with the list of users:\n\n[{]: <helper> (diffStep \"15.1\" files=\"src/components/ChatsListScreen/AddChatButton.tsx\" module=\"client\")\n\n#### [__Client__ Step 15.1: Implement prefetching](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/5795bf6d2ac32f6f9b3bfd9cded8c4847670dbe0)\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;AddChatButton.tsx\n```diff\n@@ -3,6 +3,7 @@\n â”Š3â”Š3â”Šimport React from 'react';\n â”Š4â”Š4â”Šimport styled from 'styled-components';\n â”Š5â”Š5â”Šimport { History } from 'history';\n+â”Š â”Š6â”Šimport { useUsersPrefetch } from '../UsersList';\n â”Š6â”Š7â”Š\n â”Š7â”Š8â”Šconst Container = styled.div`\n â”Š8â”Š9â”Š  position: fixed;\n```\n```diff\n@@ -18,17 +19,19 @@\n â”Š18â”Š19â”Š    color: white;\n â”Š19â”Š20â”Š  }\n â”Š20â”Š21â”Š`;\n+â”Š  â”Š22â”Š\n â”Š21â”Š23â”Šinterface ChildComponentProps {\n â”Š22â”Š24â”Š  history: History;\n â”Š23â”Š25â”Š}\n â”Š24â”Š26â”Š\n â”Š25â”Š27â”Šconst AddChatButton: React.FC<ChildComponentProps> = ({ history }) => {\n+â”Š  â”Š28â”Š  const prefetchUsers = useUsersPrefetch();\n â”Š26â”Š29â”Š  const onClick = () => {\n â”Š27â”Š30â”Š    history.push('/new-chat');\n â”Š28â”Š31â”Š  };\n â”Š29â”Š32â”Š\n â”Š30â”Š33â”Š  return (\n-â”Š31â”Š  â”Š    <Container>\n+â”Š  â”Š34â”Š    <Container onMouseEnter={() => prefetchUsers()}>\n â”Š32â”Š35â”Š      <Button\n â”Š33â”Š36â”Š        data-testid=\"new-chat-button\"\n â”Š34â”Š37â”Š        variant=\"contained\"\n```\n\n[}]: #\n[{]: <helper> (diffStep \"15.1\" files=\"src/components/ChatsListScreen/ChatsList.tsx\" module=\"client\")\n\n#### [__Client__ Step 15.1: Implement prefetching](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/5795bf6d2ac32f6f9b3bfd9cded8c4847670dbe0)\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -5,6 +5,7 @@\n â”Š 5â”Š 5â”Šimport { useCallback } from 'react';\n â”Š 6â”Š 6â”Šimport { History } from 'history';\n â”Š 7â”Š 7â”Šimport { useChatsQuery } from '../../graphql/types';\n+â”Š  â”Š 8â”Šimport { useGetChatPrefetch } from '../ChatRoomScreen';\n â”Š 8â”Š 9â”Š\n â”Š 9â”Š10â”Šconst Container = styled.div`\n â”Š10â”Š11â”Š  height: calc(100% - 56px);\n```\n```diff\n@@ -69,6 +70,7 @@\n â”Š69â”Š70â”Š    },\n â”Š70â”Š71â”Š    [history]\n â”Š71â”Š72â”Š  );\n+â”Š  â”Š73â”Š  const prefetchChat = useGetChatPrefetch();\n â”Š72â”Š74â”Š\n â”Š73â”Š75â”Š  const { data } = useChatsQuery();\n â”Š74â”Š76â”Š\n```\n```diff\n@@ -85,7 +87,10 @@\n â”Š85â”Š87â”Š            key={chat.id}\n â”Š86â”Š88â”Š            data-testid=\"chat\"\n â”Š87â”Š89â”Š            button\n-â”Š88â”Š  â”Š            onClick={navToChat.bind(null, chat)}>\n+â”Š  â”Š90â”Š            onClick={navToChat.bind(null, chat)}\n+â”Š  â”Š91â”Š            onMouseEnter={() => {\n+â”Š  â”Š92â”Š              prefetchChat(chat.id);\n+â”Š  â”Š93â”Š            }}>\n â”Š89â”Š94â”Š            <ChatPicture\n â”Š90â”Š95â”Š              data-testid=\"picture\"\n â”Š91â”Š96â”Š              src={chat.picture}\n```\n\n[}]: #\n\n### Splitting and Deferring Queries\n\nPrefetching is an easy way to make your applications UI feel faster. You can use mouse events to predict the data that could be needed. This is powerful and works perfectly on the browser, but can not be applied to a mobile device.\n\nOne solution for improving the UI experience would be the usage of fragments to preload more data in a query, but loading huge amounts of data (that you probably never show to the user) is expensive.\n\nAnother solution would be to **split huge queries into two smaller queries**:\n\n- The first one could load data which is already in the store. This means that it can be displayed instantly.\n- The second query could load data which is not in the store yet and must be fetched from the server first.\n\nThis solution gives you the benefit of not fetching too much data, as well as the possibility to show some part of the views data before the server responds.\n\nThis could be used in our messaging app to load chatâ€™s information and messages separately. This way we will see the title and the image instantly, because itâ€™s already in the cache but messages will be loaded afterwards. UX will benefit a lot.\n\nThereâ€™s also something very similar conceptually to Query Splitting but instead of separating queries we keep everything in one operation and annotate the parts that should be deferred. The annotation is, of course a directive and itâ€™s called **`@defer`**.\n\nOnce the `@defer` is used, the server returns an initial response without waiting for deferred fields to resolve, using null as placeholders for them. Then, it streams patches for each deferred field asynchronously as they resolve. Thanks to that, we maintain one operation but decide how it behaves.\n\n> Right now, this feature is not well supported in Apollo Server so we donâ€™t recommend to use it yet. Keep it on mind though.\n\n### Dealing with rendering issues\n\nThe most naive thing we can do to start noticing performance issues would be loading TONS of data to our app, and make sure that each view is absolutely overwhelmed with information. This way performance issues will start rising above the surface pretty quickly. To do that, we will edit the `resetDb()` method on the server so it can generate large quantities of data. The most comfortable way of controlling that behavior would be through an environment variable that will tell the reset method how much iterations it should run. The more iterations, the more data would be fabricated:\n\n[{]: <helper> (diffStep \"15.10\" module=\"server\")\n\n#### Step 15.10: NOT FOUND!\n\n[}]: #\n\nItâ€™s important to note that weâ€™ve generated the data in a very specific way where a single user will be the center of the network of data. This way when we log in with that user, we should see our views packed. If it wasnâ€™t for that we would have just had large quantities of data in the DB, but none of it would appear to the end-user.\n\nNow, we will restart the server and this time run it differently. We will provide `FAKED_DB` with a value of `100` which should connect us to 100 messages per single view:\n\n    RESET_DB=true FAKED_DB=100 yarn start\n\nNow make sure that the application is running and log-in with the first user of Ray Edwards using the credentials:\n\n    username: ray\n    passowrd: 111\n\nNow try to navigate around between the `ChatsScreen` and `ChatBoxScreen`. Youâ€™ll notice that each transition takes a long time until it shows the data. Itâ€™s obviously something which is related to rendering and not data transportation, because the slowdown also happens the second time you visit a view, a point where the fetched data should have already been stored by Apollo in cache. So weâ€™ve already detected one performance issue we should deal with.\n\n### Pagination\n\nTo solve it, there are couple of changes weâ€™re gonna make in the way we ask for data, messages will be fetched dynamically based on our scrolling position.\n\nWith these changes, the requests will be splitted into smaller chunks, and React DOM wonâ€™t have to deal with a lot of data the first time it loads. There are few challenges that may arise from this implementation:\n\n- Representing queries in a way that they can be loaded in chunks\n- Sending requests and updating the view dynamically\n- Maintaining updates from subscriptions\n\nTo start with, we will first take on the task of improving initialization times. We will release the pressure by fetching only the first 20 messages. This way when we visit a chat, it should be loaded faster.\n\nFor that we're going to implement cursor-based pagination. We will add `after` and `limit` arguments to `Chat.messages` that could be used to fetch a specific snapshot of available messages.\n\n- `after` is optional and marks the point where the last fetch ended (what is the last element of a received list)\n- `limit` is required, defines amount of data\n\nA common design pattern for fetching data snapshots from a GraphQL back-end is called [Relay](https://facebook.github.io/relay/docs/en/graphql-server-specification.html). Relay provides a robust solution which is suitable for things like search engines.\n\nWe will define our own version of it.\n\n[{]: <helper> (diffStep \"14.9\" module=\"server\")\n\n#### [__Server__ Step 14.9: Add fake data](https://github.com/Urigo/WhatsApp-Clone-Server/commit/10d1673d976ea881d474ac7ea30cc997fbdd1495)\n\n##### Changed db.ts\n```diff\n@@ -1,6 +1,8 @@\n â”Š1â”Š1â”Šimport { Pool } from 'pg';\n â”Š2â”Š2â”Šimport sql from 'sql-template-strings';\n-â”Š3â”Š â”Šimport { resetDb as envResetDb } from './env';\n+â”Š â”Š3â”Šimport faker from 'faker';\n+â”Š â”Š4â”Šimport addMinutes from 'date-fns/add_minutes';\n+â”Š â”Š5â”Šimport { resetDb as envResetDb, fakedDb } from './env';\n â”Š4â”Š6â”Š\n â”Š5â”Š7â”Šexport type User = {\n â”Š6â”Š8â”Š  id: string;\n```\n```diff\n@@ -234,6 +236,10 @@\n â”Š234â”Š236â”Š    },\n â”Š235â”Š237â”Š  ];\n â”Š236â”Š238â”Š\n+â”Š   â”Š239â”Š  if (fakedDb) {\n+â”Š   â”Š240â”Š    addFakedMessages(sampleMessages, fakedDb);\n+â”Š   â”Š241â”Š  }\n+â”Š   â”Š242â”Š\n â”Š237â”Š243â”Š  for (const sampleMessage of sampleMessages) {\n â”Š238â”Š244â”Š    await pool.query(sql`\n â”Š239â”Š245â”Š      INSERT INTO messages(id, content, created_at, chat_id, sender_user_id)\n```\n```diff\n@@ -248,6 +254,21 @@\n â”Š248â”Š254â”Š  );\n â”Š249â”Š255â”Š};\n â”Š250â”Š256â”Š\n+â”Š   â”Š257â”Šfunction addFakedMessages(messages: Message[], count: number) {\n+â”Š   â”Š258â”Š  const message = messages[0];\n+â”Š   â”Š259â”Š  const date = message.created_at;\n+â”Š   â”Š260â”Š  const id = messages.length + 1;\n+â”Š   â”Š261â”Š\n+â”Š   â”Š262â”Š  new Array(count).fill(0).forEach((_, i) => {\n+â”Š   â”Š263â”Š    messages.push({\n+â”Š   â”Š264â”Š      ...message,\n+â”Š   â”Š265â”Š      id: `${id + i}`,\n+â”Š   â”Š266â”Š      content: faker.lorem.sentence(4),\n+â”Š   â”Š267â”Š      created_at: addMinutes(date, i + 1),\n+â”Š   â”Š268â”Š    });\n+â”Š   â”Š269â”Š  });\n+â”Š   â”Š270â”Š}\n+â”Š   â”Š271â”Š\n â”Š251â”Š272â”Šif (envResetDb) {\n â”Š252â”Š273â”Š  resetDb();\n â”Š253â”Š274â”Š}\n```\n\n##### Changed env.ts\n```diff\n@@ -5,3 +5,6 @@\n â”Š 5â”Š 5â”Šexport const origin = process.env.ORIGIN || 'http://localhost:3000';\n â”Š 6â”Š 6â”Šexport const port = process.env.PORT || 4000;\n â”Š 7â”Š 7â”Šexport const resetDb = process.env.RESET_DB || false;\n+â”Š  â”Š 8â”Šexport const fakedDb = process.env.FAKED_DB\n+â”Š  â”Š 9â”Š  ? parseInt(process.env.FAKED_DB, 10)\n+â”Š  â”Š10â”Š  : 0;\n```\n\n##### Changed package.json\n```diff\n@@ -25,6 +25,7 @@\n â”Š25â”Š25â”Š    \"@types/cookie\": \"0.3.3\",\n â”Š26â”Š26â”Š    \"@types/cookie-parser\": \"1.4.1\",\n â”Š27â”Š27â”Š    \"@types/express\": \"4.17.0\",\n+â”Š  â”Š28â”Š    \"@types/faker\": \"4.1.5\",\n â”Š28â”Š29â”Š    \"@types/graphql\": \"14.2.3\",\n â”Š29â”Š30â”Š    \"@types/graphql-iso-date\": \"3.3.1\",\n â”Š30â”Š31â”Š    \"@types/jest\": \"24.0.17\",\n```\n```diff\n@@ -52,7 +53,9 @@\n â”Š52â”Š53â”Š    \"cors\": \"2.8.5\",\n â”Š53â”Š54â”Š    \"cookie-parser\": \"1.4.4\",\n â”Š54â”Š55â”Š    \"dataloader\": \"1.4.0\",\n+â”Š  â”Š56â”Š    \"date-fns\": \"1.30.1\",\n â”Š55â”Š57â”Š    \"express\": \"4.17.1\",\n+â”Š  â”Š58â”Š    \"faker\": \"4.1.0\",\n â”Š56â”Š59â”Š    \"graphql\": \"14.4.2\",\n â”Š57â”Š60â”Š    \"graphql-import\": \"0.7.1\",\n â”Š58â”Š61â”Š    \"graphql-iso-date\": \"3.6.1\",\n```\n\n[}]: #\n\nThe `MessagesResult` is built of:\n\n- `cursor` - marks the end of a fetched list\n- `hasMore` - tells if there's more data to ask for\n- `message` - has the same type as `Chat.messages` previously had\n\nBecause the cursor marks the edge of received data, it has to be something we could use while sorting. The most obvious choice is the date of creation, so `created_at` column of `messages` table.\n\nIt's stored as `YYYY-MM-DD HH:mm:ss` but we want to expose it as something easier to work with, let's say a `number`.\n\nIn order to do it quickly, let's add `date-fns` package:\n\n    npm install date-fns\n\nIt has `format` method that will help us to do conversions.\n\nWe need to the logic of `Chats.findMessagesByChat` method.\n\n[{]: <helper> (diffStep \"14.11\" module=\"server\")\n\n#### [__Server__ Step 14.11: Implement cursor-based pagination in messages](https://github.com/Urigo/WhatsApp-Clone-Server/commit/152d95eebac8af642da92bf5965fbc2a15dc60bf)\n\n##### Changed modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -2,6 +2,7 @@\n â”Š2â”Š2â”Šimport { QueryResult } from 'pg';\n â”Š3â”Š3â”Šimport sql from 'sql-template-strings';\n â”Š4â”Š4â”Šimport DataLoader from 'dataloader';\n+â”Š â”Š5â”Šimport format from 'date-fns/format';\n â”Š5â”Š6â”Šimport { Database } from '../common/database.provider';\n â”Š6â”Š7â”Šimport { PubSub } from '../common/pubsub.provider';\n â”Š7â”Š8â”Šimport { Chat } from '../../db';\n```\n```diff\n@@ -107,12 +108,55 @@\n â”Š107â”Š108â”Š    return rows;\n â”Š108â”Š109â”Š  }\n â”Š109â”Š110â”Š\n-â”Š110â”Š   â”Š  async findMessagesByChat(chatId: string) {\n-â”Š111â”Š   â”Š    const { rows } = await this.db.query(\n-â”Š112â”Š   â”Š      sql`SELECT * FROM messages WHERE chat_id = ${chatId}`\n+â”Š   â”Š111â”Š  async findMessagesByChat({\n+â”Š   â”Š112â”Š    chatId,\n+â”Š   â”Š113â”Š    limit,\n+â”Š   â”Š114â”Š    after,\n+â”Š   â”Š115â”Š  }: {\n+â”Š   â”Š116â”Š    chatId: string;\n+â”Š   â”Š117â”Š    limit: number;\n+â”Š   â”Š118â”Š    after?: number | null;\n+â”Š   â”Š119â”Š  }): Promise<{\n+â”Š   â”Š120â”Š    hasMore: boolean;\n+â”Š   â”Š121â”Š    cursor: number | null;\n+â”Š   â”Š122â”Š    messages: any[];\n+â”Š   â”Š123â”Š  }> {\n+â”Š   â”Š124â”Š    const query = sql`SELECT * FROM messages`;\n+â”Š   â”Š125â”Š    query.append(` WHERE chat_id = ${chatId}`);\n+â”Š   â”Š126â”Š\n+â”Š   â”Š127â”Š    if (after) {\n+â”Š   â”Š128â”Š      // the created_at is the cursor\n+â”Š   â”Š129â”Š      query.append(` AND created_at < ${cursorToDate(after)}`);\n+â”Š   â”Š130â”Š    }\n+â”Š   â”Š131â”Š\n+â”Š   â”Š132â”Š    query.append(` ORDER BY created_at DESC LIMIT ${limit}`);\n+â”Š   â”Š133â”Š\n+â”Š   â”Š134â”Š    const { rows: messages } = await this.db.query(query);\n+â”Š   â”Š135â”Š\n+â”Š   â”Š136â”Š    if (!messages) {\n+â”Š   â”Š137â”Š      return {\n+â”Š   â”Š138â”Š        hasMore: false,\n+â”Š   â”Š139â”Š        cursor: null,\n+â”Š   â”Š140â”Š        messages: [],\n+â”Š   â”Š141â”Š      };\n+â”Š   â”Š142â”Š    }\n+â”Š   â”Š143â”Š\n+â”Š   â”Š144â”Š    // so we send them as old -> new\n+â”Š   â”Š145â”Š    messages.reverse();\n+â”Š   â”Š146â”Š\n+â”Š   â”Š147â”Š    // cursor is a number representation of created_at\n+â”Š   â”Š148â”Š    const cursor = messages.length ? new Date(messages[0].created_at).getTime() : 0;\n+â”Š   â”Š149â”Š    const { rows: next } = await this.db.query(\n+â”Š   â”Š150â”Š      sql`SELECT * FROM messages WHERE chat_id = ${chatId} AND created_at < ${cursorToDate(\n+â”Š   â”Š151â”Š        cursor\n+â”Š   â”Š152â”Š      )} ORDER BY created_at DESC LIMIT 1`\n â”Š113â”Š153â”Š    );\n â”Š114â”Š154â”Š\n-â”Š115â”Š   â”Š    return rows;\n+â”Š   â”Š155â”Š    return {\n+â”Š   â”Š156â”Š      hasMore: next.length === 1, // means there's no more messages\n+â”Š   â”Š157â”Š      cursor,\n+â”Š   â”Š158â”Š      messages,\n+â”Š   â”Š159â”Š    };\n â”Š116â”Š160â”Š  }\n â”Š117â”Š161â”Š\n â”Š118â”Š162â”Š  async lastMessage(chatId: string) {\n```\n```diff\n@@ -280,3 +324,7 @@\n â”Š280â”Š324â”Š    }\n â”Š281â”Š325â”Š  }\n â”Š282â”Š326â”Š}\n+â”Š   â”Š327â”Š\n+â”Š   â”Š328â”Šfunction cursorToDate(cursor: number) {\n+â”Š   â”Š329â”Š  return `'${format(cursor, 'YYYY-MM-DD HH:mm:ss')}'`;\n+â”Š   â”Š330â”Š}\n```\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -111,7 +111,11 @@\n â”Š111â”Š111â”Š    },\n â”Š112â”Š112â”Š\n â”Š113â”Š113â”Š    async messages(chat, args, { injector }) {\n-â”Š114â”Š   â”Š      return injector.get(Chats).findMessagesByChat(chat.id);\n+â”Š   â”Š114â”Š      return injector.get(Chats).findMessagesByChat({\n+â”Š   â”Š115â”Š        chatId: chat.id,\n+â”Š   â”Š116â”Š        limit: args.limit,\n+â”Š   â”Š117â”Š        after: args.after,\n+â”Š   â”Š118â”Š      });\n â”Š115â”Š119â”Š    },\n â”Š116â”Š120â”Š\n â”Š117â”Š121â”Š    async lastMessage(chat, args, { injector }) {\n```\n\n[}]: #\n\nBecause the order of creation matters, messages are selected quite differently than before, we keep selecting all columns but records are ordered by the date of creation.\n\nThere's an interesting thing related to the cursor. If it's provided, we query for only those messages that happened before our cursor. This way we have a valid direction, fetching more messages means fetching older records.\n\nThe last message in the list becomes of course the `cursor`.\n\nIn order to calculate `hasMore` we need to apply the same conditions as above but with `LIMIT 1` and see if we get a result.\n\nSince the API part is done, let's take care of something much more complicated, which is always the UI...\n\nLet's plan it first. We know we want to fetch more messages while scrolling up. That means, Infinite Scroll with a corresponding request each time we hit the top. Because we implemented prefetching, we need to know what's the `limit`. React's Context might be helpful here. There was, of course, the change in GraphQL Schema we need to take care of too.\n\n### Apply schema changes\n\nSince we know what the plan is, let's start with schema changes. The `Chat.messages` is no longer a list, it's an object now.\n\n[{]: <helper> (diffStep \"15.6\" module=\"client\")\n\n#### [__Client__ Step 15.6: Apply MessagesResult type](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/93c74a039bb3829644d4399255580b4fc833bd28)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -27,7 +27,7 @@\n â”Š27â”Š27â”Š\n â”Š28â”Š28â”Š// eslint-disable-next-line\n â”Š29â”Š29â”Šconst getChatQuery = gql`\n-â”Š30â”Š  â”Š  query GetChat($chatId: ID!) {\n+â”Š  â”Š30â”Š  query GetChat($chatId: ID!, $limit: Int!, $after: Float) {\n â”Š31â”Š31â”Š    chat(chatId: $chatId) {\n â”Š32â”Š32â”Š      ...FullChat\n â”Š33â”Š33â”Š    }\n```\n\n##### Changed src&#x2F;graphql&#x2F;fragments&#x2F;fullChat.fragment.ts\n```diff\n@@ -1,14 +1,14 @@\n â”Š 1â”Š 1â”Šimport gql from 'graphql-tag';\n â”Š 2â”Š 2â”Šimport chat from './chat.fragment';\n-â”Š 3â”Š  â”Šimport message from './message.fragment';\n+â”Š  â”Š 3â”Šimport messagesResult from './messagesResult.fragment';\n â”Š 4â”Š 4â”Š\n â”Š 5â”Š 5â”Šexport default gql`\n â”Š 6â”Š 6â”Š  fragment FullChat on Chat {\n â”Š 7â”Š 7â”Š    ...Chat\n-â”Š 8â”Š  â”Š    messages {\n-â”Š 9â”Š  â”Š      ...Message\n+â”Š  â”Š 8â”Š    messages(limit: $limit, after: $after) @connection(key: \"messages\") {\n+â”Š  â”Š 9â”Š      ...MessagesResult\n â”Š10â”Š10â”Š    }\n â”Š11â”Š11â”Š  }\n â”Š12â”Š12â”Š  ${chat}\n-â”Š13â”Š  â”Š  ${message}\n+â”Š  â”Š13â”Š  ${messagesResult}\n â”Š14â”Š14â”Š`;\n```\n\n##### Added src&#x2F;graphql&#x2F;fragments&#x2F;messagesResult.fragment.ts\n```diff\n@@ -0,0 +1,13 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag';\n+â”Š  â”Š 2â”Šimport message from './message.fragment';\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šexport default gql`\n+â”Š  â”Š 5â”Š  fragment MessagesResult on MessagesResult {\n+â”Š  â”Š 6â”Š    cursor\n+â”Š  â”Š 7â”Š    hasMore\n+â”Š  â”Š 8â”Š    messages {\n+â”Š  â”Š 9â”Š      ...Message\n+â”Š  â”Š10â”Š    }\n+â”Š  â”Š11â”Š  }\n+â”Š  â”Š12â”Š  ${message}\n+â”Š  â”Š13â”Š`;\n```\n\n##### Changed src&#x2F;services&#x2F;cache.service.ts\n```diff\n@@ -61,9 +61,9 @@\n â”Š61â”Š61â”Š  if (fullChat === null || fullChat.messages === null) {\n â”Š62â”Š62â”Š    return;\n â”Š63â”Š63â”Š  }\n-â”Š64â”Š  â”Š  if (fullChat.messages.some((m: any) => m.id === message.id)) return;\n+â”Š  â”Š64â”Š  if (fullChat.messages.messages.some((m: any) => m.id === message.id)) return;\n â”Š65â”Š65â”Š\n-â”Š66â”Š  â”Š  fullChat.messages.push(message);\n+â”Š  â”Š66â”Š  fullChat.messages.messages.push(message);\n â”Š67â”Š67â”Š  fullChat.lastMessage = message;\n â”Š68â”Š68â”Š\n â”Š69â”Š69â”Š  client.writeFragment({\n```\n\n[}]: #\n\nNow we need reflect those changes in generated hooks by running:\n\n    yarn codegen\n\nOkay, let's move on!\n\n### Infinite Scrolling\n\nNow this Infinite Scroll thing. The core concept is to ask for more data, once a user's scrollbar hits the top edge of the screen.\n\n[{]: <helper> (diffStep \"15.2\" module=\"client\")\n\n#### [__Client__ Step 15.2: Basics for infinite scroll](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/7a97ee1750777a513208d698e9653d3cbb193f3f)\n\n##### Added src&#x2F;hooks&#x2F;use-infinite-scroll.ts\n```diff\n@@ -0,0 +1,32 @@\n+â”Š  â”Š 1â”Šimport { useEffect, useCallback, RefObject } from 'react';\n+â”Š  â”Š 2â”Š\n+â”Š  â”Š 3â”Šexport const useInfiniteScroll = ({\n+â”Š  â”Š 4â”Š  ref,\n+â”Š  â”Š 5â”Š  onLoadMore,\n+â”Š  â”Š 6â”Š}: {\n+â”Š  â”Š 7â”Š  onLoadMore: Function;\n+â”Š  â”Š 8â”Š  ref: RefObject<HTMLElement>;\n+â”Š  â”Š 9â”Š}) => {\n+â”Š  â”Š10â”Š  const handleScroll = useCallback(() => {\n+â”Š  â”Š11â”Š    if (ref.current!.scrollTop === 0) {\n+â”Š  â”Š12â”Š      // loads more if scrolled to top\n+â”Š  â”Š13â”Š      onLoadMore();\n+â”Š  â”Š14â”Š    }\n+â”Š  â”Š15â”Š  }, [ref, onLoadMore]);\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š  useEffect(() => {\n+â”Š  â”Š18â”Š    const elem = ref.current;\n+â”Š  â”Š19â”Š\n+â”Š  â”Š20â”Š    if (!elem) {\n+â”Š  â”Š21â”Š      return;\n+â”Š  â”Š22â”Š    }\n+â”Š  â”Š23â”Š\n+â”Š  â”Š24â”Š    elem.addEventListener('scroll', handleScroll);\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Š    return () => {\n+â”Š  â”Š27â”Š      elem!.removeEventListener('scroll', handleScroll);\n+â”Š  â”Š28â”Š    };\n+â”Š  â”Š29â”Š  }, [ref, handleScroll]);\n+â”Š  â”Š30â”Š};\n+â”Š  â”Š31â”Š\n+â”Š  â”Š32â”Šexport default useInfiniteScroll;\n```\n\n[}]: #\n\nOur `useInfiniteScroll` hook requires:\n\n- `ref` is a reference of a HTML element\n- `onLoadMore` calls the part component back and asks for data\n\nWe used `useEffect` to add and remove a scroll event listener. The function lives as long as `ref` and `onLoadMore` stay the same, that's because we simply make use of them in `handleScroll` function. The `handleScroll` function calls `onLoadMore` when a user scrolled to the top.\n\nIt all looks fine at first, but we still need to prevent calling back once fetching is in progress.\n\n[{]: <helper> (diffStep \"15.3\" module=\"client\")\n\n#### [__Client__ Step 15.3: Prevent calling back once fetching is in progress](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/e2a43c49b6366ea6a557df0159326d15a1e6e576)\n\n##### Changed src&#x2F;hooks&#x2F;use-infinite-scroll.ts\n```diff\n@@ -1,4 +1,4 @@\n-â”Š1â”Š â”Šimport { useEffect, useCallback, RefObject } from 'react';\n+â”Š â”Š1â”Šimport { useState, useEffect, useCallback, RefObject } from 'react';\n â”Š2â”Š2â”Š\n â”Š3â”Š3â”Šexport const useInfiniteScroll = ({\n â”Š4â”Š4â”Š  ref,\n```\n```diff\n@@ -7,12 +7,13 @@\n â”Š 7â”Š 7â”Š  onLoadMore: Function;\n â”Š 8â”Š 8â”Š  ref: RefObject<HTMLElement>;\n â”Š 9â”Š 9â”Š}) => {\n+â”Š  â”Š10â”Š  const [isFetching, setIsFetching] = useState(false);\n â”Š10â”Š11â”Š  const handleScroll = useCallback(() => {\n-â”Š11â”Š  â”Š    if (ref.current!.scrollTop === 0) {\n-â”Š12â”Š  â”Š      // loads more if scrolled to top\n-â”Š13â”Š  â”Š      onLoadMore();\n+â”Š  â”Š12â”Š    if (ref.current!.scrollTop === 0 && isFetching === false) {\n+â”Š  â”Š13â”Š      // starts to fetch if scrolled to top and fetching is not in progress\n+â”Š  â”Š14â”Š      setIsFetching(true);\n â”Š14â”Š15â”Š    }\n-â”Š15â”Š  â”Š  }, [ref, onLoadMore]);\n+â”Š  â”Š16â”Š  }, [ref, isFetching]);\n â”Š16â”Š17â”Š\n â”Š17â”Š18â”Š  useEffect(() => {\n â”Š18â”Š19â”Š    const elem = ref.current;\n```\n```diff\n@@ -27,6 +28,13 @@\n â”Š27â”Š28â”Š      elem!.removeEventListener('scroll', handleScroll);\n â”Š28â”Š29â”Š    };\n â”Š29â”Š30â”Š  }, [ref, handleScroll]);\n+â”Š  â”Š31â”Š\n+â”Š  â”Š32â”Š  // loads more if fetching has started\n+â”Š  â”Š33â”Š  useEffect(() => {\n+â”Š  â”Š34â”Š    if (isFetching) {\n+â”Š  â”Š35â”Š      onLoadMore();\n+â”Š  â”Š36â”Š    }\n+â”Š  â”Š37â”Š  }, [isFetching, onLoadMore]);\n â”Š30â”Š38â”Š};\n â”Š31â”Š39â”Š\n â”Š32â”Š40â”Šexport default useInfiniteScroll;\n```\n\n[}]: #\n\nThat's why `isFetching` state is necessary but as you can tell, we don't set it to `false`.\n\n[{]: <helper> (diffStep \"15.4\" module=\"client\")\n\n#### [__Client__ Step 15.4: Allow to notify when finished](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/35b28a390857993cc84bdf8533ace9fb17e749c1)\n\n##### Changed src&#x2F;hooks&#x2F;use-infinite-scroll.ts\n```diff\n@@ -6,7 +6,7 @@\n â”Š 6â”Š 6â”Š}: {\n â”Š 7â”Š 7â”Š  onLoadMore: Function;\n â”Š 8â”Š 8â”Š  ref: RefObject<HTMLElement>;\n-â”Š 9â”Š  â”Š}) => {\n+â”Š  â”Š 9â”Š}): [boolean, () => void] => {\n â”Š10â”Š10â”Š  const [isFetching, setIsFetching] = useState(false);\n â”Š11â”Š11â”Š  const handleScroll = useCallback(() => {\n â”Š12â”Š12â”Š    if (ref.current!.scrollTop === 0 && isFetching === false) {\n```\n```diff\n@@ -35,6 +35,12 @@\n â”Š35â”Š35â”Š      onLoadMore();\n â”Š36â”Š36â”Š    }\n â”Š37â”Š37â”Š  }, [isFetching, onLoadMore]);\n+â”Š  â”Š38â”Š\n+â”Š  â”Š39â”Š  const stopFetching = useCallback(() => {\n+â”Š  â”Š40â”Š    setIsFetching(false);\n+â”Š  â”Š41â”Š  }, []);\n+â”Š  â”Š42â”Š\n+â”Š  â”Š43â”Š  return [isFetching, stopFetching];\n â”Š38â”Š44â”Š};\n â”Š39â”Š45â”Š\n â”Š40â”Š46â”Šexport default useInfiniteScroll;\n```\n\n[}]: #\n\nWe want the consumer of the hook to tell it when fetching is finished, that's why we expose the state with `stopFetching` function.\n\nThe next issue that appears right away is related to the case when there's no more data to fetch.\n\n[{]: <helper> (diffStep \"15.5\" module=\"client\")\n\n#### [__Client__ Step 15.5: Fetch only if there is more data](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/e095cbd46fee607433f7ec099a85c0572c24cb12)\n\n##### Changed src&#x2F;hooks&#x2F;use-infinite-scroll.ts\n```diff\n@@ -2,18 +2,20 @@\n â”Š 2â”Š 2â”Š\n â”Š 3â”Š 3â”Šexport const useInfiniteScroll = ({\n â”Š 4â”Š 4â”Š  ref,\n+â”Š  â”Š 5â”Š  hasMore,\n â”Š 5â”Š 6â”Š  onLoadMore,\n â”Š 6â”Š 7â”Š}: {\n â”Š 7â”Š 8â”Š  onLoadMore: Function;\n+â”Š  â”Š 9â”Š  hasMore: boolean;\n â”Š 8â”Š10â”Š  ref: RefObject<HTMLElement>;\n â”Š 9â”Š11â”Š}): [boolean, () => void] => {\n â”Š10â”Š12â”Š  const [isFetching, setIsFetching] = useState(false);\n â”Š11â”Š13â”Š  const handleScroll = useCallback(() => {\n-â”Š12â”Š  â”Š    if (ref.current!.scrollTop === 0 && isFetching === false) {\n-â”Š13â”Š  â”Š      // starts to fetch if scrolled to top and fetching is not in progress\n+â”Š  â”Š14â”Š    if (ref.current!.scrollTop === 0 && isFetching === false && hasMore) {\n+â”Š  â”Š15â”Š      // starts to fetch if scrolled to top, fetching is not in progress and has more data\n â”Š14â”Š16â”Š      setIsFetching(true);\n â”Š15â”Š17â”Š    }\n-â”Š16â”Š  â”Š  }, [ref, isFetching]);\n+â”Š  â”Š18â”Š  }, [ref, isFetching, hasMore]);\n â”Š17â”Š19â”Š\n â”Š18â”Š20â”Š  useEffect(() => {\n â”Š19â”Š21â”Š    const elem = ref.current;\n```\n\n[}]: #\n\nPfff... The hook part is done!\n\n### Pagination\n\nPagination is partially implemented thanks to Infinite Scrolling but the thing we need to still apply is React's context. It will be a central place of storing `limit` and `after` values, so they could be shared across multiple components and not passed directly from one to another.\n\n[{]: <helper> (diffStep \"15.7\" module=\"client\")\n\n#### [__Client__ Step 15.7: Implement pagination with context and hooks](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/9c7387b29d87fb8ae9464207a9b6f569865e88e7)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -1,6 +1,6 @@\n â”Š1â”Š1â”Šimport gql from 'graphql-tag';\n â”Š2â”Š2â”Šimport React from 'react';\n-â”Š3â”Š â”Šimport { useCallback } from 'react';\n+â”Š â”Š3â”Šimport { useCallback, useState, useContext, useEffect } from 'react';\n â”Š4â”Š4â”Šimport { Redirect } from 'react-router-dom';\n â”Š5â”Š5â”Šimport { useApolloClient } from '@apollo/react-hooks';\n â”Š6â”Š6â”Šimport styled from 'styled-components';\n```\n```diff\n@@ -45,6 +45,48 @@\n â”Š45â”Š45â”Š  ${fragments.message}\n â”Š46â”Š46â”Š`;\n â”Š47â”Š47â”Š\n+â”Š  â”Š48â”Šconst PaginationContext = React.createContext({\n+â”Š  â”Š49â”Š  after: 0,\n+â”Š  â”Š50â”Š  limit: 20,\n+â”Š  â”Š51â”Š  /**\n+â”Š  â”Š52â”Š   * Sets new cursor\n+â”Š  â”Š53â”Š   */\n+â”Š  â”Š54â”Š  setAfter: (after: number) => {},\n+â”Š  â”Š55â”Š  /**\n+â”Š  â”Š56â”Š   * Resets `after` value to its inital state (null) so\n+â”Š  â”Š57â”Š   */\n+â”Š  â”Š58â”Š  reset: () => {},\n+â”Š  â”Š59â”Š});\n+â”Š  â”Š60â”Š\n+â”Š  â”Š61â”Šconst usePagination = () => {\n+â”Š  â”Š62â”Š  const pagination = useContext(PaginationContext);\n+â”Š  â”Š63â”Š\n+â”Š  â”Š64â”Š  // Resets the pagination every time a component did unmount\n+â”Š  â”Š65â”Š  useEffect(() => {\n+â”Š  â”Š66â”Š    return () => {\n+â”Š  â”Š67â”Š      pagination.reset();\n+â”Š  â”Š68â”Š    };\n+â”Š  â”Š69â”Š  }, [pagination]);\n+â”Š  â”Š70â”Š\n+â”Š  â”Š71â”Š  return pagination;\n+â”Š  â”Š72â”Š};\n+â”Š  â”Š73â”Š\n+â”Š  â”Š74â”Šexport const ChatPaginationProvider = ({ children }: { children: any }) => {\n+â”Š  â”Š75â”Š  const [after, setAfter] = useState<number | null>(null);\n+â”Š  â”Š76â”Š\n+â”Š  â”Š77â”Š  return (\n+â”Š  â”Š78â”Š    <PaginationContext.Provider\n+â”Š  â”Š79â”Š      value={{\n+â”Š  â”Š80â”Š        limit: 20,\n+â”Š  â”Š81â”Š        after: after!,\n+â”Š  â”Š82â”Š        setAfter,\n+â”Š  â”Š83â”Š        reset: () => setAfter(null),\n+â”Š  â”Š84â”Š      }}>\n+â”Š  â”Š85â”Š      {children}\n+â”Š  â”Š86â”Š    </PaginationContext.Provider>\n+â”Š  â”Š87â”Š  );\n+â”Š  â”Š88â”Š};\n+â”Š  â”Š89â”Š\n â”Š48â”Š90â”Šexport const useGetChatPrefetch = () => {\n â”Š49â”Š91â”Š  const client = useApolloClient();\n```\n\n[}]: #\n\nWe implemented three things:\n\n- `PaginationContext` is simple, it stores the values but also allows to set a new one for `after` or even bring it all back to the initial state.\n- `usePagination` hook is there so components could use `PaginationContext` and to make sure we reset it when component unmounts.\n- `ChatPaginationProvider` provides the logic and core functionality\n\nSince the pagination is almost ready, let's make use of it in `useGetChatPrefetch` hook and `ChatRoomScreen` component.\n\n[{]: <helper> (diffStep \"15.8\" module=\"client\")\n\n#### [__Client__ Step 15.8: Use pagination limit and after props](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/a8349f8412fcb503cecea99ae0752145538edce0)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -89,12 +89,15 @@\n â”Š 89â”Š 89â”Š\n â”Š 90â”Š 90â”Šexport const useGetChatPrefetch = () => {\n â”Š 91â”Š 91â”Š  const client = useApolloClient();\n+â”Š   â”Š 92â”Š  const { limit, after } = usePagination();\n â”Š 92â”Š 93â”Š\n â”Š 93â”Š 94â”Š  return (chatId: string) => {\n â”Š 94â”Š 95â”Š    client.query<GetChatQuery, GetChatQueryVariables>({\n â”Š 95â”Š 96â”Š      query: GetChatDocument,\n â”Š 96â”Š 97â”Š      variables: {\n â”Š 97â”Š 98â”Š        chatId,\n+â”Š   â”Š 99â”Š        after,\n+â”Š   â”Š100â”Š        limit,\n â”Š 98â”Š101â”Š      },\n â”Š 99â”Š102â”Š    });\n â”Š100â”Š103â”Š  };\n```\n```diff\n@@ -109,8 +112,9 @@\n â”Š109â”Š112â”Š  history,\n â”Š110â”Š113â”Š  chatId,\n â”Š111â”Š114â”Š}) => {\n+â”Š   â”Š115â”Š  const { after, limit } = usePagination();\n â”Š112â”Š116â”Š  const { data, loading } = useGetChatQuery({\n-â”Š113â”Š   â”Š    variables: { chatId },\n+â”Š   â”Š117â”Š    variables: { chatId, after, limit },\n â”Š114â”Š118â”Š  });\n â”Š115â”Š119â”Š\n â”Š116â”Š120â”Šconst [addMessage] = useAddMessageMutation();\n```\n\n[}]: #\n\nThis won't work yet because there's nothing that creates the context.\n\n[{]: <helper> (diffStep \"15.9\" module=\"client\")\n\n#### [__Client__ Step 15.9: Use ChatPaginationProvider](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/32e7a05f8146fe980f699b7a2d09e3a5fe5b7a7e)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -108,10 +108,7 @@\n â”Š108â”Š108â”Š  history: History;\n â”Š109â”Š109â”Š}\n â”Š110â”Š110â”Š\n-â”Š111â”Š   â”Šconst ChatRoomScreen: React.FC<ChatRoomScreenParams> = ({\n-â”Š112â”Š   â”Š  history,\n-â”Š113â”Š   â”Š  chatId,\n-â”Š114â”Š   â”Š}) => {\n+â”Š   â”Š111â”Šconst ChatRoom: React.FC<ChatRoomScreenParams> = ({ history, chatId }) => {\n â”Š115â”Š112â”Š  const { after, limit } = usePagination();\n â”Š116â”Š113â”Š  const { data, loading } = useGetChatQuery({\n â”Š117â”Š114â”Š    variables: { chatId, after, limit },\n```\n```diff\n@@ -176,4 +173,15 @@\n â”Š176â”Š173â”Š  );\n â”Š177â”Š174â”Š};\n â”Š178â”Š175â”Š\n+â”Š   â”Š176â”Šconst ChatRoomScreen: React.FC<ChatRoomScreenParams> = ({\n+â”Š   â”Š177â”Š  history,\n+â”Š   â”Š178â”Š  chatId,\n+â”Š   â”Š179â”Š}) => {\n+â”Š   â”Š180â”Š  return (\n+â”Š   â”Š181â”Š    <ChatPaginationProvider>\n+â”Š   â”Š182â”Š      <ChatRoom history={history} chatId={chatId} />\n+â”Š   â”Š183â”Š    </ChatPaginationProvider>\n+â”Š   â”Š184â”Š  );\n+â”Š   â”Š185â”Š};\n+â”Š   â”Š186â”Š\n â”Š179â”Š187â”Šexport default ChatRoomScreen;\n```\n\n[}]: #\n\nWe had to split the `ChatRoomScreen` into two pieces. One that includes `ChatPaginationProvider` and produces `chatId` and the other that keeps pretty much everything else. This way the tree of child components, starting from `ChatRoom` share the same context.\n\n### Fetching more messages\n\nEverything is set up, we can now move on and consume the `useInfiniteScroll` in the `MessagesList` component.\n\n[{]: <helper> (diffStep \"15.10\" module=\"client\")\n\n#### [__Client__ Step 15.10: Make use of infinite scroll in MessagesList component](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/f3f57db460fafd2d85386b72131f1acba5270e4c)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;MessagesList.tsx\n```diff\n@@ -3,14 +3,27 @@\n â”Š 3â”Š 3â”Šimport { useEffect, useRef } from 'react';\n â”Š 4â”Š 4â”Šimport ReactDOM from 'react-dom';\n â”Š 5â”Š 5â”Šimport styled, { css } from 'styled-components';\n+â”Š  â”Š 6â”Šimport { useInfiniteScroll } from '../../hooks/use-infinite-scroll';\n â”Š 6â”Š 7â”Š\n â”Š 7â”Š 8â”Šconst Container = styled.div`\n+â”Š  â”Š 9â”Š  position: relative;\n â”Š 8â”Š10â”Š  display: block;\n â”Š 9â”Š11â”Š  flex: 2;\n â”Š10â”Š12â”Š  overflow-y: overlay;\n â”Š11â”Š13â”Š  padding: 0 15px;\n â”Š12â”Š14â”Š`;\n â”Š13â”Š15â”Š\n+â”Š  â”Š16â”Šconst LoadingMore = styled.div`\n+â”Š  â”Š17â”Š  height: 30px;\n+â”Š  â”Š18â”Š  line-height: 30px;\n+â”Š  â”Š19â”Š  position: absolute;\n+â”Š  â”Š20â”Š  top: 0;\n+â”Š  â”Š21â”Š  right: 0;\n+â”Š  â”Š22â”Š  bottom: 0;\n+â”Š  â”Š23â”Š  left: 0;\n+â”Š  â”Š24â”Š  text-align: center;\n+â”Š  â”Š25â”Š`;\n+â”Š  â”Š26â”Š\n â”Š14â”Š27â”Štype StyledProp = {\n â”Š15â”Š28â”Š  isMine: any;\n â”Š16â”Š29â”Š};\n```\n```diff\n@@ -89,19 +102,36 @@\n â”Š 89â”Š102â”Š}\n â”Š 90â”Š103â”Šinterface MessagesListProps {\n â”Š 91â”Š104â”Š  messages: Array<Message>;\n+â”Š   â”Š105â”Š  loadMore: Function;\n+â”Š   â”Š106â”Š  hasMore: boolean;\n â”Š 92â”Š107â”Š}\n â”Š 93â”Š108â”Š\n-â”Š 94â”Š   â”Šconst MessagesList: React.FC<MessagesListProps> = ({ messages }) => {\n-â”Š 95â”Š   â”Š  const selfRef = useRef(null);\n+â”Š   â”Š109â”Šconst MessagesList: React.FC<MessagesListProps> = ({\n+â”Š   â”Š110â”Š  messages,\n+â”Š   â”Š111â”Š  loadMore,\n+â”Š   â”Š112â”Š  hasMore,\n+â”Š   â”Š113â”Š}) => {\n+â”Š   â”Š114â”Š  const selfRef = useRef<HTMLDivElement>(null);\n+â”Š   â”Š115â”Š  const [fetching, stopFetching] = useInfiniteScroll({\n+â”Š   â”Š116â”Š    onLoadMore: loadMore,\n+â”Š   â”Š117â”Š    hasMore,\n+â”Š   â”Š118â”Š    ref: selfRef!,\n+â”Š   â”Š119â”Š  });\n â”Š 96â”Š120â”Š\n â”Š 97â”Š121â”Š  useEffect(() => {\n â”Š 98â”Š122â”Š    if (!selfRef.current) return;\n+â”Š   â”Š123â”Š\n+â”Š   â”Š124â”Š    if (fetching) {\n+â”Š   â”Š125â”Š      stopFetching();\n+â”Š   â”Š126â”Š    }\n+â”Š   â”Š127â”Š\n â”Š 99â”Š128â”Š    const selfDOMNode = ReactDOM.findDOMNode(selfRef.current) as HTMLElement;\n â”Š100â”Š129â”Š    selfDOMNode.scrollTop = Number.MAX_SAFE_INTEGER;\n-â”Š101â”Š   â”Š  }, [messages.length]);\n+â”Š   â”Š130â”Š  }, [messages.length, selfRef, fetching, stopFetching]);\n â”Š102â”Š131â”Š\n â”Š103â”Š132â”Š  return (\n â”Š104â”Š133â”Š    <Container ref={selfRef}>\n+â”Š   â”Š134â”Š      {fetching && <LoadingMore>{'Loading more messages...'}</LoadingMore>}\n â”Š105â”Š135â”Š      {messages.map((message: any) => (\n â”Š106â”Š136â”Š        <MessageItem\n â”Š107â”Š137â”Š          data-testid=\"message-item\"\n```\n\n[}]: #\n\nWe added the `LoadingMore` component with *Loading more messages...* text in it that pops out when fetching is in progress.\nBecause the `MessagesList` is not responsible of quering data we don't know exactly when it's completed but we can assume, it happens once the length of `messages` changes.\nWe also pass `onLoadMore` and `hasMore` props to the parent component and the `useInfiniteScroll` uses `MessagesList` as the element we're going to scroll in.\n\nThere's also one more thing that could be turned into a hook, it's the logic responsible for scrolling to bottom of the page, every time `messages` changes.\n\n[{]: <helper> (diffStep \"15.11\" module=\"client\")\n\n#### [__Client__ Step 15.11: Implement a hook responsible for scrolling](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/f93c82d9ed82067fd3c10e461fd4ad6f101d2432)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;MessagesList.tsx\n```diff\n@@ -1,9 +1,9 @@\n â”Š1â”Š1â”Šimport moment from 'moment';\n â”Š2â”Š2â”Šimport React from 'react';\n â”Š3â”Š3â”Šimport { useEffect, useRef } from 'react';\n-â”Š4â”Š â”Šimport ReactDOM from 'react-dom';\n â”Š5â”Š4â”Šimport styled, { css } from 'styled-components';\n â”Š6â”Š5â”Šimport { useInfiniteScroll } from '../../hooks/use-infinite-scroll';\n+â”Š â”Š6â”Šimport { useAdjustedScroll } from '../../hooks/use-adjusted-scroll';\n â”Š7â”Š7â”Š\n â”Š8â”Š8â”Šconst Container = styled.div`\n â”Š9â”Š9â”Š  position: relative;\n```\n```diff\n@@ -117,17 +117,19 @@\n â”Š117â”Š117â”Š    hasMore,\n â”Š118â”Š118â”Š    ref: selfRef!,\n â”Š119â”Š119â”Š  });\n+â”Š   â”Š120â”Š  const adjustScroll = useAdjustedScroll(selfRef);\n â”Š120â”Š121â”Š\n â”Š121â”Š122â”Š  useEffect(() => {\n â”Š122â”Š123â”Š    if (!selfRef.current) return;\n â”Š123â”Š124â”Š\n â”Š124â”Š125â”Š    if (fetching) {\n â”Š125â”Š126â”Š      stopFetching();\n+â”Š   â”Š127â”Š      adjustScroll();\n+â”Š   â”Š128â”Š    } else {\n+â”Š   â”Š129â”Š      // scroll to the most recent message\n+â”Š   â”Š130â”Š      adjustScroll(true);\n â”Š126â”Š131â”Š    }\n-â”Š127â”Š   â”Š\n-â”Š128â”Š   â”Š    const selfDOMNode = ReactDOM.findDOMNode(selfRef.current) as HTMLElement;\n-â”Š129â”Š   â”Š    selfDOMNode.scrollTop = Number.MAX_SAFE_INTEGER;\n-â”Š130â”Š   â”Š  }, [messages.length, selfRef, fetching, stopFetching]);\n+â”Š   â”Š132â”Š  }, [messages.length, selfRef, fetching, stopFetching, adjustScroll]);\n â”Š131â”Š133â”Š\n â”Š132â”Š134â”Š  return (\n â”Š133â”Š135â”Š    <Container ref={selfRef}>\n```\n\n##### Added src&#x2F;hooks&#x2F;use-adjusted-scroll.ts\n```diff\n@@ -0,0 +1,35 @@\n+â”Š  â”Š 1â”Šimport { useState, useCallback, RefObject } from 'react';\n+â”Š  â”Š 2â”Šimport * as ReactDOM from 'react-dom';\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šexport const useAdjustedScroll = (ref: RefObject<HTMLElement>) => {\n+â”Š  â”Š 5â”Š  const [previousScroll, setPreviousScroll] = useState<{\n+â”Š  â”Š 6â”Š    top: number;\n+â”Š  â”Š 7â”Š    height: number;\n+â”Š  â”Š 8â”Š  }>();\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Š  /**\n+â”Š  â”Š11â”Š   * Scrolls to the previous position or completely to bottom (on demand)\n+â”Š  â”Š12â”Š   */\n+â”Š  â”Š13â”Š  const adjust = useCallback(\n+â”Š  â”Š14â”Š    (scrollToBottom?: boolean) => {\n+â”Š  â”Š15â”Š      if (!ref.current) return;\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š      const node = ReactDOM.findDOMNode(ref.current) as HTMLElement;\n+â”Š  â”Š18â”Š      const height =\n+â”Š  â”Š19â”Š        !scrollToBottom && previousScroll\n+â”Š  â”Š20â”Š          ? previousScroll.height\n+â”Š  â”Š21â”Š          : node.clientHeight;\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Š      node.scrollTop = node.scrollHeight - height;\n+â”Š  â”Š24â”Š\n+â”Š  â”Š25â”Š      // saves current scroll details\n+â”Š  â”Š26â”Š      setPreviousScroll({\n+â”Š  â”Š27â”Š        top: node.scrollTop,\n+â”Š  â”Š28â”Š        height: node.scrollHeight,\n+â”Š  â”Š29â”Š      });\n+â”Š  â”Š30â”Š    },\n+â”Š  â”Š31â”Š    [ref, previousScroll]\n+â”Š  â”Š32â”Š  );\n+â”Š  â”Š33â”Š\n+â”Š  â”Š34â”Š  return adjust;\n+â”Š  â”Š35â”Š};\n```\n\n[}]: #\n\nWe also added some extra functionality there. Because we don't want to scroll to bottom when a new message is added, the function returned by `useAdjustedScroll` accepts now an argument.\n\nWe did the `MessagesList`, now let's move onto real data and the `ChatRoom` component.\n\n[{]: <helper> (diffStep \"15.12\" module=\"client\")\n\n#### [__Client__ Step 15.12: Implement pagination in ChatRoom component](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/7b713cf4605f6dadba574cac76e4c1ae35847ef5)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -109,7 +109,7 @@\n â”Š109â”Š109â”Š}\n â”Š110â”Š110â”Š\n â”Š111â”Š111â”Šconst ChatRoom: React.FC<ChatRoomScreenParams> = ({ history, chatId }) => {\n-â”Š112â”Š   â”Š  const { after, limit } = usePagination();\n+â”Š   â”Š112â”Š  const { after, limit, setAfter } = usePagination();\n â”Š113â”Š113â”Š  const { data, loading } = useGetChatQuery({\n â”Š114â”Š114â”Š    variables: { chatId, after, limit },\n â”Š115â”Š115â”Š  });\n```\n```diff\n@@ -150,6 +150,14 @@\n â”Š150â”Š150â”Š    [data, chatId, addMessage]\n â”Š151â”Š151â”Š  );\n â”Š152â”Š152â”Š\n+â”Š   â”Š153â”Š  useEffect(() => {\n+â”Š   â”Š154â”Š    if (!after) {\n+â”Š   â”Š155â”Š      return;\n+â”Š   â”Š156â”Š    }\n+â”Š   â”Š157â”Š\n+â”Š   â”Š158â”Š    // every time after changes its value, fetch more messages\n+â”Š   â”Š159â”Š  }, [after]);\n+â”Š   â”Š160â”Š\n â”Š153â”Š161â”Š  if (data === undefined) {\n â”Š154â”Š162â”Š    return null;\n â”Š155â”Š163â”Š  }\n```\n```diff\n@@ -167,7 +175,13 @@\n â”Š167â”Š175â”Š  return (\n â”Š168â”Š176â”Š    <Container>\n â”Š169â”Š177â”Š      <ChatNavbar chat={chat} history={history} />\n-â”Š170â”Š   â”Š      {chat.messages && <MessagesList messages={chat.messages} />}\n+â”Š   â”Š178â”Š      {chat.messages && (\n+â”Š   â”Š179â”Š        <MessagesList\n+â”Š   â”Š180â”Š          messages={chat.messages.messages}\n+â”Š   â”Š181â”Š          hasMore={chat.messages.hasMore}\n+â”Š   â”Š182â”Š          loadMore={() => setAfter(chat.messages.cursor!)}\n+â”Š   â”Š183â”Š        />\n+â”Š   â”Š184â”Š      )}\n â”Š171â”Š185â”Š      <MessageInput onSendMessage={onSendMessage} />\n â”Š172â”Š186â”Š    </Container>\n â”Š173â”Š187â”Š  );\n```\n\n[}]: #\n\nAs you see above, every time the `MessagesList` asks for more messages, the `after` changes its value to `chat.messages.cursor` which means that's a new \"end\" of the list and we need to fill it up.\n\nRight now we just have a logic and a place to do it but we still need to make a GraphQL call.\n\nFortunately, Apollo lets you do pagination with a method called `fetchMore`. You need to specify what query and variables to use for the update, and how to merge the new query result with the existing data on the client. How exactly you do that will determine what kind of pagination you are implementing, in our case it's cursor-based.\n\nBut there's a catch!\n\nIt's related to how Apollo stores query results in cache. When we update the variables, in our case it's the `after` that changes quite a lot, a new record is created that is totally unrelated to the original query. That's because Apollo uses a combination of variables and query string to produce a key.\n\nAn example:\n\n\n```graphql\n{\n  query getUser($id: ID!) {\n    user(id: $id) {\n      name\n    }\n  }\n}\n```\n\nThe result of `getUser` query will be saved under `user({\"id\":2})` key.\n\nThis is a huge problem, it breaks imperative store updates but that's why `@connection` directive exists. It directs Apollo to use a stable store key for paginated queries, so every `useQuery()` or `fetchMore()` is being placed in the same space.\n\nWith all that knowledge, let's implement the last puzzle piece!\n\n[{]: <helper> (diffStep \"15.13\" module=\"client\")\n\n#### [__Client__ Step 15.13: Use fetchMore to load more messages](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/03911d6f64f030a0782297cfcb13fa567cd03691)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -110,7 +110,7 @@\n â”Š110â”Š110â”Š\n â”Š111â”Š111â”Šconst ChatRoom: React.FC<ChatRoomScreenParams> = ({ history, chatId }) => {\n â”Š112â”Š112â”Š  const { after, limit, setAfter } = usePagination();\n-â”Š113â”Š   â”Š  const { data, loading } = useGetChatQuery({\n+â”Š   â”Š113â”Š  const { data, loading, fetchMore } = useGetChatQuery({\n â”Š114â”Š114â”Š    variables: { chatId, after, limit },\n â”Š115â”Š115â”Š  });\n â”Š116â”Š116â”Š\n```\n```diff\n@@ -156,7 +156,30 @@\n â”Š156â”Š156â”Š    }\n â”Š157â”Š157â”Š\n â”Š158â”Š158â”Š    // every time after changes its value, fetch more messages\n-â”Š159â”Š   â”Š  }, [after]);\n+â”Š   â”Š159â”Š    fetchMore({\n+â”Š   â”Š160â”Š      variables: {\n+â”Š   â”Š161â”Š        after,\n+â”Š   â”Š162â”Š        limit,\n+â”Š   â”Š163â”Š      },\n+â”Š   â”Š164â”Š      updateQuery(prev, { fetchMoreResult }) {\n+â”Š   â”Š165â”Š        const messages = [\n+â”Š   â”Š166â”Š          ...fetchMoreResult!.chat!.messages.messages,\n+â”Š   â”Š167â”Š          ...prev.chat!.messages.messages,\n+â”Š   â”Š168â”Š        ];\n+â”Š   â”Š169â”Š\n+â”Š   â”Š170â”Š        return {\n+â”Š   â”Š171â”Š          ...prev,\n+â”Š   â”Š172â”Š          chat: {\n+â”Š   â”Š173â”Š            ...prev.chat!,\n+â”Š   â”Š174â”Š            messages: {\n+â”Š   â”Š175â”Š              ...fetchMoreResult!.chat!.messages,\n+â”Š   â”Š176â”Š              messages,\n+â”Š   â”Š177â”Š            },\n+â”Š   â”Š178â”Š          },\n+â”Š   â”Š179â”Š        };\n+â”Š   â”Š180â”Š      },\n+â”Š   â”Š181â”Š    });\n+â”Š   â”Š182â”Š  }, [after, limit, fetchMore]);\n â”Š160â”Š183â”Š\n â”Š161â”Š184â”Š  if (data === undefined) {\n â”Š162â”Š185â”Š    return null;\n```\n\n[}]: #\n\nAs you see, we mutate the store as usual and we put fetched messages before the existing ones. Remember, it's from older to newer.\n\n### Looking at the bundle size\n\nWe can't of course forget about one of the most important aspects of optimization, the size of the application. As bundle size increases, both the parsing time and the time of the request takes longer.\n\nHow can we check what libraries and source files are shipped within the produced bundle?\n\nThere are many tools that analyze it for us but we're going to use only one of them, just for educational purpose.\n\n      $ yarn add -D source-map-explorer\n\nWe're going to add the `size` npm script in which we point the `source-map-explorer` to transpiled js files.\n\n[{]: <helper> (diffStep \"15.14\" module=\"client\")\n\n#### [__Client__ Step 15.14: Explore bundle size](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/bf246cf73cb9e19a2c24b61e4f7e214ac0ded52f)\n\n##### Changed package.json\n```diff\n@@ -50,7 +50,8 @@\n â”Š50â”Š50â”Š    \"test\": \"TZ=\\\"Asia/Jerusalem\\\" react-scripts test\",\n â”Š51â”Š51â”Š    \"eject\": \"react-scripts eject\",\n â”Š52â”Š52â”Š    \"codegen\": \"gql-gen\",\n-â”Š53â”Š  â”Š    \"format\": \"prettier \\\"**/*.{ts,tsx,css,graphql}\\\" --write\"\n+â”Š  â”Š53â”Š    \"format\": \"prettier \\\"**/*.{ts,tsx,css,graphql}\\\" --write\",\n+â”Š  â”Š54â”Š    \"size\": \"source-map-explorer 'build/static/js/*.js'\"\n â”Š54â”Š55â”Š  },\n â”Š55â”Š56â”Š  \"eslintConfig\": {\n â”Š56â”Š57â”Š    \"extends\": \"react-app\"\n```\n```diff\n@@ -70,6 +71,7 @@\n â”Š70â”Š71â”Š  \"devDependencies\": {\n â”Š71â”Š72â”Š    \"@testing-library/jest-dom\": \"4.0.0\",\n â”Š72â”Š73â”Š    \"@testing-library/react\": \"9.1.0\",\n-â”Š73â”Š  â”Š    \"jest-fetch-mock\": \"2.1.2\"\n+â”Š  â”Š74â”Š    \"jest-fetch-mock\": \"2.1.2\",\n+â”Š  â”Š75â”Š    \"source-map-explorer\": \"2.0.1\"\n â”Š74â”Š76â”Š  }\n â”Š75â”Š77â”Š}ðŸš«â†µ\n```\n\n[}]: #\n\nLet's see it in action, run:\n\n    $ yarn build && yarn size\n\nThat's what you should see:\n\n![Source Map Explorer](../../../assets/step17/img-10.png \"Source Map Explorer\")\n\nIt's interactive so you can dive deeper and deeper into those blocks but in general it shows what libraries and files are included in the produced output with their size(not minified and not gzipped).\n\n![Source Map Explorer](../../../assets/step17/img-11.png \"Source Map Explorer with moment highlighted\")\n\nFor example, we see that `moment` takes almost _53.49KB_ which is enourmous. In fact we only use its `format` method. The reason is that the library is not well tree-shakable. There are plugins for webpack (or any other build tool) that helps with it but we're going to use an alternative instead. We're going to replace it with `date-fns`.\n\n[{]: <helper> (diffStep \"15.15\" module=\"client\")\n\n#### [__Client__ Step 15.15: Replace moment with date-fns](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/75ff5dd2bd2f294bf9f28ee35ebc7bf36eb50256)\n\n##### Changed package.json\n```diff\n@@ -30,9 +30,9 @@\n â”Š30â”Š30â”Š    \"graphql\": \"14.4.2\",\n â”Š31â”Š31â”Š    \"apollo-link-ws\": \"1.0.18\",\n â”Š32â”Š32â”Š    \"apollo-utilities\": \"1.3.2\",\n+â”Š  â”Š33â”Š    \"date-fns\": \"1.30.1\",\n â”Š33â”Š34â”Š    \"graphql-tag\": \"2.10.1\",\n â”Š34â”Š35â”Š    \"history\": \"4.9.0\",\n-â”Š35â”Š  â”Š    \"moment\": \"2.24.0\",\n â”Š36â”Š36â”Š    \"prettier\": \"1.18.2\",\n â”Š37â”Š37â”Š    \"react\": \"16.9.0\",\n â”Š38â”Š38â”Š    \"react-dom\": \"16.9.0\",\n```\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;MessagesList.tsx\n```diff\n@@ -1,4 +1,4 @@\n-â”Š1â”Š â”Šimport moment from 'moment';\n+â”Š â”Š1â”Šimport format from 'date-fns/format';\n â”Š2â”Š2â”Šimport React from 'react';\n â”Š3â”Š3â”Šimport { useEffect, useRef } from 'react';\n â”Š4â”Š4â”Šimport styled, { css } from 'styled-components';\n```\n```diff\n@@ -141,7 +141,7 @@\n â”Š141â”Š141â”Š          key={message.id}>\n â”Š142â”Š142â”Š          <Contents data-testid=\"message-content\">{message.content}</Contents>\n â”Š143â”Š143â”Š          <Timestamp data-testid=\"message-date\">\n-â”Š144â”Š   â”Š            {moment(message.createdAt).format('HH:mm')}\n+â”Š   â”Š144â”Š            {format(message.createdAt, 'HH:mm')}\n â”Š145â”Š145â”Š          </Timestamp>\n â”Š146â”Š146â”Š        </MessageItem>\n â”Š147â”Š147â”Š      ))}\n```\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -1,5 +1,5 @@\n â”Š1â”Š1â”Šimport React from 'react';\n-â”Š2â”Š â”Šimport moment from 'moment';\n+â”Š â”Š2â”Šimport format from 'date-fns/format';\n â”Š3â”Š3â”Šimport { List, ListItem } from '@material-ui/core';\n â”Š4â”Š4â”Šimport styled from 'styled-components';\n â”Š5â”Š5â”Šimport { useCallback } from 'react';\n```\n```diff\n@@ -104,7 +104,7 @@\n â”Š104â”Š104â”Š                    {chat.lastMessage.content}\n â”Š105â”Š105â”Š                  </MessageContent>\n â”Š106â”Š106â”Š                  <MessageDate data-testid=\"date\">\n-â”Š107â”Š   â”Š                    {moment(chat.lastMessage.createdAt).format('HH:mm')}\n+â”Š   â”Š107â”Š                    {format(chat.lastMessage.createdAt, 'HH:mm')}\n â”Š108â”Š108â”Š                  </MessageDate>\n â”Š109â”Š109â”Š                </React.Fragment>\n â”Š110â”Š110â”Š              )}\n```\n\n[}]: #\n\nNow when you run:\n\n    $ yarn build && yarn size\n\nYou should see the following results.\n\n![Source Map Explorer](../../../assets/step17/img-12.png \"Source Map Explorer with date-fns\")\n\nThe bundle size is a bit smaller and `date-fns` takes only _8.93KB_ which in comparison to _53.49KB_ is a significant change!\n\n## Load testing\n\nLoad testing, in short, is about finding the limit of an application and figure out how to push it even more. We simulate a stressful behavior and apply that to the server until it crashes. Weâ€™re trying to answer the question of how the api deals with a pressure.\n\nWhen to do load testing?\nI would say at least before and after major changes, when pre-launching and just from time to time to prevent regressions.\n\nBefore doing load testing, we need to prepare a bit first. Right now we use `ts-node` to run the server but it would be faster to run it directly using `node`, just to avoid on-the-fly transpilation of TypeScript files.\n\nIn order to do it, we need to define the `outDir` in `tsconfig.json` and add a build step.\n\n[{]: <helper> (diffStep \"14.12\" module=\"server\")\n\n#### [__Server__ Step 14.12: Produce transpiled code](https://github.com/Urigo/WhatsApp-Clone-Server/commit/15d859c618d44ab3133e9f8078f26c05b0ad0798)\n\n##### Changed .circleci&#x2F;config.yml\n```diff\n@@ -18,6 +18,9 @@\n â”Š18â”Š18â”Š      - run:\n â”Š19â”Š19â”Š          name: Install Dependencies\n â”Š20â”Š20â”Š          command: yarn\n+â”Š  â”Š21â”Š      - run:\n+â”Š  â”Š22â”Š          name: Build\n+â”Š  â”Š23â”Š          command: yarn build\n â”Š21â”Š24â”Š      - run:\n â”Š22â”Š25â”Š          name: Test\n â”Š23â”Š26â”Š          command: yarn test\n```\n\n##### Changed .gitignore\n```diff\n@@ -1,3 +1,4 @@\n+â”Š â”Š1â”Šdist\n â”Š1â”Š2â”Šnode_modules\n â”Š2â”Š3â”Šnpm-debug.log\n â”Š3â”Š4â”Štest-results/\n```\n\n##### Changed package.json\n```diff\n@@ -9,6 +9,8 @@\n â”Š 9â”Š 9â”Š  \"scripts\": {\n â”Š10â”Š10â”Š    \"prestart\": \"yarn codegen\",\n â”Š11â”Š11â”Š    \"start\": \"ts-node index.ts\",\n+â”Š  â”Š12â”Š    \"prebuild\": \"yarn codegen\",\n+â”Š  â”Š13â”Š    \"build\": \"tsc\",\n â”Š12â”Š14â”Š    \"test\": \"TZ=\\\"Asia/Jerusalem\\\" jest --runInBand --forceExit\",\n â”Š13â”Š15â”Š    \"codegen\": \"gql-gen\",\n â”Š14â”Š16â”Š    \"format\": \"prettier \\\"**/*.ts\\\" --write\"\n```\n\n##### Changed tsconfig.json\n```diff\n@@ -1,5 +1,6 @@\n â”Š1â”Š1â”Š{\n â”Š2â”Š2â”Š  \"compilerOptions\": {\n+â”Š â”Š3â”Š    \"outDir\": \"dist\",\n â”Š3â”Š4â”Š    \"target\": \"es2018\",\n â”Š4â”Š5â”Š    \"module\": \"commonjs\",\n â”Š5â”Š6â”Š    \"lib\": [\n```\n\n[}]: #\n\nNext, the script to actually run the server:\n\n[{]: <helper> (diffStep \"14.13\" files=\"package.json\" module=\"server\")\n\n#### [__Server__ Step 14.13: Prepare for production](https://github.com/Urigo/WhatsApp-Clone-Server/commit/49d93d2fdf7c6dd419c6d307bdb159215dee5c6e)\n\n##### Changed package.json\n```diff\n@@ -10,6 +10,7 @@\n â”Š10â”Š10â”Š    \"prestart\": \"yarn codegen\",\n â”Š11â”Š11â”Š    \"start\": \"ts-node index.ts\",\n â”Š12â”Š12â”Š    \"prebuild\": \"yarn codegen\",\n+â”Š  â”Š13â”Š    \"prod\": \"node dist/index.js\",\n â”Š13â”Š14â”Š    \"build\": \"tsc\",\n â”Š14â”Š15â”Š    \"test\": \"TZ=\\\"Asia/Jerusalem\\\" jest --runInBand --forceExit\",\n â”Š15â”Š16â”Š    \"codegen\": \"gql-gen\",\n```\n\n[}]: #\n\nOnce itâ€™s ready, we can move on to tooling.\n\n### Artillery\n\nArtillery is an open-source load testing and functional testing toolkit. Itâ€™s API is vast but we will focus on the core part of it which is relevant to this chapter. Artillery is available as a npm package:\n\n    $ yarn add -D artillery\n\nThe only step to use Artillery is to set it up. We will create the `artillery.yml` file, like this:\n\n[{]: <helper> (diffStep \"14.15\" module=\"server\")\n\n#### [__Server__ Step 14.15: Add artillery config](https://github.com/Urigo/WhatsApp-Clone-Server/commit/2be17e8b6f6c5d1b0673e1e20314762aabd08725)\n\n##### Added artillery.yml\n```diff\n@@ -0,0 +1,72 @@\n+â”Š  â”Š 1â”Šconfig:\n+â”Š  â”Š 2â”Š  target: 'http://localhost:4000/graphql'\n+â”Š  â”Š 3â”Š  phases:\n+â”Š  â”Š 4â”Š    - duration: 120\n+â”Š  â”Š 5â”Š      arrivalRate: 5\n+â”Š  â”Š 6â”Š      rampTo: 20\n+â”Š  â”Š 7â”Šscenarios:\n+â”Š  â”Š 8â”Š  - name: 'Sign in, send a new message and fetch a list of chats'\n+â”Š  â”Š 9â”Š    flow:\n+â”Š  â”Š10â”Š      - post:\n+â”Š  â”Š11â”Š          url: '/'\n+â”Š  â”Š12â”Š          json:\n+â”Š  â”Š13â”Š            variables:\n+â”Š  â”Š14â”Š              username: 'ray'\n+â”Š  â”Š15â”Š              password: '111'\n+â”Š  â”Š16â”Š            query: |\n+â”Š  â”Š17â”Š              mutation SignIn($username: String!, $password: String!) {\n+â”Š  â”Š18â”Š                signIn(username: $username, password: $password) {\n+â”Š  â”Š19â”Š                  id\n+â”Š  â”Š20â”Š                }\n+â”Š  â”Š21â”Š              }\n+â”Š  â”Š22â”Š      - post:\n+â”Š  â”Š23â”Š          url: '/'\n+â”Š  â”Š24â”Š          json:\n+â”Š  â”Š25â”Š            query: |\n+â”Š  â”Š26â”Š              mutation message {\n+â”Š  â”Š27â”Š                addMessage(chatId: \"1\", content: \"artillery\") {\n+â”Š  â”Š28â”Š                  id\n+â”Š  â”Š29â”Š                }\n+â”Š  â”Š30â”Š              }\n+â”Š  â”Š31â”Š      - post:\n+â”Š  â”Š32â”Š          url: '/'\n+â”Š  â”Š33â”Š          json:\n+â”Š  â”Š34â”Š            variables:\n+â”Š  â”Š35â”Š              limit: 20\n+â”Š  â”Š36â”Š            query: |\n+â”Š  â”Š37â”Š              fragment User on User {\n+â”Š  â”Š38â”Š                id\n+â”Š  â”Š39â”Š                name\n+â”Š  â”Š40â”Š                picture\n+â”Š  â”Š41â”Š              }\n+â”Š  â”Š42â”Š              fragment Message on Message {\n+â”Š  â”Š43â”Š                id\n+â”Š  â”Š44â”Š                content\n+â”Š  â”Š45â”Š                chat {\n+â”Š  â”Š46â”Š                  id\n+â”Š  â”Š47â”Š                }\n+â”Š  â”Š48â”Š                sender {\n+â”Š  â”Š49â”Š                  ...User\n+â”Š  â”Š50â”Š                }\n+â”Š  â”Š51â”Š                recipient {\n+â”Š  â”Š52â”Š                  ...User\n+â”Š  â”Š53â”Š                }\n+â”Š  â”Š54â”Š              }\n+â”Š  â”Š55â”Š              query GetChats($limit: Int!) {\n+â”Š  â”Š56â”Š                chats {\n+â”Š  â”Š57â”Š                  id\n+â”Š  â”Š58â”Š                  name\n+â”Š  â”Š59â”Š                  picture\n+â”Š  â”Š60â”Š                  lastMessage {\n+â”Š  â”Š61â”Š                    ...Message\n+â”Š  â”Š62â”Š                  }\n+â”Š  â”Š63â”Š                  messages(limit: $limit) {\n+â”Š  â”Š64â”Š                    messages {\n+â”Š  â”Š65â”Š                      ...Message\n+â”Š  â”Š66â”Š                    }\n+â”Š  â”Š67â”Š                  }\n+â”Š  â”Š68â”Š                  participants {\n+â”Š  â”Š69â”Š                    ...User\n+â”Š  â”Š70â”Š                  }\n+â”Š  â”Š71â”Š                }\n+â”Š  â”Š72â”Š              }\n```\n\n[}]: #\n\nAs you can see, the config file is built of two sections. First one is named `config` and it defines whatâ€™s our target and how the traffic should look like. We used one phase but it could have many. The `duration` parameter is to define how long the phase should take. The `arrivalRate` defines how many virtual users per second are going to hit the target and the `rampTo` directs Artillery to increase this number up to 20, at the middle of the phase.\n\nThe next section, called `scenarios`, is all about the actual requests. In our case, we want to authenticate user, submit a new message and fetch an entire list of chats with their messages at the end. Artillery shares cookies between request of the same virtual user, keep that on mind.\n\nWe used Ray as the user and fairly similar operations to what the client app sends. That should closely represent the actual usage of the API.\n\nEverything is fine with that config but we need to find the limit, to push even more. That's why we'll also add a second config with a bit more heavier traffic, something to simulate the more real life environment. It's pretty much the same setup except phases. First, we \"warms up\" the server for 2 minutes, same amount of times goes next with double the traffic, then we keep it for 5 minutes. At the end, we want to crash the server so we send nearly 100 virtual users per second for an entire minute. This way we know when it cracks.\n\n[{]: <helper> (diffStep \"14.16\" module=\"server\")\n\n#### [__Server__ Step 14.16: Artillery config to find a limit](https://github.com/Urigo/WhatsApp-Clone-Server/commit/b0643c1b6061b6a43ae663a3115154b15a588dcf)\n\n##### Added artillery-limit.yml\n```diff\n@@ -0,0 +1,77 @@\n+â”Š  â”Š 1â”Šconfig:\n+â”Š  â”Š 2â”Š  target: 'http://localhost:4000/graphql'\n+â”Š  â”Š 3â”Š  phases:\n+â”Š  â”Š 4â”Š    - duration: 120\n+â”Š  â”Š 5â”Š      arrivalRate: 5\n+â”Š  â”Š 6â”Š    - duration: 120\n+â”Š  â”Š 7â”Š      arrivalRate: 10\n+â”Š  â”Š 8â”Š    - duration: 300\n+â”Š  â”Š 9â”Š      arrivalRate: 10\n+â”Š  â”Š10â”Š    - duration: 60\n+â”Š  â”Š11â”Š      arrivalRate: 100\n+â”Š  â”Š12â”Šscenarios:\n+â”Š  â”Š13â”Š  - name: 'Sign in, send a new message and fetch a list of chats'\n+â”Š  â”Š14â”Š    flow:\n+â”Š  â”Š15â”Š      - post:\n+â”Š  â”Š16â”Š          url: '/'\n+â”Š  â”Š17â”Š          json:\n+â”Š  â”Š18â”Š            variables:\n+â”Š  â”Š19â”Š              username: 'ray'\n+â”Š  â”Š20â”Š              password: '111'\n+â”Š  â”Š21â”Š            query: |\n+â”Š  â”Š22â”Š              mutation SignIn($username: String!, $password: String!) {\n+â”Š  â”Š23â”Š                signIn(username: $username, password: $password) {\n+â”Š  â”Š24â”Š                  id\n+â”Š  â”Š25â”Š                }\n+â”Š  â”Š26â”Š              }\n+â”Š  â”Š27â”Š      - post:\n+â”Š  â”Š28â”Š          url: '/'\n+â”Š  â”Š29â”Š          json:\n+â”Š  â”Š30â”Š            query: |\n+â”Š  â”Š31â”Š              mutation message {\n+â”Š  â”Š32â”Š                addMessage(chatId: \"1\", content: \"artillery\") {\n+â”Š  â”Š33â”Š                  id\n+â”Š  â”Š34â”Š                }\n+â”Š  â”Š35â”Š              }\n+â”Š  â”Š36â”Š      - post:\n+â”Š  â”Š37â”Š          url: '/'\n+â”Š  â”Š38â”Š          json:\n+â”Š  â”Š39â”Š            variables:\n+â”Š  â”Š40â”Š              limit: 20\n+â”Š  â”Š41â”Š            query: |\n+â”Š  â”Š42â”Š              fragment User on User {\n+â”Š  â”Š43â”Š                id\n+â”Š  â”Š44â”Š                name\n+â”Š  â”Š45â”Š                picture\n+â”Š  â”Š46â”Š              }\n+â”Š  â”Š47â”Š              fragment Message on Message {\n+â”Š  â”Š48â”Š                id\n+â”Š  â”Š49â”Š                content\n+â”Š  â”Š50â”Š                chat {\n+â”Š  â”Š51â”Š                  id\n+â”Š  â”Š52â”Š                }\n+â”Š  â”Š53â”Š                sender {\n+â”Š  â”Š54â”Š                  ...User\n+â”Š  â”Š55â”Š                }\n+â”Š  â”Š56â”Š                recipient {\n+â”Š  â”Š57â”Š                  ...User\n+â”Š  â”Š58â”Š                }\n+â”Š  â”Š59â”Š              }\n+â”Š  â”Š60â”Š              query GetChats($limit: Int!) {\n+â”Š  â”Š61â”Š                chats {\n+â”Š  â”Š62â”Š                  id\n+â”Š  â”Š63â”Š                  name\n+â”Š  â”Š64â”Š                  picture\n+â”Š  â”Š65â”Š                  lastMessage {\n+â”Š  â”Š66â”Š                    ...Message\n+â”Š  â”Š67â”Š                  }\n+â”Š  â”Š68â”Š                  messages(limit: $limit) {\n+â”Š  â”Š69â”Š                    messages {\n+â”Š  â”Š70â”Š                      ...Message\n+â”Š  â”Š71â”Š                    }\n+â”Š  â”Š72â”Š                  }\n+â”Š  â”Š73â”Š                  participants {\n+â”Š  â”Š74â”Š                    ...User\n+â”Š  â”Š75â”Š                  }\n+â”Š  â”Š76â”Š                }\n+â”Š  â”Š77â”Š              }ðŸš«â†µ\n```\n\n[}]: #\n\nOnce everything is ready, let's add npm scripts, one for a normal traffic and a second with the much more users:\n\n[{]: <helper> (diffStep \"14.17\" module=\"server\")\n\n#### [__Server__ Step 14.17: Add loadtest scripts](https://github.com/Urigo/WhatsApp-Clone-Server/commit/527d4c191c67aa80ed4765bda59c07f1753df799)\n\n##### Changed package.json\n```diff\n@@ -14,7 +14,9 @@\n â”Š14â”Š14â”Š    \"build\": \"tsc\",\n â”Š15â”Š15â”Š    \"test\": \"TZ=\\\"Asia/Jerusalem\\\" jest --runInBand --forceExit\",\n â”Š16â”Š16â”Š    \"codegen\": \"gql-gen\",\n-â”Š17â”Š  â”Š    \"format\": \"prettier \\\"**/*.ts\\\" --write\"\n+â”Š  â”Š17â”Š    \"format\": \"prettier \\\"**/*.ts\\\" --write\",\n+â”Š  â”Š18â”Š    \"loadtest\": \"yarn artillery run artillery.yml > loadtest.log\",\n+â”Š  â”Š19â”Š    \"loadtest:limit\": \"yarn artillery run artillery-limit.yml > loadtest.log\"\n â”Š18â”Š20â”Š  },\n â”Š19â”Š21â”Š  \"jest-junit\": {\n â”Š20â”Š22â”Š    \"outputDirectory\": \"./test-results\"\n```\n\n[}]: #\n\nYou probably noticed that we stream the output to the `loadtest.log` file and that's just to read the results in a bit more pleasent way, than in the terminal.\n\nLetâ€™s start the server and run artillery:\n\n    $ yarn build && yarn start\n    $ yarn loadtest\n\nYouâ€™ll see a loading indicator, might take a while but when it completes, you should see something like this in `loadtest.log` file:\n\n```\nSummary report @ 15:00:58(+0200) 2019-05-30\n  Scenarios launched:  1506\n  Scenarios completed: 1506\n  Requests completed:  4518\n  RPS sent: 37.35\n  Request latency:\n    min: 3.5\n    max: 115.7\n    median: 18.6\n    p95: 54.4\n    p99: 66.2\n  Scenario counts:\n    Sign in, send a new message and fetch a list of chats: 1506 (100%)\n  Codes:\n    200: 4518\n```\n\nWe ran the scenario 1506 times, all were completed and the total number of requests was 4518.  The **RPS** means requests per second.\n\nThe metrics in **Request latency** are in milliseconds. We see what was the shortest request and so on. These **p95** and **p99** values mean that for 95% of virtual users, the latency was 54.4ms or lower, for 99% it was 66.2ms. All requests finished with 200 status code.\n\nYou might also automate that process and integrate Artillery CLI with CI/CI systems or even send metrics to external monitoring systems.\n\n### Apollo Engine\n\nLet's bring back the Apollo Engine once again. It will be helpful to analyze the load testing results.\n\nOn the **Metrics** page, you will see the following view:\n\n![Metrics](../../../assets/step17/img-13.png \"Metrics\")\n\nClick on the filter and set a custom date range to match the time you were load testing. Just to filter out other requests.\n\n![Filter](../../../assets/step17/img-14.png \"Filter\")\n\nBy default, Apollo Engine counts all operations, but you can pick the one youâ€™re interesting in. We donâ€™t do it and inspect them all.\n\n![List](../../../assets/step17/img-15.png \"List of operations\")\n\nOn the main part of the view, you should see â€œLast day overviewâ€ panel.\n\n![Overview](../../../assets/step17/img-16.png \"Last day overview\")\n\nAs you can see, all operations we ran are listed there and no error occurred.\n\n![Request Rate](../../../assets/step17/img-17.png \"Request Rate Over Time\")\n\nNext section shows the Requests Per Minute (rpm) metric over time. Itâ€™s useful to understand which operations are sent more often than others.\n\n![Request 1](../../../assets/step17/img-18.png \"Request Latency Over time\")\n![Request 2](../../../assets/step17/img-19.png \"Request Latency Distribution\")\n\nLast two panels are there to understand at what number of requests the latency increases and to show the correlation between them. We see a distribution of the processing time (the horizontal axis) and the number of operations. It also has p50, p75, p90 and p99 marks on it."
          }
        ]
      },
      {
        "releaseVersion": "0.1.0",
        "releaseDate": "2019-06-01 01:45:09 +0800",
        "tagName": "master@0.1.0",
        "tagRevision": "437c0e5feed066018bb9aa41ea28c01eabed9c32",
        "historyRevision": "86652ec8412a5f2b8749e385b3a70ae4e886aa74",
        "changesDiff": "diff --git a/.gitignore b/.gitignore\nnew file mode 100644\nindex 0000000..5171c54\n--- /dev/null\n+++ b/.gitignore\n@@ -0,0 +1,2 @@\n+node_modules\n+npm-debug.log\n\\ No newline at end of file\ndiff --git a/.tortilla/manuals/templates/root.tmpl b/.tortilla/manuals/templates/root.tmpl\nnew file mode 100644\nindex 0000000..4586208\n--- /dev/null\n+++ b/.tortilla/manuals/templates/root.tmpl\n@@ -0,0 +1,129 @@\n+![whatsapp-clone](https://user-images.githubusercontent.com/7648874/54141944-9f801a80-4461-11e9-85a1-bcb161d9a6c6.png)\n+\n+Whatsapp Clone is a free and open-source tutorial that will guide you step-by-step on how to create a full-stack,\n+mobile, hybrid web application from scratch.\n+\n+The software world is evolving quickly, and oftentimes people find themselves left behind, even the most experienced ones.\n+The purpose of this tutorial is not only to demonstrate how to create a full application with the latest technologies, but also\n+to keep up to date with the ever-changing development ecosystem.\n+\n+This tutorial is for anyone who has ever asked themselves one of the following questions:\n+\n+- How do people build an app today?\n+- What are the currently leading technologies in the ecosystem?\n+- What are the best practices for using technology XXX?\n+- What is the purpose of technology XXX?\n+- How does technology XXX work?\n+- How do I use technology XXX?\n+- How do I migrate to the new version of technology XXX?\n+- Why should I use technology XXX over technology YYY?\n+\n+All of the above and more can be answered in the tutorial. Whether youâ€™re a beginner, intermediate or a professional,\n+we will have the answers youâ€™re looking for.\n+\n+**What technologies does Whatsapp Clone uses?**\n+\n+The version of the Whatsapp Clone you are looking at, uses:\n+\n+- [React (with Hooks and Suspense)](http://react.com)\n+- [Styled-Components](https://styled-components.com)\n+- [Material-UI](https://material-ui.com)\n+- [TypeScript](https://typescriptlang.org)\n+- [Apollo GraphQL](https://www.apollographql.com)\n+- [GraphQL Code Generator](http://graphql-code-generator.com)\n+- [GraphQL Modules](https://graphql-modules.com)\n+- [PostgreSQL](https://www.postgresql.org/)\n+- [GraphQL Inspector](https://graphql-inspector.com/)\n+\n+The point of this tutorial is not to be bound to a certain technology, but rather keep itself aligned with the ecosystem.\n+When a new technology comes out, and itâ€™s better and more popular, Whatsapp Clone will upgrade to use it (together with full migration instructions).\n+\n+**P2P tutorial for the community by the community**\n+\n+Keeping tutorials up to date is not an easy task.\n+That's why we've created the Tortilla Tutorial Framework that makes it easy to write and update tutorials.\n+Also, the WhatsApp clone is completely open source in order for the community to give its feedback, help and fork ideas.\n+Here are the repositories the tutorial is made of:\n+\n+- [Whatsapp Clone - Client](https://github.com/Urigo/WhatsApp-Clone-Client-React)\n+- [Whatsapp Clone - Server](https://github.com/Urigo/WhatsApp-Clone-server)\n+- [Whatsapp Clone - Script's text](https://github.com/Urigo/WhatsApp-Clone-Tutorial)\n+\n+Weâ€™ve also made sure to publish some important documents so you can get more involved.\n+You can track our progress and comment your suggestions, since everything is based on Google Docs and is updated live:\n+\n+- [Road map](https://docs.google.com/document/d/1p2Zio6Js2eoFfHs9CjIMF6jTuNyD4eQEHlgEAKhAqM8/edit?usp=sharing)\n+- [Chapter manuals] (https://drive.google.com/open?id=1ITxOniS_S3sgZfunLvtJ1L9P6Fj1YOLlFHhoQPjT3S0)\n+\n+**Migration instructions included**\n+\n+There are many great tutorials out there, but almost none of them shows you what changes you should make in your app in order to be aligned with a new version of a certain technology.\n+As technologies are being updated by the minute, some changes are minor and insignificant,\n+but often times a breaking change will be made in which case we need to know how we can adapt to that change.\n+Thanks to the [Tortilla platform](https://tortilla.academy), we can provide you with a git-diff that will show you what changes were made between each and every released version of the Whatsapp Clone tutorial since the beginning of history.\n+This way you can easily notice the changes in APIs and migrate your app in no time.\n+\n+![tutorial-versions-diff](https://user-images.githubusercontent.com/7648874/54142148-0f8ea080-4462-11e9-9522-ec9997b76169.png)\n+\n+**Prerequisites for WhatsApp Clone**\n+\n+- JavaScript - https://javascript.info/\n+- TypeScript\n+- JSX\n+- HTML\n+- CSS\n+- Node.JS\n+- npm & Yarn\n+- React\n+- SQL\n+\n+> Even if you don't have experience with the technologies above you might be able to start the tutorial and pick things along the way.\n+> If you struggle with anything, contact us on the forum or on Github with your questions.\n+\n+OS operations such as navigating to a folder, or creating a folder, are all gonna be written in Bash, but the instructions are OS agnostic and can be applied on any machine that is web-compatible.\n+\n+Make sure you have the latest global dependencies on your computer before starting the tutorial:\n+\n+**[Node](https://nodejs.org/)**\n+\n+Install [nvm](https://github.com/nvm-sh/nvm) by running the following command in your command line:\n+\n+    $ curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.34.0/install.sh | bash\n+\n+Then install the latest version of Node by running the following:\n+\n+    $ nvm install node\n+\n+**[Yarn](https://yarnpkg.com)**\n+\n+Follow the instructions [here](https://yarnpkg.com/en/docs/install#mac-stable).\n+\n+\n+**Whatâ€™s on the tutorial?**\n+\n+Whatsapp Clone is built chronologically, from the most basic, to more higher level features, so we recommend you to follow the tutorial in the right order.\n+Each step is focused on a different subject, so by the end of it youâ€™ll have a new feature and a new set of knowledge that you can start implementing in your everyday scenario immediately.\n+\n+If you feel like you want to skip or focus on a specific subject, on each step you can download the full app code till that point in time.\n+\n+That is also useful in case you get stuck.\n+\n+Currently, Whatsapp Clone includes the following chapters:\n+\n+- [Step 1: Creating a basic React APP with a basic view.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/final/.tortilla/manuals/views/step1.md)\n+- [Step 2: Styling with Material-UI and Styled-Components.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/final/.tortilla/manuals/views/step2.md)\n+- [Step 3: Setting a basic Node.JS server with basic a basic REST endpoint.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/final/.tortilla/manuals/views/step3.md)\n+- [Step 4: Transition to GraphQL.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/final/.tortilla/manuals/views/step4.md)\n+- [Step 5: Testing.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/final/.tortilla/manuals/views/step5.md)\n+- [Step 6: Creating an app router and implementing a chat room.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/final/.tortilla/manuals/views/step6.md)\n+- [Step 7: Caching with Apollo-Client.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/final/.tortilla/manuals/views/step7.md)\n+- [Step 8: Sending messages with GraphQL mutations.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/final/.tortilla/manuals/views/step8.md)\n+- [Step 9: Type safety with GraphQL Code Generator.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/final/.tortilla/manuals/views/step9.md)\n+- [Step 10: Live updates with GraphQL subscriptions.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/final/.tortilla/manuals/views/step10.md)\n+- [Step 11: Users.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/final/.tortilla/manuals/views/step11.md)\n+- [Step 12: Adding and removing chats.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/final/.tortilla/manuals/views/step12.md)\n+- [Step 13: Authentication.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/final/.tortilla/manuals/views/step13.md)\n+- Step 14: Your choice! Submit a request [here](https://github.com/Urigo/WhatsApp-Clone-Client-React/issues)\n+\n+Whatsapp Clone is updated on a regular basis, so you should expect more steps and extensions with time.\n+You can keep track of our [road map](https://docs.google.com/document/d/1p2Zio6Js2eoFfHs9CjIMF6jTuNyD4eQEHlgEAKhAqM8/edit?usp=sharing) to see whatâ€™s upcoming.\ndiff --git a/.tortilla/manuals/templates/step1.tmpl b/.tortilla/manuals/templates/step1.tmpl\nnew file mode 100644\nindex 0000000..380cc0d\n--- /dev/null\n+++ b/.tortilla/manuals/templates/step1.tmpl\n@@ -0,0 +1,342 @@\n+The first thing we will do in the tutorial is to start with the UI (User Interface).\n+That is the visible part of our app that our users will see and interact with.\n+\n+In this chapter we will learn how to create a basic React app.\n+The app will contain a basic view that will render a list of conversations within our app.\n+We will gradually create our app, so for now, instead of using real data, we will use in-memory fake data instead of calling a server.\n+\n+In order to save time, instead of starting from scratch, we will use a boilerplate to kick-start our application.\n+When it comes to React apps, the most popular boilerplate is [`create-react-app`](https://github.com/facebook/create-react-app)\n+which is also officially maintained by Facebook, the creators of [React](https://reactjs.org/).\n+\n+We'll launch `create-react-app` using `yarn create` (so we won't need to install `create-react-app` permanently),\n+and run the `react-app` command to create the basis for our WhatsApp Clone.\n+\n+In your command line, navigate to the folder you want to put your app's folder in and run:\n+\n+    $ yarn create react-app whatsapp-clone-client --typescript\n+\n+> Note how we used the `client` postfix. That's because we're planning to create a server as well on later chapters.\n+\n+It will create a directory called `whatsapp-clone-client` inside the current folder.\n+Inside that directory, it will generate the initial project structure and install the needed dependencies.\n+No configuration or complicated folder structures, just the files you need to build your app.\n+\n+> In our project, we're gonna use [TypeScript](https://www.typescriptlang.org/) (indicated by the `--typescript` command).\n+> The main advantage of using TypeScript over using plain JavaScript is that if we want, we get to tell the compiler what types and data structures we expect in certain places,\n+> so that the compiler (which unlike a human never forgets) will remind us when we make a mistake and assume something that is not true.\n+> The more information we will provide to the compiler, the more the compiler will be able to help us.\n+\n+Once the installation is done, you can open your project folder:\n+\n+\t$ cd whatsapp-clone-client\n+\n+Inside the newly created project, you can run some built-in commands:\n+\n+\t$ yarn start\n+\n+Runs the app in development mode. Open `http://localhost:3000` to view it in the browser:\n+\n+![boilerplate-page](https://user-images.githubusercontent.com/7648874/54026782-025f8080-41da-11e9-9a4e-796fe15e8d03.png)\n+\n+### create-react-app\n+\n+Let's look at what create-react-app has created for us in order to understand everything that's going on.\n+\n+First thing, let's look at what webpage is being served to the browser.\n+That webpage in `index.html` that sits under the `public` folder.\n+\n+As you can see, this file is a regular HTML file. You will want to edit it's `<title>` to name our real app:\n+\n+{{{ diffStep \"1.1\" module=\"client\" files=\"public/index.html\" }}}\n+\n+In the `public` folder we will place assets that are not going to change, like `favicon.ico`, static images and the HTML templates.\n+\n+When we will prepare to app for production, a script from `create-react-app` will place those assets in a build folder and reference them into the\n+HTML template.\n+\n+Another file in the `public` folder is the `manifest.json` file that gives browsers information about our app in case the users will install the app permanently on their\n+mobile phones or desktop apps.\n+You can read more about it here: https://developers.google.com/web/fundamentals/web-app-manifest/.\n+\n+{{{ diffStep \"1.1\" module=\"client\" files=\"public/manifest.json\" }}}\n+\n+Now the HTML file has in it's <body> tag just one `<div id=\"root\"></div>` tag which is empty.\n+So how do we get the nice React logo that is being rendered onto our screen?\n+\n+`create-react-app` has scripts that will run the `src/index.tsx` file together with our HTML template, so let's look what this file is doing.\n+The important thing to see here is the `React` is calling it's render method and telling it to render the `App` component into a document where `id` equals `root`.\n+\n+So now you know where React is coming into our html template.\n+\n+But where does the `App` React component comes from and where does `React` itself comes from?\n+\n+The `index.tsx` file imports this code from outside of the file using the `import` command.\n+\n+In the case of the `App` component, we can see it bring it from the path './App', which is in the same folder ('src').\n+\n+Getting React, it is simply calling it by name instead of a path. That means that the import will automatically look for a folder named `react` under the `node-modules` folder.\n+\n+`node-modules` is a default folder which will include all of the libraries we want to use in our app.\n+\n+[yarn](https://yarnpkg.com) will install those libraries according to the dependencies listed inside the `package.json` file, so let's look into that.\n+\n+Under dependencies you can see all the libraries our app currently depends on.\n+\n+You can also see other values in there like `scripts`, which will teach `yarn` new commands that we can use.\n+The right side will name the command and the left would be the actual command that it will run.\n+\n+Another file that got created is `tsconfig.json`.\n+That file specifies options for the Typescript compiler when it takes our code and transforms it from Typescript into Javascript.\n+\n+Some noticeable configuration options for that file are:\n+\n+* `target` - What kind of Javascript should the compilers output? in our case `es5` is the version of Javascript that is supported by many browsers.\n+If you know that your app would run only on newer browsers or a Node environment, you can change that value to a newer version and gain performance improvements.\n+* `lib` - If you are using new syntax from Javascript, the compiler can add to it's output libraries that would help you support the new syntax even if the browsers don't know those.\n+* `strict` - We can give Typescript a lot of information or not so much. The more we give it the more it can help us. adding the strict option will make the compiler warn us when we won't give it enough information.\n+\n+For the full set of options, check out the [official docs](https://www.typescriptlang.org/docs/handbook/compiler-options.html);\n+\n+Now, let's look at our App's code in `src/App.tsx`.\n+\n+We can see that our app is just a function named `App`.\n+\n+`const App` means we declare a variable named `App` and `const` means it cannot be changed after it has been declared (you can't do `App = XX;` later in the app);\n+\n+Next we assign App with a function. Something like: `const App = () => {}`.\n+That way of creating functions is called `arrow functions`. It is almost equivalent to `const App = function(){}`.\n+So it is a function that doesn't accept any parameters into it.\n+\n+That function returns `jsx`. A visual language from React that describes how our component should look like.\n+\n+So all a React component is, is simply a function that returns how it look like.\n+\n+We then export this function so that React could import it from `index.tsx`.\n+\n+In our own component we will import things like the logo and styles that the component uses and those will be imported together with it each time\n+something will import our component.\n+\n+The last thing we haven't explained is the following part: `App: React.FC`.\n+Those are Typescript typings. Everything after `:` describes the types of the `App` variable and has no affect on the behavior and execution of the app.\n+It will tell Typescript what `App` is suppose to look so that in case we make a mistake Typescript will warn us before we get the app running.\n+\n+So what are the types of React.FC?  You can check it out inside by using command+click on it's name.\n+You see that it accepts `P` as props into the component and needs to return `React.Element` or `null`.\n+\n+Let's test this out, add a Typescript interface named `AppProps` and put that it includes a property called `name` of type string.\n+\n+Now let's try to return something invalid. `\"some string\"`, or `1+1`.\n+You can see that our editor is calling out that there are errors in our code.\n+\n+You will encounter those error a lot as you develop.\n+Always read the errors all the way. Understand each sentence there because that will save you a lot of time.\n+\n+Ok we now know the component doesn't get anything into itself so let's make sure the typings reflect that as well.\n+The default for React.FC is that there are no props passed inside so if we'll bring that back but keep sending the `name` value from `index.tsx` in the code, you should now get an error.\n+\n+Those errors can be very useful when your app grows.\n+Make sure to define types on the component itself like we have done now. It would make it easier to identify the issues.\n+\n+Next, we have `App.css`. This is used to style our App component.\n+Play around with changing some of the values and see how it changes your view.\n+Right now the link between the styles and the components is done by class names (`App-header`, etc).\n+Later on we'll learn better strategies of sorting our styles and making\n+sure they are not touching components that we don't want them to affect.\n+\n+Next file - `App.test.tsx`.\n+This file contains automatic tests to make sure our app is doing what it's suppose to do.\n+\n+We are programmers, that means that many times our job is to take something manual and making it automatic.\n+That's why we should also strive to automate things we do ourselves.\n+Type checking is one area, testing is another.  If we can automate tests and run them all the time, it can save us a lot of time\n+and bring us a lot of confidence that when we change our code, we haven't destroyed anything.\n+\n+The testing tool that create-react-app provides us with is [Jest](https://jestjs.io/).\n+\n+Right now we have only one simple test - it renders the App React component and makes sure nothing crashes.\n+Run the test by running `yarn test` in the command line.\n+\n+Now go and remove the export from the app component. see how the tests picked up immediately that something is wrong.\n+\n+In a later chapter we'll learn how to test more things to make sure we get guarantees that things are working as expected.\n+\n+## Pin dependencies and save-exact\n+\n+Checkout the package versions on the `package.json` file.\n+\n+you can see the `^` sign.  That means that every time someone will get this code and run `yarn`, what `yarn` will do is to get the newest version on that range.\n+We don't want that. We want to first be notified when a new version is out and we want to explicitly update it.\n+\n+That's why we need to add 2 things into our code:\n+First, to delete all `^`.\n+\n+{{{ diffStep \"1.2\" module=\"client\" files=\"package.json\" }}}\n+\n+Second, to add the following command that will make each `yarn add <package-name>` command automatically add the library without any additions or `^` signs into it.\n+\n+{{{ diffStep \"1.2\" module=\"client\" files=\".npmrc\" }}}\n+\n+There is no need to upgrade your dependencies at all. If they work it's ok. But, it is highly recommended.\n+Packages keep improving all the time with important things that would help your app and will save you time.\n+If you make it a routine to upgrade it makes it much easier then to upgrade every couple of months.\n+In order to discover if there are new versions of libraries there are 2 options.\n+\n+One is to manually run a check every day or so to find new packages out there.\n+You can do that by going to your command line in the root folder of the project and type `yarn outdated`.\n+\n+But if you want to get notified when there is a new version of your dependencies, you can check out [Renovate](https://github.com/renovatebot/renovate).\n+If your project is hosted somewhere, for example Github, it will analyze your `package.json` and submit a new PR when a new release happened from one of your dependencies.\n+\n+## git and saving your code on Github\n+\n+If you want to save your code somewhere where you can track versions, using [git](https://git-scm.com/book/en/v2) and [Github](https://guides.github.com/activities/hello-world/) is a good choice.\n+Here is a nice guide to start: https://try.github.io/.\n+\n+You can check out the `.gitignore` file create-react-app has set up for us in the root folder.\n+That file will tell `.git` what not to save and not to upload.\n+\n+**End of intro**\n+\n+Assuming that everything is set, we will now create our first screen - `ChatsListScreen`.\n+The ChatsListScreen component is responsible for showing the active conversations within our app.\n+\n+It's best to first schematically plan how our view's gonna look like.\n+This would help us illustrate the intended view and also understand which React.Components / elements take part in it.\n+This is how our screen's gonna look like:\n+\n+![chatslistscreen](https://user-images.githubusercontent.com/7648874/54027873-01305280-41de-11e9-9df0-5ad9c9c2f226.png)\n+\n+Let's break down the image above and see what components are we gonna have in the `ChatsListScreen`:\n+\n+- Navbar -  Which should contain a simple static title for now.\n+- ChatsList - Where each item's gonna contain some data regards the user we're chatting with and information about the chat.\n+\n+First let's remove the current React code and add our own code into it.\n+\n+For now, let's create fake data on our HTML.\n+\n+Add this data will be changed and we are not going to manually add HTML tags every time there is a new message, let's move our data into a JSON structure.\n+For now it would be a structure we will manually create.\n+That way we can make our React component already behave like our final version.\n+\n+{{{ diffStep \"1.3\" module=\"client\" files=\"App.tsx\" }}}\n+\n+If all we do in the function is just returning a value, instead of `const App: React.FC = () => { return () };` we can also do `const App: React.FC = () => ();`\n+So let's use that for our ChatsList component.\n+\n+We have to import React to make sure it will work.\n+We also have to export our component function so that the `App` component would be able to import it.\n+(You can't import Javascript variables from a file if that file won't explicitly export it).\n+\n+As we don't use those styles and logos anymore, we can delete the `src/App.css` and the `src/logo.svg` files from our app.\n+\n+Now let's move ChatsList into it's own component:\n+\n+{{{ diffStep \"1.4\" module=\"client\" files=\"ChatsList.tsx\" }}}\n+\n+and let's import that component into the App component and use the shorter syntax for the functional component:\n+\n+{{{ diffStep \"1.4\" module=\"client\" files=\"App.tsx\" }}}\n+\n+and let's do the same for our Navbar:\n+\n+{{{ diffStep \"1.5\" module=\"client\" }}}\n+\n+React apps tend to store React.Components under a directory located at `src/components`, and so we're gonna follow this pattern.\n+We will create a directory called ChatsListScreen in the `components` dir where we're simply gonna import and put together the Navbar and ChatsList components.\n+This is how the contents of that directory should look like:\n+\n+    ChatsListScreen\n+    â”œâ”€â”€ index.tsx\n+    â”œâ”€â”€ ChatsList\n+    â””â”€â”€ ChatsNavbar\n+\n+We will use the `index.tsx` file to define that component, this way we can import it using the directory name:\n+\n+{{{ diffStep \"1.6\" module=\"client\" }}}\n+\n+Now, we have our app rendering our view, but it is completely static and manual in the code.\n+\n+If we had 10 messages, we wouldn't want to type all of those HTML tags again and again.\n+Also if the data will change, the app should do this update itself without the need of hand written code.\n+\n+So let's create a file that lists just the data of our chats and then make our React component render a line for each entry in that file.\n+\n+We will create the file in a JSON format:\n+\n+{{{ diffStep \"1.7\" module=\"client\" files=\"db.ts\" }}}\n+\n+We are giving IDs for the values just like a database gives a unique id for each value.\n+\n+The is so we can reference specific values, for example,\n+last message would actually reference the other array instead of duplicating the values.\n+\n+Now let's change ChatsList component to import the data from that file.\n+Then to use the Javascript [map](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/map)\n+function to render a line for each data entry:\n+\n+{{{ diffStep \"1.7\" module=\"client\" files=\"ChatsList.tsx\" }}}\n+\n+When running `map` on the `chats` array, it will run a function for each entry in the array and return a value.\n+The function will receive the current entry as a parameter.\n+In our case the function will get the current function and will return a JSX line with the data of that specific chat.\n+\n+Notice we are also adding the `key` tag with the ID of each chat.\n+If you'll remove that and render again you will see the following error inside the console of your [Chrome developer tools](https://developers.google.com/web/tools/chrome-devtools/):\n+`Warning: Each child in a list should have a unique \"key\" prop`.\n+\n+By telling React how to identify and distinguish each element using the `key` value we help solve that problem and also making React faster.\n+Read [here](https://reactjs.org/docs/lists-and-keys.html) for more in depth explanation.\n+\n+Now that we rendered a line for each chat, let's add also the last message's content and creation date for each chat:\n+\n+{{{ diffStep \"1.8\" module=\"client\" }}}\n+\n+Try to run the app again.\n+\n+You can see we get a Typescript error.\n+This is because Typescript is smart enough and tells us there might be no last message.\n+So we add a check.\n+Remember to always check for null or undefined if optional, donâ€™t write shorter write safer:\n+\n+{{{ diffStep \"1.9\" module=\"client\" }}}\n+\n+Now let's try again.\n+\n+Now we have a syntax error - A JSX return value can't have more then a single root Element.\n+So in order to return a root element from the function but still display multiple elements in the same level,\n+we can use [React.Fragment](https://reactjs.org/docs/fragments.html) to wrap the returned elements:\n+\n+{{{ diffStep \"1.10\" module=\"client\" }}}\n+\n+\n+Let's try again.  This time it looks like the format is not correct, so let's format the date using the `moment` library.\n+\n+Let's install the [`moment`](https://momentjs.com/) library to wrap `lastMessage.createdAt` with a better format.\n+Moment has the ability to wrap date objects nicely and rewrite them in a pretty format.\n+This way we can have an elegant time format at which the message was sent e.g. `11:34`.\n+To install:\n+\n+\t$ yarn add moment\n+\n+\n+And now let's import the library by it's name, wrap the value of each chat and call the `format` function with our requested format:\n+\n+{{{ diffStep \"1.11\" module=\"client\" files=\"ChatsList.tsx\" }}}\n+\n+\n+If you'll try to run the app you'll see that everything is there, but it's not hard to notice that it's missing some style:\n+\n+![naked-chats-list](https://user-images.githubusercontent.com/7648874/54028578-73099b80-41e0-11e9-803a-7469300acb06.png)\n+\n+In the next chapter we will take care of styling our application with [Material-UI](https://material-ui.com/) and [styled-components](https://www.styled-components.com/) - we will give it the desired look and make it more user friendly. For now the ChatsListScreen serves no purpose, because you can't really do anything with it, but it can be used as a great basis to build on top of as we make progress.\n+\n+TODO: Define and use Prettier.\n+TODO: Editor and Prettier, extensions - Auto Import, GitLens, npm Intellisense, TypeScript Importer - works when Auto Import doesn't\n+TODO: react-dev-tools, go through everything on dev tools.\n+TODO: build. show built code. show it on file and show it on the browser.\n+TODO: Go through all of https://facebook.github.io/create-react-app/docs/\n+TODO: Should we talk about Storybook?\n+TODO: Should we use â€œâ€ or â€˜â€™?\n+TODO: Should we use date-fns instead of moment?\n\\ No newline at end of file\ndiff --git a/.tortilla/manuals/templates/step10.tmpl b/.tortilla/manuals/templates/step10.tmpl\nnew file mode 100644\nindex 0000000..6486d3b\n--- /dev/null\n+++ b/.tortilla/manuals/templates/step10.tmpl\n@@ -0,0 +1,131 @@\n+So far we've been developing the app and we've been treating it as if there's no other users; we're the only one exists.\n+This approach is true when we want to develop a UI and focus on UX, but comes a point where we need to start thinking on a macro level.\n+Our app is social interactive, and if things work properly for me, it doesn't mean that it works properly to the fellow I'm chatting with.\n+It's inevitable to have an authentication system in our app, hence we need to take care of things before we get to that stage.\n+\n+Try to open 2 instances of the app in 2 separate tabs/windows, and navigate into the same chat room.\n+Try to send a message with one instance and notice that the second instance doesn't update unless we refresh the page.\n+\n+\n+![ezgif com-video-to-gif (2)](https://user-images.githubusercontent.com/7648874/55079371-fbd87080-50d6-11e9-8ade-5ffeed6eaf8d.gif)\n+\n+\n+This issue is very important and should be addressed, because a chat is all about sending and receiving messages on a lively basis.\n+This issue was expected, as there's no mechanism that would trigger and listen to changes in the back-end.\n+In this chapter we're gonna address that issue by implementing exactly that mechanism.\n+\n+**Introducing: GraphQL Subscriptions**\n+\n+[GraphQL subscriptions](https://github.com/apollographql/graphql-subscriptions) is a mechanism that works on [web-sockets](https://en.wikipedia.org/wiki/WebSocket) and live communication; clients can subscribe to it and be notified regards specific changes that happen in the back-end. Notifications will be triggered manually by us and can be provided with parameters that provide additional information regards the triggered event. For example, a `messageAdded` will be published with the new message, and will notify all clients who are subscribed to that event. Once the subscribers are notified, they can respond as they would like to, such as updating the UI.\n+\n+\n+\n+![subscription-notifications](https://user-images.githubusercontent.com/7648874/55079462-30e4c300-50d7-11e9-8399-7706da2a9cff.png)\n+\n+\n+A subscription is presented in our GraphQL schema as a separate type called `Subscription`, where each field represents an event name along with its return type.\n+Like any other GraphQL type, each field should be match with a resolver where we handle the request.\n+\n+In this chapter we will implement the `messageAdded` subscription, so users can be notified when it happens and update the messages list to contain the new message.\n+\n+**Implementing a subscription**\n+\n+We will start by creating a new `Subscription` type in our GraphQL schema with the field `messageAdded`:\n+\n+{{{ diffStep 7.1 module=\"server\" }}}\n+\n+Changes are triggered using an event-emitter like object called `PubSub`. This can be done using the `PubSub.prototype.publish` method. We will create a new instance of it and will provide it via the [context](https://www.apollographql.com/docs/apollo-server/essentials/data#context) - a common pattern for providing objects which are useful for the execution of the resolvers:\n+\n+TODO: Explain what the context is\n+\n+{{{ diffStep 7.2 module=\"server\" }}}\n+\n+Inside the `addMessage` resolver we will publish a new event called `messageAdded`. The 3rd argument of the resolver will be the context object that we've just defined in the previous step, where we can use the pubsub instance. The TypeScript type of our context can be directly defined and generated by CodeGen through the `codegen.yml` file. This can be specified under the `ContextType` field with the file path that contains the context followed by the name of the exported object, like so:\n+\n+{{{ diffStep 7.3 module=\"server\" }}}\n+\n+The event will be published right after the message was pushed into the messages collection, because order is a crucial thing. We don't want to notify our users unless the change has been made. The event will have a single parameter which represents the new message.\n+\n+{{{ diffStep 7.4 module=\"server\" }}}\n+\n+A subscription resolver behaves differently and thus should be implemented differently. Using the `pubsub.asyncIterator` instance, we can specify which events are relevant for the subscription, for example, all clients who are subscribers of the `chatUpdated` subscription will be notified when `messageAdded`, `messageRemoved` and `chatInfoChanged` events were triggered. For now, we will have a 1 to 1 relationship between the `messageAdded` event and `messageAdded` subscription. In code, it should look like this:\n+\n+{{{ diffStep 7.5 module=\"server\" }}}\n+\n+The idea behind the `pubsub.asyncIterator` method is that it returns an [`Iterator`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Iterators_and_Generators#Iterators) like object, where each value is a promise that will be resolved when the relevant events are triggered. By default, the parameter that has a similar name to the subscription will be returned as a response, e.g. `messageAdded` parameter will be sent back to the subscribers. This behavior can be modified as explained [here](https://github.com/apollographql/graphql-subscriptions#payload-manipulation), but it's very unlikely and not necessary for our use case.\n+\n+As mentioned at the beginning of this article, there needs to be an open connection between the client and the server so live updates can happen. There are serveral methods for doing so, but the 2 most popular ones are:\n+\n+\n+\n+*   Based on polling with HTTP protocol\n+*   Based on web-sockets (WS protocol)\n+\n+HTTP polling means that each amount of time an HTTP request will be made to the server where potential changes can be sent back to us at any given time. HTTP requests are very reliable, but the problem with them is that they contain a lot of information in their headers, so even if we sent an empty request, it might be still very heavy due to cookies, user-agent, language, request type, etc.\n+\n+With web-sockets, once a connection has been established, it will remain open and it will only send the information which is relevant for the current session, so it's much faster. The communication is between the server and the client is bi-directional when it comes to web-sockets, which means that a user can spontaneously receive information from the server, as long as the communication channel remains open.\n+\n+> More information about the advantages of Web Sockets over HTTP can be found at [websocket.org](http://websocket.org/quantum.html)\n+\n+The subscription mechanism can be installed using the `server.installSubscriptionHandlers`. It will use the WS protocol by default and will fallback to HTTP polling if there were troubles establishing a connection via WS protocol:\n+\n+{{{ diffStep 7.6 module=\"server\" }}}\n+\n+Now we have everything set and we can start listening to subscriptions and react to to triggered changes.\n+\n+**Using subscriptions**\n+\n+To support subscriptions we need to establish a WS connection. For that we will need to update our Apollo client. We will install a couple of packages that will enable such feature:\n+\n+    $ yarn add subscriptions-transport-ws apollo-link apollo-link-ws apollo-utilities\n+\n+\n+*   [`subscriptions-transport-ws`](https://www.npmjs.com/package/subscriptions-transport-ws) - a transport layer that understands how client and GraphQL API communicates with each other. The spec has GQL_INIT GQL_UPDATE GQL_DATA events.\n+*   [`apollo-link-ws`](https://www.npmjs.com/package/apollo-link-ws) - Will establish a WS connection.\n+*   [`apollo-link`](https://www.npmjs.com/package/apollo-link) - Will enable WS and HTTP connections co-exist in a single client.\n+*   [`apollo-utilities`](https://www.npmjs.com/package/apollo-utilities) - Includes utility functions that will help us analyze a GraphQL AST.\n+\n+The WS url can be composed by simply running a regular expression over the `REACT_APP_SERVER_URL` environment variable and is unnecessary to be stored separately. Here's how our new client should look like: \\\n+\n+\n+{{{ diffStep 10.1 module=\"client\" files=\"client\" }}}\n+\n+Our subscription listeners should live globally across our application and shouldn't be bound to a specific component, thus we will create an external service which will be responsible of doing so. Using that service, we will update our GraphQL data-store any time a new message has been added. We will define a `messageAdded` subscription in a dedicated file under the `src/graphql/subscriptions` dir where all our subscriptions will be defined and exported:\n+\n+TODO: - but they are anyway. Itâ€™s just a standalone function that is used in a component. Which makes no difference.\n+\n+{{{ diffStep 10.2 module=\"client\" }}}\n+\n+Now we will create the service under the path `services/cache.service.ts`. Like any other GraphQL operation, `react-apollo-hooks` provides us with a dedicated React hook for subscriptions called `useSubscription`. Given the subscription document and the `onSubscriptionData` callback we can handle incoming changes. We will be using GraphQL Code Generator to generate typed subscription hooks, as the `typescript-react-apollo` plug-in supports it right out of the box. First let's update the `codegen.yml` file to look for documents in the `graphql/subscriptions` dir:\n+\n+{{{ diffStep 10.3 module=\"client\" }}}\n+\n+And then we will type the code generation command:\n+\n+    $ npm run codegen\n+\n+Now we can import and use the newly generated hook `useMessageAddedSubscription` in the `cache.service`. Like mentioned earlier, we will be using the `onSubscriptionData` callback to retrieve the change that was sent by the server and we will use it to re-write our cache. In this case we will be writing a new fragment for the incoming message, and we will update the correlated chat:\n+\n+{{{ diffStep 10.4 module=\"client\" files=\"cache.service\" }}}\n+\n+We will also use the exported `writeMessage()` function in the `ChatRoomScreen` so we won't have any code duplications:\n+\n+{{{ diffStep 10.4 module=\"client\" files=\"ChatRoom\" }}}\n+\n+One thing missing that you might notice is that we're trying to retrieve the chat from the received message, unfortunately our GraphQL schema doesn't support it and we will need to add it. On the server, we will add a `chat` field to the `Message` type in the GraphQL schema, and we will implement a resolver which will lookup for the chat in the chats collection:\n+\n+{{{ diffStep 7.7 module=\"server\" }}}\n+\n+Now that we have it supported we can update the `Message` fragment in the client to include that information. We don't need the entire chat, only its ID, since the fragment ID composition is done out of an ID and type name:\n+\n+{{{ diffStep 10.5 module=\"client\" }}}\n+\n+Finally, we will import the `useCacheService` React hook that we've just created and we will use it in our main `App` component. This means that the cache service will start listening for changes right as the app component is mounted:\n+\n+{{{ diffStep 10.6 module=\"client\" }}}\n+\n+Subscription handling is complete! If you'll try to repeat the same process again where you check messages updating between 2 instances of the app, you should see them both update.\n+\n+-------\n+\n+TODO: `useCacheService` shouldnâ€™t be called like that since itâ€™s related to message events and cache updates are only side-effects.\n\\ No newline at end of file\ndiff --git a/.tortilla/manuals/templates/step11.tmpl b/.tortilla/manuals/templates/step11.tmpl\nnew file mode 100644\nindex 0000000..6c58875\n--- /dev/null\n+++ b/.tortilla/manuals/templates/step11.tmpl\n@@ -0,0 +1,137 @@\n+Our chat app is pretty functional. We can pick a chat from the chats list and we can send messages. It's not hard to notice that one of the most important mechanisms is missing, which is relating a chat or a message to a specific user. Even though we can send messages, it's basically pointless unless someone else receives it. In this chapter we will create a new users collection with pre-defined documents and we will learn how to simulate authentication programmatically so we can test the new mechanism.\n+\n+**Reshaping the back-end**\n+\n+To implement this feature we need to rethink our back-end and reshape the way our GraphQL schema is structured. Right now we only have 2 entities: Chat and Message, which are connected like so:\n+\n+\n+\n+![chat-message-orm](https://user-images.githubusercontent.com/7648874/55325929-0faa1b00-54b9-11e9-8868-7a8ed3edcda1.png)\n+\n+\n+We want to have a new User entity where each user will have Chats he participates in and Messages he owns. Therefore, our new GraphQL schema should look like something like this:\n+\n+\n+\n+![chat-message-user-orm](https://user-images.githubusercontent.com/7648874/55325935-146ecf00-54b9-11e9-8c0f-bc3b63cbe676.png)\n+\n+This change would require us to update the GraphQL type definitions and handlers, the DB models, and the codegen configuration file:\n+\n+{{{ diffStep 8.1 module=\"server\" }}}\n+\n+Even though we made these changes, the app remained the same. That's because the Query type haven't changed at all, and we still serve the same data as before. What we need to do is to edit the Query resolvers to serve data based on the user that is currently logged-in to the app in the current session. Before we go all in with a robust authentication system, it would be smarter to simulate it, so we can test our app and see that everything works as intended.\n+\n+For now, let's assume that we're logged in with user of ID 1 - Ray Edwards. Codewise, this would mean that we will need to have the current user defined on the resolver context. In the main file, let's add the `currentUser` field to the context using a simple `find()` method from our `users` collection:\n+\n+{{{ diffStep 8.2 module=\"server\" files=\"index.ts\" }}}\n+\n+And we will update the context type:\n+\n+{{{ diffStep 8.2 module=\"server\" files=\"context\" }}}\n+\n+Now we will update the resolvers to fetch data relatively to the current user logged in. If there's no user logged in, the resolvers should return `null`, as the client is not authorized to view the data he requested:\n+\n+{{{ diffStep 8.2 module=\"server\" files=\"schema, tests\" }}}\n+\n+Now if we will get back to the app and refresh the page, we should see a new chats list which is only relevant to Ray Edwards. Earlier in this chapter, we've defined a new `isMine` field on the `Message` type. This field is useful because now we can differentiate between messages that are mine and messages that belong to the recipient. We can use that information to distinct between messages in our UI.\n+\n+Let's first download a new image that will help us achieve the new style and save it under the [`src/public/assets/message-yours.png`](https://github.com/Urigo/WhatsApp-Clone-Client-React/blob/cordova/public/assets/message-other.png?raw=true) path. Then let's implement the new style:\n+\n+{{{ diffStep 11.1 module=\"client\" files=\"src/components\" }}}\n+\n+This is how the updated `ChatRoomScreen` should look like:\n+\n+\n+\n+![chat-room-screen](https://user-images.githubusercontent.com/7648874/55326701-face8700-54ba-11e9-877e-0b7dd71a1b68.png)\n+\n+\n+\n+We can use a temporary solution to log-in and alternate between different users. This would be a good way to test data authorization without implementing an authentication mechanism. One way to know which user is logged in is via [cookies](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies).\n+\n+Cookies are just text files which are stored locally on your computer and they contain key-value data maps. Cookies will be sent automatically by the browser with every HTTP request under the `Cookie` header. The header can be parsed and read by the server and this way inform it about the state of the client. Cookie values can also be set by the server by sending back a response which contain a `Set-Cookie` header. The browser will automatically write these cookies because of its specification and how it works.\n+\n+This is how you can set cookies on the client:\n+\n+```js\n+document.cookie = \"yummy_cookie=choco\"\n+document.cookie = \"tasty_cookie=strawberry\"\n+// logs \"yummy_cookie=choco; tasty_cookie=strawberry\"\n+```\n+\n+And this is how further requests would look like:\n+\n+```\n+GET /sample_page.html HTTP/2.0\n+Host: www.example.org\n+Cookie: yummy_cookie=choco; tasty_cookie=strawberry\n+```\n+\n+Using this method we can set the current user's ID. Open your browser's dev-console, and type the following:\n+\n+```js\n+// Ray Edwards\n+document.cookie = 'currentUserId=1'\n+```\n+\n+To be able to send cookies with Apollo Client, we need to set the [`credentials`](https://www.apollographql.com/docs/react/recipes/authentication#cookie) option to \"include\" when creating the HTTP link:\n+\n+{{{ diffStep 11.2 module=\"client\" }}}\n+\n+This will set the [`Access-Control-Allow-Credentials`](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Credentials) header to â€œincludeâ€ with each HTTP request which is necessary when using the POST method. In correlation to that, we would need to configure the server to be able to receive and set cookies. This can be done via CORS options like so:\n+\n+{{{ diffStep 8.4 module=\"server\" files=\"index.ts\" }}}\n+\n+So how exactly does one retrieve the values of the cookies? Like mentioned earlier, each and every request will have them set on the `cookie` header, so one way would be by reading the header directly, but a more convenient way would be using an Express middleware called [`cookie-parser`](https://www.npmjs.com/package/cookie-parser):\n+\n+    $ yarn add cookie-parser\n+\n+{{{ diffStep 8.5 module=\"server\" files=\"index.ts\" }}}\n+\n+`cookie-parser` will read the `Cookie` header, it will parse it into a JSON and will define it on `req.cookies`. Since weâ€™re using Apollo-Server with Express, the `req` object should be accessible as the first argument in the `context` function. This means that we can use the `currentUserId` from the cookies to fetch the current user from our users collection and define it on the context object:\n+\n+{{{ diffStep 8.6 module=\"server\" }}}\n+\n+Now you can go ahead and change the value of the `currentUserId` cookie and see how it affects the view anytime you refresh the page. Needless to say that this is not the most convenient way to switch between users, so weâ€™re gonna implement a dedicated screen that will set the cookies for us.\n+\n+All the auth related logic should go into a dedicated service since it can serve us vastly across the application, not just for a single component. Thus we will create a new service called `auth.service`, which will contain 3 basic functions for now: `signIn()`, `signOut()` and `isSignedIn():\n+\n+{{{ diffStep 11.3 module=\"client\" }}}\n+\n+Now we will implement the `AuthScreen`. For now this screen should be fairly simple. It should contain a single `TextField` to specify the current user ID, and a `sign-in` button that will call the `signIn()` method with the specified ID. Once it does so, we will be proceeded to the `ChatsListScreen`. First we will download and save the following assets:\n+\n+- [`src/public/assets/whatsapp-icon.ping`](https://github.com/Urigo/WhatsApp-Clone-Client-React/raw/wip/cookie-auth/public/assets/whatsapp-icon.png)\n+\n+{{{ diffStep 11.4 module=\"client\" files=\"components\" }}}\n+\n+Accordingly we will define a new `/sign-in` route that will render the `AuthScreen` weâ€™re under that path name:\n+\n+{{{ diffStep 11.4 module=\"client\" files=\"App\" }}}\n+\n+This is how the new screen should look like:\n+\n+![auth-screen](https://user-images.githubusercontent.com/7648874/55606715-7a56a180-57ac-11e9-8eea-2da5931cccf5.png)\n+\n+Now letâ€™s type the `/sign-in` route in our browserâ€™s navigation bar and assign a user ID, see how it affects what chats we see in the `ChatsListScreen`. Youâ€™ve probably noticed that thereâ€™s no way to escape from the `/chats` route unless we edit the browserâ€™s navigation bar manually. To fix that, we will add a new sign-out button to the navbar of the `ChatsListScreen` that will call the `signOut()` method anytime we click on it, and will bring us back to the `AuthScreen`:\n+\n+{{{ diffStep 11.5 module=\"client\" }}}\n+\n+At this point weâ€™ve got everything we need, but we will add a small touch to improve the user experience and make it feel more complete. Users who arenâ€™t logged in shouldnâ€™t be able to view any screen besides the `AuthScreen`. First they need to sign-in, and only then they will be able to view the `ChatsListScreen` and `ChatRoomScreen`. To achieve that, we will wrap all the components which require authentication before we provide them into their routes. This wrap will basically check whether a user is logged in or not by reading the cookies, and if not we will be redirected to the `/sign-in` route. Letâ€™s implement that wrap in the `auth.service` and call it `withAuth()`:\n+\n+{{{ diffStep 11.6 module=\"client\" files=\"auth.service\" }}}\n+\n+We will use this function to wrap the right components in our appâ€™s router. Note that since we used the `useCacheService()` directly in the `withAuth()` method, thereâ€™s no need to use it in the router itself anymore. This makes a lot more sense since thereâ€™s no need to stay subscribed to data that you're not gonna receive from the first place unless youâ€™re logged-in:\n+\n+{{{ diffStep 11.6 module=\"client\" files=\"App\" }}}\n+\n+Assuming that youâ€™re not logged-in, if youâ€™ll try to force navigate to the `/chats` route you should be automatically redirected to the `/sign-in` form. We will finish the chapter here as we wanna keep things simple and gradual. Itâ€™s true that we havenâ€™t implemented true authentication, but that would be addressed soon further in this tutorial.\n+\n+---------\n+\n+TODO: minor change, which might be helpful for people in long term. Thatâ€™s a small but powerful thing to know about in TypeScript\n++ recipient: chat.participants.find(p => p !== currentUser.id)!\n+- recipient: chat.participants.find(p => p !== currentUser.id) as string\n+\n+\n+TODO: I donâ€™t think we need `if (props.history.location.pathname === '/sign-in') return null`\n+since withAuth HOC is not used on `AuthScreen` component\n\\ No newline at end of file\ndiff --git a/.tortilla/manuals/templates/step12.tmpl b/.tortilla/manuals/templates/step12.tmpl\nnew file mode 100644\nindex 0000000..aaf2562\n--- /dev/null\n+++ b/.tortilla/manuals/templates/step12.tmpl\n@@ -0,0 +1,85 @@\n+Now that the users system is ready it would be a lot more comfortable to implement a chat creation feature. In the original Whatsapp, you can create a new chat based on your available contacts - a list of your contacts will appear on the screen and by picking one of the items youâ€™ll basically be able to start chatting with the selected contact. However, since in our app we donâ€™t have any real contacts (yet), we will implement the chats creation feature based on all available users in our DB. By picking a user from the users list we will be able to start chatting with it.\n+\n+![demo](https://user-images.githubusercontent.com/7648874/55896445-e4c67200-5bf0-11e9-9c1c-88318642ef81.gif)\n+\n+To be able to fetch users in our system we will need to add a new query called `users`. The `users` query will retrieve all users except for current user:\n+\n+{{{ diffStep 9.1 module=\"server\" }}}\n+\n+This query will be reflected in a component called `UsersList`. First we will define and export a new fragment called `User`:\n+\n+{{{ diffStep 12.1 module=\"client\" files=\"graphql/fragments\" }}}\n+\n+And then we will implement the `UsersList` component which is going to use the `users` query with the `User` fragment:\n+\n+{{{ diffStep 12.1 module=\"client\" files=\"UsersList\" }}}\n+\n+The list is likely to change when a new user signs-up. We will implement a subscription and live-update the list further this tutorial when we go through authentication. Now we will implement a new screen component called `ChatCreationScreen`. The screen will simply render the `UsersList` along with a navigation bar:\n+\n+{{{ diffStep 12.1 module=\"client\" files=\"ChatCreationScreen\" }}}\n+\n+The screen will be available under the route `/new-chat`. The new route will be restricted, since only authenticated users should be able to access it:\n+\n+{{{ diffStep 12.1 module=\"client\" files=\"App\" }}}\n+\n+the `/new-chat` route will be accessible directly from the main `ChatsListScreen`. We will implement a navigation button which is gonna have a fixed position at the bottom right corner of the screen:\n+\n+{{{ diffStep 12.1 module=\"client\" files=\"AddChatButton\" }}}\n+\n+And then we will render it in the `ChatsListScreen`:\n+\n+{{{ diffStep 12.1 module=\"client\" files=\"ChatsListScreen/index\" }}}\n+\n+For now we can only observe the users list. Our goal now is to be able to start chatting with a user once it has been clicked. First we will need to add a new mutation called `addChat` which will create a new chat document and add it to the chats collection. If the chat already exists we will return the existing instance. This behavior will help us navigate to the desired `ChatRoomScreen`, whether it exists or not:\n+\n+{{{ diffStep 9.2 module=\"server\" }}}\n+\n+To use the new mutation, we will define a new callback called `onUserPick` in the `UsersList` so it can be used from the `ChatCreationScreen`:\n+\n+{{{ diffStep 12.2 module=\"client\" files=\"UsersList\" }}}\n+\n+In the `ChatCreationScreen/index.tsx` module, we will define an `AddChat` document with `graphql-tag`. Using the `$ yarn codegen` command we can generate the correlated React mutation hook and use it as the `onUserPick` callback:\n+\n+{{{ diffStep 12.2 module=\"client\" files=\"ChatCreationScreen/index\" }}}\n+\n+Chats can now be created, you can test out the function by signing in with different users. However, the chats list in the `ChatsListScreen` will not be updated unless we refresh the page manually. In the server project, we will define a new subscription called `chatAdded`. The subscription should be broadcasted to the current user only if he is a participant of the published chat:\n+\n+{{{ diffStep 9.3 module=\"server\" }}}\n+\n+Now we will listen to the new subscription in the client and update the cache. First we will define the subscription document:\n+\n+{{{ diffStep 12.3 module=\"client\" files=\"graphql/subscriptions\" }}}\n+\n+And then we will update the `cache.service` to write the broadcasted chat to the store. We will write the fragment, and we will also update the `chats` query to contain the new chat. We will also check if the chat already exists before we update the query, because remember, the `addChat` mutation will return the chat even if it already exists, not if it was created only:\n+\n+{{{ diffStep 12.3 module=\"client\" }}}\n+\n+Now we can create new chats, and the chats list would be updated, without refreshing the page. You can also test it with 2 separate sessions in the browser and see how each tab/window affects the other. Lastly, we will implement a chat removal function. This is important as we donâ€™t want to garbage our chats collection, sometimes we would like to clean up some of them.\n+\n+In the back-end, letâ€™s implement the `removeChat` mutation. The chat can only be removed only if the current user is one of the chatâ€™s participants. The mutation will also remove all the messages which are related to the target chat, since weâ€™re not gonna use them anymore. The chat will be removed for all participants. This is not exactly the behavior of the original Whatsapp, but to keep things simple we will go with that solution:\n+\n+{{{ diffStep 9.4 module=\"server\" }}}\n+\n+In the client app, a chat could be removed directly from the `ChatRoomScreen`. On the top right corner, right on the navbar, we will add a dispose button that will call the `removeChat` mutation. Just like we did before, we will define the mutation document with `graphql-tag` and generate the correlated hook with CodeGen:\n+\n+{{{ diffStep 12.4 module=\"client\" }}}\n+\n+Normally this is a dangerous behavior because we wipe out the entire history without any warnings, which is not recommended. For tutoring purposes only we will keep it the way it is, because it makes things simple and easier to understand.\n+\n+To be able to update the chats list cache, we will implement a `chatRemoved` subscription. The subscription will be broadcasted only to those whoâ€™re participants of the published chat:\n+\n+{{{ diffStep 9.5 module=\"server\" }}}\n+\n+In the client, we will define the right subscription document:\n+\n+{{{ diffStep 12.5 module=\"client\" files=\"graphql/subscriptions\" }}}\n+\n+And we will update the `cache.service` to listen to the new subscription and update the `chats` query accordingly. When we deal with the fragment, we remove the `FullChat` fragment because it consists of the `Chat` fragment. If it was the other way around, we would still have some data leftovers from the `FullChat` on the fragment, because of how Apollo-Cache manages the store:\n+\n+{{{ diffStep 12.5 module=\"client\" files=\"cache.service\" }}}\n+\n+We will also update the `ChatRoomScreen` to redirect us to the `/chats` route if the chat was not found. The render method of the component will be re-triggered automatically by `react-apollo-hooks` if the cached result of `useGetChat()` hook has changed, which means that even if you didnâ€™t actively remove the chat, you will still be redirected as a result:\n+\n+{{{ diffStep 12.5 module=\"client\" files=\"ChatRoom\" }}}\n+\n+TODO: maybe mention that ApolloCache doesnâ€™t have Garbage Collector so even though the object is removed, everything else related to it says in cache.\ndiff --git a/.tortilla/manuals/templates/step13.tmpl b/.tortilla/manuals/templates/step13.tmpl\nnew file mode 100644\nindex 0000000..803b11c\n--- /dev/null\n+++ b/.tortilla/manuals/templates/step13.tmpl\n@@ -0,0 +1,118 @@\n+In the previous step weâ€™ve set the ground for the authentication system in our app. We have a users collection which can be used to distinguish which data the client is authorized to view, and we have a context handler which can retrieve the current user logged in based on the received value of the `cookie` header. Itâ€™s definitely a good starting point, but it misses a lot of things.\n+\n+In this chapter we will implement a cookie-based authentication system. There are many ways to implement an authentication system in an app, but cookie-based authentication is one of the most popular ones, hence we will go with that method. Essentially the authentication flow in our app should look very simple: a user will be able to sign-in with a dedicated screen, and if he doesnâ€™t own an account he can use the sign-up screen to create a new one. The more complicated part in this flow is the back-end, which is the core of this chapter. So before we get into the implementation, we need to understand the authentication process:\n+\n+- A user logs in with a username and a password.\n+The server compares the received username and password to the ones stored in the database.\n+- If the comparison was successful, the server will generate a token and will set it as a cookie.\n+- Each time a request is sent, the server will retrieve the username from the stored token on the cookie header and will send data back accordingly.\n+\n+![auth-flow](https://user-images.githubusercontent.com/7648874/55929679-55e94200-5c50-11e9-9fe7-54ad6194a572.png)\n+\n+The stored token will save us the hassle of re-specifying the username and password over and over again each and every request. Itâ€™s important to note that everything in the authentication process is encrypted, **sensitive information will never be stored or sent in its raw form**, otherwise data might be stolen in case of a DB breach or a request hijacking. This is what it means for our app:\n+\n+- Passwords will always be stored in an encrypted form in the DB using an algorithm called [Bcrypt](https://en.wikipedia.org/wiki/Bcrypt). Bcrypt has the ability to compare the password in its raw form to the encrypted one, which can help us authorize the user.\n+\n+- Tokens are self contained. That means that once we decode the encrypted string we can get a hold of the username string. This form of encrypted tokens is called [Json Web Token (JWT)](https://jwt.io/).\n+\n+> We're not going to elaborate about the algorithm behind each encryption method because we want to focus more on practicality, although it's very much recommended to understand how each method works before proceeding.\n+\n+The implementation will follow the principles above. Authentication is a hot topic in the GraphQL world and there are several ways of doing so. We will start with the back-end and set the infrastructure for authentication, and then we will move on to the front-end.\n+\n+Weâ€™re gonna expose 2 new mutations from GraphQL Schema: `signIn` and `signUp`. `/sign-out` is unnecessary because it can be done locally by deleting the right cookie. Our back-end is gonna grow bigger so first we will separate the Express app from the Apollo Server instance, and extract the env vars to a dedicated module:\n+\n+{{{ diffStep 10.1 module=\"server\" }}}\n+\n+We will first start with the `signIn` mutation, so we can test it against pre-defined user credentials, and then we will proceed to implementing the `signUp` mutation. It would be a lot easier to progress this way. For that we will install a couple of packages:\n+\n+- `bcrypt` - which is responsible for running a one-way encryption against received passwords before theyâ€™re stored in the DB.\n+- `jsonwebtoken` - responsible for encrypting the logged-in username before itâ€™s set as a cooky and decrypting it once itâ€™s sent back with a request.\n+\n+    $ yarn add bcrypt jsonwebtoken\n+\n+\n+    $ yarn add --dev @types/bcrypt @types/jsonwebtoken\n+\n+And we will implement the `signIn` mutation:\n+\n+{{{ diffStep 10.2 module=\"server\" files=\"schema\" }}}\n+\n+As you can see we use a special secret before we encrypt the username with JWT. The same secret will be used later on to decrypt the token back into username when getting requests. If someone malicious will get a hold of that password, he can fabricate an authentication token for every user that he wants, **thus itâ€™s important to choose a strong secret**.\n+\n+When building the context for our GraphQL resolvers, we will decode the received cookie with JWT using the same secret to determine the username who made the request. Once we have that username, we can simply retrieve the original user from the DB and define it on the context:\n+\n+{{{ diffStep 10.3 module=\"server\" }}}\n+\n+You might have noticed that the User schema has been updated, because we try to address the `user.username` property. The authentication in our app will be done with a username and a password; accordingly, we will update our User type definitions and the user documents in the users collection mock. The credentials that weâ€™re going to store can actually be used to sign-in to our app:\n+\n+{{{ diffStep 10.4 module=\"server\" }}}\n+\n+To test it out, we will run our front-end application and open the dev-console. Using the Apollo Client we will send a request to the `signIn` mutation. We can use the credentials of one of the users stored in the DB. As for now all our restricted routes are observing the `currentUserId` cookie. This is wrong and no longer relevant. Letâ€™s change the `withAuth()` method to observe the `authToken` cookie so we can test our new mutation successfully:\n+\n+{{{ diffStep 13.1 module=\"client\" }}}\n+\n+Now we can perform the signIn. It would be a good idea to signIn with the first user - `ray`, since all the DB mock is built around him:\n+\n+```js\n+mutation signIn(username: 'ray', password: '111') {\n+  id\n+}\n+```\n+\n+Now if we would look at the value of `document.cookie` we should see a key named `authToken` with a JWT token and the `ChatsListScreen` should show the chats which are relevant to `ray`. To complete the sign-in flow we would need to update the `AuthScreen` and the `auth.service` to use username and password and the actual `sign-in` mutation weâ€™ve just implemented.\n+\n+To check if weâ€™re authorized to visit a route, not only we would need to check if we have the `authToken` cookie defined, but we would also need to validate it against the server to see that it actually references a real user. For that we will implement `Query.me` which will send us back the current user logged in directly from the context:\n+\n+{{{ diffStep 10.5 module=\"server\" }}}\n+\n+Now back to the `auth.service`, we will replace the `signIn()` method implementation with one that actually calls the `signIn` mutation in our API:\n+\n+{{{ diffStep 13.2 module=\"client\" }}}\n+\n+And we will use the GraphQL query weâ€™ve just implemented to check if the user actually exists within the DB before we proceed to the restricted route:\n+\n+{{{ diffStep 13.3 module=\"client\" }}}\n+\n+we will use the new query to try and fetch the user directly from the back-end, and we will only proceed if the user was actually found. In addition, we will replace the `signIn()` method to call `signIn` mutation:\n+\n+{{{ diffStep 13.4 module=\"client\" }}}\n+\n+The behavior of the updated screen should be identical to what we had so far. To complete the flow weâ€™ll need a way to signUp. When we signing-up we will need the following parameters: `name`, `username`, `password` and `passwordConfirm`. In addition we will need to run certain validations against the parameters:\n+\n+- The name must be at least 3 and at most 50 characters long.\n+- The username must be at least 3 and at most 18 characters long.\n+- A password must be at least 8 and at most 30 characters long. In addition, it should contain English letters, numbers, and special characters.\n+\n+For that we will implement a dedicated validations module:\n+\n+{{{ diffStep 10.6 module=\"server\" files=\"validators\" }}}\n+\n+And we will implement the resolver and schema for the `signUp` mutation:\n+\n+{{{ diffStep 10.6 module=\"server\" files=\"schema\" }}}\n+\n+Before encrypting the password we append a string called â€œsaltâ€ to it. Even though the passwords are stored encrypted in the DB, a hacker might use a dictionary of common passwords in their encrypted form to decipher the original password. When adding salt to a password which is essentially a random string, the hacker cannot use a dictionary anymore since he would need to know the salt. Hypothetically, the hacker can get a hold of the salt and re-generate the entire dictionary, however that would take too long because of the way Bcrypt is designed to work.\n+\n+Going back to the client, we will implement a new `signUp()` method in the `auth.service` that will call the `signUp` mutation:\n+\n+{{{ diffStep 13.5 module=\"client\" }}}\n+\n+Now we will implement a dedicated `SignUpForm` that we can use to perform the sign-up. Instead of implementing a new screen, we will use the `AuthScreen` to alternate between the `SignInForm` and the `SignUpForm` using `AnimatedSwitch`. This way we can have a container component that is common for both forms, and we will be able to switch between the two very smoothly. We will first define a new `/sign-up` route in our router:\n+\n+{{{ diffStep 13.6 module=\"client\" module=\"App\" }}}\n+\n+And then we will make the necessary changes in the `AuthScreen`:\n+\n+{{{ diffStep 13.6 module=\"client\" module=\"AuthScreen\" }}}\n+\n+> Note how we used the `/sign-(in|up)` pattern to define the `signUp` mutation. This is because the request will be further redirected in the `AuthScreen`.\n+\n+The authentication flow is complete! To test it out, you can create a new user, log in with it and start chatting with other users.\n+\n+------------\n+\n+TODO: maybe use HttpOnly in cookie\n+save userâ€™s id or data in localStorage so we can guess if a user is logged in or not and later on invalidate it\n+we send a password in its raw form over the wire\n+Error message: â€œreq.password and req.passwordConfirm don't matchâ€ looks odd, should be â€œPasswords donâ€™t matchâ€\n+Why is `const maySignUp = useCallback(() => {` a useCallback and not useMemo for example? We do use a value there.\ndiff --git a/.tortilla/manuals/templates/step14.tmpl b/.tortilla/manuals/templates/step14.tmpl\nnew file mode 100644\nindex 0000000..8541c20\n--- /dev/null\n+++ b/.tortilla/manuals/templates/step14.tmpl\n@@ -0,0 +1,321 @@\n+**Which Relational Database? And Why?**\n+\n+Weâ€™ve used to have an in-memory database so far that keeps our entities on memory inside business logic so far. But in a real application we will need a real database system that keeps our data which is seperated from our business logic. In this part we will design our database according to the relational database principles with the benefits of SQL.\n+\n+We prefer to use PostgreSQL from now on; because PostgreSQL is a Relational Database implementation that has tables, constraints, triggers, roles, stored procedures and views together with foreign tables from external data sources and many features from NoSQL.\n+\n+**Database Design**\n+\n+While we are defining our entity types and schema inside our array-based in-memory database, we have already designed the basic parts of them. In this part, we will design our relational database with base and relation tables regarding to them.\n+\n+Initially we can decide the base fields without relations;\n+* User;\n+    * `id`\n+    * `name`\n+    * `username`\n+    * `password`\n+    * `picture`\n+* Message;\n+    * `id`\n+    * `content`\n+    * `created_at`\n+* Chat;\n+    * `id`\n+\n+Before creating tables, we should design our database structure according to [Database Normalization principles](https://www.essentialsql.com/get-ready-to-learn-sql-database-normalization-explained-in-simple-english/) to prevent duplicated data and modification anomalies.\n+\n+Initially we will have 3 base tables in our database; `user`, `chat`, `message`; and there are some relations between those 3 tables. These relations will be defined in other relation tables together with different primary key and foreign key definitions.\n+\n+There are four types of relations in relational databases;\n+\n+* One to one\n+    * This relationship means A entity type can have a relationship with only one instance of B entity type while B entity type can have a relationship with only one instance of A entity type. For example, one user can have only one profile while a profile belongs to only one user.\n+* Many to one\n+    * This relationship means A entity type can have a relationship with multiple instances of B entity type while B entity type can have a relationship with only one instance of A entity type. For example, a chat can have multiple messages while a message belongs to only one chat. But `many to one` as a word means multiple photos belong to the same chat.\n+* One to many\n+    * This relationship has the same logic with Many to one. However, `One to many` as a word means a chat can have multiple messages while those messages cannot have multiple chats but only one.\n+* Many to many\n+    * This relationship means A entity type can have a relationship with multiple instances of B entity type while B entity type can have a relationship with multiple instances of A entity type dependently or independently. For example; a chat can have multiple users, and a user can have multiple chats.\n+\n+You can read more about those relations in [here](https://www.techrepublic.com/article/relational-databases-defining-relationships-between-database-tables/).\n+\n+In existing entity declarations and schema, we have 6 relationships;\n+\n+* Message has a One To Many relationship under the name of `chat` inside our schema; so one message can have one chat while one chat can have multiple messages.\n+    gql```\n+    type Message { chat: Chat }\n+    ```\n+* Message has another One To Many relationship under the name of `sender`` inside our schema; so one message can have one sender while one sender user can have multiple messages.\n+    gql```\n+    type Message { sender: User }\n+    ```\n+* Message has one more One To Many relationship under the name of `recipient`` inside our schema; so one message can have one recipient while one recipient user can have multiple messages.\n+    gql```\n+    type Message { recipient: User }\n+    ```\n+* Chat has a One To Many relationship under the name of `messages`, because one chat can have multiple messages while one message can have only one chat. Notice that this relationship is the reversed version of the first relationship in Message.\n+    gql```\n+    `type Chat { messages: [Message] }\n+    ```\n+* Chat has another Many To Many relationship under the name of `participants`, because one chat can have multiple participants while a participant can have multiple chats as well.\n+    gql```\n+    type Chat { participants: [User] }\n+    ```\n+* User has a Many To Many relationship under the name of `chats`, because one user can have multiple chats, while it has the same situation for chats.\n+    gql```\n+    type User { chats: [Chat] }\n+    ```\n+\n+So we should decide the dependencies between each other to add columns and tables to our database.\n+\n+* User is independent in all relationships, so we will keep its columns as it is\n+* Message is dependent to User in two cases so we can define this relationship as two different new foreign keys pointing to Userâ€™s id under the columns `sender_user_id`. But we donâ€™t need `recipient_user_id` because `recipient` can be found under Chatâ€™s participants.\n+* Chat is also independent because it will be better to keep those relations inside Message.\n+* Message is dependent to Chat so we can define this relationship as a new foreign key that points to Chatâ€™s id under the column named `chat_id`.\n+* We need to have another table that defines the relationship between multiple chats and users.\n+\n+> We donâ€™t need to duplicate relations in each entities, because SQL has the power to reverse each relations even if they are defined only in one entity. This is one of the rule of Database Normalization.\n+\n+Finally we can decide on our tables;\n+\n+* `chats` table;\n+    * `id` ->\n+        * `PRIMARY KEY` - `SERIAL`\n+        * `SERIAL` will automatically increase the number of the new chat row. Check SQL docs about primary key and auto increment\n+* `users` table;\n+    * `id` ->\n+        * `PRIMARY KEY` - `SERIAL`\n+    * `name` ->\n+        * `VARCHAR`\n+    * `username` ->\n+        * `VARCHAR` - `UNIQUE`\n+        * `UNIQUE` means this value can exist in this table only once. We use this feature because `username` must be unique in users for each user\n+    * `password` ->\n+        * `VARCHAR`\n+    * `picture` ->\n+        * `VARCHAR`\n+* `chats_users` table;\n+    * `chat_id` ->\n+        * `FOREIGN KEY` points to `chat.id` ->\n+            * `ON DELETE` -> `CASCADE`.\n+            * This means that if chat that has this id is deleted, this row will be deleted automatically as well.\n+    * `user_id` ->\n+        * FOREIGN KEY points to `user.id` ->\n+            * `ON DELETE` -> `CASCADE`.\n+* `messages` table;\n+    * `id` ->\n+        * `PRIMARY KEY` - `SERIAL`\n+    * `content` ->\n+        * `VARCHAR`\n+    * `created_at` ->\n+        * `TIMESTAMP` ->\n+            * `DEFAULT_VALUE = now()`\n+            * This means it will automatically set this to the current timestamp in the new row.\n+    * `chat_id` ->\n+        * `FOREIGN KEY` points to `chat.id` ->\n+            * `ON DELETE` -> `CASCADE`\n+            * This means that if chat that has this id is deleted, this row will be deleted automatically as well. So the message will be deleted immediately after the chat is deleted.\n+    * `sender_user_id` ->\n+        * `FOREIGN_KEY` points to `user.id`\n+            * `ON DELETE` -> `CASCADE`\n+            * This means that if user that has this id is deleted, this message will be deleted.\n+\n+> Notice that having a good dependency gives us an opportunity to benefit from `ON_DELETE` feature of SQL. Otherwise, we need to delete each dependent row manually by hand.\n+\n+**Installing PostgreSQL on your machine**\n+\n+***Windows / Mac OS X***\n+\n+You can download one-click installer for Windows and Mac OS X. During the installation, you must define a password and keep it somewhere safe.\n+\n+[https://www.enterprisedb.com/downloads/postgres-postgresql-downloads](Download Installer)\n+\n+***Ubuntu / Debian***\n+\n+If you have Debian package manager on your machine, you can install PostgreSQL in a single line in your Bash terminal;\n+\n+    $ sudo apt-get install postgresql postgresql-contrib\n+\n+***Other environments***\n+\n+Check [https://www.postgresql.org/download/](PostgreSQL website) for installation instructions on other environments.\n+\n+**Creating Database, Database User and Tables**\n+\n+> Make sure you have installed PostgreSQL on your environment first!\n+\n+We will use Bash terminal in order to access PostgreSQL using superuser;\n+\n+    $ su - postgres\n+\n+You don't need to execute the previous command if you're using Windows. But you have to open the terminal with Administrator privileges.\n+\n+    $ psql template1\n+\n+Then we will see the following PostgreSQL console;\n+\n+bash```\n+Welcome to psql 7.4.16, the PostgreSQL interactive terminal.\n+\n+Type:  \\\\copyright for distribution terms\n+       \\\\h for help with SQL commands\n+       \\\\? for help on internal slash commands\n+       \\\\g or terminate with semicolon to execute query\n+       \\\\q to quit\n+\n+template1\n+```\n+\n+So we can do the following SQL operations in order to create our new user, database and tables;\n+\n+* Create user for our database\n+\n+```sql\n+    CREATE DATABASE whatsapp;\n+```\n+\n+* Create database\n+\n+```sql\n+    CREATE USER testuser WITH PASSWORD 'testpassword';\n+```\n+\n+* Give permissions to that user\n+\n+```sql\n+    GRANT ALL PRIVILEGES ON DATABASE whatsapp to testuser;\n+```\n+\n+* Connect database\n+\n+```sql\n+    \\connect whatsapp\n+```\n+\n+* Create `chats` table\n+\n+```sql\n+    CREATE TABLE chats(\n+        id SERIAL PRIMARY KEY\n+    );\n+```\n+\n+* Create `users` table\n+\n+```sql\n+    CREATE TABLE users(\n+        id SERIAL PRIMARY KEY,\n+        username VARCHAR (50) UNIQUE NOT NULL,\n+        name VARCHAR (50) NOT NULL,\n+        password VARCHAR (255) NOT NULL,\n+        picture VARCHAR (255) NOT NULL\n+    );\n+```\n+\n+* Create `chats_users` table\n+\n+```sql\n+    CREATE TABLE chats_users(\n+        chat_id INTEGER NOT NULL REFERENCES chats(id) ON DELETE CASCADE,\n+        user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE\n+    );\n+```\n+\n+* Create messages table;\n+\n+```sql\n+    CREATE TABLE messages(\n+        id SERIAL PRIMARY KEY,\n+        content VARCHAR (355) NOT NULL,\n+        created_at TIMESTAMP NOT NULL DEFAULT NOW(),\n+        chat_id INTEGER NOT NULL REFERENCES chats(id) ON DELETE CASCADE,\n+        sender_user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE\n+    );\n+```\n+\n+* Give access for those tables\n+\n+```sql\n+    GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO testuser;\n+    GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO testuser;\n+```\n+\n+**Installing PostgreSQL on our backend project**\n+\n+As we are using PostgreSQL, we will use `node-postgres` as our database client in the backend.\n+\n+First install necessary npm packages using yarn;\n+\n+\t$ yarn add pg\n+\n+And we will also need TypeScript definitions for better development experience;\n+\n+\t$ yarn add @types/pg --dev\n+\n+We will use `sql` template literals (which is way easier and safer than native API) with [this package](https://github.com/felixfbecker/node-sql-template-strings) which allows you to have SQL highlighting in VSCode with (this extension)[https://marketplace.visualstudio.com/items?itemName=forbeslindesay.vscode-sql-template-literal].\n+\n+\t$ yarn add sql-template-strings\n+\n+**Connecting to our database**\n+\n+We will use connection pooling to prevent connection leaks and benefit from transactions in our complicated SQL queries. [You can read more about the benefits of connection pooling.](https://node-postgres.com/features/pooling)\n+\n+First we need to create a connection pool using our connection credentials;\n+\n+{{{diffStep 11.2 module=\"server\" files=\"db\"}}}\n+\n+**Add Database Client to GraphQL Context**\n+\n+After that, we will request a client from this pool on each network request in our GraphQL context. So we need to update our context interface and context builder function.\n+\n+{{{diffStep 11.3 module=\"server\" files=\"context, index\"}}}\n+\n+> However we need to release that client to the pool after the network connection ends to prevent connection leaks. So, letâ€™s use `formatResponse` to do this operation.\n+> We don't need connection pooling for subscriptions, because it can cause the connection open in all websocket connection. That's why, we don't request a new client from the pool if it is a subscription.\n+\n+**Update entity typings**\n+\n+We should update our entity typings according to our new database tables and columns.\n+\n+{{{diffStep 11.4 module=\"server\" files=\"db\"}}}\n+\n+**Add Sample Data**\n+\n+We need to update the `resetDb` function to add a sample data to our new relational database instead of in-memory database. But we will call `resetDb` if it is asked by using the environmental variable.\n+\n+{{{diffStep 11.5 module=\"server\" files=\"db\"}}}\n+\n+> When you update tables with your own ID values, you have to update `SEQUENCE`; because PostgreSQL calculates the next ID value using `SEQUENCE`s.\n+\n+**Updating Resolvers**\n+\n+We will benefit from transactions for complicated SQL queries in mutation. Transactions will help us to rollback our changes if there is an exception in the middle of our operations.\n+\n+{{{diffStep 11.6 module=\"server\" files=\"resolvers\"}}}\n+\n+> We use `pool` itself instead of `db` from the context in the subscriptions. Remember we don't request for a new client from the pool in subscriptions.\n+> If you use `pool.query`, it just opens a connection, does that operation and set the client free. In that case, you wouldn't be able to work with transactions which is not need in GraphQL Subscriptions.\n+\n+**Updating Subscriptions w/ PostgreSQL PubSub mechanism**\n+\n+Apolloâ€™s default PubSub mechanism is not for production usage. So, we will use PostgreSQLâ€™s notify/listen for our PubSub mechanism in GraphQL Subscriptions.\n+\n+Install the necessary packages;\n+\n+\t$ yarn add graphql-postgres-subscriptions\n+\n+{{{diffStep 11.7 module=\"server\" files=\"index\"}}}\n+\n+> Unfortunately `graphql-postgres-subscription` doesn't have TypeScript typings, so we have to import it using `require`.\n+\n+**Updating Tests**\n+\n+We should update tests to use SQL instead of in-memory database.\n+\n+{{{diffStep 11.8 module=\"server\" files=\"test\"}}}\n+\n+**Remove in-memory database**\n+\n+We can remove all the stuff related to in-memory database now.\n+\n+{{{diffStep 11.9 module=\"server\" files=\"db\"}}}\ndiff --git a/.tortilla/manuals/templates/step15.tmpl b/.tortilla/manuals/templates/step15.tmpl\nnew file mode 100644\nindex 0000000..7ab1c4a\n--- /dev/null\n+++ b/.tortilla/manuals/templates/step15.tmpl\n@@ -0,0 +1,79 @@\n+Despite using GraphQL throughout all our app, we will soon meet the need to use some external API and chances are it will be REST.\n+Our first idea could be to bridge the REST API through GraphQL, reproposing the very same API to the client. This approach is wrong, because our first concern should always be to provide the client with ready to use data in the best possible shape.\n+The client donâ€™t need to know that our GraphQL API is backed by a REST API, it doesnâ€™t have to pass headers required by the underlying API or do any kind of special considerations: our backend should take care of everything.\n+\n+## Retrieve a profile picture from a REST API\n+\n+In this chapter we will discuss how to use an external API called Unsplash to retrieve random profile pictures for the users who didnâ€™t set any.\n+\n+Start heading to https://unsplash.com/developers and clicking on â€œRegister as a developerâ€. After registering you will have to create a new app: take note of the Access Key because weâ€™re going to need it.\n+\n+If you look at the Documentation (https://unsplash.com/documentation#get-a-random-photo) youâ€™ll notice that in order to retrieve a random photo we have to query the /photos/random endpoint (GET method). We also have to pass some headers for the authent\n+cation and some params for the search term and the orientation.\n+\n+On the browser we would probably use the fetch api, but since on we node we would need a polyfill itâ€™s better to just use a full fledged library like axios:\n+\n+    yarn add axios\n+    yarn add -D @types/axios\n+\n+Before we start implementing, we want to create some typings for our endpoint, because ideally we would like to be aided by those typings during the development.\n+In order to do so we can use a Chrome extension like Advanced Rest Client to retrieve the response.\n+Set the Method to GET, the Headers to Authorization: 'Client-ID 4d048cfb4383b407eff92e4a2a5ec36c0a866be85e64caafa588c110efad350d' and the Request URL to https://api.unsplash.com/photos/random, along with the params to query: 'portrait' and orientation: 'squarish'.\n+Copy the response, create a new file called types/unsplash.ts in your vscode editor and run the command â€œPast JSON as Typesâ€ (you need to install the Past JSON as Code extension and press CTRL+P to open the run command prompt). That would be enough to automatically create the typings for the random photo endpoint.\n+\n+Now we can finally implement the REST API call in our picture resolver:\n+\n+{{{ diffStep \"12.1\" module=\"client\" files=\"schema/resolvers.ts\" }}}\n+\n+In order to test it, we have to remove the picture from one of the users and re-run the server with the `RESET_DB=true` environment variable:\n+\n+{{{ diffStep \"12.1\" module=\"client\" files=\"db.ts\" }}}\n+\n+\n+## Track the API\n+\n+Even if our typings are working pretty well so far, not all REST APIs are versioned and the shape weâ€™ve got from the server could potentially change.\n+In order to keep an eye on it we could use the safe-api middleware in order to check for abnormal answers coming from the server and log them. We can also generate the typings automatically based on the response we get.\n+First letâ€™s install the safe-api middleware:\n+\n+    yarn add @safe-api/middleware\n+\n+Then letâ€™s use it inside our resolver:\n+\n+{{{ diffStep \"12.2\" module=\"client\" files=\"schema/resolvers.ts\" }}}\n+\n+Now launch the client in order to retrieve the picture field multiple times.\n+\n+If you look inside the logs directory you will notice that it generated some graphql schema to represent the REST API. You will notice that each time we call the REST endpoint it generates a new schema, because a single response isnâ€™t generic enough to account for all possible responses. Ideally safe-api should be able to average multiple esponses in order to generate the least generic schema matching the given responses.\n+\n+Now we need to remove `types/unsplash.ts` and generate some Typescript typings out of the schema. Do do so we can use the graphql-code-generator:\n+\n+{{{ diffStep \"12.3\" module=\"client\" files=\".gitignore, codegen.yml\" }}}\n+\n+    yarn codegen\n+\n+\n+## Apollo DataSources\n+\n+Weâ€™re not done yet, there is still room for improvement. Instead of using axios, we could use Apolloâ€™s Data Sources and take advantage of the built-in support for caching, deduplication and error handling.\n+\n+    yarn remove axios @types/axios\n+    yarn add apollo-datasource-rest\n+\n+{{{ diffStep \"12.4\" module=\"client\" files=\"schema/unsplash.api.ts\" }}}\n+\n+We created the UnsplashApi class, which extends RESTDataSource. In the constructor you need to set the baseUrl (after calling super() to run the constructor of the base class). You also need to create a willSendRequest method to set the authentication headers for each call. Then itâ€™s simply a matter of creating a getRandomPhoto method to perform the actual REST API call. Instead of calling axios you will have to call the get method of the class (which in turn gets inherited from its RESTDataSource base class): the API is very similar to the axios one.\n+\n+In order to access the data source from the resolvers we need to tell Apollo to put them on the context for every request. We shouldnâ€™t use the context field, because that would lead to circular dependencies. Instead we need to use the dataSources field:\n+\n+{{{ diffStep \"12.4\" module=\"client\" files=\"index.ts\" }}}\n+\n+Now we need to update the typings for our context and run the graphq-code-generator again:\n+\n+{{{ diffStep \"12.4\" module=\"client\" files=\"context.ts\" }}}\n+\n+    yarn codegen\n+\n+Now it should be pretty easy to modify our resolver in order to use our just created datasource:\n+\n+{{{ diffStep \"12.4\" module=\"client\" files=\"schema/resolvers.ts\" }}}\ndiff --git a/.tortilla/manuals/templates/step2.tmpl b/.tortilla/manuals/templates/step2.tmpl\nnew file mode 100644\nindex 0000000..f0dbebe\n--- /dev/null\n+++ b/.tortilla/manuals/templates/step2.tmpl\n@@ -0,0 +1,214 @@\n+Now it's time to style our app.\n+\n+We can edit styles manually but we can also usie ready made components that have already been styled and shared in the community.\n+\n+In this chapter we will do both.\n+\n+First, we would also use [Material-UI](https://material-ui.com/) - a library with a set of React components that implements Google's Material Design.\n+What's good about it is that the design is already implemented right out of the box.\n+Not only that, but it also includes a set of icons which are free to use.\n+\n+There are many things that Material-UI can offer, and it's not easy to follow it up, especially with the constantly evolving and improving API.\n+The best way to go with it, is to identify a component you need, and then look for it in the [official website](https://material-ui.com/).\n+And when it comes to searching for icons, they can be found on the [material.io](https://material-ui.com/) website through the search bar.\n+\n+As we move further in this tutorial you should have a better grasp of Material and how to use it.\n+\n+![material-ui-icons](https://user-images.githubusercontent.com/7648874/54141504-c853e000-4460-11e9-94b5-aae98ec9a1e3.png)\n+\n+We will start off by installing some of the needed material libraries and its Typescript types library:\n+\n+    $ yarn add @material-ui/core @material-ui/icons @types/material-ui\n+\n+`@material-ui/core` includes core component of Material-UI such as Input, Popover, Modal, etc, and `@material-ui/icons` includes a set of icons.\n+Material is very generic and has a built in theming system which can be controlled by simply setting few variables,\n+which is exactly what we're gonna need in our app.\n+\n+In our app we're mainly gonna use 2 colors:\n+\n+- Primary #306759\n+- Secondary #79e352\n+\n+The easiest way to reference colors without repeating yourself is through Themes.\n+Theme definition can easily be done in Material using the MuiThemeProvider component:\n+\n+{{{ diffStep \"2.2\" module=\"client\" }}}\n+\n+\n+We create a `palette` of the themes together with any other definitions for the theme, and then we wrap our app with a React component\n+from the `material-ui` library to provide those definitions to all of our App's components when they need them.\n+\n+Once we have it set, the colors should be available to use in our application by simply providing the \"color\" prop to the component instance whose color we would like to change:\n+\n+```diff\n+<Button color=\"primary\">Primary</Button>\n+<Button color=\"secondary\">Secondary</Button>\n+```\n+\n+In our app, we're also gonna use CSS directly to change its colors, therefore it would be handy to have these theme variables available to us through CSS.\n+To do so, we will have a second definition of these variables in `index.css`, at the `:root` level of our application.\n+\n+That feels like a small duplication but this will help us use them in styled components directly.\n+Also that means you can view the variables in chrome-dev-tools.\n+\n+{{{ diffStep \"2.3\" module=\"client\" }}}\n+\n+`:root` is a pseudo element that simply represents the root node, which will make the colors available in all elements.\n+Normally, it works like JavaScript's scoping system and it will make variables available only to the current node and to its children, NOT its parents.\n+CSS vars can be used like so:\n+\n+```css\n+  color: var(--primary-text);\n+  background-color: var(--primary-bg);\n+```\n+\n+More information about CSS variables can be found in the [official MDN docs](https://developer.mozilla.org/en-US/docs/Web/CSS/Using_CSS_variables).\n+\n+So getting back to the ChatsListScreen, we will wrap the ChatsNavbar with Material's <Toolbar /> component:\n+\n+{{{ diffStep \"2.4\" module=\"client\" files=\"ChatsNavbar.tsx\" }}}\n+\n+And we will replace the `<ul />` and `<li />` elements with Material's `<List />` and `<ListItem />` in ChatsList:\n+\n+{{{ diffStep \"2.4\" module=\"client\" files=\"ChatsList.tsx\" }}}\n+\n+Thanks to the `button` attribute, the Material component can give our list a more vibrant feeling and that will display a nice ripple effect once an item is clicked,\n+something that could have taken a long time to implement manually.\n+\n+Now that we are using existing styled components, it's time to customize them to look exactly like we want them to look.\n+When we write styles, we usually use CSS.\n+\n+One of the important concepts that React brought us was the fact we could use just Javascript to describe our components\n+and another was the fact that we could encapsulate our UI into a set of separated components.\n+\n+But when it comes to CSS, we are still using it like before, having no encapsulation between different definitions and files.\n+\n+[Styled-components](https://www.styled-components.com/) is a relatively new library that will transpile a given string into a CSS string and will encapsulate it under a `React.Component`.\n+Bringing the same concepts from React into the way we write styles, so we ca define our styles programmatically.\n+With JavaScript in-hand you naturally have more control over our styles and its encapsulation, which makes it a very powerful tool.\n+\n+Here's one way to style a button using styled-components:\n+\n+```js\n+import styled, { css } from 'styled-components';\n+\n+const Button = styled.button`\n+  background: transparent;\n+  border-radius: 3px;\n+  border: 2px solid palevioletred;\n+  color: palevioletred;\n+  margin: 0.5em 1em;\n+  padding: 0.25em 1em;\n+\n+  ${props => props.primary && css`\n+    background: palevioletred;\n+    color: white;\n+  `}\n+`;\n+```\n+\n+* `styled` is coming from the `styled-components` library. When we call `styled.button` that means we are extending a button component from styled.\n+* `Button` will become a full React componnet with the extended styled we specified\n+* Like a React component, we can send props into our component. And like a React function, we can write Javascript code that interact and respond to those props.\n+In our case, just like a check we've done before in TSX to render something only if it exists, here only if we have a `primary` property, we will add extra styles to our component.\n+The created Button is actually a React.Component, so an instance of it can be created with ease like any other component:\n+* `css` is telling Styled components that the string literal that comes after describes CSS styles.\n+\n+```jsx\n+  <Button primary />\n+```\n+\n+But as this is just like a component, we should type it just like we type component, defining what properties it should get in:\n+\n+```tsx\n+import styled, { css } from 'styled-components';\n+\n+interface ButtonProps {\n+  readonly primary: any;\n+};\n+\n+const Button = styled.button<ButtonProps>`\n+  background: transparent;\n+  border-radius: 3px;\n+  border: 2px solid palevioletred;\n+  color: palevioletred;\n+  margin: 0.5em 1em;\n+  padding: 0.25em 1em;\n+\n+  ${props => props.primary && css`\n+    background: palevioletred;\n+    color: white;\n+  `}\n+`;\n+```\n+\n+More information about styled-components can be found in the official [docs page](https://www.styled-components.com/docs).\n+\n+Now, we will use `styled-components` to create new React.Components which are bound into a style-sheet.\n+This way when we create new instances of them, the components will be styled right out of the box. Example:\n+\n+```jsx\n+const Button = styled.button `\n+  border-radius: 999px;\n+`\n+\n+const RedButton = styled(Button) `\n+  color: red;\n+`\n+\n+const GreenButton = styled(Button) `\n+  color: green;\n+`\n+\n+const BlueButton = styled(Button) `\n+  color: blue;\n+`\n+\n+const Dashboard = (\n+  <div>\n+    <RedButton />\n+    <GreenButton />\n+    <BlueButton />\n+  </div>\n+)\n+```\n+\n+The clear advantage of such working strategy is that all the styles are encapsulated, unlike traditional CSS where style rules can easily collide and be merged unintentionally.\n+Remember that **`styled-components` operates per component, not globally**.\n+\n+We will start off by installing `styled-components` and its Typescript types library:\n+\n+    $ yarn add styled-components @types/styled-components\n+\n+Now, let's use `styled-components` our `ChatsListScreen`:\n+\n+{{{ diffStep \"2.5\" module=\"client\" files=\"index.tsx\" }}}\n+\n+Here you can see that we've created a new component called `Container`.\n+That component is extending `div` and adds some styles into it.\n+Then we've replaced the `div` element with the new, enhanced `div` called `Container`.\n+\n+With this we know for sure that the styles we applied for `Container` won't affect any other component in our app.\n+\n+{{{ diffStep \"2.5\" module=\"client\" files=\"ChatsNavbar.tsx\" }}}\n+\n+Here you can see we've done the same, but instead of extending a built-in component from styled-component,\n+we enhanced the `Toolbar` component from `material-ui.\n+\n+Notice that we also called the wrapper `Container` but again it has no affect on any component outside of our specific component.\n+\n+> Notice that we've added Typescript type inference `as typeof Toolbar` at the end. That's because of an issue that suppose to be fixed when we'll upgrade to material-ui v4.\n+\n+Let's finish this off by doing the same in our last component:\n+\n+{{{ diffStep \"2.5\" module=\"client\" files=\"ChatsList.tsx\" }}}\n+\n+Notice that we've changed the structure of the HTML of the `ChatsList` component.\n+We've added the ChatInfo to allow better alignment of the elements.\n+\n+We're done styling `ChatsListScreen`. We will keep using the same principles to style the rest of the components in our application. The final result should look like so:\n+\n+![screenshot](https://user-images.githubusercontent.com/7648874/54141766-40baa100-4461-11e9-8dd0-59edcfdb3b84.png)\n+\n+\n+TODO: What do people think about https://www.styled-components.com/docs/tooling#babel-plugin, should we use it here?\ndiff --git a/.tortilla/manuals/templates/step3.tmpl b/.tortilla/manuals/templates/step3.tmpl\nnew file mode 100644\nindex 0000000..bac6af8\n--- /dev/null\n+++ b/.tortilla/manuals/templates/step3.tmpl\n@@ -0,0 +1,239 @@\n+Currently we have a running app with a single screen which looks stylish and presents some data to the user.\n+\n+There is something missing though - The data that we are displaying can't be changed in any way.\n+\n+but even if we'll change the data, there is still a more fundamental issue - all of the data lives on the client.\n+\n+That means that each client has it's own copy of the data and the data is not shared between them,\n+if a client will create a new message, only that client will have the new message and not the client that the message was sent to.\n+\n+Also if the client will shut down, all data will be lost.\n+\n+So how can we have a place to put data that is being shared between all clients?\n+\n+We should find a central machine that all clients will connect to and get the data from.\n+If some client wants to create a new message, it will create it on that central machine so that the next time another clients will ask for the available messages,\n+all those messages will be available on the central machine.\n+\n+That central machine that stores data is called a database. and the machine that communicates between the database and the client is called a server.\n+\n+In this step, we will write a NodeJS server (server that runs using the Javascript language) and will expose a REST endpoint that will serve the data-mock.\n+We will build the REST application using [Express](https://www.npmjs.com/package/express).\n+Further in this tutorial, we will migrate to using a real data-base with real I/O from the user, because at this point, if the server will shut down, all data will be lost.\n+\n+The plan is to have a server up and running at `localhost:4000` that will expose a `GET /chats` route.\n+Unlike our client application, we're not gonna use any boilerplate and we're gonna set everything up manually.\n+\n+Right outside the client project, we will create a new directory called `whatsapp-clone-server` in which we will start creating our server:\n+\n+    $ mkdir whatsapp-clone-server\n+    $ cd whatsapp-clone-server\n+\n+Then we will use `Yarn` to initialize a new project:\n+\n+    $ yarn init -yp\n+\n+There's nothing special about this command, it only creates a basic `package.json` file.\n+Just to make sure that things work, we will add an `index.js` file which will print `\"hello world\"` to the console.\n+\n+{{{ diffStep \"1.1\" module=\"server\" files=\"index.js\" }}}\n+\n+And we will add a startup script to the `package.json` file called `start`:\n+\n+    \"start\": \"node index.js\"\n+\n+NPM-scripts are just a way to defined an alias for commands. Now we only have one simple script,\n+but it can turn out to be something very complex depending on our server, so it can be very useful.\n+More about npm-scripts can be found in the [official NPM docs](https://docs.npmjs.com/misc/scripts).\n+\n+Now we can run our server by running `$ yarn start` and we should see the message \"hello world\" printed to the console, as expected.\n+\n+Like in our client's app, we will be using TypeScript.\n+In order to use TypeScript we will install few packages:\n+\n+    $ yarn add --dev typescript ts-node @types/node\n+\n+> Note how we used the `--dev` flag. It is a good practice to separate between production dependencies and development dependencies.\n+That way when you deploy your server to the real environment, you won't install the unnecessary development dependencies there.\n+More about the `--dev` option can be read in the [NPM-install docs](https://docs.npmjs.com/cli/install).\n+\n+- The [`typescript`](https://www.npmjs.com/package/typescript) package is TypeScript's core transpiler.\n+- [`ts-node`](https://www.npmjs.com/package/ts-node) is an interpreter that will transpile required `.ts` files into JavaScript at runtime.\n+- [`@types/node`](https://www.npmjs.com/package/@types/node) will make the appropriate definitions for a Node.JS environment.\n+\n+> You can read more about the `@types` monorepo in the [official GitHub repository](https://github.com/DefinitelyTyped/DefinitelyTyped).\n+\n+We will rename the `index.js` file to `index.ts`:\n+\n+    $ mv index.js index.ts\n+\n+Now we need to compile the `ts` file to turn it into a Javascript file the Node can run.\n+\n+For that we will use Typescript and its `tsc` command.\n+The command has many options, but instead of writing them in the command line, we can specify them in a `tsconfig.json` file at the root of the project.\n+\n+Our server is gonna use the following `tsconfig.json` file, feel free to make the necessary modifications based on your needs:\n+\n+{{{ diffStep \"1.2\" module=\"server\" files=\"tsconfig.json\" }}}\n+\n+We need to tell Typescript which files to compile. Those are in the `include` key.\n+\n+Now let's run `tsc` and see what happens.\n+\n+We've got a new `index.js` file!  Now let's run it by running `node index.js`.\n+\n+That's great, but doing this work each time we change a file can be annoying,\n+so let's use tools to track when files change and make them run the code automatically after.\n+\n+And we will update the npm-script `start` to use `ts-node`, since we wanna use TypeScript, and not JavaScript directly:\n+\n+    start: ts-node index.ts\n+\n+We can test the startup of our server again by running `$ yarn start` and we should see the message \"hello world\" printed to the console.\n+\n+The skeleton of the project is set and we can move on to implementing the REST API.\n+\n+Like we said at the beginning, we will be using Express to setup the API. Express is a wrapper around the native [Node.JS \"http\"](https://nodejs.org/api/http.html) library which is responsible for handling HTTP requests.\n+Yes, it can also be used directly, but Express is much more comfortable and has an amazing ecosystem built around it.\n+Let's install Express and its TypeScript definitions:\n+\n+    $ yarn add express\n+    $ yarn add --dev @types/express\n+\n+Before we implement the `GET /chats` route we will implement a `GET /_ping` route. This route will be used to determine whether the server is up and running or not, and how fast the connection is based on the response time.\n+For every request sent to this route, we should expect a response saying \"pong\".\n+Some call it \"heartbeat\", because this route is being tested repeatedly by the hosting machine to check if it's alive, just like a heartbeat in a way.\n+This is how the route should look like:\n+\n+{{{ diffStep \"1.3\" module=\"server\" files=\"index.ts\" }}}\n+\n+We can use the\n+\n+        `$ curl localhost:4000/_ping`\n+\n+command to send a request to the server and we should get a \"pong\", assuming that the server available on that URL.\n+The `GET /chats` should be implemented similarly, only the response is different. Instead of returning \"pong\" we will return the data-mock for our chats:\n+\n+{{{ diffStep \"1.4\" module=\"server\" files=\"index.ts, db.ts\" }}}\n+\n+TODO: Mention `_req`\n+\n+Check we can get the chats by running:\n+\n+        `$ curl localhost:4000/chats`\n+\n+Unlike the previous route, we used the `.json()` method this time around to send a response. This will simply stringify the given JSON and set the right headers.\n+Similarly to the client, we've defined the db mock in a dedicated file, as this is easier to maintain and look at.\n+\n+It's also recommended to connect a middleware called [`cors`](https://www.npmjs.com/package/cors) which will enable cross-origin requests.\n+Without it we will only be able to make requests in localhost, something which is likely to limit us in the future because we would probably host our server somewhere separate than the client application.\n+Without it it will also be impossible to call the server from our client app.\n+Let's install the `cors` library and load it with the Express `middleware()` function:\n+\n+    $ yarn add cors\n+\n+and its Typescript types:\n+\n+\n+    $ yarn add --dev @types/cors\n+\n+{{{ diffStep \"1.4\" module=\"server\" files=\"index.ts\" }}}\n+\n+The server is now ready to use!\n+\n+So getting back to the client, first we will define our server's URL under the `.env` file:\n+\n+{{{ diffStep \"3.1\" module=\"client\" }}}\n+\n+This will make our server's URL available under the `process.env.REACT_APP_SERVER_URL` member expression and it will be replaced with a fixed value at build time, just like macros.\n+The `.env` file is a file which will automatically be loaded to `process.env` by the [`dotenv`](https://www.npmjs.com/package/dotenv) NPM package.\n+`react-scripts` then filters environment variables which have a `REACT_APP_` prefix and provides the created JSON to a Webpack plugin called [DefinePlugin](https://webpack.js.org/plugins/define-plugin/), which will result in the macro effect.\n+\n+Now let's move back into our React app folder.\n+We will now replace the local data-mock usage with a fetch from the server.\n+For that we can use the native [fetch API](https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API),\n+however, it needs to be used in the right life-cycle hook of the React.Component.\n+\n+There are 2 naive approaches for that:\n+\n+- Calling `fetch()` outside the component, but this way that chats will be fetched even if we're not even intending to create an instance of the component.\n+\n+```js\n+fetch().then(() => /* ... */)\n+const MyComponent = () => {}\n+```\n+\n+- Calling `fetch()` inside the component, but then it will be invoked whenever the component is re-rendered.\n+\n+```js\n+const MyComponent = () => {\n+  fetch().then(() => /* ... */)\n+}\n+```\n+\n+These 2 approaches indeed work, but they both fail to deliver what's necessary on the right time.\n+In addition, there's no way to properly coordinate async function calls with the render method of the component.\n+\n+**Introducing: React hooks**\n+\n+With React hooks we can invoke the desired logic in the right life-cycle stage of the target component.\n+This way we can avoid potential memory leaks or extra calculations.\n+To implement a proper `fetch()`, we will be using 2 React hooks:\n+\n+- [`React.useState()`](https://reactjs.org/docs/hooks-reference.html#usestate) - which is used to get and set a state of the component - will be used to store the chats fetched from the server.\n+\n+```js\n+const [value, setValue] = useState(initialValue);\n+```\n+\n+- [`React.useMemo()`](https://reactjs.org/docs/hooks-reference.html#usememo) - which is used to run a computation only once certain conditions were met - will be used to run the `fetch()` function only once the component has mounted.\n+\n+```js\n+const memoizedValue = useMemo(calcFn, [cond1, cond2, ...conds]);\n+```\n+\n+The result of that approach will look like this, in the context of our ChatsList component:\n+\n+{{{ diffStep \"3.2\" module=\"client\" }}}\n+\n+> It's recommended to read about React hooks and their basic concept at the [official React docs page](https://reactjs.org/docs/hooks-overview.html).\n+\n+At this point we can get rid of `db.ts` file in the client, since we don't use it anymore:\n+\n+    $ rm src/db.ts\n+\n+That's it. Our ChatsListScreen is now connected to a working back-end.\n+In the next step we will upgrade our REST API into a GraphQL API and we will create a basis for a more robust back-end.\n+\n+-------------\n+TODO:\n+\n+First, `tsc` has a `--watch` option so that if the Typescript files changed it will compile them again and spit new Javascript files.\n+\n+Then we need to rerun the Node server everytime the output Javascript files has changed.\n+[nodemon](https://github.com/remy/nodemon) is a tool that tracks file and if the files changed it will re-run our node server.\n+\n+Let's create a new npm script called \"watch\" and make it run both tools:\n+\n+TODO: New diff\n+\n+TODO: https://stackoverflow.com/a/39172660/1426570\n+\n+TODO: Better watch, also watch and copy schema files (maybe in a later chapter)?\n+\n+TODO: concurrently - because it works on all environments\n+\n+TODO: Explain what -r register command does in Node and in Jest\n+\n+TODO: Talk about the difference between graphql-import and graphql-import-node\n+\n+TODO: Show debugging\n+\n+\n+It's a bit annoying that we get the compiled file right next to our Typescript file, so let's move it into a separate folder:\n+\n+TODO: New diff for the `lib` folder update\n+\n+TODO: why `useMemo(fn, [true])` instead of `useEffect(fn, [])` ?\n+\n+TODO: Move to hooks in a separate commit and later change to call the server\ndiff --git a/.tortilla/manuals/templates/step4.tmpl b/.tortilla/manuals/templates/step4.tmpl\nnew file mode 100644\nindex 0000000..0d3700e\n--- /dev/null\n+++ b/.tortilla/manuals/templates/step4.tmpl\n@@ -0,0 +1,297 @@\n+**What is GraphQL?**\n+\n+[GraphQL](https://graphql.org/) is a query language invented by Facebook, and it's used to query data within from a schema.\n+In our case, we will create a schema for the data that our server exposes through its API.\n+It allows clients to define the structure of the data required, and the exact same structure of data will be returned from the server,\n+therefore preventing excessively large amounts of data from being returned.\n+Unlike REST, GraphQL APIs are organized in terms of types and fields, not endpoints.\n+\n+Even if we use GraphQL without a server, it can save us a lot of code and work becuase it can transform data in a very easy way from a schema to a query.\n+\n+Currently in our app, if we'd like to get its chats we would send a GET request to `/chats`.\n+With GraphQL it would be done differently with a string that describes the data that we would like to get:\n+\n+```graphql\n+chats {\n+  id\n+  name\n+  picture\n+  lastMessage {\n+    id\n+    content\n+    createdAt\n+  }\n+}\n+```\n+\n+> Above: An illustration of a potential GraphQL query sent to our Whatsapp API\n+\n+**Why GraphQL and not REST?**\n+\n+REST has been used for many more years and has proven itself to work well, and it's completely agnostic to the implementation of the back-end.\n+However, when it comes to data projection and aggregation, it fails to deliver.\n+\n+When using REST, often times you'll find yourself performing multiple requests to execute a single query of data.\n+Not only that, you might even end up with additional data that is not necessary.\n+Either way, the process would result in slower and heavier response.\n+\n+With GraphQL we donâ€™t have that kind of problem. The API is based on a schema built from many entities that we call object types.\n+Think of GraphQL as something similar to TypeScript but for API.\n+Object types are like interfaces, they describe the shape of an entity.\n+\n+In TypeScript you would describe a Chat as:\n+\n+```\n+interface Chat {\n+  id: string;\n+  name: string;\n+  picture: string;\n+  lastMessage: Message;\n+}\n+\n+interface Message {\n+  id: string;\n+  content: string;\n+  createdAt: number;\n+}\n+```\n+\n+GraphQL:\n+\n+```\n+type Chat {\n+  id: String\n+  name: String\n+  picture: String\n+  lastMessage: Message\n+}\n+\n+type Message {\n+  id: String\n+  content: String\n+  createdAt: Float\n+}\n+```\n+\n+Looks pretty similar?\n+\n+So this is the definition of the available data, now let's see how we can pick and structure data from it using a query:\n+\n+```graphql\n+# request\n+chats {\n+  id\n+  name\n+  picture\n+  lastMessage {\n+    id\n+    content\n+    createdAt\n+  }\n+}\n+```\n+\n+We think itâ€™s pretty straightforward to understand what do you fetch by just looking at the query above.\n+\n+![graphql-request](https://user-images.githubusercontent.com/7648874/54133620-5aec8300-4451-11e9-9bda-a459dc48f57c.png)\n+\n+If you would execute that query the result might look like this:\n+\n+```js\n+// response\n+{\n+  chats: [{\n+    id: â€œ1â€,\n+    name: â€œEthan Gonzalezâ€,\n+    picture: â€œhttps://randomuser.me/api/portraits/thumb/men/1.jpgâ€,\n+    lastMessage: {\n+      id: â€œ1â€,\n+      content: \"You on your way?\",\n+      createdAt: 1234567890\n+  }]\n+}\n+```\n+\n+You'll get exactly what you asked for with a single request. GraphQL provides a dynamic API while REST doesn't.\n+\n+**GraphQL schema, in a nutshell**\n+\n+Like said earlier,  GraphQL APIs are organized in terms of types and fields.\n+That means that our app data should be described with a schema, where each field's gonna have a resolver - the handler that will return the corresponding data.\n+Things will be much clearer as we move further.\n+\n+Let's try to describe our app's data with a GraphQL schema and then dive into it:\n+\n+```graphql\n+scalar Date\n+\n+type Message {\n+  id: ID!\n+  content: String!\n+  createdAt: Date!\n+}\n+\n+type Chat {\n+  id: ID!\n+  name: String!\n+  picture: String\n+  lastMessage: Message\n+}\n+\n+type Query {\n+  chats: [Chat!]!\n+}\n+```\n+\n+The schema is self explanatory in terms of what data it's compatible with. Supported built-in scalar types in GraphQL are:\n+\n+- Int: Signed 32â€bit integer\n+- Float: Signed double-precision floating-point value\n+- String: UTFâ€8 character sequence\n+- Boolean: true or false\n+- ID (serialized as String): A unique identifier, often used to refetch an object or as the key for a cache.\n+While serialized as a String, ID signifies that it is not intended to be humanâ€readable\n+\n+Any custom scalar can be declared with the `scalar` keyword, and custom types can be declared with the `type` keyword.\n+However, you should know that some types are reserved by GraphQL itself; `Query` is one of them.\n+The `Query` type will be used as the root for received queries by the clients, which means that we can send queries which start with the `chats` field.\n+Other reserved types are:\n+\n+- `type Query` - reserved for [GraphQL queries](https://graphql.org/learn/queries/#mutations).\n+- `type Mutation` - reserved for [GraphQL mutations.](https://graphql.github.io/learn/queries/)\n+- `type Subscription` - reserved for [GraphQL subscriptions.](https://www.apollographql.com/docs/react/advanced/subscriptions.html)\n+\n+> As we're not gonna go through the entire GraphQL API, it's recommended to go through the [official learn section of the GraphQL website](https://graphql.org/learn/), but the information so far will definitely help you kick-start, plus the upcoming implementation.\n+\n+**Getting started**\n+\n+We will be implementing a GraphQL mechanism for the client and for the server.\n+We will start with the server as things will make more sense, and we will be able to test it before we proceed into the client.\n+Essentially GraphQL is connected into a HTTP endpoint, usually under `POST /graphql`, and so this is exactly what we're gonna do, connect the endpoint handler.\n+Luckily, we don't have to implement that. A team called [Apollo](https://www.apollographql.com/) already did it for us, so we can use their implementation.\n+We will install the required packages:\n+\n+    $ yarn add apollo-server-express body-parser graphql\n+    $ yarn add --dev @types/body-parser @types/graphql\n+\n+- [`graphql`](https://www.npmjs.com/package/graphql) - The core package of GraphQL that includes the resolvers for basic data-types.\n+- [`apollo-server-express`](https://www.npmjs.com/package/apollo-server-express) - Apollo's implementation for the GraphQL Express REST endpoint.\n+- [`body-parser`](https://www.npmjs.com/package/body-parser) - Parse incoming request bodies in a middleware before your handlers, available under the req.body property.\n+- `@types/â€¦` - TypeScript definitions. Notice that we didn't need to install Apollo's types library. That is because Apollo themselves writes their source code in Typescript so\n+we get a ready Typescript code directly from their library.\n+\n+We can now connect Apollo's middleware under the `/graphql` route:\n+\n+{{{ diffStep \"2.1\" module=\"server\" files=\"index.ts\" }}}\n+\n+As you can see, the middleware requires a schema. A schema is composed mainly out of 2 fields:\n+\n+- `typeDefs` (type definitions) - the schema types we wrote earlier this chapter for chats.\n+- `resolvers` - The handlers that will provide the data for each field in `typeDefs`.\n+\n+We will start first by defining the types.\n+All we have to do is to copy-paste the contents of the schema that was shown earlier into a new file called `typeDefs.graphql`:\n+\n+{{{ diffStep \"2.2\" module=\"server\" files=\"schema/typeDefs.graphql\" }}}\n+\n+The `.graphql` file extension is just a more convenient way to work with a GraphQL schema. The exported result should be a simple string that we can use to compose our GraphQL schema. The clear advantage of working with a dedicated file is that we get to have syntax highlight.\n+\n+Now we will implement the resolvers. Resolvers are presented in a JSON object where each resolver name should match the field name it represents. You can read more about resolvers in [Apollo's official docs for resolvers](https://www.apollographql.com/docs/tutorial/resolvers.html). This is how our resolvers should look like:\n+\n+{{{ diffStep \"2.2\" module=\"server\" files=\"schema/resolvers.ts\" }}}\n+\n+For now it's extremely simple, we map the chats query directly into the database collection. Each field in the resolvers object should match the GraphQL type it represents in the schema. Since we don't have any logic now, we should not implement any resolvers for the rest of the types, the data will simply be forwarded as is.\n+\n+Note that we've implemented a custom scalar named `Date` and we resolved it with an NPM package. Let's install it:\n+\n+    $ yarn add graphql-iso-date\n+    $ yarn add --dev @types/graphql-iso-date\n+\n+Final thing that we have to do would be combining the resolvers and the type-defs under a single GraphQL schema.\n+\n+{{{ diffStep \"2.2\" module=\"server\" files=\"index.ts\" }}}\n+\n+[`graphql-tools`](https://www.npmjs.com/package/graphql-tools) is a library with a set of utilities that will help us create a schema that will be compatible with Apollo's API:\n+\n+    $ yarn add graphql-tools graphql-import\n+\n+There's one optimization however that we should make in the our DB. Right now, the each chat document has a direct reference to a message via the `lastMessage` field. Practically speaking, this is NOT how the data sits in the DB. The `lastMessage` should only hold the ID for the correlated message, and then in the Node.JS app we should **resolve** it according to our needs. Let's make the appropriate changes in the DB then:\n+\n+{{{ diffStep \"2.3\" module=\"server\" files=\"db.ts\" }}}\n+\n+And a resolver to the `lastMessage` field:\n+\n+{{{ diffStep \"2.3\" module=\"server\" files=\"schema/resolvers.ts\" }}}\n+\n+The first argument of the resolver is the raw chat data received by the DB, and the returned result should be the mapped value which we would like to return to the client.\n+\n+As we get further in this tutorial we should get a better grasp regards resolvers and their API, since we will have to deal with more logic and complexity within our Node.JS app.\n+\n+Assuming that the server is running, we can already test our GraphQL endpoint. Because it's exposed to us via a REST endpoint, we can use a `$ curl` command to send a request to `GET localhost:4000/graphql` and get a response with all the data. Again, the query that we're gonna use to fetch the chats is:\n+\n+```graphql\n+chats {\n+  id\n+  name\n+  picture\n+  lastMessage {\n+    id\n+    content\n+    createdAt\n+  }\n+}\n+```\n+\n+The one-liner version of it with a `$ curl` command looks like so:\n+\n+    curl \\\n+      -X POST \\\n+      -H \"Content-Type: application/json\" \\\n+      --data '{ \"query\": \"{ chats { id name picture lastMessage { id content createdAt } } }\" }' \\\n+      localhost:4000/graphql\n+\n+As a response we should get the data-mock for our chats stored in the server. Since we have that in place, we can go ahead and delete our implementation for the `GET /chats` route.\n+\n+Another way to test and inspect our GraphQL schema would be by using an IDE for the browser called [GraphQL Playground](https://github.com/prisma/graphql-playground).\n+Apollo-Server ships with it right out of the box and can be used right away by navigating to the `http://localhost:4000/graphql` URL from the browser.\n+\n+[![](https://i.imgur.com/AE5W6OW.png)](https://graphqlbin.com/v2/6RQ6TM)\n+\n+So getting back to the client, all we have to do is to change the fetching URL in the ChatsList component to use our newly implemented GraphQL REST endpoint:\n+\n+{{{ diffStep \"4.1\" module=\"client\" }}}\n+\n+The received data should be similar to the previous one.\n+No further changes are required.\n+\n+In the next chapter, we will continue working on the UI of our front-end application and we will add a new screen to the flow - the `ChatRoomScreen`.\n+\n+-------\n+TODO: Start with calling the  `graphql` function just on the server to show how it works.\n+TODO: Separate step for body parser.\n+TODO: Example middlewares in Node\n+TODO: Mention the vs code extension\n+\n+TODO: Introduce the scalar type later on\n+\n+TODO: Start without Apollo and add it later, in the same file.\n+TODO: remove `gql` import becuase it's unused\n+TODO: Add visualizations of how GraphQL works\n+TODO: import { loadSchema } from 'graphql-toolkit'; and install it\n+\n+TODO: What DB change is that?\n+TODO: Type `lastMessage(chat: any) {`\n+TOOD: Change `m` to `currentIteratedMessage`\n+\n+TODO: Why adding headers? and go through the code\n+\n+TODO: Talk about working with document node and not with makeExacutableSchema\n+```\n+×–×” ×œ× ×ž×©× ×” ×‘×ª×›×œ×¡, ×›×™ ApolloServer ×‘×›×œ ×ž×§×¨×” ×™×¢×©×” ×œ×–×” ×§×™×ž×¤×•×œ\n+×”× ×§×•×“×” ×”×™× ×©×œ× ×¦×¨×™×š ×œ×§×ž×¤×œ ×¤×¢×ž×™×™× ×œGraphQLSchema\n+×¤×©×•×˜ ×¢×“×™×£ ×©××ª ×”×§×™×ž×¤×•×œ ×™×¢×©×” ×”×¨×›×™×‘ ×”××—×¨×•×Ÿ ×©×”×•×œ×š ×œ×”×©×ª×ž×© ×‘typeDefs\n+\n+DocumentNode => DocumentNode (cheap, easy, no checks)\n+DocumentNode => GraphQLSchema (compile AST, does all checking, might throw exceptions, expensive)\n+GraphQLSchema => DocumentNode (printed version, might lost AST features such as directives)\n+```\n\\ No newline at end of file\ndiff --git a/.tortilla/manuals/templates/step5.tmpl b/.tortilla/manuals/templates/step5.tmpl\nnew file mode 100644\nindex 0000000..ba9132d\n--- /dev/null\n+++ b/.tortilla/manuals/templates/step5.tmpl\n@@ -0,0 +1,156 @@\n+Testing is a crucial part when writing an application, especially if we're planning to publish it or make it a commercial thing. Before we hand someone a product, of any kind, we wanna make sure that it passes certain quality checks. We're signed on that product and so it's very important to ensure that it functions properly according our expectations, otherwise wouldn't wanna use it and will look for alternatives.\n+\n+In the context of software, we constantly make changes. It's also inevitable to make all features completely independent from one another, so something in the app is likely to break as we upgrade it or maintain it. That's why we need to write a set of tests that can be run on demand, so when we implement a new feature we can simply run the tests and see what feature broke due to most recent changes.\n+\n+There are currently 3 main testing frameworks in the NPM ecosystem: [Jasmine](https://jasmine.github.io/), [Mocha](https://mochajs.org/), and [Jest](https://jestjs.io/). Each testing framework has its pros, and cons, and at the end of the day it's a matter of preference. In our application we're gonna use [Jest](https://jestjs.io/) - a testing framework which was developed by Facebook. What's good about Jest is that it can be used to test both client and server logic, because it runs as a Node.JS application, but it also emulates the browser environment whenever we run it, thanks to [JSDOM](https://github.com/jsdom/jsdom).\n+\n+![jest](https://user-images.githubusercontent.com/7648874/54493900-e2ce0380-490f-11e9-8075-be4a236c7c38.png)\n+\n+In this chapter we will learn how to test the React.Components in the client, and Apollo-GraphQL resolvers in the server. There are 3 kinds of tests:\n+\n+- Unit tests - which are used to test a single component, independently from other components in our system.\n+- Integration tests - which are used to test a component in relation to other components in our systems (how well do they co-work with each other).\n+- e2e tests (end to end) - which are used to test a complete, from the moment I clicked on a button in the user interface until the data gets back from the server and shown on the screen.\n+\n+The efficiency of the tests go from bottom to top (unit -> e2e), but the maintenance and complexity go from bottom to top (e2e -> unit). Accordingly we will need to find a good balance where we donâ€™t spend too much time on writing tests yet have a good indicator for how well our system functions. So we should write a lot of unit tests, a good amount of integration tests and a handful of e2e tests.\n+\n+![tests-types-table](https://user-images.githubusercontent.com/7648874/54494121-fed2a480-4911-11e9-9370-694ec989729b.png)\n+\n+We will start with the client as itâ€™s much easier, because Jest is set and ready to use right out of the box thanks to `create-react-app`.\n+\n+**Client - Testing React.Components**\n+\n+Thanks to `create-react-app`, we have Jest set and ready to use right out of the box, so we can start writing tests right away. I you'll look at the `src` you'll see a file called `App.test.tsx`, which simply ensures that the component can be rendered without crashing.\n+\n+```jsx\n+import React from 'react';\n+import ReactDOM from 'react-dom';\n+import App from './App';\n+\n+it('renders without crashing', () => {\n+  const div = document.createElement('div');\n+  ReactDOM.render(<App />, div);\n+  ReactDOM.unmountComponentAtNode(div);\n+});\n+```\n+\n+This is not a typical test that you're likely to find in a React project, but it demonstrates very well how Jest can be used to test DOM related issues. If you'll run `$ npm run test` (or `$ yarn test`) in the command line and then press `a`, you should see the following output:\n+\n+![report](https://user-images.githubusercontent.com/7648874/54341429-eabe4700-4674-11e9-8e76-3aaaf7fec79a.png)\n+\n+Jest will automatically run for every file that ends with a `.test.xxx` extension. This is very convenient because the tests can live right next to the component, and you don't need to lookup for it across the project. This behavior can be modified by configuring Jest in the `package.json` file under the `\"jest\"` field. More information about configuring Jest can be found in the official[ configuration documentation](https://jestjs.io/docs/en/configuration).\n+\n+> If you get a warning message regards wrapping the component with `act()` - this is a known issue with hooks and should have a proper solution soon. More about this issue and progress regards its fix can be found in this [GitHub thread](https://github.com/facebook/react/issues/14769#issuecomment-470097212).\n+\n+Now we're gonna write a basic test for the `<ChatsList />` component. In the test, we'll mock a fake response from the server, and examine the contents of rendered HTML. Since the HTML of the component is a dynamic thing and is constantly subject to changes, it would be a good idea to annotate it with `data-testid` attributes so it can be tested regardless of its structure:\n+\n+{{{ diffStep \"5.1\" module=\"client\" files=\"ChatsList.tsx\" }}}\n+\n+Now we can select various HTML elements with a query selector when we test the component. We will install a couple of packages that will assist us in implementing the test:\n+\n+  $ yarn add jest-fetch-mock jest-dom react-testing-library\n+\n+- The [`jest-fetch-mock`](https://www.npmjs.com/package/jest-fetch-mock) package can mock responses emitted by the Fetch API.\n+- The [`jest-dom`](https://www.npmjs.com/package/jsdom) package will add custom matchers that will help us examine HTML contents of DOM elements.\n+- The [`react-testing-library`](https://www.npmjs.com/package/react-testing-library) package contains utility methods that will help us test React.Components with Jest.\n+\n+Next, we will create a file under the `src` folder called `setupTests.ts`. This file is loaded configured automatically by `create-react-app` and loaded by Jest, and we can use it to set up our testing environment according to our needs (like said earlier, Jest can be configured, so this file path can be changed). We will use that file to define a fake Fetch API using the `jest-fetch-mock` library:\n+\n+{{{ diffStep \"5.2\" module=\"client\" files=\"src/setupTests.ts\" }}}\n+\n+We will create another file called `ChatsList.test.tsx`, right next to the `<ChatsList />` component under the `ChatsListScreen` directory, and inside we will implement our test. The test should follow these steps:\n+\n+- Mock the response to contain a fake chat, so we won't need to make an actual call to our GraphQL API.\n+- We will create a new instance of `<ChatsList />` and render it in a container element.\n+- We will wait for changes in the DOM caused by `setState()`.\n+- We will test the contents of the container.\n+\n+And this is how the implementation should look like:\n+\n+{{{ diffStep \"5.3\" module=\"client\" files=\"src/components/ChatsListScreen/ChatsList.test.tsx\" }}}\n+\n+> Jest API is vast but pretty intuitive for the most part. It mostly consists of test descriptors and matchers. [Here's a full list of all matchers which are built into Jest's API](https://jestjs.io/docs/en/expect). Always make sure to work against it when writing tests, for optimal results.\n+\n+We will now move on to testing the server where we will learn how to setup Jest manually and test it against a GraphQL API.\n+\n+**Server - Testing GraphQL resolvers**\n+\n+To set-up Jest, we will run the following in the command line:\n+\n+    $ yarn add --dev jest @types/jest ts-jest\n+\n+\n+This will basically install Jest and make it useable with TypeScript.\n+In addition, we will need to specify the file pattern that we would like to transform with [`ts-jest`](https://www.npmjs.com/package/ts-jest), by adding the following section to `package.json`:\n+\n+```\n+{\n+  \"jest\": {\n+    \"transform\": {\n+      \"^.+\\\\.(js|jsx|ts|tsx)$\": \"<rootDir>/node_modules/ts-jest\"\n+    }\n+  }\n+}\n+```\n+\n+We will also add a `\"test\"` script in the `package.json` file,\n+so we can run the tests with `$ yarn test`:\n+\n+```\n+{\n+  \"scripts\": {\n+    \"test\": \"jest\"\n+  }\n+}\n+```\n+\n+This is how our `package.json` should look like at this point:\n+\n+{{{ diffStep \"3.1\" module=\"server\" files=\"package.json\" }}}\n+\n+Now we're gonna test the `chats` query in our GraphQL schema. To do so, we will setup an Apollo Client and send a query request to our back-end, and then we will match the received response with a pre-defined snapshot. Luckily, we don't have to set an actual client, since the tests and the implementation of the back-end live right next to each other, thus, we will install a package which will help us achieving so:\n+\n+    $ yarn add --dev apollo-server-testing\n+\n+We will define the test suite under the `tests/queries` folder in a file called `getChats.test.ts`:\n+\n+{{{ diffStep \"3.2\" module=\"server\" files=\"tests/queries/getChats.test.ts\" }}}\n+\n+In the test function, we create a new instance of the Apollo-GraphQL server using our schema, and we query some data against it thanks to the fake client created by [`apollo-server-testing`](https://www.npmjs.com/package/apollo-server-testing).\n+\n+The `.toMatchSnapshot()` matcher will call the `toString()` method on the examined object and will test it against a predefined snapshot.\n+The snapshot will automatically be created once we run the test for the first time and will be stored under the `__snapshot__` directory.\n+This means that the first test run will always pass. This is useful because you can later on observe and adjust manually the snapshot manually without having to write it from scratch.\n+\n+So let's do our first test run for the server:\n+\n+    $ yarn test\n+\n+The expected result should be a projection of the data stored in the `db.ts` file.\n+\n+{{{ diffStep \"3.2\" module=\"server\" files=\"tests/queries/__snapshots__\" }}}\n+\n+Always be sure to observe the snapshot before moving on! The received result isn't necessarily what you'd expect. Also it's not a good practice to store production data in the snapshot because it's subject to changes. Normally we would set up another instance of the DB for testing purposes, but since our DB is a mock and doesn't represent real data, there's no need to at this stage.\n+\n+Now that we have the required knowledge regards testing and Jest's API, we will implement tests throughout the tutorial as a trivial thing. We will not go through each and every new matcher that we introduce, as it is self explanatory and there's too much of them. Be sure to work against [this full list of matchers](https://jestjs.io/docs/en/expect) when working with Jest.\n+\n+In the next chapter we will continue expanding our application by adding a `<ChatRoomScreen />`.\n+\n+----------\n+TODO: Check what changed on testing in create-react-app 3.0 https://facebook.github.io/create-react-app/docs/running-tests\n+\n+TODO: I think ts-jest could be configured in a simpler way, but need to check\n+\t{ preset: 'ts-jest' }\n+\n+TODO: I donâ€™t like using jestâ€™s toMatchSnapshot() to compare operationâ€™s result that comes from the real GraphQL Schema (with resolvers).\n+It might change quite a lot and break tests. That data might be huge and hard to be validated by looking at it. Maybe checking a structure is a better approach?\n+\n+TODO: Why ts-jest?\n+\n+TODO: Change into tortilla diff:\n+\n+TODO: Change into Tortilla diif:\n+\n+TODO: Test with UTC timezone so it would work on all computers\n+\n+TODO: const server = new ApolloServer({ typeDefs }); // easier, no need to compile the schema before\n\\ No newline at end of file\ndiff --git a/.tortilla/manuals/templates/step6.tmpl b/.tortilla/manuals/templates/step6.tmpl\nnew file mode 100644\nindex 0000000..cf3c983\n--- /dev/null\n+++ b/.tortilla/manuals/templates/step6.tmpl\n@@ -0,0 +1,223 @@\n+In this chapter we will learn how to build a chat room screen.\n+In order to navigate between different screens, we will setup a router.\n+\n+Since we're gonna have to screens in our app now - `ChatsListScreen` and `ChatRoomScreen`, we will need a router that will be able to alternate between them.\n+We will be using the [`react-router-dom`](https://www.npmjs.com/package/react-router-dom) package to manage the routes of the application:\n+\n+    $ yarn add react-router-dom\n+\n+And we will implement a router directly in the `<App />` component:\n+\n+{{{ diffStep 6.1 module=\"client\" files=\"App\" }}}\n+\n+The purpose of a router is to make route managing easy and declarative.\n+It will take care of managing the history within our app and parameterizing certain screens according to our need.\n+Essentially it's a wrap around the `window.history` object which is also compatible with React.\n+I recommend you to go through the [official MDN docs](https://developer.mozilla.org/en-US/docs/Web/API/History) if you're not yet familiar with the concept.\n+\n+The `<Route />` component represents a path for a route in our application. Using the colon syntax (`:chatId`) we basically tell the router that the `/chat` route should be followed by a string whose value can later on be addressed via a parameter called `chatId` when navigating to the route. So here's a sum-up of the routes manifest:\n+\n+\n+\n+*   `/chats` - will navigate to the `ChatsListScreen`.\n+*   `/chat/:chatId` - e.g. `/chat/1`, will navigate to the `ChatRoomScreen` and will parameterize it to show data which is related to chat ID 1.\n+*   Any other route will fallback to the `/chats` route which will redirect us to the `ChatsListScreen`.\n+\n+Now we will implement the `ChatRoomScreen` so the router can function properly.\n+For now we will make it a plain screen which simply prints out the information of the chat that was clicked so we can have a complete flow,\n+and then we will take care of the rest.\n+\n+To do so, we will first implement the `chat` query in our backend.\n+This would be a parameterized query that will provide us with a specific chat according to the received ID,\n+and it will be used by the new screen as soon as it is initialized.\n+First we would update the `Chat` type to contain a `messages` field:\n+\n+{{{ diffStep 4.1 module=\"server\" files=\"typeDefs.graphql\" }}}\n+\n+Then we will create the appropriate resolver:\n+\n+{{{ diffStep 4.1 module=\"server\" files=\"resolvers.ts\" }}}\n+\n+And then we will update our DB mock to be aligned with these changes:\n+\n+{{{ diffStep 4.1 module=\"server\" files=\"db\" }}}\n+\n+This means that when we resolve `Chat.lastMessage`, we should get it directly from the `Chat.messages` field:\n+\n+{{{ diffStep 4.2 module=\"server\" }}}\n+\n+Now that we have an updated schema which is relevant to the new screen that we would like to add, we will declare a new query called `chat`:\n+\n+{{{ diffStep 4.3 module=\"server\" files=\"schema/typeDefs\" }}}\n+\n+Note that unlike the `chats` query, this time we have a parameter. The parameters are provided to the resolver function as the second parameter as a JSON. Using the provided parameter - the chat ID, we will find and return the relevant chat from the DB:\n+\n+{{{ diffStep 4.3 module=\"server\" files=\"schema/resolvers\" }}}\n+\n+> More about the resolver signature can be read in [Apollo-GraphQL's official docs page](https://www.apollographql.com/docs/apollo-server/essentials/data.html#type-signature).\n+\n+Now we will add a test suite:\n+\n+{{{ diffStep 4.3 module=\"server\" files=\"tests/queries/getChat.test\" }}}\n+\n+We can observe the snapshot created by Jest to get a better understanding of how the response should look like:\n+\n+{{{ diffStep 4.3 module=\"server\" files=\"__snapshot__\" }}}\n+\n+If you experience any TypeScript related issues with the following error:\n+\n+```\n+Object literal may only specify known properties, and 'variables' does not exist in type 'Query'.\n+```\n+\n+Add the following declaration file to your project:\n+\n+{{{ diffStep 4.3 module=\"server\" files=\"types\" }}}\n+\n+This is a [known issue](https://github.com/apollographql/apollo-server/issues/2172) in the `apollo-server-testing` package and has a pending [fix PR](https://github.com/apollographql/apollo-server/pull/2307).\n+Now getting back to the client, let's implement a basic version of the `ChatRoomScreen` where we will fetch the new query and print it to the screen:\n+\n+{{{ diffStep 6.2 module=\"client\" }}}\n+\n+Note how we used the `match.params.chatId` variable to get the selected chat ID.\n+The `match` prop is defined and provided to us by the `<Route />` component, since it interfaces directly with the `ChatRoomScreen`.\n+More about that can be read in the [official docs page](https://reacttraining.com/react-router/core/api/match).\n+\n+In many examples online, you can see people pass the `match` prop directly to the component.\n+The main issue with that is that this makes the component being usable only by a router, but the truth is that the component\n+doesn't care if it's consumed by a router or another parents component as long as they will pass the `chatId` prop.\n+\n+So we need to make sure the interface of the ChatRoom component defines those requierements right.\n+\n+Next we will call our server from the component with the right query and store the result on a `useState` hook.\n+\n+Now, because we are using GraphQL, we know the types of the result that we are going to get, so let's create Typescript interfaces that\n+describe the data we're going to get from the server.\n+\n+If you'll run the application and type `/chats/1` in the URL bar, this is what you should see on the screen:\n+\n+![naked-chat](https://user-images.githubusercontent.com/7648874/54664314-d4096b80-4b1e-11e9-9e06-1323cf7b0abe.png)\n+\n+The view has no styling at all but it should be fixed in a moment.\n+To make navigation more convenient we will add an `onClick` listener for each chat item in the `ChatsList`.\n+Using the [history](https://reacttraining.com/react-router/core/api/history) object, provided to us by the `<Route />` component,\n+we will navigate to the correlated `ChatRoomScreen`:\n+\n+First let's install the `history` package:\n+\n+    $ yarn add history @types/history\n+\n+{{{ diffStep 6.3 module=\"client\" }}}\n+\n+And add test the new logic:\n+\n+{{{ diffStep 6.4 module=\"client\" }}}\n+\n+If you'll click on the chat item you'll see that the screen changes very suddenly.\n+We can smooth the transition by animating it with CSS.\n+Luckily we don't need to implemented such mechanism manually because there's a package that can do that for us - [`react-router-transition`](https://www.npmjs.com/package/react-router-transition):\n+\n+    $ yarn add react-router-transition\n+\n+And let's add the mising types for the library:\n+\n+{{{ diffStep 6.5 module=\"client\" files=\"react-app-env.d.ts\" }}}\n+\n+Using this package, we will create a custom `Switch` component that will play an animation for all its subordinate `Route` components.\n+The animation is defined by the user using a component called `AnimatedSwitch` as specified in the [package's docs page](http://maisano.github.io/react-router-transition/animated-switch/props).\n+So first, let's create our switch component that will play a smooth transition switching routes:\n+\n+{{{ diffStep 6.5 module=\"client\" files=\"AnimatedSwitch\" }}}\n+\n+And then replace it with the main `Switch` component in our app:\n+\n+{{{ diffStep 6.5 module=\"client\" files=\"App\" }}}\n+\n+Both components act identically and thus there shall be no special treatment. Behold the new transition effect:\n+\n+![transition-demo](https://user-images.githubusercontent.com/7648874/54739398-ebb22400-4bf2-11e9-8d4c-2aeb65deeb92.gif)\n+\n+The final screen will be composed out of 3 components:\n+\n+\n+\n+*   A navigation bar.\n+*   A messages list.\n+*   A message input.\n+\n+We will create a new directory under the path `public/assets` and inside we will download and place a couple of assets which are necessary for our view:\n+\n+*   [chat-background.jpg](https://raw.githubusercontent.com/Urigo/WhatsApp-Clone-Client-Angular/master/src/assets/chat-background.jpg)\n+*   [message-mine.png](https://raw.githubusercontent.com/Urigo/WhatsApp-Clone-Client-Angular/master/src/assets/message-mine.png)\n+\n+In the main `index.ts` file of the screen we will simply import all 3 in the right order.\n+We will start with the most simple one - the `ChatRoomNavbar`.\n+The navbar should show the picture of the chat we're currently at and its name,\n+along with a back button that will bring us back to the `ChatsListScreen`:\n+\n+{{{ diffStep 6.6 module=\"client\" files=\"ChatNavbar\" }}}\n+\n+Next, would be the `MesagesList` component, where we will see a scrollable list of all the messages of the active chat:\n+\n+{{{ diffStep 6.6 module=\"client\" files=\"MessagesList\" }}}\n+\n+And finally, would be the `MessageInput` component which will trigger an event whenever we type and submit a new message:\n+\n+{{{ diffStep 6.6 module=\"client\" files=\"MessageInput\" }}}\n+\n+Now that we have all 3 components, we will put them all together in the main `index.ts` file:\n+\n+{{{ diffStep 6.6 module=\"client\" files=\"index\" }}}\n+\n+The view is complete! However the `MessageInput` is not bound to our messages list.\n+We will use the triggered callback to update the chat state, whose changes should appear in the `MessagesList` component in the following render phase:\n+\n+{{{ diffStep 6.7 module=\"client\" }}}\n+\n+This is how the entire flow should look like:\n+\n+![flow-demo](https://user-images.githubusercontent.com/7648874/54739741-27012280-4bf4-11e9-97cb-c715482e2e70.gif)\n+\n+An edge case that should be taken care of is when the messages list length in the view exceeds the length of the container,\n+in which case we will have to scroll down to the bottom of the view.\n+This way we can keep track of the most recent message.\n+We will use `ReactDOM` to retrieve the native HTML element of the container and change the position of the scroller whenever a messages was sent:\n+\n+{{{ diffStep 6.8 module=\"client\" }}}\n+\n+Before we wrap things up, we should also test our components.\n+Since the new components have a direct control over the app's history,\n+we should also find a way to simulate it in our tests.\n+Because `react-dom-router` uses the [`history`](https://www.npmjs.com/package/history) package under the hood,\n+that means that we can use that package to inject a custom history object directly into the tested components:\n+\n+{{{ diffStep 6.9 module=\"client\" files=\"components\" }}}\n+\n+There are many things which are incomplete in the current implementation. The functionality exists in the UI, but no messages are really being sent and stored in the database. In the next chapters we will learn how to:\n+\n+\n+\n+*   Cache query results with Apollo-Client.\n+*   Send messages with GraphQL mutations\n+\n+--------\n+TODO: Add this to router chapter - https://www.pluralsight.com/guides/react-router-typescript\n+And this - https://stackoverflow.com/questions/49342390/typescript-how-to-add-type-check-for-history-object-in-react\n+\n+TODO: https://medium.com/@jrwebdev/react-higher-order-component-patterns-in-typescript-42278f7590fb\n+\n+TODO: https://www.cypress.io/blog/2019/05/13/code-create-react-app-v3-and-its-cypress-tests-using-typescript/#\n+\n+TODO: Schema says thereâ€™s always an array with messages, is it really true? Is newly created chat resolves an empty array, null will throw an error?\n+\n+TODO: Same thing with `chats: [Chat!]!`, do we always return an array here?\n+\n+TODO: _root and type all resolvers\n+\n+TODO: How to import schema together with jest, should I changed from ts-jest?\n+\n+TODO: remove all that part including the file in the commit\n+\n+TODO: Add all the new files and changes on 6.6\n+\n+TODO: Add all the new files and changes on 6.7\n\\ No newline at end of file\ndiff --git a/.tortilla/manuals/templates/step7.tmpl b/.tortilla/manuals/templates/step7.tmpl\nnew file mode 100644\nindex 0000000..2c24150\n--- /dev/null\n+++ b/.tortilla/manuals/templates/step7.tmpl\n@@ -0,0 +1,158 @@\n+In the previous step we've implemented a `ChatRoomScreen` where we were able to view each chat's messages list by clicking on a chat item from the main screen.\n+It all looks functional, however, there's a significant optimization issue - each time we navigate into a `ChatRoomScreen`,\n+we need to re-fetch the data related to the target chat.\n+\n+The solution for that would be [caching](https://en.wikipedia.org/wiki/Cache_(computing)) the fetch result,\n+so it can be re-used once we re-enter a screen that we've visited before.\n+For now things are fairly simple so the caching mechanism can be implemented manually,\n+but things are gonna get tougher when we add more queries or things like message sending and profile updating to the mix,\n+so it's not gonna be an easy task.\n+\n+Luckily, in the Apollo team they've invented a solution that works right out of the box and integrates perfectly with Apollo-GraphQL server - [Apollo-GraphQL client](https://www.apollographql.com/docs/link/#apollo-client).\n+\n+\n+![caching](https://user-images.githubusercontent.com/7648874/54871150-f505e100-4dea-11e9-9e2d-439fbf3eaebe.png)\n+\n+\n+\n+Apollo-Client is a wrap around our GraphQL endpoint which essentially uses HTTP requests (and further on [web-sockets](https://en.wikipedia.org/wiki/WebSocket), but we will get there), something that we've implemented manually so far.\n+Not only it can be used to fetch data, but it will also cache the result of the query so it can be seamlessly re-used when we request the same data.\n+This means that we will need to setup an Apollo-Client and replace all our `fetch()` calls with `client.query()` call.\n+More about Apollo-Client's API further in this tutorial, but let's start configuring it.\n+First we will install few essential NPM packages:\n+\n+    $ yarn add apollo-client apollo-cache-inmemory apollo-link apollo-link-http\n+\n+\n+\n+*   [`apollo-client`](https://www.npmjs.com/package/apollo-client) - Apollo-Client's core package, as we explained earlier.\n+*   [`apollo-cache-inmemory`](https://www.npmjs.com/package/apollo-cache-inmemory) - The data store that will be used to cache the results.\n+*   [`apollo-link-http`](https://www.npmjs.com/package/apollo-link-http) - Get GraphQL results over a network using HTTP fetch.\n+\n+We will create a new file in the `src` directory called `client.ts` and inside we will export the client:\n+\n+{{{ diffStep 7.1 module=\"client\" files=\"client\" }}}\n+\n+Although the client can be used directly and integrated into any UI framework, it would be the most comfortable to use a wrap around it which is suitable for React.\n+For that we will use a package called [`react-apollo-hooks`](https://www.npmjs.com/package/react-apollo-hooks) which includes a set of [React hooks](https://reactjs.org/docs/hooks-intro.html) that can connect between our Apollo-Client and target React.Component:\n+\n+    $ yarn add react-apollo-hooks graphql-tag graphql\n+\n+With `react-apollo-hooks` we can use the `useQuery()` hook to fetch data from our GraphQL API.\n+The `graphql-tag` package is used to parse the GraphQL string to an [AST](https://en.wikipedia.org/wiki/Abstract_syntax_tree), something which is required when using Apollo Client. Example:\n+\n+\n+```\n+import gql from 'graphql-tag';\n+import { useQuery } from 'react-apollo-hooks';\n+\n+const GET_DOGS = gql`\n+  {\n+    dogs {\n+      id\n+      breed\n+    }\n+  }\n+`;\n+\n+const Dogs = () => {\n+  const { data, error, loading } = useQuery(GET_DOGS);\n+  if (loading) {\n+    return <div>Loading...</div>;\n+  };\n+  if (error) {\n+    return <div>Error! {error.message}</div>;\n+  };\n+\n+  return (\n+    <ul>\n+      {data.dogs.map(dog => (\n+        <li key={dog.id}>{dog.breed}</li>\n+      ))}\n+    </ul>\n+  );\n+};\n+```\n+\n+\n+The package requires a small setup so that imported hooks can use our Apollo-Client:\n+\n+{{{ diffStep 7.2 module=\"client\" files=\"index\" }}}\n+\n+The code above uses the [Context/Provider](https://reactjs.org/docs/context.html) API, thus the client is now known globally.\n+Now that we can use the `useQuery()` hook, there's no need to use the native Fetch API anymore.\n+Let's replace all our Fetch API call instances with a React hook:\n+\n+{{{ diffStep 7.3 module=\"client\" files=\"components\" }}}\n+\n+You can see that we've fetched the query using Apollo client, and we removed the `setChat` call because Apollo will know automatically to place the results in the cache.\n+\n+And you can see we can also work directly with the cache.\n+\n+On the `OnSendMessage` function we take the new message and push it to Apollo Client's cache.\n+\n+Now if we'll scroll to another screen and come back, the messages will still be displayed there.\n+\n+You can see that we've added the `__typename` when we push a new chat to the cache.\n+That's how Apollo Client knows where to place the results.\n+\n+The replacement is finished. Note that we removed the usage of `useMemo()` - because Apollo has an internal cache mechanism, there's no need to memoize the result anymore.\n+We also used the [`writeQuery()`](https://www.apollographql.com/docs/react/features/caching.html#writequery-and-writefragment) method to edit the stored result in the cache, so in the next render phase we would have an updated chat with the newly added message.\n+\n+We shouldn't see any change at all in the view and the response time, since we're running it locally, but if we will take a look at the `network` tab in the browser's dev-tools we should notice the differences:\n+\n+**before**\n+\n+![fetch](https://user-images.githubusercontent.com/7648874/54871305-e5879780-4dec-11e9-87bb-3279e9e18342.png)\n+\n+**after**\n+\n+![apollo](https://user-images.githubusercontent.com/7648874/54871319-1bc51700-4ded-11e9-9001-d5518bedf9ad.png)\n+\n+> Above: ChatsListScreen -> ChatRoomScreen -> ChatsListScreen -> ChatRoomScreen\n+\n+This test is obviously very rough, but the deviation is so big that you don't need any accuracy to emphasize the difference.\n+The blue stripes represents the requests made and the time they took. Before we had about 6 request phases, while after we had only 3 of them.\n+\n+Since we don't use the Fetch API anymore, we will also need to update our tests.\n+Right now we mock the response from the fetch API, but a more appropriate way would be creating a fake Apollo Client where we will be able to mock the results.\n+For that we will install a package called [`apollo-link-mock`](https://www.npmjs.com/package/apollo-link-mock):\n+\n+    $ yarn add --dev apollo-link-mock\n+\n+And we will create a `test-helpers.ts` file under the `src` directory that will contain the utility function for creating a fake Apollo Client:\n+\n+{{{ diffStep 7.4 module=\"client\" files=\"test-helpers\" }}}\n+\n+The fake client accepts an array of mocks where each mock object will have a `request` key that will contain details about the request and a `result` key which will contain the mocked result.\n+You should get a better understanding of how it works now that we will replace the fake Fetch calls with fake Apollo Clients:\n+\n+{{{ diffStep 7.4 module=\"client\" files=\"src/components\" }}}\n+\n+We are telling Apollo mock to give a certain result each time it gets a specific query.\n+\n+Note how we used the `ApolloProvider` component to provide the target component with the fake Apollo Client.\n+Like so, any other component which uses Apollo Client should be wrapped with an ApolloProvider when rendering it, otherwise it will not function as intended:\n+\n+{{{ diffStep 7.4 module=\"client\" files=\"src/App\" }}}\n+\n+That's it for this chapter. There's one thing missing to make our `ChatRoomScreen` functional and that would be actually sending a message to the backend and updating the DB. In the next chapter we will learn how to do exactly that with our new Apollo-Client.\n+\n+\n+--------------------\n+\n+TODO: Change the whole intro.\n+\n+TODO: I think we might want to explain the cache in more details\n+how itâ€™s normalized\n+how some parts update automatically and some do not\n+whatâ€™s the smallest unit stored in the cache\n+and other stuff\n+this might help later on with optimistic responses and mutations in general\n+\n+TODO: Remove all label code\n+\n+TODO: Create a drawing of the cache.\n+TODO: Change typename from Chat to Message\n+\n+TODO: Explain a bit about Apollo links.\n\\ No newline at end of file\ndiff --git a/.tortilla/manuals/templates/step8.tmpl b/.tortilla/manuals/templates/step8.tmpl\nnew file mode 100644\nindex 0000000..f3a2022\n--- /dev/null\n+++ b/.tortilla/manuals/templates/step8.tmpl\n@@ -0,0 +1,156 @@\n+The view and the functionality for updating the component's state when sending a message already exists.\n+The thing is that messages are not really being sent, we only update the memory in the client.\n+\n+If so, how exactly can we send messages and store them in the DB? For this purpose we're gonna learn about GraphQL mutations -\n+a method for sending and applying mutations in our back-end.\n+\n+**What are GraphQL mutations?**\n+\n+If you have an API endpoint that alters data, like inserting data into a database or altering data already in a database,\n+you should make this endpoint a `Mutation` rather than a `Query`.\n+This is as simple as making the API endpoint part of the top-level `Mutation` type instead of the top-level `Query` type.\n+\n+It's often convenient to have a mutation that maps to a database create or update operation, return the same thing that the server stored.\n+That way, if you modify the data on the server, the client can learn about those modifications.\n+**A GraphQL mutation is like a GraphQL query, only with side effects**.\n+It's equivalent to GET (query) and POST/PUT (mutation) in the context of REST API.\n+\n+Below is a sample GraphQL mutation request:\n+\n+```graphql\n+mutation AddMessage($chatId: ID!) {\n+  addMessage(chatId: $chatId) {\n+    id\n+    contents\n+    createdAt\n+  }\n+}\n+```\n+\n+**How to implement a GraphQL mutation?**\n+\n+Since GraphQL is schema based, we will need to create a new type called `Mutation` in the `typeDefs.graphql` file.\n+In this chapter we want to have the ability to send messages, thus we will have a field named `addMessage` in the new mutation type:\n+\n+{{{ diffStep 5.1 module=\"server\" files=\"typeDefs\" }}}\n+\n+Note that our mutation resolver `addMessage` receives a `chatId`. This is because when adding a message, we should update both the messages collection, and the correlated chat document. Mutations are resolved exactly like any other type in our resolvers manifest. The new resolver should look like this:\n+\n+{{{ diffStep 5.1 module=\"server\" files=\"resolvers\" }}}\n+\n+In terms of testing, we will use a temporary solution for now to reset the DB each time we test a mutation. Since we make a modification in the DB, we need to make sure that each test is completely agnostic and doesn't affect one another, thus, we will export a `resetDB()` method from our `db.ts` module:\n+\n+{{{ diffStep 5.2 module=\"server\" files=\"db.ts\" }}}\n+\n+And we will use the `beforeEach()` test hook to reset the `chats` and `messages` collections:\n+\n+{{{ diffStep 5.2 module=\"server\" files=\"tests\" }}}\n+\n+Now we have the infrastructure set for sending a new message and we can start using it in our client.\n+\n+**How to use a GraphQL mutation?**\n+\n+Like in the previous chapters, we're gonna use a React hook so we can run a mutation more efficiently in a React.Component.\n+For this we're gonna use the [`useMutation()`](https://github.com/trojanowski/react-apollo-hooks#usemutation) react hook.\n+The first argument of the hook is the mutation string, and the second one is the [mutation options](https://www.apollographql.com/docs/react/api/apollo-client.html#ApolloClient.mutate).\n+We're gonna provide our mutation call with a single option called `optimisticResponse`.\n+\n+Optimistic response is a common pattern that will update the state of the component twice so we can have a better UX: First it updates the component's state with the predicted result,\n+and then it will update the state with the actual result.\n+\n+\n+\n+![optimistic_response](https://user-images.githubusercontent.com/7648874/54883302-859df900-4e9f-11e9-9eb7-a98108cd2482.png)\n+\n+\n+This is how the component should look like:\n+\n+{{{ diffStep 8.1 module=\"client\" }}}\n+\n+Note that unlike `useQuery()`, `useMutation()` returns a callback that will run the mutation only once called, NOT immediately.\n+Seemingly, everything works fine, but if you'll try to navigate from `ChatsListScreen` to `ChatRoomScreen`, send a message, and then go back, you'll see that the last message was not updated.\n+So why is that exactly?\n+\n+**Cache updating**\n+\n+As explained in the previous chapter, Apollo-Client will cache all the results in a data-store.\n+Later on, rather than re-fetching the data, it will look up for the result in the store and will serve it to you in case it exists.\n+That means, that even though we ran the mutation and updated the data on the server, our data-store is still left behind and it needs to be updated as well,\n+otherwise Apollo-Client will see nothing wrong with the outcome.\n+\n+Apollo-Client stores the data in a hash, where the key represents the query and the value represents the retrieved result.\n+This means that the cache will need to be updated for:\n+\n+\n+*   `chats` query - which we already did, without really diving into the reason behind it.\n+*   `chat(chatId: $chatId)` where `chatId` is the chat that was just mutated.\n+\n+Indeed, a query will be duplicated for each and every distinct set of parameters.\n+So potentially our data-store can grow infinite amount of times, and we will need to take care of it and manage it correctly, so things won't get out of hand.\n+\n+To update a query, we will first export the `getChats` query to a separate file so it can be imported in the `ChatRoomScreen`.\n+We will define all our GraphQL assets under the `src/graphql` directory:\n+\n+{{{ diffStep 8.2 module=\"client\" files=\"graphql\" }}}\n+\n+And then we will read the memoized result from the store using [`client.readQuery`](https://www.apollographql.com/docs/react/features/caching.html#readquery),\n+update it, and then rewrite it using [`client.writeQuery`](https://www.apollographql.com/docs/react/features/caching.html#writequery-and-writefragment).\n+We can gain access to the client object via the `update` callback which will be triggered right after the mutation has been successfully executed.\n+This is how it should look like:\n+\n+{{{ diffStep 8.2 module=\"client\" files=\"components\" }}}\n+\n+Right now what happens is that we update a single chat document twice: Once for the `chats` query and another time for the `chat($chatId)` query.\n+This work is redundant and become more complex as we add more `chat` related queries.\n+To solve it, we can define and use a [GraphQL fragment](https://www.apollographql.com/docs/react/advanced/fragments.html).\n+\n+**Using Fragments**\n+\n+A GraphQL fragment is a shared piece of query logic.\n+\n+```graphql\n+fragment NameParts on Person {\n+  firstName\n+  lastName\n+}\n+\n+query GetPerson {\n+  people(id: \"7\") {\n+    ...NameParts\n+    avatar(size: LARGE)\n+  }\n+}\n+```\n+\n+It's important to note that the component after the `on` clause is designated for the type we are selecting from. In this case, `people` is of type `Person` and we want to select the `firstName` and `lastName` fields from `people(id: \"7\")`.\n+\n+Apollo maps the fragment ID to its retrieved data in the store. By default, Apollo will compose the fragment ID out of the entity type and the ID of the document. For example, for a `Chat` document with an ID of `7`, the fragment ID would be `Chat:7`. This behavior can be modified, but there's no need to.\n+\n+We will define the following fragments in our app:\n+\n+\n+\n+*   `Message` - represents a message\n+*   `Chat` - represents a chat, **without its messages list**.\n+*   `FullChat` - represents a chat, **including its messages list**.\n+\n+Once we define the fragments we can start embedding them in our queries. We will create a new directory path `src/graphql/fragments`, and inside we will create a dedicated fragment file for each fragment type: `message.fragment.ts`, `chat.fragment.ts` and `fullChat.fragment.ts`:\n+\n+{{{ diffStep 8.3 module=\"client\" files=\"graphql/fragments\" }}}\n+\n+And now that we have the fragments available to us, let's embed them in the relevant queries:\n+\n+{{{ diffStep 8.3 module=\"client\" files=\"components, graphql/queries\" }}}\n+\n+Similarly to query rewriting, we will use the [`readFragment()`](https://www.apollographql.com/docs/react/features/caching.html#readfragment) and [`writeFragment()`](https://www.apollographql.com/docs/react/features/caching.html#writefragment) methods in the same way to rewrite the fragments. When working with a fragment we need to compose its ID, just like explained earlier. The default mapping function called `defaultDataIdFromObject` can be imported from `apollo-cache-inmemory` and be used to specify the fragment that we would like to read/write. Accordingly, we're gonna replace all our query re-writings with fragments re-writings, as we don't need them anymore:\n+\n+{{{ diffStep 8.4 module=\"client\" }}}\n+\n+\n+----------\n+TODO: Isnâ€™t `chats.splice(0, Infinity, ...[ â€¦ ])` the same as `chats = [...]` ?\n+I see an explanation of apollo-cache but it makes you feel itâ€™s the fragment thatâ€™s being cached, which is not true, itâ€™s the object type.\n+We shouldnâ€™t use `defaultDataIdFromObject` directly from `apollo-cache-inmemory` but define it somewhere in our code and use that. It might change in the future and then we would have to do it in 500 files.\n+I would explain a lot more than it is now, about the caching. It should be based on a simpler example and show that when an entity `Foo:1` is modified, the change reflects in all component. We should describe how itâ€™s stored, as references and not real data and so on.\n+\n+TODO: Better fragments naming and convensions\n\\ No newline at end of file\ndiff --git a/.tortilla/manuals/templates/step9.tmpl b/.tortilla/manuals/templates/step9.tmpl\nnew file mode 100644\nindex 0000000..4c87613\n--- /dev/null\n+++ b/.tortilla/manuals/templates/step9.tmpl\n@@ -0,0 +1,158 @@\n+So far we've been just writing code. If there was an error we would most likely discover it during runtime. As a reminder, we've created a project which is based on TypeScript, but we haven't really took any advantage of TypeScript's type safety mechanism. Currently, the TypeScript compiler is configured to work on loose mode, so any object which is not bound to any type will be converted to `any` - a type which is compatible with any type of casting and will ignore type errors.\n+\n+So far it's been very convenient because we've only started to learn about building an app and the ecosystem around it, but for a long term project it's would be very handy to take a full advantage of TypeScript and not let it go under the radar. So where exactly are we missing type checkings? In the core of our project - when dealing with GraphQL documents.\n+\n+When we run a query, or a mutation, we wanna make sure that we use the received data correctly, based on its intended shape and form. For example, given the following GraphQL query:\n+\n+```graphql\n+query Chats {\n+  chats {\n+    id\n+    name\n+    picture\n+  }\n+}\n+```\n+\n+We want to have the following TypeScript type:\n+\n+```ts\n+export type Chat = {\n+  __typename?: \"Chat\"\n+  id: string\n+  name: string\n+  picture: string\n+}\n+\n+export type ChatQuery = {\n+  __typename?: \"Query\"\n+  chats: Chats[]\n+}\n+\n+```\n+\n+So later on we can use it with `react-apollo-hooks` like so:\n+\n+```ts\n+useQuery<ChatsQuery>(getChatsQuery)\n+```\n+\n+Everything looks nice in theory, but the main issue that arises from having type definitions is that we need to maintain and sync 2 similar code bases:\n+A GraphQL schema and TypeScript type definitions.\n+Both are essentially the same, and if so, why do we even need to maintain 2 code bases?\n+Isn't there a tool which does that for us? A question which brings us straight to the point of the chapter.\n+\n+**Introducing: GraphQL Code Generator**\n+\n+With [GraphQL Code Generator](https://graphql-code-generator.com/) we can generate TypeScript definitions given a GraphQL schema, and a set of GraphQL documents if they are presented to us.\n+\n+\n+\n+![graphql-codegen](https://user-images.githubusercontent.com/7648874/54940897-9f564380-4f66-11e9-9891-3b994a1daef1.png)\n+\n+\n+GraphQL Code Generator is a simple CLI tool that operates based on a configuration file and can generate TypeScript types for both Client and Server.\n+We will start with generating types for the server.\n+\n+In the server project, install GraphQL Code Generator via Yarn\n+\n+    $ yarn add @graphql-codegen/cli --dev\n+\n+Now GraphQL Code Generator can be used directly from the `scripts` section in the `package.json` file using the `gql-gen` binary.\n+We're gonna call the code generation script \"codegen\":\n+\n+```json\n+{\n+  \"codegen\": \"gql-gen\"\n+}\n+```\n+\n+This command will automatically be referenced to a configuration file in the root of our project called `codegen.yml`.\n+The essence of this file is to provide the code generator with the GraphQL schema, GraphQL documents, the output path of the type definition file/s and a set of plug-ins.\n+More about the configuration file can be found in the [official website](https://graphql-code-generator.com/docs/getting-started/codegen-config).\n+\n+In the server project, we will generate the `types/graphql.d.ts` file and we will use a couple of plug-ins to do that:\n+\n+\n+\n+*   `@graphql-codegen/typescript` - Will generate the core TypeScript types from our GraphQL schema.\n+*   `@graphql-codegen/typescript-resolvers` - Will generate resolvers signatures with the generated TypeScript types.\n+\n+> A full list of available plugins is available [here](https://graphql-code-generator.com/docs/plugins/). In addition, you can write your own [custom plugin](https://graphql-code-generator.com/docs/custom-codegen/write-your-plugin).\n+\n+Let's install these 2 plugins:\n+\n+    $ yarn add @graphql-codegen/typescript @graphql-codegen/typescript-resolvers --dev\n+\n+And write the `codegen.yml` file:\n+\n+{{{ diffStep 6.1 module=\"server\" files=\"codegen.yml\" }}}\n+\n+> See inline comments to learn more about our configuration setup.\n+\n+Now if you'll run `$ npm run codegen` you should see that a new file `types/graphql.d.ts` has been generated with all the necessary TypeScript types. Since these types are very likely to change as we extend our schema, there's no need to include them in our project, thus it's recommended to add the appropriate .gitignore rule:\n+\n+{{{ diffStep 6.1 module=\"server\" files=\".gitignore\" }}}\n+\n+Now we can import the `IResolvers` type from the file we've just created and use it in the `resolvers.ts` file to ensure our resolvers handlers have the right signature:\n+\n+{{{ diffStep 6.2 module=\"server\" }}}\n+\n+We will now repeat the same process in the client with few tweaks. Again, we will install GraphQL Code Generator:\n+\n+    $ yarn add @graphql-codegen/cli --dev\n+\n+And we will define a script:\n+\n+```json\n+{\n+  \"codegen\": \"gql-gen\"\n+}\n+```\n+\n+This time around, because we're in the client, we will define a set of glob paths that will specify which files contain GraphQL documents.\n+GraphQL Code Generator is smart enough to automatically recognize the documents within these files by looking at the `gql` template literal calls using the `typescript-operations` package.\n+We will be using a plugin called `typescript-react-apollo` to generate React/Apollo-GraphQL hooks that can be used in our function components.\n+Let's install the necessary plugins:\n+\n+    $ yarn add @graphql-codegen/cli @graphql-codegen/typescript @graphql-codegen/typescript-operations @graphql-codegen/typescript-react-apollo @graphql-codegen/add\n+\n+\n+And we will write the `codegen.yml` file:\n+\n+{{{ diffStep 9.1 module=\"client\" files=\"codegen.yml\" }}}\n+\n+Notice that we sent the schema as a local path.\n+We could have also provided a GraphQL endpoint that exposes a GraphQL schema.\n+This way if there's an existing running GraphQL API, we can generate TypeScript types out of it, such as GitHub's GraphQL API.\n+The advantages of providing a local path is that the server doesn't have to be running in order to generate types, which is more comfortable in development, and we can bypass authentication if the endpoint is guarded with such mechanism.\n+This will be useful in further chapters when we're introduced to the concept of authentication.\n+\n+Be sure to add a .gitignore rule because we want to run the generator every time there is a change and don't want to rely on old generated types:\n+\n+{{{ diffStep 9.1 module=\"client\" files=\".gitignore\" }}}\n+\n+Now we have TypeScript types available to us and we can replace `useQuery()` and `useMutation()` calls with the generated React hooks.\n+Let's use those and also remove all the old manual typings:\n+\n+{{{ diffStep 9.2 module=\"client\" }}}\n+\n+To test if things are working properly, we can address a non existing field in one of the retrieved query results, for example `chat.foo` in `useGetChatQuery()`.\n+We should receive the following typing error when trying to run the project:\n+\n+```\n+TypeScript error: Property 'foo' does not exist on type '{ __typename?: \"Chat\"; } & { __typename?: \"Chat\"; } & { messages: ({ __typename?: \"Message\"; } & { __typename?: \"Message\"; } & Pick<Message, \"id\" | \"createdAt\" | \"content\">)[]; } & { __typename?: \"Chat\"; } & Pick<...> & { ...; }'.  TS2339\n+\n+    44 |   const addMessage = useAddMessageMutation()\n+    45 |\n+  > 46 |   console.log(chat.foo)\n+       |                    ^\n+    47 |\n+    48 |   const onSendMessage = useCallback((content) => {\n+    49 |     addMessage({\n+```\n+\n+TODO: Mappers are not explained - The root types of Message resolvers - doesnâ€™t say much\n+we donâ€™t need to use `resolvers as IResolvers`, thereâ€™s a flag for it, in codegen\n+\n+TODO: Change `gql-gen` to `graphql-codegen`\n\\ No newline at end of file\ndiff --git a/client/.env b/client/.env\nnew file mode 100644\nindex 0000000..f0fc5d5\n--- /dev/null\n+++ b/client/.env\n@@ -0,0 +1 @@\n+REACT_APP_SERVER_URL=http://localhost:4000\n\\ No newline at end of file\ndiff --git a/client/.gitignore b/client/.gitignore\nnew file mode 100644\nindex 0000000..31561ca\n--- /dev/null\n+++ b/client/.gitignore\n@@ -0,0 +1,25 @@\n+# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.\n+\n+# dependencies\n+/node_modules\n+/.pnp\n+.pnp.js\n+\n+# testing\n+/coverage\n+\n+# production\n+/build\n+\n+# misc\n+.DS_Store\n+.env.local\n+.env.development.local\n+.env.test.local\n+.env.production.local\n+\n+npm-debug.log*\n+yarn-debug.log*\n+yarn-error.log*\n+\n+src/graphql/types.tsx\ndiff --git a/client/.npmrc b/client/.npmrc\nnew file mode 100644\nindex 0000000..cffe8cd\n--- /dev/null\n+++ b/client/.npmrc\n@@ -0,0 +1 @@\n+save-exact=true\ndiff --git a/client/codegen.yml b/client/codegen.yml\nnew file mode 100644\nindex 0000000..7faedfa\n--- /dev/null\n+++ b/client/codegen.yml\n@@ -0,0 +1,21 @@\n+schema: ../Whatsapp-Clone-Server/schema/typeDefs.graphql\n+documents:\n+  - ./src/components/**/*.tsx\n+  - ./src/graphql/fragments/**/*.ts\n+  - ./src/graphql/queries/**/*.ts\n+  - ./src/graphql/subscriptions/**/*.ts\n+overwrite: true\n+generates:\n+  ./src/graphql/types.tsx:\n+    plugins:\n+      - add: '/* eslint-disable */'\n+      - typescript\n+      - typescript-operations\n+      - typescript-react-apollo\n+    # The combined options of all provided plug-ins\n+    # More information about the options below:\n+    # graphql-code-generator.com/docs/plugins/typescript-react-apollo#configuration\n+    config:\n+      withHOC: false\n+      withHooks: true\n+      withComponent: false\ndiff --git a/client/package.json b/client/package.json\nnew file mode 100644\nindex 0000000..f1093db\n--- /dev/null\n+++ b/client/package.json\n@@ -0,0 +1,70 @@\n+{\n+  \"name\": \"whatsapp-clone-client\",\n+  \"version\": \"0.1.0\",\n+  \"private\": true,\n+  \"dependencies\": {\n+    \"@graphql-codegen/add\": \"1.2.0\",\n+    \"@graphql-codegen/cli\": \"1.2.0\",\n+    \"@graphql-codegen/typescript\": \"1.2.0\",\n+    \"@graphql-codegen/typescript-operations\": \"1.2.0\",\n+    \"@graphql-codegen/typescript-react-apollo\": \"1.2.0\",\n+    \"@material-ui/core\": \"3.9.3\",\n+    \"@material-ui/icons\": \"3.0.2\",\n+    \"@types/history\": \"4.7.2\",\n+    \"@types/jest\": \"24.0.13\",\n+    \"@types/material-ui\": \"0.21.6\",\n+    \"@types/node\": \"12.0.1\",\n+    \"@types/react\": \"16.8.17\",\n+    \"@types/react-dom\": \"16.8.4\",\n+    \"@types/react-router-dom\": \"4.3.3\",\n+    \"@types/styled-components\": \"4.1.14\",\n+    \"apollo-cache-inmemory\": \"1.5.1\",\n+    \"apollo-client\": \"2.5.1\",\n+    \"apollo-link\": \"1.2.11\",\n+    \"apollo-link-http\": \"1.5.14\",\n+    \"apollo-link-mock\": \"1.0.1\",\n+    \"graphql\": \"14.3.1\",\n+    \"apollo-link-ws\": \"1.0.17\",\n+    \"apollo-utilities\": \"1.2.1\",\n+    \"graphql-tag\": \"2.10.1\",\n+    \"history\": \"4.9.0\",\n+    \"moment\": \"2.24.0\",\n+    \"react\": \"16.8.6\",\n+    \"react-apollo\": \"2.5.6\",\n+    \"react-apollo-hooks\": \"0.4.5\",\n+    \"react-dom\": \"16.8.6\",\n+    \"react-router-dom\": \"5.0.0\",\n+    \"react-router-transition\": \"1.3.0\",\n+    \"react-scripts\": \"3.0.1\",\n+    \"styled-components\": \"4.2.0\",\n+    \"subscriptions-transport-ws\": \"0.9.16\",\n+    \"typescript\": \"3.4.5\"\n+  },\n+  \"scripts\": {\n+    \"start\": \"react-scripts start\",\n+    \"build\": \"react-scripts build\",\n+    \"test\": \"react-scripts test\",\n+    \"eject\": \"react-scripts eject\",\n+    \"codegen\": \"gql-gen\"\n+  },\n+  \"eslintConfig\": {\n+    \"extends\": \"react-app\"\n+  },\n+  \"browserslist\": {\n+    \"production\": [\n+      \">0.2%\",\n+      \"not dead\",\n+      \"not op_mini all\"\n+    ],\n+    \"development\": [\n+      \"last 1 chrome version\",\n+      \"last 1 firefox version\",\n+      \"last 1 safari version\"\n+    ]\n+  },\n+  \"devDependencies\": {\n+    \"jest-dom\": \"3.2.1\",\n+    \"jest-fetch-mock\": \"2.1.2\",\n+    \"react-testing-library\": \"7.0.0\"\n+  }\n+}\ndiff --git a/client/public/chat-background.jpg b/client/public/chat-background.jpg\nnew file mode 100644\nindex 0000000..12cf45c\nBinary files /dev/null and b/client/public/chat-background.jpg differ\ndiff --git a/client/public/favicon.ico b/client/public/favicon.ico\nnew file mode 100644\nindex 0000000..a11777c\nBinary files /dev/null and b/client/public/favicon.ico differ\ndiff --git a/client/public/index.html b/client/public/index.html\nnew file mode 100644\nindex 0000000..7f991f8\n--- /dev/null\n+++ b/client/public/index.html\n@@ -0,0 +1,38 @@\n+<!DOCTYPE html>\n+<html lang=\"en\">\n+  <head>\n+    <meta charset=\"utf-8\" />\n+    <link rel=\"shortcut icon\" href=\"%PUBLIC_URL%/favicon.ico\" />\n+    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\n+    <meta name=\"theme-color\" content=\"#000000\" />\n+    <!--\n+      manifest.json provides metadata used when your web app is installed on a\n+      user's mobile device or desktop. See https://developers.google.com/web/fundamentals/web-app-manifest/\n+    -->\n+    <link rel=\"manifest\" href=\"%PUBLIC_URL%/manifest.json\" />\n+    <!--\n+      Notice the use of %PUBLIC_URL% in the tags above.\n+      It will be replaced with the URL of the `public` folder during the build.\n+      Only files inside the `public` folder can be referenced from the HTML.\n+\n+      Unlike \"/favicon.ico\" or \"favicon.ico\", \"%PUBLIC_URL%/favicon.ico\" will\n+      work correctly both with client-side routing and a non-root public URL.\n+      Learn how to configure a non-root public URL by running `npm run build`.\n+    -->\n+    <title>WhatsApp Clone</title>\n+  </head>\n+  <body>\n+    <noscript>You need to enable JavaScript to run this app.</noscript>\n+    <div id=\"root\"></div>\n+    <!--\n+      This HTML file is a template.\n+      If you open it directly in the browser, you will see an empty page.\n+\n+      You can add webfonts, meta tags, or analytics to this file.\n+      The build step will place the bundled scripts into the <body> tag.\n+\n+      To begin the development, run `npm start` or `yarn start`.\n+      To create a production bundle, use `npm run build` or `yarn build`.\n+    -->\n+  </body>\n+</html>\ndiff --git a/client/public/manifest.json b/client/public/manifest.json\nnew file mode 100644\nindex 0000000..5696e11\n--- /dev/null\n+++ b/client/public/manifest.json\n@@ -0,0 +1,15 @@\n+{\n+  \"short_name\": \"WhatsApp Clone\",\n+  \"name\": \"An open source chat app\",\n+  \"icons\": [\n+    {\n+      \"src\": \"favicon.ico\",\n+      \"sizes\": \"64x64 32x32 24x24 16x16\",\n+      \"type\": \"image/x-icon\"\n+    }\n+  ],\n+  \"start_url\": \".\",\n+  \"display\": \"standalone\",\n+  \"theme_color\": \"#000000\",\n+  \"background_color\": \"#ffffff\"\n+}\ndiff --git a/client/public/message-mine.png b/client/public/message-mine.png\nnew file mode 100644\nindex 0000000..a5503eb\nBinary files /dev/null and b/client/public/message-mine.png differ\ndiff --git a/client/public/message-other.png b/client/public/message-other.png\nnew file mode 100644\nindex 0000000..a9477be\nBinary files /dev/null and b/client/public/message-other.png differ\ndiff --git a/client/public/whatsapp-icon.png b/client/public/whatsapp-icon.png\nnew file mode 100644\nindex 0000000..ef4c897\nBinary files /dev/null and b/client/public/whatsapp-icon.png differ\ndiff --git a/client/renovate.json b/client/renovate.json\nnew file mode 100644\nindex 0000000..a80069a\n--- /dev/null\n+++ b/client/renovate.json\n@@ -0,0 +1,23 @@\n+{\n+  \"extends\": [\"config:base\", \":rebaseStalePrs\"],\n+  \"baseBranches\": [\n+    \"master\",\n+    \"master-root\",\n+    \"master-step1\",\n+    \"master-step2\",\n+    \"master-step3\",\n+    \"master-step4\",\n+    \"master-step5\",\n+    \"master-step6\",\n+    \"master-step7\",\n+    \"master-step8\",\n+    \"master-step9\",\n+    \"master-step10\",\n+    \"master-step11\",\n+    \"master-step12\",\n+    \"master-step13\"\n+  ],\n+  \"prHourlyLimit\": 60,\n+  \"recreateClosed\": true,\n+  \"rangeStrategy\": \"lockfile-update\"\n+}\ndiff --git a/client/src/App.test.tsx b/client/src/App.test.tsx\nnew file mode 100644\nindex 0000000..c5d9cc9\n--- /dev/null\n+++ b/client/src/App.test.tsx\n@@ -0,0 +1,17 @@\n+import React from 'react';\n+import { ApolloProvider } from 'react-apollo-hooks';\n+import ReactDOM from 'react-dom';\n+import App from './App';\n+import { mockApolloClient } from './test-helpers';\n+\n+it('renders without crashing', () => {\n+  const client = mockApolloClient();\n+  const div = document.createElement('div');\n+\n+  ReactDOM.render(\n+    <ApolloProvider client={client}>\n+      <App />\n+    </ApolloProvider>\n+  , div);\n+  ReactDOM.unmountComponentAtNode(div);\n+});\ndiff --git a/client/src/App.tsx b/client/src/App.tsx\nnew file mode 100644\nindex 0000000..85131f7\n--- /dev/null\n+++ b/client/src/App.tsx\n@@ -0,0 +1,31 @@\n+import React from 'react';\n+import { BrowserRouter, Route, Redirect, RouteComponentProps } from 'react-router-dom';\n+import AuthScreen from './components/AuthScreen';\n+import ChatRoomScreen from './components/ChatRoomScreen';\n+import ChatsListScreen from './components/ChatsListScreen';\n+import ChatCreationScreen from './components/ChatCreationScreen';\n+import AnimatedSwitch from './components/AnimatedSwitch';\n+import { withAuth } from './services/auth.service';\n+\n+const App: React.FC = () => (\n+  <BrowserRouter>\n+    <AnimatedSwitch>\n+      <Route exact path=\"/sign-in\" component={AuthScreen} />\n+      <Route exact path=\"/chats\" component={withAuth(ChatsListScreen)} />\n+\n+      <Route exact path=\"/chats/:chatId\" component={withAuth(\n+        ({ match, history }: RouteComponentProps<{ chatId: string }>) =>\n+        (<ChatRoomScreen chatId={match.params.chatId} history={history} />)\n+      )} />\n+\n+      <Route exact path=\"/new-chat\" component={withAuth(ChatCreationScreen)} />\n+    </AnimatedSwitch>\n+    <Route exact path=\"/\" render={redirectToChats} />\n+  </BrowserRouter>\n+);\n+\n+const redirectToChats = () => (\n+  <Redirect to=\"/chats\" />\n+);\n+\n+export default App;\n\\ No newline at end of file\ndiff --git a/client/src/client.ts b/client/src/client.ts\nnew file mode 100644\nindex 0000000..8f5217f\n--- /dev/null\n+++ b/client/src/client.ts\n@@ -0,0 +1,43 @@\n+import { InMemoryCache } from 'apollo-cache-inmemory';\n+import { ApolloClient } from 'apollo-client';\n+import { getMainDefinition } from 'apollo-utilities';\n+import { HttpLink } from 'apollo-link-http';\n+import { WebSocketLink } from 'apollo-link-ws';\n+import { ApolloLink, split } from 'apollo-link';\n+\n+const httpUri = process.env.REACT_APP_SERVER_URL + '/graphql';\n+const wsUri = httpUri.replace(/^https?/, 'ws');\n+\n+const httpLink = new HttpLink({\n+  uri: httpUri,\n+  credentials: 'include',\n+});\n+\n+const wsLink = new WebSocketLink({\n+  uri: wsUri,\n+  options: {\n+    // Automatic reconnect in case of connection error\n+    reconnect: true,\n+  },\n+});\n+\n+const terminatingLink = split(\n+  ({ query }) => {\n+    const { kind, operation } = getMainDefinition(query);\n+    // If this is a subscription query, use wsLink, otherwise use httpLink\n+    return (\n+      kind === 'OperationDefinition' && operation === 'subscription'\n+    );\n+  },\n+  wsLink,\n+  httpLink,\n+);\n+\n+const link = ApolloLink.from([terminatingLink]);\n+\n+const inMemoryCache = new InMemoryCache();\n+\n+export default new ApolloClient({\n+  link,\n+  cache: inMemoryCache,\n+});\ndiff --git a/client/src/components/AnimatedSwitch.tsx b/client/src/components/AnimatedSwitch.tsx\nnew file mode 100644\nindex 0000000..c1f1cbc\n--- /dev/null\n+++ b/client/src/components/AnimatedSwitch.tsx\n@@ -0,0 +1,37 @@\n+import { Switch } from 'react-router-dom';\n+import { AnimatedSwitch, spring } from 'react-router-transition';\n+import styled from 'styled-components';\n+\n+// A workaround to make test pass\n+const SwitchComponent = process.env.NODE_ENV === 'test' ? Switch : AnimatedSwitch;\n+\n+const glide = (val: number) =>\n+  spring(val, {\n+    stiffness: 174,\n+    damping: 24,\n+  });\n+\n+const mapStyles = (styles :any) => ({\n+  transform: `translateX(${styles.offset}%)`,\n+});\n+\n+const MyAnimatedSwitch =  styled(SwitchComponent).attrs(() => ({\n+  atEnter: { offset: 100 },\n+  atLeave: { offset: glide(-100) },\n+  atActive: { offset: glide(0) },\n+  mapStyles,\n+}))`\n+  position: relative;\n+  overflow: hidden;\n+  height: 100vh;\n+  width: 100vw;\n+\n+  > div {\n+    position: absolute;\n+    overflow: hidden;\n+    height: 100vh;\n+    width: 100vw;\n+  }\n+`\n+\n+export default MyAnimatedSwitch;\ndiff --git a/client/src/components/AuthScreen/SignInForm.test.tsx b/client/src/components/AuthScreen/SignInForm.test.tsx\nnew file mode 100644\nindex 0000000..da27593\n--- /dev/null\n+++ b/client/src/components/AuthScreen/SignInForm.test.tsx\n@@ -0,0 +1,81 @@\n+import { createMemoryHistory } from 'history';\n+import React from 'react';\n+import { cleanup, render, fireEvent, wait, waitForElement } from 'react-testing-library';\n+import SignInForm from './SignInForm';\n+\n+describe('SignInForm', () => {\n+  afterEach(cleanup);\n+  afterEach(() => fetch.resetMocks());\n+\n+  it('enables sign-in button when filled in', async () => {\n+    const history = createMemoryHistory();\n+\n+    {\n+      const { container, getByTestId } = render(<SignInForm history={history} />);\n+      const usernameInput = getByTestId('username-input').querySelector('input');\n+      const passwordInput = getByTestId('password-input').querySelector('input');\n+      const signInButton = getByTestId('sign-in-button') as HTMLButtonElement;\n+\n+      expect(signInButton.disabled).toEqual(true);\n+\n+      fireEvent.change(usernameInput, { target: { value: 'username' } });\n+      fireEvent.change(passwordInput, { target: { value: 'password' } });\n+\n+      await waitForElement(() => usernameInput);\n+      await waitForElement(() => passwordInput);\n+\n+      expect(signInButton.disabled).toEqual(false);\n+    }\n+  });\n+\n+  it('prints server error if input was wrong', async () => {\n+    const history = createMemoryHistory();\n+\n+    fetchMock.mockRejectOnce(new Error('sign-in failed'));\n+\n+    {\n+      const { container, getByTestId } = render(<SignInForm history={history} />);\n+      const usernameInput = getByTestId('username-input').querySelector('input');\n+      const passwordInput = getByTestId('password-input').querySelector('input');\n+      const signInButton = getByTestId('sign-in-button') as HTMLButtonElement;\n+      const errorMessage = getByTestId('error-message');\n+\n+      fireEvent.change(usernameInput, { target: { value: 'username' } });\n+      fireEvent.change(passwordInput, { target: { value: 'password' } });\n+\n+      await waitForElement(() => usernameInput);\n+      await waitForElement(() => passwordInput);\n+\n+      fireEvent.click(signInButton);\n+\n+      await waitForElement(() => errorMessage);\n+\n+      expect(errorMessage.innerHTML).toEqual('sign-in failed');\n+    }\n+  });\n+\n+  it('navigates to /chats if everything went right', async () => {\n+    const history = createMemoryHistory();\n+\n+    fetchMock.mockResponseOnce('success');\n+\n+    {\n+      const { container, getByTestId } = render(<SignInForm history={history} />);\n+      const usernameInput = getByTestId('username-input').querySelector('input');\n+      const passwordInput = getByTestId('password-input').querySelector('input');\n+      const signInButton = getByTestId('sign-in-button') as HTMLButtonElement;\n+\n+      fireEvent.change(usernameInput, { target: { value: 'username' } });\n+      fireEvent.change(passwordInput, { target: { value: 'password' } });\n+\n+      await waitForElement(() => usernameInput);\n+      await waitForElement(() => passwordInput);\n+\n+      fireEvent.click(signInButton);\n+\n+      await wait(() =>\n+        expect(history.location.pathname).toEqual('/chats')\n+      );\n+    }\n+  });\n+});\ndiff --git a/client/src/components/AuthScreen/SignInForm.tsx b/client/src/components/AuthScreen/SignInForm.tsx\nnew file mode 100644\nindex 0000000..fa21d64\n--- /dev/null\n+++ b/client/src/components/AuthScreen/SignInForm.tsx\n@@ -0,0 +1,83 @@\n+import React from 'react';\n+import { useCallback, useState } from 'react';\n+import { signIn } from '../../services/auth.service';\n+import {\n+  SignForm,\n+  ActualForm,\n+  Legend,\n+  Section,\n+  TextField,\n+  Button,\n+  ErrorMessage,\n+} from './form-components';\n+import { RouteComponentProps } from 'react-router-dom';\n+\n+const SignInForm: React.FC<RouteComponentProps<any>> = ({ history }) => {\n+  const [username, setUsername] = useState('');\n+  const [password, setPassword] = useState('');\n+  const [error, setError] = useState('');\n+\n+  const onUsernameChange = useCallback(({ target }) => {\n+    setError('');\n+    setUsername(target.value);\n+  }, []);\n+\n+  const onPasswordChange = useCallback(({ target }) => {\n+    setError('');\n+    setPassword(target.value);\n+  }, []);\n+\n+  const maySignIn = useCallback(() => {\n+    return !!(username && password);\n+  }, [username, password]);\n+\n+  const handleSignIn = useCallback(() => {\n+    signIn({ username, password })\n+      .then(() => {\n+        history.replace('/chats')\n+      })\n+      .catch(error => {\n+        setError(error.message || error)\n+      });\n+  }, [username, password, history]);\n+\n+  return (\n+    <SignForm>\n+      <ActualForm>\n+        <Legend>Sign in</Legend>\n+        <Section style={{ width: '100%' }}>\n+          <TextField\n+            data-testid=\"username-input\"\n+            label=\"Username\"\n+            value={username}\n+            onChange={onUsernameChange}\n+            margin=\"normal\"\n+            placeholder=\"Enter your username\"\n+          />\n+          <TextField\n+            data-testid=\"password-input\"\n+            label=\"Password\"\n+            type=\"password\"\n+            value={password}\n+            onChange={onPasswordChange}\n+            margin=\"normal\"\n+            placeholder=\"Enter your password\"\n+          />\n+        </Section>\n+        <Button\n+          data-testid=\"sign-in-button\"\n+          type=\"button\"\n+          color=\"secondary\"\n+          variant=\"contained\"\n+          disabled={!maySignIn()}\n+          onClick={handleSignIn}\n+        >\n+          Sign in\n+        </Button>\n+        <ErrorMessage data-testid=\"error-message\">{error}</ErrorMessage>\n+      </ActualForm>\n+    </SignForm>\n+  );\n+};\n+\n+export default SignInForm;\ndiff --git a/client/src/components/AuthScreen/SignUpForm.test.tsx b/client/src/components/AuthScreen/SignUpForm.test.tsx\nnew file mode 100644\nindex 0000000..669e45d\n--- /dev/null\n+++ b/client/src/components/AuthScreen/SignUpForm.test.tsx\n@@ -0,0 +1,99 @@\n+import { createMemoryHistory } from 'history';\n+import React from 'react';\n+import { cleanup, render, fireEvent, wait, waitForElement } from 'react-testing-library';\n+import SignUpForm from './SignUpForm';\n+\n+describe('SignUpForm', () => {\n+  afterEach(cleanup);\n+  afterEach(() => fetch.resetMocks());\n+\n+  it('enables sign-up button when filled in', async () => {\n+    const history = createMemoryHistory();\n+\n+    {\n+      const { container, getByTestId } = render(<SignUpForm history={history} />);\n+      const nameInput = getByTestId('name-input').querySelector('input');\n+      const usernameInput = getByTestId('username-input').querySelector('input');\n+      const passwordInput = getByTestId('password-input').querySelector('input');\n+      const passwordConfirmInput = getByTestId('password-confirm-input').querySelector('input');\n+      const signUpButton = getByTestId('sign-up-button') as HTMLButtonElement;\n+\n+      expect(signUpButton.disabled).toEqual(true);\n+\n+      fireEvent.change(nameInput, { target: { value: 'User Name' } });\n+      fireEvent.change(usernameInput, { target: { value: 'username' } });\n+      fireEvent.change(passwordInput, { target: { value: 'password' } });\n+      fireEvent.change(passwordConfirmInput, { target: { value: 'password' } });\n+\n+      await waitForElement(() => nameInput);\n+      await waitForElement(() => usernameInput);\n+      await waitForElement(() => passwordInput);\n+      await waitForElement(() => passwordConfirmInput);\n+\n+      expect(signUpButton.disabled).toEqual(false);\n+    }\n+  });\n+\n+  it('prints server error if input was wrong', async () => {\n+    const history = createMemoryHistory();\n+\n+    fetchMock.mockRejectOnce(new Error('sign-up failed'));\n+\n+    {\n+      const { container, getByTestId } = render(<SignUpForm history={history} />);\n+      const nameInput = getByTestId('name-input').querySelector('input');\n+      const usernameInput = getByTestId('username-input').querySelector('input');\n+      const passwordInput = getByTestId('password-input').querySelector('input');\n+      const passwordConfirmInput = getByTestId('password-confirm-input').querySelector('input');\n+      const signUpButton = getByTestId('sign-up-button') as HTMLButtonElement;\n+      const errorMessage = getByTestId('error-message');\n+\n+      fireEvent.change(nameInput, { target: { value: 'User Name' } });\n+      fireEvent.change(usernameInput, { target: { value: 'username' } });\n+      fireEvent.change(passwordInput, { target: { value: 'password' } });\n+      fireEvent.change(passwordConfirmInput, { target: { value: 'password' } });\n+\n+      await waitForElement(() => nameInput);\n+      await waitForElement(() => usernameInput);\n+      await waitForElement(() => passwordInput);\n+      await waitForElement(() => passwordConfirmInput);\n+\n+      fireEvent.click(signUpButton);\n+\n+      await waitForElement(() => errorMessage);\n+\n+      expect(errorMessage.innerHTML).toEqual('sign-up failed');\n+    }\n+  });\n+\n+  it('navigates to /sign-in if everything went right', async () => {\n+    const history = createMemoryHistory();\n+\n+    fetchMock.mockResponseOnce('success');\n+\n+    {\n+      const { container, getByTestId } = render(<SignUpForm history={history} />);\n+      const nameInput = getByTestId('name-input').querySelector('input');\n+      const usernameInput = getByTestId('username-input').querySelector('input');\n+      const passwordInput = getByTestId('password-input').querySelector('input');\n+      const passwordConfirmInput = getByTestId('password-confirm-input').querySelector('input');\n+      const signUpButton = getByTestId('sign-up-button') as HTMLButtonElement;\n+\n+      fireEvent.change(nameInput, { target: { value: 'User Name' } });\n+      fireEvent.change(usernameInput, { target: { value: 'username' } });\n+      fireEvent.change(passwordInput, { target: { value: 'password' } });\n+      fireEvent.change(passwordConfirmInput, { target: { value: 'password' } });\n+\n+      await waitForElement(() => nameInput);\n+      await waitForElement(() => usernameInput);\n+      await waitForElement(() => passwordInput);\n+      await waitForElement(() => passwordConfirmInput);\n+\n+      fireEvent.click(signUpButton);\n+\n+      await wait(() =>\n+        expect(history.location.pathname).toEqual('/sign-in')\n+      );\n+    }\n+  });\n+});\ndiff --git a/client/src/components/AuthScreen/SignUpForm.tsx b/client/src/components/AuthScreen/SignUpForm.tsx\nnew file mode 100644\nindex 0000000..b7fcd69\n--- /dev/null\n+++ b/client/src/components/AuthScreen/SignUpForm.tsx\n@@ -0,0 +1,126 @@\n+import React from 'react';\n+import { useCallback, useState } from 'react';\n+import { signUp } from '../../services/auth.service';\n+import {\n+  SignForm,\n+  ActualForm,\n+  Legend,\n+  Section,\n+  TextField,\n+  Button,\n+  ErrorMessage,\n+} from './form-components';\n+import { RouteComponentProps } from 'react-router-dom';\n+\n+const SignUpForm: React.FC<RouteComponentProps<any>> = ({ history }) => {\n+  const [name, setName] = useState('');\n+  const [username, setUsername] = useState('');\n+  const [password, setPassword] = useState('');\n+  const [passwordConfirm, setPasswordConfirm] = useState('');\n+  const [error, setError] = useState('');\n+\n+  const updateName = useCallback(({ target }) => {\n+    setError('');\n+    setName(target.value);\n+  }, []);\n+\n+  const updateUsername = useCallback(({ target }) => {\n+    setError('');\n+    setUsername(target.value);\n+  }, []);\n+\n+  const updatePassword = useCallback(({ target }) => {\n+    setError('');\n+    setPassword(target.value);\n+  }, []);\n+\n+  const updatePasswordConfirm = useCallback(({ target }) => {\n+    setError('');\n+    setPasswordConfirm(target.value);\n+  }, []);\n+\n+  const maySignUp = useCallback(() => {\n+    return !!(name && username && password && password === passwordConfirm);\n+  }, [name, username, password, passwordConfirm]);\n+\n+  const handleSignUp = useCallback(() => {\n+    signUp({ username, password, passwordConfirm, name })\n+      .then(() => {\n+        history.replace('/sign-in')\n+      })\n+      .catch(error => {\n+        setError(error.message || error)\n+      });\n+  }, [name, username, password, passwordConfirm, history]);\n+\n+  return (\n+    <SignForm>\n+      <ActualForm>\n+        <Legend>Sign up</Legend>\n+        <Section\n+          style={{\n+            float: 'left',\n+            width: 'calc(50% - 10px)',\n+            paddingRight: '10px',\n+          }}\n+        >\n+          <TextField\n+            data-testid=\"name-input\"\n+            label=\"Name\"\n+            value={name}\n+            onChange={updateName}\n+            autoComplete=\"off\"\n+            margin=\"normal\"\n+          />\n+          <TextField\n+            data-testid=\"username-input\"\n+            label=\"Username\"\n+            value={username}\n+            onChange={updateUsername}\n+            autoComplete=\"off\"\n+            margin=\"normal\"\n+          />\n+        </Section>\n+        <Section\n+          style={{\n+            float: 'right',\n+            width: 'calc(50% - 10px)',\n+            paddingLeft: '10px',\n+          }}\n+        >\n+          <TextField\n+            data-testid=\"password-input\"\n+            label=\"Password\"\n+            type=\"password\"\n+            value={password}\n+            onChange={updatePassword}\n+            autoComplete=\"off\"\n+            margin=\"normal\"\n+          />\n+          <TextField\n+            data-testid=\"password-confirm-input\"\n+            label=\"Confirm password\"\n+            type=\"password\"\n+            value={passwordConfirm}\n+            onChange={updatePasswordConfirm}\n+            autoComplete=\"off\"\n+            margin=\"normal\"\n+          />\n+        </Section>\n+        <Button\n+          data-testid=\"sign-up-button\"\n+          type=\"button\"\n+          color=\"secondary\"\n+          variant=\"contained\"\n+          disabled={!maySignUp()}\n+          onClick={handleSignUp}\n+        >\n+          Sign up\n+        </Button>\n+        <ErrorMessage data-testid=\"error-message\">{error}</ErrorMessage>\n+      </ActualForm>\n+    </SignForm>\n+  );\n+};\n+\n+export default SignUpForm;\n\\ No newline at end of file\ndiff --git a/client/src/components/AuthScreen/form-components.ts b/client/src/components/AuthScreen/form-components.ts\nnew file mode 100644\nindex 0000000..00c8c9d\n--- /dev/null\n+++ b/client/src/components/AuthScreen/form-components.ts\n@@ -0,0 +1,75 @@\n+import MaterialButton from '@material-ui/core/Button';\n+import MaterialTextField from '@material-ui/core/TextField';\n+import styled from 'styled-components';\n+\n+export const SignForm = styled.div `\n+  height: calc(100% - 265px);\n+`;\n+\n+export const ActualForm = styled.form `\n+  padding: 20px;\n+`;\n+\n+export const Section = styled.div `\n+  padding-bottom: 35px;\n+`;\n+\n+export const Legend = styled.legend `\n+  font-weight: bold;\n+  color: white;\n+`;\n+\n+export const Label = styled.label `\n+  color: white !important;\n+`;\n+\n+export const Input = styled.input `\n+  color: white;\n+\n+  &::placeholder {\n+    color: var(--primary-bg);\n+  }\n+`;\n+\n+export const TextField = styled(MaterialTextField) `\n+  width: 100%;\n+  position: relative;\n+\n+  > div::before {\n+    border-color: white !important;\n+  }\n+\n+  input {\n+    color: white !important;\n+\n+    &::placeholder {\n+      color: var(--primary-bg) !important;\n+    }\n+  }\n+\n+  label {\n+    color: white !important;\n+  }\n+` as typeof MaterialTextField;\n+\n+export const Button = styled(MaterialButton) `\n+  width: 100px;\n+  display: block !important;\n+  margin: auto !important;\n+  background-color: var(--secondary-bg) !important;\n+\n+  &[disabled] {\n+    color: #38a81c;\n+  }\n+\n+  &:not([disabled]) {\n+    color: white;\n+  }\n+` as typeof MaterialButton;\n+\n+export const ErrorMessage = styled.div `\n+  position: fixed;\n+  color: red;\n+  font-size: 15px;\n+  margin-top: 20px;\n+`;\ndiff --git a/client/src/components/AuthScreen/index.tsx b/client/src/components/AuthScreen/index.tsx\nnew file mode 100644\nindex 0000000..c6cdfe0\n--- /dev/null\n+++ b/client/src/components/AuthScreen/index.tsx\n@@ -0,0 +1,89 @@\n+import React from 'react';\n+import { useMemo } from 'react';\n+import { Route } from 'react-router-dom';\n+import styled from 'styled-components';\n+import AnimatedSwitch from '../AnimatedSwitch';\n+import SignInForm from './SignInForm';\n+import SignUpForm from './SignUpForm';\n+import { RouteComponentProps } from 'react-router-dom';\n+\n+const Container = styled.div `\n+  background: radial-gradient(rgb(34, 65, 67), rgb(17, 48, 50)),\n+    url(/assets/chat-background.jpg) no-repeat;\n+  background-size: cover;\n+  background-blend-mode: multiply;\n+  color: white;\n+`;\n+\n+const Intro = styled.div `\n+  height: 265px;\n+`;\n+\n+const Icon = styled.img `\n+  width: 125px;\n+  height: auto;\n+  margin-left: auto;\n+  margin-right: auto;\n+  padding-top: 70px;\n+  display: block;\n+`;\n+\n+const Title = styled.h2 `\n+  width: 100%;\n+  text-align: center;\n+  color: white;\n+`;\n+\n+// eslint-disable-next-line\n+const Alternative = styled.div `\n+  position: fixed;\n+  bottom: 10px;\n+  left: 10px;\n+\n+  label {\n+    color: var(--secondary-bg);\n+  }\n+`;\n+\n+const AuthScreen: React.FC<RouteComponentProps<any>> = ({ history, location }) => {\n+  const alternative = useMemo(() => {\n+    if (location.pathname === '/sign-in') {\n+      const handleSignUp = () => {\n+        history.replace('/sign-up');\n+      };\n+\n+      return (\n+        <Alternative>\n+          Don't have an account yet? <label onClick={handleSignUp}>Sign up!</label>\n+        </Alternative>\n+      );\n+    }\n+    else {\n+      const handleSignIn = () => {\n+        history.replace('/sign-in');\n+      };\n+\n+      return (\n+        <Alternative>\n+          Already have an accout? <label onClick={handleSignIn}>Sign in!</label>\n+        </Alternative>\n+      );\n+    }\n+  }, [location.pathname, history]);\n+\n+  return (\n+    <Container className=\"AuthScreen Screen\">\n+      <Intro className=\"AuthScreen-intro\">\n+        <Icon src=\"assets/whatsapp-icon.png\" className=\"AuthScreen-icon\" />\n+        <Title className=\"AuthScreen-title\">WhatsApp</Title>\n+      </Intro>\n+      <AnimatedSwitch>\n+        <Route exact path=\"/sign-in\" component={SignInForm} />\n+        <Route exact path=\"/sign-up\" component={SignUpForm} />\n+      </AnimatedSwitch>\n+      {alternative}\n+    </Container>\n+  );\n+};\n+\n+export default AuthScreen;\n\\ No newline at end of file\ndiff --git a/client/src/components/ChatCreationScreen/ChatCreationNavbar.test.tsx b/client/src/components/ChatCreationScreen/ChatCreationNavbar.test.tsx\nnew file mode 100644\nindex 0000000..0454ed0\n--- /dev/null\n+++ b/client/src/components/ChatCreationScreen/ChatCreationNavbar.test.tsx\n@@ -0,0 +1,28 @@\n+import { createMemoryHistory } from 'history';\n+import React from 'react';\n+import { cleanup, render, fireEvent, wait } from 'react-testing-library';\n+import ChatCreationNavbar from './ChatCreationNavbar';\n+\n+describe('ChatCreationNavbar', () => {\n+  afterEach(cleanup);\n+\n+  it('goes back on arrow click', async () => {\n+    const history = createMemoryHistory();\n+\n+    history.push('/new-chat');\n+\n+    await wait(() =>\n+      expect(history.location.pathname).toEqual('/new-chat')\n+    );\n+\n+    {\n+      const { container, getByTestId } = render(<ChatCreationNavbar history={history} />);\n+\n+      fireEvent.click(getByTestId('back-button'));\n+\n+      await wait(() =>\n+        expect(history.location.pathname).toEqual('/chats')\n+      );\n+    }\n+  });\n+});\ndiff --git a/client/src/components/ChatCreationScreen/ChatCreationNavbar.tsx b/client/src/components/ChatCreationScreen/ChatCreationNavbar.tsx\nnew file mode 100644\nindex 0000000..c537475\n--- /dev/null\n+++ b/client/src/components/ChatCreationScreen/ChatCreationNavbar.tsx\n@@ -0,0 +1,46 @@\n+import ArrowBackIcon from '@material-ui/icons/ArrowBack';\n+import { Toolbar, Button } from '@material-ui/core';\n+import React from 'react';\n+import { useCallback } from 'react';\n+import styled from 'styled-components';\n+import { History } from 'history';\n+\n+const Container = styled(Toolbar) `\n+  display: flex;\n+  background-color: var(--primary-bg);\n+  color: var(--primary-text);\n+  font-size: 20px;\n+  line-height: 40px;\n+` as typeof Toolbar;\n+\n+const BackButton = styled(Button) `\n+  svg {\n+    color: var(--primary-text);\n+  }\n+` as typeof Button;\n+\n+const Title = styled.div `\n+  flex: 1;\n+`;\n+\n+interface ChildComponentProps {\n+  history: History;\n+};\n+\n+const ChatCreationNavbar: React.FC<ChildComponentProps> = ({ history }) => {\n+  const navBack = useCallback(() => {\n+    history.replace('/chats');\n+  }, [history]);\n+\n+  return (\n+    <Container>\n+      <BackButton data-testid=\"back-button\" onClick={navBack}>\n+        <ArrowBackIcon />\n+      </BackButton>\n+      <Title>Create Chat</Title>\n+    </Container>\n+  );\n+};\n+\n+\n+export default ChatCreationNavbar;\ndiff --git a/client/src/components/ChatCreationScreen/index.tsx b/client/src/components/ChatCreationScreen/index.tsx\nnew file mode 100644\nindex 0000000..70f8a5a\n--- /dev/null\n+++ b/client/src/components/ChatCreationScreen/index.tsx\n@@ -0,0 +1,73 @@\n+import gql from 'graphql-tag';\n+import React from 'react';\n+import { useCallback } from 'react';\n+import styled from 'styled-components';\n+import * as fragments from '../../graphql/fragments';\n+import UsersList from '../UsersList';\n+import ChatCreationNavbar from './ChatCreationNavbar';\n+import { History } from 'history';\n+import { useAddChatMutation } from '../../graphql/types';\n+import { writeChat } from '../../services/cache.service';\n+\n+// eslint-disable-next-line\n+const Container = styled.div `\n+  height: calc(100% - 56px);\n+  overflow-y: overlay;\n+`;\n+\n+// eslint-disable-next-line\n+const StyledUsersList = styled(UsersList) `\n+  height: calc(100% - 56px);\n+`;\n+\n+gql`\n+  mutation AddChat($recipientId: ID!) {\n+    addChat(recipientId: $recipientId) {\n+      ...Chat\n+    }\n+  }\n+  ${fragments.chat}\n+`;\n+\n+interface ChildComponentProps {\n+  history: History;\n+};\n+\n+const ChatCreationScreen: React.FC<ChildComponentProps> = ({ history }) => {\n+  const addChat = useAddChatMutation({\n+    update: (client, { data: { addChat } }) => {\n+      writeChat(client, addChat);\n+    }\n+  });\n+\n+  const onUserPick = useCallback((user) => {\n+    addChat({\n+      optimisticResponse: {\n+        __typename: 'Mutation',\n+        addChat: {\n+          __typename: 'Chat',\n+          id: Math.random().toString(36).substr(2, 9),\n+          name: user.name,\n+          picture: user.picture,\n+          lastMessage: null,\n+        },\n+      },\n+      variables: {\n+        recipientId: user.id,\n+      },\n+    }).then(({ data }) => {\n+      if (data !== null) {\n+        history.push(`/chats/${data.addChat.id}`);\n+      }\n+    })\n+  }, [addChat, history]);\n+\n+  return (\n+    <div>\n+      <ChatCreationNavbar history={history} />\n+      <UsersList onUserPick={onUserPick} />\n+    </div>\n+  );\n+};\n+\n+export default ChatCreationScreen;\ndiff --git a/client/src/components/ChatRoomScreen/ChatNavbar.test.tsx b/client/src/components/ChatRoomScreen/ChatNavbar.test.tsx\nnew file mode 100644\nindex 0000000..9c61f69\n--- /dev/null\n+++ b/client/src/components/ChatRoomScreen/ChatNavbar.test.tsx\n@@ -0,0 +1,108 @@\n+import { createMemoryHistory } from 'history';\n+import React from 'react';\n+import { ApolloProvider } from 'react-apollo-hooks';\n+import { cleanup, render, fireEvent, wait } from 'react-testing-library';\n+import { mockApolloClient } from '../../test-helpers';\n+import ChatNavbar from './ChatNavbar';\n+import { RemoveChatDocument } from '../../graphql/types';\n+\n+describe('ChatNavbar', () => {\n+  afterEach(cleanup);\n+\n+  it('renders chat data', () => {\n+    const client = mockApolloClient();\n+\n+    const chat = {\n+      id: '1',\n+      name: 'Foo Bar',\n+      picture: 'https://localhost:4000/picture.jpg',\n+    };\n+\n+    {\n+      const { container, getByTestId } = render(\n+        <ApolloProvider client={client}>\n+          <ChatNavbar chat={chat} />\n+        </ApolloProvider>\n+      );\n+\n+      expect(getByTestId('chat-name')).toHaveTextContent('Foo Bar');\n+      expect(getByTestId('chat-picture')).toHaveAttribute('src', 'https://localhost:4000/picture.jpg');\n+    }\n+  })\n+\n+  it('goes back on arrow click', async () => {\n+    const client = mockApolloClient();\n+\n+    const chat = {\n+      id: '1',\n+      name: 'Foo Bar',\n+      picture: 'https://localhost:4000/picture.jpg',\n+    };\n+\n+    const history = createMemoryHistory();\n+\n+    history.push('/chats/1');\n+\n+    await wait(() =>\n+      expect(history.location.pathname).toEqual('/chats/1')\n+    )\n+\n+    {\n+      const { container, getByTestId } = render(\n+        <ApolloProvider client={client}>\n+          <ChatNavbar chat={chat} history={history} />\n+        </ApolloProvider>\n+      );\n+\n+      fireEvent.click(getByTestId('back-button'));\n+\n+      await wait(() =>\n+        expect(history.location.pathname).toEqual('/chats')\n+      );\n+    }\n+  });\n+\n+  it('goes back on chat removal', async () => {\n+    const client = mockApolloClient([\n+      {\n+        request: {\n+          query: RemoveChatDocument,\n+          variables: { chatId: '1' },\n+        },\n+        result: {\n+          data: {\n+            removeChat: '1'\n+          }\n+        }\n+      },\n+    ]);\n+\n+    const chat = {\n+      id: '1',\n+      name: 'Foo Bar',\n+      picture: 'https://localhost:4000/picture.jpg',\n+    };\n+\n+    const history = createMemoryHistory();\n+\n+    history.push('/chats/1');\n+\n+    await wait(() =>\n+      expect(history.location.pathname).toEqual('/chats/1')\n+    );\n+\n+    {\n+      const { container, getByTestId } = render(\n+        <ApolloProvider client={client}>\n+          <ChatNavbar chat={chat} history={history} />\n+        </ApolloProvider>\n+      );\n+\n+      fireEvent.click(getByTestId('delete-button'));\n+\n+      await wait(() =>\n+        expect(history.location.pathname).toEqual('/chats')\n+      );\n+    }\n+  })\n+});\n\\ No newline at end of file\ndiff --git a/client/src/components/ChatRoomScreen/ChatNavbar.tsx b/client/src/components/ChatRoomScreen/ChatNavbar.tsx\nnew file mode 100644\nindex 0000000..92f06ab\n--- /dev/null\n+++ b/client/src/components/ChatRoomScreen/ChatNavbar.tsx\n@@ -0,0 +1,106 @@\n+import Button from '@material-ui/core/Button';\n+import Toolbar from '@material-ui/core/Toolbar';\n+import ArrowBackIcon from '@material-ui/icons/ArrowBack';\n+import DeleteIcon from '@material-ui/icons/Delete';\n+import gql from 'graphql-tag';\n+import React from 'react';\n+import { useCallback } from 'react';\n+import styled from 'styled-components';\n+import { History } from 'history';\n+import { useRemoveChatMutation } from '../../graphql/types';\n+import { eraseChat } from '../../services/cache.service';\n+\n+const Container = styled(Toolbar) `\n+  padding: 0;\n+  display: flex;\n+  flex-direction: row;\n+  background-color: var(--primary-bg);\n+  color: var(--primary-text);\n+` as typeof Toolbar;\n+\n+const BackButton = styled(Button) `\n+  svg {\n+    color: var(--primary-text);\n+  }\n+` as typeof Button;\n+\n+const Rest = styled.div `\n+  flex: 1;\n+  display: flex;\n+  justify-content: flex-end;\n+`\n+\n+const Picture = styled.img `\n+  height: 40px;\n+  width: 40px;\n+  margin-top: 3px;\n+  margin-left: -22px;\n+  object-fit: cover;\n+  padding: 5px;\n+  border-radius: 50%;\n+`;\n+\n+const Name = styled.div `\n+  line-height: 56px;\n+`;\n+\n+const DeleteButton = styled(Button)`\n+  color: var(--primary-text) !important;\n+` as typeof Button;\n+\n+export const removeChatMutation = gql`\n+  mutation RemoveChat($chatId: ID!) {\n+    removeChat(chatId: $chatId)\n+  }\n+`;\n+\n+interface ChatNavbarProps {\n+  history: History;\n+  chat: {\n+    picture?: string | null;\n+    name?: string | null;\n+    id: string;\n+  };\n+};\n+\n+const ChatNavbar: React.FC<ChatNavbarProps> = ({ chat, history }) => {\n+  const removeChat = useRemoveChatMutation({\n+    variables: {\n+      chatId: chat.id\n+    },\n+    update: (client, { data: { removeChat } }) => {\n+      eraseChat(client, removeChat);\n+    }\n+  });\n+\n+  const handleRemoveChat = useCallback(() => {\n+    removeChat().then(() => {\n+      history.replace('/chats')\n+    });\n+  }, [removeChat, history]);\n+\n+  const navBack = useCallback(() => {\n+    history.replace('/chats');\n+  }, [history]);\n+\n+  return (\n+    <Container>\n+      <BackButton data-testid=\"back-button\" onClick={navBack}>\n+        <ArrowBackIcon />\n+      </BackButton>\n+      {chat && chat.picture && chat.name && (\n+        <React.Fragment>\n+          <Picture data-testid=\"chat-picture\" src={chat.picture} />\n+          <Name data-testid=\"chat-name\">{chat.name}</Name>\n+        </React.Fragment>\n+      )}\n+      <Rest>\n+        <DeleteButton data-testid=\"delete-button\" onClick={handleRemoveChat}>\n+          <DeleteIcon />\n+        </DeleteButton>\n+      </Rest>\n+    </Container>\n+  );\n+};\n+\n+export default ChatNavbar;\n\\ No newline at end of file\ndiff --git a/client/src/components/ChatRoomScreen/MessageInput.test.tsx b/client/src/components/ChatRoomScreen/MessageInput.test.tsx\nnew file mode 100644\nindex 0000000..973de60\n--- /dev/null\n+++ b/client/src/components/ChatRoomScreen/MessageInput.test.tsx\n@@ -0,0 +1,47 @@\n+import { createMemoryHistory } from 'history';\n+import React from 'react';\n+import { cleanup, render, fireEvent, wait, waitForElement } from 'react-testing-library';\n+import MessageInput from './MessageInput';\n+\n+describe('MessageInput;', () => {\n+  afterEach(cleanup);\n+\n+  it('triggers callback on send button click', async () => {\n+    const onSendMessage = jest.fn(() => {});\n+\n+    {\n+      const { container, getByTestId } = render(<MessageInput onSendMessage={onSendMessage} />);\n+      const messageInput = getByTestId('message-input');\n+      const sendButton = getByTestId('send-button');\n+\n+      fireEvent.change(messageInput, { target: { value: 'foo' } });\n+\n+      await waitForElement(() => messageInput);\n+\n+      fireEvent.click(sendButton);\n+\n+      await wait(() =>\n+        expect(onSendMessage.mock.calls.length).toBe(1)\n+      );\n+    }\n+  });\n+\n+  it('triggers callback on Enter press', async () => {\n+    const onSendMessage = jest.fn(() => {});\n+\n+    {\n+      const { container, getByTestId } = render(<MessageInput onSendMessage={onSendMessage} />);\n+      const messageInput = getByTestId('message-input');\n+\n+      fireEvent.change(messageInput, { target: { value: 'foo' } });\n+\n+      await waitForElement(() => messageInput);\n+\n+      fireEvent.keyPress(messageInput, { key: 'Enter', code: 13, charCode: 13 });\n+\n+      await wait(() =>\n+        expect(onSendMessage.mock.calls.length).toBe(1)\n+      );\n+    }\n+  });\n+});\n\\ No newline at end of file\ndiff --git a/client/src/components/ChatRoomScreen/MessageInput.tsx b/client/src/components/ChatRoomScreen/MessageInput.tsx\nnew file mode 100644\nindex 0000000..266cfbd\n--- /dev/null\n+++ b/client/src/components/ChatRoomScreen/MessageInput.tsx\n@@ -0,0 +1,92 @@\n+import Button from '@material-ui/core/Button';\n+import SendIcon from '@material-ui/icons/Send';\n+import React from 'react';\n+import styled from 'styled-components';\n+import { useState } from 'react';\n+\n+const Container = styled.div`\n+  display: flex;\n+  height: 50px;\n+  padding: 5px;\n+  width: calc(100% - 10px);\n+`;\n+\n+const ActualInput = styled.input `\n+  width: calc(100% - 50px);\n+  border: none;\n+  border-radius: 999px;\n+  padding: 10px;\n+  padding-left: 20px;\n+  padding-right: 20px;\n+  font-size: 15px;\n+  outline: none;\n+  box-shadow: 0 1px silver;\n+  font-size: 18px;\n+  line-height: 45px;\n+`;\n+\n+const SendButton = styled(Button) `\n+  min-width: 50px !important;\n+  width: 50px !important;\n+  border-radius: 999px !important;\n+  background-color: var(--primary-bg) !important;\n+  margin: 0 5px !important;\n+  margin-right: 0 !important;\n+  color: white !important;\n+  padding-left: 20px !important;\n+\n+  svg {\n+    margin-left: -3px;\n+  }\n+` as typeof Button;\n+\n+interface MessageInputProps {\n+  onSendMessage(content: string): any;\n+}\n+\n+const MessageInput: React.FC<MessageInputProps> = ({ onSendMessage }) => {\n+  const [message, setMessage] = useState(\"\");\n+\n+  const onKeyPress = (e: any) => {\n+    if (e.charCode === 13) {\n+      submitMessage();\n+    }\n+  };\n+\n+  const onChange = ({ target }: any) => {\n+    setMessage(target.value);\n+  };\n+\n+  const submitMessage = () => {\n+    if (!message) return;\n+\n+    setMessage(\"\");\n+\n+    if (typeof onSendMessage === \"function\") {\n+      onSendMessage(message);\n+    }\n+  };\n+\n+  return (\n+    <Container>\n+      <ActualInput\n+        data-testid=\"message-input\"\n+        type=\"text\"\n+        placeholder=\"Type a message\"\n+        value={message}\n+        onKeyPress={onKeyPress}\n+        onChange={onChange}\n+      />\n+      <SendButton\n+        data-testid=\"send-button\"\n+        variant=\"contained\"\n+        color=\"primary\"\n+        onClick={submitMessage}\n+      >\n+        <SendIcon />\n+      </SendButton>\n+    </Container>\n+  );\n+};\n+\n+export default MessageInput;\n\\ No newline at end of file\ndiff --git a/client/src/components/ChatRoomScreen/MessagesList.test.tsx b/client/src/components/ChatRoomScreen/MessagesList.test.tsx\nnew file mode 100644\nindex 0000000..57aa03d\n--- /dev/null\n+++ b/client/src/components/ChatRoomScreen/MessagesList.test.tsx\n@@ -0,0 +1,37 @@\n+import { createMemoryHistory } from 'history';\n+import React from 'react';\n+import { cleanup, render, fireEvent, wait, getByTestId } from 'react-testing-library';\n+import MessagesList from './MessagesList';\n+\n+describe('MessagesList', () => {\n+  afterEach(cleanup);\n+\n+  it('renders messages data', () => {\n+    const messages = [\n+      {\n+        id: '1',\n+        content: 'foo',\n+        createdAt: new Date('14 Jun 2017 00:00:00 PDT').toUTCString(),\n+      },\n+      {\n+        id: '2',\n+        content: 'bar',\n+        createdAt: new Date('17 Jun 2017 00:01:00 PDT').toUTCString(),\n+      },\n+    ];\n+\n+    let message1, message2;\n+    {\n+      const { container, getAllByTestId, getByTestId } = render(<MessagesList messages={messages} />);\n+      const match = getAllByTestId('message-item');\n+      message1 = match[0];\n+      message2 = match[1];\n+    }\n+\n+    expect(getByTestId(message1, 'message-content')).toHaveTextContent('foo');\n+    expect(getByTestId(message1, 'message-date')).toHaveTextContent('10:00');\n+\n+    expect(getByTestId(message2, 'message-content')).toHaveTextContent('bar');\n+    expect(getByTestId(message2, 'message-date')).toHaveTextContent('10:01');\n+  });\n+});\n\\ No newline at end of file\ndiff --git a/client/src/components/ChatRoomScreen/MessagesList.tsx b/client/src/components/ChatRoomScreen/MessagesList.tsx\nnew file mode 100644\nindex 0000000..5a6d418\n--- /dev/null\n+++ b/client/src/components/ChatRoomScreen/MessagesList.tsx\n@@ -0,0 +1,116 @@\n+import moment from 'moment';\n+import React from 'react';\n+import { useEffect, useRef } from 'react';\n+import ReactDOM from 'react-dom';\n+import styled, { css } from 'styled-components';\n+\n+const Container = styled.div`\n+  display: block;\n+  flex: 2;\n+  overflow-y: overlay;\n+  padding: 0 15px;\n+`;\n+\n+type StyledProp = {\n+  isMine: any;\n+};\n+\n+const MessageItem = styled.div `\n+  display: inline-block;\n+  position: relative;\n+  max-width: 100%;\n+  border-radius: 7px;\n+  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.15);\n+  margin-top: 10px;\n+  margin-bottom: 10px;\n+  clear: both;\n+\n+  &::after {\n+    content: '';\n+    display: table;\n+    clear: both;\n+  }\n+\n+  &::before {\n+    content: '';\n+    position: absolute;\n+    bottom: 3px;\n+    width: 12px;\n+    height: 19px;\n+    background-position: 50% 50%;\n+    background-repeat: no-repeat;\n+    background-size: contain;\n+  }\n+\n+  ${(props: StyledProp) => props.isMine ? css `\n+    float: right;\n+    background-color: #dcf8c6;\n+\n+    &::before {\n+      right: -11px;\n+      background-image: url(/assets/message-mine.png);\n+    }\n+  ` : css `\n+    float: left;\n+    background-color: #fff;\n+\n+    &::before {\n+      left: -11px;\n+      background-image: url(/assets/message-other.png);\n+    }\n+  `}\n+`;\n+\n+const Contents = styled.div `\n+  padding: 5px 7px;\n+  word-wrap: break-word;\n+\n+  &::after {\n+    content: ' \\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0';\n+    display: inline;\n+  }\n+`;\n+\n+const Timestamp = styled.div `\n+  position: absolute;\n+  bottom: 2px;\n+  right: 7px;\n+  color: gray;\n+  font-size: 12px;\n+`;\n+\n+interface Message {\n+  id: string | null;\n+  content: string | null;\n+  createdAt: string | null;\n+}\n+interface MessagesListProps {\n+  messages: Array<Message>;\n+}\n+\n+const MessagesList: React.FC<MessagesListProps> = ({ messages }) => {\n+  const selfRef = useRef(null);\n+\n+  useEffect(() => {\n+    if (!selfRef.current) return;\n+    const selfDOMNode = ReactDOM.findDOMNode(selfRef.current) as HTMLElement;\n+    selfDOMNode.scrollTop = Number.MAX_SAFE_INTEGER;\n+  }, [messages.length]);\n+\n+  return (\n+    <Container ref={selfRef}>\n+      {messages.map((message: any) => (\n+        <MessageItem\n+          data-testid=\"message-item\"\n+          isMine={message.isMine}\n+          key={message.id}\n+        >\n+          <Contents data-testid=\"message-content\">{message.content}</Contents>\n+          <Timestamp data-testid=\"message-date\">{moment(message.createdAt).format('HH:mm')}</Timestamp>\n+        </MessageItem>\n+      ))}\n+    </Container>\n+  );\n+};\n+\n+export default MessagesList;\n\\ No newline at end of file\ndiff --git a/client/src/components/ChatRoomScreen/index.tsx b/client/src/components/ChatRoomScreen/index.tsx\nnew file mode 100644\nindex 0000000..f109d67\n--- /dev/null\n+++ b/client/src/components/ChatRoomScreen/index.tsx\n@@ -0,0 +1,108 @@\n+import gql from 'graphql-tag';\n+import React from 'react';\n+import { useCallback } from 'react';\n+import { Redirect } from 'react-router-dom';\n+import styled from 'styled-components';\n+import ChatNavbar from './ChatNavbar';\n+import MessageInput from './MessageInput';\n+import MessagesList from './MessagesList';\n+import { History } from 'history';\n+import { useGetChatQuery, useAddMessageMutation } from '../../graphql/types';\n+import * as fragments from '../../graphql/fragments';\n+import { writeMessage } from '../../services/cache.service';\n+\n+ const Container = styled.div `\n+  background: url(/assets/chat-background.jpg);\n+  display: flex;\n+  flex-flow: column;\n+  height: 100vh;\n+`;\n+\n+// eslint-disable-next-line\n+const getChatQuery = gql `\n+  query GetChat($chatId: ID!) {\n+    chat(chatId: $chatId) {\n+      ...FullChat\n+    }\n+  }\n+  ${fragments.fullChat}\n+`;\n+\n+// eslint-disable-next-line\n+const addMessageMutation = gql `\n+  mutation AddMessage($chatId: ID!, $content: String!) {\n+    addMessage(chatId: $chatId, content: $content) {\n+      ...Message\n+    }\n+  }\n+  ${fragments.message}\n+`;\n+\n+interface ChatRoomScreenParams {\n+  chatId: string\n+  history: History;\n+};\n+\n+const ChatRoomScreen: React.FC<ChatRoomScreenParams> = ({ history, chatId }) => {\n+  const { data, loading } = useGetChatQuery({\n+    variables: { chatId }\n+  });\n+\n+  const addMessage = useAddMessageMutation();\n+\n+  const onSendMessage = useCallback((content: string) => {\n+\n+    if (data === undefined) { return null; }\n+    const chat = data.chat;\n+    if (chat === null) return null;\n+\n+    addMessage({\n+      variables: { chatId, content },\n+      optimisticResponse: {\n+        __typename: 'Mutation',\n+        addMessage: {\n+          __typename: 'Message',\n+          id: Math.random().toString(36).substr(2, 9),\n+          createdAt: new Date(),\n+          isMine: true,\n+          chat: {\n+            __typename: 'Chat',\n+            id: chatId,\n+          },\n+          content,\n+        }\n+      },\n+      update: (client, { data: { addMessage } }) => {\n+        writeMessage(client, addMessage);\n+      },\n+    })\n+  }, [data, chatId, addMessage]);\n+\n+  if (data === undefined) {\n+    return null;\n+  }\n+  const chat = data.chat;\n+  const loadingChat = loading;\n+\n+  if (loadingChat) return null;\n+  if (chat === null) return null;\n+\n+  // Chat was probably removed from cache by the subscription handler\n+  if (!chat) {\n+    return (\n+      <Redirect to=\"/chats\" />\n+    );\n+  }\n+\n+  return (\n+    <Container>\n+      <ChatNavbar chat={chat} history={history} />\n+      {chat.messages && (\n+        <MessagesList messages={chat.messages} />\n+      )}\n+      <MessageInput onSendMessage={onSendMessage}/>\n+    </Container>\n+  );\n+};\n+\n+export default ChatRoomScreen;\n\\ No newline at end of file\ndiff --git a/client/src/components/ChatsListScreen/AddChatButton.test.tsx b/client/src/components/ChatsListScreen/AddChatButton.test.tsx\nnew file mode 100644\nindex 0000000..8a21aff\n--- /dev/null\n+++ b/client/src/components/ChatsListScreen/AddChatButton.test.tsx\n@@ -0,0 +1,22 @@\n+import { createMemoryHistory } from 'history';\n+import React from 'react';\n+import { cleanup, render, fireEvent, wait } from 'react-testing-library';\n+import AddChatButton from './AddChatButton';\n+\n+describe('AddChatButton', () => {\n+  afterEach(cleanup);\n+\n+  it('goes back on arrow click', async () => {\n+    const history = createMemoryHistory();\n+\n+    {\n+      const { container, getByTestId } = render(<AddChatButton history={history} />);\n+\n+      fireEvent.click(getByTestId('new-chat-button'));\n+\n+      await wait(() =>\n+        expect(history.location.pathname).toEqual('/new-chat')\n+      );\n+    }\n+  });\n+});\ndiff --git a/client/src/components/ChatsListScreen/AddChatButton.tsx b/client/src/components/ChatsListScreen/AddChatButton.tsx\nnew file mode 100644\nindex 0000000..d14fc44\n--- /dev/null\n+++ b/client/src/components/ChatsListScreen/AddChatButton.tsx\n@@ -0,0 +1,44 @@\n+import Button from '@material-ui/core/Button';\n+import ChatIcon from '@material-ui/icons/Chat';\n+import React from 'react';\n+import styled from 'styled-components';\n+import { History } from 'history';\n+\n+const Container = styled.div `\n+  position: fixed;\n+  right: 10px;\n+  bottom: 10px;\n+\n+  button {\n+    min-width: 50px;\n+    width: 50px;\n+    height: 50px;\n+    border-radius: 999px;\n+    background-color: var(--secondary-bg);\n+    color: white;\n+  }\n+`;\n+interface ChildComponentProps {\n+  history: History;\n+};\n+\n+const AddChatButton: React.FC<ChildComponentProps> = ({ history }) => {\n+  const onClick = () => {\n+    history.push('/new-chat')\n+  };\n+\n+  return (\n+    <Container>\n+      <Button\n+        data-testid=\"new-chat-button\"\n+        variant=\"contained\"\n+        color=\"secondary\"\n+        onClick={onClick}\n+      >\n+        <ChatIcon />\n+      </Button>\n+    </Container>\n+  );\n+};\n+\n+export default AddChatButton;\n\\ No newline at end of file\ndiff --git a/client/src/components/ChatsListScreen/ChatsList.test.tsx b/client/src/components/ChatsListScreen/ChatsList.test.tsx\nnew file mode 100644\nindex 0000000..33447b8\n--- /dev/null\n+++ b/client/src/components/ChatsListScreen/ChatsList.test.tsx\n@@ -0,0 +1,128 @@\n+import React from 'react';\n+import { ApolloProvider } from 'react-apollo-hooks';\n+import ReactDOM from 'react-dom';\n+import { cleanup, render, fireEvent, wait, waitForDomChange } from 'react-testing-library';\n+import { createBrowserHistory } from 'history';\n+import { mockApolloClient } from '../../test-helpers';\n+import ChatsList, { getChatsQuery } from './ChatsList';\n+import * as queries from '../../graphql/queries';\n+\n+describe('ChatsList', () => {\n+  afterEach(() => {\n+    cleanup();\n+    window.location.pathname = '/';\n+  });\n+\n+  it('renders fetched chats data', async () => {\n+    const client = mockApolloClient([\n+      {\n+        request: { query: queries.chats },\n+        result: {\n+          data: {\n+            chats: [\n+              {\n+                __typename: 'Chat',\n+                id: 1,\n+                name: 'Foo Bar',\n+                picture: 'https://localhost:4000/picture.jpg',\n+                lastMessage: {\n+                  __typename: 'Message',\n+                  id: 1,\n+                  content: 'Hello',\n+                  createdAt: new Date('14 Jun 2017 00:00:00 PDT').toUTCString(),\n+                  isMine: true,\n+                  chat: {\n+                    __typename: 'Chat',\n+                    id: 1,\n+                  },\n+                },\n+              },\n+            ],\n+          },\n+        },\n+      },\n+    ]);\n+\n+    {\n+      const { container, getByTestId } = render(\n+        <ApolloProvider client={client}>\n+          <ChatsList />\n+        </ApolloProvider>\n+      );\n+\n+      await waitForDomChange({ container });\n+\n+      expect(getByTestId('name')).toHaveTextContent('Foo Bar');\n+      expect(getByTestId('picture')).toHaveAttribute('src', 'https://localhost:4000/picture.jpg');\n+      expect(getByTestId('content')).toHaveTextContent('Hello');\n+      expect(getByTestId('date')).toHaveTextContent('10:00');\n+    }\n+  });\n+\n+  it('should navigate to the target chat room on chat item click', async () => {\n+    const client = mockApolloClient([\n+      {\n+        request: { query: queries.chats },\n+        result: {\n+          data: {\n+            chats: [\n+              {\n+                __typename: 'Chat',\n+                id: 1,\n+                name: 'Foo Bar',\n+                picture: 'https://localhost:4000/picture.jpg',\n+                lastMessage: {\n+                  __typename: 'Message',\n+                  id: 1,\n+                  content: 'Hello',\n+                  createdAt: new Date(0),\n+                  isMine: true,\n+                  chat: {\n+                    __typename: 'Chat',\n+                    id: 1,\n+                  },\n+                },\n+              },\n+            ],\n+          },\n+        },\n+      },\n+    ]);\n+\n+     const history = createBrowserHistory();\n+\n+    {\n+      const { container, getByTestId } = render(\n+        <ApolloProvider client={client}>\n+          <ChatsList history={history} />\n+        </ApolloProvider>\n+      );\n+\n+       await waitForDomChange({ container });\n+\n+       fireEvent.click(getByTestId('chat'));\n+\n+       await wait(() =>\n+        expect(history.location.pathname).toEqual('/chats/1')\n+      );\n+    }\n+  });\n+});\n+\n+// IMPORTANT\n+// Below is a temporary hack to suppress warnings generated by a React bug.\n+// Source: https://github.com/testing-library/react-testing-library/issues/281\n+// @todo: remove this when React 16.9.0 is stable and we upgrade.\n+const originalError = console.error;\n+beforeAll(() => {\n+  console.error = (...args: string[]) => {\n+    if (/Warning.*not wrapped in act/.test(args[0])) {\n+      return;\n+    }\n+    originalError.call(console, ...args);\n+  };\n+});\n+\n+afterAll(() => {\n+  console.error = originalError;\n+});\ndiff --git a/client/src/components/ChatsListScreen/ChatsList.tsx b/client/src/components/ChatsListScreen/ChatsList.tsx\nnew file mode 100644\nindex 0000000..c5fd34a\n--- /dev/null\n+++ b/client/src/components/ChatsListScreen/ChatsList.tsx\n@@ -0,0 +1,101 @@\n+import React from 'react';\n+import moment from 'moment';\n+import { List, ListItem } from '@material-ui/core';\n+import styled from 'styled-components';\n+import { useCallback } from 'react';\n+import { History } from 'history';\n+import { useChatsQuery } from '../../graphql/types';\n+\n+const Container = styled.div `\n+  height: calc(100% - 56px);\n+  overflow-y: overlay;\n+`;\n+\n+const StyledList = styled(List) `\n+  padding: 0 !important;\n+` as typeof List;\n+\n+const StyledListItem = styled(ListItem) `\n+  height: 76px;\n+  padding: 0 15px;\n+  display: flex;\n+` as typeof ListItem;\n+\n+const ChatPicture = styled.img `\n+  height: 50px;\n+  width: 50px;\n+  object-fit: cover;\n+  border-radius: 50%;\n+`;\n+\n+const ChatInfo = styled.div `\n+  width: calc(100% - 60px);\n+  height: 46px;\n+  padding: 15px 0;\n+  margin-left: 10px;\n+  border-bottom: 0.5px solid silver;\n+  position: relative;\n+`;\n+\n+const ChatName = styled.div `\n+  margin-top: 5px;\n+`;\n+\n+const MessageContent = styled.div `\n+  color: gray;\n+  font-size: 15px;\n+  margin-top: 5px;\n+  text-overflow: ellipsis;\n+  overflow: hidden;\n+  white-space: nowrap;\n+`;\n+\n+const MessageDate = styled.div `\n+  position: absolute;\n+  color: gray;\n+  top: 20px;\n+  right: 0;\n+  font-size: 13px;\n+`;\n+\n+interface ChatsListProps {\n+  history : History;\n+};\n+\n+const ChatsList: React.FC<ChatsListProps> = ({ history }) => {\n+\n+  const navToChat = useCallback((chat) => {\n+    history.push(`chats/${chat.id}`)\n+  }, [history]);\n+\n+  const { data } = useChatsQuery();\n+\n+  if (data === undefined || data.chats === undefined) {\n+    return null;\n+  }\n+\n+  let chats = data.chats;\n+\n+  return (\n+    <Container>\n+      <StyledList>\n+        {chats.map((chat: any) => (\n+          <StyledListItem key={chat.id} data-testid=\"chat\" button onClick={navToChat.bind(null, chat)}>\n+            <ChatPicture data-testid=\"picture\" src={chat.picture} alt=\"Profile\"/>\n+            <ChatInfo>\n+              <ChatName data-testid=\"name\">{chat.name}</ChatName>\n+              {chat.lastMessage && (\n+                <React.Fragment>\n+                  <MessageContent data-testid=\"content\">{chat.lastMessage.content}</MessageContent>\n+                  <MessageDate data-testid=\"date\">{moment(chat.lastMessage.createdAt).format('HH:mm')}</MessageDate>\n+                </React.Fragment>\n+              )}\n+            </ChatInfo>\n+          </StyledListItem>\n+        ))}\n+      </StyledList>\n+    </Container>\n+  )\n+};\n+\n+export default ChatsList;\n\\ No newline at end of file\ndiff --git a/client/src/components/ChatsListScreen/ChatsNavbar.tsx b/client/src/components/ChatsListScreen/ChatsNavbar.tsx\nnew file mode 100644\nindex 0000000..9ef163a\n--- /dev/null\n+++ b/client/src/components/ChatsListScreen/ChatsNavbar.tsx\n@@ -0,0 +1,46 @@\n+import React from 'react';\n+import { Button, Toolbar } from '@material-ui/core';\n+import styled from 'styled-components';\n+import SignOutIcon from '@material-ui/icons/PowerSettingsNew';\n+import { useCallback } from 'react';\n+import { signOut } from '../../services/auth.service';\n+import { History } from 'history';\n+\n+const Container = styled(Toolbar) `\n+  display: flex;\n+  background-color: var(--primary-bg);\n+  color: var(--primary-text);\n+  font-size: 20px;\n+  line-height: 40px;\n+` as typeof Toolbar;\n+\n+const Title = styled.div `\n+  flex: 1;\n+`;\n+\n+const LogoutButton = styled(Button) `\n+  color: var(--primary-text) !important;\n+` as typeof Button;\n+\n+interface ChildComponentProps {\n+  history: History;\n+};\n+\n+const ChatsNavbar: React.FC<ChildComponentProps> = ({ history }) => {\n+  const handleSignOut = useCallback(() => {\n+    signOut().then(() => {\n+      history.replace('/sign-in')\n+    });\n+  }, [history]);\n+\n+  return (\n+    <Container>\n+      <Title>Whatsapp Clone</Title>\n+      <LogoutButton data-testid=\"sign-out-button\" onClick={handleSignOut}>\n+        <SignOutIcon />\n+      </LogoutButton>\n+    </Container>\n+  );\n+};\n+\n+export default ChatsNavbar;\n\\ No newline at end of file\ndiff --git a/client/src/components/ChatsListScreen/index.tsx b/client/src/components/ChatsListScreen/index.tsx\nnew file mode 100644\nindex 0000000..4451ea2\n--- /dev/null\n+++ b/client/src/components/ChatsListScreen/index.tsx\n@@ -0,0 +1,24 @@\n+import React from 'react';\n+import ChatsNavbar from './ChatsNavbar';\n+import ChatsList from './ChatsList';\n+import styled from 'styled-components';\n+import { History } from 'history';\n+import AddChatButton from './AddChatButton';\n+\n+const Container = styled.div `\n+  height: 100vh;\n+`;\n+\n+interface ChatsListScreenProps {\n+  history : History;\n+};\n+\n+const ChatsListScreen: React.FC<ChatsListScreenProps> = ({ history }) => (\n+  <Container>\n+    <ChatsNavbar history={history} />\n+    <ChatsList history={history} />\n+    <AddChatButton history={history} />\n+  </Container>\n+);\n+\n+export default ChatsListScreen;\n\\ No newline at end of file\ndiff --git a/client/src/components/UsersList.test.tsx b/client/src/components/UsersList.test.tsx\nnew file mode 100644\nindex 0000000..5af11e0\n--- /dev/null\n+++ b/client/src/components/UsersList.test.tsx\n@@ -0,0 +1,84 @@\n+import React from 'react';\n+import { ApolloProvider } from 'react-apollo-hooks';\n+import { cleanup, render, fireEvent, wait, waitForDomChange } from 'react-testing-library';\n+import { mockApolloClient } from '../test-helpers';\n+import UsersList, { UsersListQuery } from './UsersList';\n+import * as queries from '../graphql/queries';\n+\n+describe('UsersList', () => {\n+  afterEach(cleanup);\n+\n+  it('renders fetched users data', async () => {\n+    const client = mockApolloClient([\n+      {\n+        request: { query: UsersListQuery },\n+        result: {\n+          data: {\n+            users: [\n+              {\n+                __typename: 'User',\n+                id: 1,\n+                name: 'Charles Dickhead',\n+                picture: 'https://localhost:4000/dick.jpg',\n+              },\n+            ],\n+          },\n+        },\n+      },\n+    ]);\n+\n+    {\n+      const { container, getByTestId } = render(\n+        <ApolloProvider client={client}>\n+          <UsersList />\n+        </ApolloProvider>\n+      );\n+\n+      await waitForDomChange({ container });\n+\n+      expect(getByTestId('name')).toHaveTextContent('Charles Dickhead');\n+      expect(getByTestId('picture')).toHaveAttribute('src', 'https://localhost:4000/dick.jpg');\n+    }\n+  })\n+\n+  it('triggers onUserPick() callback on user-item click', async () => {\n+    const client = mockApolloClient([\n+      {\n+        request: { query: UsersListQuery },\n+        result: {\n+          data: {\n+            users: [\n+              {\n+                __typename: 'User',\n+                id: 1,\n+                name: 'Charles Dickhead',\n+                picture: 'https://localhost:4000/dick.jpg',\n+              },\n+            ],\n+          },\n+        },\n+      },\n+    ]);\n+\n+    const onUserPick = jest.fn(() => {});\n+\n+    {\n+      const { container, getByTestId } = render(\n+        <ApolloProvider client={client}>\n+          <UsersList onUserPick={onUserPick} />\n+        </ApolloProvider>\n+      );\n+\n+      await waitForDomChange({ container });\n+\n+      fireEvent.click(getByTestId('user'));\n+\n+      await wait(() =>\n+        expect(onUserPick.mock.calls.length).toBe(1)\n+      );\n+\n+      expect(onUserPick.mock.calls[0][0].name).toEqual('Charles Dickhead');\n+      expect(onUserPick.mock.calls[0][0].picture).toEqual('https://localhost:4000/dick.jpg');\n+    }\n+  });\n+});\ndiff --git a/client/src/components/UsersList.tsx b/client/src/components/UsersList.tsx\nnew file mode 100644\nindex 0000000..0fbf394\n--- /dev/null\n+++ b/client/src/components/UsersList.tsx\n@@ -0,0 +1,72 @@\n+import MaterialList from '@material-ui/core/List';\n+import MaterialItem from '@material-ui/core/ListItem';\n+import gql from 'graphql-tag';\n+import React from 'react';\n+import styled from 'styled-components';\n+import * as fragments from '../graphql/fragments';\n+import { useUsersListQuery, User } from '../graphql/types';\n+\n+const ActualList = styled(MaterialList) `\n+  padding: 0;\n+` as typeof MaterialList;\n+\n+const UserItem = styled(MaterialItem) `\n+  position: relative;\n+  padding: 7.5px 15px;\n+  display: flex;\n+  cursor: pinter;\n+` as typeof MaterialItem;\n+\n+const ProfilePicture = styled.img `\n+  height: 50px;\n+  width: 50px;\n+  object-fit: cover;\n+  border-radius: 50%;\n+`;\n+\n+const Name = styled.div `\n+  padding-left: 15px;\n+  font-weight: bold;\n+`;\n+\n+export const UsersListQuery = gql`\n+  query UsersList {\n+    users {\n+      ...User\n+    }\n+  }\n+  ${fragments.user}\n+`;\n+\n+interface ChildComponentProps {\n+  onUserPick: any;\n+};\n+\n+const UsersList: React.FC<ChildComponentProps> = ({ onUserPick = (user: User) => {} }) => {\n+  const { data, loading: loadingUsers } = useUsersListQuery();\n+\n+  if (data === undefined) return null;\n+  const users = data.users;\n+\n+  return (\n+    <ActualList>\n+      {!loadingUsers && users.map(user => (\n+        <UserItem\n+          key={user.id}\n+          data-testid=\"user\"\n+          onClick={onUserPick.bind(null, user)}\n+          button\n+        >\n+          {(user !== null && user.picture !== null) &&\n+            <React.Fragment>\n+              <ProfilePicture data-testid=\"picture\" src={user.picture} />\n+              <Name data-testid=\"name\">{user.name}</Name>\n+            </React.Fragment>\n+          }\n+        </UserItem>\n+      ))}\n+    </ActualList>\n+  );\n+};\n+\n+export default UsersList;\ndiff --git a/client/src/graphql/fragments/chat.fragment.ts b/client/src/graphql/fragments/chat.fragment.ts\nnew file mode 100644\nindex 0000000..9ef2c89\n--- /dev/null\n+++ b/client/src/graphql/fragments/chat.fragment.ts\n@@ -0,0 +1,14 @@\n+import gql from 'graphql-tag';\n+import message from './message.fragment';\n+\n+export default gql`\n+  fragment Chat on Chat {\n+    id\n+    name\n+    picture\n+    lastMessage {\n+      ...Message\n+    }\n+  }\n+  ${message}\n+`;\ndiff --git a/client/src/graphql/fragments/fullChat.fragment.ts b/client/src/graphql/fragments/fullChat.fragment.ts\nnew file mode 100644\nindex 0000000..26998e4\n--- /dev/null\n+++ b/client/src/graphql/fragments/fullChat.fragment.ts\n@@ -0,0 +1,14 @@\n+import gql from 'graphql-tag';\n+import chat from './chat.fragment';\n+import message from './message.fragment';\n+\n+export default gql`\n+  fragment FullChat on Chat {\n+    ...Chat\n+    messages {\n+      ...Message\n+    }\n+  }\n+  ${chat}\n+  ${message}\n+`;\ndiff --git a/client/src/graphql/fragments/index.ts b/client/src/graphql/fragments/index.ts\nnew file mode 100644\nindex 0000000..83a5d91\n--- /dev/null\n+++ b/client/src/graphql/fragments/index.ts\n@@ -0,0 +1,4 @@\n+export { default as chat } from './chat.fragment';\n+export { default as fullChat } from './fullChat.fragment';\n+export { default as message } from './message.fragment';\n+export { default as user } from './user.fragment';\ndiff --git a/client/src/graphql/fragments/message.fragment.ts b/client/src/graphql/fragments/message.fragment.ts\nnew file mode 100644\nindex 0000000..8fdf90f\n--- /dev/null\n+++ b/client/src/graphql/fragments/message.fragment.ts\n@@ -0,0 +1,13 @@\n+import gql from 'graphql-tag';\n+\n+export default gql`\n+  fragment Message on Message {\n+    id\n+    createdAt\n+    content\n+    isMine\n+    chat {\n+      id\n+    }\n+  }\n+`;\ndiff --git a/client/src/graphql/fragments/user.fragment.ts b/client/src/graphql/fragments/user.fragment.ts\nnew file mode 100644\nindex 0000000..7fb70c7\n--- /dev/null\n+++ b/client/src/graphql/fragments/user.fragment.ts\n@@ -0,0 +1,9 @@\n+import gql from 'graphql-tag';\n+\n+export default gql`\n+  fragment User on User {\n+    id\n+    name\n+    picture\n+  }\n+`;\ndiff --git a/client/src/graphql/queries/chats.query.ts b/client/src/graphql/queries/chats.query.ts\nnew file mode 100644\nindex 0000000..332d28a\n--- /dev/null\n+++ b/client/src/graphql/queries/chats.query.ts\n@@ -0,0 +1,11 @@\n+import gql from 'graphql-tag';\n+import * as fragments from '../fragments';\n+\n+export default gql`\n+  query Chats {\n+    chats {\n+      ...Chat\n+    }\n+  }\n+  ${fragments.chat}\n+`;\ndiff --git a/client/src/graphql/queries/index.ts b/client/src/graphql/queries/index.ts\nnew file mode 100644\nindex 0000000..a27d3d3\n--- /dev/null\n+++ b/client/src/graphql/queries/index.ts\n@@ -0,0 +1 @@\n+export { default as chats } from './chats.query';\ndiff --git a/client/src/graphql/queries/me.query.ts b/client/src/graphql/queries/me.query.ts\nnew file mode 100644\nindex 0000000..3ca7870\n--- /dev/null\n+++ b/client/src/graphql/queries/me.query.ts\n@@ -0,0 +1,11 @@\n+import gql from 'graphql-tag';\n+import * as fragments from '../fragments';\n+\n+export default gql`\n+  query Me {\n+    me {\n+      ...User\n+    }\n+  }\n+  ${fragments.user}\n+`;\ndiff --git a/client/src/graphql/subscriptions/chatAdded.subscription.ts b/client/src/graphql/subscriptions/chatAdded.subscription.ts\nnew file mode 100644\nindex 0000000..625420c\n--- /dev/null\n+++ b/client/src/graphql/subscriptions/chatAdded.subscription.ts\n@@ -0,0 +1,11 @@\n+import gql from 'graphql-tag';\n+import * as fragments from '../fragments';\n+\n+export default gql`\n+  subscription ChatAdded {\n+    chatAdded {\n+      ...Chat\n+    }\n+  }\n+  ${fragments.chat}\n+`;\ndiff --git a/client/src/graphql/subscriptions/chatRemoved.subscription.ts b/client/src/graphql/subscriptions/chatRemoved.subscription.ts\nnew file mode 100644\nindex 0000000..cfc6fcc\n--- /dev/null\n+++ b/client/src/graphql/subscriptions/chatRemoved.subscription.ts\n@@ -0,0 +1,7 @@\n+import gql from 'graphql-tag';\n+\n+export default gql`\n+  subscription ChatRemoved {\n+    chatRemoved\n+  }\n+`;\ndiff --git a/client/src/graphql/subscriptions/index.ts b/client/src/graphql/subscriptions/index.ts\nnew file mode 100644\nindex 0000000..0616a47\n--- /dev/null\n+++ b/client/src/graphql/subscriptions/index.ts\n@@ -0,0 +1,3 @@\n+export { default as messageAdded } from './messageAdded.subscription';\n+export { default as chatAdded } from './chatAdded.subscription';\n+export { default as chatRemoved } from './chatRemoved.subscription';\ndiff --git a/client/src/graphql/subscriptions/messageAdded.subscription.ts b/client/src/graphql/subscriptions/messageAdded.subscription.ts\nnew file mode 100644\nindex 0000000..382c755\n--- /dev/null\n+++ b/client/src/graphql/subscriptions/messageAdded.subscription.ts\n@@ -0,0 +1,11 @@\n+import gql from 'graphql-tag';\n+import * as fragments from '../fragments';\n+\n+export default gql `\n+  subscription MessageAdded {\n+    messageAdded {\n+      ...Message\n+    }\n+  }\n+  ${fragments.message}\n+`;\ndiff --git a/client/src/index.css b/client/src/index.css\nnew file mode 100644\nindex 0000000..75eaaee\n--- /dev/null\n+++ b/client/src/index.css\n@@ -0,0 +1,21 @@\n+:root {\n+  --primary-bg: #2c6157;\n+  --secondary-bg: #6fd056;\n+  --primary-text: white;\n+  --secondary-text: white;\n+}\n+\n+body {\n+  margin: 0;\n+  padding: 0;\n+  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',\n+    'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',\n+    sans-serif;\n+  -webkit-font-smoothing: antialiased;\n+  -moz-osx-font-smoothing: grayscale;\n+}\n+\n+code {\n+  font-family: source-code-pro, Menlo, Monaco, Consolas, 'Courier New',\n+    monospace;\n+}\ndiff --git a/client/src/index.tsx b/client/src/index.tsx\nnew file mode 100644\nindex 0000000..e953ef2\n--- /dev/null\n+++ b/client/src/index.tsx\n@@ -0,0 +1,31 @@\n+import { MuiThemeProvider, createMuiTheme } from '@material-ui/core/styles'\n+import React from 'react';\n+import ReactDOM from 'react-dom';\n+import { ApolloProvider } from 'react-apollo-hooks';\n+import './index.css';\n+import App from './App';\n+import client from './client';\n+import * as serviceWorker from './serviceWorker';\n+\n+const theme = createMuiTheme({\n+  palette: {\n+    primary: { main: '#2c6157' },\n+    secondary: { main: '#6fd056' },\n+  },\n+  typography: {\n+    useNextVariants: true,\n+  },\n+})\n+\n+ReactDOM.render(\n+  <MuiThemeProvider theme={theme}>\n+    <ApolloProvider client={client}>\n+      <App />\n+    </ApolloProvider>\n+  </MuiThemeProvider>\n+, document.getElementById('root'));\n+\n+// If you want your app to work offline and load faster, you can change\n+// unregister() to register() below. Note this comes with some pitfalls.\n+// Learn more about service workers: https://bit.ly/CRA-PWA\n+serviceWorker.unregister();\ndiff --git a/client/src/react-app-env.d.ts b/client/src/react-app-env.d.ts\nnew file mode 100644\nindex 0000000..c148f59\n--- /dev/null\n+++ b/client/src/react-app-env.d.ts\n@@ -0,0 +1,3 @@\n+/// <reference types=\"react-scripts\" />\n+\n+declare module \"react-router-transition\";\n\\ No newline at end of file\ndiff --git a/client/src/serviceWorker.ts b/client/src/serviceWorker.ts\nnew file mode 100644\nindex 0000000..15d90cb\n--- /dev/null\n+++ b/client/src/serviceWorker.ts\n@@ -0,0 +1,143 @@\n+// This optional code is used to register a service worker.\n+// register() is not called by default.\n+\n+// This lets the app load faster on subsequent visits in production, and gives\n+// it offline capabilities. However, it also means that developers (and users)\n+// will only see deployed updates on subsequent visits to a page, after all the\n+// existing tabs open on the page have been closed, since previously cached\n+// resources are updated in the background.\n+\n+// To learn more about the benefits of this model and instructions on how to\n+// opt-in, read https://bit.ly/CRA-PWA\n+\n+const isLocalhost = Boolean(\n+  window.location.hostname === 'localhost' ||\n+    // [::1] is the IPv6 localhost address.\n+    window.location.hostname === '[::1]' ||\n+    // 127.0.0.1/8 is considered localhost for IPv4.\n+    window.location.hostname.match(\n+      /^127(?:\\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/\n+    )\n+);\n+\n+type Config = {\n+  onSuccess?: (registration: ServiceWorkerRegistration) => void;\n+  onUpdate?: (registration: ServiceWorkerRegistration) => void;\n+};\n+\n+export function register(config?: Config) {\n+  if (process.env.NODE_ENV === 'production' && 'serviceWorker' in navigator) {\n+    // The URL constructor is available in all browsers that support SW.\n+    const publicUrl = new URL(\n+      (process as { env: { [key: string]: string } }).env.PUBLIC_URL,\n+      window.location.href\n+    );\n+    if (publicUrl.origin !== window.location.origin) {\n+      // Our service worker won't work if PUBLIC_URL is on a different origin\n+      // from what our page is served on. This might happen if a CDN is used to\n+      // serve assets; see https://github.com/facebook/create-react-app/issues/2374\n+      return;\n+    }\n+\n+    window.addEventListener('load', () => {\n+      const swUrl = `${process.env.PUBLIC_URL}/service-worker.js`;\n+\n+      if (isLocalhost) {\n+        // This is running on localhost. Let's check if a service worker still exists or not.\n+        checkValidServiceWorker(swUrl, config);\n+\n+        // Add some additional logging to localhost, pointing developers to the\n+        // service worker/PWA documentation.\n+        navigator.serviceWorker.ready.then(() => {\n+          console.log(\n+            'This web app is being served cache-first by a service ' +\n+              'worker. To learn more, visit https://bit.ly/CRA-PWA'\n+          );\n+        });\n+      } else {\n+        // Is not localhost. Just register service worker\n+        registerValidSW(swUrl, config);\n+      }\n+    });\n+  }\n+}\n+\n+function registerValidSW(swUrl: string, config?: Config) {\n+  navigator.serviceWorker\n+    .register(swUrl)\n+    .then(registration => {\n+      registration.onupdatefound = () => {\n+        const installingWorker = registration.installing;\n+        if (installingWorker == null) {\n+          return;\n+        }\n+        installingWorker.onstatechange = () => {\n+          if (installingWorker.state === 'installed') {\n+            if (navigator.serviceWorker.controller) {\n+              // At this point, the updated precached content has been fetched,\n+              // but the previous service worker will still serve the older\n+              // content until all client tabs are closed.\n+              console.log(\n+                'New content is available and will be used when all ' +\n+                  'tabs for this page are closed. See https://bit.ly/CRA-PWA.'\n+              );\n+\n+              // Execute callback\n+              if (config && config.onUpdate) {\n+                config.onUpdate(registration);\n+              }\n+            } else {\n+              // At this point, everything has been precached.\n+              // It's the perfect time to display a\n+              // \"Content is cached for offline use.\" message.\n+              console.log('Content is cached for offline use.');\n+\n+              // Execute callback\n+              if (config && config.onSuccess) {\n+                config.onSuccess(registration);\n+              }\n+            }\n+          }\n+        };\n+      };\n+    })\n+    .catch(error => {\n+      console.error('Error during service worker registration:', error);\n+    });\n+}\n+\n+function checkValidServiceWorker(swUrl: string, config?: Config) {\n+  // Check if the service worker can be found. If it can't reload the page.\n+  fetch(swUrl)\n+    .then(response => {\n+      // Ensure service worker exists, and that we really are getting a JS file.\n+      const contentType = response.headers.get('content-type');\n+      if (\n+        response.status === 404 ||\n+        (contentType != null && contentType.indexOf('javascript') === -1)\n+      ) {\n+        // No service worker found. Probably a different app. Reload the page.\n+        navigator.serviceWorker.ready.then(registration => {\n+          registration.unregister().then(() => {\n+            window.location.reload();\n+          });\n+        });\n+      } else {\n+        // Service worker found. Proceed as normal.\n+        registerValidSW(swUrl, config);\n+      }\n+    })\n+    .catch(() => {\n+      console.log(\n+        'No internet connection found. App is running in offline mode.'\n+      );\n+    });\n+}\n+\n+export function unregister() {\n+  if ('serviceWorker' in navigator) {\n+    navigator.serviceWorker.ready.then(registration => {\n+      registration.unregister();\n+    });\n+  }\n+}\ndiff --git a/client/src/services/auth.service.tsx b/client/src/services/auth.service.tsx\nnew file mode 100644\nindex 0000000..8ae9e7f\n--- /dev/null\n+++ b/client/src/services/auth.service.tsx\n@@ -0,0 +1,92 @@\n+import React from 'react';\n+import { useContext } from 'react';\n+import { Redirect } from 'react-router-dom';\n+import client from '../client';\n+import { useMeQuery, User } from '../graphql/types';\n+import { useCacheService } from './cache.service';\n+import gql from 'graphql-tag';\n+\n+const MyContext = React.createContext<User|null>(null);\n+\n+export const useMe = () => {\n+  return useContext(MyContext);\n+};\n+\n+export const withAuth = <P extends object>(Component: React.ComponentType<P>) => {\n+  return (props: any) => {\n+    if (!isSignedIn()) {\n+      if (props.history.location.pathname === '/sign-in') {\n+        return null;\n+      }\n+\n+      return (\n+        <Redirect to=\"/sign-in\" />\n+      );\n+    }\n+\n+    const { data, error, loading } = useMeQuery();\n+\n+    useCacheService();\n+\n+    if (loading) return null;\n+\n+    if (data === undefined) return null;\n+\n+    if (error || !data.me) {\n+      signOut();\n+\n+      return <Redirect to=\"/sign-in\" />;\n+    }\n+\n+    return (\n+      <MyContext.Provider value={data.me}>\n+        <Component {...props as P} />\n+      </MyContext.Provider>\n+    );\n+  };\n+};\n+\n+export const signIn = ({ username, password }: { username: string, password: string}) => {\n+  return client.mutate({\n+    mutation: gql`\n+      mutation signIn($username: String!, $password: String!) {\n+        signIn(username: $username, password: $password) {\n+          id\n+        }\n+      }\n+    `,\n+    variables: {\n+      username,\n+      password\n+    }\n+  });\n+};\n+\n+export const signUp = ({ name, username, password, passwordConfirm }:\n+  {name: string, username: string, password: string, passwordConfirm: string}) => {\n+  return client.mutate({\n+    mutation: gql`\n+      mutation signUp($name: String!, $username: String!, $password: String!, $passwordConfirm: String!) {\n+        signUp(name: $name, username: $username, password: $password, passwordConfirm: $passwordConfirm) {\n+          id\n+        }\n+      }\n+    `,\n+    variables: {\n+      name,\n+      username,\n+      password,\n+      passwordConfirm\n+    }\n+  });\n+};\n+\n+export const signOut = () => {\n+  document.cookie = `authToken=;expires=${new Date(0)}`;\n+\n+  return client.clearStore();\n+};\n+\n+export const isSignedIn = () => {\n+  return /authToken=.+(;|$)/.test(document.cookie);\n+};\ndiff --git a/client/src/services/cache.service.ts b/client/src/services/cache.service.ts\nnew file mode 100644\nindex 0000000..0b54829\n--- /dev/null\n+++ b/client/src/services/cache.service.ts\n@@ -0,0 +1,188 @@\n+import { DataProxy } from 'apollo-cache';\n+import { defaultDataIdFromObject } from 'apollo-cache-inmemory';\n+import { ApolloClient } from 'apollo-client';\n+import * as fragments from '../graphql/fragments';\n+import * as queries from '../graphql/queries';\n+import {\n+  MessageFragment,\n+  ChatFragment,\n+  useMessageAddedSubscription,\n+  useChatAddedSubscription,\n+  useChatRemovedSubscription,\n+} from '../graphql/types';\n+\n+type Client = ApolloClient<any> | DataProxy;\n+\n+export const useCacheService = () => {\n+  useMessageAddedSubscription({\n+    onSubscriptionData: ({ client, subscriptionData: { data } }) => {\n+      if (data) {\n+        writeMessage(client, data.messageAdded);\n+      }\n+    }\n+  });\n+\n+  useChatAddedSubscription({\n+    onSubscriptionData: ({ client, subscriptionData: { data } }) => {\n+      if (data) {\n+        writeChat(client, data.chatAdded);\n+      }\n+    }\n+  });\n+\n+  useChatRemovedSubscription({\n+    onSubscriptionData: ({ client, subscriptionData: { data } }) => {\n+      if (data) {\n+        eraseChat(client, data.chatRemoved);\n+      }\n+    }\n+  });\n+};\n+\n+export const writeMessage = (client: Client, message: MessageFragment) => {\n+  type FullChat = { [key: string]: any };\n+  let fullChat;\n+\n+  const chatIdFromStore = defaultDataIdFromObject(message.chat);\n+\n+  if (chatIdFromStore === null) { return; }\n+  try {\n+    fullChat = client.readFragment<FullChat>({\n+      id: chatIdFromStore,\n+      fragment: fragments.fullChat,\n+      fragmentName: 'FullChat',\n+    })\n+  } catch (e) {\n+    return;\n+  }\n+\n+  if (fullChat === null || fullChat.messages === null) { return; }\n+  if (fullChat.messages.some((m: any) => m.id === message.id)) return;\n+\n+  fullChat.messages.push(message);\n+  fullChat.lastMessage = message;\n+\n+  client.writeFragment({\n+    id: chatIdFromStore,\n+    fragment: fragments.fullChat,\n+    fragmentName: 'FullChat',\n+    data: fullChat,\n+  });\n+\n+\n+  let data;\n+  try {\n+    data = client.readQuery({\n+      query: queries.chats,\n+    })\n+  } catch (e) {\n+    return;\n+  };\n+\n+  if (data === undefined || data.chats === undefined) {\n+    return null;\n+  }\n+\n+  const chats = data.chats;\n+  if (!chats) return;\n+\n+  const chatIndex = chats.findIndex((c: any) => {\n+    if (message === null || message.chat === null) return -1;\n+    return c.id === message.chat.id;\n+  });\n+  if (chatIndex === -1) return;\n+  const chatWhereAdded = chats[chatIndex];\n+\n+  // The chat will appear at the top of the ChatsList component\n+  chats.splice(chatIndex, 1);\n+  chats.unshift(chatWhereAdded);\n+\n+  client.writeQuery({\n+    query: queries.chats,\n+    data: { chats: chats },\n+  });\n+}\n+\n+export const writeChat = (client: Client, chat: ChatFragment) => {\n+\n+  const chatId = defaultDataIdFromObject(chat);\n+  if (chatId === null) {\n+    return;\n+  }\n+\n+  client.writeFragment({\n+    id: chatId,\n+    fragment: fragments.chat,\n+    fragmentName: 'Chat',\n+    data: chat,\n+  })\n+\n+  let data;\n+  try {\n+    data = client.readQuery({\n+      query: queries.chats,\n+    })\n+  } catch (e) {\n+    return;\n+  }\n+\n+  if (!data) return;\n+\n+  const chats = data.chats;\n+\n+  if (!chats) return;\n+  if (chats.some((c: any) => c.id === chat.id)) return;\n+\n+  chats.unshift(chat)\n+\n+  client.writeQuery({\n+    query: queries.chats,\n+    data: { chats },\n+  });\n+}\n+\n+export const eraseChat = (client: Client, chatId: string) => {\n+  const chatType = {\n+    __typename: 'Chat',\n+    id: chatId\n+  };\n+\n+  const chatIdFromObject = defaultDataIdFromObject(chatType);\n+  if (chatIdFromObject === null) {\n+    return;\n+  }\n+\n+  client.writeFragment({\n+    id: chatIdFromObject,\n+    fragment: fragments.fullChat,\n+    fragmentName: 'FullChat',\n+    data: null,\n+  })\n+\n+  let data;\n+  try {\n+    data = client.readQuery({\n+      query: queries.chats,\n+    });\n+  } catch (e) {\n+    return;\n+  }\n+\n+  if (!data || !data.chats) return;\n+\n+  const chats = data.chats;\n+\n+  if (!chats) return;\n+\n+  const chatIndex = chats.findIndex((c: any) => c.id === chatId);\n+\n+  if (chatIndex === -1) return;\n+\n+  // The chat will appear at the top of the ChatsList component\n+  chats.splice(chatIndex, 1);\n+\n+  client.writeQuery({\n+    query: queries.chats,\n+    data: { chats: chats },\n+  });\n+}\ndiff --git a/client/src/setupTests.ts b/client/src/setupTests.ts\nnew file mode 100644\nindex 0000000..c42be90\n--- /dev/null\n+++ b/client/src/setupTests.ts\n@@ -0,0 +1,7 @@\n+import 'jest-dom/extend-expect'\n+import { GlobalWithFetchMock } from 'jest-fetch-mock'\n+import { act } from 'react-testing-library'\n+\n+const customGlobal: GlobalWithFetchMock = global as GlobalWithFetchMock\n+customGlobal.fetch = require('jest-fetch-mock')\n+customGlobal.fetchMock = customGlobal.fetch\ndiff --git a/client/src/test-helpers.ts b/client/src/test-helpers.ts\nnew file mode 100644\nindex 0000000..82ecfdc\n--- /dev/null\n+++ b/client/src/test-helpers.ts\n@@ -0,0 +1,10 @@\n+import { InMemoryCache } from 'apollo-cache-inmemory';\n+import { ApolloClient } from 'apollo-client';\n+import { MockLink } from 'apollo-link-mock';\n+\n+export const mockApolloClient = (mocks: any) => {\n+  return new ApolloClient({\n+    cache: new InMemoryCache(),\n+    link: new MockLink(mocks),\n+  });\n+};\ndiff --git a/client/tsconfig.json b/client/tsconfig.json\nnew file mode 100644\nindex 0000000..0980b23\n--- /dev/null\n+++ b/client/tsconfig.json\n@@ -0,0 +1,25 @@\n+{\n+  \"compilerOptions\": {\n+    \"target\": \"es5\",\n+    \"lib\": [\n+      \"dom\",\n+      \"dom.iterable\",\n+      \"esnext\"\n+    ],\n+    \"allowJs\": true,\n+    \"skipLibCheck\": true,\n+    \"esModuleInterop\": true,\n+    \"allowSyntheticDefaultImports\": true,\n+    \"strict\": true,\n+    \"forceConsistentCasingInFileNames\": true,\n+    \"module\": \"esnext\",\n+    \"moduleResolution\": \"node\",\n+    \"resolveJsonModule\": true,\n+    \"isolatedModules\": true,\n+    \"noEmit\": true,\n+    \"jsx\": \"preserve\"\n+  },\n+  \"include\": [\n+    \"src\"\n+  ]\n+}\ndiff --git a/package.json b/package.json\nnew file mode 100644\nindex 0000000..008b058\n--- /dev/null\n+++ b/package.json\n@@ -0,0 +1,9 @@\n+{\n+  \"name\": \"whatsapp-clone-tutorial\",\n+  \"description\": \"A newly created Tortilla project\",\n+  \"private\": true,\n+  \"repository\": {\n+    \"type\": \"git\",\n+    \"url\": \"https://github.com/Urigo/WhatsApp-Clone-Tutorial.git\"\n+  }\n+}\ndiff --git a/server/.gitignore b/server/.gitignore\nnew file mode 100644\nindex 0000000..ba92242\n--- /dev/null\n+++ b/server/.gitignore\n@@ -0,0 +1,4 @@\n+node_modules\n+npm-debug.log\n+types/graphql.d.ts\n+types/unsplash.d.ts\ndiff --git a/server/app.ts b/server/app.ts\nnew file mode 100644\nindex 0000000..943a214\n--- /dev/null\n+++ b/server/app.ts\n@@ -0,0 +1,15 @@\n+import bodyParser from 'body-parser'\n+import cors from 'cors'\n+import cookieParser from 'cookie-parser'\n+import express from 'express'\n+import { origin } from './env'\n+\n+export const app = express()\n+\n+app.use(cors({ credentials: true, origin }))\n+app.use(bodyParser.json())\n+app.use(cookieParser())\n+\n+app.get('/_ping', (req, res) => {\n+  res.send('pong')\n+})\ndiff --git a/server/codegen.yml b/server/codegen.yml\nnew file mode 100644\nindex 0000000..9542ce7\n--- /dev/null\n+++ b/server/codegen.yml\n@@ -0,0 +1,23 @@\n+overwrite: true\n+generates:\n+  ./types/graphql.d.ts:\n+    schema: ./modules/*/*.ts\n+    plugins:\n+      - typescript\n+      - typescript-resolvers\n+    config:\n+      useIndexSignature: true\n+      contextType: ../context#MyContext\n+      mappers:\n+        # import { Message } from '../db'\n+        # The root types of Message resolvers\n+        User: ../db#User\n+        Message: ../db#Message\n+        Chat: ../db#Chat\n+      scalars:\n+        # e.g. Message.createdAt will be of type Date\n+        Date: Date\n+  ./types/unsplash.d.ts:\n+    schema: ./logs/main/Unsplash.RandomPhoto.graphql\n+    plugins:\n+      - typescript\ndiff --git a/server/context.ts b/server/context.ts\nnew file mode 100644\nindex 0000000..c9ac74a\n--- /dev/null\n+++ b/server/context.ts\n@@ -0,0 +1,3 @@\n+import { ModuleContext } from '@graphql-modules/core';\n+\n+export type MyContext = ModuleContext;\ndiff --git a/server/db.ts b/server/db.ts\nnew file mode 100644\nindex 0000000..cd3c287\n--- /dev/null\n+++ b/server/db.ts\n@@ -0,0 +1,200 @@\n+import { Pool } from \"pg\";\n+import sql from 'sql-template-strings'\n+import { resetDb as envResetDb } from './env'\n+\n+export type User = {\n+  id: string\n+  name: string\n+  username: string\n+  password: string\n+  picture: string\n+}\n+\n+export type Message = {\n+  id: string\n+  content: string\n+  created_at: Date\n+  chat_id: string\n+  sender_user_id: string\n+}\n+\n+export type Chat = {\n+  id: string\n+}\n+\n+export const pool = new Pool({\n+  host: 'localhost',\n+  port: 5432,\n+  user: 'testuser',\n+  password: 'testpassword',\n+  database: 'whatsapp'\n+})\n+\n+export const resetDb = async () => {\n+\n+  await pool.query(sql`DELETE FROM users`)\n+\n+  const sampleUsers = [\n+    {\n+      id: '1',\n+      name: 'Ray Edwards',\n+      username: 'ray',\n+      password: '$2a$08$NO9tkFLCoSqX1c5wk3s7z.JfxaVMKA.m7zUDdDwEquo4rvzimQeJm', // 111\n+      picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n+    },\n+    {\n+      id: '2',\n+      name: 'Ethan Gonzalez',\n+      username: 'ethan',\n+      password: '$2a$08$xE4FuCi/ifxjL2S8CzKAmuKLwv18ktksSN.F3XYEnpmcKtpbpeZgO', // 222\n+      picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n+    },\n+    {\n+      id: '3',\n+      name: 'Bryan Wallace',\n+      username: 'bryan',\n+      password: '$2a$08$UHgH7J8G6z1mGQn2qx2kdeWv0jvgHItyAsL9hpEUI3KJmhVW5Q1d.', // 333\n+      picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n+    },\n+    {\n+      id: '4',\n+      name: 'Avery Stewart',\n+      username: 'avery',\n+      password: '$2a$08$wR1k5Q3T9FC7fUgB7Gdb9Os/GV7dGBBf4PLlWT7HERMFhmFDt47xi', // 444\n+      picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n+    },\n+    {\n+      id: '5',\n+      name: 'Katie Peterson',\n+      username: 'katie',\n+      password: '$2a$08$6.mbXqsDX82ZZ7q5d8Osb..JrGSsNp4R3IKj7mxgF6YGT0OmMw242', // 555\n+      picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n+    },\n+  ]\n+\n+  for (const sampleUser of sampleUsers) {\n+    await pool.query(sql`\n+      INSERT INTO users(id, name, username, password, picture)\n+      VALUES(${sampleUser.id}, ${sampleUser.name}, ${sampleUser.username}, ${sampleUser.password}, ${sampleUser.picture})\n+    `)\n+  }\n+\n+  await pool.query(sql`SELECT setval('users_id_seq', (SELECT max(id) FROM users))`)\n+\n+  await pool.query(sql`DELETE FROM chats`)\n+\n+  const sampleChats = [\n+    {\n+      id: '1',\n+    },\n+    {\n+      id: '2',\n+    },\n+    {\n+      id: '3',\n+    },\n+    {\n+      id: '4',\n+    },\n+  ]\n+\n+  for (const sampleChat of sampleChats) {\n+    await pool.query(sql`\n+      INSERT INTO chats(id)\n+      VALUES(${sampleChat.id})\n+    `)\n+  }\n+\n+  await pool.query(sql`SELECT setval('chats_id_seq', (SELECT max(id) FROM chats))`)\n+\n+  await pool.query(sql`DELETE FROM chats_users`)\n+\n+  const sampleChatsUsers = [\n+    {\n+      chat_id: '1',\n+      user_id: '1',\n+    },\n+    {\n+      chat_id: '1',\n+      user_id: '2',\n+    },\n+    {\n+      chat_id: '2',\n+      user_id: '1',\n+    },\n+    {\n+      chat_id: '2',\n+      user_id: '3',\n+    },\n+    {\n+      chat_id: '3',\n+      user_id: '1',\n+    },\n+    {\n+      chat_id: '3',\n+      user_id: '4',\n+    },\n+    {\n+      chat_id: '4',\n+      user_id: '1',\n+    },\n+    {\n+      chat_id: '4',\n+      user_id: '5',\n+    },\n+  ]\n+\n+  for (const sampleChatUser of sampleChatsUsers) {\n+    await pool.query(sql`\n+      INSERT INTO chats_users(chat_id, user_id)\n+      VALUES(${sampleChatUser.chat_id}, ${sampleChatUser.user_id})\n+    `)\n+  }\n+\n+  await pool.query(sql`DELETE FROM messages`)\n+\n+  const sampleMessages = [\n+    {\n+      id: '1',\n+      content: \"You on your way?\",\n+      created_at: new Date(new Date('1-1-2019').getTime() - 60 * 1000 * 1000),\n+      chat_id: '1',\n+      sender_user_id: '1',\n+    },\n+    {\n+      id: '2',\n+      content: \"Hey, it's me\",\n+      created_at: new Date(new Date('1-1-2019').getTime() - 2 * 60 * 1000 * 1000),\n+      chat_id: '2',\n+      sender_user_id: '1',\n+    },\n+    {\n+      id: '3',\n+      content: \"I should buy a boat\",\n+      created_at: new Date(new Date('1-1-2019').getTime() - 24 * 60 * 1000 * 1000),\n+      chat_id: '3',\n+      sender_user_id: '1',\n+    },\n+    {\n+      id: '4',\n+      content: \"This is wicked good ice cream.\",\n+      created_at: new Date(new Date('1-1-2019').getTime() - 14 * 24 * 60 * 1000 * 1000),\n+      chat_id: '4',\n+      sender_user_id: '1',\n+    },\n+  ]\n+\n+  for (const sampleMessage of sampleMessages) {\n+    await pool.query(sql`\n+      INSERT INTO messages(id, content, created_at, chat_id, sender_user_id)\n+      VALUES(${sampleMessage.id}, ${sampleMessage.content}, ${sampleMessage.created_at}, ${sampleMessage.chat_id}, ${sampleMessage.sender_user_id})\n+    `)\n+  }\n+\n+  await pool.query(sql`SELECT setval('messages_id_seq', (SELECT max(id) FROM messages))`)\n+\n+}\n+\n+if (envResetDb) {\n+  resetDb()\n+}\ndiff --git a/server/env.ts b/server/env.ts\nnew file mode 100644\nindex 0000000..d6b5023\n--- /dev/null\n+++ b/server/env.ts\n@@ -0,0 +1,7 @@\n+export const expiration = process.env.JWT_EXPIRATION_MS\n+  ?  parseInt(process.env.JWT_EXPIRATION_MS)\n+  : 24 * 60 * 60 * 1000\n+export const secret = process.env.JWT_SECRET || '70p53cr37'\n+export const origin = process.env.ORIGIN || 'http://localhost:3000'\n+export const port = process.env.PORT || 4000\n+export const resetDb = process.env.RESET_DB || false;\ndiff --git a/server/index.ts b/server/index.ts\nnew file mode 100644\nindex 0000000..39dd8b0\n--- /dev/null\n+++ b/server/index.ts\n@@ -0,0 +1,17 @@\n+import http from 'http'\n+import { app } from './app'\n+import { origin, port } from './env'\n+import { server } from './server';\n+\n+server.applyMiddleware({\n+  app,\n+  path: '/graphql',\n+  cors: { credentials: true, origin },\n+})\n+\n+const httpServer = http.createServer(app)\n+server.installSubscriptionHandlers(httpServer)\n+\n+httpServer.listen(port, () => {\n+  console.log(`Server is listening on port ${port}`)\n+})\ndiff --git a/server/logs/main/Unsplash.RandomPhoto.2019-05-09T14:45:43.850Z.graphql b/server/logs/main/Unsplash.RandomPhoto.2019-05-09T14:45:43.850Z.graphql\nnew file mode 100644\nindex 0000000..20139fc\n--- /dev/null\n+++ b/server/logs/main/Unsplash.RandomPhoto.2019-05-09T14:45:43.850Z.graphql\n@@ -0,0 +1,103 @@\n+type Exif {\n+  make: String!\n+  model: String!\n+  exposure_time: String!\n+  aperture: String!\n+  focal_length: String!\n+  iso: Int!\n+}\n+\n+scalar JSON\n+\n+type Links {\n+  self: String!\n+  html: String!\n+  download: String\n+  download_location: String\n+  photos: String\n+  likes: String\n+  portfolio: String\n+  following: String\n+  followers: String\n+}\n+\n+type Location {\n+  title: String!\n+  name: String!\n+  city: String!\n+  country: String!\n+  position: Position!\n+}\n+\n+type Position {\n+  latitude: Int!\n+  longitude: Int!\n+}\n+\n+type Profile_image {\n+  small: String!\n+  medium: String!\n+  large: String!\n+}\n+\n+type RandomPhoto {\n+  id: String!\n+  created_at: String!\n+  updated_at: String!\n+  width: Int!\n+  height: Int!\n+  color: String!\n+  description: JSON\n+  alt_description: String!\n+  urls: Urls!\n+  links: Links!\n+  categories: [JSON]!\n+  sponsored: Boolean!\n+  sponsored_by: JSON\n+  sponsored_impressions_id: JSON\n+  likes: Int!\n+  liked_by_user: Boolean!\n+  current_user_collections: [JSON]!\n+  user: User!\n+  exif: Exif!\n+  location: Location!\n+  views: Int!\n+  downloads: Int!\n+}\n+\n+input RandomPhotoInput {\n+  query: String!\n+  orientation: String!\n+}\n+\n+type Root {\n+  RandomPhoto(input: RandomPhotoInput): RandomPhoto\n+}\n+\n+type Urls {\n+  raw: String!\n+  full: String!\n+  regular: String!\n+  small: String!\n+  thumb: String!\n+}\n+\n+type User {\n+  id: String!\n+  updated_at: String!\n+  username: String!\n+  name: String!\n+  first_name: String!\n+  last_name: String!\n+  twitter_username: String!\n+  portfolio_url: String!\n+  bio: String!\n+  location: String!\n+  links: Links!\n+  profile_image: Profile_image!\n+  instagram_username: String!\n+  total_collections: Int!\n+  total_likes: Int!\n+  total_photos: Int!\n+  accepted_tos: Boolean!\n+}\ndiff --git a/server/logs/main/Unsplash.RandomPhoto.2019-05-09T14:45:45.197Z.graphql b/server/logs/main/Unsplash.RandomPhoto.2019-05-09T14:45:45.197Z.graphql\nnew file mode 100644\nindex 0000000..02152a8\n--- /dev/null\n+++ b/server/logs/main/Unsplash.RandomPhoto.2019-05-09T14:45:45.197Z.graphql\n@@ -0,0 +1,103 @@\n+type Exif {\n+  make: String!\n+  model: String!\n+  exposure_time: String!\n+  aperture: String!\n+  focal_length: String!\n+  iso: Int!\n+}\n+\n+scalar JSON\n+\n+type Links {\n+  self: String!\n+  html: String!\n+  download: String\n+  download_location: String\n+  photos: String\n+  likes: String\n+  portfolio: String\n+  following: String\n+  followers: String\n+}\n+\n+type Location {\n+  title: String!\n+  name: String!\n+  city: String!\n+  country: String!\n+  position: Position!\n+}\n+\n+type Position {\n+  latitude: Int!\n+  longitude: Int!\n+}\n+\n+type Profile_image {\n+  small: String!\n+  medium: String!\n+  large: String!\n+}\n+\n+type RandomPhoto {\n+  id: String!\n+  created_at: String!\n+  updated_at: String!\n+  width: Int!\n+  height: Int!\n+  color: String!\n+  description: String!\n+  alt_description: String!\n+  urls: Urls!\n+  links: Links!\n+  categories: [JSON]!\n+  sponsored: Boolean!\n+  sponsored_by: JSON\n+  sponsored_impressions_id: JSON\n+  likes: Int!\n+  liked_by_user: Boolean!\n+  current_user_collections: [JSON]!\n+  user: User!\n+  exif: Exif!\n+  location: Location!\n+  views: Int!\n+  downloads: Int!\n+}\n+\n+input RandomPhotoInput {\n+  query: String!\n+  orientation: String!\n+}\n+\n+type Root {\n+  RandomPhoto(input: RandomPhotoInput): RandomPhoto\n+}\n+\n+type Urls {\n+  raw: String!\n+  full: String!\n+  regular: String!\n+  small: String!\n+  thumb: String!\n+}\n+\n+type User {\n+  id: String!\n+  updated_at: String!\n+  username: String!\n+  name: String!\n+  first_name: String!\n+  last_name: String!\n+  twitter_username: String!\n+  portfolio_url: JSON\n+  bio: String!\n+  location: String!\n+  links: Links!\n+  profile_image: Profile_image!\n+  instagram_username: String!\n+  total_collections: Int!\n+  total_likes: Int!\n+  total_photos: Int!\n+  accepted_tos: Boolean!\n+}\ndiff --git a/server/logs/main/Unsplash.RandomPhoto.graphql b/server/logs/main/Unsplash.RandomPhoto.graphql\nnew file mode 100644\nindex 0000000..c412c9c\n--- /dev/null\n+++ b/server/logs/main/Unsplash.RandomPhoto.graphql\n@@ -0,0 +1,103 @@\n+type Exif {\n+  make: String!\n+  model: String!\n+  exposure_time: String!\n+  aperture: String!\n+  focal_length: String!\n+  iso: Int!\n+}\n+\n+scalar JSON\n+\n+type Links {\n+  self: String!\n+  html: String!\n+  download: String\n+  download_location: String\n+  photos: String\n+  likes: String\n+  portfolio: String\n+  following: String\n+  followers: String\n+}\n+\n+type Location {\n+  title: String!\n+  name: String!\n+  city: String!\n+  country: String!\n+  position: Position!\n+}\n+\n+type Position {\n+  latitude: Int!\n+  longitude: Int!\n+}\n+\n+type Profile_image {\n+  small: String!\n+  medium: String!\n+  large: String!\n+}\n+\n+type RandomPhoto {\n+  id: String!\n+  created_at: String!\n+  updated_at: String!\n+  width: Int!\n+  height: Int!\n+  color: String!\n+  description: String!\n+  alt_description: String!\n+  urls: Urls!\n+  links: Links!\n+  categories: [JSON]!\n+  sponsored: Boolean!\n+  sponsored_by: JSON\n+  sponsored_impressions_id: JSON\n+  likes: Int!\n+  liked_by_user: Boolean!\n+  current_user_collections: [JSON]!\n+  user: User!\n+  exif: Exif!\n+  location: Location!\n+  views: Int!\n+  downloads: Int!\n+}\n+\n+input RandomPhotoInput {\n+  query: String!\n+  orientation: String!\n+}\n+\n+type Root {\n+  RandomPhoto(input: RandomPhotoInput): RandomPhoto\n+}\n+\n+type Urls {\n+  raw: String!\n+  full: String!\n+  regular: String!\n+  small: String!\n+  thumb: String!\n+}\n+\n+type User {\n+  id: String!\n+  updated_at: String!\n+  username: String!\n+  name: String!\n+  first_name: String!\n+  last_name: String!\n+  twitter_username: JSON\n+  portfolio_url: JSON\n+  bio: JSON\n+  location: String!\n+  links: Links!\n+  profile_image: Profile_image!\n+  instagram_username: String!\n+  total_collections: Int!\n+  total_likes: Int!\n+  total_photos: Int!\n+  accepted_tos: Boolean!\n+}\ndiff --git a/server/modules/chats/chats.provider.ts b/server/modules/chats/chats.provider.ts\nnew file mode 100644\nindex 0000000..3659604\n--- /dev/null\n+++ b/server/modules/chats/chats.provider.ts\n@@ -0,0 +1,216 @@\n+import { Injectable, Inject, ProviderScope } from '@graphql-modules/di';\n+import sql from 'sql-template-strings';\n+import { Database } from '../common/database.provider';\n+import { PubSub } from '../common/pubsub.provider';\n+\n+@Injectable({\n+  scope: ProviderScope.Session,\n+})\n+export class Chats {\n+  @Inject() private db: Database;\n+  @Inject() private pubsub: PubSub;\n+\n+  async findChatsByUser(userId: string) {\n+    const db = await this.db.getClient();\n+\n+    const { rows } = await db.query(sql`\n+      SELECT chats.* FROM chats, chats_users\n+      WHERE chats.id = chats_users.chat_id\n+      AND chats_users.user_id = ${userId}\n+    `);\n+\n+    return rows;\n+  }\n+\n+  async findChatByUser({ chatId, userId }: { chatId: string; userId: string }) {\n+    const db = await this.db.getClient();\n+    const { rows } = await db.query(sql`\n+      SELECT chats.* FROM chats, chats_users\n+      WHERE chats_users.chat_id = ${chatId}\n+      AND chats.id = chats_users.chat_id\n+      AND chats_users.user_id = ${userId}\n+    `);\n+\n+    return rows[0] || null;\n+  }\n+\n+  async findChatById(chatId: string) {\n+    const db = await this.db.getClient();\n+    const { rows } = await db.query(sql`\n+      SELECT * FROM chats WHERE id = ${chatId}\n+    `);\n+    return rows[0] || null;\n+  }\n+\n+  async findMessagesByChat(chatId: string) {\n+    const db = await this.db.getClient();\n+    const { rows } = await db.query(\n+      sql`SELECT * FROM messages WHERE chat_id = ${chatId}`,\n+    );\n+\n+    return rows;\n+  }\n+\n+  async lastMessage(chatId: string) {\n+    const db = await this.db.getClient();\n+    const { rows } = await db.query(sql`\n+      SELECT * FROM messages\n+      WHERE chat_id = ${chatId}\n+      ORDER BY created_at DESC\n+      LIMIT 1\n+    `);\n+\n+    return rows[0];\n+  }\n+\n+  async firstRecipient({ chatId, userId }: { chatId: string; userId: string }) {\n+    const db = await this.db.getClient();\n+    const { rows } = await db.query(sql`\n+      SELECT users.* FROM users, chats_users\n+      WHERE users.id != ${userId}\n+      AND users.id = chats_users.user_id\n+      AND chats_users.chat_id = ${chatId}\n+    `);\n+\n+    return rows[0] || null;\n+  }\n+\n+  async participants(chatId: string) {\n+    const db = await this.db.getClient();\n+    const { rows } = await db.query(sql`\n+      SELECT users.* FROM users, chats_users\n+      WHERE chats_users.chat_id = ${chatId}\n+      AND chats_users.user_id = users.id\n+    `);\n+\n+    return rows;\n+  }\n+\n+  async isParticipant({ chatId, userId }: { chatId: string; userId: string }) {\n+    const db = await this.db.getClient();\n+    const { rows } = await db.query(sql`\n+      SELECT * FROM chats_users\n+      WHERE chat_id = ${chatId}\n+      AND user_id = ${userId}\n+    `);\n+\n+    return !!rows.length;\n+  }\n+\n+  async addMessage({\n+    chatId,\n+    userId,\n+    content,\n+  }: {\n+    chatId: string;\n+    userId: string;\n+    content: string;\n+  }) {\n+    const db = await this.db.getClient();\n+    const { rows } = await db.query(sql`\n+      INSERT INTO messages(chat_id, sender_user_id, content)\n+      VALUES(${chatId}, ${userId}, ${content})\n+      RETURNING *\n+    `);\n+\n+    const messageAdded = rows[0];\n+\n+    this.pubsub.publish('messageAdded', {\n+      messageAdded,\n+    });\n+\n+    return messageAdded;\n+  }\n+\n+  async addChat({\n+    userId,\n+    recipientId,\n+  }: {\n+    userId: string;\n+    recipientId: string;\n+  }) {\n+    const db = await this.db.getClient();\n+    const { rows } = await db.query(sql`\n+      SELECT chats.* FROM chats, (SELECT * FROM chats_users WHERE user_id = ${userId}) AS chats_of_current_user, chats_users\n+      WHERE chats_users.chat_id = chats_of_current_user.chat_id\n+      AND chats.id = chats_users.chat_id\n+      AND chats_users.user_id = ${recipientId}\n+    `);\n+\n+    // If there is already a chat between these two users, return it\n+    if (rows[0]) {\n+      return rows[0];\n+    }\n+\n+    try {\n+      await db.query('BEGIN');\n+\n+      const { rows } = await db.query(sql`\n+        INSERT INTO chats\n+        DEFAULT VALUES\n+        RETURNING *\n+      `);\n+\n+      const chatAdded = rows[0];\n+\n+      await db.query(sql`\n+        INSERT INTO chats_users(chat_id, user_id)\n+        VALUES(${chatAdded.id}, ${userId})\n+      `);\n+\n+      await db.query(sql`\n+        INSERT INTO chats_users(chat_id, user_id)\n+        VALUES(${chatAdded.id}, ${recipientId})\n+      `);\n+\n+      await db.query('COMMIT');\n+\n+      this.pubsub.publish('chatAdded', {\n+        chatAdded,\n+      });\n+\n+      return chatAdded;\n+    } catch (e) {\n+      await db.query('ROLLBACK');\n+      throw e;\n+    }\n+  }\n+\n+  async removeChat({ chatId, userId }: { chatId: string; userId: string }) {\n+    const db = await this.db.getClient();\n+\n+    try {\n+      await db.query('BEGIN');\n+\n+      const { rows } = await db.query(sql`\n+        SELECT chats.* FROM chats, chats_users\n+        WHERE id = ${chatId}\n+        AND chats.id = chats_users.chat_id\n+        AND chats_users.user_id = ${userId}\n+      `);\n+\n+      const chat = rows[0];\n+\n+      if (!chat) {\n+        await db.query('ROLLBACK');\n+        return null;\n+      }\n+\n+      await db.query(sql`\n+        DELETE FROM chats WHERE chats.id = ${chatId}\n+      `);\n+\n+      this.pubsub.publish('chatRemoved', {\n+        chatRemoved: chat.id,\n+        targetChat: chat,\n+      });\n+\n+      await db.query('COMMIT');\n+\n+      return chatId;\n+    } catch (e) {\n+      await db.query('ROLLBACK');\n+      throw e;\n+    }\n+  }\n+}\ndiff --git a/server/modules/chats/index.ts b/server/modules/chats/index.ts\nnew file mode 100644\nindex 0000000..a8dd8ff\n--- /dev/null\n+++ b/server/modules/chats/index.ts\n@@ -0,0 +1,242 @@\n+import { GraphQLModule } from '@graphql-modules/core';\n+import { gql, withFilter } from 'apollo-server-express';\n+import commonModule from '../common';\n+import usersModule from '../users';\n+import { Message, Chat } from '../../db';\n+import { Resolvers } from '../../types/graphql';\n+import { UnsplashApi } from './unsplash.api';\n+import { Users } from './../users/users.provider';\n+import { Auth } from './../users/auth.provider';\n+import { Chats } from './chats.provider';\n+import { PubSub } from '../common/pubsub.provider';\n+\n+const typeDefs = gql`\n+  type Message {\n+    id: ID!\n+    content: String!\n+    createdAt: DateTime!\n+    chat: Chat\n+    sender: User\n+    recipient: User\n+    isMine: Boolean!\n+  }\n+\n+  type Chat {\n+    id: ID!\n+    name: String\n+    picture: String\n+    lastMessage: Message\n+    messages: [Message!]!\n+    participants: [User!]!\n+  }\n+\n+  extend type Query {\n+    chats: [Chat!]!\n+    chat(chatId: ID!): Chat\n+  }\n+\n+  extend type Mutation {\n+    addMessage(chatId: ID!, content: String!): Message\n+    addChat(recipientId: ID!): Chat\n+    removeChat(chatId: ID!): ID\n+  }\n+\n+  extend type Subscription {\n+    messageAdded: Message!\n+    chatAdded: Chat!\n+    chatRemoved: ID!\n+  }\n+`;\n+\n+const resolvers: Resolvers = {\n+  Message: {\n+    createdAt(message) {\n+      return new Date(message.created_at);\n+    },\n+\n+    async chat(message, args, { injector }) {\n+      return injector.get(Chats).findChatById(message.chat_id);\n+    },\n+\n+    async sender(message, args, { injector }) {\n+      return injector.get(Users).findById(message.sender_user_id);\n+    },\n+\n+    async recipient(message, args, { injector }) {\n+      return injector.get(Chats).firstRecipient({\n+        chatId: message.chat_id,\n+        userId: message.sender_user_id,\n+      });\n+    },\n+\n+    async isMine(message, args, { injector }) {\n+      const currentUser = await injector.get(Auth).currentUser();\n+      return message.sender_user_id === currentUser!.id;\n+    },\n+  },\n+\n+  Chat: {\n+    async name(chat, args, { injector }) {\n+      const currentUser = await injector.get(Auth).currentUser();\n+\n+      if (!currentUser) return null;\n+\n+      const participant = await injector.get(Chats).firstRecipient({\n+        chatId: chat.id,\n+        userId: currentUser.id,\n+      });\n+\n+      return participant ? participant.name : null;\n+    },\n+\n+    async picture(chat, args, { injector }) {\n+      const currentUser = await injector.get(Auth).currentUser();\n+\n+      if (!currentUser) return null;\n+\n+      const participant = await injector.get(Chats).firstRecipient({\n+        chatId: chat.id,\n+        userId: currentUser.id,\n+      });\n+\n+      return participant && participant.picture\n+        ? participant.picture\n+        : injector.get(UnsplashApi).getRandomPhoto();\n+    },\n+\n+    async messages(chat, args, { injector }) {\n+      return injector.get(Chats).findMessagesByChat(chat.id);\n+    },\n+\n+    async lastMessage(chat, args, { injector }) {\n+      return injector.get(Chats).lastMessage(chat.id);\n+    },\n+\n+    async participants(chat, args, { injector }) {\n+      return injector.get(Chats).participants(chat.id);\n+    },\n+  },\n+\n+  Query: {\n+    async chats(root, args, { injector }) {\n+      const currentUser = await injector.get(Auth).currentUser();\n+\n+      if (!currentUser) return [];\n+\n+      return injector.get(Chats).findChatsByUser(currentUser.id);\n+    },\n+\n+    async chat(root, { chatId }, { injector }) {\n+      const currentUser = await injector.get(Auth).currentUser();\n+\n+      if (!currentUser) return null;\n+\n+      return injector\n+        .get(Chats)\n+        .findChatByUser({ chatId, userId: currentUser.id });\n+    },\n+  },\n+\n+  Mutation: {\n+    async addMessage(root, { chatId, content }, { injector }) {\n+      const currentUser = await injector.get(Auth).currentUser();\n+\n+      if (!currentUser) return null;\n+\n+      return injector\n+        .get(Chats)\n+        .addMessage({ chatId, content, userId: currentUser.id });\n+    },\n+\n+    async addChat(root, { recipientId }, { injector }) {\n+      const currentUser = await injector.get(Auth).currentUser();\n+\n+      if (!currentUser) return null;\n+\n+      return injector\n+        .get(Chats)\n+        .addChat({ recipientId, userId: currentUser.id });\n+    },\n+\n+    async removeChat(root, { chatId }, { injector }) {\n+      const currentUser = await injector.get(Auth).currentUser();\n+\n+      if (!currentUser) return null;\n+\n+      return injector.get(Chats).removeChat({ chatId, userId: currentUser.id });\n+    },\n+  },\n+\n+  Subscription: {\n+    messageAdded: {\n+      subscribe: withFilter(\n+        (root, args, { injector }) =>\n+          injector.get(PubSub).asyncIterator('messageAdded'),\n+        async (\n+          { messageAdded }: { messageAdded: Message },\n+          args,\n+          { injector },\n+        ) => {\n+          const currentUser = await injector.get(Auth).currentUser();\n+\n+          if (!currentUser) return false;\n+\n+          return injector.get(Chats).isParticipant({\n+            chatId: messageAdded.chat_id,\n+            userId: currentUser.id,\n+          });\n+        },\n+      ),\n+    },\n+\n+    chatAdded: {\n+      subscribe: withFilter(\n+        (root, args, { injector }) =>\n+          injector.get(PubSub).asyncIterator('chatAdded'),\n+        async (\n+          { chatAdded }: { chatAdded: Chat },\n+          args,\n+          { injector },\n+        ) => {\n+          const currentUser = await injector.get(Auth).currentUser();\n+\n+          if (!currentUser) return false;\n+\n+          return injector.get(Chats).isParticipant({\n+            chatId: chatAdded.id,\n+            userId: currentUser.id,\n+          });\n+        },\n+      ),\n+    },\n+\n+    chatRemoved: {\n+      subscribe: withFilter(\n+        (root, args, { injector }) =>\n+          injector.get(PubSub).asyncIterator('chatRemoved'),\n+        async (\n+          { targetChat }: { targetChat: Chat },\n+          args,\n+          { injector },\n+        ) => {\n+          const currentUser = await injector.get(Auth).currentUser();\n+\n+          if (!currentUser) return false;\n+\n+          return injector.get(Chats).isParticipant({\n+            chatId: targetChat.id,\n+            userId: currentUser.id,\n+          });\n+        },\n+      ),\n+    },\n+  },\n+};\n+\n+export default new GraphQLModule({\n+  name: 'chats',\n+  typeDefs,\n+  resolvers,\n+  imports: () => [commonModule, usersModule],\n+  providers: () => [UnsplashApi, Chats],\n+});\ndiff --git a/server/modules/chats/unsplash.api.ts b/server/modules/chats/unsplash.api.ts\nnew file mode 100644\nindex 0000000..cb993f0\n--- /dev/null\n+++ b/server/modules/chats/unsplash.api.ts\n@@ -0,0 +1,52 @@\n+import { Injectable, ProviderScope } from '@graphql-modules/di';\n+import { resolve } from 'path';\n+import axios from 'axios';\n+import { trackProvider } from '@safe-api/middleware';\n+import { RandomPhoto } from '../../types/unsplash';\n+\n+interface RandomPhotoInput {\n+  query: string;\n+  orientation: 'landscape' | 'portrait' | 'squarish';\n+}\n+\n+@Injectable({\n+  scope: ProviderScope.Application,\n+})\n+export class UnsplashApi {\n+  baseURL = 'https://api.unsplash.com/';\n+\n+  async getRandomPhoto() {\n+    const trackedRandomPhoto = await trackProvider(\n+      async ({ query, orientation }: RandomPhotoInput) => {\n+        const response = await axios.get<RandomPhoto>('photos/random', {\n+          baseURL: this.baseURL,\n+          headers: {\n+            Authorization:\n+              'Client-ID 4d048cfb4383b407eff92e4a2a5ec36c0a866be85e64caafa588c110efad350d',\n+          },\n+          params: {\n+            query,\n+            orientation,\n+          },\n+        });\n+\n+        return response.data;\n+      },\n+      {\n+        provider: 'Unsplash',\n+        method: 'RandomPhoto',\n+        location: resolve(__dirname, '../logs/main'),\n+      },\n+    );\n+\n+    try {\n+      return (await trackedRandomPhoto({\n+        query: 'portrait',\n+        orientation: 'squarish',\n+      })).urls.small;\n+    } catch (err) {\n+      console.error('Cannot retrieve random photo:', err);\n+      return null;\n+    }\n+  }\n+}\ndiff --git a/server/modules/common/database.provider.ts b/server/modules/common/database.provider.ts\nnew file mode 100644\nindex 0000000..4e72c6a\n--- /dev/null\n+++ b/server/modules/common/database.provider.ts\n@@ -0,0 +1,26 @@\n+import { Injectable, ProviderScope } from '@graphql-modules/di';\n+import { OnResponse } from '@graphql-modules/core';\n+import { Pool, PoolClient } from 'pg';\n+\n+@Injectable({\n+  scope: ProviderScope.Session,\n+})\n+export class Database implements OnResponse {\n+  private instance: PoolClient;\n+\n+  constructor(private pool: Pool) {}\n+\n+  async onRequest() {\n+    this.instance = await this.pool.connect();\n+  }\n+\n+  onResponse() {\n+    if (this.instance) {\n+      this.instance.release();\n+    }\n+  }\n+\n+  async getClient() {\n+    return this.instance;\n+  }\n+}\n\\ No newline at end of file\ndiff --git a/server/modules/common/index.ts b/server/modules/common/index.ts\nnew file mode 100644\nindex 0000000..ddad1f0\n--- /dev/null\n+++ b/server/modules/common/index.ts\n@@ -0,0 +1,57 @@\n+import { GraphQLModule } from '@graphql-modules/core';\n+import { ProviderScope } from '@graphql-modules/di';\n+import { gql } from 'apollo-server-express';\n+import { GraphQLDateTime } from 'graphql-iso-date';\n+import { Pool } from 'pg';\n+import { pool } from '../../db';\n+import { Resolvers } from '../../types/graphql';\n+import { Database } from './database.provider';\n+import { PubSub } from './pubsub.provider';\n+\n+const { PostgresPubSub } = require('graphql-postgres-subscriptions');\n+\n+const typeDefs = gql`\n+  scalar DateTime\n+\n+  type Query {\n+    _dummy: Boolean\n+  }\n+\n+  type Mutation {\n+    _dummy: Boolean\n+  }\n+\n+  type Subscription {\n+    _dummy: Boolean\n+  }\n+`;\n+\n+const resolvers: Resolvers = {\n+  DateTime: GraphQLDateTime,\n+};\n+\n+const pubsub = new PostgresPubSub({\n+  host: 'localhost',\n+  port: 5432,\n+  user: 'testuser',\n+  password: 'testpassword',\n+  database: 'whatsapp',\n+});\n+\n+export default new GraphQLModule({\n+  name: 'common',\n+  typeDefs,\n+  resolvers,\n+  providers: () => [\n+    {\n+      provide: Pool,\n+      useValue: pool,\n+    },\n+    {\n+      provide: PubSub,\n+      scope: ProviderScope.Application,\n+      useValue: pubsub,\n+    },\n+    Database,\n+  ],\n+});\ndiff --git a/server/modules/common/pubsub.provider.ts b/server/modules/common/pubsub.provider.ts\nnew file mode 100644\nindex 0000000..d1455e2\n--- /dev/null\n+++ b/server/modules/common/pubsub.provider.ts\n@@ -0,0 +1 @@\n+export { PubSub } from 'apollo-server-express';\n\\ No newline at end of file\ndiff --git a/server/modules/users/auth.provider.ts b/server/modules/users/auth.provider.ts\nnew file mode 100644\nindex 0000000..a781b82\n--- /dev/null\n+++ b/server/modules/users/auth.provider.ts\n@@ -0,0 +1,89 @@\n+import { Injectable, Inject, ProviderScope } from '@graphql-modules/di';\n+import { ModuleSessionInfo } from '@graphql-modules/core';\n+import { Response } from 'express';\n+import bcrypt from 'bcrypt';\n+import jwt from 'jsonwebtoken';\n+import { secret, expiration } from '../../env';\n+import { validateLength, validatePassword } from '../../validators';\n+import { Users } from './users.provider';\n+import { User } from '../../db';\n+\n+@Injectable({\n+  scope: ProviderScope.Session,\n+})\n+export class Auth {\n+  @Inject() private users: Users;\n+  @Inject() private module: ModuleSessionInfo;\n+\n+  private get req() {\n+    return this.module.session.req;\n+  }\n+\n+  private get res(): Response {\n+    return this.module.session.res;\n+  }\n+\n+  async signIn({ username, password }: { username: string; password: string }) {\n+    const user = await this.users.findByUsername(username);\n+\n+    if (!user) {\n+      throw new Error('user not found');\n+    }\n+\n+    const passwordsMatch = bcrypt.compareSync(password, user.password);\n+\n+    if (!passwordsMatch) {\n+      throw new Error('password is incorrect');\n+    }\n+\n+    const authToken = jwt.sign(username, secret);\n+\n+    this.res.cookie('authToken', authToken, { maxAge: expiration });\n+\n+    return user;\n+  }\n+\n+  async signUp({\n+    name,\n+    password,\n+    passwordConfirm,\n+    username,\n+  }: {\n+    name: string;\n+    password: string;\n+    passwordConfirm: string;\n+    username: string;\n+  }) {\n+    validateLength('req.name', name, 3, 50);\n+    validateLength('req.username', name, 3, 18);\n+    validatePassword('req.password', password);\n+\n+    if (password !== passwordConfirm) {\n+      throw Error(\"req.password and req.passwordConfirm don't match\");\n+    }\n+\n+    const existingUser = await this.users.findByUsername(username);\n+\n+    if (existingUser) {\n+      throw Error('username already exists');\n+    }\n+\n+    return this.users.newUser({\n+      username,\n+      name,\n+      password,\n+    });\n+  }\n+\n+  async currentUser(): Promise<User | null> {\n+    if (this.req.cookies.authToken) {\n+      const username = jwt.verify(this.req.cookies.authToken, secret) as string;\n+\n+      if (username) {\n+        return this.users.findByUsername(username);\n+      }\n+    }\n+\n+    return null;\n+  }\n+}\n\\ No newline at end of file\ndiff --git a/server/modules/users/index.ts b/server/modules/users/index.ts\nnew file mode 100644\nindex 0000000..93e30ea\n--- /dev/null\n+++ b/server/modules/users/index.ts\n@@ -0,0 +1,61 @@\n+import { GraphQLModule } from '@graphql-modules/core';\n+import { gql } from 'apollo-server-express';\n+import commonModule from '../common';\n+import { Resolvers } from '../../types/graphql';\n+import { Users } from './users.provider';\n+import { Auth } from './auth.provider';\n+\n+const typeDefs = gql`\n+  type User {\n+    id: ID!\n+    name: String!\n+    picture: String\n+  }\n+\n+  extend type Query {\n+    me: User\n+    users: [User!]!\n+  }\n+\n+  extend type Mutation {\n+    signIn(username: String!, password: String!): User\n+    signUp(\n+      name: String!\n+      username: String!\n+      password: String!\n+      passwordConfirm: String!\n+    ): User\n+  }\n+`;\n+\n+const resolvers: Resolvers = {\n+  Query: {\n+    me(root, args, { injector }) {\n+      return injector.get(Auth).currentUser();\n+    },\n+    async users(root, args, { injector }) {\n+      const currentUser = await injector.get(Auth).currentUser();\n+\n+      if (!currentUser) return [];\n+\n+      return injector.get(Users).findAllExcept(currentUser.id);\n+    },\n+  },\n+  Mutation: {\n+    async signIn(root, { username, password }, { injector }) {\n+      return injector.get(Auth).signIn({username, password});\n+    },\n+\n+    async signUp(root, { name, username, password, passwordConfirm }, { injector }) {\n+      return injector.get(Auth).signUp({name, username, password, passwordConfirm });\n+    },\n+  },\n+};\n+\n+export default new GraphQLModule({\n+  name: 'users',\n+  typeDefs,\n+  resolvers,\n+  imports: () => [commonModule],\n+  providers: () => [Users, Auth]\n+});\ndiff --git a/server/modules/users/users.provider.ts b/server/modules/users/users.provider.ts\nnew file mode 100644\nindex 0000000..daf32fd\n--- /dev/null\n+++ b/server/modules/users/users.provider.ts\n@@ -0,0 +1,59 @@\n+import { Injectable, Inject, ProviderScope } from '@graphql-modules/di';\n+import sql from 'sql-template-strings';\n+import bcrypt from 'bcrypt';\n+import { Database } from '../common/database.provider';\n+\n+@Injectable({\n+  scope: ProviderScope.Session,\n+})\n+export class Users {\n+  @Inject() private db: Database;\n+\n+  async findById(userId: string) {\n+    const db = await this.db.getClient();\n+    const { rows } = await db.query(\n+      sql`SELECT * FROM users WHERE id = ${userId}`,\n+    );\n+\n+    return rows[0] || null;\n+  }\n+\n+  async findAllExcept(userId: string) {\n+    const db = await this.db.getClient();\n+    const { rows } = await db.query(\n+      sql`SELECT * FROM users WHERE id != ${userId}`,\n+    );\n+\n+    return rows;\n+  }\n+\n+  async findByUsername(username: string) {\n+    const db = await this.db.getClient();\n+    const { rows } = await db.query(\n+      sql`SELECT * FROM users WHERE username = ${username}`,\n+    );\n+\n+    return rows[0] || null;\n+  }\n+\n+  async newUser({\n+    username,\n+    name,\n+    password,\n+  }: {\n+    username: string;\n+    name: string;\n+    password: string;\n+  }) {\n+    const db = await this.db.getClient();\n+    const passwordHash = bcrypt.hashSync(password, bcrypt.genSaltSync(8));\n+    const createdUserQuery = await db.query(sql`\n+        INSERT INTO users(password, picture, username, name)\n+        VALUES(${passwordHash}, '', ${username}, ${name})\n+        RETURNING *\n+      `);\n+    const user = createdUserQuery.rows[0];\n+\n+    return user;\n+  }\n+}\n\\ No newline at end of file\ndiff --git a/server/package.json b/server/package.json\nnew file mode 100644\nindex 0000000..30019b0\n--- /dev/null\n+++ b/server/package.json\n@@ -0,0 +1,64 @@\n+{\n+  \"name\": \"whatsapp-clone-server\",\n+  \"description\": \"A newly created Tortilla project\",\n+  \"repository\": {\n+    \"type\": \"git\",\n+    \"url\": \"https://github.com/Urigo/WhatsApp-Clone-Server.git\"\n+  },\n+  \"private\": true,\n+  \"scripts\": {\n+    \"start\": \"ts-node index.ts\",\n+    \"test\": \"jest --runInBand\",\n+    \"codegen\": \"gql-gen\"\n+  },\n+  \"devDependencies\": {\n+    \"@graphql-codegen/cli\": \"1.0.3\",\n+    \"@graphql-codegen/typescript\": \"1.0.3\",\n+    \"@graphql-codegen/typescript-resolvers\": \"1.0.3\",\n+    \"@types/bcrypt\": \"3.0.0\",\n+    \"@types/body-parser\": \"1.17.0\",\n+    \"@types/cookie-parser\": \"1.4.1\",\n+    \"@types/cors\": \"2.8.4\",\n+    \"@types/express\": \"4.16.1\",\n+    \"@types/graphql\": \"14.0.7\",\n+    \"@types/graphql-iso-date\": \"3.3.1\",\n+    \"@types/jest\": \"24.0.11\",\n+    \"@types/jsonwebtoken\": \"8.3.2\",\n+    \"@types/lodash\": \"4.14.126\",\n+    \"@types/node\": \"11.11.0\",\n+    \"@types/pg\": \"^7.4.14\",\n+    \"jest\": \"24.5.0\",\n+    \"ts-jest\": \"24.0.0\",\n+    \"ts-node\": \"8.0.3\",\n+    \"typescript\": \"3.3.3333\"\n+  },\n+  \"dependencies\": {\n+    \"@graphql-modules/core\": \"0.7.1\",\n+    \"@graphql-modules/di\": \"0.7.1\",\n+    \"@safe-api/middleware\": \"^0.0.2\",\n+    \"apollo-datasource-rest\": \"^0.4.0\",\n+    \"apollo-server-express\": \"2.4.8\",\n+    \"apollo-server-testing\": \"2.4.8\",\n+    \"axios\": \"0.18.0\",\n+    \"bcrypt\": \"3.0.5\",\n+    \"body-parser\": \"1.18.3\",\n+    \"cookie-parser\": \"1.4.4\",\n+    \"cors\": \"2.8.5\",\n+    \"express\": \"4.16.4\",\n+    \"graphql\": \"14.1.1\",\n+    \"graphql-import\": \"0.7.1\",\n+    \"graphql-iso-date\": \"3.6.1\",\n+    \"graphql-postgres-subscriptions\": \"^1.0.5\",\n+    \"graphql-tools\": \"4.0.4\",\n+    \"jsonwebtoken\": \"8.5.1\",\n+    \"lodash\": \"4.17.11\",\n+    \"pg\": \"^7.10.0\",\n+    \"reflect-metadata\": \"0.1.13\",\n+    \"sql-template-strings\": \"^2.2.2\"\n+  },\n+  \"jest\": {\n+    \"transform\": {\n+      \"^.+\\\\.(js|jsx|ts|tsx)$\": \"<rootDir>/node_modules/ts-jest\"\n+    }\n+  }\n+}\ndiff --git a/server/renovate.json b/server/renovate.json\nnew file mode 100644\nindex 0000000..216ef3c\n--- /dev/null\n+++ b/server/renovate.json\n@@ -0,0 +1,23 @@\n+{\n+    \"extends\": [\"config:base\", \":rebaseStalePrs\"],\n+    \"baseBranches\": [\n+      \"master\",\n+      \"master-root\",\n+      \"master-step1\",\n+      \"master-step2\",\n+      \"master-step3\",\n+      \"master-step4\",\n+      \"master-step5\",\n+      \"master-step6\",\n+      \"master-step7\",\n+      \"master-step8\",\n+      \"master-step9\",\n+      \"master-step10\",\n+      \"master-step11\",\n+      \"master-step12\",\n+      \"master-step13\"\n+    ],\n+    \"prHourlyLimit\": 60,\n+    \"recreateClosed\": true,\n+    \"rangeStrategy\": \"lockfile-update\"\n+  }\n\\ No newline at end of file\ndiff --git a/server/server.ts b/server/server.ts\nnew file mode 100644\nindex 0000000..43e68ac\n--- /dev/null\n+++ b/server/server.ts\n@@ -0,0 +1,16 @@\n+import 'reflect-metadata';\n+import { ApolloServer } from 'apollo-server-express'\n+import { GraphQLModule } from '@graphql-modules/core'\n+\n+import usersModule from './modules/users'\n+import chatsModule from './modules/chats'\n+\n+export const rootModule = new GraphQLModule({\n+  name: 'root',\n+  imports: [usersModule, chatsModule]\n+})\n+\n+export const server = new ApolloServer({\n+  schema: rootModule.schema,\n+  context: rootModule.context\n+})\ndiff --git a/server/tests/mocks/auth.provider.ts b/server/tests/mocks/auth.provider.ts\nnew file mode 100644\nindex 0000000..074f62c\n--- /dev/null\n+++ b/server/tests/mocks/auth.provider.ts\n@@ -0,0 +1,21 @@\n+import sql from 'sql-template-strings';\n+import { Auth } from './../../modules/users/auth.provider';\n+import usersModule from './../../modules/users';\n+import { pool } from '../../db';\n+\n+export function mockAuth(userId: number) {\n+  class AuthMock extends Auth {\n+    async currentUser() {\n+      const { rows } = await pool.query(\n+        sql`SELECT * FROM users WHERE id = ${userId}`,\n+      );\n+      return rows[0];\n+    }\n+  }\n+\n+  usersModule.injector.provide({\n+    provide: Auth,\n+    useClass: AuthMock,\n+    overwrite: true,\n+  });\n+}\n\\ No newline at end of file\ndiff --git a/server/tests/mutations/__snapshots__/addChat.test.ts.snap b/server/tests/mutations/__snapshots__/addChat.test.ts.snap\nnew file mode 100644\nindex 0000000..d1d9f44\n--- /dev/null\n+++ b/server/tests/mutations/__snapshots__/addChat.test.ts.snap\n@@ -0,0 +1,52 @@\n+// Jest Snapshot v1, https://goo.gl/fbAQLP\n+\n+exports[`Mutation.addChat creates a new chat between current user and specified recipient 1`] = `\n+Object {\n+  \"addChat\": Object {\n+    \"id\": \"5\",\n+    \"name\": \"Bryan Wallace\",\n+    \"participants\": Array [\n+      Object {\n+        \"id\": \"2\",\n+      },\n+      Object {\n+        \"id\": \"3\",\n+      },\n+    ],\n+  },\n+}\n+`;\n+\n+exports[`Mutation.addChat creates a new chat between current user and specified recipient 2`] = `\n+Object {\n+  \"chat\": Object {\n+    \"id\": \"5\",\n+    \"name\": \"Bryan Wallace\",\n+    \"participants\": Array [\n+      Object {\n+        \"id\": \"2\",\n+      },\n+      Object {\n+        \"id\": \"3\",\n+      },\n+    ],\n+  },\n+}\n+`;\n+\n+exports[`Mutation.addChat returns the existing chat if so 1`] = `\n+Object {\n+  \"addChat\": Object {\n+    \"id\": \"1\",\n+    \"name\": \"Ethan Gonzalez\",\n+    \"participants\": Array [\n+      Object {\n+        \"id\": \"1\",\n+      },\n+      Object {\n+        \"id\": \"2\",\n+      },\n+    ],\n+  },\n+}\n+`;\ndiff --git a/server/tests/mutations/__snapshots__/addMessage.test.ts.snap b/server/tests/mutations/__snapshots__/addMessage.test.ts.snap\nnew file mode 100644\nindex 0000000..0e88349\n--- /dev/null\n+++ b/server/tests/mutations/__snapshots__/addMessage.test.ts.snap\n@@ -0,0 +1,22 @@\n+// Jest Snapshot v1, https://goo.gl/fbAQLP\n+\n+exports[`Mutation.addMessage should add message to specified chat 1`] = `\n+Object {\n+  \"addMessage\": Object {\n+    \"content\": \"Hello World\",\n+    \"id\": \"5\",\n+  },\n+}\n+`;\n+\n+exports[`Mutation.addMessage should add message to specified chat 2`] = `\n+Object {\n+  \"chat\": Object {\n+    \"id\": \"1\",\n+    \"lastMessage\": Object {\n+      \"content\": \"Hello World\",\n+      \"id\": \"5\",\n+    },\n+  },\n+}\n+`;\ndiff --git a/server/tests/mutations/addChat.test.ts b/server/tests/mutations/addChat.test.ts\nnew file mode 100644\nindex 0000000..ad369f2\n--- /dev/null\n+++ b/server/tests/mutations/addChat.test.ts\n@@ -0,0 +1,78 @@\n+import { createTestClient } from 'apollo-server-testing'\n+import { gql } from 'apollo-server-express'\n+import { server } from '../../server';\n+import { resetDb } from '../../db'\n+import { mockAuth } from '../mocks/auth.provider';\n+\n+describe('Mutation.addChat', () => {\n+  beforeEach(resetDb)\n+\n+  it('creates a new chat between current user and specified recipient', async () => {\n+    mockAuth(2);\n+\n+    const { query, mutate } = createTestClient(server)\n+\n+    const addChatRes = await mutate({\n+      variables: { recipientId: '3' },\n+      mutation: gql `\n+        mutation AddChat($recipientId: ID!) {\n+          addChat(recipientId: $recipientId) {\n+            id\n+            name\n+            participants {\n+              id\n+            }\n+          }\n+        }\n+      `,\n+    })\n+\n+    expect(addChatRes.data).toBeDefined()\n+    expect(addChatRes.errors).toBeUndefined()\n+    expect(addChatRes.data).toMatchSnapshot()\n+\n+    const getChatRes = await query({\n+      variables: { chatId: '5' },\n+      query: gql `\n+        query GetChat($chatId: ID!) {\n+          chat(chatId: $chatId) {\n+            id\n+            name\n+            participants {\n+              id\n+            }\n+          }\n+        }\n+      `,\n+    })\n+\n+    expect(getChatRes.data).toBeDefined()\n+    expect(getChatRes.errors).toBeUndefined()\n+    expect(getChatRes.data).toMatchSnapshot()\n+  })\n+\n+  it('returns the existing chat if so', async () => {\n+    mockAuth(1);\n+\n+    const { query, mutate } = createTestClient(server)\n+\n+    const addChatRes = await mutate({\n+      variables: { recipientId: '2' },\n+      mutation: gql `\n+        mutation AddChat($recipientId: ID!) {\n+          addChat(recipientId: $recipientId) {\n+            id\n+            name\n+            participants {\n+              id\n+            }\n+          }\n+        }\n+      `,\n+    })\n+\n+    expect(addChatRes.data).toBeDefined()\n+    expect(addChatRes.errors).toBeUndefined()\n+    expect(addChatRes.data).toMatchSnapshot()\n+  })\n+})\ndiff --git a/server/tests/mutations/addMessage.test.ts b/server/tests/mutations/addMessage.test.ts\nnew file mode 100644\nindex 0000000..ec98e08\n--- /dev/null\n+++ b/server/tests/mutations/addMessage.test.ts\n@@ -0,0 +1,50 @@\n+import { createTestClient } from 'apollo-server-testing'\n+import { gql } from 'apollo-server-express'\n+import { server } from '../../server';\n+import { resetDb } from '../../db'\n+import { mockAuth } from '../mocks/auth.provider';\n+\n+describe('Mutation.addMessage', () => {\n+  beforeEach(resetDb)\n+\n+  it('should add message to specified chat', async () => {\n+    mockAuth(1);\n+\n+    const { query, mutate } = createTestClient(server)\n+\n+    const addMessageRes = await mutate({\n+      variables: { chatId: '1', content: 'Hello World' },\n+      mutation: gql `\n+        mutation AddMessage($chatId: ID!, $content: String!) {\n+          addMessage(chatId: $chatId, content: $content) {\n+            id\n+            content\n+          }\n+        }\n+      `,\n+    })\n+\n+    expect(addMessageRes.data).toBeDefined()\n+    expect(addMessageRes.errors).toBeUndefined()\n+    expect(addMessageRes.data).toMatchSnapshot()\n+\n+    const getChatRes = await query({\n+      variables: { chatId: '1' },\n+      query: gql `\n+        query GetChat($chatId: ID!) {\n+          chat(chatId: $chatId) {\n+            id\n+            lastMessage {\n+              id\n+              content\n+            }\n+          }\n+        }\n+      `,\n+    })\n+\n+    expect(getChatRes.data).toBeDefined()\n+    expect(getChatRes.errors).toBeUndefined()\n+    expect(getChatRes.data).toMatchSnapshot()\n+  })\n+})\ndiff --git a/server/tests/mutations/removeChat.test.ts b/server/tests/mutations/removeChat.test.ts\nnew file mode 100644\nindex 0000000..010232d\n--- /dev/null\n+++ b/server/tests/mutations/removeChat.test.ts\n@@ -0,0 +1,47 @@\n+import { createTestClient } from 'apollo-server-testing'\n+import { gql } from 'apollo-server-express'\n+import { server } from '../../server';\n+import { resetDb } from '../../db'\n+import { mockAuth } from '../mocks/auth.provider';\n+\n+describe('Mutation.removeChat', () => {\n+  beforeEach(resetDb)\n+\n+  it('removes chat by id', async () => {\n+    mockAuth(1);\n+\n+    const { query, mutate } = createTestClient(server)\n+\n+    const addChatRes = await mutate({\n+      variables: { chatId: '1' },\n+      mutation: gql `\n+        mutation RemoveChat($chatId: ID!) {\n+          removeChat(chatId: $chatId)\n+        }\n+      `,\n+    })\n+\n+    expect(addChatRes.data).toBeDefined()\n+    expect(addChatRes.errors).toBeUndefined()\n+    expect(addChatRes.data!.removeChat).toEqual('1')\n+\n+    const getChatRes = await query({\n+      variables: { chatId: '1' },\n+      query: gql `\n+        query GetChat($chatId: ID!) {\n+          chat(chatId: $chatId) {\n+            id\n+            name\n+            participants {\n+              id\n+            }\n+          }\n+        }\n+      `,\n+    })\n+\n+    expect(addChatRes.data).toBeDefined()\n+    expect(getChatRes.errors).toBeUndefined()\n+    expect(addChatRes.data!.chat).toBeUndefined()\n+  })\n+})\ndiff --git a/server/tests/queries/__snapshots__/getChat.test.ts.snap b/server/tests/queries/__snapshots__/getChat.test.ts.snap\nnew file mode 100644\nindex 0000000..64b1e2b\n--- /dev/null\n+++ b/server/tests/queries/__snapshots__/getChat.test.ts.snap\n@@ -0,0 +1,16 @@\n+// Jest Snapshot v1, https://goo.gl/fbAQLP\n+\n+exports[`Query.chat should fetch specified chat 1`] = `\n+Object {\n+  \"chat\": Object {\n+    \"id\": \"1\",\n+    \"lastMessage\": Object {\n+      \"content\": \"You on your way?\",\n+      \"createdAt\": \"2018-12-31T06:20:00.000Z\",\n+      \"id\": \"1\",\n+    },\n+    \"name\": \"Ethan Gonzalez\",\n+    \"picture\": \"https://randomuser.me/api/portraits/thumb/men/1.jpg\",\n+  },\n+}\n+`;\ndiff --git a/server/tests/queries/__snapshots__/getChats.test.ts.snap b/server/tests/queries/__snapshots__/getChats.test.ts.snap\nnew file mode 100644\nindex 0000000..1bd3a67\n--- /dev/null\n+++ b/server/tests/queries/__snapshots__/getChats.test.ts.snap\n@@ -0,0 +1,48 @@\n+// Jest Snapshot v1, https://goo.gl/fbAQLP\n+\n+exports[`Query.chats should fetch all chats 1`] = `\n+Object {\n+  \"chats\": Array [\n+    Object {\n+      \"id\": \"1\",\n+      \"lastMessage\": Object {\n+        \"content\": \"You on your way?\",\n+        \"createdAt\": \"2018-12-31T06:20:00.000Z\",\n+        \"id\": \"1\",\n+      },\n+      \"name\": \"Ethan Gonzalez\",\n+      \"picture\": \"https://randomuser.me/api/portraits/thumb/men/1.jpg\",\n+    },\n+    Object {\n+      \"id\": \"2\",\n+      \"lastMessage\": Object {\n+        \"content\": \"Hey, it's me\",\n+        \"createdAt\": \"2018-12-30T13:40:00.000Z\",\n+        \"id\": \"2\",\n+      },\n+      \"name\": \"Bryan Wallace\",\n+      \"picture\": \"https://randomuser.me/api/portraits/thumb/men/2.jpg\",\n+    },\n+    Object {\n+      \"id\": \"3\",\n+      \"lastMessage\": Object {\n+        \"content\": \"I should buy a boat\",\n+        \"createdAt\": \"2018-12-15T07:00:00.000Z\",\n+        \"id\": \"3\",\n+      },\n+      \"name\": \"Avery Stewart\",\n+      \"picture\": \"https://randomuser.me/api/portraits/thumb/women/1.jpg\",\n+    },\n+    Object {\n+      \"id\": \"4\",\n+      \"lastMessage\": Object {\n+        \"content\": \"This is wicked good ice cream.\",\n+        \"createdAt\": \"2018-05-12T15:00:00.000Z\",\n+        \"id\": \"4\",\n+      },\n+      \"name\": \"Katie Peterson\",\n+      \"picture\": \"https://randomuser.me/api/portraits/thumb/women/2.jpg\",\n+    },\n+  ],\n+}\n+`;\ndiff --git a/server/tests/queries/__snapshots__/getMe.test.ts.snap b/server/tests/queries/__snapshots__/getMe.test.ts.snap\nnew file mode 100644\nindex 0000000..8f5621e\n--- /dev/null\n+++ b/server/tests/queries/__snapshots__/getMe.test.ts.snap\n@@ -0,0 +1,11 @@\n+// Jest Snapshot v1, https://goo.gl/fbAQLP\n+\n+exports[`Query.me should fetch current user 1`] = `\n+Object {\n+  \"me\": Object {\n+    \"id\": \"1\",\n+    \"name\": \"Ray Edwards\",\n+    \"picture\": \"https://randomuser.me/api/portraits/thumb/lego/1.jpg\",\n+  },\n+}\n+`;\ndiff --git a/server/tests/queries/__snapshots__/getUsers.test.ts.snap b/server/tests/queries/__snapshots__/getUsers.test.ts.snap\nnew file mode 100644\nindex 0000000..a2fd9bd\n--- /dev/null\n+++ b/server/tests/queries/__snapshots__/getUsers.test.ts.snap\n@@ -0,0 +1,55 @@\n+// Jest Snapshot v1, https://goo.gl/fbAQLP\n+\n+exports[`Query.getUsers should fetch all users except the one signed-in 1`] = `\n+Object {\n+  \"users\": Array [\n+    Object {\n+      \"id\": \"2\",\n+      \"name\": \"Ethan Gonzalez\",\n+      \"picture\": \"https://randomuser.me/api/portraits/thumb/men/1.jpg\",\n+    },\n+    Object {\n+      \"id\": \"3\",\n+      \"name\": \"Bryan Wallace\",\n+      \"picture\": \"https://randomuser.me/api/portraits/thumb/men/2.jpg\",\n+    },\n+    Object {\n+      \"id\": \"4\",\n+      \"name\": \"Avery Stewart\",\n+      \"picture\": \"https://randomuser.me/api/portraits/thumb/women/1.jpg\",\n+    },\n+    Object {\n+      \"id\": \"5\",\n+      \"name\": \"Katie Peterson\",\n+      \"picture\": \"https://randomuser.me/api/portraits/thumb/women/2.jpg\",\n+    },\n+  ],\n+}\n+`;\n+\n+exports[`Query.getUsers should fetch all users except the one signed-in 2`] = `\n+Object {\n+  \"users\": Array [\n+    Object {\n+      \"id\": \"1\",\n+      \"name\": \"Ray Edwards\",\n+      \"picture\": \"https://randomuser.me/api/portraits/thumb/lego/1.jpg\",\n+    },\n+    Object {\n+      \"id\": \"3\",\n+      \"name\": \"Bryan Wallace\",\n+      \"picture\": \"https://randomuser.me/api/portraits/thumb/men/2.jpg\",\n+    },\n+    Object {\n+      \"id\": \"4\",\n+      \"name\": \"Avery Stewart\",\n+      \"picture\": \"https://randomuser.me/api/portraits/thumb/women/1.jpg\",\n+    },\n+    Object {\n+      \"id\": \"5\",\n+      \"name\": \"Katie Peterson\",\n+      \"picture\": \"https://randomuser.me/api/portraits/thumb/women/2.jpg\",\n+    },\n+  ],\n+}\n+`;\ndiff --git a/server/tests/queries/getChat.test.ts b/server/tests/queries/getChat.test.ts\nnew file mode 100644\nindex 0000000..0e63918\n--- /dev/null\n+++ b/server/tests/queries/getChat.test.ts\n@@ -0,0 +1,37 @@\n+import { createTestClient } from 'apollo-server-testing'\n+import { gql } from 'apollo-server-express'\n+import { server } from '../../server';\n+import { resetDb } from '../../db';\n+import { mockAuth } from '../mocks/auth.provider';\n+\n+describe('Query.chat', () => {\n+  beforeEach(resetDb)\n+\n+  it('should fetch specified chat', async () => {\n+    mockAuth(1);\n+\n+    const { query } = createTestClient(server)\n+\n+    const res = await query({\n+      variables: { chatId: '1' },\n+      query: gql `\n+        query GetChat($chatId: ID!) {\n+          chat(chatId: $chatId) {\n+            id\n+            name\n+            picture\n+            lastMessage {\n+              id\n+              content\n+              createdAt\n+            }\n+          }\n+        }\n+      `,\n+    })\n+\n+    expect(res.data).toBeDefined()\n+    expect(res.errors).toBeUndefined()\n+    expect(res.data).toMatchSnapshot()\n+  })\n+})\ndiff --git a/server/tests/queries/getChats.test.ts b/server/tests/queries/getChats.test.ts\nnew file mode 100644\nindex 0000000..171aa10\n--- /dev/null\n+++ b/server/tests/queries/getChats.test.ts\n@@ -0,0 +1,36 @@\n+import { createTestClient } from 'apollo-server-testing'\n+import { gql } from 'apollo-server-express'\n+import { server } from '../../server';\n+import { resetDb } from '../../db';\n+import { mockAuth } from '../mocks/auth.provider';\n+\n+describe('Query.chats', () => {\n+  beforeEach(resetDb)\n+\n+  it('should fetch all chats', async () => {\n+    mockAuth(1);\n+\n+    const { query } = createTestClient(server)\n+\n+    const res = await query({\n+      query: gql `\n+        query GetChats {\n+          chats {\n+            id\n+            name\n+            picture\n+            lastMessage {\n+              id\n+              content\n+              createdAt\n+            }\n+          }\n+        }\n+      `,\n+    })\n+\n+    expect(res.data).toBeDefined()\n+    expect(res.errors).toBeUndefined()\n+    expect(res.data).toMatchSnapshot()\n+  })\n+})\ndiff --git a/server/tests/queries/getMe.test.ts b/server/tests/queries/getMe.test.ts\nnew file mode 100644\nindex 0000000..022c28e\n--- /dev/null\n+++ b/server/tests/queries/getMe.test.ts\n@@ -0,0 +1,31 @@\n+import { createTestClient } from 'apollo-server-testing'\n+import { gql } from 'apollo-server-express'\n+import { server } from '../../server';\n+import { resetDb } from '../../db';\n+import { mockAuth } from '../mocks/auth.provider';\n+\n+describe('Query.me', () => {\n+  beforeEach(resetDb)\n+\n+  it('should fetch current user', async () => {\n+    mockAuth(1)\n+\n+    const { query } = createTestClient(server)\n+\n+    const res = await query({\n+      query: gql `\n+        query GetMe {\n+          me {\n+            id\n+            name\n+            picture\n+          }\n+        }\n+      `,\n+    })\n+\n+    expect(res.data).toBeDefined()\n+    expect(res.errors).toBeUndefined()\n+    expect(res.data).toMatchSnapshot()\n+  })\n+})\ndiff --git a/server/tests/queries/getUsers.test.ts b/server/tests/queries/getUsers.test.ts\nnew file mode 100644\nindex 0000000..47ac87a\n--- /dev/null\n+++ b/server/tests/queries/getUsers.test.ts\n@@ -0,0 +1,49 @@\n+import { createTestClient } from 'apollo-server-testing'\n+import { gql } from 'apollo-server-express'\n+import { server } from '../../server';\n+import { resetDb } from '../../db';\n+import { mockAuth } from '../mocks/auth.provider';\n+\n+describe('Query.getUsers', () => {\n+  beforeEach(resetDb)\n+\n+  it('should fetch all users except the one signed-in', async () => {\n+    mockAuth(1);\n+\n+    const { query } = createTestClient(server)\n+\n+    let res = await query({\n+      query: gql `\n+        query GetUsers {\n+          users {\n+            id\n+            name\n+            picture\n+          }\n+        }\n+      `,\n+    })\n+\n+    expect(res.data).toBeDefined()\n+    expect(res.errors).toBeUndefined()\n+    expect(res.data).toMatchSnapshot()\n+\n+    mockAuth(2);\n+\n+    res = await query({\n+      query: gql `\n+        query GetUsers {\n+          users {\n+            id\n+            name\n+            picture\n+          }\n+        }\n+      `,\n+    })\n+\n+    expect(res.data).toBeDefined()\n+    expect(res.errors).toBeUndefined()\n+    expect(res.data).toMatchSnapshot()\n+  })\n+})\ndiff --git a/server/tsconfig.json b/server/tsconfig.json\nnew file mode 100644\nindex 0000000..fe56553\n--- /dev/null\n+++ b/server/tsconfig.json\n@@ -0,0 +1,16 @@\n+{\n+  \"compilerOptions\": {\n+    \"target\": \"es2018\",\n+    \"module\": \"commonjs\",\n+    \"lib\": [\n+      \"es2018\",\n+      \"esnext.asynciterable\"\n+    ],\n+    \"strict\": true,\n+    \"strictFunctionTypes\": false,\n+    \"strictPropertyInitialization\": false,\n+    \"esModuleInterop\": true,\n+    \"experimentalDecorators\": true,\n+    \"emitDecoratorMetadata\": true\n+  }\n+}\ndiff --git a/server/types/apollo-server-testing.d.ts b/server/types/apollo-server-testing.d.ts\nnew file mode 100644\nindex 0000000..e9d9b94\n--- /dev/null\n+++ b/server/types/apollo-server-testing.d.ts\n@@ -0,0 +1,27 @@\n+declare module 'apollo-server-testing' {\n+  import { ApolloServerBase } from 'apollo-server-core';\n+  import { print, DocumentNode } from 'graphql';\n+  import { GraphQLResponse } from 'graphql-extensions';\n+\n+  type StringOrAst = string | DocumentNode;\n+\n+  // A query must not come with a mutation (and vice versa).\n+  type Query<TVariables> = {\n+    query: StringOrAst;\n+    mutation?: undefined;\n+    variables?: TVariables;\n+  };\n+\n+  type Mutation<TVariables> = {\n+    mutation: StringOrAst;\n+    query?: undefined;\n+    variables?: TVariables;\n+  };\n+\n+  export const createTestClient: <TVariables>(\n+    server: ApolloServerBase,\n+  ) => {\n+    query: (query: Query<TVariables>) => Promise<GraphQLResponse>;\n+    mutate: (mutation: Mutation<TVariables>) => Promise<GraphQLResponse>;\n+  };\n+}\ndiff --git a/server/validators.ts b/server/validators.ts\nnew file mode 100644\nindex 0000000..341d955\n--- /dev/null\n+++ b/server/validators.ts\n@@ -0,0 +1,43 @@\n+export const validatePassword = (ctx: string, str: string) => {\n+  if (typeof str !== 'string') {\n+    throw TypeError(`${ctx} must be a string`)\n+  }\n+\n+  validateLength(ctx, str, 8, 30)\n+\n+  if (!/[a-zA-Z]+/.test(str)) {\n+    throw TypeError(`${ctx} must contain english letters`)\n+  }\n+\n+  if (!/\\d+/.test(str)) {\n+    throw TypeError(`${ctx} must contain numbers`)\n+  }\n+\n+  if (!/[^\\da-zA-Z]+/.test(str)) {\n+    throw TypeError(`${ctx} must contain special charachters`)\n+  }\n+}\n+\n+export const validateLength = (ctx: string, str: string, ...args: number[]) => {\n+  let min, max\n+\n+  if (args.length === 1) {\n+    min = 0\n+    max = args[0]\n+  } else {\n+    min = args[0]\n+    max = args[1]\n+  }\n+\n+  if (typeof str !== 'string') {\n+    throw TypeError(`${ctx} must be a string`)\n+  }\n+\n+  if (str.length < min) {\n+    throw TypeError(`${ctx} must be at least ${min} chars long`)\n+  }\n+\n+  if (str.length > max) {\n+    throw TypeError(`${ctx} must contain ${max} chars at most`)\n+  }\n+}\n",
        "manuals": [
          {
            "manualTitle": "Whatsapp Clone Tutorial",
            "stepRevision": "b730e902f078ad498ac130dc99ec5e523a32f139",
            "manualView": "![whatsapp-clone](https://user-images.githubusercontent.com/7648874/54141944-9f801a80-4461-11e9-85a1-bcb161d9a6c6.png)\n\nWhatsapp Clone is a free and open-source tutorial that will guide you step-by-step on how to create a full-stack,\nmobile, hybrid web application from scratch.\n\nThe software world is evolving quickly, and oftentimes people find themselves left behind, even the most experienced ones.\nThe purpose of this tutorial is not only to demonstrate how to create a full application with the latest technologies, but also\nto keep up to date with the ever-changing development ecosystem.\n\nThis tutorial is for anyone who has ever asked themselves one of the following questions:\n\n- How do people build an app today?\n- What are the currently leading technologies in the ecosystem?\n- What are the best practices for using technology XXX?\n- What is the purpose of technology XXX?\n- How does technology XXX work?\n- How do I use technology XXX?\n- How do I migrate to the new version of technology XXX?\n- Why should I use technology XXX over technology YYY?\n\nAll of the above and more can be answered in the tutorial. Whether youâ€™re a beginner, intermediate or a professional,\nwe will have the answers youâ€™re looking for.\n\n**What technologies does Whatsapp Clone uses?**\n\nThe version of the Whatsapp Clone you are looking at, uses:\n\n- [React (with Hooks and Suspense)](http://react.com)\n- [Styled-Components](https://styled-components.com)\n- [Material-UI](https://material-ui.com)\n- [TypeScript](https://typescriptlang.org)\n- [Apollo GraphQL](https://www.apollographql.com)\n- [GraphQL Code Generator](http://graphql-code-generator.com)\n- [GraphQL Modules](https://graphql-modules.com)\n- [PostgreSQL](https://www.postgresql.org/)\n- [GraphQL Inspector](https://graphql-inspector.com/)\n\nThe point of this tutorial is not to be bound to a certain technology, but rather keep itself aligned with the ecosystem.\nWhen a new technology comes out, and itâ€™s better and more popular, Whatsapp Clone will upgrade to use it (together with full migration instructions).\n\n**P2P tutorial for the community by the community**\n\nKeeping tutorials up to date is not an easy task.\nThat's why we've created the Tortilla Tutorial Framework that makes it easy to write and update tutorials.\nAlso, the WhatsApp clone is completely open source in order for the community to give its feedback, help and fork ideas.\nHere are the repositories the tutorial is made of:\n\n- [Whatsapp Clone - Client](https://github.com/Urigo/WhatsApp-Clone-Client-React)\n- [Whatsapp Clone - Server](https://github.com/Urigo/WhatsApp-Clone-server)\n- [Whatsapp Clone - Script's text](https://github.com/Urigo/WhatsApp-Clone-Tutorial)\n\nWeâ€™ve also made sure to publish some important documents so you can get more involved.\nYou can track our progress and comment your suggestions, since everything is based on Google Docs and is updated live:\n\n- [Road map](https://docs.google.com/document/d/1p2Zio6Js2eoFfHs9CjIMF6jTuNyD4eQEHlgEAKhAqM8/edit?usp=sharing)\n- [Chapter manuals] (https://drive.google.com/open?id=1ITxOniS_S3sgZfunLvtJ1L9P6Fj1YOLlFHhoQPjT3S0)\n\n**Migration instructions included**\n\nThere are many great tutorials out there, but almost none of them shows you what changes you should make in your app in order to be aligned with a new version of a certain technology.\nAs technologies are being updated by the minute, some changes are minor and insignificant,\nbut often times a breaking change will be made in which case we need to know how we can adapt to that change.\nThanks to the [Tortilla platform](https://tortilla.academy), we can provide you with a git-diff that will show you what changes were made between each and every released version of the Whatsapp Clone tutorial since the beginning of history.\nThis way you can easily notice the changes in APIs and migrate your app in no time.\n\n![tutorial-versions-diff](https://user-images.githubusercontent.com/7648874/54142148-0f8ea080-4462-11e9-9522-ec9997b76169.png)\n\n**Prerequisites for WhatsApp Clone**\n\n- JavaScript - https://javascript.info/\n- TypeScript\n- JSX\n- HTML\n- CSS\n- Node.JS\n- npm & Yarn\n- React\n- SQL\n\n> Even if you don't have experience with the technologies above you might be able to start the tutorial and pick things along the way.\n> If you struggle with anything, contact us on the forum or on Github with your questions.\n\nOS operations such as navigating to a folder, or creating a folder, are all gonna be written in Bash, but the instructions are OS agnostic and can be applied on any machine that is web-compatible.\n\nMake sure you have the latest global dependencies on your computer before starting the tutorial:\n\n**[Node](https://nodejs.org/)**\n\nInstall [nvm](https://github.com/nvm-sh/nvm) by running the following command in your command line:\n\n    $ curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.34.0/install.sh | bash\n\nThen install the latest version of Node by running the following:\n\n    $ nvm install node\n\n**[Yarn](https://yarnpkg.com)**\n\nFollow the instructions [here](https://yarnpkg.com/en/docs/install#mac-stable).\n\n\n**Whatâ€™s on the tutorial?**\n\nWhatsapp Clone is built chronologically, from the most basic, to more higher level features, so we recommend you to follow the tutorial in the right order.\nEach step is focused on a different subject, so by the end of it youâ€™ll have a new feature and a new set of knowledge that you can start implementing in your everyday scenario immediately.\n\nIf you feel like you want to skip or focus on a specific subject, on each step you can download the full app code till that point in time.\n\nThat is also useful in case you get stuck.\n\nCurrently, Whatsapp Clone includes the following chapters:\n\n- [Step 1: Creating a basic React APP with a basic view.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/final/.tortilla/manuals/views/step1.md)\n- [Step 2: Styling with Material-UI and Styled-Components.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/final/.tortilla/manuals/views/step2.md)\n- [Step 3: Setting a basic Node.JS server with basic a basic REST endpoint.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/final/.tortilla/manuals/views/step3.md)\n- [Step 4: Transition to GraphQL.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/final/.tortilla/manuals/views/step4.md)\n- [Step 5: Testing.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/final/.tortilla/manuals/views/step5.md)\n- [Step 6: Creating an app router and implementing a chat room.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/final/.tortilla/manuals/views/step6.md)\n- [Step 7: Caching with Apollo-Client.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/final/.tortilla/manuals/views/step7.md)\n- [Step 8: Sending messages with GraphQL mutations.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/final/.tortilla/manuals/views/step8.md)\n- [Step 9: Type safety with GraphQL Code Generator.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/final/.tortilla/manuals/views/step9.md)\n- [Step 10: Live updates with GraphQL subscriptions.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/final/.tortilla/manuals/views/step10.md)\n- [Step 11: Users.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/final/.tortilla/manuals/views/step11.md)\n- [Step 12: Adding and removing chats.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/final/.tortilla/manuals/views/step12.md)\n- [Step 13: Authentication.](https://github.com/Urigo/WhatsApp-Clone-Tutorial/blob/final/.tortilla/manuals/views/step13.md)\n- Step 14: Your choice! Submit a request [here](https://github.com/Urigo/WhatsApp-Clone-Client-React/issues)\n\nWhatsapp Clone is updated on a regular basis, so you should expect more steps and extensions with time.\nYou can keep track of our [road map](https://docs.google.com/document/d/1p2Zio6Js2eoFfHs9CjIMF6jTuNyD4eQEHlgEAKhAqM8/edit?usp=sharing) to see whatâ€™s upcoming."
          },
          {
            "manualTitle": "Step 1: Creating a basic React APP with a basic view",
            "stepRevision": "f47f90a83d7d83a0c40e4a4646cad843ad8a81c3",
            "manualView": "The first thing we will do in the tutorial is to start with the UI (User Interface).\nThat is the visible part of our app that our users will see and interact with.\n\nIn this chapter we will learn how to create a basic React app.\nThe app will contain a basic view that will render a list of conversations within our app.\nWe will gradually create our app, so for now, instead of using real data, we will use in-memory fake data instead of calling a server.\n\nIn order to save time, instead of starting from scratch, we will use a boilerplate to kick-start our application.\nWhen it comes to React apps, the most popular boilerplate is [`create-react-app`](https://github.com/facebook/create-react-app)\nwhich is also officially maintained by Facebook, the creators of [React](https://reactjs.org/).\n\nWe'll launch `create-react-app` using `yarn create` (so we won't need to install `create-react-app` permanently),\nand run the `react-app` command to create the basis for our WhatsApp Clone.\n\nIn your command line, navigate to the folder you want to put your app's folder in and run:\n\n    $ yarn create react-app whatsapp-clone-client --typescript\n\n> Note how we used the `client` postfix. That's because we're planning to create a server as well on later chapters.\n\nIt will create a directory called `whatsapp-clone-client` inside the current folder.\nInside that directory, it will generate the initial project structure and install the needed dependencies.\nNo configuration or complicated folder structures, just the files you need to build your app.\n\n> In our project, we're gonna use [TypeScript](https://www.typescriptlang.org/) (indicated by the `--typescript` command).\n> The main advantage of using TypeScript over using plain JavaScript is that if we want, we get to tell the compiler what types and data structures we expect in certain places,\n> so that the compiler (which unlike a human never forgets) will remind us when we make a mistake and assume something that is not true.\n> The more information we will provide to the compiler, the more the compiler will be able to help us.\n\nOnce the installation is done, you can open your project folder:\n\n\t$ cd whatsapp-clone-client\n\nInside the newly created project, you can run some built-in commands:\n\n\t$ yarn start\n\nRuns the app in development mode. Open `http://localhost:3000` to view it in the browser:\n\n![boilerplate-page](https://user-images.githubusercontent.com/7648874/54026782-025f8080-41da-11e9-9a4e-796fe15e8d03.png)\n\n### create-react-app\n\nLet's look at what create-react-app has created for us in order to understand everything that's going on.\n\nFirst thing, let's look at what webpage is being served to the browser.\nThat webpage in `index.html` that sits under the `public` folder.\n\nAs you can see, this file is a regular HTML file. You will want to edit it's `<title>` to name our real app:\n\n[{]: <helper> (diffStep \"1.1\" files=\"public/index.html\" module=\"client\")\n\n#### Client Step 1.1: Rename the app\n\n##### Changed public&#x2F;index.html\n```diff\n@@ -19,7 +19,7 @@\n â”Š19â”Š19â”Š      work correctly both with client-side routing and a non-root public URL.\n â”Š20â”Š20â”Š      Learn how to configure a non-root public URL by running `npm run build`.\n â”Š21â”Š21â”Š    -->\n-â”Š22â”Š  â”Š    <title>React App</title>\n+â”Š  â”Š22â”Š    <title>WhatsApp Clone</title>\n â”Š23â”Š23â”Š  </head>\n â”Š24â”Š24â”Š  <body>\n â”Š25â”Š25â”Š    <noscript>You need to enable JavaScript to run this app.</noscript>\n```\n\n[}]: #\n\nIn the `public` folder we will place assets that are not going to change, like `favicon.ico`, static images and the HTML templates.\n\nWhen we will prepare to app for production, a script from `create-react-app` will place those assets in a build folder and reference them into the\nHTML template.\n\nAnother file in the `public` folder is the `manifest.json` file that gives browsers information about our app in case the users will install the app permanently on their\nmobile phones or desktop apps.\nYou can read more about it here: https://developers.google.com/web/fundamentals/web-app-manifest/.\n\n[{]: <helper> (diffStep \"1.1\" files=\"public/manifest.json\" module=\"client\")\n\n#### Client Step 1.1: Rename the app\n\n##### Changed public&#x2F;manifest.json\n```diff\n@@ -1,6 +1,6 @@\n â”Š1â”Š1â”Š{\n-â”Š2â”Š â”Š  \"short_name\": \"React App\",\n-â”Š3â”Š â”Š  \"name\": \"Create React App Sample\",\n+â”Š â”Š2â”Š  \"short_name\": \"WhatsApp Clone\",\n+â”Š â”Š3â”Š  \"name\": \"An open source chat app\",\n â”Š4â”Š4â”Š  \"icons\": [\n â”Š5â”Š5â”Š    {\n â”Š6â”Š6â”Š      \"src\": \"favicon.ico\",\n```\n\n[}]: #\n\nNow the HTML file has in it's <body> tag just one `<div id=\"root\"></div>` tag which is empty.\nSo how do we get the nice React logo that is being rendered onto our screen?\n\n`create-react-app` has scripts that will run the `src/index.tsx` file together with our HTML template, so let's look what this file is doing.\nThe important thing to see here is the `React` is calling it's render method and telling it to render the `App` component into a document where `id` equals `root`.\n\nSo now you know where React is coming into our html template.\n\nBut where does the `App` React component comes from and where does `React` itself comes from?\n\nThe `index.tsx` file imports this code from outside of the file using the `import` command.\n\nIn the case of the `App` component, we can see it bring it from the path './App', which is in the same folder ('src').\n\nGetting React, it is simply calling it by name instead of a path. That means that the import will automatically look for a folder named `react` under the `node-modules` folder.\n\n`node-modules` is a default folder which will include all of the libraries we want to use in our app.\n\n[yarn](https://yarnpkg.com) will install those libraries according to the dependencies listed inside the `package.json` file, so let's look into that.\n\nUnder dependencies you can see all the libraries our app currently depends on.\n\nYou can also see other values in there like `scripts`, which will teach `yarn` new commands that we can use.\nThe right side will name the command and the left would be the actual command that it will run.\n\nAnother file that got created is `tsconfig.json`.\nThat file specifies options for the Typescript compiler when it takes our code and transforms it from Typescript into Javascript.\n\nSome noticeable configuration options for that file are:\n\n* `target` - What kind of Javascript should the compilers output? in our case `es5` is the version of Javascript that is supported by many browsers.\nIf you know that your app would run only on newer browsers or a Node environment, you can change that value to a newer version and gain performance improvements.\n* `lib` - If you are using new syntax from Javascript, the compiler can add to it's output libraries that would help you support the new syntax even if the browsers don't know those.\n* `strict` - We can give Typescript a lot of information or not so much. The more we give it the more it can help us. adding the strict option will make the compiler warn us when we won't give it enough information.\n\nFor the full set of options, check out the [official docs](https://www.typescriptlang.org/docs/handbook/compiler-options.html);\n\nNow, let's look at our App's code in `src/App.tsx`.\n\nWe can see that our app is just a function named `App`.\n\n`const App` means we declare a variable named `App` and `const` means it cannot be changed after it has been declared (you can't do `App = XX;` later in the app);\n\nNext we assign App with a function. Something like: `const App = () => {}`.\nThat way of creating functions is called `arrow functions`. It is almost equivalent to `const App = function(){}`.\nSo it is a function that doesn't accept any parameters into it.\n\nThat function returns `jsx`. A visual language from React that describes how our component should look like.\n\nSo all a React component is, is simply a function that returns how it look like.\n\nWe then export this function so that React could import it from `index.tsx`.\n\nIn our own component we will import things like the logo and styles that the component uses and those will be imported together with it each time\nsomething will import our component.\n\nThe last thing we haven't explained is the following part: `App: React.FC`.\nThose are Typescript typings. Everything after `:` describes the types of the `App` variable and has no affect on the behavior and execution of the app.\nIt will tell Typescript what `App` is suppose to look so that in case we make a mistake Typescript will warn us before we get the app running.\n\nSo what are the types of React.FC?  You can check it out inside by using command+click on it's name.\nYou see that it accepts `P` as props into the component and needs to return `React.Element` or `null`.\n\nLet's test this out, add a Typescript interface named `AppProps` and put that it includes a property called `name` of type string.\n\nNow let's try to return something invalid. `\"some string\"`, or `1+1`.\nYou can see that our editor is calling out that there are errors in our code.\n\nYou will encounter those error a lot as you develop.\nAlways read the errors all the way. Understand each sentence there because that will save you a lot of time.\n\nOk we now know the component doesn't get anything into itself so let's make sure the typings reflect that as well.\nThe default for React.FC is that there are no props passed inside so if we'll bring that back but keep sending the `name` value from `index.tsx` in the code, you should now get an error.\n\nThose errors can be very useful when your app grows.\nMake sure to define types on the component itself like we have done now. It would make it easier to identify the issues.\n\nNext, we have `App.css`. This is used to style our App component.\nPlay around with changing some of the values and see how it changes your view.\nRight now the link between the styles and the components is done by class names (`App-header`, etc).\nLater on we'll learn better strategies of sorting our styles and making\nsure they are not touching components that we don't want them to affect.\n\nNext file - `App.test.tsx`.\nThis file contains automatic tests to make sure our app is doing what it's suppose to do.\n\nWe are programmers, that means that many times our job is to take something manual and making it automatic.\nThat's why we should also strive to automate things we do ourselves.\nType checking is one area, testing is another.  If we can automate tests and run them all the time, it can save us a lot of time\nand bring us a lot of confidence that when we change our code, we haven't destroyed anything.\n\nThe testing tool that create-react-app provides us with is [Jest](https://jestjs.io/).\n\nRight now we have only one simple test - it renders the App React component and makes sure nothing crashes.\nRun the test by running `yarn test` in the command line.\n\nNow go and remove the export from the app component. see how the tests picked up immediately that something is wrong.\n\nIn a later chapter we'll learn how to test more things to make sure we get guarantees that things are working as expected.\n\n## Pin dependencies and save-exact\n\nCheckout the package versions on the `package.json` file.\n\nyou can see the `^` sign.  That means that every time someone will get this code and run `yarn`, what `yarn` will do is to get the newest version on that range.\nWe don't want that. We want to first be notified when a new version is out and we want to explicitly update it.\n\nThat's why we need to add 2 things into our code:\nFirst, to delete all `^`.\n\n[{]: <helper> (diffStep \"1.2\" files=\"package.json\" module=\"client\")\n\n#### Client Step 1.2: Pin dependencies\n\n##### Changed package.json\n```diff\n@@ -7,8 +7,8 @@\n â”Š 7â”Š 7â”Š    \"@types/node\": \"12.0.1\",\n â”Š 8â”Š 8â”Š    \"@types/react\": \"16.8.17\",\n â”Š 9â”Š 9â”Š    \"@types/react-dom\": \"16.8.4\",\n-â”Š10â”Š  â”Š    \"react\": \"^16.8.6\",\n-â”Š11â”Š  â”Š    \"react-dom\": \"^16.8.6\",\n+â”Š  â”Š10â”Š    \"react\": \"16.8.6\",\n+â”Š  â”Š11â”Š    \"react-dom\": \"16.8.6\",\n â”Š12â”Š12â”Š    \"react-scripts\": \"3.0.1\",\n â”Š13â”Š13â”Š    \"typescript\": \"3.4.5\"\n â”Š14â”Š14â”Š  },\n```\n\n[}]: #\n\nSecond, to add the following command that will make each `yarn add <package-name>` command automatically add the library without any additions or `^` signs into it.\n\n[{]: <helper> (diffStep \"1.2\" files=\".npmrc\" module=\"client\")\n\n#### Client Step 1.2: Pin dependencies\n\n##### Added .npmrc\n```diff\n@@ -0,0 +1 @@\n+â”Š â”Š1â”Šsave-exact=true\n```\n\n[}]: #\n\nThere is no need to upgrade your dependencies at all. If they work it's ok. But, it is highly recommended.\nPackages keep improving all the time with important things that would help your app and will save you time.\nIf you make it a routine to upgrade it makes it much easier then to upgrade every couple of months.\nIn order to discover if there are new versions of libraries there are 2 options.\n\nOne is to manually run a check every day or so to find new packages out there.\nYou can do that by going to your command line in the root folder of the project and type `yarn outdated`.\n\nBut if you want to get notified when there is a new version of your dependencies, you can check out [Renovate](https://github.com/renovatebot/renovate).\nIf your project is hosted somewhere, for example Github, it will analyze your `package.json` and submit a new PR when a new release happened from one of your dependencies.\n\n## git and saving your code on Github\n\nIf you want to save your code somewhere where you can track versions, using [git](https://git-scm.com/book/en/v2) and [Github](https://guides.github.com/activities/hello-world/) is a good choice.\nHere is a nice guide to start: https://try.github.io/.\n\nYou can check out the `.gitignore` file create-react-app has set up for us in the root folder.\nThat file will tell `.git` what not to save and not to upload.\n\n**End of intro**\n\nAssuming that everything is set, we will now create our first screen - `ChatsListScreen`.\nThe ChatsListScreen component is responsible for showing the active conversations within our app.\n\nIt's best to first schematically plan how our view's gonna look like.\nThis would help us illustrate the intended view and also understand which React.Components / elements take part in it.\nThis is how our screen's gonna look like:\n\n![chatslistscreen](https://user-images.githubusercontent.com/7648874/54027873-01305280-41de-11e9-9df0-5ad9c9c2f226.png)\n\nLet's break down the image above and see what components are we gonna have in the `ChatsListScreen`:\n\n- Navbar -  Which should contain a simple static title for now.\n- ChatsList - Where each item's gonna contain some data regards the user we're chatting with and information about the chat.\n\nFirst let's remove the current React code and add our own code into it.\n\nFor now, let's create fake data on our HTML.\n\nAdd this data will be changed and we are not going to manually add HTML tags every time there is a new message, let's move our data into a JSON structure.\nFor now it would be a structure we will manually create.\nThat way we can make our React component already behave like our final version.\n\n[{]: <helper> (diffStep \"1.3\" files=\"App.tsx\" module=\"client\")\n\n#### Client Step 1.3: Create ChatsList screen\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -1,26 +1,29 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n-â”Š 2â”Š  â”Šimport logo from './logo.svg';\n-â”Š 3â”Š  â”Šimport './App.css';\n â”Š 4â”Š 2â”Š\n â”Š 5â”Š 3â”Šconst App: React.FC = () => {\n â”Š 6â”Š 4â”Š  return (\n-â”Š 7â”Š  â”Š    <div className=\"App\">\n-â”Š 8â”Š  â”Š      <header className=\"App-header\">\n-â”Š 9â”Š  â”Š        <img src={logo} className=\"App-logo\" alt=\"logo\" />\n-â”Š10â”Š  â”Š        <p>\n-â”Š11â”Š  â”Š          Edit <code>src/App.tsx</code> and save to reload.\n-â”Š12â”Š  â”Š        </p>\n-â”Š13â”Š  â”Š        <a\n-â”Š14â”Š  â”Š          className=\"App-link\"\n-â”Š15â”Š  â”Š          href=\"https://reactjs.org\"\n-â”Š16â”Š  â”Š          target=\"_blank\"\n-â”Š17â”Š  â”Š          rel=\"noopener noreferrer\"\n-â”Š18â”Š  â”Š        >\n-â”Š19â”Š  â”Š          Learn React\n-â”Š20â”Š  â”Š        </a>\n-â”Š21â”Š  â”Š      </header>\n+â”Š  â”Š 5â”Š    <div>\n+â”Š  â”Š 6â”Š      <div>\n+â”Š  â”Š 7â”Š        Whatsapp Clone\n+â”Š  â”Š 8â”Š      </div>\n+â”Š  â”Š 9â”Š      <div>\n+â”Š  â”Š10â”Š        <ul>\n+â”Š  â”Š11â”Š            <li>\n+â”Š  â”Š12â”Š              <img src=\"https://randomuser.me/api/portraits/thumb/men/1.jpg\" alt=\"Profile\"/>\n+â”Š  â”Š13â”Š              <div>Ethan Gonzalez</div>\n+â”Š  â”Š14â”Š                <div>You on your way?</div>\n+â”Š  â”Š15â”Š                <div>10:25</div>\n+â”Š  â”Š16â”Š            </li>\n+â”Š  â”Š17â”Š            <li>\n+â”Š  â”Š18â”Š              <img src=\"https://randomuser.me/api/portraits/thumb/men/2.jpg\" alt=\"Profile\"/>\n+â”Š  â”Š19â”Š              <div>Bryan Wallace</div>\n+â”Š  â”Š20â”Š                <div>Hey, it's me</div>\n+â”Š  â”Š21â”Š                <div>13:27</div>\n+â”Š  â”Š22â”Š            </li>\n+â”Š  â”Š23â”Š        </ul>\n+â”Š  â”Š24â”Š      </div>\n â”Š22â”Š25â”Š    </div>\n â”Š23â”Š26â”Š  );\n-â”Š24â”Š  â”Š}\n+â”Š  â”Š27â”Š};\n â”Š25â”Š28â”Š\n â”Š26â”Š29â”Šexport default App;\n```\n\n[}]: #\n\nIf all we do in the function is just returning a value, instead of `const App: React.FC = () => { return () };` we can also do `const App: React.FC = () => ();`\nSo let's use that for our ChatsList component.\n\nWe have to import React to make sure it will work.\nWe also have to export our component function so that the `App` component would be able to import it.\n(You can't import Javascript variables from a file if that file won't explicitly export it).\n\nAs we don't use those styles and logos anymore, we can delete the `src/App.css` and the `src/logo.svg` files from our app.\n\nNow let's move ChatsList into it's own component:\n\n[{]: <helper> (diffStep \"1.4\" files=\"ChatsList.tsx\" module=\"client\")\n\n#### Client Step 1.4: Move ChatsList to a component\n\n##### Added src&#x2F;components&#x2F;ChatsList.tsx\n```diff\n@@ -0,0 +1,22 @@\n+â”Š  â”Š 1â”Šimport React from 'react';\n+â”Š  â”Š 2â”Š\n+â”Š  â”Š 3â”Šconst ChatsList: React.FC = () => (\n+â”Š  â”Š 4â”Š  <div>\n+â”Š  â”Š 5â”Š    <ul>\n+â”Š  â”Š 6â”Š        <li>\n+â”Š  â”Š 7â”Š          <img src=\"https://randomuser.me/api/portraits/thumb/men/1.jpg\" alt=\"Profile\"/>\n+â”Š  â”Š 8â”Š          <div>Ethan Gonzalez</div>\n+â”Š  â”Š 9â”Š            <div>You on your way?</div>\n+â”Š  â”Š10â”Š            <div>10:25</div>\n+â”Š  â”Š11â”Š        </li>\n+â”Š  â”Š12â”Š        <li>\n+â”Š  â”Š13â”Š          <img src=\"https://randomuser.me/api/portraits/thumb/men/2.jpg\" alt=\"Profile\"/>\n+â”Š  â”Š14â”Š          <div>Bryan Wallace</div>\n+â”Š  â”Š15â”Š            <div>Hey, it's me</div>\n+â”Š  â”Š16â”Š            <div>13:27</div>\n+â”Š  â”Š17â”Š        </li>\n+â”Š  â”Š18â”Š    </ul>\n+â”Š  â”Š19â”Š  </div>\n+â”Š  â”Š20â”Š);\n+â”Š  â”Š21â”Š\n+â”Š  â”Š22â”Šexport default ChatsList;ðŸš«â†µ\n```\n\n[}]: #\n\nand let's import that component into the App component and use the shorter syntax for the functional component:\n\n[{]: <helper> (diffStep \"1.4\" files=\"App.tsx\" module=\"client\")\n\n#### Client Step 1.4: Move ChatsList to a component\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -1,4 +1,5 @@\n â”Š1â”Š1â”Šimport React from 'react';\n+â”Š â”Š2â”Šimport ChatsList from './components/ChatsList';\n â”Š2â”Š3â”Š\n â”Š3â”Š4â”Šconst App: React.FC = () => {\n â”Š4â”Š5â”Š  return (\n```\n```diff\n@@ -6,22 +7,7 @@\n â”Š 6â”Š 7â”Š      <div>\n â”Š 7â”Š 8â”Š        Whatsapp Clone\n â”Š 8â”Š 9â”Š      </div>\n-â”Š 9â”Š  â”Š      <div>\n-â”Š10â”Š  â”Š        <ul>\n-â”Š11â”Š  â”Š            <li>\n-â”Š12â”Š  â”Š              <img src=\"https://randomuser.me/api/portraits/thumb/men/1.jpg\" alt=\"Profile\"/>\n-â”Š13â”Š  â”Š              <div>Ethan Gonzalez</div>\n-â”Š14â”Š  â”Š                <div>You on your way?</div>\n-â”Š15â”Š  â”Š                <div>10:25</div>\n-â”Š16â”Š  â”Š            </li>\n-â”Š17â”Š  â”Š            <li>\n-â”Š18â”Š  â”Š              <img src=\"https://randomuser.me/api/portraits/thumb/men/2.jpg\" alt=\"Profile\"/>\n-â”Š19â”Š  â”Š              <div>Bryan Wallace</div>\n-â”Š20â”Š  â”Š                <div>Hey, it's me</div>\n-â”Š21â”Š  â”Š                <div>13:27</div>\n-â”Š22â”Š  â”Š            </li>\n-â”Š23â”Š  â”Š        </ul>\n-â”Š24â”Š  â”Š      </div>\n+â”Š  â”Š10â”Š      <ChatsList />\n â”Š25â”Š11â”Š    </div>\n â”Š26â”Š12â”Š  );\n â”Š27â”Š13â”Š};\n```\n\n[}]: #\n\nand let's do the same for our Navbar:\n\n[{]: <helper> (diffStep \"1.5\" module=\"client\")\n\n#### Client Step 1.5: Move ChatsNavbar to a component\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -1,12 +1,11 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n â”Š 2â”Š 2â”Šimport ChatsList from './components/ChatsList';\n+â”Š  â”Š 3â”Šimport ChatsNavbar from './components/ChatsNavbar';\n â”Š 3â”Š 4â”Š\n â”Š 4â”Š 5â”Šconst App: React.FC = () => {\n â”Š 5â”Š 6â”Š  return (\n â”Š 6â”Š 7â”Š    <div>\n-â”Š 7â”Š  â”Š      <div>\n-â”Š 8â”Š  â”Š        Whatsapp Clone\n-â”Š 9â”Š  â”Š      </div>\n+â”Š  â”Š 8â”Š      <ChatsNavbar />\n â”Š10â”Š 9â”Š      <ChatsList />\n â”Š11â”Š10â”Š    </div>\n â”Š12â”Š11â”Š  );\n```\n\n##### Added src&#x2F;components&#x2F;ChatsNavbar.tsx\n```diff\n@@ -0,0 +1,9 @@\n+â”Š â”Š1â”Šimport React from 'react';\n+â”Š â”Š2â”Š\n+â”Š â”Š3â”Šconst ChatsNavbar: React.FC = () => (\n+â”Š â”Š4â”Š  <div>\n+â”Š â”Š5â”Š    Whatsapp Clone\n+â”Š â”Š6â”Š  </div>\n+â”Š â”Š7â”Š);\n+â”Š â”Š8â”Š\n+â”Š â”Š9â”Šexport default ChatsNavbar;ðŸš«â†µ\n```\n\n[}]: #\n\nReact apps tend to store React.Components under a directory located at `src/components`, and so we're gonna follow this pattern.\nWe will create a directory called ChatsListScreen in the `components` dir where we're simply gonna import and put together the Navbar and ChatsList components.\nThis is how the contents of that directory should look like:\n\n    ChatsListScreen\n    â”œâ”€â”€ index.tsx\n    â”œâ”€â”€ ChatsList\n    â””â”€â”€ ChatsNavbar\n\nWe will use the `index.tsx` file to define that component, this way we can import it using the directory name:\n\n[{]: <helper> (diffStep \"1.6\" module=\"client\")\n\n#### Client Step 1.6: Move all ChatsListScreen into a folder\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -1,14 +1,10 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n-â”Š 2â”Š  â”Šimport ChatsList from './components/ChatsList';\n-â”Š 3â”Š  â”Šimport ChatsNavbar from './components/ChatsNavbar';\n+â”Š  â”Š 2â”Šimport ChatsListScreen from './components/ChatsListScreen';\n â”Š 4â”Š 3â”Š\n-â”Š 5â”Š  â”Šconst App: React.FC = () => {\n-â”Š 6â”Š  â”Š  return (\n-â”Š 7â”Š  â”Š    <div>\n-â”Š 8â”Š  â”Š      <ChatsNavbar />\n-â”Š 9â”Š  â”Š      <ChatsList />\n-â”Š10â”Š  â”Š    </div>\n-â”Š11â”Š  â”Š  );\n-â”Š12â”Š  â”Š};\n+â”Š  â”Š 4â”Šconst App: React.FC = () => (\n+â”Š  â”Š 5â”Š  <div>\n+â”Š  â”Š 6â”Š    <ChatsListScreen/>\n+â”Š  â”Š 7â”Š  </div>\n+â”Š  â”Š 8â”Š);\n â”Š13â”Š 9â”Š\n â”Š14â”Š10â”Šexport default App;\n```\n\n##### Renamed from src&#x2F;components&#x2F;ChatsList.tsx to src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n\n\n##### Renamed from src&#x2F;components&#x2F;ChatsNavbar.tsx to src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsNavbar.tsx\n\n\n##### Added src&#x2F;components&#x2F;ChatsListScreen&#x2F;index.tsx\n```diff\n@@ -0,0 +1,12 @@\n+â”Š  â”Š 1â”Šimport React from 'react';\n+â”Š  â”Š 2â”Šimport ChatsNavbar from './ChatsNavbar';\n+â”Š  â”Š 3â”Šimport ChatsList from './ChatsList';\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šconst ChatsListScreen: React.FC = () => (\n+â”Š  â”Š 6â”Š  <div>\n+â”Š  â”Š 7â”Š    <ChatsNavbar />\n+â”Š  â”Š 8â”Š    <ChatsList />\n+â”Š  â”Š 9â”Š  </div>\n+â”Š  â”Š10â”Š);\n+â”Š  â”Š11â”Š\n+â”Š  â”Š12â”Šexport default ChatsListScreen;ðŸš«â†µ\n```\n\n[}]: #\n\nNow, we have our app rendering our view, but it is completely static and manual in the code.\n\nIf we had 10 messages, we wouldn't want to type all of those HTML tags again and again.\nAlso if the data will change, the app should do this update itself without the need of hand written code.\n\nSo let's create a file that lists just the data of our chats and then make our React component render a line for each entry in that file.\n\nWe will create the file in a JSON format:\n\n[{]: <helper> (diffStep \"1.7\" files=\"db.ts\" module=\"client\")\n\n#### Client Step 1.7: Attach unique keys to ChatsList\n\n##### Added src&#x2F;db.ts\n```diff\n@@ -0,0 +1,49 @@\n+â”Š  â”Š 1â”Šexport const messages = [\n+â”Š  â”Š 2â”Š  {\n+â”Š  â”Š 3â”Š    id: 1,\n+â”Š  â”Š 4â”Š    content: \"You on your way?\",\n+â”Š  â”Š 5â”Š    createdAt: new Date(Date.now() - 60 * 1000 * 1000),\n+â”Š  â”Š 6â”Š  },\n+â”Š  â”Š 7â”Š  {\n+â”Š  â”Š 8â”Š    id: 2,\n+â”Š  â”Š 9â”Š    content: \"Hey, it's me\",\n+â”Š  â”Š10â”Š    createdAt: new Date(Date.now() - 2 * 60 * 1000 * 1000),\n+â”Š  â”Š11â”Š  },\n+â”Š  â”Š12â”Š  {\n+â”Š  â”Š13â”Š    id: 3,\n+â”Š  â”Š14â”Š    content: \"I should buy a boat\",\n+â”Š  â”Š15â”Š    createdAt: new Date(Date.now() - 24 * 60 * 1000 * 1000),\n+â”Š  â”Š16â”Š  },\n+â”Š  â”Š17â”Š  {\n+â”Š  â”Š18â”Š    id: 4,\n+â”Š  â”Š19â”Š    content: \"This is wicked good ice cream.\",\n+â”Š  â”Š20â”Š    createdAt: new Date(Date.now() - 14 * 24 * 60 * 1000 * 1000),\n+â”Š  â”Š21â”Š  },\n+â”Š  â”Š22â”Š];\n+â”Š  â”Š23â”Š\n+â”Š  â”Š24â”Šexport const chats = [\n+â”Š  â”Š25â”Š  {\n+â”Š  â”Š26â”Š    id: 1,\n+â”Š  â”Š27â”Š    name: 'Ethan Gonzalez',\n+â”Š  â”Š28â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n+â”Š  â”Š29â”Š    lastMessage: messages.find(m => m.id === 1),\n+â”Š  â”Š30â”Š  },\n+â”Š  â”Š31â”Š  {\n+â”Š  â”Š32â”Š    id: 2,\n+â”Š  â”Š33â”Š    name: 'Bryan Wallace',\n+â”Š  â”Š34â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n+â”Š  â”Š35â”Š    lastMessage: messages.find(m => m.id === 2),\n+â”Š  â”Š36â”Š  },\n+â”Š  â”Š37â”Š  {\n+â”Š  â”Š38â”Š    id: 3,\n+â”Š  â”Š39â”Š    name: 'Avery Stewart',\n+â”Š  â”Š40â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n+â”Š  â”Š41â”Š    lastMessage: messages.find(m => m.id === 3),\n+â”Š  â”Š42â”Š  },\n+â”Š  â”Š43â”Š  {\n+â”Š  â”Š44â”Š    id: 4,\n+â”Š  â”Š45â”Š    name: 'Katie Peterson',\n+â”Š  â”Š46â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n+â”Š  â”Š47â”Š    lastMessage: messages.find(m => m.id === 4),\n+â”Š  â”Š48â”Š  },\n+â”Š  â”Š49â”Š];ðŸš«â†µ\n```\n\n[}]: #\n\nWe are giving IDs for the values just like a database gives a unique id for each value.\n\nThe is so we can reference specific values, for example,\nlast message would actually reference the other array instead of duplicating the values.\n\nNow let's change ChatsList component to import the data from that file.\nThen to use the Javascript [map](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/map)\nfunction to render a line for each data entry:\n\n[{]: <helper> (diffStep \"1.7\" files=\"ChatsList.tsx\" module=\"client\")\n\n#### Client Step 1.7: Attach unique keys to ChatsList\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -1,20 +1,15 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n+â”Š  â”Š 2â”Šimport { chats } from '../../db';\n â”Š 2â”Š 3â”Š\n â”Š 3â”Š 4â”Šconst ChatsList: React.FC = () => (\n â”Š 4â”Š 5â”Š  <div>\n â”Š 5â”Š 6â”Š    <ul>\n-â”Š 6â”Š  â”Š        <li>\n-â”Š 7â”Š  â”Š          <img src=\"https://randomuser.me/api/portraits/thumb/men/1.jpg\" alt=\"Profile\"/>\n-â”Š 8â”Š  â”Š          <div>Ethan Gonzalez</div>\n-â”Š 9â”Š  â”Š            <div>You on your way?</div>\n-â”Š10â”Š  â”Š            <div>10:25</div>\n-â”Š11â”Š  â”Š        </li>\n-â”Š12â”Š  â”Š        <li>\n-â”Š13â”Š  â”Š          <img src=\"https://randomuser.me/api/portraits/thumb/men/2.jpg\" alt=\"Profile\"/>\n-â”Š14â”Š  â”Š          <div>Bryan Wallace</div>\n-â”Š15â”Š  â”Š            <div>Hey, it's me</div>\n-â”Š16â”Š  â”Š            <div>13:27</div>\n+â”Š  â”Š 7â”Š      {chats.map(chat => (\n+â”Š  â”Š 8â”Š        <li key={chat.id}>\n+â”Š  â”Š 9â”Š          <img src={chat.picture} alt=\"Profile\" />\n+â”Š  â”Š10â”Š          <div>{chat.name}</div>\n â”Š17â”Š11â”Š        </li>\n+â”Š  â”Š12â”Š      ))}\n â”Š18â”Š13â”Š    </ul>\n â”Š19â”Š14â”Š  </div>\n â”Š20â”Š15â”Š);\n```\n\n[}]: #\n\nWhen running `map` on the `chats` array, it will run a function for each entry in the array and return a value.\nThe function will receive the current entry as a parameter.\nIn our case the function will get the current function and will return a JSX line with the data of that specific chat.\n\nNotice we are also adding the `key` tag with the ID of each chat.\nIf you'll remove that and render again you will see the following error inside the console of your [Chrome developer tools](https://developers.google.com/web/tools/chrome-devtools/):\n`Warning: Each child in a list should have a unique \"key\" prop`.\n\nBy telling React how to identify and distinguish each element using the `key` value we help solve that problem and also making React faster.\nRead [here](https://reactjs.org/docs/lists-and-keys.html) for more in depth explanation.\n\nNow that we rendered a line for each chat, let's add also the last message's content and creation date for each chat:\n\n[{]: <helper> (diffStep \"1.8\" module=\"client\")\n\n#### Client Step 1.8: Failed try to add last message to ChatsList\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -8,6 +8,8 @@\n â”Š 8â”Š 8â”Š        <li key={chat.id}>\n â”Š 9â”Š 9â”Š          <img src={chat.picture} alt=\"Profile\" />\n â”Š10â”Š10â”Š          <div>{chat.name}</div>\n+â”Š  â”Š11â”Š          <div>{chat.lastMessage.content}</div>\n+â”Š  â”Š12â”Š          <div>{chat.lastMessage.createdAt}</div>\n â”Š11â”Š13â”Š        </li>\n â”Š12â”Š14â”Š      ))}\n â”Š13â”Š15â”Š    </ul>\n```\n\n[}]: #\n\nTry to run the app again.\n\nYou can see we get a Typescript error.\nThis is because Typescript is smart enough and tells us there might be no last message.\nSo we add a check.\nRemember to always check for null or undefined if optional, donâ€™t write shorter write safer:\n\n[{]: <helper> (diffStep \"1.9\" module=\"client\")\n\n#### Client Step 1.9: Second failed try to add last message to ChatsList\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -8,8 +8,10 @@\n â”Š 8â”Š 8â”Š        <li key={chat.id}>\n â”Š 9â”Š 9â”Š          <img src={chat.picture} alt=\"Profile\" />\n â”Š10â”Š10â”Š          <div>{chat.name}</div>\n+â”Š  â”Š11â”Š          {chat.lastMessage && (\n â”Š11â”Š12â”Š          <div>{chat.lastMessage.content}</div>\n â”Š12â”Š13â”Š          <div>{chat.lastMessage.createdAt}</div>\n+â”Š  â”Š14â”Š          )}\n â”Š13â”Š15â”Š        </li>\n â”Š14â”Š16â”Š      ))}\n â”Š15â”Š17â”Š    </ul>\n```\n\n[}]: #\n\nNow let's try again.\n\nNow we have a syntax error - A JSX return value can't have more then a single root Element.\nSo in order to return a root element from the function but still display multiple elements in the same level,\nwe can use [React.Fragment](https://reactjs.org/docs/fragments.html) to wrap the returned elements:\n\n[{]: <helper> (diffStep \"1.10\" module=\"client\")\n\n#### Client Step 1.10: Third failed try to add last message to ChatsList\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -9,8 +9,10 @@\n â”Š 9â”Š 9â”Š          <img src={chat.picture} alt=\"Profile\" />\n â”Š10â”Š10â”Š          <div>{chat.name}</div>\n â”Š11â”Š11â”Š          {chat.lastMessage && (\n-â”Š12â”Š  â”Š          <div>{chat.lastMessage.content}</div>\n-â”Š13â”Š  â”Š          <div>{chat.lastMessage.createdAt}</div>\n+â”Š  â”Š12â”Š            <React.Fragment>\n+â”Š  â”Š13â”Š              <div>{chat.lastMessage.content}</div>\n+â”Š  â”Š14â”Š              <div>{chat.lastMessage.createdAt}</div>\n+â”Š  â”Š15â”Š            </React.Fragment>\n â”Š14â”Š16â”Š          )}\n â”Š15â”Š17â”Š        </li>\n â”Š16â”Š18â”Š      ))}\n```\n\n[}]: #\n\n\nLet's try again.  This time it looks like the format is not correct, so let's format the date using the `moment` library.\n\nLet's install the [`moment`](https://momentjs.com/) library to wrap `lastMessage.createdAt` with a better format.\nMoment has the ability to wrap date objects nicely and rewrite them in a pretty format.\nThis way we can have an elegant time format at which the message was sent e.g. `11:34`.\nTo install:\n\n\t$ yarn add moment\n\n\nAnd now let's import the library by it's name, wrap the value of each chat and call the `format` function with our requested format:\n\n[{]: <helper> (diffStep \"1.11\" files=\"ChatsList.tsx\" module=\"client\")\n\n#### Client Step 1.11: Success adding last message to ChatsList\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -1,5 +1,6 @@\n â”Š1â”Š1â”Šimport React from 'react';\n â”Š2â”Š2â”Šimport { chats } from '../../db';\n+â”Š â”Š3â”Šimport moment from 'moment';\n â”Š3â”Š4â”Š\n â”Š4â”Š5â”Šconst ChatsList: React.FC = () => (\n â”Š5â”Š6â”Š  <div>\n```\n```diff\n@@ -11,7 +12,7 @@\n â”Š11â”Š12â”Š          {chat.lastMessage && (\n â”Š12â”Š13â”Š            <React.Fragment>\n â”Š13â”Š14â”Š              <div>{chat.lastMessage.content}</div>\n-â”Š14â”Š  â”Š              <div>{chat.lastMessage.createdAt}</div>\n+â”Š  â”Š15â”Š              <div>{moment(chat.lastMessage.createdAt).format('HH:mm')}</div>\n â”Š15â”Š16â”Š            </React.Fragment>\n â”Š16â”Š17â”Š          )}\n â”Š17â”Š18â”Š        </li>\n```\n\n[}]: #\n\n\nIf you'll try to run the app you'll see that everything is there, but it's not hard to notice that it's missing some style:\n\n![naked-chats-list](https://user-images.githubusercontent.com/7648874/54028578-73099b80-41e0-11e9-803a-7469300acb06.png)\n\nIn the next chapter we will take care of styling our application with [Material-UI](https://material-ui.com/) and [styled-components](https://www.styled-components.com/) - we will give it the desired look and make it more user friendly. For now the ChatsListScreen serves no purpose, because you can't really do anything with it, but it can be used as a great basis to build on top of as we make progress.\n\nTODO: Define and use Prettier.\nTODO: Editor and Prettier, extensions - Auto Import, GitLens, npm Intellisense, TypeScript Importer - works when Auto Import doesn't\nTODO: react-dev-tools, go through everything on dev tools.\nTODO: build. show built code. show it on file and show it on the browser.\nTODO: Go through all of https://facebook.github.io/create-react-app/docs/\nTODO: Should we talk about Storybook?\nTODO: Should we use â€œâ€ or â€˜â€™?\nTODO: Should we use date-fns instead of moment?"
          },
          {
            "manualTitle": "Step 2: Styling with Material UI and styled-components",
            "stepRevision": "6cbeea8a1ed4b498ab29a90210b610854489d4c7",
            "manualView": "Now it's time to style our app.\n\nWe can edit styles manually but we can also usie ready made components that have already been styled and shared in the community.\n\nIn this chapter we will do both.\n\nFirst, we would also use [Material-UI](https://material-ui.com/) - a library with a set of React components that implements Google's Material Design.\nWhat's good about it is that the design is already implemented right out of the box.\nNot only that, but it also includes a set of icons which are free to use.\n\nThere are many things that Material-UI can offer, and it's not easy to follow it up, especially with the constantly evolving and improving API.\nThe best way to go with it, is to identify a component you need, and then look for it in the [official website](https://material-ui.com/).\nAnd when it comes to searching for icons, they can be found on the [material.io](https://material-ui.com/) website through the search bar.\n\nAs we move further in this tutorial you should have a better grasp of Material and how to use it.\n\n![material-ui-icons](https://user-images.githubusercontent.com/7648874/54141504-c853e000-4460-11e9-94b5-aae98ec9a1e3.png)\n\nWe will start off by installing some of the needed material libraries and its Typescript types library:\n\n    $ yarn add @material-ui/core @material-ui/icons @types/material-ui\n\n`@material-ui/core` includes core component of Material-UI such as Input, Popover, Modal, etc, and `@material-ui/icons` includes a set of icons.\nMaterial is very generic and has a built in theming system which can be controlled by simply setting few variables,\nwhich is exactly what we're gonna need in our app.\n\nIn our app we're mainly gonna use 2 colors:\n\n- Primary #306759\n- Secondary #79e352\n\nThe easiest way to reference colors without repeating yourself is through Themes.\nTheme definition can easily be done in Material using the MuiThemeProvider component:\n\n[{]: <helper> (diffStep \"2.2\" module=\"client\")\n\n#### Client Step 2.2: Setup Material-UI theme\n\n##### Changed src&#x2F;index.tsx\n```diff\n@@ -1,10 +1,25 @@\n+â”Š  â”Š 1â”Šimport { MuiThemeProvider, createMuiTheme } from '@material-ui/core/styles'\n â”Š 1â”Š 2â”Šimport React from 'react';\n â”Š 2â”Š 3â”Šimport ReactDOM from 'react-dom';\n â”Š 3â”Š 4â”Šimport './index.css';\n â”Š 4â”Š 5â”Šimport App from './App';\n â”Š 5â”Š 6â”Šimport * as serviceWorker from './serviceWorker';\n â”Š 6â”Š 7â”Š\n-â”Š 7â”Š  â”ŠReactDOM.render(<App />, document.getElementById('root'));\n+â”Š  â”Š 8â”Šconst theme = createMuiTheme({\n+â”Š  â”Š 9â”Š  palette: {\n+â”Š  â”Š10â”Š    primary: { main: '#2c6157' },\n+â”Š  â”Š11â”Š    secondary: { main: '#6fd056' },\n+â”Š  â”Š12â”Š  },\n+â”Š  â”Š13â”Š  typography: {\n+â”Š  â”Š14â”Š    useNextVariants: true,\n+â”Š  â”Š15â”Š  },\n+â”Š  â”Š16â”Š})\n+â”Š  â”Š17â”Š\n+â”Š  â”Š18â”ŠReactDOM.render(\n+â”Š  â”Š19â”Š  <MuiThemeProvider theme={theme}>\n+â”Š  â”Š20â”Š    <App />\n+â”Š  â”Š21â”Š  </MuiThemeProvider>\n+â”Š  â”Š22â”Š, document.getElementById('root'));\n â”Š 8â”Š23â”Š\n â”Š 9â”Š24â”Š// If you want your app to work offline and load faster, you can change\n â”Š10â”Š25â”Š// unregister() to register() below. Note this comes with some pitfalls.\n```\n\n[}]: #\n\n\nWe create a `palette` of the themes together with any other definitions for the theme, and then we wrap our app with a React component\nfrom the `material-ui` library to provide those definitions to all of our App's components when they need them.\n\nOnce we have it set, the colors should be available to use in our application by simply providing the \"color\" prop to the component instance whose color we would like to change:\n\n```diff\n<Button color=\"primary\">Primary</Button>\n<Button color=\"secondary\">Secondary</Button>\n```\n\nIn our app, we're also gonna use CSS directly to change its colors, therefore it would be handy to have these theme variables available to us through CSS.\nTo do so, we will have a second definition of these variables in `index.css`, at the `:root` level of our application.\n\nThat feels like a small duplication but this will help us use them in styled components directly.\nAlso that means you can view the variables in chrome-dev-tools.\n\n[{]: <helper> (diffStep \"2.3\" module=\"client\")\n\n#### Client Step 2.3: Setup CSS theme vars\n\n##### Changed src&#x2F;index.css\n```diff\n@@ -1,3 +1,10 @@\n+â”Š  â”Š 1â”Š:root {\n+â”Š  â”Š 2â”Š  --primary-bg: #2c6157;\n+â”Š  â”Š 3â”Š  --secondary-bg: #6fd056;\n+â”Š  â”Š 4â”Š  --primary-text: white;\n+â”Š  â”Š 5â”Š  --secondary-text: white;\n+â”Š  â”Š 6â”Š}\n+â”Š  â”Š 7â”Š\n â”Š 1â”Š 8â”Šbody {\n â”Š 2â”Š 9â”Š  margin: 0;\n â”Š 3â”Š10â”Š  padding: 0;\n```\n\n[}]: #\n\n`:root` is a pseudo element that simply represents the root node, which will make the colors available in all elements.\nNormally, it works like JavaScript's scoping system and it will make variables available only to the current node and to its children, NOT its parents.\nCSS vars can be used like so:\n\n```css\n  color: var(--primary-text);\n  background-color: var(--primary-bg);\n```\n\nMore information about CSS variables can be found in the [official MDN docs](https://developer.mozilla.org/en-US/docs/Web/CSS/Using_CSS_variables).\n\nSo getting back to the ChatsListScreen, we will wrap the ChatsNavbar with Material's <Toolbar /> component:\n\n[{]: <helper> (diffStep \"2.4\" files=\"ChatsNavbar.tsx\" module=\"client\")\n\n#### Client Step 2.4: Use Material components\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsNavbar.tsx\n```diff\n@@ -1,9 +1,10 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n+â”Š  â”Š 2â”Šimport { Toolbar } from '@material-ui/core';\n â”Š 2â”Š 3â”Š\n â”Š 3â”Š 4â”Šconst ChatsNavbar: React.FC = () => (\n-â”Š 4â”Š  â”Š  <div>\n+â”Š  â”Š 5â”Š  <Toolbar>\n â”Š 5â”Š 6â”Š    Whatsapp Clone\n-â”Š 6â”Š  â”Š  </div>\n+â”Š  â”Š 7â”Š  </Toolbar>\n â”Š 7â”Š 8â”Š);\n â”Š 8â”Š 9â”Š\n â”Š 9â”Š10â”Šexport default ChatsNavbar;ðŸš«â†µ\n```\n\n[}]: #\n\nAnd we will replace the `<ul />` and `<li />` elements with Material's `<List />` and `<ListItem />` in ChatsList:\n\n[{]: <helper> (diffStep \"2.4\" files=\"ChatsList.tsx\" module=\"client\")\n\n#### Client Step 2.4: Use Material components\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -1,12 +1,13 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n â”Š 2â”Š 2â”Šimport { chats } from '../../db';\n â”Š 3â”Š 3â”Šimport moment from 'moment';\n+â”Š  â”Š 4â”Šimport { List, ListItem } from '@material-ui/core';\n â”Š 4â”Š 5â”Š\n â”Š 5â”Š 6â”Šconst ChatsList: React.FC = () => (\n â”Š 6â”Š 7â”Š  <div>\n-â”Š 7â”Š  â”Š    <ul>\n+â”Š  â”Š 8â”Š    <List>\n â”Š 8â”Š 9â”Š      {chats.map(chat => (\n-â”Š 9â”Š  â”Š        <li key={chat.id}>\n+â”Š  â”Š10â”Š        <ListItem key={chat.id} button>\n â”Š10â”Š11â”Š          <img src={chat.picture} alt=\"Profile\" />\n â”Š11â”Š12â”Š          <div>{chat.name}</div>\n â”Š12â”Š13â”Š          {chat.lastMessage && (\n```\n```diff\n@@ -15,9 +16,9 @@\n â”Š15â”Š16â”Š              <div>{moment(chat.lastMessage.createdAt).format('HH:mm')}</div>\n â”Š16â”Š17â”Š            </React.Fragment>\n â”Š17â”Š18â”Š          )}\n-â”Š18â”Š  â”Š        </li>\n+â”Š  â”Š19â”Š        </ListItem>\n â”Š19â”Š20â”Š      ))}\n-â”Š20â”Š  â”Š    </ul>\n+â”Š  â”Š21â”Š    </List>\n â”Š21â”Š22â”Š  </div>\n â”Š22â”Š23â”Š);\n â”Š23â”Š24â”Š\n```\n\n[}]: #\n\nThanks to the `button` attribute, the Material component can give our list a more vibrant feeling and that will display a nice ripple effect once an item is clicked,\nsomething that could have taken a long time to implement manually.\n\nNow that we are using existing styled components, it's time to customize them to look exactly like we want them to look.\nWhen we write styles, we usually use CSS.\n\nOne of the important concepts that React brought us was the fact we could use just Javascript to describe our components\nand another was the fact that we could encapsulate our UI into a set of separated components.\n\nBut when it comes to CSS, we are still using it like before, having no encapsulation between different definitions and files.\n\n[Styled-components](https://www.styled-components.com/) is a relatively new library that will transpile a given string into a CSS string and will encapsulate it under a `React.Component`.\nBringing the same concepts from React into the way we write styles, so we ca define our styles programmatically.\nWith JavaScript in-hand you naturally have more control over our styles and its encapsulation, which makes it a very powerful tool.\n\nHere's one way to style a button using styled-components:\n\n```js\nimport styled, { css } from 'styled-components';\n\nconst Button = styled.button`\n  background: transparent;\n  border-radius: 3px;\n  border: 2px solid palevioletred;\n  color: palevioletred;\n  margin: 0.5em 1em;\n  padding: 0.25em 1em;\n\n  ${props => props.primary && css`\n    background: palevioletred;\n    color: white;\n  `}\n`;\n```\n\n* `styled` is coming from the `styled-components` library. When we call `styled.button` that means we are extending a button component from styled.\n* `Button` will become a full React componnet with the extended styled we specified\n* Like a React component, we can send props into our component. And like a React function, we can write Javascript code that interact and respond to those props.\nIn our case, just like a check we've done before in TSX to render something only if it exists, here only if we have a `primary` property, we will add extra styles to our component.\nThe created Button is actually a React.Component, so an instance of it can be created with ease like any other component:\n* `css` is telling Styled components that the string literal that comes after describes CSS styles.\n\n```jsx\n  <Button primary />\n```\n\nBut as this is just like a component, we should type it just like we type component, defining what properties it should get in:\n\n```tsx\nimport styled, { css } from 'styled-components';\n\ninterface ButtonProps {\n  readonly primary: any;\n};\n\nconst Button = styled.button<ButtonProps>`\n  background: transparent;\n  border-radius: 3px;\n  border: 2px solid palevioletred;\n  color: palevioletred;\n  margin: 0.5em 1em;\n  padding: 0.25em 1em;\n\n  ${props => props.primary && css`\n    background: palevioletred;\n    color: white;\n  `}\n`;\n```\n\nMore information about styled-components can be found in the official [docs page](https://www.styled-components.com/docs).\n\nNow, we will use `styled-components` to create new React.Components which are bound into a style-sheet.\nThis way when we create new instances of them, the components will be styled right out of the box. Example:\n\n```jsx\nconst Button = styled.button `\n  border-radius: 999px;\n`\n\nconst RedButton = styled(Button) `\n  color: red;\n`\n\nconst GreenButton = styled(Button) `\n  color: green;\n`\n\nconst BlueButton = styled(Button) `\n  color: blue;\n`\n\nconst Dashboard = (\n  <div>\n    <RedButton />\n    <GreenButton />\n    <BlueButton />\n  </div>\n)\n```\n\nThe clear advantage of such working strategy is that all the styles are encapsulated, unlike traditional CSS where style rules can easily collide and be merged unintentionally.\nRemember that **`styled-components` operates per component, not globally**.\n\nWe will start off by installing `styled-components` and its Typescript types library:\n\n    $ yarn add styled-components @types/styled-components\n\nNow, let's use `styled-components` our `ChatsListScreen`:\n\n[{]: <helper> (diffStep \"2.5\" files=\"index.tsx\" module=\"client\")\n\n#### Client Step 2.5: Add style with styled-components\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;index.tsx\n```diff\n@@ -1,12 +1,17 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n â”Š 2â”Š 2â”Šimport ChatsNavbar from './ChatsNavbar';\n â”Š 3â”Š 3â”Šimport ChatsList from './ChatsList';\n+â”Š  â”Š 4â”Šimport styled from 'styled-components';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šconst Container = styled.div `\n+â”Š  â”Š 7â”Š  height: 100vh;\n+â”Š  â”Š 8â”Š`;\n â”Š 4â”Š 9â”Š\n â”Š 5â”Š10â”Šconst ChatsListScreen: React.FC = () => (\n-â”Š 6â”Š  â”Š  <div>\n+â”Š  â”Š11â”Š  <Container>\n â”Š 7â”Š12â”Š    <ChatsNavbar />\n â”Š 8â”Š13â”Š    <ChatsList />\n-â”Š 9â”Š  â”Š  </div>\n+â”Š  â”Š14â”Š  </Container>\n â”Š10â”Š15â”Š);\n â”Š11â”Š16â”Š\n â”Š12â”Š17â”Šexport default ChatsListScreen;ðŸš«â†µ\n```\n\n[}]: #\n\nHere you can see that we've created a new component called `Container`.\nThat component is extending `div` and adds some styles into it.\nThen we've replaced the `div` element with the new, enhanced `div` called `Container`.\n\nWith this we know for sure that the styles we applied for `Container` won't affect any other component in our app.\n\n[{]: <helper> (diffStep \"2.5\" files=\"ChatsNavbar.tsx\" module=\"client\")\n\n#### Client Step 2.5: Add style with styled-components\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsNavbar.tsx\n```diff\n@@ -1,10 +1,18 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n â”Š 2â”Š 2â”Šimport { Toolbar } from '@material-ui/core';\n+â”Š  â”Š 3â”Šimport styled from 'styled-components';\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šconst Container = styled(Toolbar) `\n+â”Š  â”Š 6â”Š  background-color: var(--primary-bg);\n+â”Š  â”Š 7â”Š  color: var(--primary-text);\n+â”Š  â”Š 8â”Š  font-size: 20px;\n+â”Š  â”Š 9â”Š  line-height: 40px;\n+â”Š  â”Š10â”Š` as typeof Toolbar;\n â”Š 3â”Š11â”Š\n â”Š 4â”Š12â”Šconst ChatsNavbar: React.FC = () => (\n-â”Š 5â”Š  â”Š  <Toolbar>\n+â”Š  â”Š13â”Š  <Container>\n â”Š 6â”Š14â”Š    Whatsapp Clone\n-â”Š 7â”Š  â”Š  </Toolbar>\n+â”Š  â”Š15â”Š  </Container>\n â”Š 8â”Š16â”Š);\n â”Š 9â”Š17â”Š\n â”Š10â”Š18â”Šexport default ChatsNavbar;ðŸš«â†µ\n```\n\n[}]: #\n\nHere you can see we've done the same, but instead of extending a built-in component from styled-component,\nwe enhanced the `Toolbar` component from `material-ui.\n\nNotice that we also called the wrapper `Container` but again it has no affect on any component outside of our specific component.\n\n> Notice that we've added Typescript type inference `as typeof Toolbar` at the end. That's because of an issue that suppose to be fixed when we'll upgrade to material-ui v4.\n\nLet's finish this off by doing the same in our last component:\n\n[{]: <helper> (diffStep \"2.5\" files=\"ChatsList.tsx\" module=\"client\")\n\n#### Client Step 2.5: Add style with styled-components\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -2,24 +2,79 @@\n â”Š 2â”Š 2â”Šimport { chats } from '../../db';\n â”Š 3â”Š 3â”Šimport moment from 'moment';\n â”Š 4â”Š 4â”Šimport { List, ListItem } from '@material-ui/core';\n+â”Š  â”Š 5â”Šimport styled from 'styled-components';\n â”Š 5â”Š 6â”Š\n-â”Š 6â”Š  â”Šconst ChatsList: React.FC = () => (\n-â”Š 7â”Š  â”Š  <div>\n-â”Š 8â”Š  â”Š    <List>\n-â”Š 9â”Š  â”Š      {chats.map(chat => (\n-â”Š10â”Š  â”Š        <ListItem key={chat.id} button>\n-â”Š11â”Š  â”Š          <img src={chat.picture} alt=\"Profile\" />\n-â”Š12â”Š  â”Š          <div>{chat.name}</div>\n-â”Š13â”Š  â”Š          {chat.lastMessage && (\n-â”Š14â”Š  â”Š            <React.Fragment>\n-â”Š15â”Š  â”Š              <div>{chat.lastMessage.content}</div>\n-â”Š16â”Š  â”Š              <div>{moment(chat.lastMessage.createdAt).format('HH:mm')}</div>\n-â”Š17â”Š  â”Š            </React.Fragment>\n-â”Š18â”Š  â”Š          )}\n-â”Š19â”Š  â”Š        </ListItem>\n+â”Š  â”Š 7â”Šconst Container = styled.div `\n+â”Š  â”Š 8â”Š  height: calc(100% - 56px);\n+â”Š  â”Š 9â”Š  overflow-y: overlay;\n+â”Š  â”Š10â”Š`;\n+â”Š  â”Š11â”Š\n+â”Š  â”Š12â”Šconst StyledList = styled(List) `\n+â”Š  â”Š13â”Š  padding: 0 !important;\n+â”Š  â”Š14â”Š` as typeof List;\n+â”Š  â”Š15â”Š\n+â”Š  â”Š16â”Šconst StyledListItem = styled(ListItem) `\n+â”Š  â”Š17â”Š  height: 76px;\n+â”Š  â”Š18â”Š  padding: 0 15px;\n+â”Š  â”Š19â”Š  display: flex;\n+â”Š  â”Š20â”Š` as typeof ListItem;\n+â”Š  â”Š21â”Š\n+â”Š  â”Š22â”Šconst ChatPicture = styled.img `\n+â”Š  â”Š23â”Š  height: 50px;\n+â”Š  â”Š24â”Š  width: 50px;\n+â”Š  â”Š25â”Š  object-fit: cover;\n+â”Š  â”Š26â”Š  border-radius: 50%;\n+â”Š  â”Š27â”Š`;\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Šconst ChatInfo = styled.div `\n+â”Š  â”Š30â”Š  width: calc(100% - 60px);\n+â”Š  â”Š31â”Š  height: 46px;\n+â”Š  â”Š32â”Š  padding: 15px 0;\n+â”Š  â”Š33â”Š  margin-left: 10px;\n+â”Š  â”Š34â”Š  border-bottom: 0.5px solid silver;\n+â”Š  â”Š35â”Š  position: relative;\n+â”Š  â”Š36â”Š`;\n+â”Š  â”Š37â”Š\n+â”Š  â”Š38â”Šconst ChatName = styled.div `\n+â”Š  â”Š39â”Š  margin-top: 5px;\n+â”Š  â”Š40â”Š`;\n+â”Š  â”Š41â”Š\n+â”Š  â”Š42â”Šconst MessageContent = styled.div `\n+â”Š  â”Š43â”Š  color: gray;\n+â”Š  â”Š44â”Š  font-size: 15px;\n+â”Š  â”Š45â”Š  margin-top: 5px;\n+â”Š  â”Š46â”Š  text-overflow: ellipsis;\n+â”Š  â”Š47â”Š  overflow: hidden;\n+â”Š  â”Š48â”Š  white-space: nowrap;\n+â”Š  â”Š49â”Š`;\n+â”Š  â”Š50â”Š\n+â”Š  â”Š51â”Šconst MessageDate = styled.div `\n+â”Š  â”Š52â”Š  position: absolute;\n+â”Š  â”Š53â”Š  color: gray;\n+â”Š  â”Š54â”Š  top: 20px;\n+â”Š  â”Š55â”Š  right: 0;\n+â”Š  â”Š56â”Š  font-size: 13px;\n+â”Š  â”Š57â”Š`;\n+â”Š  â”Š58â”Š\n+â”Š  â”Š59â”Šconst ChatsList = () => (\n+â”Š  â”Š60â”Š  <Container>\n+â”Š  â”Š61â”Š    <StyledList>\n+â”Š  â”Š62â”Š      {chats.map((chat) => (\n+â”Š  â”Š63â”Š        <StyledListItem key={chat.id} button>\n+â”Š  â”Š64â”Š          <ChatPicture src={chat.picture} alt=\"Profile\"/>\n+â”Š  â”Š65â”Š          <ChatInfo>\n+â”Š  â”Š66â”Š            <ChatName>{chat.name}</ChatName>\n+â”Š  â”Š67â”Š            {chat.lastMessage && (\n+â”Š  â”Š68â”Š              <React.Fragment>\n+â”Š  â”Š69â”Š                <MessageContent>{chat.lastMessage.content}</MessageContent>\n+â”Š  â”Š70â”Š                <MessageDate>{moment(chat.lastMessage.createdAt).format('HH:mm')}</MessageDate>\n+â”Š  â”Š71â”Š              </React.Fragment>\n+â”Š  â”Š72â”Š            )}\n+â”Š  â”Š73â”Š          </ChatInfo>\n+â”Š  â”Š74â”Š        </StyledListItem>\n â”Š20â”Š75â”Š      ))}\n-â”Š21â”Š  â”Š    </List>\n-â”Š22â”Š  â”Š  </div>\n+â”Š  â”Š76â”Š    </StyledList>\n+â”Š  â”Š77â”Š  </Container>\n â”Š23â”Š78â”Š);\n â”Š24â”Š79â”Š\n â”Š25â”Š80â”Šexport default ChatsList;ðŸš«â†µ\n```\n\n[}]: #\n\nNotice that we've changed the structure of the HTML of the `ChatsList` component.\nWe've added the ChatInfo to allow better alignment of the elements.\n\nWe're done styling `ChatsListScreen`. We will keep using the same principles to style the rest of the components in our application. The final result should look like so:\n\n![screenshot](https://user-images.githubusercontent.com/7648874/54141766-40baa100-4461-11e9-8dd0-59edcfdb3b84.png)\n\n\nTODO: What do people think about https://www.styled-components.com/docs/tooling#babel-plugin, should we use it here?"
          },
          {
            "manualTitle": "Step 3: Setup a basic Node.JS server with a basic REST endpoint",
            "stepRevision": "fe6585f4ef8228e7732e90efa2f4092ea2789f29",
            "manualView": "Currently we have a running app with a single screen which looks stylish and presents some data to the user.\n\nThere is something missing though - The data that we are displaying can't be changed in any way.\n\nbut even if we'll change the data, there is still a more fundamental issue - all of the data lives on the client.\n\nThat means that each client has it's own copy of the data and the data is not shared between them,\nif a client will create a new message, only that client will have the new message and not the client that the message was sent to.\n\nAlso if the client will shut down, all data will be lost.\n\nSo how can we have a place to put data that is being shared between all clients?\n\nWe should find a central machine that all clients will connect to and get the data from.\nIf some client wants to create a new message, it will create it on that central machine so that the next time another clients will ask for the available messages,\nall those messages will be available on the central machine.\n\nThat central machine that stores data is called a database. and the machine that communicates between the database and the client is called a server.\n\nIn this step, we will write a NodeJS server (server that runs using the Javascript language) and will expose a REST endpoint that will serve the data-mock.\nWe will build the REST application using [Express](https://www.npmjs.com/package/express).\nFurther in this tutorial, we will migrate to using a real data-base with real I/O from the user, because at this point, if the server will shut down, all data will be lost.\n\nThe plan is to have a server up and running at `localhost:4000` that will expose a `GET /chats` route.\nUnlike our client application, we're not gonna use any boilerplate and we're gonna set everything up manually.\n\nRight outside the client project, we will create a new directory called `whatsapp-clone-server` in which we will start creating our server:\n\n    $ mkdir whatsapp-clone-server\n    $ cd whatsapp-clone-server\n\nThen we will use `Yarn` to initialize a new project:\n\n    $ yarn init -yp\n\nThere's nothing special about this command, it only creates a basic `package.json` file.\nJust to make sure that things work, we will add an `index.js` file which will print `\"hello world\"` to the console.\n\n[{]: <helper> (diffStep \"1.1\" files=\"index.js\" module=\"server\")\n\n#### [Server Step 1.1: Create start script](https://github.com/Urigo/WhatsApp-Clone-Server/commit/adbc199)\n\n##### Added index.js\n```diff\n@@ -0,0 +1 @@\n+â”Š â”Š1â”Šconsole.log('hello world')\n```\n\n[}]: #\n\nAnd we will add a startup script to the `package.json` file called `start`:\n\n    \"start\": \"node index.js\"\n\nNPM-scripts are just a way to defined an alias for commands. Now we only have one simple script,\nbut it can turn out to be something very complex depending on our server, so it can be very useful.\nMore about npm-scripts can be found in the [official NPM docs](https://docs.npmjs.com/misc/scripts).\n\nNow we can run our server by running `$ yarn start` and we should see the message \"hello world\" printed to the console, as expected.\n\nLike in our client's app, we will be using TypeScript.\nIn order to use TypeScript we will install few packages:\n\n    $ yarn add --dev typescript ts-node @types/node\n\n> Note how we used the `--dev` flag. It is a good practice to separate between production dependencies and development dependencies.\nThat way when you deploy your server to the real environment, you won't install the unnecessary development dependencies there.\nMore about the `--dev` option can be read in the [NPM-install docs](https://docs.npmjs.com/cli/install).\n\n- The [`typescript`](https://www.npmjs.com/package/typescript) package is TypeScript's core transpiler.\n- [`ts-node`](https://www.npmjs.com/package/ts-node) is an interpreter that will transpile required `.ts` files into JavaScript at runtime.\n- [`@types/node`](https://www.npmjs.com/package/@types/node) will make the appropriate definitions for a Node.JS environment.\n\n> You can read more about the `@types` monorepo in the [official GitHub repository](https://github.com/DefinitelyTyped/DefinitelyTyped).\n\nWe will rename the `index.js` file to `index.ts`:\n\n    $ mv index.js index.ts\n\nNow we need to compile the `ts` file to turn it into a Javascript file the Node can run.\n\nFor that we will use Typescript and its `tsc` command.\nThe command has many options, but instead of writing them in the command line, we can specify them in a `tsconfig.json` file at the root of the project.\n\nOur server is gonna use the following `tsconfig.json` file, feel free to make the necessary modifications based on your needs:\n\n[{]: <helper> (diffStep \"1.2\" files=\"tsconfig.json\" module=\"server\")\n\n#### [Server Step 1.2: Setup TypeScript](https://github.com/Urigo/WhatsApp-Clone-Server/commit/0dcf18c)\n\n##### Added tsconfig.json\n```diff\n@@ -0,0 +1,16 @@\n+â”Š  â”Š 1â”Š{\n+â”Š  â”Š 2â”Š  \"compilerOptions\": {\n+â”Š  â”Š 3â”Š    \"target\": \"es2018\",\n+â”Š  â”Š 4â”Š    \"module\": \"commonjs\",\n+â”Š  â”Š 5â”Š    \"lib\": [\n+â”Š  â”Š 6â”Š      \"es2018\",\n+â”Š  â”Š 7â”Š      \"esnext.asynciterable\"\n+â”Š  â”Š 8â”Š    ],\n+â”Š  â”Š 9â”Š    \"strict\": true,\n+â”Š  â”Š10â”Š    \"strictFunctionTypes\": false,\n+â”Š  â”Š11â”Š    \"strictPropertyInitialization\": false,\n+â”Š  â”Š12â”Š    \"esModuleInterop\": true,\n+â”Š  â”Š13â”Š    \"experimentalDecorators\": true,\n+â”Š  â”Š14â”Š    \"emitDecoratorMetadata\": true\n+â”Š  â”Š15â”Š  }\n+â”Š  â”Š16â”Š}\n```\n\n[}]: #\n\nWe need to tell Typescript which files to compile. Those are in the `include` key.\n\nNow let's run `tsc` and see what happens.\n\nWe've got a new `index.js` file!  Now let's run it by running `node index.js`.\n\nThat's great, but doing this work each time we change a file can be annoying,\nso let's use tools to track when files change and make them run the code automatically after.\n\nAnd we will update the npm-script `start` to use `ts-node`, since we wanna use TypeScript, and not JavaScript directly:\n\n    start: ts-node index.ts\n\nWe can test the startup of our server again by running `$ yarn start` and we should see the message \"hello world\" printed to the console.\n\nThe skeleton of the project is set and we can move on to implementing the REST API.\n\nLike we said at the beginning, we will be using Express to setup the API. Express is a wrapper around the native [Node.JS \"http\"](https://nodejs.org/api/http.html) library which is responsible for handling HTTP requests.\nYes, it can also be used directly, but Express is much more comfortable and has an amazing ecosystem built around it.\nLet's install Express and its TypeScript definitions:\n\n    $ yarn add express\n    $ yarn add --dev @types/express\n\nBefore we implement the `GET /chats` route we will implement a `GET /_ping` route. This route will be used to determine whether the server is up and running or not, and how fast the connection is based on the response time.\nFor every request sent to this route, we should expect a response saying \"pong\".\nSome call it \"heartbeat\", because this route is being tested repeatedly by the hosting machine to check if it's alive, just like a heartbeat in a way.\nThis is how the route should look like:\n\n[{]: <helper> (diffStep \"1.3\" files=\"index.ts\" module=\"server\")\n\n#### [Server Step 1.3: Setup a Express with a basic health check route](https://github.com/Urigo/WhatsApp-Clone-Server/commit/4a60e4b)\n\n##### Changed index.ts\n```diff\n@@ -1 +1,13 @@\n-â”Š 1â”Š  â”Šconsole.log('hello world')\n+â”Š  â”Š 1â”Šimport express from 'express'\n+â”Š  â”Š 2â”Š\n+â”Š  â”Š 3â”Šconst app = express()\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šapp.get('/_ping', (req, res) => {\n+â”Š  â”Š 6â”Š  res.send('pong')\n+â”Š  â”Š 7â”Š})\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Šconst port = process.env.PORT || 4000\n+â”Š  â”Š10â”Š\n+â”Š  â”Š11â”Šapp.listen(port, () => {\n+â”Š  â”Š12â”Š  console.log(`Server is listening on port ${port}`)\n+â”Š  â”Š13â”Š})\n```\n\n[}]: #\n\nWe can use the\n\n        `$ curl localhost:4000/_ping`\n\ncommand to send a request to the server and we should get a \"pong\", assuming that the server available on that URL.\nThe `GET /chats` should be implemented similarly, only the response is different. Instead of returning \"pong\" we will return the data-mock for our chats:\n\n[{]: <helper> (diffStep \"1.4\" files=\"index.ts, db.ts\" module=\"server\")\n\n#### [Server Step 1.4: Create GET /chats route](https://github.com/Urigo/WhatsApp-Clone-Server/commit/e216866)\n\n##### Added db.ts\n```diff\n@@ -0,0 +1,49 @@\n+â”Š  â”Š 1â”Šexport const messages = [\n+â”Š  â”Š 2â”Š  {\n+â”Š  â”Š 3â”Š    id: '1',\n+â”Š  â”Š 4â”Š    content: \"You on your way?\",\n+â”Š  â”Š 5â”Š    createdAt: new Date(new Date('1-1-2019').getTime() - 60 * 1000 * 1000),\n+â”Š  â”Š 6â”Š  },\n+â”Š  â”Š 7â”Š  {\n+â”Š  â”Š 8â”Š    id: '2',\n+â”Š  â”Š 9â”Š    content: \"Hey, it's me\",\n+â”Š  â”Š10â”Š    createdAt: new Date(new Date('1-1-2019').getTime() - 2 * 60 * 1000 * 1000),\n+â”Š  â”Š11â”Š  },\n+â”Š  â”Š12â”Š  {\n+â”Š  â”Š13â”Š    id: '3',\n+â”Š  â”Š14â”Š    content: \"I should buy a boat\",\n+â”Š  â”Š15â”Š    createdAt: new Date(new Date('1-1-2019').getTime() - 24 * 60 * 1000 * 1000),\n+â”Š  â”Š16â”Š  },\n+â”Š  â”Š17â”Š  {\n+â”Š  â”Š18â”Š    id: '4',\n+â”Š  â”Š19â”Š    content: \"This is wicked good ice cream.\",\n+â”Š  â”Š20â”Š    createdAt: new Date(new Date('1-1-2019').getTime() - 14 * 24 * 60 * 1000 * 1000),\n+â”Š  â”Š21â”Š  },\n+â”Š  â”Š22â”Š]\n+â”Š  â”Š23â”Š\n+â”Š  â”Š24â”Šexport const chats = [\n+â”Š  â”Š25â”Š  {\n+â”Š  â”Š26â”Š    id: '1',\n+â”Š  â”Š27â”Š    name: 'Ethan Gonzalez',\n+â”Š  â”Š28â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n+â”Š  â”Š29â”Š    lastMessage: '1',\n+â”Š  â”Š30â”Š  },\n+â”Š  â”Š31â”Š  {\n+â”Š  â”Š32â”Š    id: '2',\n+â”Š  â”Š33â”Š    name: 'Bryan Wallace',\n+â”Š  â”Š34â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n+â”Š  â”Š35â”Š    lastMessage: '2',\n+â”Š  â”Š36â”Š  },\n+â”Š  â”Š37â”Š  {\n+â”Š  â”Š38â”Š    id: '3',\n+â”Š  â”Š39â”Š    name: 'Avery Stewart',\n+â”Š  â”Š40â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n+â”Š  â”Š41â”Š    lastMessage: '3',\n+â”Š  â”Š42â”Š  },\n+â”Š  â”Š43â”Š  {\n+â”Š  â”Š44â”Š    id: '4',\n+â”Š  â”Š45â”Š    name: 'Katie Peterson',\n+â”Š  â”Š46â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n+â”Š  â”Š47â”Š    lastMessage: '4',\n+â”Š  â”Š48â”Š  },\n+â”Š  â”Š49â”Š]\n```\n\n##### Changed index.ts\n```diff\n@@ -1,4 +1,5 @@\n â”Š1â”Š1â”Šimport express from 'express'\n+â”Š â”Š2â”Šimport { chats } from './db'\n â”Š2â”Š3â”Š\n â”Š3â”Š4â”Šconst app = express()\n â”Š4â”Š5â”Š\n```\n```diff\n@@ -6,6 +7,10 @@\n â”Š 6â”Š 7â”Š  res.send('pong')\n â”Š 7â”Š 8â”Š})\n â”Š 8â”Š 9â”Š\n+â”Š  â”Š10â”Šapp.get('/chats', (req, res) => {\n+â”Š  â”Š11â”Š  res.json(chats)\n+â”Š  â”Š12â”Š})\n+â”Š  â”Š13â”Š\n â”Š 9â”Š14â”Šconst port = process.env.PORT || 4000\n â”Š10â”Š15â”Š\n â”Š11â”Š16â”Šapp.listen(port, () => {\n```\n\n[}]: #\n\nTODO: Mention `_req`\n\nCheck we can get the chats by running:\n\n        `$ curl localhost:4000/chats`\n\nUnlike the previous route, we used the `.json()` method this time around to send a response. This will simply stringify the given JSON and set the right headers.\nSimilarly to the client, we've defined the db mock in a dedicated file, as this is easier to maintain and look at.\n\nIt's also recommended to connect a middleware called [`cors`](https://www.npmjs.com/package/cors) which will enable cross-origin requests.\nWithout it we will only be able to make requests in localhost, something which is likely to limit us in the future because we would probably host our server somewhere separate than the client application.\nWithout it it will also be impossible to call the server from our client app.\nLet's install the `cors` library and load it with the Express `middleware()` function:\n\n    $ yarn add cors\n\nand its Typescript types:\n\n\n    $ yarn add --dev @types/cors\n\n[{]: <helper> (diffStep \"1.4\" files=\"index.ts\" module=\"server\")\n\n#### [Server Step 1.4: Create GET /chats route](https://github.com/Urigo/WhatsApp-Clone-Server/commit/e216866)\n\n##### Changed index.ts\n```diff\n@@ -1,4 +1,5 @@\n â”Š1â”Š1â”Šimport express from 'express'\n+â”Š â”Š2â”Šimport { chats } from './db'\n â”Š2â”Š3â”Š\n â”Š3â”Š4â”Šconst app = express()\n â”Š4â”Š5â”Š\n```\n```diff\n@@ -6,6 +7,10 @@\n â”Š 6â”Š 7â”Š  res.send('pong')\n â”Š 7â”Š 8â”Š})\n â”Š 8â”Š 9â”Š\n+â”Š  â”Š10â”Šapp.get('/chats', (req, res) => {\n+â”Š  â”Š11â”Š  res.json(chats)\n+â”Š  â”Š12â”Š})\n+â”Š  â”Š13â”Š\n â”Š 9â”Š14â”Šconst port = process.env.PORT || 4000\n â”Š10â”Š15â”Š\n â”Š11â”Š16â”Šapp.listen(port, () => {\n```\n\n[}]: #\n\nThe server is now ready to use!\n\nSo getting back to the client, first we will define our server's URL under the `.env` file:\n\n[{]: <helper> (diffStep \"3.1\" module=\"client\")\n\n#### Client Step 3.1: Define server URL\n\n##### Added .env\n```diff\n@@ -0,0 +1 @@\n+â”Š â”Š1â”ŠREACT_APP_SERVER_URL=http://localhost:4000ðŸš«â†µ\n```\n\n[}]: #\n\nThis will make our server's URL available under the `process.env.REACT_APP_SERVER_URL` member expression and it will be replaced with a fixed value at build time, just like macros.\nThe `.env` file is a file which will automatically be loaded to `process.env` by the [`dotenv`](https://www.npmjs.com/package/dotenv) NPM package.\n`react-scripts` then filters environment variables which have a `REACT_APP_` prefix and provides the created JSON to a Webpack plugin called [DefinePlugin](https://webpack.js.org/plugins/define-plugin/), which will result in the macro effect.\n\nNow let's move back into our React app folder.\nWe will now replace the local data-mock usage with a fetch from the server.\nFor that we can use the native [fetch API](https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API),\nhowever, it needs to be used in the right life-cycle hook of the React.Component.\n\nThere are 2 naive approaches for that:\n\n- Calling `fetch()` outside the component, but this way that chats will be fetched even if we're not even intending to create an instance of the component.\n\n```js\nfetch().then(() => /* ... */)\nconst MyComponent = () => {}\n```\n\n- Calling `fetch()` inside the component, but then it will be invoked whenever the component is re-rendered.\n\n```js\nconst MyComponent = () => {\n  fetch().then(() => /* ... */)\n}\n```\n\nThese 2 approaches indeed work, but they both fail to deliver what's necessary on the right time.\nIn addition, there's no way to properly coordinate async function calls with the render method of the component.\n\n**Introducing: React hooks**\n\nWith React hooks we can invoke the desired logic in the right life-cycle stage of the target component.\nThis way we can avoid potential memory leaks or extra calculations.\nTo implement a proper `fetch()`, we will be using 2 React hooks:\n\n- [`React.useState()`](https://reactjs.org/docs/hooks-reference.html#usestate) - which is used to get and set a state of the component - will be used to store the chats fetched from the server.\n\n```js\nconst [value, setValue] = useState(initialValue);\n```\n\n- [`React.useMemo()`](https://reactjs.org/docs/hooks-reference.html#usememo) - which is used to run a computation only once certain conditions were met - will be used to run the `fetch()` function only once the component has mounted.\n\n```js\nconst memoizedValue = useMemo(calcFn, [cond1, cond2, ...conds]);\n```\n\nThe result of that approach will look like this, in the context of our ChatsList component:\n\n[{]: <helper> (diffStep \"3.2\" module=\"client\")\n\n#### Client Step 3.2: Fetch chats using native fetch API instead of mock DB\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -1,8 +1,8 @@\n â”Š1â”Š1â”Šimport React from 'react';\n-â”Š2â”Š â”Šimport { chats } from '../../db';\n â”Š3â”Š2â”Šimport moment from 'moment';\n â”Š4â”Š3â”Šimport { List, ListItem } from '@material-ui/core';\n â”Š5â”Š4â”Šimport styled from 'styled-components';\n+â”Š â”Š5â”Šimport { useState, useMemo } from 'react';\n â”Š6â”Š6â”Š\n â”Š7â”Š7â”Šconst Container = styled.div `\n â”Š8â”Š8â”Š  height: calc(100% - 56px);\n```\n```diff\n@@ -56,25 +56,35 @@\n â”Š56â”Š56â”Š  font-size: 13px;\n â”Š57â”Š57â”Š`;\n â”Š58â”Š58â”Š\n-â”Š59â”Š  â”Šconst ChatsList = () => (\n-â”Š60â”Š  â”Š  <Container>\n-â”Š61â”Š  â”Š    <StyledList>\n-â”Š62â”Š  â”Š      {chats.map((chat) => (\n-â”Š63â”Š  â”Š        <StyledListItem key={chat.id} button>\n-â”Š64â”Š  â”Š          <ChatPicture src={chat.picture} alt=\"Profile\"/>\n-â”Š65â”Š  â”Š          <ChatInfo>\n-â”Š66â”Š  â”Š            <ChatName>{chat.name}</ChatName>\n-â”Š67â”Š  â”Š            {chat.lastMessage && (\n-â”Š68â”Š  â”Š              <React.Fragment>\n-â”Š69â”Š  â”Š                <MessageContent>{chat.lastMessage.content}</MessageContent>\n-â”Š70â”Š  â”Š                <MessageDate>{moment(chat.lastMessage.createdAt).format('HH:mm')}</MessageDate>\n-â”Š71â”Š  â”Š              </React.Fragment>\n-â”Š72â”Š  â”Š            )}\n-â”Š73â”Š  â”Š          </ChatInfo>\n-â”Š74â”Š  â”Š        </StyledListItem>\n-â”Š75â”Š  â”Š      ))}\n-â”Š76â”Š  â”Š    </StyledList>\n-â”Š77â”Š  â”Š  </Container>\n-â”Š78â”Š  â”Š);\n+â”Š  â”Š59â”Šconst ChatsList = () => {\n+â”Š  â”Š60â”Š  const [chats, setChats] = useState<any[]>([]);\n+â”Š  â”Š61â”Š\n+â”Š  â”Š62â”Š  useMemo(async () => {\n+â”Š  â”Š63â”Š    const body = await fetch(`${process.env.REACT_APP_SERVER_URL}/chats`);\n+â”Š  â”Š64â”Š    const chats = await body.json();\n+â”Š  â”Š65â”Š    setChats(chats);\n+â”Š  â”Š66â”Š  }, []);\n+â”Š  â”Š67â”Š\n+â”Š  â”Š68â”Š  return (\n+â”Š  â”Š69â”Š    <Container>\n+â”Š  â”Š70â”Š      <StyledList>\n+â”Š  â”Š71â”Š        {chats.map((chat) => (\n+â”Š  â”Š72â”Š          <StyledListItem key={chat!.id} button>\n+â”Š  â”Š73â”Š            <ChatPicture src={chat.picture} alt=\"Profile\"/>\n+â”Š  â”Š74â”Š            <ChatInfo>\n+â”Š  â”Š75â”Š              <ChatName>{chat.name}</ChatName>\n+â”Š  â”Š76â”Š              {chat.lastMessage && (\n+â”Š  â”Š77â”Š                <React.Fragment>\n+â”Š  â”Š78â”Š                  <MessageContent>{chat.lastMessage.content}</MessageContent>\n+â”Š  â”Š79â”Š                  <MessageDate>{moment(chat.lastMessage.createdAt).format('HH:mm')}</MessageDate>\n+â”Š  â”Š80â”Š                </React.Fragment>\n+â”Š  â”Š81â”Š              )}\n+â”Š  â”Š82â”Š            </ChatInfo>\n+â”Š  â”Š83â”Š          </StyledListItem>\n+â”Š  â”Š84â”Š        ))}\n+â”Š  â”Š85â”Š      </StyledList>\n+â”Š  â”Š86â”Š    </Container>\n+â”Š  â”Š87â”Š  )\n+â”Š  â”Š88â”Š};\n â”Š79â”Š89â”Š\n â”Š80â”Š90â”Šexport default ChatsList;ðŸš«â†µ\n```\n\n##### Deleted src&#x2F;db.ts\n```diff\n@@ -1,49 +0,0 @@\n-â”Š 1â”Š  â”Šexport const messages = [\n-â”Š 2â”Š  â”Š  {\n-â”Š 3â”Š  â”Š    id: 1,\n-â”Š 4â”Š  â”Š    content: \"You on your way?\",\n-â”Š 5â”Š  â”Š    createdAt: new Date(Date.now() - 60 * 1000 * 1000),\n-â”Š 6â”Š  â”Š  },\n-â”Š 7â”Š  â”Š  {\n-â”Š 8â”Š  â”Š    id: 2,\n-â”Š 9â”Š  â”Š    content: \"Hey, it's me\",\n-â”Š10â”Š  â”Š    createdAt: new Date(Date.now() - 2 * 60 * 1000 * 1000),\n-â”Š11â”Š  â”Š  },\n-â”Š12â”Š  â”Š  {\n-â”Š13â”Š  â”Š    id: 3,\n-â”Š14â”Š  â”Š    content: \"I should buy a boat\",\n-â”Š15â”Š  â”Š    createdAt: new Date(Date.now() - 24 * 60 * 1000 * 1000),\n-â”Š16â”Š  â”Š  },\n-â”Š17â”Š  â”Š  {\n-â”Š18â”Š  â”Š    id: 4,\n-â”Š19â”Š  â”Š    content: \"This is wicked good ice cream.\",\n-â”Š20â”Š  â”Š    createdAt: new Date(Date.now() - 14 * 24 * 60 * 1000 * 1000),\n-â”Š21â”Š  â”Š  },\n-â”Š22â”Š  â”Š];\n-â”Š23â”Š  â”Š\n-â”Š24â”Š  â”Šexport const chats = [\n-â”Š25â”Š  â”Š  {\n-â”Š26â”Š  â”Š    id: 1,\n-â”Š27â”Š  â”Š    name: 'Ethan Gonzalez',\n-â”Š28â”Š  â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n-â”Š29â”Š  â”Š    lastMessage: messages.find(m => m.id === 1),\n-â”Š30â”Š  â”Š  },\n-â”Š31â”Š  â”Š  {\n-â”Š32â”Š  â”Š    id: 2,\n-â”Š33â”Š  â”Š    name: 'Bryan Wallace',\n-â”Š34â”Š  â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n-â”Š35â”Š  â”Š    lastMessage: messages.find(m => m.id === 2),\n-â”Š36â”Š  â”Š  },\n-â”Š37â”Š  â”Š  {\n-â”Š38â”Š  â”Š    id: 3,\n-â”Š39â”Š  â”Š    name: 'Avery Stewart',\n-â”Š40â”Š  â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n-â”Š41â”Š  â”Š    lastMessage: messages.find(m => m.id === 3),\n-â”Š42â”Š  â”Š  },\n-â”Š43â”Š  â”Š  {\n-â”Š44â”Š  â”Š    id: 4,\n-â”Š45â”Š  â”Š    name: 'Katie Peterson',\n-â”Š46â”Š  â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n-â”Š47â”Š  â”Š    lastMessage: messages.find(m => m.id === 4),\n-â”Š48â”Š  â”Š  },\n-â”Š49â”Š  â”Š];ðŸš«â†µ\n```\n\n[}]: #\n\n> It's recommended to read about React hooks and their basic concept at the [official React docs page](https://reactjs.org/docs/hooks-overview.html).\n\nAt this point we can get rid of `db.ts` file in the client, since we don't use it anymore:\n\n    $ rm src/db.ts\n\nThat's it. Our ChatsListScreen is now connected to a working back-end.\nIn the next step we will upgrade our REST API into a GraphQL API and we will create a basis for a more robust back-end.\n\n-------------\nTODO:\n\nFirst, `tsc` has a `--watch` option so that if the Typescript files changed it will compile them again and spit new Javascript files.\n\nThen we need to rerun the Node server everytime the output Javascript files has changed.\n[nodemon](https://github.com/remy/nodemon) is a tool that tracks file and if the files changed it will re-run our node server.\n\nLet's create a new npm script called \"watch\" and make it run both tools:\n\nTODO: New diff\n\nTODO: https://stackoverflow.com/a/39172660/1426570\n\nTODO: Better watch, also watch and copy schema files (maybe in a later chapter)?\n\nTODO: concurrently - because it works on all environments\n\nTODO: Explain what -r register command does in Node and in Jest\n\nTODO: Talk about the difference between graphql-import and graphql-import-node\n\nTODO: Show debugging\n\n\nIt's a bit annoying that we get the compiled file right next to our Typescript file, so let's move it into a separate folder:\n\nTODO: New diff for the `lib` folder update\n\nTODO: why `useMemo(fn, [true])` instead of `useEffect(fn, [])` ?\n\nTODO: Move to hooks in a separate commit and later change to call the server"
          },
          {
            "manualTitle": "Step 4: Transition to GraphQL",
            "stepRevision": "1eeb3a1eff7815775bc8b005f08fd99935f2ba29",
            "manualView": "**What is GraphQL?**\n\n[GraphQL](https://graphql.org/) is a query language invented by Facebook, and it's used to query data within from a schema.\nIn our case, we will create a schema for the data that our server exposes through its API.\nIt allows clients to define the structure of the data required, and the exact same structure of data will be returned from the server,\ntherefore preventing excessively large amounts of data from being returned.\nUnlike REST, GraphQL APIs are organized in terms of types and fields, not endpoints.\n\nEven if we use GraphQL without a server, it can save us a lot of code and work becuase it can transform data in a very easy way from a schema to a query.\n\nCurrently in our app, if we'd like to get its chats we would send a GET request to `/chats`.\nWith GraphQL it would be done differently with a string that describes the data that we would like to get:\n\n```graphql\nchats {\n  id\n  name\n  picture\n  lastMessage {\n    id\n    content\n    createdAt\n  }\n}\n```\n\n> Above: An illustration of a potential GraphQL query sent to our Whatsapp API\n\n**Why GraphQL and not REST?**\n\nREST has been used for many more years and has proven itself to work well, and it's completely agnostic to the implementation of the back-end.\nHowever, when it comes to data projection and aggregation, it fails to deliver.\n\nWhen using REST, often times you'll find yourself performing multiple requests to execute a single query of data.\nNot only that, you might even end up with additional data that is not necessary.\nEither way, the process would result in slower and heavier response.\n\nWith GraphQL we donâ€™t have that kind of problem. The API is based on a schema built from many entities that we call object types.\nThink of GraphQL as something similar to TypeScript but for API.\nObject types are like interfaces, they describe the shape of an entity.\n\nIn TypeScript you would describe a Chat as:\n\n```\ninterface Chat {\n  id: string;\n  name: string;\n  picture: string;\n  lastMessage: Message;\n}\n\ninterface Message {\n  id: string;\n  content: string;\n  createdAt: number;\n}\n```\n\nGraphQL:\n\n```\ntype Chat {\n  id: String\n  name: String\n  picture: String\n  lastMessage: Message\n}\n\ntype Message {\n  id: String\n  content: String\n  createdAt: Float\n}\n```\n\nLooks pretty similar?\n\nSo this is the definition of the available data, now let's see how we can pick and structure data from it using a query:\n\n```graphql\n# request\nchats {\n  id\n  name\n  picture\n  lastMessage {\n    id\n    content\n    createdAt\n  }\n}\n```\n\nWe think itâ€™s pretty straightforward to understand what do you fetch by just looking at the query above.\n\n![graphql-request](https://user-images.githubusercontent.com/7648874/54133620-5aec8300-4451-11e9-9bda-a459dc48f57c.png)\n\nIf you would execute that query the result might look like this:\n\n```js\n// response\n{\n  chats: [{\n    id: â€œ1â€,\n    name: â€œEthan Gonzalezâ€,\n    picture: â€œhttps://randomuser.me/api/portraits/thumb/men/1.jpgâ€,\n    lastMessage: {\n      id: â€œ1â€,\n      content: \"You on your way?\",\n      createdAt: 1234567890\n  }]\n}\n```\n\nYou'll get exactly what you asked for with a single request. GraphQL provides a dynamic API while REST doesn't.\n\n**GraphQL schema, in a nutshell**\n\nLike said earlier,  GraphQL APIs are organized in terms of types and fields.\nThat means that our app data should be described with a schema, where each field's gonna have a resolver - the handler that will return the corresponding data.\nThings will be much clearer as we move further.\n\nLet's try to describe our app's data with a GraphQL schema and then dive into it:\n\n```graphql\nscalar Date\n\ntype Message {\n  id: ID!\n  content: String!\n  createdAt: Date!\n}\n\ntype Chat {\n  id: ID!\n  name: String!\n  picture: String\n  lastMessage: Message\n}\n\ntype Query {\n  chats: [Chat!]!\n}\n```\n\nThe schema is self explanatory in terms of what data it's compatible with. Supported built-in scalar types in GraphQL are:\n\n- Int: Signed 32â€bit integer\n- Float: Signed double-precision floating-point value\n- String: UTFâ€8 character sequence\n- Boolean: true or false\n- ID (serialized as String): A unique identifier, often used to refetch an object or as the key for a cache.\nWhile serialized as a String, ID signifies that it is not intended to be humanâ€readable\n\nAny custom scalar can be declared with the `scalar` keyword, and custom types can be declared with the `type` keyword.\nHowever, you should know that some types are reserved by GraphQL itself; `Query` is one of them.\nThe `Query` type will be used as the root for received queries by the clients, which means that we can send queries which start with the `chats` field.\nOther reserved types are:\n\n- `type Query` - reserved for [GraphQL queries](https://graphql.org/learn/queries/#mutations).\n- `type Mutation` - reserved for [GraphQL mutations.](https://graphql.github.io/learn/queries/)\n- `type Subscription` - reserved for [GraphQL subscriptions.](https://www.apollographql.com/docs/react/advanced/subscriptions.html)\n\n> As we're not gonna go through the entire GraphQL API, it's recommended to go through the [official learn section of the GraphQL website](https://graphql.org/learn/), but the information so far will definitely help you kick-start, plus the upcoming implementation.\n\n**Getting started**\n\nWe will be implementing a GraphQL mechanism for the client and for the server.\nWe will start with the server as things will make more sense, and we will be able to test it before we proceed into the client.\nEssentially GraphQL is connected into a HTTP endpoint, usually under `POST /graphql`, and so this is exactly what we're gonna do, connect the endpoint handler.\nLuckily, we don't have to implement that. A team called [Apollo](https://www.apollographql.com/) already did it for us, so we can use their implementation.\nWe will install the required packages:\n\n    $ yarn add apollo-server-express body-parser graphql\n    $ yarn add --dev @types/body-parser @types/graphql\n\n- [`graphql`](https://www.npmjs.com/package/graphql) - The core package of GraphQL that includes the resolvers for basic data-types.\n- [`apollo-server-express`](https://www.npmjs.com/package/apollo-server-express) - Apollo's implementation for the GraphQL Express REST endpoint.\n- [`body-parser`](https://www.npmjs.com/package/body-parser) - Parse incoming request bodies in a middleware before your handlers, available under the req.body property.\n- `@types/â€¦` - TypeScript definitions. Notice that we didn't need to install Apollo's types library. That is because Apollo themselves writes their source code in Typescript so\nwe get a ready Typescript code directly from their library.\n\nWe can now connect Apollo's middleware under the `/graphql` route:\n\n[{]: <helper> (diffStep \"2.1\" files=\"index.ts\" module=\"server\")\n\n#### [Server Step 2.1: Setup Apollo GraphQL](https://github.com/Urigo/WhatsApp-Clone-Server/commit/b988e04)\n\n##### Changed index.ts\n```diff\n@@ -1,10 +1,14 @@\n+â”Š  â”Š 1â”Šimport { ApolloServer, gql } from 'apollo-server-express'\n+â”Š  â”Š 2â”Šimport bodyParser from 'body-parser'\n â”Š 1â”Š 3â”Šimport cors from 'cors'\n â”Š 2â”Š 4â”Šimport express from 'express'\n â”Š 3â”Š 5â”Šimport { chats } from './db'\n+â”Š  â”Š 6â”Šimport schema from './schema'\n â”Š 4â”Š 7â”Š\n â”Š 5â”Š 8â”Šconst app = express()\n â”Š 6â”Š 9â”Š\n â”Š 7â”Š10â”Šapp.use(cors())\n+â”Š  â”Š11â”Šapp.use(bodyParser.json())\n â”Š 8â”Š12â”Š\n â”Š 9â”Š13â”Šapp.get('/_ping', (req, res) => {\n â”Š10â”Š14â”Š  res.send('pong')\n```\n```diff\n@@ -14,6 +18,13 @@\n â”Š14â”Š18â”Š  res.json(chats)\n â”Š15â”Š19â”Š})\n â”Š16â”Š20â”Š\n+â”Š  â”Š21â”Šconst server = new ApolloServer({ schema })\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Šserver.applyMiddleware({\n+â”Š  â”Š24â”Š  app,\n+â”Š  â”Š25â”Š  path: '/graphql',\n+â”Š  â”Š26â”Š})\n+â”Š  â”Š27â”Š\n â”Š17â”Š28â”Šconst port = process.env.PORT || 4000\n â”Š18â”Š29â”Š\n â”Š19â”Š30â”Šapp.listen(port, () => {\n```\n\n[}]: #\n\nAs you can see, the middleware requires a schema. A schema is composed mainly out of 2 fields:\n\n- `typeDefs` (type definitions) - the schema types we wrote earlier this chapter for chats.\n- `resolvers` - The handlers that will provide the data for each field in `typeDefs`.\n\nWe will start first by defining the types.\nAll we have to do is to copy-paste the contents of the schema that was shown earlier into a new file called `typeDefs.graphql`:\n\n[{]: <helper> (diffStep \"2.2\" files=\"schema/typeDefs.graphql\" module=\"server\")\n\n#### [Server Step 2.2: Create a basic GraphQL schema](https://github.com/Urigo/WhatsApp-Clone-Server/commit/ff4c53d)\n\n##### Added schema&#x2F;typeDefs.graphql\n```diff\n@@ -0,0 +1,18 @@\n+â”Š  â”Š 1â”Šscalar Date\n+â”Š  â”Š 2â”Š\n+â”Š  â”Š 3â”Štype Message {\n+â”Š  â”Š 4â”Š  id: ID!\n+â”Š  â”Š 5â”Š  content: String!\n+â”Š  â”Š 6â”Š  createdAt: Date!\n+â”Š  â”Š 7â”Š}\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Štype Chat {\n+â”Š  â”Š10â”Š  id: ID!\n+â”Š  â”Š11â”Š  name: String!\n+â”Š  â”Š12â”Š  picture: String\n+â”Š  â”Š13â”Š  lastMessage: Message\n+â”Š  â”Š14â”Š}\n+â”Š  â”Š15â”Š\n+â”Š  â”Š16â”Štype Query {\n+â”Š  â”Š17â”Š  chats: [Chat!]!\n+â”Š  â”Š18â”Š}\n```\n\n[}]: #\n\nThe `.graphql` file extension is just a more convenient way to work with a GraphQL schema. The exported result should be a simple string that we can use to compose our GraphQL schema. The clear advantage of working with a dedicated file is that we get to have syntax highlight.\n\nNow we will implement the resolvers. Resolvers are presented in a JSON object where each resolver name should match the field name it represents. You can read more about resolvers in [Apollo's official docs for resolvers](https://www.apollographql.com/docs/tutorial/resolvers.html). This is how our resolvers should look like:\n\n[{]: <helper> (diffStep \"2.2\" files=\"schema/resolvers.ts\" module=\"server\")\n\n#### [Server Step 2.2: Create a basic GraphQL schema](https://github.com/Urigo/WhatsApp-Clone-Server/commit/ff4c53d)\n\n##### Added schema&#x2F;resolvers.ts\n```diff\n@@ -0,0 +1,14 @@\n+â”Š  â”Š 1â”Šimport { GraphQLDateTime } from 'graphql-iso-date'\n+â”Š  â”Š 2â”Šimport { chats } from '../db'\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šconst resolvers = {\n+â”Š  â”Š 5â”Š  Date: GraphQLDateTime,\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Š  Query: {\n+â”Š  â”Š 8â”Š    chats() {\n+â”Š  â”Š 9â”Š      return chats\n+â”Š  â”Š10â”Š    },\n+â”Š  â”Š11â”Š  },\n+â”Š  â”Š12â”Š}\n+â”Š  â”Š13â”Š\n+â”Š  â”Š14â”Šexport default resolvers\n```\n\n[}]: #\n\nFor now it's extremely simple, we map the chats query directly into the database collection. Each field in the resolvers object should match the GraphQL type it represents in the schema. Since we don't have any logic now, we should not implement any resolvers for the rest of the types, the data will simply be forwarded as is.\n\nNote that we've implemented a custom scalar named `Date` and we resolved it with an NPM package. Let's install it:\n\n    $ yarn add graphql-iso-date\n    $ yarn add --dev @types/graphql-iso-date\n\nFinal thing that we have to do would be combining the resolvers and the type-defs under a single GraphQL schema.\n\n[{]: <helper> (diffStep \"2.2\" files=\"index.ts\" module=\"server\")\n\n#### [Server Step 2.2: Create a basic GraphQL schema](https://github.com/Urigo/WhatsApp-Clone-Server/commit/ff4c53d)\n\n##### Added schema&#x2F;index.ts\n```diff\n@@ -0,0 +1,7 @@\n+â”Š â”Š1â”Šimport { importSchema } from 'graphql-import'\n+â”Š â”Š2â”Šimport { makeExecutableSchema } from 'graphql-tools'\n+â”Š â”Š3â”Šimport resolvers from './resolvers'\n+â”Š â”Š4â”Š\n+â”Š â”Š5â”Šconst typeDefs = importSchema('schema/typeDefs.graphql')\n+â”Š â”Š6â”Š\n+â”Š â”Š7â”Šexport default makeExecutableSchema({ resolvers, typeDefs })\n```\n\n[}]: #\n\n[`graphql-tools`](https://www.npmjs.com/package/graphql-tools) is a library with a set of utilities that will help us create a schema that will be compatible with Apollo's API:\n\n    $ yarn add graphql-tools graphql-import\n\nThere's one optimization however that we should make in the our DB. Right now, the each chat document has a direct reference to a message via the `lastMessage` field. Practically speaking, this is NOT how the data sits in the DB. The `lastMessage` should only hold the ID for the correlated message, and then in the Node.JS app we should **resolve** it according to our needs. Let's make the appropriate changes in the DB then:\n\n[{]: <helper> (diffStep \"2.3\" files=\"db.ts\" module=\"server\")\n\n#### [Server Step 2.3: Resolve Chat.lastMessage](https://github.com/Urigo/WhatsApp-Clone-Server/commit/908839f)\n\n\n\n[}]: #\n\nAnd a resolver to the `lastMessage` field:\n\n[{]: <helper> (diffStep \"2.3\" files=\"schema/resolvers.ts\" module=\"server\")\n\n#### [Server Step 2.3: Resolve Chat.lastMessage](https://github.com/Urigo/WhatsApp-Clone-Server/commit/908839f)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,9 +1,15 @@\n â”Š 1â”Š 1â”Šimport { GraphQLDateTime } from 'graphql-iso-date'\n-â”Š 2â”Š  â”Šimport { chats } from '../db'\n+â”Š  â”Š 2â”Šimport { chats, messages } from '../db'\n â”Š 3â”Š 3â”Š\n â”Š 4â”Š 4â”Šconst resolvers = {\n â”Š 5â”Š 5â”Š  Date: GraphQLDateTime,\n â”Š 6â”Š 6â”Š\n+â”Š  â”Š 7â”Š  Chat: {\n+â”Š  â”Š 8â”Š    lastMessage(chat: any) {\n+â”Š  â”Š 9â”Š      return messages.find(m => m.id === chat.lastMessage)\n+â”Š  â”Š10â”Š    },\n+â”Š  â”Š11â”Š  },\n+â”Š  â”Š12â”Š\n â”Š 7â”Š13â”Š  Query: {\n â”Š 8â”Š14â”Š    chats() {\n â”Š 9â”Š15â”Š      return chats\n```\n\n[}]: #\n\nThe first argument of the resolver is the raw chat data received by the DB, and the returned result should be the mapped value which we would like to return to the client.\n\nAs we get further in this tutorial we should get a better grasp regards resolvers and their API, since we will have to deal with more logic and complexity within our Node.JS app.\n\nAssuming that the server is running, we can already test our GraphQL endpoint. Because it's exposed to us via a REST endpoint, we can use a `$ curl` command to send a request to `GET localhost:4000/graphql` and get a response with all the data. Again, the query that we're gonna use to fetch the chats is:\n\n```graphql\nchats {\n  id\n  name\n  picture\n  lastMessage {\n    id\n    content\n    createdAt\n  }\n}\n```\n\nThe one-liner version of it with a `$ curl` command looks like so:\n\n    curl \\\n      -X POST \\\n      -H \"Content-Type: application/json\" \\\n      --data '{ \"query\": \"{ chats { id name picture lastMessage { id content createdAt } } }\" }' \\\n      localhost:4000/graphql\n\nAs a response we should get the data-mock for our chats stored in the server. Since we have that in place, we can go ahead and delete our implementation for the `GET /chats` route.\n\nAnother way to test and inspect our GraphQL schema would be by using an IDE for the browser called [GraphQL Playground](https://github.com/prisma/graphql-playground).\nApollo-Server ships with it right out of the box and can be used right away by navigating to the `http://localhost:4000/graphql` URL from the browser.\n\n[![](https://i.imgur.com/AE5W6OW.png)](https://graphqlbin.com/v2/6RQ6TM)\n\nSo getting back to the client, all we have to do is to change the fetching URL in the ChatsList component to use our newly implemented GraphQL REST endpoint:\n\n[{]: <helper> (diffStep \"4.1\" module=\"client\")\n\n#### Client Step 4.1: Replace REST call with GraphQL call\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -56,12 +56,33 @@\n â”Š56â”Š56â”Š  font-size: 13px;\n â”Š57â”Š57â”Š`;\n â”Š58â”Š58â”Š\n+â”Š  â”Š59â”Šconst getChatsQuery = `\n+â”Š  â”Š60â”Š  query GetChats {\n+â”Š  â”Š61â”Š    chats {\n+â”Š  â”Š62â”Š      id\n+â”Š  â”Š63â”Š      name\n+â”Š  â”Š64â”Š      picture\n+â”Š  â”Š65â”Š      lastMessage {\n+â”Š  â”Š66â”Š        id\n+â”Š  â”Š67â”Š        content\n+â”Š  â”Š68â”Š        createdAt\n+â”Š  â”Š69â”Š      }\n+â”Š  â”Š70â”Š    }\n+â”Š  â”Š71â”Š  }\n+â”Š  â”Š72â”Š`\n+â”Š  â”Š73â”Š\n â”Š59â”Š74â”Šconst ChatsList = () => {\n â”Š60â”Š75â”Š  const [chats, setChats] = useState<any[]>([]);\n â”Š61â”Š76â”Š\n â”Š62â”Š77â”Š  useMemo(async () => {\n-â”Š63â”Š  â”Š    const body = await fetch(`${process.env.REACT_APP_SERVER_URL}/chats`);\n-â”Š64â”Š  â”Š    const chats = await body.json();\n+â”Š  â”Š78â”Š    const body = await fetch(`${process.env.REACT_APP_SERVER_URL}/graphql`, {\n+â”Š  â”Š79â”Š      method: 'POST',\n+â”Š  â”Š80â”Š      headers: {\n+â”Š  â”Š81â”Š        'Content-Type': 'application/json',\n+â”Š  â”Š82â”Š      },\n+â”Š  â”Š83â”Š      body: JSON.stringify({ query: getChatsQuery }),\n+â”Š  â”Š84â”Š    });\n+â”Š  â”Š85â”Š    const { data: { chats } } = await body.json();\n â”Š65â”Š86â”Š    setChats(chats);\n â”Š66â”Š87â”Š  }, []);\n```\n\n[}]: #\n\nThe received data should be similar to the previous one.\nNo further changes are required.\n\nIn the next chapter, we will continue working on the UI of our front-end application and we will add a new screen to the flow - the `ChatRoomScreen`.\n\n-------\nTODO: Start with calling the  `graphql` function just on the server to show how it works.\nTODO: Separate step for body parser.\nTODO: Example middlewares in Node\nTODO: Mention the vs code extension\n\nTODO: Introduce the scalar type later on\n\nTODO: Start without Apollo and add it later, in the same file.\nTODO: remove `gql` import becuase it's unused\nTODO: Add visualizations of how GraphQL works\nTODO: import { loadSchema } from 'graphql-toolkit'; and install it\n\nTODO: What DB change is that?\nTODO: Type `lastMessage(chat: any) {`\nTOOD: Change `m` to `currentIteratedMessage`\n\nTODO: Why adding headers? and go through the code\n\nTODO: Talk about working with document node and not with makeExacutableSchema\n```\n×–×” ×œ× ×ž×©× ×” ×‘×ª×›×œ×¡, ×›×™ ApolloServer ×‘×›×œ ×ž×§×¨×” ×™×¢×©×” ×œ×–×” ×§×™×ž×¤×•×œ\n×”× ×§×•×“×” ×”×™× ×©×œ× ×¦×¨×™×š ×œ×§×ž×¤×œ ×¤×¢×ž×™×™× ×œGraphQLSchema\n×¤×©×•×˜ ×¢×“×™×£ ×©××ª ×”×§×™×ž×¤×•×œ ×™×¢×©×” ×”×¨×›×™×‘ ×”××—×¨×•×Ÿ ×©×”×•×œ×š ×œ×”×©×ª×ž×© ×‘typeDefs\n\nDocumentNode => DocumentNode (cheap, easy, no checks)\nDocumentNode => GraphQLSchema (compile AST, does all checking, might throw exceptions, expensive)\nGraphQLSchema => DocumentNode (printed version, might lost AST features such as directives)\n```"
          },
          {
            "manualTitle": "Step 5: Testing",
            "stepRevision": "74de26b395c828fde0285ed89d1bb6e82676e753",
            "manualView": "Testing is a crucial part when writing an application, especially if we're planning to publish it or make it a commercial thing. Before we hand someone a product, of any kind, we wanna make sure that it passes certain quality checks. We're signed on that product and so it's very important to ensure that it functions properly according our expectations, otherwise wouldn't wanna use it and will look for alternatives.\n\nIn the context of software, we constantly make changes. It's also inevitable to make all features completely independent from one another, so something in the app is likely to break as we upgrade it or maintain it. That's why we need to write a set of tests that can be run on demand, so when we implement a new feature we can simply run the tests and see what feature broke due to most recent changes.\n\nThere are currently 3 main testing frameworks in the NPM ecosystem: [Jasmine](https://jasmine.github.io/), [Mocha](https://mochajs.org/), and [Jest](https://jestjs.io/). Each testing framework has its pros, and cons, and at the end of the day it's a matter of preference. In our application we're gonna use [Jest](https://jestjs.io/) - a testing framework which was developed by Facebook. What's good about Jest is that it can be used to test both client and server logic, because it runs as a Node.JS application, but it also emulates the browser environment whenever we run it, thanks to [JSDOM](https://github.com/jsdom/jsdom).\n\n![jest](https://user-images.githubusercontent.com/7648874/54493900-e2ce0380-490f-11e9-8075-be4a236c7c38.png)\n\nIn this chapter we will learn how to test the React.Components in the client, and Apollo-GraphQL resolvers in the server. There are 3 kinds of tests:\n\n- Unit tests - which are used to test a single component, independently from other components in our system.\n- Integration tests - which are used to test a component in relation to other components in our systems (how well do they co-work with each other).\n- e2e tests (end to end) - which are used to test a complete, from the moment I clicked on a button in the user interface until the data gets back from the server and shown on the screen.\n\nThe efficiency of the tests go from bottom to top (unit -> e2e), but the maintenance and complexity go from bottom to top (e2e -> unit). Accordingly we will need to find a good balance where we donâ€™t spend too much time on writing tests yet have a good indicator for how well our system functions. So we should write a lot of unit tests, a good amount of integration tests and a handful of e2e tests.\n\n![tests-types-table](https://user-images.githubusercontent.com/7648874/54494121-fed2a480-4911-11e9-9370-694ec989729b.png)\n\nWe will start with the client as itâ€™s much easier, because Jest is set and ready to use right out of the box thanks to `create-react-app`.\n\n**Client - Testing React.Components**\n\nThanks to `create-react-app`, we have Jest set and ready to use right out of the box, so we can start writing tests right away. I you'll look at the `src` you'll see a file called `App.test.tsx`, which simply ensures that the component can be rendered without crashing.\n\n```jsx\nimport React from 'react';\nimport ReactDOM from 'react-dom';\nimport App from './App';\n\nit('renders without crashing', () => {\n  const div = document.createElement('div');\n  ReactDOM.render(<App />, div);\n  ReactDOM.unmountComponentAtNode(div);\n});\n```\n\nThis is not a typical test that you're likely to find in a React project, but it demonstrates very well how Jest can be used to test DOM related issues. If you'll run `$ npm run test` (or `$ yarn test`) in the command line and then press `a`, you should see the following output:\n\n![report](https://user-images.githubusercontent.com/7648874/54341429-eabe4700-4674-11e9-8e76-3aaaf7fec79a.png)\n\nJest will automatically run for every file that ends with a `.test.xxx` extension. This is very convenient because the tests can live right next to the component, and you don't need to lookup for it across the project. This behavior can be modified by configuring Jest in the `package.json` file under the `\"jest\"` field. More information about configuring Jest can be found in the official[ configuration documentation](https://jestjs.io/docs/en/configuration).\n\n> If you get a warning message regards wrapping the component with `act()` - this is a known issue with hooks and should have a proper solution soon. More about this issue and progress regards its fix can be found in this [GitHub thread](https://github.com/facebook/react/issues/14769#issuecomment-470097212).\n\nNow we're gonna write a basic test for the `<ChatsList />` component. In the test, we'll mock a fake response from the server, and examine the contents of rendered HTML. Since the HTML of the component is a dynamic thing and is constantly subject to changes, it would be a good idea to annotate it with `data-testid` attributes so it can be tested regardless of its structure:\n\n[{]: <helper> (diffStep \"5.1\" files=\"ChatsList.tsx\" module=\"client\")\n\n#### Client Step 5.1: Add data-testid attributes\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -90,14 +90,14 @@\n â”Š 90â”Š 90â”Š    <Container>\n â”Š 91â”Š 91â”Š      <StyledList>\n â”Š 92â”Š 92â”Š        {chats.map((chat) => (\n-â”Š 93â”Š   â”Š          <StyledListItem key={chat!.id} button>\n-â”Š 94â”Š   â”Š            <ChatPicture src={chat.picture} alt=\"Profile\"/>\n+â”Š   â”Š 93â”Š          <StyledListItem key={chat.id} button>\n+â”Š   â”Š 94â”Š            <ChatPicture data-testid=\"picture\" src={chat.picture} alt=\"Profile\"/>\n â”Š 95â”Š 95â”Š            <ChatInfo>\n-â”Š 96â”Š   â”Š              <ChatName>{chat.name}</ChatName>\n+â”Š   â”Š 96â”Š              <ChatName data-testid=\"name\">{chat.name}</ChatName>\n â”Š 97â”Š 97â”Š              {chat.lastMessage && (\n â”Š 98â”Š 98â”Š                <React.Fragment>\n-â”Š 99â”Š   â”Š                  <MessageContent>{chat.lastMessage.content}</MessageContent>\n-â”Š100â”Š   â”Š                  <MessageDate>{moment(chat.lastMessage.createdAt).format('HH:mm')}</MessageDate>\n+â”Š   â”Š 99â”Š                  <MessageContent data-testid=\"content\">{chat.lastMessage.content}</MessageContent>\n+â”Š   â”Š100â”Š                  <MessageDate data-testid=\"date\">{moment(chat.lastMessage.createdAt).format('HH:mm')}</MessageDate>\n â”Š101â”Š101â”Š                </React.Fragment>\n â”Š102â”Š102â”Š              )}\n â”Š103â”Š103â”Š            </ChatInfo>\n```\n\n[}]: #\n\nNow we can select various HTML elements with a query selector when we test the component. We will install a couple of packages that will assist us in implementing the test:\n\n  $ yarn add jest-fetch-mock jest-dom react-testing-library\n\n- The [`jest-fetch-mock`](https://www.npmjs.com/package/jest-fetch-mock) package can mock responses emitted by the Fetch API.\n- The [`jest-dom`](https://www.npmjs.com/package/jsdom) package will add custom matchers that will help us examine HTML contents of DOM elements.\n- The [`react-testing-library`](https://www.npmjs.com/package/react-testing-library) package contains utility methods that will help us test React.Components with Jest.\n\nNext, we will create a file under the `src` folder called `setupTests.ts`. This file is loaded configured automatically by `create-react-app` and loaded by Jest, and we can use it to set up our testing environment according to our needs (like said earlier, Jest can be configured, so this file path can be changed). We will use that file to define a fake Fetch API using the `jest-fetch-mock` library:\n\n[{]: <helper> (diffStep \"5.2\" files=\"src/setupTests.ts\" module=\"client\")\n\n#### Client Step 5.2: Setup tests\n\n##### Added src&#x2F;setupTests.ts\n```diff\n@@ -0,0 +1,7 @@\n+â”Š â”Š1â”Šimport 'jest-dom/extend-expect'\n+â”Š â”Š2â”Šimport { GlobalWithFetchMock } from 'jest-fetch-mock'\n+â”Š â”Š3â”Šimport { act } from 'react-testing-library'\n+â”Š â”Š4â”Š\n+â”Š â”Š5â”Šconst customGlobal: GlobalWithFetchMock = global as GlobalWithFetchMock\n+â”Š â”Š6â”ŠcustomGlobal.fetch = require('jest-fetch-mock')\n+â”Š â”Š7â”ŠcustomGlobal.fetchMock = customGlobal.fetch\n```\n\n[}]: #\n\nWe will create another file called `ChatsList.test.tsx`, right next to the `<ChatsList />` component under the `ChatsListScreen` directory, and inside we will implement our test. The test should follow these steps:\n\n- Mock the response to contain a fake chat, so we won't need to make an actual call to our GraphQL API.\n- We will create a new instance of `<ChatsList />` and render it in a container element.\n- We will wait for changes in the DOM caused by `setState()`.\n- We will test the contents of the container.\n\nAnd this is how the implementation should look like:\n\n[{]: <helper> (diffStep \"5.3\" files=\"src/components/ChatsListScreen/ChatsList.test.tsx\" module=\"client\")\n\n#### Client Step 5.3: Test ChatsList\n\n##### Added src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.test.tsx\n```diff\n@@ -0,0 +1,56 @@\n+â”Š  â”Š 1â”Šimport React from 'react';\n+â”Š  â”Š 2â”Šimport ReactDOM from 'react-dom';\n+â”Š  â”Š 3â”Šimport { cleanup, render, waitForDomChange } from 'react-testing-library';\n+â”Š  â”Š 4â”Šimport ChatsList from './ChatsList';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šdescribe('ChatsList', () => {\n+â”Š  â”Š 7â”Š  afterEach(cleanup);\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Š  it('renders fetched chats data', async () => {\n+â”Š  â”Š10â”Š    fetch.mockResponseOnce(JSON.stringify({\n+â”Š  â”Š11â”Š      data: {\n+â”Š  â”Š12â”Š        chats: [\n+â”Š  â”Š13â”Š          {\n+â”Š  â”Š14â”Š            id: 1,\n+â”Š  â”Š15â”Š            name: 'Foo Bar',\n+â”Š  â”Š16â”Š            picture: 'https://localhost:4000/picture.jpg',\n+â”Š  â”Š17â”Š            lastMessage: {\n+â”Š  â”Š18â”Š              id: 1,\n+â”Š  â”Š19â”Š              content: 'Hello',\n+â”Š  â”Š20â”Š              createdAt: new Date(0),\n+â”Š  â”Š21â”Š            },\n+â”Š  â”Š22â”Š          },\n+â”Š  â”Š23â”Š        ],\n+â”Š  â”Š24â”Š      },\n+â”Š  â”Š25â”Š    }));\n+â”Š  â”Š26â”Š\n+â”Š  â”Š27â”Š    {\n+â”Š  â”Š28â”Š      const { container, getByTestId } = render(<ChatsList />);\n+â”Š  â”Š29â”Š\n+â”Š  â”Š30â”Š      await waitForDomChange({ container });\n+â”Š  â”Š31â”Š\n+â”Š  â”Š32â”Š      expect(getByTestId('name')).toHaveTextContent('Foo Bar');\n+â”Š  â”Š33â”Š      expect(getByTestId('picture')).toHaveAttribute('src', 'https://localhost:4000/picture.jpg');\n+â”Š  â”Š34â”Š      expect(getByTestId('content')).toHaveTextContent('Hello');\n+â”Š  â”Š35â”Š      expect(getByTestId('date')).toHaveTextContent('01:00');\n+â”Š  â”Š36â”Š    }\n+â”Š  â”Š37â”Š  });\n+â”Š  â”Š38â”Š});\n+â”Š  â”Š39â”Š\n+â”Š  â”Š40â”Š// IMPORTANT\n+â”Š  â”Š41â”Š// Below is a temporary hack to suppress warnings generated by a React bug.\n+â”Š  â”Š42â”Š// Source: https://github.com/testing-library/react-testing-library/issues/281\n+â”Š  â”Š43â”Š// @todo: remove this when React 16.9.0 is stable and we upgrade.\n+â”Š  â”Š44â”Šconst originalError = console.error;\n+â”Š  â”Š45â”ŠbeforeAll(() => {\n+â”Š  â”Š46â”Š  console.error = (...args: string[]) => {\n+â”Š  â”Š47â”Š    if (/Warning.*not wrapped in act/.test(args[0])) {\n+â”Š  â”Š48â”Š      return;\n+â”Š  â”Š49â”Š    }\n+â”Š  â”Š50â”Š    originalError.call(console, ...args);\n+â”Š  â”Š51â”Š  };\n+â”Š  â”Š52â”Š});\n+â”Š  â”Š53â”Š\n+â”Š  â”Š54â”ŠafterAll(() => {\n+â”Š  â”Š55â”Š  console.error = originalError;\n+â”Š  â”Š56â”Š});\n```\n\n[}]: #\n\n> Jest API is vast but pretty intuitive for the most part. It mostly consists of test descriptors and matchers. [Here's a full list of all matchers which are built into Jest's API](https://jestjs.io/docs/en/expect). Always make sure to work against it when writing tests, for optimal results.\n\nWe will now move on to testing the server where we will learn how to setup Jest manually and test it against a GraphQL API.\n\n**Server - Testing GraphQL resolvers**\n\nTo set-up Jest, we will run the following in the command line:\n\n    $ yarn add --dev jest @types/jest ts-jest\n\n\nThis will basically install Jest and make it useable with TypeScript.\nIn addition, we will need to specify the file pattern that we would like to transform with [`ts-jest`](https://www.npmjs.com/package/ts-jest), by adding the following section to `package.json`:\n\n```\n{\n  \"jest\": {\n    \"transform\": {\n      \"^.+\\\\.(js|jsx|ts|tsx)$\": \"<rootDir>/node_modules/ts-jest\"\n    }\n  }\n}\n```\n\nWe will also add a `\"test\"` script in the `package.json` file,\nso we can run the tests with `$ yarn test`:\n\n```\n{\n  \"scripts\": {\n    \"test\": \"jest\"\n  }\n}\n```\n\nThis is how our `package.json` should look like at this point:\n\n[{]: <helper> (diffStep \"3.1\" files=\"package.json\" module=\"server\")\n\n#### [Server Step 3.1: Install and configure Jest](https://github.com/Urigo/WhatsApp-Clone-Server/commit/2712fc5)\n\n##### Changed package.json\n```diff\n@@ -7,7 +7,8 @@\n â”Š 7â”Š 7â”Š  },\n â”Š 8â”Š 8â”Š  \"private\": true,\n â”Š 9â”Š 9â”Š  \"scripts\": {\n-â”Š10â”Š  â”Š    \"start\": \"ts-node index.ts\"\n+â”Š  â”Š10â”Š    \"start\": \"ts-node index.ts\",\n+â”Š  â”Š11â”Š    \"test\": \"jest\"\n â”Š11â”Š12â”Š  },\n â”Š12â”Š13â”Š  \"devDependencies\": {\n â”Š13â”Š14â”Š    \"@types/body-parser\": \"1.17.0\",\n```\n```diff\n@@ -15,7 +16,10 @@\n â”Š15â”Š16â”Š    \"@types/express\": \"4.16.1\",\n â”Š16â”Š17â”Š    \"@types/graphql\": \"14.0.7\",\n â”Š17â”Š18â”Š    \"@types/graphql-iso-date\": \"3.3.1\",\n+â”Š  â”Š19â”Š    \"@types/jest\": \"24.0.11\",\n â”Š18â”Š20â”Š    \"@types/node\": \"11.11.0\",\n+â”Š  â”Š21â”Š    \"ts-jest\": \"24.0.0\",\n+â”Š  â”Š22â”Š    \"jest\": \"24.5.0\",\n â”Š19â”Š23â”Š    \"ts-node\": \"8.0.3\",\n â”Š20â”Š24â”Š    \"typescript\": \"3.3.3333\"\n â”Š21â”Š25â”Š  },\n```\n```diff\n@@ -28,5 +32,10 @@\n â”Š28â”Š32â”Š    \"graphql-import\": \"0.7.1\",\n â”Š29â”Š33â”Š    \"graphql-iso-date\": \"3.6.1\",\n â”Š30â”Š34â”Š    \"graphql-tools\": \"4.0.4\"\n+â”Š  â”Š35â”Š  },\n+â”Š  â”Š36â”Š  \"jest\": {\n+â”Š  â”Š37â”Š    \"transform\": {\n+â”Š  â”Š38â”Š      \"^.+\\\\.(js|jsx|ts|tsx)$\": \"<rootDir>/node_modules/ts-jest\"\n+â”Š  â”Š39â”Š    }\n â”Š31â”Š40â”Š  }\n â”Š32â”Š41â”Š}\n```\n\n[}]: #\n\nNow we're gonna test the `chats` query in our GraphQL schema. To do so, we will setup an Apollo Client and send a query request to our back-end, and then we will match the received response with a pre-defined snapshot. Luckily, we don't have to set an actual client, since the tests and the implementation of the back-end live right next to each other, thus, we will install a package which will help us achieving so:\n\n    $ yarn add --dev apollo-server-testing\n\nWe will define the test suite under the `tests/queries` folder in a file called `getChats.test.ts`:\n\n[{]: <helper> (diffStep \"3.2\" files=\"tests/queries/getChats.test.ts\" module=\"server\")\n\n#### [Server Step 3.2: Test Query.chats](https://github.com/Urigo/WhatsApp-Clone-Server/commit/5a5edc4)\n\n##### Added tests&#x2F;queries&#x2F;getChats.test.ts\n```diff\n@@ -0,0 +1,32 @@\n+â”Š  â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing'\n+â”Š  â”Š 2â”Šimport { ApolloServer, gql } from 'apollo-server-express'\n+â”Š  â”Š 3â”Šimport schema from '../../schema'\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šdescribe('Query.chats', () => {\n+â”Š  â”Š 6â”Š  it('should fetch all chats', async () => {\n+â”Š  â”Š 7â”Š    const server = new ApolloServer({ schema })\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Š    const { query } = createTestClient(server)\n+â”Š  â”Š10â”Š\n+â”Š  â”Š11â”Š    const res = await query({\n+â”Š  â”Š12â”Š      query: gql `\n+â”Š  â”Š13â”Š        query GetChats {\n+â”Š  â”Š14â”Š          chats {\n+â”Š  â”Š15â”Š            id\n+â”Š  â”Š16â”Š            name\n+â”Š  â”Š17â”Š            picture\n+â”Š  â”Š18â”Š            lastMessage {\n+â”Š  â”Š19â”Š              id\n+â”Š  â”Š20â”Š              content\n+â”Š  â”Š21â”Š              createdAt\n+â”Š  â”Š22â”Š            }\n+â”Š  â”Š23â”Š          }\n+â”Š  â”Š24â”Š        }\n+â”Š  â”Š25â”Š      `,\n+â”Š  â”Š26â”Š    })\n+â”Š  â”Š27â”Š\n+â”Š  â”Š28â”Š    expect(res.data).toBeDefined()\n+â”Š  â”Š29â”Š    expect(res.errors).toBeUndefined()\n+â”Š  â”Š30â”Š    expect(res.data).toMatchSnapshot()\n+â”Š  â”Š31â”Š  })\n+â”Š  â”Š32â”Š})\n```\n\n[}]: #\n\nIn the test function, we create a new instance of the Apollo-GraphQL server using our schema, and we query some data against it thanks to the fake client created by [`apollo-server-testing`](https://www.npmjs.com/package/apollo-server-testing).\n\nThe `.toMatchSnapshot()` matcher will call the `toString()` method on the examined object and will test it against a predefined snapshot.\nThe snapshot will automatically be created once we run the test for the first time and will be stored under the `__snapshot__` directory.\nThis means that the first test run will always pass. This is useful because you can later on observe and adjust manually the snapshot manually without having to write it from scratch.\n\nSo let's do our first test run for the server:\n\n    $ yarn test\n\nThe expected result should be a projection of the data stored in the `db.ts` file.\n\n[{]: <helper> (diffStep \"3.2\" files=\"tests/queries/__snapshots__\" module=\"server\")\n\n#### [Server Step 3.2: Test Query.chats](https://github.com/Urigo/WhatsApp-Clone-Server/commit/5a5edc4)\n\n##### Added tests&#x2F;queries&#x2F;\\__snapshots__&#x2F;getChats.test.ts.snap\n```diff\n@@ -0,0 +1,48 @@\n+â”Š  â”Š 1â”Š// Jest Snapshot v1, https://goo.gl/fbAQLP\n+â”Š  â”Š 2â”Š\n+â”Š  â”Š 3â”Šexports[`Query.chats should fetch all chats 1`] = `\n+â”Š  â”Š 4â”ŠObject {\n+â”Š  â”Š 5â”Š  \"chats\": Array [\n+â”Š  â”Š 6â”Š    Object {\n+â”Š  â”Š 7â”Š      \"id\": \"1\",\n+â”Š  â”Š 8â”Š      \"lastMessage\": Object {\n+â”Š  â”Š 9â”Š        \"content\": \"You on your way?\",\n+â”Š  â”Š10â”Š        \"createdAt\": \"2018-12-30T23:20:00.000Z\",\n+â”Š  â”Š11â”Š        \"id\": \"1\",\n+â”Š  â”Š12â”Š      },\n+â”Š  â”Š13â”Š      \"name\": \"Ethan Gonzalez\",\n+â”Š  â”Š14â”Š      \"picture\": \"https://randomuser.me/api/portraits/thumb/men/1.jpg\",\n+â”Š  â”Š15â”Š    },\n+â”Š  â”Š16â”Š    Object {\n+â”Š  â”Š17â”Š      \"id\": \"2\",\n+â”Š  â”Š18â”Š      \"lastMessage\": Object {\n+â”Š  â”Š19â”Š        \"content\": \"Hey, it's me\",\n+â”Š  â”Š20â”Š        \"createdAt\": \"2018-12-30T06:40:00.000Z\",\n+â”Š  â”Š21â”Š        \"id\": \"2\",\n+â”Š  â”Š22â”Š      },\n+â”Š  â”Š23â”Š      \"name\": \"Bryan Wallace\",\n+â”Š  â”Š24â”Š      \"picture\": \"https://randomuser.me/api/portraits/thumb/men/2.jpg\",\n+â”Š  â”Š25â”Š    },\n+â”Š  â”Š26â”Š    Object {\n+â”Š  â”Š27â”Š      \"id\": \"3\",\n+â”Š  â”Š28â”Š      \"lastMessage\": Object {\n+â”Š  â”Š29â”Š        \"content\": \"I should buy a boat\",\n+â”Š  â”Š30â”Š        \"createdAt\": \"2018-12-15T00:00:00.000Z\",\n+â”Š  â”Š31â”Š        \"id\": \"3\",\n+â”Š  â”Š32â”Š      },\n+â”Š  â”Š33â”Š      \"name\": \"Avery Stewart\",\n+â”Š  â”Š34â”Š      \"picture\": \"https://randomuser.me/api/portraits/thumb/women/1.jpg\",\n+â”Š  â”Š35â”Š    },\n+â”Š  â”Š36â”Š    Object {\n+â”Š  â”Š37â”Š      \"id\": \"4\",\n+â”Š  â”Š38â”Š      \"lastMessage\": Object {\n+â”Š  â”Š39â”Š        \"content\": \"This is wicked good ice cream.\",\n+â”Š  â”Š40â”Š        \"createdAt\": \"2018-05-12T08:00:00.000Z\",\n+â”Š  â”Š41â”Š        \"id\": \"4\",\n+â”Š  â”Š42â”Š      },\n+â”Š  â”Š43â”Š      \"name\": \"Katie Peterson\",\n+â”Š  â”Š44â”Š      \"picture\": \"https://randomuser.me/api/portraits/thumb/women/2.jpg\",\n+â”Š  â”Š45â”Š    },\n+â”Š  â”Š46â”Š  ],\n+â”Š  â”Š47â”Š}\n+â”Š  â”Š48â”Š`;\n```\n\n[}]: #\n\nAlways be sure to observe the snapshot before moving on! The received result isn't necessarily what you'd expect. Also it's not a good practice to store production data in the snapshot because it's subject to changes. Normally we would set up another instance of the DB for testing purposes, but since our DB is a mock and doesn't represent real data, there's no need to at this stage.\n\nNow that we have the required knowledge regards testing and Jest's API, we will implement tests throughout the tutorial as a trivial thing. We will not go through each and every new matcher that we introduce, as it is self explanatory and there's too much of them. Be sure to work against [this full list of matchers](https://jestjs.io/docs/en/expect) when working with Jest.\n\nIn the next chapter we will continue expanding our application by adding a `<ChatRoomScreen />`.\n\n----------\nTODO: Check what changed on testing in create-react-app 3.0 https://facebook.github.io/create-react-app/docs/running-tests\n\nTODO: I think ts-jest could be configured in a simpler way, but need to check\n\t{ preset: 'ts-jest' }\n\nTODO: I donâ€™t like using jestâ€™s toMatchSnapshot() to compare operationâ€™s result that comes from the real GraphQL Schema (with resolvers).\nIt might change quite a lot and break tests. That data might be huge and hard to be validated by looking at it. Maybe checking a structure is a better approach?\n\nTODO: Why ts-jest?\n\nTODO: Change into tortilla diff:\n\nTODO: Change into Tortilla diif:\n\nTODO: Test with UTC timezone so it would work on all computers\n\nTODO: const server = new ApolloServer({ typeDefs }); // easier, no need to compile the schema before"
          },
          {
            "manualTitle": "Step 6: Creating an app router and implementing a chat room",
            "stepRevision": "b1853f0258e57eb800345f3985d55b2d29e641bd",
            "manualView": "In this chapter we will learn how to build a chat room screen.\nIn order to navigate between different screens, we will setup a router.\n\nSince we're gonna have to screens in our app now - `ChatsListScreen` and `ChatRoomScreen`, we will need a router that will be able to alternate between them.\nWe will be using the [`react-router-dom`](https://www.npmjs.com/package/react-router-dom) package to manage the routes of the application:\n\n    $ yarn add react-router-dom\n\nAnd we will implement a router directly in the `<App />` component:\n\n[{]: <helper> (diffStep 6.1 files=\"App\" module=\"client\")\n\n#### Client Step 6.1: Add router\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -1,10 +1,20 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n+â”Š  â”Š 2â”Šimport { BrowserRouter, Route, Redirect, Switch } from 'react-router-dom';\n+â”Š  â”Š 3â”Šimport ChatRoomScreen from './components/ChatRoomScreen';\n â”Š 2â”Š 4â”Šimport ChatsListScreen from './components/ChatsListScreen';\n â”Š 3â”Š 5â”Š\n â”Š 4â”Š 6â”Šconst App: React.FC = () => (\n-â”Š 5â”Š  â”Š  <div>\n-â”Š 6â”Š  â”Š    <ChatsListScreen/>\n-â”Š 7â”Š  â”Š  </div>\n+â”Š  â”Š 7â”Š  <BrowserRouter>\n+â”Š  â”Š 8â”Š    <Switch>\n+â”Š  â”Š 9â”Š      <Route exact path=\"/chats\" component={ChatsListScreen} />\n+â”Š  â”Š10â”Š      <Route exact path=\"/chats/:chatId\" component={ChatRoomScreen} />\n+â”Š  â”Š11â”Š    </Switch>\n+â”Š  â”Š12â”Š    <Route exact path=\"/\" render={redirectToChats} />\n+â”Š  â”Š13â”Š  </BrowserRouter>\n+â”Š  â”Š14â”Š);\n+â”Š  â”Š15â”Š\n+â”Š  â”Š16â”Šconst redirectToChats = () => (\n+â”Š  â”Š17â”Š  <Redirect to=\"/chats\" />\n â”Š 8â”Š18â”Š);\n â”Š 9â”Š19â”Š\n â”Š10â”Š20â”Šexport default App;\n```\n\n[}]: #\n\nThe purpose of a router is to make route managing easy and declarative.\nIt will take care of managing the history within our app and parameterizing certain screens according to our need.\nEssentially it's a wrap around the `window.history` object which is also compatible with React.\nI recommend you to go through the [official MDN docs](https://developer.mozilla.org/en-US/docs/Web/API/History) if you're not yet familiar with the concept.\n\nThe `<Route />` component represents a path for a route in our application. Using the colon syntax (`:chatId`) we basically tell the router that the `/chat` route should be followed by a string whose value can later on be addressed via a parameter called `chatId` when navigating to the route. So here's a sum-up of the routes manifest:\n\n\n\n*   `/chats` - will navigate to the `ChatsListScreen`.\n*   `/chat/:chatId` - e.g. `/chat/1`, will navigate to the `ChatRoomScreen` and will parameterize it to show data which is related to chat ID 1.\n*   Any other route will fallback to the `/chats` route which will redirect us to the `ChatsListScreen`.\n\nNow we will implement the `ChatRoomScreen` so the router can function properly.\nFor now we will make it a plain screen which simply prints out the information of the chat that was clicked so we can have a complete flow,\nand then we will take care of the rest.\n\nTo do so, we will first implement the `chat` query in our backend.\nThis would be a parameterized query that will provide us with a specific chat according to the received ID,\nand it will be used by the new screen as soon as it is initialized.\nFirst we would update the `Chat` type to contain a `messages` field:\n\n[{]: <helper> (diffStep 4.1 files=\"typeDefs.graphql\" module=\"server\")\n\n#### [Server Step 4.1: Add messages field to Chat type](https://github.com/Urigo/WhatsApp-Clone-Server/commit/9f01cf6)\n\n##### Changed schema&#x2F;typeDefs.graphql\n```diff\n@@ -11,6 +11,7 @@\n â”Š11â”Š11â”Š  name: String!\n â”Š12â”Š12â”Š  picture: String\n â”Š13â”Š13â”Š  lastMessage: Message\n+â”Š  â”Š14â”Š  messages: [Message!]!\n â”Š14â”Š15â”Š}\n â”Š15â”Š16â”Š\n â”Š16â”Š17â”Štype Query {\n```\n\n[}]: #\n\nThen we will create the appropriate resolver:\n\n[{]: <helper> (diffStep 4.1 files=\"resolvers.ts\" module=\"server\")\n\n#### [Server Step 4.1: Add messages field to Chat type](https://github.com/Urigo/WhatsApp-Clone-Server/commit/9f01cf6)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -5,6 +5,10 @@\n â”Š 5â”Š 5â”Š  Date: GraphQLDateTime,\n â”Š 6â”Š 6â”Š\n â”Š 7â”Š 7â”Š  Chat: {\n+â”Š  â”Š 8â”Š    messages(chat: any) {\n+â”Š  â”Š 9â”Š      return messages.filter(m => chat.messages.includes(m.id))\n+â”Š  â”Š10â”Š    },\n+â”Š  â”Š11â”Š\n â”Š 8â”Š12â”Š    lastMessage(chat: any) {\n â”Š 9â”Š13â”Š      return messages.find(m => m.id === chat.lastMessage)\n â”Š10â”Š14â”Š    },\n```\n\n[}]: #\n\nAnd then we will update our DB mock to be aligned with these changes:\n\n[{]: <helper> (diffStep 4.1 files=\"db\" module=\"server\")\n\n#### [Server Step 4.1: Add messages field to Chat type](https://github.com/Urigo/WhatsApp-Clone-Server/commit/9f01cf6)\n\n##### Changed db.ts\n```diff\n@@ -27,23 +27,27 @@\n â”Š27â”Š27â”Š    name: 'Ethan Gonzalez',\n â”Š28â”Š28â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n â”Š29â”Š29â”Š    lastMessage: '1',\n+â”Š  â”Š30â”Š    messages: ['1'],\n â”Š30â”Š31â”Š  },\n â”Š31â”Š32â”Š  {\n â”Š32â”Š33â”Š    id: '2',\n â”Š33â”Š34â”Š    name: 'Bryan Wallace',\n â”Š34â”Š35â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n â”Š35â”Š36â”Š    lastMessage: '2',\n+â”Š  â”Š37â”Š    messages: ['2'],\n â”Š36â”Š38â”Š  },\n â”Š37â”Š39â”Š  {\n â”Š38â”Š40â”Š    id: '3',\n â”Š39â”Š41â”Š    name: 'Avery Stewart',\n â”Š40â”Š42â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n â”Š41â”Š43â”Š    lastMessage: '3',\n+â”Š  â”Š44â”Š    messages: ['3'],\n â”Š42â”Š45â”Š  },\n â”Š43â”Š46â”Š  {\n â”Š44â”Š47â”Š    id: '4',\n â”Š45â”Š48â”Š    name: 'Katie Peterson',\n â”Š46â”Š49â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n â”Š47â”Š50â”Š    lastMessage: '4',\n+â”Š  â”Š51â”Š    messages: ['4'],\n â”Š48â”Š52â”Š  },\n â”Š49â”Š53â”Š]\n```\n\n[}]: #\n\nThis means that when we resolve `Chat.lastMessage`, we should get it directly from the `Chat.messages` field:\n\n[{]: <helper> (diffStep 4.2 module=\"server\")\n\n#### [Server Step 4.2: Resolve last message based on messages array](https://github.com/Urigo/WhatsApp-Clone-Server/commit/eacae7b)\n\n##### Changed db.ts\n```diff\n@@ -26,28 +26,24 @@\n â”Š26â”Š26â”Š    id: '1',\n â”Š27â”Š27â”Š    name: 'Ethan Gonzalez',\n â”Š28â”Š28â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n-â”Š29â”Š  â”Š    lastMessage: '1',\n â”Š30â”Š29â”Š    messages: ['1'],\n â”Š31â”Š30â”Š  },\n â”Š32â”Š31â”Š  {\n â”Š33â”Š32â”Š    id: '2',\n â”Š34â”Š33â”Š    name: 'Bryan Wallace',\n â”Š35â”Š34â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n-â”Š36â”Š  â”Š    lastMessage: '2',\n â”Š37â”Š35â”Š    messages: ['2'],\n â”Š38â”Š36â”Š  },\n â”Š39â”Š37â”Š  {\n â”Š40â”Š38â”Š    id: '3',\n â”Š41â”Š39â”Š    name: 'Avery Stewart',\n â”Š42â”Š40â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n-â”Š43â”Š  â”Š    lastMessage: '3',\n â”Š44â”Š41â”Š    messages: ['3'],\n â”Š45â”Š42â”Š  },\n â”Š46â”Š43â”Š  {\n â”Š47â”Š44â”Š    id: '4',\n â”Š48â”Š45â”Š    name: 'Katie Peterson',\n â”Š49â”Š46â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n-â”Š50â”Š  â”Š    lastMessage: '4',\n â”Š51â”Š47â”Š    messages: ['4'],\n â”Š52â”Š48â”Š  },\n â”Š53â”Š49â”Š]\n```\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -10,7 +10,9 @@\n â”Š10â”Š10â”Š    },\n â”Š11â”Š11â”Š\n â”Š12â”Š12â”Š    lastMessage(chat: any) {\n-â”Š13â”Š  â”Š      return messages.find(m => m.id === chat.lastMessage)\n+â”Š  â”Š13â”Š      const lastMessage = chat.messages[chat.messages.length - 1]\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”Š      return messages.find(m => m.id === lastMessage)\n â”Š14â”Š16â”Š    },\n â”Š15â”Š17â”Š  },\n```\n\n[}]: #\n\nNow that we have an updated schema which is relevant to the new screen that we would like to add, we will declare a new query called `chat`:\n\n[{]: <helper> (diffStep 4.3 files=\"schema/typeDefs\" module=\"server\")\n\n#### [Server Step 4.3: Add chat field to Query type](https://github.com/Urigo/WhatsApp-Clone-Server/commit/93160df)\n\n##### Changed schema&#x2F;typeDefs.graphql\n```diff\n@@ -16,4 +16,5 @@\n â”Š16â”Š16â”Š\n â”Š17â”Š17â”Štype Query {\n â”Š18â”Š18â”Š  chats: [Chat!]!\n+â”Š  â”Š19â”Š  chat(chatId: ID!): Chat\n â”Š19â”Š20â”Š}\n```\n\n[}]: #\n\nNote that unlike the `chats` query, this time we have a parameter. The parameters are provided to the resolver function as the second parameter as a JSON. Using the provided parameter - the chat ID, we will find and return the relevant chat from the DB:\n\n[{]: <helper> (diffStep 4.3 files=\"schema/resolvers\" module=\"server\")\n\n#### [Server Step 4.3: Add chat field to Query type](https://github.com/Urigo/WhatsApp-Clone-Server/commit/93160df)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -20,6 +20,10 @@\n â”Š20â”Š20â”Š    chats() {\n â”Š21â”Š21â”Š      return chats\n â”Š22â”Š22â”Š    },\n+â”Š  â”Š23â”Š\n+â”Š  â”Š24â”Š    chat(root: any, { chatId }: any) {\n+â”Š  â”Š25â”Š      return chats.find(c => c.id === chatId)\n+â”Š  â”Š26â”Š    },\n â”Š23â”Š27â”Š  },\n â”Š24â”Š28â”Š}\n â”Š25â”Š29â”Š\n```\n\n[}]: #\n\n> More about the resolver signature can be read in [Apollo-GraphQL's official docs page](https://www.apollographql.com/docs/apollo-server/essentials/data.html#type-signature).\n\nNow we will add a test suite:\n\n[{]: <helper> (diffStep 4.3 files=\"tests/queries/getChat.test\" module=\"server\")\n\n#### [Server Step 4.3: Add chat field to Query type](https://github.com/Urigo/WhatsApp-Clone-Server/commit/93160df)\n\n##### Added tests&#x2F;queries&#x2F;getChat.test.ts\n```diff\n@@ -0,0 +1,33 @@\n+â”Š  â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing'\n+â”Š  â”Š 2â”Šimport { ApolloServer, gql } from 'apollo-server-express'\n+â”Š  â”Š 3â”Šimport schema from '../../schema'\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šdescribe('Query.chat', () => {\n+â”Š  â”Š 6â”Š  it('should fetch specified chat', async () => {\n+â”Š  â”Š 7â”Š    const server = new ApolloServer({ schema })\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Š    const { query } = createTestClient(server)\n+â”Š  â”Š10â”Š\n+â”Š  â”Š11â”Š    const res = await query({\n+â”Š  â”Š12â”Š      variables: { chatId: '1' },\n+â”Š  â”Š13â”Š      query: gql `\n+â”Š  â”Š14â”Š        query GetChat($chatId: ID!) {\n+â”Š  â”Š15â”Š          chat(chatId: $chatId) {\n+â”Š  â”Š16â”Š            id\n+â”Š  â”Š17â”Š            name\n+â”Š  â”Š18â”Š            picture\n+â”Š  â”Š19â”Š            lastMessage {\n+â”Š  â”Š20â”Š              id\n+â”Š  â”Š21â”Š              content\n+â”Š  â”Š22â”Š              createdAt\n+â”Š  â”Š23â”Š            }\n+â”Š  â”Š24â”Š          }\n+â”Š  â”Š25â”Š        }\n+â”Š  â”Š26â”Š      `,\n+â”Š  â”Š27â”Š    })\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š    expect(res.data).toBeDefined()\n+â”Š  â”Š30â”Š    expect(res.errors).toBeUndefined()\n+â”Š  â”Š31â”Š    expect(res.data).toMatchSnapshot()\n+â”Š  â”Š32â”Š  })\n+â”Š  â”Š33â”Š})\n```\n\n[}]: #\n\nWe can observe the snapshot created by Jest to get a better understanding of how the response should look like:\n\n[{]: <helper> (diffStep 4.3 files=\"__snapshot__\" module=\"server\")\n\n#### [Server Step 4.3: Add chat field to Query type](https://github.com/Urigo/WhatsApp-Clone-Server/commit/93160df)\n\n\n\n[}]: #\n\nIf you experience any TypeScript related issues with the following error:\n\n```\nObject literal may only specify known properties, and 'variables' does not exist in type 'Query'.\n```\n\nAdd the following declaration file to your project:\n\n[{]: <helper> (diffStep 4.3 files=\"types\" module=\"server\")\n\n#### [Server Step 4.3: Add chat field to Query type](https://github.com/Urigo/WhatsApp-Clone-Server/commit/93160df)\n\n##### Added types&#x2F;apollo-server-testing.d.ts\n```diff\n@@ -0,0 +1,27 @@\n+â”Š  â”Š 1â”Šdeclare module 'apollo-server-testing' {\n+â”Š  â”Š 2â”Š  import { ApolloServerBase } from 'apollo-server-core';\n+â”Š  â”Š 3â”Š  import { print, DocumentNode } from 'graphql';\n+â”Š  â”Š 4â”Š  import { GraphQLResponse } from 'graphql-extensions';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Š  type StringOrAst = string | DocumentNode;\n+â”Š  â”Š 7â”Š\n+â”Š  â”Š 8â”Š  // A query must not come with a mutation (and vice versa).\n+â”Š  â”Š 9â”Š  type Query<TVariables> = {\n+â”Š  â”Š10â”Š    query: StringOrAst;\n+â”Š  â”Š11â”Š    mutation?: undefined;\n+â”Š  â”Š12â”Š    variables?: TVariables;\n+â”Š  â”Š13â”Š  };\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”Š  type Mutation<TVariables> = {\n+â”Š  â”Š16â”Š    mutation: StringOrAst;\n+â”Š  â”Š17â”Š    query?: undefined;\n+â”Š  â”Š18â”Š    variables?: TVariables;\n+â”Š  â”Š19â”Š  };\n+â”Š  â”Š20â”Š\n+â”Š  â”Š21â”Š  export const createTestClient: <TVariables>(\n+â”Š  â”Š22â”Š    server: ApolloServerBase,\n+â”Š  â”Š23â”Š  ) => {\n+â”Š  â”Š24â”Š    query: (query: Query<TVariables>) => Promise<GraphQLResponse>;\n+â”Š  â”Š25â”Š    mutate: (mutation: Mutation<TVariables>) => Promise<GraphQLResponse>;\n+â”Š  â”Š26â”Š  };\n+â”Š  â”Š27â”Š}\n```\n\n[}]: #\n\nThis is a [known issue](https://github.com/apollographql/apollo-server/issues/2172) in the `apollo-server-testing` package and has a pending [fix PR](https://github.com/apollographql/apollo-server/pull/2307).\nNow getting back to the client, let's implement a basic version of the `ChatRoomScreen` where we will fetch the new query and print it to the screen:\n\n[{]: <helper> (diffStep 6.2 module=\"client\")\n\n#### Client Step 6.2: Add basic ChatRoomScreen\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -1,5 +1,5 @@\n â”Š1â”Š1â”Šimport React from 'react';\n-â”Š2â”Š â”Šimport { BrowserRouter, Route, Redirect, Switch } from 'react-router-dom';\n+â”Š â”Š2â”Šimport { BrowserRouter, Route, Redirect, Switch, RouteComponentProps } from 'react-router-dom';\n â”Š3â”Š3â”Šimport ChatRoomScreen from './components/ChatRoomScreen';\n â”Š4â”Š4â”Šimport ChatsListScreen from './components/ChatsListScreen';\n â”Š5â”Š5â”Š\n```\n```diff\n@@ -7,7 +7,12 @@\n â”Š 7â”Š 7â”Š  <BrowserRouter>\n â”Š 8â”Š 8â”Š    <Switch>\n â”Š 9â”Š 9â”Š      <Route exact path=\"/chats\" component={ChatsListScreen} />\n-â”Š10â”Š  â”Š      <Route exact path=\"/chats/:chatId\" component={ChatRoomScreen} />\n+â”Š  â”Š10â”Š\n+â”Š  â”Š11â”Š      <Route exact path=\"/chats/:chatId\" component={\n+â”Š  â”Š12â”Š        ({ match }: RouteComponentProps<{ chatId: string }>) =>\n+â”Š  â”Š13â”Š        (<ChatRoomScreen chatId={match.params.chatId} />)\n+â”Š  â”Š14â”Š      } />\n+â”Š  â”Š15â”Š\n â”Š11â”Š16â”Š    </Switch>\n â”Š12â”Š17â”Š    <Route exact path=\"/\" render={redirectToChats} />\n â”Š13â”Š18â”Š  </BrowserRouter>\n```\n```diff\n@@ -17,4 +22,4 @@\n â”Š17â”Š22â”Š  <Redirect to=\"/chats\" />\n â”Š18â”Š23â”Š);\n â”Š19â”Š24â”Š\n-â”Š20â”Š  â”Šexport default App;\n+â”Š  â”Š25â”Šexport default App;ðŸš«â†µ\n```\n\n##### Added src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -0,0 +1,74 @@\n+â”Š  â”Š 1â”Šimport React from 'react';\n+â”Š  â”Š 2â”Šimport { useMemo, useState } from 'react';\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šconst getChatQuery = `\n+â”Š  â”Š 5â”Š  query GetChat($chatId: ID!) {\n+â”Š  â”Š 6â”Š    chat(chatId: $chatId) {\n+â”Š  â”Š 7â”Š      id\n+â”Š  â”Š 8â”Š      name\n+â”Š  â”Š 9â”Š      picture\n+â”Š  â”Š10â”Š      messages {\n+â”Š  â”Š11â”Š        id\n+â”Š  â”Š12â”Š        content\n+â”Š  â”Š13â”Š        createdAt\n+â”Š  â”Š14â”Š      }\n+â”Š  â”Š15â”Š    }\n+â”Š  â”Š16â”Š  }\n+â”Š  â”Š17â”Š`;\n+â”Š  â”Š18â”Š\n+â”Š  â”Š19â”Šinterface ChatRoomScreenParams {\n+â”Š  â”Š20â”Š  chatId: string\n+â”Š  â”Š21â”Š};\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Šinterface ChatQueryMessage {\n+â”Š  â”Š24â”Š  id: string;\n+â”Š  â”Š25â”Š  content: string;\n+â”Š  â”Š26â”Š  createdAt: string;\n+â”Š  â”Š27â”Š};\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Šinterface ChatQueryResult {\n+â”Š  â”Š30â”Š  id: string;\n+â”Š  â”Š31â”Š  name: string;\n+â”Š  â”Š32â”Š  picture: string;\n+â”Š  â”Š33â”Š  messages: Array<ChatQueryMessage>;\n+â”Š  â”Š34â”Š};\n+â”Š  â”Š35â”Š\n+â”Š  â”Š36â”Štype OptionalChatQueryResult = ChatQueryResult | null;\n+â”Š  â”Š37â”Š\n+â”Š  â”Š38â”Šconst ChatRoomScreen: React.FC<ChatRoomScreenParams> = ({ chatId }) => {\n+â”Š  â”Š39â”Š  const [chat, setChat] = useState<OptionalChatQueryResult>(null);\n+â”Š  â”Š40â”Š\n+â”Š  â”Š41â”Š  useMemo(async () => {\n+â”Š  â”Š42â”Š    const body = await fetch(`${process.env.REACT_APP_SERVER_URL}/graphql`, {\n+â”Š  â”Š43â”Š      method: 'POST',\n+â”Š  â”Š44â”Š      headers: {\n+â”Š  â”Š45â”Š        'Content-Type': 'application/json',\n+â”Š  â”Š46â”Š      },\n+â”Š  â”Š47â”Š      body: JSON.stringify({\n+â”Š  â”Š48â”Š        query: getChatQuery,\n+â”Š  â”Š49â”Š        variables: { chatId },\n+â”Š  â”Š50â”Š      }),\n+â”Š  â”Š51â”Š    });\n+â”Š  â”Š52â”Š    const { data: { chat } } = await body.json();\n+â”Š  â”Š53â”Š    setChat(chat);\n+â”Š  â”Š54â”Š  }, [chatId]);\n+â”Š  â”Š55â”Š\n+â”Š  â”Š56â”Š  if (!chat) return null;\n+â”Š  â”Š57â”Š\n+â”Š  â”Š58â”Š  return (\n+â”Š  â”Š59â”Š    <div>\n+â”Š  â”Š60â”Š      <img src={chat.picture} alt=\"Profile\"/>\n+â”Š  â”Š61â”Š      <div>{chat.name}</div>\n+â”Š  â”Š62â”Š      <ul>\n+â”Š  â”Š63â”Š        {chat.messages.map((message) =>\n+â”Š  â”Š64â”Š          <li key={message.id}>\n+â”Š  â”Š65â”Š            <div>{message.content}</div>\n+â”Š  â”Š66â”Š            <div>{message.createdAt}</div>\n+â”Š  â”Š67â”Š          </li>\n+â”Š  â”Š68â”Š        )}\n+â”Š  â”Š69â”Š      </ul>\n+â”Š  â”Š70â”Š    </div>\n+â”Š  â”Š71â”Š  );\n+â”Š  â”Š72â”Š};\n+â”Š  â”Š73â”Š\n+â”Š  â”Š74â”Šexport default ChatRoomScreen;ðŸš«â†µ\n```\n\n[}]: #\n\nNote how we used the `match.params.chatId` variable to get the selected chat ID.\nThe `match` prop is defined and provided to us by the `<Route />` component, since it interfaces directly with the `ChatRoomScreen`.\nMore about that can be read in the [official docs page](https://reacttraining.com/react-router/core/api/match).\n\nIn many examples online, you can see people pass the `match` prop directly to the component.\nThe main issue with that is that this makes the component being usable only by a router, but the truth is that the component\ndoesn't care if it's consumed by a router or another parents component as long as they will pass the `chatId` prop.\n\nSo we need to make sure the interface of the ChatRoom component defines those requierements right.\n\nNext we will call our server from the component with the right query and store the result on a `useState` hook.\n\nNow, because we are using GraphQL, we know the types of the result that we are going to get, so let's create Typescript interfaces that\ndescribe the data we're going to get from the server.\n\nIf you'll run the application and type `/chats/1` in the URL bar, this is what you should see on the screen:\n\n![naked-chat](https://user-images.githubusercontent.com/7648874/54664314-d4096b80-4b1e-11e9-9e06-1323cf7b0abe.png)\n\nThe view has no styling at all but it should be fixed in a moment.\nTo make navigation more convenient we will add an `onClick` listener for each chat item in the `ChatsList`.\nUsing the [history](https://reacttraining.com/react-router/core/api/history) object, provided to us by the `<Route />` component,\nwe will navigate to the correlated `ChatRoomScreen`:\n\nFirst let's install the `history` package:\n\n    $ yarn add history @types/history\n\n[{]: <helper> (diffStep 6.3 module=\"client\")\n\n#### Client Step 6.3: Navigate to chat on click\n\n##### Changed package.json\n```diff\n@@ -5,6 +5,7 @@\n â”Š 5â”Š 5â”Š  \"dependencies\": {\n â”Š 6â”Š 6â”Š    \"@material-ui/core\": \"3.9.3\",\n â”Š 7â”Š 7â”Š    \"@material-ui/icons\": \"3.0.2\",\n+â”Š  â”Š 8â”Š    \"@types/history\": \"4.7.2\",\n â”Š 8â”Š 9â”Š    \"@types/jest\": \"24.0.13\",\n â”Š 9â”Š10â”Š    \"@types/material-ui\": \"0.21.6\",\n â”Š10â”Š11â”Š    \"@types/node\": \"12.0.1\",\n```\n```diff\n@@ -12,6 +13,7 @@\n â”Š12â”Š13â”Š    \"@types/react-dom\": \"16.8.4\",\n â”Š13â”Š14â”Š    \"@types/react-router-dom\": \"4.3.3\",\n â”Š14â”Š15â”Š    \"@types/styled-components\": \"4.1.14\",\n+â”Š  â”Š16â”Š    \"history\": \"4.9.0\",\n â”Š15â”Š17â”Š    \"moment\": \"2.24.0\",\n â”Š16â”Š18â”Š    \"react\": \"16.8.6\",\n â”Š17â”Š19â”Š    \"react-dom\": \"16.8.6\",\n```\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -2,7 +2,8 @@\n â”Š2â”Š2â”Šimport moment from 'moment';\n â”Š3â”Š3â”Šimport { List, ListItem } from '@material-ui/core';\n â”Š4â”Š4â”Šimport styled from 'styled-components';\n-â”Š5â”Š â”Šimport { useState, useMemo } from 'react';\n+â”Š â”Š5â”Šimport { useCallback, useState, useMemo } from 'react';\n+â”Š â”Š6â”Šimport { History } from 'history';\n â”Š6â”Š7â”Š\n â”Š7â”Š8â”Šconst Container = styled.div `\n â”Š8â”Š9â”Š  height: calc(100% - 56px);\n```\n```diff\n@@ -69,9 +70,13 @@\n â”Š69â”Š70â”Š      }\n â”Š70â”Š71â”Š    }\n â”Š71â”Š72â”Š  }\n-â”Š72â”Š  â”Š`\n+â”Š  â”Š73â”Š`;\n+â”Š  â”Š74â”Š\n+â”Š  â”Š75â”Šinterface ChatsListProps {\n+â”Š  â”Š76â”Š  history : History;\n+â”Š  â”Š77â”Š};\n â”Š73â”Š78â”Š\n-â”Š74â”Š  â”Šconst ChatsList = () => {\n+â”Š  â”Š79â”Šconst ChatsList: React.FC<ChatsListProps> = ({ history }) => {\n â”Š75â”Š80â”Š  const [chats, setChats] = useState<any[]>([]);\n â”Š76â”Š81â”Š\n â”Š77â”Š82â”Š  useMemo(async () => {\n```\n```diff\n@@ -86,11 +91,15 @@\n â”Š 86â”Š 91â”Š    setChats(chats);\n â”Š 87â”Š 92â”Š  }, []);\n â”Š 88â”Š 93â”Š\n+â”Š   â”Š 94â”Š  const navToChat = useCallback((chat) => {\n+â”Š   â”Š 95â”Š    history.push(`chats/${chat.id}`)\n+â”Š   â”Š 96â”Š  }, [history]);\n+â”Š   â”Š 97â”Š\n â”Š 89â”Š 98â”Š  return (\n â”Š 90â”Š 99â”Š    <Container>\n â”Š 91â”Š100â”Š      <StyledList>\n â”Š 92â”Š101â”Š        {chats.map((chat) => (\n-â”Š 93â”Š   â”Š          <StyledListItem key={chat.id} button>\n+â”Š   â”Š102â”Š          <StyledListItem key={chat.id} data-testid=\"chat\" button onClick={navToChat.bind(null, chat)}>\n â”Š 94â”Š103â”Š            <ChatPicture data-testid=\"picture\" src={chat.picture} alt=\"Profile\"/>\n â”Š 95â”Š104â”Š            <ChatInfo>\n â”Š 96â”Š105â”Š              <ChatName data-testid=\"name\">{chat.name}</ChatName>\n```\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;index.tsx\n```diff\n@@ -2,15 +2,20 @@\n â”Š 2â”Š 2â”Šimport ChatsNavbar from './ChatsNavbar';\n â”Š 3â”Š 3â”Šimport ChatsList from './ChatsList';\n â”Š 4â”Š 4â”Šimport styled from 'styled-components';\n+â”Š  â”Š 5â”Šimport { History } from 'history';\n â”Š 5â”Š 6â”Š\n â”Š 6â”Š 7â”Šconst Container = styled.div `\n â”Š 7â”Š 8â”Š  height: 100vh;\n â”Š 8â”Š 9â”Š`;\n â”Š 9â”Š10â”Š\n-â”Š10â”Š  â”Šconst ChatsListScreen: React.FC = () => (\n+â”Š  â”Š11â”Šinterface ChatsListScreenProps {\n+â”Š  â”Š12â”Š  history : History;\n+â”Š  â”Š13â”Š};\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”Šconst ChatsListScreen: React.FC<ChatsListScreenProps> = ({ history }) => (\n â”Š11â”Š16â”Š  <Container>\n â”Š12â”Š17â”Š    <ChatsNavbar />\n-â”Š13â”Š  â”Š    <ChatsList />\n+â”Š  â”Š18â”Š    <ChatsList history={history} />\n â”Š14â”Š19â”Š  </Container>\n â”Š15â”Š20â”Š);\n```\n\n[}]: #\n\nAnd add test the new logic:\n\n[{]: <helper> (diffStep 6.4 module=\"client\")\n\n#### Client Step 6.4: Test new navigation logic\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.test.tsx\n```diff\n@@ -1,10 +1,14 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n â”Š 2â”Š 2â”Šimport ReactDOM from 'react-dom';\n-â”Š 3â”Š  â”Šimport { cleanup, render, waitForDomChange } from 'react-testing-library';\n+â”Š  â”Š 3â”Šimport { cleanup, render, fireEvent, wait, waitForDomChange } from 'react-testing-library';\n â”Š 4â”Š 4â”Šimport ChatsList from './ChatsList';\n+â”Š  â”Š 5â”Šimport { createBrowserHistory } from 'history';\n â”Š 5â”Š 6â”Š\n â”Š 6â”Š 7â”Šdescribe('ChatsList', () => {\n-â”Š 7â”Š  â”Š  afterEach(cleanup);\n+â”Š  â”Š 8â”Š  afterEach(() => {\n+â”Š  â”Š 9â”Š    cleanup();\n+â”Š  â”Š10â”Š    window.location.pathname = '/';\n+â”Š  â”Š11â”Š  });\n â”Š 8â”Š12â”Š\n â”Š 9â”Š13â”Š  it('renders fetched chats data', async () => {\n â”Š10â”Š14â”Š    fetch.mockResponseOnce(JSON.stringify({\n```\n```diff\n@@ -17,7 +21,7 @@\n â”Š17â”Š21â”Š            lastMessage: {\n â”Š18â”Š22â”Š              id: 1,\n â”Š19â”Š23â”Š              content: 'Hello',\n-â”Š20â”Š  â”Š              createdAt: new Date(0),\n+â”Š  â”Š24â”Š              createdAt: new Date('14 Jun 2017 00:00:00 PDT').toUTCString(),\n â”Š21â”Š25â”Š            },\n â”Š22â”Š26â”Š          },\n â”Š23â”Š27â”Š        ],\n```\n```diff\n@@ -32,7 +36,40 @@\n â”Š32â”Š36â”Š      expect(getByTestId('name')).toHaveTextContent('Foo Bar');\n â”Š33â”Š37â”Š      expect(getByTestId('picture')).toHaveAttribute('src', 'https://localhost:4000/picture.jpg');\n â”Š34â”Š38â”Š      expect(getByTestId('content')).toHaveTextContent('Hello');\n-â”Š35â”Š  â”Š      expect(getByTestId('date')).toHaveTextContent('01:00');\n+â”Š  â”Š39â”Š      expect(getByTestId('date')).toHaveTextContent('10:00');\n+â”Š  â”Š40â”Š    }\n+â”Š  â”Š41â”Š  });\n+â”Š  â”Š42â”Š\n+â”Š  â”Š43â”Š  it('should navigate to the target chat room on chat item click', async () => {\n+â”Š  â”Š44â”Š    fetch.mockResponseOnce(JSON.stringify({\n+â”Š  â”Š45â”Š      data: {\n+â”Š  â”Š46â”Š        chats: [\n+â”Š  â”Š47â”Š          {\n+â”Š  â”Š48â”Š            id: 1,\n+â”Š  â”Š49â”Š            name: 'Foo Bar',\n+â”Š  â”Š50â”Š            picture: 'https://localhost:4000/picture.jpg',\n+â”Š  â”Š51â”Š            lastMessage: {\n+â”Š  â”Š52â”Š              id: 1,\n+â”Š  â”Š53â”Š              content: 'Hello',\n+â”Š  â”Š54â”Š              createdAt: new Date(0),\n+â”Š  â”Š55â”Š            },\n+â”Š  â”Š56â”Š          },\n+â”Š  â”Š57â”Š        ],\n+â”Š  â”Š58â”Š      },\n+â”Š  â”Š59â”Š    }));\n+â”Š  â”Š60â”Š\n+â”Š  â”Š61â”Š     const history = createBrowserHistory();\n+â”Š  â”Š62â”Š\n+â”Š  â”Š63â”Š     {\n+â”Š  â”Š64â”Š      const { container, getByTestId } = render(<ChatsList history={history} />);\n+â”Š  â”Š65â”Š\n+â”Š  â”Š66â”Š       await waitForDomChange({ container });\n+â”Š  â”Š67â”Š\n+â”Š  â”Š68â”Š       fireEvent.click(getByTestId('chat'));\n+â”Š  â”Š69â”Š\n+â”Š  â”Š70â”Š       await wait(() =>\n+â”Š  â”Š71â”Š        expect(history.location.pathname).toEqual('/chats/1')\n+â”Š  â”Š72â”Š      );\n â”Š36â”Š73â”Š    }\n â”Š37â”Š74â”Š  });\n â”Š38â”Š75â”Š});\n```\n\n[}]: #\n\nIf you'll click on the chat item you'll see that the screen changes very suddenly.\nWe can smooth the transition by animating it with CSS.\nLuckily we don't need to implemented such mechanism manually because there's a package that can do that for us - [`react-router-transition`](https://www.npmjs.com/package/react-router-transition):\n\n    $ yarn add react-router-transition\n\nAnd let's add the mising types for the library:\n\n[{]: <helper> (diffStep 6.5 files=\"react-app-env.d.ts\" module=\"client\")\n\n#### Client Step 6.5: Animate route switching\n\n##### Changed src&#x2F;react-app-env.d.ts\n```diff\n@@ -1 +1,3 @@\n â”Š1â”Š1â”Š/// <reference types=\"react-scripts\" />\n+â”Š â”Š2â”Š\n+â”Š â”Š3â”Šdeclare module \"react-router-transition\";ðŸš«â†µ\n```\n\n[}]: #\n\nUsing this package, we will create a custom `Switch` component that will play an animation for all its subordinate `Route` components.\nThe animation is defined by the user using a component called `AnimatedSwitch` as specified in the [package's docs page](http://maisano.github.io/react-router-transition/animated-switch/props).\nSo first, let's create our switch component that will play a smooth transition switching routes:\n\n[{]: <helper> (diffStep 6.5 files=\"AnimatedSwitch\" module=\"client\")\n\n#### Client Step 6.5: Animate route switching\n\n##### Added src&#x2F;components&#x2F;AnimatedSwitch.tsx\n```diff\n@@ -0,0 +1,37 @@\n+â”Š  â”Š 1â”Šimport { Switch } from 'react-router-dom';\n+â”Š  â”Š 2â”Šimport { AnimatedSwitch, spring } from 'react-router-transition';\n+â”Š  â”Š 3â”Šimport styled from 'styled-components';\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Š// A workaround to make test pass\n+â”Š  â”Š 6â”Šconst SwitchComponent = process.env.NODE_ENV === 'test' ? Switch : AnimatedSwitch;\n+â”Š  â”Š 7â”Š\n+â”Š  â”Š 8â”Šconst glide = (val: number) =>\n+â”Š  â”Š 9â”Š  spring(val, {\n+â”Š  â”Š10â”Š    stiffness: 174,\n+â”Š  â”Š11â”Š    damping: 24,\n+â”Š  â”Š12â”Š  });\n+â”Š  â”Š13â”Š\n+â”Š  â”Š14â”Šconst mapStyles = (styles :any) => ({\n+â”Š  â”Š15â”Š  transform: `translateX(${styles.offset}%)`,\n+â”Š  â”Š16â”Š});\n+â”Š  â”Š17â”Š\n+â”Š  â”Š18â”Šconst MyAnimatedSwitch =  styled(SwitchComponent).attrs(() => ({\n+â”Š  â”Š19â”Š  atEnter: { offset: 100 },\n+â”Š  â”Š20â”Š  atLeave: { offset: glide(-100) },\n+â”Š  â”Š21â”Š  atActive: { offset: glide(0) },\n+â”Š  â”Š22â”Š  mapStyles,\n+â”Š  â”Š23â”Š}))`\n+â”Š  â”Š24â”Š  position: relative;\n+â”Š  â”Š25â”Š  overflow: hidden;\n+â”Š  â”Š26â”Š  height: 100vh;\n+â”Š  â”Š27â”Š  width: 100vw;\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š  > div {\n+â”Š  â”Š30â”Š    position: absolute;\n+â”Š  â”Š31â”Š    overflow: hidden;\n+â”Š  â”Š32â”Š    height: 100vh;\n+â”Š  â”Š33â”Š    width: 100vw;\n+â”Š  â”Š34â”Š  }\n+â”Š  â”Š35â”Š`\n+â”Š  â”Š36â”Š\n+â”Š  â”Š37â”Šexport default MyAnimatedSwitch;\n```\n\n[}]: #\n\nAnd then replace it with the main `Switch` component in our app:\n\n[{]: <helper> (diffStep 6.5 files=\"App\" module=\"client\")\n\n#### Client Step 6.5: Animate route switching\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -1,11 +1,12 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n-â”Š 2â”Š  â”Šimport { BrowserRouter, Route, Redirect, Switch, RouteComponentProps } from 'react-router-dom';\n+â”Š  â”Š 2â”Šimport { BrowserRouter, Route, Redirect, RouteComponentProps } from 'react-router-dom';\n â”Š 3â”Š 3â”Šimport ChatRoomScreen from './components/ChatRoomScreen';\n â”Š 4â”Š 4â”Šimport ChatsListScreen from './components/ChatsListScreen';\n+â”Š  â”Š 5â”Šimport AnimatedSwitch from './components/AnimatedSwitch';\n â”Š 5â”Š 6â”Š\n â”Š 6â”Š 7â”Šconst App: React.FC = () => (\n â”Š 7â”Š 8â”Š  <BrowserRouter>\n-â”Š 8â”Š  â”Š    <Switch>\n+â”Š  â”Š 9â”Š    <AnimatedSwitch>\n â”Š 9â”Š10â”Š      <Route exact path=\"/chats\" component={ChatsListScreen} />\n â”Š10â”Š11â”Š\n â”Š11â”Š12â”Š      <Route exact path=\"/chats/:chatId\" component={\n```\n```diff\n@@ -13,7 +14,7 @@\n â”Š13â”Š14â”Š        (<ChatRoomScreen chatId={match.params.chatId} />)\n â”Š14â”Š15â”Š      } />\n â”Š15â”Š16â”Š\n-â”Š16â”Š  â”Š    </Switch>\n+â”Š  â”Š17â”Š    </AnimatedSwitch>\n â”Š17â”Š18â”Š    <Route exact path=\"/\" render={redirectToChats} />\n â”Š18â”Š19â”Š  </BrowserRouter>\n â”Š19â”Š20â”Š);\n```\n\n[}]: #\n\nBoth components act identically and thus there shall be no special treatment. Behold the new transition effect:\n\n![transition-demo](https://user-images.githubusercontent.com/7648874/54739398-ebb22400-4bf2-11e9-8d4c-2aeb65deeb92.gif)\n\nThe final screen will be composed out of 3 components:\n\n\n\n*   A navigation bar.\n*   A messages list.\n*   A message input.\n\nWe will create a new directory under the path `public/assets` and inside we will download and place a couple of assets which are necessary for our view:\n\n*   [chat-background.jpg](https://raw.githubusercontent.com/Urigo/WhatsApp-Clone-Client-Angular/master/src/assets/chat-background.jpg)\n*   [message-mine.png](https://raw.githubusercontent.com/Urigo/WhatsApp-Clone-Client-Angular/master/src/assets/message-mine.png)\n\nIn the main `index.ts` file of the screen we will simply import all 3 in the right order.\nWe will start with the most simple one - the `ChatRoomNavbar`.\nThe navbar should show the picture of the chat we're currently at and its name,\nalong with a back button that will bring us back to the `ChatsListScreen`:\n\n[{]: <helper> (diffStep 6.6 files=\"ChatNavbar\" module=\"client\")\n\n#### Client Step 6.6: Implement ChatRoomScreen components\n\n##### Added src&#x2F;components&#x2F;ChatRoomScreen&#x2F;ChatNavbar.tsx\n```diff\n@@ -0,0 +1,59 @@\n+â”Š  â”Š 1â”Šimport Button from '@material-ui/core/Button';\n+â”Š  â”Š 2â”Šimport Toolbar from '@material-ui/core/Toolbar';\n+â”Š  â”Š 3â”Šimport ArrowBackIcon from '@material-ui/icons/ArrowBack';\n+â”Š  â”Š 4â”Šimport React from 'react';\n+â”Š  â”Š 5â”Šimport { useCallback } from 'react';\n+â”Š  â”Š 6â”Šimport styled from 'styled-components';\n+â”Š  â”Š 7â”Šimport { History } from 'history';\n+â”Š  â”Š 8â”Šimport { ChatQueryResult } from './index';\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Šconst Container = styled(Toolbar) `\n+â”Š  â”Š11â”Š  padding: 0;\n+â”Š  â”Š12â”Š  display: flex;\n+â”Š  â”Š13â”Š  flex-direction: row;\n+â”Š  â”Š14â”Š  background-color: var(--primary-bg);\n+â”Š  â”Š15â”Š  color: var(--primary-text);\n+â”Š  â”Š16â”Š` as typeof Toolbar;\n+â”Š  â”Š17â”Š\n+â”Š  â”Š18â”Šconst BackButton = styled(Button) `\n+â”Š  â”Š19â”Š  svg {\n+â”Š  â”Š20â”Š    color: var(--primary-text);\n+â”Š  â”Š21â”Š  }\n+â”Š  â”Š22â”Š` as typeof Button;\n+â”Š  â”Š23â”Š\n+â”Š  â”Š24â”Šconst Picture = styled.img `\n+â”Š  â”Š25â”Š  height: 40px;\n+â”Š  â”Š26â”Š  width: 40px;\n+â”Š  â”Š27â”Š  margin-top: 3px;\n+â”Š  â”Š28â”Š  margin-left: -22px;\n+â”Š  â”Š29â”Š  object-fit: cover;\n+â”Š  â”Š30â”Š  padding: 5px;\n+â”Š  â”Š31â”Š  border-radius: 50%;\n+â”Š  â”Š32â”Š`;\n+â”Š  â”Š33â”Š\n+â”Š  â”Š34â”Šconst Name = styled.div `\n+â”Š  â”Š35â”Š  line-height: 56px;\n+â”Š  â”Š36â”Š`;\n+â”Š  â”Š37â”Š\n+â”Š  â”Š38â”Šinterface ChatNavbarProps {\n+â”Š  â”Š39â”Š  history: History;\n+â”Š  â”Š40â”Š  chat: ChatQueryResult;\n+â”Š  â”Š41â”Š};\n+â”Š  â”Š42â”Š\n+â”Š  â”Š43â”Šconst ChatNavbar: React.FC<ChatNavbarProps> = ({ chat, history }) => {\n+â”Š  â”Š44â”Š  const navBack = useCallback(() => {\n+â”Š  â”Š45â”Š    history.replace('/chats');\n+â”Š  â”Š46â”Š  }, [history]);\n+â”Š  â”Š47â”Š\n+â”Š  â”Š48â”Š  return (\n+â”Š  â”Š49â”Š    <Container>\n+â”Š  â”Š50â”Š      <BackButton onClick={navBack}>\n+â”Š  â”Š51â”Š        <ArrowBackIcon />\n+â”Š  â”Š52â”Š      </BackButton>\n+â”Š  â”Š53â”Š      <Picture src={chat.picture} />\n+â”Š  â”Š54â”Š      <Name>{chat.name}</Name>\n+â”Š  â”Š55â”Š    </Container>\n+â”Š  â”Š56â”Š  );\n+â”Š  â”Š57â”Š};\n+â”Š  â”Š58â”Š\n+â”Š  â”Š59â”Šexport default ChatNavbar;ðŸš«â†µ\n```\n\n[}]: #\n\nNext, would be the `MesagesList` component, where we will see a scrollable list of all the messages of the active chat:\n\n[{]: <helper> (diffStep 6.6 files=\"MessagesList\" module=\"client\")\n\n#### Client Step 6.6: Implement ChatRoomScreen components\n\n##### Added src&#x2F;components&#x2F;ChatRoomScreen&#x2F;MessagesList.tsx\n```diff\n@@ -0,0 +1,78 @@\n+â”Š  â”Š 1â”Šimport moment from 'moment';\n+â”Š  â”Š 2â”Šimport React from 'react';\n+â”Š  â”Š 3â”Šimport styled from 'styled-components';\n+â”Š  â”Š 4â”Šimport { ChatQueryMessage } from './index';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šconst Container = styled.div`\n+â”Š  â”Š 7â”Š  display: block;\n+â”Š  â”Š 8â”Š  flex: 2;\n+â”Š  â”Š 9â”Š  overflow-y: overlay;\n+â”Š  â”Š10â”Š  padding: 0 15px;\n+â”Š  â”Š11â”Š`;\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Šconst MessageItem = styled.div `\n+â”Š  â”Š14â”Š  float: right;\n+â”Š  â”Š15â”Š  background-color: #dcf8c6;\n+â”Š  â”Š16â”Š  display: inline-block;\n+â”Š  â”Š17â”Š  position: relative;\n+â”Š  â”Š18â”Š  max-width: 100%;\n+â”Š  â”Š19â”Š  border-radius: 7px;\n+â”Š  â”Š20â”Š  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.15);\n+â”Š  â”Š21â”Š  margin-top: 10px;\n+â”Š  â”Š22â”Š  margin-bottom: 10px;\n+â”Š  â”Š23â”Š  clear: both;\n+â”Š  â”Š24â”Š\n+â”Š  â”Š25â”Š  &::after {\n+â”Š  â”Š26â”Š    content: '';\n+â”Š  â”Š27â”Š    display: table;\n+â”Š  â”Š28â”Š    clear: both;\n+â”Š  â”Š29â”Š  }\n+â”Š  â”Š30â”Š\n+â”Š  â”Š31â”Š  &::before {\n+â”Š  â”Š32â”Š    background-image: url(/assets/message-mine.png);\n+â”Š  â”Š33â”Š    content: '';\n+â”Š  â”Š34â”Š    position: absolute;\n+â”Š  â”Š35â”Š    bottom: 3px;\n+â”Š  â”Š36â”Š    width: 12px;\n+â”Š  â”Š37â”Š    height: 19px;\n+â”Š  â”Š38â”Š    right: -11px;\n+â”Š  â”Š39â”Š    background-position: 50% 50%;\n+â”Š  â”Š40â”Š    background-repeat: no-repeat;\n+â”Š  â”Š41â”Š    background-size: contain;\n+â”Š  â”Š42â”Š  }\n+â”Š  â”Š43â”Š`;\n+â”Š  â”Š44â”Š\n+â”Š  â”Š45â”Šconst Contents = styled.div `\n+â”Š  â”Š46â”Š  padding: 5px 7px;\n+â”Š  â”Š47â”Š  word-wrap: break-word;\n+â”Š  â”Š48â”Š\n+â”Š  â”Š49â”Š  &::after {\n+â”Š  â”Š50â”Š    content: ' \\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0';\n+â”Š  â”Š51â”Š    display: inline;\n+â”Š  â”Š52â”Š  }\n+â”Š  â”Š53â”Š`;\n+â”Š  â”Š54â”Š\n+â”Š  â”Š55â”Šconst Timestamp = styled.div `\n+â”Š  â”Š56â”Š  position: absolute;\n+â”Š  â”Š57â”Š  bottom: 2px;\n+â”Š  â”Š58â”Š  right: 7px;\n+â”Š  â”Š59â”Š  color: gray;\n+â”Š  â”Š60â”Š  font-size: 12px;\n+â”Š  â”Š61â”Š`;\n+â”Š  â”Š62â”Š\n+â”Š  â”Š63â”Šinterface MessagesListProps {\n+â”Š  â”Š64â”Š  messages: Array<ChatQueryMessage>;\n+â”Š  â”Š65â”Š}\n+â”Š  â”Š66â”Š\n+â”Š  â”Š67â”Šconst MessagesList: React.FC<MessagesListProps> = ({ messages }) => (\n+â”Š  â”Š68â”Š  <Container>\n+â”Š  â”Š69â”Š    {messages.map((message: any) => (\n+â”Š  â”Š70â”Š      <MessageItem key={message.id}>\n+â”Š  â”Š71â”Š        <Contents>{message.content}</Contents>\n+â”Š  â”Š72â”Š        <Timestamp>{moment(message.createdAt).format('HH:mm')}</Timestamp>\n+â”Š  â”Š73â”Š      </MessageItem>\n+â”Š  â”Š74â”Š    ))}\n+â”Š  â”Š75â”Š  </Container>\n+â”Š  â”Š76â”Š);\n+â”Š  â”Š77â”Š\n+â”Š  â”Š78â”Šexport default MessagesList;ðŸš«â†µ\n```\n\n[}]: #\n\nAnd finally, would be the `MessageInput` component which will trigger an event whenever we type and submit a new message:\n\n[{]: <helper> (diffStep 6.6 files=\"MessageInput\" module=\"client\")\n\n#### Client Step 6.6: Implement ChatRoomScreen components\n\n##### Added src&#x2F;components&#x2F;ChatRoomScreen&#x2F;MessageInput.tsx\n```diff\n@@ -0,0 +1,60 @@\n+â”Š  â”Š 1â”Šimport Button from '@material-ui/core/Button';\n+â”Š  â”Š 2â”Šimport SendIcon from '@material-ui/icons/Send';\n+â”Š  â”Š 3â”Šimport React from 'react';\n+â”Š  â”Š 4â”Šimport styled from 'styled-components';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šconst Container = styled.div`\n+â”Š  â”Š 7â”Š  display: flex;\n+â”Š  â”Š 8â”Š  height: 50px;\n+â”Š  â”Š 9â”Š  padding: 5px;\n+â”Š  â”Š10â”Š  width: calc(100% - 10px);\n+â”Š  â”Š11â”Š`;\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Šconst ActualInput = styled.input `\n+â”Š  â”Š14â”Š  width: calc(100% - 50px);\n+â”Š  â”Š15â”Š  border: none;\n+â”Š  â”Š16â”Š  border-radius: 999px;\n+â”Š  â”Š17â”Š  padding: 10px;\n+â”Š  â”Š18â”Š  padding-left: 20px;\n+â”Š  â”Š19â”Š  padding-right: 20px;\n+â”Š  â”Š20â”Š  font-size: 15px;\n+â”Š  â”Š21â”Š  outline: none;\n+â”Š  â”Š22â”Š  box-shadow: 0 1px silver;\n+â”Š  â”Š23â”Š  font-size: 18px;\n+â”Š  â”Š24â”Š  line-height: 45px;\n+â”Š  â”Š25â”Š`;\n+â”Š  â”Š26â”Š\n+â”Š  â”Š27â”Šconst SendButton = styled(Button) `\n+â”Š  â”Š28â”Š  min-width: 50px !important;\n+â”Š  â”Š29â”Š  width: 50px !important;\n+â”Š  â”Š30â”Š  border-radius: 999px !important;\n+â”Š  â”Š31â”Š  background-color: var(--primary-bg) !important;\n+â”Š  â”Š32â”Š  margin: 0 5px !important;\n+â”Š  â”Š33â”Š  margin-right: 0 !important;\n+â”Š  â”Š34â”Š  color: white !important;\n+â”Š  â”Š35â”Š  padding-left: 20px !important;\n+â”Š  â”Š36â”Š\n+â”Š  â”Š37â”Š  svg {\n+â”Š  â”Š38â”Š    margin-left: -3px;\n+â”Š  â”Š39â”Š  }\n+â”Š  â”Š40â”Š` as typeof Button;\n+â”Š  â”Š41â”Š\n+â”Š  â”Š42â”Šconst MessageInput: React.FC = () => {\n+â”Š  â”Š43â”Š\n+â”Š  â”Š44â”Š  return (\n+â”Š  â”Š45â”Š    <Container>\n+â”Š  â”Š46â”Š      <ActualInput\n+â”Š  â”Š47â”Š        type=\"text\"\n+â”Š  â”Š48â”Š        placeholder=\"Type a message\"\n+â”Š  â”Š49â”Š      />\n+â”Š  â”Š50â”Š      <SendButton\n+â”Š  â”Š51â”Š        variant=\"contained\"\n+â”Š  â”Š52â”Š        color=\"primary\"\n+â”Š  â”Š53â”Š      >\n+â”Š  â”Š54â”Š        <SendIcon />\n+â”Š  â”Š55â”Š      </SendButton>\n+â”Š  â”Š56â”Š    </Container>\n+â”Š  â”Š57â”Š  );\n+â”Š  â”Š58â”Š};\n+â”Š  â”Š59â”Š\n+â”Š  â”Š60â”Šexport default MessageInput;ðŸš«â†µ\n```\n\n[}]: #\n\nNow that we have all 3 components, we will put them all together in the main `index.ts` file:\n\n[{]: <helper> (diffStep 6.6 files=\"index\" module=\"client\")\n\n#### Client Step 6.6: Implement ChatRoomScreen components\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -1,5 +1,17 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n â”Š 2â”Š 2â”Šimport { useMemo, useState } from 'react';\n+â”Š  â”Š 3â”Šimport styled from 'styled-components';\n+â”Š  â”Š 4â”Šimport ChatNavbar from './ChatNavbar';\n+â”Š  â”Š 5â”Šimport MessageInput from './MessageInput';\n+â”Š  â”Š 6â”Šimport MessagesList from './MessagesList';\n+â”Š  â”Š 7â”Šimport { History } from 'history';\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Š const Container = styled.div `\n+â”Š  â”Š10â”Š  background: url(/assets/chat-background.jpg);\n+â”Š  â”Š11â”Š  display: flex;\n+â”Š  â”Š12â”Š  flex-flow: column;\n+â”Š  â”Š13â”Š  height: 100vh;\n+â”Š  â”Š14â”Š`;\n â”Š 3â”Š15â”Š\n â”Š 4â”Š16â”Šconst getChatQuery = `\n â”Š 5â”Š17â”Š  query GetChat($chatId: ID!) {\n```\n```diff\n@@ -18,15 +30,16 @@\n â”Š18â”Š30â”Š\n â”Š19â”Š31â”Šinterface ChatRoomScreenParams {\n â”Š20â”Š32â”Š  chatId: string\n+â”Š  â”Š33â”Š  history: History;\n â”Š21â”Š34â”Š};\n â”Š22â”Š35â”Š\n-â”Š23â”Š  â”Šinterface ChatQueryMessage {\n+â”Š  â”Š36â”Šexport interface ChatQueryMessage {\n â”Š24â”Š37â”Š  id: string;\n â”Š25â”Š38â”Š  content: string;\n â”Š26â”Š39â”Š  createdAt: string;\n â”Š27â”Š40â”Š};\n â”Š28â”Š41â”Š\n-â”Š29â”Š  â”Šinterface ChatQueryResult {\n+â”Š  â”Š42â”Šexport interface ChatQueryResult {\n â”Š30â”Š43â”Š  id: string;\n â”Š31â”Š44â”Š  name: string;\n â”Š32â”Š45â”Š  picture: string;\n```\n```diff\n@@ -35,7 +48,7 @@\n â”Š35â”Š48â”Š\n â”Š36â”Š49â”Štype OptionalChatQueryResult = ChatQueryResult | null;\n â”Š37â”Š50â”Š\n-â”Š38â”Š  â”Šconst ChatRoomScreen: React.FC<ChatRoomScreenParams> = ({ chatId }) => {\n+â”Š  â”Š51â”Šconst ChatRoomScreen: React.FC<ChatRoomScreenParams> = ({ history, chatId }) => {\n â”Š39â”Š52â”Š  const [chat, setChat] = useState<OptionalChatQueryResult>(null);\n â”Š40â”Š53â”Š\n â”Š41â”Š54â”Š  useMemo(async () => {\n```\n```diff\n@@ -56,18 +69,13 @@\n â”Š56â”Š69â”Š  if (!chat) return null;\n â”Š57â”Š70â”Š\n â”Š58â”Š71â”Š  return (\n-â”Š59â”Š  â”Š    <div>\n-â”Š60â”Š  â”Š      <img src={chat.picture} alt=\"Profile\"/>\n-â”Š61â”Š  â”Š      <div>{chat.name}</div>\n-â”Š62â”Š  â”Š      <ul>\n-â”Š63â”Š  â”Š        {chat.messages.map((message) =>\n-â”Š64â”Š  â”Š          <li key={message.id}>\n-â”Š65â”Š  â”Š            <div>{message.content}</div>\n-â”Š66â”Š  â”Š            <div>{message.createdAt}</div>\n-â”Š67â”Š  â”Š          </li>\n-â”Š68â”Š  â”Š        )}\n-â”Š69â”Š  â”Š      </ul>\n-â”Š70â”Š  â”Š    </div>\n+â”Š  â”Š72â”Š    <Container>\n+â”Š  â”Š73â”Š      <ChatNavbar chat={chat} history={history} />\n+â”Š  â”Š74â”Š      {chat.messages && (\n+â”Š  â”Š75â”Š        <MessagesList messages={chat.messages} />\n+â”Š  â”Š76â”Š      )}\n+â”Š  â”Š77â”Š      <MessageInput />\n+â”Š  â”Š78â”Š    </Container>\n â”Š71â”Š79â”Š  );\n â”Š72â”Š80â”Š};\n```\n\n[}]: #\n\nThe view is complete! However the `MessageInput` is not bound to our messages list.\nWe will use the triggered callback to update the chat state, whose changes should appear in the `MessagesList` component in the following render phase:\n\n[{]: <helper> (diffStep 6.7 module=\"client\")\n\n#### Client Step 6.7: Define onSendMessage callback\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;MessageInput.tsx\n```diff\n@@ -2,6 +2,7 @@\n â”Š2â”Š2â”Šimport SendIcon from '@material-ui/icons/Send';\n â”Š3â”Š3â”Šimport React from 'react';\n â”Š4â”Š4â”Šimport styled from 'styled-components';\n+â”Š â”Š5â”Šimport { useState } from 'react';\n â”Š5â”Š6â”Š\n â”Š6â”Š7â”Šconst Container = styled.div`\n â”Š7â”Š8â”Š  display: flex;\n```\n```diff\n@@ -39,17 +40,46 @@\n â”Š39â”Š40â”Š  }\n â”Š40â”Š41â”Š` as typeof Button;\n â”Š41â”Š42â”Š\n-â”Š42â”Š  â”Šconst MessageInput: React.FC = () => {\n+â”Š  â”Š43â”Šinterface MessageInputProps {\n+â”Š  â”Š44â”Š  onSendMessage(content: string): any;\n+â”Š  â”Š45â”Š}\n+â”Š  â”Š46â”Š\n+â”Š  â”Š47â”Šconst MessageInput: React.FC<MessageInputProps> = ({ onSendMessage }) => {\n+â”Š  â”Š48â”Š  const [message, setMessage] = useState(\"\");\n+â”Š  â”Š49â”Š\n+â”Š  â”Š50â”Š  const onKeyPress = (e: any) => {\n+â”Š  â”Š51â”Š    if (e.charCode === 13) {\n+â”Š  â”Š52â”Š      submitMessage();\n+â”Š  â”Š53â”Š    }\n+â”Š  â”Š54â”Š  };\n+â”Š  â”Š55â”Š\n+â”Š  â”Š56â”Š  const onChange = ({ target }: any) => {\n+â”Š  â”Š57â”Š    setMessage(target.value);\n+â”Š  â”Š58â”Š  };\n+â”Š  â”Š59â”Š\n+â”Š  â”Š60â”Š  const submitMessage = () => {\n+â”Š  â”Š61â”Š    if (!message) return;\n+â”Š  â”Š62â”Š\n+â”Š  â”Š63â”Š    setMessage(\"\");\n+â”Š  â”Š64â”Š\n+â”Š  â”Š65â”Š    if (typeof onSendMessage === \"function\") {\n+â”Š  â”Š66â”Š      onSendMessage(message);\n+â”Š  â”Š67â”Š    }\n+â”Š  â”Š68â”Š  };\n â”Š43â”Š69â”Š\n â”Š44â”Š70â”Š  return (\n â”Š45â”Š71â”Š    <Container>\n â”Š46â”Š72â”Š      <ActualInput\n â”Š47â”Š73â”Š        type=\"text\"\n â”Š48â”Š74â”Š        placeholder=\"Type a message\"\n+â”Š  â”Š75â”Š        value={message}\n+â”Š  â”Š76â”Š        onKeyPress={onKeyPress}\n+â”Š  â”Š77â”Š        onChange={onChange}\n â”Š49â”Š78â”Š      />\n â”Š50â”Š79â”Š      <SendButton\n â”Š51â”Š80â”Š        variant=\"contained\"\n â”Š52â”Š81â”Š        color=\"primary\"\n+â”Š  â”Š82â”Š        onClick={submitMessage}\n â”Š53â”Š83â”Š      >\n â”Š54â”Š84â”Š        <SendIcon />\n â”Š55â”Š85â”Š      </SendButton>\n```\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -1,5 +1,5 @@\n â”Š1â”Š1â”Šimport React from 'react';\n-â”Š2â”Š â”Šimport { useMemo, useState } from 'react';\n+â”Š â”Š2â”Šimport { useCallback, useMemo, useState } from 'react';\n â”Š3â”Š3â”Šimport styled from 'styled-components';\n â”Š4â”Š4â”Šimport ChatNavbar from './ChatNavbar';\n â”Š5â”Š5â”Šimport MessageInput from './MessageInput';\n```\n```diff\n@@ -36,7 +36,7 @@\n â”Š36â”Š36â”Šexport interface ChatQueryMessage {\n â”Š37â”Š37â”Š  id: string;\n â”Š38â”Š38â”Š  content: string;\n-â”Š39â”Š  â”Š  createdAt: string;\n+â”Š  â”Š39â”Š  createdAt: number;\n â”Š40â”Š40â”Š};\n â”Š41â”Š41â”Š\n â”Š42â”Š42â”Šexport interface ChatQueryResult {\n```\n```diff\n@@ -66,6 +66,23 @@\n â”Š66â”Š66â”Š    setChat(chat);\n â”Š67â”Š67â”Š  }, [chatId]);\n â”Š68â”Š68â”Š\n+â”Š  â”Š69â”Š  const onSendMessage = useCallback((content: string) => {\n+â”Š  â”Š70â”Š    if (!chat) return null;\n+â”Š  â”Š71â”Š\n+â”Š  â”Š72â”Š    const message = {\n+â”Š  â”Š73â”Š      id: (chat.messages.length + 10).toString(),\n+â”Š  â”Š74â”Š      createdAt: Date.now(),\n+â”Š  â”Š75â”Š      content,\n+â”Š  â”Š76â”Š    };\n+â”Š  â”Š77â”Š\n+â”Š  â”Š78â”Š    console.log(chat.messages);\n+â”Š  â”Š79â”Š\n+â”Š  â”Š80â”Š     setChat({\n+â”Š  â”Š81â”Š      ...chat,\n+â”Š  â”Š82â”Š      messages: chat.messages.concat(message),\n+â”Š  â”Š83â”Š    });\n+â”Š  â”Š84â”Š  }, [chat]);\n+â”Š  â”Š85â”Š\n â”Š69â”Š86â”Š  if (!chat) return null;\n â”Š70â”Š87â”Š\n â”Š71â”Š88â”Š  return (\n```\n```diff\n@@ -74,7 +91,7 @@\n â”Š74â”Š91â”Š      {chat.messages && (\n â”Š75â”Š92â”Š        <MessagesList messages={chat.messages} />\n â”Š76â”Š93â”Š      )}\n-â”Š77â”Š  â”Š      <MessageInput />\n+â”Š  â”Š94â”Š      <MessageInput onSendMessage={onSendMessage}/>\n â”Š78â”Š95â”Š    </Container>\n â”Š79â”Š96â”Š  );\n â”Š80â”Š97â”Š};\n```\n\n[}]: #\n\nThis is how the entire flow should look like:\n\n![flow-demo](https://user-images.githubusercontent.com/7648874/54739741-27012280-4bf4-11e9-97cb-c715482e2e70.gif)\n\nAn edge case that should be taken care of is when the messages list length in the view exceeds the length of the container,\nin which case we will have to scroll down to the bottom of the view.\nThis way we can keep track of the most recent message.\nWe will use `ReactDOM` to retrieve the native HTML element of the container and change the position of the scroller whenever a messages was sent:\n\n[{]: <helper> (diffStep 6.8 module=\"client\")\n\n#### Client Step 6.8: Reset scroller on message sent\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;MessagesList.tsx\n```diff\n@@ -1,5 +1,7 @@\n â”Š1â”Š1â”Šimport moment from 'moment';\n â”Š2â”Š2â”Šimport React from 'react';\n+â”Š â”Š3â”Šimport { useEffect, useRef } from 'react';\n+â”Š â”Š4â”Šimport ReactDOM from 'react-dom';\n â”Š3â”Š5â”Šimport styled from 'styled-components';\n â”Š4â”Š6â”Šimport { ChatQueryMessage } from './index';\n â”Š5â”Š7â”Š\n```\n```diff\n@@ -64,15 +66,26 @@\n â”Š64â”Š66â”Š  messages: Array<ChatQueryMessage>;\n â”Š65â”Š67â”Š}\n â”Š66â”Š68â”Š\n-â”Š67â”Š  â”Šconst MessagesList: React.FC<MessagesListProps> = ({ messages }) => (\n-â”Š68â”Š  â”Š  <Container>\n-â”Š69â”Š  â”Š    {messages.map((message: any) => (\n-â”Š70â”Š  â”Š      <MessageItem key={message.id}>\n-â”Š71â”Š  â”Š        <Contents>{message.content}</Contents>\n-â”Š72â”Š  â”Š        <Timestamp>{moment(message.createdAt).format('HH:mm')}</Timestamp>\n-â”Š73â”Š  â”Š      </MessageItem>\n-â”Š74â”Š  â”Š    ))}\n-â”Š75â”Š  â”Š  </Container>\n-â”Š76â”Š  â”Š);\n+â”Š  â”Š69â”Šconst MessagesList: React.FC<MessagesListProps> = ({ messages }) => {\n+â”Š  â”Š70â”Š  const selfRef = useRef(null);\n+â”Š  â”Š71â”Š\n+â”Š  â”Š72â”Š  useEffect(() => {\n+â”Š  â”Š73â”Š    if (!selfRef.current) return;\n+â”Š  â”Š74â”Š\n+â”Š  â”Š75â”Š     const selfDOMNode = ReactDOM.findDOMNode(selfRef.current) as HTMLElement;\n+â”Š  â”Š76â”Š    selfDOMNode.scrollTop = Number.MAX_SAFE_INTEGER;\n+â”Š  â”Š77â”Š  }, [messages.length]);\n+â”Š  â”Š78â”Š\n+â”Š  â”Š79â”Š  return (\n+â”Š  â”Š80â”Š    <Container ref={selfRef}>\n+â”Š  â”Š81â”Š      {messages.map((message: any) => (\n+â”Š  â”Š82â”Š        <MessageItem key={message.id}>\n+â”Š  â”Š83â”Š          <Contents>{message.content}</Contents>\n+â”Š  â”Š84â”Š          <Timestamp>{moment(message.createdAt).format('HH:mm')}</Timestamp>\n+â”Š  â”Š85â”Š        </MessageItem>\n+â”Š  â”Š86â”Š      ))}\n+â”Š  â”Š87â”Š    </Container>\n+â”Š  â”Š88â”Š  )\n+â”Š  â”Š89â”Š};\n â”Š77â”Š90â”Š\n â”Š78â”Š91â”Šexport default MessagesList;ðŸš«â†µ\n```\n\n[}]: #\n\nBefore we wrap things up, we should also test our components.\nSince the new components have a direct control over the app's history,\nwe should also find a way to simulate it in our tests.\nBecause `react-dom-router` uses the [`history`](https://www.npmjs.com/package/history) package under the hood,\nthat means that we can use that package to inject a custom history object directly into the tested components:\n\n[{]: <helper> (diffStep 6.9 files=\"components\" module=\"client\")\n\n#### Client Step 6.9: Test ChatRoomScreen child components\n\n##### Added src&#x2F;components&#x2F;ChatRoomScreen&#x2F;ChatNavbar.test.tsx\n```diff\n@@ -0,0 +1,49 @@\n+â”Š  â”Š 1â”Šimport { createMemoryHistory } from 'history';\n+â”Š  â”Š 2â”Šimport React from 'react';\n+â”Š  â”Š 3â”Šimport { cleanup, render, fireEvent, wait } from 'react-testing-library';\n+â”Š  â”Š 4â”Šimport ChatNavbar from './ChatNavbar';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šdescribe('ChatNavbar', () => {\n+â”Š  â”Š 7â”Š  afterEach(cleanup);\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Š  it('renders chat data', () => {\n+â”Š  â”Š10â”Š    const chat = {\n+â”Š  â”Š11â”Š      id: '1',\n+â”Š  â”Š12â”Š      name: 'Foo Bar',\n+â”Š  â”Š13â”Š      picture: 'https://localhost:4000/picture.jpg',\n+â”Š  â”Š14â”Š    };\n+â”Š  â”Š15â”Š\n+â”Š  â”Š16â”Š    {\n+â”Š  â”Š17â”Š      const { container, getByTestId } = render(<ChatNavbar chat={chat} />);\n+â”Š  â”Š18â”Š\n+â”Š  â”Š19â”Š      expect(getByTestId('chat-name')).toHaveTextContent('Foo Bar');\n+â”Š  â”Š20â”Š      expect(getByTestId('chat-picture')).toHaveAttribute('src', 'https://localhost:4000/picture.jpg');\n+â”Š  â”Š21â”Š    }\n+â”Š  â”Š22â”Š  })\n+â”Š  â”Š23â”Š\n+â”Š  â”Š24â”Š  it('goes back on arrow click', async () => {\n+â”Š  â”Š25â”Š    const chat = {\n+â”Š  â”Š26â”Š      id: '1',\n+â”Š  â”Š27â”Š      name: 'Foo Bar',\n+â”Š  â”Š28â”Š      picture: 'https://localhost:4000/picture.jpg',\n+â”Š  â”Š29â”Š    };\n+â”Š  â”Š30â”Š\n+â”Š  â”Š31â”Š    const history = createMemoryHistory();\n+â”Š  â”Š32â”Š\n+â”Š  â”Š33â”Š    history.push('/chats/1');\n+â”Š  â”Š34â”Š\n+â”Š  â”Š35â”Š    await wait(() =>\n+â”Š  â”Š36â”Š      expect(history.location.pathname).toEqual('/chats/1')\n+â”Š  â”Š37â”Š    )\n+â”Š  â”Š38â”Š\n+â”Š  â”Š39â”Š    {\n+â”Š  â”Š40â”Š      const { container, getByTestId } = render(<ChatNavbar chat={chat} history={history} />);\n+â”Š  â”Š41â”Š\n+â”Š  â”Š42â”Š      fireEvent.click(getByTestId('back-button'));\n+â”Š  â”Š43â”Š\n+â”Š  â”Š44â”Š      await wait(() =>\n+â”Š  â”Š45â”Š        expect(history.location.pathname).toEqual('/chats')\n+â”Š  â”Š46â”Š      );\n+â”Š  â”Š47â”Š    }\n+â”Š  â”Š48â”Š  });\n+â”Š  â”Š49â”Š});ðŸš«â†µ\n```\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;ChatNavbar.tsx\n```diff\n@@ -47,11 +47,11 @@\n â”Š47â”Š47â”Š\n â”Š48â”Š48â”Š  return (\n â”Š49â”Š49â”Š    <Container>\n-â”Š50â”Š  â”Š      <BackButton onClick={navBack}>\n+â”Š  â”Š50â”Š      <BackButton data-testid=\"back-button\" onClick={navBack}>\n â”Š51â”Š51â”Š        <ArrowBackIcon />\n â”Š52â”Š52â”Š      </BackButton>\n-â”Š53â”Š  â”Š      <Picture src={chat.picture} />\n-â”Š54â”Š  â”Š      <Name>{chat.name}</Name>\n+â”Š  â”Š53â”Š      <Picture data-testid=\"chat-picture\" src={chat.picture} />\n+â”Š  â”Š54â”Š      <Name data-testid=\"chat-name\">{chat.name}</Name>\n â”Š55â”Š55â”Š    </Container>\n â”Š56â”Š56â”Š  );\n â”Š57â”Š57â”Š};\n```\n\n##### Added src&#x2F;components&#x2F;ChatRoomScreen&#x2F;MessageInput.test.tsx\n```diff\n@@ -0,0 +1,47 @@\n+â”Š  â”Š 1â”Šimport { createMemoryHistory } from 'history';\n+â”Š  â”Š 2â”Šimport React from 'react';\n+â”Š  â”Š 3â”Šimport { cleanup, render, fireEvent, wait, waitForElement } from 'react-testing-library';\n+â”Š  â”Š 4â”Šimport MessageInput from './MessageInput';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šdescribe('MessageInput;', () => {\n+â”Š  â”Š 7â”Š  afterEach(cleanup);\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Š  it('triggers callback on send button click', async () => {\n+â”Š  â”Š10â”Š    const onSendMessage = jest.fn(() => {});\n+â”Š  â”Š11â”Š\n+â”Š  â”Š12â”Š    {\n+â”Š  â”Š13â”Š      const { container, getByTestId } = render(<MessageInput onSendMessage={onSendMessage} />);\n+â”Š  â”Š14â”Š      const messageInput = getByTestId('message-input');\n+â”Š  â”Š15â”Š      const sendButton = getByTestId('send-button');\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š      fireEvent.change(messageInput, { target: { value: 'foo' } });\n+â”Š  â”Š18â”Š\n+â”Š  â”Š19â”Š      await waitForElement(() => messageInput);\n+â”Š  â”Š20â”Š\n+â”Š  â”Š21â”Š      fireEvent.click(sendButton);\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Š      await wait(() =>\n+â”Š  â”Š24â”Š        expect(onSendMessage.mock.calls.length).toBe(1)\n+â”Š  â”Š25â”Š      );\n+â”Š  â”Š26â”Š    }\n+â”Š  â”Š27â”Š  });\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š  it('triggers callback on Enter press', async () => {\n+â”Š  â”Š30â”Š    const onSendMessage = jest.fn(() => {});\n+â”Š  â”Š31â”Š\n+â”Š  â”Š32â”Š    {\n+â”Š  â”Š33â”Š      const { container, getByTestId } = render(<MessageInput onSendMessage={onSendMessage} />);\n+â”Š  â”Š34â”Š      const messageInput = getByTestId('message-input');\n+â”Š  â”Š35â”Š\n+â”Š  â”Š36â”Š      fireEvent.change(messageInput, { target: { value: 'foo' } });\n+â”Š  â”Š37â”Š\n+â”Š  â”Š38â”Š      await waitForElement(() => messageInput);\n+â”Š  â”Š39â”Š\n+â”Š  â”Š40â”Š      fireEvent.keyPress(messageInput, { key: 'Enter', code: 13, charCode: 13 });\n+â”Š  â”Š41â”Š\n+â”Š  â”Š42â”Š      await wait(() =>\n+â”Š  â”Š43â”Š        expect(onSendMessage.mock.calls.length).toBe(1)\n+â”Š  â”Š44â”Š      );\n+â”Š  â”Š45â”Š    }\n+â”Š  â”Š46â”Š  });\n+â”Š  â”Š47â”Š});ðŸš«â†µ\n```\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;MessageInput.tsx\n```diff\n@@ -70,6 +70,7 @@\n â”Š70â”Š70â”Š  return (\n â”Š71â”Š71â”Š    <Container>\n â”Š72â”Š72â”Š      <ActualInput\n+â”Š  â”Š73â”Š        data-testid=\"message-input\"\n â”Š73â”Š74â”Š        type=\"text\"\n â”Š74â”Š75â”Š        placeholder=\"Type a message\"\n â”Š75â”Š76â”Š        value={message}\n```\n```diff\n@@ -77,6 +78,7 @@\n â”Š77â”Š78â”Š        onChange={onChange}\n â”Š78â”Š79â”Š      />\n â”Š79â”Š80â”Š      <SendButton\n+â”Š  â”Š81â”Š        data-testid=\"send-button\"\n â”Š80â”Š82â”Š        variant=\"contained\"\n â”Š81â”Š83â”Š        color=\"primary\"\n â”Š82â”Š84â”Š        onClick={submitMessage}\n```\n\n##### Added src&#x2F;components&#x2F;ChatRoomScreen&#x2F;MessagesList.test.tsx\n```diff\n@@ -0,0 +1,37 @@\n+â”Š  â”Š 1â”Šimport { createMemoryHistory } from 'history';\n+â”Š  â”Š 2â”Šimport React from 'react';\n+â”Š  â”Š 3â”Šimport { cleanup, render, fireEvent, wait, getByTestId } from 'react-testing-library';\n+â”Š  â”Š 4â”Šimport MessagesList from './MessagesList';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šdescribe('MessagesList', () => {\n+â”Š  â”Š 7â”Š  afterEach(cleanup);\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Š  it('renders messages data', () => {\n+â”Š  â”Š10â”Š    const messages = [\n+â”Š  â”Š11â”Š      {\n+â”Š  â”Š12â”Š        id: '1',\n+â”Š  â”Š13â”Š        content: 'foo',\n+â”Š  â”Š14â”Š        createdAt: new Date('14 Jun 2017 00:00:00 PDT').toUTCString(),\n+â”Š  â”Š15â”Š      },\n+â”Š  â”Š16â”Š      {\n+â”Š  â”Š17â”Š        id: '2',\n+â”Š  â”Š18â”Š        content: 'bar',\n+â”Š  â”Š19â”Š        createdAt: new Date('17 Jun 2017 00:01:00 PDT').toUTCString(),\n+â”Š  â”Š20â”Š      },\n+â”Š  â”Š21â”Š    ];\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Š    let message1, message2;\n+â”Š  â”Š24â”Š    {\n+â”Š  â”Š25â”Š      const { container, getAllByTestId, getByTestId } = render(<MessagesList messages={messages} />);\n+â”Š  â”Š26â”Š      const match = getAllByTestId('message-item');\n+â”Š  â”Š27â”Š      message1 = match[0];\n+â”Š  â”Š28â”Š      message2 = match[1];\n+â”Š  â”Š29â”Š    }\n+â”Š  â”Š30â”Š\n+â”Š  â”Š31â”Š    expect(getByTestId(message1, 'message-content')).toHaveTextContent('foo');\n+â”Š  â”Š32â”Š    expect(getByTestId(message1, 'message-date')).toHaveTextContent('10:00');\n+â”Š  â”Š33â”Š\n+â”Š  â”Š34â”Š    expect(getByTestId(message2, 'message-content')).toHaveTextContent('bar');\n+â”Š  â”Š35â”Š    expect(getByTestId(message2, 'message-date')).toHaveTextContent('10:01');\n+â”Š  â”Š36â”Š  });\n+â”Š  â”Š37â”Š});ðŸš«â†µ\n```\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;MessagesList.tsx\n```diff\n@@ -79,9 +79,9 @@\n â”Š79â”Š79â”Š  return (\n â”Š80â”Š80â”Š    <Container ref={selfRef}>\n â”Š81â”Š81â”Š      {messages.map((message: any) => (\n-â”Š82â”Š  â”Š        <MessageItem key={message.id}>\n-â”Š83â”Š  â”Š          <Contents>{message.content}</Contents>\n-â”Š84â”Š  â”Š          <Timestamp>{moment(message.createdAt).format('HH:mm')}</Timestamp>\n+â”Š  â”Š82â”Š        <MessageItem data-testid=\"message-item\" key={message.id}>\n+â”Š  â”Š83â”Š          <Contents data-testid=\"message-content\">{message.content}</Contents>\n+â”Š  â”Š84â”Š          <Timestamp data-testid=\"message-date\">{moment(message.createdAt).format('HH:mm')}</Timestamp>\n â”Š85â”Š85â”Š        </MessageItem>\n â”Š86â”Š86â”Š      ))}\n â”Š87â”Š87â”Š    </Container>\n```\n\n[}]: #\n\nThere are many things which are incomplete in the current implementation. The functionality exists in the UI, but no messages are really being sent and stored in the database. In the next chapters we will learn how to:\n\n\n\n*   Cache query results with Apollo-Client.\n*   Send messages with GraphQL mutations\n\n--------\nTODO: Add this to router chapter - https://www.pluralsight.com/guides/react-router-typescript\nAnd this - https://stackoverflow.com/questions/49342390/typescript-how-to-add-type-check-for-history-object-in-react\n\nTODO: https://medium.com/@jrwebdev/react-higher-order-component-patterns-in-typescript-42278f7590fb\n\nTODO: https://www.cypress.io/blog/2019/05/13/code-create-react-app-v3-and-its-cypress-tests-using-typescript/#\n\nTODO: Schema says thereâ€™s always an array with messages, is it really true? Is newly created chat resolves an empty array, null will throw an error?\n\nTODO: Same thing with `chats: [Chat!]!`, do we always return an array here?\n\nTODO: _root and type all resolvers\n\nTODO: How to import schema together with jest, should I changed from ts-jest?\n\nTODO: remove all that part including the file in the commit\n\nTODO: Add all the new files and changes on 6.6\n\nTODO: Add all the new files and changes on 6.7"
          },
          {
            "manualTitle": "Step 7: Caching with Apollo-Client",
            "stepRevision": "00b04bd11897e0a5c13ae50bb28a973622a78d41",
            "manualView": "In the previous step we've implemented a `ChatRoomScreen` where we were able to view each chat's messages list by clicking on a chat item from the main screen.\nIt all looks functional, however, there's a significant optimization issue - each time we navigate into a `ChatRoomScreen`,\nwe need to re-fetch the data related to the target chat.\n\nThe solution for that would be [caching](https://en.wikipedia.org/wiki/Cache_(computing)) the fetch result,\nso it can be re-used once we re-enter a screen that we've visited before.\nFor now things are fairly simple so the caching mechanism can be implemented manually,\nbut things are gonna get tougher when we add more queries or things like message sending and profile updating to the mix,\nso it's not gonna be an easy task.\n\nLuckily, in the Apollo team they've invented a solution that works right out of the box and integrates perfectly with Apollo-GraphQL server - [Apollo-GraphQL client](https://www.apollographql.com/docs/link/#apollo-client).\n\n\n![caching](https://user-images.githubusercontent.com/7648874/54871150-f505e100-4dea-11e9-9e2d-439fbf3eaebe.png)\n\n\n\nApollo-Client is a wrap around our GraphQL endpoint which essentially uses HTTP requests (and further on [web-sockets](https://en.wikipedia.org/wiki/WebSocket), but we will get there), something that we've implemented manually so far.\nNot only it can be used to fetch data, but it will also cache the result of the query so it can be seamlessly re-used when we request the same data.\nThis means that we will need to setup an Apollo-Client and replace all our `fetch()` calls with `client.query()` call.\nMore about Apollo-Client's API further in this tutorial, but let's start configuring it.\nFirst we will install few essential NPM packages:\n\n    $ yarn add apollo-client apollo-cache-inmemory apollo-link apollo-link-http\n\n\n\n*   [`apollo-client`](https://www.npmjs.com/package/apollo-client) - Apollo-Client's core package, as we explained earlier.\n*   [`apollo-cache-inmemory`](https://www.npmjs.com/package/apollo-cache-inmemory) - The data store that will be used to cache the results.\n*   [`apollo-link-http`](https://www.npmjs.com/package/apollo-link-http) - Get GraphQL results over a network using HTTP fetch.\n\nWe will create a new file in the `src` directory called `client.ts` and inside we will export the client:\n\n[{]: <helper> (diffStep 7.1 files=\"client\" module=\"client\")\n\n#### Client Step 7.1: Add Apollo client\n\n##### Added src&#x2F;client.ts\n```diff\n@@ -0,0 +1,16 @@\n+â”Š  â”Š 1â”Šimport { InMemoryCache } from 'apollo-cache-inmemory';\n+â”Š  â”Š 2â”Šimport { ApolloClient } from 'apollo-client';\n+â”Š  â”Š 3â”Šimport { HttpLink } from 'apollo-link-http';\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šconst httpUri = process.env.REACT_APP_SERVER_URL + '/graphql';\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Šconst httpLink = new HttpLink({\n+â”Š  â”Š 8â”Š  uri: httpUri,\n+â”Š  â”Š 9â”Š});\n+â”Š  â”Š10â”Š\n+â”Š  â”Š11â”Šconst inMemoryCache = new InMemoryCache();\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Šexport default new ApolloClient({\n+â”Š  â”Š14â”Š  link: httpLink,\n+â”Š  â”Š15â”Š  cache: inMemoryCache,\n+â”Š  â”Š16â”Š});\n```\n\n[}]: #\n\nAlthough the client can be used directly and integrated into any UI framework, it would be the most comfortable to use a wrap around it which is suitable for React.\nFor that we will use a package called [`react-apollo-hooks`](https://www.npmjs.com/package/react-apollo-hooks) which includes a set of [React hooks](https://reactjs.org/docs/hooks-intro.html) that can connect between our Apollo-Client and target React.Component:\n\n    $ yarn add react-apollo-hooks graphql-tag graphql\n\nWith `react-apollo-hooks` we can use the `useQuery()` hook to fetch data from our GraphQL API.\nThe `graphql-tag` package is used to parse the GraphQL string to an [AST](https://en.wikipedia.org/wiki/Abstract_syntax_tree), something which is required when using Apollo Client. Example:\n\n\n```\nimport gql from 'graphql-tag';\nimport { useQuery } from 'react-apollo-hooks';\n\nconst GET_DOGS = gql`\n  {\n    dogs {\n      id\n      breed\n    }\n  }\n`;\n\nconst Dogs = () => {\n  const { data, error, loading } = useQuery(GET_DOGS);\n  if (loading) {\n    return <div>Loading...</div>;\n  };\n  if (error) {\n    return <div>Error! {error.message}</div>;\n  };\n\n  return (\n    <ul>\n      {data.dogs.map(dog => (\n        <li key={dog.id}>{dog.breed}</li>\n      ))}\n    </ul>\n  );\n};\n```\n\n\nThe package requires a small setup so that imported hooks can use our Apollo-Client:\n\n[{]: <helper> (diffStep 7.2 files=\"index\" module=\"client\")\n\n#### Client Step 7.2: Provide Apollo client\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -75,9 +75,7 @@\n â”Š75â”Š75â”Š      content,\n â”Š76â”Š76â”Š    };\n â”Š77â”Š77â”Š\n-â”Š78â”Š  â”Š    console.log(chat.messages);\n-â”Š79â”Š  â”Š\n-â”Š80â”Š  â”Š     setChat({\n+â”Š  â”Š78â”Š    setChat({\n â”Š81â”Š79â”Š      ...chat,\n â”Š82â”Š80â”Š      messages: chat.messages.concat(message),\n â”Š83â”Š81â”Š    });\n```\n\n##### Changed src&#x2F;index.tsx\n```diff\n@@ -1,8 +1,10 @@\n â”Š 1â”Š 1â”Šimport { MuiThemeProvider, createMuiTheme } from '@material-ui/core/styles'\n â”Š 2â”Š 2â”Šimport React from 'react';\n â”Š 3â”Š 3â”Šimport ReactDOM from 'react-dom';\n+â”Š  â”Š 4â”Šimport { ApolloProvider } from 'react-apollo-hooks';\n â”Š 4â”Š 5â”Šimport './index.css';\n â”Š 5â”Š 6â”Šimport App from './App';\n+â”Š  â”Š 7â”Šimport client from './client';\n â”Š 6â”Š 8â”Šimport * as serviceWorker from './serviceWorker';\n â”Š 7â”Š 9â”Š\n â”Š 8â”Š10â”Šconst theme = createMuiTheme({\n```\n```diff\n@@ -17,7 +19,9 @@\n â”Š17â”Š19â”Š\n â”Š18â”Š20â”ŠReactDOM.render(\n â”Š19â”Š21â”Š  <MuiThemeProvider theme={theme}>\n-â”Š20â”Š  â”Š    <App />\n+â”Š  â”Š22â”Š    <ApolloProvider client={client}>\n+â”Š  â”Š23â”Š      <App />\n+â”Š  â”Š24â”Š    </ApolloProvider>\n â”Š21â”Š25â”Š  </MuiThemeProvider>\n â”Š22â”Š26â”Š, document.getElementById('root'));\n```\n\n[}]: #\n\nThe code above uses the [Context/Provider](https://reactjs.org/docs/context.html) API, thus the client is now known globally.\nNow that we can use the `useQuery()` hook, there's no need to use the native Fetch API anymore.\nLet's replace all our Fetch API call instances with a React hook:\n\n[{]: <helper> (diffStep 7.3 files=\"components\" module=\"client\")\n\n#### Client Step 7.3: Replace fetch() calls with Apollo useQuery()\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -1,5 +1,7 @@\n+â”Š â”Š1â”Šimport gql from 'graphql-tag';\n â”Š1â”Š2â”Šimport React from 'react';\n-â”Š2â”Š â”Šimport { useCallback, useMemo, useState } from 'react';\n+â”Š â”Š3â”Šimport { useCallback } from 'react';\n+â”Š â”Š4â”Šimport { useApolloClient, useQuery } from 'react-apollo-hooks';\n â”Š3â”Š5â”Šimport styled from 'styled-components';\n â”Š4â”Š6â”Šimport ChatNavbar from './ChatNavbar';\n â”Š5â”Š7â”Šimport MessageInput from './MessageInput';\n```\n```diff\n@@ -13,7 +15,7 @@\n â”Š13â”Š15â”Š  height: 100vh;\n â”Š14â”Š16â”Š`;\n â”Š15â”Š17â”Š\n-â”Š16â”Š  â”Šconst getChatQuery = `\n+â”Š  â”Š18â”Šconst getChatQuery = gql`\n â”Š17â”Š19â”Š  query GetChat($chatId: ID!) {\n â”Š18â”Š20â”Š    chat(chatId: $chatId) {\n â”Š19â”Š21â”Š      id\n```\n```diff\n@@ -47,24 +49,12 @@\n â”Š47â”Š49â”Š};\n â”Š48â”Š50â”Š\n â”Š49â”Š51â”Štype OptionalChatQueryResult = ChatQueryResult | null;\n-â”Š50â”Š  â”Š\n+â”Š  â”Š52â”Š\n â”Š51â”Š53â”Šconst ChatRoomScreen: React.FC<ChatRoomScreenParams> = ({ history, chatId }) => {\n-â”Š52â”Š  â”Š  const [chat, setChat] = useState<OptionalChatQueryResult>(null);\n-â”Š53â”Š  â”Š\n-â”Š54â”Š  â”Š  useMemo(async () => {\n-â”Š55â”Š  â”Š    const body = await fetch(`${process.env.REACT_APP_SERVER_URL}/graphql`, {\n-â”Š56â”Š  â”Š      method: 'POST',\n-â”Š57â”Š  â”Š      headers: {\n-â”Š58â”Š  â”Š        'Content-Type': 'application/json',\n-â”Š59â”Š  â”Š      },\n-â”Š60â”Š  â”Š      body: JSON.stringify({\n-â”Š61â”Š  â”Š        query: getChatQuery,\n-â”Š62â”Š  â”Š        variables: { chatId },\n-â”Š63â”Š  â”Š      }),\n-â”Š64â”Š  â”Š    });\n-â”Š65â”Š  â”Š    const { data: { chat } } = await body.json();\n-â”Š66â”Š  â”Š    setChat(chat);\n-â”Š67â”Š  â”Š  }, [chatId]);\n+â”Š  â”Š54â”Š  const client = useApolloClient();\n+â”Š  â”Š55â”Š  const { data: { chat } } = useQuery<any>(getChatQuery, {\n+â”Š  â”Š56â”Š    variables: { chatId }\n+â”Š  â”Š57â”Š  });\n â”Š68â”Š58â”Š\n â”Š69â”Š59â”Š  const onSendMessage = useCallback((content: string) => {\n â”Š70â”Š60â”Š    if (!chat) return null;\n```\n```diff\n@@ -73,13 +63,20 @@\n â”Š73â”Š63â”Š      id: (chat.messages.length + 10).toString(),\n â”Š74â”Š64â”Š      createdAt: Date.now(),\n â”Š75â”Š65â”Š      content,\n+â”Š  â”Š66â”Š      __typename: \"Chat\",\n â”Š76â”Š67â”Š    };\n â”Š77â”Š68â”Š\n-â”Š78â”Š  â”Š    setChat({\n-â”Š79â”Š  â”Š      ...chat,\n-â”Š80â”Š  â”Š      messages: chat.messages.concat(message),\n-â”Š81â”Š  â”Š    });\n-â”Š82â”Š  â”Š  }, [chat]);\n+â”Š  â”Š69â”Š    client.writeQuery({\n+â”Š  â”Š70â”Š      query: getChatQuery,\n+â”Š  â”Š71â”Š      variables: { chatId },\n+â”Š  â”Š72â”Š      data: {\n+â”Š  â”Š73â”Š        chat: {\n+â”Š  â”Š74â”Š          ...chat,\n+â”Š  â”Š75â”Š          messages: chat.messages.concat(message),\n+â”Š  â”Š76â”Š        },\n+â”Š  â”Š77â”Š      },\n+â”Š  â”Š78â”Š    })\n+â”Š  â”Š79â”Š  }, [chat, chatId, client]);\n â”Š83â”Š80â”Š\n â”Š84â”Š81â”Š  if (!chat) return null;\n â”Š85â”Š82â”Š\n```\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -2,8 +2,10 @@\n â”Š 2â”Š 2â”Šimport moment from 'moment';\n â”Š 3â”Š 3â”Šimport { List, ListItem } from '@material-ui/core';\n â”Š 4â”Š 4â”Šimport styled from 'styled-components';\n-â”Š 5â”Š  â”Šimport { useCallback, useState, useMemo } from 'react';\n+â”Š  â”Š 5â”Šimport { useCallback } from 'react';\n â”Š 6â”Š 6â”Šimport { History } from 'history';\n+â”Š  â”Š 7â”Šimport gql from 'graphql-tag';\n+â”Š  â”Š 8â”Šimport { useQuery } from 'react-apollo-hooks';\n â”Š 7â”Š 9â”Š\n â”Š 8â”Š10â”Šconst Container = styled.div `\n â”Š 9â”Š11â”Š  height: calc(100% - 56px);\n```\n```diff\n@@ -57,7 +59,7 @@\n â”Š57â”Š59â”Š  font-size: 13px;\n â”Š58â”Š60â”Š`;\n â”Š59â”Š61â”Š\n-â”Š60â”Š  â”Šconst getChatsQuery = `\n+â”Š  â”Š62â”Šconst getChatsQuery = gql`\n â”Š61â”Š63â”Š  query GetChats {\n â”Š62â”Š64â”Š    chats {\n â”Š63â”Š65â”Š      id\n```\n```diff\n@@ -77,19 +79,7 @@\n â”Š77â”Š79â”Š};\n â”Š78â”Š80â”Š\n â”Š79â”Š81â”Šconst ChatsList: React.FC<ChatsListProps> = ({ history }) => {\n-â”Š80â”Š  â”Š  const [chats, setChats] = useState<any[]>([]);\n-â”Š81â”Š  â”Š\n-â”Š82â”Š  â”Š  useMemo(async () => {\n-â”Š83â”Š  â”Š    const body = await fetch(`${process.env.REACT_APP_SERVER_URL}/graphql`, {\n-â”Š84â”Š  â”Š      method: 'POST',\n-â”Š85â”Š  â”Š      headers: {\n-â”Š86â”Š  â”Š        'Content-Type': 'application/json',\n-â”Š87â”Š  â”Š      },\n-â”Š88â”Š  â”Š      body: JSON.stringify({ query: getChatsQuery }),\n-â”Š89â”Š  â”Š    });\n-â”Š90â”Š  â”Š    const { data: { chats } } = await body.json();\n-â”Š91â”Š  â”Š    setChats(chats);\n-â”Š92â”Š  â”Š  }, []);\n+â”Š  â”Š82â”Š  const { data: { chats = [] } } = useQuery<any>(getChatsQuery);\n â”Š93â”Š83â”Š\n â”Š94â”Š84â”Š  const navToChat = useCallback((chat) => {\n â”Š95â”Š85â”Š    history.push(`chats/${chat.id}`)\n```\n```diff\n@@ -98,7 +88,7 @@\n â”Š 98â”Š 88â”Š  return (\n â”Š 99â”Š 89â”Š    <Container>\n â”Š100â”Š 90â”Š      <StyledList>\n-â”Š101â”Š   â”Š        {chats.map((chat) => (\n+â”Š   â”Š 91â”Š        {chats.map((chat: any) => (\n â”Š102â”Š 92â”Š          <StyledListItem key={chat.id} data-testid=\"chat\" button onClick={navToChat.bind(null, chat)}>\n â”Š103â”Š 93â”Š            <ChatPicture data-testid=\"picture\" src={chat.picture} alt=\"Profile\"/>\n â”Š104â”Š 94â”Š            <ChatInfo>\n```\n\n[}]: #\n\nYou can see that we've fetched the query using Apollo client, and we removed the `setChat` call because Apollo will know automatically to place the results in the cache.\n\nAnd you can see we can also work directly with the cache.\n\nOn the `OnSendMessage` function we take the new message and push it to Apollo Client's cache.\n\nNow if we'll scroll to another screen and come back, the messages will still be displayed there.\n\nYou can see that we've added the `__typename` when we push a new chat to the cache.\nThat's how Apollo Client knows where to place the results.\n\nThe replacement is finished. Note that we removed the usage of `useMemo()` - because Apollo has an internal cache mechanism, there's no need to memoize the result anymore.\nWe also used the [`writeQuery()`](https://www.apollographql.com/docs/react/features/caching.html#writequery-and-writefragment) method to edit the stored result in the cache, so in the next render phase we would have an updated chat with the newly added message.\n\nWe shouldn't see any change at all in the view and the response time, since we're running it locally, but if we will take a look at the `network` tab in the browser's dev-tools we should notice the differences:\n\n**before**\n\n![fetch](https://user-images.githubusercontent.com/7648874/54871305-e5879780-4dec-11e9-87bb-3279e9e18342.png)\n\n**after**\n\n![apollo](https://user-images.githubusercontent.com/7648874/54871319-1bc51700-4ded-11e9-9001-d5518bedf9ad.png)\n\n> Above: ChatsListScreen -> ChatRoomScreen -> ChatsListScreen -> ChatRoomScreen\n\nThis test is obviously very rough, but the deviation is so big that you don't need any accuracy to emphasize the difference.\nThe blue stripes represents the requests made and the time they took. Before we had about 6 request phases, while after we had only 3 of them.\n\nSince we don't use the Fetch API anymore, we will also need to update our tests.\nRight now we mock the response from the fetch API, but a more appropriate way would be creating a fake Apollo Client where we will be able to mock the results.\nFor that we will install a package called [`apollo-link-mock`](https://www.npmjs.com/package/apollo-link-mock):\n\n    $ yarn add --dev apollo-link-mock\n\nAnd we will create a `test-helpers.ts` file under the `src` directory that will contain the utility function for creating a fake Apollo Client:\n\n[{]: <helper> (diffStep 7.4 files=\"test-helpers\" module=\"client\")\n\n#### Client Step 7.4: Mock Apollo requests in tests\n\n##### Added src&#x2F;test-helpers.ts\n```diff\n@@ -0,0 +1,10 @@\n+â”Š  â”Š 1â”Šimport { InMemoryCache } from 'apollo-cache-inmemory';\n+â”Š  â”Š 2â”Šimport { ApolloClient } from 'apollo-client';\n+â”Š  â”Š 3â”Šimport { MockLink } from 'apollo-link-mock';\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šexport const mockApolloClient = (mocks: any) => {\n+â”Š  â”Š 6â”Š  return new ApolloClient({\n+â”Š  â”Š 7â”Š    cache: new InMemoryCache(),\n+â”Š  â”Š 8â”Š    link: new MockLink(mocks),\n+â”Š  â”Š 9â”Š  });\n+â”Š  â”Š10â”Š};\n```\n\n[}]: #\n\nThe fake client accepts an array of mocks where each mock object will have a `request` key that will contain details about the request and a `result` key which will contain the mocked result.\nYou should get a better understanding of how it works now that we will replace the fake Fetch calls with fake Apollo Clients:\n\n[{]: <helper> (diffStep 7.4 files=\"src/components\" module=\"client\")\n\n#### Client Step 7.4: Mock Apollo requests in tests\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.test.tsx\n```diff\n@@ -1,8 +1,10 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n+â”Š  â”Š 2â”Šimport { ApolloProvider } from 'react-apollo-hooks';\n â”Š 2â”Š 3â”Šimport ReactDOM from 'react-dom';\n â”Š 3â”Š 4â”Šimport { cleanup, render, fireEvent, wait, waitForDomChange } from 'react-testing-library';\n-â”Š 4â”Š  â”Šimport ChatsList from './ChatsList';\n â”Š 5â”Š 5â”Šimport { createBrowserHistory } from 'history';\n+â”Š  â”Š 6â”Šimport { mockApolloClient } from '../../test-helpers';\n+â”Š  â”Š 7â”Šimport ChatsList, { getChatsQuery } from './ChatsList';\n â”Š 6â”Š 8â”Š\n â”Š 7â”Š 9â”Šdescribe('ChatsList', () => {\n â”Š 8â”Š10â”Š  afterEach(() => {\n```\n```diff\n@@ -11,25 +13,36 @@\n â”Š11â”Š13â”Š  });\n â”Š12â”Š14â”Š\n â”Š13â”Š15â”Š  it('renders fetched chats data', async () => {\n-â”Š14â”Š  â”Š    fetch.mockResponseOnce(JSON.stringify({\n-â”Š15â”Š  â”Š      data: {\n-â”Š16â”Š  â”Š        chats: [\n-â”Š17â”Š  â”Š          {\n-â”Š18â”Š  â”Š            id: 1,\n-â”Š19â”Š  â”Š            name: 'Foo Bar',\n-â”Š20â”Š  â”Š            picture: 'https://localhost:4000/picture.jpg',\n-â”Š21â”Š  â”Š            lastMessage: {\n-â”Š22â”Š  â”Š              id: 1,\n-â”Š23â”Š  â”Š              content: 'Hello',\n-â”Š24â”Š  â”Š              createdAt: new Date('14 Jun 2017 00:00:00 PDT').toUTCString(),\n-â”Š25â”Š  â”Š            },\n+â”Š  â”Š16â”Š    const client = mockApolloClient([\n+â”Š  â”Š17â”Š      {\n+â”Š  â”Š18â”Š        request: { query: getChatsQuery },\n+â”Š  â”Š19â”Š        result: {\n+â”Š  â”Š20â”Š          data: {\n+â”Š  â”Š21â”Š            chats: [\n+â”Š  â”Š22â”Š              {\n+â”Š  â”Š23â”Š                __typename: 'Chat',\n+â”Š  â”Š24â”Š                id: 1,\n+â”Š  â”Š25â”Š                name: 'Foo Bar',\n+â”Š  â”Š26â”Š                picture: 'https://localhost:4000/picture.jpg',\n+â”Š  â”Š27â”Š                lastMessage: {\n+â”Š  â”Š28â”Š                  __typename: 'Message',\n+â”Š  â”Š29â”Š                  id: 1,\n+â”Š  â”Š30â”Š                  content: 'Hello',\n+â”Š  â”Š31â”Š                  createdAt: new Date('14 Jun 2017 00:00:00 PDT').toUTCString(),\n+â”Š  â”Š32â”Š                },\n+â”Š  â”Š33â”Š              },\n+â”Š  â”Š34â”Š            ],\n â”Š26â”Š35â”Š          },\n-â”Š27â”Š  â”Š        ],\n+â”Š  â”Š36â”Š        },\n â”Š28â”Š37â”Š      },\n-â”Š29â”Š  â”Š    }));\n+â”Š  â”Š38â”Š    ]);\n â”Š30â”Š39â”Š\n â”Š31â”Š40â”Š    {\n-â”Š32â”Š  â”Š      const { container, getByTestId } = render(<ChatsList />);\n+â”Š  â”Š41â”Š      const { container, getByTestId } = render(\n+â”Š  â”Š42â”Š        <ApolloProvider client={client}>\n+â”Š  â”Š43â”Š          <ChatsList />\n+â”Š  â”Š44â”Š        </ApolloProvider>\n+â”Š  â”Š45â”Š      );\n â”Š33â”Š46â”Š\n â”Š34â”Š47â”Š      await waitForDomChange({ container });\n â”Š35â”Š48â”Š\n```\n```diff\n@@ -41,27 +54,38 @@\n â”Š41â”Š54â”Š  });\n â”Š42â”Š55â”Š\n â”Š43â”Š56â”Š  it('should navigate to the target chat room on chat item click', async () => {\n-â”Š44â”Š  â”Š    fetch.mockResponseOnce(JSON.stringify({\n-â”Š45â”Š  â”Š      data: {\n-â”Š46â”Š  â”Š        chats: [\n-â”Š47â”Š  â”Š          {\n-â”Š48â”Š  â”Š            id: 1,\n-â”Š49â”Š  â”Š            name: 'Foo Bar',\n-â”Š50â”Š  â”Š            picture: 'https://localhost:4000/picture.jpg',\n-â”Š51â”Š  â”Š            lastMessage: {\n-â”Š52â”Š  â”Š              id: 1,\n-â”Š53â”Š  â”Š              content: 'Hello',\n-â”Š54â”Š  â”Š              createdAt: new Date(0),\n-â”Š55â”Š  â”Š            },\n+â”Š  â”Š57â”Š    const client = mockApolloClient([\n+â”Š  â”Š58â”Š      {\n+â”Š  â”Š59â”Š        request: { query: getChatsQuery },\n+â”Š  â”Š60â”Š        result: {\n+â”Š  â”Š61â”Š          data: {\n+â”Š  â”Š62â”Š            chats: [\n+â”Š  â”Š63â”Š              {\n+â”Š  â”Š64â”Š                __typename: 'Chat',\n+â”Š  â”Š65â”Š                id: 1,\n+â”Š  â”Š66â”Š                name: 'Foo Bar',\n+â”Š  â”Š67â”Š                picture: 'https://localhost:4000/picture.jpg',\n+â”Š  â”Š68â”Š                lastMessage: {\n+â”Š  â”Š69â”Š                  __typename: 'Message',\n+â”Š  â”Š70â”Š                  id: 1,\n+â”Š  â”Š71â”Š                  content: 'Hello',\n+â”Š  â”Š72â”Š                  createdAt: new Date(0),\n+â”Š  â”Š73â”Š                },\n+â”Š  â”Š74â”Š              },\n+â”Š  â”Š75â”Š            ],\n â”Š56â”Š76â”Š          },\n-â”Š57â”Š  â”Š        ],\n+â”Š  â”Š77â”Š        },\n â”Š58â”Š78â”Š      },\n-â”Š59â”Š  â”Š    }));\n+â”Š  â”Š79â”Š    ]);\n â”Š60â”Š80â”Š\n â”Š61â”Š81â”Š     const history = createBrowserHistory();\n â”Š62â”Š82â”Š\n-â”Š63â”Š  â”Š     {\n-â”Š64â”Š  â”Š      const { container, getByTestId } = render(<ChatsList history={history} />);\n+â”Š  â”Š83â”Š    {\n+â”Š  â”Š84â”Š      const { container, getByTestId } = render(\n+â”Š  â”Š85â”Š        <ApolloProvider client={client}>\n+â”Š  â”Š86â”Š          <ChatsList history={history} />\n+â”Š  â”Š87â”Š        </ApolloProvider>\n+â”Š  â”Š88â”Š      );\n â”Š65â”Š89â”Š\n â”Š66â”Š90â”Š       await waitForDomChange({ container });\n â”Š67â”Š91â”Š\n```\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -59,7 +59,7 @@\n â”Š59â”Š59â”Š  font-size: 13px;\n â”Š60â”Š60â”Š`;\n â”Š61â”Š61â”Š\n-â”Š62â”Š  â”Šconst getChatsQuery = gql`\n+â”Š  â”Š62â”Šexport const getChatsQuery = gql`\n â”Š63â”Š63â”Š  query GetChats {\n â”Š64â”Š64â”Š    chats {\n â”Š65â”Š65â”Š      id\n```\n\n[}]: #\n\nWe are telling Apollo mock to give a certain result each time it gets a specific query.\n\nNote how we used the `ApolloProvider` component to provide the target component with the fake Apollo Client.\nLike so, any other component which uses Apollo Client should be wrapped with an ApolloProvider when rendering it, otherwise it will not function as intended:\n\n[{]: <helper> (diffStep 7.4 files=\"src/App\" module=\"client\")\n\n#### Client Step 7.4: Mock Apollo requests in tests\n\n##### Changed src&#x2F;App.test.tsx\n```diff\n@@ -1,9 +1,17 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n+â”Š  â”Š 2â”Šimport { ApolloProvider } from 'react-apollo-hooks';\n â”Š 2â”Š 3â”Šimport ReactDOM from 'react-dom';\n â”Š 3â”Š 4â”Šimport App from './App';\n+â”Š  â”Š 5â”Šimport { mockApolloClient } from './test-helpers';\n â”Š 4â”Š 6â”Š\n â”Š 5â”Š 7â”Šit('renders without crashing', () => {\n+â”Š  â”Š 8â”Š  const client = mockApolloClient();\n â”Š 6â”Š 9â”Š  const div = document.createElement('div');\n-â”Š 7â”Š  â”Š  ReactDOM.render(<App />, div);\n+â”Š  â”Š10â”Š\n+â”Š  â”Š11â”Š  ReactDOM.render(\n+â”Š  â”Š12â”Š    <ApolloProvider client={client}>\n+â”Š  â”Š13â”Š      <App />\n+â”Š  â”Š14â”Š    </ApolloProvider>\n+â”Š  â”Š15â”Š  , div);\n â”Š 8â”Š16â”Š  ReactDOM.unmountComponentAtNode(div);\n â”Š 9â”Š17â”Š});\n```\n\n[}]: #\n\nThat's it for this chapter. There's one thing missing to make our `ChatRoomScreen` functional and that would be actually sending a message to the backend and updating the DB. In the next chapter we will learn how to do exactly that with our new Apollo-Client.\n\n\n--------------------\n\nTODO: Change the whole intro.\n\nTODO: I think we might want to explain the cache in more details\nhow itâ€™s normalized\nhow some parts update automatically and some do not\nwhatâ€™s the smallest unit stored in the cache\nand other stuff\nthis might help later on with optimistic responses and mutations in general\n\nTODO: Remove all label code\n\nTODO: Create a drawing of the cache.\nTODO: Change typename from Chat to Message\n\nTODO: Explain a bit about Apollo links."
          },
          {
            "manualTitle": "Step 8: Sending messages with GraphQL mutations",
            "stepRevision": "512e9ff8b40162a08642c8d4a888429f7e24ecf1",
            "manualView": "The view and the functionality for updating the component's state when sending a message already exists.\nThe thing is that messages are not really being sent, we only update the memory in the client.\n\nIf so, how exactly can we send messages and store them in the DB? For this purpose we're gonna learn about GraphQL mutations -\na method for sending and applying mutations in our back-end.\n\n**What are GraphQL mutations?**\n\nIf you have an API endpoint that alters data, like inserting data into a database or altering data already in a database,\nyou should make this endpoint a `Mutation` rather than a `Query`.\nThis is as simple as making the API endpoint part of the top-level `Mutation` type instead of the top-level `Query` type.\n\nIt's often convenient to have a mutation that maps to a database create or update operation, return the same thing that the server stored.\nThat way, if you modify the data on the server, the client can learn about those modifications.\n**A GraphQL mutation is like a GraphQL query, only with side effects**.\nIt's equivalent to GET (query) and POST/PUT (mutation) in the context of REST API.\n\nBelow is a sample GraphQL mutation request:\n\n```graphql\nmutation AddMessage($chatId: ID!) {\n  addMessage(chatId: $chatId) {\n    id\n    contents\n    createdAt\n  }\n}\n```\n\n**How to implement a GraphQL mutation?**\n\nSince GraphQL is schema based, we will need to create a new type called `Mutation` in the `typeDefs.graphql` file.\nIn this chapter we want to have the ability to send messages, thus we will have a field named `addMessage` in the new mutation type:\n\n[{]: <helper> (diffStep 5.1 files=\"typeDefs\" module=\"server\")\n\n#### [Server Step 5.1: Add addMessage() mutation](https://github.com/Urigo/WhatsApp-Clone-Server/commit/5b54877)\n\n##### Changed schema&#x2F;typeDefs.graphql\n```diff\n@@ -18,3 +18,7 @@\n â”Š18â”Š18â”Š  chats: [Chat!]!\n â”Š19â”Š19â”Š  chat(chatId: ID!): Chat\n â”Š20â”Š20â”Š}\n+â”Š  â”Š21â”Š\n+â”Š  â”Š22â”Štype Mutation {\n+â”Š  â”Š23â”Š  addMessage(chatId: ID!, content: String!): Message\n+â”Š  â”Š24â”Š}\n```\n\n[}]: #\n\nNote that our mutation resolver `addMessage` receives a `chatId`. This is because when adding a message, we should update both the messages collection, and the correlated chat document. Mutations are resolved exactly like any other type in our resolvers manifest. The new resolver should look like this:\n\n[{]: <helper> (diffStep 5.1 files=\"resolvers\" module=\"server\")\n\n#### [Server Step 5.1: Add addMessage() mutation](https://github.com/Urigo/WhatsApp-Clone-Server/commit/5b54877)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -25,6 +25,31 @@\n â”Š25â”Š25â”Š      return chats.find(c => c.id === chatId)\n â”Š26â”Š26â”Š    },\n â”Š27â”Š27â”Š  },\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š  Mutation: {\n+â”Š  â”Š30â”Š    addMessage(root: any, { chatId, content }: any) {\n+â”Š  â”Š31â”Š      const chatIndex = chats.findIndex(c => c.id === chatId)\n+â”Š  â”Š32â”Š\n+â”Š  â”Š33â”Š      if (chatIndex === -1) return null\n+â”Š  â”Š34â”Š\n+â”Š  â”Š35â”Š      const chat = chats[chatIndex]\n+â”Š  â”Š36â”Š      const lastMessageId = chat.messages[chat.messages.length - 1]\n+â”Š  â”Š37â”Š      const messageId = String(Number(lastMessageId) + 1)\n+â”Š  â”Š38â”Š      const message = {\n+â”Š  â”Š39â”Š        id: messageId,\n+â”Š  â”Š40â”Š        createdAt: new Date(),\n+â”Š  â”Š41â”Š        content,\n+â”Š  â”Š42â”Š      }\n+â”Š  â”Š43â”Š\n+â”Š  â”Š44â”Š      messages.push(message)\n+â”Š  â”Š45â”Š      chat.messages.push(messageId)\n+â”Š  â”Š46â”Š      // The chat will appear at the top of the ChatsList component\n+â”Š  â”Š47â”Š      chats.splice(chatIndex, 1)\n+â”Š  â”Š48â”Š      chats.unshift(chat)\n+â”Š  â”Š49â”Š\n+â”Š  â”Š50â”Š      return message\n+â”Š  â”Š51â”Š    }\n+â”Š  â”Š52â”Š  }\n â”Š28â”Š53â”Š}\n â”Š29â”Š54â”Š\n â”Š30â”Š55â”Šexport default resolvers\n```\n\n[}]: #\n\nIn terms of testing, we will use a temporary solution for now to reset the DB each time we test a mutation. Since we make a modification in the DB, we need to make sure that each test is completely agnostic and doesn't affect one another, thus, we will export a `resetDB()` method from our `db.ts` module:\n\n[{]: <helper> (diffStep 5.2 files=\"db.ts\" module=\"server\")\n\n#### [Server Step 5.2: Test addMessage() mutation](https://github.com/Urigo/WhatsApp-Clone-Server/commit/78b7349)\n\n##### Changed db.ts\n```diff\n@@ -1,49 +1,69 @@\n-â”Š 1â”Š  â”Šexport const messages = [\n-â”Š 2â”Š  â”Š  {\n-â”Š 3â”Š  â”Š    id: '1',\n-â”Š 4â”Š  â”Š    content: \"You on your way?\",\n-â”Š 5â”Š  â”Š    createdAt: new Date(new Date('1-1-2019').getTime() - 60 * 1000 * 1000),\n-â”Š 6â”Š  â”Š  },\n-â”Š 7â”Š  â”Š  {\n-â”Š 8â”Š  â”Š    id: '2',\n-â”Š 9â”Š  â”Š    content: \"Hey, it's me\",\n-â”Š10â”Š  â”Š    createdAt: new Date(new Date('1-1-2019').getTime() - 2 * 60 * 1000 * 1000),\n-â”Š11â”Š  â”Š  },\n-â”Š12â”Š  â”Š  {\n-â”Š13â”Š  â”Š    id: '3',\n-â”Š14â”Š  â”Š    content: \"I should buy a boat\",\n-â”Š15â”Š  â”Š    createdAt: new Date(new Date('1-1-2019').getTime() - 24 * 60 * 1000 * 1000),\n-â”Š16â”Š  â”Š  },\n-â”Š17â”Š  â”Š  {\n-â”Š18â”Š  â”Š    id: '4',\n-â”Š19â”Š  â”Š    content: \"This is wicked good ice cream.\",\n-â”Š20â”Š  â”Š    createdAt: new Date(new Date('1-1-2019').getTime() - 14 * 24 * 60 * 1000 * 1000),\n-â”Š21â”Š  â”Š  },\n-â”Š22â”Š  â”Š]\n+â”Š  â”Š 1â”Šexport type Message = {\n+â”Š  â”Š 2â”Š  id: string\n+â”Š  â”Š 3â”Š  content: string\n+â”Š  â”Š 4â”Š  createdAt: Date\n+â”Š  â”Š 5â”Š}\n â”Š23â”Š 6â”Š\n-â”Š24â”Š  â”Šexport const chats = [\n-â”Š25â”Š  â”Š  {\n-â”Š26â”Š  â”Š    id: '1',\n-â”Š27â”Š  â”Š    name: 'Ethan Gonzalez',\n-â”Š28â”Š  â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n-â”Š29â”Š  â”Š    messages: ['1'],\n-â”Š30â”Š  â”Š  },\n-â”Š31â”Š  â”Š  {\n-â”Š32â”Š  â”Š    id: '2',\n-â”Š33â”Š  â”Š    name: 'Bryan Wallace',\n-â”Š34â”Š  â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n-â”Š35â”Š  â”Š    messages: ['2'],\n-â”Š36â”Š  â”Š  },\n-â”Š37â”Š  â”Š  {\n-â”Š38â”Š  â”Š    id: '3',\n-â”Š39â”Š  â”Š    name: 'Avery Stewart',\n-â”Š40â”Š  â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n-â”Š41â”Š  â”Š    messages: ['3'],\n-â”Š42â”Š  â”Š  },\n-â”Š43â”Š  â”Š  {\n-â”Š44â”Š  â”Š    id: '4',\n-â”Š45â”Š  â”Š    name: 'Katie Peterson',\n-â”Š46â”Š  â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n-â”Š47â”Š  â”Š    messages: ['4'],\n-â”Š48â”Š  â”Š  },\n-â”Š49â”Š  â”Š]\n+â”Š  â”Š 7â”Šexport type Chat = {\n+â”Š  â”Š 8â”Š  id: string\n+â”Š  â”Š 9â”Š  name: string\n+â”Š  â”Š10â”Š  picture: string\n+â”Š  â”Š11â”Š  messages: string[]\n+â”Š  â”Š12â”Š}\n+â”Š  â”Š13â”Š\n+â”Š  â”Š14â”Šexport const messages: Message[] = []\n+â”Š  â”Š15â”Šexport const chats: Chat[] = []\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Šexport const resetDb = () => {\n+â”Š  â”Š18â”Š  messages.splice(0, Infinity, ...[\n+â”Š  â”Š19â”Š    {\n+â”Š  â”Š20â”Š      id: '1',\n+â”Š  â”Š21â”Š      content: \"You on your way?\",\n+â”Š  â”Š22â”Š      createdAt: new Date(new Date('1-1-2019').getTime() - 60 * 1000 * 1000),\n+â”Š  â”Š23â”Š    },\n+â”Š  â”Š24â”Š    {\n+â”Š  â”Š25â”Š      id: '2',\n+â”Š  â”Š26â”Š      content: \"Hey, it's me\",\n+â”Š  â”Š27â”Š      createdAt: new Date(new Date('1-1-2019').getTime() - 2 * 60 * 1000 * 1000),\n+â”Š  â”Š28â”Š    },\n+â”Š  â”Š29â”Š    {\n+â”Š  â”Š30â”Š      id: '3',\n+â”Š  â”Š31â”Š      content: \"I should buy a boat\",\n+â”Š  â”Š32â”Š      createdAt: new Date(new Date('1-1-2019').getTime() - 24 * 60 * 1000 * 1000),\n+â”Š  â”Š33â”Š    },\n+â”Š  â”Š34â”Š    {\n+â”Š  â”Š35â”Š      id: '4',\n+â”Š  â”Š36â”Š      content: \"This is wicked good ice cream.\",\n+â”Š  â”Š37â”Š      createdAt: new Date(new Date('1-1-2019').getTime() - 14 * 24 * 60 * 1000 * 1000),\n+â”Š  â”Š38â”Š    },\n+â”Š  â”Š39â”Š  ])\n+â”Š  â”Š40â”Š\n+â”Š  â”Š41â”Š  chats.splice(0, Infinity, ...[\n+â”Š  â”Š42â”Š    {\n+â”Š  â”Š43â”Š      id: '1',\n+â”Š  â”Š44â”Š      name: 'Ethan Gonzalez',\n+â”Š  â”Š45â”Š      picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n+â”Š  â”Š46â”Š      messages: ['1'],\n+â”Š  â”Š47â”Š    },\n+â”Š  â”Š48â”Š    {\n+â”Š  â”Š49â”Š      id: '2',\n+â”Š  â”Š50â”Š      name: 'Bryan Wallace',\n+â”Š  â”Š51â”Š      picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n+â”Š  â”Š52â”Š      messages: ['2'],\n+â”Š  â”Š53â”Š    },\n+â”Š  â”Š54â”Š    {\n+â”Š  â”Š55â”Š      id: '3',\n+â”Š  â”Š56â”Š      name: 'Avery Stewart',\n+â”Š  â”Š57â”Š      picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n+â”Š  â”Š58â”Š      messages: ['3'],\n+â”Š  â”Š59â”Š    },\n+â”Š  â”Š60â”Š    {\n+â”Š  â”Š61â”Š      id: '4',\n+â”Š  â”Š62â”Š      name: 'Katie Peterson',\n+â”Š  â”Š63â”Š      picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n+â”Š  â”Š64â”Š      messages: ['4'],\n+â”Š  â”Š65â”Š    },\n+â”Š  â”Š66â”Š  ])\n+â”Š  â”Š67â”Š}\n+â”Š  â”Š68â”Š\n+â”Š  â”Š69â”ŠresetDb()\n```\n\n[}]: #\n\nAnd we will use the `beforeEach()` test hook to reset the `chats` and `messages` collections:\n\n[{]: <helper> (diffStep 5.2 files=\"tests\" module=\"server\")\n\n#### [Server Step 5.2: Test addMessage() mutation](https://github.com/Urigo/WhatsApp-Clone-Server/commit/78b7349)\n\n##### Added tests&#x2F;mutations&#x2F;\\__snapshots__&#x2F;addMessage.test.ts.snap\n```diff\n@@ -0,0 +1,22 @@\n+â”Š  â”Š 1â”Š// Jest Snapshot v1, https://goo.gl/fbAQLP\n+â”Š  â”Š 2â”Š\n+â”Š  â”Š 3â”Šexports[`Mutation.addMessage should add message to specified chat 1`] = `\n+â”Š  â”Š 4â”ŠObject {\n+â”Š  â”Š 5â”Š  \"addMessage\": Object {\n+â”Š  â”Š 6â”Š    \"content\": \"Hello World\",\n+â”Š  â”Š 7â”Š    \"id\": \"5\",\n+â”Š  â”Š 8â”Š  },\n+â”Š  â”Š 9â”Š}\n+â”Š  â”Š10â”Š`;\n+â”Š  â”Š11â”Š\n+â”Š  â”Š12â”Šexports[`Mutation.addMessage should add message to specified chat 2`] = `\n+â”Š  â”Š13â”ŠObject {\n+â”Š  â”Š14â”Š  \"chat\": Object {\n+â”Š  â”Š15â”Š    \"id\": \"1\",\n+â”Š  â”Š16â”Š    \"lastMessage\": Object {\n+â”Š  â”Š17â”Š      \"content\": \"Hello World\",\n+â”Š  â”Š18â”Š      \"id\": \"5\",\n+â”Š  â”Š19â”Š    },\n+â”Š  â”Š20â”Š  },\n+â”Š  â”Š21â”Š}\n+â”Š  â”Š22â”Š`;\n```\n\n##### Added tests&#x2F;mutations&#x2F;addMessage.test.ts\n```diff\n@@ -0,0 +1,49 @@\n+â”Š  â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing'\n+â”Š  â”Š 2â”Šimport { ApolloServer, gql } from 'apollo-server-express'\n+â”Š  â”Š 3â”Šimport schema from '../../schema'\n+â”Š  â”Š 4â”Šimport { resetDb } from '../../db'\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šdescribe('Mutation.addMessage', () => {\n+â”Š  â”Š 7â”Š  beforeEach(resetDb)\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Š  it('should add message to specified chat', async () => {\n+â”Š  â”Š10â”Š    const server = new ApolloServer({ schema })\n+â”Š  â”Š11â”Š\n+â”Š  â”Š12â”Š    const { query, mutate } = createTestClient(server)\n+â”Š  â”Š13â”Š\n+â”Š  â”Š14â”Š    const addMessageRes = await mutate({\n+â”Š  â”Š15â”Š      variables: { chatId: '1', content: 'Hello World' },\n+â”Š  â”Š16â”Š      mutation: gql `\n+â”Š  â”Š17â”Š        mutation AddMessage($chatId: ID!, $content: String!) {\n+â”Š  â”Š18â”Š          addMessage(chatId: $chatId, content: $content) {\n+â”Š  â”Š19â”Š            id\n+â”Š  â”Š20â”Š            content\n+â”Š  â”Š21â”Š          }\n+â”Š  â”Š22â”Š        }\n+â”Š  â”Š23â”Š      `,\n+â”Š  â”Š24â”Š    })\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Š    expect(addMessageRes.data).toBeDefined()\n+â”Š  â”Š27â”Š    expect(addMessageRes.errors).toBeUndefined()\n+â”Š  â”Š28â”Š    expect(addMessageRes.data).toMatchSnapshot()\n+â”Š  â”Š29â”Š\n+â”Š  â”Š30â”Š    const getChatRes = await query({\n+â”Š  â”Š31â”Š      variables: { chatId: '1' },\n+â”Š  â”Š32â”Š      query: gql `\n+â”Š  â”Š33â”Š        query GetChat($chatId: ID!) {\n+â”Š  â”Š34â”Š          chat(chatId: $chatId) {\n+â”Š  â”Š35â”Š            id\n+â”Š  â”Š36â”Š            lastMessage {\n+â”Š  â”Š37â”Š              id\n+â”Š  â”Š38â”Š              content\n+â”Š  â”Š39â”Š            }\n+â”Š  â”Š40â”Š          }\n+â”Š  â”Š41â”Š        }\n+â”Š  â”Š42â”Š      `,\n+â”Š  â”Š43â”Š    })\n+â”Š  â”Š44â”Š\n+â”Š  â”Š45â”Š    expect(getChatRes.data).toBeDefined()\n+â”Š  â”Š46â”Š    expect(getChatRes.errors).toBeUndefined()\n+â”Š  â”Š47â”Š    expect(getChatRes.data).toMatchSnapshot()\n+â”Š  â”Š48â”Š  })\n+â”Š  â”Š49â”Š})\n```\n\n[}]: #\n\nNow we have the infrastructure set for sending a new message and we can start using it in our client.\n\n**How to use a GraphQL mutation?**\n\nLike in the previous chapters, we're gonna use a React hook so we can run a mutation more efficiently in a React.Component.\nFor this we're gonna use the [`useMutation()`](https://github.com/trojanowski/react-apollo-hooks#usemutation) react hook.\nThe first argument of the hook is the mutation string, and the second one is the [mutation options](https://www.apollographql.com/docs/react/api/apollo-client.html#ApolloClient.mutate).\nWe're gonna provide our mutation call with a single option called `optimisticResponse`.\n\nOptimistic response is a common pattern that will update the state of the component twice so we can have a better UX: First it updates the component's state with the predicted result,\nand then it will update the state with the actual result.\n\n\n\n![optimistic_response](https://user-images.githubusercontent.com/7648874/54883302-859df900-4e9f-11e9-9eb7-a98108cd2482.png)\n\n\nThis is how the component should look like:\n\n[{]: <helper> (diffStep 8.1 module=\"client\")\n\n#### Client Step 8.1: Send message with a GraphQL mutation\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -1,7 +1,7 @@\n â”Š1â”Š1â”Šimport gql from 'graphql-tag';\n â”Š2â”Š2â”Šimport React from 'react';\n â”Š3â”Š3â”Šimport { useCallback } from 'react';\n-â”Š4â”Š â”Šimport { useApolloClient, useQuery } from 'react-apollo-hooks';\n+â”Š â”Š4â”Šimport { useQuery, useMutation } from 'react-apollo-hooks';\n â”Š5â”Š5â”Šimport styled from 'styled-components';\n â”Š6â”Š6â”Šimport ChatNavbar from './ChatNavbar';\n â”Š7â”Š7â”Šimport MessageInput from './MessageInput';\n```\n```diff\n@@ -30,6 +30,16 @@\n â”Š30â”Š30â”Š  }\n â”Š31â”Š31â”Š`;\n â”Š32â”Š32â”Š\n+â”Š  â”Š33â”Šconst addMessageMutation = gql `\n+â”Š  â”Š34â”Š  mutation AddMessage($chatId: ID!, $content: String!) {\n+â”Š  â”Š35â”Š    addMessage(chatId: $chatId, content: $content) {\n+â”Š  â”Š36â”Š      id\n+â”Š  â”Š37â”Š      content\n+â”Š  â”Š38â”Š      createdAt\n+â”Š  â”Š39â”Š    }\n+â”Š  â”Š40â”Š  }\n+â”Š  â”Š41â”Š`;\n+â”Š  â”Š42â”Š\n â”Š33â”Š43â”Šinterface ChatRoomScreenParams {\n â”Š34â”Š44â”Š  chatId: string\n â”Š35â”Š45â”Š  history: History;\n```\n```diff\n@@ -51,32 +61,37 @@\n â”Š51â”Š61â”Štype OptionalChatQueryResult = ChatQueryResult | null;\n â”Š52â”Š62â”Š\n â”Š53â”Š63â”Šconst ChatRoomScreen: React.FC<ChatRoomScreenParams> = ({ history, chatId }) => {\n-â”Š54â”Š  â”Š  const client = useApolloClient();\n â”Š55â”Š64â”Š  const { data: { chat } } = useQuery<any>(getChatQuery, {\n â”Š56â”Š65â”Š    variables: { chatId }\n â”Š57â”Š66â”Š  });\n+â”Š  â”Š67â”Š  const addMessage = useMutation(addMessageMutation);\n â”Š58â”Š68â”Š\n â”Š59â”Š69â”Š  const onSendMessage = useCallback((content: string) => {\n-â”Š60â”Š  â”Š    if (!chat) return null;\n-â”Š61â”Š  â”Š\n-â”Š62â”Š  â”Š    const message = {\n-â”Š63â”Š  â”Š      id: (chat.messages.length + 10).toString(),\n-â”Š64â”Š  â”Š      createdAt: Date.now(),\n-â”Š65â”Š  â”Š      content,\n-â”Š66â”Š  â”Š      __typename: \"Chat\",\n-â”Š67â”Š  â”Š    };\n-â”Š68â”Š  â”Š\n-â”Š69â”Š  â”Š    client.writeQuery({\n-â”Š70â”Š  â”Š      query: getChatQuery,\n-â”Š71â”Š  â”Š      variables: { chatId },\n-â”Š72â”Š  â”Š      data: {\n-â”Š73â”Š  â”Š        chat: {\n-â”Š74â”Š  â”Š          ...chat,\n-â”Š75â”Š  â”Š          messages: chat.messages.concat(message),\n-â”Š76â”Š  â”Š        },\n+â”Š  â”Š70â”Š    addMessage({\n+â”Š  â”Š71â”Š      variables: { chatId, content },\n+â”Š  â”Š72â”Š      optimisticResponse: {\n+â”Š  â”Š73â”Š        __typename: 'Mutation',\n+â”Š  â”Š74â”Š        addMessage: {\n+â”Š  â”Š75â”Š          __typename: 'Message',\n+â”Š  â”Š76â”Š          id: Math.random().toString(36).substr(2, 9),\n+â”Š  â”Š77â”Š          createdAt: new Date(),\n+â”Š  â”Š78â”Š          content,\n+â”Š  â”Š79â”Š        }\n â”Š77â”Š80â”Š      },\n-â”Š78â”Š  â”Š    })\n-â”Š79â”Š  â”Š  }, [chat, chatId, client]);\n+â”Š  â”Š81â”Š      update: (client, { data: { addMessage } }) => {\n+â”Š  â”Š82â”Š        client.writeQuery({\n+â”Š  â”Š83â”Š          query: getChatQuery,\n+â”Š  â”Š84â”Š          variables: { chatId },\n+â”Š  â”Š85â”Š          data: {\n+â”Š  â”Š86â”Š            chat: {\n+â”Š  â”Š87â”Š              ...chat,\n+â”Š  â”Š88â”Š              messages: chat.messages.concat(addMessage)\n+â”Š  â”Š89â”Š            }\n+â”Š  â”Š90â”Š          }\n+â”Š  â”Š91â”Š        });\n+â”Š  â”Š92â”Š      }\n+â”Š  â”Š93â”Š    });\n+â”Š  â”Š94â”Š  }, [chat, chatId, addMessage]);\n â”Š80â”Š95â”Š\n â”Š81â”Š96â”Š  if (!chat) return null;\n```\n\n[}]: #\n\nNote that unlike `useQuery()`, `useMutation()` returns a callback that will run the mutation only once called, NOT immediately.\nSeemingly, everything works fine, but if you'll try to navigate from `ChatsListScreen` to `ChatRoomScreen`, send a message, and then go back, you'll see that the last message was not updated.\nSo why is that exactly?\n\n**Cache updating**\n\nAs explained in the previous chapter, Apollo-Client will cache all the results in a data-store.\nLater on, rather than re-fetching the data, it will look up for the result in the store and will serve it to you in case it exists.\nThat means, that even though we ran the mutation and updated the data on the server, our data-store is still left behind and it needs to be updated as well,\notherwise Apollo-Client will see nothing wrong with the outcome.\n\nApollo-Client stores the data in a hash, where the key represents the query and the value represents the retrieved result.\nThis means that the cache will need to be updated for:\n\n\n*   `chats` query - which we already did, without really diving into the reason behind it.\n*   `chat(chatId: $chatId)` where `chatId` is the chat that was just mutated.\n\nIndeed, a query will be duplicated for each and every distinct set of parameters.\nSo potentially our data-store can grow infinite amount of times, and we will need to take care of it and manage it correctly, so things won't get out of hand.\n\nTo update a query, we will first export the `getChats` query to a separate file so it can be imported in the `ChatRoomScreen`.\nWe will define all our GraphQL assets under the `src/graphql` directory:\n\n[{]: <helper> (diffStep 8.2 files=\"graphql\" module=\"client\")\n\n#### Client Step 8.2: Rewrite lastMessage to chats query\n\n##### Added src&#x2F;graphql&#x2F;queries&#x2F;chats.query.ts\n```diff\n@@ -0,0 +1,16 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag';\n+â”Š  â”Š 2â”Š\n+â”Š  â”Š 3â”Šexport default gql`\n+â”Š  â”Š 4â”Š  query Chats {\n+â”Š  â”Š 5â”Š    chats {\n+â”Š  â”Š 6â”Š      id\n+â”Š  â”Š 7â”Š      name\n+â”Š  â”Š 8â”Š      picture\n+â”Š  â”Š 9â”Š      lastMessage {\n+â”Š  â”Š10â”Š        id\n+â”Š  â”Š11â”Š        content\n+â”Š  â”Š12â”Š        createdAt\n+â”Š  â”Š13â”Š      }\n+â”Š  â”Š14â”Š    }\n+â”Š  â”Š15â”Š  }\n+â”Š  â”Š16â”Š`;\n```\n\n##### Added src&#x2F;graphql&#x2F;queries&#x2F;index.ts\n```diff\n@@ -0,0 +1 @@\n+â”Š â”Š1â”Šexport { default as chats } from './chats.query';\n```\n\n[}]: #\n\nAnd then we will read the memoized result from the store using [`client.readQuery`](https://www.apollographql.com/docs/react/features/caching.html#readquery),\nupdate it, and then rewrite it using [`client.writeQuery`](https://www.apollographql.com/docs/react/features/caching.html#writequery-and-writefragment).\nWe can gain access to the client object via the `update` callback which will be triggered right after the mutation has been successfully executed.\nThis is how it should look like:\n\n[{]: <helper> (diffStep 8.2 files=\"components\" module=\"client\")\n\n#### Client Step 8.2: Rewrite lastMessage to chats query\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -7,6 +7,7 @@\n â”Š 7â”Š 7â”Šimport MessageInput from './MessageInput';\n â”Š 8â”Š 8â”Šimport MessagesList from './MessagesList';\n â”Š 9â”Š 9â”Šimport { History } from 'history';\n+â”Š  â”Š10â”Šimport * as queries from '../../graphql/queries';\n â”Š10â”Š11â”Š\n â”Š11â”Š12â”Š const Container = styled.div `\n â”Š12â”Š13â”Š  background: url(/assets/chat-background.jpg);\n```\n```diff\n@@ -26,8 +27,8 @@\n â”Š26â”Š27â”Š        content\n â”Š27â”Š28â”Š        createdAt\n â”Š28â”Š29â”Š      }\n-â”Š29â”Š  â”Š    }\n â”Š30â”Š30â”Š  }\n+â”Š  â”Š31â”Š}\n â”Š31â”Š32â”Š`;\n â”Š32â”Š33â”Š\n â”Š33â”Š34â”Šconst addMessageMutation = gql `\n```\n```diff\n@@ -60,6 +61,10 @@\n â”Š60â”Š61â”Š\n â”Š61â”Š62â”Štype OptionalChatQueryResult = ChatQueryResult | null;\n â”Š62â”Š63â”Š\n+â”Š  â”Š64â”Šinterface ChatsResult {\n+â”Š  â”Š65â”Š  chats: any[];\n+â”Š  â”Š66â”Š}\n+â”Š  â”Š67â”Š\n â”Š63â”Š68â”Šconst ChatRoomScreen: React.FC<ChatRoomScreenParams> = ({ history, chatId }) => {\n â”Š64â”Š69â”Š  const { data: { chat } } = useQuery<any>(getChatQuery, {\n â”Š65â”Š70â”Š    variables: { chatId }\n```\n```diff\n@@ -89,6 +94,33 @@\n â”Š 89â”Š 94â”Š            }\n â”Š 90â”Š 95â”Š          }\n â”Š 91â”Š 96â”Š        });\n+â”Š   â”Š 97â”Š\n+â”Š   â”Š 98â”Š        let data;\n+â”Š   â”Š 99â”Š        try {\n+â”Š   â”Š100â”Š          data = client.readQuery<ChatsResult>({\n+â”Š   â”Š101â”Š            query: queries.chats,\n+â”Š   â”Š102â”Š          });\n+â”Š   â”Š103â”Š        } catch (e) {\n+â”Š   â”Š104â”Š          return;\n+â”Š   â”Š105â”Š        }\n+â”Š   â”Š106â”Š\n+â”Š   â”Š107â”Š        if (!data) return;\n+â”Š   â”Š108â”Š        const chats = data.chats;\n+â”Š   â”Š109â”Š        if (!chats) return;\n+â”Š   â”Š110â”Š\n+â”Š   â”Š111â”Š        const chatIndex = chats.findIndex((c:any) => c.id === chatId);\n+â”Š   â”Š112â”Š        if (chatIndex === -1) return;\n+â”Š   â”Š113â”Š        const chatWhereAdded = chats[chatIndex];\n+â”Š   â”Š114â”Š\n+â”Š   â”Š115â”Š        chatWhereAdded.lastMessage = addMessage;\n+â”Š   â”Š116â”Š        // The chat will appear at the top of the ChatsList component\n+â”Š   â”Š117â”Š        chats.splice(chatIndex, 1);\n+â”Š   â”Š118â”Š        chats.unshift(chatWhereAdded);\n+â”Š   â”Š119â”Š\n+â”Š   â”Š120â”Š        client.writeQuery({\n+â”Š   â”Š121â”Š          query: queries.chats,\n+â”Š   â”Š122â”Š          data: { chats: chats },\n+â”Š   â”Š123â”Š        });\n â”Š 92â”Š124â”Š      }\n â”Š 93â”Š125â”Š    });\n â”Š 94â”Š126â”Š  }, [chat, chatId, addMessage]);\n```\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.test.tsx\n```diff\n@@ -5,6 +5,7 @@\n â”Š 5â”Š 5â”Šimport { createBrowserHistory } from 'history';\n â”Š 6â”Š 6â”Šimport { mockApolloClient } from '../../test-helpers';\n â”Š 7â”Š 7â”Šimport ChatsList, { getChatsQuery } from './ChatsList';\n+â”Š  â”Š 8â”Šimport * as queries from '../../graphql/queries';\n â”Š 8â”Š 9â”Š\n â”Š 9â”Š10â”Šdescribe('ChatsList', () => {\n â”Š10â”Š11â”Š  afterEach(() => {\n```\n```diff\n@@ -15,7 +16,7 @@\n â”Š15â”Š16â”Š  it('renders fetched chats data', async () => {\n â”Š16â”Š17â”Š    const client = mockApolloClient([\n â”Š17â”Š18â”Š      {\n-â”Š18â”Š  â”Š        request: { query: getChatsQuery },\n+â”Š  â”Š19â”Š        request: { query: queries.chats },\n â”Š19â”Š20â”Š        result: {\n â”Š20â”Š21â”Š          data: {\n â”Š21â”Š22â”Š            chats: [\n```\n```diff\n@@ -56,7 +57,7 @@\n â”Š56â”Š57â”Š  it('should navigate to the target chat room on chat item click', async () => {\n â”Š57â”Š58â”Š    const client = mockApolloClient([\n â”Š58â”Š59â”Š      {\n-â”Š59â”Š  â”Š        request: { query: getChatsQuery },\n+â”Š  â”Š60â”Š        request: { query: queries.chats },\n â”Š60â”Š61â”Š        result: {\n â”Š61â”Š62â”Š          data: {\n â”Š62â”Š63â”Š            chats: [\n```\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -4,8 +4,8 @@\n â”Š 4â”Š 4â”Šimport styled from 'styled-components';\n â”Š 5â”Š 5â”Šimport { useCallback } from 'react';\n â”Š 6â”Š 6â”Šimport { History } from 'history';\n-â”Š 7â”Š  â”Šimport gql from 'graphql-tag';\n â”Š 8â”Š 7â”Šimport { useQuery } from 'react-apollo-hooks';\n+â”Š  â”Š 8â”Šimport * as queries from '../../graphql/queries';\n â”Š 9â”Š 9â”Š\n â”Š10â”Š10â”Šconst Container = styled.div `\n â”Š11â”Š11â”Š  height: calc(100% - 56px);\n```\n```diff\n@@ -59,27 +59,12 @@\n â”Š59â”Š59â”Š  font-size: 13px;\n â”Š60â”Š60â”Š`;\n â”Š61â”Š61â”Š\n-â”Š62â”Š  â”Šexport const getChatsQuery = gql`\n-â”Š63â”Š  â”Š  query GetChats {\n-â”Š64â”Š  â”Š    chats {\n-â”Š65â”Š  â”Š      id\n-â”Š66â”Š  â”Š      name\n-â”Š67â”Š  â”Š      picture\n-â”Š68â”Š  â”Š      lastMessage {\n-â”Š69â”Š  â”Š        id\n-â”Š70â”Š  â”Š        content\n-â”Š71â”Š  â”Š        createdAt\n-â”Š72â”Š  â”Š      }\n-â”Š73â”Š  â”Š    }\n-â”Š74â”Š  â”Š  }\n-â”Š75â”Š  â”Š`;\n-â”Š76â”Š  â”Š\n â”Š77â”Š62â”Šinterface ChatsListProps {\n â”Š78â”Š63â”Š  history : History;\n â”Š79â”Š64â”Š};\n â”Š80â”Š65â”Š\n â”Š81â”Š66â”Šconst ChatsList: React.FC<ChatsListProps> = ({ history }) => {\n-â”Š82â”Š  â”Š  const { data: { chats = [] } } = useQuery<any>(getChatsQuery);\n+â”Š  â”Š67â”Š  const { data: { chats = [] } } = useQuery<any>(queries.chats);\n â”Š83â”Š68â”Š\n â”Š84â”Š69â”Š  const navToChat = useCallback((chat) => {\n â”Š85â”Š70â”Š    history.push(`chats/${chat.id}`)\n```\n\n[}]: #\n\nRight now what happens is that we update a single chat document twice: Once for the `chats` query and another time for the `chat($chatId)` query.\nThis work is redundant and become more complex as we add more `chat` related queries.\nTo solve it, we can define and use a [GraphQL fragment](https://www.apollographql.com/docs/react/advanced/fragments.html).\n\n**Using Fragments**\n\nA GraphQL fragment is a shared piece of query logic.\n\n```graphql\nfragment NameParts on Person {\n  firstName\n  lastName\n}\n\nquery GetPerson {\n  people(id: \"7\") {\n    ...NameParts\n    avatar(size: LARGE)\n  }\n}\n```\n\nIt's important to note that the component after the `on` clause is designated for the type we are selecting from. In this case, `people` is of type `Person` and we want to select the `firstName` and `lastName` fields from `people(id: \"7\")`.\n\nApollo maps the fragment ID to its retrieved data in the store. By default, Apollo will compose the fragment ID out of the entity type and the ID of the document. For example, for a `Chat` document with an ID of `7`, the fragment ID would be `Chat:7`. This behavior can be modified, but there's no need to.\n\nWe will define the following fragments in our app:\n\n\n\n*   `Message` - represents a message\n*   `Chat` - represents a chat, **without its messages list**.\n*   `FullChat` - represents a chat, **including its messages list**.\n\nOnce we define the fragments we can start embedding them in our queries. We will create a new directory path `src/graphql/fragments`, and inside we will create a dedicated fragment file for each fragment type: `message.fragment.ts`, `chat.fragment.ts` and `fullChat.fragment.ts`:\n\n[{]: <helper> (diffStep 8.3 files=\"graphql/fragments\" module=\"client\")\n\n#### Client Step 8.3: Update queries to use GraphQL fragments\n\n##### Added src&#x2F;graphql&#x2F;fragments&#x2F;chat.fragment.ts\n```diff\n@@ -0,0 +1,14 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag';\n+â”Š  â”Š 2â”Šimport message from './message.fragment';\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šexport default gql`\n+â”Š  â”Š 5â”Š  fragment Chat on Chat {\n+â”Š  â”Š 6â”Š    id\n+â”Š  â”Š 7â”Š    name\n+â”Š  â”Š 8â”Š    picture\n+â”Š  â”Š 9â”Š    lastMessage {\n+â”Š  â”Š10â”Š      ...Message\n+â”Š  â”Š11â”Š    }\n+â”Š  â”Š12â”Š  }\n+â”Š  â”Š13â”Š  ${message}\n+â”Š  â”Š14â”Š`;\n```\n\n##### Added src&#x2F;graphql&#x2F;fragments&#x2F;fullChat.fragment.ts\n```diff\n@@ -0,0 +1,14 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag';\n+â”Š  â”Š 2â”Šimport chat from './chat.fragment';\n+â”Š  â”Š 3â”Šimport message from './message.fragment';\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šexport default gql`\n+â”Š  â”Š 6â”Š  fragment FullChat on Chat {\n+â”Š  â”Š 7â”Š    ...Chat\n+â”Š  â”Š 8â”Š    messages {\n+â”Š  â”Š 9â”Š      ...Message\n+â”Š  â”Š10â”Š    }\n+â”Š  â”Š11â”Š  }\n+â”Š  â”Š12â”Š  ${chat}\n+â”Š  â”Š13â”Š  ${message}\n+â”Š  â”Š14â”Š`;\n```\n\n##### Added src&#x2F;graphql&#x2F;fragments&#x2F;index.ts\n```diff\n@@ -0,0 +1,3 @@\n+â”Š â”Š1â”Šexport { default as chat } from './chat.fragment';\n+â”Š â”Š2â”Šexport { default as fullChat } from './fullChat.fragment';\n+â”Š â”Š3â”Šexport { default as message } from './message.fragment';\n```\n\n##### Added src&#x2F;graphql&#x2F;fragments&#x2F;message.fragment.ts\n```diff\n@@ -0,0 +1,9 @@\n+â”Š â”Š1â”Šimport gql from 'graphql-tag';\n+â”Š â”Š2â”Š\n+â”Š â”Š3â”Šexport default gql`\n+â”Š â”Š4â”Š  fragment Message on Message {\n+â”Š â”Š5â”Š    id\n+â”Š â”Š6â”Š    createdAt\n+â”Š â”Š7â”Š    content\n+â”Š â”Š8â”Š  }\n+â”Š â”Š9â”Š`;\n```\n\n[}]: #\n\nAnd now that we have the fragments available to us, let's embed them in the relevant queries:\n\n[{]: <helper> (diffStep 8.3 files=\"components, graphql/queries\" module=\"client\")\n\n#### Client Step 8.3: Update queries to use GraphQL fragments\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -8,6 +8,7 @@\n â”Š 8â”Š 8â”Šimport MessagesList from './MessagesList';\n â”Š 9â”Š 9â”Šimport { History } from 'history';\n â”Š10â”Š10â”Šimport * as queries from '../../graphql/queries';\n+â”Š  â”Š11â”Šimport * as fragments from '../../graphql/fragments';\n â”Š11â”Š12â”Š\n â”Š12â”Š13â”Š const Container = styled.div `\n â”Š13â”Š14â”Š  background: url(/assets/chat-background.jpg);\n```\n```diff\n@@ -19,26 +20,19 @@\n â”Š19â”Š20â”Šconst getChatQuery = gql`\n â”Š20â”Š21â”Š  query GetChat($chatId: ID!) {\n â”Š21â”Š22â”Š    chat(chatId: $chatId) {\n-â”Š22â”Š  â”Š      id\n-â”Š23â”Š  â”Š      name\n-â”Š24â”Š  â”Š      picture\n-â”Š25â”Š  â”Š      messages {\n-â”Š26â”Š  â”Š        id\n-â”Š27â”Š  â”Š        content\n-â”Š28â”Š  â”Š        createdAt\n-â”Š29â”Š  â”Š      }\n+â”Š  â”Š23â”Š      ...FullChat\n+â”Š  â”Š24â”Š    }\n â”Š30â”Š25â”Š  }\n-â”Š31â”Š  â”Š}\n+â”Š  â”Š26â”Š  ${fragments.fullChat}\n â”Š32â”Š27â”Š`;\n â”Š33â”Š28â”Š\n â”Š34â”Š29â”Šconst addMessageMutation = gql `\n â”Š35â”Š30â”Š  mutation AddMessage($chatId: ID!, $content: String!) {\n â”Š36â”Š31â”Š    addMessage(chatId: $chatId, content: $content) {\n-â”Š37â”Š  â”Š      id\n-â”Š38â”Š  â”Š      content\n-â”Š39â”Š  â”Š      createdAt\n+â”Š  â”Š32â”Š      ...Message\n â”Š40â”Š33â”Š    }\n â”Š41â”Š34â”Š  }\n+â”Š  â”Š35â”Š  ${fragments.message}\n â”Š42â”Š36â”Š`;\n â”Š43â”Š37â”Š\n â”Š44â”Š38â”Šinterface ChatRoomScreenParams {\n```\n\n##### Changed src&#x2F;graphql&#x2F;queries&#x2F;chats.query.ts\n```diff\n@@ -1,16 +1,11 @@\n â”Š 1â”Š 1â”Šimport gql from 'graphql-tag';\n+â”Š  â”Š 2â”Šimport * as fragments from '../fragments';\n â”Š 2â”Š 3â”Š\n â”Š 3â”Š 4â”Šexport default gql`\n â”Š 4â”Š 5â”Š  query Chats {\n â”Š 5â”Š 6â”Š    chats {\n-â”Š 6â”Š  â”Š      id\n-â”Š 7â”Š  â”Š      name\n-â”Š 8â”Š  â”Š      picture\n-â”Š 9â”Š  â”Š      lastMessage {\n-â”Š10â”Š  â”Š        id\n-â”Š11â”Š  â”Š        content\n-â”Š12â”Š  â”Š        createdAt\n-â”Š13â”Š  â”Š      }\n+â”Š  â”Š 7â”Š      ...Chat\n â”Š14â”Š 8â”Š    }\n â”Š15â”Š 9â”Š  }\n+â”Š  â”Š10â”Š  ${fragments.chat}\n â”Š16â”Š11â”Š`;\n```\n\n[}]: #\n\nSimilarly to query rewriting, we will use the [`readFragment()`](https://www.apollographql.com/docs/react/features/caching.html#readfragment) and [`writeFragment()`](https://www.apollographql.com/docs/react/features/caching.html#writefragment) methods in the same way to rewrite the fragments. When working with a fragment we need to compose its ID, just like explained earlier. The default mapping function called `defaultDataIdFromObject` can be imported from `apollo-cache-inmemory` and be used to specify the fragment that we would like to read/write. Accordingly, we're gonna replace all our query re-writings with fragments re-writings, as we don't need them anymore:\n\n[{]: <helper> (diffStep 8.4 module=\"client\")\n\n#### Client Step 8.4: Rewrite fragments\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -1,3 +1,4 @@\n+â”Š â”Š1â”Šimport { defaultDataIdFromObject } from 'apollo-cache-inmemory';\n â”Š1â”Š2â”Šimport gql from 'graphql-tag';\n â”Š2â”Š3â”Šimport React from 'react';\n â”Š3â”Š4â”Šimport { useCallback } from 'react';\n```\n```diff\n@@ -78,15 +79,33 @@\n â”Š 78â”Š 79â”Š        }\n â”Š 79â”Š 80â”Š      },\n â”Š 80â”Š 81â”Š      update: (client, { data: { addMessage } }) => {\n-â”Š 81â”Š   â”Š        client.writeQuery({\n-â”Š 82â”Š   â”Š          query: getChatQuery,\n-â”Š 83â”Š   â”Š          variables: { chatId },\n-â”Š 84â”Š   â”Š          data: {\n-â”Š 85â”Š   â”Š            chat: {\n-â”Š 86â”Š   â”Š              ...chat,\n-â”Š 87â”Š   â”Š              messages: chat.messages.concat(addMessage)\n-â”Š 88â”Š   â”Š            }\n-â”Š 89â”Š   â”Š          }\n+â”Š   â”Š 82â”Š        type FullChat = { [key: string]: any };\n+â”Š   â”Š 83â”Š        let fullChat;\n+â”Š   â”Š 84â”Š        const chatIdFromStore = defaultDataIdFromObject(chat);\n+â”Š   â”Š 85â”Š\n+â”Š   â”Š 86â”Š        if (chatIdFromStore === null) { return; }\n+â”Š   â”Š 87â”Š\n+â”Š   â”Š 88â”Š        try {\n+â”Š   â”Š 89â”Š          fullChat = client.readFragment<FullChat>({\n+â”Š   â”Š 90â”Š            id: chatIdFromStore,\n+â”Š   â”Š 91â”Š            fragment: fragments.fullChat,\n+â”Š   â”Š 92â”Š            fragmentName: 'FullChat',\n+â”Š   â”Š 93â”Š          });\n+â”Š   â”Š 94â”Š        } catch (e) {\n+â”Š   â”Š 95â”Š          return;\n+â”Š   â”Š 96â”Š        }\n+â”Š   â”Š 97â”Š\n+â”Š   â”Š 98â”Š        if (fullChat === null) { return; }\n+â”Š   â”Š 99â”Š        if (fullChat.messages.some((m:any) => m.id === addMessage.id)) return;\n+â”Š   â”Š100â”Š\n+â”Š   â”Š101â”Š        fullChat.messages.push(addMessage);\n+â”Š   â”Š102â”Š        fullChat.lastMessage = addMessage;\n+â”Š   â”Š103â”Š\n+â”Š   â”Š104â”Š        client.writeFragment({\n+â”Š   â”Š105â”Š          id: chatIdFromStore,\n+â”Š   â”Š106â”Š          fragment: fragments.fullChat,\n+â”Š   â”Š107â”Š          fragmentName: 'FullChat',\n+â”Š   â”Š108â”Š          data: fullChat,\n â”Š 90â”Š109â”Š        });\n â”Š 91â”Š110â”Š\n â”Š 92â”Š111â”Š        let data;\n```\n```diff\n@@ -106,7 +125,6 @@\n â”Š106â”Š125â”Š        if (chatIndex === -1) return;\n â”Š107â”Š126â”Š        const chatWhereAdded = chats[chatIndex];\n â”Š108â”Š127â”Š\n-â”Š109â”Š   â”Š        chatWhereAdded.lastMessage = addMessage;\n â”Š110â”Š128â”Š        // The chat will appear at the top of the ChatsList component\n â”Š111â”Š129â”Š        chats.splice(chatIndex, 1);\n â”Š112â”Š130â”Š        chats.unshift(chatWhereAdded);\n```\n\n[}]: #\n\n\n----------\nTODO: Isnâ€™t `chats.splice(0, Infinity, ...[ â€¦ ])` the same as `chats = [...]` ?\nI see an explanation of apollo-cache but it makes you feel itâ€™s the fragment thatâ€™s being cached, which is not true, itâ€™s the object type.\nWe shouldnâ€™t use `defaultDataIdFromObject` directly from `apollo-cache-inmemory` but define it somewhere in our code and use that. It might change in the future and then we would have to do it in 500 files.\nI would explain a lot more than it is now, about the caching. It should be based on a simpler example and show that when an entity `Foo:1` is modified, the change reflects in all component. We should describe how itâ€™s stored, as references and not real data and so on.\n\nTODO: Better fragments naming and convensions"
          },
          {
            "manualTitle": "Step 9: Type safety with GraphQL Code Generator",
            "stepRevision": "bf4d4410e6a2867a686daaab67abf66f380a449d",
            "manualView": "So far we've been just writing code. If there was an error we would most likely discover it during runtime. As a reminder, we've created a project which is based on TypeScript, but we haven't really took any advantage of TypeScript's type safety mechanism. Currently, the TypeScript compiler is configured to work on loose mode, so any object which is not bound to any type will be converted to `any` - a type which is compatible with any type of casting and will ignore type errors.\n\nSo far it's been very convenient because we've only started to learn about building an app and the ecosystem around it, but for a long term project it's would be very handy to take a full advantage of TypeScript and not let it go under the radar. So where exactly are we missing type checkings? In the core of our project - when dealing with GraphQL documents.\n\nWhen we run a query, or a mutation, we wanna make sure that we use the received data correctly, based on its intended shape and form. For example, given the following GraphQL query:\n\n```graphql\nquery Chats {\n  chats {\n    id\n    name\n    picture\n  }\n}\n```\n\nWe want to have the following TypeScript type:\n\n```ts\nexport type Chat = {\n  __typename?: \"Chat\"\n  id: string\n  name: string\n  picture: string\n}\n\nexport type ChatQuery = {\n  __typename?: \"Query\"\n  chats: Chats[]\n}\n\n```\n\nSo later on we can use it with `react-apollo-hooks` like so:\n\n```ts\nuseQuery<ChatsQuery>(getChatsQuery)\n```\n\nEverything looks nice in theory, but the main issue that arises from having type definitions is that we need to maintain and sync 2 similar code bases:\nA GraphQL schema and TypeScript type definitions.\nBoth are essentially the same, and if so, why do we even need to maintain 2 code bases?\nIsn't there a tool which does that for us? A question which brings us straight to the point of the chapter.\n\n**Introducing: GraphQL Code Generator**\n\nWith [GraphQL Code Generator](https://graphql-code-generator.com/) we can generate TypeScript definitions given a GraphQL schema, and a set of GraphQL documents if they are presented to us.\n\n\n\n![graphql-codegen](https://user-images.githubusercontent.com/7648874/54940897-9f564380-4f66-11e9-9891-3b994a1daef1.png)\n\n\nGraphQL Code Generator is a simple CLI tool that operates based on a configuration file and can generate TypeScript types for both Client and Server.\nWe will start with generating types for the server.\n\nIn the server project, install GraphQL Code Generator via Yarn\n\n    $ yarn add @graphql-codegen/cli --dev\n\nNow GraphQL Code Generator can be used directly from the `scripts` section in the `package.json` file using the `gql-gen` binary.\nWe're gonna call the code generation script \"codegen\":\n\n```json\n{\n  \"codegen\": \"gql-gen\"\n}\n```\n\nThis command will automatically be referenced to a configuration file in the root of our project called `codegen.yml`.\nThe essence of this file is to provide the code generator with the GraphQL schema, GraphQL documents, the output path of the type definition file/s and a set of plug-ins.\nMore about the configuration file can be found in the [official website](https://graphql-code-generator.com/docs/getting-started/codegen-config).\n\nIn the server project, we will generate the `types/graphql.d.ts` file and we will use a couple of plug-ins to do that:\n\n\n\n*   `@graphql-codegen/typescript` - Will generate the core TypeScript types from our GraphQL schema.\n*   `@graphql-codegen/typescript-resolvers` - Will generate resolvers signatures with the generated TypeScript types.\n\n> A full list of available plugins is available [here](https://graphql-code-generator.com/docs/plugins/). In addition, you can write your own [custom plugin](https://graphql-code-generator.com/docs/custom-codegen/write-your-plugin).\n\nLet's install these 2 plugins:\n\n    $ yarn add @graphql-codegen/typescript @graphql-codegen/typescript-resolvers --dev\n\nAnd write the `codegen.yml` file:\n\n[{]: <helper> (diffStep 6.1 files=\"codegen.yml\" module=\"server\")\n\n#### [Server Step 6.1: Setup GraphQL Code Generator](https://github.com/Urigo/WhatsApp-Clone-Server/commit/2296411)\n\n##### Added codegen.yml\n```diff\n@@ -0,0 +1,16 @@\n+â”Š  â”Š 1â”Šschema: ./schema/typeDefs.graphql\n+â”Š  â”Š 2â”Šoverwrite: true\n+â”Š  â”Š 3â”Šgenerates:\n+â”Š  â”Š 4â”Š  ./types/graphql.d.ts:\n+â”Š  â”Š 5â”Š    plugins:\n+â”Š  â”Š 6â”Š      - typescript\n+â”Š  â”Š 7â”Š      - typescript-resolvers\n+â”Š  â”Š 8â”Š    config:\n+â”Š  â”Š 9â”Š      mappers:\n+â”Š  â”Š10â”Š        # import { Message } from '../db'\n+â”Š  â”Š11â”Š        # The root types of Message resolvers\n+â”Š  â”Š12â”Š        Message: ../db#Message\n+â”Š  â”Š13â”Š        Chat: ../db#Chat\n+â”Š  â”Š14â”Š      scalars:\n+â”Š  â”Š15â”Š        # e.g. Message.createdAt will be of type Date\n+â”Š  â”Š16â”Š        Date: Date\n```\n\n[}]: #\n\n> See inline comments to learn more about our configuration setup.\n\nNow if you'll run `$ npm run codegen` you should see that a new file `types/graphql.d.ts` has been generated with all the necessary TypeScript types. Since these types are very likely to change as we extend our schema, there's no need to include them in our project, thus it's recommended to add the appropriate .gitignore rule:\n\n[{]: <helper> (diffStep 6.1 files=\".gitignore\" module=\"server\")\n\n#### [Server Step 6.1: Setup GraphQL Code Generator](https://github.com/Urigo/WhatsApp-Clone-Server/commit/2296411)\n\n##### Changed .gitignore\n```diff\n@@ -1,2 +1,3 @@\n â”Š1â”Š1â”Šnode_modules\n-â”Š2â”Š â”Šnpm-debug.logðŸš«â†µ\n+â”Š â”Š2â”Šnpm-debug.log\n+â”Š â”Š3â”Štypes/graphql.d.tsðŸš«â†µ\n```\n\n[}]: #\n\nNow we can import the `IResolvers` type from the file we've just created and use it in the `resolvers.ts` file to ensure our resolvers handlers have the right signature:\n\n[{]: <helper> (diffStep 6.2 module=\"server\")\n\n#### [Server Step 6.2: Type resolvers](https://github.com/Urigo/WhatsApp-Clone-Server/commit/9cb0db6)\n\n##### Changed schema&#x2F;index.ts\n```diff\n@@ -1,7 +1,10 @@\n â”Š 1â”Š 1â”Šimport { importSchema } from 'graphql-import'\n-â”Š 2â”Š  â”Šimport { makeExecutableSchema } from 'graphql-tools'\n+â”Š  â”Š 2â”Šimport { makeExecutableSchema, IResolvers } from 'graphql-tools'\n â”Š 3â”Š 3â”Šimport resolvers from './resolvers'\n â”Š 4â”Š 4â”Š\n â”Š 5â”Š 5â”Šconst typeDefs = importSchema('schema/typeDefs.graphql')\n â”Š 6â”Š 6â”Š\n-â”Š 7â”Š  â”Šexport default makeExecutableSchema({ resolvers, typeDefs })\n+â”Š  â”Š 7â”Šexport default makeExecutableSchema({\n+â”Š  â”Š 8â”Š  resolvers: resolvers as IResolvers,\n+â”Š  â”Š 9â”Š  typeDefs,\n+â”Š  â”Š10â”Š})\n```\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,18 +1,19 @@\n â”Š 1â”Š 1â”Šimport { GraphQLDateTime } from 'graphql-iso-date'\n-â”Š 2â”Š  â”Šimport { chats, messages } from '../db'\n+â”Š  â”Š 2â”Šimport { Message, chats, messages } from '../db'\n+â”Š  â”Š 3â”Šimport { Resolvers } from '../types/graphql'\n â”Š 3â”Š 4â”Š\n-â”Š 4â”Š  â”Šconst resolvers = {\n+â”Š  â”Š 5â”Šconst resolvers: Resolvers = {\n â”Š 5â”Š 6â”Š  Date: GraphQLDateTime,\n â”Š 6â”Š 7â”Š\n â”Š 7â”Š 8â”Š  Chat: {\n-â”Š 8â”Š  â”Š    messages(chat: any) {\n+â”Š  â”Š 9â”Š    messages(chat) {\n â”Š 9â”Š10â”Š      return messages.filter(m => chat.messages.includes(m.id))\n â”Š10â”Š11â”Š    },\n â”Š11â”Š12â”Š\n-â”Š12â”Š  â”Š    lastMessage(chat: any) {\n+â”Š  â”Š13â”Š    lastMessage(chat) {\n â”Š13â”Š14â”Š      const lastMessage = chat.messages[chat.messages.length - 1]\n â”Š14â”Š15â”Š\n-â”Š15â”Š  â”Š      return messages.find(m => m.id === lastMessage)\n+â”Š  â”Š16â”Š      return messages.find(m => m.id === lastMessage) || null\n â”Š16â”Š17â”Š    },\n â”Š17â”Š18â”Š  },\n â”Š18â”Š19â”Š\n```\n```diff\n@@ -21,13 +22,13 @@\n â”Š21â”Š22â”Š      return chats\n â”Š22â”Š23â”Š    },\n â”Š23â”Š24â”Š\n-â”Š24â”Š  â”Š    chat(root: any, { chatId }: any) {\n-â”Š25â”Š  â”Š      return chats.find(c => c.id === chatId)\n+â”Š  â”Š25â”Š    chat(root, { chatId }) {\n+â”Š  â”Š26â”Š      return chats.find(c => c.id === chatId) || null\n â”Š26â”Š27â”Š    },\n â”Š27â”Š28â”Š  },\n â”Š28â”Š29â”Š\n â”Š29â”Š30â”Š  Mutation: {\n-â”Š30â”Š  â”Š    addMessage(root: any, { chatId, content }: any) {\n+â”Š  â”Š31â”Š    addMessage(root, { chatId, content }) {\n â”Š31â”Š32â”Š      const chatIndex = chats.findIndex(c => c.id === chatId)\n â”Š32â”Š33â”Š\n â”Š33â”Š34â”Š      if (chatIndex === -1) return null\n```\n```diff\n@@ -35,7 +36,7 @@\n â”Š35â”Š36â”Š      const chat = chats[chatIndex]\n â”Š36â”Š37â”Š      const recentMessage = messages[messages.length - 1]\n â”Š37â”Š38â”Š      const messageId = String(Number(recentMessage.id) + 1)\n-â”Š38â”Š  â”Š      const message = {\n+â”Š  â”Š39â”Š      const message: Message = {\n â”Š39â”Š40â”Š        id: messageId,\n â”Š40â”Š41â”Š        createdAt: new Date(),\n â”Š41â”Š42â”Š        content,\n```\n\n[}]: #\n\nWe will now repeat the same process in the client with few tweaks. Again, we will install GraphQL Code Generator:\n\n    $ yarn add @graphql-codegen/cli --dev\n\nAnd we will define a script:\n\n```json\n{\n  \"codegen\": \"gql-gen\"\n}\n```\n\nThis time around, because we're in the client, we will define a set of glob paths that will specify which files contain GraphQL documents.\nGraphQL Code Generator is smart enough to automatically recognize the documents within these files by looking at the `gql` template literal calls using the `typescript-operations` package.\nWe will be using a plugin called `typescript-react-apollo` to generate React/Apollo-GraphQL hooks that can be used in our function components.\nLet's install the necessary plugins:\n\n    $ yarn add @graphql-codegen/cli @graphql-codegen/typescript @graphql-codegen/typescript-operations @graphql-codegen/typescript-react-apollo @graphql-codegen/add\n\n\nAnd we will write the `codegen.yml` file:\n\n[{]: <helper> (diffStep 9.1 files=\"codegen.yml\" module=\"client\")\n\n#### Client Step 9.1: Setup GraphQL Code Generator\n\n##### Added codegen.yml\n```diff\n@@ -0,0 +1,20 @@\n+â”Š  â”Š 1â”Šschema: ../Whatsapp-Clone-Server/schema/typeDefs.graphql\n+â”Š  â”Š 2â”Šdocuments:\n+â”Š  â”Š 3â”Š  - ./src/components/**/*.tsx\n+â”Š  â”Š 4â”Š  - ./src/graphql/fragments/**/*.ts\n+â”Š  â”Š 5â”Š  - ./src/graphql/queries/**/*.ts\n+â”Š  â”Š 6â”Šoverwrite: true\n+â”Š  â”Š 7â”Šgenerates:\n+â”Š  â”Š 8â”Š  ./src/graphql/types.tsx:\n+â”Š  â”Š 9â”Š    plugins:\n+â”Š  â”Š10â”Š      - add: '/* eslint-disable */'\n+â”Š  â”Š11â”Š      - typescript\n+â”Š  â”Š12â”Š      - typescript-operations\n+â”Š  â”Š13â”Š      - typescript-react-apollo\n+â”Š  â”Š14â”Š    # The combined options of all provided plug-ins\n+â”Š  â”Š15â”Š    # More information about the options below:\n+â”Š  â”Š16â”Š    # graphql-code-generator.com/docs/plugins/typescript-react-apollo#configuration\n+â”Š  â”Š17â”Š    config:\n+â”Š  â”Š18â”Š      withHOC: false\n+â”Š  â”Š19â”Š      withHooks: true\n+â”Š  â”Š20â”Š      withComponent: false\n```\n\n[}]: #\n\nNotice that we sent the schema as a local path.\nWe could have also provided a GraphQL endpoint that exposes a GraphQL schema.\nThis way if there's an existing running GraphQL API, we can generate TypeScript types out of it, such as GitHub's GraphQL API.\nThe advantages of providing a local path is that the server doesn't have to be running in order to generate types, which is more comfortable in development, and we can bypass authentication if the endpoint is guarded with such mechanism.\nThis will be useful in further chapters when we're introduced to the concept of authentication.\n\nBe sure to add a .gitignore rule because we want to run the generator every time there is a change and don't want to rely on old generated types:\n\n[{]: <helper> (diffStep 9.1 files=\".gitignore\" module=\"client\")\n\n#### Client Step 9.1: Setup GraphQL Code Generator\n\n##### Changed .gitignore\n```diff\n@@ -21,3 +21,5 @@\n â”Š21â”Š21â”Šnpm-debug.log*\n â”Š22â”Š22â”Šyarn-debug.log*\n â”Š23â”Š23â”Šyarn-error.log*\n+â”Š  â”Š24â”Š\n+â”Š  â”Š25â”Šsrc/graphql/types.tsx\n```\n\n[}]: #\n\nNow we have TypeScript types available to us and we can replace `useQuery()` and `useMutation()` calls with the generated React hooks.\nLet's use those and also remove all the old manual typings:\n\n[{]: <helper> (diffStep 9.2 module=\"client\")\n\n#### Client Step 9.2: Use GraphQL Codegen hooks\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;ChatNavbar.tsx\n```diff\n@@ -5,7 +5,6 @@\n â”Š 5â”Š 5â”Šimport { useCallback } from 'react';\n â”Š 6â”Š 6â”Šimport styled from 'styled-components';\n â”Š 7â”Š 7â”Šimport { History } from 'history';\n-â”Š 8â”Š  â”Šimport { ChatQueryResult } from './index';\n â”Š 9â”Š 8â”Š\n â”Š10â”Š 9â”Šconst Container = styled(Toolbar) `\n â”Š11â”Š10â”Š  padding: 0;\n```\n```diff\n@@ -37,7 +36,10 @@\n â”Š37â”Š36â”Š\n â”Š38â”Š37â”Šinterface ChatNavbarProps {\n â”Š39â”Š38â”Š  history: History;\n-â”Š40â”Š  â”Š  chat: ChatQueryResult;\n+â”Š  â”Š39â”Š  chat?: {\n+â”Š  â”Š40â”Š    picture?: string | null;\n+â”Š  â”Š41â”Š    name?: string | null;\n+â”Š  â”Š42â”Š  };\n â”Š41â”Š43â”Š};\n â”Š42â”Š44â”Š\n â”Š43â”Š45â”Šconst ChatNavbar: React.FC<ChatNavbarProps> = ({ chat, history }) => {\n```\n```diff\n@@ -50,8 +52,12 @@\n â”Š50â”Š52â”Š      <BackButton data-testid=\"back-button\" onClick={navBack}>\n â”Š51â”Š53â”Š        <ArrowBackIcon />\n â”Š52â”Š54â”Š      </BackButton>\n-â”Š53â”Š  â”Š      <Picture data-testid=\"chat-picture\" src={chat.picture} />\n-â”Š54â”Š  â”Š      <Name data-testid=\"chat-name\">{chat.name}</Name>\n+â”Š  â”Š55â”Š      {chat && chat.picture && chat.name && (\n+â”Š  â”Š56â”Š        <React.Fragment>\n+â”Š  â”Š57â”Š          <Picture data-testid=\"chat-picture\" src={chat.picture} />\n+â”Š  â”Š58â”Š          <Name data-testid=\"chat-name\">{chat.name}</Name>\n+â”Š  â”Š59â”Š        </React.Fragment>\n+â”Š  â”Š60â”Š      )}\n â”Š55â”Š61â”Š    </Container>\n â”Š56â”Š62â”Š  );\n â”Š57â”Š63â”Š};\n```\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;MessagesList.tsx\n```diff\n@@ -3,7 +3,6 @@\n â”Š3â”Š3â”Šimport { useEffect, useRef } from 'react';\n â”Š4â”Š4â”Šimport ReactDOM from 'react-dom';\n â”Š5â”Š5â”Šimport styled from 'styled-components';\n-â”Š6â”Š â”Šimport { ChatQueryMessage } from './index';\n â”Š7â”Š6â”Š\n â”Š8â”Š7â”Šconst Container = styled.div`\n â”Š9â”Š8â”Š  display: block;\n```\n```diff\n@@ -62,8 +61,13 @@\n â”Š62â”Š61â”Š  font-size: 12px;\n â”Š63â”Š62â”Š`;\n â”Š64â”Š63â”Š\n+â”Š  â”Š64â”Šinterface Message {\n+â”Š  â”Š65â”Š  id: string | null;\n+â”Š  â”Š66â”Š  content: string | null;\n+â”Š  â”Š67â”Š  createdAt: string | null;\n+â”Š  â”Š68â”Š}\n â”Š65â”Š69â”Šinterface MessagesListProps {\n-â”Š66â”Š  â”Š  messages: Array<ChatQueryMessage>;\n+â”Š  â”Š70â”Š  messages: Array<Message>;\n â”Š67â”Š71â”Š}\n â”Š68â”Š72â”Š\n â”Š69â”Š73â”Šconst MessagesList: React.FC<MessagesListProps> = ({ messages }) => {\n```\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -2,12 +2,12 @@\n â”Š 2â”Š 2â”Šimport gql from 'graphql-tag';\n â”Š 3â”Š 3â”Šimport React from 'react';\n â”Š 4â”Š 4â”Šimport { useCallback } from 'react';\n-â”Š 5â”Š  â”Šimport { useQuery, useMutation } from 'react-apollo-hooks';\n â”Š 6â”Š 5â”Šimport styled from 'styled-components';\n â”Š 7â”Š 6â”Šimport ChatNavbar from './ChatNavbar';\n â”Š 8â”Š 7â”Šimport MessageInput from './MessageInput';\n â”Š 9â”Š 8â”Šimport MessagesList from './MessagesList';\n â”Š10â”Š 9â”Šimport { History } from 'history';\n+â”Š  â”Š10â”Šimport { useGetChatQuery, useAddMessageMutation } from '../../graphql/types';\n â”Š11â”Š11â”Šimport * as queries from '../../graphql/queries';\n â”Š12â”Š12â”Šimport * as fragments from '../../graphql/fragments';\n â”Š13â”Š13â”Š\n```\n```diff\n@@ -18,7 +18,8 @@\n â”Š18â”Š18â”Š  height: 100vh;\n â”Š19â”Š19â”Š`;\n â”Š20â”Š20â”Š\n-â”Š21â”Š  â”Šconst getChatQuery = gql`\n+â”Š  â”Š21â”Š// eslint-disable-next-line\n+â”Š  â”Š22â”Šconst getChatQuery = gql `\n â”Š22â”Š23â”Š  query GetChat($chatId: ID!) {\n â”Š23â”Š24â”Š    chat(chatId: $chatId) {\n â”Š24â”Š25â”Š      ...FullChat\n```\n```diff\n@@ -27,6 +28,7 @@\n â”Š27â”Š28â”Š  ${fragments.fullChat}\n â”Š28â”Š29â”Š`;\n â”Š29â”Š30â”Š\n+â”Š  â”Š31â”Š// eslint-disable-next-line\n â”Š30â”Š32â”Šconst addMessageMutation = gql `\n â”Š31â”Š33â”Š  mutation AddMessage($chatId: ID!, $content: String!) {\n â”Š32â”Š34â”Š    addMessage(chatId: $chatId, content: $content) {\n```\n```diff\n@@ -36,37 +38,28 @@\n â”Š36â”Š38â”Š  ${fragments.message}\n â”Š37â”Š39â”Š`;\n â”Š38â”Š40â”Š\n-â”Š39â”Š  â”Šinterface ChatRoomScreenParams {\n+â”Š  â”Š41â”Šinterface ChatRoomScreenParams {\n â”Š40â”Š42â”Š  chatId: string\n â”Š41â”Š43â”Š  history: History;\n â”Š42â”Š44â”Š};\n-â”Š43â”Š  â”Š\n-â”Š44â”Š  â”Šexport interface ChatQueryMessage {\n-â”Š45â”Š  â”Š  id: string;\n-â”Š46â”Š  â”Š  content: string;\n-â”Š47â”Š  â”Š  createdAt: number;\n-â”Š48â”Š  â”Š};\n-â”Š49â”Š  â”Š\n-â”Š50â”Š  â”Šexport interface ChatQueryResult {\n-â”Š51â”Š  â”Š  id: string;\n-â”Š52â”Š  â”Š  name: string;\n-â”Š53â”Š  â”Š  picture: string;\n-â”Š54â”Š  â”Š  messages: Array<ChatQueryMessage>;\n-â”Š55â”Š  â”Š};\n-â”Š56â”Š  â”Š\n-â”Š57â”Š  â”Štype OptionalChatQueryResult = ChatQueryResult | null;\n â”Š58â”Š45â”Š\n â”Š59â”Š46â”Šinterface ChatsResult {\n â”Š60â”Š47â”Š  chats: any[];\n â”Š61â”Š48â”Š}\n â”Š62â”Š49â”Š\n â”Š63â”Š50â”Šconst ChatRoomScreen: React.FC<ChatRoomScreenParams> = ({ history, chatId }) => {\n-â”Š64â”Š  â”Š  const { data: { chat } } = useQuery<any>(getChatQuery, {\n+â”Š  â”Š51â”Š  const { data, loading } = useGetChatQuery({\n â”Š65â”Š52â”Š    variables: { chatId }\n â”Š66â”Š53â”Š  });\n-â”Š67â”Š  â”Š  const addMessage = useMutation(addMessageMutation);\n+â”Š  â”Š54â”Š\n+â”Š  â”Š55â”Š  const addMessage = useAddMessageMutation();\n â”Š68â”Š56â”Š\n â”Š69â”Š57â”Š  const onSendMessage = useCallback((content: string) => {\n+â”Š  â”Š58â”Š\n+â”Š  â”Š59â”Š    if (data === undefined) { return null; }\n+â”Š  â”Š60â”Š    const chat = data.chat;\n+â”Š  â”Š61â”Š    if (chat === null) return null;\n+â”Š  â”Š62â”Š\n â”Š70â”Š63â”Š    addMessage({\n â”Š71â”Š64â”Š      variables: { chatId, content },\n â”Š72â”Š65â”Š      optimisticResponse: {\n```\n```diff\n@@ -82,7 +75,7 @@\n â”Š82â”Š75â”Š        type FullChat = { [key: string]: any };\n â”Š83â”Š76â”Š        let fullChat;\n â”Š84â”Š77â”Š        const chatIdFromStore = defaultDataIdFromObject(chat);\n-â”Š85â”Š  â”Š\n+â”Š  â”Š78â”Š\n â”Š86â”Š79â”Š        if (chatIdFromStore === null) { return; }\n â”Š87â”Š80â”Š\n â”Š88â”Š81â”Š        try {\n```\n```diff\n@@ -132,12 +125,19 @@\n â”Š132â”Š125â”Š        client.writeQuery({\n â”Š133â”Š126â”Š          query: queries.chats,\n â”Š134â”Š127â”Š          data: { chats: chats },\n-â”Š135â”Š   â”Š        });\n+â”Š   â”Š128â”Š        });\n â”Š136â”Š129â”Š      }\n â”Š137â”Š130â”Š    });\n-â”Š138â”Š   â”Š  }, [chat, chatId, addMessage]);\n+â”Š   â”Š131â”Š  }, [data, chatId, addMessage]);\n+â”Š   â”Š132â”Š\n+â”Š   â”Š133â”Š  if (data === undefined) {\n+â”Š   â”Š134â”Š    return null;\n+â”Š   â”Š135â”Š  }\n+â”Š   â”Š136â”Š  const chat = data.chat;\n+â”Š   â”Š137â”Š  const loadingChat = loading;\n â”Š139â”Š138â”Š\n-â”Š140â”Š   â”Š  if (!chat) return null;\n+â”Š   â”Š139â”Š  if (loadingChat) return null;\n+â”Š   â”Š140â”Š  if (chat === null) return null;\n â”Š141â”Š141â”Š\n â”Š142â”Š142â”Š  return (\n â”Š143â”Š143â”Š    <Container>\n```\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -4,8 +4,7 @@\n â”Š 4â”Š 4â”Šimport styled from 'styled-components';\n â”Š 5â”Š 5â”Šimport { useCallback } from 'react';\n â”Š 6â”Š 6â”Šimport { History } from 'history';\n-â”Š 7â”Š  â”Šimport { useQuery } from 'react-apollo-hooks';\n-â”Š 8â”Š  â”Šimport * as queries from '../../graphql/queries';\n+â”Š  â”Š 7â”Šimport { useChatsQuery } from '../../graphql/types';\n â”Š 9â”Š 8â”Š\n â”Š10â”Š 9â”Šconst Container = styled.div `\n â”Š11â”Š10â”Š  height: calc(100% - 56px);\n```\n```diff\n@@ -64,12 +63,19 @@\n â”Š64â”Š63â”Š};\n â”Š65â”Š64â”Š\n â”Š66â”Š65â”Šconst ChatsList: React.FC<ChatsListProps> = ({ history }) => {\n-â”Š67â”Š  â”Š  const { data: { chats = [] } } = useQuery<any>(queries.chats);\n â”Š68â”Š66â”Š\n â”Š69â”Š67â”Š  const navToChat = useCallback((chat) => {\n â”Š70â”Š68â”Š    history.push(`chats/${chat.id}`)\n â”Š71â”Š69â”Š  }, [history]);\n â”Š72â”Š70â”Š\n+â”Š  â”Š71â”Š  const { data } = useChatsQuery();\n+â”Š  â”Š72â”Š\n+â”Š  â”Š73â”Š  if (data === undefined || data.chats === undefined) {\n+â”Š  â”Š74â”Š    return null;\n+â”Š  â”Š75â”Š  }\n+â”Š  â”Š76â”Š\n+â”Š  â”Š77â”Š  let chats = data.chats;\n+â”Š  â”Š78â”Š\n â”Š73â”Š79â”Š  return (\n â”Š74â”Š80â”Š    <Container>\n â”Š75â”Š81â”Š      <StyledList>\n```\n\n[}]: #\n\nTo test if things are working properly, we can address a non existing field in one of the retrieved query results, for example `chat.foo` in `useGetChatQuery()`.\nWe should receive the following typing error when trying to run the project:\n\n```\nTypeScript error: Property 'foo' does not exist on type '{ __typename?: \"Chat\"; } & { __typename?: \"Chat\"; } & { messages: ({ __typename?: \"Message\"; } & { __typename?: \"Message\"; } & Pick<Message, \"id\" | \"createdAt\" | \"content\">)[]; } & { __typename?: \"Chat\"; } & Pick<...> & { ...; }'.  TS2339\n\n    44 |   const addMessage = useAddMessageMutation()\n    45 |\n  > 46 |   console.log(chat.foo)\n       |                    ^\n    47 |\n    48 |   const onSendMessage = useCallback((content) => {\n    49 |     addMessage({\n```\n\nTODO: Mappers are not explained - The root types of Message resolvers - doesnâ€™t say much\nwe donâ€™t need to use `resolvers as IResolvers`, thereâ€™s a flag for it, in codegen\n\nTODO: Change `gql-gen` to `graphql-codegen`"
          },
          {
            "manualTitle": "Step 10: Live updates with GraphQL subscriptions",
            "stepRevision": "7a5987372e3538bec4342cde757f725cc8ebf9f0",
            "manualView": "So far we've been developing the app and we've been treating it as if there's no other users; we're the only one exists.\nThis approach is true when we want to develop a UI and focus on UX, but comes a point where we need to start thinking on a macro level.\nOur app is social interactive, and if things work properly for me, it doesn't mean that it works properly to the fellow I'm chatting with.\nIt's inevitable to have an authentication system in our app, hence we need to take care of things before we get to that stage.\n\nTry to open 2 instances of the app in 2 separate tabs/windows, and navigate into the same chat room.\nTry to send a message with one instance and notice that the second instance doesn't update unless we refresh the page.\n\n\n![ezgif com-video-to-gif (2)](https://user-images.githubusercontent.com/7648874/55079371-fbd87080-50d6-11e9-8ade-5ffeed6eaf8d.gif)\n\n\nThis issue is very important and should be addressed, because a chat is all about sending and receiving messages on a lively basis.\nThis issue was expected, as there's no mechanism that would trigger and listen to changes in the back-end.\nIn this chapter we're gonna address that issue by implementing exactly that mechanism.\n\n**Introducing: GraphQL Subscriptions**\n\n[GraphQL subscriptions](https://github.com/apollographql/graphql-subscriptions) is a mechanism that works on [web-sockets](https://en.wikipedia.org/wiki/WebSocket) and live communication; clients can subscribe to it and be notified regards specific changes that happen in the back-end. Notifications will be triggered manually by us and can be provided with parameters that provide additional information regards the triggered event. For example, a `messageAdded` will be published with the new message, and will notify all clients who are subscribed to that event. Once the subscribers are notified, they can respond as they would like to, such as updating the UI.\n\n\n\n![subscription-notifications](https://user-images.githubusercontent.com/7648874/55079462-30e4c300-50d7-11e9-8399-7706da2a9cff.png)\n\n\nA subscription is presented in our GraphQL schema as a separate type called `Subscription`, where each field represents an event name along with its return type.\nLike any other GraphQL type, each field should be match with a resolver where we handle the request.\n\nIn this chapter we will implement the `messageAdded` subscription, so users can be notified when it happens and update the messages list to contain the new message.\n\n**Implementing a subscription**\n\nWe will start by creating a new `Subscription` type in our GraphQL schema with the field `messageAdded`:\n\n[{]: <helper> (diffStep 7.1 module=\"server\")\n\n#### [Server Step 7.1: Add subscription type with messageAdded](https://github.com/Urigo/WhatsApp-Clone-Server/commit/8b6d50c)\n\n##### Changed schema&#x2F;typeDefs.graphql\n```diff\n@@ -22,3 +22,7 @@\n â”Š22â”Š22â”Štype Mutation {\n â”Š23â”Š23â”Š  addMessage(chatId: ID!, content: String!): Message\n â”Š24â”Š24â”Š}\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Štype Subscription {\n+â”Š  â”Š27â”Š  messageAdded: Message!\n+â”Š  â”Š28â”Š}\n```\n\n[}]: #\n\nChanges are triggered using an event-emitter like object called `PubSub`. This can be done using the `PubSub.prototype.publish` method. We will create a new instance of it and will provide it via the [context](https://www.apollographql.com/docs/apollo-server/essentials/data#context) - a common pattern for providing objects which are useful for the execution of the resolvers:\n\nTODO: Explain what the context is\n\n[{]: <helper> (diffStep 7.2 module=\"server\")\n\n#### [Server Step 7.2: Provide a new instance of PubSub to context](https://github.com/Urigo/WhatsApp-Clone-Server/commit/a1b2016)\n\n##### Changed index.ts\n```diff\n@@ -1,4 +1,4 @@\n-â”Š1â”Š â”Šimport { ApolloServer, gql } from 'apollo-server-express'\n+â”Š â”Š1â”Šimport { ApolloServer, gql, PubSub } from 'apollo-server-express'\n â”Š2â”Š2â”Šimport bodyParser from 'body-parser'\n â”Š3â”Š3â”Šimport cors from 'cors'\n â”Š4â”Š4â”Šimport express from 'express'\n```\n```diff\n@@ -13,7 +13,11 @@\n â”Š13â”Š13â”Š  res.send('pong')\n â”Š14â”Š14â”Š})\n â”Š15â”Š15â”Š\n-â”Š16â”Š  â”Šconst server = new ApolloServer({ schema })\n+â”Š  â”Š16â”Šconst pubsub = new PubSub()\n+â”Š  â”Š17â”Šconst server = new ApolloServer({\n+â”Š  â”Š18â”Š  schema,\n+â”Š  â”Š19â”Š  context: () => ({ pubsub }),\n+â”Š  â”Š20â”Š})\n â”Š17â”Š21â”Š\n â”Š18â”Š22â”Šserver.applyMiddleware({\n â”Š19â”Š23â”Š  app,\n```\n\n[}]: #\n\nInside the `addMessage` resolver we will publish a new event called `messageAdded`. The 3rd argument of the resolver will be the context object that we've just defined in the previous step, where we can use the pubsub instance. The TypeScript type of our context can be directly defined and generated by CodeGen through the `codegen.yml` file. This can be specified under the `ContextType` field with the file path that contains the context followed by the name of the exported object, like so:\n\n[{]: <helper> (diffStep 7.3 module=\"server\")\n\n#### [Server Step 7.3: Define Context type](https://github.com/Urigo/WhatsApp-Clone-Server/commit/405ba97)\n\n##### Changed codegen.yml\n```diff\n@@ -6,6 +6,7 @@\n â”Š 6â”Š 6â”Š      - typescript\n â”Š 7â”Š 7â”Š      - typescript-resolvers\n â”Š 8â”Š 8â”Š    config:\n+â”Š  â”Š 9â”Š      contextType: ../context#MyContext\n â”Š 9â”Š10â”Š      mappers:\n â”Š10â”Š11â”Š        # import { Message } from '../db'\n â”Š11â”Š12â”Š        # The root types of Message resolvers\n```\n\n##### Added context.ts\n```diff\n@@ -0,0 +1,5 @@\n+â”Š â”Š1â”Šimport { PubSub } from 'apollo-server-express'\n+â”Š â”Š2â”Š\n+â”Š â”Š3â”Šexport type MyContext = {\n+â”Š â”Š4â”Š  pubsub: PubSub\n+â”Š â”Š5â”Š}\n```\n\n[}]: #\n\nThe event will be published right after the message was pushed into the messages collection, because order is a crucial thing. We don't want to notify our users unless the change has been made. The event will have a single parameter which represents the new message.\n\n[{]: <helper> (diffStep 7.4 module=\"server\")\n\n#### [Server Step 7.4: Publish message added event](https://github.com/Urigo/WhatsApp-Clone-Server/commit/4c6d52a)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -28,7 +28,7 @@\n â”Š28â”Š28â”Š  },\n â”Š29â”Š29â”Š\n â”Š30â”Š30â”Š  Mutation: {\n-â”Š31â”Š  â”Š    addMessage(root, { chatId, content }) {\n+â”Š  â”Š31â”Š    addMessage(root, { chatId, content }, { pubsub }) {\n â”Š32â”Š32â”Š      const chatIndex = chats.findIndex(c => c.id === chatId)\n â”Š33â”Š33â”Š\n â”Š34â”Š34â”Š      if (chatIndex === -1) return null\n```\n```diff\n@@ -48,6 +48,10 @@\n â”Š48â”Š48â”Š      chats.splice(chatIndex, 1)\n â”Š49â”Š49â”Š      chats.unshift(chat)\n â”Š50â”Š50â”Š\n+â”Š  â”Š51â”Š      pubsub.publish('messageAdded', {\n+â”Š  â”Š52â”Š        messageAdded: message,\n+â”Š  â”Š53â”Š      })\n+â”Š  â”Š54â”Š\n â”Š51â”Š55â”Š      return message\n â”Š52â”Š56â”Š    }\n â”Š53â”Š57â”Š  }\n```\n\n##### Changed tests&#x2F;mutations&#x2F;addMessage.test.ts\n```diff\n@@ -1,5 +1,5 @@\n â”Š1â”Š1â”Šimport { createTestClient } from 'apollo-server-testing'\n-â”Š2â”Š â”Šimport { ApolloServer, gql } from 'apollo-server-express'\n+â”Š â”Š2â”Šimport { ApolloServer, PubSub, gql } from 'apollo-server-express'\n â”Š3â”Š3â”Šimport schema from '../../schema'\n â”Š4â”Š4â”Šimport { resetDb } from '../../db'\n â”Š5â”Š5â”Š\n```\n```diff\n@@ -7,7 +7,10 @@\n â”Š 7â”Š 7â”Š  beforeEach(resetDb)\n â”Š 8â”Š 8â”Š\n â”Š 9â”Š 9â”Š  it('should add message to specified chat', async () => {\n-â”Š10â”Š  â”Š    const server = new ApolloServer({ schema })\n+â”Š  â”Š10â”Š    const server = new ApolloServer({\n+â”Š  â”Š11â”Š      schema,\n+â”Š  â”Š12â”Š      context: () => ({ pubsub: new PubSub() }),\n+â”Š  â”Š13â”Š    })\n â”Š11â”Š14â”Š\n â”Š12â”Š15â”Š    const { query, mutate } = createTestClient(server)\n```\n\n[}]: #\n\nA subscription resolver behaves differently and thus should be implemented differently. Using the `pubsub.asyncIterator` instance, we can specify which events are relevant for the subscription, for example, all clients who are subscribers of the `chatUpdated` subscription will be notified when `messageAdded`, `messageRemoved` and `chatInfoChanged` events were triggered. For now, we will have a 1 to 1 relationship between the `messageAdded` event and `messageAdded` subscription. In code, it should look like this:\n\n[{]: <helper> (diffStep 7.5 module=\"server\")\n\n#### [Server Step 7.5: Add Subscription.messageAdded resolver](https://github.com/Urigo/WhatsApp-Clone-Server/commit/3bbaa14)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -54,6 +54,12 @@\n â”Š54â”Š54â”Š\n â”Š55â”Š55â”Š      return message\n â”Š56â”Š56â”Š    }\n+â”Š  â”Š57â”Š  },\n+â”Š  â”Š58â”Š\n+â”Š  â”Š59â”Š  Subscription: {\n+â”Š  â”Š60â”Š    messageAdded: {\n+â”Š  â”Š61â”Š      subscribe: (root, args, { pubsub }) => pubsub.asyncIterator('messageAdded')\n+â”Š  â”Š62â”Š    }\n â”Š57â”Š63â”Š  }\n â”Š58â”Š64â”Š}\n```\n\n[}]: #\n\nThe idea behind the `pubsub.asyncIterator` method is that it returns an [`Iterator`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Iterators_and_Generators#Iterators) like object, where each value is a promise that will be resolved when the relevant events are triggered. By default, the parameter that has a similar name to the subscription will be returned as a response, e.g. `messageAdded` parameter will be sent back to the subscribers. This behavior can be modified as explained [here](https://github.com/apollographql/graphql-subscriptions#payload-manipulation), but it's very unlikely and not necessary for our use case.\n\nAs mentioned at the beginning of this article, there needs to be an open connection between the client and the server so live updates can happen. There are serveral methods for doing so, but the 2 most popular ones are:\n\n\n\n*   Based on polling with HTTP protocol\n*   Based on web-sockets (WS protocol)\n\nHTTP polling means that each amount of time an HTTP request will be made to the server where potential changes can be sent back to us at any given time. HTTP requests are very reliable, but the problem with them is that they contain a lot of information in their headers, so even if we sent an empty request, it might be still very heavy due to cookies, user-agent, language, request type, etc.\n\nWith web-sockets, once a connection has been established, it will remain open and it will only send the information which is relevant for the current session, so it's much faster. The communication is between the server and the client is bi-directional when it comes to web-sockets, which means that a user can spontaneously receive information from the server, as long as the communication channel remains open.\n\n> More information about the advantages of Web Sockets over HTTP can be found at [websocket.org](http://websocket.org/quantum.html)\n\nThe subscription mechanism can be installed using the `server.installSubscriptionHandlers`. It will use the WS protocol by default and will fallback to HTTP polling if there were troubles establishing a connection via WS protocol:\n\n[{]: <helper> (diffStep 7.6 module=\"server\")\n\n#### [Server Step 7.6: Install subscription handlers](https://github.com/Urigo/WhatsApp-Clone-Server/commit/8fd8a58)\n\n##### Changed index.ts\n```diff\n@@ -2,6 +2,7 @@\n â”Š2â”Š2â”Šimport bodyParser from 'body-parser'\n â”Š3â”Š3â”Šimport cors from 'cors'\n â”Š4â”Š4â”Šimport express from 'express'\n+â”Š â”Š5â”Šimport http from 'http'\n â”Š5â”Š6â”Šimport schema from './schema'\n â”Š6â”Š7â”Š\n â”Š7â”Š8â”Šconst app = express()\n```\n```diff\n@@ -24,8 +25,11 @@\n â”Š24â”Š25â”Š  path: '/graphql',\n â”Š25â”Š26â”Š})\n â”Š26â”Š27â”Š\n+â”Š  â”Š28â”Šconst httpServer = http.createServer(app)\n+â”Š  â”Š29â”Šserver.installSubscriptionHandlers(httpServer)\n+â”Š  â”Š30â”Š\n â”Š27â”Š31â”Šconst port = process.env.PORT || 4000\n â”Š28â”Š32â”Š\n-â”Š29â”Š  â”Šapp.listen(port, () => {\n+â”Š  â”Š33â”ŠhttpServer.listen(port, () => {\n â”Š30â”Š34â”Š  console.log(`Server is listening on port ${port}`)\n â”Š31â”Š35â”Š})\n```\n\n[}]: #\n\nNow we have everything set and we can start listening to subscriptions and react to to triggered changes.\n\n**Using subscriptions**\n\nTo support subscriptions we need to establish a WS connection. For that we will need to update our Apollo client. We will install a couple of packages that will enable such feature:\n\n    $ yarn add subscriptions-transport-ws apollo-link apollo-link-ws apollo-utilities\n\n\n*   [`subscriptions-transport-ws`](https://www.npmjs.com/package/subscriptions-transport-ws) - a transport layer that understands how client and GraphQL API communicates with each other. The spec has GQL_INIT GQL_UPDATE GQL_DATA events.\n*   [`apollo-link-ws`](https://www.npmjs.com/package/apollo-link-ws) - Will establish a WS connection.\n*   [`apollo-link`](https://www.npmjs.com/package/apollo-link) - Will enable WS and HTTP connections co-exist in a single client.\n*   [`apollo-utilities`](https://www.npmjs.com/package/apollo-utilities) - Includes utility functions that will help us analyze a GraphQL AST.\n\nThe WS url can be composed by simply running a regular expression over the `REACT_APP_SERVER_URL` environment variable and is unnecessary to be stored separately. Here's how our new client should look like: \\\n\n\n[{]: <helper> (diffStep 10.1 files=\"client\" module=\"client\")\n\n#### Client Step 10.1: Setup WS link\n\n##### Changed src&#x2F;client.ts\n```diff\n@@ -1,16 +1,42 @@\n â”Š 1â”Š 1â”Šimport { InMemoryCache } from 'apollo-cache-inmemory';\n â”Š 2â”Š 2â”Šimport { ApolloClient } from 'apollo-client';\n+â”Š  â”Š 3â”Šimport { getMainDefinition } from 'apollo-utilities';\n â”Š 3â”Š 4â”Šimport { HttpLink } from 'apollo-link-http';\n+â”Š  â”Š 5â”Šimport { WebSocketLink } from 'apollo-link-ws';\n+â”Š  â”Š 6â”Šimport { ApolloLink, split } from 'apollo-link';\n â”Š 4â”Š 7â”Š\n â”Š 5â”Š 8â”Šconst httpUri = process.env.REACT_APP_SERVER_URL + '/graphql';\n+â”Š  â”Š 9â”Šconst wsUri = httpUri.replace(/^https?/, 'ws');\n â”Š 6â”Š10â”Š\n â”Š 7â”Š11â”Šconst httpLink = new HttpLink({\n â”Š 8â”Š12â”Š  uri: httpUri,\n â”Š 9â”Š13â”Š});\n â”Š10â”Š14â”Š\n+â”Š  â”Š15â”Šconst wsLink = new WebSocketLink({\n+â”Š  â”Š16â”Š  uri: wsUri,\n+â”Š  â”Š17â”Š  options: {\n+â”Š  â”Š18â”Š    // Automatic reconnect in case of connection error\n+â”Š  â”Š19â”Š    reconnect: true,\n+â”Š  â”Š20â”Š  },\n+â”Š  â”Š21â”Š});\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Šconst terminatingLink = split(\n+â”Š  â”Š24â”Š  ({ query }) => {\n+â”Š  â”Š25â”Š    const { kind, operation } = getMainDefinition(query);\n+â”Š  â”Š26â”Š    // If this is a subscription query, use wsLink, otherwise use httpLink\n+â”Š  â”Š27â”Š    return (\n+â”Š  â”Š28â”Š      kind === 'OperationDefinition' && operation === 'subscription'\n+â”Š  â”Š29â”Š    );\n+â”Š  â”Š30â”Š  },\n+â”Š  â”Š31â”Š  wsLink,\n+â”Š  â”Š32â”Š  httpLink,\n+â”Š  â”Š33â”Š);\n+â”Š  â”Š34â”Š\n+â”Š  â”Š35â”Šconst link = ApolloLink.from([terminatingLink]);\n+â”Š  â”Š36â”Š\n â”Š11â”Š37â”Šconst inMemoryCache = new InMemoryCache();\n â”Š12â”Š38â”Š\n â”Š13â”Š39â”Šexport default new ApolloClient({\n-â”Š14â”Š  â”Š  link: httpLink,\n+â”Š  â”Š40â”Š  link,\n â”Š15â”Š41â”Š  cache: inMemoryCache,\n â”Š16â”Š42â”Š});\n```\n\n[}]: #\n\nOur subscription listeners should live globally across our application and shouldn't be bound to a specific component, thus we will create an external service which will be responsible of doing so. Using that service, we will update our GraphQL data-store any time a new message has been added. We will define a `messageAdded` subscription in a dedicated file under the `src/graphql/subscriptions` dir where all our subscriptions will be defined and exported:\n\nTODO: - but they are anyway. Itâ€™s just a standalone function that is used in a component. Which makes no difference.\n\n[{]: <helper> (diffStep 10.2 module=\"client\")\n\n#### Client Step 10.2: Add messageAdded subscription document\n\n##### Added src&#x2F;graphql&#x2F;subscriptions&#x2F;index.ts\n```diff\n@@ -0,0 +1 @@\n+â”Š â”Š1â”Šexport { default as messageAdded } from './messageAdded.subscription';\n```\n\n##### Added src&#x2F;graphql&#x2F;subscriptions&#x2F;messageAdded.subscription.ts\n```diff\n@@ -0,0 +1,11 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag';\n+â”Š  â”Š 2â”Šimport * as fragments from '../fragments';\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šexport default gql `\n+â”Š  â”Š 5â”Š  subscription MessageAdded {\n+â”Š  â”Š 6â”Š    messageAdded {\n+â”Š  â”Š 7â”Š      ...Message\n+â”Š  â”Š 8â”Š    }\n+â”Š  â”Š 9â”Š  }\n+â”Š  â”Š10â”Š  ${fragments.message}\n+â”Š  â”Š11â”Š`;\n```\n\n[}]: #\n\nNow we will create the service under the path `services/cache.service.ts`. Like any other GraphQL operation, `react-apollo-hooks` provides us with a dedicated React hook for subscriptions called `useSubscription`. Given the subscription document and the `onSubscriptionData` callback we can handle incoming changes. We will be using GraphQL Code Generator to generate typed subscription hooks, as the `typescript-react-apollo` plug-in supports it right out of the box. First let's update the `codegen.yml` file to look for documents in the `graphql/subscriptions` dir:\n\n[{]: <helper> (diffStep 10.3 module=\"client\")\n\n#### Client Step 10.3: Include subscription documents in codegen.yml\n\n##### Changed codegen.yml\n```diff\n@@ -3,6 +3,7 @@\n â”Š3â”Š3â”Š  - ./src/components/**/*.tsx\n â”Š4â”Š4â”Š  - ./src/graphql/fragments/**/*.ts\n â”Š5â”Š5â”Š  - ./src/graphql/queries/**/*.ts\n+â”Š â”Š6â”Š  - ./src/graphql/subscriptions/**/*.ts\n â”Š6â”Š7â”Šoverwrite: true\n â”Š7â”Š8â”Šgenerates:\n â”Š8â”Š9â”Š  ./src/graphql/types.tsx:\n```\n\n[}]: #\n\nAnd then we will type the code generation command:\n\n    $ npm run codegen\n\nNow we can import and use the newly generated hook `useMessageAddedSubscription` in the `cache.service`. Like mentioned earlier, we will be using the `onSubscriptionData` callback to retrieve the change that was sent by the server and we will use it to re-write our cache. In this case we will be writing a new fragment for the incoming message, and we will update the correlated chat:\n\n[{]: <helper> (diffStep 10.4 files=\"cache.service\" module=\"client\")\n\n#### Client Step 10.4: Update cache on message added\n\n##### Added src&#x2F;services&#x2F;cache.service.ts\n```diff\n@@ -0,0 +1,79 @@\n+â”Š  â”Š 1â”Šimport { DataProxy } from 'apollo-cache';\n+â”Š  â”Š 2â”Šimport { defaultDataIdFromObject } from 'apollo-cache-inmemory';\n+â”Š  â”Š 3â”Šimport { ApolloClient } from 'apollo-client';\n+â”Š  â”Š 4â”Šimport * as fragments from '../graphql/fragments';\n+â”Š  â”Š 5â”Šimport * as queries from '../graphql/queries';\n+â”Š  â”Š 6â”Šimport { MessageFragment, useMessageAddedSubscription } from '../graphql/types';\n+â”Š  â”Š 7â”Š\n+â”Š  â”Š 8â”Štype Client = ApolloClient<any> | DataProxy;\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Šexport const useCacheService = () => {\n+â”Š  â”Š11â”Š  useMessageAddedSubscription({\n+â”Š  â”Š12â”Š    onSubscriptionData: ({ client, subscriptionData: { data } }) => {\n+â”Š  â”Š13â”Š      if (data) {\n+â”Š  â”Š14â”Š        writeMessage(client, data.messageAdded);\n+â”Š  â”Š15â”Š      }\n+â”Š  â”Š16â”Š    }\n+â”Š  â”Š17â”Š  });\n+â”Š  â”Š18â”Š};\n+â”Š  â”Š19â”Š\n+â”Š  â”Š20â”Šexport const writeMessage = (client: Client, message: MessageFragment) => {\n+â”Š  â”Š21â”Š  type FullChat = { [key: string]: any };\n+â”Š  â”Š22â”Š  let fullChat;\n+â”Š  â”Š23â”Š\n+â”Š  â”Š24â”Š  const chatIdFromStore = defaultDataIdFromObject(message.chat);\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Š  if (chatIdFromStore === null) { return; }\n+â”Š  â”Š27â”Š  try {\n+â”Š  â”Š28â”Š    fullChat = client.readFragment<FullChat>({\n+â”Š  â”Š29â”Š      id: chatIdFromStore,\n+â”Š  â”Š30â”Š      fragment: fragments.fullChat,\n+â”Š  â”Š31â”Š      fragmentName: 'FullChat',\n+â”Š  â”Š32â”Š    })\n+â”Š  â”Š33â”Š  } catch (e) {\n+â”Š  â”Š34â”Š    return;\n+â”Š  â”Š35â”Š  }\n+â”Š  â”Š36â”Š\n+â”Š  â”Š37â”Š  if (fullChat === null || fullChat.messages === null) { return; }\n+â”Š  â”Š38â”Š  if (fullChat.messages.some((m: any) => m.id === message.id)) return;\n+â”Š  â”Š39â”Š\n+â”Š  â”Š40â”Š  fullChat.messages.push(message);\n+â”Š  â”Š41â”Š  fullChat.lastMessage = message;\n+â”Š  â”Š42â”Š\n+â”Š  â”Š43â”Š  client.writeFragment({\n+â”Š  â”Š44â”Š    id: chatIdFromStore,\n+â”Š  â”Š45â”Š    fragment: fragments.fullChat,\n+â”Š  â”Š46â”Š    fragmentName: 'FullChat',\n+â”Š  â”Š47â”Š    data: fullChat,\n+â”Š  â”Š48â”Š  });\n+â”Š  â”Š49â”Š\n+â”Š  â”Š50â”Š\n+â”Š  â”Š51â”Š  let data;\n+â”Š  â”Š52â”Š  try {\n+â”Š  â”Š53â”Š    data = client.readQuery({\n+â”Š  â”Š54â”Š      query: queries.chats,\n+â”Š  â”Š55â”Š    })\n+â”Š  â”Š56â”Š  } catch (e) {\n+â”Š  â”Š57â”Š    return;\n+â”Š  â”Š58â”Š  };\n+â”Š  â”Š59â”Š\n+â”Š  â”Š60â”Š  if (!data) return;\n+â”Š  â”Š61â”Š  const chats = data.chats;\n+â”Š  â”Š62â”Š  if (!chats) return;\n+â”Š  â”Š63â”Š\n+â”Š  â”Š64â”Š  const chatIndex = chats.findIndex((c: any) => {\n+â”Š  â”Š65â”Š    if (message === null || message.chat === null) return -1;\n+â”Š  â”Š66â”Š    return c.id === message.chat.id;\n+â”Š  â”Š67â”Š  });\n+â”Š  â”Š68â”Š  if (chatIndex === -1) return;\n+â”Š  â”Š69â”Š  const chatWhereAdded = chats[chatIndex];\n+â”Š  â”Š70â”Š\n+â”Š  â”Š71â”Š  // The chat will appear at the top of the ChatsList component\n+â”Š  â”Š72â”Š  chats.splice(chatIndex, 1);\n+â”Š  â”Š73â”Š  chats.unshift(chatWhereAdded);\n+â”Š  â”Š74â”Š\n+â”Š  â”Š75â”Š  client.writeQuery({\n+â”Š  â”Š76â”Š    query: queries.chats,\n+â”Š  â”Š77â”Š    data: { chats: chats },\n+â”Š  â”Š78â”Š  });\n+â”Š  â”Š79â”Š}\n```\n\n[}]: #\n\nWe will also use the exported `writeMessage()` function in the `ChatRoomScreen` so we won't have any code duplications:\n\n[{]: <helper> (diffStep 10.4 files=\"ChatRoom\" module=\"client\")\n\n#### Client Step 10.4: Update cache on message added\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -1,4 +1,3 @@\n-â”Š1â”Š â”Šimport { defaultDataIdFromObject } from 'apollo-cache-inmemory';\n â”Š2â”Š1â”Šimport gql from 'graphql-tag';\n â”Š3â”Š2â”Šimport React from 'react';\n â”Š4â”Š3â”Šimport { useCallback } from 'react';\n```\n```diff\n@@ -8,8 +7,8 @@\n â”Š 8â”Š 7â”Šimport MessagesList from './MessagesList';\n â”Š 9â”Š 8â”Šimport { History } from 'history';\n â”Š10â”Š 9â”Šimport { useGetChatQuery, useAddMessageMutation } from '../../graphql/types';\n-â”Š11â”Š  â”Šimport * as queries from '../../graphql/queries';\n â”Š12â”Š10â”Šimport * as fragments from '../../graphql/fragments';\n+â”Š  â”Š11â”Šimport { writeMessage } from '../../services/cache.service';\n â”Š13â”Š12â”Š\n â”Š14â”Š13â”Š const Container = styled.div `\n â”Š15â”Š14â”Š  background: url(/assets/chat-background.jpg);\n```\n```diff\n@@ -42,10 +41,6 @@\n â”Š42â”Š41â”Š  chatId: string\n â”Š43â”Š42â”Š  history: History;\n â”Š44â”Š43â”Š};\n-â”Š45â”Š  â”Š\n-â”Š46â”Š  â”Šinterface ChatsResult {\n-â”Š47â”Š  â”Š  chats: any[];\n-â”Š48â”Š  â”Š}\n â”Š49â”Š44â”Š\n â”Š50â”Š45â”Šconst ChatRoomScreen: React.FC<ChatRoomScreenParams> = ({ history, chatId }) => {\n â”Š51â”Š46â”Š  const { data, loading } = useGetChatQuery({\n```\n```diff\n@@ -72,62 +67,9 @@\n â”Š 72â”Š 67â”Š        }\n â”Š 73â”Š 68â”Š      },\n â”Š 74â”Š 69â”Š      update: (client, { data: { addMessage } }) => {\n-â”Š 75â”Š   â”Š        type FullChat = { [key: string]: any };\n-â”Š 76â”Š   â”Š        let fullChat;\n-â”Š 77â”Š   â”Š        const chatIdFromStore = defaultDataIdFromObject(chat);\n-â”Š 78â”Š   â”Š\n-â”Š 79â”Š   â”Š        if (chatIdFromStore === null) { return; }\n-â”Š 80â”Š   â”Š\n-â”Š 81â”Š   â”Š        try {\n-â”Š 82â”Š   â”Š          fullChat = client.readFragment<FullChat>({\n-â”Š 83â”Š   â”Š            id: chatIdFromStore,\n-â”Š 84â”Š   â”Š            fragment: fragments.fullChat,\n-â”Š 85â”Š   â”Š            fragmentName: 'FullChat',\n-â”Š 86â”Š   â”Š          });\n-â”Š 87â”Š   â”Š        } catch (e) {\n-â”Š 88â”Š   â”Š          return;\n-â”Š 89â”Š   â”Š        }\n-â”Š 90â”Š   â”Š\n-â”Š 91â”Š   â”Š        if (fullChat === null) { return; }\n-â”Š 92â”Š   â”Š        if (fullChat.messages.some((m:any) => m.id === addMessage.id)) return;\n-â”Š 93â”Š   â”Š\n-â”Š 94â”Š   â”Š        fullChat.messages.push(addMessage);\n-â”Š 95â”Š   â”Š        fullChat.lastMessage = addMessage;\n-â”Š 96â”Š   â”Š\n-â”Š 97â”Š   â”Š        client.writeFragment({\n-â”Š 98â”Š   â”Š          id: chatIdFromStore,\n-â”Š 99â”Š   â”Š          fragment: fragments.fullChat,\n-â”Š100â”Š   â”Š          fragmentName: 'FullChat',\n-â”Š101â”Š   â”Š          data: fullChat,\n-â”Š102â”Š   â”Š        });\n-â”Š103â”Š   â”Š\n-â”Š104â”Š   â”Š        let data;\n-â”Š105â”Š   â”Š        try {\n-â”Š106â”Š   â”Š          data = client.readQuery<ChatsResult>({\n-â”Š107â”Š   â”Š            query: queries.chats,\n-â”Š108â”Š   â”Š          });\n-â”Š109â”Š   â”Š        } catch (e) {\n-â”Š110â”Š   â”Š          return;\n-â”Š111â”Š   â”Š        }\n-â”Š112â”Š   â”Š\n-â”Š113â”Š   â”Š        if (!data) return;\n-â”Š114â”Š   â”Š        const chats = data.chats;\n-â”Š115â”Š   â”Š        if (!chats) return;\n-â”Š116â”Š   â”Š\n-â”Š117â”Š   â”Š        const chatIndex = chats.findIndex((c:any) => c.id === chatId);\n-â”Š118â”Š   â”Š        if (chatIndex === -1) return;\n-â”Š119â”Š   â”Š        const chatWhereAdded = chats[chatIndex];\n-â”Š120â”Š   â”Š\n-â”Š121â”Š   â”Š        // The chat will appear at the top of the ChatsList component\n-â”Š122â”Š   â”Š        chats.splice(chatIndex, 1);\n-â”Š123â”Š   â”Š        chats.unshift(chatWhereAdded);\n-â”Š124â”Š   â”Š\n-â”Š125â”Š   â”Š        client.writeQuery({\n-â”Š126â”Š   â”Š          query: queries.chats,\n-â”Š127â”Š   â”Š          data: { chats: chats },\n-â”Š128â”Š   â”Š        });\n-â”Š129â”Š   â”Š      }\n-â”Š130â”Š   â”Š    });\n+â”Š   â”Š 70â”Š        writeMessage(client, addMessage);\n+â”Š   â”Š 71â”Š      },\n+â”Š   â”Š 72â”Š    })\n â”Š131â”Š 73â”Š  }, [data, chatId, addMessage]);\n â”Š132â”Š 74â”Š\n â”Š133â”Š 75â”Š  if (data === undefined) {\n```\n\n[}]: #\n\nOne thing missing that you might notice is that we're trying to retrieve the chat from the received message, unfortunately our GraphQL schema doesn't support it and we will need to add it. On the server, we will add a `chat` field to the `Message` type in the GraphQL schema, and we will implement a resolver which will lookup for the chat in the chats collection:\n\n[{]: <helper> (diffStep 7.7 module=\"server\")\n\n#### [Server Step 7.7: Add Message.chat resolver](https://github.com/Urigo/WhatsApp-Clone-Server/commit/19f77a3)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -5,6 +5,12 @@\n â”Š 5â”Š 5â”Šconst resolvers: Resolvers = {\n â”Š 6â”Š 6â”Š  Date: GraphQLDateTime,\n â”Š 7â”Š 7â”Š\n+â”Š  â”Š 8â”Š  Message: {\n+â”Š  â”Š 9â”Š    chat(message) {\n+â”Š  â”Š10â”Š      return chats.find(c => c.messages.some(m => m === message.id)) || null\n+â”Š  â”Š11â”Š    },\n+â”Š  â”Š12â”Š  },\n+â”Š  â”Š13â”Š\n â”Š 8â”Š14â”Š  Chat: {\n â”Š 9â”Š15â”Š    messages(chat) {\n â”Š10â”Š16â”Š      return messages.filter(m => chat.messages.includes(m.id))\n```\n\n##### Changed schema&#x2F;typeDefs.graphql\n```diff\n@@ -4,6 +4,7 @@\n â”Š 4â”Š 4â”Š  id: ID!\n â”Š 5â”Š 5â”Š  content: String!\n â”Š 6â”Š 6â”Š  createdAt: Date!\n+â”Š  â”Š 7â”Š  chat: Chat\n â”Š 7â”Š 8â”Š}\n â”Š 8â”Š 9â”Š\n â”Š 9â”Š10â”Štype Chat {\n```\n\n[}]: #\n\nNow that we have it supported we can update the `Message` fragment in the client to include that information. We don't need the entire chat, only its ID, since the fragment ID composition is done out of an ID and type name:\n\n[{]: <helper> (diffStep 10.5 module=\"client\")\n\n#### Client Step 10.5: Add chat.id to message fragment\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -63,6 +63,10 @@\n â”Š63â”Š63â”Š          __typename: 'Message',\n â”Š64â”Š64â”Š          id: Math.random().toString(36).substr(2, 9),\n â”Š65â”Š65â”Š          createdAt: new Date(),\n+â”Š  â”Š66â”Š          chat: {\n+â”Š  â”Š67â”Š            __typename: 'Chat',\n+â”Š  â”Š68â”Š            id: chatId,\n+â”Š  â”Š69â”Š          },\n â”Š66â”Š70â”Š          content,\n â”Š67â”Š71â”Š        }\n â”Š68â”Š72â”Š      },\n```\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.test.tsx\n```diff\n@@ -30,6 +30,10 @@\n â”Š30â”Š30â”Š                  id: 1,\n â”Š31â”Š31â”Š                  content: 'Hello',\n â”Š32â”Š32â”Š                  createdAt: new Date('14 Jun 2017 00:00:00 PDT').toUTCString(),\n+â”Š  â”Š33â”Š                  chat: {\n+â”Š  â”Š34â”Š                    __typename: 'Chat',\n+â”Š  â”Š35â”Š                    id: 1,\n+â”Š  â”Š36â”Š                  },\n â”Š33â”Š37â”Š                },\n â”Š34â”Š38â”Š              },\n â”Š35â”Š39â”Š            ],\n```\n```diff\n@@ -71,6 +75,10 @@\n â”Š71â”Š75â”Š                  id: 1,\n â”Š72â”Š76â”Š                  content: 'Hello',\n â”Š73â”Š77â”Š                  createdAt: new Date(0),\n+â”Š  â”Š78â”Š                  chat: {\n+â”Š  â”Š79â”Š                    __typename: 'Chat',\n+â”Š  â”Š80â”Š                    id: 1,\n+â”Š  â”Š81â”Š                  },\n â”Š74â”Š82â”Š                },\n â”Š75â”Š83â”Š              },\n â”Š76â”Š84â”Š            ],\n```\n\n##### Changed src&#x2F;graphql&#x2F;fragments&#x2F;message.fragment.ts\n```diff\n@@ -5,5 +5,8 @@\n â”Š 5â”Š 5â”Š    id\n â”Š 6â”Š 6â”Š    createdAt\n â”Š 7â”Š 7â”Š    content\n+â”Š  â”Š 8â”Š    chat {\n+â”Š  â”Š 9â”Š      id\n+â”Š  â”Š10â”Š    }\n â”Š 8â”Š11â”Š  }\n â”Š 9â”Š12â”Š`;\n```\n\n[}]: #\n\nFinally, we will import the `useCacheService` React hook that we've just created and we will use it in our main `App` component. This means that the cache service will start listening for changes right as the app component is mounted:\n\n[{]: <helper> (diffStep 10.6 module=\"client\")\n\n#### Client Step 10.6: Use cache service\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -3,21 +3,26 @@\n â”Š 3â”Š 3â”Šimport ChatRoomScreen from './components/ChatRoomScreen';\n â”Š 4â”Š 4â”Šimport ChatsListScreen from './components/ChatsListScreen';\n â”Š 5â”Š 5â”Šimport AnimatedSwitch from './components/AnimatedSwitch';\n+â”Š  â”Š 6â”Šimport { useCacheService } from './services/cache.service';\n â”Š 6â”Š 7â”Š\n-â”Š 7â”Š  â”Šconst App: React.FC = () => (\n-â”Š 8â”Š  â”Š  <BrowserRouter>\n-â”Š 9â”Š  â”Š    <AnimatedSwitch>\n-â”Š10â”Š  â”Š      <Route exact path=\"/chats\" component={ChatsListScreen} />\n+â”Š  â”Š 8â”Šconst App: React.FC = () => {\n+â”Š  â”Š 9â”Š  useCacheService();\n â”Š11â”Š10â”Š\n-â”Š12â”Š  â”Š      <Route exact path=\"/chats/:chatId\" component={\n-â”Š13â”Š  â”Š        ({ match, history }: RouteComponentProps<{ chatId: string }>) =>\n-â”Š14â”Š  â”Š        (<ChatRoomScreen chatId={match.params.chatId} history={history} />)\n-â”Š15â”Š  â”Š      } />\n+â”Š  â”Š11â”Š  return (\n+â”Š  â”Š12â”Š    <BrowserRouter>\n+â”Š  â”Š13â”Š      <AnimatedSwitch>\n+â”Š  â”Š14â”Š        <Route exact path=\"/chats\" component={ChatsListScreen} />\n â”Š16â”Š15â”Š\n-â”Š17â”Š  â”Š    </AnimatedSwitch>\n-â”Š18â”Š  â”Š    <Route exact path=\"/\" render={redirectToChats} />\n-â”Š19â”Š  â”Š  </BrowserRouter>\n-â”Š20â”Š  â”Š);\n+â”Š  â”Š16â”Š        <Route exact path=\"/chats/:chatId\" component={\n+â”Š  â”Š17â”Š          ({ match, history }: RouteComponentProps<{ chatId: string }>) =>\n+â”Š  â”Š18â”Š          (<ChatRoomScreen chatId={match.params.chatId} history={history} />)\n+â”Š  â”Š19â”Š        } />\n+â”Š  â”Š20â”Š\n+â”Š  â”Š21â”Š      </AnimatedSwitch>\n+â”Š  â”Š22â”Š      <Route exact path=\"/\" render={redirectToChats} />\n+â”Š  â”Š23â”Š    </BrowserRouter>\n+â”Š  â”Š24â”Š  );\n+â”Š  â”Š25â”Š};\n â”Š21â”Š26â”Š\n â”Š22â”Š27â”Šconst redirectToChats = () => (\n â”Š23â”Š28â”Š  <Redirect to=\"/chats\" />\n```\n\n[}]: #\n\nSubscription handling is complete! If you'll try to repeat the same process again where you check messages updating between 2 instances of the app, you should see them both update.\n\n-------\n\nTODO: `useCacheService` shouldnâ€™t be called like that since itâ€™s related to message events and cache updates are only side-effects."
          },
          {
            "manualTitle": "Step 11: Users",
            "stepRevision": "689df04c93f5d49a946de533243bbf71d328fd91",
            "manualView": "Our chat app is pretty functional. We can pick a chat from the chats list and we can send messages. It's not hard to notice that one of the most important mechanisms is missing, which is relating a chat or a message to a specific user. Even though we can send messages, it's basically pointless unless someone else receives it. In this chapter we will create a new users collection with pre-defined documents and we will learn how to simulate authentication programmatically so we can test the new mechanism.\n\n**Reshaping the back-end**\n\nTo implement this feature we need to rethink our back-end and reshape the way our GraphQL schema is structured. Right now we only have 2 entities: Chat and Message, which are connected like so:\n\n\n\n![chat-message-orm](https://user-images.githubusercontent.com/7648874/55325929-0faa1b00-54b9-11e9-8868-7a8ed3edcda1.png)\n\n\nWe want to have a new User entity where each user will have Chats he participates in and Messages he owns. Therefore, our new GraphQL schema should look like something like this:\n\n\n\n![chat-message-user-orm](https://user-images.githubusercontent.com/7648874/55325935-146ecf00-54b9-11e9-8c0f-bc3b63cbe676.png)\n\nThis change would require us to update the GraphQL type definitions and handlers, the DB models, and the codegen configuration file:\n\n[{]: <helper> (diffStep 8.1 module=\"server\")\n\n#### [Server Step 8.1: Add User type](https://github.com/Urigo/WhatsApp-Clone-Server/commit/8400014)\n\n##### Changed codegen.yml\n```diff\n@@ -10,6 +10,7 @@\n â”Š10â”Š10â”Š      mappers:\n â”Š11â”Š11â”Š        # import { Message } from '../db'\n â”Š12â”Š12â”Š        # The root types of Message resolvers\n+â”Š  â”Š13â”Š        User: ../db#User\n â”Š13â”Š14â”Š        Message: ../db#Message\n â”Š14â”Š15â”Š        Chat: ../db#Chat\n â”Š15â”Š16â”Š      scalars:\n```\n\n##### Changed db.ts\n```diff\n@@ -1,66 +1,106 @@\n+â”Š   â”Š  1â”Šexport type User = {\n+â”Š   â”Š  2â”Š  id: string\n+â”Š   â”Š  3â”Š  name: string\n+â”Š   â”Š  4â”Š  picture: string\n+â”Š   â”Š  5â”Š}\n+â”Š   â”Š  6â”Š\n â”Š  1â”Š  7â”Šexport type Message = {\n â”Š  2â”Š  8â”Š  id: string\n â”Š  3â”Š  9â”Š  content: string\n â”Š  4â”Š 10â”Š  createdAt: Date\n+â”Š   â”Š 11â”Š  sender: string\n+â”Š   â”Š 12â”Š  recipient: string\n â”Š  5â”Š 13â”Š}\n â”Š  6â”Š 14â”Š\n â”Š  7â”Š 15â”Šexport type Chat = {\n â”Š  8â”Š 16â”Š  id: string\n-â”Š  9â”Š   â”Š  name: string\n-â”Š 10â”Š   â”Š  picture: string\n â”Š 11â”Š 17â”Š  messages: string[]\n+â”Š   â”Š 18â”Š  participants: string[]\n â”Š 12â”Š 19â”Š}\n â”Š 13â”Š 20â”Š\n+â”Š   â”Š 21â”Šexport const users: User[] = []\n â”Š 14â”Š 22â”Šexport const messages: Message[] = []\n â”Š 15â”Š 23â”Šexport const chats: Chat[] = []\n â”Š 16â”Š 24â”Š\n â”Š 17â”Š 25â”Šexport const resetDb = () => {\n+â”Š   â”Š 26â”Š  users.splice(0, Infinity, ...[\n+â”Š   â”Š 27â”Š    {\n+â”Š   â”Š 28â”Š      id: '1',\n+â”Š   â”Š 29â”Š      name: 'Ray Edwards',\n+â”Š   â”Š 30â”Š      picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n+â”Š   â”Š 31â”Š    },\n+â”Š   â”Š 32â”Š    {\n+â”Š   â”Š 33â”Š      id: '2',\n+â”Š   â”Š 34â”Š      name: 'Ethan Gonzalez',\n+â”Š   â”Š 35â”Š      picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n+â”Š   â”Š 36â”Š    },\n+â”Š   â”Š 37â”Š    {\n+â”Š   â”Š 38â”Š      id: '3',\n+â”Š   â”Š 39â”Š      name: 'Bryan Wallace',\n+â”Š   â”Š 40â”Š      picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n+â”Š   â”Š 41â”Š    },\n+â”Š   â”Š 42â”Š    {\n+â”Š   â”Š 43â”Š      id: '4',\n+â”Š   â”Š 44â”Š      name: 'Avery Stewart',\n+â”Š   â”Š 45â”Š      picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n+â”Š   â”Š 46â”Š    },\n+â”Š   â”Š 47â”Š    {\n+â”Š   â”Š 48â”Š      id: '5',\n+â”Š   â”Š 49â”Š      name: 'Katie Peterson',\n+â”Š   â”Š 50â”Š      picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n+â”Š   â”Š 51â”Š    },\n+â”Š   â”Š 52â”Š  ])\n+â”Š   â”Š 53â”Š\n â”Š 18â”Š 54â”Š  messages.splice(0, Infinity, ...[\n â”Š 19â”Š 55â”Š    {\n â”Š 20â”Š 56â”Š      id: '1',\n â”Š 21â”Š 57â”Š      content: \"You on your way?\",\n â”Š 22â”Š 58â”Š      createdAt: new Date(new Date('1-1-2019').getTime() - 60 * 1000 * 1000),\n+â”Š   â”Š 59â”Š      sender: '1',\n+â”Š   â”Š 60â”Š      recipient: '2',\n â”Š 23â”Š 61â”Š    },\n â”Š 24â”Š 62â”Š    {\n â”Š 25â”Š 63â”Š      id: '2',\n â”Š 26â”Š 64â”Š      content: \"Hey, it's me\",\n â”Š 27â”Š 65â”Š      createdAt: new Date(new Date('1-1-2019').getTime() - 2 * 60 * 1000 * 1000),\n+â”Š   â”Š 66â”Š      sender: '1',\n+â”Š   â”Š 67â”Š      recipient: '3',\n â”Š 28â”Š 68â”Š    },\n â”Š 29â”Š 69â”Š    {\n â”Š 30â”Š 70â”Š      id: '3',\n â”Š 31â”Š 71â”Š      content: \"I should buy a boat\",\n â”Š 32â”Š 72â”Š      createdAt: new Date(new Date('1-1-2019').getTime() - 24 * 60 * 1000 * 1000),\n+â”Š   â”Š 73â”Š      sender: '1',\n+â”Š   â”Š 74â”Š      recipient: '4',\n â”Š 33â”Š 75â”Š    },\n â”Š 34â”Š 76â”Š    {\n â”Š 35â”Š 77â”Š      id: '4',\n â”Š 36â”Š 78â”Š      content: \"This is wicked good ice cream.\",\n â”Š 37â”Š 79â”Š      createdAt: new Date(new Date('1-1-2019').getTime() - 14 * 24 * 60 * 1000 * 1000),\n+â”Š   â”Š 80â”Š      sender: '1',\n+â”Š   â”Š 81â”Š      recipient: '5',\n â”Š 38â”Š 82â”Š    },\n â”Š 39â”Š 83â”Š  ])\n â”Š 40â”Š 84â”Š\n â”Š 41â”Š 85â”Š  chats.splice(0, Infinity, ...[\n â”Š 42â”Š 86â”Š    {\n â”Š 43â”Š 87â”Š      id: '1',\n-â”Š 44â”Š   â”Š      name: 'Ethan Gonzalez',\n-â”Š 45â”Š   â”Š      picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n+â”Š   â”Š 88â”Š      participants: ['1', '2'],\n â”Š 46â”Š 89â”Š      messages: ['1'],\n â”Š 47â”Š 90â”Š    },\n â”Š 48â”Š 91â”Š    {\n â”Š 49â”Š 92â”Š      id: '2',\n-â”Š 50â”Š   â”Š      name: 'Bryan Wallace',\n-â”Š 51â”Š   â”Š      picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n+â”Š   â”Š 93â”Š      participants: ['1', '3'],\n â”Š 52â”Š 94â”Š      messages: ['2'],\n â”Š 53â”Š 95â”Š    },\n â”Š 54â”Š 96â”Š    {\n â”Š 55â”Š 97â”Š      id: '3',\n-â”Š 56â”Š   â”Š      name: 'Avery Stewart',\n-â”Š 57â”Š   â”Š      picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n+â”Š   â”Š 98â”Š      participants: ['1', '4'],\n â”Š 58â”Š 99â”Š      messages: ['3'],\n â”Š 59â”Š100â”Š    },\n â”Š 60â”Š101â”Š    {\n â”Š 61â”Š102â”Š      id: '4',\n-â”Š 62â”Š   â”Š      name: 'Katie Peterson',\n-â”Š 63â”Š   â”Š      picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n+â”Š   â”Š103â”Š      participants: ['1', '5'],\n â”Š 64â”Š104â”Š      messages: ['4'],\n â”Š 65â”Š105â”Š    },\n â”Š 66â”Š106â”Š  ])\n```\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,5 +1,5 @@\n â”Š1â”Š1â”Šimport { GraphQLDateTime } from 'graphql-iso-date'\n-â”Š2â”Š â”Šimport { Message, chats, messages } from '../db'\n+â”Š â”Š2â”Šimport { User, Message, chats, messages, users } from '../db'\n â”Š3â”Š3â”Šimport { Resolvers } from '../types/graphql'\n â”Š4â”Š4â”Š\n â”Š5â”Š5â”Šconst resolvers: Resolvers = {\n```\n```diff\n@@ -9,9 +9,27 @@\n â”Š 9â”Š 9â”Š    chat(message) {\n â”Š10â”Š10â”Š      return chats.find(c => c.messages.some(m => m === message.id)) || null\n â”Š11â”Š11â”Š    },\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Š    sender(message) {\n+â”Š  â”Š14â”Š      return users.find(u => u.id === message.sender) || null\n+â”Š  â”Š15â”Š    },\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š    recipient(message) {\n+â”Š  â”Š18â”Š      return users.find(u => u.id === message.recipient) || null\n+â”Š  â”Š19â”Š    },\n â”Š12â”Š20â”Š  },\n â”Š13â”Š21â”Š\n â”Š14â”Š22â”Š  Chat: {\n+â”Š  â”Š23â”Š    name() {\n+â”Š  â”Š24â”Š      // TODO: Resolve in relation to current user\n+â”Š  â”Š25â”Š      return null\n+â”Š  â”Š26â”Š    },\n+â”Š  â”Š27â”Š\n+â”Š  â”Š28â”Š    picture() {\n+â”Š  â”Š29â”Š      // TODO: Resolve in relation to current user\n+â”Š  â”Š30â”Š      return null\n+â”Š  â”Š31â”Š    },\n+â”Š  â”Š32â”Š\n â”Š15â”Š33â”Š    messages(chat) {\n â”Š16â”Š34â”Š      return messages.filter(m => chat.messages.includes(m.id))\n â”Š17â”Š35â”Š    },\n```\n```diff\n@@ -21,6 +39,10 @@\n â”Š21â”Š39â”Š\n â”Š22â”Š40â”Š      return messages.find(m => m.id === lastMessage) || null\n â”Š23â”Š41â”Š    },\n+â”Š  â”Š42â”Š\n+â”Š  â”Š43â”Š    participants(chat) {\n+â”Š  â”Š44â”Š      return chat.participants.map(p => users.find(u => u.id === p)).filter(Boolean) as User[]\n+â”Š  â”Š45â”Š    },\n â”Š24â”Š46â”Š  },\n â”Š25â”Š47â”Š\n â”Š26â”Š48â”Š  Query: {\n```\n```diff\n@@ -45,6 +67,8 @@\n â”Š45â”Š67â”Š      const message: Message = {\n â”Š46â”Š68â”Š        id: messageId,\n â”Š47â”Š69â”Š        createdAt: new Date(),\n+â”Š  â”Š70â”Š        sender: '', // TODO: Fill-in\n+â”Š  â”Š71â”Š        recipient: '', // TODO: Fill-in\n â”Š48â”Š72â”Š        content,\n â”Š49â”Š73â”Š      }\n â”Š50â”Š74â”Š\n```\n\n##### Changed schema&#x2F;typeDefs.graphql\n```diff\n@@ -1,18 +1,28 @@\n â”Š 1â”Š 1â”Šscalar Date\n â”Š 2â”Š 2â”Š\n+â”Š  â”Š 3â”Štype User {\n+â”Š  â”Š 4â”Š  id: ID!\n+â”Š  â”Š 5â”Š  name: String!\n+â”Š  â”Š 6â”Š  picture: String\n+â”Š  â”Š 7â”Š}\n+â”Š  â”Š 8â”Š\n â”Š 3â”Š 9â”Štype Message {\n â”Š 4â”Š10â”Š  id: ID!\n â”Š 5â”Š11â”Š  content: String!\n â”Š 6â”Š12â”Š  createdAt: Date!\n â”Š 7â”Š13â”Š  chat: Chat\n+â”Š  â”Š14â”Š  sender: User\n+â”Š  â”Š15â”Š  recipient: User\n+â”Š  â”Š16â”Š  isMine: Boolean!\n â”Š 8â”Š17â”Š}\n â”Š 9â”Š18â”Š\n â”Š10â”Š19â”Štype Chat {\n â”Š11â”Š20â”Š  id: ID!\n-â”Š12â”Š  â”Š  name: String!\n+â”Š  â”Š21â”Š  name: String\n â”Š13â”Š22â”Š  picture: String\n â”Š14â”Š23â”Š  lastMessage: Message\n â”Š15â”Š24â”Š  messages: [Message!]!\n+â”Š  â”Š25â”Š  participants: [User!]!\n â”Š16â”Š26â”Š}\n â”Š17â”Š27â”Š\n â”Š18â”Š28â”Štype Query {\n```\n\n[}]: #\n\nEven though we made these changes, the app remained the same. That's because the Query type haven't changed at all, and we still serve the same data as before. What we need to do is to edit the Query resolvers to serve data based on the user that is currently logged-in to the app in the current session. Before we go all in with a robust authentication system, it would be smarter to simulate it, so we can test our app and see that everything works as intended.\n\nFor now, let's assume that we're logged in with user of ID 1 - Ray Edwards. Codewise, this would mean that we will need to have the current user defined on the resolver context. In the main file, let's add the `currentUser` field to the context using a simple `find()` method from our `users` collection:\n\n[{]: <helper> (diffStep 8.2 files=\"index.ts\" module=\"server\")\n\n#### [Server Step 8.2: Resolve queries in relation to current user](https://github.com/Urigo/WhatsApp-Clone-Server/commit/5fc7bfd)\n\n##### Changed index.ts\n```diff\n@@ -3,6 +3,7 @@\n â”Š3â”Š3â”Šimport cors from 'cors'\n â”Š4â”Š4â”Šimport express from 'express'\n â”Š5â”Š5â”Šimport http from 'http'\n+â”Š â”Š6â”Šimport { users } from './db'\n â”Š6â”Š7â”Šimport schema from './schema'\n â”Š7â”Š8â”Š\n â”Š8â”Š9â”Šconst app = express()\n```\n```diff\n@@ -17,7 +18,10 @@\n â”Š17â”Š18â”Šconst pubsub = new PubSub()\n â”Š18â”Š19â”Šconst server = new ApolloServer({\n â”Š19â”Š20â”Š  schema,\n-â”Š20â”Š  â”Š  context: () => ({ pubsub }),\n+â”Š  â”Š21â”Š  context: () => ({\n+â”Š  â”Š22â”Š    currentUser: users.find(u => u.id === '1'),\n+â”Š  â”Š23â”Š    pubsub,\n+â”Š  â”Š24â”Š  }),\n â”Š21â”Š25â”Š})\n â”Š22â”Š26â”Š\n â”Š23â”Š27â”Šserver.applyMiddleware({\n```\n\n[}]: #\n\nAnd we will update the context type:\n\n[{]: <helper> (diffStep 8.2 files=\"context\" module=\"server\")\n\n#### [Server Step 8.2: Resolve queries in relation to current user](https://github.com/Urigo/WhatsApp-Clone-Server/commit/5fc7bfd)\n\n##### Changed context.ts\n```diff\n@@ -1,5 +1,7 @@\n â”Š1â”Š1â”Šimport { PubSub } from 'apollo-server-express'\n+â”Š â”Š2â”Šimport { User } from './db'\n â”Š2â”Š3â”Š\n â”Š3â”Š4â”Šexport type MyContext = {\n-â”Š4â”Š â”Š  pubsub: PubSub\n+â”Š â”Š5â”Š  pubsub: PubSub,\n+â”Š â”Š6â”Š  currentUser: User,\n â”Š5â”Š7â”Š}\n```\n\n[}]: #\n\nNow we will update the resolvers to fetch data relatively to the current user logged in. If there's no user logged in, the resolvers should return `null`, as the client is not authorized to view the data he requested:\n\n[{]: <helper> (diffStep 8.2 files=\"schema, tests\" module=\"server\")\n\n#### [Server Step 8.2: Resolve queries in relation to current user](https://github.com/Urigo/WhatsApp-Clone-Server/commit/5fc7bfd)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -17,17 +17,35 @@\n â”Š17â”Š17â”Š    recipient(message) {\n â”Š18â”Š18â”Š      return users.find(u => u.id === message.recipient) || null\n â”Š19â”Š19â”Š    },\n+â”Š  â”Š20â”Š\n+â”Š  â”Š21â”Š    isMine(message, args, { currentUser }) {\n+â”Š  â”Š22â”Š      return message.sender === currentUser.id\n+â”Š  â”Š23â”Š    },\n â”Š20â”Š24â”Š  },\n â”Š21â”Š25â”Š\n â”Š22â”Š26â”Š  Chat: {\n-â”Š23â”Š  â”Š    name() {\n-â”Š24â”Š  â”Š      // TODO: Resolve in relation to current user\n-â”Š25â”Š  â”Š      return null\n+â”Š  â”Š27â”Š    name(chat, args, { currentUser }) {\n+â”Š  â”Š28â”Š      if (!currentUser) return null\n+â”Š  â”Š29â”Š\n+â”Š  â”Š30â”Š      const participantId = chat.participants.find(p => p !== currentUser.id)\n+â”Š  â”Š31â”Š\n+â”Š  â”Š32â”Š      if (!participantId) return null\n+â”Š  â”Š33â”Š\n+â”Š  â”Š34â”Š      const participant = users.find(u => u.id === participantId)\n+â”Š  â”Š35â”Š\n+â”Š  â”Š36â”Š      return participant ? participant.name : null\n â”Š26â”Š37â”Š    },\n â”Š27â”Š38â”Š\n-â”Š28â”Š  â”Š    picture() {\n-â”Š29â”Š  â”Š      // TODO: Resolve in relation to current user\n-â”Š30â”Š  â”Š      return null\n+â”Š  â”Š39â”Š    picture(chat, args, { currentUser }) {\n+â”Š  â”Š40â”Š      if (!currentUser) return null\n+â”Š  â”Š41â”Š\n+â”Š  â”Š42â”Š      const participantId = chat.participants.find(p => p !== currentUser.id)\n+â”Š  â”Š43â”Š\n+â”Š  â”Š44â”Š      if (!participantId) return null\n+â”Š  â”Š45â”Š\n+â”Š  â”Š46â”Š      const participant = users.find(u => u.id === participantId)\n+â”Š  â”Š47â”Š\n+â”Š  â”Š48â”Š      return participant ? participant.picture : null\n â”Š31â”Š49â”Š    },\n â”Š32â”Š50â”Š\n â”Š33â”Š51â”Š    messages(chat) {\n```\n```diff\n@@ -46,29 +64,42 @@\n â”Š 46â”Š 64â”Š  },\n â”Š 47â”Š 65â”Š\n â”Š 48â”Š 66â”Š  Query: {\n-â”Š 49â”Š   â”Š    chats() {\n-â”Š 50â”Š   â”Š      return chats\n+â”Š   â”Š 67â”Š    chats(root, args, { currentUser }) {\n+â”Š   â”Š 68â”Š      if (!currentUser) return []\n+â”Š   â”Š 69â”Š\n+â”Š   â”Š 70â”Š      return chats.filter(c => c.participants.includes(currentUser.id))\n â”Š 51â”Š 71â”Š    },\n â”Š 52â”Š 72â”Š\n-â”Š 53â”Š   â”Š    chat(root, { chatId }) {\n-â”Š 54â”Š   â”Š      return chats.find(c => c.id === chatId) || null\n+â”Š   â”Š 73â”Š    chat(root, { chatId }, { currentUser }) {\n+â”Š   â”Š 74â”Š      if (!currentUser) return null\n+â”Š   â”Š 75â”Š\n+â”Š   â”Š 76â”Š      const chat = chats.find(c => c.id === chatId)\n+â”Š   â”Š 77â”Š\n+â”Š   â”Š 78â”Š      if (!chat) return null\n+â”Š   â”Š 79â”Š\n+â”Š   â”Š 80â”Š      return chat.participants.includes(currentUser.id) ? chat : null\n â”Š 55â”Š 81â”Š    },\n â”Š 56â”Š 82â”Š  },\n â”Š 57â”Š 83â”Š\n â”Š 58â”Š 84â”Š  Mutation: {\n-â”Š 59â”Š   â”Š    addMessage(root, { chatId, content }, { pubsub }) {\n+â”Š   â”Š 85â”Š    addMessage(root, { chatId, content }, { currentUser, pubsub }) {\n+â”Š   â”Š 86â”Š      if (!currentUser) return null\n+â”Š   â”Š 87â”Š\n â”Š 60â”Š 88â”Š      const chatIndex = chats.findIndex(c => c.id === chatId)\n â”Š 61â”Š 89â”Š\n â”Š 62â”Š 90â”Š      if (chatIndex === -1) return null\n â”Š 63â”Š 91â”Š\n â”Š 64â”Š 92â”Š      const chat = chats[chatIndex]\n+â”Š   â”Š 93â”Š\n+â”Š   â”Š 94â”Š      if (!chat.participants.includes(currentUser.id)) return null\n+â”Š   â”Š 95â”Š\n â”Š 65â”Š 96â”Š      const recentMessage = messages[messages.length - 1]\n â”Š 66â”Š 97â”Š      const messageId = String(Number(recentMessage.id) + 1)\n â”Š 67â”Š 98â”Š      const message: Message = {\n â”Š 68â”Š 99â”Š        id: messageId,\n â”Š 69â”Š100â”Š        createdAt: new Date(),\n-â”Š 70â”Š   â”Š        sender: '', // TODO: Fill-in\n-â”Š 71â”Š   â”Š        recipient: '', // TODO: Fill-in\n+â”Š   â”Š101â”Š        sender: currentUser.id,\n+â”Š   â”Š102â”Š        recipient: chat.participants.find(p => p !== currentUser.id) as string,\n â”Š 72â”Š103â”Š        content,\n â”Š 73â”Š104â”Š      }\n â”Š 74â”Š105â”Š\n```\n\n##### Changed tests&#x2F;mutations&#x2F;addMessage.test.ts\n```diff\n@@ -1,7 +1,7 @@\n â”Š1â”Š1â”Šimport { createTestClient } from 'apollo-server-testing'\n â”Š2â”Š2â”Šimport { ApolloServer, PubSub, gql } from 'apollo-server-express'\n â”Š3â”Š3â”Šimport schema from '../../schema'\n-â”Š4â”Š â”Šimport { resetDb } from '../../db'\n+â”Š â”Š4â”Šimport { resetDb, users } from '../../db'\n â”Š5â”Š5â”Š\n â”Š6â”Š6â”Šdescribe('Mutation.addMessage', () => {\n â”Š7â”Š7â”Š  beforeEach(resetDb)\n```\n```diff\n@@ -9,7 +9,10 @@\n â”Š 9â”Š 9â”Š  it('should add message to specified chat', async () => {\n â”Š10â”Š10â”Š    const server = new ApolloServer({\n â”Š11â”Š11â”Š      schema,\n-â”Š12â”Š  â”Š      context: () => ({ pubsub: new PubSub() }),\n+â”Š  â”Š12â”Š      context: () => ({\n+â”Š  â”Š13â”Š        pubsub: new PubSub(),\n+â”Š  â”Š14â”Š        currentUser: users[0],\n+â”Š  â”Š15â”Š      }),\n â”Š13â”Š16â”Š    })\n â”Š14â”Š17â”Š\n â”Š15â”Š18â”Š    const { query, mutate } = createTestClient(server)\n```\n\n##### Changed tests&#x2F;queries&#x2F;getChat.test.ts\n```diff\n@@ -1,10 +1,16 @@\n â”Š 1â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing'\n â”Š 2â”Š 2â”Šimport { ApolloServer, gql } from 'apollo-server-express'\n â”Š 3â”Š 3â”Šimport schema from '../../schema'\n+â”Š  â”Š 4â”Šimport { users } from '../../db'\n â”Š 4â”Š 5â”Š\n â”Š 5â”Š 6â”Šdescribe('Query.chat', () => {\n â”Š 6â”Š 7â”Š  it('should fetch specified chat', async () => {\n-â”Š 7â”Š  â”Š    const server = new ApolloServer({ schema })\n+â”Š  â”Š 8â”Š    const server = new ApolloServer({\n+â”Š  â”Š 9â”Š      schema,\n+â”Š  â”Š10â”Š      context: () => ({\n+â”Š  â”Š11â”Š        currentUser: users[0],\n+â”Š  â”Š12â”Š      }),\n+â”Š  â”Š13â”Š    })\n â”Š 8â”Š14â”Š\n â”Š 9â”Š15â”Š    const { query } = createTestClient(server)\n â”Š10â”Š16â”Š\n```\n\n##### Changed tests&#x2F;queries&#x2F;getChats.test.ts\n```diff\n@@ -1,10 +1,16 @@\n â”Š 1â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing'\n â”Š 2â”Š 2â”Šimport { ApolloServer, gql } from 'apollo-server-express'\n â”Š 3â”Š 3â”Šimport schema from '../../schema'\n+â”Š  â”Š 4â”Šimport { users } from '../../db'\n â”Š 4â”Š 5â”Š\n â”Š 5â”Š 6â”Šdescribe('Query.chats', () => {\n â”Š 6â”Š 7â”Š  it('should fetch all chats', async () => {\n-â”Š 7â”Š  â”Š    const server = new ApolloServer({ schema })\n+â”Š  â”Š 8â”Š    const server = new ApolloServer({\n+â”Š  â”Š 9â”Š      schema,\n+â”Š  â”Š10â”Š      context: () => ({\n+â”Š  â”Š11â”Š        currentUser: users[0],\n+â”Š  â”Š12â”Š      }),\n+â”Š  â”Š13â”Š    })\n â”Š 8â”Š14â”Š\n â”Š 9â”Š15â”Š    const { query } = createTestClient(server)\n```\n\n[}]: #\n\nNow if we will get back to the app and refresh the page, we should see a new chats list which is only relevant to Ray Edwards. Earlier in this chapter, we've defined a new `isMine` field on the `Message` type. This field is useful because now we can differentiate between messages that are mine and messages that belong to the recipient. We can use that information to distinct between messages in our UI.\n\nLet's first download a new image that will help us achieve the new style and save it under the [`src/public/assets/message-yours.png`](https://github.com/Urigo/WhatsApp-Clone-Client-React/blob/cordova/public/assets/message-other.png?raw=true) path. Then let's implement the new style:\n\n[{]: <helper> (diffStep 11.1 files=\"src/components\" module=\"client\")\n\n#### Client Step 11.1: Distinguish messages\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;MessagesList.tsx\n```diff\n@@ -2,7 +2,7 @@\n â”Š2â”Š2â”Šimport React from 'react';\n â”Š3â”Š3â”Šimport { useEffect, useRef } from 'react';\n â”Š4â”Š4â”Šimport ReactDOM from 'react-dom';\n-â”Š5â”Š â”Šimport styled from 'styled-components';\n+â”Š â”Š5â”Šimport styled, { css } from 'styled-components';\n â”Š6â”Š6â”Š\n â”Š7â”Š7â”Šconst Container = styled.div`\n â”Š8â”Š8â”Š  display: block;\n```\n```diff\n@@ -11,9 +11,11 @@\n â”Š11â”Š11â”Š  padding: 0 15px;\n â”Š12â”Š12â”Š`;\n â”Š13â”Š13â”Š\n+â”Š  â”Š14â”Štype StyledProp = {\n+â”Š  â”Š15â”Š  isMine: any;\n+â”Š  â”Š16â”Š};\n+â”Š  â”Š17â”Š\n â”Š14â”Š18â”Šconst MessageItem = styled.div `\n-â”Š15â”Š  â”Š  float: right;\n-â”Š16â”Š  â”Š  background-color: #dcf8c6;\n â”Š17â”Š19â”Š  display: inline-block;\n â”Š18â”Š20â”Š  position: relative;\n â”Š19â”Š21â”Š  max-width: 100%;\n```\n```diff\n@@ -30,17 +32,33 @@\n â”Š30â”Š32â”Š  }\n â”Š31â”Š33â”Š\n â”Š32â”Š34â”Š  &::before {\n-â”Š33â”Š  â”Š    background-image: url(/assets/message-mine.png);\n â”Š34â”Š35â”Š    content: '';\n â”Š35â”Š36â”Š    position: absolute;\n â”Š36â”Š37â”Š    bottom: 3px;\n â”Š37â”Š38â”Š    width: 12px;\n â”Š38â”Š39â”Š    height: 19px;\n-â”Š39â”Š  â”Š    right: -11px;\n â”Š40â”Š40â”Š    background-position: 50% 50%;\n â”Š41â”Š41â”Š    background-repeat: no-repeat;\n â”Š42â”Š42â”Š    background-size: contain;\n â”Š43â”Š43â”Š  }\n+â”Š  â”Š44â”Š\n+â”Š  â”Š45â”Š  ${(props: StyledProp) => props.isMine ? css `\n+â”Š  â”Š46â”Š    float: right;\n+â”Š  â”Š47â”Š    background-color: #dcf8c6;\n+â”Š  â”Š48â”Š\n+â”Š  â”Š49â”Š    &::before {\n+â”Š  â”Š50â”Š      right: -11px;\n+â”Š  â”Š51â”Š      background-image: url(/assets/message-mine.png);\n+â”Š  â”Š52â”Š    }\n+â”Š  â”Š53â”Š  ` : css `\n+â”Š  â”Š54â”Š    float: left;\n+â”Š  â”Š55â”Š    background-color: #fff;\n+â”Š  â”Š56â”Š\n+â”Š  â”Š57â”Š    &::before {\n+â”Š  â”Š58â”Š      left: -11px;\n+â”Š  â”Š59â”Š      background-image: url(/assets/message-other.png);\n+â”Š  â”Š60â”Š    }\n+â”Š  â”Š61â”Š  `}\n â”Š44â”Š62â”Š`;\n â”Š45â”Š63â”Š\n â”Š46â”Š64â”Šconst Contents = styled.div `\n```\n```diff\n@@ -75,21 +93,24 @@\n â”Š 75â”Š 93â”Š\n â”Š 76â”Š 94â”Š  useEffect(() => {\n â”Š 77â”Š 95â”Š    if (!selfRef.current) return;\n-â”Š 78â”Š   â”Š\n-â”Š 79â”Š   â”Š     const selfDOMNode = ReactDOM.findDOMNode(selfRef.current) as HTMLElement;\n+â”Š   â”Š 96â”Š    const selfDOMNode = ReactDOM.findDOMNode(selfRef.current) as HTMLElement;\n â”Š 80â”Š 97â”Š    selfDOMNode.scrollTop = Number.MAX_SAFE_INTEGER;\n â”Š 81â”Š 98â”Š  }, [messages.length]);\n-â”Š 82â”Š   â”Š\n+â”Š   â”Š 99â”Š\n â”Š 83â”Š100â”Š  return (\n â”Š 84â”Š101â”Š    <Container ref={selfRef}>\n â”Š 85â”Š102â”Š      {messages.map((message: any) => (\n-â”Š 86â”Š   â”Š        <MessageItem data-testid=\"message-item\" key={message.id}>\n+â”Š   â”Š103â”Š        <MessageItem\n+â”Š   â”Š104â”Š          data-testid=\"message-item\"\n+â”Š   â”Š105â”Š          isMine={message.isMine}\n+â”Š   â”Š106â”Š          key={message.id}\n+â”Š   â”Š107â”Š        >\n â”Š 87â”Š108â”Š          <Contents data-testid=\"message-content\">{message.content}</Contents>\n â”Š 88â”Š109â”Š          <Timestamp data-testid=\"message-date\">{moment(message.createdAt).format('HH:mm')}</Timestamp>\n â”Š 89â”Š110â”Š        </MessageItem>\n â”Š 90â”Š111â”Š      ))}\n â”Š 91â”Š112â”Š    </Container>\n-â”Š 92â”Š   â”Š  )\n+â”Š   â”Š113â”Š  );\n â”Š 93â”Š114â”Š};\n â”Š 94â”Š115â”Š\n â”Š 95â”Š116â”Šexport default MessagesList;ðŸš«â†µ\n```\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -63,6 +63,7 @@\n â”Š63â”Š63â”Š          __typename: 'Message',\n â”Š64â”Š64â”Š          id: Math.random().toString(36).substr(2, 9),\n â”Š65â”Š65â”Š          createdAt: new Date(),\n+â”Š  â”Š66â”Š          isMine: true,\n â”Š66â”Š67â”Š          chat: {\n â”Š67â”Š68â”Š            __typename: 'Chat',\n â”Š68â”Š69â”Š            id: chatId,\n```\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.test.tsx\n```diff\n@@ -30,6 +30,7 @@\n â”Š30â”Š30â”Š                  id: 1,\n â”Š31â”Š31â”Š                  content: 'Hello',\n â”Š32â”Š32â”Š                  createdAt: new Date('14 Jun 2017 00:00:00 PDT').toUTCString(),\n+â”Š  â”Š33â”Š                  isMine: true,\n â”Š33â”Š34â”Š                  chat: {\n â”Š34â”Š35â”Š                    __typename: 'Chat',\n â”Š35â”Š36â”Š                    id: 1,\n```\n```diff\n@@ -75,6 +76,7 @@\n â”Š75â”Š76â”Š                  id: 1,\n â”Š76â”Š77â”Š                  content: 'Hello',\n â”Š77â”Š78â”Š                  createdAt: new Date(0),\n+â”Š  â”Š79â”Š                  isMine: true,\n â”Š78â”Š80â”Š                  chat: {\n â”Š79â”Š81â”Š                    __typename: 'Chat',\n â”Š80â”Š82â”Š                    id: 1,\n```\n\n[}]: #\n\nThis is how the updated `ChatRoomScreen` should look like:\n\n\n\n![chat-room-screen](https://user-images.githubusercontent.com/7648874/55326701-face8700-54ba-11e9-877e-0b7dd71a1b68.png)\n\n\n\nWe can use a temporary solution to log-in and alternate between different users. This would be a good way to test data authorization without implementing an authentication mechanism. One way to know which user is logged in is via [cookies](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies).\n\nCookies are just text files which are stored locally on your computer and they contain key-value data maps. Cookies will be sent automatically by the browser with every HTTP request under the `Cookie` header. The header can be parsed and read by the server and this way inform it about the state of the client. Cookie values can also be set by the server by sending back a response which contain a `Set-Cookie` header. The browser will automatically write these cookies because of its specification and how it works.\n\nThis is how you can set cookies on the client:\n\n```js\ndocument.cookie = \"yummy_cookie=choco\"\ndocument.cookie = \"tasty_cookie=strawberry\"\n// logs \"yummy_cookie=choco; tasty_cookie=strawberry\"\n```\n\nAnd this is how further requests would look like:\n\n```\nGET /sample_page.html HTTP/2.0\nHost: www.example.org\nCookie: yummy_cookie=choco; tasty_cookie=strawberry\n```\n\nUsing this method we can set the current user's ID. Open your browser's dev-console, and type the following:\n\n```js\n// Ray Edwards\ndocument.cookie = 'currentUserId=1'\n```\n\nTo be able to send cookies with Apollo Client, we need to set the [`credentials`](https://www.apollographql.com/docs/react/recipes/authentication#cookie) option to \"include\" when creating the HTTP link:\n\n[{]: <helper> (diffStep 11.2 module=\"client\")\n\n#### Client Step 11.2: Support credentials\n\n##### Changed src&#x2F;client.ts\n```diff\n@@ -10,6 +10,7 @@\n â”Š10â”Š10â”Š\n â”Š11â”Š11â”Šconst httpLink = new HttpLink({\n â”Š12â”Š12â”Š  uri: httpUri,\n+â”Š  â”Š13â”Š  credentials: 'include',\n â”Š13â”Š14â”Š});\n â”Š14â”Š15â”Š\n â”Š15â”Š16â”Šconst wsLink = new WebSocketLink({\n```\n\n[}]: #\n\nThis will set the [`Access-Control-Allow-Credentials`](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Credentials) header to â€œincludeâ€ with each HTTP request which is necessary when using the POST method. In correlation to that, we would need to configure the server to be able to receive and set cookies. This can be done via CORS options like so:\n\n[{]: <helper> (diffStep 8.4 files=\"index.ts\" module=\"server\")\n\n#### [Server Step 8.4: Support credentials](https://github.com/Urigo/WhatsApp-Clone-Server/commit/44bf4c2)\n\n##### Changed index.ts\n```diff\n@@ -8,7 +8,8 @@\n â”Š 8â”Š 8â”Š\n â”Š 9â”Š 9â”Šconst app = express()\n â”Š10â”Š10â”Š\n-â”Š11â”Š  â”Šapp.use(cors())\n+â”Š  â”Š11â”Šconst origin = process.env.ORIGIN || 'http://localhost:3000'\n+â”Š  â”Š12â”Šapp.use(cors({ credentials: true, origin }))\n â”Š12â”Š13â”Šapp.use(bodyParser.json())\n â”Š13â”Š14â”Š\n â”Š14â”Š15â”Šapp.get('/_ping', (req, res) => {\n```\n```diff\n@@ -27,6 +28,7 @@\n â”Š27â”Š28â”Šserver.applyMiddleware({\n â”Š28â”Š29â”Š  app,\n â”Š29â”Š30â”Š  path: '/graphql',\n+â”Š  â”Š31â”Š  cors: { credentials: true, origin },\n â”Š30â”Š32â”Š})\n â”Š31â”Š33â”Š\n â”Š32â”Š34â”Šconst httpServer = http.createServer(app)\n```\n\n[}]: #\n\nSo how exactly does one retrieve the values of the cookies? Like mentioned earlier, each and every request will have them set on the `cookie` header, so one way would be by reading the header directly, but a more convenient way would be using an Express middleware called [`cookie-parser`](https://www.npmjs.com/package/cookie-parser):\n\n    $ yarn add cookie-parser\n\n[{]: <helper> (diffStep 8.5 files=\"index.ts\" module=\"server\")\n\n#### [Server Step 8.5: Use cookie parser](https://github.com/Urigo/WhatsApp-Clone-Server/commit/ac3a481)\n\n##### Changed index.ts\n```diff\n@@ -1,6 +1,7 @@\n â”Š1â”Š1â”Šimport { ApolloServer, gql, PubSub } from 'apollo-server-express'\n â”Š2â”Š2â”Šimport bodyParser from 'body-parser'\n â”Š3â”Š3â”Šimport cors from 'cors'\n+â”Š â”Š4â”Šimport cookieParser from 'cookie-parser'\n â”Š4â”Š5â”Šimport express from 'express'\n â”Š5â”Š6â”Šimport http from 'http'\n â”Š6â”Š7â”Šimport { users } from './db'\n```\n```diff\n@@ -11,6 +12,7 @@\n â”Š11â”Š12â”Šconst origin = process.env.ORIGIN || 'http://localhost:3000'\n â”Š12â”Š13â”Šapp.use(cors({ credentials: true, origin }))\n â”Š13â”Š14â”Šapp.use(bodyParser.json())\n+â”Š  â”Š15â”Šapp.use(cookieParser())\n â”Š14â”Š16â”Š\n â”Š15â”Š17â”Šapp.get('/_ping', (req, res) => {\n â”Š16â”Š18â”Š  res.send('pong')\n```\n\n[}]: #\n\n`cookie-parser` will read the `Cookie` header, it will parse it into a JSON and will define it on `req.cookies`. Since weâ€™re using Apollo-Server with Express, the `req` object should be accessible as the first argument in the `context` function. This means that we can use the `currentUserId` from the cookies to fetch the current user from our users collection and define it on the context object:\n\n[{]: <helper> (diffStep 8.6 module=\"server\")\n\n#### [Server Step 8.6: Define current user based on cookies](https://github.com/Urigo/WhatsApp-Clone-Server/commit/9d9333f)\n\n##### Changed index.ts\n```diff\n@@ -21,8 +21,8 @@\n â”Š21â”Š21â”Šconst pubsub = new PubSub()\n â”Š22â”Š22â”Šconst server = new ApolloServer({\n â”Š23â”Š23â”Š  schema,\n-â”Š24â”Š  â”Š  context: () => ({\n-â”Š25â”Š  â”Š    currentUser: users.find(u => u.id === '1'),\n+â”Š  â”Š24â”Š  context: ({ req }) => ({\n+â”Š  â”Š25â”Š    currentUser: users.find(u => u.id === req.cookies.currentUserId),\n â”Š26â”Š26â”Š    pubsub,\n â”Š27â”Š27â”Š  }),\n â”Š28â”Š28â”Š})\n```\n\n[}]: #\n\nNow you can go ahead and change the value of the `currentUserId` cookie and see how it affects the view anytime you refresh the page. Needless to say that this is not the most convenient way to switch between users, so weâ€™re gonna implement a dedicated screen that will set the cookies for us.\n\nAll the auth related logic should go into a dedicated service since it can serve us vastly across the application, not just for a single component. Thus we will create a new service called `auth.service`, which will contain 3 basic functions for now: `signIn()`, `signOut()` and `isSignedIn():\n\n[{]: <helper> (diffStep 11.3 module=\"client\")\n\n#### Client Step 11.3: Add basic auth.service\n\n##### Added src&#x2F;services&#x2F;auth.service.tsx\n```diff\n@@ -0,0 +1,21 @@\n+â”Š  â”Š 1â”Šimport client from '../client';\n+â”Š  â”Š 2â”Š\n+â”Š  â”Š 3â”Šexport const signIn = (currentUserId: string) => {\n+â”Š  â”Š 4â”Š  document.cookie = `currentUserId=${currentUserId}`;\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Š  // This will become async in the near future\n+â”Š  â”Š 7â”Š  return Promise.resolve();\n+â”Š  â”Š 8â”Š};\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Šexport const signOut = () => {\n+â”Š  â”Š11â”Š  // \"expires\" represents the lifespan of a cookie. Beyond that date the cookie will\n+â”Š  â”Š12â”Š  // be deleted by the browser. \"expires\" cannot be viewed from \"document.cookie\"\n+â”Š  â”Š13â”Š  document.cookie = `currentUserId=;expires=${new Date(0)}`;\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”Š  // Clear cache\n+â”Š  â”Š16â”Š  return client.clearStore();\n+â”Š  â”Š17â”Š};\n+â”Š  â”Š18â”Š\n+â”Š  â”Š19â”Šexport const isSignedIn = () => {\n+â”Š  â”Š20â”Š  return /currentUserId=.+(;|$)/.test(document.cookie);\n+â”Š  â”Š21â”Š};ðŸš«â†µ\n```\n\n[}]: #\n\nNow we will implement the `AuthScreen`. For now this screen should be fairly simple. It should contain a single `TextField` to specify the current user ID, and a `sign-in` button that will call the `signIn()` method with the specified ID. Once it does so, we will be proceeded to the `ChatsListScreen`. First we will download and save the following assets:\n\n- [`src/public/assets/whatsapp-icon.ping`](https://github.com/Urigo/WhatsApp-Clone-Client-React/raw/wip/cookie-auth/public/assets/whatsapp-icon.png)\n\n[{]: <helper> (diffStep 11.4 files=\"components\" module=\"client\")\n\n#### Client Step 11.4: Add AuthScreen\n\n##### Added src&#x2F;components&#x2F;AuthScreen&#x2F;index.tsx\n```diff\n@@ -0,0 +1,168 @@\n+â”Š   â”Š  1â”Šimport MaterialButton from '@material-ui/core/Button';\n+â”Š   â”Š  2â”Šimport MaterialTextField from '@material-ui/core/TextField';\n+â”Š   â”Š  3â”Šimport React from 'react';\n+â”Š   â”Š  4â”Šimport { useCallback, useState } from 'react';\n+â”Š   â”Š  5â”Šimport styled from 'styled-components';\n+â”Š   â”Š  6â”Šimport { signIn } from '../../services/auth.service';\n+â”Š   â”Š  7â”Šimport { RouteComponentProps } from 'react-router-dom';\n+â”Š   â”Š  8â”Š\n+â”Š   â”Š  9â”Šconst Container = styled.div `\n+â”Š   â”Š 10â”Š  height: 100%;\n+â”Š   â”Š 11â”Š  background: radial-gradient(rgb(34, 65, 67), rgb(17, 48, 50)),\n+â”Š   â”Š 12â”Š    url(/assets/chat-background.jpg) no-repeat;\n+â”Š   â”Š 13â”Š  background-size: cover;\n+â”Š   â”Š 14â”Š  background-blend-mode: multiply;\n+â”Š   â”Š 15â”Š  color: white;\n+â”Š   â”Š 16â”Š`;\n+â”Š   â”Š 17â”Š\n+â”Š   â”Š 18â”Šconst Intro = styled.div `\n+â”Š   â”Š 19â”Š  height: 265px;\n+â”Š   â”Š 20â”Š`;\n+â”Š   â”Š 21â”Š\n+â”Š   â”Š 22â”Šconst Icon = styled.img `\n+â”Š   â”Š 23â”Š  width: 125px;\n+â”Š   â”Š 24â”Š  height: auto;\n+â”Š   â”Š 25â”Š  margin-left: auto;\n+â”Š   â”Š 26â”Š  margin-right: auto;\n+â”Š   â”Š 27â”Š  padding-top: 70px;\n+â”Š   â”Š 28â”Š  display: block;\n+â”Š   â”Š 29â”Š`;\n+â”Š   â”Š 30â”Š\n+â”Š   â”Š 31â”Šconst Title = styled.h2 `\n+â”Š   â”Š 32â”Š  width: 100%;\n+â”Š   â”Š 33â”Š  text-align: center;\n+â”Š   â”Š 34â”Š  color: white;\n+â”Š   â”Š 35â”Š`;\n+â”Š   â”Š 36â”Š\n+â”Š   â”Š 37â”Š// eslint-disable-next-line\n+â”Š   â”Š 38â”Šconst Alternative = styled.div `\n+â”Š   â”Š 39â”Š  position: fixed;\n+â”Š   â”Š 40â”Š  bottom: 10px;\n+â”Š   â”Š 41â”Š  left: 10px;\n+â”Š   â”Š 42â”Š\n+â”Š   â”Š 43â”Š  a {\n+â”Š   â”Š 44â”Š    color: var(--secondary-bg);\n+â”Š   â”Š 45â”Š  }\n+â”Š   â”Š 46â”Š`;\n+â”Š   â”Š 47â”Š\n+â”Š   â”Š 48â”Šconst SignInForm = styled.div `\n+â”Š   â”Š 49â”Š  height: calc(100% - 265px);\n+â”Š   â”Š 50â”Š`;\n+â”Š   â”Š 51â”Š\n+â”Š   â”Š 52â”Šconst ActualForm = styled.form `\n+â”Š   â”Š 53â”Š  padding: 20px;\n+â”Š   â”Š 54â”Š`;\n+â”Š   â”Š 55â”Š\n+â”Š   â”Š 56â”Šconst Section = styled.div `\n+â”Š   â”Š 57â”Š  width: 100%;\n+â”Š   â”Š 58â”Š  padding-bottom: 35px;\n+â”Š   â”Š 59â”Š`;\n+â”Š   â”Š 60â”Š\n+â”Š   â”Š 61â”Šconst Legend = styled.legend `\n+â”Š   â”Š 62â”Š  font-weight: bold;\n+â”Š   â”Š 63â”Š  color: white;\n+â”Š   â”Š 64â”Š`;\n+â”Š   â”Š 65â”Š\n+â”Š   â”Š 66â”Š// eslint-disable-next-line\n+â”Š   â”Š 67â”Šconst Label = styled.label `\n+â”Š   â”Š 68â”Š  color: white !important;\n+â”Š   â”Š 69â”Š`;\n+â”Š   â”Š 70â”Š\n+â”Š   â”Š 71â”Š// eslint-disable-next-line\n+â”Š   â”Š 72â”Šconst Input = styled.input `\n+â”Š   â”Š 73â”Š  color: white;\n+â”Š   â”Š 74â”Š\n+â”Š   â”Š 75â”Š  &::placeholder {\n+â”Š   â”Š 76â”Š    color: var(--primary-bg);\n+â”Š   â”Š 77â”Š  }\n+â”Š   â”Š 78â”Š`;\n+â”Š   â”Š 79â”Š\n+â”Š   â”Š 80â”Šconst TextField = styled(MaterialTextField) `\n+â”Š   â”Š 81â”Š  width: 100%;\n+â”Š   â”Š 82â”Š  position: relative;\n+â”Š   â”Š 83â”Š\n+â”Š   â”Š 84â”Š  > div::before {\n+â”Š   â”Š 85â”Š    border-color: white !important;\n+â”Š   â”Š 86â”Š  }\n+â”Š   â”Š 87â”Š\n+â”Š   â”Š 88â”Š  input {\n+â”Š   â”Š 89â”Š    color: white !important;\n+â”Š   â”Š 90â”Š\n+â”Š   â”Š 91â”Š    &::placeholder {\n+â”Š   â”Š 92â”Š      color: var(--primary-bg) !important;\n+â”Š   â”Š 93â”Š    }\n+â”Š   â”Š 94â”Š  }\n+â”Š   â”Š 95â”Š\n+â”Š   â”Š 96â”Š  label {\n+â”Š   â”Š 97â”Š    color: white !important;\n+â”Š   â”Š 98â”Š  }\n+â”Š   â”Š 99â”Š` as typeof MaterialTextField;\n+â”Š   â”Š100â”Š\n+â”Š   â”Š101â”Šconst Button = styled(MaterialButton) `\n+â”Š   â”Š102â”Š  width: 100px;\n+â”Š   â”Š103â”Š  display: block !important;\n+â”Š   â”Š104â”Š  margin: auto !important;\n+â”Š   â”Š105â”Š  background-color: var(--secondary-bg) !important;\n+â”Š   â”Š106â”Š\n+â”Š   â”Š107â”Š  &[disabled] {\n+â”Š   â”Š108â”Š    color: #38a81c;\n+â”Š   â”Š109â”Š  }\n+â”Š   â”Š110â”Š\n+â”Š   â”Š111â”Š  &:not([disabled]) {\n+â”Š   â”Š112â”Š    color: white;\n+â”Š   â”Š113â”Š  }\n+â”Š   â”Š114â”Š` as typeof MaterialButton;\n+â”Š   â”Š115â”Š\n+â”Š   â”Š116â”Šconst AuthScreen: React.FC<RouteComponentProps<any>> = ({ history }) => {\n+â”Š   â”Š117â”Š  const [userId, setUserId] = useState('');\n+â”Š   â”Š118â”Š\n+â”Š   â”Š119â”Š  const onUserIdChange = useCallback(({ target }) => {\n+â”Š   â”Š120â”Š    setUserId(target.value);\n+â”Š   â”Š121â”Š  }, []);\n+â”Š   â”Š122â”Š\n+â”Š   â”Š123â”Š  const maySignIn = useCallback(() => {\n+â”Š   â”Š124â”Š    return !!userId\n+â”Š   â”Š125â”Š  }, [userId]);\n+â”Š   â”Š126â”Š\n+â”Š   â”Š127â”Š  const handleSignIn = useCallback(() => {\n+â”Š   â”Š128â”Š    signIn(userId).then(() => {\n+â”Š   â”Š129â”Š      history.replace('/chats')\n+â”Š   â”Š130â”Š    })\n+â”Š   â”Š131â”Š  }, [userId, history]);\n+â”Š   â”Š132â”Š\n+â”Š   â”Š133â”Š  return (\n+â”Š   â”Š134â”Š    <Container>\n+â”Š   â”Š135â”Š      <Intro>\n+â”Š   â”Š136â”Š        <Icon src=\"assets/whatsapp-icon.png\" className=\"AuthScreen-icon\" />\n+â”Š   â”Š137â”Š        <Title className=\"AuthScreen-title\">WhatsApp</Title>\n+â”Š   â”Š138â”Š      </Intro>\n+â”Š   â”Š139â”Š      <SignInForm>\n+â”Š   â”Š140â”Š        <ActualForm>\n+â”Š   â”Š141â”Š          <Legend>Sign in</Legend>\n+â”Š   â”Š142â”Š          <Section>\n+â”Š   â”Š143â”Š            <TextField\n+â”Š   â”Š144â”Š              data-testid=\"user-id-input\"\n+â”Š   â”Š145â”Š              label=\"User ID\"\n+â”Š   â”Š146â”Š              value={userId}\n+â”Š   â”Š147â”Š              onChange={onUserIdChange}\n+â”Š   â”Š148â”Š              margin=\"normal\"\n+â”Š   â”Š149â”Š              placeholder=\"Enter current user ID\"\n+â”Š   â”Š150â”Š            />\n+â”Š   â”Š151â”Š          </Section>\n+â”Š   â”Š152â”Š          <Button\n+â”Š   â”Š153â”Š            data-testid=\"sign-in-button\"\n+â”Š   â”Š154â”Š            type=\"button\"\n+â”Š   â”Š155â”Š            color=\"secondary\"\n+â”Š   â”Š156â”Š            variant=\"contained\"\n+â”Š   â”Š157â”Š            disabled={!maySignIn()}\n+â”Š   â”Š158â”Š            onClick={handleSignIn}\n+â”Š   â”Š159â”Š          >\n+â”Š   â”Š160â”Š            Sign in\n+â”Š   â”Š161â”Š          </Button>\n+â”Š   â”Š162â”Š        </ActualForm>\n+â”Š   â”Š163â”Š      </SignInForm>\n+â”Š   â”Š164â”Š    </Container>\n+â”Š   â”Š165â”Š  );\n+â”Š   â”Š166â”Š};\n+â”Š   â”Š167â”Š\n+â”Š   â”Š168â”Šexport default AuthScreen;ðŸš«â†µ\n```\n\n[}]: #\n\nAccordingly we will define a new `/sign-in` route that will render the `AuthScreen` weâ€™re under that path name:\n\n[{]: <helper> (diffStep 11.4 files=\"App\" module=\"client\")\n\n#### Client Step 11.4: Add AuthScreen\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -1,5 +1,6 @@\n â”Š1â”Š1â”Šimport React from 'react';\n â”Š2â”Š2â”Šimport { BrowserRouter, Route, Redirect, RouteComponentProps } from 'react-router-dom';\n+â”Š â”Š3â”Šimport AuthScreen from './components/AuthScreen';\n â”Š3â”Š4â”Šimport ChatRoomScreen from './components/ChatRoomScreen';\n â”Š4â”Š5â”Šimport ChatsListScreen from './components/ChatsListScreen';\n â”Š5â”Š6â”Šimport AnimatedSwitch from './components/AnimatedSwitch';\n```\n```diff\n@@ -11,6 +12,7 @@\n â”Š11â”Š12â”Š  return (\n â”Š12â”Š13â”Š    <BrowserRouter>\n â”Š13â”Š14â”Š      <AnimatedSwitch>\n+â”Š  â”Š15â”Š        <Route exact path=\"/sign-in\" component={AuthScreen} />\n â”Š14â”Š16â”Š        <Route exact path=\"/chats\" component={ChatsListScreen} />\n â”Š15â”Š17â”Š\n â”Š16â”Š18â”Š        <Route exact path=\"/chats/:chatId\" component={\n```\n\n[}]: #\n\nThis is how the new screen should look like:\n\n![auth-screen](https://user-images.githubusercontent.com/7648874/55606715-7a56a180-57ac-11e9-8eea-2da5931cccf5.png)\n\nNow letâ€™s type the `/sign-in` route in our browserâ€™s navigation bar and assign a user ID, see how it affects what chats we see in the `ChatsListScreen`. Youâ€™ve probably noticed that thereâ€™s no way to escape from the `/chats` route unless we edit the browserâ€™s navigation bar manually. To fix that, we will add a new sign-out button to the navbar of the `ChatsListScreen` that will call the `signOut()` method anytime we click on it, and will bring us back to the `AuthScreen`:\n\n[{]: <helper> (diffStep 11.5 module=\"client\")\n\n#### Client Step 11.5: Add sign-out button that ChatsNavbar\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsNavbar.tsx\n```diff\n@@ -1,18 +1,46 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n-â”Š 2â”Š  â”Šimport { Toolbar } from '@material-ui/core';\n+â”Š  â”Š 2â”Šimport { Button, Toolbar } from '@material-ui/core';\n â”Š 3â”Š 3â”Šimport styled from 'styled-components';\n+â”Š  â”Š 4â”Šimport SignOutIcon from '@material-ui/icons/PowerSettingsNew';\n+â”Š  â”Š 5â”Šimport { useCallback } from 'react';\n+â”Š  â”Š 6â”Šimport { signOut } from '../../services/auth.service';\n+â”Š  â”Š 7â”Šimport { History } from 'history';\n â”Š 4â”Š 8â”Š\n â”Š 5â”Š 9â”Šconst Container = styled(Toolbar) `\n+â”Š  â”Š10â”Š  display: flex;\n â”Š 6â”Š11â”Š  background-color: var(--primary-bg);\n â”Š 7â”Š12â”Š  color: var(--primary-text);\n â”Š 8â”Š13â”Š  font-size: 20px;\n â”Š 9â”Š14â”Š  line-height: 40px;\n â”Š10â”Š15â”Š` as typeof Toolbar;\n â”Š11â”Š16â”Š\n-â”Š12â”Š  â”Šconst ChatsNavbar: React.FC = () => (\n-â”Š13â”Š  â”Š  <Container>\n-â”Š14â”Š  â”Š    Whatsapp Clone\n-â”Š15â”Š  â”Š  </Container>\n-â”Š16â”Š  â”Š);\n+â”Š  â”Š17â”Šconst Title = styled.div `\n+â”Š  â”Š18â”Š  flex: 1;\n+â”Š  â”Š19â”Š`;\n+â”Š  â”Š20â”Š\n+â”Š  â”Š21â”Šconst LogoutButton = styled(Button) `\n+â”Š  â”Š22â”Š  color: var(--primary-text) !important;\n+â”Š  â”Š23â”Š` as typeof Button;\n+â”Š  â”Š24â”Š\n+â”Š  â”Š25â”Šinterface ChildComponentProps {\n+â”Š  â”Š26â”Š  history: History;\n+â”Š  â”Š27â”Š};\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Šconst ChatsNavbar: React.FC<ChildComponentProps> = ({ history }) => {\n+â”Š  â”Š30â”Š  const handleSignOut = useCallback(() => {\n+â”Š  â”Š31â”Š    signOut().then(() => {\n+â”Š  â”Š32â”Š      history.replace('/sign-in')\n+â”Š  â”Š33â”Š    });\n+â”Š  â”Š34â”Š  }, [history]);\n+â”Š  â”Š35â”Š\n+â”Š  â”Š36â”Š  return (\n+â”Š  â”Š37â”Š    <Container>\n+â”Š  â”Š38â”Š      <Title>Whatsapp Clone</Title>\n+â”Š  â”Š39â”Š      <LogoutButton data-testid=\"sign-out-button\" onClick={handleSignOut}>\n+â”Š  â”Š40â”Š        <SignOutIcon />\n+â”Š  â”Š41â”Š      </LogoutButton>\n+â”Š  â”Š42â”Š    </Container>\n+â”Š  â”Š43â”Š  );\n+â”Š  â”Š44â”Š};\n â”Š17â”Š45â”Š\n â”Š18â”Š46â”Šexport default ChatsNavbar;ðŸš«â†µ\n```\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;index.tsx\n```diff\n@@ -14,7 +14,7 @@\n â”Š14â”Š14â”Š\n â”Š15â”Š15â”Šconst ChatsListScreen: React.FC<ChatsListScreenProps> = ({ history }) => (\n â”Š16â”Š16â”Š  <Container>\n-â”Š17â”Š  â”Š    <ChatsNavbar />\n+â”Š  â”Š17â”Š    <ChatsNavbar history={history} />\n â”Š18â”Š18â”Š    <ChatsList history={history} />\n â”Š19â”Š19â”Š  </Container>\n â”Š20â”Š20â”Š);\n```\n\n[}]: #\n\nAt this point weâ€™ve got everything we need, but we will add a small touch to improve the user experience and make it feel more complete. Users who arenâ€™t logged in shouldnâ€™t be able to view any screen besides the `AuthScreen`. First they need to sign-in, and only then they will be able to view the `ChatsListScreen` and `ChatRoomScreen`. To achieve that, we will wrap all the components which require authentication before we provide them into their routes. This wrap will basically check whether a user is logged in or not by reading the cookies, and if not we will be redirected to the `/sign-in` route. Letâ€™s implement that wrap in the `auth.service` and call it `withAuth()`:\n\n[{]: <helper> (diffStep 11.6 files=\"auth.service\" module=\"client\")\n\n#### Client Step 11.6: Add withAuth() route wrapper\n\n##### Changed src&#x2F;services&#x2F;auth.service.tsx\n```diff\n@@ -1,4 +1,27 @@\n+â”Š  â”Š 1â”Šimport React from 'react';\n+â”Š  â”Š 2â”Šimport { Redirect } from 'react-router-dom';\n â”Š 1â”Š 3â”Šimport client from '../client';\n+â”Š  â”Š 4â”Šimport { useCacheService } from './cache.service';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šexport const withAuth = <P extends object>(Component: React.ComponentType<P>) => {\n+â”Š  â”Š 7â”Š  return (props: any) => {\n+â”Š  â”Š 8â”Š    if (!isSignedIn()) {\n+â”Š  â”Š 9â”Š      if (props.history.location.pathname === '/sign-in') {\n+â”Š  â”Š10â”Š        return null;\n+â”Š  â”Š11â”Š      }\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Š      return (\n+â”Š  â”Š14â”Š        <Redirect to=\"/sign-in\" />\n+â”Š  â”Š15â”Š      );\n+â”Š  â”Š16â”Š    }\n+â”Š  â”Š17â”Š\n+â”Š  â”Š18â”Š    useCacheService();\n+â”Š  â”Š19â”Š\n+â”Š  â”Š20â”Š    return (\n+â”Š  â”Š21â”Š      <Component {...props as P} />\n+â”Š  â”Š22â”Š    );\n+â”Š  â”Š23â”Š  };\n+â”Š  â”Š24â”Š};\n â”Š 2â”Š25â”Š\n â”Š 3â”Š26â”Šexport const signIn = (currentUserId: string) => {\n â”Š 4â”Š27â”Š  document.cookie = `currentUserId=${currentUserId}`;\n```\n\n[}]: #\n\nWe will use this function to wrap the right components in our appâ€™s router. Note that since we used the `useCacheService()` directly in the `withAuth()` method, thereâ€™s no need to use it in the router itself anymore. This makes a lot more sense since thereâ€™s no need to stay subscribed to data that you're not gonna receive from the first place unless youâ€™re logged-in:\n\n[{]: <helper> (diffStep 11.6 files=\"App\" module=\"client\")\n\n#### Client Step 11.6: Add withAuth() route wrapper\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -4,27 +4,23 @@\n â”Š 4â”Š 4â”Šimport ChatRoomScreen from './components/ChatRoomScreen';\n â”Š 5â”Š 5â”Šimport ChatsListScreen from './components/ChatsListScreen';\n â”Š 6â”Š 6â”Šimport AnimatedSwitch from './components/AnimatedSwitch';\n-â”Š 7â”Š  â”Šimport { useCacheService } from './services/cache.service';\n+â”Š  â”Š 7â”Šimport { withAuth } from './services/auth.service';\n â”Š 8â”Š 8â”Š\n-â”Š 9â”Š  â”Šconst App: React.FC = () => {\n-â”Š10â”Š  â”Š  useCacheService();\n+â”Š  â”Š 9â”Šconst App: React.FC = () => (\n+â”Š  â”Š10â”Š  <BrowserRouter>\n+â”Š  â”Š11â”Š    <AnimatedSwitch>\n+â”Š  â”Š12â”Š      <Route exact path=\"/sign-in\" component={AuthScreen} />\n+â”Š  â”Š13â”Š      <Route exact path=\"/chats\" component={withAuth(ChatsListScreen)} />\n â”Š11â”Š14â”Š\n-â”Š12â”Š  â”Š  return (\n-â”Š13â”Š  â”Š    <BrowserRouter>\n-â”Š14â”Š  â”Š      <AnimatedSwitch>\n-â”Š15â”Š  â”Š        <Route exact path=\"/sign-in\" component={AuthScreen} />\n-â”Š16â”Š  â”Š        <Route exact path=\"/chats\" component={ChatsListScreen} />\n+â”Š  â”Š15â”Š      <Route exact path=\"/chats/:chatId\" component={withAuth(\n+â”Š  â”Š16â”Š        ({ match, history }: RouteComponentProps<{ chatId: string }>) =>\n+â”Š  â”Š17â”Š        (<ChatRoomScreen chatId={match.params.chatId} history={history} />)\n+â”Š  â”Š18â”Š      )} />\n â”Š17â”Š19â”Š\n-â”Š18â”Š  â”Š        <Route exact path=\"/chats/:chatId\" component={\n-â”Š19â”Š  â”Š          ({ match, history }: RouteComponentProps<{ chatId: string }>) =>\n-â”Š20â”Š  â”Š          (<ChatRoomScreen chatId={match.params.chatId} history={history} />)\n-â”Š21â”Š  â”Š        } />\n-â”Š22â”Š  â”Š\n-â”Š23â”Š  â”Š      </AnimatedSwitch>\n-â”Š24â”Š  â”Š      <Route exact path=\"/\" render={redirectToChats} />\n-â”Š25â”Š  â”Š    </BrowserRouter>\n-â”Š26â”Š  â”Š  );\n-â”Š27â”Š  â”Š};\n+â”Š  â”Š20â”Š    </AnimatedSwitch>\n+â”Š  â”Š21â”Š    <Route exact path=\"/\" render={redirectToChats} />\n+â”Š  â”Š22â”Š  </BrowserRouter>\n+â”Š  â”Š23â”Š);\n â”Š28â”Š24â”Š\n â”Š29â”Š25â”Šconst redirectToChats = () => (\n â”Š30â”Š26â”Š  <Redirect to=\"/chats\" />\n```\n\n[}]: #\n\nAssuming that youâ€™re not logged-in, if youâ€™ll try to force navigate to the `/chats` route you should be automatically redirected to the `/sign-in` form. We will finish the chapter here as we wanna keep things simple and gradual. Itâ€™s true that we havenâ€™t implemented true authentication, but that would be addressed soon further in this tutorial.\n\n---------\n\nTODO: minor change, which might be helpful for people in long term. Thatâ€™s a small but powerful thing to know about in TypeScript\n+ recipient: chat.participants.find(p => p !== currentUser.id)!\n- recipient: chat.participants.find(p => p !== currentUser.id) as string\n\n\nTODO: I donâ€™t think we need `if (props.history.location.pathname === '/sign-in') return null`\nsince withAuth HOC is not used on `AuthScreen` component"
          },
          {
            "manualTitle": "Step 12: Adding and removing chats",
            "stepRevision": "52aa581ceab56fe7d39cab9a6b0db5ba52737f7d",
            "manualView": "Now that the users system is ready it would be a lot more comfortable to implement a chat creation feature. In the original Whatsapp, you can create a new chat based on your available contacts - a list of your contacts will appear on the screen and by picking one of the items youâ€™ll basically be able to start chatting with the selected contact. However, since in our app we donâ€™t have any real contacts (yet), we will implement the chats creation feature based on all available users in our DB. By picking a user from the users list we will be able to start chatting with it.\n\n![demo](https://user-images.githubusercontent.com/7648874/55896445-e4c67200-5bf0-11e9-9c1c-88318642ef81.gif)\n\nTo be able to fetch users in our system we will need to add a new query called `users`. The `users` query will retrieve all users except for current user:\n\n[{]: <helper> (diffStep 9.1 module=\"server\")\n\n#### [Server Step 9.1: Add Query.users](https://github.com/Urigo/WhatsApp-Clone-Server/commit/95127eb)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -80,6 +80,12 @@\n â”Š80â”Š80â”Š\n â”Š81â”Š81â”Š      return chat.participants.includes(currentUser.id) ? chat : null\n â”Š82â”Š82â”Š    },\n+â”Š  â”Š83â”Š\n+â”Š  â”Š84â”Š    users(root, args, { currentUser }) {\n+â”Š  â”Š85â”Š      if (!currentUser) return []\n+â”Š  â”Š86â”Š\n+â”Š  â”Š87â”Š      return users.filter(u => u.id !== currentUser.id)\n+â”Š  â”Š88â”Š    },\n â”Š83â”Š89â”Š  },\n â”Š84â”Š90â”Š\n â”Š85â”Š91â”Š  Mutation: {\n```\n\n##### Changed schema&#x2F;typeDefs.graphql\n```diff\n@@ -28,6 +28,7 @@\n â”Š28â”Š28â”Štype Query {\n â”Š29â”Š29â”Š  chats: [Chat!]!\n â”Š30â”Š30â”Š  chat(chatId: ID!): Chat\n+â”Š  â”Š31â”Š  users: [User!]!\n â”Š31â”Š32â”Š}\n â”Š32â”Š33â”Š\n â”Š33â”Š34â”Štype Mutation {\n```\n\n##### Added tests&#x2F;queries&#x2F;\\__snapshots__&#x2F;getUsers.test.ts.snap\n```diff\n@@ -0,0 +1,55 @@\n+â”Š  â”Š 1â”Š// Jest Snapshot v1, https://goo.gl/fbAQLP\n+â”Š  â”Š 2â”Š\n+â”Š  â”Š 3â”Šexports[`Query.getUsers should fetch all users except the one signed-in 1`] = `\n+â”Š  â”Š 4â”ŠObject {\n+â”Š  â”Š 5â”Š  \"users\": Array [\n+â”Š  â”Š 6â”Š    Object {\n+â”Š  â”Š 7â”Š      \"id\": \"2\",\n+â”Š  â”Š 8â”Š      \"name\": \"Ethan Gonzalez\",\n+â”Š  â”Š 9â”Š      \"picture\": \"https://randomuser.me/api/portraits/thumb/men/1.jpg\",\n+â”Š  â”Š10â”Š    },\n+â”Š  â”Š11â”Š    Object {\n+â”Š  â”Š12â”Š      \"id\": \"3\",\n+â”Š  â”Š13â”Š      \"name\": \"Bryan Wallace\",\n+â”Š  â”Š14â”Š      \"picture\": \"https://randomuser.me/api/portraits/thumb/men/2.jpg\",\n+â”Š  â”Š15â”Š    },\n+â”Š  â”Š16â”Š    Object {\n+â”Š  â”Š17â”Š      \"id\": \"4\",\n+â”Š  â”Š18â”Š      \"name\": \"Avery Stewart\",\n+â”Š  â”Š19â”Š      \"picture\": \"https://randomuser.me/api/portraits/thumb/women/1.jpg\",\n+â”Š  â”Š20â”Š    },\n+â”Š  â”Š21â”Š    Object {\n+â”Š  â”Š22â”Š      \"id\": \"5\",\n+â”Š  â”Š23â”Š      \"name\": \"Katie Peterson\",\n+â”Š  â”Š24â”Š      \"picture\": \"https://randomuser.me/api/portraits/thumb/women/2.jpg\",\n+â”Š  â”Š25â”Š    },\n+â”Š  â”Š26â”Š  ],\n+â”Š  â”Š27â”Š}\n+â”Š  â”Š28â”Š`;\n+â”Š  â”Š29â”Š\n+â”Š  â”Š30â”Šexports[`Query.getUsers should fetch all users except the one signed-in 2`] = `\n+â”Š  â”Š31â”ŠObject {\n+â”Š  â”Š32â”Š  \"users\": Array [\n+â”Š  â”Š33â”Š    Object {\n+â”Š  â”Š34â”Š      \"id\": \"1\",\n+â”Š  â”Š35â”Š      \"name\": \"Ray Edwards\",\n+â”Š  â”Š36â”Š      \"picture\": \"https://randomuser.me/api/portraits/thumb/lego/1.jpg\",\n+â”Š  â”Š37â”Š    },\n+â”Š  â”Š38â”Š    Object {\n+â”Š  â”Š39â”Š      \"id\": \"3\",\n+â”Š  â”Š40â”Š      \"name\": \"Bryan Wallace\",\n+â”Š  â”Š41â”Š      \"picture\": \"https://randomuser.me/api/portraits/thumb/men/2.jpg\",\n+â”Š  â”Š42â”Š    },\n+â”Š  â”Š43â”Š    Object {\n+â”Š  â”Š44â”Š      \"id\": \"4\",\n+â”Š  â”Š45â”Š      \"name\": \"Avery Stewart\",\n+â”Š  â”Š46â”Š      \"picture\": \"https://randomuser.me/api/portraits/thumb/women/1.jpg\",\n+â”Š  â”Š47â”Š    },\n+â”Š  â”Š48â”Š    Object {\n+â”Š  â”Š49â”Š      \"id\": \"5\",\n+â”Š  â”Š50â”Š      \"name\": \"Katie Peterson\",\n+â”Š  â”Š51â”Š      \"picture\": \"https://randomuser.me/api/portraits/thumb/women/2.jpg\",\n+â”Š  â”Š52â”Š    },\n+â”Š  â”Š53â”Š  ],\n+â”Š  â”Š54â”Š}\n+â”Š  â”Š55â”Š`;\n```\n\n##### Added tests&#x2F;queries&#x2F;getUsers.test.ts\n```diff\n@@ -0,0 +1,51 @@\n+â”Š  â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing'\n+â”Š  â”Š 2â”Šimport { ApolloServer, gql } from 'apollo-server-express'\n+â”Š  â”Š 3â”Šimport schema from '../../schema'\n+â”Š  â”Š 4â”Šimport { users } from '../../db'\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šdescribe('Query.getUsers', () => {\n+â”Š  â”Š 7â”Š  it('should fetch all users except the one signed-in', async () => {\n+â”Š  â”Š 8â”Š    let currentUser = users[0]\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Š    const server = new ApolloServer({\n+â”Š  â”Š11â”Š      schema,\n+â”Š  â”Š12â”Š      context: () => ({ currentUser }),\n+â”Š  â”Š13â”Š    })\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”Š    const { query } = createTestClient(server)\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š    let res = await query({\n+â”Š  â”Š18â”Š      query: gql `\n+â”Š  â”Š19â”Š        query GetUsers {\n+â”Š  â”Š20â”Š          users {\n+â”Š  â”Š21â”Š            id\n+â”Š  â”Š22â”Š            name\n+â”Š  â”Š23â”Š            picture\n+â”Š  â”Š24â”Š          }\n+â”Š  â”Š25â”Š        }\n+â”Š  â”Š26â”Š      `,\n+â”Š  â”Š27â”Š    })\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š    expect(res.data).toBeDefined()\n+â”Š  â”Š30â”Š    expect(res.errors).toBeUndefined()\n+â”Š  â”Š31â”Š    expect(res.data).toMatchSnapshot()\n+â”Š  â”Š32â”Š\n+â”Š  â”Š33â”Š    currentUser = users[1]\n+â”Š  â”Š34â”Š\n+â”Š  â”Š35â”Š    res = await query({\n+â”Š  â”Š36â”Š      query: gql `\n+â”Š  â”Š37â”Š        query GetUsers {\n+â”Š  â”Š38â”Š          users {\n+â”Š  â”Š39â”Š            id\n+â”Š  â”Š40â”Š            name\n+â”Š  â”Š41â”Š            picture\n+â”Š  â”Š42â”Š          }\n+â”Š  â”Š43â”Š        }\n+â”Š  â”Š44â”Š      `,\n+â”Š  â”Š45â”Š    })\n+â”Š  â”Š46â”Š\n+â”Š  â”Š47â”Š    expect(res.data).toBeDefined()\n+â”Š  â”Š48â”Š    expect(res.errors).toBeUndefined()\n+â”Š  â”Š49â”Š    expect(res.data).toMatchSnapshot()\n+â”Š  â”Š50â”Š  })\n+â”Š  â”Š51â”Š})\n```\n\n[}]: #\n\nThis query will be reflected in a component called `UsersList`. First we will define and export a new fragment called `User`:\n\n[{]: <helper> (diffStep 12.1 files=\"graphql/fragments\" module=\"client\")\n\n#### Client Step 12.1: Add basic ChatCreationScreen\n\n##### Changed src&#x2F;graphql&#x2F;fragments&#x2F;index.ts\n```diff\n@@ -1,3 +1,4 @@\n â”Š1â”Š1â”Šexport { default as chat } from './chat.fragment';\n â”Š2â”Š2â”Šexport { default as fullChat } from './fullChat.fragment';\n â”Š3â”Š3â”Šexport { default as message } from './message.fragment';\n+â”Š â”Š4â”Šexport { default as user } from './user.fragment';\n```\n\n##### Added src&#x2F;graphql&#x2F;fragments&#x2F;user.fragment.ts\n```diff\n@@ -0,0 +1,9 @@\n+â”Š â”Š1â”Šimport gql from 'graphql-tag';\n+â”Š â”Š2â”Š\n+â”Š â”Š3â”Šexport default gql`\n+â”Š â”Š4â”Š  fragment User on User {\n+â”Š â”Š5â”Š    id\n+â”Š â”Š6â”Š    name\n+â”Š â”Š7â”Š    picture\n+â”Š â”Š8â”Š  }\n+â”Š â”Š9â”Š`;\n```\n\n[}]: #\n\nAnd then we will implement the `UsersList` component which is going to use the `users` query with the `User` fragment:\n\n[{]: <helper> (diffStep 12.1 files=\"UsersList\" module=\"client\")\n\n#### Client Step 12.1: Add basic ChatCreationScreen\n\n##### Added src&#x2F;components&#x2F;UsersList.test.tsx\n```diff\n@@ -0,0 +1,43 @@\n+â”Š  â”Š 1â”Šimport React from 'react';\n+â”Š  â”Š 2â”Šimport { ApolloProvider } from 'react-apollo-hooks';\n+â”Š  â”Š 3â”Šimport { cleanup, render, waitForDomChange } from 'react-testing-library';\n+â”Š  â”Š 4â”Šimport { mockApolloClient } from '../test-helpers';\n+â”Š  â”Š 5â”Šimport UsersList, { UsersListQuery } from './UsersList';\n+â”Š  â”Š 6â”Šimport * as queries from '../graphql/queries';\n+â”Š  â”Š 7â”Š\n+â”Š  â”Š 8â”Šdescribe('UsersList', () => {\n+â”Š  â”Š 9â”Š  afterEach(cleanup);\n+â”Š  â”Š10â”Š\n+â”Š  â”Š11â”Š  it('renders fetched users data', async () => {\n+â”Š  â”Š12â”Š    const client = mockApolloClient([\n+â”Š  â”Š13â”Š      {\n+â”Š  â”Š14â”Š        request: { query: UsersListQuery },\n+â”Š  â”Š15â”Š        result: {\n+â”Š  â”Š16â”Š          data: {\n+â”Š  â”Š17â”Š            users: [\n+â”Š  â”Š18â”Š              {\n+â”Š  â”Š19â”Š                __typename: 'User',\n+â”Š  â”Š20â”Š                id: 1,\n+â”Š  â”Š21â”Š                name: 'Charles Dickhead',\n+â”Š  â”Š22â”Š                picture: 'https://localhost:4000/dick.jpg',\n+â”Š  â”Š23â”Š              },\n+â”Š  â”Š24â”Š            ],\n+â”Š  â”Š25â”Š          },\n+â”Š  â”Š26â”Š        },\n+â”Š  â”Š27â”Š      },\n+â”Š  â”Š28â”Š    ]);\n+â”Š  â”Š29â”Š\n+â”Š  â”Š30â”Š    {\n+â”Š  â”Š31â”Š      const { container, getByTestId } = render(\n+â”Š  â”Š32â”Š        <ApolloProvider client={client}>\n+â”Š  â”Š33â”Š          <UsersList />\n+â”Š  â”Š34â”Š        </ApolloProvider>\n+â”Š  â”Š35â”Š      );\n+â”Š  â”Š36â”Š\n+â”Š  â”Š37â”Š      await waitForDomChange({ container });\n+â”Š  â”Š38â”Š\n+â”Š  â”Š39â”Š      expect(getByTestId('name')).toHaveTextContent('Charles Dickhead');\n+â”Š  â”Š40â”Š      expect(getByTestId('picture')).toHaveAttribute('src', 'https://localhost:4000/dick.jpg');\n+â”Š  â”Š41â”Š    }\n+â”Š  â”Š42â”Š  })\n+â”Š  â”Š43â”Š});\n```\n\n##### Added src&#x2F;components&#x2F;UsersList.tsx\n```diff\n@@ -0,0 +1,66 @@\n+â”Š  â”Š 1â”Šimport MaterialList from '@material-ui/core/List';\n+â”Š  â”Š 2â”Šimport MaterialItem from '@material-ui/core/ListItem';\n+â”Š  â”Š 3â”Šimport gql from 'graphql-tag';\n+â”Š  â”Š 4â”Šimport React from 'react';\n+â”Š  â”Š 5â”Šimport styled from 'styled-components';\n+â”Š  â”Š 6â”Šimport * as fragments from '../graphql/fragments';\n+â”Š  â”Š 7â”Šimport { useUsersListQuery } from '../graphql/types';\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Šconst ActualList = styled(MaterialList) `\n+â”Š  â”Š10â”Š  padding: 0;\n+â”Š  â”Š11â”Š` as typeof MaterialList;\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Šconst UserItem = styled(MaterialItem) `\n+â”Š  â”Š14â”Š  position: relative;\n+â”Š  â”Š15â”Š  padding: 7.5px 15px;\n+â”Š  â”Š16â”Š  display: flex;\n+â”Š  â”Š17â”Š  cursor: pinter;\n+â”Š  â”Š18â”Š` as typeof MaterialItem;\n+â”Š  â”Š19â”Š\n+â”Š  â”Š20â”Šconst ProfilePicture = styled.img `\n+â”Š  â”Š21â”Š  height: 50px;\n+â”Š  â”Š22â”Š  width: 50px;\n+â”Š  â”Š23â”Š  object-fit: cover;\n+â”Š  â”Š24â”Š  border-radius: 50%;\n+â”Š  â”Š25â”Š`;\n+â”Š  â”Š26â”Š\n+â”Š  â”Š27â”Šconst Name = styled.div `\n+â”Š  â”Š28â”Š  padding-left: 15px;\n+â”Š  â”Š29â”Š  font-weight: bold;\n+â”Š  â”Š30â”Š`;\n+â”Š  â”Š31â”Š\n+â”Š  â”Š32â”Šexport const UsersListQuery = gql`\n+â”Š  â”Š33â”Š  query UsersList {\n+â”Š  â”Š34â”Š    users {\n+â”Š  â”Š35â”Š      ...User\n+â”Š  â”Š36â”Š    }\n+â”Š  â”Š37â”Š  }\n+â”Š  â”Š38â”Š  ${fragments.user}\n+â”Š  â”Š39â”Š`;\n+â”Š  â”Š40â”Š\n+â”Š  â”Š41â”Šconst UsersList: React.FC = () => {\n+â”Š  â”Š42â”Š  const { data, loading: loadingUsers } = useUsersListQuery();\n+â”Š  â”Š43â”Š\n+â”Š  â”Š44â”Š  if (data === undefined) return null;\n+â”Š  â”Š45â”Š  const users = data.users;\n+â”Š  â”Š46â”Š\n+â”Š  â”Š47â”Š  return (\n+â”Š  â”Š48â”Š    <ActualList>\n+â”Š  â”Š49â”Š      {!loadingUsers && users.map(user => (\n+â”Š  â”Š50â”Š        <UserItem\n+â”Š  â”Š51â”Š          key={user.id}\n+â”Š  â”Š52â”Š          button\n+â”Š  â”Š53â”Š        >\n+â”Š  â”Š54â”Š          {(user !== null && user.picture !== null) &&\n+â”Š  â”Š55â”Š            <React.Fragment>\n+â”Š  â”Š56â”Š              <ProfilePicture data-testid=\"picture\" src={user.picture} />\n+â”Š  â”Š57â”Š              <Name data-testid=\"name\">{user.name}</Name>\n+â”Š  â”Š58â”Š            </React.Fragment>\n+â”Š  â”Š59â”Š          }\n+â”Š  â”Š60â”Š        </UserItem>\n+â”Š  â”Š61â”Š      ))}\n+â”Š  â”Š62â”Š    </ActualList>\n+â”Š  â”Š63â”Š  );\n+â”Š  â”Š64â”Š};\n+â”Š  â”Š65â”Š\n+â”Š  â”Š66â”Šexport default UsersList;\n```\n\n[}]: #\n\nThe list is likely to change when a new user signs-up. We will implement a subscription and live-update the list further this tutorial when we go through authentication. Now we will implement a new screen component called `ChatCreationScreen`. The screen will simply render the `UsersList` along with a navigation bar:\n\n[{]: <helper> (diffStep 12.1 files=\"ChatCreationScreen\" module=\"client\")\n\n#### Client Step 12.1: Add basic ChatCreationScreen\n\n##### Added src&#x2F;components&#x2F;ChatCreationScreen&#x2F;ChatCreationNavbar.test.tsx\n```diff\n@@ -0,0 +1,28 @@\n+â”Š  â”Š 1â”Šimport { createMemoryHistory } from 'history';\n+â”Š  â”Š 2â”Šimport React from 'react';\n+â”Š  â”Š 3â”Šimport { cleanup, render, fireEvent, wait } from 'react-testing-library';\n+â”Š  â”Š 4â”Šimport ChatCreationNavbar from './ChatCreationNavbar';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šdescribe('ChatCreationNavbar', () => {\n+â”Š  â”Š 7â”Š  afterEach(cleanup);\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Š  it('goes back on arrow click', async () => {\n+â”Š  â”Š10â”Š    const history = createMemoryHistory();\n+â”Š  â”Š11â”Š\n+â”Š  â”Š12â”Š    history.push('/new-chat');\n+â”Š  â”Š13â”Š\n+â”Š  â”Š14â”Š    await wait(() =>\n+â”Š  â”Š15â”Š      expect(history.location.pathname).toEqual('/new-chat')\n+â”Š  â”Š16â”Š    );\n+â”Š  â”Š17â”Š\n+â”Š  â”Š18â”Š    {\n+â”Š  â”Š19â”Š      const { container, getByTestId } = render(<ChatCreationNavbar history={history} />);\n+â”Š  â”Š20â”Š\n+â”Š  â”Š21â”Š      fireEvent.click(getByTestId('back-button'));\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Š      await wait(() =>\n+â”Š  â”Š24â”Š        expect(history.location.pathname).toEqual('/chats')\n+â”Š  â”Š25â”Š      );\n+â”Š  â”Š26â”Š    }\n+â”Š  â”Š27â”Š  });\n+â”Š  â”Š28â”Š});\n```\n\n##### Added src&#x2F;components&#x2F;ChatCreationScreen&#x2F;ChatCreationNavbar.tsx\n```diff\n@@ -0,0 +1,46 @@\n+â”Š  â”Š 1â”Šimport ArrowBackIcon from '@material-ui/icons/ArrowBack';\n+â”Š  â”Š 2â”Šimport { Toolbar, Button } from '@material-ui/core';\n+â”Š  â”Š 3â”Šimport React from 'react';\n+â”Š  â”Š 4â”Šimport { useCallback } from 'react';\n+â”Š  â”Š 5â”Šimport styled from 'styled-components';\n+â”Š  â”Š 6â”Šimport { History } from 'history';\n+â”Š  â”Š 7â”Š\n+â”Š  â”Š 8â”Šconst Container = styled(Toolbar) `\n+â”Š  â”Š 9â”Š  display: flex;\n+â”Š  â”Š10â”Š  background-color: var(--primary-bg);\n+â”Š  â”Š11â”Š  color: var(--primary-text);\n+â”Š  â”Š12â”Š  font-size: 20px;\n+â”Š  â”Š13â”Š  line-height: 40px;\n+â”Š  â”Š14â”Š` as typeof Toolbar;\n+â”Š  â”Š15â”Š\n+â”Š  â”Š16â”Šconst BackButton = styled(Button) `\n+â”Š  â”Š17â”Š  svg {\n+â”Š  â”Š18â”Š    color: var(--primary-text);\n+â”Š  â”Š19â”Š  }\n+â”Š  â”Š20â”Š` as typeof Button;\n+â”Š  â”Š21â”Š\n+â”Š  â”Š22â”Šconst Title = styled.div `\n+â”Š  â”Š23â”Š  flex: 1;\n+â”Š  â”Š24â”Š`;\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Šinterface ChildComponentProps {\n+â”Š  â”Š27â”Š  history: History;\n+â”Š  â”Š28â”Š};\n+â”Š  â”Š29â”Š\n+â”Š  â”Š30â”Šconst ChatCreationNavbar: React.FC<ChildComponentProps> = ({ history }) => {\n+â”Š  â”Š31â”Š  const navBack = useCallback(() => {\n+â”Š  â”Š32â”Š    history.replace('/chats');\n+â”Š  â”Š33â”Š  }, [history]);\n+â”Š  â”Š34â”Š\n+â”Š  â”Š35â”Š  return (\n+â”Š  â”Š36â”Š    <Container>\n+â”Š  â”Š37â”Š      <BackButton data-testid=\"back-button\" onClick={navBack}>\n+â”Š  â”Š38â”Š        <ArrowBackIcon />\n+â”Š  â”Š39â”Š      </BackButton>\n+â”Š  â”Š40â”Š      <Title>Create Chat</Title>\n+â”Š  â”Š41â”Š    </Container>\n+â”Š  â”Š42â”Š  );\n+â”Š  â”Š43â”Š};\n+â”Š  â”Š44â”Š\n+â”Š  â”Š45â”Š\n+â”Š  â”Š46â”Šexport default ChatCreationNavbar;\n```\n\n##### Added src&#x2F;components&#x2F;ChatCreationScreen&#x2F;index.tsx\n```diff\n@@ -0,0 +1,29 @@\n+â”Š  â”Š 1â”Šimport React from 'react';\n+â”Š  â”Š 2â”Šimport styled from 'styled-components';\n+â”Š  â”Š 3â”Šimport UsersList from '../UsersList';\n+â”Š  â”Š 4â”Šimport ChatCreationNavbar from './ChatCreationNavbar';\n+â”Š  â”Š 5â”Šimport { History } from 'history';\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Š// eslint-disable-next-line\n+â”Š  â”Š 8â”Šconst Container = styled.div `\n+â”Š  â”Š 9â”Š  height: calc(100% - 56px);\n+â”Š  â”Š10â”Š  overflow-y: overlay;\n+â”Š  â”Š11â”Š`;\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Š// eslint-disable-next-line\n+â”Š  â”Š14â”Šconst StyledUsersList = styled(UsersList) `\n+â”Š  â”Š15â”Š  height: calc(100% - 56px);\n+â”Š  â”Š16â”Š`;\n+â”Š  â”Š17â”Š\n+â”Š  â”Š18â”Šinterface ChildComponentProps {\n+â”Š  â”Š19â”Š  history: History;\n+â”Š  â”Š20â”Š};\n+â”Š  â”Š21â”Š\n+â”Š  â”Š22â”Šconst ChatCreationScreen: React.FC<ChildComponentProps> = ({ history }) => (\n+â”Š  â”Š23â”Š  <div>\n+â”Š  â”Š24â”Š    <ChatCreationNavbar history={history} />\n+â”Š  â”Š25â”Š    <UsersList/>\n+â”Š  â”Š26â”Š  </div>\n+â”Š  â”Š27â”Š);\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Šexport default ChatCreationScreen;\n```\n\n[}]: #\n\nThe screen will be available under the route `/new-chat`. The new route will be restricted, since only authenticated users should be able to access it:\n\n[{]: <helper> (diffStep 12.1 files=\"App\" module=\"client\")\n\n#### Client Step 12.1: Add basic ChatCreationScreen\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -3,6 +3,7 @@\n â”Š3â”Š3â”Šimport AuthScreen from './components/AuthScreen';\n â”Š4â”Š4â”Šimport ChatRoomScreen from './components/ChatRoomScreen';\n â”Š5â”Š5â”Šimport ChatsListScreen from './components/ChatsListScreen';\n+â”Š â”Š6â”Šimport ChatCreationScreen from './components/ChatCreationScreen';\n â”Š6â”Š7â”Šimport AnimatedSwitch from './components/AnimatedSwitch';\n â”Š7â”Š8â”Šimport { withAuth } from './services/auth.service';\n â”Š8â”Š9â”Š\n```\n```diff\n@@ -17,6 +18,7 @@\n â”Š17â”Š18â”Š        (<ChatRoomScreen chatId={match.params.chatId} history={history} />)\n â”Š18â”Š19â”Š      )} />\n â”Š19â”Š20â”Š\n+â”Š  â”Š21â”Š      <Route exact path=\"/new-chat\" component={withAuth(ChatCreationScreen)} />\n â”Š20â”Š22â”Š    </AnimatedSwitch>\n â”Š21â”Š23â”Š    <Route exact path=\"/\" render={redirectToChats} />\n â”Š22â”Š24â”Š  </BrowserRouter>\n```\n\n[}]: #\n\nthe `/new-chat` route will be accessible directly from the main `ChatsListScreen`. We will implement a navigation button which is gonna have a fixed position at the bottom right corner of the screen:\n\n[{]: <helper> (diffStep 12.1 files=\"AddChatButton\" module=\"client\")\n\n#### Client Step 12.1: Add basic ChatCreationScreen\n\n##### Added src&#x2F;components&#x2F;ChatsListScreen&#x2F;AddChatButton.test.tsx\n```diff\n@@ -0,0 +1,22 @@\n+â”Š  â”Š 1â”Šimport { createMemoryHistory } from 'history';\n+â”Š  â”Š 2â”Šimport React from 'react';\n+â”Š  â”Š 3â”Šimport { cleanup, render, fireEvent, wait } from 'react-testing-library';\n+â”Š  â”Š 4â”Šimport AddChatButton from './AddChatButton';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šdescribe('AddChatButton', () => {\n+â”Š  â”Š 7â”Š  afterEach(cleanup);\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Š  it('goes back on arrow click', async () => {\n+â”Š  â”Š10â”Š    const history = createMemoryHistory();\n+â”Š  â”Š11â”Š\n+â”Š  â”Š12â”Š    {\n+â”Š  â”Š13â”Š      const { container, getByTestId } = render(<AddChatButton history={history} />);\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”Š      fireEvent.click(getByTestId('new-chat-button'));\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š      await wait(() =>\n+â”Š  â”Š18â”Š        expect(history.location.pathname).toEqual('/new-chat')\n+â”Š  â”Š19â”Š      );\n+â”Š  â”Š20â”Š    }\n+â”Š  â”Š21â”Š  });\n+â”Š  â”Š22â”Š});\n```\n\n##### Added src&#x2F;components&#x2F;ChatsListScreen&#x2F;AddChatButton.tsx\n```diff\n@@ -0,0 +1,44 @@\n+â”Š  â”Š 1â”Šimport Button from '@material-ui/core/Button';\n+â”Š  â”Š 2â”Šimport ChatIcon from '@material-ui/icons/Chat';\n+â”Š  â”Š 3â”Šimport React from 'react';\n+â”Š  â”Š 4â”Šimport styled from 'styled-components';\n+â”Š  â”Š 5â”Šimport { History } from 'history';\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Šconst Container = styled.div `\n+â”Š  â”Š 8â”Š  position: fixed;\n+â”Š  â”Š 9â”Š  right: 10px;\n+â”Š  â”Š10â”Š  bottom: 10px;\n+â”Š  â”Š11â”Š\n+â”Š  â”Š12â”Š  button {\n+â”Š  â”Š13â”Š    min-width: 50px;\n+â”Š  â”Š14â”Š    width: 50px;\n+â”Š  â”Š15â”Š    height: 50px;\n+â”Š  â”Š16â”Š    border-radius: 999px;\n+â”Š  â”Š17â”Š    background-color: var(--secondary-bg);\n+â”Š  â”Š18â”Š    color: white;\n+â”Š  â”Š19â”Š  }\n+â”Š  â”Š20â”Š`;\n+â”Š  â”Š21â”Šinterface ChildComponentProps {\n+â”Š  â”Š22â”Š  history: History;\n+â”Š  â”Š23â”Š};\n+â”Š  â”Š24â”Š\n+â”Š  â”Š25â”Šconst AddChatButton: React.FC<ChildComponentProps> = ({ history }) => {\n+â”Š  â”Š26â”Š  const onClick = () => {\n+â”Š  â”Š27â”Š    history.push('/new-chat')\n+â”Š  â”Š28â”Š  };\n+â”Š  â”Š29â”Š\n+â”Š  â”Š30â”Š  return (\n+â”Š  â”Š31â”Š    <Container>\n+â”Š  â”Š32â”Š      <Button\n+â”Š  â”Š33â”Š        data-testid=\"new-chat-button\"\n+â”Š  â”Š34â”Š        variant=\"contained\"\n+â”Š  â”Š35â”Š        color=\"secondary\"\n+â”Š  â”Š36â”Š        onClick={onClick}\n+â”Š  â”Š37â”Š      >\n+â”Š  â”Š38â”Š        <ChatIcon />\n+â”Š  â”Š39â”Š      </Button>\n+â”Š  â”Š40â”Š    </Container>\n+â”Š  â”Š41â”Š  );\n+â”Š  â”Š42â”Š};\n+â”Š  â”Š43â”Š\n+â”Š  â”Š44â”Šexport default AddChatButton;ðŸš«â†µ\n```\n\n[}]: #\n\nAnd then we will render it in the `ChatsListScreen`:\n\n[{]: <helper> (diffStep 12.1 files=\"ChatsListScreen/index\" module=\"client\")\n\n#### Client Step 12.1: Add basic ChatCreationScreen\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;index.tsx\n```diff\n@@ -3,6 +3,7 @@\n â”Š3â”Š3â”Šimport ChatsList from './ChatsList';\n â”Š4â”Š4â”Šimport styled from 'styled-components';\n â”Š5â”Š5â”Šimport { History } from 'history';\n+â”Š â”Š6â”Šimport AddChatButton from './AddChatButton';\n â”Š6â”Š7â”Š\n â”Š7â”Š8â”Šconst Container = styled.div `\n â”Š8â”Š9â”Š  height: 100vh;\n```\n```diff\n@@ -16,6 +17,7 @@\n â”Š16â”Š17â”Š  <Container>\n â”Š17â”Š18â”Š    <ChatsNavbar history={history} />\n â”Š18â”Š19â”Š    <ChatsList history={history} />\n+â”Š  â”Š20â”Š    <AddChatButton history={history} />\n â”Š19â”Š21â”Š  </Container>\n â”Š20â”Š22â”Š);\n â”Š21â”Š23â”Š\n```\n\n[}]: #\n\nFor now we can only observe the users list. Our goal now is to be able to start chatting with a user once it has been clicked. First we will need to add a new mutation called `addChat` which will create a new chat document and add it to the chats collection. If the chat already exists we will return the existing instance. This behavior will help us navigate to the desired `ChatRoomScreen`, whether it exists or not:\n\n[{]: <helper> (diffStep 9.2 module=\"server\")\n\n#### [Server Step 9.2: Add Mutation.addChat](https://github.com/Urigo/WhatsApp-Clone-Server/commit/e3509c3)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,6 +1,6 @@\n â”Š1â”Š1â”Šimport { withFilter } from 'apollo-server-express'\n â”Š2â”Š2â”Šimport { GraphQLDateTime } from 'graphql-iso-date'\n-â”Š3â”Š â”Šimport { User, Message, chats, messages, users } from '../db'\n+â”Š â”Š3â”Šimport { User, Message, Chat, chats, messages, users } from '../db'\n â”Š4â”Š4â”Šimport { Resolvers } from '../types/graphql'\n â”Š5â”Š5â”Š\n â”Š6â”Š6â”Šconst resolvers: Resolvers = {\n```\n```diff\n@@ -121,7 +121,31 @@\n â”Š121â”Š121â”Š      })\n â”Š122â”Š122â”Š\n â”Š123â”Š123â”Š      return message\n-â”Š124â”Š   â”Š    }\n+â”Š   â”Š124â”Š    },\n+â”Š   â”Š125â”Š\n+â”Š   â”Š126â”Š    addChat(root, { recipientId }, { currentUser }) {\n+â”Š   â”Š127â”Š      if (!currentUser) return null\n+â”Š   â”Š128â”Š      if (!users.some(u => u.id === recipientId)) return null\n+â”Š   â”Š129â”Š\n+â”Š   â”Š130â”Š      let chat = chats.find(c =>\n+â”Š   â”Š131â”Š        c.participants.includes(currentUser.id) &&\n+â”Š   â”Š132â”Š        c.participants.includes(recipientId)\n+â”Š   â”Š133â”Š      )\n+â”Š   â”Š134â”Š\n+â”Š   â”Š135â”Š      if (chat) return chat\n+â”Š   â”Š136â”Š\n+â”Š   â”Š137â”Š      const chatsIds = chats.map(c => Number(c.id))\n+â”Š   â”Š138â”Š\n+â”Š   â”Š139â”Š      chat = {\n+â”Š   â”Š140â”Š        id: String(Math.max(...chatsIds) + 1),\n+â”Š   â”Š141â”Š        participants: [currentUser.id, recipientId],\n+â”Š   â”Š142â”Š        messages: [],\n+â”Š   â”Š143â”Š      }\n+â”Š   â”Š144â”Š\n+â”Š   â”Š145â”Š      chats.push(chat)\n+â”Š   â”Š146â”Š\n+â”Š   â”Š147â”Š      return chat\n+â”Š   â”Š148â”Š    },\n â”Š125â”Š149â”Š  },\n â”Š126â”Š150â”Š\n â”Š127â”Š151â”Š  Subscription: {\n```\n\n##### Changed schema&#x2F;typeDefs.graphql\n```diff\n@@ -33,6 +33,7 @@\n â”Š33â”Š33â”Š\n â”Š34â”Š34â”Štype Mutation {\n â”Š35â”Š35â”Š  addMessage(chatId: ID!, content: String!): Message\n+â”Š  â”Š36â”Š  addChat(recipientId: ID!): Chat\n â”Š36â”Š37â”Š}\n â”Š37â”Š38â”Š\n â”Š38â”Š39â”Štype Subscription {\n```\n\n##### Added tests&#x2F;mutations&#x2F;\\__snapshots__&#x2F;addChat.test.ts.snap\n```diff\n@@ -0,0 +1,52 @@\n+â”Š  â”Š 1â”Š// Jest Snapshot v1, https://goo.gl/fbAQLP\n+â”Š  â”Š 2â”Š\n+â”Š  â”Š 3â”Šexports[`Mutation.addChat creates a new chat between current user and specified recipient 1`] = `\n+â”Š  â”Š 4â”ŠObject {\n+â”Š  â”Š 5â”Š  \"addChat\": Object {\n+â”Š  â”Š 6â”Š    \"id\": \"5\",\n+â”Š  â”Š 7â”Š    \"name\": \"Bryan Wallace\",\n+â”Š  â”Š 8â”Š    \"participants\": Array [\n+â”Š  â”Š 9â”Š      Object {\n+â”Š  â”Š10â”Š        \"id\": \"2\",\n+â”Š  â”Š11â”Š      },\n+â”Š  â”Š12â”Š      Object {\n+â”Š  â”Š13â”Š        \"id\": \"3\",\n+â”Š  â”Š14â”Š      },\n+â”Š  â”Š15â”Š    ],\n+â”Š  â”Š16â”Š  },\n+â”Š  â”Š17â”Š}\n+â”Š  â”Š18â”Š`;\n+â”Š  â”Š19â”Š\n+â”Š  â”Š20â”Šexports[`Mutation.addChat creates a new chat between current user and specified recipient 2`] = `\n+â”Š  â”Š21â”ŠObject {\n+â”Š  â”Š22â”Š  \"chat\": Object {\n+â”Š  â”Š23â”Š    \"id\": \"5\",\n+â”Š  â”Š24â”Š    \"name\": \"Bryan Wallace\",\n+â”Š  â”Š25â”Š    \"participants\": Array [\n+â”Š  â”Š26â”Š      Object {\n+â”Š  â”Š27â”Š        \"id\": \"2\",\n+â”Š  â”Š28â”Š      },\n+â”Š  â”Š29â”Š      Object {\n+â”Š  â”Š30â”Š        \"id\": \"3\",\n+â”Š  â”Š31â”Š      },\n+â”Š  â”Š32â”Š    ],\n+â”Š  â”Š33â”Š  },\n+â”Š  â”Š34â”Š}\n+â”Š  â”Š35â”Š`;\n+â”Š  â”Š36â”Š\n+â”Š  â”Š37â”Šexports[`Mutation.addChat returns the existing chat if so 1`] = `\n+â”Š  â”Š38â”ŠObject {\n+â”Š  â”Š39â”Š  \"addChat\": Object {\n+â”Š  â”Š40â”Š    \"id\": \"1\",\n+â”Š  â”Š41â”Š    \"name\": \"Ethan Gonzalez\",\n+â”Š  â”Š42â”Š    \"participants\": Array [\n+â”Š  â”Š43â”Š      Object {\n+â”Š  â”Š44â”Š        \"id\": \"1\",\n+â”Š  â”Š45â”Š      },\n+â”Š  â”Š46â”Š      Object {\n+â”Š  â”Š47â”Š        \"id\": \"2\",\n+â”Š  â”Š48â”Š      },\n+â”Š  â”Š49â”Š    ],\n+â”Š  â”Š50â”Š  },\n+â”Š  â”Š51â”Š}\n+â”Š  â”Š52â”Š`;\n```\n\n##### Added tests&#x2F;mutations&#x2F;addChat.test.ts\n```diff\n@@ -0,0 +1,89 @@\n+â”Š  â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing'\n+â”Š  â”Š 2â”Šimport { ApolloServer, PubSub, gql } from 'apollo-server-express'\n+â”Š  â”Š 3â”Šimport schema from '../../schema'\n+â”Š  â”Š 4â”Šimport { resetDb, users } from '../../db'\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šdescribe('Mutation.addChat', () => {\n+â”Š  â”Š 7â”Š  beforeEach(resetDb)\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Š  it('creates a new chat between current user and specified recipient', async () => {\n+â”Š  â”Š10â”Š    const server = new ApolloServer({\n+â”Š  â”Š11â”Š      schema,\n+â”Š  â”Š12â”Š      context: () => ({\n+â”Š  â”Š13â”Š        pubsub: new PubSub(),\n+â”Š  â”Š14â”Š        currentUser: users[1],\n+â”Š  â”Š15â”Š      }),\n+â”Š  â”Š16â”Š    })\n+â”Š  â”Š17â”Š\n+â”Š  â”Š18â”Š    const { query, mutate } = createTestClient(server)\n+â”Š  â”Š19â”Š\n+â”Š  â”Š20â”Š    const addChatRes = await mutate({\n+â”Š  â”Š21â”Š      variables: { recipientId: '3' },\n+â”Š  â”Š22â”Š      mutation: gql `\n+â”Š  â”Š23â”Š        mutation AddChat($recipientId: ID!) {\n+â”Š  â”Š24â”Š          addChat(recipientId: $recipientId) {\n+â”Š  â”Š25â”Š            id\n+â”Š  â”Š26â”Š            name\n+â”Š  â”Š27â”Š            participants {\n+â”Š  â”Š28â”Š              id\n+â”Š  â”Š29â”Š            }\n+â”Š  â”Š30â”Š          }\n+â”Š  â”Š31â”Š        }\n+â”Š  â”Š32â”Š      `,\n+â”Š  â”Š33â”Š    })\n+â”Š  â”Š34â”Š\n+â”Š  â”Š35â”Š    expect(addChatRes.data).toBeDefined()\n+â”Š  â”Š36â”Š    expect(addChatRes.errors).toBeUndefined()\n+â”Š  â”Š37â”Š    expect(addChatRes.data).toMatchSnapshot()\n+â”Š  â”Š38â”Š\n+â”Š  â”Š39â”Š    const getChatRes = await query({\n+â”Š  â”Š40â”Š      variables: { chatId: '5' },\n+â”Š  â”Š41â”Š      query: gql `\n+â”Š  â”Š42â”Š        query GetChat($chatId: ID!) {\n+â”Š  â”Š43â”Š          chat(chatId: $chatId) {\n+â”Š  â”Š44â”Š            id\n+â”Š  â”Š45â”Š            name\n+â”Š  â”Š46â”Š            participants {\n+â”Š  â”Š47â”Š              id\n+â”Š  â”Š48â”Š            }\n+â”Š  â”Š49â”Š          }\n+â”Š  â”Š50â”Š        }\n+â”Š  â”Š51â”Š      `,\n+â”Š  â”Š52â”Š    })\n+â”Š  â”Š53â”Š\n+â”Š  â”Š54â”Š    expect(getChatRes.data).toBeDefined()\n+â”Š  â”Š55â”Š    expect(getChatRes.errors).toBeUndefined()\n+â”Š  â”Š56â”Š    expect(getChatRes.data).toMatchSnapshot()\n+â”Š  â”Š57â”Š  })\n+â”Š  â”Š58â”Š\n+â”Š  â”Š59â”Š  it('returns the existing chat if so', async () => {\n+â”Š  â”Š60â”Š    const server = new ApolloServer({\n+â”Š  â”Š61â”Š      schema,\n+â”Š  â”Š62â”Š      context: () => ({\n+â”Š  â”Š63â”Š        pubsub: new PubSub(),\n+â”Š  â”Š64â”Š        currentUser: users[0],\n+â”Š  â”Š65â”Š      }),\n+â”Š  â”Š66â”Š    })\n+â”Š  â”Š67â”Š\n+â”Š  â”Š68â”Š    const { query, mutate } = createTestClient(server)\n+â”Š  â”Š69â”Š\n+â”Š  â”Š70â”Š    const addChatRes = await mutate({\n+â”Š  â”Š71â”Š      variables: { recipientId: '2' },\n+â”Š  â”Š72â”Š      mutation: gql `\n+â”Š  â”Š73â”Š        mutation AddChat($recipientId: ID!) {\n+â”Š  â”Š74â”Š          addChat(recipientId: $recipientId) {\n+â”Š  â”Š75â”Š            id\n+â”Š  â”Š76â”Š            name\n+â”Š  â”Š77â”Š            participants {\n+â”Š  â”Š78â”Š              id\n+â”Š  â”Š79â”Š            }\n+â”Š  â”Š80â”Š          }\n+â”Š  â”Š81â”Š        }\n+â”Š  â”Š82â”Š      `,\n+â”Š  â”Š83â”Š    })\n+â”Š  â”Š84â”Š\n+â”Š  â”Š85â”Š    expect(addChatRes.data).toBeDefined()\n+â”Š  â”Š86â”Š    expect(addChatRes.errors).toBeUndefined()\n+â”Š  â”Š87â”Š    expect(addChatRes.data).toMatchSnapshot()\n+â”Š  â”Š88â”Š  })\n+â”Š  â”Š89â”Š})\n```\n\n[}]: #\n\nTo use the new mutation, we will define a new callback called `onUserPick` in the `UsersList` so it can be used from the `ChatCreationScreen`:\n\n[{]: <helper> (diffStep 12.2 files=\"UsersList\" module=\"client\")\n\n#### Client Step 12.2: Create chat on user pick\n\n##### Changed src&#x2F;components&#x2F;UsersList.test.tsx\n```diff\n@@ -1,6 +1,6 @@\n â”Š1â”Š1â”Šimport React from 'react';\n â”Š2â”Š2â”Šimport { ApolloProvider } from 'react-apollo-hooks';\n-â”Š3â”Š â”Šimport { cleanup, render, waitForDomChange } from 'react-testing-library';\n+â”Š â”Š3â”Šimport { cleanup, render, fireEvent, wait, waitForDomChange } from 'react-testing-library';\n â”Š4â”Š4â”Šimport { mockApolloClient } from '../test-helpers';\n â”Š5â”Š5â”Šimport UsersList, { UsersListQuery } from './UsersList';\n â”Š6â”Š6â”Šimport * as queries from '../graphql/queries';\n```\n```diff\n@@ -40,4 +40,45 @@\n â”Š40â”Š40â”Š      expect(getByTestId('picture')).toHaveAttribute('src', 'https://localhost:4000/dick.jpg');\n â”Š41â”Š41â”Š    }\n â”Š42â”Š42â”Š  })\n+â”Š  â”Š43â”Š\n+â”Š  â”Š44â”Š  it('triggers onUserPick() callback on user-item click', async () => {\n+â”Š  â”Š45â”Š    const client = mockApolloClient([\n+â”Š  â”Š46â”Š      {\n+â”Š  â”Š47â”Š        request: { query: UsersListQuery },\n+â”Š  â”Š48â”Š        result: {\n+â”Š  â”Š49â”Š          data: {\n+â”Š  â”Š50â”Š            users: [\n+â”Š  â”Š51â”Š              {\n+â”Š  â”Š52â”Š                __typename: 'User',\n+â”Š  â”Š53â”Š                id: 1,\n+â”Š  â”Š54â”Š                name: 'Charles Dickhead',\n+â”Š  â”Š55â”Š                picture: 'https://localhost:4000/dick.jpg',\n+â”Š  â”Š56â”Š              },\n+â”Š  â”Š57â”Š            ],\n+â”Š  â”Š58â”Š          },\n+â”Š  â”Š59â”Š        },\n+â”Š  â”Š60â”Š      },\n+â”Š  â”Š61â”Š    ]);\n+â”Š  â”Š62â”Š\n+â”Š  â”Š63â”Š    const onUserPick = jest.fn(() => {});\n+â”Š  â”Š64â”Š\n+â”Š  â”Š65â”Š    {\n+â”Š  â”Š66â”Š      const { container, getByTestId } = render(\n+â”Š  â”Š67â”Š        <ApolloProvider client={client}>\n+â”Š  â”Š68â”Š          <UsersList onUserPick={onUserPick} />\n+â”Š  â”Š69â”Š        </ApolloProvider>\n+â”Š  â”Š70â”Š      );\n+â”Š  â”Š71â”Š\n+â”Š  â”Š72â”Š      await waitForDomChange({ container });\n+â”Š  â”Š73â”Š\n+â”Š  â”Š74â”Š      fireEvent.click(getByTestId('user'));\n+â”Š  â”Š75â”Š\n+â”Š  â”Š76â”Š      await wait(() =>\n+â”Š  â”Š77â”Š        expect(onUserPick.mock.calls.length).toBe(1)\n+â”Š  â”Š78â”Š      );\n+â”Š  â”Š79â”Š\n+â”Š  â”Š80â”Š      expect(onUserPick.mock.calls[0][0].name).toEqual('Charles Dickhead');\n+â”Š  â”Š81â”Š      expect(onUserPick.mock.calls[0][0].picture).toEqual('https://localhost:4000/dick.jpg');\n+â”Š  â”Š82â”Š    }\n+â”Š  â”Š83â”Š  });\n â”Š43â”Š84â”Š});\n```\n\n##### Changed src&#x2F;components&#x2F;UsersList.tsx\n```diff\n@@ -4,7 +4,7 @@\n â”Š 4â”Š 4â”Šimport React from 'react';\n â”Š 5â”Š 5â”Šimport styled from 'styled-components';\n â”Š 6â”Š 6â”Šimport * as fragments from '../graphql/fragments';\n-â”Š 7â”Š  â”Šimport { useUsersListQuery } from '../graphql/types';\n+â”Š  â”Š 7â”Šimport { useUsersListQuery, User } from '../graphql/types';\n â”Š 8â”Š 8â”Š\n â”Š 9â”Š 9â”Šconst ActualList = styled(MaterialList) `\n â”Š10â”Š10â”Š  padding: 0;\n```\n```diff\n@@ -38,7 +38,11 @@\n â”Š38â”Š38â”Š  ${fragments.user}\n â”Š39â”Š39â”Š`;\n â”Š40â”Š40â”Š\n-â”Š41â”Š  â”Šconst UsersList: React.FC = () => {\n+â”Š  â”Š41â”Šinterface ChildComponentProps {\n+â”Š  â”Š42â”Š  onUserPick: any;\n+â”Š  â”Š43â”Š};\n+â”Š  â”Š44â”Š\n+â”Š  â”Š45â”Šconst UsersList: React.FC<ChildComponentProps> = ({ onUserPick = (user: User) => {} }) => {\n â”Š42â”Š46â”Š  const { data, loading: loadingUsers } = useUsersListQuery();\n â”Š43â”Š47â”Š\n â”Š44â”Š48â”Š  if (data === undefined) return null;\n```\n```diff\n@@ -49,6 +53,8 @@\n â”Š49â”Š53â”Š      {!loadingUsers && users.map(user => (\n â”Š50â”Š54â”Š        <UserItem\n â”Š51â”Š55â”Š          key={user.id}\n+â”Š  â”Š56â”Š          data-testid=\"user\"\n+â”Š  â”Š57â”Š          onClick={onUserPick.bind(null, user)}\n â”Š52â”Š58â”Š          button\n â”Š53â”Š59â”Š        >\n â”Š54â”Š60â”Š          {(user !== null && user.picture !== null) &&\n```\n\n[}]: #\n\nIn the `ChatCreationScreen/index.tsx` module, we will define an `AddChat` document with `graphql-tag`. Using the `$ yarn codegen` command we can generate the correlated React mutation hook and use it as the `onUserPick` callback:\n\n[{]: <helper> (diffStep 12.2 files=\"ChatCreationScreen/index\" module=\"client\")\n\n#### Client Step 12.2: Create chat on user pick\n\n##### Changed src&#x2F;components&#x2F;ChatCreationScreen&#x2F;index.tsx\n```diff\n@@ -1,8 +1,12 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag';\n â”Š 1â”Š 2â”Šimport React from 'react';\n+â”Š  â”Š 3â”Šimport { useCallback } from 'react';\n â”Š 2â”Š 4â”Šimport styled from 'styled-components';\n+â”Š  â”Š 5â”Šimport * as fragments from '../../graphql/fragments';\n â”Š 3â”Š 6â”Šimport UsersList from '../UsersList';\n â”Š 4â”Š 7â”Šimport ChatCreationNavbar from './ChatCreationNavbar';\n â”Š 5â”Š 8â”Šimport { History } from 'history';\n+â”Š  â”Š 9â”Šimport { useAddChatMutation } from '../../graphql/types';\n â”Š 6â”Š10â”Š\n â”Š 7â”Š11â”Š// eslint-disable-next-line\n â”Š 8â”Š12â”Šconst Container = styled.div `\n```\n```diff\n@@ -15,15 +19,50 @@\n â”Š15â”Š19â”Š  height: calc(100% - 56px);\n â”Š16â”Š20â”Š`;\n â”Š17â”Š21â”Š\n+â”Š  â”Š22â”Šgql`\n+â”Š  â”Š23â”Š  mutation AddChat($recipientId: ID!) {\n+â”Š  â”Š24â”Š    addChat(recipientId: $recipientId) {\n+â”Š  â”Š25â”Š      ...Chat\n+â”Š  â”Š26â”Š    }\n+â”Š  â”Š27â”Š  }\n+â”Š  â”Š28â”Š  ${fragments.chat}\n+â”Š  â”Š29â”Š`;\n+â”Š  â”Š30â”Š\n â”Š18â”Š31â”Šinterface ChildComponentProps {\n â”Š19â”Š32â”Š  history: History;\n â”Š20â”Š33â”Š};\n â”Š21â”Š34â”Š\n-â”Š22â”Š  â”Šconst ChatCreationScreen: React.FC<ChildComponentProps> = ({ history }) => (\n-â”Š23â”Š  â”Š  <div>\n-â”Š24â”Š  â”Š    <ChatCreationNavbar history={history} />\n-â”Š25â”Š  â”Š    <UsersList/>\n-â”Š26â”Š  â”Š  </div>\n-â”Š27â”Š  â”Š);\n+â”Š  â”Š35â”Šconst ChatCreationScreen: React.FC<ChildComponentProps> = ({ history }) => {\n+â”Š  â”Š36â”Š  const addChat = useAddChatMutation();\n+â”Š  â”Š37â”Š\n+â”Š  â”Š38â”Š  const onUserPick = useCallback((user) => {\n+â”Š  â”Š39â”Š    addChat({\n+â”Š  â”Š40â”Š      optimisticResponse: {\n+â”Š  â”Š41â”Š        __typename: 'Mutation',\n+â”Š  â”Š42â”Š        addChat: {\n+â”Š  â”Š43â”Š          __typename: 'Chat',\n+â”Š  â”Š44â”Š          id: Math.random().toString(36).substr(2, 9),\n+â”Š  â”Š45â”Š          name: user.name,\n+â”Š  â”Š46â”Š          picture: user.picture,\n+â”Š  â”Š47â”Š          lastMessage: null,\n+â”Š  â”Š48â”Š        },\n+â”Š  â”Š49â”Š      },\n+â”Š  â”Š50â”Š      variables: {\n+â”Š  â”Š51â”Š        recipientId: user.id,\n+â”Š  â”Š52â”Š      },\n+â”Š  â”Š53â”Š    }).then(({ data }) => {\n+â”Š  â”Š54â”Š      if (data !== null) {\n+â”Š  â”Š55â”Š        history.push(`/chats/${data.addChat.id}`);\n+â”Š  â”Š56â”Š      }\n+â”Š  â”Š57â”Š    })\n+â”Š  â”Š58â”Š  }, [addChat, history]);\n+â”Š  â”Š59â”Š\n+â”Š  â”Š60â”Š  return (\n+â”Š  â”Š61â”Š    <div>\n+â”Š  â”Š62â”Š      <ChatCreationNavbar history={history} />\n+â”Š  â”Š63â”Š      <UsersList onUserPick={onUserPick} />\n+â”Š  â”Š64â”Š    </div>\n+â”Š  â”Š65â”Š  );\n+â”Š  â”Š66â”Š};\n â”Š28â”Š67â”Š\n â”Š29â”Š68â”Šexport default ChatCreationScreen;\n```\n\n[}]: #\n\nChats can now be created, you can test out the function by signing in with different users. However, the chats list in the `ChatsListScreen` will not be updated unless we refresh the page manually. In the server project, we will define a new subscription called `chatAdded`. The subscription should be broadcasted to the current user only if he is a participant of the published chat:\n\n[{]: <helper> (diffStep 9.3 module=\"server\")\n\n#### [Server Step 9.3: Add Subscription.chatAdded](https://github.com/Urigo/WhatsApp-Clone-Server/commit/693b6bd)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -123,7 +123,7 @@\n â”Š123â”Š123â”Š      return message\n â”Š124â”Š124â”Š    },\n â”Š125â”Š125â”Š\n-â”Š126â”Š   â”Š    addChat(root, { recipientId }, { currentUser }) {\n+â”Š   â”Š126â”Š    addChat(root, { recipientId }, { currentUser, pubsub }) {\n â”Š127â”Š127â”Š      if (!currentUser) return null\n â”Š128â”Š128â”Š      if (!users.some(u => u.id === recipientId)) return null\n â”Š129â”Š129â”Š\n```\n```diff\n@@ -144,6 +144,10 @@\n â”Š144â”Š144â”Š\n â”Š145â”Š145â”Š      chats.push(chat)\n â”Š146â”Š146â”Š\n+â”Š   â”Š147â”Š      pubsub.publish('chatAdded', {\n+â”Š   â”Š148â”Š        chatAdded: chat\n+â”Š   â”Š149â”Š      })\n+â”Š   â”Š150â”Š\n â”Š147â”Š151â”Š      return chat\n â”Š148â”Š152â”Š    },\n â”Š149â”Š153â”Š  },\n```\n```diff\n@@ -161,6 +165,17 @@\n â”Š161â”Š165â”Š          ].includes(currentUser.id)\n â”Š162â”Š166â”Š        },\n â”Š163â”Š167â”Š      )\n+â”Š   â”Š168â”Š    },\n+â”Š   â”Š169â”Š\n+â”Š   â”Š170â”Š    chatAdded: {\n+â”Š   â”Š171â”Š      subscribe: withFilter(\n+â”Š   â”Š172â”Š        (root, args, { pubsub }) => pubsub.asyncIterator('chatAdded'),\n+â”Š   â”Š173â”Š        ({ chatAdded }: { chatAdded: Chat }, args, { currentUser }) => {\n+â”Š   â”Š174â”Š          if (!currentUser) return false\n+â”Š   â”Š175â”Š\n+â”Š   â”Š176â”Š          return chatAdded.participants.some(p => p === currentUser.id)\n+â”Š   â”Š177â”Š        },\n+â”Š   â”Š178â”Š      )\n â”Š164â”Š179â”Š    }\n â”Š165â”Š180â”Š  }\n â”Š166â”Š181â”Š}\n```\n\n##### Changed schema&#x2F;typeDefs.graphql\n```diff\n@@ -38,4 +38,5 @@\n â”Š38â”Š38â”Š\n â”Š39â”Š39â”Štype Subscription {\n â”Š40â”Š40â”Š  messageAdded: Message!\n+â”Š  â”Š41â”Š  chatAdded: Chat!\n â”Š41â”Š42â”Š}\n```\n\n[}]: #\n\nNow we will listen to the new subscription in the client and update the cache. First we will define the subscription document:\n\n[{]: <helper> (diffStep 12.3 files=\"graphql/subscriptions\" module=\"client\")\n\n#### Client Step 12.3: Write chat on chatAdded\n\n##### Added src&#x2F;graphql&#x2F;subscriptions&#x2F;chatAdded.subscription.ts\n```diff\n@@ -0,0 +1,11 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag';\n+â”Š  â”Š 2â”Šimport * as fragments from '../fragments';\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šexport default gql`\n+â”Š  â”Š 5â”Š  subscription ChatAdded {\n+â”Š  â”Š 6â”Š    chatAdded {\n+â”Š  â”Š 7â”Š      ...Chat\n+â”Š  â”Š 8â”Š    }\n+â”Š  â”Š 9â”Š  }\n+â”Š  â”Š10â”Š  ${fragments.chat}\n+â”Š  â”Š11â”Š`;\n```\n\n##### Changed src&#x2F;graphql&#x2F;subscriptions&#x2F;index.ts\n```diff\n@@ -1 +1,2 @@\n â”Š1â”Š1â”Šexport { default as messageAdded } from './messageAdded.subscription';\n+â”Š â”Š2â”Šexport { default as chatAdded } from './chatAdded.subscription';\n```\n\n[}]: #\n\nAnd then we will update the `cache.service` to write the broadcasted chat to the store. We will write the fragment, and we will also update the `chats` query to contain the new chat. We will also check if the chat already exists before we update the query, because remember, the `addChat` mutation will return the chat even if it already exists, not if it was created only:\n\n[{]: <helper> (diffStep 12.3 module=\"client\")\n\n#### Client Step 12.3: Write chat on chatAdded\n\n##### Changed src&#x2F;components&#x2F;ChatCreationScreen&#x2F;index.tsx\n```diff\n@@ -7,6 +7,7 @@\n â”Š 7â”Š 7â”Šimport ChatCreationNavbar from './ChatCreationNavbar';\n â”Š 8â”Š 8â”Šimport { History } from 'history';\n â”Š 9â”Š 9â”Šimport { useAddChatMutation } from '../../graphql/types';\n+â”Š  â”Š10â”Šimport { writeChat } from '../../services/cache.service';\n â”Š10â”Š11â”Š\n â”Š11â”Š12â”Š// eslint-disable-next-line\n â”Š12â”Š13â”Šconst Container = styled.div `\n```\n```diff\n@@ -33,7 +34,11 @@\n â”Š33â”Š34â”Š};\n â”Š34â”Š35â”Š\n â”Š35â”Š36â”Šconst ChatCreationScreen: React.FC<ChildComponentProps> = ({ history }) => {\n-â”Š36â”Š  â”Š  const addChat = useAddChatMutation();\n+â”Š  â”Š37â”Š  const addChat = useAddChatMutation({\n+â”Š  â”Š38â”Š    update: (client, { data: { addChat } }) => {\n+â”Š  â”Š39â”Š      writeChat(client, addChat);\n+â”Š  â”Š40â”Š    }\n+â”Š  â”Š41â”Š  });\n â”Š37â”Š42â”Š\n â”Š38â”Š43â”Š  const onUserPick = useCallback((user) => {\n â”Š39â”Š44â”Š    addChat({\n```\n\n##### Added src&#x2F;graphql&#x2F;subscriptions&#x2F;chatAdded.subscription.ts\n```diff\n@@ -0,0 +1,11 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag';\n+â”Š  â”Š 2â”Šimport * as fragments from '../fragments';\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šexport default gql`\n+â”Š  â”Š 5â”Š  subscription ChatAdded {\n+â”Š  â”Š 6â”Š    chatAdded {\n+â”Š  â”Š 7â”Š      ...Chat\n+â”Š  â”Š 8â”Š    }\n+â”Š  â”Š 9â”Š  }\n+â”Š  â”Š10â”Š  ${fragments.chat}\n+â”Š  â”Š11â”Š`;\n```\n\n##### Changed src&#x2F;graphql&#x2F;subscriptions&#x2F;index.ts\n```diff\n@@ -1 +1,2 @@\n â”Š1â”Š1â”Šexport { default as messageAdded } from './messageAdded.subscription';\n+â”Š â”Š2â”Šexport { default as chatAdded } from './chatAdded.subscription';\n```\n\n##### Changed src&#x2F;services&#x2F;cache.service.ts\n```diff\n@@ -5,7 +5,9 @@\n â”Š 5â”Š 5â”Šimport * as queries from '../graphql/queries';\n â”Š 6â”Š 6â”Šimport {\n â”Š 7â”Š 7â”Š  MessageFragment,\n+â”Š  â”Š 8â”Š  ChatFragment,\n â”Š 8â”Š 9â”Š  useMessageAddedSubscription,\n+â”Š  â”Š10â”Š  useChatAddedSubscription,\n â”Š 9â”Š11â”Š} from '../graphql/types';\n â”Š10â”Š12â”Š\n â”Š11â”Š13â”Štype Client = ApolloClient<any> | DataProxy;\n```\n```diff\n@@ -18,6 +20,14 @@\n â”Š18â”Š20â”Š      }\n â”Š19â”Š21â”Š    }\n â”Š20â”Š22â”Š  });\n+â”Š  â”Š23â”Š\n+â”Š  â”Š24â”Š  useChatAddedSubscription({\n+â”Š  â”Š25â”Š    onSubscriptionData: ({ client, subscriptionData: { data } }) => {\n+â”Š  â”Š26â”Š      if (data) {\n+â”Š  â”Š27â”Š        writeChat(client, data.chatAdded);\n+â”Š  â”Š28â”Š      }\n+â”Š  â”Š29â”Š    }\n+â”Š  â”Š30â”Š  });\n â”Š21â”Š31â”Š};\n â”Š22â”Š32â”Š\n â”Š23â”Š33â”Šexport const writeMessage = (client: Client, message: MessageFragment) => {\n```\n```diff\n@@ -83,3 +93,41 @@\n â”Š 83â”Š 93â”Š    data: { chats: chats },\n â”Š 84â”Š 94â”Š  });\n â”Š 85â”Š 95â”Š}\n+â”Š   â”Š 96â”Š\n+â”Š   â”Š 97â”Šexport const writeChat = (client: Client, chat: ChatFragment) => {\n+â”Š   â”Š 98â”Š\n+â”Š   â”Š 99â”Š  const chatId = defaultDataIdFromObject(chat);\n+â”Š   â”Š100â”Š  if (chatId === null) {\n+â”Š   â”Š101â”Š    return;\n+â”Š   â”Š102â”Š  }\n+â”Š   â”Š103â”Š\n+â”Š   â”Š104â”Š  client.writeFragment({\n+â”Š   â”Š105â”Š    id: chatId,\n+â”Š   â”Š106â”Š    fragment: fragments.chat,\n+â”Š   â”Š107â”Š    fragmentName: 'Chat',\n+â”Š   â”Š108â”Š    data: chat,\n+â”Š   â”Š109â”Š  })\n+â”Š   â”Š110â”Š\n+â”Š   â”Š111â”Š  let data;\n+â”Š   â”Š112â”Š  try {\n+â”Š   â”Š113â”Š    data = client.readQuery({\n+â”Š   â”Š114â”Š      query: queries.chats,\n+â”Š   â”Š115â”Š    })\n+â”Š   â”Š116â”Š  } catch (e) {\n+â”Š   â”Š117â”Š    return;\n+â”Š   â”Š118â”Š  }\n+â”Š   â”Š119â”Š\n+â”Š   â”Š120â”Š  if (!data) return;\n+â”Š   â”Š121â”Š\n+â”Š   â”Š122â”Š  const chats = data.chats;\n+â”Š   â”Š123â”Š\n+â”Š   â”Š124â”Š  if (!chats) return;\n+â”Š   â”Š125â”Š  if (chats.some((c: any) => c.id === chat.id)) return;\n+â”Š   â”Š126â”Š\n+â”Š   â”Š127â”Š  chats.unshift(chat)\n+â”Š   â”Š128â”Š\n+â”Š   â”Š129â”Š  client.writeQuery({\n+â”Š   â”Š130â”Š    query: queries.chats,\n+â”Š   â”Š131â”Š    data: { chats },\n+â”Š   â”Š132â”Š  });\n+â”Š   â”Š133â”Š}\n```\n\n[}]: #\n\nNow we can create new chats, and the chats list would be updated, without refreshing the page. You can also test it with 2 separate sessions in the browser and see how each tab/window affects the other. Lastly, we will implement a chat removal function. This is important as we donâ€™t want to garbage our chats collection, sometimes we would like to clean up some of them.\n\nIn the back-end, letâ€™s implement the `removeChat` mutation. The chat can only be removed only if the current user is one of the chatâ€™s participants. The mutation will also remove all the messages which are related to the target chat, since weâ€™re not gonna use them anymore. The chat will be removed for all participants. This is not exactly the behavior of the original Whatsapp, but to keep things simple we will go with that solution:\n\n[{]: <helper> (diffStep 9.4 module=\"server\")\n\n#### [Server Step 9.4: Add Mutation.removeChat](https://github.com/Urigo/WhatsApp-Clone-Server/commit/19f69d9)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -150,6 +150,30 @@\n â”Š150â”Š150â”Š\n â”Š151â”Š151â”Š      return chat\n â”Š152â”Š152â”Š    },\n+â”Š   â”Š153â”Š\n+â”Š   â”Š154â”Š    removeChat(root, { chatId }, { currentUser }) {\n+â”Š   â”Š155â”Š      if (!currentUser) return null\n+â”Š   â”Š156â”Š\n+â”Š   â”Š157â”Š      const chatIndex = chats.findIndex(c => c.id === chatId)\n+â”Š   â”Š158â”Š\n+â”Š   â”Š159â”Š      if (chatIndex === -1) return null\n+â”Š   â”Š160â”Š\n+â”Š   â”Š161â”Š      const chat = chats[chatIndex]\n+â”Š   â”Š162â”Š\n+â”Š   â”Š163â”Š      if (!chat.participants.some(p => p === currentUser.id)) return null\n+â”Š   â”Š164â”Š\n+â”Š   â”Š165â”Š      chat.messages.forEach((chatMessage) => {\n+â”Š   â”Š166â”Š        const chatMessageIndex = messages.findIndex(m => m.id === chatMessage)\n+â”Š   â”Š167â”Š\n+â”Š   â”Š168â”Š        if (chatMessageIndex !== -1) {\n+â”Š   â”Š169â”Š          messages.splice(chatMessageIndex, 1)\n+â”Š   â”Š170â”Š        }\n+â”Š   â”Š171â”Š      })\n+â”Š   â”Š172â”Š\n+â”Š   â”Š173â”Š      chats.splice(chatIndex, 1)\n+â”Š   â”Š174â”Š\n+â”Š   â”Š175â”Š      return chatId\n+â”Š   â”Š176â”Š    }\n â”Š153â”Š177â”Š  },\n â”Š154â”Š178â”Š\n â”Š155â”Š179â”Š  Subscription: {\n```\n\n##### Changed schema&#x2F;typeDefs.graphql\n```diff\n@@ -34,6 +34,7 @@\n â”Š34â”Š34â”Štype Mutation {\n â”Š35â”Š35â”Š  addMessage(chatId: ID!, content: String!): Message\n â”Š36â”Š36â”Š  addChat(recipientId: ID!): Chat\n+â”Š  â”Š37â”Š  removeChat(chatId: ID!): ID\n â”Š37â”Š38â”Š}\n â”Š38â”Š39â”Š\n â”Š39â”Š40â”Štype Subscription {\n```\n\n##### Added tests&#x2F;mutations&#x2F;removeChat.test.ts\n```diff\n@@ -0,0 +1,52 @@\n+â”Š  â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing'\n+â”Š  â”Š 2â”Šimport { ApolloServer, PubSub, gql } from 'apollo-server-express'\n+â”Š  â”Š 3â”Šimport schema from '../../schema'\n+â”Š  â”Š 4â”Šimport { resetDb, users } from '../../db'\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šdescribe('Mutation.removeChat', () => {\n+â”Š  â”Š 7â”Š  beforeEach(resetDb)\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Š  it('removes chat by id', async () => {\n+â”Š  â”Š10â”Š    const server = new ApolloServer({\n+â”Š  â”Š11â”Š      schema,\n+â”Š  â”Š12â”Š      context: () => ({\n+â”Š  â”Š13â”Š        pubsub: new PubSub(),\n+â”Š  â”Š14â”Š        currentUser: users[0],\n+â”Š  â”Š15â”Š      }),\n+â”Š  â”Š16â”Š    })\n+â”Š  â”Š17â”Š\n+â”Š  â”Š18â”Š    const { query, mutate } = createTestClient(server)\n+â”Š  â”Š19â”Š\n+â”Š  â”Š20â”Š    const addChatRes = await mutate({\n+â”Š  â”Š21â”Š      variables: { chatId: '1' },\n+â”Š  â”Š22â”Š      mutation: gql `\n+â”Š  â”Š23â”Š        mutation RemoveChat($chatId: ID!) {\n+â”Š  â”Š24â”Š          removeChat(chatId: $chatId)\n+â”Š  â”Š25â”Š        }\n+â”Š  â”Š26â”Š      `,\n+â”Š  â”Š27â”Š    })\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š    expect(addChatRes.data).toBeDefined()\n+â”Š  â”Š30â”Š    expect(addChatRes.errors).toBeUndefined()\n+â”Š  â”Š31â”Š    expect(addChatRes.data!.removeChat).toEqual('1')\n+â”Š  â”Š32â”Š\n+â”Š  â”Š33â”Š    const getChatRes = await query({\n+â”Š  â”Š34â”Š      variables: { chatId: '1' },\n+â”Š  â”Š35â”Š      query: gql `\n+â”Š  â”Š36â”Š        query GetChat($chatId: ID!) {\n+â”Š  â”Š37â”Š          chat(chatId: $chatId) {\n+â”Š  â”Š38â”Š            id\n+â”Š  â”Š39â”Š            name\n+â”Š  â”Š40â”Š            participants {\n+â”Š  â”Š41â”Š              id\n+â”Š  â”Š42â”Š            }\n+â”Š  â”Š43â”Š          }\n+â”Š  â”Š44â”Š        }\n+â”Š  â”Š45â”Š      `,\n+â”Š  â”Š46â”Š    })\n+â”Š  â”Š47â”Š\n+â”Š  â”Š48â”Š    expect(addChatRes.data).toBeDefined()\n+â”Š  â”Š49â”Š    expect(getChatRes.errors).toBeUndefined()\n+â”Š  â”Š50â”Š    expect(addChatRes.data!.chat).toBeUndefined()\n+â”Š  â”Š51â”Š  })\n+â”Š  â”Š52â”Š})\n```\n\n[}]: #\n\nIn the client app, a chat could be removed directly from the `ChatRoomScreen`. On the top right corner, right on the navbar, we will add a dispose button that will call the `removeChat` mutation. Just like we did before, we will define the mutation document with `graphql-tag` and generate the correlated hook with CodeGen:\n\n[{]: <helper> (diffStep 12.4 module=\"client\")\n\n#### Client Step 12.4: Add chat removal function\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;ChatNavbar.test.tsx\n```diff\n@@ -1,12 +1,17 @@\n â”Š 1â”Š 1â”Šimport { createMemoryHistory } from 'history';\n â”Š 2â”Š 2â”Šimport React from 'react';\n+â”Š  â”Š 3â”Šimport { ApolloProvider } from 'react-apollo-hooks';\n â”Š 3â”Š 4â”Šimport { cleanup, render, fireEvent, wait } from 'react-testing-library';\n+â”Š  â”Š 5â”Šimport { mockApolloClient } from '../../test-helpers';\n â”Š 4â”Š 6â”Šimport ChatNavbar from './ChatNavbar';\n+â”Š  â”Š 7â”Šimport { RemoveChatDocument } from '../../graphql/types';\n â”Š 5â”Š 8â”Š\n â”Š 6â”Š 9â”Šdescribe('ChatNavbar', () => {\n â”Š 7â”Š10â”Š  afterEach(cleanup);\n â”Š 8â”Š11â”Š\n â”Š 9â”Š12â”Š  it('renders chat data', () => {\n+â”Š  â”Š13â”Š    const client = mockApolloClient();\n+â”Š  â”Š14â”Š\n â”Š10â”Š15â”Š    const chat = {\n â”Š11â”Š16â”Š      id: '1',\n â”Š12â”Š17â”Š      name: 'Foo Bar',\n```\n```diff\n@@ -14,7 +19,11 @@\n â”Š14â”Š19â”Š    };\n â”Š15â”Š20â”Š\n â”Š16â”Š21â”Š    {\n-â”Š17â”Š  â”Š      const { container, getByTestId } = render(<ChatNavbar chat={chat} />);\n+â”Š  â”Š22â”Š      const { container, getByTestId } = render(\n+â”Š  â”Š23â”Š        <ApolloProvider client={client}>\n+â”Š  â”Š24â”Š          <ChatNavbar chat={chat} />\n+â”Š  â”Š25â”Š        </ApolloProvider>\n+â”Š  â”Š26â”Š      );\n â”Š18â”Š27â”Š\n â”Š19â”Š28â”Š      expect(getByTestId('chat-name')).toHaveTextContent('Foo Bar');\n â”Š20â”Š29â”Š      expect(getByTestId('chat-picture')).toHaveAttribute('src', 'https://localhost:4000/picture.jpg');\n```\n```diff\n@@ -22,6 +31,8 @@\n â”Š22â”Š31â”Š  })\n â”Š23â”Š32â”Š\n â”Š24â”Š33â”Š  it('goes back on arrow click', async () => {\n+â”Š  â”Š34â”Š    const client = mockApolloClient();\n+â”Š  â”Š35â”Š\n â”Š25â”Š36â”Š    const chat = {\n â”Š26â”Š37â”Š      id: '1',\n â”Š27â”Š38â”Š      name: 'Foo Bar',\n```\n```diff\n@@ -37,7 +48,11 @@\n â”Š37â”Š48â”Š    )\n â”Š38â”Š49â”Š\n â”Š39â”Š50â”Š    {\n-â”Š40â”Š  â”Š      const { container, getByTestId } = render(<ChatNavbar chat={chat} history={history} />);\n+â”Š  â”Š51â”Š      const { container, getByTestId } = render(\n+â”Š  â”Š52â”Š        <ApolloProvider client={client}>\n+â”Š  â”Š53â”Š          <ChatNavbar chat={chat} history={history} />\n+â”Š  â”Š54â”Š        </ApolloProvider>\n+â”Š  â”Š55â”Š      );\n â”Š41â”Š56â”Š\n â”Š42â”Š57â”Š      fireEvent.click(getByTestId('back-button'));\n â”Š43â”Š58â”Š\n```\n```diff\n@@ -46,4 +61,48 @@\n â”Š 46â”Š 61â”Š      );\n â”Š 47â”Š 62â”Š    }\n â”Š 48â”Š 63â”Š  });\n+â”Š   â”Š 64â”Š\n+â”Š   â”Š 65â”Š  it('goes back on chat removal', async () => {\n+â”Š   â”Š 66â”Š    const client = mockApolloClient([\n+â”Š   â”Š 67â”Š      {\n+â”Š   â”Š 68â”Š        request: {\n+â”Š   â”Š 69â”Š          query: RemoveChatDocument,\n+â”Š   â”Š 70â”Š          variables: { chatId: '1' },\n+â”Š   â”Š 71â”Š        },\n+â”Š   â”Š 72â”Š        result: {\n+â”Š   â”Š 73â”Š          data: {\n+â”Š   â”Š 74â”Š            removeChat: '1'\n+â”Š   â”Š 75â”Š          }\n+â”Š   â”Š 76â”Š        }\n+â”Š   â”Š 77â”Š      },\n+â”Š   â”Š 78â”Š    ]);\n+â”Š   â”Š 79â”Š\n+â”Š   â”Š 80â”Š    const chat = {\n+â”Š   â”Š 81â”Š      id: '1',\n+â”Š   â”Š 82â”Š      name: 'Foo Bar',\n+â”Š   â”Š 83â”Š      picture: 'https://localhost:4000/picture.jpg',\n+â”Š   â”Š 84â”Š    };\n+â”Š   â”Š 85â”Š\n+â”Š   â”Š 86â”Š    const history = createMemoryHistory();\n+â”Š   â”Š 87â”Š\n+â”Š   â”Š 88â”Š    history.push('/chats/1');\n+â”Š   â”Š 89â”Š\n+â”Š   â”Š 90â”Š    await wait(() =>\n+â”Š   â”Š 91â”Š      expect(history.location.pathname).toEqual('/chats/1')\n+â”Š   â”Š 92â”Š    );\n+â”Š   â”Š 93â”Š\n+â”Š   â”Š 94â”Š    {\n+â”Š   â”Š 95â”Š      const { container, getByTestId } = render(\n+â”Š   â”Š 96â”Š        <ApolloProvider client={client}>\n+â”Š   â”Š 97â”Š          <ChatNavbar chat={chat} history={history} />\n+â”Š   â”Š 98â”Š        </ApolloProvider>\n+â”Š   â”Š 99â”Š      );\n+â”Š   â”Š100â”Š\n+â”Š   â”Š101â”Š      fireEvent.click(getByTestId('delete-button'));\n+â”Š   â”Š102â”Š\n+â”Š   â”Š103â”Š      await wait(() =>\n+â”Š   â”Š104â”Š        expect(history.location.pathname).toEqual('/chats')\n+â”Š   â”Š105â”Š      );\n+â”Š   â”Š106â”Š    }\n+â”Š   â”Š107â”Š  })\n â”Š 49â”Š108â”Š});ðŸš«â†µ\n```\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;ChatNavbar.tsx\n```diff\n@@ -1,10 +1,13 @@\n â”Š 1â”Š 1â”Šimport Button from '@material-ui/core/Button';\n â”Š 2â”Š 2â”Šimport Toolbar from '@material-ui/core/Toolbar';\n â”Š 3â”Š 3â”Šimport ArrowBackIcon from '@material-ui/icons/ArrowBack';\n+â”Š  â”Š 4â”Šimport DeleteIcon from '@material-ui/icons/Delete';\n+â”Š  â”Š 5â”Šimport gql from 'graphql-tag';\n â”Š 4â”Š 6â”Šimport React from 'react';\n â”Š 5â”Š 7â”Šimport { useCallback } from 'react';\n â”Š 6â”Š 8â”Šimport styled from 'styled-components';\n â”Š 7â”Š 9â”Šimport { History } from 'history';\n+â”Š  â”Š10â”Šimport { useRemoveChatMutation } from '../../graphql/types';\n â”Š 8â”Š11â”Š\n â”Š 9â”Š12â”Šconst Container = styled(Toolbar) `\n â”Š10â”Š13â”Š  padding: 0;\n```\n```diff\n@@ -20,6 +23,12 @@\n â”Š20â”Š23â”Š  }\n â”Š21â”Š24â”Š` as typeof Button;\n â”Š22â”Š25â”Š\n+â”Š  â”Š26â”Šconst Rest = styled.div `\n+â”Š  â”Š27â”Š  flex: 1;\n+â”Š  â”Š28â”Š  display: flex;\n+â”Š  â”Š29â”Š  justify-content: flex-end;\n+â”Š  â”Š30â”Š`\n+â”Š  â”Š31â”Š\n â”Š23â”Š32â”Šconst Picture = styled.img `\n â”Š24â”Š33â”Š  height: 40px;\n â”Š25â”Š34â”Š  width: 40px;\n```\n```diff\n@@ -34,15 +43,38 @@\n â”Š34â”Š43â”Š  line-height: 56px;\n â”Š35â”Š44â”Š`;\n â”Š36â”Š45â”Š\n+â”Š  â”Š46â”Šconst DeleteButton = styled(Button)`\n+â”Š  â”Š47â”Š  color: var(--primary-text) !important;\n+â”Š  â”Š48â”Š` as typeof Button;\n+â”Š  â”Š49â”Š\n+â”Š  â”Š50â”Šexport const removeChatMutation = gql`\n+â”Š  â”Š51â”Š  mutation RemoveChat($chatId: ID!) {\n+â”Š  â”Š52â”Š    removeChat(chatId: $chatId)\n+â”Š  â”Š53â”Š  }\n+â”Š  â”Š54â”Š`;\n+â”Š  â”Š55â”Š\n â”Š37â”Š56â”Šinterface ChatNavbarProps {\n â”Š38â”Š57â”Š  history: History;\n-â”Š39â”Š  â”Š  chat?: {\n+â”Š  â”Š58â”Š  chat: {\n â”Š40â”Š59â”Š    picture?: string | null;\n â”Š41â”Š60â”Š    name?: string | null;\n+â”Š  â”Š61â”Š    id: string;\n â”Š42â”Š62â”Š  };\n â”Š43â”Š63â”Š};\n â”Š44â”Š64â”Š\n â”Š45â”Š65â”Šconst ChatNavbar: React.FC<ChatNavbarProps> = ({ chat, history }) => {\n+â”Š  â”Š66â”Š  const removeChat = useRemoveChatMutation({\n+â”Š  â”Š67â”Š    variables: {\n+â”Š  â”Š68â”Š      chatId: chat.id\n+â”Š  â”Š69â”Š    }\n+â”Š  â”Š70â”Š  });\n+â”Š  â”Š71â”Š\n+â”Š  â”Š72â”Š  const handleRemoveChat = useCallback(() => {\n+â”Š  â”Š73â”Š    removeChat().then(() => {\n+â”Š  â”Š74â”Š      history.replace('/chats')\n+â”Š  â”Š75â”Š    });\n+â”Š  â”Š76â”Š  }, [removeChat, history]);\n+â”Š  â”Š77â”Š\n â”Š46â”Š78â”Š  const navBack = useCallback(() => {\n â”Š47â”Š79â”Š    history.replace('/chats');\n â”Š48â”Š80â”Š  }, [history]);\n```\n```diff\n@@ -58,6 +90,11 @@\n â”Š 58â”Š 90â”Š          <Name data-testid=\"chat-name\">{chat.name}</Name>\n â”Š 59â”Š 91â”Š        </React.Fragment>\n â”Š 60â”Š 92â”Š      )}\n+â”Š   â”Š 93â”Š      <Rest>\n+â”Š   â”Š 94â”Š        <DeleteButton data-testid=\"delete-button\" onClick={handleRemoveChat}>\n+â”Š   â”Š 95â”Š          <DeleteIcon />\n+â”Š   â”Š 96â”Š        </DeleteButton>\n+â”Š   â”Š 97â”Š      </Rest>\n â”Š 61â”Š 98â”Š    </Container>\n â”Š 62â”Š 99â”Š  );\n â”Š 63â”Š100â”Š};\n```\n\n[}]: #\n\nNormally this is a dangerous behavior because we wipe out the entire history without any warnings, which is not recommended. For tutoring purposes only we will keep it the way it is, because it makes things simple and easier to understand.\n\nTo be able to update the chats list cache, we will implement a `chatRemoved` subscription. The subscription will be broadcasted only to those whoâ€™re participants of the published chat:\n\n[{]: <helper> (diffStep 9.5 module=\"server\")\n\n#### [Server Step 9.5: Add Subscription.chatRemoved](https://github.com/Urigo/WhatsApp-Clone-Server/commit/7f6b7a4)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -151,7 +151,7 @@\n â”Š151â”Š151â”Š      return chat\n â”Š152â”Š152â”Š    },\n â”Š153â”Š153â”Š\n-â”Š154â”Š   â”Š    removeChat(root, { chatId }, { currentUser }) {\n+â”Š   â”Š154â”Š    removeChat(root, { chatId }, { currentUser, pubsub }) {\n â”Š155â”Š155â”Š      if (!currentUser) return null\n â”Š156â”Š156â”Š\n â”Š157â”Š157â”Š      const chatIndex = chats.findIndex(c => c.id === chatId)\n```\n```diff\n@@ -172,6 +172,11 @@\n â”Š172â”Š172â”Š\n â”Š173â”Š173â”Š      chats.splice(chatIndex, 1)\n â”Š174â”Š174â”Š\n+â”Š   â”Š175â”Š      pubsub.publish('chatRemoved', {\n+â”Š   â”Š176â”Š        chatRemoved: chat.id,\n+â”Š   â”Š177â”Š        targetChat: chat,\n+â”Š   â”Š178â”Š      })\n+â”Š   â”Š179â”Š\n â”Š175â”Š180â”Š      return chatId\n â”Š176â”Š181â”Š    }\n â”Š177â”Š182â”Š  },\n```\n```diff\n@@ -200,6 +205,17 @@\n â”Š200â”Š205â”Š          return chatAdded.participants.some(p => p === currentUser.id)\n â”Š201â”Š206â”Š        },\n â”Š202â”Š207â”Š      )\n+â”Š   â”Š208â”Š    },\n+â”Š   â”Š209â”Š\n+â”Š   â”Š210â”Š    chatRemoved: {\n+â”Š   â”Š211â”Š      subscribe: withFilter(\n+â”Š   â”Š212â”Š        (root, args, { pubsub }) => pubsub.asyncIterator('chatRemoved'),\n+â”Š   â”Š213â”Š        ({ targetChat }: { targetChat: Chat }, args, { currentUser }) => {\n+â”Š   â”Š214â”Š          if (!currentUser) return false\n+â”Š   â”Š215â”Š\n+â”Š   â”Š216â”Š          return targetChat.participants.some(p => p === currentUser.id)\n+â”Š   â”Š217â”Š        },\n+â”Š   â”Š218â”Š      )\n â”Š203â”Š219â”Š    }\n â”Š204â”Š220â”Š  }\n â”Š205â”Š221â”Š}\n```\n\n##### Changed schema&#x2F;typeDefs.graphql\n```diff\n@@ -40,4 +40,5 @@\n â”Š40â”Š40â”Štype Subscription {\n â”Š41â”Š41â”Š  messageAdded: Message!\n â”Š42â”Š42â”Š  chatAdded: Chat!\n+â”Š  â”Š43â”Š  chatRemoved: ID!\n â”Š43â”Š44â”Š}\n```\n\n[}]: #\n\nIn the client, we will define the right subscription document:\n\n[{]: <helper> (diffStep 12.5 files=\"graphql/subscriptions\" module=\"client\")\n\n#### Client Step 12.5: Update cache on chat removal\n\n##### Added src&#x2F;graphql&#x2F;subscriptions&#x2F;chatRemoved.subscription.ts\n```diff\n@@ -0,0 +1,7 @@\n+â”Š â”Š1â”Šimport gql from 'graphql-tag';\n+â”Š â”Š2â”Š\n+â”Š â”Š3â”Šexport default gql`\n+â”Š â”Š4â”Š  subscription ChatRemoved {\n+â”Š â”Š5â”Š    chatRemoved\n+â”Š â”Š6â”Š  }\n+â”Š â”Š7â”Š`;\n```\n\n##### Changed src&#x2F;graphql&#x2F;subscriptions&#x2F;index.ts\n```diff\n@@ -1,2 +1,3 @@\n â”Š1â”Š1â”Šexport { default as messageAdded } from './messageAdded.subscription';\n â”Š2â”Š2â”Šexport { default as chatAdded } from './chatAdded.subscription';\n+â”Š â”Š3â”Šexport { default as chatRemoved } from './chatRemoved.subscription';\n```\n\n[}]: #\n\nAnd we will update the `cache.service` to listen to the new subscription and update the `chats` query accordingly. When we deal with the fragment, we remove the `FullChat` fragment because it consists of the `Chat` fragment. If it was the other way around, we would still have some data leftovers from the `FullChat` on the fragment, because of how Apollo-Cache manages the store:\n\n[{]: <helper> (diffStep 12.5 files=\"cache.service\" module=\"client\")\n\n#### Client Step 12.5: Update cache on chat removal\n\n##### Changed src&#x2F;services&#x2F;cache.service.ts\n```diff\n@@ -8,6 +8,7 @@\n â”Š 8â”Š 8â”Š  ChatFragment,\n â”Š 9â”Š 9â”Š  useMessageAddedSubscription,\n â”Š10â”Š10â”Š  useChatAddedSubscription,\n+â”Š  â”Š11â”Š  useChatRemovedSubscription,\n â”Š11â”Š12â”Š} from '../graphql/types';\n â”Š12â”Š13â”Š\n â”Š13â”Š14â”Štype Client = ApolloClient<any> | DataProxy;\n```\n```diff\n@@ -28,6 +29,14 @@\n â”Š28â”Š29â”Š      }\n â”Š29â”Š30â”Š    }\n â”Š30â”Š31â”Š  });\n+â”Š  â”Š32â”Š\n+â”Š  â”Š33â”Š  useChatRemovedSubscription({\n+â”Š  â”Š34â”Š    onSubscriptionData: ({ client, subscriptionData: { data } }) => {\n+â”Š  â”Š35â”Š      if (data) {\n+â”Š  â”Š36â”Š        eraseChat(client, data.chatRemoved);\n+â”Š  â”Š37â”Š      }\n+â”Š  â”Š38â”Š    }\n+â”Š  â”Š39â”Š  });\n â”Š31â”Š40â”Š};\n â”Š32â”Š41â”Š\n â”Š33â”Š42â”Šexport const writeMessage = (client: Client, message: MessageFragment) => {\n```\n```diff\n@@ -131,3 +140,49 @@\n â”Š131â”Š140â”Š    data: { chats },\n â”Š132â”Š141â”Š  });\n â”Š133â”Š142â”Š}\n+â”Š   â”Š143â”Š\n+â”Š   â”Š144â”Šexport const eraseChat = (client: Client, chatId: string) => {\n+â”Š   â”Š145â”Š  const chatType = {\n+â”Š   â”Š146â”Š    __typename: 'Chat',\n+â”Š   â”Š147â”Š    id: chatId\n+â”Š   â”Š148â”Š  };\n+â”Š   â”Š149â”Š\n+â”Š   â”Š150â”Š  const chatIdFromObject = defaultDataIdFromObject(chatType);\n+â”Š   â”Š151â”Š  if (chatIdFromObject === null) {\n+â”Š   â”Š152â”Š    return;\n+â”Š   â”Š153â”Š  }\n+â”Š   â”Š154â”Š\n+â”Š   â”Š155â”Š  client.writeFragment({\n+â”Š   â”Š156â”Š    id: chatIdFromObject,\n+â”Š   â”Š157â”Š    fragment: fragments.fullChat,\n+â”Š   â”Š158â”Š    fragmentName: 'FullChat',\n+â”Š   â”Š159â”Š    data: null,\n+â”Š   â”Š160â”Š  })\n+â”Š   â”Š161â”Š\n+â”Š   â”Š162â”Š  let data;\n+â”Š   â”Š163â”Š  try {\n+â”Š   â”Š164â”Š    data = client.readQuery({\n+â”Š   â”Š165â”Š      query: queries.chats,\n+â”Š   â”Š166â”Š    });\n+â”Š   â”Š167â”Š  } catch (e) {\n+â”Š   â”Š168â”Š    return;\n+â”Š   â”Š169â”Š  }\n+â”Š   â”Š170â”Š\n+â”Š   â”Š171â”Š  if (!data || !data.chats) return;\n+â”Š   â”Š172â”Š\n+â”Š   â”Š173â”Š  const chats = data.chats;\n+â”Š   â”Š174â”Š\n+â”Š   â”Š175â”Š  if (!chats) return;\n+â”Š   â”Š176â”Š\n+â”Š   â”Š177â”Š  const chatIndex = chats.findIndex((c: any) => c.id === chatId);\n+â”Š   â”Š178â”Š\n+â”Š   â”Š179â”Š  if (chatIndex === -1) return;\n+â”Š   â”Š180â”Š\n+â”Š   â”Š181â”Š  // The chat will appear at the top of the ChatsList component\n+â”Š   â”Š182â”Š  chats.splice(chatIndex, 1);\n+â”Š   â”Š183â”Š\n+â”Š   â”Š184â”Š  client.writeQuery({\n+â”Š   â”Š185â”Š    query: queries.chats,\n+â”Š   â”Š186â”Š    data: { chats: chats },\n+â”Š   â”Š187â”Š  });\n+â”Š   â”Š188â”Š}\n```\n\n[}]: #\n\nWe will also update the `ChatRoomScreen` to redirect us to the `/chats` route if the chat was not found. The render method of the component will be re-triggered automatically by `react-apollo-hooks` if the cached result of `useGetChat()` hook has changed, which means that even if you didnâ€™t actively remove the chat, you will still be redirected as a result:\n\n[{]: <helper> (diffStep 12.5 files=\"ChatRoom\" module=\"client\")\n\n#### Client Step 12.5: Update cache on chat removal\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;ChatNavbar.tsx\n```diff\n@@ -8,6 +8,7 @@\n â”Š 8â”Š 8â”Šimport styled from 'styled-components';\n â”Š 9â”Š 9â”Šimport { History } from 'history';\n â”Š10â”Š10â”Šimport { useRemoveChatMutation } from '../../graphql/types';\n+â”Š  â”Š11â”Šimport { eraseChat } from '../../services/cache.service';\n â”Š11â”Š12â”Š\n â”Š12â”Š13â”Šconst Container = styled(Toolbar) `\n â”Š13â”Š14â”Š  padding: 0;\n```\n```diff\n@@ -66,6 +67,9 @@\n â”Š66â”Š67â”Š  const removeChat = useRemoveChatMutation({\n â”Š67â”Š68â”Š    variables: {\n â”Š68â”Š69â”Š      chatId: chat.id\n+â”Š  â”Š70â”Š    },\n+â”Š  â”Š71â”Š    update: (client, { data: { removeChat } }) => {\n+â”Š  â”Š72â”Š      eraseChat(client, removeChat);\n â”Š69â”Š73â”Š    }\n â”Š70â”Š74â”Š  });\n â”Š71â”Š75â”Š\n```\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -1,6 +1,7 @@\n â”Š1â”Š1â”Šimport gql from 'graphql-tag';\n â”Š2â”Š2â”Šimport React from 'react';\n â”Š3â”Š3â”Šimport { useCallback } from 'react';\n+â”Š â”Š4â”Šimport { Redirect } from 'react-router-dom';\n â”Š4â”Š5â”Šimport styled from 'styled-components';\n â”Š5â”Š6â”Šimport ChatNavbar from './ChatNavbar';\n â”Š6â”Š7â”Šimport MessageInput from './MessageInput';\n```\n```diff\n@@ -86,6 +87,13 @@\n â”Š86â”Š87â”Š  if (loadingChat) return null;\n â”Š87â”Š88â”Š  if (chat === null) return null;\n â”Š88â”Š89â”Š\n+â”Š  â”Š90â”Š  // Chat was probably removed from cache by the subscription handler\n+â”Š  â”Š91â”Š  if (!chat) {\n+â”Š  â”Š92â”Š    return (\n+â”Š  â”Š93â”Š      <Redirect to=\"/chats\" />\n+â”Š  â”Š94â”Š    );\n+â”Š  â”Š95â”Š  }\n+â”Š  â”Š96â”Š\n â”Š89â”Š97â”Š  return (\n â”Š90â”Š98â”Š    <Container>\n â”Š91â”Š99â”Š      <ChatNavbar chat={chat} history={history} />\n```\n\n[}]: #\n\nTODO: maybe mention that ApolloCache doesnâ€™t have Garbage Collector so even though the object is removed, everything else related to it says in cache."
          },
          {
            "manualTitle": "Step 13: Authentication",
            "stepRevision": "71ccc9d595ba621cfbea06c102ddf8e951aecc34",
            "manualView": "In the previous step weâ€™ve set the ground for the authentication system in our app. We have a users collection which can be used to distinguish which data the client is authorized to view, and we have a context handler which can retrieve the current user logged in based on the received value of the `cookie` header. Itâ€™s definitely a good starting point, but it misses a lot of things.\n\nIn this chapter we will implement a cookie-based authentication system. There are many ways to implement an authentication system in an app, but cookie-based authentication is one of the most popular ones, hence we will go with that method. Essentially the authentication flow in our app should look very simple: a user will be able to sign-in with a dedicated screen, and if he doesnâ€™t own an account he can use the sign-up screen to create a new one. The more complicated part in this flow is the back-end, which is the core of this chapter. So before we get into the implementation, we need to understand the authentication process:\n\n- A user logs in with a username and a password.\nThe server compares the received username and password to the ones stored in the database.\n- If the comparison was successful, the server will generate a token and will set it as a cookie.\n- Each time a request is sent, the server will retrieve the username from the stored token on the cookie header and will send data back accordingly.\n\n![auth-flow](https://user-images.githubusercontent.com/7648874/55929679-55e94200-5c50-11e9-9fe7-54ad6194a572.png)\n\nThe stored token will save us the hassle of re-specifying the username and password over and over again each and every request. Itâ€™s important to note that everything in the authentication process is encrypted, **sensitive information will never be stored or sent in its raw form**, otherwise data might be stolen in case of a DB breach or a request hijacking. This is what it means for our app:\n\n- Passwords will always be stored in an encrypted form in the DB using an algorithm called [Bcrypt](https://en.wikipedia.org/wiki/Bcrypt). Bcrypt has the ability to compare the password in its raw form to the encrypted one, which can help us authorize the user.\n\n- Tokens are self contained. That means that once we decode the encrypted string we can get a hold of the username string. This form of encrypted tokens is called [Json Web Token (JWT)](https://jwt.io/).\n\n> We're not going to elaborate about the algorithm behind each encryption method because we want to focus more on practicality, although it's very much recommended to understand how each method works before proceeding.\n\nThe implementation will follow the principles above. Authentication is a hot topic in the GraphQL world and there are several ways of doing so. We will start with the back-end and set the infrastructure for authentication, and then we will move on to the front-end.\n\nWeâ€™re gonna expose 2 new mutations from GraphQL Schema: `signIn` and `signUp`. `/sign-out` is unnecessary because it can be done locally by deleting the right cookie. Our back-end is gonna grow bigger so first we will separate the Express app from the Apollo Server instance, and extract the env vars to a dedicated module:\n\n[{]: <helper> (diffStep 10.1 module=\"server\")\n\n#### [Server Step 10.1: Separate app into a different module](https://github.com/Urigo/WhatsApp-Clone-Server/commit/47bf939)\n\n##### Added app.ts\n```diff\n@@ -0,0 +1,15 @@\n+â”Š  â”Š 1â”Šimport bodyParser from 'body-parser'\n+â”Š  â”Š 2â”Šimport cors from 'cors'\n+â”Š  â”Š 3â”Šimport cookieParser from 'cookie-parser'\n+â”Š  â”Š 4â”Šimport express from 'express'\n+â”Š  â”Š 5â”Šimport { origin } from './env'\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Šexport const app = express()\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Šapp.use(cors({ credentials: true, origin }))\n+â”Š  â”Š10â”Šapp.use(bodyParser.json())\n+â”Š  â”Š11â”Šapp.use(cookieParser())\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Šapp.get('/_ping', (req, res) => {\n+â”Š  â”Š14â”Š  res.send('pong')\n+â”Š  â”Š15â”Š})\n```\n\n##### Added env.ts\n```diff\n@@ -0,0 +1,2 @@\n+â”Š â”Š1â”Šexport const origin = process.env.ORIGIN || 'http://localhost:3000'\n+â”Š â”Š2â”Šexport const port = process.env.PORT || 4000\n```\n\n##### Changed index.ts\n```diff\n@@ -1,23 +1,10 @@\n â”Š 1â”Š 1â”Šimport { ApolloServer, gql, PubSub } from 'apollo-server-express'\n-â”Š 2â”Š  â”Šimport bodyParser from 'body-parser'\n-â”Š 3â”Š  â”Šimport cors from 'cors'\n-â”Š 4â”Š  â”Šimport cookieParser from 'cookie-parser'\n-â”Š 5â”Š  â”Šimport express from 'express'\n â”Š 6â”Š 2â”Šimport http from 'http'\n+â”Š  â”Š 3â”Šimport { app } from './app'\n â”Š 7â”Š 4â”Šimport { users } from './db'\n+â”Š  â”Š 5â”Šimport { origin, port } from './env'\n â”Š 8â”Š 6â”Šimport schema from './schema'\n â”Š 9â”Š 7â”Š\n-â”Š10â”Š  â”Šconst app = express()\n-â”Š11â”Š  â”Š\n-â”Š12â”Š  â”Šconst origin = process.env.ORIGIN || 'http://localhost:3000'\n-â”Š13â”Š  â”Šapp.use(cors({ credentials: true, origin }))\n-â”Š14â”Š  â”Šapp.use(bodyParser.json())\n-â”Š15â”Š  â”Šapp.use(cookieParser())\n-â”Š16â”Š  â”Š\n-â”Š17â”Š  â”Šapp.get('/_ping', (req, res) => {\n-â”Š18â”Š  â”Š  res.send('pong')\n-â”Š19â”Š  â”Š})\n-â”Š20â”Š  â”Š\n â”Š21â”Š 8â”Šconst pubsub = new PubSub()\n â”Š22â”Š 9â”Šconst server = new ApolloServer({\n â”Š23â”Š10â”Š  schema,\n```\n```diff\n@@ -36,8 +23,6 @@\n â”Š36â”Š23â”Šconst httpServer = http.createServer(app)\n â”Š37â”Š24â”Šserver.installSubscriptionHandlers(httpServer)\n â”Š38â”Š25â”Š\n-â”Š39â”Š  â”Šconst port = process.env.PORT || 4000\n-â”Š40â”Š  â”Š\n â”Š41â”Š26â”ŠhttpServer.listen(port, () => {\n â”Š42â”Š27â”Š  console.log(`Server is listening on port ${port}`)\n â”Š43â”Š28â”Š})\n```\n\n[}]: #\n\nWe will first start with the `signIn` mutation, so we can test it against pre-defined user credentials, and then we will proceed to implementing the `signUp` mutation. It would be a lot easier to progress this way. For that we will install a couple of packages:\n\n- `bcrypt` - which is responsible for running a one-way encryption against received passwords before theyâ€™re stored in the DB.\n- `jsonwebtoken` - responsible for encrypting the logged-in username before itâ€™s set as a cooky and decrypting it once itâ€™s sent back with a request.\n\n    $ yarn add bcrypt jsonwebtoken\n\n\n    $ yarn add --dev @types/bcrypt @types/jsonwebtoken\n\nAnd we will implement the `signIn` mutation:\n\n[{]: <helper> (diffStep 10.2 files=\"schema\" module=\"server\")\n\n#### [Server Step 10.2: Add signIn mutation](https://github.com/Urigo/WhatsApp-Clone-Server/commit/c6ac755)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -2,6 +2,9 @@\n â”Š 2â”Š 2â”Šimport { GraphQLDateTime } from 'graphql-iso-date'\n â”Š 3â”Š 3â”Šimport { User, Message, Chat, chats, messages, users } from '../db'\n â”Š 4â”Š 4â”Šimport { Resolvers } from '../types/graphql'\n+â”Š  â”Š 5â”Šimport { secret, expiration } from '../env'\n+â”Š  â”Š 6â”Šimport bcrypt from 'bcrypt'\n+â”Š  â”Š 7â”Šimport jwt from 'jsonwebtoken'\n â”Š 5â”Š 8â”Š\n â”Š 6â”Š 9â”Šconst resolvers: Resolvers = {\n â”Š 7â”Š10â”Š  Date: GraphQLDateTime,\n```\n```diff\n@@ -89,6 +92,27 @@\n â”Š 89â”Š 92â”Š  },\n â”Š 90â”Š 93â”Š\n â”Š 91â”Š 94â”Š  Mutation: {\n+â”Š   â”Š 95â”Š    signIn(root, { username, password}, { res }) {\n+â”Š   â”Š 96â”Š\n+â”Š   â”Š 97â”Š      const user = users.find(u => u.username === username)\n+â”Š   â”Š 98â”Š\n+â”Š   â”Š 99â”Š      if (!user) {\n+â”Š   â”Š100â”Š        throw new Error('user not found')\n+â”Š   â”Š101â”Š      }\n+â”Š   â”Š102â”Š\n+â”Š   â”Š103â”Š      const passwordsMatch = bcrypt.compareSync(password, user.password)\n+â”Š   â”Š104â”Š\n+â”Š   â”Š105â”Š      if (!passwordsMatch) {\n+â”Š   â”Š106â”Š        throw new Error('password is incorrect')\n+â”Š   â”Š107â”Š      }\n+â”Š   â”Š108â”Š\n+â”Š   â”Š109â”Š      const authToken = jwt.sign(username, secret)\n+â”Š   â”Š110â”Š\n+â”Š   â”Š111â”Š      res.cookie('authToken', authToken, { maxAge: expiration })\n+â”Š   â”Š112â”Š\n+â”Š   â”Š113â”Š      return user;\n+â”Š   â”Š114â”Š    },\n+â”Š   â”Š115â”Š\n â”Š 92â”Š116â”Š    addMessage(root, { chatId, content }, { currentUser, pubsub }) {\n â”Š 93â”Š117â”Š      if (!currentUser) return null\n â”Š 94â”Š118â”Š\n```\n\n##### Changed schema&#x2F;typeDefs.graphql\n```diff\n@@ -32,6 +32,7 @@\n â”Š32â”Š32â”Š}\n â”Š33â”Š33â”Š\n â”Š34â”Š34â”Štype Mutation {\n+â”Š  â”Š35â”Š  signIn(username: String!, password: String!): User\n â”Š35â”Š36â”Š  addMessage(chatId: ID!, content: String!): Message\n â”Š36â”Š37â”Š  addChat(recipientId: ID!): Chat\n â”Š37â”Š38â”Š  removeChat(chatId: ID!): ID\n```\n\n[}]: #\n\nAs you can see we use a special secret before we encrypt the username with JWT. The same secret will be used later on to decrypt the token back into username when getting requests. If someone malicious will get a hold of that password, he can fabricate an authentication token for every user that he wants, **thus itâ€™s important to choose a strong secret**.\n\nWhen building the context for our GraphQL resolvers, we will decode the received cookie with JWT using the same secret to determine the username who made the request. Once we have that username, we can simply retrieve the original user from the DB and define it on the context:\n\n[{]: <helper> (diffStep 10.3 module=\"server\")\n\n#### [Server Step 10.3: Get current user from auth token](https://github.com/Urigo/WhatsApp-Clone-Server/commit/51cae3f)\n\n##### Changed index.ts\n```diff\n@@ -1,18 +1,27 @@\n â”Š 1â”Š 1â”Šimport { ApolloServer, gql, PubSub } from 'apollo-server-express'\n â”Š 2â”Š 2â”Šimport http from 'http'\n+â”Š  â”Š 3â”Šimport jwt from 'jsonwebtoken'\n â”Š 3â”Š 4â”Šimport { app } from './app'\n â”Š 4â”Š 5â”Šimport { users } from './db'\n-â”Š 5â”Š  â”Šimport { origin, port } from './env'\n+â”Š  â”Š 6â”Šimport { origin, port, secret } from './env'\n â”Š 6â”Š 7â”Šimport schema from './schema'\n â”Š 7â”Š 8â”Š\n â”Š 8â”Š 9â”Šconst pubsub = new PubSub()\n â”Š 9â”Š10â”Šconst server = new ApolloServer({\n â”Š10â”Š11â”Š  schema,\n-â”Š11â”Š  â”Š  context: ({ req, res }) => ({\n-â”Š12â”Š  â”Š    currentUser: users.find(u => u.id === req.cookies.currentUserId),\n-â”Š13â”Š  â”Š    pubsub,\n-â”Š14â”Š  â”Š    res,\n-â”Š15â”Š  â”Š  }),\n+â”Š  â”Š12â”Š  context: ({ req, res }) => {\n+â”Š  â”Š13â”Š    let currentUser;\n+â”Š  â”Š14â”Š    if (req.cookies.authToken) {\n+â”Š  â”Š15â”Š      const username = jwt.verify(req.cookies.authToken, secret) as string\n+â”Š  â”Š16â”Š      currentUser = username && users.find(u => u.username === username)\n+â”Š  â”Š17â”Š    }\n+â”Š  â”Š18â”Š\n+â”Š  â”Š19â”Š    return {\n+â”Š  â”Š20â”Š      currentUser,\n+â”Š  â”Š21â”Š      pubsub,\n+â”Š  â”Š22â”Š      res,\n+â”Š  â”Š23â”Š    }\n+â”Š  â”Š24â”Š  },\n â”Š16â”Š25â”Š})\n â”Š17â”Š26â”Š\n â”Š18â”Š27â”Šserver.applyMiddleware({\n```\n\n[}]: #\n\nYou might have noticed that the User schema has been updated, because we try to address the `user.username` property. The authentication in our app will be done with a username and a password; accordingly, we will update our User type definitions and the user documents in the users collection mock. The credentials that weâ€™re going to store can actually be used to sign-in to our app:\n\n[{]: <helper> (diffStep 10.4 module=\"server\")\n\n#### [Server Step 10.4: Update user schema to contain credentials](https://github.com/Urigo/WhatsApp-Clone-Server/commit/754bdf4)\n\n##### Changed db.ts\n```diff\n@@ -1,6 +1,8 @@\n â”Š1â”Š1â”Šexport type User = {\n â”Š2â”Š2â”Š  id: string\n â”Š3â”Š3â”Š  name: string\n+â”Š â”Š4â”Š  username: string\n+â”Š â”Š5â”Š  password: string\n â”Š4â”Š6â”Š  picture: string\n â”Š5â”Š7â”Š}\n â”Š6â”Š8â”Š\n```\n```diff\n@@ -27,26 +29,36 @@\n â”Š27â”Š29â”Š    {\n â”Š28â”Š30â”Š      id: '1',\n â”Š29â”Š31â”Š      name: 'Ray Edwards',\n+â”Š  â”Š32â”Š      username: 'ray',\n+â”Š  â”Š33â”Š      password: '$2a$08$NO9tkFLCoSqX1c5wk3s7z.JfxaVMKA.m7zUDdDwEquo4rvzimQeJm', // 111\n â”Š30â”Š34â”Š      picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n â”Š31â”Š35â”Š    },\n â”Š32â”Š36â”Š    {\n â”Š33â”Š37â”Š      id: '2',\n â”Š34â”Š38â”Š      name: 'Ethan Gonzalez',\n+â”Š  â”Š39â”Š      username: 'ethan',\n+â”Š  â”Š40â”Š      password: '$2a$08$xE4FuCi/ifxjL2S8CzKAmuKLwv18ktksSN.F3XYEnpmcKtpbpeZgO', // 222\n â”Š35â”Š41â”Š      picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n â”Š36â”Š42â”Š    },\n â”Š37â”Š43â”Š    {\n â”Š38â”Š44â”Š      id: '3',\n â”Š39â”Š45â”Š      name: 'Bryan Wallace',\n+â”Š  â”Š46â”Š      username: 'bryan',\n+â”Š  â”Š47â”Š      password: '$2a$08$UHgH7J8G6z1mGQn2qx2kdeWv0jvgHItyAsL9hpEUI3KJmhVW5Q1d.', // 333\n â”Š40â”Š48â”Š      picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n â”Š41â”Š49â”Š    },\n â”Š42â”Š50â”Š    {\n â”Š43â”Š51â”Š      id: '4',\n â”Š44â”Š52â”Š      name: 'Avery Stewart',\n+â”Š  â”Š53â”Š      username: 'avery',\n+â”Š  â”Š54â”Š      password: '$2a$08$wR1k5Q3T9FC7fUgB7Gdb9Os/GV7dGBBf4PLlWT7HERMFhmFDt47xi', // 444\n â”Š45â”Š55â”Š      picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n â”Š46â”Š56â”Š    },\n â”Š47â”Š57â”Š    {\n â”Š48â”Š58â”Š      id: '5',\n â”Š49â”Š59â”Š      name: 'Katie Peterson',\n+â”Š  â”Š60â”Š      username: 'katie',\n+â”Š  â”Š61â”Š      password: '$2a$08$6.mbXqsDX82ZZ7q5d8Osb..JrGSsNp4R3IKj7mxgF6YGT0OmMw242', // 555\n â”Š50â”Š62â”Š      picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n â”Š51â”Š63â”Š    },\n â”Š52â”Š64â”Š  ])\n```\n```diff\n@@ -106,4 +118,4 @@\n â”Š106â”Š118â”Š  ])\n â”Š107â”Š119â”Š}\n â”Š108â”Š120â”Š\n-â”Š109â”Š   â”ŠresetDb()\n+â”Š   â”Š121â”ŠresetDb()ðŸš«â†µ\n```\n\n[}]: #\n\nTo test it out, we will run our front-end application and open the dev-console. Using the Apollo Client we will send a request to the `signIn` mutation. We can use the credentials of one of the users stored in the DB. As for now all our restricted routes are observing the `currentUserId` cookie. This is wrong and no longer relevant. Letâ€™s change the `withAuth()` method to observe the `authToken` cookie so we can test our new mutation successfully:\n\n[{]: <helper> (diffStep 13.1 module=\"client\")\n\n#### Client Step 13.1: Use authToken cookie\n\n##### Changed src&#x2F;services&#x2F;auth.service.tsx\n```diff\n@@ -23,8 +23,8 @@\n â”Š23â”Š23â”Š  };\n â”Š24â”Š24â”Š};\n â”Š25â”Š25â”Š\n-â”Š26â”Š  â”Šexport const signIn = (currentUserId: string) => {\n-â”Š27â”Š  â”Š  document.cookie = `currentUserId=${currentUserId}`;\n+â”Š  â”Š26â”Šexport const signIn = (authToken: string) => {\n+â”Š  â”Š27â”Š  document.cookie = `authToken=${authToken}`;\n â”Š28â”Š28â”Š\n â”Š29â”Š29â”Š  // This will become async in the near future\n â”Š30â”Š30â”Š  return Promise.resolve();\n```\n```diff\n@@ -33,12 +33,12 @@\n â”Š33â”Š33â”Šexport const signOut = () => {\n â”Š34â”Š34â”Š  // \"expires\" represents the lifespan of a cookie. Beyond that date the cookie will\n â”Š35â”Š35â”Š  // be deleted by the browser. \"expires\" cannot be viewed from \"document.cookie\"\n-â”Š36â”Š  â”Š  document.cookie = `currentUserId=;expires=${new Date(0)}`;\n+â”Š  â”Š36â”Š  document.cookie = `authToken=;expires=${new Date(0)}`;\n â”Š37â”Š37â”Š\n â”Š38â”Š38â”Š  // Clear cache\n â”Š39â”Š39â”Š  return client.clearStore();\n â”Š40â”Š40â”Š};\n â”Š41â”Š41â”Š\n â”Š42â”Š42â”Šexport const isSignedIn = () => {\n-â”Š43â”Š  â”Š  return /currentUserId=.+(;|$)/.test(document.cookie);\n+â”Š  â”Š43â”Š  return /authToken=.+(;|$)/.test(document.cookie);\n â”Š44â”Š44â”Š};ðŸš«â†µ\n```\n\n[}]: #\n\nNow we can perform the signIn. It would be a good idea to signIn with the first user - `ray`, since all the DB mock is built around him:\n\n```js\nmutation signIn(username: 'ray', password: '111') {\n  id\n}\n```\n\nNow if we would look at the value of `document.cookie` we should see a key named `authToken` with a JWT token and the `ChatsListScreen` should show the chats which are relevant to `ray`. To complete the sign-in flow we would need to update the `AuthScreen` and the `auth.service` to use username and password and the actual `sign-in` mutation weâ€™ve just implemented.\n\nTo check if weâ€™re authorized to visit a route, not only we would need to check if we have the `authToken` cookie defined, but we would also need to validate it against the server to see that it actually references a real user. For that we will implement `Query.me` which will send us back the current user logged in directly from the context:\n\n[{]: <helper> (diffStep 10.5 module=\"server\")\n\n#### [Server Step 10.5: Add Query.me](https://github.com/Urigo/WhatsApp-Clone-Server/commit/234afe4)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -68,6 +68,10 @@\n â”Š68â”Š68â”Š  },\n â”Š69â”Š69â”Š\n â”Š70â”Š70â”Š  Query: {\n+â”Š  â”Š71â”Š    me(root, args, { currentUser }) {\n+â”Š  â”Š72â”Š      return currentUser || null\n+â”Š  â”Š73â”Š    },\n+â”Š  â”Š74â”Š\n â”Š71â”Š75â”Š    chats(root, args, { currentUser }) {\n â”Š72â”Š76â”Š      if (!currentUser) return []\n â”Š73â”Š77â”Š\n```\n\n##### Changed schema&#x2F;typeDefs.graphql\n```diff\n@@ -26,6 +26,7 @@\n â”Š26â”Š26â”Š}\n â”Š27â”Š27â”Š\n â”Š28â”Š28â”Štype Query {\n+â”Š  â”Š29â”Š  me: User\n â”Š29â”Š30â”Š  chats: [Chat!]!\n â”Š30â”Š31â”Š  chat(chatId: ID!): Chat\n â”Š31â”Š32â”Š  users: [User!]!\n```\n\n##### Added tests&#x2F;queries&#x2F;getMe.test.ts\n```diff\n@@ -0,0 +1,33 @@\n+â”Š  â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing'\n+â”Š  â”Š 2â”Šimport { ApolloServer, gql } from 'apollo-server-express'\n+â”Š  â”Š 3â”Šimport schema from '../../schema'\n+â”Š  â”Š 4â”Šimport { users } from '../../db'\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šdescribe('Query.me', () => {\n+â”Š  â”Š 7â”Š  it('should fetch current user', async () => {\n+â”Š  â”Š 8â”Š    const server = new ApolloServer({\n+â”Š  â”Š 9â”Š      schema,\n+â”Š  â”Š10â”Š      context: () => ({\n+â”Š  â”Š11â”Š        currentUser: users[0],\n+â”Š  â”Š12â”Š      }),\n+â”Š  â”Š13â”Š    })\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”Š    const { query } = createTestClient(server)\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š    const res = await query({\n+â”Š  â”Š18â”Š      query: gql `\n+â”Š  â”Š19â”Š        query GetMe {\n+â”Š  â”Š20â”Š          me {\n+â”Š  â”Š21â”Š            id\n+â”Š  â”Š22â”Š            name\n+â”Š  â”Š23â”Š            picture\n+â”Š  â”Š24â”Š          }\n+â”Š  â”Š25â”Š        }\n+â”Š  â”Š26â”Š      `,\n+â”Š  â”Š27â”Š    })\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š    expect(res.data).toBeDefined()\n+â”Š  â”Š30â”Š    expect(res.errors).toBeUndefined()\n+â”Š  â”Š31â”Š    expect(res.data).toMatchSnapshot()\n+â”Š  â”Š32â”Š  })\n+â”Š  â”Š33â”Š})\n```\n\n[}]: #\n\nNow back to the `auth.service`, we will replace the `signIn()` method implementation with one that actually calls the `signIn` mutation in our API:\n\n[{]: <helper> (diffStep 13.2 module=\"client\")\n\n#### Client Step 13.2: Update auth service to call signIn mutation\n\n##### Changed src&#x2F;services&#x2F;auth.service.tsx\n```diff\n@@ -2,6 +2,7 @@\n â”Š2â”Š2â”Šimport { Redirect } from 'react-router-dom';\n â”Š3â”Š3â”Šimport client from '../client';\n â”Š4â”Š4â”Šimport { useCacheService } from './cache.service';\n+â”Š â”Š5â”Šimport gql from 'graphql-tag';\n â”Š5â”Š6â”Š\n â”Š6â”Š7â”Šexport const withAuth = <P extends object>(Component: React.ComponentType<P>) => {\n â”Š7â”Š8â”Š  return (props: any) => {\n```\n```diff\n@@ -18,24 +19,30 @@\n â”Š18â”Š19â”Š    useCacheService();\n â”Š19â”Š20â”Š\n â”Š20â”Š21â”Š    return (\n-â”Š21â”Š  â”Š      <Component {...props as P} />\n+â”Š  â”Š22â”Š        <Component {...props as P} />\n â”Š22â”Š23â”Š    );\n â”Š23â”Š24â”Š  };\n â”Š24â”Š25â”Š};\n â”Š25â”Š26â”Š\n-â”Š26â”Š  â”Šexport const signIn = (authToken: string) => {\n-â”Š27â”Š  â”Š  document.cookie = `authToken=${authToken}`;\n-â”Š28â”Š  â”Š\n-â”Š29â”Š  â”Š  // This will become async in the near future\n-â”Š30â”Š  â”Š  return Promise.resolve();\n+â”Š  â”Š27â”Šexport const signIn = ({ username, password }: { username: string, password: string}) => {\n+â”Š  â”Š28â”Š  return client.mutate({\n+â”Š  â”Š29â”Š    mutation: gql`\n+â”Š  â”Š30â”Š      mutation signIn($username: String!, $password: String!) {\n+â”Š  â”Š31â”Š        signIn(username: $username, password: $password) {\n+â”Š  â”Š32â”Š          id\n+â”Š  â”Š33â”Š        }\n+â”Š  â”Š34â”Š      }\n+â”Š  â”Š35â”Š    `,\n+â”Š  â”Š36â”Š    variables: {\n+â”Š  â”Š37â”Š      username,\n+â”Š  â”Š38â”Š      password\n+â”Š  â”Š39â”Š    }\n+â”Š  â”Š40â”Š  });\n â”Š31â”Š41â”Š};\n â”Š32â”Š42â”Š\n â”Š33â”Š43â”Šexport const signOut = () => {\n-â”Š34â”Š  â”Š  // \"expires\" represents the lifespan of a cookie. Beyond that date the cookie will\n-â”Š35â”Š  â”Š  // be deleted by the browser. \"expires\" cannot be viewed from \"document.cookie\"\n â”Š36â”Š44â”Š  document.cookie = `authToken=;expires=${new Date(0)}`;\n â”Š37â”Š45â”Š\n-â”Š38â”Š  â”Š  // Clear cache\n â”Š39â”Š46â”Š  return client.clearStore();\n â”Š40â”Š47â”Š};\n```\n\n[}]: #\n\nAnd we will use the GraphQL query weâ€™ve just implemented to check if the user actually exists within the DB before we proceed to the restricted route:\n\n[{]: <helper> (diffStep 13.3 module=\"client\")\n\n#### Client Step 13.3: Validate auth token against the back-end on restricted route\n\n##### Added src&#x2F;graphql&#x2F;queries&#x2F;me.query.ts\n```diff\n@@ -0,0 +1,11 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag';\n+â”Š  â”Š 2â”Šimport * as fragments from '../fragments';\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šexport default gql`\n+â”Š  â”Š 5â”Š  query Me {\n+â”Š  â”Š 6â”Š    me {\n+â”Š  â”Š 7â”Š      ...User\n+â”Š  â”Š 8â”Š    }\n+â”Š  â”Š 9â”Š  }\n+â”Š  â”Š10â”Š  ${fragments.user}\n+â”Š  â”Š11â”Š`;\n```\n\n##### Changed src&#x2F;services&#x2F;auth.service.tsx\n```diff\n@@ -1,9 +1,17 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n+â”Š  â”Š 2â”Šimport { useContext } from 'react';\n â”Š 2â”Š 3â”Šimport { Redirect } from 'react-router-dom';\n â”Š 3â”Š 4â”Šimport client from '../client';\n+â”Š  â”Š 5â”Šimport { useMeQuery, User } from '../graphql/types';\n â”Š 4â”Š 6â”Šimport { useCacheService } from './cache.service';\n â”Š 5â”Š 7â”Šimport gql from 'graphql-tag';\n â”Š 6â”Š 8â”Š\n+â”Š  â”Š 9â”Šconst MyContext = React.createContext<User|null>(null);\n+â”Š  â”Š10â”Š\n+â”Š  â”Š11â”Šexport const useMe = () => {\n+â”Š  â”Š12â”Š  return useContext(MyContext);\n+â”Š  â”Š13â”Š};\n+â”Š  â”Š14â”Š\n â”Š 7â”Š15â”Šexport const withAuth = <P extends object>(Component: React.ComponentType<P>) => {\n â”Š 8â”Š16â”Š  return (props: any) => {\n â”Š 9â”Š17â”Š    if (!isSignedIn()) {\n```\n```diff\n@@ -16,10 +24,24 @@\n â”Š16â”Š24â”Š      );\n â”Š17â”Š25â”Š    }\n â”Š18â”Š26â”Š\n+â”Š  â”Š27â”Š    const { data, error, loading } = useMeQuery();\n+â”Š  â”Š28â”Š\n â”Š19â”Š29â”Š    useCacheService();\n â”Š20â”Š30â”Š\n+â”Š  â”Š31â”Š    if (loading) return null;\n+â”Š  â”Š32â”Š\n+â”Š  â”Š33â”Š    if (data === undefined) return null;\n+â”Š  â”Š34â”Š\n+â”Š  â”Š35â”Š    if (error || !data.me) {\n+â”Š  â”Š36â”Š      signOut();\n+â”Š  â”Š37â”Š\n+â”Š  â”Š38â”Š      return <Redirect to=\"/sign-in\" />;\n+â”Š  â”Š39â”Š    }\n+â”Š  â”Š40â”Š\n â”Š21â”Š41â”Š    return (\n+â”Š  â”Š42â”Š      <MyContext.Provider value={data.me}>\n â”Š22â”Š43â”Š        <Component {...props as P} />\n+â”Š  â”Š44â”Š      </MyContext.Provider>\n â”Š23â”Š45â”Š    );\n â”Š24â”Š46â”Š  };\n â”Š25â”Š47â”Š};\n```\n```diff\n@@ -48,4 +70,4 @@\n â”Š48â”Š70â”Š\n â”Š49â”Š71â”Šexport const isSignedIn = () => {\n â”Š50â”Š72â”Š  return /authToken=.+(;|$)/.test(document.cookie);\n-â”Š51â”Š  â”Š};ðŸš«â†µ\n+â”Š  â”Š73â”Š};\n```\n\n[}]: #\n\nwe will use the new query to try and fetch the user directly from the back-end, and we will only proceed if the user was actually found. In addition, we will replace the `signIn()` method to call `signIn` mutation:\n\n[{]: <helper> (diffStep 13.4 module=\"client\")\n\n#### Client Step 13.4: Add username and password to AuthScreen\n\n##### Changed src&#x2F;components&#x2F;AuthScreen&#x2F;index.tsx\n```diff\n@@ -114,21 +114,34 @@\n â”Š114â”Š114â”Š` as typeof MaterialButton;\n â”Š115â”Š115â”Š\n â”Š116â”Š116â”Šconst AuthScreen: React.FC<RouteComponentProps<any>> = ({ history }) => {\n-â”Š117â”Š   â”Š  const [userId, setUserId] = useState('');\n+â”Š   â”Š117â”Š  const [username, setUsername] = useState('');\n+â”Š   â”Š118â”Š  const [password, setPassword] = useState('');\n+â”Š   â”Š119â”Š  // eslint-disable-next-line\n+â”Š   â”Š120â”Š  const [error, setError] = useState('');\n+â”Š   â”Š121â”Š\n+â”Š   â”Š122â”Š  const onUsernameChange = useCallback(({ target }) => {\n+â”Š   â”Š123â”Š    setError('');\n+â”Š   â”Š124â”Š    setUsername(target.value);\n+â”Š   â”Š125â”Š  }, []);\n â”Š118â”Š126â”Š\n-â”Š119â”Š   â”Š  const onUserIdChange = useCallback(({ target }) => {\n-â”Š120â”Š   â”Š    setUserId(target.value);\n+â”Š   â”Š127â”Š  const onPasswordChange = useCallback(({ target }) => {\n+â”Š   â”Š128â”Š    setError('');\n+â”Š   â”Š129â”Š    setPassword(target.value);\n â”Š121â”Š130â”Š  }, []);\n â”Š122â”Š131â”Š\n â”Š123â”Š132â”Š  const maySignIn = useCallback(() => {\n-â”Š124â”Š   â”Š    return !!userId\n-â”Š125â”Š   â”Š  }, [userId]);\n+â”Š   â”Š133â”Š    return !!(username && password);\n+â”Š   â”Š134â”Š  }, [username, password]);\n â”Š126â”Š135â”Š\n â”Š127â”Š136â”Š  const handleSignIn = useCallback(() => {\n-â”Š128â”Š   â”Š    signIn(userId).then(() => {\n-â”Š129â”Š   â”Š      history.replace('/chats')\n-â”Š130â”Š   â”Š    })\n-â”Š131â”Š   â”Š  }, [userId, history]);\n+â”Š   â”Š137â”Š    signIn({ username, password })\n+â”Š   â”Š138â”Š      .then(() => {\n+â”Š   â”Š139â”Š        history.push('/chats')\n+â”Š   â”Š140â”Š      })\n+â”Š   â”Š141â”Š      .catch(error => {\n+â”Š   â”Š142â”Š        setError(error.message || error)\n+â”Š   â”Š143â”Š      });\n+â”Š   â”Š144â”Š  }, [username, password, history]);\n â”Š132â”Š145â”Š\n â”Š133â”Š146â”Š  return (\n â”Š134â”Š147â”Š    <Container>\n```\n```diff\n@@ -141,12 +154,21 @@\n â”Š141â”Š154â”Š          <Legend>Sign in</Legend>\n â”Š142â”Š155â”Š          <Section>\n â”Š143â”Š156â”Š            <TextField\n-â”Š144â”Š   â”Š              data-testid=\"user-id-input\"\n-â”Š145â”Š   â”Š              label=\"User ID\"\n-â”Š146â”Š   â”Š              value={userId}\n-â”Š147â”Š   â”Š              onChange={onUserIdChange}\n+â”Š   â”Š157â”Š              className=\"AuthScreen-text-field\"\n+â”Š   â”Š158â”Š              label=\"Username\"\n+â”Š   â”Š159â”Š              value={username}\n+â”Š   â”Š160â”Š              onChange={onUsernameChange}\n+â”Š   â”Š161â”Š              margin=\"normal\"\n+â”Š   â”Š162â”Š              placeholder=\"Enter your username\"\n+â”Š   â”Š163â”Š            />\n+â”Š   â”Š164â”Š            <TextField\n+â”Š   â”Š165â”Š              className=\"AuthScreen-text-field\"\n+â”Š   â”Š166â”Š              label=\"Password\"\n+â”Š   â”Š167â”Š              type=\"password\"\n+â”Š   â”Š168â”Š              value={password}\n+â”Š   â”Š169â”Š              onChange={onPasswordChange}\n â”Š148â”Š170â”Š              margin=\"normal\"\n-â”Š149â”Š   â”Š              placeholder=\"Enter current user ID\"\n+â”Š   â”Š171â”Š              placeholder=\"Enter your password\"\n â”Š150â”Š172â”Š            />\n â”Š151â”Š173â”Š          </Section>\n â”Š152â”Š174â”Š          <Button\n```\n\n[}]: #\n\nThe behavior of the updated screen should be identical to what we had so far. To complete the flow weâ€™ll need a way to signUp. When we signing-up we will need the following parameters: `name`, `username`, `password` and `passwordConfirm`. In addition we will need to run certain validations against the parameters:\n\n- The name must be at least 3 and at most 50 characters long.\n- The username must be at least 3 and at most 18 characters long.\n- A password must be at least 8 and at most 30 characters long. In addition, it should contain English letters, numbers, and special characters.\n\nFor that we will implement a dedicated validations module:\n\n[{]: <helper> (diffStep 10.6 files=\"validators\" module=\"server\")\n\n#### [Server Step 10.6: Add signUp mutation](https://github.com/Urigo/WhatsApp-Clone-Server/commit/3e749d6)\n\n##### Added validators.ts\n```diff\n@@ -0,0 +1,43 @@\n+â”Š  â”Š 1â”Šexport const validatePassword = (ctx: string, str: string) => {\n+â”Š  â”Š 2â”Š  if (typeof str !== 'string') {\n+â”Š  â”Š 3â”Š    throw TypeError(`${ctx} must be a string`)\n+â”Š  â”Š 4â”Š  }\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Š  validateLength(ctx, str, 8, 30)\n+â”Š  â”Š 7â”Š\n+â”Š  â”Š 8â”Š  if (!/[a-zA-Z]+/.test(str)) {\n+â”Š  â”Š 9â”Š    throw TypeError(`${ctx} must contain english letters`)\n+â”Š  â”Š10â”Š  }\n+â”Š  â”Š11â”Š\n+â”Š  â”Š12â”Š  if (!/\\d+/.test(str)) {\n+â”Š  â”Š13â”Š    throw TypeError(`${ctx} must contain numbers`)\n+â”Š  â”Š14â”Š  }\n+â”Š  â”Š15â”Š\n+â”Š  â”Š16â”Š  if (!/[^\\da-zA-Z]+/.test(str)) {\n+â”Š  â”Š17â”Š    throw TypeError(`${ctx} must contain special charachters`)\n+â”Š  â”Š18â”Š  }\n+â”Š  â”Š19â”Š}\n+â”Š  â”Š20â”Š\n+â”Š  â”Š21â”Šexport const validateLength = (ctx: string, str: string, ...args: number[]) => {\n+â”Š  â”Š22â”Š  let min, max\n+â”Š  â”Š23â”Š\n+â”Š  â”Š24â”Š  if (args.length === 1) {\n+â”Š  â”Š25â”Š    min = 0\n+â”Š  â”Š26â”Š    max = args[0]\n+â”Š  â”Š27â”Š  } else {\n+â”Š  â”Š28â”Š    min = args[0]\n+â”Š  â”Š29â”Š    max = args[1]\n+â”Š  â”Š30â”Š  }\n+â”Š  â”Š31â”Š\n+â”Š  â”Š32â”Š  if (typeof str !== 'string') {\n+â”Š  â”Š33â”Š    throw TypeError(`${ctx} must be a string`)\n+â”Š  â”Š34â”Š  }\n+â”Š  â”Š35â”Š\n+â”Š  â”Š36â”Š  if (str.length < min) {\n+â”Š  â”Š37â”Š    throw TypeError(`${ctx} must be at least ${min} chars long`)\n+â”Š  â”Š38â”Š  }\n+â”Š  â”Š39â”Š\n+â”Š  â”Š40â”Š  if (str.length > max) {\n+â”Š  â”Š41â”Š    throw TypeError(`${ctx} must contain ${max} chars at most`)\n+â”Š  â”Š42â”Š  }\n+â”Š  â”Š43â”Š}\n```\n\n[}]: #\n\nAnd we will implement the resolver and schema for the `signUp` mutation:\n\n[{]: <helper> (diffStep 10.6 files=\"schema\" module=\"server\")\n\n#### [Server Step 10.6: Add signUp mutation](https://github.com/Urigo/WhatsApp-Clone-Server/commit/3e749d6)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -5,6 +5,7 @@\n â”Š 5â”Š 5â”Šimport { secret, expiration } from '../env'\n â”Š 6â”Š 6â”Šimport bcrypt from 'bcrypt'\n â”Š 7â”Š 7â”Šimport jwt from 'jsonwebtoken'\n+â”Š  â”Š 8â”Šimport { validateLength, validatePassword } from '../validators';\n â”Š 8â”Š 9â”Š\n â”Š 9â”Š10â”Šconst resolvers: Resolvers = {\n â”Š10â”Š11â”Š  Date: GraphQLDateTime,\n```\n```diff\n@@ -96,20 +97,20 @@\n â”Š 96â”Š 97â”Š  },\n â”Š 97â”Š 98â”Š\n â”Š 98â”Š 99â”Š  Mutation: {\n-â”Š 99â”Š   â”Š    signIn(root, { username, password}, { res }) {\n+â”Š   â”Š100â”Š    signIn(root, { username, password }, { res }) {\n â”Š100â”Š101â”Š\n â”Š101â”Š102â”Š      const user = users.find(u => u.username === username)\n-â”Š102â”Š   â”Š\n+â”Š   â”Š103â”Š\n â”Š103â”Š104â”Š      if (!user) {\n â”Š104â”Š105â”Š        throw new Error('user not found')\n â”Š105â”Š106â”Š      }\n-â”Š106â”Š   â”Š\n+â”Š   â”Š107â”Š\n â”Š107â”Š108â”Š      const passwordsMatch = bcrypt.compareSync(password, user.password)\n-â”Š108â”Š   â”Š\n+â”Š   â”Š109â”Š\n â”Š109â”Š110â”Š      if (!passwordsMatch) {\n â”Š110â”Š111â”Š        throw new Error('password is incorrect')\n â”Š111â”Š112â”Š      }\n-â”Š112â”Š   â”Š\n+â”Š   â”Š113â”Š\n â”Š113â”Š114â”Š      const authToken = jwt.sign(username, secret)\n â”Š114â”Š115â”Š\n â”Š115â”Š116â”Š      res.cookie('authToken', authToken, { maxAge: expiration })\n```\n```diff\n@@ -117,6 +118,35 @@\n â”Š117â”Š118â”Š      return user;\n â”Š118â”Š119â”Š    },\n â”Š119â”Š120â”Š\n+â”Š   â”Š121â”Š    signUp(root, { name, username, password, passwordConfirm }) {\n+â”Š   â”Š122â”Š\n+â”Š   â”Š123â”Š      validateLength('req.name', name, 3, 50)\n+â”Š   â”Š124â”Š      validateLength('req.username', name, 3, 18)\n+â”Š   â”Š125â”Š      validatePassword('req.password', password)\n+â”Š   â”Š126â”Š\n+â”Š   â”Š127â”Š      if (password !== passwordConfirm) {\n+â”Š   â”Š128â”Š        throw Error(\"req.password and req.passwordConfirm don't match\")\n+â”Š   â”Š129â”Š      }\n+â”Š   â”Š130â”Š\n+â”Š   â”Š131â”Š      if (users.some(u => u.username === username)) {\n+â”Š   â”Š132â”Š        throw Error(\"username already exists\")\n+â”Š   â”Š133â”Š      }\n+â”Š   â”Š134â”Š\n+â”Š   â”Š135â”Š      const passwordHash = bcrypt.hashSync(password, bcrypt.genSaltSync(8))\n+â”Š   â”Š136â”Š\n+â”Š   â”Š137â”Š      const user: User = {\n+â”Š   â”Š138â”Š        id: String(users.length + 1),\n+â”Š   â”Š139â”Š        password: passwordHash,\n+â”Š   â”Š140â”Š        picture: '',\n+â”Š   â”Š141â”Š        username,\n+â”Š   â”Š142â”Š        name,\n+â”Š   â”Š143â”Š      }\n+â”Š   â”Š144â”Š\n+â”Š   â”Š145â”Š      users.push(user)\n+â”Š   â”Š146â”Š\n+â”Š   â”Š147â”Š      return user\n+â”Š   â”Š148â”Š    },\n+â”Š   â”Š149â”Š\n â”Š120â”Š150â”Š    addMessage(root, { chatId, content }, { currentUser, pubsub }) {\n â”Š121â”Š151â”Š      if (!currentUser) return null\n â”Š122â”Š152â”Š\n```\n\n##### Changed schema&#x2F;typeDefs.graphql\n```diff\n@@ -34,6 +34,7 @@\n â”Š34â”Š34â”Š\n â”Š35â”Š35â”Štype Mutation {\n â”Š36â”Š36â”Š  signIn(username: String!, password: String!): User\n+â”Š  â”Š37â”Š  signUp(name: String!, username: String!, password: String!, passwordConfirm: String!): User\n â”Š37â”Š38â”Š  addMessage(chatId: ID!, content: String!): Message\n â”Š38â”Š39â”Š  addChat(recipientId: ID!): Chat\n â”Š39â”Š40â”Š  removeChat(chatId: ID!): ID\n```\n\n[}]: #\n\nBefore encrypting the password we append a string called â€œsaltâ€ to it. Even though the passwords are stored encrypted in the DB, a hacker might use a dictionary of common passwords in their encrypted form to decipher the original password. When adding salt to a password which is essentially a random string, the hacker cannot use a dictionary anymore since he would need to know the salt. Hypothetically, the hacker can get a hold of the salt and re-generate the entire dictionary, however that would take too long because of the way Bcrypt is designed to work.\n\nGoing back to the client, we will implement a new `signUp()` method in the `auth.service` that will call the `signUp` mutation:\n\n[{]: <helper> (diffStep 13.5 module=\"client\")\n\n#### Client Step 13.5: Add signUp() method to auth.service\n\n##### Changed src&#x2F;services&#x2F;auth.service.tsx\n```diff\n@@ -62,6 +62,25 @@\n â”Š62â”Š62â”Š  });\n â”Š63â”Š63â”Š};\n â”Š64â”Š64â”Š\n+â”Š  â”Š65â”Šexport const signUp = ({ name, username, password, passwordConfirm }:\n+â”Š  â”Š66â”Š  {name: string, username: string, password: string, passwordConfirm: string}) => {\n+â”Š  â”Š67â”Š  return client.mutate({\n+â”Š  â”Š68â”Š    mutation: gql`\n+â”Š  â”Š69â”Š      mutation signUp($name: String!, $username: String!, $password: String!, $passwordConfirm: String!) {\n+â”Š  â”Š70â”Š        signUp(name: $name, username: $username, password: $password, passwordConfirm: $passwordConfirm) {\n+â”Š  â”Š71â”Š          id\n+â”Š  â”Š72â”Š        }\n+â”Š  â”Š73â”Š      }\n+â”Š  â”Š74â”Š    `,\n+â”Š  â”Š75â”Š    variables: {\n+â”Š  â”Š76â”Š      name,\n+â”Š  â”Š77â”Š      username,\n+â”Š  â”Š78â”Š      password,\n+â”Š  â”Š79â”Š      passwordConfirm\n+â”Š  â”Š80â”Š    }\n+â”Š  â”Š81â”Š  });\n+â”Š  â”Š82â”Š};\n+â”Š  â”Š83â”Š\n â”Š65â”Š84â”Šexport const signOut = () => {\n â”Š66â”Š85â”Š  document.cookie = `authToken=;expires=${new Date(0)}`;\n```\n\n[}]: #\n\nNow we will implement a dedicated `SignUpForm` that we can use to perform the sign-up. Instead of implementing a new screen, we will use the `AuthScreen` to alternate between the `SignInForm` and the `SignUpForm` using `AnimatedSwitch`. This way we can have a container component that is common for both forms, and we will be able to switch between the two very smoothly. We will first define a new `/sign-up` route in our router:\n\n[{]: <helper> (diffStep 13.6 module=\"client\")\n\n#### Client Step 13.6: Split AuthScreen into SignInForm and SignUpForm\n\n##### Added src&#x2F;components&#x2F;AuthScreen&#x2F;SignInForm.test.tsx\n```diff\n@@ -0,0 +1,81 @@\n+â”Š  â”Š 1â”Šimport { createMemoryHistory } from 'history';\n+â”Š  â”Š 2â”Šimport React from 'react';\n+â”Š  â”Š 3â”Šimport { cleanup, render, fireEvent, wait, waitForElement } from 'react-testing-library';\n+â”Š  â”Š 4â”Šimport SignInForm from './SignInForm';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šdescribe('SignInForm', () => {\n+â”Š  â”Š 7â”Š  afterEach(cleanup);\n+â”Š  â”Š 8â”Š  afterEach(() => fetch.resetMocks());\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Š  it('enables sign-in button when filled in', async () => {\n+â”Š  â”Š11â”Š    const history = createMemoryHistory();\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Š    {\n+â”Š  â”Š14â”Š      const { container, getByTestId } = render(<SignInForm history={history} />);\n+â”Š  â”Š15â”Š      const usernameInput = getByTestId('username-input').querySelector('input');\n+â”Š  â”Š16â”Š      const passwordInput = getByTestId('password-input').querySelector('input');\n+â”Š  â”Š17â”Š      const signInButton = getByTestId('sign-in-button') as HTMLButtonElement;\n+â”Š  â”Š18â”Š\n+â”Š  â”Š19â”Š      expect(signInButton.disabled).toEqual(true);\n+â”Š  â”Š20â”Š\n+â”Š  â”Š21â”Š      fireEvent.change(usernameInput, { target: { value: 'username' } });\n+â”Š  â”Š22â”Š      fireEvent.change(passwordInput, { target: { value: 'password' } });\n+â”Š  â”Š23â”Š\n+â”Š  â”Š24â”Š      await waitForElement(() => usernameInput);\n+â”Š  â”Š25â”Š      await waitForElement(() => passwordInput);\n+â”Š  â”Š26â”Š\n+â”Š  â”Š27â”Š      expect(signInButton.disabled).toEqual(false);\n+â”Š  â”Š28â”Š    }\n+â”Š  â”Š29â”Š  });\n+â”Š  â”Š30â”Š\n+â”Š  â”Š31â”Š  it('prints server error if input was wrong', async () => {\n+â”Š  â”Š32â”Š    const history = createMemoryHistory();\n+â”Š  â”Š33â”Š\n+â”Š  â”Š34â”Š    fetchMock.mockRejectOnce(new Error('sign-in failed'));\n+â”Š  â”Š35â”Š\n+â”Š  â”Š36â”Š    {\n+â”Š  â”Š37â”Š      const { container, getByTestId } = render(<SignInForm history={history} />);\n+â”Š  â”Š38â”Š      const usernameInput = getByTestId('username-input').querySelector('input');\n+â”Š  â”Š39â”Š      const passwordInput = getByTestId('password-input').querySelector('input');\n+â”Š  â”Š40â”Š      const signInButton = getByTestId('sign-in-button') as HTMLButtonElement;\n+â”Š  â”Š41â”Š      const errorMessage = getByTestId('error-message');\n+â”Š  â”Š42â”Š\n+â”Š  â”Š43â”Š      fireEvent.change(usernameInput, { target: { value: 'username' } });\n+â”Š  â”Š44â”Š      fireEvent.change(passwordInput, { target: { value: 'password' } });\n+â”Š  â”Š45â”Š\n+â”Š  â”Š46â”Š      await waitForElement(() => usernameInput);\n+â”Š  â”Š47â”Š      await waitForElement(() => passwordInput);\n+â”Š  â”Š48â”Š\n+â”Š  â”Š49â”Š      fireEvent.click(signInButton);\n+â”Š  â”Š50â”Š\n+â”Š  â”Š51â”Š      await waitForElement(() => errorMessage);\n+â”Š  â”Š52â”Š\n+â”Š  â”Š53â”Š      expect(errorMessage.innerHTML).toEqual('sign-in failed');\n+â”Š  â”Š54â”Š    }\n+â”Š  â”Š55â”Š  });\n+â”Š  â”Š56â”Š\n+â”Š  â”Š57â”Š  it('navigates to /chats if everything went right', async () => {\n+â”Š  â”Š58â”Š    const history = createMemoryHistory();\n+â”Š  â”Š59â”Š\n+â”Š  â”Š60â”Š    fetchMock.mockResponseOnce('success');\n+â”Š  â”Š61â”Š\n+â”Š  â”Š62â”Š    {\n+â”Š  â”Š63â”Š      const { container, getByTestId } = render(<SignInForm history={history} />);\n+â”Š  â”Š64â”Š      const usernameInput = getByTestId('username-input').querySelector('input');\n+â”Š  â”Š65â”Š      const passwordInput = getByTestId('password-input').querySelector('input');\n+â”Š  â”Š66â”Š      const signInButton = getByTestId('sign-in-button') as HTMLButtonElement;\n+â”Š  â”Š67â”Š\n+â”Š  â”Š68â”Š      fireEvent.change(usernameInput, { target: { value: 'username' } });\n+â”Š  â”Š69â”Š      fireEvent.change(passwordInput, { target: { value: 'password' } });\n+â”Š  â”Š70â”Š\n+â”Š  â”Š71â”Š      await waitForElement(() => usernameInput);\n+â”Š  â”Š72â”Š      await waitForElement(() => passwordInput);\n+â”Š  â”Š73â”Š\n+â”Š  â”Š74â”Š      fireEvent.click(signInButton);\n+â”Š  â”Š75â”Š\n+â”Š  â”Š76â”Š      await wait(() =>\n+â”Š  â”Š77â”Š        expect(history.location.pathname).toEqual('/chats')\n+â”Š  â”Š78â”Š      );\n+â”Š  â”Š79â”Š    }\n+â”Š  â”Š80â”Š  });\n+â”Š  â”Š81â”Š});\n```\n\n##### Added src&#x2F;components&#x2F;AuthScreen&#x2F;SignInForm.tsx\n```diff\n@@ -0,0 +1,83 @@\n+â”Š  â”Š 1â”Šimport React from 'react';\n+â”Š  â”Š 2â”Šimport { useCallback, useState } from 'react';\n+â”Š  â”Š 3â”Šimport { signIn } from '../../services/auth.service';\n+â”Š  â”Š 4â”Šimport {\n+â”Š  â”Š 5â”Š  SignForm,\n+â”Š  â”Š 6â”Š  ActualForm,\n+â”Š  â”Š 7â”Š  Legend,\n+â”Š  â”Š 8â”Š  Section,\n+â”Š  â”Š 9â”Š  TextField,\n+â”Š  â”Š10â”Š  Button,\n+â”Š  â”Š11â”Š  ErrorMessage,\n+â”Š  â”Š12â”Š} from './form-components';\n+â”Š  â”Š13â”Šimport { RouteComponentProps } from 'react-router-dom';\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”Šconst SignInForm: React.FC<RouteComponentProps<any>> = ({ history }) => {\n+â”Š  â”Š16â”Š  const [username, setUsername] = useState('');\n+â”Š  â”Š17â”Š  const [password, setPassword] = useState('');\n+â”Š  â”Š18â”Š  const [error, setError] = useState('');\n+â”Š  â”Š19â”Š\n+â”Š  â”Š20â”Š  const onUsernameChange = useCallback(({ target }) => {\n+â”Š  â”Š21â”Š    setError('');\n+â”Š  â”Š22â”Š    setUsername(target.value);\n+â”Š  â”Š23â”Š  }, []);\n+â”Š  â”Š24â”Š\n+â”Š  â”Š25â”Š  const onPasswordChange = useCallback(({ target }) => {\n+â”Š  â”Š26â”Š    setError('');\n+â”Š  â”Š27â”Š    setPassword(target.value);\n+â”Š  â”Š28â”Š  }, []);\n+â”Š  â”Š29â”Š\n+â”Š  â”Š30â”Š  const maySignIn = useCallback(() => {\n+â”Š  â”Š31â”Š    return !!(username && password);\n+â”Š  â”Š32â”Š  }, [username, password]);\n+â”Š  â”Š33â”Š\n+â”Š  â”Š34â”Š  const handleSignIn = useCallback(() => {\n+â”Š  â”Š35â”Š    signIn({ username, password })\n+â”Š  â”Š36â”Š      .then(() => {\n+â”Š  â”Š37â”Š        history.replace('/chats')\n+â”Š  â”Š38â”Š      })\n+â”Š  â”Š39â”Š      .catch(error => {\n+â”Š  â”Š40â”Š        setError(error.message || error)\n+â”Š  â”Š41â”Š      });\n+â”Š  â”Š42â”Š  }, [username, password, history]);\n+â”Š  â”Š43â”Š\n+â”Š  â”Š44â”Š  return (\n+â”Š  â”Š45â”Š    <SignForm>\n+â”Š  â”Š46â”Š      <ActualForm>\n+â”Š  â”Š47â”Š        <Legend>Sign in</Legend>\n+â”Š  â”Š48â”Š        <Section style={{ width: '100%' }}>\n+â”Š  â”Š49â”Š          <TextField\n+â”Š  â”Š50â”Š            data-testid=\"username-input\"\n+â”Š  â”Š51â”Š            label=\"Username\"\n+â”Š  â”Š52â”Š            value={username}\n+â”Š  â”Š53â”Š            onChange={onUsernameChange}\n+â”Š  â”Š54â”Š            margin=\"normal\"\n+â”Š  â”Š55â”Š            placeholder=\"Enter your username\"\n+â”Š  â”Š56â”Š          />\n+â”Š  â”Š57â”Š          <TextField\n+â”Š  â”Š58â”Š            data-testid=\"password-input\"\n+â”Š  â”Š59â”Š            label=\"Password\"\n+â”Š  â”Š60â”Š            type=\"password\"\n+â”Š  â”Š61â”Š            value={password}\n+â”Š  â”Š62â”Š            onChange={onPasswordChange}\n+â”Š  â”Š63â”Š            margin=\"normal\"\n+â”Š  â”Š64â”Š            placeholder=\"Enter your password\"\n+â”Š  â”Š65â”Š          />\n+â”Š  â”Š66â”Š        </Section>\n+â”Š  â”Š67â”Š        <Button\n+â”Š  â”Š68â”Š          data-testid=\"sign-in-button\"\n+â”Š  â”Š69â”Š          type=\"button\"\n+â”Š  â”Š70â”Š          color=\"secondary\"\n+â”Š  â”Š71â”Š          variant=\"contained\"\n+â”Š  â”Š72â”Š          disabled={!maySignIn()}\n+â”Š  â”Š73â”Š          onClick={handleSignIn}\n+â”Š  â”Š74â”Š        >\n+â”Š  â”Š75â”Š          Sign in\n+â”Š  â”Š76â”Š        </Button>\n+â”Š  â”Š77â”Š        <ErrorMessage data-testid=\"error-message\">{error}</ErrorMessage>\n+â”Š  â”Š78â”Š      </ActualForm>\n+â”Š  â”Š79â”Š    </SignForm>\n+â”Š  â”Š80â”Š  );\n+â”Š  â”Š81â”Š};\n+â”Š  â”Š82â”Š\n+â”Š  â”Š83â”Šexport default SignInForm;\n```\n\n##### Added src&#x2F;components&#x2F;AuthScreen&#x2F;SignUpForm.test.tsx\n```diff\n@@ -0,0 +1,99 @@\n+â”Š  â”Š 1â”Šimport { createMemoryHistory } from 'history';\n+â”Š  â”Š 2â”Šimport React from 'react';\n+â”Š  â”Š 3â”Šimport { cleanup, render, fireEvent, wait, waitForElement } from 'react-testing-library';\n+â”Š  â”Š 4â”Šimport SignUpForm from './SignUpForm';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šdescribe('SignUpForm', () => {\n+â”Š  â”Š 7â”Š  afterEach(cleanup);\n+â”Š  â”Š 8â”Š  afterEach(() => fetch.resetMocks());\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Š  it('enables sign-up button when filled in', async () => {\n+â”Š  â”Š11â”Š    const history = createMemoryHistory();\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Š    {\n+â”Š  â”Š14â”Š      const { container, getByTestId } = render(<SignUpForm history={history} />);\n+â”Š  â”Š15â”Š      const nameInput = getByTestId('name-input').querySelector('input');\n+â”Š  â”Š16â”Š      const usernameInput = getByTestId('username-input').querySelector('input');\n+â”Š  â”Š17â”Š      const passwordInput = getByTestId('password-input').querySelector('input');\n+â”Š  â”Š18â”Š      const passwordConfirmInput = getByTestId('password-confirm-input').querySelector('input');\n+â”Š  â”Š19â”Š      const signUpButton = getByTestId('sign-up-button') as HTMLButtonElement;\n+â”Š  â”Š20â”Š\n+â”Š  â”Š21â”Š      expect(signUpButton.disabled).toEqual(true);\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Š      fireEvent.change(nameInput, { target: { value: 'User Name' } });\n+â”Š  â”Š24â”Š      fireEvent.change(usernameInput, { target: { value: 'username' } });\n+â”Š  â”Š25â”Š      fireEvent.change(passwordInput, { target: { value: 'password' } });\n+â”Š  â”Š26â”Š      fireEvent.change(passwordConfirmInput, { target: { value: 'password' } });\n+â”Š  â”Š27â”Š\n+â”Š  â”Š28â”Š      await waitForElement(() => nameInput);\n+â”Š  â”Š29â”Š      await waitForElement(() => usernameInput);\n+â”Š  â”Š30â”Š      await waitForElement(() => passwordInput);\n+â”Š  â”Š31â”Š      await waitForElement(() => passwordConfirmInput);\n+â”Š  â”Š32â”Š\n+â”Š  â”Š33â”Š      expect(signUpButton.disabled).toEqual(false);\n+â”Š  â”Š34â”Š    }\n+â”Š  â”Š35â”Š  });\n+â”Š  â”Š36â”Š\n+â”Š  â”Š37â”Š  it('prints server error if input was wrong', async () => {\n+â”Š  â”Š38â”Š    const history = createMemoryHistory();\n+â”Š  â”Š39â”Š\n+â”Š  â”Š40â”Š    fetchMock.mockRejectOnce(new Error('sign-up failed'));\n+â”Š  â”Š41â”Š\n+â”Š  â”Š42â”Š    {\n+â”Š  â”Š43â”Š      const { container, getByTestId } = render(<SignUpForm history={history} />);\n+â”Š  â”Š44â”Š      const nameInput = getByTestId('name-input').querySelector('input');\n+â”Š  â”Š45â”Š      const usernameInput = getByTestId('username-input').querySelector('input');\n+â”Š  â”Š46â”Š      const passwordInput = getByTestId('password-input').querySelector('input');\n+â”Š  â”Š47â”Š      const passwordConfirmInput = getByTestId('password-confirm-input').querySelector('input');\n+â”Š  â”Š48â”Š      const signUpButton = getByTestId('sign-up-button') as HTMLButtonElement;\n+â”Š  â”Š49â”Š      const errorMessage = getByTestId('error-message');\n+â”Š  â”Š50â”Š\n+â”Š  â”Š51â”Š      fireEvent.change(nameInput, { target: { value: 'User Name' } });\n+â”Š  â”Š52â”Š      fireEvent.change(usernameInput, { target: { value: 'username' } });\n+â”Š  â”Š53â”Š      fireEvent.change(passwordInput, { target: { value: 'password' } });\n+â”Š  â”Š54â”Š      fireEvent.change(passwordConfirmInput, { target: { value: 'password' } });\n+â”Š  â”Š55â”Š\n+â”Š  â”Š56â”Š      await waitForElement(() => nameInput);\n+â”Š  â”Š57â”Š      await waitForElement(() => usernameInput);\n+â”Š  â”Š58â”Š      await waitForElement(() => passwordInput);\n+â”Š  â”Š59â”Š      await waitForElement(() => passwordConfirmInput);\n+â”Š  â”Š60â”Š\n+â”Š  â”Š61â”Š      fireEvent.click(signUpButton);\n+â”Š  â”Š62â”Š\n+â”Š  â”Š63â”Š      await waitForElement(() => errorMessage);\n+â”Š  â”Š64â”Š\n+â”Š  â”Š65â”Š      expect(errorMessage.innerHTML).toEqual('sign-up failed');\n+â”Š  â”Š66â”Š    }\n+â”Š  â”Š67â”Š  });\n+â”Š  â”Š68â”Š\n+â”Š  â”Š69â”Š  it('navigates to /sign-in if everything went right', async () => {\n+â”Š  â”Š70â”Š    const history = createMemoryHistory();\n+â”Š  â”Š71â”Š\n+â”Š  â”Š72â”Š    fetchMock.mockResponseOnce('success');\n+â”Š  â”Š73â”Š\n+â”Š  â”Š74â”Š    {\n+â”Š  â”Š75â”Š      const { container, getByTestId } = render(<SignUpForm history={history} />);\n+â”Š  â”Š76â”Š      const nameInput = getByTestId('name-input').querySelector('input');\n+â”Š  â”Š77â”Š      const usernameInput = getByTestId('username-input').querySelector('input');\n+â”Š  â”Š78â”Š      const passwordInput = getByTestId('password-input').querySelector('input');\n+â”Š  â”Š79â”Š      const passwordConfirmInput = getByTestId('password-confirm-input').querySelector('input');\n+â”Š  â”Š80â”Š      const signUpButton = getByTestId('sign-up-button') as HTMLButtonElement;\n+â”Š  â”Š81â”Š\n+â”Š  â”Š82â”Š      fireEvent.change(nameInput, { target: { value: 'User Name' } });\n+â”Š  â”Š83â”Š      fireEvent.change(usernameInput, { target: { value: 'username' } });\n+â”Š  â”Š84â”Š      fireEvent.change(passwordInput, { target: { value: 'password' } });\n+â”Š  â”Š85â”Š      fireEvent.change(passwordConfirmInput, { target: { value: 'password' } });\n+â”Š  â”Š86â”Š\n+â”Š  â”Š87â”Š      await waitForElement(() => nameInput);\n+â”Š  â”Š88â”Š      await waitForElement(() => usernameInput);\n+â”Š  â”Š89â”Š      await waitForElement(() => passwordInput);\n+â”Š  â”Š90â”Š      await waitForElement(() => passwordConfirmInput);\n+â”Š  â”Š91â”Š\n+â”Š  â”Š92â”Š      fireEvent.click(signUpButton);\n+â”Š  â”Š93â”Š\n+â”Š  â”Š94â”Š      await wait(() =>\n+â”Š  â”Š95â”Š        expect(history.location.pathname).toEqual('/sign-in')\n+â”Š  â”Š96â”Š      );\n+â”Š  â”Š97â”Š    }\n+â”Š  â”Š98â”Š  });\n+â”Š  â”Š99â”Š});\n```\n\n##### Added src&#x2F;components&#x2F;AuthScreen&#x2F;SignUpForm.tsx\n```diff\n@@ -0,0 +1,126 @@\n+â”Š   â”Š  1â”Šimport React from 'react';\n+â”Š   â”Š  2â”Šimport { useCallback, useState } from 'react';\n+â”Š   â”Š  3â”Šimport { signUp } from '../../services/auth.service';\n+â”Š   â”Š  4â”Šimport {\n+â”Š   â”Š  5â”Š  SignForm,\n+â”Š   â”Š  6â”Š  ActualForm,\n+â”Š   â”Š  7â”Š  Legend,\n+â”Š   â”Š  8â”Š  Section,\n+â”Š   â”Š  9â”Š  TextField,\n+â”Š   â”Š 10â”Š  Button,\n+â”Š   â”Š 11â”Š  ErrorMessage,\n+â”Š   â”Š 12â”Š} from './form-components';\n+â”Š   â”Š 13â”Šimport { RouteComponentProps } from 'react-router-dom';\n+â”Š   â”Š 14â”Š\n+â”Š   â”Š 15â”Šconst SignUpForm: React.FC<RouteComponentProps<any>> = ({ history }) => {\n+â”Š   â”Š 16â”Š  const [name, setName] = useState('');\n+â”Š   â”Š 17â”Š  const [username, setUsername] = useState('');\n+â”Š   â”Š 18â”Š  const [password, setPassword] = useState('');\n+â”Š   â”Š 19â”Š  const [passwordConfirm, setPasswordConfirm] = useState('');\n+â”Š   â”Š 20â”Š  const [error, setError] = useState('');\n+â”Š   â”Š 21â”Š\n+â”Š   â”Š 22â”Š  const updateName = useCallback(({ target }) => {\n+â”Š   â”Š 23â”Š    setError('');\n+â”Š   â”Š 24â”Š    setName(target.value);\n+â”Š   â”Š 25â”Š  }, []);\n+â”Š   â”Š 26â”Š\n+â”Š   â”Š 27â”Š  const updateUsername = useCallback(({ target }) => {\n+â”Š   â”Š 28â”Š    setError('');\n+â”Š   â”Š 29â”Š    setUsername(target.value);\n+â”Š   â”Š 30â”Š  }, []);\n+â”Š   â”Š 31â”Š\n+â”Š   â”Š 32â”Š  const updatePassword = useCallback(({ target }) => {\n+â”Š   â”Š 33â”Š    setError('');\n+â”Š   â”Š 34â”Š    setPassword(target.value);\n+â”Š   â”Š 35â”Š  }, []);\n+â”Š   â”Š 36â”Š\n+â”Š   â”Š 37â”Š  const updatePasswordConfirm = useCallback(({ target }) => {\n+â”Š   â”Š 38â”Š    setError('');\n+â”Š   â”Š 39â”Š    setPasswordConfirm(target.value);\n+â”Š   â”Š 40â”Š  }, []);\n+â”Š   â”Š 41â”Š\n+â”Š   â”Š 42â”Š  const maySignUp = useCallback(() => {\n+â”Š   â”Š 43â”Š    return !!(name && username && password && password === passwordConfirm);\n+â”Š   â”Š 44â”Š  }, [name, username, password, passwordConfirm]);\n+â”Š   â”Š 45â”Š\n+â”Š   â”Š 46â”Š  const handleSignUp = useCallback(() => {\n+â”Š   â”Š 47â”Š    signUp({ username, password, passwordConfirm, name })\n+â”Š   â”Š 48â”Š      .then(() => {\n+â”Š   â”Š 49â”Š        history.replace('/sign-in')\n+â”Š   â”Š 50â”Š      })\n+â”Š   â”Š 51â”Š      .catch(error => {\n+â”Š   â”Š 52â”Š        setError(error.message || error)\n+â”Š   â”Š 53â”Š      });\n+â”Š   â”Š 54â”Š  }, [name, username, password, passwordConfirm, history]);\n+â”Š   â”Š 55â”Š\n+â”Š   â”Š 56â”Š  return (\n+â”Š   â”Š 57â”Š    <SignForm>\n+â”Š   â”Š 58â”Š      <ActualForm>\n+â”Š   â”Š 59â”Š        <Legend>Sign up</Legend>\n+â”Š   â”Š 60â”Š        <Section\n+â”Š   â”Š 61â”Š          style={{\n+â”Š   â”Š 62â”Š            float: 'left',\n+â”Š   â”Š 63â”Š            width: 'calc(50% - 10px)',\n+â”Š   â”Š 64â”Š            paddingRight: '10px',\n+â”Š   â”Š 65â”Š          }}\n+â”Š   â”Š 66â”Š        >\n+â”Š   â”Š 67â”Š          <TextField\n+â”Š   â”Š 68â”Š            data-testid=\"name-input\"\n+â”Š   â”Š 69â”Š            label=\"Name\"\n+â”Š   â”Š 70â”Š            value={name}\n+â”Š   â”Š 71â”Š            onChange={updateName}\n+â”Š   â”Š 72â”Š            autoComplete=\"off\"\n+â”Š   â”Š 73â”Š            margin=\"normal\"\n+â”Š   â”Š 74â”Š          />\n+â”Š   â”Š 75â”Š          <TextField\n+â”Š   â”Š 76â”Š            data-testid=\"username-input\"\n+â”Š   â”Š 77â”Š            label=\"Username\"\n+â”Š   â”Š 78â”Š            value={username}\n+â”Š   â”Š 79â”Š            onChange={updateUsername}\n+â”Š   â”Š 80â”Š            autoComplete=\"off\"\n+â”Š   â”Š 81â”Š            margin=\"normal\"\n+â”Š   â”Š 82â”Š          />\n+â”Š   â”Š 83â”Š        </Section>\n+â”Š   â”Š 84â”Š        <Section\n+â”Š   â”Š 85â”Š          style={{\n+â”Š   â”Š 86â”Š            float: 'right',\n+â”Š   â”Š 87â”Š            width: 'calc(50% - 10px)',\n+â”Š   â”Š 88â”Š            paddingLeft: '10px',\n+â”Š   â”Š 89â”Š          }}\n+â”Š   â”Š 90â”Š        >\n+â”Š   â”Š 91â”Š          <TextField\n+â”Š   â”Š 92â”Š            data-testid=\"password-input\"\n+â”Š   â”Š 93â”Š            label=\"Password\"\n+â”Š   â”Š 94â”Š            type=\"password\"\n+â”Š   â”Š 95â”Š            value={password}\n+â”Š   â”Š 96â”Š            onChange={updatePassword}\n+â”Š   â”Š 97â”Š            autoComplete=\"off\"\n+â”Š   â”Š 98â”Š            margin=\"normal\"\n+â”Š   â”Š 99â”Š          />\n+â”Š   â”Š100â”Š          <TextField\n+â”Š   â”Š101â”Š            data-testid=\"password-confirm-input\"\n+â”Š   â”Š102â”Š            label=\"Confirm password\"\n+â”Š   â”Š103â”Š            type=\"password\"\n+â”Š   â”Š104â”Š            value={passwordConfirm}\n+â”Š   â”Š105â”Š            onChange={updatePasswordConfirm}\n+â”Š   â”Š106â”Š            autoComplete=\"off\"\n+â”Š   â”Š107â”Š            margin=\"normal\"\n+â”Š   â”Š108â”Š          />\n+â”Š   â”Š109â”Š        </Section>\n+â”Š   â”Š110â”Š        <Button\n+â”Š   â”Š111â”Š          data-testid=\"sign-up-button\"\n+â”Š   â”Š112â”Š          type=\"button\"\n+â”Š   â”Š113â”Š          color=\"secondary\"\n+â”Š   â”Š114â”Š          variant=\"contained\"\n+â”Š   â”Š115â”Š          disabled={!maySignUp()}\n+â”Š   â”Š116â”Š          onClick={handleSignUp}\n+â”Š   â”Š117â”Š        >\n+â”Š   â”Š118â”Š          Sign up\n+â”Š   â”Š119â”Š        </Button>\n+â”Š   â”Š120â”Š        <ErrorMessage data-testid=\"error-message\">{error}</ErrorMessage>\n+â”Š   â”Š121â”Š      </ActualForm>\n+â”Š   â”Š122â”Š    </SignForm>\n+â”Š   â”Š123â”Š  );\n+â”Š   â”Š124â”Š};\n+â”Š   â”Š125â”Š\n+â”Š   â”Š126â”Šexport default SignUpForm;ðŸš«â†µ\n```\n\n##### Added src&#x2F;components&#x2F;AuthScreen&#x2F;form-components.ts\n```diff\n@@ -0,0 +1,75 @@\n+â”Š  â”Š 1â”Šimport MaterialButton from '@material-ui/core/Button';\n+â”Š  â”Š 2â”Šimport MaterialTextField from '@material-ui/core/TextField';\n+â”Š  â”Š 3â”Šimport styled from 'styled-components';\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šexport const SignForm = styled.div `\n+â”Š  â”Š 6â”Š  height: calc(100% - 265px);\n+â”Š  â”Š 7â”Š`;\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Šexport const ActualForm = styled.form `\n+â”Š  â”Š10â”Š  padding: 20px;\n+â”Š  â”Š11â”Š`;\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Šexport const Section = styled.div `\n+â”Š  â”Š14â”Š  padding-bottom: 35px;\n+â”Š  â”Š15â”Š`;\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Šexport const Legend = styled.legend `\n+â”Š  â”Š18â”Š  font-weight: bold;\n+â”Š  â”Š19â”Š  color: white;\n+â”Š  â”Š20â”Š`;\n+â”Š  â”Š21â”Š\n+â”Š  â”Š22â”Šexport const Label = styled.label `\n+â”Š  â”Š23â”Š  color: white !important;\n+â”Š  â”Š24â”Š`;\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Šexport const Input = styled.input `\n+â”Š  â”Š27â”Š  color: white;\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š  &::placeholder {\n+â”Š  â”Š30â”Š    color: var(--primary-bg);\n+â”Š  â”Š31â”Š  }\n+â”Š  â”Š32â”Š`;\n+â”Š  â”Š33â”Š\n+â”Š  â”Š34â”Šexport const TextField = styled(MaterialTextField) `\n+â”Š  â”Š35â”Š  width: 100%;\n+â”Š  â”Š36â”Š  position: relative;\n+â”Š  â”Š37â”Š\n+â”Š  â”Š38â”Š  > div::before {\n+â”Š  â”Š39â”Š    border-color: white !important;\n+â”Š  â”Š40â”Š  }\n+â”Š  â”Š41â”Š\n+â”Š  â”Š42â”Š  input {\n+â”Š  â”Š43â”Š    color: white !important;\n+â”Š  â”Š44â”Š\n+â”Š  â”Š45â”Š    &::placeholder {\n+â”Š  â”Š46â”Š      color: var(--primary-bg) !important;\n+â”Š  â”Š47â”Š    }\n+â”Š  â”Š48â”Š  }\n+â”Š  â”Š49â”Š\n+â”Š  â”Š50â”Š  label {\n+â”Š  â”Š51â”Š    color: white !important;\n+â”Š  â”Š52â”Š  }\n+â”Š  â”Š53â”Š` as typeof MaterialTextField;\n+â”Š  â”Š54â”Š\n+â”Š  â”Š55â”Šexport const Button = styled(MaterialButton) `\n+â”Š  â”Š56â”Š  width: 100px;\n+â”Š  â”Š57â”Š  display: block !important;\n+â”Š  â”Š58â”Š  margin: auto !important;\n+â”Š  â”Š59â”Š  background-color: var(--secondary-bg) !important;\n+â”Š  â”Š60â”Š\n+â”Š  â”Š61â”Š  &[disabled] {\n+â”Š  â”Š62â”Š    color: #38a81c;\n+â”Š  â”Š63â”Š  }\n+â”Š  â”Š64â”Š\n+â”Š  â”Š65â”Š  &:not([disabled]) {\n+â”Š  â”Š66â”Š    color: white;\n+â”Š  â”Š67â”Š  }\n+â”Š  â”Š68â”Š` as typeof MaterialButton;\n+â”Š  â”Š69â”Š\n+â”Š  â”Š70â”Šexport const ErrorMessage = styled.div `\n+â”Š  â”Š71â”Š  position: fixed;\n+â”Š  â”Š72â”Š  color: red;\n+â”Š  â”Š73â”Š  font-size: 15px;\n+â”Š  â”Š74â”Š  margin-top: 20px;\n+â”Š  â”Š75â”Š`;\n```\n\n##### Changed src&#x2F;components&#x2F;AuthScreen&#x2F;index.tsx\n```diff\n@@ -1,13 +1,13 @@\n-â”Š 1â”Š  â”Šimport MaterialButton from '@material-ui/core/Button';\n-â”Š 2â”Š  â”Šimport MaterialTextField from '@material-ui/core/TextField';\n â”Š 3â”Š 1â”Šimport React from 'react';\n-â”Š 4â”Š  â”Šimport { useCallback, useState } from 'react';\n+â”Š  â”Š 2â”Šimport { useMemo } from 'react';\n+â”Š  â”Š 3â”Šimport { Route } from 'react-router-dom';\n â”Š 5â”Š 4â”Šimport styled from 'styled-components';\n-â”Š 6â”Š  â”Šimport { signIn } from '../../services/auth.service';\n+â”Š  â”Š 5â”Šimport AnimatedSwitch from '../AnimatedSwitch';\n+â”Š  â”Š 6â”Šimport SignInForm from './SignInForm';\n+â”Š  â”Š 7â”Šimport SignUpForm from './SignUpForm';\n â”Š 7â”Š 8â”Šimport { RouteComponentProps } from 'react-router-dom';\n â”Š 8â”Š 9â”Š\n â”Š 9â”Š10â”Šconst Container = styled.div `\n-â”Š10â”Š  â”Š  height: 100%;\n â”Š11â”Š11â”Š  background: radial-gradient(rgb(34, 65, 67), rgb(17, 48, 50)),\n â”Š12â”Š12â”Š    url(/assets/chat-background.jpg) no-repeat;\n â”Š13â”Š13â”Š  background-size: cover;\n```\n```diff\n@@ -40,149 +40,48 @@\n â”Š 40â”Š 40â”Š  bottom: 10px;\n â”Š 41â”Š 41â”Š  left: 10px;\n â”Š 42â”Š 42â”Š\n-â”Š 43â”Š   â”Š  a {\n+â”Š   â”Š 43â”Š  label {\n â”Š 44â”Š 44â”Š    color: var(--secondary-bg);\n â”Š 45â”Š 45â”Š  }\n â”Š 46â”Š 46â”Š`;\n â”Š 47â”Š 47â”Š\n-â”Š 48â”Š   â”Šconst SignInForm = styled.div `\n-â”Š 49â”Š   â”Š  height: calc(100% - 265px);\n-â”Š 50â”Š   â”Š`;\n-â”Š 51â”Š   â”Š\n-â”Š 52â”Š   â”Šconst ActualForm = styled.form `\n-â”Š 53â”Š   â”Š  padding: 20px;\n-â”Š 54â”Š   â”Š`;\n-â”Š 55â”Š   â”Š\n-â”Š 56â”Š   â”Šconst Section = styled.div `\n-â”Š 57â”Š   â”Š  width: 100%;\n-â”Š 58â”Š   â”Š  padding-bottom: 35px;\n-â”Š 59â”Š   â”Š`;\n-â”Š 60â”Š   â”Š\n-â”Š 61â”Š   â”Šconst Legend = styled.legend `\n-â”Š 62â”Š   â”Š  font-weight: bold;\n-â”Š 63â”Š   â”Š  color: white;\n-â”Š 64â”Š   â”Š`;\n-â”Š 65â”Š   â”Š\n-â”Š 66â”Š   â”Š// eslint-disable-next-line\n-â”Š 67â”Š   â”Šconst Label = styled.label `\n-â”Š 68â”Š   â”Š  color: white !important;\n-â”Š 69â”Š   â”Š`;\n-â”Š 70â”Š   â”Š\n-â”Š 71â”Š   â”Š// eslint-disable-next-line\n-â”Š 72â”Š   â”Šconst Input = styled.input `\n-â”Š 73â”Š   â”Š  color: white;\n-â”Š 74â”Š   â”Š\n-â”Š 75â”Š   â”Š  &::placeholder {\n-â”Š 76â”Š   â”Š    color: var(--primary-bg);\n-â”Š 77â”Š   â”Š  }\n-â”Š 78â”Š   â”Š`;\n-â”Š 79â”Š   â”Š\n-â”Š 80â”Š   â”Šconst TextField = styled(MaterialTextField) `\n-â”Š 81â”Š   â”Š  width: 100%;\n-â”Š 82â”Š   â”Š  position: relative;\n-â”Š 83â”Š   â”Š\n-â”Š 84â”Š   â”Š  > div::before {\n-â”Š 85â”Š   â”Š    border-color: white !important;\n-â”Š 86â”Š   â”Š  }\n-â”Š 87â”Š   â”Š\n-â”Š 88â”Š   â”Š  input {\n-â”Š 89â”Š   â”Š    color: white !important;\n-â”Š 90â”Š   â”Š\n-â”Š 91â”Š   â”Š    &::placeholder {\n-â”Š 92â”Š   â”Š      color: var(--primary-bg) !important;\n+â”Š   â”Š 48â”Šconst AuthScreen: React.FC<RouteComponentProps<any>> = ({ history, location }) => {\n+â”Š   â”Š 49â”Š  const alternative = useMemo(() => {\n+â”Š   â”Š 50â”Š    if (location.pathname === '/sign-in') {\n+â”Š   â”Š 51â”Š      const handleSignUp = () => {\n+â”Š   â”Š 52â”Š        history.replace('/sign-up');\n+â”Š   â”Š 53â”Š      };\n+â”Š   â”Š 54â”Š\n+â”Š   â”Š 55â”Š      return (\n+â”Š   â”Š 56â”Š        <Alternative>\n+â”Š   â”Š 57â”Š          Don't have an account yet? <label onClick={handleSignUp}>Sign up!</label>\n+â”Š   â”Š 58â”Š        </Alternative>\n+â”Š   â”Š 59â”Š      );\n â”Š 93â”Š 60â”Š    }\n-â”Š 94â”Š   â”Š  }\n-â”Š 95â”Š   â”Š\n-â”Š 96â”Š   â”Š  label {\n-â”Š 97â”Š   â”Š    color: white !important;\n-â”Š 98â”Š   â”Š  }\n-â”Š 99â”Š   â”Š` as typeof MaterialTextField;\n-â”Š100â”Š   â”Š\n-â”Š101â”Š   â”Šconst Button = styled(MaterialButton) `\n-â”Š102â”Š   â”Š  width: 100px;\n-â”Š103â”Š   â”Š  display: block !important;\n-â”Š104â”Š   â”Š  margin: auto !important;\n-â”Š105â”Š   â”Š  background-color: var(--secondary-bg) !important;\n-â”Š106â”Š   â”Š\n-â”Š107â”Š   â”Š  &[disabled] {\n-â”Š108â”Š   â”Š    color: #38a81c;\n-â”Š109â”Š   â”Š  }\n-â”Š110â”Š   â”Š\n-â”Š111â”Š   â”Š  &:not([disabled]) {\n-â”Š112â”Š   â”Š    color: white;\n-â”Š113â”Š   â”Š  }\n-â”Š114â”Š   â”Š` as typeof MaterialButton;\n-â”Š115â”Š   â”Š\n-â”Š116â”Š   â”Šconst AuthScreen: React.FC<RouteComponentProps<any>> = ({ history }) => {\n-â”Š117â”Š   â”Š  const [username, setUsername] = useState('');\n-â”Š118â”Š   â”Š  const [password, setPassword] = useState('');\n-â”Š119â”Š   â”Š  // eslint-disable-next-line\n-â”Š120â”Š   â”Š  const [error, setError] = useState('');\n-â”Š121â”Š   â”Š\n-â”Š122â”Š   â”Š  const onUsernameChange = useCallback(({ target }) => {\n-â”Š123â”Š   â”Š    setError('');\n-â”Š124â”Š   â”Š    setUsername(target.value);\n-â”Š125â”Š   â”Š  }, []);\n-â”Š126â”Š   â”Š\n-â”Š127â”Š   â”Š  const onPasswordChange = useCallback(({ target }) => {\n-â”Š128â”Š   â”Š    setError('');\n-â”Š129â”Š   â”Š    setPassword(target.value);\n-â”Š130â”Š   â”Š  }, []);\n-â”Š131â”Š   â”Š\n-â”Š132â”Š   â”Š  const maySignIn = useCallback(() => {\n-â”Š133â”Š   â”Š    return !!(username && password);\n-â”Š134â”Š   â”Š  }, [username, password]);\n-â”Š135â”Š   â”Š\n-â”Š136â”Š   â”Š  const handleSignIn = useCallback(() => {\n-â”Š137â”Š   â”Š    signIn({ username, password })\n-â”Š138â”Š   â”Š      .then(() => {\n-â”Š139â”Š   â”Š        history.push('/chats')\n-â”Š140â”Š   â”Š      })\n-â”Š141â”Š   â”Š      .catch(error => {\n-â”Š142â”Š   â”Š        setError(error.message || error)\n-â”Š143â”Š   â”Š      });\n-â”Š144â”Š   â”Š  }, [username, password, history]);\n+â”Š   â”Š 61â”Š    else {\n+â”Š   â”Š 62â”Š      const handleSignIn = () => {\n+â”Š   â”Š 63â”Š        history.replace('/sign-in');\n+â”Š   â”Š 64â”Š      };\n+â”Š   â”Š 65â”Š\n+â”Š   â”Š 66â”Š      return (\n+â”Š   â”Š 67â”Š        <Alternative>\n+â”Š   â”Š 68â”Š          Already have an accout? <label onClick={handleSignIn}>Sign in!</label>\n+â”Š   â”Š 69â”Š        </Alternative>\n+â”Š   â”Š 70â”Š      );\n+â”Š   â”Š 71â”Š    }\n+â”Š   â”Š 72â”Š  }, [location.pathname, history]);\n â”Š145â”Š 73â”Š\n â”Š146â”Š 74â”Š  return (\n-â”Š147â”Š   â”Š    <Container>\n-â”Š148â”Š   â”Š      <Intro>\n+â”Š   â”Š 75â”Š    <Container className=\"AuthScreen Screen\">\n+â”Š   â”Š 76â”Š      <Intro className=\"AuthScreen-intro\">\n â”Š149â”Š 77â”Š        <Icon src=\"assets/whatsapp-icon.png\" className=\"AuthScreen-icon\" />\n â”Š150â”Š 78â”Š        <Title className=\"AuthScreen-title\">WhatsApp</Title>\n â”Š151â”Š 79â”Š      </Intro>\n-â”Š152â”Š   â”Š      <SignInForm>\n-â”Š153â”Š   â”Š        <ActualForm>\n-â”Š154â”Š   â”Š          <Legend>Sign in</Legend>\n-â”Š155â”Š   â”Š          <Section>\n-â”Š156â”Š   â”Š            <TextField\n-â”Š157â”Š   â”Š              className=\"AuthScreen-text-field\"\n-â”Š158â”Š   â”Š              label=\"Username\"\n-â”Š159â”Š   â”Š              value={username}\n-â”Š160â”Š   â”Š              onChange={onUsernameChange}\n-â”Š161â”Š   â”Š              margin=\"normal\"\n-â”Š162â”Š   â”Š              placeholder=\"Enter your username\"\n-â”Š163â”Š   â”Š            />\n-â”Š164â”Š   â”Š            <TextField\n-â”Š165â”Š   â”Š              className=\"AuthScreen-text-field\"\n-â”Š166â”Š   â”Š              label=\"Password\"\n-â”Š167â”Š   â”Š              type=\"password\"\n-â”Š168â”Š   â”Š              value={password}\n-â”Š169â”Š   â”Š              onChange={onPasswordChange}\n-â”Š170â”Š   â”Š              margin=\"normal\"\n-â”Š171â”Š   â”Š              placeholder=\"Enter your password\"\n-â”Š172â”Š   â”Š            />\n-â”Š173â”Š   â”Š          </Section>\n-â”Š174â”Š   â”Š          <Button\n-â”Š175â”Š   â”Š            data-testid=\"sign-in-button\"\n-â”Š176â”Š   â”Š            type=\"button\"\n-â”Š177â”Š   â”Š            color=\"secondary\"\n-â”Š178â”Š   â”Š            variant=\"contained\"\n-â”Š179â”Š   â”Š            disabled={!maySignIn()}\n-â”Š180â”Š   â”Š            onClick={handleSignIn}\n-â”Š181â”Š   â”Š          >\n-â”Š182â”Š   â”Š            Sign in\n-â”Š183â”Š   â”Š          </Button>\n-â”Š184â”Š   â”Š        </ActualForm>\n-â”Š185â”Š   â”Š      </SignInForm>\n+â”Š   â”Š 80â”Š      <AnimatedSwitch>\n+â”Š   â”Š 81â”Š        <Route exact path=\"/sign-in\" component={SignInForm} />\n+â”Š   â”Š 82â”Š        <Route exact path=\"/sign-up\" component={SignUpForm} />\n+â”Š   â”Š 83â”Š      </AnimatedSwitch>\n+â”Š   â”Š 84â”Š      {alternative}\n â”Š186â”Š 85â”Š    </Container>\n â”Š187â”Š 86â”Š  );\n â”Š188â”Š 87â”Š};\n```\n\n[}]: #\n\nAnd then we will make the necessary changes in the `AuthScreen`:\n\n[{]: <helper> (diffStep 13.6 module=\"client\")\n\n#### Client Step 13.6: Split AuthScreen into SignInForm and SignUpForm\n\n##### Added src&#x2F;components&#x2F;AuthScreen&#x2F;SignInForm.test.tsx\n```diff\n@@ -0,0 +1,81 @@\n+â”Š  â”Š 1â”Šimport { createMemoryHistory } from 'history';\n+â”Š  â”Š 2â”Šimport React from 'react';\n+â”Š  â”Š 3â”Šimport { cleanup, render, fireEvent, wait, waitForElement } from 'react-testing-library';\n+â”Š  â”Š 4â”Šimport SignInForm from './SignInForm';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šdescribe('SignInForm', () => {\n+â”Š  â”Š 7â”Š  afterEach(cleanup);\n+â”Š  â”Š 8â”Š  afterEach(() => fetch.resetMocks());\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Š  it('enables sign-in button when filled in', async () => {\n+â”Š  â”Š11â”Š    const history = createMemoryHistory();\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Š    {\n+â”Š  â”Š14â”Š      const { container, getByTestId } = render(<SignInForm history={history} />);\n+â”Š  â”Š15â”Š      const usernameInput = getByTestId('username-input').querySelector('input');\n+â”Š  â”Š16â”Š      const passwordInput = getByTestId('password-input').querySelector('input');\n+â”Š  â”Š17â”Š      const signInButton = getByTestId('sign-in-button') as HTMLButtonElement;\n+â”Š  â”Š18â”Š\n+â”Š  â”Š19â”Š      expect(signInButton.disabled).toEqual(true);\n+â”Š  â”Š20â”Š\n+â”Š  â”Š21â”Š      fireEvent.change(usernameInput, { target: { value: 'username' } });\n+â”Š  â”Š22â”Š      fireEvent.change(passwordInput, { target: { value: 'password' } });\n+â”Š  â”Š23â”Š\n+â”Š  â”Š24â”Š      await waitForElement(() => usernameInput);\n+â”Š  â”Š25â”Š      await waitForElement(() => passwordInput);\n+â”Š  â”Š26â”Š\n+â”Š  â”Š27â”Š      expect(signInButton.disabled).toEqual(false);\n+â”Š  â”Š28â”Š    }\n+â”Š  â”Š29â”Š  });\n+â”Š  â”Š30â”Š\n+â”Š  â”Š31â”Š  it('prints server error if input was wrong', async () => {\n+â”Š  â”Š32â”Š    const history = createMemoryHistory();\n+â”Š  â”Š33â”Š\n+â”Š  â”Š34â”Š    fetchMock.mockRejectOnce(new Error('sign-in failed'));\n+â”Š  â”Š35â”Š\n+â”Š  â”Š36â”Š    {\n+â”Š  â”Š37â”Š      const { container, getByTestId } = render(<SignInForm history={history} />);\n+â”Š  â”Š38â”Š      const usernameInput = getByTestId('username-input').querySelector('input');\n+â”Š  â”Š39â”Š      const passwordInput = getByTestId('password-input').querySelector('input');\n+â”Š  â”Š40â”Š      const signInButton = getByTestId('sign-in-button') as HTMLButtonElement;\n+â”Š  â”Š41â”Š      const errorMessage = getByTestId('error-message');\n+â”Š  â”Š42â”Š\n+â”Š  â”Š43â”Š      fireEvent.change(usernameInput, { target: { value: 'username' } });\n+â”Š  â”Š44â”Š      fireEvent.change(passwordInput, { target: { value: 'password' } });\n+â”Š  â”Š45â”Š\n+â”Š  â”Š46â”Š      await waitForElement(() => usernameInput);\n+â”Š  â”Š47â”Š      await waitForElement(() => passwordInput);\n+â”Š  â”Š48â”Š\n+â”Š  â”Š49â”Š      fireEvent.click(signInButton);\n+â”Š  â”Š50â”Š\n+â”Š  â”Š51â”Š      await waitForElement(() => errorMessage);\n+â”Š  â”Š52â”Š\n+â”Š  â”Š53â”Š      expect(errorMessage.innerHTML).toEqual('sign-in failed');\n+â”Š  â”Š54â”Š    }\n+â”Š  â”Š55â”Š  });\n+â”Š  â”Š56â”Š\n+â”Š  â”Š57â”Š  it('navigates to /chats if everything went right', async () => {\n+â”Š  â”Š58â”Š    const history = createMemoryHistory();\n+â”Š  â”Š59â”Š\n+â”Š  â”Š60â”Š    fetchMock.mockResponseOnce('success');\n+â”Š  â”Š61â”Š\n+â”Š  â”Š62â”Š    {\n+â”Š  â”Š63â”Š      const { container, getByTestId } = render(<SignInForm history={history} />);\n+â”Š  â”Š64â”Š      const usernameInput = getByTestId('username-input').querySelector('input');\n+â”Š  â”Š65â”Š      const passwordInput = getByTestId('password-input').querySelector('input');\n+â”Š  â”Š66â”Š      const signInButton = getByTestId('sign-in-button') as HTMLButtonElement;\n+â”Š  â”Š67â”Š\n+â”Š  â”Š68â”Š      fireEvent.change(usernameInput, { target: { value: 'username' } });\n+â”Š  â”Š69â”Š      fireEvent.change(passwordInput, { target: { value: 'password' } });\n+â”Š  â”Š70â”Š\n+â”Š  â”Š71â”Š      await waitForElement(() => usernameInput);\n+â”Š  â”Š72â”Š      await waitForElement(() => passwordInput);\n+â”Š  â”Š73â”Š\n+â”Š  â”Š74â”Š      fireEvent.click(signInButton);\n+â”Š  â”Š75â”Š\n+â”Š  â”Š76â”Š      await wait(() =>\n+â”Š  â”Š77â”Š        expect(history.location.pathname).toEqual('/chats')\n+â”Š  â”Š78â”Š      );\n+â”Š  â”Š79â”Š    }\n+â”Š  â”Š80â”Š  });\n+â”Š  â”Š81â”Š});\n```\n\n##### Added src&#x2F;components&#x2F;AuthScreen&#x2F;SignInForm.tsx\n```diff\n@@ -0,0 +1,83 @@\n+â”Š  â”Š 1â”Šimport React from 'react';\n+â”Š  â”Š 2â”Šimport { useCallback, useState } from 'react';\n+â”Š  â”Š 3â”Šimport { signIn } from '../../services/auth.service';\n+â”Š  â”Š 4â”Šimport {\n+â”Š  â”Š 5â”Š  SignForm,\n+â”Š  â”Š 6â”Š  ActualForm,\n+â”Š  â”Š 7â”Š  Legend,\n+â”Š  â”Š 8â”Š  Section,\n+â”Š  â”Š 9â”Š  TextField,\n+â”Š  â”Š10â”Š  Button,\n+â”Š  â”Š11â”Š  ErrorMessage,\n+â”Š  â”Š12â”Š} from './form-components';\n+â”Š  â”Š13â”Šimport { RouteComponentProps } from 'react-router-dom';\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”Šconst SignInForm: React.FC<RouteComponentProps<any>> = ({ history }) => {\n+â”Š  â”Š16â”Š  const [username, setUsername] = useState('');\n+â”Š  â”Š17â”Š  const [password, setPassword] = useState('');\n+â”Š  â”Š18â”Š  const [error, setError] = useState('');\n+â”Š  â”Š19â”Š\n+â”Š  â”Š20â”Š  const onUsernameChange = useCallback(({ target }) => {\n+â”Š  â”Š21â”Š    setError('');\n+â”Š  â”Š22â”Š    setUsername(target.value);\n+â”Š  â”Š23â”Š  }, []);\n+â”Š  â”Š24â”Š\n+â”Š  â”Š25â”Š  const onPasswordChange = useCallback(({ target }) => {\n+â”Š  â”Š26â”Š    setError('');\n+â”Š  â”Š27â”Š    setPassword(target.value);\n+â”Š  â”Š28â”Š  }, []);\n+â”Š  â”Š29â”Š\n+â”Š  â”Š30â”Š  const maySignIn = useCallback(() => {\n+â”Š  â”Š31â”Š    return !!(username && password);\n+â”Š  â”Š32â”Š  }, [username, password]);\n+â”Š  â”Š33â”Š\n+â”Š  â”Š34â”Š  const handleSignIn = useCallback(() => {\n+â”Š  â”Š35â”Š    signIn({ username, password })\n+â”Š  â”Š36â”Š      .then(() => {\n+â”Š  â”Š37â”Š        history.replace('/chats')\n+â”Š  â”Š38â”Š      })\n+â”Š  â”Š39â”Š      .catch(error => {\n+â”Š  â”Š40â”Š        setError(error.message || error)\n+â”Š  â”Š41â”Š      });\n+â”Š  â”Š42â”Š  }, [username, password, history]);\n+â”Š  â”Š43â”Š\n+â”Š  â”Š44â”Š  return (\n+â”Š  â”Š45â”Š    <SignForm>\n+â”Š  â”Š46â”Š      <ActualForm>\n+â”Š  â”Š47â”Š        <Legend>Sign in</Legend>\n+â”Š  â”Š48â”Š        <Section style={{ width: '100%' }}>\n+â”Š  â”Š49â”Š          <TextField\n+â”Š  â”Š50â”Š            data-testid=\"username-input\"\n+â”Š  â”Š51â”Š            label=\"Username\"\n+â”Š  â”Š52â”Š            value={username}\n+â”Š  â”Š53â”Š            onChange={onUsernameChange}\n+â”Š  â”Š54â”Š            margin=\"normal\"\n+â”Š  â”Š55â”Š            placeholder=\"Enter your username\"\n+â”Š  â”Š56â”Š          />\n+â”Š  â”Š57â”Š          <TextField\n+â”Š  â”Š58â”Š            data-testid=\"password-input\"\n+â”Š  â”Š59â”Š            label=\"Password\"\n+â”Š  â”Š60â”Š            type=\"password\"\n+â”Š  â”Š61â”Š            value={password}\n+â”Š  â”Š62â”Š            onChange={onPasswordChange}\n+â”Š  â”Š63â”Š            margin=\"normal\"\n+â”Š  â”Š64â”Š            placeholder=\"Enter your password\"\n+â”Š  â”Š65â”Š          />\n+â”Š  â”Š66â”Š        </Section>\n+â”Š  â”Š67â”Š        <Button\n+â”Š  â”Š68â”Š          data-testid=\"sign-in-button\"\n+â”Š  â”Š69â”Š          type=\"button\"\n+â”Š  â”Š70â”Š          color=\"secondary\"\n+â”Š  â”Š71â”Š          variant=\"contained\"\n+â”Š  â”Š72â”Š          disabled={!maySignIn()}\n+â”Š  â”Š73â”Š          onClick={handleSignIn}\n+â”Š  â”Š74â”Š        >\n+â”Š  â”Š75â”Š          Sign in\n+â”Š  â”Š76â”Š        </Button>\n+â”Š  â”Š77â”Š        <ErrorMessage data-testid=\"error-message\">{error}</ErrorMessage>\n+â”Š  â”Š78â”Š      </ActualForm>\n+â”Š  â”Š79â”Š    </SignForm>\n+â”Š  â”Š80â”Š  );\n+â”Š  â”Š81â”Š};\n+â”Š  â”Š82â”Š\n+â”Š  â”Š83â”Šexport default SignInForm;\n```\n\n##### Added src&#x2F;components&#x2F;AuthScreen&#x2F;SignUpForm.test.tsx\n```diff\n@@ -0,0 +1,99 @@\n+â”Š  â”Š 1â”Šimport { createMemoryHistory } from 'history';\n+â”Š  â”Š 2â”Šimport React from 'react';\n+â”Š  â”Š 3â”Šimport { cleanup, render, fireEvent, wait, waitForElement } from 'react-testing-library';\n+â”Š  â”Š 4â”Šimport SignUpForm from './SignUpForm';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šdescribe('SignUpForm', () => {\n+â”Š  â”Š 7â”Š  afterEach(cleanup);\n+â”Š  â”Š 8â”Š  afterEach(() => fetch.resetMocks());\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Š  it('enables sign-up button when filled in', async () => {\n+â”Š  â”Š11â”Š    const history = createMemoryHistory();\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Š    {\n+â”Š  â”Š14â”Š      const { container, getByTestId } = render(<SignUpForm history={history} />);\n+â”Š  â”Š15â”Š      const nameInput = getByTestId('name-input').querySelector('input');\n+â”Š  â”Š16â”Š      const usernameInput = getByTestId('username-input').querySelector('input');\n+â”Š  â”Š17â”Š      const passwordInput = getByTestId('password-input').querySelector('input');\n+â”Š  â”Š18â”Š      const passwordConfirmInput = getByTestId('password-confirm-input').querySelector('input');\n+â”Š  â”Š19â”Š      const signUpButton = getByTestId('sign-up-button') as HTMLButtonElement;\n+â”Š  â”Š20â”Š\n+â”Š  â”Š21â”Š      expect(signUpButton.disabled).toEqual(true);\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Š      fireEvent.change(nameInput, { target: { value: 'User Name' } });\n+â”Š  â”Š24â”Š      fireEvent.change(usernameInput, { target: { value: 'username' } });\n+â”Š  â”Š25â”Š      fireEvent.change(passwordInput, { target: { value: 'password' } });\n+â”Š  â”Š26â”Š      fireEvent.change(passwordConfirmInput, { target: { value: 'password' } });\n+â”Š  â”Š27â”Š\n+â”Š  â”Š28â”Š      await waitForElement(() => nameInput);\n+â”Š  â”Š29â”Š      await waitForElement(() => usernameInput);\n+â”Š  â”Š30â”Š      await waitForElement(() => passwordInput);\n+â”Š  â”Š31â”Š      await waitForElement(() => passwordConfirmInput);\n+â”Š  â”Š32â”Š\n+â”Š  â”Š33â”Š      expect(signUpButton.disabled).toEqual(false);\n+â”Š  â”Š34â”Š    }\n+â”Š  â”Š35â”Š  });\n+â”Š  â”Š36â”Š\n+â”Š  â”Š37â”Š  it('prints server error if input was wrong', async () => {\n+â”Š  â”Š38â”Š    const history = createMemoryHistory();\n+â”Š  â”Š39â”Š\n+â”Š  â”Š40â”Š    fetchMock.mockRejectOnce(new Error('sign-up failed'));\n+â”Š  â”Š41â”Š\n+â”Š  â”Š42â”Š    {\n+â”Š  â”Š43â”Š      const { container, getByTestId } = render(<SignUpForm history={history} />);\n+â”Š  â”Š44â”Š      const nameInput = getByTestId('name-input').querySelector('input');\n+â”Š  â”Š45â”Š      const usernameInput = getByTestId('username-input').querySelector('input');\n+â”Š  â”Š46â”Š      const passwordInput = getByTestId('password-input').querySelector('input');\n+â”Š  â”Š47â”Š      const passwordConfirmInput = getByTestId('password-confirm-input').querySelector('input');\n+â”Š  â”Š48â”Š      const signUpButton = getByTestId('sign-up-button') as HTMLButtonElement;\n+â”Š  â”Š49â”Š      const errorMessage = getByTestId('error-message');\n+â”Š  â”Š50â”Š\n+â”Š  â”Š51â”Š      fireEvent.change(nameInput, { target: { value: 'User Name' } });\n+â”Š  â”Š52â”Š      fireEvent.change(usernameInput, { target: { value: 'username' } });\n+â”Š  â”Š53â”Š      fireEvent.change(passwordInput, { target: { value: 'password' } });\n+â”Š  â”Š54â”Š      fireEvent.change(passwordConfirmInput, { target: { value: 'password' } });\n+â”Š  â”Š55â”Š\n+â”Š  â”Š56â”Š      await waitForElement(() => nameInput);\n+â”Š  â”Š57â”Š      await waitForElement(() => usernameInput);\n+â”Š  â”Š58â”Š      await waitForElement(() => passwordInput);\n+â”Š  â”Š59â”Š      await waitForElement(() => passwordConfirmInput);\n+â”Š  â”Š60â”Š\n+â”Š  â”Š61â”Š      fireEvent.click(signUpButton);\n+â”Š  â”Š62â”Š\n+â”Š  â”Š63â”Š      await waitForElement(() => errorMessage);\n+â”Š  â”Š64â”Š\n+â”Š  â”Š65â”Š      expect(errorMessage.innerHTML).toEqual('sign-up failed');\n+â”Š  â”Š66â”Š    }\n+â”Š  â”Š67â”Š  });\n+â”Š  â”Š68â”Š\n+â”Š  â”Š69â”Š  it('navigates to /sign-in if everything went right', async () => {\n+â”Š  â”Š70â”Š    const history = createMemoryHistory();\n+â”Š  â”Š71â”Š\n+â”Š  â”Š72â”Š    fetchMock.mockResponseOnce('success');\n+â”Š  â”Š73â”Š\n+â”Š  â”Š74â”Š    {\n+â”Š  â”Š75â”Š      const { container, getByTestId } = render(<SignUpForm history={history} />);\n+â”Š  â”Š76â”Š      const nameInput = getByTestId('name-input').querySelector('input');\n+â”Š  â”Š77â”Š      const usernameInput = getByTestId('username-input').querySelector('input');\n+â”Š  â”Š78â”Š      const passwordInput = getByTestId('password-input').querySelector('input');\n+â”Š  â”Š79â”Š      const passwordConfirmInput = getByTestId('password-confirm-input').querySelector('input');\n+â”Š  â”Š80â”Š      const signUpButton = getByTestId('sign-up-button') as HTMLButtonElement;\n+â”Š  â”Š81â”Š\n+â”Š  â”Š82â”Š      fireEvent.change(nameInput, { target: { value: 'User Name' } });\n+â”Š  â”Š83â”Š      fireEvent.change(usernameInput, { target: { value: 'username' } });\n+â”Š  â”Š84â”Š      fireEvent.change(passwordInput, { target: { value: 'password' } });\n+â”Š  â”Š85â”Š      fireEvent.change(passwordConfirmInput, { target: { value: 'password' } });\n+â”Š  â”Š86â”Š\n+â”Š  â”Š87â”Š      await waitForElement(() => nameInput);\n+â”Š  â”Š88â”Š      await waitForElement(() => usernameInput);\n+â”Š  â”Š89â”Š      await waitForElement(() => passwordInput);\n+â”Š  â”Š90â”Š      await waitForElement(() => passwordConfirmInput);\n+â”Š  â”Š91â”Š\n+â”Š  â”Š92â”Š      fireEvent.click(signUpButton);\n+â”Š  â”Š93â”Š\n+â”Š  â”Š94â”Š      await wait(() =>\n+â”Š  â”Š95â”Š        expect(history.location.pathname).toEqual('/sign-in')\n+â”Š  â”Š96â”Š      );\n+â”Š  â”Š97â”Š    }\n+â”Š  â”Š98â”Š  });\n+â”Š  â”Š99â”Š});\n```\n\n##### Added src&#x2F;components&#x2F;AuthScreen&#x2F;SignUpForm.tsx\n```diff\n@@ -0,0 +1,126 @@\n+â”Š   â”Š  1â”Šimport React from 'react';\n+â”Š   â”Š  2â”Šimport { useCallback, useState } from 'react';\n+â”Š   â”Š  3â”Šimport { signUp } from '../../services/auth.service';\n+â”Š   â”Š  4â”Šimport {\n+â”Š   â”Š  5â”Š  SignForm,\n+â”Š   â”Š  6â”Š  ActualForm,\n+â”Š   â”Š  7â”Š  Legend,\n+â”Š   â”Š  8â”Š  Section,\n+â”Š   â”Š  9â”Š  TextField,\n+â”Š   â”Š 10â”Š  Button,\n+â”Š   â”Š 11â”Š  ErrorMessage,\n+â”Š   â”Š 12â”Š} from './form-components';\n+â”Š   â”Š 13â”Šimport { RouteComponentProps } from 'react-router-dom';\n+â”Š   â”Š 14â”Š\n+â”Š   â”Š 15â”Šconst SignUpForm: React.FC<RouteComponentProps<any>> = ({ history }) => {\n+â”Š   â”Š 16â”Š  const [name, setName] = useState('');\n+â”Š   â”Š 17â”Š  const [username, setUsername] = useState('');\n+â”Š   â”Š 18â”Š  const [password, setPassword] = useState('');\n+â”Š   â”Š 19â”Š  const [passwordConfirm, setPasswordConfirm] = useState('');\n+â”Š   â”Š 20â”Š  const [error, setError] = useState('');\n+â”Š   â”Š 21â”Š\n+â”Š   â”Š 22â”Š  const updateName = useCallback(({ target }) => {\n+â”Š   â”Š 23â”Š    setError('');\n+â”Š   â”Š 24â”Š    setName(target.value);\n+â”Š   â”Š 25â”Š  }, []);\n+â”Š   â”Š 26â”Š\n+â”Š   â”Š 27â”Š  const updateUsername = useCallback(({ target }) => {\n+â”Š   â”Š 28â”Š    setError('');\n+â”Š   â”Š 29â”Š    setUsername(target.value);\n+â”Š   â”Š 30â”Š  }, []);\n+â”Š   â”Š 31â”Š\n+â”Š   â”Š 32â”Š  const updatePassword = useCallback(({ target }) => {\n+â”Š   â”Š 33â”Š    setError('');\n+â”Š   â”Š 34â”Š    setPassword(target.value);\n+â”Š   â”Š 35â”Š  }, []);\n+â”Š   â”Š 36â”Š\n+â”Š   â”Š 37â”Š  const updatePasswordConfirm = useCallback(({ target }) => {\n+â”Š   â”Š 38â”Š    setError('');\n+â”Š   â”Š 39â”Š    setPasswordConfirm(target.value);\n+â”Š   â”Š 40â”Š  }, []);\n+â”Š   â”Š 41â”Š\n+â”Š   â”Š 42â”Š  const maySignUp = useCallback(() => {\n+â”Š   â”Š 43â”Š    return !!(name && username && password && password === passwordConfirm);\n+â”Š   â”Š 44â”Š  }, [name, username, password, passwordConfirm]);\n+â”Š   â”Š 45â”Š\n+â”Š   â”Š 46â”Š  const handleSignUp = useCallback(() => {\n+â”Š   â”Š 47â”Š    signUp({ username, password, passwordConfirm, name })\n+â”Š   â”Š 48â”Š      .then(() => {\n+â”Š   â”Š 49â”Š        history.replace('/sign-in')\n+â”Š   â”Š 50â”Š      })\n+â”Š   â”Š 51â”Š      .catch(error => {\n+â”Š   â”Š 52â”Š        setError(error.message || error)\n+â”Š   â”Š 53â”Š      });\n+â”Š   â”Š 54â”Š  }, [name, username, password, passwordConfirm, history]);\n+â”Š   â”Š 55â”Š\n+â”Š   â”Š 56â”Š  return (\n+â”Š   â”Š 57â”Š    <SignForm>\n+â”Š   â”Š 58â”Š      <ActualForm>\n+â”Š   â”Š 59â”Š        <Legend>Sign up</Legend>\n+â”Š   â”Š 60â”Š        <Section\n+â”Š   â”Š 61â”Š          style={{\n+â”Š   â”Š 62â”Š            float: 'left',\n+â”Š   â”Š 63â”Š            width: 'calc(50% - 10px)',\n+â”Š   â”Š 64â”Š            paddingRight: '10px',\n+â”Š   â”Š 65â”Š          }}\n+â”Š   â”Š 66â”Š        >\n+â”Š   â”Š 67â”Š          <TextField\n+â”Š   â”Š 68â”Š            data-testid=\"name-input\"\n+â”Š   â”Š 69â”Š            label=\"Name\"\n+â”Š   â”Š 70â”Š            value={name}\n+â”Š   â”Š 71â”Š            onChange={updateName}\n+â”Š   â”Š 72â”Š            autoComplete=\"off\"\n+â”Š   â”Š 73â”Š            margin=\"normal\"\n+â”Š   â”Š 74â”Š          />\n+â”Š   â”Š 75â”Š          <TextField\n+â”Š   â”Š 76â”Š            data-testid=\"username-input\"\n+â”Š   â”Š 77â”Š            label=\"Username\"\n+â”Š   â”Š 78â”Š            value={username}\n+â”Š   â”Š 79â”Š            onChange={updateUsername}\n+â”Š   â”Š 80â”Š            autoComplete=\"off\"\n+â”Š   â”Š 81â”Š            margin=\"normal\"\n+â”Š   â”Š 82â”Š          />\n+â”Š   â”Š 83â”Š        </Section>\n+â”Š   â”Š 84â”Š        <Section\n+â”Š   â”Š 85â”Š          style={{\n+â”Š   â”Š 86â”Š            float: 'right',\n+â”Š   â”Š 87â”Š            width: 'calc(50% - 10px)',\n+â”Š   â”Š 88â”Š            paddingLeft: '10px',\n+â”Š   â”Š 89â”Š          }}\n+â”Š   â”Š 90â”Š        >\n+â”Š   â”Š 91â”Š          <TextField\n+â”Š   â”Š 92â”Š            data-testid=\"password-input\"\n+â”Š   â”Š 93â”Š            label=\"Password\"\n+â”Š   â”Š 94â”Š            type=\"password\"\n+â”Š   â”Š 95â”Š            value={password}\n+â”Š   â”Š 96â”Š            onChange={updatePassword}\n+â”Š   â”Š 97â”Š            autoComplete=\"off\"\n+â”Š   â”Š 98â”Š            margin=\"normal\"\n+â”Š   â”Š 99â”Š          />\n+â”Š   â”Š100â”Š          <TextField\n+â”Š   â”Š101â”Š            data-testid=\"password-confirm-input\"\n+â”Š   â”Š102â”Š            label=\"Confirm password\"\n+â”Š   â”Š103â”Š            type=\"password\"\n+â”Š   â”Š104â”Š            value={passwordConfirm}\n+â”Š   â”Š105â”Š            onChange={updatePasswordConfirm}\n+â”Š   â”Š106â”Š            autoComplete=\"off\"\n+â”Š   â”Š107â”Š            margin=\"normal\"\n+â”Š   â”Š108â”Š          />\n+â”Š   â”Š109â”Š        </Section>\n+â”Š   â”Š110â”Š        <Button\n+â”Š   â”Š111â”Š          data-testid=\"sign-up-button\"\n+â”Š   â”Š112â”Š          type=\"button\"\n+â”Š   â”Š113â”Š          color=\"secondary\"\n+â”Š   â”Š114â”Š          variant=\"contained\"\n+â”Š   â”Š115â”Š          disabled={!maySignUp()}\n+â”Š   â”Š116â”Š          onClick={handleSignUp}\n+â”Š   â”Š117â”Š        >\n+â”Š   â”Š118â”Š          Sign up\n+â”Š   â”Š119â”Š        </Button>\n+â”Š   â”Š120â”Š        <ErrorMessage data-testid=\"error-message\">{error}</ErrorMessage>\n+â”Š   â”Š121â”Š      </ActualForm>\n+â”Š   â”Š122â”Š    </SignForm>\n+â”Š   â”Š123â”Š  );\n+â”Š   â”Š124â”Š};\n+â”Š   â”Š125â”Š\n+â”Š   â”Š126â”Šexport default SignUpForm;ðŸš«â†µ\n```\n\n##### Added src&#x2F;components&#x2F;AuthScreen&#x2F;form-components.ts\n```diff\n@@ -0,0 +1,75 @@\n+â”Š  â”Š 1â”Šimport MaterialButton from '@material-ui/core/Button';\n+â”Š  â”Š 2â”Šimport MaterialTextField from '@material-ui/core/TextField';\n+â”Š  â”Š 3â”Šimport styled from 'styled-components';\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šexport const SignForm = styled.div `\n+â”Š  â”Š 6â”Š  height: calc(100% - 265px);\n+â”Š  â”Š 7â”Š`;\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Šexport const ActualForm = styled.form `\n+â”Š  â”Š10â”Š  padding: 20px;\n+â”Š  â”Š11â”Š`;\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Šexport const Section = styled.div `\n+â”Š  â”Š14â”Š  padding-bottom: 35px;\n+â”Š  â”Š15â”Š`;\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Šexport const Legend = styled.legend `\n+â”Š  â”Š18â”Š  font-weight: bold;\n+â”Š  â”Š19â”Š  color: white;\n+â”Š  â”Š20â”Š`;\n+â”Š  â”Š21â”Š\n+â”Š  â”Š22â”Šexport const Label = styled.label `\n+â”Š  â”Š23â”Š  color: white !important;\n+â”Š  â”Š24â”Š`;\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Šexport const Input = styled.input `\n+â”Š  â”Š27â”Š  color: white;\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š  &::placeholder {\n+â”Š  â”Š30â”Š    color: var(--primary-bg);\n+â”Š  â”Š31â”Š  }\n+â”Š  â”Š32â”Š`;\n+â”Š  â”Š33â”Š\n+â”Š  â”Š34â”Šexport const TextField = styled(MaterialTextField) `\n+â”Š  â”Š35â”Š  width: 100%;\n+â”Š  â”Š36â”Š  position: relative;\n+â”Š  â”Š37â”Š\n+â”Š  â”Š38â”Š  > div::before {\n+â”Š  â”Š39â”Š    border-color: white !important;\n+â”Š  â”Š40â”Š  }\n+â”Š  â”Š41â”Š\n+â”Š  â”Š42â”Š  input {\n+â”Š  â”Š43â”Š    color: white !important;\n+â”Š  â”Š44â”Š\n+â”Š  â”Š45â”Š    &::placeholder {\n+â”Š  â”Š46â”Š      color: var(--primary-bg) !important;\n+â”Š  â”Š47â”Š    }\n+â”Š  â”Š48â”Š  }\n+â”Š  â”Š49â”Š\n+â”Š  â”Š50â”Š  label {\n+â”Š  â”Š51â”Š    color: white !important;\n+â”Š  â”Š52â”Š  }\n+â”Š  â”Š53â”Š` as typeof MaterialTextField;\n+â”Š  â”Š54â”Š\n+â”Š  â”Š55â”Šexport const Button = styled(MaterialButton) `\n+â”Š  â”Š56â”Š  width: 100px;\n+â”Š  â”Š57â”Š  display: block !important;\n+â”Š  â”Š58â”Š  margin: auto !important;\n+â”Š  â”Š59â”Š  background-color: var(--secondary-bg) !important;\n+â”Š  â”Š60â”Š\n+â”Š  â”Š61â”Š  &[disabled] {\n+â”Š  â”Š62â”Š    color: #38a81c;\n+â”Š  â”Š63â”Š  }\n+â”Š  â”Š64â”Š\n+â”Š  â”Š65â”Š  &:not([disabled]) {\n+â”Š  â”Š66â”Š    color: white;\n+â”Š  â”Š67â”Š  }\n+â”Š  â”Š68â”Š` as typeof MaterialButton;\n+â”Š  â”Š69â”Š\n+â”Š  â”Š70â”Šexport const ErrorMessage = styled.div `\n+â”Š  â”Š71â”Š  position: fixed;\n+â”Š  â”Š72â”Š  color: red;\n+â”Š  â”Š73â”Š  font-size: 15px;\n+â”Š  â”Š74â”Š  margin-top: 20px;\n+â”Š  â”Š75â”Š`;\n```\n\n##### Changed src&#x2F;components&#x2F;AuthScreen&#x2F;index.tsx\n```diff\n@@ -1,13 +1,13 @@\n-â”Š 1â”Š  â”Šimport MaterialButton from '@material-ui/core/Button';\n-â”Š 2â”Š  â”Šimport MaterialTextField from '@material-ui/core/TextField';\n â”Š 3â”Š 1â”Šimport React from 'react';\n-â”Š 4â”Š  â”Šimport { useCallback, useState } from 'react';\n+â”Š  â”Š 2â”Šimport { useMemo } from 'react';\n+â”Š  â”Š 3â”Šimport { Route } from 'react-router-dom';\n â”Š 5â”Š 4â”Šimport styled from 'styled-components';\n-â”Š 6â”Š  â”Šimport { signIn } from '../../services/auth.service';\n+â”Š  â”Š 5â”Šimport AnimatedSwitch from '../AnimatedSwitch';\n+â”Š  â”Š 6â”Šimport SignInForm from './SignInForm';\n+â”Š  â”Š 7â”Šimport SignUpForm from './SignUpForm';\n â”Š 7â”Š 8â”Šimport { RouteComponentProps } from 'react-router-dom';\n â”Š 8â”Š 9â”Š\n â”Š 9â”Š10â”Šconst Container = styled.div `\n-â”Š10â”Š  â”Š  height: 100%;\n â”Š11â”Š11â”Š  background: radial-gradient(rgb(34, 65, 67), rgb(17, 48, 50)),\n â”Š12â”Š12â”Š    url(/assets/chat-background.jpg) no-repeat;\n â”Š13â”Š13â”Š  background-size: cover;\n```\n```diff\n@@ -40,149 +40,48 @@\n â”Š 40â”Š 40â”Š  bottom: 10px;\n â”Š 41â”Š 41â”Š  left: 10px;\n â”Š 42â”Š 42â”Š\n-â”Š 43â”Š   â”Š  a {\n+â”Š   â”Š 43â”Š  label {\n â”Š 44â”Š 44â”Š    color: var(--secondary-bg);\n â”Š 45â”Š 45â”Š  }\n â”Š 46â”Š 46â”Š`;\n â”Š 47â”Š 47â”Š\n-â”Š 48â”Š   â”Šconst SignInForm = styled.div `\n-â”Š 49â”Š   â”Š  height: calc(100% - 265px);\n-â”Š 50â”Š   â”Š`;\n-â”Š 51â”Š   â”Š\n-â”Š 52â”Š   â”Šconst ActualForm = styled.form `\n-â”Š 53â”Š   â”Š  padding: 20px;\n-â”Š 54â”Š   â”Š`;\n-â”Š 55â”Š   â”Š\n-â”Š 56â”Š   â”Šconst Section = styled.div `\n-â”Š 57â”Š   â”Š  width: 100%;\n-â”Š 58â”Š   â”Š  padding-bottom: 35px;\n-â”Š 59â”Š   â”Š`;\n-â”Š 60â”Š   â”Š\n-â”Š 61â”Š   â”Šconst Legend = styled.legend `\n-â”Š 62â”Š   â”Š  font-weight: bold;\n-â”Š 63â”Š   â”Š  color: white;\n-â”Š 64â”Š   â”Š`;\n-â”Š 65â”Š   â”Š\n-â”Š 66â”Š   â”Š// eslint-disable-next-line\n-â”Š 67â”Š   â”Šconst Label = styled.label `\n-â”Š 68â”Š   â”Š  color: white !important;\n-â”Š 69â”Š   â”Š`;\n-â”Š 70â”Š   â”Š\n-â”Š 71â”Š   â”Š// eslint-disable-next-line\n-â”Š 72â”Š   â”Šconst Input = styled.input `\n-â”Š 73â”Š   â”Š  color: white;\n-â”Š 74â”Š   â”Š\n-â”Š 75â”Š   â”Š  &::placeholder {\n-â”Š 76â”Š   â”Š    color: var(--primary-bg);\n-â”Š 77â”Š   â”Š  }\n-â”Š 78â”Š   â”Š`;\n-â”Š 79â”Š   â”Š\n-â”Š 80â”Š   â”Šconst TextField = styled(MaterialTextField) `\n-â”Š 81â”Š   â”Š  width: 100%;\n-â”Š 82â”Š   â”Š  position: relative;\n-â”Š 83â”Š   â”Š\n-â”Š 84â”Š   â”Š  > div::before {\n-â”Š 85â”Š   â”Š    border-color: white !important;\n-â”Š 86â”Š   â”Š  }\n-â”Š 87â”Š   â”Š\n-â”Š 88â”Š   â”Š  input {\n-â”Š 89â”Š   â”Š    color: white !important;\n-â”Š 90â”Š   â”Š\n-â”Š 91â”Š   â”Š    &::placeholder {\n-â”Š 92â”Š   â”Š      color: var(--primary-bg) !important;\n+â”Š   â”Š 48â”Šconst AuthScreen: React.FC<RouteComponentProps<any>> = ({ history, location }) => {\n+â”Š   â”Š 49â”Š  const alternative = useMemo(() => {\n+â”Š   â”Š 50â”Š    if (location.pathname === '/sign-in') {\n+â”Š   â”Š 51â”Š      const handleSignUp = () => {\n+â”Š   â”Š 52â”Š        history.replace('/sign-up');\n+â”Š   â”Š 53â”Š      };\n+â”Š   â”Š 54â”Š\n+â”Š   â”Š 55â”Š      return (\n+â”Š   â”Š 56â”Š        <Alternative>\n+â”Š   â”Š 57â”Š          Don't have an account yet? <label onClick={handleSignUp}>Sign up!</label>\n+â”Š   â”Š 58â”Š        </Alternative>\n+â”Š   â”Š 59â”Š      );\n â”Š 93â”Š 60â”Š    }\n-â”Š 94â”Š   â”Š  }\n-â”Š 95â”Š   â”Š\n-â”Š 96â”Š   â”Š  label {\n-â”Š 97â”Š   â”Š    color: white !important;\n-â”Š 98â”Š   â”Š  }\n-â”Š 99â”Š   â”Š` as typeof MaterialTextField;\n-â”Š100â”Š   â”Š\n-â”Š101â”Š   â”Šconst Button = styled(MaterialButton) `\n-â”Š102â”Š   â”Š  width: 100px;\n-â”Š103â”Š   â”Š  display: block !important;\n-â”Š104â”Š   â”Š  margin: auto !important;\n-â”Š105â”Š   â”Š  background-color: var(--secondary-bg) !important;\n-â”Š106â”Š   â”Š\n-â”Š107â”Š   â”Š  &[disabled] {\n-â”Š108â”Š   â”Š    color: #38a81c;\n-â”Š109â”Š   â”Š  }\n-â”Š110â”Š   â”Š\n-â”Š111â”Š   â”Š  &:not([disabled]) {\n-â”Š112â”Š   â”Š    color: white;\n-â”Š113â”Š   â”Š  }\n-â”Š114â”Š   â”Š` as typeof MaterialButton;\n-â”Š115â”Š   â”Š\n-â”Š116â”Š   â”Šconst AuthScreen: React.FC<RouteComponentProps<any>> = ({ history }) => {\n-â”Š117â”Š   â”Š  const [username, setUsername] = useState('');\n-â”Š118â”Š   â”Š  const [password, setPassword] = useState('');\n-â”Š119â”Š   â”Š  // eslint-disable-next-line\n-â”Š120â”Š   â”Š  const [error, setError] = useState('');\n-â”Š121â”Š   â”Š\n-â”Š122â”Š   â”Š  const onUsernameChange = useCallback(({ target }) => {\n-â”Š123â”Š   â”Š    setError('');\n-â”Š124â”Š   â”Š    setUsername(target.value);\n-â”Š125â”Š   â”Š  }, []);\n-â”Š126â”Š   â”Š\n-â”Š127â”Š   â”Š  const onPasswordChange = useCallback(({ target }) => {\n-â”Š128â”Š   â”Š    setError('');\n-â”Š129â”Š   â”Š    setPassword(target.value);\n-â”Š130â”Š   â”Š  }, []);\n-â”Š131â”Š   â”Š\n-â”Š132â”Š   â”Š  const maySignIn = useCallback(() => {\n-â”Š133â”Š   â”Š    return !!(username && password);\n-â”Š134â”Š   â”Š  }, [username, password]);\n-â”Š135â”Š   â”Š\n-â”Š136â”Š   â”Š  const handleSignIn = useCallback(() => {\n-â”Š137â”Š   â”Š    signIn({ username, password })\n-â”Š138â”Š   â”Š      .then(() => {\n-â”Š139â”Š   â”Š        history.push('/chats')\n-â”Š140â”Š   â”Š      })\n-â”Š141â”Š   â”Š      .catch(error => {\n-â”Š142â”Š   â”Š        setError(error.message || error)\n-â”Š143â”Š   â”Š      });\n-â”Š144â”Š   â”Š  }, [username, password, history]);\n+â”Š   â”Š 61â”Š    else {\n+â”Š   â”Š 62â”Š      const handleSignIn = () => {\n+â”Š   â”Š 63â”Š        history.replace('/sign-in');\n+â”Š   â”Š 64â”Š      };\n+â”Š   â”Š 65â”Š\n+â”Š   â”Š 66â”Š      return (\n+â”Š   â”Š 67â”Š        <Alternative>\n+â”Š   â”Š 68â”Š          Already have an accout? <label onClick={handleSignIn}>Sign in!</label>\n+â”Š   â”Š 69â”Š        </Alternative>\n+â”Š   â”Š 70â”Š      );\n+â”Š   â”Š 71â”Š    }\n+â”Š   â”Š 72â”Š  }, [location.pathname, history]);\n â”Š145â”Š 73â”Š\n â”Š146â”Š 74â”Š  return (\n-â”Š147â”Š   â”Š    <Container>\n-â”Š148â”Š   â”Š      <Intro>\n+â”Š   â”Š 75â”Š    <Container className=\"AuthScreen Screen\">\n+â”Š   â”Š 76â”Š      <Intro className=\"AuthScreen-intro\">\n â”Š149â”Š 77â”Š        <Icon src=\"assets/whatsapp-icon.png\" className=\"AuthScreen-icon\" />\n â”Š150â”Š 78â”Š        <Title className=\"AuthScreen-title\">WhatsApp</Title>\n â”Š151â”Š 79â”Š      </Intro>\n-â”Š152â”Š   â”Š      <SignInForm>\n-â”Š153â”Š   â”Š        <ActualForm>\n-â”Š154â”Š   â”Š          <Legend>Sign in</Legend>\n-â”Š155â”Š   â”Š          <Section>\n-â”Š156â”Š   â”Š            <TextField\n-â”Š157â”Š   â”Š              className=\"AuthScreen-text-field\"\n-â”Š158â”Š   â”Š              label=\"Username\"\n-â”Š159â”Š   â”Š              value={username}\n-â”Š160â”Š   â”Š              onChange={onUsernameChange}\n-â”Š161â”Š   â”Š              margin=\"normal\"\n-â”Š162â”Š   â”Š              placeholder=\"Enter your username\"\n-â”Š163â”Š   â”Š            />\n-â”Š164â”Š   â”Š            <TextField\n-â”Š165â”Š   â”Š              className=\"AuthScreen-text-field\"\n-â”Š166â”Š   â”Š              label=\"Password\"\n-â”Š167â”Š   â”Š              type=\"password\"\n-â”Š168â”Š   â”Š              value={password}\n-â”Š169â”Š   â”Š              onChange={onPasswordChange}\n-â”Š170â”Š   â”Š              margin=\"normal\"\n-â”Š171â”Š   â”Š              placeholder=\"Enter your password\"\n-â”Š172â”Š   â”Š            />\n-â”Š173â”Š   â”Š          </Section>\n-â”Š174â”Š   â”Š          <Button\n-â”Š175â”Š   â”Š            data-testid=\"sign-in-button\"\n-â”Š176â”Š   â”Š            type=\"button\"\n-â”Š177â”Š   â”Š            color=\"secondary\"\n-â”Š178â”Š   â”Š            variant=\"contained\"\n-â”Š179â”Š   â”Š            disabled={!maySignIn()}\n-â”Š180â”Š   â”Š            onClick={handleSignIn}\n-â”Š181â”Š   â”Š          >\n-â”Š182â”Š   â”Š            Sign in\n-â”Š183â”Š   â”Š          </Button>\n-â”Š184â”Š   â”Š        </ActualForm>\n-â”Š185â”Š   â”Š      </SignInForm>\n+â”Š   â”Š 80â”Š      <AnimatedSwitch>\n+â”Š   â”Š 81â”Š        <Route exact path=\"/sign-in\" component={SignInForm} />\n+â”Š   â”Š 82â”Š        <Route exact path=\"/sign-up\" component={SignUpForm} />\n+â”Š   â”Š 83â”Š      </AnimatedSwitch>\n+â”Š   â”Š 84â”Š      {alternative}\n â”Š186â”Š 85â”Š    </Container>\n â”Š187â”Š 86â”Š  );\n â”Š188â”Š 87â”Š};\n```\n\n[}]: #\n\n> Note how we used the `/sign-(in|up)` pattern to define the `signUp` mutation. This is because the request will be further redirected in the `AuthScreen`.\n\nThe authentication flow is complete! To test it out, you can create a new user, log in with it and start chatting with other users.\n\n------------\n\nTODO: maybe use HttpOnly in cookie\nsave userâ€™s id or data in localStorage so we can guess if a user is logged in or not and later on invalidate it\nwe send a password in its raw form over the wire\nError message: â€œreq.password and req.passwordConfirm don't matchâ€ looks odd, should be â€œPasswords donâ€™t matchâ€\nWhy is `const maySignUp = useCallback(() => {` a useCallback and not useMemo for example? We do use a value there."
          },
          {
            "manualTitle": "Step 14: Migrating to PostgreSQL",
            "stepRevision": "6cc312657b290bb6d7b8659a30736d8def717567",
            "manualView": "**Which Relational Database? And Why?**\n\nWeâ€™ve used to have an in-memory database so far that keeps our entities on memory inside business logic so far. But in a real application we will need a real database system that keeps our data which is seperated from our business logic. In this part we will design our database according to the relational database principles with the benefits of SQL.\n\nWe prefer to use PostgreSQL from now on; because PostgreSQL is a Relational Database implementation that has tables, constraints, triggers, roles, stored procedures and views together with foreign tables from external data sources and many features from NoSQL.\n\n**Database Design**\n\nWhile we are defining our entity types and schema inside our array-based in-memory database, we have already designed the basic parts of them. In this part, we will design our relational database with base and relation tables regarding to them.\n\nInitially we can decide the base fields without relations;\n* User;\n    * `id`\n    * `name`\n    * `username`\n    * `password`\n    * `picture`\n* Message;\n    * `id`\n    * `content`\n    * `created_at`\n* Chat;\n    * `id`\n\nBefore creating tables, we should design our database structure according to [Database Normalization principles](https://www.essentialsql.com/get-ready-to-learn-sql-database-normalization-explained-in-simple-english/) to prevent duplicated data and modification anomalies.\n\nInitially we will have 3 base tables in our database; `user`, `chat`, `message`; and there are some relations between those 3 tables. These relations will be defined in other relation tables together with different primary key and foreign key definitions.\n\nThere are four types of relations in relational databases;\n\n* One to one\n    * This relationship means A entity type can have a relationship with only one instance of B entity type while B entity type can have a relationship with only one instance of A entity type. For example, one user can have only one profile while a profile belongs to only one user.\n* Many to one\n    * This relationship means A entity type can have a relationship with multiple instances of B entity type while B entity type can have a relationship with only one instance of A entity type. For example, a chat can have multiple messages while a message belongs to only one chat. But `many to one` as a word means multiple photos belong to the same chat.\n* One to many\n    * This relationship has the same logic with Many to one. However, `One to many` as a word means a chat can have multiple messages while those messages cannot have multiple chats but only one.\n* Many to many\n    * This relationship means A entity type can have a relationship with multiple instances of B entity type while B entity type can have a relationship with multiple instances of A entity type dependently or independently. For example; a chat can have multiple users, and a user can have multiple chats.\n\nYou can read more about those relations in [here](https://www.techrepublic.com/article/relational-databases-defining-relationships-between-database-tables/).\n\nIn existing entity declarations and schema, we have 6 relationships;\n\n* Message has a One To Many relationship under the name of `chat` inside our schema; so one message can have one chat while one chat can have multiple messages.\n    gql```\n    type Message { chat: Chat }\n    ```\n* Message has another One To Many relationship under the name of `sender`` inside our schema; so one message can have one sender while one sender user can have multiple messages.\n    gql```\n    type Message { sender: User }\n    ```\n* Message has one more One To Many relationship under the name of `recipient`` inside our schema; so one message can have one recipient while one recipient user can have multiple messages.\n    gql```\n    type Message { recipient: User }\n    ```\n* Chat has a One To Many relationship under the name of `messages`, because one chat can have multiple messages while one message can have only one chat. Notice that this relationship is the reversed version of the first relationship in Message.\n    gql```\n    `type Chat { messages: [Message] }\n    ```\n* Chat has another Many To Many relationship under the name of `participants`, because one chat can have multiple participants while a participant can have multiple chats as well.\n    gql```\n    type Chat { participants: [User] }\n    ```\n* User has a Many To Many relationship under the name of `chats`, because one user can have multiple chats, while it has the same situation for chats.\n    gql```\n    type User { chats: [Chat] }\n    ```\n\nSo we should decide the dependencies between each other to add columns and tables to our database.\n\n* User is independent in all relationships, so we will keep its columns as it is\n* Message is dependent to User in two cases so we can define this relationship as two different new foreign keys pointing to Userâ€™s id under the columns `sender_user_id`. But we donâ€™t need `recipient_user_id` because `recipient` can be found under Chatâ€™s participants.\n* Chat is also independent because it will be better to keep those relations inside Message.\n* Message is dependent to Chat so we can define this relationship as a new foreign key that points to Chatâ€™s id under the column named `chat_id`.\n* We need to have another table that defines the relationship between multiple chats and users.\n\n> We donâ€™t need to duplicate relations in each entities, because SQL has the power to reverse each relations even if they are defined only in one entity. This is one of the rule of Database Normalization.\n\nFinally we can decide on our tables;\n\n* `chats` table;\n    * `id` ->\n        * `PRIMARY KEY` - `SERIAL`\n        * `SERIAL` will automatically increase the number of the new chat row. Check SQL docs about primary key and auto increment\n* `users` table;\n    * `id` ->\n        * `PRIMARY KEY` - `SERIAL`\n    * `name` ->\n        * `VARCHAR`\n    * `username` ->\n        * `VARCHAR` - `UNIQUE`\n        * `UNIQUE` means this value can exist in this table only once. We use this feature because `username` must be unique in users for each user\n    * `password` ->\n        * `VARCHAR`\n    * `picture` ->\n        * `VARCHAR`\n* `chats_users` table;\n    * `chat_id` ->\n        * `FOREIGN KEY` points to `chat.id` ->\n            * `ON DELETE` -> `CASCADE`.\n            * This means that if chat that has this id is deleted, this row will be deleted automatically as well.\n    * `user_id` ->\n        * FOREIGN KEY points to `user.id` ->\n            * `ON DELETE` -> `CASCADE`.\n* `messages` table;\n    * `id` ->\n        * `PRIMARY KEY` - `SERIAL`\n    * `content` ->\n        * `VARCHAR`\n    * `created_at` ->\n        * `TIMESTAMP` ->\n            * `DEFAULT_VALUE = now()`\n            * This means it will automatically set this to the current timestamp in the new row.\n    * `chat_id` ->\n        * `FOREIGN KEY` points to `chat.id` ->\n            * `ON DELETE` -> `CASCADE`\n            * This means that if chat that has this id is deleted, this row will be deleted automatically as well. So the message will be deleted immediately after the chat is deleted.\n    * `sender_user_id` ->\n        * `FOREIGN_KEY` points to `user.id`\n            * `ON DELETE` -> `CASCADE`\n            * This means that if user that has this id is deleted, this message will be deleted.\n\n> Notice that having a good dependency gives us an opportunity to benefit from `ON_DELETE` feature of SQL. Otherwise, we need to delete each dependent row manually by hand.\n\n**Installing PostgreSQL on your machine**\n\n***Windows / Mac OS X***\n\nYou can download one-click installer for Windows and Mac OS X. During the installation, you must define a password and keep it somewhere safe.\n\n[https://www.enterprisedb.com/downloads/postgres-postgresql-downloads](Download Installer)\n\n***Ubuntu / Debian***\n\nIf you have Debian package manager on your machine, you can install PostgreSQL in a single line in your Bash terminal;\n\n    $ sudo apt-get install postgresql postgresql-contrib\n\n***Other environments***\n\nCheck [https://www.postgresql.org/download/](PostgreSQL website) for installation instructions on other environments.\n\n**Creating Database, Database User and Tables**\n\n> Make sure you have installed PostgreSQL on your environment first!\n\nWe will use Bash terminal in order to access PostgreSQL using superuser;\n\n    $ su - postgres\n\nYou don't need to execute the previous command if you're using Windows. But you have to open the terminal with Administrator privileges.\n\n    $ psql template1\n\nThen we will see the following PostgreSQL console;\n\nbash```\nWelcome to psql 7.4.16, the PostgreSQL interactive terminal.\n\nType:  \\\\copyright for distribution terms\n       \\\\h for help with SQL commands\n       \\\\? for help on internal slash commands\n       \\\\g or terminate with semicolon to execute query\n       \\\\q to quit\n\ntemplate1\n```\n\nSo we can do the following SQL operations in order to create our new user, database and tables;\n\n* Create user for our database\n\n```sql\n    CREATE DATABASE whatsapp;\n```\n\n* Create database\n\n```sql\n    CREATE USER testuser WITH PASSWORD 'testpassword';\n```\n\n* Give permissions to that user\n\n```sql\n    GRANT ALL PRIVILEGES ON DATABASE whatsapp to testuser;\n```\n\n* Connect database\n\n```sql\n    \\connect whatsapp\n```\n\n* Create `chats` table\n\n```sql\n    CREATE TABLE chats(\n        id SERIAL PRIMARY KEY\n    );\n```\n\n* Create `users` table\n\n```sql\n    CREATE TABLE users(\n        id SERIAL PRIMARY KEY,\n        username VARCHAR (50) UNIQUE NOT NULL,\n        name VARCHAR (50) NOT NULL,\n        password VARCHAR (255) NOT NULL,\n        picture VARCHAR (255) NOT NULL\n    );\n```\n\n* Create `chats_users` table\n\n```sql\n    CREATE TABLE chats_users(\n        chat_id INTEGER NOT NULL REFERENCES chats(id) ON DELETE CASCADE,\n        user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE\n    );\n```\n\n* Create messages table;\n\n```sql\n    CREATE TABLE messages(\n        id SERIAL PRIMARY KEY,\n        content VARCHAR (355) NOT NULL,\n        created_at TIMESTAMP NOT NULL DEFAULT NOW(),\n        chat_id INTEGER NOT NULL REFERENCES chats(id) ON DELETE CASCADE,\n        sender_user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE\n    );\n```\n\n* Give access for those tables\n\n```sql\n    GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO testuser;\n    GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO testuser;\n```\n\n**Installing PostgreSQL on our backend project**\n\nAs we are using PostgreSQL, we will use `node-postgres` as our database client in the backend.\n\nFirst install necessary npm packages using yarn;\n\n\t$ yarn add pg\n\nAnd we will also need TypeScript definitions for better development experience;\n\n\t$ yarn add @types/pg --dev\n\nWe will use `sql` template literals (which is way easier and safer than native API) with [this package](https://github.com/felixfbecker/node-sql-template-strings) which allows you to have SQL highlighting in VSCode with (this extension)[https://marketplace.visualstudio.com/items?itemName=forbeslindesay.vscode-sql-template-literal].\n\n\t$ yarn add sql-template-strings\n\n**Connecting to our database**\n\nWe will use connection pooling to prevent connection leaks and benefit from transactions in our complicated SQL queries. [You can read more about the benefits of connection pooling.](https://node-postgres.com/features/pooling)\n\nFirst we need to create a connection pool using our connection credentials;\n\n[{]: <helper> (diffStep 11.2 files=\"db\" module=\"server\")\n\n#### [Server Step 11.2: Connecting to database](https://github.com/Urigo/WhatsApp-Clone-Server/commit/7dfb72f)\n\n##### Changed db.ts\n```diff\n@@ -1,3 +1,5 @@\n+â”Š â”Š1â”Šimport { Pool } from \"pg\";\n+â”Š â”Š2â”Š\n â”Š1â”Š3â”Šexport type User = {\n â”Š2â”Š4â”Š  id: string\n â”Š3â”Š5â”Š  name: string\n```\n```diff\n@@ -20,6 +22,14 @@\n â”Š20â”Š22â”Š  participants: string[]\n â”Š21â”Š23â”Š}\n â”Š22â”Š24â”Š\n+â”Š  â”Š25â”Šexport const pool = new Pool({\n+â”Š  â”Š26â”Š  host: 'localhost',\n+â”Š  â”Š27â”Š  port: 5432,\n+â”Š  â”Š28â”Š  user: 'testuser',\n+â”Š  â”Š29â”Š  password: 'testpassword',\n+â”Š  â”Š30â”Š  database: 'whatsapp'\n+â”Š  â”Š31â”Š})\n+â”Š  â”Š32â”Š\n â”Š23â”Š33â”Šexport const users: User[] = []\n â”Š24â”Š34â”Šexport const messages: Message[] = []\n â”Š25â”Š35â”Šexport const chats: Chat[] = []\n```\n\n[}]: #\n\n**Add Database Client to GraphQL Context**\n\nAfter that, we will request a client from this pool on each network request in our GraphQL context. So we need to update our context interface and context builder function.\n\n[{]: <helper> (diffStep 11.3 files=\"context, index\" module=\"server\")\n\n#### [Server Step 11.3: Add Database Client to GraphQL Context](https://github.com/Urigo/WhatsApp-Clone-Server/commit/3e77d78)\n\n##### Changed context.ts\n```diff\n@@ -1,9 +1,11 @@\n â”Š 1â”Š 1â”Šimport { PubSub } from 'apollo-server-express'\n â”Š 2â”Š 2â”Šimport { User } from './db'\n â”Š 3â”Š 3â”Šimport { Response } from 'express'\n+â”Š  â”Š 4â”Šimport { PoolClient } from 'pg';\n â”Š 4â”Š 5â”Š\n â”Š 5â”Š 6â”Šexport type MyContext = {\n â”Š 6â”Š 7â”Š  pubsub: PubSub,\n â”Š 7â”Š 8â”Š  currentUser: User,\n â”Š 8â”Š 9â”Š  res: Response,\n+â”Š  â”Š10â”Š  db: PoolClient,\n â”Š 9â”Š11â”Š}\n```\n\n##### Changed index.ts\n```diff\n@@ -2,26 +2,42 @@\n â”Š 2â”Š 2â”Šimport http from 'http'\n â”Š 3â”Š 3â”Šimport jwt from 'jsonwebtoken'\n â”Š 4â”Š 4â”Šimport { app } from './app'\n-â”Š 5â”Š  â”Šimport { users } from './db'\n+â”Š  â”Š 5â”Šimport { pool } from './db'\n â”Š 6â”Š 6â”Šimport { origin, port, secret } from './env'\n â”Š 7â”Š 7â”Šimport schema from './schema'\n+â”Š  â”Š 8â”Šimport { MyContext } from './context';\n+â”Š  â”Š 9â”Šimport sql from 'sql-template-strings'\n â”Š 8â”Š10â”Š\n â”Š 9â”Š11â”Šconst pubsub = new PubSub()\n â”Š10â”Š12â”Šconst server = new ApolloServer({\n â”Š11â”Š13â”Š  schema,\n-â”Š12â”Š  â”Š  context: ({ req, res }) => {\n-â”Š13â”Š  â”Š    let currentUser;\n+â”Š  â”Š14â”Š  context: async ({ req, res, connection }: any) => {\n+â”Š  â”Š15â”Š    let db;\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š    if(!connection) {\n+â”Š  â”Š18â”Š      db = await pool.connect();\n+â”Š  â”Š19â”Š    }\n+â”Š  â”Š20â”Š\n+â”Š  â”Š21â”Š    let currentUser\n â”Š14â”Š22â”Š    if (req.cookies.authToken) {\n â”Š15â”Š23â”Š      const username = jwt.verify(req.cookies.authToken, secret) as string\n-â”Š16â”Š  â”Š      currentUser = username && users.find(u => u.username === username)\n+â”Š  â”Š24â”Š      if (username) {\n+â”Š  â”Š25â”Š        const { rows } =  await pool.query(sql`SELECT * FROM users WHERE username = ${username}`)\n+â”Š  â”Š26â”Š        currentUser = rows[0]\n+â”Š  â”Š27â”Š      }\n â”Š17â”Š28â”Š    }\n-â”Š18â”Š  â”Š\n â”Š19â”Š29â”Š    return {\n â”Š20â”Š30â”Š      currentUser,\n â”Š21â”Š31â”Š      pubsub,\n â”Š22â”Š32â”Š      res,\n+â”Š  â”Š33â”Š      db,\n â”Š23â”Š34â”Š    }\n â”Š24â”Š35â”Š  },\n+â”Š  â”Š36â”Š  formatResponse: (res: any, { context }: { context: MyContext }) => {\n+â”Š  â”Š37â”Š    context.db.release()\n+â”Š  â”Š38â”Š\n+â”Š  â”Š39â”Š    return res\n+â”Š  â”Š40â”Š  }\n â”Š25â”Š41â”Š})\n â”Š26â”Š42â”Š\n â”Š27â”Š43â”Šserver.applyMiddleware({\n```\n\n[}]: #\n\n> However we need to release that client to the pool after the network connection ends to prevent connection leaks. So, letâ€™s use `formatResponse` to do this operation.\n> We don't need connection pooling for subscriptions, because it can cause the connection open in all websocket connection. That's why, we don't request a new client from the pool if it is a subscription.\n\n**Update entity typings**\n\nWe should update our entity typings according to our new database tables and columns.\n\n[{]: <helper> (diffStep 11.4 files=\"db\" module=\"server\")\n\n#### [Server Step 11.4: Update Entity Types](https://github.com/Urigo/WhatsApp-Clone-Server/commit/0b3d3e2)\n\n##### Changed db.ts\n```diff\n@@ -11,15 +11,13 @@\n â”Š11â”Š11â”Šexport type Message = {\n â”Š12â”Š12â”Š  id: string\n â”Š13â”Š13â”Š  content: string\n-â”Š14â”Š  â”Š  createdAt: Date\n-â”Š15â”Š  â”Š  sender: string\n-â”Š16â”Š  â”Š  recipient: string\n+â”Š  â”Š14â”Š  created_at: Date\n+â”Š  â”Š15â”Š  chat_id: string\n+â”Š  â”Š16â”Š  sender_user_id: string\n â”Š17â”Š17â”Š}\n â”Š18â”Š18â”Š\n â”Š19â”Š19â”Šexport type Chat = {\n â”Š20â”Š20â”Š  id: string\n-â”Š21â”Š  â”Š  messages: string[]\n-â”Š22â”Š  â”Š  participants: string[]\n â”Š23â”Š21â”Š}\n â”Š24â”Š22â”Š\n â”Š25â”Š23â”Šexport const pool = new Pool({\n```\n\n[}]: #\n\n**Add Sample Data**\n\nWe need to update the `resetDb` function to add a sample data to our new relational database instead of in-memory database. But we will call `resetDb` if it is asked by using the environmental variable.\n\n[{]: <helper> (diffStep 11.5 files=\"db\" module=\"server\")\n\n#### [Server Step 11.5: Add Sample Data](https://github.com/Urigo/WhatsApp-Clone-Server/commit/934d3c1)\n\n##### Changed db.ts\n```diff\n@@ -1,4 +1,6 @@\n â”Š1â”Š1â”Šimport { Pool } from \"pg\";\n+â”Š â”Š2â”Šimport sql from 'sql-template-strings'\n+â”Š â”Š3â”Šimport { resetDb as envResetDb } from './env'\n â”Š2â”Š4â”Š\n â”Š3â”Š5â”Šexport type User = {\n â”Š4â”Š6â”Š  id: string\n```\n```diff\n@@ -32,8 +34,11 @@\n â”Š32â”Š34â”Šexport const messages: Message[] = []\n â”Š33â”Š35â”Šexport const chats: Chat[] = []\n â”Š34â”Š36â”Š\n-â”Š35â”Š  â”Šexport const resetDb = () => {\n-â”Š36â”Š  â”Š  users.splice(0, Infinity, ...[\n+â”Š  â”Š37â”Šexport const resetDb = async () => {\n+â”Š  â”Š38â”Š\n+â”Š  â”Š39â”Š  await pool.query(sql`DELETE FROM users`)\n+â”Š  â”Š40â”Š\n+â”Š  â”Š41â”Š  const sampleUsers = [\n â”Š37â”Š42â”Š    {\n â”Š38â”Š43â”Š      id: '1',\n â”Š39â”Š44â”Š      name: 'Ray Edwards',\n```\n```diff\n@@ -69,61 +74,131 @@\n â”Š 69â”Š 74â”Š      password: '$2a$08$6.mbXqsDX82ZZ7q5d8Osb..JrGSsNp4R3IKj7mxgF6YGT0OmMw242', // 555\n â”Š 70â”Š 75â”Š      picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n â”Š 71â”Š 76â”Š    },\n-â”Š 72â”Š   â”Š  ])\n+â”Š   â”Š 77â”Š  ]\n+â”Š   â”Š 78â”Š\n+â”Š   â”Š 79â”Š  for (const sampleUser of sampleUsers) {\n+â”Š   â”Š 80â”Š    await pool.query(sql`\n+â”Š   â”Š 81â”Š      INSERT INTO users(id, name, username, password, picture)\n+â”Š   â”Š 82â”Š      VALUES(${sampleUser.id}, ${sampleUser.name}, ${sampleUser.username}, ${sampleUser.password}, ${sampleUser.picture})\n+â”Š   â”Š 83â”Š    `)\n+â”Š   â”Š 84â”Š  }\n+â”Š   â”Š 85â”Š\n+â”Š   â”Š 86â”Š  await pool.query(sql`SELECT setval('users_id_seq', (SELECT max(id) FROM users))`)\n+â”Š   â”Š 87â”Š\n+â”Š   â”Š 88â”Š  await pool.query(sql`DELETE FROM chats`)\n â”Š 73â”Š 89â”Š\n-â”Š 74â”Š   â”Š  messages.splice(0, Infinity, ...[\n+â”Š   â”Š 90â”Š  const sampleChats = [\n â”Š 75â”Š 91â”Š    {\n â”Š 76â”Š 92â”Š      id: '1',\n-â”Š 77â”Š   â”Š      content: \"You on your way?\",\n-â”Š 78â”Š   â”Š      createdAt: new Date(new Date('1-1-2019').getTime() - 60 * 1000 * 1000),\n-â”Š 79â”Š   â”Š      sender: '1',\n-â”Š 80â”Š   â”Š      recipient: '2',\n â”Š 81â”Š 93â”Š    },\n â”Š 82â”Š 94â”Š    {\n â”Š 83â”Š 95â”Š      id: '2',\n-â”Š 84â”Š   â”Š      content: \"Hey, it's me\",\n-â”Š 85â”Š   â”Š      createdAt: new Date(new Date('1-1-2019').getTime() - 2 * 60 * 1000 * 1000),\n-â”Š 86â”Š   â”Š      sender: '1',\n-â”Š 87â”Š   â”Š      recipient: '3',\n â”Š 88â”Š 96â”Š    },\n â”Š 89â”Š 97â”Š    {\n â”Š 90â”Š 98â”Š      id: '3',\n-â”Š 91â”Š   â”Š      content: \"I should buy a boat\",\n-â”Š 92â”Š   â”Š      createdAt: new Date(new Date('1-1-2019').getTime() - 24 * 60 * 1000 * 1000),\n-â”Š 93â”Š   â”Š      sender: '1',\n-â”Š 94â”Š   â”Š      recipient: '4',\n â”Š 95â”Š 99â”Š    },\n â”Š 96â”Š100â”Š    {\n â”Š 97â”Š101â”Š      id: '4',\n-â”Š 98â”Š   â”Š      content: \"This is wicked good ice cream.\",\n-â”Š 99â”Š   â”Š      createdAt: new Date(new Date('1-1-2019').getTime() - 14 * 24 * 60 * 1000 * 1000),\n-â”Š100â”Š   â”Š      sender: '1',\n-â”Š101â”Š   â”Š      recipient: '5',\n â”Š102â”Š102â”Š    },\n-â”Š103â”Š   â”Š  ])\n+â”Š   â”Š103â”Š  ]\n+â”Š   â”Š104â”Š\n+â”Š   â”Š105â”Š  for (const sampleChat of sampleChats) {\n+â”Š   â”Š106â”Š    await pool.query(sql`\n+â”Š   â”Š107â”Š      INSERT INTO chats(id)\n+â”Š   â”Š108â”Š      VALUES(${sampleChat.id})\n+â”Š   â”Š109â”Š    `)\n+â”Š   â”Š110â”Š  }\n+â”Š   â”Š111â”Š\n+â”Š   â”Š112â”Š  await pool.query(sql`SELECT setval('chats_id_seq', (SELECT max(id) FROM chats))`)\n+â”Š   â”Š113â”Š\n+â”Š   â”Š114â”Š  await pool.query(sql`DELETE FROM chats_users`)\n â”Š104â”Š115â”Š\n-â”Š105â”Š   â”Š  chats.splice(0, Infinity, ...[\n+â”Š   â”Š116â”Š  const sampleChatsUsers = [\n+â”Š   â”Š117â”Š    {\n+â”Š   â”Š118â”Š      chat_id: '1',\n+â”Š   â”Š119â”Š      user_id: '1',\n+â”Š   â”Š120â”Š    },\n+â”Š   â”Š121â”Š    {\n+â”Š   â”Š122â”Š      chat_id: '1',\n+â”Š   â”Š123â”Š      user_id: '2',\n+â”Š   â”Š124â”Š    },\n+â”Š   â”Š125â”Š    {\n+â”Š   â”Š126â”Š      chat_id: '2',\n+â”Š   â”Š127â”Š      user_id: '1',\n+â”Š   â”Š128â”Š    },\n+â”Š   â”Š129â”Š    {\n+â”Š   â”Š130â”Š      chat_id: '2',\n+â”Š   â”Š131â”Š      user_id: '3',\n+â”Š   â”Š132â”Š    },\n+â”Š   â”Š133â”Š    {\n+â”Š   â”Š134â”Š      chat_id: '3',\n+â”Š   â”Š135â”Š      user_id: '1',\n+â”Š   â”Š136â”Š    },\n+â”Š   â”Š137â”Š    {\n+â”Š   â”Š138â”Š      chat_id: '3',\n+â”Š   â”Š139â”Š      user_id: '4',\n+â”Š   â”Š140â”Š    },\n+â”Š   â”Š141â”Š    {\n+â”Š   â”Š142â”Š      chat_id: '4',\n+â”Š   â”Š143â”Š      user_id: '1',\n+â”Š   â”Š144â”Š    },\n+â”Š   â”Š145â”Š    {\n+â”Š   â”Š146â”Š      chat_id: '4',\n+â”Š   â”Š147â”Š      user_id: '5',\n+â”Š   â”Š148â”Š    },\n+â”Š   â”Š149â”Š  ]\n+â”Š   â”Š150â”Š\n+â”Š   â”Š151â”Š  for (const sampleChatUser of sampleChatsUsers) {\n+â”Š   â”Š152â”Š    await pool.query(sql`\n+â”Š   â”Š153â”Š      INSERT INTO chats_users(chat_id, user_id)\n+â”Š   â”Š154â”Š      VALUES(${sampleChatUser.chat_id}, ${sampleChatUser.user_id})\n+â”Š   â”Š155â”Š    `)\n+â”Š   â”Š156â”Š  }\n+â”Š   â”Š157â”Š\n+â”Š   â”Š158â”Š  await pool.query(sql`DELETE FROM messages`)\n+â”Š   â”Š159â”Š\n+â”Š   â”Š160â”Š  const sampleMessages = [\n â”Š106â”Š161â”Š    {\n â”Š107â”Š162â”Š      id: '1',\n-â”Š108â”Š   â”Š      participants: ['1', '2'],\n-â”Š109â”Š   â”Š      messages: ['1'],\n+â”Š   â”Š163â”Š      content: \"You on your way?\",\n+â”Š   â”Š164â”Š      created_at: new Date(new Date('1-1-2019').getTime() - 60 * 1000 * 1000),\n+â”Š   â”Š165â”Š      chat_id: '1',\n+â”Š   â”Š166â”Š      sender_user_id: '1',\n â”Š110â”Š167â”Š    },\n â”Š111â”Š168â”Š    {\n â”Š112â”Š169â”Š      id: '2',\n-â”Š113â”Š   â”Š      participants: ['1', '3'],\n-â”Š114â”Š   â”Š      messages: ['2'],\n+â”Š   â”Š170â”Š      content: \"Hey, it's me\",\n+â”Š   â”Š171â”Š      created_at: new Date(new Date('1-1-2019').getTime() - 2 * 60 * 1000 * 1000),\n+â”Š   â”Š172â”Š      chat_id: '2',\n+â”Š   â”Š173â”Š      sender_user_id: '1',\n â”Š115â”Š174â”Š    },\n â”Š116â”Š175â”Š    {\n â”Š117â”Š176â”Š      id: '3',\n-â”Š118â”Š   â”Š      participants: ['1', '4'],\n-â”Š119â”Š   â”Š      messages: ['3'],\n+â”Š   â”Š177â”Š      content: \"I should buy a boat\",\n+â”Š   â”Š178â”Š      created_at: new Date(new Date('1-1-2019').getTime() - 24 * 60 * 1000 * 1000),\n+â”Š   â”Š179â”Š      chat_id: '3',\n+â”Š   â”Š180â”Š      sender_user_id: '1',\n â”Š120â”Š181â”Š    },\n â”Š121â”Š182â”Š    {\n â”Š122â”Š183â”Š      id: '4',\n-â”Š123â”Š   â”Š      participants: ['1', '5'],\n-â”Š124â”Š   â”Š      messages: ['4'],\n+â”Š   â”Š184â”Š      content: \"This is wicked good ice cream.\",\n+â”Š   â”Š185â”Š      created_at: new Date(new Date('1-1-2019').getTime() - 14 * 24 * 60 * 1000 * 1000),\n+â”Š   â”Š186â”Š      chat_id: '4',\n+â”Š   â”Š187â”Š      sender_user_id: '1',\n â”Š125â”Š188â”Š    },\n-â”Š126â”Š   â”Š  ])\n+â”Š   â”Š189â”Š  ]\n+â”Š   â”Š190â”Š\n+â”Š   â”Š191â”Š  for (const sampleMessage of sampleMessages) {\n+â”Š   â”Š192â”Š    await pool.query(sql`\n+â”Š   â”Š193â”Š      INSERT INTO messages(id, content, created_at, chat_id, sender_user_id)\n+â”Š   â”Š194â”Š      VALUES(${sampleMessage.id}, ${sampleMessage.content}, ${sampleMessage.created_at}, ${sampleMessage.chat_id}, ${sampleMessage.sender_user_id})\n+â”Š   â”Š195â”Š    `)\n+â”Š   â”Š196â”Š  }\n+â”Š   â”Š197â”Š\n+â”Š   â”Š198â”Š  await pool.query(sql`SELECT setval('messages_id_seq', (SELECT max(id) FROM messages))`)\n+â”Š   â”Š199â”Š\n â”Š127â”Š200â”Š}\n â”Š128â”Š201â”Š\n-â”Š129â”Š   â”ŠresetDb()ðŸš«â†µ\n+â”Š   â”Š202â”Šif (envResetDb) {\n+â”Š   â”Š203â”Š  resetDb()\n+â”Š   â”Š204â”Š}\n```\n\n[}]: #\n\n> When you update tables with your own ID values, you have to update `SEQUENCE`; because PostgreSQL calculates the next ID value using `SEQUENCE`s.\n\n**Updating Resolvers**\n\nWe will benefit from transactions for complicated SQL queries in mutation. Transactions will help us to rollback our changes if there is an exception in the middle of our operations.\n\n[{]: <helper> (diffStep 11.6 files=\"resolvers\" module=\"server\")\n\n#### [Server Step 11.6: Updating Resolvers with SQL](https://github.com/Urigo/WhatsApp-Clone-Server/commit/472470b)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,70 +1,102 @@\n â”Š  1â”Š  1â”Šimport { withFilter } from 'apollo-server-express'\n â”Š  2â”Š  2â”Šimport { GraphQLDateTime } from 'graphql-iso-date'\n-â”Š  3â”Š   â”Šimport { User, Message, Chat, chats, messages, users } from '../db'\n+â”Š   â”Š  3â”Šimport { Message, Chat, pool } from '../db'\n â”Š  4â”Š  4â”Šimport { Resolvers } from '../types/graphql'\n â”Š  5â”Š  5â”Šimport { secret, expiration } from '../env'\n â”Š  6â”Š  6â”Šimport bcrypt from 'bcrypt'\n â”Š  7â”Š  7â”Šimport jwt from 'jsonwebtoken'\n â”Š  8â”Š  8â”Šimport { validateLength, validatePassword } from '../validators';\n+â”Š   â”Š  9â”Šimport sql from 'sql-template-strings'\n â”Š  9â”Š 10â”Š\n â”Š 10â”Š 11â”Šconst resolvers: Resolvers = {\n â”Š 11â”Š 12â”Š  Date: GraphQLDateTime,\n â”Š 12â”Š 13â”Š\n â”Š 13â”Š 14â”Š  Message: {\n-â”Š 14â”Š   â”Š    chat(message) {\n-â”Š 15â”Š   â”Š      return chats.find(c => c.messages.some(m => m === message.id)) || null\n+â”Š   â”Š 15â”Š    createdAt(message) {\n+â”Š   â”Š 16â”Š      return new Date(message.created_at)\n â”Š 16â”Š 17â”Š    },\n â”Š 17â”Š 18â”Š\n-â”Š 18â”Š   â”Š    sender(message) {\n-â”Š 19â”Š   â”Š      return users.find(u => u.id === message.sender) || null\n+â”Š   â”Š 19â”Š    async chat(message, args, { db }) {\n+â”Š   â”Š 20â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š 21â”Š        SELECT * FROM chats WHERE id = ${message.chat_id}\n+â”Š   â”Š 22â”Š      `)\n+â”Š   â”Š 23â”Š      return rows[0] || null\n â”Š 20â”Š 24â”Š    },\n â”Š 21â”Š 25â”Š\n-â”Š 22â”Š   â”Š    recipient(message) {\n-â”Š 23â”Š   â”Š      return users.find(u => u.id === message.recipient) || null\n+â”Š   â”Š 26â”Š    async sender(message, args, { db }) {\n+â”Š   â”Š 27â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š 28â”Š        SELECT * FROM users WHERE id = ${message.sender_user_id}\n+â”Š   â”Š 29â”Š      `)\n+â”Š   â”Š 30â”Š      return rows[0] || null\n+â”Š   â”Š 31â”Š    },\n+â”Š   â”Š 32â”Š\n+â”Š   â”Š 33â”Š    async recipient(message, args, { db }) {\n+â”Š   â”Š 34â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š 35â”Š        SELECT users.* FROM users, chats_users\n+â”Š   â”Š 36â”Š        WHERE chats_users.user_id != ${message.sender_user_id}\n+â”Š   â”Š 37â”Š        AND chats_users.chat_id = ${message.chat_id}\n+â”Š   â”Š 38â”Š      `)\n+â”Š   â”Š 39â”Š      return rows[0] || null\n â”Š 24â”Š 40â”Š    },\n â”Š 25â”Š 41â”Š\n â”Š 26â”Š 42â”Š    isMine(message, args, { currentUser }) {\n-â”Š 27â”Š   â”Š      return message.sender === currentUser.id\n+â”Š   â”Š 43â”Š      return message.sender_user_id === currentUser.id\n â”Š 28â”Š 44â”Š    },\n â”Š 29â”Š 45â”Š  },\n â”Š 30â”Š 46â”Š\n â”Š 31â”Š 47â”Š  Chat: {\n-â”Š 32â”Š   â”Š    name(chat, args, { currentUser }) {\n+â”Š   â”Š 48â”Š    async name(chat, args, { currentUser, db }) {\n â”Š 33â”Š 49â”Š      if (!currentUser) return null\n â”Š 34â”Š 50â”Š\n-â”Š 35â”Š   â”Š      const participantId = chat.participants.find(p => p !== currentUser.id)\n-â”Š 36â”Š   â”Š\n-â”Š 37â”Š   â”Š      if (!participantId) return null\n+â”Š   â”Š 51â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š 52â”Š        SELECT users.* FROM users, chats_users\n+â”Š   â”Š 53â”Š        WHERE users.id != ${currentUser.id}\n+â”Š   â”Š 54â”Š        AND users.id = chats_users.user_id\n+â”Š   â”Š 55â”Š        AND chats_users.chat_id = ${chat.id}`)\n â”Š 38â”Š 56â”Š\n-â”Š 39â”Š   â”Š      const participant = users.find(u => u.id === participantId)\n+â”Š   â”Š 57â”Š      const participant = rows[0]\n â”Š 40â”Š 58â”Š\n â”Š 41â”Š 59â”Š      return participant ? participant.name : null\n â”Š 42â”Š 60â”Š    },\n â”Š 43â”Š 61â”Š\n-â”Š 44â”Š   â”Š    picture(chat, args, { currentUser }) {\n+â”Š   â”Š 62â”Š    async picture(chat, args, { currentUser, db }) {\n â”Š 45â”Š 63â”Š      if (!currentUser) return null\n â”Š 46â”Š 64â”Š\n-â”Š 47â”Š   â”Š      const participantId = chat.participants.find(p => p !== currentUser.id)\n+â”Š   â”Š 65â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š 66â”Š        SELECT users.* FROM users, chats_users\n+â”Š   â”Š 67â”Š        WHERE users.id != ${currentUser.id}\n+â”Š   â”Š 68â”Š        AND users.id = chats_users.user_id\n+â”Š   â”Š 69â”Š        AND chats_users.chat_id = ${chat.id}`)\n â”Š 48â”Š 70â”Š\n-â”Š 49â”Š   â”Š      if (!participantId) return null\n-â”Š 50â”Š   â”Š\n-â”Š 51â”Š   â”Š      const participant = users.find(u => u.id === participantId)\n+â”Š   â”Š 71â”Š      const participant = rows[0]\n â”Š 52â”Š 72â”Š\n â”Š 53â”Š 73â”Š      return participant ? participant.picture : null\n â”Š 54â”Š 74â”Š    },\n â”Š 55â”Š 75â”Š\n-â”Š 56â”Š   â”Š    messages(chat) {\n-â”Š 57â”Š   â”Š      return messages.filter(m => chat.messages.includes(m.id))\n+â”Š   â”Š 76â”Š    async messages(chat, args, { db }) {\n+â”Š   â”Š 77â”Š      const { rows } = await db.query(sql`SELECT * FROM messages WHERE chat_id = ${chat.id}`)\n+â”Š   â”Š 78â”Š\n+â”Š   â”Š 79â”Š      return rows\n â”Š 58â”Š 80â”Š    },\n â”Š 59â”Š 81â”Š\n-â”Š 60â”Š   â”Š    lastMessage(chat) {\n-â”Š 61â”Š   â”Š      const lastMessage = chat.messages[chat.messages.length - 1]\n+â”Š   â”Š 82â”Š    async lastMessage(chat, args, { db }) {\n+â”Š   â”Š 83â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š 84â”Š        SELECT * FROM messages\n+â”Š   â”Š 85â”Š        WHERE chat_id = ${chat.id}\n+â”Š   â”Š 86â”Š        ORDER BY created_at DESC\n+â”Š   â”Š 87â”Š        LIMIT 1`)\n â”Š 62â”Š 88â”Š\n-â”Š 63â”Š   â”Š      return messages.find(m => m.id === lastMessage) || null\n+â”Š   â”Š 89â”Š      return rows[0]\n â”Š 64â”Š 90â”Š    },\n â”Š 65â”Š 91â”Š\n-â”Š 66â”Š   â”Š    participants(chat) {\n-â”Š 67â”Š   â”Š      return chat.participants.map(p => users.find(u => u.id === p)).filter(Boolean) as User[]\n+â”Š   â”Š 92â”Š    async participants(chat, args, { db }) {\n+â”Š   â”Š 93â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š 94â”Š        SELECT users.* FROM users, chats_users\n+â”Š   â”Š 95â”Š        WHERE chats_users.chat_id = ${chat.id}\n+â”Š   â”Š 96â”Š        AND chats_users.user_id = users.id\n+â”Š   â”Š 97â”Š      `)\n+â”Š   â”Š 98â”Š\n+â”Š   â”Š 99â”Š      return rows\n â”Š 68â”Š100â”Š    },\n â”Š 69â”Š101â”Š  },\n â”Š 70â”Š102â”Š\n```\n```diff\n@@ -73,36 +105,50 @@\n â”Š 73â”Š105â”Š      return currentUser || null\n â”Š 74â”Š106â”Š    },\n â”Š 75â”Š107â”Š\n-â”Š 76â”Š   â”Š    chats(root, args, { currentUser }) {\n+â”Š   â”Š108â”Š    async chats(root, args, { currentUser, db }) {\n â”Š 77â”Š109â”Š      if (!currentUser) return []\n â”Š 78â”Š110â”Š\n-â”Š 79â”Š   â”Š      return chats.filter(c => c.participants.includes(currentUser.id))\n+â”Š   â”Š111â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š112â”Š        SELECT chats.* FROM chats, chats_users\n+â”Š   â”Š113â”Š        WHERE chats.id = chats_users.chat_id\n+â”Š   â”Š114â”Š        AND chats_users.user_id = ${currentUser.id}\n+â”Š   â”Š115â”Š      `)\n+â”Š   â”Š116â”Š\n+â”Š   â”Š117â”Š      return rows\n â”Š 80â”Š118â”Š    },\n â”Š 81â”Š119â”Š\n-â”Š 82â”Š   â”Š    chat(root, { chatId }, { currentUser }) {\n+â”Š   â”Š120â”Š    async chat(root, { chatId }, { currentUser, db }) {\n â”Š 83â”Š121â”Š      if (!currentUser) return null\n â”Š 84â”Š122â”Š\n-â”Š 85â”Š   â”Š      const chat = chats.find(c => c.id === chatId)\n-â”Š 86â”Š   â”Š\n-â”Š 87â”Š   â”Š      if (!chat) return null\n-â”Š 88â”Š   â”Š\n-â”Š 89â”Š   â”Š      return chat.participants.includes(currentUser.id) ? chat : null\n+â”Š   â”Š123â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š124â”Š        SELECT chats.* FROM chats, chats_users\n+â”Š   â”Š125â”Š        WHERE chats_users.chat_id = ${chatId}\n+â”Š   â”Š126â”Š        AND chats.id = chats_users.chat_id\n+â”Š   â”Š127â”Š        AND chats_users.user_id = ${currentUser.id}\n+â”Š   â”Š128â”Š      `)\n+â”Š   â”Š129â”Š\n+â”Š   â”Š130â”Š      return rows[0] ? rows[0] : null\n â”Š 90â”Š131â”Š    },\n â”Š 91â”Š132â”Š\n-â”Š 92â”Š   â”Š    users(root, args, { currentUser }) {\n+â”Š   â”Š133â”Š    async users(root, args, { currentUser, db }) {\n â”Š 93â”Š134â”Š      if (!currentUser) return []\n â”Š 94â”Š135â”Š\n-â”Š 95â”Š   â”Š      return users.filter(u => u.id !== currentUser.id)\n+â”Š   â”Š136â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š137â”Š        SELECT * FROM users WHERE users.id != ${currentUser.id}\n+â”Š   â”Š138â”Š      `)\n+â”Š   â”Š139â”Š\n+â”Š   â”Š140â”Š      return rows\n â”Š 96â”Š141â”Š    },\n â”Š 97â”Š142â”Š  },\n â”Š 98â”Š143â”Š\n â”Š 99â”Š144â”Š  Mutation: {\n-â”Š100â”Š   â”Š    signIn(root, { username, password }, { res }) {\n â”Š101â”Š145â”Š\n-â”Š102â”Š   â”Š      const user = users.find(u => u.username === username)\n+â”Š   â”Š146â”Š    async signIn(root, { username, password }, { db, res }) {\n+â”Š   â”Š147â”Š      const { rows } = await db.query(sql`SELECT * FROM users WHERE username = ${username}`)\n+â”Š   â”Š148â”Š      const user = rows[0]\n â”Š103â”Š149â”Š\n â”Š104â”Š150â”Š      if (!user) {\n-â”Š105â”Š   â”Š        throw new Error('user not found')\n+â”Š   â”Š151â”Š        throw new Error('user not found');\n â”Š106â”Š152â”Š      }\n â”Š107â”Š153â”Š\n â”Š108â”Š154â”Š      const passwordsMatch = bcrypt.compareSync(password, user.password)\n```\n```diff\n@@ -112,130 +158,143 @@\n â”Š112â”Š158â”Š      }\n â”Š113â”Š159â”Š\n â”Š114â”Š160â”Š      const authToken = jwt.sign(username, secret)\n-â”Š115â”Š   â”Š\n+â”Š   â”Š161â”Š\n â”Š116â”Š162â”Š      res.cookie('authToken', authToken, { maxAge: expiration })\n â”Š117â”Š163â”Š\n â”Š118â”Š164â”Š      return user;\n â”Š119â”Š165â”Š    },\n-â”Š120â”Š   â”Š\n-â”Š121â”Š   â”Š    signUp(root, { name, username, password, passwordConfirm }) {\n-â”Š122â”Š   â”Š\n+â”Š   â”Š166â”Š\n+â”Š   â”Š167â”Š    async signUp(root, { name, username, password, passwordConfirm }, { db }) {\n â”Š123â”Š168â”Š      validateLength('req.name', name, 3, 50)\n â”Š124â”Š169â”Š      validateLength('req.username', name, 3, 18)\n â”Š125â”Š170â”Š      validatePassword('req.password', password)\n-â”Š126â”Š   â”Š\n+â”Š   â”Š171â”Š\n â”Š127â”Š172â”Š      if (password !== passwordConfirm) {\n â”Š128â”Š173â”Š        throw Error(\"req.password and req.passwordConfirm don't match\")\n â”Š129â”Š174â”Š      }\n-â”Š130â”Š   â”Š\n-â”Š131â”Š   â”Š      if (users.some(u => u.username === username)) {\n+â”Š   â”Š175â”Š\n+â”Š   â”Š176â”Š      const existingUserQuery = await db.query(sql`SELECT * FROM users WHERE username = ${username}`)\n+â”Š   â”Š177â”Š      if (existingUserQuery.rows[0]) {\n â”Š132â”Š178â”Š        throw Error(\"username already exists\")\n â”Š133â”Š179â”Š      }\n-â”Š134â”Š   â”Š\n+â”Š   â”Š180â”Š\n â”Š135â”Š181â”Š      const passwordHash = bcrypt.hashSync(password, bcrypt.genSaltSync(8))\n+â”Š   â”Š182â”Š\n+â”Š   â”Š183â”Š      const createdUserQuery = await db.query(sql`\n+â”Š   â”Š184â”Š        INSERT INTO users(password, picture, username, name)\n+â”Š   â”Š185â”Š        VALUES(${passwordHash}, '', ${username}, ${name})\n+â”Š   â”Š186â”Š        RETURNING *\n+â”Š   â”Š187â”Š      `)\n+â”Š   â”Š188â”Š\n+â”Š   â”Š189â”Š      const user = createdUserQuery.rows[0]\n+â”Š   â”Š190â”Š\n+â”Š   â”Š191â”Š      return user;\n â”Š136â”Š192â”Š\n-â”Š137â”Š   â”Š      const user: User = {\n-â”Š138â”Š   â”Š        id: String(users.length + 1),\n-â”Š139â”Š   â”Š        password: passwordHash,\n-â”Š140â”Š   â”Š        picture: '',\n-â”Š141â”Š   â”Š        username,\n-â”Š142â”Š   â”Š        name,\n-â”Š143â”Š   â”Š      }\n-â”Š144â”Š   â”Š\n-â”Š145â”Š   â”Š      users.push(user)\n-â”Š146â”Š   â”Š\n-â”Š147â”Š   â”Š      return user\n â”Š148â”Š193â”Š    },\n â”Š149â”Š194â”Š\n-â”Š150â”Š   â”Š    addMessage(root, { chatId, content }, { currentUser, pubsub }) {\n+â”Š   â”Š195â”Š    async addMessage(root, { chatId, content }, { currentUser, pubsub, db }) {\n â”Š151â”Š196â”Š      if (!currentUser) return null\n â”Š152â”Š197â”Š\n-â”Š153â”Š   â”Š      const chatIndex = chats.findIndex(c => c.id === chatId)\n-â”Š154â”Š   â”Š\n-â”Š155â”Š   â”Š      if (chatIndex === -1) return null\n-â”Š156â”Š   â”Š\n-â”Š157â”Š   â”Š      const chat = chats[chatIndex]\n-â”Š158â”Š   â”Š\n-â”Š159â”Š   â”Š      if (!chat.participants.includes(currentUser.id)) return null\n-â”Š160â”Š   â”Š\n-â”Š161â”Š   â”Š      const recentMessage = messages[messages.length - 1]\n-â”Š162â”Š   â”Š      const messageId = String(Number(recentMessage.id) + 1)\n-â”Š163â”Š   â”Š      const message: Message = {\n-â”Š164â”Š   â”Š        id: messageId,\n-â”Š165â”Š   â”Š        createdAt: new Date(),\n-â”Š166â”Š   â”Š        sender: currentUser.id,\n-â”Š167â”Š   â”Š        recipient: chat.participants.find(p => p !== currentUser.id) as string,\n-â”Š168â”Š   â”Š        content,\n-â”Š169â”Š   â”Š      }\n+â”Š   â”Š198â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š199â”Š        INSERT INTO messages(chat_id, sender_user_id, content)\n+â”Š   â”Š200â”Š        VALUES(${chatId}, ${currentUser.id}, ${content})\n+â”Š   â”Š201â”Š        RETURNING *\n+â”Š   â”Š202â”Š      `)\n â”Š170â”Š203â”Š\n-â”Š171â”Š   â”Š      messages.push(message)\n-â”Š172â”Š   â”Š      chat.messages.push(messageId)\n-â”Š173â”Š   â”Š      // The chat will appear at the top of the ChatsList component\n-â”Š174â”Š   â”Š      chats.splice(chatIndex, 1)\n-â”Š175â”Š   â”Š      chats.unshift(chat)\n+â”Š   â”Š204â”Š      const messageAdded = rows[0]\n â”Š176â”Š205â”Š\n â”Š177â”Š206â”Š      pubsub.publish('messageAdded', {\n-â”Š178â”Š   â”Š        messageAdded: message,\n+â”Š   â”Š207â”Š        messageAdded,\n â”Š179â”Š208â”Š      })\n â”Š180â”Š209â”Š\n-â”Š181â”Š   â”Š      return message\n+â”Š   â”Š210â”Š      return messageAdded\n â”Š182â”Š211â”Š    },\n â”Š183â”Š212â”Š\n-â”Š184â”Š   â”Š    addChat(root, { recipientId }, { currentUser, pubsub }) {\n+â”Š   â”Š213â”Š    async addChat(root, { recipientId }, { currentUser, pubsub, db }) {\n â”Š185â”Š214â”Š      if (!currentUser) return null\n-â”Š186â”Š   â”Š      if (!users.some(u => u.id === recipientId)) return null\n â”Š187â”Š215â”Š\n-â”Š188â”Š   â”Š      let chat = chats.find(c =>\n-â”Š189â”Š   â”Š        c.participants.includes(currentUser.id) &&\n-â”Š190â”Š   â”Š        c.participants.includes(recipientId)\n-â”Š191â”Š   â”Š      )\n+â”Š   â”Š216â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š217â”Š        SELECT chats.* FROM chats, (SELECT * FROM chats_users WHERE user_id = ${currentUser.id}) AS chats_of_current_user, chats_users\n+â”Š   â”Š218â”Š        WHERE chats_users.chat_id = chats_of_current_user.chat_id\n+â”Š   â”Š219â”Š        AND chats.id = chats_users.chat_id\n+â”Š   â”Š220â”Š        AND chats_users.user_id = ${recipientId}\n+â”Š   â”Š221â”Š      `)\n â”Š192â”Š222â”Š\n-â”Š193â”Š   â”Š      if (chat) return chat\n+â”Š   â”Š223â”Š      // If there is already a chat between these two users, return it\n+â”Š   â”Š224â”Š      if (rows[0]) {\n+â”Š   â”Š225â”Š        return rows[0]\n+â”Š   â”Š226â”Š      }\n â”Š194â”Š227â”Š\n-â”Š195â”Š   â”Š      const chatsIds = chats.map(c => Number(c.id))\n+â”Š   â”Š228â”Š      try {\n+â”Š   â”Š229â”Š        await db.query('BEGIN')\n â”Š196â”Š230â”Š\n-â”Š197â”Š   â”Š      chat = {\n-â”Š198â”Š   â”Š        id: String(Math.max(...chatsIds) + 1),\n-â”Š199â”Š   â”Š        participants: [currentUser.id, recipientId],\n-â”Š200â”Š   â”Š        messages: [],\n-â”Š201â”Š   â”Š      }\n+â”Š   â”Š231â”Š        const { rows } = await db.query(sql`\n+â”Š   â”Š232â”Š          INSERT INTO chats\n+â”Š   â”Š233â”Š          DEFAULT VALUES\n+â”Š   â”Š234â”Š          RETURNING *\n+â”Š   â”Š235â”Š        `)\n â”Š202â”Š236â”Š\n-â”Š203â”Š   â”Š      chats.push(chat)\n+â”Š   â”Š237â”Š        const chatAdded = rows[0]\n â”Š204â”Š238â”Š\n-â”Š205â”Š   â”Š      pubsub.publish('chatAdded', {\n-â”Š206â”Š   â”Š        chatAdded: chat\n-â”Š207â”Š   â”Š      })\n+â”Š   â”Š239â”Š        await db.query(sql`\n+â”Š   â”Š240â”Š          INSERT INTO chats_users(chat_id, user_id)\n+â”Š   â”Š241â”Š          VALUES(${chatAdded.id}, ${currentUser.id})\n+â”Š   â”Š242â”Š        `)\n â”Š208â”Š243â”Š\n-â”Š209â”Š   â”Š      return chat\n-â”Š210â”Š   â”Š    },\n+â”Š   â”Š244â”Š        await db.query(sql`\n+â”Š   â”Š245â”Š          INSERT INTO chats_users(chat_id, user_id)\n+â”Š   â”Š246â”Š          VALUES(${chatAdded.id}, ${recipientId})\n+â”Š   â”Š247â”Š        `)\n â”Š211â”Š248â”Š\n-â”Š212â”Š   â”Š    removeChat(root, { chatId }, { currentUser, pubsub }) {\n-â”Š213â”Š   â”Š      if (!currentUser) return null\n+â”Š   â”Š249â”Š        await db.query('COMMIT')\n â”Š214â”Š250â”Š\n-â”Š215â”Š   â”Š      const chatIndex = chats.findIndex(c => c.id === chatId)\n+â”Š   â”Š251â”Š        pubsub.publish('chatAdded', {\n+â”Š   â”Š252â”Š          chatAdded\n+â”Š   â”Š253â”Š        })\n â”Š216â”Š254â”Š\n-â”Š217â”Š   â”Š      if (chatIndex === -1) return null\n+â”Š   â”Š255â”Š        return chatAdded\n+â”Š   â”Š256â”Š      } catch(e) {\n+â”Š   â”Š257â”Š        await db.query('ROLLBACK')\n+â”Š   â”Š258â”Š        throw e\n+â”Š   â”Š259â”Š      }\n+â”Š   â”Š260â”Š    },\n+â”Š   â”Š261â”Š\n+â”Š   â”Š262â”Š    async removeChat(root, { chatId }, { currentUser, pubsub, db }) {\n+â”Š   â”Š263â”Š      if (!currentUser) return null\n â”Š218â”Š264â”Š\n-â”Š219â”Š   â”Š      const chat = chats[chatIndex]\n+â”Š   â”Š265â”Š      try {\n+â”Š   â”Š266â”Š        await db.query('BEGIN')\n â”Š220â”Š267â”Š\n-â”Š221â”Š   â”Š      if (!chat.participants.some(p => p === currentUser.id)) return null\n+â”Š   â”Š268â”Š        const { rows } = await db.query(sql`\n+â”Š   â”Š269â”Š          SELECT chats.* FROM chats, chats_users\n+â”Š   â”Š270â”Š          WHERE id = ${chatId}\n+â”Š   â”Š271â”Š          AND chats.id = chats_users.chat_id\n+â”Š   â”Š272â”Š          AND chats_users.user_id = ${currentUser.id}\n+â”Š   â”Š273â”Š        `)\n â”Š222â”Š274â”Š\n-â”Š223â”Š   â”Š      chat.messages.forEach((chatMessage) => {\n-â”Š224â”Š   â”Š        const chatMessageIndex = messages.findIndex(m => m.id === chatMessage)\n+â”Š   â”Š275â”Š        const chat = rows[0]\n â”Š225â”Š276â”Š\n-â”Š226â”Š   â”Š        if (chatMessageIndex !== -1) {\n-â”Š227â”Š   â”Š          messages.splice(chatMessageIndex, 1)\n+â”Š   â”Š277â”Š        if (!chat) {\n+â”Š   â”Š278â”Š          await db.query('ROLLBACK')\n+â”Š   â”Š279â”Š          return null\n â”Š228â”Š280â”Š        }\n-â”Š229â”Š   â”Š      })\n â”Š230â”Š281â”Š\n-â”Š231â”Š   â”Š      chats.splice(chatIndex, 1)\n+â”Š   â”Š282â”Š        await db.query(sql`\n+â”Š   â”Š283â”Š          DELETE FROM chats WHERE chats.id = ${chatId}\n+â”Š   â”Š284â”Š        `)\n â”Š232â”Š285â”Š\n-â”Š233â”Š   â”Š      pubsub.publish('chatRemoved', {\n-â”Š234â”Š   â”Š        chatRemoved: chat.id,\n-â”Š235â”Š   â”Š        targetChat: chat,\n-â”Š236â”Š   â”Š      })\n+â”Š   â”Š286â”Š        pubsub.publish('chatRemoved', {\n+â”Š   â”Š287â”Š          chatRemoved: chat.id,\n+â”Š   â”Š288â”Š          targetChat: chat,\n+â”Š   â”Š289â”Š        })\n â”Š237â”Š290â”Š\n-â”Š238â”Š   â”Š      return chatId\n+â”Š   â”Š291â”Š        await db.query('COMMIT')\n+â”Š   â”Š292â”Š\n+â”Š   â”Š293â”Š        return chatId\n+â”Š   â”Š294â”Š      } catch(e) {\n+â”Š   â”Š295â”Š        await db.query('ROLLBACK')\n+â”Š   â”Š296â”Š        throw e\n+â”Š   â”Š297â”Š      }\n â”Š239â”Š298â”Š    }\n â”Š240â”Š299â”Š  },\n â”Š241â”Š300â”Š\n```\n```diff\n@@ -243,13 +302,15 @@\n â”Š243â”Š302â”Š    messageAdded: {\n â”Š244â”Š303â”Š      subscribe: withFilter(\n â”Š245â”Š304â”Š        (root, args, { pubsub }) => pubsub.asyncIterator('messageAdded'),\n-â”Š246â”Š   â”Š        ({ messageAdded }, args, { currentUser }) => {\n+â”Š   â”Š305â”Š        async ({ messageAdded }: { messageAdded: Message }, args, { currentUser }) => {\n â”Š247â”Š306â”Š          if (!currentUser) return false\n â”Š248â”Š307â”Š\n-â”Š249â”Š   â”Š          return [\n-â”Š250â”Š   â”Š            messageAdded.sender,\n-â”Š251â”Š   â”Š            messageAdded.recipient,\n-â”Š252â”Š   â”Š          ].includes(currentUser.id)\n+â”Š   â”Š308â”Š          const { rows } = await pool.query(sql`\n+â”Š   â”Š309â”Š            SELECT * FROM chats_users\n+â”Š   â”Š310â”Š            WHERE chat_id = ${messageAdded.chat_id}\n+â”Š   â”Š311â”Š            AND user_id = ${currentUser.id}`)\n+â”Š   â”Š312â”Š\n+â”Š   â”Š313â”Š          return !!rows.length\n â”Š253â”Š314â”Š        },\n â”Š254â”Š315â”Š      )\n â”Š255â”Š316â”Š    },\n```\n```diff\n@@ -257,10 +318,15 @@\n â”Š257â”Š318â”Š    chatAdded: {\n â”Š258â”Š319â”Š      subscribe: withFilter(\n â”Š259â”Š320â”Š        (root, args, { pubsub }) => pubsub.asyncIterator('chatAdded'),\n-â”Š260â”Š   â”Š        ({ chatAdded }: { chatAdded: Chat }, args, { currentUser }) => {\n+â”Š   â”Š321â”Š        async ({ chatAdded }: { chatAdded: Chat }, args, { currentUser }) => {\n â”Š261â”Š322â”Š          if (!currentUser) return false\n â”Š262â”Š323â”Š\n-â”Š263â”Š   â”Š          return chatAdded.participants.some(p => p === currentUser.id)\n+â”Š   â”Š324â”Š          const { rows } = await pool.query(sql`\n+â”Š   â”Š325â”Š            SELECT * FROM chats_users\n+â”Š   â”Š326â”Š            WHERE chat_id = ${chatAdded.id}\n+â”Š   â”Š327â”Š            AND user_id = ${currentUser.id}`)\n+â”Š   â”Š328â”Š\n+â”Š   â”Š329â”Š          return !!rows.length\n â”Š264â”Š330â”Š        },\n â”Š265â”Š331â”Š      )\n â”Š266â”Š332â”Š    },\n```\n```diff\n@@ -268,10 +334,15 @@\n â”Š268â”Š334â”Š    chatRemoved: {\n â”Š269â”Š335â”Š      subscribe: withFilter(\n â”Š270â”Š336â”Š        (root, args, { pubsub }) => pubsub.asyncIterator('chatRemoved'),\n-â”Š271â”Š   â”Š        ({ targetChat }: { targetChat: Chat }, args, { currentUser }) => {\n+â”Š   â”Š337â”Š        async ({ targetChat }: { targetChat: Chat }, args, { currentUser }) => {\n â”Š272â”Š338â”Š          if (!currentUser) return false\n â”Š273â”Š339â”Š\n-â”Š274â”Š   â”Š          return targetChat.participants.some(p => p === currentUser.id)\n+â”Š   â”Š340â”Š          const { rows } = await pool.query(sql`\n+â”Š   â”Š341â”Š            SELECT * FROM chats_users\n+â”Š   â”Š342â”Š            WHERE chat_id = ${targetChat.id}\n+â”Š   â”Š343â”Š            AND user_id = ${currentUser.id}`)\n+â”Š   â”Š344â”Š\n+â”Š   â”Š345â”Š          return !!rows.length\n â”Š275â”Š346â”Š        },\n â”Š276â”Š347â”Š      )\n â”Š277â”Š348â”Š    }\n```\n\n[}]: #\n\n> We use `pool` itself instead of `db` from the context in the subscriptions. Remember we don't request for a new client from the pool in subscriptions.\n> If you use `pool.query`, it just opens a connection, does that operation and set the client free. In that case, you wouldn't be able to work with transactions which is not need in GraphQL Subscriptions.\n\n**Updating Subscriptions w/ PostgreSQL PubSub mechanism**\n\nApolloâ€™s default PubSub mechanism is not for production usage. So, we will use PostgreSQLâ€™s notify/listen for our PubSub mechanism in GraphQL Subscriptions.\n\nInstall the necessary packages;\n\n\t$ yarn add graphql-postgres-subscriptions\n\n[{]: <helper> (diffStep 11.7 files=\"index\" module=\"server\")\n\n#### [Server Step 11.7: Updating Subscriptions w/ PostgreSQL PubSub mechanism](https://github.com/Urigo/WhatsApp-Clone-Server/commit/2ae7573)\n\n##### Changed index.ts\n```diff\n@@ -1,4 +1,4 @@\n-â”Š1â”Š â”Šimport { ApolloServer, gql, PubSub } from 'apollo-server-express'\n+â”Š â”Š1â”Šimport { ApolloServer } from 'apollo-server-express'\n â”Š2â”Š2â”Šimport http from 'http'\n â”Š3â”Š3â”Šimport jwt from 'jsonwebtoken'\n â”Š4â”Š4â”Šimport { app } from './app'\n```\n```diff\n@@ -7,8 +7,15 @@\n â”Š 7â”Š 7â”Šimport schema from './schema'\n â”Š 8â”Š 8â”Šimport { MyContext } from './context';\n â”Š 9â”Š 9â”Šimport sql from 'sql-template-strings'\n+â”Š  â”Š10â”Šconst { PostgresPubSub } = require('graphql-postgres-subscriptions')\n â”Š10â”Š11â”Š\n-â”Š11â”Š  â”Šconst pubsub = new PubSub()\n+â”Š  â”Š12â”Šconst pubsub = new PostgresPubSub({\n+â”Š  â”Š13â”Š  host: 'localhost',\n+â”Š  â”Š14â”Š  port: 5432,\n+â”Š  â”Š15â”Š  user: 'testuser',\n+â”Š  â”Š16â”Š  password: 'testpassword',\n+â”Š  â”Š17â”Š  database: 'whatsapp'\n+â”Š  â”Š18â”Š})\n â”Š12â”Š19â”Šconst server = new ApolloServer({\n â”Š13â”Š20â”Š  schema,\n â”Š14â”Š21â”Š  context: async ({ req, res, connection }: any) => {\n```\n\n[}]: #\n\n> Unfortunately `graphql-postgres-subscription` doesn't have TypeScript typings, so we have to import it using `require`.\n\n**Updating Tests**\n\nWe should update tests to use SQL instead of in-memory database.\n\n[{]: <helper> (diffStep 11.8 files=\"test\" module=\"server\")\n\n#### [Server Step 11.8: Updating Tests with SQL](https://github.com/Urigo/WhatsApp-Clone-Server/commit/9c1d8bc)\n\n##### Changed tests&#x2F;mutations&#x2F;addChat.test.ts\n```diff\n@@ -1,18 +1,27 @@\n â”Š 1â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing'\n â”Š 2â”Š 2â”Šimport { ApolloServer, PubSub, gql } from 'apollo-server-express'\n â”Š 3â”Š 3â”Šimport schema from '../../schema'\n-â”Š 4â”Š  â”Šimport { resetDb, users } from '../../db'\n+â”Š  â”Š 4â”Šimport { resetDb, pool } from '../../db'\n+â”Š  â”Š 5â”Šimport sql from 'sql-template-strings'\n+â”Š  â”Š 6â”Šimport { MyContext } from '../../context';\n â”Š 5â”Š 7â”Š\n â”Š 6â”Š 8â”Šdescribe('Mutation.addChat', () => {\n â”Š 7â”Š 9â”Š  beforeEach(resetDb)\n â”Š 8â”Š10â”Š\n â”Š 9â”Š11â”Š  it('creates a new chat between current user and specified recipient', async () => {\n+â”Š  â”Š12â”Š    const { rows } = await pool.query(sql`SELECT * FROM users WHERE id = 2`)\n+â”Š  â”Š13â”Š    const currentUser = rows[0];\n â”Š10â”Š14â”Š    const server = new ApolloServer({\n â”Š11â”Š15â”Š      schema,\n-â”Š12â”Š  â”Š      context: () => ({\n+â”Š  â”Š16â”Š      context: async () => ({\n â”Š13â”Š17â”Š        pubsub: new PubSub(),\n-â”Š14â”Š  â”Š        currentUser: users[1],\n+â”Š  â”Š18â”Š        currentUser,\n+â”Š  â”Š19â”Š        db: await pool.connect(),\n â”Š15â”Š20â”Š      }),\n+â”Š  â”Š21â”Š      formatResponse: (res: any, { context }: { context: MyContext }) => {\n+â”Š  â”Š22â”Š        context.db.release();\n+â”Š  â”Š23â”Š        return res;\n+â”Š  â”Š24â”Š      }\n â”Š16â”Š25â”Š    })\n â”Š17â”Š26â”Š\n â”Š18â”Š27â”Š    const { query, mutate } = createTestClient(server)\n```\n```diff\n@@ -57,12 +66,19 @@\n â”Š57â”Š66â”Š  })\n â”Š58â”Š67â”Š\n â”Š59â”Š68â”Š  it('returns the existing chat if so', async () => {\n+â”Š  â”Š69â”Š    const { rows } = await pool.query(sql`SELECT * FROM users WHERE id = 1`)\n+â”Š  â”Š70â”Š    const currentUser = rows[0]\n â”Š60â”Š71â”Š    const server = new ApolloServer({\n â”Š61â”Š72â”Š      schema,\n-â”Š62â”Š  â”Š      context: () => ({\n+â”Š  â”Š73â”Š      context: async () => ({\n â”Š63â”Š74â”Š        pubsub: new PubSub(),\n-â”Š64â”Š  â”Š        currentUser: users[0],\n+â”Š  â”Š75â”Š        currentUser,\n+â”Š  â”Š76â”Š        db: await pool.connect(),\n â”Š65â”Š77â”Š      }),\n+â”Š  â”Š78â”Š      formatResponse: (res: any, { context }: { context: MyContext }) => {\n+â”Š  â”Š79â”Š        context.db.release();\n+â”Š  â”Š80â”Š        return res;\n+â”Š  â”Š81â”Š      }\n â”Š66â”Š82â”Š    })\n â”Š67â”Š83â”Š\n â”Š68â”Š84â”Š    const { query, mutate } = createTestClient(server)\n```\n\n##### Changed tests&#x2F;mutations&#x2F;addMessage.test.ts\n```diff\n@@ -1,18 +1,27 @@\n â”Š 1â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing'\n â”Š 2â”Š 2â”Šimport { ApolloServer, PubSub, gql } from 'apollo-server-express'\n â”Š 3â”Š 3â”Šimport schema from '../../schema'\n-â”Š 4â”Š  â”Šimport { resetDb, users } from '../../db'\n+â”Š  â”Š 4â”Šimport { resetDb, pool } from '../../db'\n+â”Š  â”Š 5â”Šimport sql from 'sql-template-strings'\n+â”Š  â”Š 6â”Šimport { MyContext } from '../../context';\n â”Š 5â”Š 7â”Š\n â”Š 6â”Š 8â”Šdescribe('Mutation.addMessage', () => {\n â”Š 7â”Š 9â”Š  beforeEach(resetDb)\n â”Š 8â”Š10â”Š\n â”Š 9â”Š11â”Š  it('should add message to specified chat', async () => {\n+â”Š  â”Š12â”Š    const { rows } = await pool.query(sql`SELECT * FROM users WHERE id = 1`)\n+â”Š  â”Š13â”Š    const currentUser = rows[0]\n â”Š10â”Š14â”Š    const server = new ApolloServer({\n â”Š11â”Š15â”Š      schema,\n-â”Š12â”Š  â”Š      context: () => ({\n+â”Š  â”Š16â”Š      context: async () => ({\n â”Š13â”Š17â”Š        pubsub: new PubSub(),\n-â”Š14â”Š  â”Š        currentUser: users[0],\n+â”Š  â”Š18â”Š        currentUser,\n+â”Š  â”Š19â”Š        db: await pool.connect(),\n â”Š15â”Š20â”Š      }),\n+â”Š  â”Š21â”Š      formatResponse: (res: any, { context }: { context: MyContext }) => {\n+â”Š  â”Š22â”Š        context.db.release();\n+â”Š  â”Š23â”Š        return res;\n+â”Š  â”Š24â”Š      }\n â”Š16â”Š25â”Š    })\n â”Š17â”Š26â”Š\n â”Š18â”Š27â”Š    const { query, mutate } = createTestClient(server)\n```\n\n##### Changed tests&#x2F;mutations&#x2F;removeChat.test.ts\n```diff\n@@ -1,18 +1,27 @@\n â”Š 1â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing'\n â”Š 2â”Š 2â”Šimport { ApolloServer, PubSub, gql } from 'apollo-server-express'\n â”Š 3â”Š 3â”Šimport schema from '../../schema'\n-â”Š 4â”Š  â”Šimport { resetDb, users } from '../../db'\n+â”Š  â”Š 4â”Šimport { resetDb, pool } from '../../db'\n+â”Š  â”Š 5â”Šimport sql from 'sql-template-strings'\n+â”Š  â”Š 6â”Šimport { MyContext } from '../../context';\n â”Š 5â”Š 7â”Š\n â”Š 6â”Š 8â”Šdescribe('Mutation.removeChat', () => {\n â”Š 7â”Š 9â”Š  beforeEach(resetDb)\n â”Š 8â”Š10â”Š\n â”Š 9â”Š11â”Š  it('removes chat by id', async () => {\n+â”Š  â”Š12â”Š    const { rows } = await pool.query(sql`SELECT * FROM users WHERE id = 1`)\n+â”Š  â”Š13â”Š    const currentUser = rows[0]\n â”Š10â”Š14â”Š    const server = new ApolloServer({\n â”Š11â”Š15â”Š      schema,\n-â”Š12â”Š  â”Š      context: () => ({\n+â”Š  â”Š16â”Š      context: async () => ({\n â”Š13â”Š17â”Š        pubsub: new PubSub(),\n-â”Š14â”Š  â”Š        currentUser: users[0],\n+â”Š  â”Š18â”Š        currentUser,\n+â”Š  â”Š19â”Š        db: await pool.connect(),\n â”Š15â”Š20â”Š      }),\n+â”Š  â”Š21â”Š      formatResponse: (res: any, { context }: { context: MyContext }) => {\n+â”Š  â”Š22â”Š        context.db.release();\n+â”Š  â”Š23â”Š        return res;\n+â”Š  â”Š24â”Š      }\n â”Š16â”Š25â”Š    })\n â”Š17â”Š26â”Š\n â”Š18â”Š27â”Š    const { query, mutate } = createTestClient(server)\n```\n\n##### Added tests&#x2F;queries&#x2F;\\__snapshots__&#x2F;getMe.test.ts.snap\n```diff\n@@ -0,0 +1,11 @@\n+â”Š  â”Š 1â”Š// Jest Snapshot v1, https://goo.gl/fbAQLP\n+â”Š  â”Š 2â”Š\n+â”Š  â”Š 3â”Šexports[`Query.me should fetch current user 1`] = `\n+â”Š  â”Š 4â”ŠObject {\n+â”Š  â”Š 5â”Š  \"me\": Object {\n+â”Š  â”Š 6â”Š    \"id\": \"1\",\n+â”Š  â”Š 7â”Š    \"name\": \"Ray Edwards\",\n+â”Š  â”Š 8â”Š    \"picture\": \"https://randomuser.me/api/portraits/thumb/lego/1.jpg\",\n+â”Š  â”Š 9â”Š  },\n+â”Š  â”Š10â”Š}\n+â”Š  â”Š11â”Š`;\n```\n\n##### Changed tests&#x2F;queries&#x2F;getChat.test.ts\n```diff\n@@ -1,15 +1,24 @@\n â”Š 1â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing'\n â”Š 2â”Š 2â”Šimport { ApolloServer, gql } from 'apollo-server-express'\n â”Š 3â”Š 3â”Šimport schema from '../../schema'\n-â”Š 4â”Š  â”Šimport { users } from '../../db'\n+â”Š  â”Š 4â”Šimport { pool } from '../../db'\n+â”Š  â”Š 5â”Šimport sql from 'sql-template-strings'\n+â”Š  â”Š 6â”Šimport { MyContext } from '../../context';\n â”Š 5â”Š 7â”Š\n â”Š 6â”Š 8â”Šdescribe('Query.chat', () => {\n â”Š 7â”Š 9â”Š  it('should fetch specified chat', async () => {\n+â”Š  â”Š10â”Š    const { rows } = await pool.query(sql`SELECT * FROM users WHERE id = 1`)\n+â”Š  â”Š11â”Š    const currentUser = rows[0]\n â”Š 8â”Š12â”Š    const server = new ApolloServer({\n â”Š 9â”Š13â”Š      schema,\n-â”Š10â”Š  â”Š      context: () => ({\n-â”Š11â”Š  â”Š        currentUser: users[0],\n+â”Š  â”Š14â”Š      context: async () => ({\n+â”Š  â”Š15â”Š        currentUser,\n+â”Š  â”Š16â”Š        db: await pool.connect(),\n â”Š12â”Š17â”Š      }),\n+â”Š  â”Š18â”Š      formatResponse: (res: any, { context }: { context: MyContext }) => {\n+â”Š  â”Š19â”Š        context.db.release();\n+â”Š  â”Š20â”Š        return res;\n+â”Š  â”Š21â”Š      }\n â”Š13â”Š22â”Š    })\n â”Š14â”Š23â”Š\n â”Š15â”Š24â”Š    const { query } = createTestClient(server)\n```\n\n##### Changed tests&#x2F;queries&#x2F;getChats.test.ts\n```diff\n@@ -1,15 +1,24 @@\n â”Š 1â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing'\n â”Š 2â”Š 2â”Šimport { ApolloServer, gql } from 'apollo-server-express'\n â”Š 3â”Š 3â”Šimport schema from '../../schema'\n-â”Š 4â”Š  â”Šimport { users } from '../../db'\n+â”Š  â”Š 4â”Šimport { pool } from '../../db'\n+â”Š  â”Š 5â”Šimport sql from 'sql-template-strings'\n+â”Š  â”Š 6â”Šimport { MyContext } from '../../context';\n â”Š 5â”Š 7â”Š\n â”Š 6â”Š 8â”Šdescribe('Query.chats', () => {\n â”Š 7â”Š 9â”Š  it('should fetch all chats', async () => {\n+â”Š  â”Š10â”Š    const { rows } = await pool.query(sql`SELECT * FROM users WHERE id = 1`)\n+â”Š  â”Š11â”Š    const currentUser = rows[0]\n â”Š 8â”Š12â”Š    const server = new ApolloServer({\n â”Š 9â”Š13â”Š      schema,\n-â”Š10â”Š  â”Š      context: () => ({\n-â”Š11â”Š  â”Š        currentUser: users[0],\n+â”Š  â”Š14â”Š      context: async () => ({\n+â”Š  â”Š15â”Š        currentUser,\n+â”Š  â”Š16â”Š        db: await pool.connect(),\n â”Š12â”Š17â”Š      }),\n+â”Š  â”Š18â”Š      formatResponse: (res: any, { context }: { context: MyContext }) => {\n+â”Š  â”Š19â”Š        context.db.release();\n+â”Š  â”Š20â”Š        return res;\n+â”Š  â”Š21â”Š      }\n â”Š13â”Š22â”Š    })\n â”Š14â”Š23â”Š\n â”Š15â”Š24â”Š    const { query } = createTestClient(server)\n```\n\n##### Changed tests&#x2F;queries&#x2F;getMe.test.ts\n```diff\n@@ -1,15 +1,24 @@\n â”Š 1â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing'\n â”Š 2â”Š 2â”Šimport { ApolloServer, gql } from 'apollo-server-express'\n â”Š 3â”Š 3â”Šimport schema from '../../schema'\n-â”Š 4â”Š  â”Šimport { users } from '../../db'\n+â”Š  â”Š 4â”Šimport { pool } from '../../db'\n+â”Š  â”Š 5â”Šimport sql from 'sql-template-strings'\n+â”Š  â”Š 6â”Šimport { MyContext } from '../../context';\n â”Š 5â”Š 7â”Š\n â”Š 6â”Š 8â”Šdescribe('Query.me', () => {\n â”Š 7â”Š 9â”Š  it('should fetch current user', async () => {\n+â”Š  â”Š10â”Š    const { rows } = await pool.query(sql`SELECT * FROM users WHERE id = 1`)\n+â”Š  â”Š11â”Š    const currentUser = rows[0]\n â”Š 8â”Š12â”Š    const server = new ApolloServer({\n â”Š 9â”Š13â”Š      schema,\n-â”Š10â”Š  â”Š      context: () => ({\n-â”Š11â”Š  â”Š        currentUser: users[0],\n+â”Š  â”Š14â”Š      context: async () => ({\n+â”Š  â”Š15â”Š        currentUser,\n+â”Š  â”Š16â”Š        db: await pool.connect(),\n â”Š12â”Š17â”Š      }),\n+â”Š  â”Š18â”Š      formatResponse: (res: any, { context }: { context: MyContext }) => {\n+â”Š  â”Š19â”Š        context.db.release();\n+â”Š  â”Š20â”Š        return res;\n+â”Š  â”Š21â”Š      }\n â”Š13â”Š22â”Š    })\n â”Š14â”Š23â”Š\n â”Š15â”Š24â”Š    const { query } = createTestClient(server)\n```\n\n##### Changed tests&#x2F;queries&#x2F;getUsers.test.ts\n```diff\n@@ -1,15 +1,25 @@\n â”Š 1â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing'\n â”Š 2â”Š 2â”Šimport { ApolloServer, gql } from 'apollo-server-express'\n â”Š 3â”Š 3â”Šimport schema from '../../schema'\n-â”Š 4â”Š  â”Šimport { users } from '../../db'\n+â”Š  â”Š 4â”Šimport { pool } from '../../db'\n+â”Š  â”Š 5â”Šimport sql from 'sql-template-strings'\n+â”Š  â”Š 6â”Šimport { MyContext } from '../../context';\n â”Š 5â”Š 7â”Š\n â”Š 6â”Š 8â”Šdescribe('Query.getUsers', () => {\n â”Š 7â”Š 9â”Š  it('should fetch all users except the one signed-in', async () => {\n-â”Š 8â”Š  â”Š    let currentUser = users[0]\n-â”Š 9â”Š  â”Š\n+â”Š  â”Š10â”Š    const firstUserQuery = await pool.query(sql`SELECT * FROM users WHERE id = 1`)\n+â”Š  â”Š11â”Š    let currentUser = firstUserQuery.rows[0]\n+â”Š  â”Š12â”Š    const db = await pool.connect()\n â”Š10â”Š13â”Š    const server = new ApolloServer({\n â”Š11â”Š14â”Š      schema,\n-â”Š12â”Š  â”Š      context: () => ({ currentUser }),\n+â”Š  â”Š15â”Š      context: async () => ({\n+â”Š  â”Š16â”Š        currentUser,\n+â”Š  â”Š17â”Š        db: await pool.connect(),\n+â”Š  â”Š18â”Š      }),\n+â”Š  â”Š19â”Š      formatResponse: (res: any, { context }: { context: MyContext }) => {\n+â”Š  â”Š20â”Š        context.db.release();\n+â”Š  â”Š21â”Š        return res;\n+â”Š  â”Š22â”Š      }\n â”Š13â”Š23â”Š    })\n â”Š14â”Š24â”Š\n â”Š15â”Š25â”Š    const { query } = createTestClient(server)\n```\n```diff\n@@ -30,7 +40,8 @@\n â”Š30â”Š40â”Š    expect(res.errors).toBeUndefined()\n â”Š31â”Š41â”Š    expect(res.data).toMatchSnapshot()\n â”Š32â”Š42â”Š\n-â”Š33â”Š  â”Š    currentUser = users[1]\n+â”Š  â”Š43â”Š    const secondUserQuery = await pool.query(sql`SELECT * FROM users WHERE id = '2'`)\n+â”Š  â”Š44â”Š    currentUser = secondUserQuery.rows[0]\n â”Š34â”Š45â”Š\n â”Š35â”Š46â”Š    res = await query({\n â”Š36â”Š47â”Š      query: gql `\n```\n\n[}]: #\n\n**Remove in-memory database**\n\nWe can remove all the stuff related to in-memory database now.\n\n[{]: <helper> (diffStep 11.9 files=\"db\" module=\"server\")\n\n#### [Server Step 11.9: Removing in-memory database](https://github.com/Urigo/WhatsApp-Clone-Server/commit/5d4af68)\n\n##### Changed db.ts\n```diff\n@@ -30,10 +30,6 @@\n â”Š30â”Š30â”Š  database: 'whatsapp'\n â”Š31â”Š31â”Š})\n â”Š32â”Š32â”Š\n-â”Š33â”Š  â”Šexport const users: User[] = []\n-â”Š34â”Š  â”Šexport const messages: Message[] = []\n-â”Š35â”Š  â”Šexport const chats: Chat[] = []\n-â”Š36â”Š  â”Š\n â”Š37â”Š33â”Šexport const resetDb = async () => {\n â”Š38â”Š34â”Š\n â”Š39â”Š35â”Š  await pool.query(sql`DELETE FROM users`)\n```\n\n[}]: #"
          },
          {
            "manualTitle": "Step 15: Using a REST API",
            "stepRevision": "0b53d9cd23436376ee9d52dc6a2ec9899b80aa1e",
            "manualView": "Despite using GraphQL throughout all our app, we will soon meet the need to use some external API and chances are it will be REST.\nOur first idea could be to bridge the REST API through GraphQL, reproposing the very same API to the client. This approach is wrong, because our first concern should always be to provide the client with ready to use data in the best possible shape.\nThe client donâ€™t need to know that our GraphQL API is backed by a REST API, it doesnâ€™t have to pass headers required by the underlying API or do any kind of special considerations: our backend should take care of everything.\n\n## Retrieve a profile picture from a REST API\n\nIn this chapter we will discuss how to use an external API called Unsplash to retrieve random profile pictures for the users who didnâ€™t set any.\n\nStart heading to https://unsplash.com/developers and clicking on â€œRegister as a developerâ€. After registering you will have to create a new app: take note of the Access Key because weâ€™re going to need it.\n\nIf you look at the Documentation (https://unsplash.com/documentation#get-a-random-photo) youâ€™ll notice that in order to retrieve a random photo we have to query the /photos/random endpoint (GET method). We also have to pass some headers for the authent\ncation and some params for the search term and the orientation.\n\nOn the browser we would probably use the fetch api, but since on we node we would need a polyfill itâ€™s better to just use a full fledged library like axios:\n\n    yarn add axios\n    yarn add -D @types/axios\n\nBefore we start implementing, we want to create some typings for our endpoint, because ideally we would like to be aided by those typings during the development.\nIn order to do so we can use a Chrome extension like Advanced Rest Client to retrieve the response.\nSet the Method to GET, the Headers to Authorization: 'Client-ID 4d048cfb4383b407eff92e4a2a5ec36c0a866be85e64caafa588c110efad350d' and the Request URL to https://api.unsplash.com/photos/random, along with the params to query: 'portrait' and orientation: 'squarish'.\nCopy the response, create a new file called types/unsplash.ts in your vscode editor and run the command â€œPast JSON as Typesâ€ (you need to install the Past JSON as Code extension and press CTRL+P to open the run command prompt). That would be enough to automatically create the typings for the random photo endpoint.\n\nNow we can finally implement the REST API call in our picture resolver:\n\n[{]: <helper> (diffStep \"12.1\" files=\"schema/resolvers.ts\" module=\"client\")\n\n#### Client Step 12.1: Add basic ChatCreationScreen\n\n\n\n[}]: #\n\nIn order to test it, we have to remove the picture from one of the users and re-run the server with the `RESET_DB=true` environment variable:\n\n[{]: <helper> (diffStep \"12.1\" files=\"db.ts\" module=\"client\")\n\n#### Client Step 12.1: Add basic ChatCreationScreen\n\n\n\n[}]: #\n\n\n## Track the API\n\nEven if our typings are working pretty well so far, not all REST APIs are versioned and the shape weâ€™ve got from the server could potentially change.\nIn order to keep an eye on it we could use the safe-api middleware in order to check for abnormal answers coming from the server and log them. We can also generate the typings automatically based on the response we get.\nFirst letâ€™s install the safe-api middleware:\n\n    yarn add @safe-api/middleware\n\nThen letâ€™s use it inside our resolver:\n\n[{]: <helper> (diffStep \"12.2\" files=\"schema/resolvers.ts\" module=\"client\")\n\n#### Client Step 12.2: Create chat on user pick\n\n\n\n[}]: #\n\nNow launch the client in order to retrieve the picture field multiple times.\n\nIf you look inside the logs directory you will notice that it generated some graphql schema to represent the REST API. You will notice that each time we call the REST endpoint it generates a new schema, because a single response isnâ€™t generic enough to account for all possible responses. Ideally safe-api should be able to average multiple esponses in order to generate the least generic schema matching the given responses.\n\nNow we need to remove `types/unsplash.ts` and generate some Typescript typings out of the schema. Do do so we can use the graphql-code-generator:\n\n[{]: <helper> (diffStep \"12.3\" files=\".gitignore, codegen.yml\" module=\"client\")\n\n#### Client Step 12.3: Write chat on chatAdded\n\n\n\n[}]: #\n\n    yarn codegen\n\n\n## Apollo DataSources\n\nWeâ€™re not done yet, there is still room for improvement. Instead of using axios, we could use Apolloâ€™s Data Sources and take advantage of the built-in support for caching, deduplication and error handling.\n\n    yarn remove axios @types/axios\n    yarn add apollo-datasource-rest\n\n[{]: <helper> (diffStep \"12.4\" files=\"schema/unsplash.api.ts\" module=\"client\")\n\n#### Client Step 12.4: Add chat removal function\n\n\n\n[}]: #\n\nWe created the UnsplashApi class, which extends RESTDataSource. In the constructor you need to set the baseUrl (after calling super() to run the constructor of the base class). You also need to create a willSendRequest method to set the authentication headers for each call. Then itâ€™s simply a matter of creating a getRandomPhoto method to perform the actual REST API call. Instead of calling axios you will have to call the get method of the class (which in turn gets inherited from its RESTDataSource base class): the API is very similar to the axios one.\n\nIn order to access the data source from the resolvers we need to tell Apollo to put them on the context for every request. We shouldnâ€™t use the context field, because that would lead to circular dependencies. Instead we need to use the dataSources field:\n\n[{]: <helper> (diffStep \"12.4\" files=\"index.ts\" module=\"client\")\n\n#### Client Step 12.4: Add chat removal function\n\n\n\n[}]: #\n\nNow we need to update the typings for our context and run the graphq-code-generator again:\n\n[{]: <helper> (diffStep \"12.4\" files=\"context.ts\" module=\"client\")\n\n#### Client Step 12.4: Add chat removal function\n\n\n\n[}]: #\n\n    yarn codegen\n\nNow it should be pretty easy to modify our resolver in order to use our just created datasource:\n\n[{]: <helper> (diffStep \"12.4\" files=\"schema/resolvers.ts\" module=\"client\")\n\n#### Client Step 12.4: Add chat removal function\n\n\n\n[}]: #"
          },
          {
            "manualTitle": "",
            "stepRevision": "",
            "manualView": "This chapter is focused entirely on how to organize a GraphQL API. By far, our project's schema looks simple and keeping SDL and resolvers in two files is really enough.\n\n## Issues we face when GraphQL API grows\n\nUsually, every app starts small and the difficulty of maintenance grows while features are being implemented. I believe that you should always start small and see how a project involves. You could look up many articles about best practices of organising a project but they bring no benefit when your project is small. You don't want to jump between files in order to find what you're looking for, it should be intuitive. I agree a proper folder structure helps but if your schema has 100 lines of code then it makes no sense to split it into 5 files with 20 LOC each. The schema is so small that it won't hurt you when you hit the wall and separation will be necessary but until it happens you can easily move on with the project.\n\nBigger project means more people, more people means teams. In the current state of the app, they might interrupt each other and that eventually affects productivity.\nLack of separation makes the schema harder to maintain, especially once it grows rapidly.\n\n## That's why modularity is a thing!\n\nIn order to improve and solve those issues we would have to split an API into many pieces.\nThose might be files, even folders, doesn't really matter because the goal is to keep relevant chunks of code in one place, conceptually called module.\n\nIf done right, one team won't disturb another and it also helps to understand an entire codebase just by looking at those modules or even learn a feature because everything related to it is within a single module.\n\nThere's also a very important aspect, reusability. Most APIs have something in common, the first thing that comes to mind is authentication and user mechanism in general.\nWhen working with modules, it gets easier to share those.\n\n## Many ways to organize an API\n\nGraphQL specification explains just the language and how to form an API. Managing codebase, that's on our side.\n\nSince we're talking about modularity, let's see possible implementations.\n\nThe first thing on mind are files and folders. Putting relevant logic in a file won't scale well once we add more things, like business logic for example. Which means we need folders, that's for sure.\n\nOkay, so the next question, how to store SDL and resolvers. Do we want to have them stored together or keep them separated?\n\nI'm a big fan of the former because in schema-first approach the SDL is written first and you see exactly how to construct resolvers. The latter would require to jump between files or have them opened side-by-side.\nAnother benefit shows up when you add, remove or just change part of a schema, less likely that you'll miss something.\n\nBut as always, there are things you can't do with that approach.\nOne that pops into my head right away is an IDE supportâ€¦ ?\n< guys, any ideas? >\n\nLet's talk about modularity in terms of SDL.\nWe know how to define types in GraphQL but what if a type is a sum of many features?\nThere two ways to do it. One is to use the `extend` keyword, another to define a type multiple type. Both gave the same effect, all is merged into one type after all.\n\nBut there are few major differences.\n\nThe `extend` keyword is obviously a part of the specification so IDEs and most tools support it. It feels more natural than the second option.\n\nDefining the same type multiple times is the opposite. It might feel odd, not many IDEs and\ntools support it so you have to add a library that handles it but on the other way you don't care if there's already a type or not, you just make sure there's one with proper fields, no matter what. It might also warn you when fields overlap.\n\n## Modularized schema\n\nThere are couple solutions to help you modularize the schema and we will look at 3 of them.\n\nFirst, let's start by defining 3 modules:\n\n- common - things we want to share with all the rest\n- users - everything related to users\n- chats - core logic of WhatsApp\n\n### Using directories\n\nThe simplest and most obvious solution would be to split what we have and move that into directories.\n\nStarting with common module. We need to create a folder at `/modules/common` and a `index.ts` file in it:\n\n[{]: <helper> (diffStep \"13.1\" files=\"modules/common/index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.1: Modularize schema](https://github.com/Urigo/WhatsApp-Clone-Server/commit/7be36f4a336712a4ef2de692cb492e04d919cac8)\n\n##### Added modules&#x2F;common&#x2F;index.ts\n```diff\n@@ -0,0 +1,23 @@\n+â”Š  â”Š 1â”Šimport { gql } from 'apollo-server-express';\n+â”Š  â”Š 2â”Šimport { GraphQLDateTime } from 'graphql-iso-date';\n+â”Š  â”Š 3â”Šimport { Resolvers } from '../../types/graphql';\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šexport const typeDefs = gql`\n+â”Š  â”Š 6â”Š  scalar Date\n+â”Š  â”Š 7â”Š\n+â”Š  â”Š 8â”Š  type Query {\n+â”Š  â”Š 9â”Š    _dummy: Boolean\n+â”Š  â”Š10â”Š  }\n+â”Š  â”Š11â”Š\n+â”Š  â”Š12â”Š  type Mutation {\n+â”Š  â”Š13â”Š    _dummy: Boolean\n+â”Š  â”Š14â”Š  }\n+â”Š  â”Š15â”Š\n+â”Š  â”Š16â”Š  type Subscription {\n+â”Š  â”Š17â”Š    _dummy: Boolean\n+â”Š  â”Š18â”Š  }\n+â”Š  â”Š19â”Š`;\n+â”Š  â”Š20â”Š\n+â”Š  â”Š21â”Šexport const resolvers: Resolvers = {\n+â”Š  â”Š22â”Š  Date: GraphQLDateTime,\n+â”Š  â”Š23â”Š};\n```\n\n[}]: #\n\nYou can see a pattern here, two things are being exported, one with type definitions and the other with resolvers. Why those `_dummy` fields? We want to use `extend` keyword, that require a base type and GraphQL doesn't accept empty objects.\n\nNow, let's do the same but with Users module:\n\n[{]: <helper> (diffStep \"13.1\" files=\"modules/users/index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.1: Modularize schema](https://github.com/Urigo/WhatsApp-Clone-Server/commit/7be36f4a336712a4ef2de692cb492e04d919cac8)\n\n##### Added modules&#x2F;users&#x2F;index.ts\n```diff\n@@ -0,0 +1,100 @@\n+â”Š   â”Š  1â”Šimport { gql } from 'apollo-server-express';\n+â”Š   â”Š  2â”Šimport sql from 'sql-template-strings';\n+â”Š   â”Š  3â”Šimport bcrypt from 'bcrypt';\n+â”Š   â”Š  4â”Šimport jwt from 'jsonwebtoken';\n+â”Š   â”Š  5â”Šimport { secret, expiration } from '../../env';\n+â”Š   â”Š  6â”Šimport { validateLength, validatePassword } from '../../validators';\n+â”Š   â”Š  7â”Šimport { Resolvers } from '../../types/graphql';\n+â”Š   â”Š  8â”Š\n+â”Š   â”Š  9â”Šexport const typeDefs = gql`\n+â”Š   â”Š 10â”Š  type User {\n+â”Š   â”Š 11â”Š    id: ID!\n+â”Š   â”Š 12â”Š    name: String!\n+â”Š   â”Š 13â”Š    picture: String\n+â”Š   â”Š 14â”Š  }\n+â”Š   â”Š 15â”Š\n+â”Š   â”Š 16â”Š  extend type Query {\n+â”Š   â”Š 17â”Š    me: User\n+â”Š   â”Š 18â”Š    users: [User!]!\n+â”Š   â”Š 19â”Š  }\n+â”Š   â”Š 20â”Š\n+â”Š   â”Š 21â”Š  extend type Mutation {\n+â”Š   â”Š 22â”Š    signIn(username: String!, password: String!): User\n+â”Š   â”Š 23â”Š    signUp(\n+â”Š   â”Š 24â”Š      name: String!\n+â”Š   â”Š 25â”Š      username: String!\n+â”Š   â”Š 26â”Š      password: String!\n+â”Š   â”Š 27â”Š      passwordConfirm: String!\n+â”Š   â”Š 28â”Š    ): User\n+â”Š   â”Š 29â”Š  }\n+â”Š   â”Š 30â”Š`;\n+â”Š   â”Š 31â”Š\n+â”Š   â”Š 32â”Šexport const resolvers: Resolvers = {\n+â”Š   â”Š 33â”Š  Query: {\n+â”Š   â”Š 34â”Š    me(root, args, { currentUser }) {\n+â”Š   â”Š 35â”Š      return currentUser || null;\n+â”Š   â”Š 36â”Š    },\n+â”Š   â”Š 37â”Š    async users(root, args, { currentUser, db }) {\n+â”Š   â”Š 38â”Š      if (!currentUser) return [];\n+â”Š   â”Š 39â”Š\n+â”Š   â”Š 40â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š 41â”Š        SELECT * FROM users WHERE users.id != ${currentUser.id}\n+â”Š   â”Š 42â”Š      `);\n+â”Š   â”Š 43â”Š\n+â”Š   â”Š 44â”Š      return rows;\n+â”Š   â”Š 45â”Š    },\n+â”Š   â”Š 46â”Š  },\n+â”Š   â”Š 47â”Š  Mutation: {\n+â”Š   â”Š 48â”Š    async signIn(root, { username, password }, { db, res }) {\n+â”Š   â”Š 49â”Š      const { rows } = await db.query(\n+â”Š   â”Š 50â”Š        sql`SELECT * FROM users WHERE username = ${username}`\n+â”Š   â”Š 51â”Š      );\n+â”Š   â”Š 52â”Š      const user = rows[0];\n+â”Š   â”Š 53â”Š\n+â”Š   â”Š 54â”Š      if (!user) {\n+â”Š   â”Š 55â”Š        throw new Error('user not found');\n+â”Š   â”Š 56â”Š      }\n+â”Š   â”Š 57â”Š\n+â”Š   â”Š 58â”Š      const passwordsMatch = bcrypt.compareSync(password, user.password);\n+â”Š   â”Š 59â”Š\n+â”Š   â”Š 60â”Š      if (!passwordsMatch) {\n+â”Š   â”Š 61â”Š        throw new Error('password is incorrect');\n+â”Š   â”Š 62â”Š      }\n+â”Š   â”Š 63â”Š\n+â”Š   â”Š 64â”Š      const authToken = jwt.sign(username, secret);\n+â”Š   â”Š 65â”Š\n+â”Š   â”Š 66â”Š      res.cookie('authToken', authToken, { maxAge: expiration });\n+â”Š   â”Š 67â”Š\n+â”Š   â”Š 68â”Š      return user;\n+â”Š   â”Š 69â”Š    },\n+â”Š   â”Š 70â”Š\n+â”Š   â”Š 71â”Š    async signUp(root, { name, username, password, passwordConfirm }, { db }) {\n+â”Š   â”Š 72â”Š      validateLength('req.name', name, 3, 50);\n+â”Š   â”Š 73â”Š      validateLength('req.username', username, 3, 18);\n+â”Š   â”Š 74â”Š      validatePassword('req.password', password);\n+â”Š   â”Š 75â”Š\n+â”Š   â”Š 76â”Š      if (password !== passwordConfirm) {\n+â”Š   â”Š 77â”Š        throw Error(\"req.password and req.passwordConfirm don't match\");\n+â”Š   â”Š 78â”Š      }\n+â”Š   â”Š 79â”Š\n+â”Š   â”Š 80â”Š      const existingUserQuery = await db.query(\n+â”Š   â”Š 81â”Š        sql`SELECT * FROM users WHERE username = ${username}`\n+â”Š   â”Š 82â”Š      );\n+â”Š   â”Š 83â”Š      if (existingUserQuery.rows[0]) {\n+â”Š   â”Š 84â”Š        throw Error('username already exists');\n+â”Š   â”Š 85â”Š      }\n+â”Š   â”Š 86â”Š\n+â”Š   â”Š 87â”Š      const passwordHash = bcrypt.hashSync(password, bcrypt.genSaltSync(8));\n+â”Š   â”Š 88â”Š\n+â”Š   â”Š 89â”Š      const createdUserQuery = await db.query(sql`\n+â”Š   â”Š 90â”Š        INSERT INTO users(password, picture, username, name)\n+â”Š   â”Š 91â”Š        VALUES(${passwordHash}, '', ${username}, ${name})\n+â”Š   â”Š 92â”Š        RETURNING *\n+â”Š   â”Š 93â”Š      `);\n+â”Š   â”Š 94â”Š\n+â”Š   â”Š 95â”Š      const user = createdUserQuery.rows[0];\n+â”Š   â”Š 96â”Š\n+â”Š   â”Š 97â”Š      return user;\n+â”Š   â”Š 98â”Š    },\n+â”Š   â”Š 99â”Š  },\n+â”Š   â”Š100â”Š};\n```\n\n[}]: #\n\nAnd Chats module:\n\n[{]: <helper> (diffStep \"13.1\" files=\"modules/chats/index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.1: Modularize schema](https://github.com/Urigo/WhatsApp-Clone-Server/commit/7be36f4a336712a4ef2de692cb492e04d919cac8)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,16 +1,47 @@\n-â”Š 1â”Š  â”Šimport { withFilter } from 'apollo-server-express';\n-â”Š 2â”Š  â”Šimport { GraphQLDateTime } from 'graphql-iso-date';\n-â”Š 3â”Š  â”Šimport { Message, Chat, pool } from '../db';\n-â”Š 4â”Š  â”Šimport { Resolvers } from '../types/graphql';\n-â”Š 5â”Š  â”Šimport { secret, expiration } from '../env';\n-â”Š 6â”Š  â”Šimport bcrypt from 'bcrypt';\n-â”Š 7â”Š  â”Šimport jwt from 'jsonwebtoken';\n-â”Š 8â”Š  â”Šimport { validateLength, validatePassword } from '../validators';\n+â”Š  â”Š 1â”Šimport { gql, withFilter } from 'apollo-server-express';\n â”Š 9â”Š 2â”Šimport sql from 'sql-template-strings';\n-â”Š10â”Š  â”Š\n-â”Š11â”Š  â”Šconst resolvers: Resolvers = {\n-â”Š12â”Š  â”Š  Date: GraphQLDateTime,\n-â”Š13â”Š  â”Š\n+â”Š  â”Š 3â”Šimport { Message, Chat, pool } from '../../db';\n+â”Š  â”Š 4â”Šimport { Resolvers } from '../../types/graphql';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šexport const typeDefs = gql`\n+â”Š  â”Š 7â”Š  type Message {\n+â”Š  â”Š 8â”Š    id: ID!\n+â”Š  â”Š 9â”Š    content: String!\n+â”Š  â”Š10â”Š    createdAt: Date!\n+â”Š  â”Š11â”Š    chat: Chat\n+â”Š  â”Š12â”Š    sender: User\n+â”Š  â”Š13â”Š    recipient: User\n+â”Š  â”Š14â”Š    isMine: Boolean!\n+â”Š  â”Š15â”Š  }\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š  type Chat {\n+â”Š  â”Š18â”Š    id: ID!\n+â”Š  â”Š19â”Š    name: String\n+â”Š  â”Š20â”Š    picture: String\n+â”Š  â”Š21â”Š    lastMessage: Message\n+â”Š  â”Š22â”Š    messages: [Message!]!\n+â”Š  â”Š23â”Š    participants: [User!]!\n+â”Š  â”Š24â”Š  }\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Š  extend type Query {\n+â”Š  â”Š27â”Š    chats: [Chat!]!\n+â”Š  â”Š28â”Š    chat(chatId: ID!): Chat\n+â”Š  â”Š29â”Š  }\n+â”Š  â”Š30â”Š\n+â”Š  â”Š31â”Š  extend type Mutation {\n+â”Š  â”Š32â”Š    addMessage(chatId: ID!, content: String!): Message\n+â”Š  â”Š33â”Š    addChat(recipientId: ID!): Chat\n+â”Š  â”Š34â”Š    removeChat(chatId: ID!): ID\n+â”Š  â”Š35â”Š  }\n+â”Š  â”Š36â”Š\n+â”Š  â”Š37â”Š  extend type Subscription {\n+â”Š  â”Š38â”Š    messageAdded: Message!\n+â”Š  â”Š39â”Š    chatAdded: Chat!\n+â”Š  â”Š40â”Š    chatRemoved: ID!\n+â”Š  â”Š41â”Š  }\n+â”Š  â”Š42â”Š`;\n+â”Š  â”Š43â”Š\n+â”Š  â”Š44â”Šexport const resolvers: Resolvers = {\n â”Š14â”Š45â”Š  Message: {\n â”Š15â”Š46â”Š    createdAt(message) {\n â”Š16â”Š47â”Š      return new Date(message.created_at);\n```\n```diff\n@@ -105,10 +136,6 @@\n â”Š105â”Š136â”Š  },\n â”Š106â”Š137â”Š\n â”Š107â”Š138â”Š  Query: {\n-â”Š108â”Š   â”Š    me(root, args, { currentUser }) {\n-â”Š109â”Š   â”Š      return currentUser || null;\n-â”Š110â”Š   â”Š    },\n-â”Š111â”Š   â”Š\n â”Š112â”Š139â”Š    async chats(root, args, { currentUser, db }) {\n â”Š113â”Š140â”Š      if (!currentUser) return [];\n â”Š114â”Š141â”Š\n```\n```diff\n@@ -133,71 +160,9 @@\n â”Š133â”Š160â”Š\n â”Š134â”Š161â”Š      return rows[0] ? rows[0] : null;\n â”Š135â”Š162â”Š    },\n-â”Š136â”Š   â”Š\n-â”Š137â”Š   â”Š    async users(root, args, { currentUser, db }) {\n-â”Š138â”Š   â”Š      if (!currentUser) return [];\n-â”Š139â”Š   â”Š\n-â”Š140â”Š   â”Š      const { rows } = await db.query(sql`\n-â”Š141â”Š   â”Š        SELECT * FROM users WHERE users.id != ${currentUser.id}\n-â”Š142â”Š   â”Š      `);\n-â”Š143â”Š   â”Š\n-â”Š144â”Š   â”Š      return rows;\n-â”Š145â”Š   â”Š    },\n â”Š146â”Š163â”Š  },\n â”Š147â”Š164â”Š\n â”Š148â”Š165â”Š  Mutation: {\n-â”Š149â”Š   â”Š    async signIn(root, { username, password }, { db, res }) {\n-â”Š150â”Š   â”Š      const { rows } = await db.query(\n-â”Š151â”Š   â”Š        sql`SELECT * FROM users WHERE username = ${username}`\n-â”Š152â”Š   â”Š      );\n-â”Š153â”Š   â”Š      const user = rows[0];\n-â”Š154â”Š   â”Š\n-â”Š155â”Š   â”Š      if (!user) {\n-â”Š156â”Š   â”Š        throw new Error('user not found');\n-â”Š157â”Š   â”Š      }\n-â”Š158â”Š   â”Š\n-â”Š159â”Š   â”Š      const passwordsMatch = bcrypt.compareSync(password, user.password);\n-â”Š160â”Š   â”Š\n-â”Š161â”Š   â”Š      if (!passwordsMatch) {\n-â”Š162â”Š   â”Š        throw new Error('password is incorrect');\n-â”Š163â”Š   â”Š      }\n-â”Š164â”Š   â”Š\n-â”Š165â”Š   â”Š      const authToken = jwt.sign(username, secret);\n-â”Š166â”Š   â”Š\n-â”Š167â”Š   â”Š      res.cookie('authToken', authToken, { maxAge: expiration });\n-â”Š168â”Š   â”Š\n-â”Š169â”Š   â”Š      return user;\n-â”Š170â”Š   â”Š    },\n-â”Š171â”Š   â”Š\n-â”Š172â”Š   â”Š    async signUp(root, { name, username, password, passwordConfirm }, { db }) {\n-â”Š173â”Š   â”Š      validateLength('req.name', name, 3, 50);\n-â”Š174â”Š   â”Š      validateLength('req.username', username, 3, 18);\n-â”Š175â”Š   â”Š      validatePassword('req.password', password);\n-â”Š176â”Š   â”Š\n-â”Š177â”Š   â”Š      if (password !== passwordConfirm) {\n-â”Š178â”Š   â”Š        throw Error(\"req.password and req.passwordConfirm don't match\");\n-â”Š179â”Š   â”Š      }\n-â”Š180â”Š   â”Š\n-â”Š181â”Š   â”Š      const existingUserQuery = await db.query(\n-â”Š182â”Š   â”Š        sql`SELECT * FROM users WHERE username = ${username}`\n-â”Š183â”Š   â”Š      );\n-â”Š184â”Š   â”Š      if (existingUserQuery.rows[0]) {\n-â”Š185â”Š   â”Š        throw Error('username already exists');\n-â”Š186â”Š   â”Š      }\n-â”Š187â”Š   â”Š\n-â”Š188â”Š   â”Š      const passwordHash = bcrypt.hashSync(password, bcrypt.genSaltSync(8));\n-â”Š189â”Š   â”Š\n-â”Š190â”Š   â”Š      const createdUserQuery = await db.query(sql`\n-â”Š191â”Š   â”Š        INSERT INTO users(password, picture, username, name)\n-â”Š192â”Š   â”Š        VALUES(${passwordHash}, '', ${username}, ${name})\n-â”Š193â”Š   â”Š        RETURNING *\n-â”Š194â”Š   â”Š      `);\n-â”Š195â”Š   â”Š\n-â”Š196â”Š   â”Š      const user = createdUserQuery.rows[0];\n-â”Š197â”Š   â”Š\n-â”Š198â”Š   â”Š      return user;\n-â”Š199â”Š   â”Š    },\n-â”Š200â”Š   â”Š\n â”Š201â”Š166â”Š    async addMessage(root, { chatId, content }, { currentUser, pubsub, db }) {\n â”Š202â”Š167â”Š      if (!currentUser) return null;\n â”Š203â”Š168â”Š\n```\n```diff\n@@ -360,5 +325,3 @@\n â”Š360â”Š325â”Š    },\n â”Š361â”Š326â”Š  },\n â”Š362â”Š327â”Š};\n-â”Š363â”Š   â”Š\n-â”Š364â”Š   â”Šexport default resolvers;\n```\n\n[}]: #\n\nSeems like modules are ready but we still need to create a Schema out of them.\n\n[{]: <helper> (diffStep \"13.1\" files=\"schema/index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.1: Modularize schema](https://github.com/Urigo/WhatsApp-Clone-Server/commit/7be36f4a336712a4ef2de692cb492e04d919cac8)\n\n##### Changed schema&#x2F;index.ts\n```diff\n@@ -1,10 +1,15 @@\n-â”Š 1â”Š  â”Šimport { importSchema } from 'graphql-import';\n â”Š 2â”Š 1â”Šimport { makeExecutableSchema, IResolvers } from 'graphql-tools';\n-â”Š 3â”Š  â”Šimport resolvers from './resolvers';\n-â”Š 4â”Š  â”Š\n-â”Š 5â”Š  â”Šconst typeDefs = importSchema('schema/typeDefs.graphql');\n+â”Š  â”Š 2â”Šimport { merge } from 'lodash';\n+â”Š  â”Š 3â”Šimport * as commonModule from '../modules/common';\n+â”Š  â”Š 4â”Šimport * as usersModule from '../modules/users';\n+â”Š  â”Š 5â”Šimport * as chatsModule from '../modules/chats';\n â”Š 6â”Š 6â”Š\n â”Š 7â”Š 7â”Šexport default makeExecutableSchema({\n-â”Š 8â”Š  â”Š  resolvers: resolvers as IResolvers,\n-â”Š 9â”Š  â”Š  typeDefs,\n+â”Š  â”Š 8â”Š  resolvers: merge(\n+â”Š  â”Š 9â”Š    {},\n+â”Š  â”Š10â”Š    commonModule.resolvers,\n+â”Š  â”Š11â”Š    usersModule.resolvers,\n+â”Š  â”Š12â”Š    chatsModule.resolvers\n+â”Š  â”Š13â”Š  ) as IResolvers,\n+â”Š  â”Š14â”Š  typeDefs: [commonModule.typeDefs, usersModule.typeDefs, chatsModule.typeDefs],\n â”Š10â”Š15â”Š});\n```\n\n[}]: #\n\nBecause we moved everything from `resolvers.ts` and `typeDefs.graphql` files, those can now be removed.\n\nThe last thing we need to adjust is the GraphQL Code Generator's config, in `codegen.yml`:\n\n[{]: <helper> (diffStep \"13.1\" files=\"codegen.yml\" module=\"server\")\n\n#### [__Server__ Step 13.1: Modularize schema](https://github.com/Urigo/WhatsApp-Clone-Server/commit/7be36f4a336712a4ef2de692cb492e04d919cac8)\n\n##### Changed codegen.yml\n```diff\n@@ -1,7 +1,7 @@\n â”Š1â”Š1â”Šoverwrite: true\n â”Š2â”Š2â”Šgenerates:\n â”Š3â”Š3â”Š  ./types/graphql.d.ts:\n-â”Š4â”Š â”Š    schema: ./schema/typeDefs.graphql\n+â”Š â”Š4â”Š    schema: ./modules/*/index.ts\n â”Š5â”Š5â”Š    plugins:\n â”Š6â”Š6â”Š      - typescript\n â”Š7â”Š7â”Š      - typescript-resolvers\n```\n\n[}]: #\n\nWe no longer keep all type definitions in one place and all documents are wrapped with `gql` tag, the codegen is smart enough to find those.\n\n### Using Apollo Modules\n\nAn alternative to the previous solution and far more interesting is a module feature of Apollo Server.\n\nLet's see how it all might look like when using Apollo Server's modules:\n\n[{]: <helper> (diffStep \"13.2\" files=\"index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.2: Use Apollo Modules](https://github.com/Urigo/WhatsApp-Clone-Server/commit/991ad9ac02cf17beac14a06a922cb4b0bae38741)\n\n##### Changed index.ts\n```diff\n@@ -5,12 +5,15 @@\n â”Š 5â”Š 5â”Šimport { app } from './app';\n â”Š 6â”Š 6â”Šimport { pool } from './db';\n â”Š 7â”Š 7â”Šimport { origin, port, secret } from './env';\n-â”Š 8â”Š  â”Šimport schema from './schema';\n â”Š 9â”Š 8â”Šimport { MyContext } from './context';\n â”Š10â”Š 9â”Šimport sql from 'sql-template-strings';\n â”Š11â”Š10â”Šimport { UnsplashApi } from './schema/unsplash.api';\n â”Š12â”Š11â”Šconst { PostgresPubSub } = require('graphql-postgres-subscriptions');\n â”Š13â”Š12â”Š\n+â”Š  â”Š13â”Šimport * as commonModule from './modules/common';\n+â”Š  â”Š14â”Šimport * as usersModule from './modules/users';\n+â”Š  â”Š15â”Šimport * as chatsModule from './modules/chats';\n+â”Š  â”Š16â”Š\n â”Š14â”Š17â”Šconst pubsub = new PostgresPubSub({\n â”Š15â”Š18â”Š  host: 'localhost',\n â”Š16â”Š19â”Š  port: process.env.DB_PORT ? parseInt(process.env.DB_PORT) : 5432,\n```\n```diff\n@@ -19,7 +22,7 @@\n â”Š19â”Š22â”Š  database: 'whatsapp',\n â”Š20â”Š23â”Š});\n â”Š21â”Š24â”Šconst server = new ApolloServer({\n-â”Š22â”Š  â”Š  schema,\n+â”Š  â”Š25â”Š  modules: [commonModule, usersModule, chatsModule],\n â”Š23â”Š26â”Š  context: async (session: any) => {\n â”Š24â”Š27â”Š    // Access the request object\n â”Š25â”Š28â”Š    let req = session.connection\n```\n\n##### Deleted schema&#x2F;index.ts\n```diff\n@@ -1,15 +0,0 @@\n-â”Š 1â”Š  â”Šimport { makeExecutableSchema, IResolvers } from 'graphql-tools';\n-â”Š 2â”Š  â”Šimport { merge } from 'lodash';\n-â”Š 3â”Š  â”Šimport * as commonModule from '../modules/common';\n-â”Š 4â”Š  â”Šimport * as usersModule from '../modules/users';\n-â”Š 5â”Š  â”Šimport * as chatsModule from '../modules/chats';\n-â”Š 6â”Š  â”Š\n-â”Š 7â”Š  â”Šexport default makeExecutableSchema({\n-â”Š 8â”Š  â”Š  resolvers: merge(\n-â”Š 9â”Š  â”Š    {},\n-â”Š10â”Š  â”Š    commonModule.resolvers,\n-â”Š11â”Š  â”Š    usersModule.resolvers,\n-â”Š12â”Š  â”Š    chatsModule.resolvers\n-â”Š13â”Š  â”Š  ) as IResolvers,\n-â”Š14â”Š  â”Š  typeDefs: [commonModule.typeDefs, usersModule.typeDefs, chatsModule.typeDefs],\n-â”Š15â”Š  â”Š});\n```\n\n[}]: #\n\nThe `modules` of ApolloServer accepts an array of objects with `resolvers` and `typeDefs` properties. That's exactly what we exported and that's why we can use esmodules directly.\n\nBecause we no longer use `schema.ts`, let's remove it.\n\nIf you would run the server right now, you will see a lot of warnings about missing index signatures. It's definitely nothing to worry about and can be easily fixed by using `useIndexSignature` flag of codegen:\n\n[{]: <helper> (diffStep \"13.2\" files=\"codegen.yml\" module=\"server\")\n\n#### [__Server__ Step 13.2: Use Apollo Modules](https://github.com/Urigo/WhatsApp-Clone-Server/commit/991ad9ac02cf17beac14a06a922cb4b0bae38741)\n\n##### Changed codegen.yml\n```diff\n@@ -6,6 +6,7 @@\n â”Š 6â”Š 6â”Š      - typescript\n â”Š 7â”Š 7â”Š      - typescript-resolvers\n â”Š 8â”Š 8â”Š    config:\n+â”Š  â”Š 9â”Š      useIndexSignature: true\n â”Š 9â”Š10â”Š      contextType: ../context#MyContext\n â”Š10â”Š11â”Š      mappers:\n â”Š11â”Š12â”Š        # import { Message } from '../db'\n```\n\n[}]: #\n\nYou might ask how is that different from what we have already implemented. The code is a bit simpler because the merging part is done by Apollo Server. We get some helpful messages when type's definition is missing but one of the modules was extending it and also when there are duplicates. Apollo Modules are very straightforward and basic but maybe that's all you really need in a project.\n\n### Using GraphQL Modules\n\nThere's an another alternative option that forces good patterns and providess a nice to work with API. It's called GraphQL Modules.\nThe main goal is to help organize an API and allow to develop it across multiple teams.\n\nyarn add @graphql-modules/core\n\nSame as Apollo Server's modules, has useful warnings and messages but you can use it with any implementation of GraphQL server.\n\n```ts\nimport { GraphQLModule } from â€˜@graphql-modules/core';\n\nexport default = new GraphQLModule({\n  name: 'common',\n  typeDefs,\n  resolvers\n});\n```\n\nIt's a bit similar to what we have in Apollo Modules but as you probably noticed, it's wrapped within `GraphQLModule` class. The class manages a business logic, SDL, resolvers and dependencies between modules.\n\n> An important thing to be aware of, GraphQL Modules encapsulates every module. To get a better understanding, think of it as CSS Modules.\n\nNow that you know some basics, let's implement the simplest of all modules:\n\n[{]: <helper> (diffStep \"13.3\" files=\"modules/common/index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.3: Use GraphQL Modules](https://github.com/Urigo/WhatsApp-Clone-Server/commit/ff8c1a7bae4e107a5a7b75811f732f3e7626aa78)\n\n##### Changed modules&#x2F;common&#x2F;index.ts\n```diff\n@@ -1,8 +1,12 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š 1â”Š 2â”Šimport { gql } from 'apollo-server-express';\n â”Š 2â”Š 3â”Šimport { GraphQLDateTime } from 'graphql-iso-date';\n+â”Š  â”Š 4â”Šimport { pool } from '../../db';\n â”Š 3â”Š 5â”Šimport { Resolvers } from '../../types/graphql';\n â”Š 4â”Š 6â”Š\n-â”Š 5â”Š  â”Šexport const typeDefs = gql`\n+â”Š  â”Š 7â”Šconst { PostgresPubSub } = require('graphql-postgres-subscriptions');\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Šconst typeDefs = gql`\n â”Š 6â”Š10â”Š  scalar Date\n â”Š 7â”Š11â”Š\n â”Š 8â”Š12â”Š  type Query {\n```\n```diff\n@@ -18,6 +22,33 @@\n â”Š18â”Š22â”Š  }\n â”Š19â”Š23â”Š`;\n â”Š20â”Š24â”Š\n-â”Š21â”Š  â”Šexport const resolvers: Resolvers = {\n+â”Š  â”Š25â”Šconst resolvers: Resolvers = {\n â”Š22â”Š26â”Š  Date: GraphQLDateTime,\n â”Š23â”Š27â”Š};\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Šconst pubsub = new PostgresPubSub({\n+â”Š  â”Š30â”Š  host: 'localhost',\n+â”Š  â”Š31â”Š  port: process.env.DB_PORT ? parseInt(process.env.DB_PORT) : 5432,\n+â”Š  â”Š32â”Š  user: 'testuser',\n+â”Š  â”Š33â”Š  password: 'testpassword',\n+â”Š  â”Š34â”Š  database: 'whatsapp',\n+â”Š  â”Š35â”Š});\n+â”Š  â”Š36â”Š\n+â”Š  â”Š37â”Šexport default new GraphQLModule({\n+â”Š  â”Š38â”Š  name: 'common',\n+â”Š  â”Š39â”Š  typeDefs,\n+â”Š  â”Š40â”Š  resolvers,\n+â”Š  â”Š41â”Š  async context({ res, connection }) {\n+â”Š  â”Š42â”Š    let db;\n+â”Š  â”Š43â”Š\n+â”Š  â”Š44â”Š    if (!connection) {\n+â”Š  â”Š45â”Š      db = await pool.connect();\n+â”Š  â”Š46â”Š    }\n+â”Š  â”Š47â”Š\n+â”Š  â”Š48â”Š    return {\n+â”Š  â”Š49â”Š      pubsub,\n+â”Š  â”Š50â”Š      res,\n+â”Š  â”Š51â”Š      db,\n+â”Š  â”Š52â”Š    };\n+â”Š  â”Š53â”Š  },\n+â”Š  â”Š54â”Š});\n```\n\n[}]: #\n\nAs we mentioned, there's no global context so we moved the common parts into Common module.\n\nLet's take care of other two modules and migrate `modules/users/index.ts` first:\n\n[{]: <helper> (diffStep \"13.3\" files=\"modules/users/index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.3: Use GraphQL Modules](https://github.com/Urigo/WhatsApp-Clone-Server/commit/ff8c1a7bae4e107a5a7b75811f732f3e7626aa78)\n\n##### Changed modules&#x2F;users&#x2F;index.ts\n```diff\n@@ -1,12 +1,16 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š 1â”Š 2â”Šimport { gql } from 'apollo-server-express';\n+â”Š  â”Š 3â”Šimport cookie from 'cookie';\n â”Š 2â”Š 4â”Šimport sql from 'sql-template-strings';\n â”Š 3â”Š 5â”Šimport bcrypt from 'bcrypt';\n â”Š 4â”Š 6â”Šimport jwt from 'jsonwebtoken';\n+â”Š  â”Š 7â”Šimport commonModule from '../common';\n â”Š 5â”Š 8â”Šimport { secret, expiration } from '../../env';\n+â”Š  â”Š 9â”Šimport { pool } from '../../db';\n â”Š 6â”Š10â”Šimport { validateLength, validatePassword } from '../../validators';\n â”Š 7â”Š11â”Šimport { Resolvers } from '../../types/graphql';\n â”Š 8â”Š12â”Š\n-â”Š 9â”Š  â”Šexport const typeDefs = gql`\n+â”Š  â”Š13â”Šconst typeDefs = gql`\n â”Š10â”Š14â”Š  type User {\n â”Š11â”Š15â”Š    id: ID!\n â”Š12â”Š16â”Š    name: String!\n```\n```diff\n@@ -29,7 +33,7 @@\n â”Š29â”Š33â”Š  }\n â”Š30â”Š34â”Š`;\n â”Š31â”Š35â”Š\n-â”Š32â”Š  â”Šexport const resolvers: Resolvers = {\n+â”Š  â”Š36â”Šconst resolvers: Resolvers = {\n â”Š33â”Š37â”Š  Query: {\n â”Š34â”Š38â”Š    me(root, args, { currentUser }) {\n â”Š35â”Š39â”Š      return currentUser || null;\n```\n```diff\n@@ -98,3 +102,38 @@\n â”Š 98â”Š102â”Š    },\n â”Š 99â”Š103â”Š  },\n â”Š100â”Š104â”Š};\n+â”Š   â”Š105â”Š\n+â”Š   â”Š106â”Šexport default new GraphQLModule({\n+â”Š   â”Š107â”Š  name: 'users',\n+â”Š   â”Š108â”Š  typeDefs,\n+â”Š   â”Š109â”Š  resolvers,\n+â”Š   â”Š110â”Š  imports: () => [commonModule],\n+â”Š   â”Š111â”Š  async context(session) {\n+â”Š   â”Š112â”Š    let currentUser;\n+â”Š   â”Š113â”Š\n+â”Š   â”Š114â”Š    // Access the request object\n+â”Š   â”Š115â”Š    let req = session.connection\n+â”Š   â”Š116â”Š      ? session.connection.context.request\n+â”Š   â”Š117â”Š      : session.req;\n+â”Š   â”Š118â”Š\n+â”Š   â”Š119â”Š    // It's subscription\n+â”Š   â”Š120â”Š    if (session.connection) {\n+â”Š   â”Š121â”Š      req.cookies = cookie.parse(req.headers.cookie || '');\n+â”Š   â”Š122â”Š    }\n+â”Š   â”Š123â”Š\n+â”Š   â”Š124â”Š    if (req.cookies.authToken) {\n+â”Š   â”Š125â”Š      const username = jwt.verify(req.cookies.authToken, secret) as string;\n+â”Š   â”Š126â”Š\n+â”Š   â”Š127â”Š      if (username) {\n+â”Š   â”Š128â”Š        const { rows } = await pool.query(\n+â”Š   â”Š129â”Š          sql`SELECT * FROM users WHERE username = ${username}`\n+â”Š   â”Š130â”Š        );\n+â”Š   â”Š131â”Š        currentUser = rows[0];\n+â”Š   â”Š132â”Š      }\n+â”Š   â”Š133â”Š    }\n+â”Š   â”Š134â”Š\n+â”Š   â”Š135â”Š    return {\n+â”Š   â”Š136â”Š      currentUser,\n+â”Š   â”Š137â”Š    };\n+â”Š   â”Š138â”Š  },\n+â”Š   â”Š139â”Š});\n```\n\n[}]: #\n\nJust like with Common, we also moved related context but there's a totally new thing called `imports`. In order to let Users module see Common's contents (types, resolvers, context etc) we need to include it in the dependencies.\n\nNow `Chats` that depends on `Users` and `Common` modules:\n\n[{]: <helper> (diffStep \"13.3\" files=\"modules/chats/index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.3: Use GraphQL Modules](https://github.com/Urigo/WhatsApp-Clone-Server/commit/ff8c1a7bae4e107a5a7b75811f732f3e7626aa78)\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -1,9 +1,12 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š 1â”Š 2â”Šimport { gql, withFilter } from 'apollo-server-express';\n â”Š 2â”Š 3â”Šimport sql from 'sql-template-strings';\n+â”Š  â”Š 4â”Šimport commonModule from '../common';\n+â”Š  â”Š 5â”Šimport usersModule from '../users';\n â”Š 3â”Š 6â”Šimport { Message, Chat, pool } from '../../db';\n â”Š 4â”Š 7â”Šimport { Resolvers } from '../../types/graphql';\n â”Š 5â”Š 8â”Š\n-â”Š 6â”Š  â”Šexport const typeDefs = gql`\n+â”Š  â”Š 9â”Šconst typeDefs = gql`\n â”Š 7â”Š10â”Š  type Message {\n â”Š 8â”Š11â”Š    id: ID!\n â”Š 9â”Š12â”Š    content: String!\n```\n```diff\n@@ -41,7 +44,7 @@\n â”Š41â”Š44â”Š  }\n â”Š42â”Š45â”Š`;\n â”Š43â”Š46â”Š\n-â”Š44â”Š  â”Šexport const resolvers: Resolvers = {\n+â”Š  â”Š47â”Šconst resolvers: Resolvers = {\n â”Š45â”Š48â”Š  Message: {\n â”Š46â”Š49â”Š    createdAt(message) {\n â”Š47â”Š50â”Š      return new Date(message.created_at);\n```\n```diff\n@@ -325,3 +328,10 @@\n â”Š325â”Š328â”Š    },\n â”Š326â”Š329â”Š  },\n â”Š327â”Š330â”Š};\n+â”Š   â”Š331â”Š\n+â”Š   â”Š332â”Šexport default new GraphQLModule({\n+â”Š   â”Š333â”Š  name: 'chats',\n+â”Š   â”Š334â”Š  typeDefs,\n+â”Š   â”Š335â”Š  resolvers,\n+â”Š   â”Š336â”Š  imports: () => [commonModule, usersModule],\n+â”Š   â”Š337â”Š});\n```\n\n[}]: #\n\nSince every module is now a GraphQL Module, we can take care of how to use them in the ApolloServer.\n\nTo make things easier, we're going to create a module that's called `Root` and represents our API.\n\n```ts\nexport const rootModule = new GraphQLModule({\n  name: 'root',\n  imports: [usersModule, chatsModule],\n});\n```\n\nWe want to pass `schema` and `context` to ApolloServer:\n\n```ts\nconst server = new ApolloServer({\n  schema: rootModule.schema,\n  context: rootModule.context,\n  // ...\n```\n\nNow with all that knowledge, take a look at all changes at once:\n\n[{]: <helper> (diffStep \"13.3\" files=\"index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.3: Use GraphQL Modules](https://github.com/Urigo/WhatsApp-Clone-Server/commit/ff8c1a7bae4e107a5a7b75811f732f3e7626aa78)\n\n##### Changed index.ts\n```diff\n@@ -1,71 +1,23 @@\n â”Š 1â”Š 1â”Šimport { ApolloServer } from 'apollo-server-express';\n-â”Š 2â”Š  â”Šimport cookie from 'cookie';\n+â”Š  â”Š 2â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š 3â”Š 3â”Šimport http from 'http';\n-â”Š 4â”Š  â”Šimport jwt from 'jsonwebtoken';\n â”Š 5â”Š 4â”Šimport { app } from './app';\n-â”Š 6â”Š  â”Šimport { pool } from './db';\n-â”Š 7â”Š  â”Šimport { origin, port, secret } from './env';\n+â”Š  â”Š 5â”Šimport { origin, port } from './env';\n â”Š 8â”Š 6â”Šimport { MyContext } from './context';\n-â”Š 9â”Š  â”Šimport sql from 'sql-template-strings';\n â”Š10â”Š 7â”Šimport { UnsplashApi } from './schema/unsplash.api';\n-â”Š11â”Š  â”Šconst { PostgresPubSub } = require('graphql-postgres-subscriptions');\n â”Š12â”Š 8â”Š\n-â”Š13â”Š  â”Šimport * as commonModule from './modules/common';\n-â”Š14â”Š  â”Šimport * as usersModule from './modules/users';\n-â”Š15â”Š  â”Šimport * as chatsModule from './modules/chats';\n+â”Š  â”Š 9â”Šimport usersModule from './modules/users';\n+â”Š  â”Š10â”Šimport chatsModule from './modules/chats';\n â”Š16â”Š11â”Š\n-â”Š17â”Š  â”Šconst pubsub = new PostgresPubSub({\n-â”Š18â”Š  â”Š  host: 'localhost',\n-â”Š19â”Š  â”Š  port: process.env.DB_PORT ? parseInt(process.env.DB_PORT) : 5432,\n-â”Š20â”Š  â”Š  user: 'testuser',\n-â”Š21â”Š  â”Š  password: 'testpassword',\n-â”Š22â”Š  â”Š  database: 'whatsapp',\n+â”Š  â”Š12â”Šexport const rootModule = new GraphQLModule({\n+â”Š  â”Š13â”Š  name: 'root',\n+â”Š  â”Š14â”Š  imports: [usersModule, chatsModule],\n â”Š23â”Š15â”Š});\n-â”Š24â”Š  â”Šconst server = new ApolloServer({\n-â”Š25â”Š  â”Š  modules: [commonModule, usersModule, chatsModule],\n-â”Š26â”Š  â”Š  context: async (session: any) => {\n-â”Š27â”Š  â”Š    // Access the request object\n-â”Š28â”Š  â”Š    let req = session.connection\n-â”Š29â”Š  â”Š      ? session.connection.context.request\n-â”Š30â”Š  â”Š      : session.req;\n-â”Š31â”Š  â”Š\n-â”Š32â”Š  â”Š    // It's subscription\n-â”Š33â”Š  â”Š    if (session.connection) {\n-â”Š34â”Š  â”Š      req.cookies = cookie.parse(req.headers.cookie || '');\n-â”Š35â”Š  â”Š    }\n-â”Š36â”Š  â”Š\n-â”Š37â”Š  â”Š    let currentUser;\n-â”Š38â”Š  â”Š    if (req.cookies.authToken) {\n-â”Š39â”Š  â”Š      const username = jwt.verify(req.cookies.authToken, secret) as string;\n-â”Š40â”Š  â”Š      if (username) {\n-â”Š41â”Š  â”Š        const { rows } = await pool.query(\n-â”Š42â”Š  â”Š          sql`SELECT * FROM users WHERE username = ${username}`\n-â”Š43â”Š  â”Š        );\n-â”Š44â”Š  â”Š        currentUser = rows[0];\n-â”Š45â”Š  â”Š      }\n-â”Š46â”Š  â”Š    }\n-â”Š47â”Š  â”Š\n-â”Š48â”Š  â”Š    let db;\n â”Š49â”Š16â”Š\n-â”Š50â”Š  â”Š    if (!session.connection) {\n-â”Š51â”Š  â”Š      db = await pool.connect();\n-â”Š52â”Š  â”Š    }\n-â”Š53â”Š  â”Š\n-â”Š54â”Š  â”Š    return {\n-â”Š55â”Š  â”Š      currentUser,\n-â”Š56â”Š  â”Š      pubsub,\n-â”Š57â”Š  â”Š      db,\n-â”Š58â”Š  â”Š      res: session.res,\n-â”Š59â”Š  â”Š    };\n-â”Š60â”Š  â”Š  },\n-â”Š61â”Š  â”Š  subscriptions: {\n-â”Š62â”Š  â”Š    onConnect(params, ws, ctx) {\n-â”Š63â”Š  â”Š      // pass the request object to context\n-â”Š64â”Š  â”Š      return {\n-â”Š65â”Š  â”Š        request: ctx.request,\n-â”Š66â”Š  â”Š      };\n-â”Š67â”Š  â”Š    },\n-â”Š68â”Š  â”Š  },\n+â”Š  â”Š17â”Šconst server = new ApolloServer({\n+â”Š  â”Š18â”Š  schema: rootModule.schema,\n+â”Š  â”Š19â”Š  context: rootModule.context,\n+â”Š  â”Š20â”Š  subscriptions: rootModule.subscriptions,\n â”Š69â”Š21â”Š  formatResponse: (res: any, { context }: { context: MyContext }) => {\n â”Š70â”Š22â”Š    context.db.release();\n â”Š71â”Š23â”Š\n```\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -1,9 +1,12 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š 1â”Š 2â”Šimport { gql, withFilter } from 'apollo-server-express';\n â”Š 2â”Š 3â”Šimport sql from 'sql-template-strings';\n+â”Š  â”Š 4â”Šimport commonModule from '../common';\n+â”Š  â”Š 5â”Šimport usersModule from '../users';\n â”Š 3â”Š 6â”Šimport { Message, Chat, pool } from '../../db';\n â”Š 4â”Š 7â”Šimport { Resolvers } from '../../types/graphql';\n â”Š 5â”Š 8â”Š\n-â”Š 6â”Š  â”Šexport const typeDefs = gql`\n+â”Š  â”Š 9â”Šconst typeDefs = gql`\n â”Š 7â”Š10â”Š  type Message {\n â”Š 8â”Š11â”Š    id: ID!\n â”Š 9â”Š12â”Š    content: String!\n```\n```diff\n@@ -41,7 +44,7 @@\n â”Š41â”Š44â”Š  }\n â”Š42â”Š45â”Š`;\n â”Š43â”Š46â”Š\n-â”Š44â”Š  â”Šexport const resolvers: Resolvers = {\n+â”Š  â”Š47â”Šconst resolvers: Resolvers = {\n â”Š45â”Š48â”Š  Message: {\n â”Š46â”Š49â”Š    createdAt(message) {\n â”Š47â”Š50â”Š      return new Date(message.created_at);\n```\n```diff\n@@ -325,3 +328,10 @@\n â”Š325â”Š328â”Š    },\n â”Š326â”Š329â”Š  },\n â”Š327â”Š330â”Š};\n+â”Š   â”Š331â”Š\n+â”Š   â”Š332â”Šexport default new GraphQLModule({\n+â”Š   â”Š333â”Š  name: 'chats',\n+â”Š   â”Š334â”Š  typeDefs,\n+â”Š   â”Š335â”Š  resolvers,\n+â”Š   â”Š336â”Š  imports: () => [commonModule, usersModule],\n+â”Š   â”Š337â”Š});\n```\n\n##### Changed modules&#x2F;common&#x2F;index.ts\n```diff\n@@ -1,8 +1,12 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š 1â”Š 2â”Šimport { gql } from 'apollo-server-express';\n â”Š 2â”Š 3â”Šimport { GraphQLDateTime } from 'graphql-iso-date';\n+â”Š  â”Š 4â”Šimport { pool } from '../../db';\n â”Š 3â”Š 5â”Šimport { Resolvers } from '../../types/graphql';\n â”Š 4â”Š 6â”Š\n-â”Š 5â”Š  â”Šexport const typeDefs = gql`\n+â”Š  â”Š 7â”Šconst { PostgresPubSub } = require('graphql-postgres-subscriptions');\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Šconst typeDefs = gql`\n â”Š 6â”Š10â”Š  scalar Date\n â”Š 7â”Š11â”Š\n â”Š 8â”Š12â”Š  type Query {\n```\n```diff\n@@ -18,6 +22,33 @@\n â”Š18â”Š22â”Š  }\n â”Š19â”Š23â”Š`;\n â”Š20â”Š24â”Š\n-â”Š21â”Š  â”Šexport const resolvers: Resolvers = {\n+â”Š  â”Š25â”Šconst resolvers: Resolvers = {\n â”Š22â”Š26â”Š  Date: GraphQLDateTime,\n â”Š23â”Š27â”Š};\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Šconst pubsub = new PostgresPubSub({\n+â”Š  â”Š30â”Š  host: 'localhost',\n+â”Š  â”Š31â”Š  port: process.env.DB_PORT ? parseInt(process.env.DB_PORT) : 5432,\n+â”Š  â”Š32â”Š  user: 'testuser',\n+â”Š  â”Š33â”Š  password: 'testpassword',\n+â”Š  â”Š34â”Š  database: 'whatsapp',\n+â”Š  â”Š35â”Š});\n+â”Š  â”Š36â”Š\n+â”Š  â”Š37â”Šexport default new GraphQLModule({\n+â”Š  â”Š38â”Š  name: 'common',\n+â”Š  â”Š39â”Š  typeDefs,\n+â”Š  â”Š40â”Š  resolvers,\n+â”Š  â”Š41â”Š  async context({ res, connection }) {\n+â”Š  â”Š42â”Š    let db;\n+â”Š  â”Š43â”Š\n+â”Š  â”Š44â”Š    if (!connection) {\n+â”Š  â”Š45â”Š      db = await pool.connect();\n+â”Š  â”Š46â”Š    }\n+â”Š  â”Š47â”Š\n+â”Š  â”Š48â”Š    return {\n+â”Š  â”Š49â”Š      pubsub,\n+â”Š  â”Š50â”Š      res,\n+â”Š  â”Š51â”Š      db,\n+â”Š  â”Š52â”Š    };\n+â”Š  â”Š53â”Š  },\n+â”Š  â”Š54â”Š});\n```\n\n##### Changed modules&#x2F;users&#x2F;index.ts\n```diff\n@@ -1,12 +1,16 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š 1â”Š 2â”Šimport { gql } from 'apollo-server-express';\n+â”Š  â”Š 3â”Šimport cookie from 'cookie';\n â”Š 2â”Š 4â”Šimport sql from 'sql-template-strings';\n â”Š 3â”Š 5â”Šimport bcrypt from 'bcrypt';\n â”Š 4â”Š 6â”Šimport jwt from 'jsonwebtoken';\n+â”Š  â”Š 7â”Šimport commonModule from '../common';\n â”Š 5â”Š 8â”Šimport { secret, expiration } from '../../env';\n+â”Š  â”Š 9â”Šimport { pool } from '../../db';\n â”Š 6â”Š10â”Šimport { validateLength, validatePassword } from '../../validators';\n â”Š 7â”Š11â”Šimport { Resolvers } from '../../types/graphql';\n â”Š 8â”Š12â”Š\n-â”Š 9â”Š  â”Šexport const typeDefs = gql`\n+â”Š  â”Š13â”Šconst typeDefs = gql`\n â”Š10â”Š14â”Š  type User {\n â”Š11â”Š15â”Š    id: ID!\n â”Š12â”Š16â”Š    name: String!\n```\n```diff\n@@ -29,7 +33,7 @@\n â”Š29â”Š33â”Š  }\n â”Š30â”Š34â”Š`;\n â”Š31â”Š35â”Š\n-â”Š32â”Š  â”Šexport const resolvers: Resolvers = {\n+â”Š  â”Š36â”Šconst resolvers: Resolvers = {\n â”Š33â”Š37â”Š  Query: {\n â”Š34â”Š38â”Š    me(root, args, { currentUser }) {\n â”Š35â”Š39â”Š      return currentUser || null;\n```\n```diff\n@@ -98,3 +102,38 @@\n â”Š 98â”Š102â”Š    },\n â”Š 99â”Š103â”Š  },\n â”Š100â”Š104â”Š};\n+â”Š   â”Š105â”Š\n+â”Š   â”Š106â”Šexport default new GraphQLModule({\n+â”Š   â”Š107â”Š  name: 'users',\n+â”Š   â”Š108â”Š  typeDefs,\n+â”Š   â”Š109â”Š  resolvers,\n+â”Š   â”Š110â”Š  imports: () => [commonModule],\n+â”Š   â”Š111â”Š  async context(session) {\n+â”Š   â”Š112â”Š    let currentUser;\n+â”Š   â”Š113â”Š\n+â”Š   â”Š114â”Š    // Access the request object\n+â”Š   â”Š115â”Š    let req = session.connection\n+â”Š   â”Š116â”Š      ? session.connection.context.request\n+â”Š   â”Š117â”Š      : session.req;\n+â”Š   â”Š118â”Š\n+â”Š   â”Š119â”Š    // It's subscription\n+â”Š   â”Š120â”Š    if (session.connection) {\n+â”Š   â”Š121â”Š      req.cookies = cookie.parse(req.headers.cookie || '');\n+â”Š   â”Š122â”Š    }\n+â”Š   â”Š123â”Š\n+â”Š   â”Š124â”Š    if (req.cookies.authToken) {\n+â”Š   â”Š125â”Š      const username = jwt.verify(req.cookies.authToken, secret) as string;\n+â”Š   â”Š126â”Š\n+â”Š   â”Š127â”Š      if (username) {\n+â”Š   â”Š128â”Š        const { rows } = await pool.query(\n+â”Š   â”Š129â”Š          sql`SELECT * FROM users WHERE username = ${username}`\n+â”Š   â”Š130â”Š        );\n+â”Š   â”Š131â”Š        currentUser = rows[0];\n+â”Š   â”Š132â”Š      }\n+â”Š   â”Š133â”Š    }\n+â”Š   â”Š134â”Š\n+â”Š   â”Š135â”Š    return {\n+â”Š   â”Š136â”Š      currentUser,\n+â”Š   â”Š137â”Š    };\n+â”Š   â”Š138â”Š  },\n+â”Š   â”Š139â”Š});\n```\n\n[}]: #\n\n#### Migrate Unsplash API to Chats\n\nWe still make use of global context which won't work with GraphQL Modules. To be more specific, it's not the context definition itself but the thing that's being added by ApolloServer, Data Sources.\n\nThe `RESTDataSource` is of course more than a class but in case of Unsplash API we won't loose any important features except the HTTP client. We're going to use `axios` instead:\n\nyarn add axios\n\nWe've got everything now so let's migrate UnsplashAPI class and move it from `schema/unsplash.api.ts` under `modules/chats`!\n\n[{]: <helper> (diffStep \"13.3\" files=\"modules/chats/unsplash.api.ts\" module=\"server\")\n\n#### [__Server__ Step 13.3: Use GraphQL Modules](https://github.com/Urigo/WhatsApp-Clone-Server/commit/ff8c1a7bae4e107a5a7b75811f732f3e7626aa78)\n\n\n\n[}]: #\n\nThere is no big differences between now and what we had before, the only thing that's changed is the way we make http requests.\n\nThe `UnsplashAPI` can be now removed from `dataSources` and moved under Chats module's context:\n\n[{]: <helper> (diffStep \"13.3\" files=\"index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.3: Use GraphQL Modules](https://github.com/Urigo/WhatsApp-Clone-Server/commit/ff8c1a7bae4e107a5a7b75811f732f3e7626aa78)\n\n##### Changed index.ts\n```diff\n@@ -1,71 +1,23 @@\n â”Š 1â”Š 1â”Šimport { ApolloServer } from 'apollo-server-express';\n-â”Š 2â”Š  â”Šimport cookie from 'cookie';\n+â”Š  â”Š 2â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š 3â”Š 3â”Šimport http from 'http';\n-â”Š 4â”Š  â”Šimport jwt from 'jsonwebtoken';\n â”Š 5â”Š 4â”Šimport { app } from './app';\n-â”Š 6â”Š  â”Šimport { pool } from './db';\n-â”Š 7â”Š  â”Šimport { origin, port, secret } from './env';\n+â”Š  â”Š 5â”Šimport { origin, port } from './env';\n â”Š 8â”Š 6â”Šimport { MyContext } from './context';\n-â”Š 9â”Š  â”Šimport sql from 'sql-template-strings';\n â”Š10â”Š 7â”Šimport { UnsplashApi } from './schema/unsplash.api';\n-â”Š11â”Š  â”Šconst { PostgresPubSub } = require('graphql-postgres-subscriptions');\n â”Š12â”Š 8â”Š\n-â”Š13â”Š  â”Šimport * as commonModule from './modules/common';\n-â”Š14â”Š  â”Šimport * as usersModule from './modules/users';\n-â”Š15â”Š  â”Šimport * as chatsModule from './modules/chats';\n+â”Š  â”Š 9â”Šimport usersModule from './modules/users';\n+â”Š  â”Š10â”Šimport chatsModule from './modules/chats';\n â”Š16â”Š11â”Š\n-â”Š17â”Š  â”Šconst pubsub = new PostgresPubSub({\n-â”Š18â”Š  â”Š  host: 'localhost',\n-â”Š19â”Š  â”Š  port: process.env.DB_PORT ? parseInt(process.env.DB_PORT) : 5432,\n-â”Š20â”Š  â”Š  user: 'testuser',\n-â”Š21â”Š  â”Š  password: 'testpassword',\n-â”Š22â”Š  â”Š  database: 'whatsapp',\n+â”Š  â”Š12â”Šexport const rootModule = new GraphQLModule({\n+â”Š  â”Š13â”Š  name: 'root',\n+â”Š  â”Š14â”Š  imports: [usersModule, chatsModule],\n â”Š23â”Š15â”Š});\n-â”Š24â”Š  â”Šconst server = new ApolloServer({\n-â”Š25â”Š  â”Š  modules: [commonModule, usersModule, chatsModule],\n-â”Š26â”Š  â”Š  context: async (session: any) => {\n-â”Š27â”Š  â”Š    // Access the request object\n-â”Š28â”Š  â”Š    let req = session.connection\n-â”Š29â”Š  â”Š      ? session.connection.context.request\n-â”Š30â”Š  â”Š      : session.req;\n-â”Š31â”Š  â”Š\n-â”Š32â”Š  â”Š    // It's subscription\n-â”Š33â”Š  â”Š    if (session.connection) {\n-â”Š34â”Š  â”Š      req.cookies = cookie.parse(req.headers.cookie || '');\n-â”Š35â”Š  â”Š    }\n-â”Š36â”Š  â”Š\n-â”Š37â”Š  â”Š    let currentUser;\n-â”Š38â”Š  â”Š    if (req.cookies.authToken) {\n-â”Š39â”Š  â”Š      const username = jwt.verify(req.cookies.authToken, secret) as string;\n-â”Š40â”Š  â”Š      if (username) {\n-â”Š41â”Š  â”Š        const { rows } = await pool.query(\n-â”Š42â”Š  â”Š          sql`SELECT * FROM users WHERE username = ${username}`\n-â”Š43â”Š  â”Š        );\n-â”Š44â”Š  â”Š        currentUser = rows[0];\n-â”Š45â”Š  â”Š      }\n-â”Š46â”Š  â”Š    }\n-â”Š47â”Š  â”Š\n-â”Š48â”Š  â”Š    let db;\n â”Š49â”Š16â”Š\n-â”Š50â”Š  â”Š    if (!session.connection) {\n-â”Š51â”Š  â”Š      db = await pool.connect();\n-â”Š52â”Š  â”Š    }\n-â”Š53â”Š  â”Š\n-â”Š54â”Š  â”Š    return {\n-â”Š55â”Š  â”Š      currentUser,\n-â”Š56â”Š  â”Š      pubsub,\n-â”Š57â”Š  â”Š      db,\n-â”Š58â”Š  â”Š      res: session.res,\n-â”Š59â”Š  â”Š    };\n-â”Š60â”Š  â”Š  },\n-â”Š61â”Š  â”Š  subscriptions: {\n-â”Š62â”Š  â”Š    onConnect(params, ws, ctx) {\n-â”Š63â”Š  â”Š      // pass the request object to context\n-â”Š64â”Š  â”Š      return {\n-â”Š65â”Š  â”Š        request: ctx.request,\n-â”Š66â”Š  â”Š      };\n-â”Š67â”Š  â”Š    },\n-â”Š68â”Š  â”Š  },\n+â”Š  â”Š17â”Šconst server = new ApolloServer({\n+â”Š  â”Š18â”Š  schema: rootModule.schema,\n+â”Š  â”Š19â”Š  context: rootModule.context,\n+â”Š  â”Š20â”Š  subscriptions: rootModule.subscriptions,\n â”Š69â”Š21â”Š  formatResponse: (res: any, { context }: { context: MyContext }) => {\n â”Š70â”Š22â”Š    context.db.release();\n â”Š71â”Š23â”Š\n```\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -1,9 +1,12 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š 1â”Š 2â”Šimport { gql, withFilter } from 'apollo-server-express';\n â”Š 2â”Š 3â”Šimport sql from 'sql-template-strings';\n+â”Š  â”Š 4â”Šimport commonModule from '../common';\n+â”Š  â”Š 5â”Šimport usersModule from '../users';\n â”Š 3â”Š 6â”Šimport { Message, Chat, pool } from '../../db';\n â”Š 4â”Š 7â”Šimport { Resolvers } from '../../types/graphql';\n â”Š 5â”Š 8â”Š\n-â”Š 6â”Š  â”Šexport const typeDefs = gql`\n+â”Š  â”Š 9â”Šconst typeDefs = gql`\n â”Š 7â”Š10â”Š  type Message {\n â”Š 8â”Š11â”Š    id: ID!\n â”Š 9â”Š12â”Š    content: String!\n```\n```diff\n@@ -41,7 +44,7 @@\n â”Š41â”Š44â”Š  }\n â”Š42â”Š45â”Š`;\n â”Š43â”Š46â”Š\n-â”Š44â”Š  â”Šexport const resolvers: Resolvers = {\n+â”Š  â”Š47â”Šconst resolvers: Resolvers = {\n â”Š45â”Š48â”Š  Message: {\n â”Š46â”Š49â”Š    createdAt(message) {\n â”Š47â”Š50â”Š      return new Date(message.created_at);\n```\n```diff\n@@ -325,3 +328,10 @@\n â”Š325â”Š328â”Š    },\n â”Š326â”Š329â”Š  },\n â”Š327â”Š330â”Š};\n+â”Š   â”Š331â”Š\n+â”Š   â”Š332â”Šexport default new GraphQLModule({\n+â”Š   â”Š333â”Š  name: 'chats',\n+â”Š   â”Š334â”Š  typeDefs,\n+â”Š   â”Š335â”Š  resolvers,\n+â”Š   â”Š336â”Š  imports: () => [commonModule, usersModule],\n+â”Š   â”Š337â”Š});\n```\n\n##### Changed modules&#x2F;common&#x2F;index.ts\n```diff\n@@ -1,8 +1,12 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š 1â”Š 2â”Šimport { gql } from 'apollo-server-express';\n â”Š 2â”Š 3â”Šimport { GraphQLDateTime } from 'graphql-iso-date';\n+â”Š  â”Š 4â”Šimport { pool } from '../../db';\n â”Š 3â”Š 5â”Šimport { Resolvers } from '../../types/graphql';\n â”Š 4â”Š 6â”Š\n-â”Š 5â”Š  â”Šexport const typeDefs = gql`\n+â”Š  â”Š 7â”Šconst { PostgresPubSub } = require('graphql-postgres-subscriptions');\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Šconst typeDefs = gql`\n â”Š 6â”Š10â”Š  scalar Date\n â”Š 7â”Š11â”Š\n â”Š 8â”Š12â”Š  type Query {\n```\n```diff\n@@ -18,6 +22,33 @@\n â”Š18â”Š22â”Š  }\n â”Š19â”Š23â”Š`;\n â”Š20â”Š24â”Š\n-â”Š21â”Š  â”Šexport const resolvers: Resolvers = {\n+â”Š  â”Š25â”Šconst resolvers: Resolvers = {\n â”Š22â”Š26â”Š  Date: GraphQLDateTime,\n â”Š23â”Š27â”Š};\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Šconst pubsub = new PostgresPubSub({\n+â”Š  â”Š30â”Š  host: 'localhost',\n+â”Š  â”Š31â”Š  port: process.env.DB_PORT ? parseInt(process.env.DB_PORT) : 5432,\n+â”Š  â”Š32â”Š  user: 'testuser',\n+â”Š  â”Š33â”Š  password: 'testpassword',\n+â”Š  â”Š34â”Š  database: 'whatsapp',\n+â”Š  â”Š35â”Š});\n+â”Š  â”Š36â”Š\n+â”Š  â”Š37â”Šexport default new GraphQLModule({\n+â”Š  â”Š38â”Š  name: 'common',\n+â”Š  â”Š39â”Š  typeDefs,\n+â”Š  â”Š40â”Š  resolvers,\n+â”Š  â”Š41â”Š  async context({ res, connection }) {\n+â”Š  â”Š42â”Š    let db;\n+â”Š  â”Š43â”Š\n+â”Š  â”Š44â”Š    if (!connection) {\n+â”Š  â”Š45â”Š      db = await pool.connect();\n+â”Š  â”Š46â”Š    }\n+â”Š  â”Š47â”Š\n+â”Š  â”Š48â”Š    return {\n+â”Š  â”Š49â”Š      pubsub,\n+â”Š  â”Š50â”Š      res,\n+â”Š  â”Š51â”Š      db,\n+â”Š  â”Š52â”Š    };\n+â”Š  â”Š53â”Š  },\n+â”Š  â”Š54â”Š});\n```\n\n##### Changed modules&#x2F;users&#x2F;index.ts\n```diff\n@@ -1,12 +1,16 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š 1â”Š 2â”Šimport { gql } from 'apollo-server-express';\n+â”Š  â”Š 3â”Šimport cookie from 'cookie';\n â”Š 2â”Š 4â”Šimport sql from 'sql-template-strings';\n â”Š 3â”Š 5â”Šimport bcrypt from 'bcrypt';\n â”Š 4â”Š 6â”Šimport jwt from 'jsonwebtoken';\n+â”Š  â”Š 7â”Šimport commonModule from '../common';\n â”Š 5â”Š 8â”Šimport { secret, expiration } from '../../env';\n+â”Š  â”Š 9â”Šimport { pool } from '../../db';\n â”Š 6â”Š10â”Šimport { validateLength, validatePassword } from '../../validators';\n â”Š 7â”Š11â”Šimport { Resolvers } from '../../types/graphql';\n â”Š 8â”Š12â”Š\n-â”Š 9â”Š  â”Šexport const typeDefs = gql`\n+â”Š  â”Š13â”Šconst typeDefs = gql`\n â”Š10â”Š14â”Š  type User {\n â”Š11â”Š15â”Š    id: ID!\n â”Š12â”Š16â”Š    name: String!\n```\n```diff\n@@ -29,7 +33,7 @@\n â”Š29â”Š33â”Š  }\n â”Š30â”Š34â”Š`;\n â”Š31â”Š35â”Š\n-â”Š32â”Š  â”Šexport const resolvers: Resolvers = {\n+â”Š  â”Š36â”Šconst resolvers: Resolvers = {\n â”Š33â”Š37â”Š  Query: {\n â”Š34â”Š38â”Š    me(root, args, { currentUser }) {\n â”Š35â”Š39â”Š      return currentUser || null;\n```\n```diff\n@@ -98,3 +102,38 @@\n â”Š 98â”Š102â”Š    },\n â”Š 99â”Š103â”Š  },\n â”Š100â”Š104â”Š};\n+â”Š   â”Š105â”Š\n+â”Š   â”Š106â”Šexport default new GraphQLModule({\n+â”Š   â”Š107â”Š  name: 'users',\n+â”Š   â”Š108â”Š  typeDefs,\n+â”Š   â”Š109â”Š  resolvers,\n+â”Š   â”Š110â”Š  imports: () => [commonModule],\n+â”Š   â”Š111â”Š  async context(session) {\n+â”Š   â”Š112â”Š    let currentUser;\n+â”Š   â”Š113â”Š\n+â”Š   â”Š114â”Š    // Access the request object\n+â”Š   â”Š115â”Š    let req = session.connection\n+â”Š   â”Š116â”Š      ? session.connection.context.request\n+â”Š   â”Š117â”Š      : session.req;\n+â”Š   â”Š118â”Š\n+â”Š   â”Š119â”Š    // It's subscription\n+â”Š   â”Š120â”Š    if (session.connection) {\n+â”Š   â”Š121â”Š      req.cookies = cookie.parse(req.headers.cookie || '');\n+â”Š   â”Š122â”Š    }\n+â”Š   â”Š123â”Š\n+â”Š   â”Š124â”Š    if (req.cookies.authToken) {\n+â”Š   â”Š125â”Š      const username = jwt.verify(req.cookies.authToken, secret) as string;\n+â”Š   â”Š126â”Š\n+â”Š   â”Š127â”Š      if (username) {\n+â”Š   â”Š128â”Š        const { rows } = await pool.query(\n+â”Š   â”Š129â”Š          sql`SELECT * FROM users WHERE username = ${username}`\n+â”Š   â”Š130â”Š        );\n+â”Š   â”Š131â”Š        currentUser = rows[0];\n+â”Š   â”Š132â”Š      }\n+â”Š   â”Š133â”Š    }\n+â”Š   â”Š134â”Š\n+â”Š   â”Š135â”Š    return {\n+â”Š   â”Š136â”Š      currentUser,\n+â”Š   â”Š137â”Š    };\n+â”Š   â”Š138â”Š  },\n+â”Š   â”Š139â”Š});\n```\n\n[}]: #\n\n[{]: <helper> (diffStep \"13.3\" files=\"context.ts\" module=\"server\")\n\n#### [__Server__ Step 13.3: Use GraphQL Modules](https://github.com/Urigo/WhatsApp-Clone-Server/commit/ff8c1a7bae4e107a5a7b75811f732f3e7626aa78)\n\n\n\n[}]: #\n\n[{]: <helper> (diffStep \"13.3\" files=\"modules/chats/index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.3: Use GraphQL Modules](https://github.com/Urigo/WhatsApp-Clone-Server/commit/ff8c1a7bae4e107a5a7b75811f732f3e7626aa78)\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -1,9 +1,12 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š 1â”Š 2â”Šimport { gql, withFilter } from 'apollo-server-express';\n â”Š 2â”Š 3â”Šimport sql from 'sql-template-strings';\n+â”Š  â”Š 4â”Šimport commonModule from '../common';\n+â”Š  â”Š 5â”Šimport usersModule from '../users';\n â”Š 3â”Š 6â”Šimport { Message, Chat, pool } from '../../db';\n â”Š 4â”Š 7â”Šimport { Resolvers } from '../../types/graphql';\n â”Š 5â”Š 8â”Š\n-â”Š 6â”Š  â”Šexport const typeDefs = gql`\n+â”Š  â”Š 9â”Šconst typeDefs = gql`\n â”Š 7â”Š10â”Š  type Message {\n â”Š 8â”Š11â”Š    id: ID!\n â”Š 9â”Š12â”Š    content: String!\n```\n```diff\n@@ -41,7 +44,7 @@\n â”Š41â”Š44â”Š  }\n â”Š42â”Š45â”Š`;\n â”Š43â”Š46â”Š\n-â”Š44â”Š  â”Šexport const resolvers: Resolvers = {\n+â”Š  â”Š47â”Šconst resolvers: Resolvers = {\n â”Š45â”Š48â”Š  Message: {\n â”Š46â”Š49â”Š    createdAt(message) {\n â”Š47â”Š50â”Š      return new Date(message.created_at);\n```\n```diff\n@@ -325,3 +328,10 @@\n â”Š325â”Š328â”Š    },\n â”Š326â”Š329â”Š  },\n â”Š327â”Š330â”Š};\n+â”Š   â”Š331â”Š\n+â”Š   â”Š332â”Šexport default new GraphQLModule({\n+â”Š   â”Š333â”Š  name: 'chats',\n+â”Š   â”Š334â”Š  typeDefs,\n+â”Š   â”Š335â”Š  resolvers,\n+â”Š   â”Š336â”Š  imports: () => [commonModule, usersModule],\n+â”Š   â”Š337â”Š});\n```\n\n[}]: #\n\n#### Dependency Injection in GraphQL Modules\n\nThe major feature of GraphQL Modules is the Dependency Injection. It's optional, you don't have to use it until it's really necessary. Even though WhatsApp clone doesn't need it yet, we're going to talk about DI and implement a simple thing, just for educational purpose.\n\nIf you're familiar with Dependency Injection then you will get it straight away. If not, please read about it here or here (**links**).\n\nTo start working with DI, we we need to install two packages:\n\nyarn add @graphql-modules/di reflect-metadata\n\nLet's now adjust the context type and import `reflect-metadata` into the project:\n\n[{]: <helper> (diffStep \"13.5\" files=\"context.ts\" module=\"server\")\n\n#### [__Server__ Step 13.5: Use Dependency Injection](https://github.com/Urigo/WhatsApp-Clone-Server/commit/dfe0303e3362a46201c59a0caca111aaed8c1d84)\n\n##### Changed context.ts\n```diff\n@@ -1,13 +1,12 @@\n â”Š 1â”Š 1â”Šimport { PubSub } from 'apollo-server-express';\n+â”Š  â”Š 2â”Šimport { ModuleContext } from '@graphql-modules/core';\n â”Š 2â”Š 3â”Šimport { User } from './db';\n â”Š 3â”Š 4â”Šimport { Response } from 'express';\n â”Š 4â”Š 5â”Šimport { PoolClient } from 'pg';\n-â”Š 5â”Š  â”Šimport { UnsplashApi } from './modules/chats/unsplash.api';\n â”Š 6â”Š 6â”Š\n â”Š 7â”Š 7â”Šexport type MyContext = {\n â”Š 8â”Š 8â”Š  pubsub: PubSub;\n â”Š 9â”Š 9â”Š  currentUser: User;\n â”Š10â”Š10â”Š  res: Response;\n â”Š11â”Š11â”Š  db: PoolClient;\n-â”Š12â”Š  â”Š  unsplashApi: UnsplashApi;\n-â”Š13â”Š  â”Š};\n+â”Š  â”Š12â”Š} & ModuleContext;\n```\n\n[}]: #\n\n[{]: <helper> (diffStep \"13.5\" files=\"index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.5: Use Dependency Injection](https://github.com/Urigo/WhatsApp-Clone-Server/commit/dfe0303e3362a46201c59a0caca111aaed8c1d84)\n\n##### Changed index.ts\n```diff\n@@ -1,3 +1,4 @@\n+â”Š â”Š1â”Šimport 'reflect-metadata';\n â”Š1â”Š2â”Šimport { ApolloServer } from 'apollo-server-express';\n â”Š2â”Š3â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š3â”Š4â”Šimport http from 'http';\n```\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -11,7 +11,7 @@\n â”Š11â”Š11â”Š  type Message {\n â”Š12â”Š12â”Š    id: ID!\n â”Š13â”Š13â”Š    content: String!\n-â”Š14â”Š  â”Š    createdAt: Date!\n+â”Š  â”Š14â”Š    createdAt: DateTime!\n â”Š15â”Š15â”Š    chat: Chat\n â”Š16â”Š16â”Š    sender: User\n â”Š17â”Š17â”Š    recipient: User\n```\n```diff\n@@ -94,7 +94,7 @@\n â”Š 94â”Š 94â”Š      return participant ? participant.name : null;\n â”Š 95â”Š 95â”Š    },\n â”Š 96â”Š 96â”Š\n-â”Š 97â”Š   â”Š    async picture(chat, args, { currentUser, db, unsplashApi }) {\n+â”Š   â”Š 97â”Š    async picture(chat, args, { currentUser, db, injector }) {\n â”Š 98â”Š 98â”Š      if (!currentUser) return null;\n â”Š 99â”Š 99â”Š\n â”Š100â”Š100â”Š      const { rows } = await db.query(sql`\n```\n```diff\n@@ -107,7 +107,7 @@\n â”Š107â”Š107â”Š\n â”Š108â”Š108â”Š      return participant && participant.picture\n â”Š109â”Š109â”Š        ? participant.picture\n-â”Š110â”Š   â”Š        : unsplashApi.getRandomPhoto();\n+â”Š   â”Š110â”Š        : injector.get(UnsplashApi).getRandomPhoto();\n â”Š111â”Š111â”Š    },\n â”Š112â”Š112â”Š\n â”Š113â”Š113â”Š    async messages(chat, args, { db }) {\n```\n```diff\n@@ -335,9 +335,5 @@\n â”Š335â”Š335â”Š  typeDefs,\n â”Š336â”Š336â”Š  resolvers,\n â”Š337â”Š337â”Š  imports: () => [commonModule, usersModule],\n-â”Š338â”Š   â”Š  context() {\n-â”Š339â”Š   â”Š    return {\n-â”Š340â”Š   â”Š      unsplashApi: new UnsplashApi(),\n-â”Š341â”Š   â”Š    };\n-â”Š342â”Š   â”Š  },\n+â”Š   â”Š338â”Š  providers: () => [UnsplashApi],\n â”Š343â”Š339â”Š});\n```\n\n##### Changed modules&#x2F;common&#x2F;index.ts\n```diff\n@@ -7,7 +7,7 @@\n â”Š 7â”Š 7â”Šconst { PostgresPubSub } = require('graphql-postgres-subscriptions');\n â”Š 8â”Š 8â”Š\n â”Š 9â”Š 9â”Šconst typeDefs = gql`\n-â”Š10â”Š  â”Š  scalar Date\n+â”Š  â”Š10â”Š  scalar DateTime\n â”Š11â”Š11â”Š\n â”Š12â”Š12â”Š  type Query {\n â”Š13â”Š13â”Š    _dummy: Boolean\n```\n```diff\n@@ -23,7 +23,7 @@\n â”Š23â”Š23â”Š`;\n â”Š24â”Š24â”Š\n â”Š25â”Š25â”Šconst resolvers: Resolvers = {\n-â”Š26â”Š  â”Š  Date: GraphQLDateTime,\n+â”Š  â”Š26â”Š  DateTime: GraphQLDateTime,\n â”Š27â”Š27â”Š};\n â”Š28â”Š28â”Š\n â”Š29â”Š29â”Šconst pubsub = new PostgresPubSub({\n```\n\n[}]: #\n\nIn short, Iependency Injection will instantiate classes, manage dependencies between them and so on and in addition to that, the GraphQL Modules allows to define when each provider / class should be created. We call it scopes.\n\n- Application scope - provider is created when application starts (default)\n- Session - providers are constructed in the beginning of the network request, then kept until the network request is closed\n- Request - creates an instance each time you request it from the injector\n\nBecause our `UnsplashApi` doesn't have to be recreated on every request, we can easily use Application scope, which is the default. The `Injectable` decorator is just to attach some metadata to the class.\n\n[{]: <helper> (diffStep \"13.5\" files=\"modules/chats/unsplash.api.ts\" module=\"server\")\n\n#### [__Server__ Step 13.5: Use Dependency Injection](https://github.com/Urigo/WhatsApp-Clone-Server/commit/dfe0303e3362a46201c59a0caca111aaed8c1d84)\n\n##### Changed modules&#x2F;chats&#x2F;unsplash.api.ts\n```diff\n@@ -1,3 +1,4 @@\n+â”Š â”Š1â”Šimport { Injectable, ProviderScope } from '@graphql-modules/di';\n â”Š1â”Š2â”Šimport { resolve } from 'path';\n â”Š2â”Š3â”Šimport axios from 'axios';\n â”Š3â”Š4â”Šimport { trackProvider } from '@safe-api/middleware';\n```\n```diff\n@@ -8,6 +9,9 @@\n â”Š 8â”Š 9â”Š  orientation: 'landscape' | 'portrait' | 'squarish';\n â”Š 9â”Š10â”Š}\n â”Š10â”Š11â”Š\n+â”Š  â”Š12â”Š@Injectable({\n+â”Š  â”Š13â”Š  scope: ProviderScope.Application,\n+â”Š  â”Š14â”Š})\n â”Š11â”Š15â”Šexport class UnsplashApi {\n â”Š12â”Š16â”Š  baseURL = 'https://api.unsplash.com/';\n â”Š13â”Š17â”Š\n```\n\n[}]: #\n\nHere's how to register the UnsplashApi provider in Chats module:\n\n[{]: <helper> (diffStep \"13.5\" files=\"modules/chats/index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.5: Use Dependency Injection](https://github.com/Urigo/WhatsApp-Clone-Server/commit/dfe0303e3362a46201c59a0caca111aaed8c1d84)\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -11,7 +11,7 @@\n â”Š11â”Š11â”Š  type Message {\n â”Š12â”Š12â”Š    id: ID!\n â”Š13â”Š13â”Š    content: String!\n-â”Š14â”Š  â”Š    createdAt: Date!\n+â”Š  â”Š14â”Š    createdAt: DateTime!\n â”Š15â”Š15â”Š    chat: Chat\n â”Š16â”Š16â”Š    sender: User\n â”Š17â”Š17â”Š    recipient: User\n```\n```diff\n@@ -94,7 +94,7 @@\n â”Š 94â”Š 94â”Š      return participant ? participant.name : null;\n â”Š 95â”Š 95â”Š    },\n â”Š 96â”Š 96â”Š\n-â”Š 97â”Š   â”Š    async picture(chat, args, { currentUser, db, unsplashApi }) {\n+â”Š   â”Š 97â”Š    async picture(chat, args, { currentUser, db, injector }) {\n â”Š 98â”Š 98â”Š      if (!currentUser) return null;\n â”Š 99â”Š 99â”Š\n â”Š100â”Š100â”Š      const { rows } = await db.query(sql`\n```\n```diff\n@@ -107,7 +107,7 @@\n â”Š107â”Š107â”Š\n â”Š108â”Š108â”Š      return participant && participant.picture\n â”Š109â”Š109â”Š        ? participant.picture\n-â”Š110â”Š   â”Š        : unsplashApi.getRandomPhoto();\n+â”Š   â”Š110â”Š        : injector.get(UnsplashApi).getRandomPhoto();\n â”Š111â”Š111â”Š    },\n â”Š112â”Š112â”Š\n â”Š113â”Š113â”Š    async messages(chat, args, { db }) {\n```\n```diff\n@@ -335,9 +335,5 @@\n â”Š335â”Š335â”Š  typeDefs,\n â”Š336â”Š336â”Š  resolvers,\n â”Š337â”Š337â”Š  imports: () => [commonModule, usersModule],\n-â”Š338â”Š   â”Š  context() {\n-â”Š339â”Š   â”Š    return {\n-â”Š340â”Š   â”Š      unsplashApi: new UnsplashApi(),\n-â”Š341â”Š   â”Š    };\n-â”Š342â”Š   â”Š  },\n+â”Š   â”Š338â”Š  providers: () => [UnsplashApi],\n â”Š343â”Š339â”Š});\n```\n\n[}]: #\n\nPlease also take a look at `injector.get(UnsplashApi)` part. There's `injector` instance in every module's context that allows to consume providers and everything that is defined within DI. You simply pass a class / token to the `get` method and GraphQL Modules takes care of the rest.\n\n**What are the benefits of DI?**\n\nYou can have a different implementation of Users based on the same interface. Maybe right now you're using PostgreSQL but at some point a project will be migrated to MongoDB. You could do it through GraphQL context, of course but with Dependency Injection, GraphQL Modules is able to tell you exactly what's missing and where. It reduces boiler plate because instantiation is done by the injector, code is loosely coupled.\n\nHelps maintainability but also comes with few disadvantages. It's a bit complex concept to learn and what could be done on compile time (TypeScript) is moved to run-time.\n\nYou might find DI useful while testing. Let's say you want to test a query that involves `UnsplashApi` provider, you simply replace it with a mocked version without touching the context or internals and you get the expected result every single time.\n\nWe know there's only one provider by far, the `UnsplashApi`, but we're going to implement more and more in following steps.\n\n#### Continuing with DI\n\nWe want to have everything easily accesible and DI helps with that so let's move on and continue migrating things.\n\nOne of the shared objects is database connection and we're going to create a Database provider:\n\n[{]: <helper> (diffStep \"13.6\" files=\"modules/common/database.provider.ts\" module=\"server\")\n\n#### [__Server__ Step 13.6: Define Database provider](https://github.com/Urigo/WhatsApp-Clone-Server/commit/06de9e072077b513496c1588ffbc7ad5461b4c90)\n\n##### Added modules&#x2F;common&#x2F;database.provider.ts\n```diff\n@@ -0,0 +1,26 @@\n+â”Š  â”Š 1â”Šimport { Injectable, ProviderScope } from '@graphql-modules/di';\n+â”Š  â”Š 2â”Šimport { OnResponse } from '@graphql-modules/core';\n+â”Š  â”Š 3â”Šimport { Pool, PoolClient } from 'pg';\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Š@Injectable({\n+â”Š  â”Š 6â”Š  scope: ProviderScope.Session,\n+â”Š  â”Š 7â”Š})\n+â”Š  â”Š 8â”Šexport class Database implements OnResponse {\n+â”Š  â”Š 9â”Š  private instance: PoolClient;\n+â”Š  â”Š10â”Š\n+â”Š  â”Š11â”Š  constructor(private pool: Pool) {}\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Š  async onRequest() {\n+â”Š  â”Š14â”Š    this.instance = await this.pool.connect();\n+â”Š  â”Š15â”Š  }\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š  onResponse() {\n+â”Š  â”Š18â”Š    if (this.instance) {\n+â”Š  â”Š19â”Š      this.instance.release();\n+â”Š  â”Š20â”Š    }\n+â”Š  â”Š21â”Š  }\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Š  async getClient() {\n+â”Š  â”Š24â”Š    return this.instance;\n+â”Š  â”Š25â”Š  }\n+â”Š  â”Š26â”Š}\n```\n\n[}]: #\n\nThings we did there:\n- Session scope was used, which makes sure our provider is created and destroyed on every GraphQL Operation\n- `onRequest` hook is called when a GraphQL Operation starts and we create a database connection in it.\n- `onResponse` hook is triggered when GraphQL Response is about to be sent to the consumer, so we destroy the connection there.\n- `getClient` method exposes the connection\n- `Pool` in constructor means we expect `Pool` to be injected into `Database` provider.\n\nNow we can define `Pool` token and register `Database`:\n\n[{]: <helper> (diffStep \"13.6\" files=\"modules/common/index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.6: Define Database provider](https://github.com/Urigo/WhatsApp-Clone-Server/commit/06de9e072077b513496c1588ffbc7ad5461b4c90)\n\n##### Changed modules&#x2F;common&#x2F;index.ts\n```diff\n@@ -1,8 +1,10 @@\n â”Š 1â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š 2â”Š 2â”Šimport { gql } from 'apollo-server-express';\n â”Š 3â”Š 3â”Šimport { GraphQLDateTime } from 'graphql-iso-date';\n+â”Š  â”Š 4â”Šimport { Pool } from 'pg';\n â”Š 4â”Š 5â”Šimport { pool } from '../../db';\n â”Š 5â”Š 6â”Šimport { Resolvers } from '../../types/graphql';\n+â”Š  â”Š 7â”Šimport { Database } from './database.provider';\n â”Š 6â”Š 8â”Š\n â”Š 7â”Š 9â”Šconst { PostgresPubSub } = require('graphql-postgres-subscriptions');\n â”Š 8â”Š10â”Š\n```\n```diff\n@@ -38,6 +40,13 @@\n â”Š38â”Š40â”Š  name: 'common',\n â”Š39â”Š41â”Š  typeDefs,\n â”Š40â”Š42â”Š  resolvers,\n+â”Š  â”Š43â”Š  providers: () => [\n+â”Š  â”Š44â”Š    {\n+â”Š  â”Š45â”Š      provide: Pool,\n+â”Š  â”Š46â”Š      useValue: pool,\n+â”Š  â”Š47â”Š    },\n+â”Š  â”Š48â”Š    Database,\n+â”Š  â”Š49â”Š  ],\n â”Š41â”Š50â”Š  async context({ res, connection }) {\n â”Š42â”Š51â”Š    let db;\n```\n\n[}]: #\n\n[{]: <helper> (diffStep \"13.6\" files=\"modules/index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.6: Define Database provider](https://github.com/Urigo/WhatsApp-Clone-Server/commit/06de9e072077b513496c1588ffbc7ad5461b4c90)\n\n\n\n[}]: #\n\n#### Creating Users and Chats services\n\nIt's not really recommended to put logic in resolvers so we're going to create a layer with business logic. A good example of that are Users and Chats modules so let's start with the former.\n\nWe're going to create `Users` service and move `Query.users` logic into `findAllExcept` method:\n\n[{]: <helper> (diffStep \"13.7\" files=\"modules/users/users.provider.ts,modules/users/index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.7: Basic User provider](https://github.com/Urigo/WhatsApp-Clone-Server/commit/cc196cf7f4a9c18d84397ca6f11f39c4bc8f8bab)\n\n##### Changed modules&#x2F;users&#x2F;index.ts\n```diff\n@@ -9,6 +9,7 @@\n â”Š 9â”Š 9â”Šimport { pool } from '../../db';\n â”Š10â”Š10â”Šimport { validateLength, validatePassword } from '../../validators';\n â”Š11â”Š11â”Šimport { Resolvers } from '../../types/graphql';\n+â”Š  â”Š12â”Šimport { Users } from './users.provider';\n â”Š12â”Š13â”Š\n â”Š13â”Š14â”Šconst typeDefs = gql`\n â”Š14â”Š15â”Š  type User {\n```\n```diff\n@@ -38,14 +39,10 @@\n â”Š38â”Š39â”Š    me(root, args, { currentUser }) {\n â”Š39â”Š40â”Š      return currentUser || null;\n â”Š40â”Š41â”Š    },\n-â”Š41â”Š  â”Š    async users(root, args, { currentUser, db }) {\n+â”Š  â”Š42â”Š    async users(root, args, { currentUser, injector }) {\n â”Š42â”Š43â”Š      if (!currentUser) return [];\n â”Š43â”Š44â”Š\n-â”Š44â”Š  â”Š      const { rows } = await db.query(sql`\n-â”Š45â”Š  â”Š        SELECT * FROM users WHERE users.id != ${currentUser.id}\n-â”Š46â”Š  â”Š      `);\n-â”Š47â”Š  â”Š\n-â”Š48â”Š  â”Š      return rows;\n+â”Š  â”Š45â”Š      return injector.get(Users).findAllExcept(currentUser.id);\n â”Š49â”Š46â”Š    },\n â”Š50â”Š47â”Š  },\n â”Š51â”Š48â”Š  Mutation: {\n```\n```diff\n@@ -108,6 +105,7 @@\n â”Š108â”Š105â”Š  typeDefs,\n â”Š109â”Š106â”Š  resolvers,\n â”Š110â”Š107â”Š  imports: () => [commonModule],\n+â”Š   â”Š108â”Š  providers: () => [Users],\n â”Š111â”Š109â”Š  async context(session) {\n â”Š112â”Š110â”Š    let currentUser;\n â”Š113â”Š111â”Š\n```\n\n##### Added modules&#x2F;users&#x2F;users.provider.ts\n```diff\n@@ -0,0 +1,19 @@\n+â”Š  â”Š 1â”Šimport { Injectable, Inject, ProviderScope } from '@graphql-modules/di';\n+â”Š  â”Š 2â”Šimport sql from 'sql-template-strings';\n+â”Š  â”Š 3â”Šimport { Database } from '../common/database.provider';\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Š@Injectable({\n+â”Š  â”Š 6â”Š  scope: ProviderScope.Session,\n+â”Š  â”Š 7â”Š})\n+â”Š  â”Š 8â”Šexport class Users {\n+â”Š  â”Š 9â”Š  @Inject() private db: Database;\n+â”Š  â”Š10â”Š\n+â”Š  â”Š11â”Š  async findAllExcept(userId: string) {\n+â”Š  â”Š12â”Š    const db = await this.db.getClient();\n+â”Š  â”Š13â”Š    const { rows } = await db.query(\n+â”Š  â”Š14â”Š      sql`SELECT * FROM users WHERE id != ${userId}`\n+â”Š  â”Š15â”Š    );\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š    return rows;\n+â”Š  â”Š18â”Š  }\n+â”Š  â”Š19â”Š}\n```\n\n[}]: #\n\nA very interesting thing to notice is `@Inject()` decorator.\n\n```ts\n@Inject() private db: Database;\n```\n\nThe @Inject, well... injects `Database` provider as `db` property so you don't have to use the `constructor`.\n\nBack to the Users service. It's very similar to what we did with the `UnsplashApi` so let's move on and implement more methods.\n\n[{]: <helper> (diffStep \"13.8\" module=\"server\")\n\n#### [__Server__ Step 13.8: Implement newUser and findByUsername](https://github.com/Urigo/WhatsApp-Clone-Server/commit/bb6c1e76d447a85b631ce9d78b3fc8664cf6ed2a)\n\n##### Changed modules&#x2F;users&#x2F;index.ts\n```diff\n@@ -46,11 +46,8 @@\n â”Š46â”Š46â”Š    },\n â”Š47â”Š47â”Š  },\n â”Š48â”Š48â”Š  Mutation: {\n-â”Š49â”Š  â”Š    async signIn(root, { username, password }, { db, res }) {\n-â”Š50â”Š  â”Š      const { rows } = await db.query(\n-â”Š51â”Š  â”Š        sql`SELECT * FROM users WHERE username = ${username}`\n-â”Š52â”Š  â”Š      );\n-â”Š53â”Š  â”Š      const user = rows[0];\n+â”Š  â”Š49â”Š    async signIn(root, { username, password }, { injector, res }) {\n+â”Š  â”Š50â”Š      const user = await injector.get(Users).findByUsername(username);\n â”Š54â”Š51â”Š\n â”Š55â”Š52â”Š      if (!user) {\n â”Š56â”Š53â”Š        throw new Error('user not found');\n```\n```diff\n@@ -69,7 +66,11 @@\n â”Š69â”Š66â”Š      return user;\n â”Š70â”Š67â”Š    },\n â”Š71â”Š68â”Š\n-â”Š72â”Š  â”Š    async signUp(root, { name, username, password, passwordConfirm }, { db }) {\n+â”Š  â”Š69â”Š    async signUp(\n+â”Š  â”Š70â”Š      root,\n+â”Š  â”Š71â”Š      { name, username, password, passwordConfirm },\n+â”Š  â”Š72â”Š      { injector }\n+â”Š  â”Š73â”Š    ) {\n â”Š73â”Š74â”Š      validateLength('req.name', name, 3, 50);\n â”Š74â”Š75â”Š      validateLength('req.username', username, 3, 18);\n â”Š75â”Š76â”Š      validatePassword('req.password', password);\n```\n```diff\n@@ -78,24 +79,18 @@\n â”Š 78â”Š 79â”Š        throw Error(\"req.password and req.passwordConfirm don't match\");\n â”Š 79â”Š 80â”Š      }\n â”Š 80â”Š 81â”Š\n-â”Š 81â”Š   â”Š      const existingUserQuery = await db.query(\n-â”Š 82â”Š   â”Š        sql`SELECT * FROM users WHERE username = ${username}`\n-â”Š 83â”Š   â”Š      );\n-â”Š 84â”Š   â”Š      if (existingUserQuery.rows[0]) {\n+â”Š   â”Š 82â”Š      const existingUser = await injector.get(Users).findByUsername(username);\n+â”Š   â”Š 83â”Š      if (existingUser) {\n â”Š 85â”Š 84â”Š        throw Error('username already exists');\n â”Š 86â”Š 85â”Š      }\n â”Š 87â”Š 86â”Š\n-â”Š 88â”Š   â”Š      const passwordHash = bcrypt.hashSync(password, bcrypt.genSaltSync(8));\n+â”Š   â”Š 87â”Š      const createdUser = await injector.get(Users).newUser({\n+â”Š   â”Š 88â”Š        username,\n+â”Š   â”Š 89â”Š        password,\n+â”Š   â”Š 90â”Š        name,\n+â”Š   â”Š 91â”Š      });\n â”Š 89â”Š 92â”Š\n-â”Š 90â”Š   â”Š      const createdUserQuery = await db.query(sql`\n-â”Š 91â”Š   â”Š        INSERT INTO users(password, picture, username, name)\n-â”Š 92â”Š   â”Š        VALUES(${passwordHash}, '', ${username}, ${name})\n-â”Š 93â”Š   â”Š        RETURNING *\n-â”Š 94â”Š   â”Š      `);\n-â”Š 95â”Š   â”Š\n-â”Š 96â”Š   â”Š      const user = createdUserQuery.rows[0];\n-â”Š 97â”Š   â”Š\n-â”Š 98â”Š   â”Š      return user;\n+â”Š   â”Š 93â”Š      return createdUser;\n â”Š 99â”Š 94â”Š    },\n â”Š100â”Š 95â”Š  },\n â”Š101â”Š 96â”Š};\n```\n\n##### Changed modules&#x2F;users&#x2F;users.provider.ts\n```diff\n@@ -1,7 +1,10 @@\n â”Š 1â”Š 1â”Šimport { Injectable, Inject, ProviderScope } from '@graphql-modules/di';\n â”Š 2â”Š 2â”Šimport sql from 'sql-template-strings';\n+â”Š  â”Š 3â”Šimport bcrypt from 'bcrypt';\n â”Š 3â”Š 4â”Šimport { Database } from '../common/database.provider';\n â”Š 4â”Š 5â”Š\n+â”Š  â”Š 6â”Šconst DEFAULT_PROFILE_PIC = 'https://raw.githubusercontent.com/Urigo/WhatsApp-Clone-Client-React/legacy/public/assets/default-profile-pic.jpg'\n+â”Š  â”Š 7â”Š\n â”Š 5â”Š 8â”Š@Injectable({\n â”Š 6â”Š 9â”Š  scope: ProviderScope.Session,\n â”Š 7â”Š10â”Š})\n```\n```diff\n@@ -16,4 +19,34 @@\n â”Š16â”Š19â”Š\n â”Š17â”Š20â”Š    return rows;\n â”Š18â”Š21â”Š  }\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Š  async findByUsername(username: string) {\n+â”Š  â”Š24â”Š    const db = await this.db.getClient();\n+â”Š  â”Š25â”Š    const { rows } = await db.query(\n+â”Š  â”Š26â”Š      sql`SELECT * FROM users WHERE username = ${username}`\n+â”Š  â”Š27â”Š    );\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š    return rows[0] || null;\n+â”Š  â”Š30â”Š  }\n+â”Š  â”Š31â”Š\n+â”Š  â”Š32â”Š  async newUser({\n+â”Š  â”Š33â”Š    username,\n+â”Š  â”Š34â”Š    name,\n+â”Š  â”Š35â”Š    password,\n+â”Š  â”Š36â”Š  }: {\n+â”Š  â”Š37â”Š    username: string;\n+â”Š  â”Š38â”Š    name: string;\n+â”Š  â”Š39â”Š    password: string;\n+â”Š  â”Š40â”Š  }) {\n+â”Š  â”Š41â”Š    const db = await this.db.getClient();\n+â”Š  â”Š42â”Š    const passwordHash = bcrypt.hashSync(password, bcrypt.genSaltSync(8));\n+â”Š  â”Š43â”Š    const createdUserQuery = await db.query(sql`\n+â”Š  â”Š44â”Š        INSERT INTO users(password, picture, username, name)\n+â”Š  â”Š45â”Š        VALUES(${passwordHash}, ${DEFAULT_PROFILE_PIC}, ${username}, ${name})\n+â”Š  â”Š46â”Š        RETURNING *\n+â”Š  â”Š47â”Š      `);\n+â”Š  â”Š48â”Š    const user = createdUserQuery.rows[0];\n+â”Š  â”Š49â”Š\n+â”Š  â”Š50â”Š    return user;\n+â”Š  â”Š51â”Š  }\n â”Š19â”Š52â”Š}\n```\n\n[}]: #\n[{]: <helper> (diffStep \"13.9\" module=\"server\")\n\n#### [__Server__ Step 13.9: Implement findById and use in Chats module](https://github.com/Urigo/WhatsApp-Clone-Server/commit/a5a2605255aceef947f02bc84430aba7717ce1fa)\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -6,6 +6,7 @@\n â”Š 6â”Š 6â”Šimport { Message, Chat, pool } from '../../db';\n â”Š 7â”Š 7â”Šimport { Resolvers } from '../../types/graphql';\n â”Š 8â”Š 8â”Šimport { UnsplashApi } from './unsplash.api';\n+â”Š  â”Š 9â”Šimport { Users } from './../users/users.provider';\n â”Š 9â”Š10â”Š\n â”Š10â”Š11â”Šconst typeDefs = gql`\n â”Š11â”Š12â”Š  type Message {\n```\n```diff\n@@ -58,11 +59,8 @@\n â”Š58â”Š59â”Š      return rows[0] || null;\n â”Š59â”Š60â”Š    },\n â”Š60â”Š61â”Š\n-â”Š61â”Š  â”Š    async sender(message, args, { db }) {\n-â”Š62â”Š  â”Š      const { rows } = await db.query(sql`\n-â”Š63â”Š  â”Š        SELECT * FROM users WHERE id = ${message.sender_user_id}\n-â”Š64â”Š  â”Š      `);\n-â”Š65â”Š  â”Š      return rows[0] || null;\n+â”Š  â”Š62â”Š    async sender(message, args, { injector }) {\n+â”Š  â”Š63â”Š      return injector.get(Users).findById(message.sender_user_id);\n â”Š66â”Š64â”Š    },\n â”Š67â”Š65â”Š\n â”Š68â”Š66â”Š    async recipient(message, args, { db }) {\n```\n\n##### Changed modules&#x2F;users&#x2F;users.provider.ts\n```diff\n@@ -11,6 +11,15 @@\n â”Š11â”Š11â”Šexport class Users {\n â”Š12â”Š12â”Š  @Inject() private db: Database;\n â”Š13â”Š13â”Š\n+â”Š  â”Š14â”Š  async findById(userId: string) {\n+â”Š  â”Š15â”Š    const db = await this.db.getClient();\n+â”Š  â”Š16â”Š    const { rows } = await db.query(\n+â”Š  â”Š17â”Š      sql`SELECT * FROM users WHERE id = ${userId}`\n+â”Š  â”Š18â”Š    );\n+â”Š  â”Š19â”Š\n+â”Š  â”Š20â”Š    return rows[0] || null;\n+â”Š  â”Š21â”Š  }\n+â”Š  â”Š22â”Š\n â”Š14â”Š23â”Š  async findAllExcept(userId: string) {\n â”Š15â”Š24â”Š    const db = await this.db.getClient();\n â”Š16â”Š25â”Š    const { rows } = await db.query(\n```\n\n[}]: #\n\nLet's now implement `Chats` service with two basic methods:\n\n[{]: <helper> (diffStep \"13.10\" module=\"server\")\n\n#### [__Server__ Step 13.10: Basic Chats provider](https://github.com/Urigo/WhatsApp-Clone-Server/commit/506fc26dbee2244d5780af1f21e80c5236276a96)\n\n##### Added modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -0,0 +1,34 @@\n+â”Š  â”Š 1â”Šimport { Injectable, Inject, ProviderScope } from '@graphql-modules/di';\n+â”Š  â”Š 2â”Šimport sql from 'sql-template-strings';\n+â”Š  â”Š 3â”Šimport { Database } from '../common/database.provider';\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Š@Injectable({\n+â”Š  â”Š 6â”Š  scope: ProviderScope.Session,\n+â”Š  â”Š 7â”Š})\n+â”Š  â”Š 8â”Šexport class Chats {\n+â”Š  â”Š 9â”Š  @Inject() private db: Database;\n+â”Š  â”Š10â”Š\n+â”Š  â”Š11â”Š  async findChatsByUser(userId: string) {\n+â”Š  â”Š12â”Š    const db = await this.db.getClient();\n+â”Š  â”Š13â”Š\n+â”Š  â”Š14â”Š    const { rows } = await db.query(sql`\n+â”Š  â”Š15â”Š      SELECT chats.* FROM chats, chats_users\n+â”Š  â”Š16â”Š      WHERE chats.id = chats_users.chat_id\n+â”Š  â”Š17â”Š      AND chats_users.user_id = ${userId}\n+â”Š  â”Š18â”Š    `);\n+â”Š  â”Š19â”Š\n+â”Š  â”Š20â”Š    return rows;\n+â”Š  â”Š21â”Š  }\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Š  async findChatByUser({ chatId, userId }: { chatId: string; userId: string }) {\n+â”Š  â”Š24â”Š    const db = await this.db.getClient();\n+â”Š  â”Š25â”Š    const { rows } = await db.query(sql`\n+â”Š  â”Š26â”Š      SELECT chats.* FROM chats, chats_users\n+â”Š  â”Š27â”Š      WHERE chats_users.chat_id = ${chatId}\n+â”Š  â”Š28â”Š      AND chats.id = chats_users.chat_id\n+â”Š  â”Š29â”Š      AND chats_users.user_id = ${userId}\n+â”Š  â”Š30â”Š    `);\n+â”Š  â”Š31â”Š\n+â”Š  â”Š32â”Š    return rows[0] || null;\n+â”Š  â”Š33â”Š  }\n+â”Š  â”Š34â”Š}\n```\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -7,6 +7,7 @@\n â”Š 7â”Š 7â”Šimport { Resolvers } from '../../types/graphql';\n â”Š 8â”Š 8â”Šimport { UnsplashApi } from './unsplash.api';\n â”Š 9â”Š 9â”Šimport { Users } from './../users/users.provider';\n+â”Š  â”Š10â”Šimport { Chats } from './chats.provider';\n â”Š10â”Š11â”Š\n â”Š11â”Š12â”Šconst typeDefs = gql`\n â”Š12â”Š13â”Š  type Message {\n```\n```diff\n@@ -138,29 +139,18 @@\n â”Š138â”Š139â”Š  },\n â”Š139â”Š140â”Š\n â”Š140â”Š141â”Š  Query: {\n-â”Š141â”Š   â”Š    async chats(root, args, { currentUser, db }) {\n+â”Š   â”Š142â”Š    async chats(root, args, { currentUser, injector }) {\n â”Š142â”Š143â”Š      if (!currentUser) return [];\n â”Š143â”Š144â”Š\n-â”Š144â”Š   â”Š      const { rows } = await db.query(sql`\n-â”Š145â”Š   â”Š        SELECT chats.* FROM chats, chats_users\n-â”Š146â”Š   â”Š        WHERE chats.id = chats_users.chat_id\n-â”Š147â”Š   â”Š        AND chats_users.user_id = ${currentUser.id}\n-â”Š148â”Š   â”Š      `);\n-â”Š149â”Š   â”Š\n-â”Š150â”Š   â”Š      return rows;\n+â”Š   â”Š145â”Š      return injector.get(Chats).findChatsByUser(currentUser.id);\n â”Š151â”Š146â”Š    },\n â”Š152â”Š147â”Š\n-â”Š153â”Š   â”Š    async chat(root, { chatId }, { currentUser, db }) {\n+â”Š   â”Š148â”Š    async chat(root, { chatId }, { currentUser, injector }) {\n â”Š154â”Š149â”Š      if (!currentUser) return null;\n â”Š155â”Š150â”Š\n-â”Š156â”Š   â”Š      const { rows } = await db.query(sql`\n-â”Š157â”Š   â”Š        SELECT chats.* FROM chats, chats_users\n-â”Š158â”Š   â”Š        WHERE chats_users.chat_id = ${chatId}\n-â”Š159â”Š   â”Š        AND chats.id = chats_users.chat_id\n-â”Š160â”Š   â”Š        AND chats_users.user_id = ${currentUser.id}\n-â”Š161â”Š   â”Š      `);\n-â”Š162â”Š   â”Š\n-â”Š163â”Š   â”Š      return rows[0] ? rows[0] : null;\n+â”Š   â”Š151â”Š      return injector\n+â”Š   â”Š152â”Š        .get(Chats)\n+â”Š   â”Š153â”Š        .findChatByUser({ chatId, userId: currentUser.id });\n â”Š164â”Š154â”Š    },\n â”Š165â”Š155â”Š  },\n â”Š166â”Š156â”Š\n```\n```diff\n@@ -333,5 +323,5 @@\n â”Š333â”Š323â”Š  typeDefs,\n â”Š334â”Š324â”Š  resolvers,\n â”Š335â”Š325â”Š  imports: () => [commonModule, usersModule],\n-â”Š336â”Š   â”Š  providers: () => [UnsplashApi],\n+â”Š   â”Š326â”Š  providers: () => [UnsplashApi, Chats],\n â”Š337â”Š327â”Š});\n```\n\n[}]: #\n\nIt looks exatly like `Users` and also has only `database` provider in it.\n\nWe're going to move on and more things:\n\n[{]: <helper> (diffStep \"13.11\" module=\"server\")\n\n#### [__Server__ Step 13.11: Implement findChatById](https://github.com/Urigo/WhatsApp-Clone-Server/commit/b62f273059ef53b2b0049df3b007a916c15ca6a8)\n\n##### Changed modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -31,4 +31,12 @@\n â”Š31â”Š31â”Š\n â”Š32â”Š32â”Š    return rows[0] || null;\n â”Š33â”Š33â”Š  }\n+â”Š  â”Š34â”Š\n+â”Š  â”Š35â”Š  async findChatById(chatId: string) {\n+â”Š  â”Š36â”Š    const db = await this.db.getClient();\n+â”Š  â”Š37â”Š    const { rows } = await db.query(sql`\n+â”Š  â”Š38â”Š      SELECT * FROM chats WHERE id = ${chatId}\n+â”Š  â”Š39â”Š    `);\n+â”Š  â”Š40â”Š    return rows[0] || null;\n+â”Š  â”Š41â”Š  }\n â”Š34â”Š42â”Š}\n```\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -53,11 +53,8 @@\n â”Š53â”Š53â”Š      return new Date(message.created_at);\n â”Š54â”Š54â”Š    },\n â”Š55â”Š55â”Š\n-â”Š56â”Š  â”Š    async chat(message, args, { db }) {\n-â”Š57â”Š  â”Š      const { rows } = await db.query(sql`\n-â”Š58â”Š  â”Š        SELECT * FROM chats WHERE id = ${message.chat_id}\n-â”Š59â”Š  â”Š      `);\n-â”Š60â”Š  â”Š      return rows[0] || null;\n+â”Š  â”Š56â”Š    async chat(message, args, { injector }) {\n+â”Š  â”Š57â”Š      return injector.get(Chats).findChatById(message.chat_id);\n â”Š61â”Š58â”Š    },\n â”Š62â”Š59â”Š\n â”Š63â”Š60â”Š    async sender(message, args, { injector }) {\n```\n\n[}]: #\n[{]: <helper> (diffStep \"13.12\" module=\"server\")\n\n#### [__Server__ Step 13.12: Find chat&#x27;s messages](https://github.com/Urigo/WhatsApp-Clone-Server/commit/19a5df856d0bb583c22b427770b7504d2756ef03)\n\n##### Changed modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -39,4 +39,25 @@\n â”Š39â”Š39â”Š    `);\n â”Š40â”Š40â”Š    return rows[0] || null;\n â”Š41â”Š41â”Š  }\n+â”Š  â”Š42â”Š\n+â”Š  â”Š43â”Š  async findMessagesByChat(chatId: string) {\n+â”Š  â”Š44â”Š    const db = await this.db.getClient();\n+â”Š  â”Š45â”Š    const { rows } = await db.query(\n+â”Š  â”Š46â”Š      sql`SELECT * FROM messages WHERE chat_id = ${chatId}`\n+â”Š  â”Š47â”Š    );\n+â”Š  â”Š48â”Š\n+â”Š  â”Š49â”Š    return rows;\n+â”Š  â”Š50â”Š  }\n+â”Š  â”Š51â”Š\n+â”Š  â”Š52â”Š  async lastMessage(chatId: string) {\n+â”Š  â”Š53â”Š    const db = await this.db.getClient();\n+â”Š  â”Š54â”Š    const { rows } = await db.query(sql`\n+â”Š  â”Š55â”Š      SELECT * FROM messages\n+â”Š  â”Š56â”Š      WHERE chat_id = ${chatId}\n+â”Š  â”Š57â”Š      ORDER BY created_at DESC\n+â”Š  â”Š58â”Š      LIMIT 1\n+â”Š  â”Š59â”Š    `);\n+â”Š  â”Š60â”Š\n+â”Š  â”Š61â”Š    return rows[0];\n+â”Š  â”Š62â”Š  }\n â”Š42â”Š63â”Š}\n```\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -106,22 +106,12 @@\n â”Š106â”Š106â”Š        : injector.get(UnsplashApi).getRandomPhoto();\n â”Š107â”Š107â”Š    },\n â”Š108â”Š108â”Š\n-â”Š109â”Š   â”Š    async messages(chat, args, { db }) {\n-â”Š110â”Š   â”Š      const { rows } = await db.query(\n-â”Š111â”Š   â”Š        sql`SELECT * FROM messages WHERE chat_id = ${chat.id}`\n-â”Š112â”Š   â”Š      );\n-â”Š113â”Š   â”Š\n-â”Š114â”Š   â”Š      return rows;\n+â”Š   â”Š109â”Š    async messages(chat, args, { injector }) {\n+â”Š   â”Š110â”Š      return injector.get(Chats).findMessagesByChat(chat.id);\n â”Š115â”Š111â”Š    },\n â”Š116â”Š112â”Š\n-â”Š117â”Š   â”Š    async lastMessage(chat, args, { db }) {\n-â”Š118â”Š   â”Š      const { rows } = await db.query(sql`\n-â”Š119â”Š   â”Š        SELECT * FROM messages\n-â”Š120â”Š   â”Š        WHERE chat_id = ${chat.id}\n-â”Š121â”Š   â”Š        ORDER BY created_at DESC\n-â”Š122â”Š   â”Š        LIMIT 1`);\n-â”Š123â”Š   â”Š\n-â”Š124â”Š   â”Š      return rows[0];\n+â”Š   â”Š113â”Š    async lastMessage(chat, args, { injector }) {\n+â”Š   â”Š114â”Š      return injector.get(Chats).lastMessage(chat.id);\n â”Š125â”Š115â”Š    },\n â”Š126â”Š116â”Š\n â”Š127â”Š117â”Š    async participants(chat, args, { db }) {\n```\n\n[}]: #\n[{]: <helper> (diffStep \"13.13\" module=\"server\")\n\n#### [__Server__ Step 13.13: Find first participant](https://github.com/Urigo/WhatsApp-Clone-Server/commit/e817a51f389ef809c308e23682b7d15daa1377d9)\n\n##### Changed modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -60,4 +60,16 @@\n â”Š60â”Š60â”Š\n â”Š61â”Š61â”Š    return rows[0];\n â”Š62â”Š62â”Š  }\n+â”Š  â”Š63â”Š\n+â”Š  â”Š64â”Š  async firstRecipient({ chatId, userId }: { chatId: string; userId: string }) {\n+â”Š  â”Š65â”Š    const db = await this.db.getClient();\n+â”Š  â”Š66â”Š    const { rows } = await db.query(sql`\n+â”Š  â”Š67â”Š      SELECT users.* FROM users, chats_users\n+â”Š  â”Š68â”Š      WHERE users.id != ${userId}\n+â”Š  â”Š69â”Š      AND users.id = chats_users.user_id\n+â”Š  â”Š70â”Š      AND chats_users.chat_id = ${chatId}\n+â”Š  â”Š71â”Š    `);\n+â”Š  â”Š72â”Š\n+â”Š  â”Š73â”Š    return rows[0] || null;\n+â”Š  â”Š74â”Š  }\n â”Š63â”Š75â”Š}\n```\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -61,13 +61,11 @@\n â”Š61â”Š61â”Š      return injector.get(Users).findById(message.sender_user_id);\n â”Š62â”Š62â”Š    },\n â”Š63â”Š63â”Š\n-â”Š64â”Š  â”Š    async recipient(message, args, { db }) {\n-â”Š65â”Š  â”Š      const { rows } = await db.query(sql`\n-â”Š66â”Š  â”Š        SELECT users.* FROM users, chats_users\n-â”Š67â”Š  â”Š        WHERE chats_users.user_id != ${message.sender_user_id}\n-â”Š68â”Š  â”Š        AND chats_users.chat_id = ${message.chat_id}\n-â”Š69â”Š  â”Š      `);\n-â”Š70â”Š  â”Š      return rows[0] || null;\n+â”Š  â”Š64â”Š    async recipient(message, args, { injector }) {\n+â”Š  â”Š65â”Š      return injector.get(Chats).firstRecipient({\n+â”Š  â”Š66â”Š        chatId: message.chat_id,\n+â”Š  â”Š67â”Š        userId: message.sender_user_id,\n+â”Š  â”Š68â”Š      });\n â”Š71â”Š69â”Š    },\n â”Š72â”Š70â”Š\n â”Š73â”Š71â”Š    isMine(message, args, { currentUser }) {\n```\n```diff\n@@ -76,16 +74,13 @@\n â”Š76â”Š74â”Š  },\n â”Š77â”Š75â”Š\n â”Š78â”Š76â”Š  Chat: {\n-â”Š79â”Š  â”Š    async name(chat, args, { currentUser, db }) {\n+â”Š  â”Š77â”Š    async name(chat, args, { currentUser, injector }) {\n â”Š80â”Š78â”Š      if (!currentUser) return null;\n â”Š81â”Š79â”Š\n-â”Š82â”Š  â”Š      const { rows } = await db.query(sql`\n-â”Š83â”Š  â”Š        SELECT users.* FROM users, chats_users\n-â”Š84â”Š  â”Š        WHERE users.id != ${currentUser.id}\n-â”Š85â”Š  â”Š        AND users.id = chats_users.user_id\n-â”Š86â”Š  â”Š        AND chats_users.chat_id = ${chat.id}`);\n-â”Š87â”Š  â”Š\n-â”Š88â”Š  â”Š      const participant = rows[0];\n+â”Š  â”Š80â”Š      const participant = await injector.get(Chats).firstRecipient({\n+â”Š  â”Š81â”Š        chatId: chat.id,\n+â”Š  â”Š82â”Š        userId: currentUser.id,\n+â”Š  â”Š83â”Š      });\n â”Š89â”Š84â”Š\n â”Š90â”Š85â”Š      return participant ? participant.name : null;\n â”Š91â”Š86â”Š    },\n```\n```diff\n@@ -93,13 +88,10 @@\n â”Š 93â”Š 88â”Š    async picture(chat, args, { currentUser, db, injector }) {\n â”Š 94â”Š 89â”Š      if (!currentUser) return null;\n â”Š 95â”Š 90â”Š\n-â”Š 96â”Š   â”Š      const { rows } = await db.query(sql`\n-â”Š 97â”Š   â”Š        SELECT users.* FROM users, chats_users\n-â”Š 98â”Š   â”Š        WHERE users.id != ${currentUser.id}\n-â”Š 99â”Š   â”Š        AND users.id = chats_users.user_id\n-â”Š100â”Š   â”Š        AND chats_users.chat_id = ${chat.id}`);\n-â”Š101â”Š   â”Š\n-â”Š102â”Š   â”Š      const participant = rows[0];\n+â”Š   â”Š 91â”Š      const participant = await injector.get(Chats).firstRecipient({\n+â”Š   â”Š 92â”Š        chatId: chat.id,\n+â”Š   â”Š 93â”Š        userId: currentUser.id,\n+â”Š   â”Š 94â”Š      });\n â”Š103â”Š 95â”Š\n â”Š104â”Š 96â”Š      return participant && participant.picture\n â”Š105â”Š 97â”Š        ? participant.picture\n```\n\n[}]: #\n[{]: <helper> (diffStep \"13.14\" module=\"server\")\n\n#### [__Server__ Step 13.14: Find all participants](https://github.com/Urigo/WhatsApp-Clone-Server/commit/7ec04832465f7cd8d53d43af0e7ee86bd20be11e)\n\n##### Changed modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -72,4 +72,15 @@\n â”Š72â”Š72â”Š\n â”Š73â”Š73â”Š    return rows[0] || null;\n â”Š74â”Š74â”Š  }\n+â”Š  â”Š75â”Š\n+â”Š  â”Š76â”Š  async participants(chatId: string) {\n+â”Š  â”Š77â”Š    const db = await this.db.getClient();\n+â”Š  â”Š78â”Š    const { rows } = await db.query(sql`\n+â”Š  â”Š79â”Š      SELECT users.* FROM users, chats_users\n+â”Š  â”Š80â”Š      WHERE chats_users.chat_id = ${chatId}\n+â”Š  â”Š81â”Š      AND chats_users.user_id = users.id\n+â”Š  â”Š82â”Š    `);\n+â”Š  â”Š83â”Š\n+â”Š  â”Š84â”Š    return rows;\n+â”Š  â”Š85â”Š  }\n â”Š75â”Š86â”Š}\n```\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -106,14 +106,8 @@\n â”Š106â”Š106â”Š      return injector.get(Chats).lastMessage(chat.id);\n â”Š107â”Š107â”Š    },\n â”Š108â”Š108â”Š\n-â”Š109â”Š   â”Š    async participants(chat, args, { db }) {\n-â”Š110â”Š   â”Š      const { rows } = await db.query(sql`\n-â”Š111â”Š   â”Š        SELECT users.* FROM users, chats_users\n-â”Š112â”Š   â”Š        WHERE chats_users.chat_id = ${chat.id}\n-â”Š113â”Š   â”Š        AND chats_users.user_id = users.id\n-â”Š114â”Š   â”Š      `);\n-â”Š115â”Š   â”Š\n-â”Š116â”Š   â”Š      return rows;\n+â”Š   â”Š109â”Š    async participants(chat, args, { injector }) {\n+â”Š   â”Š110â”Š      return injector.get(Chats).participants(chat.id);\n â”Š117â”Š111â”Š    },\n â”Š118â”Š112â”Š  },\n```\n\n[}]: #\n[{]: <helper> (diffStep \"13.15\" module=\"server\")\n\n#### [__Server__ Step 13.15: Check if a user belongs to a chat](https://github.com/Urigo/WhatsApp-Clone-Server/commit/e282abbaa16ade91cb80f05df3a6a28726af778f)\n\n##### Changed modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -83,4 +83,15 @@\n â”Š83â”Š83â”Š\n â”Š84â”Š84â”Š    return rows;\n â”Š85â”Š85â”Š  }\n+â”Š  â”Š86â”Š\n+â”Š  â”Š87â”Š  async isParticipant({ chatId, userId }: { chatId: string; userId: string }) {\n+â”Š  â”Š88â”Š    const db = await this.db.getClient();\n+â”Š  â”Š89â”Š    const { rows } = await db.query(sql`\n+â”Š  â”Š90â”Š      SELECT * FROM chats_users\n+â”Š  â”Š91â”Š      WHERE chat_id = ${chatId}\n+â”Š  â”Š92â”Š      AND user_id = ${userId}\n+â”Š  â”Š93â”Š    `);\n+â”Š  â”Š94â”Š\n+â”Š  â”Š95â”Š    return !!rows.length;\n+â”Š  â”Š96â”Š  }\n â”Š86â”Š97â”Š}\n```\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -243,16 +243,14 @@\n â”Š243â”Š243â”Š        async (\n â”Š244â”Š244â”Š          { messageAdded }: { messageAdded: Message },\n â”Š245â”Š245â”Š          args,\n-â”Š246â”Š   â”Š          { currentUser }\n+â”Š   â”Š246â”Š          { currentUser, injector }\n â”Š247â”Š247â”Š        ) => {\n â”Š248â”Š248â”Š          if (!currentUser) return false;\n â”Š249â”Š249â”Š\n-â”Š250â”Š   â”Š          const { rows } = await pool.query(sql`\n-â”Š251â”Š   â”Š            SELECT * FROM chats_users\n-â”Š252â”Š   â”Š            WHERE chat_id = ${messageAdded.chat_id}\n-â”Š253â”Š   â”Š            AND user_id = ${currentUser.id}`);\n-â”Š254â”Š   â”Š\n-â”Š255â”Š   â”Š          return !!rows.length;\n+â”Š   â”Š250â”Š          return injector.get(Chats).isParticipant({\n+â”Š   â”Š251â”Š            chatId: messageAdded.chat_id,\n+â”Š   â”Š252â”Š            userId: currentUser.id,\n+â”Š   â”Š253â”Š          });\n â”Š256â”Š254â”Š        }\n â”Š257â”Š255â”Š      ),\n â”Š258â”Š256â”Š    },\n```\n```diff\n@@ -260,15 +258,17 @@\n â”Š260â”Š258â”Š    chatAdded: {\n â”Š261â”Š259â”Š      subscribe: withFilter(\n â”Š262â”Š260â”Š        (root, args, { pubsub }) => pubsub.asyncIterator('chatAdded'),\n-â”Š263â”Š   â”Š        async ({ chatAdded }: { chatAdded: Chat }, args, { currentUser }) => {\n+â”Š   â”Š261â”Š        async (\n+â”Š   â”Š262â”Š          { chatAdded }: { chatAdded: Chat },\n+â”Š   â”Š263â”Š          args,\n+â”Š   â”Š264â”Š          { currentUser, injector }\n+â”Š   â”Š265â”Š        ) => {\n â”Š264â”Š266â”Š          if (!currentUser) return false;\n â”Š265â”Š267â”Š\n-â”Š266â”Š   â”Š          const { rows } = await pool.query(sql`\n-â”Š267â”Š   â”Š            SELECT * FROM chats_users\n-â”Š268â”Š   â”Š            WHERE chat_id = ${chatAdded.id}\n-â”Š269â”Š   â”Š            AND user_id = ${currentUser.id}`);\n-â”Š270â”Š   â”Š\n-â”Š271â”Š   â”Š          return !!rows.length;\n+â”Š   â”Š268â”Š          return injector.get(Chats).isParticipant({\n+â”Š   â”Š269â”Š            chatId: chatAdded.id,\n+â”Š   â”Š270â”Š            userId: currentUser.id,\n+â”Š   â”Š271â”Š          });\n â”Š272â”Š272â”Š        }\n â”Š273â”Š273â”Š      ),\n â”Š274â”Š274â”Š    },\n```\n```diff\n@@ -276,15 +276,17 @@\n â”Š276â”Š276â”Š    chatRemoved: {\n â”Š277â”Š277â”Š      subscribe: withFilter(\n â”Š278â”Š278â”Š        (root, args, { pubsub }) => pubsub.asyncIterator('chatRemoved'),\n-â”Š279â”Š   â”Š        async ({ targetChat }: { targetChat: Chat }, args, { currentUser }) => {\n+â”Š   â”Š279â”Š        async (\n+â”Š   â”Š280â”Š          { targetChat }: { targetChat: Chat },\n+â”Š   â”Š281â”Š          args,\n+â”Š   â”Š282â”Š          { currentUser, injector }\n+â”Š   â”Š283â”Š        ) => {\n â”Š280â”Š284â”Š          if (!currentUser) return false;\n â”Š281â”Š285â”Š\n-â”Š282â”Š   â”Š          const { rows } = await pool.query(sql`\n-â”Š283â”Š   â”Š            SELECT * FROM chats_users\n-â”Š284â”Š   â”Š            WHERE chat_id = ${targetChat.id}\n-â”Š285â”Š   â”Š            AND user_id = ${currentUser.id}`);\n-â”Š286â”Š   â”Š\n-â”Š287â”Š   â”Š          return !!rows.length;\n+â”Š   â”Š286â”Š          return injector.get(Chats).isParticipant({\n+â”Š   â”Š287â”Š            chatId: targetChat.id,\n+â”Š   â”Š288â”Š            userId: currentUser.id,\n+â”Š   â”Š289â”Š          });\n â”Š288â”Š290â”Š        }\n â”Š289â”Š291â”Š      ),\n â”Š290â”Š292â”Š    },\n```\n\n[}]: #\n\n#### Sharing PubSub\n\nOne of things that are still in the context is `PubSub`. Because we're moving an entire business logic into a separate layer and as part of GraphQL Module's providers we need to make sure that PubSub is accessible throug DI.\n\nLet's register the PubSub and migrate resolvers:\n\n[{]: <helper> (diffStep \"13.16\" module=\"server\")\n\n#### [__Server__ Step 13.16: Move PubSub to Dependency Injection](https://github.com/Urigo/WhatsApp-Clone-Server/commit/69e2a53b4ccf13ea7a1045eb2a6c9030bca4b96e)\n\n##### Changed context.ts\n```diff\n@@ -1,11 +1,9 @@\n-â”Š 1â”Š  â”Šimport { PubSub } from 'apollo-server-express';\n â”Š 2â”Š 1â”Šimport { ModuleContext } from '@graphql-modules/core';\n â”Š 3â”Š 2â”Šimport { User } from './db';\n â”Š 4â”Š 3â”Šimport { Response } from 'express';\n â”Š 5â”Š 4â”Šimport { PoolClient } from 'pg';\n â”Š 6â”Š 5â”Š\n â”Š 7â”Š 6â”Šexport type MyContext = {\n-â”Š 8â”Š  â”Š  pubsub: PubSub;\n â”Š 9â”Š 7â”Š  currentUser: User;\n â”Š10â”Š 8â”Š  res: Response;\n â”Š11â”Š 9â”Š  db: PoolClient;\n```\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -8,6 +8,7 @@\n â”Š 8â”Š 8â”Šimport { UnsplashApi } from './unsplash.api';\n â”Š 9â”Š 9â”Šimport { Users } from './../users/users.provider';\n â”Š10â”Š10â”Šimport { Chats } from './chats.provider';\n+â”Š  â”Š11â”Šimport { PubSub } from '../common/pubsub.provider';\n â”Š11â”Š12â”Š\n â”Š12â”Š13â”Šconst typeDefs = gql`\n â”Š13â”Š14â”Š  type Message {\n```\n```diff\n@@ -128,7 +129,7 @@\n â”Š128â”Š129â”Š  },\n â”Š129â”Š130â”Š\n â”Š130â”Š131â”Š  Mutation: {\n-â”Š131â”Š   â”Š    async addMessage(root, { chatId, content }, { currentUser, pubsub, db }) {\n+â”Š   â”Š132â”Š    async addMessage(root, { chatId, content }, { currentUser, injector, db }) {\n â”Š132â”Š133â”Š      if (!currentUser) return null;\n â”Š133â”Š134â”Š\n â”Š134â”Š135â”Š      const { rows } = await db.query(sql`\n```\n```diff\n@@ -139,14 +140,14 @@\n â”Š139â”Š140â”Š\n â”Š140â”Š141â”Š      const messageAdded = rows[0];\n â”Š141â”Š142â”Š\n-â”Š142â”Š   â”Š      pubsub.publish('messageAdded', {\n+â”Š   â”Š143â”Š      injector.get(PubSub).publish('messageAdded', {\n â”Š143â”Š144â”Š        messageAdded,\n â”Š144â”Š145â”Š      });\n â”Š145â”Š146â”Š\n â”Š146â”Š147â”Š      return messageAdded;\n â”Š147â”Š148â”Š    },\n â”Š148â”Š149â”Š\n-â”Š149â”Š   â”Š    async addChat(root, { recipientId }, { currentUser, pubsub, db }) {\n+â”Š   â”Š150â”Š    async addChat(root, { recipientId }, { currentUser, injector, db }) {\n â”Š150â”Š151â”Š      if (!currentUser) return null;\n â”Š151â”Š152â”Š\n â”Š152â”Š153â”Š      const { rows } = await db.query(sql`\n```\n```diff\n@@ -186,7 +187,7 @@\n â”Š186â”Š187â”Š\n â”Š187â”Š188â”Š        await db.query('COMMIT');\n â”Š188â”Š189â”Š\n-â”Š189â”Š   â”Š        pubsub.publish('chatAdded', {\n+â”Š   â”Š190â”Š        injector.get(PubSub).publish('chatAdded', {\n â”Š190â”Š191â”Š          chatAdded,\n â”Š191â”Š192â”Š        });\n â”Š192â”Š193â”Š\n```\n```diff\n@@ -197,7 +198,7 @@\n â”Š197â”Š198â”Š      }\n â”Š198â”Š199â”Š    },\n â”Š199â”Š200â”Š\n-â”Š200â”Š   â”Š    async removeChat(root, { chatId }, { currentUser, pubsub, db }) {\n+â”Š   â”Š201â”Š    async removeChat(root, { chatId }, { currentUser, injector, db }) {\n â”Š201â”Š202â”Š      if (!currentUser) return null;\n â”Š202â”Š203â”Š\n â”Š203â”Š204â”Š      try {\n```\n```diff\n@@ -221,7 +222,7 @@\n â”Š221â”Š222â”Š          DELETE FROM chats WHERE chats.id = ${chatId}\n â”Š222â”Š223â”Š        `);\n â”Š223â”Š224â”Š\n-â”Š224â”Š   â”Š        pubsub.publish('chatRemoved', {\n+â”Š   â”Š225â”Š        injector.get(PubSub).publish('chatRemoved', {\n â”Š225â”Š226â”Š          chatRemoved: chat.id,\n â”Š226â”Š227â”Š          targetChat: chat,\n â”Š227â”Š228â”Š        });\n```\n```diff\n@@ -239,7 +240,8 @@\n â”Š239â”Š240â”Š  Subscription: {\n â”Š240â”Š241â”Š    messageAdded: {\n â”Š241â”Š242â”Š      subscribe: withFilter(\n-â”Š242â”Š   â”Š        (root, args, { pubsub }) => pubsub.asyncIterator('messageAdded'),\n+â”Š   â”Š243â”Š        (root, args, { injector }) =>\n+â”Š   â”Š244â”Š          injector.get(PubSub).asyncIterator('messageAdded'),\n â”Š243â”Š245â”Š        async (\n â”Š244â”Š246â”Š          { messageAdded }: { messageAdded: Message },\n â”Š245â”Š247â”Š          args,\n```\n```diff\n@@ -257,7 +259,8 @@\n â”Š257â”Š259â”Š\n â”Š258â”Š260â”Š    chatAdded: {\n â”Š259â”Š261â”Š      subscribe: withFilter(\n-â”Š260â”Š   â”Š        (root, args, { pubsub }) => pubsub.asyncIterator('chatAdded'),\n+â”Š   â”Š262â”Š        (root, args, { injector }) =>\n+â”Š   â”Š263â”Š          injector.get(PubSub).asyncIterator('chatAdded'),\n â”Š261â”Š264â”Š        async (\n â”Š262â”Š265â”Š          { chatAdded }: { chatAdded: Chat },\n â”Š263â”Š266â”Š          args,\n```\n```diff\n@@ -275,7 +278,8 @@\n â”Š275â”Š278â”Š\n â”Š276â”Š279â”Š    chatRemoved: {\n â”Š277â”Š280â”Š      subscribe: withFilter(\n-â”Š278â”Š   â”Š        (root, args, { pubsub }) => pubsub.asyncIterator('chatRemoved'),\n+â”Š   â”Š281â”Š        (root, args, { injector }) =>\n+â”Š   â”Š282â”Š          injector.get(PubSub).asyncIterator('chatRemoved'),\n â”Š279â”Š283â”Š        async (\n â”Š280â”Š284â”Š          { targetChat }: { targetChat: Chat },\n â”Š281â”Š285â”Š          args,\n```\n\n##### Changed modules&#x2F;common&#x2F;index.ts\n```diff\n@@ -1,10 +1,12 @@\n â”Š 1â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n+â”Š  â”Š 2â”Šimport { ProviderScope } from '@graphql-modules/di';\n â”Š 2â”Š 3â”Šimport { gql } from 'apollo-server-express';\n â”Š 3â”Š 4â”Šimport { GraphQLDateTime } from 'graphql-iso-date';\n â”Š 4â”Š 5â”Šimport { Pool } from 'pg';\n â”Š 5â”Š 6â”Šimport { pool } from '../../db';\n â”Š 6â”Š 7â”Šimport { Resolvers } from '../../types/graphql';\n â”Š 7â”Š 8â”Šimport { Database } from './database.provider';\n+â”Š  â”Š 9â”Šimport { PubSub } from './pubsub.provider';\n â”Š 8â”Š10â”Š\n â”Š 9â”Š11â”Šconst { PostgresPubSub } = require('graphql-postgres-subscriptions');\n â”Š10â”Š12â”Š\n```\n```diff\n@@ -45,6 +47,11 @@\n â”Š45â”Š47â”Š      provide: Pool,\n â”Š46â”Š48â”Š      useValue: pool,\n â”Š47â”Š49â”Š    },\n+â”Š  â”Š50â”Š    {\n+â”Š  â”Š51â”Š      provide: PubSub,\n+â”Š  â”Š52â”Š      scope: ProviderScope.Application,\n+â”Š  â”Š53â”Š      useValue: pubsub,\n+â”Š  â”Š54â”Š    },\n â”Š48â”Š55â”Š    Database,\n â”Š49â”Š56â”Š  ],\n â”Š50â”Š57â”Š  async context({ res, connection }) {\n```\n```diff\n@@ -55,7 +62,6 @@\n â”Š55â”Š62â”Š    }\n â”Š56â”Š63â”Š\n â”Š57â”Š64â”Š    return {\n-â”Š58â”Š  â”Š      pubsub,\n â”Š59â”Š65â”Š      res,\n â”Š60â”Š66â”Š      db,\n â”Š61â”Š67â”Š    };\n```\n\n##### Added modules&#x2F;common&#x2F;pubsub.provider.ts\n```diff\n@@ -0,0 +1 @@\n+â”Š â”Š1â”Šexport { PubSub } from 'apollo-server-express';\n```\n\n[}]: #\n\nNow, we're going to use `PubSub` within `Chats` service:\n\n[{]: <helper> (diffStep \"13.17\" module=\"server\")\n\n#### [__Server__ Step 13.17: Migrate addMessage to Chats provider](https://github.com/Urigo/WhatsApp-Clone-Server/commit/a5fc4ade5305e7a12632197421ad044396027389)\n\n##### Changed modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -1,12 +1,14 @@\n â”Š 1â”Š 1â”Šimport { Injectable, Inject, ProviderScope } from '@graphql-modules/di';\n â”Š 2â”Š 2â”Šimport sql from 'sql-template-strings';\n â”Š 3â”Š 3â”Šimport { Database } from '../common/database.provider';\n+â”Š  â”Š 4â”Šimport { PubSub } from '../common/pubsub.provider';\n â”Š 4â”Š 5â”Š\n â”Š 5â”Š 6â”Š@Injectable({\n â”Š 6â”Š 7â”Š  scope: ProviderScope.Session,\n â”Š 7â”Š 8â”Š})\n â”Š 8â”Š 9â”Šexport class Chats {\n â”Š 9â”Š10â”Š  @Inject() private db: Database;\n+â”Š  â”Š11â”Š  @Inject() private pubsub: PubSub;\n â”Š10â”Š12â”Š\n â”Š11â”Š13â”Š  async findChatsByUser(userId: string) {\n â”Š12â”Š14â”Š    const db = await this.db.getClient();\n```\n```diff\n@@ -94,4 +96,29 @@\n â”Š 94â”Š 96â”Š\n â”Š 95â”Š 97â”Š    return !!rows.length;\n â”Š 96â”Š 98â”Š  }\n+â”Š   â”Š 99â”Š\n+â”Š   â”Š100â”Š  async addMessage({\n+â”Š   â”Š101â”Š    chatId,\n+â”Š   â”Š102â”Š    userId,\n+â”Š   â”Š103â”Š    content,\n+â”Š   â”Š104â”Š  }: {\n+â”Š   â”Š105â”Š    chatId: string;\n+â”Š   â”Š106â”Š    userId: string;\n+â”Š   â”Š107â”Š    content: string;\n+â”Š   â”Š108â”Š  }) {\n+â”Š   â”Š109â”Š    const db = await this.db.getClient();\n+â”Š   â”Š110â”Š    const { rows } = await db.query(sql`\n+â”Š   â”Š111â”Š      INSERT INTO messages(chat_id, sender_user_id, content)\n+â”Š   â”Š112â”Š      VALUES(${chatId}, ${userId}, ${content})\n+â”Š   â”Š113â”Š      RETURNING *\n+â”Š   â”Š114â”Š    `);\n+â”Š   â”Š115â”Š\n+â”Š   â”Š116â”Š    const messageAdded = rows[0];\n+â”Š   â”Š117â”Š\n+â”Š   â”Š118â”Š    this.pubsub.publish('messageAdded', {\n+â”Š   â”Š119â”Š      messageAdded,\n+â”Š   â”Š120â”Š    });\n+â”Š   â”Š121â”Š\n+â”Š   â”Š122â”Š    return messageAdded;\n+â”Š   â”Š123â”Š  }\n â”Š 97â”Š124â”Š}\n```\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -129,22 +129,12 @@\n â”Š129â”Š129â”Š  },\n â”Š130â”Š130â”Š\n â”Š131â”Š131â”Š  Mutation: {\n-â”Š132â”Š   â”Š    async addMessage(root, { chatId, content }, { currentUser, injector, db }) {\n+â”Š   â”Š132â”Š    async addMessage(root, { chatId, content }, { currentUser, injector }) {\n â”Š133â”Š133â”Š      if (!currentUser) return null;\n â”Š134â”Š134â”Š\n-â”Š135â”Š   â”Š      const { rows } = await db.query(sql`\n-â”Š136â”Š   â”Š        INSERT INTO messages(chat_id, sender_user_id, content)\n-â”Š137â”Š   â”Š        VALUES(${chatId}, ${currentUser.id}, ${content})\n-â”Š138â”Š   â”Š        RETURNING *\n-â”Š139â”Š   â”Š      `);\n-â”Š140â”Š   â”Š\n-â”Š141â”Š   â”Š      const messageAdded = rows[0];\n-â”Š142â”Š   â”Š\n-â”Š143â”Š   â”Š      injector.get(PubSub).publish('messageAdded', {\n-â”Š144â”Š   â”Š        messageAdded,\n-â”Š145â”Š   â”Š      });\n-â”Š146â”Š   â”Š\n-â”Š147â”Š   â”Š      return messageAdded;\n+â”Š   â”Š135â”Š      return injector\n+â”Š   â”Š136â”Š        .get(Chats)\n+â”Š   â”Š137â”Š        .addMessage({ chatId, content, userId: currentUser.id });\n â”Š148â”Š138â”Š    },\n â”Š149â”Š139â”Š\n â”Š150â”Š140â”Š    async addChat(root, { recipientId }, { currentUser, injector, db }) {\n```\n\n[}]: #\n[{]: <helper> (diffStep \"13.18\" module=\"server\")\n\n#### [__Server__ Step 13.18: Migrate addChat to Chats provider](https://github.com/Urigo/WhatsApp-Clone-Server/commit/4213ec01669cd0d017cc45a563c7d916e226196b)\n\n##### Changed modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -121,4 +121,58 @@\n â”Š121â”Š121â”Š\n â”Š122â”Š122â”Š    return messageAdded;\n â”Š123â”Š123â”Š  }\n+â”Š   â”Š124â”Š\n+â”Š   â”Š125â”Š  async addChat({\n+â”Š   â”Š126â”Š    userId,\n+â”Š   â”Š127â”Š    recipientId,\n+â”Š   â”Š128â”Š  }: {\n+â”Š   â”Š129â”Š    userId: string;\n+â”Š   â”Š130â”Š    recipientId: string;\n+â”Š   â”Š131â”Š  }) {\n+â”Š   â”Š132â”Š    const db = await this.db.getClient();\n+â”Š   â”Š133â”Š    const { rows } = await db.query(sql`\n+â”Š   â”Š134â”Š      SELECT chats.* FROM chats, (SELECT * FROM chats_users WHERE user_id = ${userId}) AS chats_of_current_user, chats_users\n+â”Š   â”Š135â”Š      WHERE chats_users.chat_id = chats_of_current_user.chat_id\n+â”Š   â”Š136â”Š      AND chats.id = chats_users.chat_id\n+â”Š   â”Š137â”Š      AND chats_users.user_id = ${recipientId}\n+â”Š   â”Š138â”Š    `);\n+â”Š   â”Š139â”Š\n+â”Š   â”Š140â”Š    // If there is already a chat between these two users, return it\n+â”Š   â”Š141â”Š    if (rows[0]) {\n+â”Š   â”Š142â”Š      return rows[0];\n+â”Š   â”Š143â”Š    }\n+â”Š   â”Š144â”Š\n+â”Š   â”Š145â”Š    try {\n+â”Š   â”Š146â”Š      await db.query('BEGIN');\n+â”Š   â”Š147â”Š\n+â”Š   â”Š148â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š149â”Š        INSERT INTO chats\n+â”Š   â”Š150â”Š        DEFAULT VALUES\n+â”Š   â”Š151â”Š        RETURNING *\n+â”Š   â”Š152â”Š      `);\n+â”Š   â”Š153â”Š\n+â”Š   â”Š154â”Š      const chatAdded = rows[0];\n+â”Š   â”Š155â”Š\n+â”Š   â”Š156â”Š      await db.query(sql`\n+â”Š   â”Š157â”Š        INSERT INTO chats_users(chat_id, user_id)\n+â”Š   â”Š158â”Š        VALUES(${chatAdded.id}, ${userId})\n+â”Š   â”Š159â”Š      `);\n+â”Š   â”Š160â”Š\n+â”Š   â”Š161â”Š      await db.query(sql`\n+â”Š   â”Š162â”Š        INSERT INTO chats_users(chat_id, user_id)\n+â”Š   â”Š163â”Š        VALUES(${chatAdded.id}, ${recipientId})\n+â”Š   â”Š164â”Š      `);\n+â”Š   â”Š165â”Š\n+â”Š   â”Š166â”Š      await db.query('COMMIT');\n+â”Š   â”Š167â”Š\n+â”Š   â”Š168â”Š      this.pubsub.publish('chatAdded', {\n+â”Š   â”Š169â”Š        chatAdded,\n+â”Š   â”Š170â”Š      });\n+â”Š   â”Š171â”Š\n+â”Š   â”Š172â”Š      return chatAdded;\n+â”Š   â”Š173â”Š    } catch (e) {\n+â”Š   â”Š174â”Š      await db.query('ROLLBACK');\n+â”Š   â”Š175â”Š      throw e;\n+â”Š   â”Š176â”Š    }\n+â”Š   â”Š177â”Š  }\n â”Š124â”Š178â”Š}\n```\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -137,55 +137,12 @@\n â”Š137â”Š137â”Š        .addMessage({ chatId, content, userId: currentUser.id });\n â”Š138â”Š138â”Š    },\n â”Š139â”Š139â”Š\n-â”Š140â”Š   â”Š    async addChat(root, { recipientId }, { currentUser, injector, db }) {\n+â”Š   â”Š140â”Š    async addChat(root, { recipientId }, { currentUser, injector }) {\n â”Š141â”Š141â”Š      if (!currentUser) return null;\n â”Š142â”Š142â”Š\n-â”Š143â”Š   â”Š      const { rows } = await db.query(sql`\n-â”Š144â”Š   â”Š        SELECT chats.* FROM chats, (SELECT * FROM chats_users WHERE user_id = ${\n-â”Š145â”Š   â”Š          currentUser.id\n-â”Š146â”Š   â”Š        }) AS chats_of_current_user, chats_users\n-â”Š147â”Š   â”Š        WHERE chats_users.chat_id = chats_of_current_user.chat_id\n-â”Š148â”Š   â”Š        AND chats.id = chats_users.chat_id\n-â”Š149â”Š   â”Š        AND chats_users.user_id = ${recipientId}\n-â”Š150â”Š   â”Š      `);\n-â”Š151â”Š   â”Š\n-â”Š152â”Š   â”Š      // If there is already a chat between these two users, return it\n-â”Š153â”Š   â”Š      if (rows[0]) {\n-â”Š154â”Š   â”Š        return rows[0];\n-â”Š155â”Š   â”Š      }\n-â”Š156â”Š   â”Š\n-â”Š157â”Š   â”Š      try {\n-â”Š158â”Š   â”Š        await db.query('BEGIN');\n-â”Š159â”Š   â”Š\n-â”Š160â”Š   â”Š        const { rows } = await db.query(sql`\n-â”Š161â”Š   â”Š          INSERT INTO chats\n-â”Š162â”Š   â”Š          DEFAULT VALUES\n-â”Š163â”Š   â”Š          RETURNING *\n-â”Š164â”Š   â”Š        `);\n-â”Š165â”Š   â”Š\n-â”Š166â”Š   â”Š        const chatAdded = rows[0];\n-â”Š167â”Š   â”Š\n-â”Š168â”Š   â”Š        await db.query(sql`\n-â”Š169â”Š   â”Š          INSERT INTO chats_users(chat_id, user_id)\n-â”Š170â”Š   â”Š          VALUES(${chatAdded.id}, ${currentUser.id})\n-â”Š171â”Š   â”Š        `);\n-â”Š172â”Š   â”Š\n-â”Š173â”Š   â”Š        await db.query(sql`\n-â”Š174â”Š   â”Š          INSERT INTO chats_users(chat_id, user_id)\n-â”Š175â”Š   â”Š          VALUES(${chatAdded.id}, ${recipientId})\n-â”Š176â”Š   â”Š        `);\n-â”Š177â”Š   â”Š\n-â”Š178â”Š   â”Š        await db.query('COMMIT');\n-â”Š179â”Š   â”Š\n-â”Š180â”Š   â”Š        injector.get(PubSub).publish('chatAdded', {\n-â”Š181â”Š   â”Š          chatAdded,\n-â”Š182â”Š   â”Š        });\n-â”Š183â”Š   â”Š\n-â”Š184â”Š   â”Š        return chatAdded;\n-â”Š185â”Š   â”Š      } catch (e) {\n-â”Š186â”Š   â”Š        await db.query('ROLLBACK');\n-â”Š187â”Š   â”Š        throw e;\n-â”Š188â”Š   â”Š      }\n+â”Š   â”Š143â”Š      return injector\n+â”Š   â”Š144â”Š        .get(Chats)\n+â”Š   â”Š145â”Š        .addChat({ recipientId, userId: currentUser.id });\n â”Š189â”Š146â”Š    },\n â”Š190â”Š147â”Š\n â”Š191â”Š148â”Š    async removeChat(root, { chatId }, { currentUser, injector, db }) {\n```\n\n[}]: #\n[{]: <helper> (diffStep \"13.19\" module=\"server\")\n\n#### [__Server__ Step 13.19: Migrate removeChat to Chats provider](https://github.com/Urigo/WhatsApp-Clone-Server/commit/bd3309b80f9378924d4900c78c3dcfd80b2290bf)\n\n##### Changed modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -175,4 +175,42 @@\n â”Š175â”Š175â”Š      throw e;\n â”Š176â”Š176â”Š    }\n â”Š177â”Š177â”Š  }\n+â”Š   â”Š178â”Š\n+â”Š   â”Š179â”Š  async removeChat({ chatId, userId }: { chatId: string; userId: string }) {\n+â”Š   â”Š180â”Š    const db = await this.db.getClient();\n+â”Š   â”Š181â”Š\n+â”Š   â”Š182â”Š    try {\n+â”Š   â”Š183â”Š      await db.query('BEGIN');\n+â”Š   â”Š184â”Š\n+â”Š   â”Š185â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š186â”Š        SELECT chats.* FROM chats, chats_users\n+â”Š   â”Š187â”Š        WHERE id = ${chatId}\n+â”Š   â”Š188â”Š        AND chats.id = chats_users.chat_id\n+â”Š   â”Š189â”Š        AND chats_users.user_id = ${userId}\n+â”Š   â”Š190â”Š      `);\n+â”Š   â”Š191â”Š\n+â”Š   â”Š192â”Š      const chat = rows[0];\n+â”Š   â”Š193â”Š\n+â”Š   â”Š194â”Š      if (!chat) {\n+â”Š   â”Š195â”Š        await db.query('ROLLBACK');\n+â”Š   â”Š196â”Š        return null;\n+â”Š   â”Š197â”Š      }\n+â”Š   â”Š198â”Š\n+â”Š   â”Š199â”Š      await db.query(sql`\n+â”Š   â”Š200â”Š        DELETE FROM chats WHERE chats.id = ${chatId}\n+â”Š   â”Š201â”Š      `);\n+â”Š   â”Š202â”Š\n+â”Š   â”Š203â”Š      this.pubsub.publish('chatRemoved', {\n+â”Š   â”Š204â”Š        chatRemoved: chat.id,\n+â”Š   â”Š205â”Š        targetChat: chat,\n+â”Š   â”Š206â”Š      });\n+â”Š   â”Š207â”Š\n+â”Š   â”Š208â”Š      await db.query('COMMIT');\n+â”Š   â”Š209â”Š\n+â”Š   â”Š210â”Š      return chatId;\n+â”Š   â”Š211â”Š    } catch (e) {\n+â”Š   â”Š212â”Š      await db.query('ROLLBACK');\n+â”Š   â”Š213â”Š      throw e;\n+â”Š   â”Š214â”Š    }\n+â”Š   â”Š215â”Š  }\n â”Š178â”Š216â”Š}\n```\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -145,42 +145,10 @@\n â”Š145â”Š145â”Š        .addChat({ recipientId, userId: currentUser.id });\n â”Š146â”Š146â”Š    },\n â”Š147â”Š147â”Š\n-â”Š148â”Š   â”Š    async removeChat(root, { chatId }, { currentUser, injector, db }) {\n+â”Š   â”Š148â”Š    async removeChat(root, { chatId }, { currentUser, injector }) {\n â”Š149â”Š149â”Š      if (!currentUser) return null;\n â”Š150â”Š150â”Š\n-â”Š151â”Š   â”Š      try {\n-â”Š152â”Š   â”Š        await db.query('BEGIN');\n-â”Š153â”Š   â”Š\n-â”Š154â”Š   â”Š        const { rows } = await db.query(sql`\n-â”Š155â”Š   â”Š          SELECT chats.* FROM chats, chats_users\n-â”Š156â”Š   â”Š          WHERE id = ${chatId}\n-â”Š157â”Š   â”Š          AND chats.id = chats_users.chat_id\n-â”Š158â”Š   â”Š          AND chats_users.user_id = ${currentUser.id}\n-â”Š159â”Š   â”Š        `);\n-â”Š160â”Š   â”Š\n-â”Š161â”Š   â”Š        const chat = rows[0];\n-â”Š162â”Š   â”Š\n-â”Š163â”Š   â”Š        if (!chat) {\n-â”Š164â”Š   â”Š          await db.query('ROLLBACK');\n-â”Š165â”Š   â”Š          return null;\n-â”Š166â”Š   â”Š        }\n-â”Š167â”Š   â”Š\n-â”Š168â”Š   â”Š        await db.query(sql`\n-â”Š169â”Š   â”Š          DELETE FROM chats WHERE chats.id = ${chatId}\n-â”Š170â”Š   â”Š        `);\n-â”Š171â”Š   â”Š\n-â”Š172â”Š   â”Š        injector.get(PubSub).publish('chatRemoved', {\n-â”Š173â”Š   â”Š          chatRemoved: chat.id,\n-â”Š174â”Š   â”Š          targetChat: chat,\n-â”Š175â”Š   â”Š        });\n-â”Š176â”Š   â”Š\n-â”Š177â”Š   â”Š        await db.query('COMMIT');\n-â”Š178â”Š   â”Š\n-â”Š179â”Š   â”Š        return chatId;\n-â”Š180â”Š   â”Š      } catch (e) {\n-â”Š181â”Š   â”Š        await db.query('ROLLBACK');\n-â”Š182â”Š   â”Š        throw e;\n-â”Š183â”Š   â”Š      }\n+â”Š   â”Š151â”Š      return injector.get(Chats).removeChat({ chatId, userId: currentUser.id });\n â”Š184â”Š152â”Š    },\n â”Š185â”Š153â”Š  },\n```\n\n[}]: #\n\n#### Implementing Auth service\n\nThe last missing piece of our \"context migration\" journey is `currentUser` object. We're going to define the `Auth` service.\n\n[{]: <helper> (diffStep \"13.20\" files=\"modules/users/auth.provider.ts\" module=\"server\")\n\n#### [__Server__ Step 13.20: Implement Auth provider with currentUser method](https://github.com/Urigo/WhatsApp-Clone-Server/commit/b7ff125fc6f3f66eca49aa97ba7de0596c9eefd5)\n\n##### Added modules&#x2F;users&#x2F;auth.provider.ts\n```diff\n@@ -0,0 +1,30 @@\n+â”Š  â”Š 1â”Šimport { Injectable, Inject, ProviderScope } from '@graphql-modules/di';\n+â”Š  â”Š 2â”Šimport { ModuleSessionInfo } from '@graphql-modules/core';\n+â”Š  â”Š 3â”Šimport jwt from 'jsonwebtoken';\n+â”Š  â”Š 4â”Šimport { secret } from '../../env';\n+â”Š  â”Š 5â”Šimport { Users } from './users.provider';\n+â”Š  â”Š 6â”Šimport { User } from '../../db';\n+â”Š  â”Š 7â”Š\n+â”Š  â”Š 8â”Š@Injectable({\n+â”Š  â”Š 9â”Š  scope: ProviderScope.Session,\n+â”Š  â”Š10â”Š})\n+â”Š  â”Š11â”Šexport class Auth {\n+â”Š  â”Š12â”Š  @Inject() private users: Users;\n+â”Š  â”Š13â”Š  @Inject() private module: ModuleSessionInfo;\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”Š  private get req() {\n+â”Š  â”Š16â”Š    return this.module.session.req || this.module.session.request;\n+â”Š  â”Š17â”Š  }\n+â”Š  â”Š18â”Š\n+â”Š  â”Š19â”Š  async currentUser(): Promise<User | null> {\n+â”Š  â”Š20â”Š    if (this.req.cookies.authToken) {\n+â”Š  â”Š21â”Š      const username = jwt.verify(this.req.cookies.authToken, secret) as string;\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Š      if (username) {\n+â”Š  â”Š24â”Š        return this.users.findByUsername(username);\n+â”Š  â”Š25â”Š      }\n+â”Š  â”Š26â”Š    }\n+â”Š  â”Š27â”Š\n+â”Š  â”Š28â”Š    return null;\n+â”Š  â”Š29â”Š  }\n+â”Š  â”Š30â”Š}\n```\n\n[}]: #\n\nIt still needs to be registered and few resolvers in Users module have to be migrated:\n\n[{]: <helper> (diffStep \"13.20\" files=\"modules/users/index.ts, context.ts\" module=\"server\")\n\n#### [__Server__ Step 13.20: Implement Auth provider with currentUser method](https://github.com/Urigo/WhatsApp-Clone-Server/commit/b7ff125fc6f3f66eca49aa97ba7de0596c9eefd5)\n\n##### Changed context.ts\n```diff\n@@ -1,10 +1,8 @@\n â”Š 1â”Š 1â”Šimport { ModuleContext } from '@graphql-modules/core';\n-â”Š 2â”Š  â”Šimport { User } from './db';\n â”Š 3â”Š 2â”Šimport { Response } from 'express';\n â”Š 4â”Š 3â”Šimport { PoolClient } from 'pg';\n â”Š 5â”Š 4â”Š\n â”Š 6â”Š 5â”Šexport type MyContext = {\n-â”Š 7â”Š  â”Š  currentUser: User;\n â”Š 8â”Š 6â”Š  res: Response;\n â”Š 9â”Š 7â”Š  db: PoolClient;\n â”Š10â”Š 8â”Š} & ModuleContext;\n```\n\n##### Changed modules&#x2F;users&#x2F;index.ts\n```diff\n@@ -1,6 +1,5 @@\n â”Š1â”Š1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š2â”Š2â”Šimport { gql } from 'apollo-server-express';\n-â”Š3â”Š â”Šimport cookie from 'cookie';\n â”Š4â”Š3â”Šimport sql from 'sql-template-strings';\n â”Š5â”Š4â”Šimport bcrypt from 'bcrypt';\n â”Š6â”Š5â”Šimport jwt from 'jsonwebtoken';\n```\n```diff\n@@ -10,6 +9,7 @@\n â”Š10â”Š 9â”Šimport { validateLength, validatePassword } from '../../validators';\n â”Š11â”Š10â”Šimport { Resolvers } from '../../types/graphql';\n â”Š12â”Š11â”Šimport { Users } from './users.provider';\n+â”Š  â”Š12â”Šimport { Auth } from './auth.provider';\n â”Š13â”Š13â”Š\n â”Š14â”Š14â”Šconst typeDefs = gql`\n â”Š15â”Š15â”Š  type User {\n```\n```diff\n@@ -36,10 +36,12 @@\n â”Š36â”Š36â”Š\n â”Š37â”Š37â”Šconst resolvers: Resolvers = {\n â”Š38â”Š38â”Š  Query: {\n-â”Š39â”Š  â”Š    me(root, args, { currentUser }) {\n-â”Š40â”Š  â”Š      return currentUser || null;\n+â”Š  â”Š39â”Š    me(root, args, { injector }) {\n+â”Š  â”Š40â”Š      return injector.get(Auth).currentUser();\n â”Š41â”Š41â”Š    },\n-â”Š42â”Š  â”Š    async users(root, args, { currentUser, injector }) {\n+â”Š  â”Š42â”Š    async users(root, args, { injector }) {\n+â”Š  â”Š43â”Š      const currentUser = await injector.get(Auth).currentUser();\n+â”Š  â”Š44â”Š\n â”Š43â”Š45â”Š      if (!currentUser) return [];\n â”Š44â”Š46â”Š\n â”Š45â”Š47â”Š      return injector.get(Users).findAllExcept(currentUser.id);\n```\n```diff\n@@ -100,33 +102,5 @@\n â”Š100â”Š102â”Š  typeDefs,\n â”Š101â”Š103â”Š  resolvers,\n â”Š102â”Š104â”Š  imports: () => [commonModule],\n-â”Š103â”Š   â”Š  providers: () => [Users],\n-â”Š104â”Š   â”Š  async context(session) {\n-â”Š105â”Š   â”Š    let currentUser;\n-â”Š106â”Š   â”Š\n-â”Š107â”Š   â”Š    // Access the request object\n-â”Š108â”Š   â”Š    let req = session.connection\n-â”Š109â”Š   â”Š      ? session.connection.context.request\n-â”Š110â”Š   â”Š      : session.req;\n-â”Š111â”Š   â”Š\n-â”Š112â”Š   â”Š    // It's subscription\n-â”Š113â”Š   â”Š    if (session.connection) {\n-â”Š114â”Š   â”Š      req.cookies = cookie.parse(req.headers.cookie || '');\n-â”Š115â”Š   â”Š    }\n-â”Š116â”Š   â”Š\n-â”Š117â”Š   â”Š    if (req.cookies.authToken) {\n-â”Š118â”Š   â”Š      const username = jwt.verify(req.cookies.authToken, secret) as string;\n-â”Š119â”Š   â”Š\n-â”Š120â”Š   â”Š      if (username) {\n-â”Š121â”Š   â”Š        const { rows } = await pool.query(\n-â”Š122â”Š   â”Š          sql`SELECT * FROM users WHERE username = ${username}`\n-â”Š123â”Š   â”Š        );\n-â”Š124â”Š   â”Š        currentUser = rows[0];\n-â”Š125â”Š   â”Š      }\n-â”Š126â”Š   â”Š    }\n-â”Š127â”Š   â”Š\n-â”Š128â”Š   â”Š    return {\n-â”Š129â”Š   â”Š      currentUser,\n-â”Š130â”Š   â”Š    };\n-â”Š131â”Š   â”Š  },\n+â”Š   â”Š105â”Š  providers: () => [Users, Auth],\n â”Š132â”Š106â”Š});\n```\n\n[}]: #\n\nNow let's use the Auth service in Chats:\n\n[{]: <helper> (diffStep \"13.20\" files=\"modules/chats/index.ts\" module=\"server\")\n\n#### [__Server__ Step 13.20: Implement Auth provider with currentUser method](https://github.com/Urigo/WhatsApp-Clone-Server/commit/b7ff125fc6f3f66eca49aa97ba7de0596c9eefd5)\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -7,6 +7,7 @@\n â”Š 7â”Š 7â”Šimport { Resolvers } from '../../types/graphql';\n â”Š 8â”Š 8â”Šimport { UnsplashApi } from './unsplash.api';\n â”Š 9â”Š 9â”Šimport { Users } from './../users/users.provider';\n+â”Š  â”Š10â”Šimport { Auth } from './../users/auth.provider';\n â”Š10â”Š11â”Šimport { Chats } from './chats.provider';\n â”Š11â”Š12â”Šimport { PubSub } from '../common/pubsub.provider';\n â”Š12â”Š13â”Š\n```\n```diff\n@@ -69,13 +70,16 @@\n â”Š69â”Š70â”Š      });\n â”Š70â”Š71â”Š    },\n â”Š71â”Š72â”Š\n-â”Š72â”Š  â”Š    isMine(message, args, { currentUser }) {\n-â”Š73â”Š  â”Š      return message.sender_user_id === currentUser.id;\n+â”Š  â”Š73â”Š    async isMine(message, args, { injector }) {\n+â”Š  â”Š74â”Š      const currentUser = await injector.get(Auth).currentUser();\n+â”Š  â”Š75â”Š      return message.sender_user_id === currentUser!.id;\n â”Š74â”Š76â”Š    },\n â”Š75â”Š77â”Š  },\n â”Š76â”Š78â”Š\n â”Š77â”Š79â”Š  Chat: {\n-â”Š78â”Š  â”Š    async name(chat, args, { currentUser, injector }) {\n+â”Š  â”Š80â”Š    async name(chat, args, { injector }) {\n+â”Š  â”Š81â”Š      const currentUser = await injector.get(Auth).currentUser();\n+â”Š  â”Š82â”Š\n â”Š79â”Š83â”Š      if (!currentUser) return null;\n â”Š80â”Š84â”Š\n â”Š81â”Š85â”Š      const participant = await injector.get(Chats).firstRecipient({\n```\n```diff\n@@ -86,7 +90,9 @@\n â”Š86â”Š90â”Š      return participant ? participant.name : null;\n â”Š87â”Š91â”Š    },\n â”Š88â”Š92â”Š\n-â”Š89â”Š  â”Š    async picture(chat, args, { currentUser, db, injector }) {\n+â”Š  â”Š93â”Š    async picture(chat, args, { injector }) {\n+â”Š  â”Š94â”Š      const currentUser = await injector.get(Auth).currentUser();\n+â”Š  â”Š95â”Š\n â”Š90â”Š96â”Š      if (!currentUser) return null;\n â”Š91â”Š97â”Š\n â”Š92â”Š98â”Š      const participant = await injector.get(Chats).firstRecipient({\n```\n```diff\n@@ -113,13 +119,17 @@\n â”Š113â”Š119â”Š  },\n â”Š114â”Š120â”Š\n â”Š115â”Š121â”Š  Query: {\n-â”Š116â”Š   â”Š    async chats(root, args, { currentUser, injector }) {\n+â”Š   â”Š122â”Š    async chats(root, args, { injector }) {\n+â”Š   â”Š123â”Š      const currentUser = await injector.get(Auth).currentUser();\n+â”Š   â”Š124â”Š\n â”Š117â”Š125â”Š      if (!currentUser) return [];\n â”Š118â”Š126â”Š\n â”Š119â”Š127â”Š      return injector.get(Chats).findChatsByUser(currentUser.id);\n â”Š120â”Š128â”Š    },\n â”Š121â”Š129â”Š\n-â”Š122â”Š   â”Š    async chat(root, { chatId }, { currentUser, injector }) {\n+â”Š   â”Š130â”Š    async chat(root, { chatId }, { injector }) {\n+â”Š   â”Š131â”Š      const currentUser = await injector.get(Auth).currentUser();\n+â”Š   â”Š132â”Š\n â”Š123â”Š133â”Š      if (!currentUser) return null;\n â”Š124â”Š134â”Š\n â”Š125â”Š135â”Š      return injector\n```\n```diff\n@@ -129,7 +139,9 @@\n â”Š129â”Š139â”Š  },\n â”Š130â”Š140â”Š\n â”Š131â”Š141â”Š  Mutation: {\n-â”Š132â”Š   â”Š    async addMessage(root, { chatId, content }, { currentUser, injector }) {\n+â”Š   â”Š142â”Š    async addMessage(root, { chatId, content }, { injector }) {\n+â”Š   â”Š143â”Š      const currentUser = await injector.get(Auth).currentUser();\n+â”Š   â”Š144â”Š\n â”Š133â”Š145â”Š      if (!currentUser) return null;\n â”Š134â”Š146â”Š\n â”Š135â”Š147â”Š      return injector\n```\n```diff\n@@ -137,7 +149,9 @@\n â”Š137â”Š149â”Š        .addMessage({ chatId, content, userId: currentUser.id });\n â”Š138â”Š150â”Š    },\n â”Š139â”Š151â”Š\n-â”Š140â”Š   â”Š    async addChat(root, { recipientId }, { currentUser, injector }) {\n+â”Š   â”Š152â”Š    async addChat(root, { recipientId }, { injector }) {\n+â”Š   â”Š153â”Š      const currentUser = await injector.get(Auth).currentUser();\n+â”Š   â”Š154â”Š\n â”Š141â”Š155â”Š      if (!currentUser) return null;\n â”Š142â”Š156â”Š\n â”Š143â”Š157â”Š      return injector\n```\n```diff\n@@ -145,7 +159,9 @@\n â”Š145â”Š159â”Š        .addChat({ recipientId, userId: currentUser.id });\n â”Š146â”Š160â”Š    },\n â”Š147â”Š161â”Š\n-â”Š148â”Š   â”Š    async removeChat(root, { chatId }, { currentUser, injector }) {\n+â”Š   â”Š162â”Š    async removeChat(root, { chatId }, { injector }) {\n+â”Š   â”Š163â”Š      const currentUser = await injector.get(Auth).currentUser();\n+â”Š   â”Š164â”Š\n â”Š149â”Š165â”Š      if (!currentUser) return null;\n â”Š150â”Š166â”Š\n â”Š151â”Š167â”Š      return injector.get(Chats).removeChat({ chatId, userId: currentUser.id });\n```\n```diff\n@@ -160,8 +176,10 @@\n â”Š160â”Š176â”Š        async (\n â”Š161â”Š177â”Š          { messageAdded }: { messageAdded: Message },\n â”Š162â”Š178â”Š          args,\n-â”Š163â”Š   â”Š          { currentUser, injector }\n+â”Š   â”Š179â”Š          { injector }\n â”Š164â”Š180â”Š        ) => {\n+â”Š   â”Š181â”Š          const currentUser = await injector.get(Auth).currentUser();\n+â”Š   â”Š182â”Š\n â”Š165â”Š183â”Š          if (!currentUser) return false;\n â”Š166â”Š184â”Š\n â”Š167â”Š185â”Š          return injector.get(Chats).isParticipant({\n```\n```diff\n@@ -176,11 +194,9 @@\n â”Š176â”Š194â”Š      subscribe: withFilter(\n â”Š177â”Š195â”Š        (root, args, { injector }) =>\n â”Š178â”Š196â”Š          injector.get(PubSub).asyncIterator('chatAdded'),\n-â”Š179â”Š   â”Š        async (\n-â”Š180â”Š   â”Š          { chatAdded }: { chatAdded: Chat },\n-â”Š181â”Š   â”Š          args,\n-â”Š182â”Š   â”Š          { currentUser, injector }\n-â”Š183â”Š   â”Š        ) => {\n+â”Š   â”Š197â”Š        async ({ chatAdded }: { chatAdded: Chat }, args, { injector }) => {\n+â”Š   â”Š198â”Š          const currentUser = await injector.get(Auth).currentUser();\n+â”Š   â”Š199â”Š\n â”Š184â”Š200â”Š          if (!currentUser) return false;\n â”Š185â”Š201â”Š\n â”Š186â”Š202â”Š          return injector.get(Chats).isParticipant({\n```\n```diff\n@@ -195,11 +211,9 @@\n â”Š195â”Š211â”Š      subscribe: withFilter(\n â”Š196â”Š212â”Š        (root, args, { injector }) =>\n â”Š197â”Š213â”Š          injector.get(PubSub).asyncIterator('chatRemoved'),\n-â”Š198â”Š   â”Š        async (\n-â”Š199â”Š   â”Š          { targetChat }: { targetChat: Chat },\n-â”Š200â”Š   â”Š          args,\n-â”Š201â”Š   â”Š          { currentUser, injector }\n-â”Š202â”Š   â”Š        ) => {\n+â”Š   â”Š214â”Š        async ({ targetChat }: { targetChat: Chat }, args, { injector }) => {\n+â”Š   â”Š215â”Š          const currentUser = await injector.get(Auth).currentUser();\n+â”Š   â”Š216â”Š\n â”Š203â”Š217â”Š          if (!currentUser) return false;\n â”Š204â”Š218â”Š\n â”Š205â”Š219â”Š          return injector.get(Chats).isParticipant({\n```\n\n[}]: #\n\nBecause we no longer need `db` instance in the context, let's remove it:\n\n[{]: <helper> (diffStep \"13.21\" module=\"server\")\n\n#### [__Server__ Step 13.21: Remove db from context](https://github.com/Urigo/WhatsApp-Clone-Server/commit/7b4e4d82df6e1adde56229a087911d6f7e899d3c)\n\n##### Changed context.ts\n```diff\n@@ -1,8 +1,6 @@\n â”Š1â”Š1â”Šimport { ModuleContext } from '@graphql-modules/core';\n â”Š2â”Š2â”Šimport { Response } from 'express';\n-â”Š3â”Š â”Šimport { PoolClient } from 'pg';\n â”Š4â”Š3â”Š\n â”Š5â”Š4â”Šexport type MyContext = {\n â”Š6â”Š5â”Š  res: Response;\n-â”Š7â”Š â”Š  db: PoolClient;\n â”Š8â”Š6â”Š} & ModuleContext;\n```\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -1,9 +1,8 @@\n â”Š1â”Š1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š2â”Š2â”Šimport { gql, withFilter } from 'apollo-server-express';\n-â”Š3â”Š â”Šimport sql from 'sql-template-strings';\n â”Š4â”Š3â”Šimport commonModule from '../common';\n â”Š5â”Š4â”Šimport usersModule from '../users';\n-â”Š6â”Š â”Šimport { Message, Chat, pool } from '../../db';\n+â”Š â”Š5â”Šimport { Message, Chat } from '../../db';\n â”Š7â”Š6â”Šimport { Resolvers } from '../../types/graphql';\n â”Š8â”Š7â”Šimport { UnsplashApi } from './unsplash.api';\n â”Š9â”Š8â”Šimport { Users } from './../users/users.provider';\n```\n\n##### Changed modules&#x2F;common&#x2F;index.ts\n```diff\n@@ -54,16 +54,9 @@\n â”Š54â”Š54â”Š    },\n â”Š55â”Š55â”Š    Database,\n â”Š56â”Š56â”Š  ],\n-â”Š57â”Š  â”Š  async context({ res, connection }) {\n-â”Š58â”Š  â”Š    let db;\n-â”Š59â”Š  â”Š\n-â”Š60â”Š  â”Š    if (!connection) {\n-â”Š61â”Š  â”Š      db = await pool.connect();\n-â”Š62â”Š  â”Š    }\n-â”Š63â”Š  â”Š\n+â”Š  â”Š57â”Š  async context({ res }) {\n â”Š64â”Š58â”Š    return {\n â”Š65â”Š59â”Š      res,\n-â”Š66â”Š  â”Š      db,\n â”Š67â”Š60â”Š    };\n â”Š68â”Š61â”Š  },\n â”Š69â”Š62â”Š});\n```\n\n##### Changed modules&#x2F;users&#x2F;index.ts\n```diff\n@@ -1,11 +1,9 @@\n â”Š 1â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š 2â”Š 2â”Šimport { gql } from 'apollo-server-express';\n-â”Š 3â”Š  â”Šimport sql from 'sql-template-strings';\n â”Š 4â”Š 3â”Šimport bcrypt from 'bcrypt';\n â”Š 5â”Š 4â”Šimport jwt from 'jsonwebtoken';\n â”Š 6â”Š 5â”Šimport commonModule from '../common';\n â”Š 7â”Š 6â”Šimport { secret, expiration } from '../../env';\n-â”Š 8â”Š  â”Šimport { pool } from '../../db';\n â”Š 9â”Š 7â”Šimport { validateLength, validatePassword } from '../../validators';\n â”Š10â”Š 8â”Šimport { Resolvers } from '../../types/graphql';\n â”Š11â”Š 9â”Šimport { Users } from './users.provider';\n```\n\n[}]: #\n\nBesides the `currentUser` method we're going to have two more, one to sign in and the other to sign up:\n\n[{]: <helper> (diffStep \"13.22\" module=\"server\")\n\n#### [__Server__ Step 13.22: Move signUp logic to Auth provider](https://github.com/Urigo/WhatsApp-Clone-Server/commit/f9b04da64f48fc297ab58f5313b6c798f8718317)\n\n##### Changed modules&#x2F;users&#x2F;auth.provider.ts\n```diff\n@@ -2,6 +2,7 @@\n â”Š2â”Š2â”Šimport { ModuleSessionInfo } from '@graphql-modules/core';\n â”Š3â”Š3â”Šimport jwt from 'jsonwebtoken';\n â”Š4â”Š4â”Šimport { secret } from '../../env';\n+â”Š â”Š5â”Šimport { validateLength, validatePassword } from '../../validators';\n â”Š5â”Š6â”Šimport { Users } from './users.provider';\n â”Š6â”Š7â”Šimport { User } from '../../db';\n â”Š7â”Š8â”Š\n```\n```diff\n@@ -16,6 +17,38 @@\n â”Š16â”Š17â”Š    return this.module.session.req || this.module.session.request;\n â”Š17â”Š18â”Š  }\n â”Š18â”Š19â”Š\n+â”Š  â”Š20â”Š  async signUp({\n+â”Š  â”Š21â”Š    name,\n+â”Š  â”Š22â”Š    password,\n+â”Š  â”Š23â”Š    passwordConfirm,\n+â”Š  â”Š24â”Š    username,\n+â”Š  â”Š25â”Š  }: {\n+â”Š  â”Š26â”Š    name: string;\n+â”Š  â”Š27â”Š    password: string;\n+â”Š  â”Š28â”Š    passwordConfirm: string;\n+â”Š  â”Š29â”Š    username: string;\n+â”Š  â”Š30â”Š  }) {\n+â”Š  â”Š31â”Š    validateLength('req.name', name, 3, 50);\n+â”Š  â”Š32â”Š    validateLength('req.username', username, 3, 18);\n+â”Š  â”Š33â”Š    validatePassword('req.password', password);\n+â”Š  â”Š34â”Š\n+â”Š  â”Š35â”Š    if (password !== passwordConfirm) {\n+â”Š  â”Š36â”Š      throw Error(\"req.password and req.passwordConfirm don't match\");\n+â”Š  â”Š37â”Š    }\n+â”Š  â”Š38â”Š\n+â”Š  â”Š39â”Š    const existingUser = await this.users.findByUsername(username);\n+â”Š  â”Š40â”Š\n+â”Š  â”Š41â”Š    if (existingUser) {\n+â”Š  â”Š42â”Š      throw Error('username already exists');\n+â”Š  â”Š43â”Š    }\n+â”Š  â”Š44â”Š\n+â”Š  â”Š45â”Š    return this.users.newUser({\n+â”Š  â”Š46â”Š      username,\n+â”Š  â”Š47â”Š      name,\n+â”Š  â”Š48â”Š      password,\n+â”Š  â”Š49â”Š    });\n+â”Š  â”Š50â”Š  }\n+â”Š  â”Š51â”Š\n â”Š19â”Š52â”Š  async currentUser(): Promise<User | null> {\n â”Š20â”Š53â”Š    if (this.req.cookies.authToken) {\n â”Š21â”Š54â”Š      const username = jwt.verify(this.req.cookies.authToken, secret) as string;\n```\n\n##### Changed modules&#x2F;users&#x2F;index.ts\n```diff\n@@ -4,7 +4,6 @@\n â”Š 4â”Š 4â”Šimport jwt from 'jsonwebtoken';\n â”Š 5â”Š 5â”Šimport commonModule from '../common';\n â”Š 6â”Š 6â”Šimport { secret, expiration } from '../../env';\n-â”Š 7â”Š  â”Šimport { validateLength, validatePassword } from '../../validators';\n â”Š 8â”Š 7â”Šimport { Resolvers } from '../../types/graphql';\n â”Š 9â”Š 8â”Šimport { Users } from './users.provider';\n â”Š10â”Š 9â”Šimport { Auth } from './auth.provider';\n```\n```diff\n@@ -71,26 +70,9 @@\n â”Š71â”Š70â”Š      { name, username, password, passwordConfirm },\n â”Š72â”Š71â”Š      { injector }\n â”Š73â”Š72â”Š    ) {\n-â”Š74â”Š  â”Š      validateLength('req.name', name, 3, 50);\n-â”Š75â”Š  â”Š      validateLength('req.username', username, 3, 18);\n-â”Š76â”Š  â”Š      validatePassword('req.password', password);\n-â”Š77â”Š  â”Š\n-â”Š78â”Š  â”Š      if (password !== passwordConfirm) {\n-â”Š79â”Š  â”Š        throw Error(\"req.password and req.passwordConfirm don't match\");\n-â”Š80â”Š  â”Š      }\n-â”Š81â”Š  â”Š\n-â”Š82â”Š  â”Š      const existingUser = await injector.get(Users).findByUsername(username);\n-â”Š83â”Š  â”Š      if (existingUser) {\n-â”Š84â”Š  â”Š        throw Error('username already exists');\n-â”Š85â”Š  â”Š      }\n-â”Š86â”Š  â”Š\n-â”Š87â”Š  â”Š      const createdUser = await injector.get(Users).newUser({\n-â”Š88â”Š  â”Š        username,\n-â”Š89â”Š  â”Š        password,\n-â”Š90â”Š  â”Š        name,\n-â”Š91â”Š  â”Š      });\n-â”Š92â”Š  â”Š\n-â”Š93â”Š  â”Š      return createdUser;\n+â”Š  â”Š73â”Š      return injector\n+â”Š  â”Š74â”Š        .get(Auth)\n+â”Š  â”Š75â”Š        .signUp({ name, username, password, passwordConfirm });\n â”Š94â”Š76â”Š    },\n â”Š95â”Š77â”Š  },\n â”Š96â”Š78â”Š};\n```\n\n[}]: #\n[{]: <helper> (diffStep \"13.23\" module=\"server\")\n\n#### [__Server__ Step 13.23: Move signIn logic to Auth provider](https://github.com/Urigo/WhatsApp-Clone-Server/commit/865987d0f59da831c82341cb5cb9c42dfd1ec1e8)\n\n##### Changed context.ts\n```diff\n@@ -1,6 +1,3 @@\n â”Š1â”Š1â”Šimport { ModuleContext } from '@graphql-modules/core';\n-â”Š2â”Š â”Šimport { Response } from 'express';\n â”Š3â”Š2â”Š\n-â”Š4â”Š â”Šexport type MyContext = {\n-â”Š5â”Š â”Š  res: Response;\n-â”Š6â”Š â”Š} & ModuleContext;\n+â”Š â”Š3â”Šexport type MyContext = ModuleContext;\n```\n\n##### Changed modules&#x2F;common&#x2F;index.ts\n```diff\n@@ -54,9 +54,4 @@\n â”Š54â”Š54â”Š    },\n â”Š55â”Š55â”Š    Database,\n â”Š56â”Š56â”Š  ],\n-â”Š57â”Š  â”Š  async context({ res }) {\n-â”Š58â”Š  â”Š    return {\n-â”Š59â”Š  â”Š      res,\n-â”Š60â”Š  â”Š    };\n-â”Š61â”Š  â”Š  },\n â”Š62â”Š57â”Š});\n```\n\n##### Changed modules&#x2F;users&#x2F;auth.provider.ts\n```diff\n@@ -1,7 +1,9 @@\n â”Š1â”Š1â”Šimport { Injectable, Inject, ProviderScope } from '@graphql-modules/di';\n â”Š2â”Š2â”Šimport { ModuleSessionInfo } from '@graphql-modules/core';\n+â”Š â”Š3â”Šimport { Response } from 'express';\n+â”Š â”Š4â”Šimport bcrypt from 'bcrypt';\n â”Š3â”Š5â”Šimport jwt from 'jsonwebtoken';\n-â”Š4â”Š â”Šimport { secret } from '../../env';\n+â”Š â”Š6â”Šimport { secret, expiration } from '../../env';\n â”Š5â”Š7â”Šimport { validateLength, validatePassword } from '../../validators';\n â”Š6â”Š8â”Šimport { Users } from './users.provider';\n â”Š7â”Š9â”Šimport { User } from '../../db';\n```\n```diff\n@@ -17,6 +19,30 @@\n â”Š17â”Š19â”Š    return this.module.session.req || this.module.session.request;\n â”Š18â”Š20â”Š  }\n â”Š19â”Š21â”Š\n+â”Š  â”Š22â”Š  private get res(): Response {\n+â”Š  â”Š23â”Š    return this.module.session.res;\n+â”Š  â”Š24â”Š  }\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Š  async signIn({ username, password }: { username: string; password: string }) {\n+â”Š  â”Š27â”Š    const user = await this.users.findByUsername(username);\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š    if (!user) {\n+â”Š  â”Š30â”Š      throw new Error('user not found');\n+â”Š  â”Š31â”Š    }\n+â”Š  â”Š32â”Š\n+â”Š  â”Š33â”Š    const passwordsMatch = bcrypt.compareSync(password, user.password);\n+â”Š  â”Š34â”Š\n+â”Š  â”Š35â”Š    if (!passwordsMatch) {\n+â”Š  â”Š36â”Š      throw new Error('password is incorrect');\n+â”Š  â”Š37â”Š    }\n+â”Š  â”Š38â”Š\n+â”Š  â”Š39â”Š    const authToken = jwt.sign(username, secret);\n+â”Š  â”Š40â”Š\n+â”Š  â”Š41â”Š    this.res.cookie('authToken', authToken, { maxAge: expiration });\n+â”Š  â”Š42â”Š\n+â”Š  â”Š43â”Š    return user;\n+â”Š  â”Š44â”Š  }\n+â”Š  â”Š45â”Š\n â”Š20â”Š46â”Š  async signUp({\n â”Š21â”Š47â”Š    name,\n â”Š22â”Š48â”Š    password,\n```\n\n##### Changed modules&#x2F;users&#x2F;index.ts\n```diff\n@@ -1,9 +1,6 @@\n â”Š1â”Š1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n â”Š2â”Š2â”Šimport { gql } from 'apollo-server-express';\n-â”Š3â”Š â”Šimport bcrypt from 'bcrypt';\n-â”Š4â”Š â”Šimport jwt from 'jsonwebtoken';\n â”Š5â”Š3â”Šimport commonModule from '../common';\n-â”Š6â”Š â”Šimport { secret, expiration } from '../../env';\n â”Š7â”Š4â”Šimport { Resolvers } from '../../types/graphql';\n â”Š8â”Š5â”Šimport { Users } from './users.provider';\n â”Š9â”Š6â”Šimport { Auth } from './auth.provider';\n```\n```diff\n@@ -45,24 +42,8 @@\n â”Š45â”Š42â”Š    },\n â”Š46â”Š43â”Š  },\n â”Š47â”Š44â”Š  Mutation: {\n-â”Š48â”Š  â”Š    async signIn(root, { username, password }, { injector, res }) {\n-â”Š49â”Š  â”Š      const user = await injector.get(Users).findByUsername(username);\n-â”Š50â”Š  â”Š\n-â”Š51â”Š  â”Š      if (!user) {\n-â”Š52â”Š  â”Š        throw new Error('user not found');\n-â”Š53â”Š  â”Š      }\n-â”Š54â”Š  â”Š\n-â”Š55â”Š  â”Š      const passwordsMatch = bcrypt.compareSync(password, user.password);\n-â”Š56â”Š  â”Š\n-â”Š57â”Š  â”Š      if (!passwordsMatch) {\n-â”Š58â”Š  â”Š        throw new Error('password is incorrect');\n-â”Š59â”Š  â”Š      }\n-â”Š60â”Š  â”Š\n-â”Š61â”Š  â”Š      const authToken = jwt.sign(username, secret);\n-â”Š62â”Š  â”Š\n-â”Š63â”Š  â”Š      res.cookie('authToken', authToken, { maxAge: expiration });\n-â”Š64â”Š  â”Š\n-â”Š65â”Š  â”Š      return user;\n+â”Š  â”Š45â”Š    async signIn(root, { username, password }, { injector }) {\n+â”Š  â”Š46â”Š      return injector.get(Auth).signIn({ username, password });\n â”Š66â”Š47â”Š    },\n â”Š67â”Š48â”Š\n â”Š68â”Š49â”Š    async signUp(\n```\n\n[}]: #\n\n#### Exposing server instance\n\nIf you would run `yarn test` right now, you will see a lot of errors, every test will fail. That's because we changed our setup but we didn't adjusted tests.\n\nWe're going to change the setup of tests as well so whenever we do something on server it won't affect them. Instead of exposing schema and context as we did before, we're going to base the tests on a ready to use ApolloServer instance.\n\nIn order to achieve it, we need to separate ApolloServer from other server related logic.\n\n[{]: <helper> (diffStep \"13.24\" module=\"server\")\n\n#### [__Server__ Step 13.24: Move ApolloServer and RootModule into a separate file](https://github.com/Urigo/WhatsApp-Clone-Server/commit/fde2f7422dde8109ed588be45738caf777812b02)\n\n##### Changed index.ts\n```diff\n@@ -1,35 +1,7 @@\n-â”Š 1â”Š  â”Šimport 'reflect-metadata';\n-â”Š 2â”Š  â”Šimport { ApolloServer } from 'apollo-server-express';\n-â”Š 3â”Š  â”Šimport { GraphQLModule } from '@graphql-modules/core';\n-â”Š 4â”Š  â”Šimport cookie from 'cookie';\n â”Š 5â”Š 1â”Šimport http from 'http';\n â”Š 6â”Š 2â”Šimport { app } from './app';\n â”Š 7â”Š 3â”Šimport { origin, port } from './env';\n-â”Š 8â”Š  â”Š\n-â”Š 9â”Š  â”Šimport usersModule from './modules/users';\n-â”Š10â”Š  â”Šimport chatsModule from './modules/chats';\n-â”Š11â”Š  â”Š\n-â”Š12â”Š  â”Šexport const rootModule = new GraphQLModule({\n-â”Š13â”Š  â”Š  name: 'root',\n-â”Š14â”Š  â”Š  imports: [usersModule, chatsModule],\n-â”Š15â”Š  â”Š});\n-â”Š16â”Š  â”Š\n-â”Š17â”Š  â”Šconst server = new ApolloServer({\n-â”Š18â”Š  â”Š  schema: rootModule.schema,\n-â”Š19â”Š  â”Š  context: (session: any) => {\n-â”Š20â”Š  â”Š    if (session.connection) {\n-â”Š21â”Š  â”Š      const req = session.connection.context.session.request;\n-â”Š22â”Š  â”Š      const cookies = req.headers.cookie;\n-â”Š23â”Š  â”Š\n-â”Š24â”Š  â”Š      if (cookies) {\n-â”Š25â”Š  â”Š        req.cookies = cookie.parse(cookies);\n-â”Š26â”Š  â”Š      }\n-â”Š27â”Š  â”Š    }\n-â”Š28â”Š  â”Š\n-â”Š29â”Š  â”Š    return rootModule.context(session);\n-â”Š30â”Š  â”Š  },\n-â”Š31â”Š  â”Š  subscriptions: rootModule.subscriptions,\n-â”Š32â”Š  â”Š});\n+â”Š  â”Š 4â”Šimport { server } from './server';\n â”Š33â”Š 5â”Š\n â”Š34â”Š 6â”Šserver.applyMiddleware({\n â”Š35â”Š 7â”Š  app,\n```\n\n##### Added server.ts\n```diff\n@@ -0,0 +1,29 @@\n+â”Š  â”Š 1â”Šimport 'reflect-metadata';\n+â”Š  â”Š 2â”Šimport { ApolloServer } from 'apollo-server-express';\n+â”Š  â”Š 3â”Šimport { GraphQLModule } from '@graphql-modules/core';\n+â”Š  â”Š 4â”Šimport cookie from 'cookie';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šimport usersModule from './modules/users';\n+â”Š  â”Š 7â”Šimport chatsModule from './modules/chats';\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Šexport const rootModule = new GraphQLModule({\n+â”Š  â”Š10â”Š  name: 'root',\n+â”Š  â”Š11â”Š  imports: [usersModule, chatsModule],\n+â”Š  â”Š12â”Š});\n+â”Š  â”Š13â”Š\n+â”Š  â”Š14â”Šconst server = new ApolloServer({\n+â”Š  â”Š15â”Š  schema: rootModule.schema,\n+â”Š  â”Š16â”Š  context: (session: any) => {\n+â”Š  â”Š17â”Š    if (session.connection) {\n+â”Š  â”Š18â”Š      const req = session.connection.context.session.request;\n+â”Š  â”Š19â”Š      const cookies = req.headers.cookie;\n+â”Š  â”Š20â”Š\n+â”Š  â”Š21â”Š      if (cookies) {\n+â”Š  â”Š22â”Š        req.cookies = cookie.parse(cookies);\n+â”Š  â”Š23â”Š      }\n+â”Š  â”Š24â”Š    }\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Š    return rootModule.context(session);\n+â”Š  â”Š27â”Š  },\n+â”Š  â”Š28â”Š  subscriptions: rootModule.subscriptions,\n+â”Š  â”Š29â”Š});\n```\n\n[}]: #\n[{]: <helper> (diffStep \"13.25\" module=\"server\")\n\n#### [__Server__ Step 13.25: Export server instance](https://github.com/Urigo/WhatsApp-Clone-Server/commit/c4a44c095ef537bb09fb88484c4c1edb3452af0b)\n\n##### Changed server.ts\n```diff\n@@ -11,7 +11,7 @@\n â”Š11â”Š11â”Š  imports: [usersModule, chatsModule],\n â”Š12â”Š12â”Š});\n â”Š13â”Š13â”Š\n-â”Š14â”Š  â”Šconst server = new ApolloServer({\n+â”Š  â”Š14â”Šexport const server = new ApolloServer({\n â”Š15â”Š15â”Š  schema: rootModule.schema,\n â”Š16â”Š16â”Š  context: (session: any) => {\n â”Š17â”Š17â”Š    if (session.connection) {\n```\n\n[}]: #\n\nThere's one thing that changed and might break our tests, this line fix it:\n\n[{]: <helper> (diffStep \"13.26\" module=\"server\")\n\n#### [__Server__ Step 13.26: Define mocked version of Auth provider](https://github.com/Urigo/WhatsApp-Clone-Server/commit/c39b959e740daa06a14cd49ae3479a788d7a24a8)\n\n##### Added tests&#x2F;mocks&#x2F;auth.provider.ts\n```diff\n@@ -0,0 +1,21 @@\n+â”Š  â”Š 1â”Šimport sql from 'sql-template-strings';\n+â”Š  â”Š 2â”Šimport { Auth } from './../../modules/users/auth.provider';\n+â”Š  â”Š 3â”Šimport usersModule from './../../modules/users';\n+â”Š  â”Š 4â”Šimport { pool } from '../../db';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šexport function mockAuth(userId: number) {\n+â”Š  â”Š 7â”Š  class AuthMock extends Auth {\n+â”Š  â”Š 8â”Š    async currentUser() {\n+â”Š  â”Š 9â”Š      const { rows } = await pool.query(\n+â”Š  â”Š10â”Š        sql`SELECT * FROM users WHERE id = ${userId}`\n+â”Š  â”Š11â”Š      );\n+â”Š  â”Š12â”Š      return rows[0];\n+â”Š  â”Š13â”Š    }\n+â”Š  â”Š14â”Š  }\n+â”Š  â”Š15â”Š\n+â”Š  â”Š16â”Š  usersModule.injector.provide({\n+â”Š  â”Š17â”Š    provide: Auth,\n+â”Š  â”Š18â”Š    useClass: AuthMock,\n+â”Š  â”Š19â”Š    overwrite: true,\n+â”Š  â”Š20â”Š  });\n+â”Š  â”Š21â”Š}\n```\n\n[}]: #\n\nRemember when I said about benefits of Dependency Injection? Here's one of them. We create a function that overwrites the `currentUser` method so it always returns a specific user.\n\n[{]: <helper> (diffStep \"13.27\" module=\"server\")\n\n#### [__Server__ Step 13.27: Adjust tests](https://github.com/Urigo/WhatsApp-Clone-Server/commit/1d58f140258a21f62e1c33eee8acf6a4c95e75b1)\n\n##### Changed tests&#x2F;mutations&#x2F;addChat.test.ts\n```diff\n@@ -1,28 +1,14 @@\n â”Š 1â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n-â”Š 2â”Š  â”Šimport { ApolloServer, PubSub, gql } from 'apollo-server-express';\n-â”Š 3â”Š  â”Šimport { rootModule } from '../../index';\n-â”Š 4â”Š  â”Šimport { resetDb, pool } from '../../db';\n-â”Š 5â”Š  â”Šimport sql from 'sql-template-strings';\n-â”Š 6â”Š  â”Šimport { MyContext } from '../../context';\n+â”Š  â”Š 2â”Šimport { gql } from 'apollo-server-express';\n+â”Š  â”Š 3â”Šimport { server } from '../../server';\n+â”Š  â”Š 4â”Šimport { resetDb } from '../../db';\n+â”Š  â”Š 5â”Šimport { mockAuth } from '../mocks/auth.provider';\n â”Š 7â”Š 6â”Š\n â”Š 8â”Š 7â”Šdescribe('Mutation.addChat', () => {\n â”Š 9â”Š 8â”Š  beforeEach(resetDb);\n â”Š10â”Š 9â”Š\n â”Š11â”Š10â”Š  it('creates a new chat between current user and specified recipient', async () => {\n-â”Š12â”Š  â”Š    const { rows } = await pool.query(sql`SELECT * FROM users WHERE id = 2`);\n-â”Š13â”Š  â”Š    const currentUser = rows[0];\n-â”Š14â”Š  â”Š    const server = new ApolloServer({\n-â”Š15â”Š  â”Š      schema: rootModule.schema,\n-â”Š16â”Š  â”Š      context: async () => ({\n-â”Š17â”Š  â”Š        pubsub: new PubSub(),\n-â”Š18â”Š  â”Š        currentUser,\n-â”Š19â”Š  â”Š        db: await pool.connect(),\n-â”Š20â”Š  â”Š      }),\n-â”Š21â”Š  â”Š      formatResponse: (res: any, { context }: { context: MyContext }) => {\n-â”Š22â”Š  â”Š        context.db.release();\n-â”Š23â”Š  â”Š        return res;\n-â”Š24â”Š  â”Š      },\n-â”Š25â”Š  â”Š    });\n+â”Š  â”Š11â”Š    mockAuth(2);\n â”Š26â”Š12â”Š\n â”Š27â”Š13â”Š    const { query, mutate } = createTestClient(server);\n â”Š28â”Š14â”Š\n```\n```diff\n@@ -66,20 +52,7 @@\n â”Š66â”Š52â”Š  });\n â”Š67â”Š53â”Š\n â”Š68â”Š54â”Š  it('returns the existing chat if so', async () => {\n-â”Š69â”Š  â”Š    const { rows } = await pool.query(sql`SELECT * FROM users WHERE id = 1`);\n-â”Š70â”Š  â”Š    const currentUser = rows[0];\n-â”Š71â”Š  â”Š    const server = new ApolloServer({\n-â”Š72â”Š  â”Š      schema: rootModule.schema,\n-â”Š73â”Š  â”Š      context: async () => ({\n-â”Š74â”Š  â”Š        pubsub: new PubSub(),\n-â”Š75â”Š  â”Š        currentUser,\n-â”Š76â”Š  â”Š        db: await pool.connect(),\n-â”Š77â”Š  â”Š      }),\n-â”Š78â”Š  â”Š      formatResponse: (res: any, { context }: { context: MyContext }) => {\n-â”Š79â”Š  â”Š        context.db.release();\n-â”Š80â”Š  â”Š        return res;\n-â”Š81â”Š  â”Š      },\n-â”Š82â”Š  â”Š    });\n+â”Š  â”Š55â”Š    mockAuth(1);\n â”Š83â”Š56â”Š\n â”Š84â”Š57â”Š    const { query, mutate } = createTestClient(server);\n â”Š85â”Š58â”Š\n```\n\n##### Changed tests&#x2F;mutations&#x2F;addMessage.test.ts\n```diff\n@@ -1,28 +1,14 @@\n â”Š 1â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n-â”Š 2â”Š  â”Šimport { ApolloServer, PubSub, gql } from 'apollo-server-express';\n-â”Š 3â”Š  â”Šimport { rootModule } from '../../index';\n-â”Š 4â”Š  â”Šimport { resetDb, pool } from '../../db';\n-â”Š 5â”Š  â”Šimport sql from 'sql-template-strings';\n-â”Š 6â”Š  â”Šimport { MyContext } from '../../context';\n+â”Š  â”Š 2â”Šimport { gql } from 'apollo-server-express';\n+â”Š  â”Š 3â”Šimport { server } from '../../server';\n+â”Š  â”Š 4â”Šimport { resetDb } from '../../db';\n+â”Š  â”Š 5â”Šimport { mockAuth } from '../mocks/auth.provider';\n â”Š 7â”Š 6â”Š\n â”Š 8â”Š 7â”Šdescribe('Mutation.addMessage', () => {\n â”Š 9â”Š 8â”Š  beforeEach(resetDb);\n â”Š10â”Š 9â”Š\n â”Š11â”Š10â”Š  it('should add message to specified chat', async () => {\n-â”Š12â”Š  â”Š    const { rows } = await pool.query(sql`SELECT * FROM users WHERE id = 1`);\n-â”Š13â”Š  â”Š    const currentUser = rows[0];\n-â”Š14â”Š  â”Š    const server = new ApolloServer({\n-â”Š15â”Š  â”Š      schema: rootModule.schema,\n-â”Š16â”Š  â”Š      context: async () => ({\n-â”Š17â”Š  â”Š        pubsub: new PubSub(),\n-â”Š18â”Š  â”Š        currentUser,\n-â”Š19â”Š  â”Š        db: await pool.connect(),\n-â”Š20â”Š  â”Š      }),\n-â”Š21â”Š  â”Š      formatResponse: (res: any, { context }: { context: MyContext }) => {\n-â”Š22â”Š  â”Š        context.db.release();\n-â”Š23â”Š  â”Š        return res;\n-â”Š24â”Š  â”Š      },\n-â”Š25â”Š  â”Š    });\n+â”Š  â”Š11â”Š    mockAuth(1);\n â”Š26â”Š12â”Š\n â”Š27â”Š13â”Š    const { query, mutate } = createTestClient(server);\n â”Š28â”Š14â”Š\n```\n\n##### Changed tests&#x2F;mutations&#x2F;removeChat.test.ts\n```diff\n@@ -1,28 +1,14 @@\n â”Š 1â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n-â”Š 2â”Š  â”Šimport { ApolloServer, PubSub, gql } from 'apollo-server-express';\n-â”Š 3â”Š  â”Šimport { rootModule } from '../../index';\n-â”Š 4â”Š  â”Šimport { resetDb, pool } from '../../db';\n-â”Š 5â”Š  â”Šimport sql from 'sql-template-strings';\n-â”Š 6â”Š  â”Šimport { MyContext } from '../../context';\n+â”Š  â”Š 2â”Šimport { gql } from 'apollo-server-express';\n+â”Š  â”Š 3â”Šimport { server } from '../../server';\n+â”Š  â”Š 4â”Šimport { resetDb } from '../../db';\n+â”Š  â”Š 5â”Šimport { mockAuth } from '../mocks/auth.provider';\n â”Š 7â”Š 6â”Š\n â”Š 8â”Š 7â”Šdescribe('Mutation.removeChat', () => {\n â”Š 9â”Š 8â”Š  beforeEach(resetDb);\n â”Š10â”Š 9â”Š\n â”Š11â”Š10â”Š  it('removes chat by id', async () => {\n-â”Š12â”Š  â”Š    const { rows } = await pool.query(sql`SELECT * FROM users WHERE id = 1`);\n-â”Š13â”Š  â”Š    const currentUser = rows[0];\n-â”Š14â”Š  â”Š    const server = new ApolloServer({\n-â”Š15â”Š  â”Š      schema: rootModule.schema,\n-â”Š16â”Š  â”Š      context: async () => ({\n-â”Š17â”Š  â”Š        pubsub: new PubSub(),\n-â”Š18â”Š  â”Š        currentUser,\n-â”Š19â”Š  â”Š        db: await pool.connect(),\n-â”Š20â”Š  â”Š      }),\n-â”Š21â”Š  â”Š      formatResponse: (res: any, { context }: { context: MyContext }) => {\n-â”Š22â”Š  â”Š        context.db.release();\n-â”Š23â”Š  â”Š        return res;\n-â”Š24â”Š  â”Š      },\n-â”Š25â”Š  â”Š    });\n+â”Š  â”Š11â”Š    mockAuth(1);\n â”Š26â”Š12â”Š\n â”Š27â”Š13â”Š    const { query, mutate } = createTestClient(server);\n â”Š28â”Š14â”Š\n```\n\n##### Changed tests&#x2F;queries&#x2F;getChat.test.ts\n```diff\n@@ -1,27 +1,14 @@\n â”Š 1â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n-â”Š 2â”Š  â”Šimport { ApolloServer, gql } from 'apollo-server-express';\n-â”Š 3â”Š  â”Šimport { rootModule } from '../../index';\n-â”Š 4â”Š  â”Šimport { poolm resetDb } from '../../db';\n-â”Š 5â”Š  â”Šimport sql from 'sql-template-strings';\n-â”Š 6â”Š  â”Šimport { MyContext } from '../../context';\n+â”Š  â”Š 2â”Šimport { gql } from 'apollo-server-express';\n+â”Š  â”Š 3â”Šimport { server } from '../../server';\n+â”Š  â”Š 4â”Šimport { resetDb } from '../../db';\n+â”Š  â”Š 5â”Šimport { mockAuth } from '../mocks/auth.provider';\n â”Š 7â”Š 6â”Š\n â”Š 8â”Š 7â”Šdescribe('Query.chat', () => {\n â”Š 9â”Š 8â”Š  beforeEach(resetDb);\n â”Š10â”Š 9â”Š\n â”Š11â”Š10â”Š  it('should fetch specified chat', async () => {\n-â”Š12â”Š  â”Š    const { rows } = await pool.query(sql`SELECT * FROM users WHERE id = 1`);\n-â”Š13â”Š  â”Š    const currentUser = rows[0];\n-â”Š14â”Š  â”Š    const server = new ApolloServer({\n-â”Š15â”Š  â”Š      schema: rootModule.schema,\n-â”Š16â”Š  â”Š      context: async () => ({\n-â”Š17â”Š  â”Š        currentUser,\n-â”Š18â”Š  â”Š        db: await pool.connect(),\n-â”Š19â”Š  â”Š      }),\n-â”Š20â”Š  â”Š      formatResponse: (res: any, { context }: { context: MyContext }) => {\n-â”Š21â”Š  â”Š        context.db.release();\n-â”Š22â”Š  â”Š        return res;\n-â”Š23â”Š  â”Š      },\n-â”Š24â”Š  â”Š    });\n+â”Š  â”Š11â”Š    mockAuth(1);\n â”Š25â”Š12â”Š\n â”Š26â”Š13â”Š    const { query } = createTestClient(server);\n â”Š27â”Š14â”Š\n```\n\n##### Changed tests&#x2F;queries&#x2F;getChats.test.ts\n```diff\n@@ -1,27 +1,14 @@\n â”Š 1â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n-â”Š 2â”Š  â”Šimport { ApolloServer, gql } from 'apollo-server-express';\n-â”Š 3â”Š  â”Šimport { rootModule } from '../../index';\n-â”Š 4â”Š  â”Šimport { pool, resetDb } from '../../db';\n-â”Š 5â”Š  â”Šimport sql from 'sql-template-strings';\n-â”Š 6â”Š  â”Šimport { MyContext } from '../../context';\n+â”Š  â”Š 2â”Šimport { gql } from 'apollo-server-express';\n+â”Š  â”Š 3â”Šimport { server } from '../../server';\n+â”Š  â”Š 4â”Šimport { resetDb } from '../../db';\n+â”Š  â”Š 5â”Šimport { mockAuth } from '../mocks/auth.provider';\n â”Š 7â”Š 6â”Š\n â”Š 8â”Š 7â”Šdescribe('Query.chats', () => {\n â”Š 9â”Š 8â”Š  beforeEach(resetDb);\n â”Š10â”Š 9â”Š\n â”Š11â”Š10â”Š  it('should fetch all chats', async () => {\n-â”Š12â”Š  â”Š    const { rows } = await pool.query(sql`SELECT * FROM users WHERE id = 1`);\n-â”Š13â”Š  â”Š    const currentUser = rows[0];\n-â”Š14â”Š  â”Š    const server = new ApolloServer({\n-â”Š15â”Š  â”Š      schema: rootModule.schema,\n-â”Š16â”Š  â”Š      context: async () => ({\n-â”Š17â”Š  â”Š        currentUser,\n-â”Š18â”Š  â”Š        db: await pool.connect(),\n-â”Š19â”Š  â”Š      }),\n-â”Š20â”Š  â”Š      formatResponse: (res: any, { context }: { context: MyContext }) => {\n-â”Š21â”Š  â”Š        context.db.release();\n-â”Š22â”Š  â”Š        return res;\n-â”Š23â”Š  â”Š      },\n-â”Š24â”Š  â”Š    });\n+â”Š  â”Š11â”Š    mockAuth(1);\n â”Š25â”Š12â”Š\n â”Š26â”Š13â”Š    const { query } = createTestClient(server);\n â”Š27â”Š14â”Š\n```\n\n##### Changed tests&#x2F;queries&#x2F;getMe.test.ts\n```diff\n@@ -1,25 +1,14 @@\n â”Š 1â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n-â”Š 2â”Š  â”Šimport { ApolloServer, gql } from 'apollo-server-express';\n-â”Š 3â”Š  â”Šimport { rootModule } from '../../index';\n-â”Š 4â”Š  â”Šimport { pool } from '../../db';\n-â”Š 5â”Š  â”Šimport sql from 'sql-template-strings';\n-â”Š 6â”Š  â”Šimport { MyContext } from '../../context';\n+â”Š  â”Š 2â”Šimport { gql } from 'apollo-server-express';\n+â”Š  â”Š 3â”Šimport { server } from '../../server';\n+â”Š  â”Š 4â”Šimport { resetDb } from '../../db';\n+â”Š  â”Š 5â”Šimport { mockAuth } from '../mocks/auth.provider';\n â”Š 7â”Š 6â”Š\n â”Š 8â”Š 7â”Šdescribe('Query.me', () => {\n+â”Š  â”Š 8â”Š  beforeEach(resetDb);\n+â”Š  â”Š 9â”Š\n â”Š 9â”Š10â”Š  it('should fetch current user', async () => {\n-â”Š10â”Š  â”Š    const { rows } = await pool.query(sql`SELECT * FROM users WHERE id = 1`);\n-â”Š11â”Š  â”Š    const currentUser = rows[0];\n-â”Š12â”Š  â”Š    const server = new ApolloServer({\n-â”Š13â”Š  â”Š      schema: rootModule.schema,\n-â”Š14â”Š  â”Š      context: async () => ({\n-â”Š15â”Š  â”Š        currentUser,\n-â”Š16â”Š  â”Š        db: await pool.connect(),\n-â”Š17â”Š  â”Š      }),\n-â”Š18â”Š  â”Š      formatResponse: (res: any, { context }: { context: MyContext }) => {\n-â”Š19â”Š  â”Š        context.db.release();\n-â”Š20â”Š  â”Š        return res;\n-â”Š21â”Š  â”Š      },\n-â”Š22â”Š  â”Š    });\n+â”Š  â”Š11â”Š    mockAuth(1);\n â”Š23â”Š12â”Š\n â”Š24â”Š13â”Š    const { query } = createTestClient(server);\n â”Š25â”Š14â”Š\n```\n\n##### Changed tests&#x2F;queries&#x2F;getUsers.test.ts\n```diff\n@@ -1,28 +1,14 @@\n â”Š 1â”Š 1â”Šimport { createTestClient } from 'apollo-server-testing';\n-â”Š 2â”Š  â”Šimport { ApolloServer, gql } from 'apollo-server-express';\n-â”Š 3â”Š  â”Šimport { rootModule } from '../../index';\n-â”Š 4â”Š  â”Šimport { pool } from '../../db';\n-â”Š 5â”Š  â”Šimport sql from 'sql-template-strings';\n-â”Š 6â”Š  â”Šimport { MyContext } from '../../context';\n+â”Š  â”Š 2â”Šimport { gql } from 'apollo-server-express';\n+â”Š  â”Š 3â”Šimport { server } from '../../server';\n+â”Š  â”Š 4â”Šimport { resetDb } from '../../db';\n+â”Š  â”Š 5â”Šimport { mockAuth } from '../mocks/auth.provider';\n â”Š 7â”Š 6â”Š\n â”Š 8â”Š 7â”Šdescribe('Query.getUsers', () => {\n+â”Š  â”Š 8â”Š  beforeEach(resetDb);\n+â”Š  â”Š 9â”Š\n â”Š 9â”Š10â”Š  it('should fetch all users except the one signed-in', async () => {\n-â”Š10â”Š  â”Š    const firstUserQuery = await pool.query(\n-â”Š11â”Š  â”Š      sql`SELECT * FROM users WHERE id = 1`\n-â”Š12â”Š  â”Š    );\n-â”Š13â”Š  â”Š    let currentUser = firstUserQuery.rows[0];\n-â”Š14â”Š  â”Š    const db = await pool.connect();\n-â”Š15â”Š  â”Š    const server = new ApolloServer({\n-â”Š16â”Š  â”Š      schema: rootModule.schema,\n-â”Š17â”Š  â”Š      context: async () => ({\n-â”Š18â”Š  â”Š        currentUser,\n-â”Š19â”Š  â”Š        db: await pool.connect(),\n-â”Š20â”Š  â”Š      }),\n-â”Š21â”Š  â”Š      formatResponse: (res: any, { context }: { context: MyContext }) => {\n-â”Š22â”Š  â”Š        context.db.release();\n-â”Š23â”Š  â”Š        return res;\n-â”Š24â”Š  â”Š      },\n-â”Š25â”Š  â”Š    });\n+â”Š  â”Š11â”Š    mockAuth(1);\n â”Š26â”Š12â”Š\n â”Š27â”Š13â”Š    const { query } = createTestClient(server);\n â”Š28â”Š14â”Š\n```\n```diff\n@@ -42,10 +28,7 @@\n â”Š42â”Š28â”Š    expect(res.errors).toBeUndefined();\n â”Š43â”Š29â”Š    expect(res.data).toMatchSnapshot();\n â”Š44â”Š30â”Š\n-â”Š45â”Š  â”Š    const secondUserQuery = await pool.query(\n-â”Š46â”Š  â”Š      sql`SELECT * FROM users WHERE id = '2'`\n-â”Š47â”Š  â”Š    );\n-â”Š48â”Š  â”Š    currentUser = secondUserQuery.rows[0];\n+â”Š  â”Š31â”Š    mockAuth(2);\n â”Š49â”Š32â”Š\n â”Š50â”Š33â”Š    res = await query({\n â”Š51â”Š34â”Š      query: gql`\n```\n\n[}]: #\n\nLet's now migrate all tests and see how easier it is now to manage those. Because we use ApolloServer's instance, we don't need to understand how it's implemented.\n\n[{]: <helper> (diffStep \"13.28\" module=\"server\")\n\n#### Step 13.28: NOT FOUND!\n\n[}]: #\n\n## Adjusting client\n\nWe still need to update `codegen.yml` in the client app because of the changes we introduced in this chapter:\n\n[{]: <helper> (diffStep \"14.1\" module=\"client\")\n\n#### [__Client__ Step 14.1: Adjust to GraphQL Modules](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/346a172570d775d7238c81cef32d872ab2016043)\n\n##### Changed codegen.yml\n```diff\n@@ -1,4 +1,4 @@\n-â”Š1â”Š â”Šschema: ../WhatsApp-Clone-Server/schema/typeDefs.graphql\n+â”Š â”Š1â”Šschema: ../WhatsApp-Clone-Server/modules/*/*.ts\n â”Š2â”Š2â”Šdocuments:\n â”Š3â”Š3â”Š  - ./src/components/**/*.tsx\n â”Š4â”Š4â”Š  - ./src/graphql/fragments/**/*.ts\n```\n\n[}]: #\n\n## Many ways to write GraphQL\n\nWeâ€™re going to discuss what are the possible options of building GraphQL API and why schema-first approach was our choice.\n\nThe main ingredient of a GraphQL API is, of course the schema. Itâ€™s built out of type definitions where each of them describes a piece of data, connections between them and how data is actually resolved.\n\nThe way we develop all of it changes the way we work with the API.\n\nWe could define two main approaches:\n  - schema-first\n  - resolver-first\n\nThe former means design comes before code, the latter vice-versa.\n\nIn schema-first development you start with SDL, resolvers and code go next. Schema is sort of a contract between teams and also between frontend and backend. With schema-first approach itâ€™s easier to cooperate, discuss and write a better API. Because the SDL is written upfront, the frontend developers can use a mocked version of it and start working on the product while the backend team does the API, in parallel.\nThere are of course some pain points. Once schema is splitted into SDL and resolvers itâ€™s hard to keep them in sync and thatâ€™s why things like GraphQL Code Generator were developed, to add type safety on top of all.\n\nThe resolver-first approach is a bit different. The schema is defined programmatically, which usually means itâ€™s more flexible and combined with TypeScript or Flow gives you type-safety out of the box.\n\nWe think itâ€™s less readable than having a SDL and thereâ€™s a lack of separation between schema and code which might be a blocker for some teams."
          },
          {
            "manualTitle": "",
            "stepRevision": "",
            "manualView": "In this part of the tutorial we're going to do a bit different work than in previous chapters. We'll analyze the code instead of writing it, including both the API and the web application.\n\n## API Performance\n\nFirst, let's start with the GraphQL API.\n\n### Finding bottlenecks\n\nIn order to implement fixes and do improvements we need to understand which part of the API needs help. There's still not many tools around GraphQL in terms of analytics and inspection but there's one highly useful, it's called **Apollo Engine**.\n\nSince we're going to use it, you need to register an account at [engine.apollographql.com](https://engine.apollographql.com/) and create a service. Please then follow [the \"How to configure an Apollo project\" instructions](https://www.apollographql.com/docs/platform/schema-registry/#using-the-schema-registry).\n\nOnce you're ready, please start the server and run this command:\n\n    $ apollo service:push\n\nTo collect the data, let's play with the client app for some time. After that, go to Engine's website.\n\nHere's one of graphs with timing of an operation. We can understand when each resolver takes place and how much time it consumes. Some resolvers happen in parallel.\nThe `< 1ms` says it was a very simple computation or an element resolved immediately.\n\nWe find it very useful to understand how operation behaves.\n\n![Resolvers](../../../assets/step17/img-01.png \"Resolvers\")\n\nLet's go through an entire query to find fields fetched multiple times. The most obvious field is `isMine`. We see it's computed twice for almost 4 and 5 milliseconds.\nIn order to find out what does it mean, we need to look at the code. The resolver gets the currently logged in user from the `Auth` service and its `currentUser`. Each time the method is invoked, a query to PostgreSQL is made. We ask for that data multiple times, once in `lastMessage` and also in every message from the list.\n\nWe could deduplicate the SQL queries! In order to do that the most obvious library that pops to my mind is Dataloader.\n\nLet's install the package and discuss it afterwards:\n\n    npm install dataloader\n\nThe Dataloader is a library created and maintained by Facebook. It's main purpose is to turn equivalent requests into a single execution. Sounds like a perfect solution, right? It actually is.\n\nA short explaination of how Dataloader works.\n\n```ts\nasync function fetchUser(id: number): Promise<User> {\n  // Resolves asynchronously, after less than 1s.\n  return db.users.findOne(id);\n}\n\nasync function fetchUsers(ids: number[]): Promise<User[]> {\n  const users = ids.map(id => fetchUser(id));\n  return Promise.all(users);\n}\n\nconst loader = new Dataloader(keys => fetchUsers(keys));\n\nasync function main() {\n  const user1 = await loader.load(1);\n  const user2 = await loader.load(2);\n\n  // Later on user #1 is fetched again.\n  // It resolves immediately.\n  const member1 = await loader.load(1);\n}\n```\n\nThink of the Dataloader as a class that has a `Map` object in it, its keys are of course unique and each value is a `Promise`.\nEvery time you ask for something, Dataloader looks for it in the `Map`. When there's already something, the `Promise` is returned but if there's none the provided function is invoked and a new `Promise` is created. This way equivalent requests share the same `Promise`.\n\n> It's important to know that the `Map` object grows until the DataLoader is released, that's why it's recommended to keep `Dataloader` in GraphQL's context.\n\nLet's implement `Dataloader` in our `Database` service:\n\n[{]: <helper> (diffStep \"14.1\" files=\"modules/common/database.provider.ts\" module=\"server\")\n\n#### [__Server__ Step 14.1: Deduplicate SQL queries](https://github.com/Urigo/WhatsApp-Clone-Server/commit/3cf746ba8a23c82b982b695aa38554139e1759b1)\n\n##### Changed modules&#x2F;common&#x2F;database.provider.ts\n```diff\n@@ -1,14 +1,41 @@\n â”Š 1â”Š 1â”Šimport { Injectable, ProviderScope } from '@graphql-modules/di';\n â”Š 2â”Š 2â”Šimport { OnResponse } from '@graphql-modules/core';\n-â”Š 3â”Š  â”Šimport { Pool, PoolClient } from 'pg';\n+â”Š  â”Š 3â”Šimport { Pool, PoolClient, QueryResult } from 'pg';\n+â”Š  â”Š 4â”Šimport { SQLStatement } from 'sql-template-strings';\n+â”Š  â”Š 5â”Šimport Dataloader from 'dataloader';\n â”Š 4â”Š 6â”Š\n â”Š 5â”Š 7â”Š@Injectable({\n â”Š 6â”Š 8â”Š  scope: ProviderScope.Session,\n â”Š 7â”Š 9â”Š})\n â”Š 8â”Š10â”Šexport class Database implements OnResponse {\n â”Š 9â”Š11â”Š  private instance: PoolClient;\n+â”Š  â”Š12â”Š  private loader: Dataloader<string | SQLStatement, QueryResult>;\n â”Š10â”Š13â”Š\n-â”Š11â”Š  â”Š  constructor(private pool: Pool) {}\n+â”Š  â”Š14â”Š  constructor(private pool: Pool) {\n+â”Š  â”Š15â”Š    this.loader = new Dataloader(\n+â”Š  â”Š16â”Š      queries =>\n+â”Š  â”Š17â”Š        Promise.all(\n+â”Š  â”Š18â”Š          queries.map(async query => {\n+â”Š  â”Š19â”Š            const db = await this.getClient();\n+â”Š  â”Š20â”Š            return db.query(query);\n+â”Š  â”Š21â”Š          })\n+â”Š  â”Š22â”Š        ),\n+â”Š  â”Š23â”Š      {\n+â”Š  â”Š24â”Š        cacheKeyFn: (key: string | SQLStatement) => {\n+â”Š  â”Š25â”Š          let id: string;\n+â”Š  â”Š26â”Š\n+â”Š  â”Š27â”Š          if (typeof key === 'string') {\n+â”Š  â”Š28â”Š            id = key;\n+â”Š  â”Š29â”Š          } else {\n+â”Š  â”Š30â”Š            id = key.text + ' - ' + JSON.stringify(key.values);\n+â”Š  â”Š31â”Š          }\n+â”Š  â”Š32â”Š\n+â”Š  â”Š33â”Š          return id;\n+â”Š  â”Š34â”Š        },\n+â”Š  â”Š35â”Š        batch: false,\n+â”Š  â”Š36â”Š      }\n+â”Š  â”Š37â”Š    );\n+â”Š  â”Š38â”Š  }\n â”Š12â”Š39â”Š\n â”Š13â”Š40â”Š  async onRequest() {\n â”Š14â”Š41â”Š    this.instance = await this.pool.connect();\n```\n```diff\n@@ -20,7 +47,11 @@\n â”Š20â”Š47â”Š    }\n â”Š21â”Š48â”Š  }\n â”Š22â”Š49â”Š\n-â”Š23â”Š  â”Š  async getClient() {\n+â”Š  â”Š50â”Š  private getClient() {\n â”Š24â”Š51â”Š    return this.instance;\n â”Š25â”Š52â”Š  }\n+â”Š  â”Š53â”Š\n+â”Š  â”Š54â”Š  query(query: SQLStatement | string) {\n+â”Š  â”Š55â”Š    return this.loader.load(query);\n+â”Š  â”Š56â”Š  }\n â”Š26â”Š57â”Š}\n```\n\n[}]: #\n\nThe key is created based on SQL statement and its values and we also turned off batching because it's important to execute SQL operations sequentially.\nThere's also a new method called `query`, to execute SQL statements through Dataloader. It also reduces a boilerplate of asking for db client and executing a query every time we do SQL in resolvers and providers.\n\nNow we need to apply that change in all providers:\n\n[{]: <helper> (diffStep \"14.1\" files=\"modules/users/users.provider.ts, modules/chats/chats.provider.ts\" module=\"server\")\n\n#### [__Server__ Step 14.1: Deduplicate SQL queries](https://github.com/Urigo/WhatsApp-Clone-Server/commit/3cf746ba8a23c82b982b695aa38554139e1759b1)\n\n##### Changed modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -11,9 +11,7 @@\n â”Š11â”Š11â”Š  @Inject() private pubsub: PubSub;\n â”Š12â”Š12â”Š\n â”Š13â”Š13â”Š  async findChatsByUser(userId: string) {\n-â”Š14â”Š  â”Š    const db = await this.db.getClient();\n-â”Š15â”Š  â”Š\n-â”Š16â”Š  â”Š    const { rows } = await db.query(sql`\n+â”Š  â”Š14â”Š    const { rows } = await this.db.query(sql`\n â”Š17â”Š15â”Š      SELECT chats.* FROM chats, chats_users\n â”Š18â”Š16â”Š      WHERE chats.id = chats_users.chat_id\n â”Š19â”Š17â”Š      AND chats_users.user_id = ${userId}\n```\n```diff\n@@ -23,8 +21,7 @@\n â”Š23â”Š21â”Š  }\n â”Š24â”Š22â”Š\n â”Š25â”Š23â”Š  async findChatByUser({ chatId, userId }: { chatId: string; userId: string }) {\n-â”Š26â”Š  â”Š    const db = await this.db.getClient();\n-â”Š27â”Š  â”Š    const { rows } = await db.query(sql`\n+â”Š  â”Š24â”Š    const { rows } = await this.db.query(sql`\n â”Š28â”Š25â”Š      SELECT chats.* FROM chats, chats_users\n â”Š29â”Š26â”Š      WHERE chats_users.chat_id = ${chatId}\n â”Š30â”Š27â”Š      AND chats.id = chats_users.chat_id\n```\n```diff\n@@ -35,16 +32,14 @@\n â”Š35â”Š32â”Š  }\n â”Š36â”Š33â”Š\n â”Š37â”Š34â”Š  async findChatById(chatId: string) {\n-â”Š38â”Š  â”Š    const db = await this.db.getClient();\n-â”Š39â”Š  â”Š    const { rows } = await db.query(sql`\n+â”Š  â”Š35â”Š    const { rows } = await this.db.query(sql`\n â”Š40â”Š36â”Š      SELECT * FROM chats WHERE id = ${chatId}\n â”Š41â”Š37â”Š    `);\n â”Š42â”Š38â”Š    return rows[0] || null;\n â”Š43â”Š39â”Š  }\n â”Š44â”Š40â”Š\n â”Š45â”Š41â”Š  async findMessagesByChat(chatId: string) {\n-â”Š46â”Š  â”Š    const db = await this.db.getClient();\n-â”Š47â”Š  â”Š    const { rows } = await db.query(\n+â”Š  â”Š42â”Š    const { rows } = await this.db.query(\n â”Š48â”Š43â”Š      sql`SELECT * FROM messages WHERE chat_id = ${chatId}`\n â”Š49â”Š44â”Š    );\n â”Š50â”Š45â”Š\n```\n```diff\n@@ -52,8 +47,7 @@\n â”Š52â”Š47â”Š  }\n â”Š53â”Š48â”Š\n â”Š54â”Š49â”Š  async lastMessage(chatId: string) {\n-â”Š55â”Š  â”Š    const db = await this.db.getClient();\n-â”Š56â”Š  â”Š    const { rows } = await db.query(sql`\n+â”Š  â”Š50â”Š    const { rows } = await this.db.query(sql`\n â”Š57â”Š51â”Š      SELECT * FROM messages\n â”Š58â”Š52â”Š      WHERE chat_id = ${chatId}\n â”Š59â”Š53â”Š      ORDER BY created_at DESC\n```\n```diff\n@@ -64,8 +58,7 @@\n â”Š64â”Š58â”Š  }\n â”Š65â”Š59â”Š\n â”Š66â”Š60â”Š  async firstRecipient({ chatId, userId }: { chatId: string; userId: string }) {\n-â”Š67â”Š  â”Š    const db = await this.db.getClient();\n-â”Š68â”Š  â”Š    const { rows } = await db.query(sql`\n+â”Š  â”Š61â”Š    const { rows } = await this.db.query(sql`\n â”Š69â”Š62â”Š      SELECT users.* FROM users, chats_users\n â”Š70â”Š63â”Š      WHERE users.id != ${userId}\n â”Š71â”Š64â”Š      AND users.id = chats_users.user_id\n```\n```diff\n@@ -76,8 +69,7 @@\n â”Š76â”Š69â”Š  }\n â”Š77â”Š70â”Š\n â”Š78â”Š71â”Š  async participants(chatId: string) {\n-â”Š79â”Š  â”Š    const db = await this.db.getClient();\n-â”Š80â”Š  â”Š    const { rows } = await db.query(sql`\n+â”Š  â”Š72â”Š    const { rows } = await this.db.query(sql`\n â”Š81â”Š73â”Š      SELECT users.* FROM users, chats_users\n â”Š82â”Š74â”Š      WHERE chats_users.chat_id = ${chatId}\n â”Š83â”Š75â”Š      AND chats_users.user_id = users.id\n```\n```diff\n@@ -87,8 +79,7 @@\n â”Š87â”Š79â”Š  }\n â”Š88â”Š80â”Š\n â”Š89â”Š81â”Š  async isParticipant({ chatId, userId }: { chatId: string; userId: string }) {\n-â”Š90â”Š  â”Š    const db = await this.db.getClient();\n-â”Š91â”Š  â”Š    const { rows } = await db.query(sql`\n+â”Š  â”Š82â”Š    const { rows } = await this.db.query(sql`\n â”Š92â”Š83â”Š      SELECT * FROM chats_users\n â”Š93â”Š84â”Š      WHERE chat_id = ${chatId}\n â”Š94â”Š85â”Š      AND user_id = ${userId}\n```\n```diff\n@@ -106,8 +97,7 @@\n â”Š106â”Š 97â”Š    userId: string;\n â”Š107â”Š 98â”Š    content: string;\n â”Š108â”Š 99â”Š  }) {\n-â”Š109â”Š   â”Š    const db = await this.db.getClient();\n-â”Š110â”Š   â”Š    const { rows } = await db.query(sql`\n+â”Š   â”Š100â”Š    const { rows } = await this.db.query(sql`\n â”Š111â”Š101â”Š      INSERT INTO messages(chat_id, sender_user_id, content)\n â”Š112â”Š102â”Š      VALUES(${chatId}, ${userId}, ${content})\n â”Š113â”Š103â”Š      RETURNING *\n```\n```diff\n@@ -129,8 +119,7 @@\n â”Š129â”Š119â”Š    userId: string;\n â”Š130â”Š120â”Š    recipientId: string;\n â”Š131â”Š121â”Š  }) {\n-â”Š132â”Š   â”Š    const db = await this.db.getClient();\n-â”Š133â”Š   â”Š    const { rows } = await db.query(sql`\n+â”Š   â”Š122â”Š    const { rows } = await this.db.query(sql`\n â”Š134â”Š123â”Š      SELECT chats.* FROM chats, (SELECT * FROM chats_users WHERE user_id = ${userId}) AS chats_of_current_user, chats_users\n â”Š135â”Š124â”Š      WHERE chats_users.chat_id = chats_of_current_user.chat_id\n â”Š136â”Š125â”Š      AND chats.id = chats_users.chat_id\n```\n```diff\n@@ -143,9 +132,9 @@\n â”Š143â”Š132â”Š    }\n â”Š144â”Š133â”Š\n â”Š145â”Š134â”Š    try {\n-â”Š146â”Š   â”Š      await db.query('BEGIN');\n+â”Š   â”Š135â”Š      await this.db.query('BEGIN');\n â”Š147â”Š136â”Š\n-â”Š148â”Š   â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š137â”Š      const { rows } = await this.db.query(sql`\n â”Š149â”Š138â”Š        INSERT INTO chats\n â”Š150â”Š139â”Š        DEFAULT VALUES\n â”Š151â”Š140â”Š        RETURNING *\n```\n```diff\n@@ -153,17 +142,17 @@\n â”Š153â”Š142â”Š\n â”Š154â”Š143â”Š      const chatAdded = rows[0];\n â”Š155â”Š144â”Š\n-â”Š156â”Š   â”Š      await db.query(sql`\n+â”Š   â”Š145â”Š      await this.db.query(sql`\n â”Š157â”Š146â”Š        INSERT INTO chats_users(chat_id, user_id)\n â”Š158â”Š147â”Š        VALUES(${chatAdded.id}, ${userId})\n â”Š159â”Š148â”Š      `);\n â”Š160â”Š149â”Š\n-â”Š161â”Š   â”Š      await db.query(sql`\n+â”Š   â”Š150â”Š      await this.db.query(sql`\n â”Š162â”Š151â”Š        INSERT INTO chats_users(chat_id, user_id)\n â”Š163â”Š152â”Š        VALUES(${chatAdded.id}, ${recipientId})\n â”Š164â”Š153â”Š      `);\n â”Š165â”Š154â”Š\n-â”Š166â”Š   â”Š      await db.query('COMMIT');\n+â”Š   â”Š155â”Š      await this.db.query('COMMIT');\n â”Š167â”Š156â”Š\n â”Š168â”Š157â”Š      this.pubsub.publish('chatAdded', {\n â”Š169â”Š158â”Š        chatAdded,\n```\n```diff\n@@ -171,18 +160,16 @@\n â”Š171â”Š160â”Š\n â”Š172â”Š161â”Š      return chatAdded;\n â”Š173â”Š162â”Š    } catch (e) {\n-â”Š174â”Š   â”Š      await db.query('ROLLBACK');\n+â”Š   â”Š163â”Š      await this.db.query('ROLLBACK');\n â”Š175â”Š164â”Š      throw e;\n â”Š176â”Š165â”Š    }\n â”Š177â”Š166â”Š  }\n â”Š178â”Š167â”Š\n â”Š179â”Š168â”Š  async removeChat({ chatId, userId }: { chatId: string; userId: string }) {\n-â”Š180â”Š   â”Š    const db = await this.db.getClient();\n-â”Š181â”Š   â”Š\n â”Š182â”Š169â”Š    try {\n-â”Š183â”Š   â”Š      await db.query('BEGIN');\n+â”Š   â”Š170â”Š      await this.db.query('BEGIN');\n â”Š184â”Š171â”Š\n-â”Š185â”Š   â”Š      const { rows } = await db.query(sql`\n+â”Š   â”Š172â”Š      const { rows } = await this.db.query(sql`\n â”Š186â”Š173â”Š        SELECT chats.* FROM chats, chats_users\n â”Š187â”Š174â”Š        WHERE id = ${chatId}\n â”Š188â”Š175â”Š        AND chats.id = chats_users.chat_id\n```\n```diff\n@@ -192,11 +179,11 @@\n â”Š192â”Š179â”Š      const chat = rows[0];\n â”Š193â”Š180â”Š\n â”Š194â”Š181â”Š      if (!chat) {\n-â”Š195â”Š   â”Š        await db.query('ROLLBACK');\n+â”Š   â”Š182â”Š        await this.db.query('ROLLBACK');\n â”Š196â”Š183â”Š        return null;\n â”Š197â”Š184â”Š      }\n â”Š198â”Š185â”Š\n-â”Š199â”Š   â”Š      await db.query(sql`\n+â”Š   â”Š186â”Š      await this.db.query(sql`\n â”Š200â”Š187â”Š        DELETE FROM chats WHERE chats.id = ${chatId}\n â”Š201â”Š188â”Š      `);\n â”Š202â”Š189â”Š\n```\n```diff\n@@ -205,11 +192,11 @@\n â”Š205â”Š192â”Š        targetChat: chat,\n â”Š206â”Š193â”Š      });\n â”Š207â”Š194â”Š\n-â”Š208â”Š   â”Š      await db.query('COMMIT');\n+â”Š   â”Š195â”Š      await this.db.query('COMMIT');\n â”Š209â”Š196â”Š\n â”Š210â”Š197â”Š      return chatId;\n â”Š211â”Š198â”Š    } catch (e) {\n-â”Š212â”Š   â”Š      await db.query('ROLLBACK');\n+â”Š   â”Š199â”Š      await this.db.query('ROLLBACK');\n â”Š213â”Š200â”Š      throw e;\n â”Š214â”Š201â”Š    }\n â”Š215â”Š202â”Š  }\n```\n\n##### Changed modules&#x2F;users&#x2F;users.provider.ts\n```diff\n@@ -12,8 +12,7 @@\n â”Š12â”Š12â”Š  @Inject() private db: Database;\n â”Š13â”Š13â”Š\n â”Š14â”Š14â”Š  async findById(userId: string) {\n-â”Š15â”Š  â”Š    const db = await this.db.getClient();\n-â”Š16â”Š  â”Š    const { rows } = await db.query(\n+â”Š  â”Š15â”Š    const { rows } = await this.db.query(\n â”Š17â”Š16â”Š      sql`SELECT * FROM users WHERE id = ${userId}`\n â”Š18â”Š17â”Š    );\n â”Š19â”Š18â”Š\n```\n```diff\n@@ -21,8 +20,7 @@\n â”Š21â”Š20â”Š  }\n â”Š22â”Š21â”Š\n â”Š23â”Š22â”Š  async findAllExcept(userId: string) {\n-â”Š24â”Š  â”Š    const db = await this.db.getClient();\n-â”Š25â”Š  â”Š    const { rows } = await db.query(\n+â”Š  â”Š23â”Š    const { rows } = await this.db.query(\n â”Š26â”Š24â”Š      sql`SELECT * FROM users WHERE id != ${userId}`\n â”Š27â”Š25â”Š    );\n â”Š28â”Š26â”Š\n```\n```diff\n@@ -30,8 +28,7 @@\n â”Š30â”Š28â”Š  }\n â”Š31â”Š29â”Š\n â”Š32â”Š30â”Š  async findByUsername(username: string) {\n-â”Š33â”Š  â”Š    const db = await this.db.getClient();\n-â”Š34â”Š  â”Š    const { rows } = await db.query(\n+â”Š  â”Š31â”Š    const { rows } = await this.db.query(\n â”Š35â”Š32â”Š      sql`SELECT * FROM users WHERE username = ${username}`\n â”Š36â”Š33â”Š    );\n â”Š37â”Š34â”Š\n```\n```diff\n@@ -47,9 +44,8 @@\n â”Š47â”Š44â”Š    name: string;\n â”Š48â”Š45â”Š    password: string;\n â”Š49â”Š46â”Š  }) {\n-â”Š50â”Š  â”Š    const db = await this.db.getClient();\n â”Š51â”Š47â”Š    const passwordHash = bcrypt.hashSync(password, bcrypt.genSaltSync(8));\n-â”Š52â”Š  â”Š    const createdUserQuery = await db.query(sql`\n+â”Š  â”Š48â”Š    const createdUserQuery = await this.db.query(sql`\n â”Š53â”Š49â”Š        INSERT INTO users(password, picture, username, name)\n â”Š54â”Š50â”Š        VALUES(${passwordHash}, ${DEFAULT_PROFILE_PIC}, ${username}, ${name})\n â”Š55â”Š51â”Š        RETURNING *\n```\n\n[}]: #\n\nDeduplication is done but the `currentUser` method does more than just that. It verifies the auth token extracted from a request's cookie. This could be avoided by an assignment to a private prop and a simple if statement.\n\n[{]: <helper> (diffStep \"14.2\" module=\"server\")\n\n#### [__Server__ Step 14.2: Cache current user object](https://github.com/Urigo/WhatsApp-Clone-Server/commit/1004d68c1e18a9030df9410378e6f896362f48b6)\n\n##### Changed modules&#x2F;users&#x2F;auth.provider.ts\n```diff\n@@ -14,6 +14,7 @@\n â”Š14â”Š14â”Šexport class Auth {\n â”Š15â”Š15â”Š  @Inject() private users: Users;\n â”Š16â”Š16â”Š  @Inject() private module: ModuleSessionInfo;\n+â”Š  â”Š17â”Š  private _currentUser: User;\n â”Š17â”Š18â”Š\n â”Š18â”Š19â”Š  private get req() {\n â”Š19â”Š20â”Š    return this.module.session.req || this.module.session.request;\n```\n```diff\n@@ -76,11 +77,16 @@\n â”Š76â”Š77â”Š  }\n â”Š77â”Š78â”Š\n â”Š78â”Š79â”Š  async currentUser(): Promise<User | null> {\n+â”Š  â”Š80â”Š    if (this._currentUser) {\n+â”Š  â”Š81â”Š      return this._currentUser;\n+â”Š  â”Š82â”Š    }\n+â”Š  â”Š83â”Š\n â”Š79â”Š84â”Š    if (this.req.cookies.authToken) {\n â”Š80â”Š85â”Š      const username = jwt.verify(this.req.cookies.authToken, secret) as string;\n â”Š81â”Š86â”Š\n â”Š82â”Š87â”Š      if (username) {\n-â”Š83â”Š  â”Š        return this.users.findByUsername(username);\n+â”Š  â”Š88â”Š        this._currentUser = await this.users.findByUsername(username);\n+â”Š  â”Š89â”Š        return this._currentUser;\n â”Š84â”Š90â”Š      }\n â”Š85â”Š91â”Š    }\n```\n\n[}]: #\n\n![Resolvers](../../../assets/step17/img-02.png \"Resolvers\")\n\nAs you can see at the graph above, we reduced an execution time of `isMine` field from 4ms and 5ms to less than 1. That applies for all calls, all messages so it scales well and won't grow as list of messages increases.\n\nBut there's more... We see `chat` field being computed over and over again. So again, let's repeat the same steps.\nThe `Message.chat` resolver asks `Chats` service and its `findChatById` method which makes a SQL call.\n\nThe deduplication logic, we introduced in the previous step, helps to immediately resolve all `Message.chat` fields except the first occurrence but there's still a space for improvements.\n\nThe `Query.chats` resolver is invoked before the `Message.chat` which means at this point, we already have knowledge about the chats.\n\nLet's implement a caching logic for chats so we could reuse them. We will do it in few steps.\n\nFirst, because we're going to use `Dataloader`, `Chats` class should have private and public API.\n\n[{]: <helper> (diffStep \"14.3\" module=\"server\")\n\n#### [__Server__ Step 14.3: Separate db query from public API](https://github.com/Urigo/WhatsApp-Clone-Server/commit/0c85160c6ec357e4b1d0bbd4fc9daf44c6fe3e45)\n\n##### Changed modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -11,6 +11,10 @@\n â”Š11â”Š11â”Š  @Inject() private pubsub: PubSub;\n â”Š12â”Š12â”Š\n â”Š13â”Š13â”Š  async findChatsByUser(userId: string) {\n+â”Š  â”Š14â”Š    return this._findChatsByUser(userId);\n+â”Š  â”Š15â”Š  }\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š  private async _findChatsByUser(userId: string) {\n â”Š14â”Š18â”Š    const { rows } = await this.db.query(sql`\n â”Š15â”Š19â”Š      SELECT chats.* FROM chats, chats_users\n â”Š16â”Š20â”Š      WHERE chats.id = chats_users.chat_id\n```\n\n[}]: #\n\nThe private method is responsible for quering data from the database but the public one is to allow communication between the service and its consumers.\nIt's also there so we could switch to using Dataloader later on.\n\nWe did that to `findChatsByUser` but there are more:\n\n[{]: <helper> (diffStep \"14.4\" module=\"server\")\n\n#### [__Server__ Step 14.4: Separate findChatByUser](https://github.com/Urigo/WhatsApp-Clone-Server/commit/7824b587f1e0526777c503d5eedf48965c5588c1)\n\n##### Changed modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -25,6 +25,18 @@\n â”Š25â”Š25â”Š  }\n â”Š26â”Š26â”Š\n â”Š27â”Š27â”Š  async findChatByUser({ chatId, userId }: { chatId: string; userId: string }) {\n+â”Š  â”Š28â”Š    const rows = await this._findChatByUser({ chatId, userId });\n+â”Š  â”Š29â”Š\n+â”Š  â”Š30â”Š    return rows[0] || null;\n+â”Š  â”Š31â”Š  }\n+â”Š  â”Š32â”Š\n+â”Š  â”Š33â”Š  private async _findChatByUser({\n+â”Š  â”Š34â”Š    chatId,\n+â”Š  â”Š35â”Š    userId,\n+â”Š  â”Š36â”Š  }: {\n+â”Š  â”Š37â”Š    chatId: string;\n+â”Š  â”Š38â”Š    userId: string;\n+â”Š  â”Š39â”Š  }) {\n â”Š28â”Š40â”Š    const { rows } = await this.db.query(sql`\n â”Š29â”Š41â”Š      SELECT chats.* FROM chats, chats_users\n â”Š30â”Š42â”Š      WHERE chats_users.chat_id = ${chatId}\n```\n```diff\n@@ -32,7 +44,7 @@\n â”Š32â”Š44â”Š      AND chats_users.user_id = ${userId}\n â”Š33â”Š45â”Š    `);\n â”Š34â”Š46â”Š\n-â”Š35â”Š  â”Š    return rows[0] || null;\n+â”Š  â”Š47â”Š    return rows;\n â”Š36â”Š48â”Š  }\n â”Š37â”Š49â”Š\n â”Š38â”Š50â”Š  async findChatById(chatId: string) {\n```\n\n[}]: #\n[{]: <helper> (diffStep \"14.5\" module=\"server\")\n\n#### [__Server__ Step 14.5: Separate findChatById](https://github.com/Urigo/WhatsApp-Clone-Server/commit/e330ce5fcec9e76772e59a2d3f3084902751cede)\n\n##### Changed modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -48,10 +48,15 @@\n â”Š48â”Š48â”Š  }\n â”Š49â”Š49â”Š\n â”Š50â”Š50â”Š  async findChatById(chatId: string) {\n+â”Š  â”Š51â”Š    const rows = await this._findChatById(chatId);\n+â”Š  â”Š52â”Š    return rows[0] || null;\n+â”Š  â”Š53â”Š  }\n+â”Š  â”Š54â”Š\n+â”Š  â”Š55â”Š  private async _findChatById(chatId: string) {\n â”Š51â”Š56â”Š    const { rows } = await this.db.query(sql`\n â”Š52â”Š57â”Š      SELECT * FROM chats WHERE id = ${chatId}\n â”Š53â”Š58â”Š    `);\n-â”Š54â”Š  â”Š    return rows[0] || null;\n+â”Š  â”Š59â”Š    return rows;\n â”Š55â”Š60â”Š  }\n â”Š56â”Š61â”Š\n â”Š57â”Š62â”Š  async findMessagesByChat(chatId: string) {\n```\n\n[}]: #\n\n> Because those private methods are just to query data, make sure they all return untouched `row` object.\n\nNow's the most interesting part, Dataloader.\n\n[{]: <helper> (diffStep \"14.6\" module=\"server\")\n\n#### [__Server__ Step 14.6: Use Dataloader in Chats](https://github.com/Urigo/WhatsApp-Clone-Server/commit/edaf177dc1363c33bd58076f286a7e24df7d3ba7)\n\n##### Changed modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -1,8 +1,23 @@\n â”Š 1â”Š 1â”Šimport { Injectable, Inject, ProviderScope } from '@graphql-modules/di';\n+â”Š  â”Š 2â”Šimport { QueryResult } from 'pg';\n â”Š 2â”Š 3â”Šimport sql from 'sql-template-strings';\n+â”Š  â”Š 4â”Šimport DataLoader from 'dataloader';\n â”Š 3â”Š 5â”Šimport { Database } from '../common/database.provider';\n â”Š 4â”Š 6â”Šimport { PubSub } from '../common/pubsub.provider';\n â”Š 5â”Š 7â”Š\n+â”Š  â”Š 8â”Štype ChatsByUser = { userId: string };\n+â”Š  â”Š 9â”Štype ChatByUser = { userId: string; chatId: string };\n+â”Š  â”Š10â”Štype ChatById = { chatId: string };\n+â”Š  â”Š11â”Štype ChatsKey = ChatById | ChatByUser | ChatsByUser;\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Šfunction isChatsByUser(query: any): query is ChatsByUser {\n+â”Š  â”Š14â”Š  return query.userId && !query.chatId;\n+â”Š  â”Š15â”Š}\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Šfunction isChatByUser(query: any): query is ChatByUser {\n+â”Š  â”Š18â”Š  return query.userId && query.chatId;\n+â”Š  â”Š19â”Š}\n+â”Š  â”Š20â”Š\n â”Š 6â”Š21â”Š@Injectable({\n â”Š 7â”Š22â”Š  scope: ProviderScope.Session,\n â”Š 8â”Š23â”Š})\n```\n```diff\n@@ -10,8 +25,26 @@\n â”Š10â”Š25â”Š  @Inject() private db: Database;\n â”Š11â”Š26â”Š  @Inject() private pubsub: PubSub;\n â”Š12â”Š27â”Š\n+â”Š  â”Š28â”Š  private loaders = {\n+â”Š  â”Š29â”Š    chats: new DataLoader<ChatsKey, QueryResult['rows']>(keys => {\n+â”Š  â”Š30â”Š      return Promise.all(\n+â”Š  â”Š31â”Š        keys.map(async query => {\n+â”Š  â”Š32â”Š          if (isChatsByUser(query)) {\n+â”Š  â”Š33â”Š            return this._findChatsByUser(query.userId);\n+â”Š  â”Š34â”Š          }\n+â”Š  â”Š35â”Š\n+â”Š  â”Š36â”Š          if (isChatByUser(query)) {\n+â”Š  â”Š37â”Š            return this._findChatByUser(query);\n+â”Š  â”Š38â”Š          }\n+â”Š  â”Š39â”Š\n+â”Š  â”Š40â”Š          return this._findChatById(query.chatId);\n+â”Š  â”Š41â”Š        })\n+â”Š  â”Š42â”Š      );\n+â”Š  â”Š43â”Š    }),\n+â”Š  â”Š44â”Š  };\n+â”Š  â”Š45â”Š\n â”Š13â”Š46â”Š  async findChatsByUser(userId: string) {\n-â”Š14â”Š  â”Š    return this._findChatsByUser(userId);\n+â”Š  â”Š47â”Š    return this.loaders.chats.load({ userId });\n â”Š15â”Š48â”Š  }\n â”Š16â”Š49â”Š\n â”Š17â”Š50â”Š  private async _findChatsByUser(userId: string) {\n```\n```diff\n@@ -25,7 +58,7 @@\n â”Š25â”Š58â”Š  }\n â”Š26â”Š59â”Š\n â”Š27â”Š60â”Š  async findChatByUser({ chatId, userId }: { chatId: string; userId: string }) {\n-â”Š28â”Š  â”Š    const rows = await this._findChatByUser({ chatId, userId });\n+â”Š  â”Š61â”Š    const rows = await this.loaders.chats.load({ chatId, userId });\n â”Š29â”Š62â”Š\n â”Š30â”Š63â”Š    return rows[0] || null;\n â”Š31â”Š64â”Š  }\n```\n```diff\n@@ -48,7 +81,7 @@\n â”Š48â”Š81â”Š  }\n â”Š49â”Š82â”Š\n â”Š50â”Š83â”Š  async findChatById(chatId: string) {\n-â”Š51â”Š  â”Š    const rows = await this._findChatById(chatId);\n+â”Š  â”Š84â”Š    const rows = await this.loaders.chats.load({ chatId });\n â”Š52â”Š85â”Š    return rows[0] || null;\n â”Š53â”Š86â”Š  }\n â”Š54â”Š87â”Š\n```\n\n##### Changed package.json\n```diff\n@@ -51,6 +51,7 @@\n â”Š51â”Š51â”Š    \"cookie\": \"0.4.0\",\n â”Š52â”Š52â”Š    \"cors\": \"2.8.5\",\n â”Š53â”Š53â”Š    \"cookie-parser\": \"1.4.4\",\n+â”Š  â”Š54â”Š    \"dataloader\": \"1.4.0\",\n â”Š54â”Š55â”Š    \"express\": \"4.17.1\",\n â”Š55â”Š56â”Š    \"graphql\": \"14.4.2\",\n â”Š56â”Š57â”Š    \"graphql-import\": \"0.7.1\",\n```\n\n[}]: #\n\nWe introduced `ChatsKey` that is a union type, to standarize the input value. Those helper methods like `isChatsByUser` and `isChatByUser` are there to decide what should be fetched.\n\nIn every public method that we previously changed, there's now Dataloader in use but that's not entirely what we're trying to achieve.\n\nThe caching mechanism is not yet completed. We deduplicate requests but in some cases, we ask for chats that are already there, so we need to intercept our dataloader logic and introduce caching.\n\n[{]: <helper> (diffStep \"14.7\" module=\"server\")\n\n#### [__Server__ Step 14.7: Implement caching for Chats](https://github.com/Urigo/WhatsApp-Clone-Server/commit/d76f8318fd525464d31608b04ff9118b1d12aa5b)\n\n##### Changed modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -4,6 +4,7 @@\n â”Š 4â”Š 4â”Šimport DataLoader from 'dataloader';\n â”Š 5â”Š 5â”Šimport { Database } from '../common/database.provider';\n â”Š 6â”Š 6â”Šimport { PubSub } from '../common/pubsub.provider';\n+â”Š  â”Š 7â”Šimport { Chat } from '../../db';\n â”Š 7â”Š 8â”Š\n â”Š 8â”Š 9â”Štype ChatsByUser = { userId: string };\n â”Š 9â”Š10â”Štype ChatByUser = { userId: string; chatId: string };\n```\n```diff\n@@ -25,6 +26,7 @@\n â”Š25â”Š26â”Š  @Inject() private db: Database;\n â”Š26â”Š27â”Š  @Inject() private pubsub: PubSub;\n â”Š27â”Š28â”Š\n+â”Š  â”Š29â”Š  private chatsCache = new Map<string, Chat>();\n â”Š28â”Š30â”Š  private loaders = {\n â”Š29â”Š31â”Š    chats: new DataLoader<ChatsKey, QueryResult['rows']>(keys => {\n â”Š30â”Š32â”Š      return Promise.all(\n```\n```diff\n@@ -33,6 +35,10 @@\n â”Š33â”Š35â”Š            return this._findChatsByUser(query.userId);\n â”Š34â”Š36â”Š          }\n â”Š35â”Š37â”Š\n+â”Š  â”Š38â”Š          if (this.chatsCache.has(query.chatId)) {\n+â”Š  â”Š39â”Š            return [this._readChatFromCache(query.chatId)];\n+â”Š  â”Š40â”Š          }\n+â”Š  â”Š41â”Š\n â”Š36â”Š42â”Š          if (isChatByUser(query)) {\n â”Š37â”Š43â”Š            return this._findChatByUser(query);\n â”Š38â”Š44â”Š          }\n```\n```diff\n@@ -254,4 +260,14 @@\n â”Š254â”Š260â”Š      throw e;\n â”Š255â”Š261â”Š    }\n â”Š256â”Š262â”Š  }\n+â”Š   â”Š263â”Š\n+â”Š   â”Š264â”Š  private _readChatFromCache(chatId: string) {\n+â”Š   â”Š265â”Š    return this.chatsCache.get(chatId);\n+â”Š   â”Š266â”Š  }\n+â”Š   â”Š267â”Š\n+â”Š   â”Š268â”Š  private _writeChatToCache(chat?: Chat) {\n+â”Š   â”Š269â”Š    if (chat) {\n+â”Š   â”Š270â”Š      this.chatsCache.set(chat.id, chat);\n+â”Š   â”Š271â”Š    }\n+â”Š   â”Š272â”Š  }\n â”Š257â”Š273â”Š}\n```\n\n[}]: #\n\nWhenever we ask for a single chat that is available, it's being resolved right away but we still need to write data to the cache.\n\n[{]: <helper> (diffStep \"14.8\" module=\"server\")\n\n#### [__Server__ Step 14.8: Write chats to the cache](https://github.com/Urigo/WhatsApp-Clone-Server/commit/206907427ff19aec597c437eb8ac4eba4393b1f4)\n\n##### Changed modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -60,6 +60,10 @@\n â”Š60â”Š60â”Š      AND chats_users.user_id = ${userId}\n â”Š61â”Š61â”Š    `);\n â”Š62â”Š62â”Š\n+â”Š  â”Š63â”Š    rows.forEach(row => {\n+â”Š  â”Š64â”Š      this._writeChatToCache(row);\n+â”Š  â”Š65â”Š    });\n+â”Š  â”Š66â”Š\n â”Š63â”Š67â”Š    return rows;\n â”Š64â”Š68â”Š  }\n â”Š65â”Š69â”Š\n```\n```diff\n@@ -83,6 +87,8 @@\n â”Š83â”Š87â”Š      AND chats_users.user_id = ${userId}\n â”Š84â”Š88â”Š    `);\n â”Š85â”Š89â”Š\n+â”Š  â”Š90â”Š    this._writeChatToCache(rows[0]);\n+â”Š  â”Š91â”Š\n â”Š86â”Š92â”Š    return rows;\n â”Š87â”Š93â”Š  }\n â”Š88â”Š94â”Š\n```\n```diff\n@@ -95,6 +101,9 @@\n â”Š 95â”Š101â”Š    const { rows } = await this.db.query(sql`\n â”Š 96â”Š102â”Š      SELECT * FROM chats WHERE id = ${chatId}\n â”Š 97â”Š103â”Š    `);\n+â”Š   â”Š104â”Š\n+â”Š   â”Š105â”Š    this._writeChatToCache(rows[0]);\n+â”Š   â”Š106â”Š\n â”Š 98â”Š107â”Š    return rows;\n â”Š 99â”Š108â”Š  }\n```\n\n[}]: #\n\nLet's look at charts in Apollo Engine.\n\n![Resolvers](../../../assets/step17/img-03.png \"Resolvers\")\n\nWe cut off `Message.chat` to less than 1ms.\n\nThe `Chat.name` and `Chat.picture` resolvers share the same logic and since Database service is wrapped with DataLoader, we make a single SQL query. Unfortunately, it's not visible on the graph.\n\nLet's summarize our work. **We made the GetChat operation almost 60% faster on average** and it's just based on one chat with one message. The number would be much much higher on a bigger scale.\n\n### Preventing issues\n\nThe Apollo Engine has another interesting feature. Itâ€™s called Alerts. You set a threshold for all operations or a specific one and whenever it takes longer, you get a notification on Slack. But thereâ€™s a catch, you need to pay in order to unlock it.\n\nWeâ€™re working on something similar but entirely open-sourced. Itâ€™s an extension of ApolloServer that lets you track operations and get exactly what you would get from the engine but self-hosted.\n\n## UI Performance\n\nThe part would be the User Interface and the web app in general.\n\n### Metrics\n\nThere's a highly recommended and very comprehensive publication written by Philip Walton (Engineer at Google) called [\"User-centric Performance Metrics\"](https://developers.google.com/web/fundamentals/performance/user-centric-performance-metrics) that was an inspiration for this chapter. Weâ€™re going to talk in short about measuring render performance of a web application.\n\nLetâ€™s base this chapter on real data. First, open the app and go to Performance tab of Chrome DevTools.\n\n![Record](../../../assets/step17/img-04.png \"Record\")\n\nNow click on â€œStart profiling and reload pageâ€. After itâ€™s done you should see the following:\n\n![All panels](../../../assets/step17/img-05.png \"All panels\")\n\nRight now it may not make a lot of sense, so weâ€™re going to start with something basic.\n\nThereâ€™s many different kinds of charts but we will cover only few of them: Network, Frames, Timings and Main.\n\nLetâ€™s check out the Timings section and explain few important performance metrics.\n\n- DCL - DOMContentLoaded Event\n- L - Onload Event\n- FP - First Paint\n- FCP - First Contentful Paint\n- FMP - First Meaningful Paint\n\nThereâ€™s also another one that is not visible on the timeline but also not less important, TTI - Time to Interactive.\n\nWe will focus on FP, FCP, FMP and TTI.\n\nThe primary difference between the two metrics is **First Paint** marks the point when the browser renders anything that is visually different from what was on the screen prior to navigation. By contrast, **First Contentful Paint** is the point when the browser renders the first bit of content from the DOM, which may be text, an image, SVG, or even a `<canvas>` element.\n\nThe **First Meaningful Paint** should mark the point when something useful was rendered. It might mean an input box on Google, video player on YouTube or in our case, a list of chats.\n\nThe **Time To Interactive** metric marks the point at which the application is both visually rendered and capable of reliably responding to user input.\n\nNow with all that knowledge we can move on to something more practical, the **Frames panel**. The main purpose here is to see whatâ€™s rendered at given time. In our case, the first paint was made after over 200ms, which is not a bad result at all but see that huge blank space next to it.\n\nThe **Network section**, is going to help us out here and give some pointers of what might be a reason of it. Itâ€™s a timeline that explains when each request was made and how long it took to resolve.\n\n![Network section](../../../assets/step17/img-06.png \"Network section\")\n\nWhat do we see here? One of the first requests are js files and we need those to bootstrap and render the app. Thatâ€™s the reason of the blank page.\n\nWe could improve that by either Server-Side Rendering or using a Service Worker.\n\n### Rendering improvements\n\n#### Server-Side Rendering\n\nImplementing SSR means you run the app on server, before itâ€™s being shipped to the client and the documentâ€™s content is not just `<html><body><app></app></body></html>` but an actual markup with all the components in it. Because itâ€™s a part of the document, the browser can already display something meaningful and after js files are loaded, the app bootstraps on the client and it becomes interactive. There is one caveat. Wherever you ship the app it has to be able to run node js.\n\n#### Store Rehydration\n\nWhen talking SSR itâ€™s worth to mention GraphQL and related technique called Store Rehydration. API calls are an important part of an application and plays a huge role in SSR.\n\nGraphQL operations are called once components are mounted which means the cache is filled up and why not reuse it on client.\n\nHow would it work? Data is extracted from the apolloâ€™s cache and passed within a document. After itâ€™s received by the browser, the app runs and so does the Apollo Client. While it happens we look for the data and fill up the cache. Now whenever a component calls a GraphQL operation, the result is already in the cache and resolves immediately.\n\n#### Service Worker\n\nAnother approach is a bit different. By using a Service Worker, weâ€™re able to control and cache requests, including js files, images etc. On the first visit, the app loads exactly the same as without SSR but the next visits are a bit faster. Itâ€™s because the Service Worker is registered after you close the app and of course we canâ€™t cache things that werenâ€™t fetched yet.\n\nBoth techniques are not mutually exclusive and we highly recommend to use both.\n\n![Main section](../../../assets/step17/img-07.png \"Main section\")\n\nThe next section weâ€™re going to talk about is the **Main panel**, a flame chart of activity on the main thread. You see those blocks? They represent an event, the wider it is the longer it took. One of the most important things to remember is to avoid long events since they block the thread.\nThe longest event on our timeline is the Evaluate Script event that involves `main.js`. The file contains all the libraries and the core functionality, those are needed to run the app. By making it lighter we would decrease the time of the first render.\nWe already do something to reduce the bundle size, This technique we use is called code-splitting and it allows to split one piece of code into multiple files which are lazy loaded.\nIt cuts off the size of the main bundle and the rest is loaded on demand, letâ€™s say login page is in a different chunk than list of chats.\n\n### Tooling\n\nThereâ€™s one tool built into Chrome DevTools called Lighthouse that allows to measure, collect metrics and get helpful tips on how to improve the performance and where are the pain points.\n\nHereâ€™s the example:\n\n![Lighthouse results](../../../assets/step17/img-08.png \"Lighthouse results\")\n\nOnce your app is optimized you want to prevent regressions. Lighthouse has you covered! It may run as part of Continuous Integration and prevents deployment when key metrics regress or drop below a certain threshold.\n\n## Making the app feels instant\n\nDealing with slow network can be hard so let's simulate that situation. After all, running the application on local host will always result in low response times.\n\nLuckily most browser come with a built in solution for that - we can simulate a slow network by defining the throttle level:\n\n![Throttling](../../../assets/step17/img-09.png \"Throttling\")\n\nIf we will refresh the application, we should notice a significant slow down the first time we load each screen; about few seconds to load each of them. To ensure that this is really caused by a slow network and not by anything else, we can open the dev-tools of our browser (letâ€™s assume you use Chrome) and under the `network` tab we should notice the network activity times.\n\n> More information about monitoring network activity and throttling it using the Chromeâ€™s dev-tools can be found in [the official dev-tools docs page](https://developers.google.com/web/tools/chrome-devtools/network/).\n\nTo solve these issues there are a couple of changes weâ€™re gonna make in the way we fetch and manage data.\n\n### Optimistic UI\n\nAs you know, pretty much in all cases, everything in Apollo flows through its cache. If a requested data is in there, a query is resolved right away. Mutations are a bit different, they have to reach the server every single time. Seems like nothing we can do about it but fortunately we can simulate the mutation, predict the result and make Apollo treat it as a temporary data. Which means, the appâ€™s state and all components are updated and the change is visible instantly after itâ€™s made.\n\nIn case of the WhatsApp clone, whenever a new message is sent, we will see it right away, on the screen, doesnâ€™t matter if the network is low or even super fast. You may experience the similar behavior on Facebookâ€™s Messenger.\n\n\n```graphql\n  mutation AddMessage($chatId: ID!, $content: String!) {\n    addMessage(chatId: $chatId, content: $content) {\n      ...Message\n    }\n  }\n```\n\n```graphql\n  addMessage({\n    variables: { chatId, content },\n    optimisticResponse: {\n      __typename: 'Mutation',\n      addMessage: {\n        __typename: 'Message',\n        id: Math.random().toString(36).substr(2, 9),\n        createdAt: new Date(),\n        isMine: true,\n        chat: {\n          __typename: 'Chat',\n          id: chatId,\n        },\n        content,\n      }\n    },\n    update: (client, { data: { addMessage } }) => {\n      writeMessage(client, addMessage);\n    },\n  })\n```\n\nWe used words â€œpredictâ€ and â€œsimulateâ€, what if the mutation behaves differently or whatâ€™s more interesting, it fails. Apollo handles that as well. The â€œrealâ€ response overwrites the fake one and the store is reverted back to the original state.\n\n### Prefetching data\n\nAnother technique but with a bit different purpose is about fetching data in advance. In some situations, you might be able to predict which page/component is going to be entered next.\n\nLetâ€™s base it on a real example. The WhatsApp clone has a page with a list of chats. The component that represents the page, calls a GraphQL operation to fetch that list. Right now, when user clicks on one of the chats, heâ€™s redirected to a partially empty page because of the ongoing GraphQL request. What if we could fetch that data in advance? Thatâ€™s what this technique is about. We could predict userâ€™s next move based on a simple mouse event or even by using Artificial Intelligence and data collected by Google Analytics, so whenever the move actually happens, the data is already in the cache.\n\n[{]: <helper> (diffStep \"15.1\" files=\"src/components/ChatRoomScreen/index.tsx\" module=\"client\")\n\n#### [__Client__ Step 15.1: Implement prefetching](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/a6a122fe74e9cdae1974b8b3cd8b4327950e0e3a)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -2,12 +2,19 @@\n â”Š 2â”Š 2â”Šimport React from 'react';\n â”Š 3â”Š 3â”Šimport { useCallback } from 'react';\n â”Š 4â”Š 4â”Šimport { Redirect } from 'react-router-dom';\n+â”Š  â”Š 5â”Šimport { useApolloClient } from '@apollo/react-hooks';\n â”Š 5â”Š 6â”Šimport styled from 'styled-components';\n â”Š 6â”Š 7â”Šimport ChatNavbar from './ChatNavbar';\n â”Š 7â”Š 8â”Šimport MessageInput from './MessageInput';\n â”Š 8â”Š 9â”Šimport MessagesList from './MessagesList';\n â”Š 9â”Š10â”Šimport { History } from 'history';\n-â”Š10â”Š  â”Šimport { useGetChatQuery, useAddMessageMutation } from '../../graphql/types';\n+â”Š  â”Š11â”Šimport {\n+â”Š  â”Š12â”Š  useGetChatQuery,\n+â”Š  â”Š13â”Š  useAddMessageMutation,\n+â”Š  â”Š14â”Š  GetChatQuery,\n+â”Š  â”Š15â”Š  GetChatQueryVariables,\n+â”Š  â”Š16â”Š  GetChatDocument,\n+â”Š  â”Š17â”Š} from '../../graphql/types';\n â”Š11â”Š18â”Šimport * as fragments from '../../graphql/fragments';\n â”Š12â”Š19â”Šimport { writeMessage } from '../../services/cache.service';\n â”Š13â”Š20â”Š\n```\n```diff\n@@ -38,6 +45,19 @@\n â”Š38â”Š45â”Š  ${fragments.message}\n â”Š39â”Š46â”Š`;\n â”Š40â”Š47â”Š\n+â”Š  â”Š48â”Šexport const useGetChatPrefetch = () => {\n+â”Š  â”Š49â”Š  const client = useApolloClient();\n+â”Š  â”Š50â”Š\n+â”Š  â”Š51â”Š  return (chatId: string) => {\n+â”Š  â”Š52â”Š    client.query<GetChatQuery, GetChatQueryVariables>({\n+â”Š  â”Š53â”Š      query: GetChatDocument,\n+â”Š  â”Š54â”Š      variables: {\n+â”Š  â”Š55â”Š        chatId,\n+â”Š  â”Š56â”Š      },\n+â”Š  â”Š57â”Š    });\n+â”Š  â”Š58â”Š  };\n+â”Š  â”Š59â”Š};\n+â”Š  â”Š60â”Š\n â”Š41â”Š61â”Šinterface ChatRoomScreenParams {\n â”Š42â”Š62â”Š  chatId: string;\n â”Š43â”Š63â”Š  history: History;\n```\n\n[}]: #\n\nWe created the `useGetChatPrefetch` hook that gets ApolloClient instance through `useApolloClient` and returns a function to prefetch data. In this case we request `GetChat` operation. Because Apollo deduplicates queries, we won't make multiple http calls, we're safe.\n\nThe actual usage of `useGetChatPrefetch`, happens on `mouse entered` event:\n\n[{]: <helper> (diffStep \"15.1\" files=\"src/components/ChatsListScreen/ChatsList.tsx\" module=\"client\")\n\n#### [__Client__ Step 15.1: Implement prefetching](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/a6a122fe74e9cdae1974b8b3cd8b4327950e0e3a)\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -5,6 +5,7 @@\n â”Š 5â”Š 5â”Šimport { useCallback } from 'react';\n â”Š 6â”Š 6â”Šimport { History } from 'history';\n â”Š 7â”Š 7â”Šimport { useChatsQuery } from '../../graphql/types';\n+â”Š  â”Š 8â”Šimport { useGetChatPrefetch } from '../ChatRoomScreen';\n â”Š 8â”Š 9â”Š\n â”Š 9â”Š10â”Šconst Container = styled.div`\n â”Š10â”Š11â”Š  height: calc(100% - 56px);\n```\n```diff\n@@ -69,6 +70,7 @@\n â”Š69â”Š70â”Š    },\n â”Š70â”Š71â”Š    [history]\n â”Š71â”Š72â”Š  );\n+â”Š  â”Š73â”Š  const prefetchChat = useGetChatPrefetch();\n â”Š72â”Š74â”Š\n â”Š73â”Š75â”Š  const { data } = useChatsQuery();\n â”Š74â”Š76â”Š\n```\n```diff\n@@ -85,7 +87,10 @@\n â”Š85â”Š87â”Š            key={chat.id}\n â”Š86â”Š88â”Š            data-testid=\"chat\"\n â”Š87â”Š89â”Š            button\n-â”Š88â”Š  â”Š            onClick={navToChat.bind(null, chat)}>\n+â”Š  â”Š90â”Š            onClick={navToChat.bind(null, chat)}\n+â”Š  â”Š91â”Š            onMouseEnter={() => {\n+â”Š  â”Š92â”Š              prefetchChat(chat.id);\n+â”Š  â”Š93â”Š            }}>\n â”Š89â”Š94â”Š            <ChatPicture\n â”Š90â”Š95â”Š              data-testid=\"picture\"\n â”Š91â”Š96â”Š              src={chat.picture}\n```\n\n[}]: #\n\nNow, the same but with the list of users:\n\n[{]: <helper> (diffStep \"15.1\" files=\"src/components/ChatsListScreen/AddChatButton.tsx\" module=\"client\")\n\n#### [__Client__ Step 15.1: Implement prefetching](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/a6a122fe74e9cdae1974b8b3cd8b4327950e0e3a)\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;AddChatButton.tsx\n```diff\n@@ -3,6 +3,7 @@\n â”Š3â”Š3â”Šimport React from 'react';\n â”Š4â”Š4â”Šimport styled from 'styled-components';\n â”Š5â”Š5â”Šimport { History } from 'history';\n+â”Š â”Š6â”Šimport { useUsersPrefetch } from '../UsersList';\n â”Š6â”Š7â”Š\n â”Š7â”Š8â”Šconst Container = styled.div`\n â”Š8â”Š9â”Š  position: fixed;\n```\n```diff\n@@ -18,17 +19,19 @@\n â”Š18â”Š19â”Š    color: white;\n â”Š19â”Š20â”Š  }\n â”Š20â”Š21â”Š`;\n+â”Š  â”Š22â”Š\n â”Š21â”Š23â”Šinterface ChildComponentProps {\n â”Š22â”Š24â”Š  history: History;\n â”Š23â”Š25â”Š}\n â”Š24â”Š26â”Š\n â”Š25â”Š27â”Šconst AddChatButton: React.FC<ChildComponentProps> = ({ history }) => {\n+â”Š  â”Š28â”Š  const prefetchUsers = useUsersPrefetch();\n â”Š26â”Š29â”Š  const onClick = () => {\n â”Š27â”Š30â”Š    history.push('/new-chat');\n â”Š28â”Š31â”Š  };\n â”Š29â”Š32â”Š\n â”Š30â”Š33â”Š  return (\n-â”Š31â”Š  â”Š    <Container>\n+â”Š  â”Š34â”Š    <Container onMouseEnter={() => prefetchUsers()}>\n â”Š32â”Š35â”Š      <Button\n â”Š33â”Š36â”Š        data-testid=\"new-chat-button\"\n â”Š34â”Š37â”Š        variant=\"contained\"\n```\n\n[}]: #\n[{]: <helper> (diffStep \"15.1\" files=\"src/components/ChatsListScreen/ChatsList.tsx\" module=\"client\")\n\n#### [__Client__ Step 15.1: Implement prefetching](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/a6a122fe74e9cdae1974b8b3cd8b4327950e0e3a)\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -5,6 +5,7 @@\n â”Š 5â”Š 5â”Šimport { useCallback } from 'react';\n â”Š 6â”Š 6â”Šimport { History } from 'history';\n â”Š 7â”Š 7â”Šimport { useChatsQuery } from '../../graphql/types';\n+â”Š  â”Š 8â”Šimport { useGetChatPrefetch } from '../ChatRoomScreen';\n â”Š 8â”Š 9â”Š\n â”Š 9â”Š10â”Šconst Container = styled.div`\n â”Š10â”Š11â”Š  height: calc(100% - 56px);\n```\n```diff\n@@ -69,6 +70,7 @@\n â”Š69â”Š70â”Š    },\n â”Š70â”Š71â”Š    [history]\n â”Š71â”Š72â”Š  );\n+â”Š  â”Š73â”Š  const prefetchChat = useGetChatPrefetch();\n â”Š72â”Š74â”Š\n â”Š73â”Š75â”Š  const { data } = useChatsQuery();\n â”Š74â”Š76â”Š\n```\n```diff\n@@ -85,7 +87,10 @@\n â”Š85â”Š87â”Š            key={chat.id}\n â”Š86â”Š88â”Š            data-testid=\"chat\"\n â”Š87â”Š89â”Š            button\n-â”Š88â”Š  â”Š            onClick={navToChat.bind(null, chat)}>\n+â”Š  â”Š90â”Š            onClick={navToChat.bind(null, chat)}\n+â”Š  â”Š91â”Š            onMouseEnter={() => {\n+â”Š  â”Š92â”Š              prefetchChat(chat.id);\n+â”Š  â”Š93â”Š            }}>\n â”Š89â”Š94â”Š            <ChatPicture\n â”Š90â”Š95â”Š              data-testid=\"picture\"\n â”Š91â”Š96â”Š              src={chat.picture}\n```\n\n[}]: #\n\n### Splitting and Deferring Queries\n\nPrefetching is an easy way to make your applications UI feel faster. You can use mouse events to predict the data that could be needed. This is powerful and works perfectly on the browser, but can not be applied to a mobile device.\n\nOne solution for improving the UI experience would be the usage of fragments to preload more data in a query, but loading huge amounts of data (that you probably never show to the user) is expensive.\n\nAnother solution would be to **split huge queries into two smaller queries**:\n\n- The first one could load data which is already in the store. This means that it can be displayed instantly.\n- The second query could load data which is not in the store yet and must be fetched from the server first.\n\nThis solution gives you the benefit of not fetching too much data, as well as the possibility to show some part of the views data before the server responds.\n\nThis could be used in our messaging app to load chatâ€™s information and messages separately. This way we will see the title and the image instantly, because itâ€™s already in the cache but messages will be loaded afterwards. UX will benefit a lot.\n\nThereâ€™s also something very similar conceptually to Query Splitting but instead of separating queries we keep everything in one operation and annotate the parts that should be deferred. The annotation is, of course a directive and itâ€™s called **`@defer`**.\n\nOnce the `@defer` is used, the server returns an initial response without waiting for deferred fields to resolve, using null as placeholders for them. Then, it streams patches for each deferred field asynchronously as they resolve. Thanks to that, we maintain one operation but decide how it behaves.\n\n> Right now, this feature is not well supported in Apollo Server so we donâ€™t recommend to use it yet. Keep it on mind though.\n\n### Dealing with rendering issues\n\nThe most naive thing we can do to start noticing performance issues would be loading TONS of data to our app, and make sure that each view is absolutely overwhelmed with information. This way performance issues will start rising above the surface pretty quickly. To do that, we will edit the `resetDb()` method on the server so it can generate large quantities of data. The most comfortable way of controlling that behavior would be through an environment variable that will tell the reset method how much iterations it should run. The more iterations, the more data would be fabricated:\n\n[{]: <helper> (diffStep \"15.10\" module=\"server\")\n\n#### Step 15.10: NOT FOUND!\n\n[}]: #\n\nItâ€™s important to note that weâ€™ve generated the data in a very specific way where a single user will be the center of the network of data. This way when we log in with that user, we should see our views packed. If it wasnâ€™t for that we would have just had large quantities of data in the DB, but none of it would appear to the end-user.\n\nNow, we will restart the server and this time run it differently. We will provide `FAKED_DB` with a value of `100` which should connect us to 100 messages per single view:\n\n    RESET_DB=true FAKED_DB=100 yarn start\n\nNow make sure that the application is running and log-in with the first user of Ray Edwards using the credentials:\n\n    username: ray\n    passowrd: 111\n\nNow try to navigate around between the `ChatsScreen` and `ChatBoxScreen`. Youâ€™ll notice that each transition takes a long time until it shows the data. Itâ€™s obviously something which is related to rendering and not data transportation, because the slowdown also happens the second time you visit a view, a point where the fetched data should have already been stored by Apollo in cache. So weâ€™ve already detected one performance issue we should deal with.\n\n### Pagination\n\nTo solve it, there are couple of changes weâ€™re gonna make in the way we ask for data, messages will be fetched dynamically based on our scrolling position.\n\nWith these changes, the requests will be splitted into smaller chunks, and React DOM wonâ€™t have to deal with a lot of data the first time it loads. There are few challenges that may arise from this implementation:\n\n- Representing queries in a way that they can be loaded in chunks\n- Sending requests and updating the view dynamically\n- Maintaining updates from subscriptions\n\nTo start with, we will first take on the task of improving initialization times. We will release the pressure by fetching only the first 20 messages. This way when we visit a chat, it should be loaded faster.\n\nFor that we're going to implement cursor-based pagination. We will add `after` and `limit` arguments to `Chat.messages` that could be used to fetch a specific snapshot of available messages.\n\n- `after` is optional and marks the point where the last fetch ended (what is the last element of a received list)\n- `limit` is required, defines amount of data\n\nA common design pattern for fetching data snapshots from a GraphQL back-end is called [Relay](https://facebook.github.io/relay/docs/en/graphql-server-specification.html). Relay provides a robust solution which is suitable for things like search engines.\n\nWe will define our own version of it.\n\n[{]: <helper> (diffStep \"14.9\" module=\"server\")\n\n#### [__Server__ Step 14.9: Add fake data](https://github.com/Urigo/WhatsApp-Clone-Server/commit/1b1efff53a613148a57444972525a20a3d7e8a7f)\n\n##### Changed db.ts\n```diff\n@@ -1,6 +1,8 @@\n â”Š1â”Š1â”Šimport { Pool } from 'pg';\n â”Š2â”Š2â”Šimport sql from 'sql-template-strings';\n-â”Š3â”Š â”Šimport { resetDb as envResetDb } from './env';\n+â”Š â”Š3â”Šimport faker from 'faker';\n+â”Š â”Š4â”Šimport addMinutes from 'date-fns/add_minutes';\n+â”Š â”Š5â”Šimport { resetDb as envResetDb, fakedDb } from './env';\n â”Š4â”Š6â”Š\n â”Š5â”Š7â”Šexport type User = {\n â”Š6â”Š8â”Š  id: string;\n```\n```diff\n@@ -234,6 +236,10 @@\n â”Š234â”Š236â”Š    },\n â”Š235â”Š237â”Š  ];\n â”Š236â”Š238â”Š\n+â”Š   â”Š239â”Š  if (fakedDb) {\n+â”Š   â”Š240â”Š    addFakedMessages(sampleMessages, fakedDb);\n+â”Š   â”Š241â”Š  }\n+â”Š   â”Š242â”Š\n â”Š237â”Š243â”Š  for (const sampleMessage of sampleMessages) {\n â”Š238â”Š244â”Š    await pool.query(sql`\n â”Š239â”Š245â”Š      INSERT INTO messages(id, content, created_at, chat_id, sender_user_id)\n```\n```diff\n@@ -248,6 +254,21 @@\n â”Š248â”Š254â”Š  );\n â”Š249â”Š255â”Š};\n â”Š250â”Š256â”Š\n+â”Š   â”Š257â”Šfunction addFakedMessages(messages: Message[], count: number) {\n+â”Š   â”Š258â”Š  const message = messages[0];\n+â”Š   â”Š259â”Š  const date = message.created_at;\n+â”Š   â”Š260â”Š  const id = messages.length + 1;\n+â”Š   â”Š261â”Š\n+â”Š   â”Š262â”Š  new Array(count).fill(0).forEach((_, i) => {\n+â”Š   â”Š263â”Š    messages.push({\n+â”Š   â”Š264â”Š      ...message,\n+â”Š   â”Š265â”Š      id: `${id + i}`,\n+â”Š   â”Š266â”Š      content: faker.lorem.sentence(4),\n+â”Š   â”Š267â”Š      created_at: addMinutes(date, i + 1),\n+â”Š   â”Š268â”Š    });\n+â”Š   â”Š269â”Š  });\n+â”Š   â”Š270â”Š}\n+â”Š   â”Š271â”Š\n â”Š251â”Š272â”Šif (envResetDb) {\n â”Š252â”Š273â”Š  resetDb();\n â”Š253â”Š274â”Š}\n```\n\n##### Changed env.ts\n```diff\n@@ -5,3 +5,6 @@\n â”Š 5â”Š 5â”Šexport const origin = process.env.ORIGIN || 'http://localhost:3000';\n â”Š 6â”Š 6â”Šexport const port = process.env.PORT || 4000;\n â”Š 7â”Š 7â”Šexport const resetDb = process.env.RESET_DB || false;\n+â”Š  â”Š 8â”Šexport const fakedDb = process.env.FAKED_DB\n+â”Š  â”Š 9â”Š  ? parseInt(process.env.FAKED_DB, 10)\n+â”Š  â”Š10â”Š  : 0;\n```\n\n##### Changed package.json\n```diff\n@@ -25,6 +25,7 @@\n â”Š25â”Š25â”Š    \"@types/cookie\": \"0.3.3\",\n â”Š26â”Š26â”Š    \"@types/cookie-parser\": \"1.4.1\",\n â”Š27â”Š27â”Š    \"@types/express\": \"4.17.0\",\n+â”Š  â”Š28â”Š    \"@types/faker\": \"4.1.5\",\n â”Š28â”Š29â”Š    \"@types/graphql\": \"14.2.3\",\n â”Š29â”Š30â”Š    \"@types/graphql-iso-date\": \"3.3.1\",\n â”Š30â”Š31â”Š    \"@types/jest\": \"24.0.17\",\n```\n```diff\n@@ -52,7 +53,9 @@\n â”Š52â”Š53â”Š    \"cors\": \"2.8.5\",\n â”Š53â”Š54â”Š    \"cookie-parser\": \"1.4.4\",\n â”Š54â”Š55â”Š    \"dataloader\": \"1.4.0\",\n+â”Š  â”Š56â”Š    \"date-fns\": \"1.30.1\",\n â”Š55â”Š57â”Š    \"express\": \"4.17.1\",\n+â”Š  â”Š58â”Š    \"faker\": \"4.1.0\",\n â”Š56â”Š59â”Š    \"graphql\": \"14.4.2\",\n â”Š57â”Š60â”Š    \"graphql-import\": \"0.7.1\",\n â”Š58â”Š61â”Š    \"graphql-iso-date\": \"3.6.1\",\n```\n\n[}]: #\n\nThe `MessagesResult` is built of:\n\n- `cursor` - marks the end of a fetched list\n- `hasMore` - tells if there's more data to ask for\n- `message` - has the same type as `Chat.messages` previously had\n\nBecause the cursor marks the edge of received data, it has to be something we could use while sorting. The most obvious choice is the date of creation, so `created_at` column of `messages` table.\n\nIt's stored as `YYYY-MM-DD HH:mm:ss` but we want to expose it as something easier to work with, let's say a `number`.\n\nIn order to do it quickly, let's add `date-fns` package:\n\n    npm install date-fns\n\nIt has `format` method that will help us to do conversions.\n\nWe need to the logic of `Chats.findMessagesByChat` method.\n\n[{]: <helper> (diffStep \"14.11\" module=\"server\")\n\n#### [__Server__ Step 14.11: Implement cursor-based pagination in messages](https://github.com/Urigo/WhatsApp-Clone-Server/commit/983033ff44ff06053741d9548fcfca66ce0e0d8b)\n\n##### Changed modules&#x2F;chats&#x2F;chats.provider.ts\n```diff\n@@ -2,6 +2,7 @@\n â”Š2â”Š2â”Šimport { QueryResult } from 'pg';\n â”Š3â”Š3â”Šimport sql from 'sql-template-strings';\n â”Š4â”Š4â”Šimport DataLoader from 'dataloader';\n+â”Š â”Š5â”Šimport format from 'date-fns/format';\n â”Š5â”Š6â”Šimport { Database } from '../common/database.provider';\n â”Š6â”Š7â”Šimport { PubSub } from '../common/pubsub.provider';\n â”Š7â”Š8â”Šimport { Chat } from '../../db';\n```\n```diff\n@@ -107,12 +108,55 @@\n â”Š107â”Š108â”Š    return rows;\n â”Š108â”Š109â”Š  }\n â”Š109â”Š110â”Š\n-â”Š110â”Š   â”Š  async findMessagesByChat(chatId: string) {\n-â”Š111â”Š   â”Š    const { rows } = await this.db.query(\n-â”Š112â”Š   â”Š      sql`SELECT * FROM messages WHERE chat_id = ${chatId}`\n+â”Š   â”Š111â”Š  async findMessagesByChat({\n+â”Š   â”Š112â”Š    chatId,\n+â”Š   â”Š113â”Š    limit,\n+â”Š   â”Š114â”Š    after,\n+â”Š   â”Š115â”Š  }: {\n+â”Š   â”Š116â”Š    chatId: string;\n+â”Š   â”Š117â”Š    limit: number;\n+â”Š   â”Š118â”Š    after?: number | null;\n+â”Š   â”Š119â”Š  }): Promise<{\n+â”Š   â”Š120â”Š    hasMore: boolean;\n+â”Š   â”Š121â”Š    cursor: number | null;\n+â”Š   â”Š122â”Š    messages: any[];\n+â”Š   â”Š123â”Š  }> {\n+â”Š   â”Š124â”Š    const query = sql`SELECT * FROM messages`;\n+â”Š   â”Š125â”Š    query.append(` WHERE chat_id = ${chatId}`);\n+â”Š   â”Š126â”Š\n+â”Š   â”Š127â”Š    if (after) {\n+â”Š   â”Š128â”Š      // the created_at is the cursor\n+â”Š   â”Š129â”Š      query.append(` AND created_at < ${cursorToDate(after)}`);\n+â”Š   â”Š130â”Š    }\n+â”Š   â”Š131â”Š\n+â”Š   â”Š132â”Š    query.append(` ORDER BY created_at DESC LIMIT ${limit}`);\n+â”Š   â”Š133â”Š\n+â”Š   â”Š134â”Š    const { rows: messages } = await this.db.query(query);\n+â”Š   â”Š135â”Š\n+â”Š   â”Š136â”Š    if (!messages) {\n+â”Š   â”Š137â”Š      return {\n+â”Š   â”Š138â”Š        hasMore: false,\n+â”Š   â”Š139â”Š        cursor: null,\n+â”Š   â”Š140â”Š        messages: [],\n+â”Š   â”Š141â”Š      };\n+â”Š   â”Š142â”Š    }\n+â”Š   â”Š143â”Š\n+â”Š   â”Š144â”Š    // so we send them as old -> new\n+â”Š   â”Š145â”Š    messages.reverse();\n+â”Š   â”Š146â”Š\n+â”Š   â”Š147â”Š    // cursor is a number representation of created_at\n+â”Š   â”Š148â”Š    const cursor = messages.length ? new Date(messages[0].created_at).getTime() : 0;\n+â”Š   â”Š149â”Š    const { rows: next } = await this.db.query(\n+â”Š   â”Š150â”Š      sql`SELECT * FROM messages WHERE chat_id = ${chatId} AND created_at < ${cursorToDate(\n+â”Š   â”Š151â”Š        cursor\n+â”Š   â”Š152â”Š      )} ORDER BY created_at DESC LIMIT 1`\n â”Š113â”Š153â”Š    );\n â”Š114â”Š154â”Š\n-â”Š115â”Š   â”Š    return rows;\n+â”Š   â”Š155â”Š    return {\n+â”Š   â”Š156â”Š      hasMore: next.length === 1, // means there's no more messages\n+â”Š   â”Š157â”Š      cursor,\n+â”Š   â”Š158â”Š      messages,\n+â”Š   â”Š159â”Š    };\n â”Š116â”Š160â”Š  }\n â”Š117â”Š161â”Š\n â”Š118â”Š162â”Š  async lastMessage(chatId: string) {\n```\n```diff\n@@ -280,3 +324,7 @@\n â”Š280â”Š324â”Š    }\n â”Š281â”Š325â”Š  }\n â”Š282â”Š326â”Š}\n+â”Š   â”Š327â”Š\n+â”Š   â”Š328â”Šfunction cursorToDate(cursor: number) {\n+â”Š   â”Š329â”Š  return `'${format(cursor, 'YYYY-MM-DD HH:mm:ss')}'`;\n+â”Š   â”Š330â”Š}\n```\n\n##### Changed modules&#x2F;chats&#x2F;index.ts\n```diff\n@@ -111,7 +111,11 @@\n â”Š111â”Š111â”Š    },\n â”Š112â”Š112â”Š\n â”Š113â”Š113â”Š    async messages(chat, args, { injector }) {\n-â”Š114â”Š   â”Š      return injector.get(Chats).findMessagesByChat(chat.id);\n+â”Š   â”Š114â”Š      return injector.get(Chats).findMessagesByChat({\n+â”Š   â”Š115â”Š        chatId: chat.id,\n+â”Š   â”Š116â”Š        limit: args.limit,\n+â”Š   â”Š117â”Š        after: args.after,\n+â”Š   â”Š118â”Š      });\n â”Š115â”Š119â”Š    },\n â”Š116â”Š120â”Š\n â”Š117â”Š121â”Š    async lastMessage(chat, args, { injector }) {\n```\n\n[}]: #\n\nBecause the order of creation matters, messages are selected quite differently than before, we keep selecting all columns but records are ordered by the date of creation.\n\nThere's an interesting thing related to the cursor. If it's provided, we query for only those messages that happened before our cursor. This way we have a valid direction, fetching more messages means fetching older records.\n\nThe last message in the list becomes of course the `cursor`.\n\nIn order to calculate `hasMore` we need to apply the same conditions as above but with `LIMIT 1` and see if we get a result.\n\nSince the API part is done, let's take care of something much more complicated, which is always the UI...\n\nLet's plan it first. We know we want to fetch more messages while scrolling up. That means, Infinite Scroll with a corresponding request each time we hit the top. Because we implemented prefetching, we need to know what's the `limit`. React's Context might be helpful here. There was, of course, the change in GraphQL Schema we need to take care of too.\n\n### Apply schema changes\n\nSince we know what the plan is, let's start with schema changes. The `Chat.messages` is no longer a list, it's an object now.\n\n[{]: <helper> (diffStep \"15.6\" module=\"client\")\n\n#### [__Client__ Step 15.6: Apply MessagesResult type](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/5ef311ae9a89c85a58695bc0299ac510379c013a)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -27,7 +27,7 @@\n â”Š27â”Š27â”Š\n â”Š28â”Š28â”Š// eslint-disable-next-line\n â”Š29â”Š29â”Šconst getChatQuery = gql`\n-â”Š30â”Š  â”Š  query GetChat($chatId: ID!) {\n+â”Š  â”Š30â”Š  query GetChat($chatId: ID!, $limit: Int!, $after: Float) {\n â”Š31â”Š31â”Š    chat(chatId: $chatId) {\n â”Š32â”Š32â”Š      ...FullChat\n â”Š33â”Š33â”Š    }\n```\n\n##### Changed src&#x2F;graphql&#x2F;fragments&#x2F;fullChat.fragment.ts\n```diff\n@@ -1,14 +1,14 @@\n â”Š 1â”Š 1â”Šimport gql from 'graphql-tag';\n â”Š 2â”Š 2â”Šimport chat from './chat.fragment';\n-â”Š 3â”Š  â”Šimport message from './message.fragment';\n+â”Š  â”Š 3â”Šimport messagesResult from './messagesResult.fragment';\n â”Š 4â”Š 4â”Š\n â”Š 5â”Š 5â”Šexport default gql`\n â”Š 6â”Š 6â”Š  fragment FullChat on Chat {\n â”Š 7â”Š 7â”Š    ...Chat\n-â”Š 8â”Š  â”Š    messages {\n-â”Š 9â”Š  â”Š      ...Message\n+â”Š  â”Š 8â”Š    messages(limit: $limit, after: $after) @connection(key: \"messages\") {\n+â”Š  â”Š 9â”Š      ...MessagesResult\n â”Š10â”Š10â”Š    }\n â”Š11â”Š11â”Š  }\n â”Š12â”Š12â”Š  ${chat}\n-â”Š13â”Š  â”Š  ${message}\n+â”Š  â”Š13â”Š  ${messagesResult}\n â”Š14â”Š14â”Š`;\n```\n\n##### Added src&#x2F;graphql&#x2F;fragments&#x2F;messagesResult.fragment.ts\n```diff\n@@ -0,0 +1,13 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag';\n+â”Š  â”Š 2â”Šimport message from './message.fragment';\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šexport default gql`\n+â”Š  â”Š 5â”Š  fragment MessagesResult on MessagesResult {\n+â”Š  â”Š 6â”Š    cursor\n+â”Š  â”Š 7â”Š    hasMore\n+â”Š  â”Š 8â”Š    messages {\n+â”Š  â”Š 9â”Š      ...Message\n+â”Š  â”Š10â”Š    }\n+â”Š  â”Š11â”Š  }\n+â”Š  â”Š12â”Š  ${message}\n+â”Š  â”Š13â”Š`;\n```\n\n##### Changed src&#x2F;services&#x2F;cache.service.ts\n```diff\n@@ -61,9 +61,9 @@\n â”Š61â”Š61â”Š  if (fullChat === null || fullChat.messages === null) {\n â”Š62â”Š62â”Š    return;\n â”Š63â”Š63â”Š  }\n-â”Š64â”Š  â”Š  if (fullChat.messages.some((m: any) => m.id === message.id)) return;\n+â”Š  â”Š64â”Š  if (fullChat.messages.messages.some((m: any) => m.id === message.id)) return;\n â”Š65â”Š65â”Š\n-â”Š66â”Š  â”Š  fullChat.messages.push(message);\n+â”Š  â”Š66â”Š  fullChat.messages.messages.push(message);\n â”Š67â”Š67â”Š  fullChat.lastMessage = message;\n â”Š68â”Š68â”Š\n â”Š69â”Š69â”Š  client.writeFragment({\n```\n\n[}]: #\n\nNow we need reflect those changes in generated hooks by running:\n\n    yarn codegen\n\nOkay, let's move on!\n\n### Infinite Scrolling\n\nNow this Infinite Scroll thing. The core concept is to ask for more data, once a user's scrollbar hits the top edge of the screen.\n\n[{]: <helper> (diffStep \"15.2\" module=\"client\")\n\n#### [__Client__ Step 15.2: Basics for infinite scroll](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/824853fc0e0b3db7cfb829ec51f6038b732ef15d)\n\n##### Added src&#x2F;hooks&#x2F;use-infinite-scroll.ts\n```diff\n@@ -0,0 +1,32 @@\n+â”Š  â”Š 1â”Šimport { useEffect, useCallback, RefObject } from 'react';\n+â”Š  â”Š 2â”Š\n+â”Š  â”Š 3â”Šexport const useInfiniteScroll = ({\n+â”Š  â”Š 4â”Š  ref,\n+â”Š  â”Š 5â”Š  onLoadMore,\n+â”Š  â”Š 6â”Š}: {\n+â”Š  â”Š 7â”Š  onLoadMore: Function;\n+â”Š  â”Š 8â”Š  ref: RefObject<HTMLElement>;\n+â”Š  â”Š 9â”Š}) => {\n+â”Š  â”Š10â”Š  const handleScroll = useCallback(() => {\n+â”Š  â”Š11â”Š    if (ref.current!.scrollTop === 0) {\n+â”Š  â”Š12â”Š      // loads more if scrolled to top\n+â”Š  â”Š13â”Š      onLoadMore();\n+â”Š  â”Š14â”Š    }\n+â”Š  â”Š15â”Š  }, [ref, onLoadMore]);\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š  useEffect(() => {\n+â”Š  â”Š18â”Š    const elem = ref.current;\n+â”Š  â”Š19â”Š\n+â”Š  â”Š20â”Š    if (!elem) {\n+â”Š  â”Š21â”Š      return;\n+â”Š  â”Š22â”Š    }\n+â”Š  â”Š23â”Š\n+â”Š  â”Š24â”Š    elem.addEventListener('scroll', handleScroll);\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Š    return () => {\n+â”Š  â”Š27â”Š      elem!.removeEventListener('scroll', handleScroll);\n+â”Š  â”Š28â”Š    };\n+â”Š  â”Š29â”Š  }, [ref, handleScroll]);\n+â”Š  â”Š30â”Š};\n+â”Š  â”Š31â”Š\n+â”Š  â”Š32â”Šexport default useInfiniteScroll;\n```\n\n[}]: #\n\nOur `useInfiniteScroll` hook requires:\n\n- `ref` is a reference of a HTML element\n- `onLoadMore` calls the part component back and asks for data\n\nWe used `useEffect` to add and remove a scroll event listener. The function lives as long as `ref` and `onLoadMore` stay the same, that's because we simply make use of them in `handleScroll` function. The `handleScroll` function calls `onLoadMore` when a user scrolled to the top.\n\nIt all looks fine at first, but we still need to prevent calling back once fetching is in progress.\n\n[{]: <helper> (diffStep \"15.3\" module=\"client\")\n\n#### [__Client__ Step 15.3: Prevent calling back once fetching is in progress](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/c850dc5905aae90d8a385a04159c211fa4062ed3)\n\n##### Changed src&#x2F;hooks&#x2F;use-infinite-scroll.ts\n```diff\n@@ -1,4 +1,4 @@\n-â”Š1â”Š â”Šimport { useEffect, useCallback, RefObject } from 'react';\n+â”Š â”Š1â”Šimport { useState, useEffect, useCallback, RefObject } from 'react';\n â”Š2â”Š2â”Š\n â”Š3â”Š3â”Šexport const useInfiniteScroll = ({\n â”Š4â”Š4â”Š  ref,\n```\n```diff\n@@ -7,12 +7,13 @@\n â”Š 7â”Š 7â”Š  onLoadMore: Function;\n â”Š 8â”Š 8â”Š  ref: RefObject<HTMLElement>;\n â”Š 9â”Š 9â”Š}) => {\n+â”Š  â”Š10â”Š  const [isFetching, setIsFetching] = useState(false);\n â”Š10â”Š11â”Š  const handleScroll = useCallback(() => {\n-â”Š11â”Š  â”Š    if (ref.current!.scrollTop === 0) {\n-â”Š12â”Š  â”Š      // loads more if scrolled to top\n-â”Š13â”Š  â”Š      onLoadMore();\n+â”Š  â”Š12â”Š    if (ref.current!.scrollTop === 0 && isFetching === false) {\n+â”Š  â”Š13â”Š      // starts to fetch if scrolled to top and fetching is not in progress\n+â”Š  â”Š14â”Š      setIsFetching(true);\n â”Š14â”Š15â”Š    }\n-â”Š15â”Š  â”Š  }, [ref, onLoadMore]);\n+â”Š  â”Š16â”Š  }, [ref, isFetching]);\n â”Š16â”Š17â”Š\n â”Š17â”Š18â”Š  useEffect(() => {\n â”Š18â”Š19â”Š    const elem = ref.current;\n```\n```diff\n@@ -27,6 +28,13 @@\n â”Š27â”Š28â”Š      elem!.removeEventListener('scroll', handleScroll);\n â”Š28â”Š29â”Š    };\n â”Š29â”Š30â”Š  }, [ref, handleScroll]);\n+â”Š  â”Š31â”Š\n+â”Š  â”Š32â”Š  // loads more if fetching has started\n+â”Š  â”Š33â”Š  useEffect(() => {\n+â”Š  â”Š34â”Š    if (isFetching) {\n+â”Š  â”Š35â”Š      onLoadMore();\n+â”Š  â”Š36â”Š    }\n+â”Š  â”Š37â”Š  }, [isFetching, onLoadMore]);\n â”Š30â”Š38â”Š};\n â”Š31â”Š39â”Š\n â”Š32â”Š40â”Šexport default useInfiniteScroll;\n```\n\n[}]: #\n\nThat's why `isFetching` state is necessary but as you can tell, we don't set it to `false`.\n\n[{]: <helper> (diffStep \"15.4\" module=\"client\")\n\n#### [__Client__ Step 15.4: Allow to notify when finished](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/e3b7bbd9b5bb880d4e00e38aff39d20c025f636f)\n\n##### Changed src&#x2F;hooks&#x2F;use-infinite-scroll.ts\n```diff\n@@ -6,7 +6,7 @@\n â”Š 6â”Š 6â”Š}: {\n â”Š 7â”Š 7â”Š  onLoadMore: Function;\n â”Š 8â”Š 8â”Š  ref: RefObject<HTMLElement>;\n-â”Š 9â”Š  â”Š}) => {\n+â”Š  â”Š 9â”Š}): [boolean, () => void] => {\n â”Š10â”Š10â”Š  const [isFetching, setIsFetching] = useState(false);\n â”Š11â”Š11â”Š  const handleScroll = useCallback(() => {\n â”Š12â”Š12â”Š    if (ref.current!.scrollTop === 0 && isFetching === false) {\n```\n```diff\n@@ -35,6 +35,12 @@\n â”Š35â”Š35â”Š      onLoadMore();\n â”Š36â”Š36â”Š    }\n â”Š37â”Š37â”Š  }, [isFetching, onLoadMore]);\n+â”Š  â”Š38â”Š\n+â”Š  â”Š39â”Š  const stopFetching = useCallback(() => {\n+â”Š  â”Š40â”Š    setIsFetching(false);\n+â”Š  â”Š41â”Š  }, []);\n+â”Š  â”Š42â”Š\n+â”Š  â”Š43â”Š  return [isFetching, stopFetching];\n â”Š38â”Š44â”Š};\n â”Š39â”Š45â”Š\n â”Š40â”Š46â”Šexport default useInfiniteScroll;\n```\n\n[}]: #\n\nWe want the consumer of the hook to tell it when fetching is finished, that's why we expose the state with `stopFetching` function.\n\nThe next issue that appears right away is related to the case when there's no more data to fetch.\n\n[{]: <helper> (diffStep \"15.5\" module=\"client\")\n\n#### [__Client__ Step 15.5: Fetch only if there is more data](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/5a848de830a19b81d0c988262840659e1aa33aec)\n\n##### Changed src&#x2F;hooks&#x2F;use-infinite-scroll.ts\n```diff\n@@ -2,18 +2,20 @@\n â”Š 2â”Š 2â”Š\n â”Š 3â”Š 3â”Šexport const useInfiniteScroll = ({\n â”Š 4â”Š 4â”Š  ref,\n+â”Š  â”Š 5â”Š  hasMore,\n â”Š 5â”Š 6â”Š  onLoadMore,\n â”Š 6â”Š 7â”Š}: {\n â”Š 7â”Š 8â”Š  onLoadMore: Function;\n+â”Š  â”Š 9â”Š  hasMore: boolean;\n â”Š 8â”Š10â”Š  ref: RefObject<HTMLElement>;\n â”Š 9â”Š11â”Š}): [boolean, () => void] => {\n â”Š10â”Š12â”Š  const [isFetching, setIsFetching] = useState(false);\n â”Š11â”Š13â”Š  const handleScroll = useCallback(() => {\n-â”Š12â”Š  â”Š    if (ref.current!.scrollTop === 0 && isFetching === false) {\n-â”Š13â”Š  â”Š      // starts to fetch if scrolled to top and fetching is not in progress\n+â”Š  â”Š14â”Š    if (ref.current!.scrollTop === 0 && isFetching === false && hasMore) {\n+â”Š  â”Š15â”Š      // starts to fetch if scrolled to top, fetching is not in progress and has more data\n â”Š14â”Š16â”Š      setIsFetching(true);\n â”Š15â”Š17â”Š    }\n-â”Š16â”Š  â”Š  }, [ref, isFetching]);\n+â”Š  â”Š18â”Š  }, [ref, isFetching, hasMore]);\n â”Š17â”Š19â”Š\n â”Š18â”Š20â”Š  useEffect(() => {\n â”Š19â”Š21â”Š    const elem = ref.current;\n```\n\n[}]: #\n\nPfff... The hook part is done!\n\n### Pagination\n\nPagination is partially implemented thanks to Infinite Scrolling but the thing we need to still apply is React's context. It will be a central place of storing `limit` and `after` values, so they could be shared across multiple components and not passed directly from one to another.\n\n[{]: <helper> (diffStep \"15.7\" module=\"client\")\n\n#### [__Client__ Step 15.7: Implement pagination with context and hooks](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/54c7abe97837b57c58af8d7075b39abe4ae778c1)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -1,6 +1,6 @@\n â”Š1â”Š1â”Šimport gql from 'graphql-tag';\n â”Š2â”Š2â”Šimport React from 'react';\n-â”Š3â”Š â”Šimport { useCallback } from 'react';\n+â”Š â”Š3â”Šimport { useCallback, useState, useContext, useEffect } from 'react';\n â”Š4â”Š4â”Šimport { Redirect } from 'react-router-dom';\n â”Š5â”Š5â”Šimport { useApolloClient } from '@apollo/react-hooks';\n â”Š6â”Š6â”Šimport styled from 'styled-components';\n```\n```diff\n@@ -45,6 +45,48 @@\n â”Š45â”Š45â”Š  ${fragments.message}\n â”Š46â”Š46â”Š`;\n â”Š47â”Š47â”Š\n+â”Š  â”Š48â”Šconst PaginationContext = React.createContext({\n+â”Š  â”Š49â”Š  after: 0,\n+â”Š  â”Š50â”Š  limit: 20,\n+â”Š  â”Š51â”Š  /**\n+â”Š  â”Š52â”Š   * Sets new cursor\n+â”Š  â”Š53â”Š   */\n+â”Š  â”Š54â”Š  setAfter: (after: number) => {},\n+â”Š  â”Š55â”Š  /**\n+â”Š  â”Š56â”Š   * Resets `after` value to its inital state (null) so\n+â”Š  â”Š57â”Š   */\n+â”Š  â”Š58â”Š  reset: () => {},\n+â”Š  â”Š59â”Š});\n+â”Š  â”Š60â”Š\n+â”Š  â”Š61â”Šconst usePagination = () => {\n+â”Š  â”Š62â”Š  const pagination = useContext(PaginationContext);\n+â”Š  â”Š63â”Š\n+â”Š  â”Š64â”Š  // Resets the pagination every time a component did unmount\n+â”Š  â”Š65â”Š  useEffect(() => {\n+â”Š  â”Š66â”Š    return () => {\n+â”Š  â”Š67â”Š      pagination.reset();\n+â”Š  â”Š68â”Š    };\n+â”Š  â”Š69â”Š  }, [pagination]);\n+â”Š  â”Š70â”Š\n+â”Š  â”Š71â”Š  return pagination;\n+â”Š  â”Š72â”Š};\n+â”Š  â”Š73â”Š\n+â”Š  â”Š74â”Šexport const ChatPaginationProvider = ({ children }: { children: any }) => {\n+â”Š  â”Š75â”Š  const [after, setAfter] = useState<number | null>(null);\n+â”Š  â”Š76â”Š\n+â”Š  â”Š77â”Š  return (\n+â”Š  â”Š78â”Š    <PaginationContext.Provider\n+â”Š  â”Š79â”Š      value={{\n+â”Š  â”Š80â”Š        limit: 20,\n+â”Š  â”Š81â”Š        after: after!,\n+â”Š  â”Š82â”Š        setAfter,\n+â”Š  â”Š83â”Š        reset: () => setAfter(null),\n+â”Š  â”Š84â”Š      }}>\n+â”Š  â”Š85â”Š      {children}\n+â”Š  â”Š86â”Š    </PaginationContext.Provider>\n+â”Š  â”Š87â”Š  );\n+â”Š  â”Š88â”Š};\n+â”Š  â”Š89â”Š\n â”Š48â”Š90â”Šexport const useGetChatPrefetch = () => {\n â”Š49â”Š91â”Š  const client = useApolloClient();\n```\n\n[}]: #\n\nWe implemented three things:\n\n- `PaginationContext` is simple, it stores the values but also allows to set a new one for `after` or even bring it all back to the initial state.\n- `usePagination` hook is there so components could use `PaginationContext` and to make sure we reset it when component unmounts.\n- `ChatPaginationProvider` provides the logic and core functionality\n\nSince the pagination is almost ready, let's make use of it in `useGetChatPrefetch` hook and `ChatRoomScreen` component.\n\n[{]: <helper> (diffStep \"15.8\" module=\"client\")\n\n#### [__Client__ Step 15.8: Use pagination limit and after props](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/4ad1ef7281217bc4a877bbe804b272d2a3a55079)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -89,12 +89,15 @@\n â”Š 89â”Š 89â”Š\n â”Š 90â”Š 90â”Šexport const useGetChatPrefetch = () => {\n â”Š 91â”Š 91â”Š  const client = useApolloClient();\n+â”Š   â”Š 92â”Š  const { limit, after } = usePagination();\n â”Š 92â”Š 93â”Š\n â”Š 93â”Š 94â”Š  return (chatId: string) => {\n â”Š 94â”Š 95â”Š    client.query<GetChatQuery, GetChatQueryVariables>({\n â”Š 95â”Š 96â”Š      query: GetChatDocument,\n â”Š 96â”Š 97â”Š      variables: {\n â”Š 97â”Š 98â”Š        chatId,\n+â”Š   â”Š 99â”Š        after,\n+â”Š   â”Š100â”Š        limit,\n â”Š 98â”Š101â”Š      },\n â”Š 99â”Š102â”Š    });\n â”Š100â”Š103â”Š  };\n```\n```diff\n@@ -109,8 +112,9 @@\n â”Š109â”Š112â”Š  history,\n â”Š110â”Š113â”Š  chatId,\n â”Š111â”Š114â”Š}) => {\n+â”Š   â”Š115â”Š  const { after, limit } = usePagination();\n â”Š112â”Š116â”Š  const { data, loading } = useGetChatQuery({\n-â”Š113â”Š   â”Š    variables: { chatId },\n+â”Š   â”Š117â”Š    variables: { chatId, after, limit },\n â”Š114â”Š118â”Š  });\n â”Š115â”Š119â”Š\n â”Š116â”Š120â”Šconst [addMessage] = useAddMessageMutation();\n```\n\n[}]: #\n\nThis won't work yet because there's nothing that creates the context.\n\n[{]: <helper> (diffStep \"15.9\" module=\"client\")\n\n#### [__Client__ Step 15.9: Use ChatPaginationProvider](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/45dd10e9aa39f48024e754dda1dd383632622804)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -108,10 +108,7 @@\n â”Š108â”Š108â”Š  history: History;\n â”Š109â”Š109â”Š}\n â”Š110â”Š110â”Š\n-â”Š111â”Š   â”Šconst ChatRoomScreen: React.FC<ChatRoomScreenParams> = ({\n-â”Š112â”Š   â”Š  history,\n-â”Š113â”Š   â”Š  chatId,\n-â”Š114â”Š   â”Š}) => {\n+â”Š   â”Š111â”Šconst ChatRoom: React.FC<ChatRoomScreenParams> = ({ history, chatId }) => {\n â”Š115â”Š112â”Š  const { after, limit } = usePagination();\n â”Š116â”Š113â”Š  const { data, loading } = useGetChatQuery({\n â”Š117â”Š114â”Š    variables: { chatId, after, limit },\n```\n```diff\n@@ -176,4 +173,15 @@\n â”Š176â”Š173â”Š  );\n â”Š177â”Š174â”Š};\n â”Š178â”Š175â”Š\n+â”Š   â”Š176â”Šconst ChatRoomScreen: React.FC<ChatRoomScreenParams> = ({\n+â”Š   â”Š177â”Š  history,\n+â”Š   â”Š178â”Š  chatId,\n+â”Š   â”Š179â”Š}) => {\n+â”Š   â”Š180â”Š  return (\n+â”Š   â”Š181â”Š    <ChatPaginationProvider>\n+â”Š   â”Š182â”Š      <ChatRoom history={history} chatId={chatId} />\n+â”Š   â”Š183â”Š    </ChatPaginationProvider>\n+â”Š   â”Š184â”Š  );\n+â”Š   â”Š185â”Š};\n+â”Š   â”Š186â”Š\n â”Š179â”Š187â”Šexport default ChatRoomScreen;\n```\n\n[}]: #\n\nWe had to split the `ChatRoomScreen` into two pieces. One that includes `ChatPaginationProvider` and produces `chatId` and the other that keeps pretty much everything else. This way the tree of child components, starting from `ChatRoom` share the same context.\n\n### Fetching more messages\n\nEverything is set up, we can now move on and consume the `useInfiniteScroll` in the `MessagesList` component.\n\n[{]: <helper> (diffStep \"15.10\" module=\"client\")\n\n#### [__Client__ Step 15.10: Make use of infinite scroll in MessagesList component](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/8bb0caffd9bc07fc4643c15045cd2b6078e45ca9)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;MessagesList.tsx\n```diff\n@@ -3,14 +3,27 @@\n â”Š 3â”Š 3â”Šimport { useEffect, useRef } from 'react';\n â”Š 4â”Š 4â”Šimport ReactDOM from 'react-dom';\n â”Š 5â”Š 5â”Šimport styled, { css } from 'styled-components';\n+â”Š  â”Š 6â”Šimport { useInfiniteScroll } from '../../hooks/use-infinite-scroll';\n â”Š 6â”Š 7â”Š\n â”Š 7â”Š 8â”Šconst Container = styled.div`\n+â”Š  â”Š 9â”Š  position: relative;\n â”Š 8â”Š10â”Š  display: block;\n â”Š 9â”Š11â”Š  flex: 2;\n â”Š10â”Š12â”Š  overflow-y: overlay;\n â”Š11â”Š13â”Š  padding: 0 15px;\n â”Š12â”Š14â”Š`;\n â”Š13â”Š15â”Š\n+â”Š  â”Š16â”Šconst LoadingMore = styled.div`\n+â”Š  â”Š17â”Š  height: 30px;\n+â”Š  â”Š18â”Š  line-height: 30px;\n+â”Š  â”Š19â”Š  position: absolute;\n+â”Š  â”Š20â”Š  top: 0;\n+â”Š  â”Š21â”Š  right: 0;\n+â”Š  â”Š22â”Š  bottom: 0;\n+â”Š  â”Š23â”Š  left: 0;\n+â”Š  â”Š24â”Š  text-align: center;\n+â”Š  â”Š25â”Š`;\n+â”Š  â”Š26â”Š\n â”Š14â”Š27â”Štype StyledProp = {\n â”Š15â”Š28â”Š  isMine: any;\n â”Š16â”Š29â”Š};\n```\n```diff\n@@ -89,19 +102,36 @@\n â”Š 89â”Š102â”Š}\n â”Š 90â”Š103â”Šinterface MessagesListProps {\n â”Š 91â”Š104â”Š  messages: Array<Message>;\n+â”Š   â”Š105â”Š  loadMore: Function;\n+â”Š   â”Š106â”Š  hasMore: boolean;\n â”Š 92â”Š107â”Š}\n â”Š 93â”Š108â”Š\n-â”Š 94â”Š   â”Šconst MessagesList: React.FC<MessagesListProps> = ({ messages }) => {\n-â”Š 95â”Š   â”Š  const selfRef = useRef(null);\n+â”Š   â”Š109â”Šconst MessagesList: React.FC<MessagesListProps> = ({\n+â”Š   â”Š110â”Š  messages,\n+â”Š   â”Š111â”Š  loadMore,\n+â”Š   â”Š112â”Š  hasMore,\n+â”Š   â”Š113â”Š}) => {\n+â”Š   â”Š114â”Š  const selfRef = useRef<HTMLDivElement>(null);\n+â”Š   â”Š115â”Š  const [fetching, stopFetching] = useInfiniteScroll({\n+â”Š   â”Š116â”Š    onLoadMore: loadMore,\n+â”Š   â”Š117â”Š    hasMore,\n+â”Š   â”Š118â”Š    ref: selfRef!,\n+â”Š   â”Š119â”Š  });\n â”Š 96â”Š120â”Š\n â”Š 97â”Š121â”Š  useEffect(() => {\n â”Š 98â”Š122â”Š    if (!selfRef.current) return;\n+â”Š   â”Š123â”Š\n+â”Š   â”Š124â”Š    if (fetching) {\n+â”Š   â”Š125â”Š      stopFetching();\n+â”Š   â”Š126â”Š    }\n+â”Š   â”Š127â”Š\n â”Š 99â”Š128â”Š    const selfDOMNode = ReactDOM.findDOMNode(selfRef.current) as HTMLElement;\n â”Š100â”Š129â”Š    selfDOMNode.scrollTop = Number.MAX_SAFE_INTEGER;\n-â”Š101â”Š   â”Š  }, [messages.length]);\n+â”Š   â”Š130â”Š  }, [messages.length, selfRef, fetching, stopFetching]);\n â”Š102â”Š131â”Š\n â”Š103â”Š132â”Š  return (\n â”Š104â”Š133â”Š    <Container ref={selfRef}>\n+â”Š   â”Š134â”Š      {fetching && <LoadingMore>{'Loading more messages...'}</LoadingMore>}\n â”Š105â”Š135â”Š      {messages.map((message: any) => (\n â”Š106â”Š136â”Š        <MessageItem\n â”Š107â”Š137â”Š          data-testid=\"message-item\"\n```\n\n[}]: #\n\nWe added the `LoadingMore` component with *Loading more messages...* text in it that pops out when fetching is in progress.\nBecause the `MessagesList` is not responsible of quering data we don't know exactly when it's completed but we can assume, it happens once the length of `messages` changes.\nWe also pass `onLoadMore` and `hasMore` props to the parent component and the `useInfiniteScroll` uses `MessagesList` as the element we're going to scroll in.\n\nThere's also one more thing that could be turned into a hook, it's the logic responsible for scrolling to bottom of the page, every time `messages` changes.\n\n[{]: <helper> (diffStep \"15.11\" module=\"client\")\n\n#### [__Client__ Step 15.11: Implement a hook responsible for scrolling](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/ce62102a6cf4e420fc3cb93cd625a1fdf6ab0ffa)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;MessagesList.tsx\n```diff\n@@ -1,9 +1,9 @@\n â”Š1â”Š1â”Šimport moment from 'moment';\n â”Š2â”Š2â”Šimport React from 'react';\n â”Š3â”Š3â”Šimport { useEffect, useRef } from 'react';\n-â”Š4â”Š â”Šimport ReactDOM from 'react-dom';\n â”Š5â”Š4â”Šimport styled, { css } from 'styled-components';\n â”Š6â”Š5â”Šimport { useInfiniteScroll } from '../../hooks/use-infinite-scroll';\n+â”Š â”Š6â”Šimport { useAdjustedScroll } from '../../hooks/use-adjusted-scroll';\n â”Š7â”Š7â”Š\n â”Š8â”Š8â”Šconst Container = styled.div`\n â”Š9â”Š9â”Š  position: relative;\n```\n```diff\n@@ -117,17 +117,19 @@\n â”Š117â”Š117â”Š    hasMore,\n â”Š118â”Š118â”Š    ref: selfRef!,\n â”Š119â”Š119â”Š  });\n+â”Š   â”Š120â”Š  const adjustScroll = useAdjustedScroll(selfRef);\n â”Š120â”Š121â”Š\n â”Š121â”Š122â”Š  useEffect(() => {\n â”Š122â”Š123â”Š    if (!selfRef.current) return;\n â”Š123â”Š124â”Š\n â”Š124â”Š125â”Š    if (fetching) {\n â”Š125â”Š126â”Š      stopFetching();\n+â”Š   â”Š127â”Š      adjustScroll();\n+â”Š   â”Š128â”Š    } else {\n+â”Š   â”Š129â”Š      // scroll to the most recent message\n+â”Š   â”Š130â”Š      adjustScroll(true);\n â”Š126â”Š131â”Š    }\n-â”Š127â”Š   â”Š\n-â”Š128â”Š   â”Š    const selfDOMNode = ReactDOM.findDOMNode(selfRef.current) as HTMLElement;\n-â”Š129â”Š   â”Š    selfDOMNode.scrollTop = Number.MAX_SAFE_INTEGER;\n-â”Š130â”Š   â”Š  }, [messages.length, selfRef, fetching, stopFetching]);\n+â”Š   â”Š132â”Š  }, [messages.length, selfRef, fetching, stopFetching, adjustScroll]);\n â”Š131â”Š133â”Š\n â”Š132â”Š134â”Š  return (\n â”Š133â”Š135â”Š    <Container ref={selfRef}>\n```\n\n##### Added src&#x2F;hooks&#x2F;use-adjusted-scroll.ts\n```diff\n@@ -0,0 +1,35 @@\n+â”Š  â”Š 1â”Šimport { useState, useCallback, RefObject } from 'react';\n+â”Š  â”Š 2â”Šimport * as ReactDOM from 'react-dom';\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šexport const useAdjustedScroll = (ref: RefObject<HTMLElement>) => {\n+â”Š  â”Š 5â”Š  const [previousScroll, setPreviousScroll] = useState<{\n+â”Š  â”Š 6â”Š    top: number;\n+â”Š  â”Š 7â”Š    height: number;\n+â”Š  â”Š 8â”Š  }>();\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Š  /**\n+â”Š  â”Š11â”Š   * Scrolls to the previous position or completely to bottom (on demand)\n+â”Š  â”Š12â”Š   */\n+â”Š  â”Š13â”Š  const adjust = useCallback(\n+â”Š  â”Š14â”Š    (scrollToBottom?: boolean) => {\n+â”Š  â”Š15â”Š      if (!ref.current) return;\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š      const node = ReactDOM.findDOMNode(ref.current) as HTMLElement;\n+â”Š  â”Š18â”Š      const height =\n+â”Š  â”Š19â”Š        !scrollToBottom && previousScroll\n+â”Š  â”Š20â”Š          ? previousScroll.height\n+â”Š  â”Š21â”Š          : node.clientHeight;\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Š      node.scrollTop = node.scrollHeight - height;\n+â”Š  â”Š24â”Š\n+â”Š  â”Š25â”Š      // saves current scroll details\n+â”Š  â”Š26â”Š      setPreviousScroll({\n+â”Š  â”Š27â”Š        top: node.scrollTop,\n+â”Š  â”Š28â”Š        height: node.scrollHeight,\n+â”Š  â”Š29â”Š      });\n+â”Š  â”Š30â”Š    },\n+â”Š  â”Š31â”Š    [ref, previousScroll]\n+â”Š  â”Š32â”Š  );\n+â”Š  â”Š33â”Š\n+â”Š  â”Š34â”Š  return adjust;\n+â”Š  â”Š35â”Š};\n```\n\n[}]: #\n\nWe also added some extra functionality there. Because we don't want to scroll to bottom when a new message is added, the function returned by `useAdjustedScroll` accepts now an argument.\n\nWe did the `MessagesList`, now let's move onto real data and the `ChatRoom` component.\n\n[{]: <helper> (diffStep \"15.12\" module=\"client\")\n\n#### [__Client__ Step 15.12: Implement pagination in ChatRoom component](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/023ec267f568c01cd5a2255c0fc0ee4d8046d927)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -109,7 +109,7 @@\n â”Š109â”Š109â”Š}\n â”Š110â”Š110â”Š\n â”Š111â”Š111â”Šconst ChatRoom: React.FC<ChatRoomScreenParams> = ({ history, chatId }) => {\n-â”Š112â”Š   â”Š  const { after, limit } = usePagination();\n+â”Š   â”Š112â”Š  const { after, limit, setAfter } = usePagination();\n â”Š113â”Š113â”Š  const { data, loading } = useGetChatQuery({\n â”Š114â”Š114â”Š    variables: { chatId, after, limit },\n â”Š115â”Š115â”Š  });\n```\n```diff\n@@ -150,6 +150,14 @@\n â”Š150â”Š150â”Š    [data, chatId, addMessage]\n â”Š151â”Š151â”Š  );\n â”Š152â”Š152â”Š\n+â”Š   â”Š153â”Š  useEffect(() => {\n+â”Š   â”Š154â”Š    if (!after) {\n+â”Š   â”Š155â”Š      return;\n+â”Š   â”Š156â”Š    }\n+â”Š   â”Š157â”Š\n+â”Š   â”Š158â”Š    // every time after changes its value, fetch more messages\n+â”Š   â”Š159â”Š  }, [after]);\n+â”Š   â”Š160â”Š\n â”Š153â”Š161â”Š  if (data === undefined) {\n â”Š154â”Š162â”Š    return null;\n â”Š155â”Š163â”Š  }\n```\n```diff\n@@ -167,7 +175,13 @@\n â”Š167â”Š175â”Š  return (\n â”Š168â”Š176â”Š    <Container>\n â”Š169â”Š177â”Š      <ChatNavbar chat={chat} history={history} />\n-â”Š170â”Š   â”Š      {chat.messages && <MessagesList messages={chat.messages} />}\n+â”Š   â”Š178â”Š      {chat.messages && (\n+â”Š   â”Š179â”Š        <MessagesList\n+â”Š   â”Š180â”Š          messages={chat.messages.messages}\n+â”Š   â”Š181â”Š          hasMore={chat.messages.hasMore}\n+â”Š   â”Š182â”Š          loadMore={() => setAfter(chat.messages.cursor!)}\n+â”Š   â”Š183â”Š        />\n+â”Š   â”Š184â”Š      )}\n â”Š171â”Š185â”Š      <MessageInput onSendMessage={onSendMessage} />\n â”Š172â”Š186â”Š    </Container>\n â”Š173â”Š187â”Š  );\n```\n\n[}]: #\n\nAs you see above, every time the `MessagesList` asks for more messages, the `after` changes its value to `chat.messages.cursor` which means that's a new \"end\" of the list and we need to fill it up.\n\nRight now we just have a logic and a place to do it but we still need to make a GraphQL call.\n\nFortunately, Apollo lets you do pagination with a method called `fetchMore`. You need to specify what query and variables to use for the update, and how to merge the new query result with the existing data on the client. How exactly you do that will determine what kind of pagination you are implementing, in our case it's cursor-based.\n\nBut there's a catch!\n\nIt's related to how Apollo stores query results in cache. When we update the variables, in our case it's the `after` that changes quite a lot, a new record is created that is totally unrelated to the original query. That's because Apollo uses a combination of variables and query string to produce a key.\n\nAn example:\n\n\n```graphql\n{\n  query getUser($id: ID!) {\n    user(id: $id) {\n      name\n    }\n  }\n}\n```\n\nThe result of `getUser` query will be saved under `user({\"id\":2})` key.\n\nThis is a huge problem, it breaks imperative store updates but that's why `@connection` directive exists. It directs Apollo to use a stable store key for paginated queries, so every `useQuery()` or `fetchMore()` is being placed in the same space.\n\nWith all that knowledge, let's implement the last puzzle piece!\n\n[{]: <helper> (diffStep \"15.13\" module=\"client\")\n\n#### [__Client__ Step 15.13: Use fetchMore to load more messages](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/9964a2857263598e2520a9f96394244686ee2383)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -110,7 +110,7 @@\n â”Š110â”Š110â”Š\n â”Š111â”Š111â”Šconst ChatRoom: React.FC<ChatRoomScreenParams> = ({ history, chatId }) => {\n â”Š112â”Š112â”Š  const { after, limit, setAfter } = usePagination();\n-â”Š113â”Š   â”Š  const { data, loading } = useGetChatQuery({\n+â”Š   â”Š113â”Š  const { data, loading, fetchMore } = useGetChatQuery({\n â”Š114â”Š114â”Š    variables: { chatId, after, limit },\n â”Š115â”Š115â”Š  });\n â”Š116â”Š116â”Š\n```\n```diff\n@@ -156,7 +156,30 @@\n â”Š156â”Š156â”Š    }\n â”Š157â”Š157â”Š\n â”Š158â”Š158â”Š    // every time after changes its value, fetch more messages\n-â”Š159â”Š   â”Š  }, [after]);\n+â”Š   â”Š159â”Š    fetchMore({\n+â”Š   â”Š160â”Š      variables: {\n+â”Š   â”Š161â”Š        after,\n+â”Š   â”Š162â”Š        limit,\n+â”Š   â”Š163â”Š      },\n+â”Š   â”Š164â”Š      updateQuery(prev, { fetchMoreResult }) {\n+â”Š   â”Š165â”Š        const messages = [\n+â”Š   â”Š166â”Š          ...fetchMoreResult!.chat!.messages.messages,\n+â”Š   â”Š167â”Š          ...prev.chat!.messages.messages,\n+â”Š   â”Š168â”Š        ];\n+â”Š   â”Š169â”Š\n+â”Š   â”Š170â”Š        return {\n+â”Š   â”Š171â”Š          ...prev,\n+â”Š   â”Š172â”Š          chat: {\n+â”Š   â”Š173â”Š            ...prev.chat!,\n+â”Š   â”Š174â”Š            messages: {\n+â”Š   â”Š175â”Š              ...fetchMoreResult!.chat!.messages,\n+â”Š   â”Š176â”Š              messages,\n+â”Š   â”Š177â”Š            },\n+â”Š   â”Š178â”Š          },\n+â”Š   â”Š179â”Š        };\n+â”Š   â”Š180â”Š      },\n+â”Š   â”Š181â”Š    });\n+â”Š   â”Š182â”Š  }, [after, limit, fetchMore]);\n â”Š160â”Š183â”Š\n â”Š161â”Š184â”Š  if (data === undefined) {\n â”Š162â”Š185â”Š    return null;\n```\n\n[}]: #\n\nAs you see, we mutate the store as usual and we put fetched messages before the existing ones. Remember, it's from older to newer.\n\n### Looking at the bundle size\n\nWe can't of course forget about one of the most important aspects of optimization, the size of the application. As bundle size increases, both the parsing time and the time of the request takes longer.\n\nHow can we check what libraries and source files are shipped within the produced bundle?\n\nThere are many tools that analyze it for us but we're going to use only one of them, just for educational purpose.\n\n      $ yarn add -D source-map-explorer\n\nWe're going to add the `size` npm script in which we point the `source-map-explorer` to transpiled js files.\n\n[{]: <helper> (diffStep \"15.14\" module=\"client\")\n\n#### [__Client__ Step 15.14: Explore bundle size](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/70a9ecc8c7b408aedf5ea755cdc8037444d2f9cc)\n\n##### Changed package.json\n```diff\n@@ -50,7 +50,8 @@\n â”Š50â”Š50â”Š    \"test\": \"TZ=\\\"Asia/Jerusalem\\\" react-scripts test\",\n â”Š51â”Š51â”Š    \"eject\": \"react-scripts eject\",\n â”Š52â”Š52â”Š    \"codegen\": \"gql-gen\",\n-â”Š53â”Š  â”Š    \"format\": \"prettier \\\"**/*.{ts,tsx,css,graphql}\\\" --write\"\n+â”Š  â”Š53â”Š    \"format\": \"prettier \\\"**/*.{ts,tsx,css,graphql}\\\" --write\",\n+â”Š  â”Š54â”Š    \"size\": \"source-map-explorer 'build/static/js/*.js'\"\n â”Š54â”Š55â”Š  },\n â”Š55â”Š56â”Š  \"eslintConfig\": {\n â”Š56â”Š57â”Š    \"extends\": \"react-app\"\n```\n```diff\n@@ -70,6 +71,7 @@\n â”Š70â”Š71â”Š  \"devDependencies\": {\n â”Š71â”Š72â”Š    \"@testing-library/jest-dom\": \"4.0.0\",\n â”Š72â”Š73â”Š    \"@testing-library/react\": \"9.1.0\",\n-â”Š73â”Š  â”Š    \"jest-fetch-mock\": \"2.1.2\"\n+â”Š  â”Š74â”Š    \"jest-fetch-mock\": \"2.1.2\",\n+â”Š  â”Š75â”Š    \"source-map-explorer\": \"2.0.1\"\n â”Š74â”Š76â”Š  }\n â”Š75â”Š77â”Š}ðŸš«â†µ\n```\n\n[}]: #\n\nLet's see it in action, run:\n\n    $ yarn build && yarn size\n\nThat's what you should see:\n\n![Source Map Explorer](../../../assets/step17/img-10.png \"Source Map Explorer\")\n\nIt's interactive so you can dive deeper and deeper into those blocks but in general it shows what libraries and files are included in the produced output with their size(not minified and not gzipped).\n\n![Source Map Explorer](../../../assets/step17/img-11.png \"Source Map Explorer with moment highlighted\")\n\nFor example, we see that `moment` takes almost _53.49KB_ which is enourmous. In fact we only use its `format` method. The reason is that the library is not well tree-shakable. There are plugins for webpack (or any other build tool) that helps with it but we're going to use an alternative instead. We're going to replace it with `date-fns`.\n\n[{]: <helper> (diffStep \"15.15\" module=\"client\")\n\n#### [__Client__ Step 15.15: Replace moment with date-fns](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/e93841016bab94b75a645b273f1b7228a3ed0b50)\n\n##### Changed package.json\n```diff\n@@ -30,9 +30,9 @@\n â”Š30â”Š30â”Š    \"graphql\": \"14.4.2\",\n â”Š31â”Š31â”Š    \"apollo-link-ws\": \"1.0.18\",\n â”Š32â”Š32â”Š    \"apollo-utilities\": \"1.3.2\",\n+â”Š  â”Š33â”Š    \"date-fns\": \"1.30.1\",\n â”Š33â”Š34â”Š    \"graphql-tag\": \"2.10.1\",\n â”Š34â”Š35â”Š    \"history\": \"4.9.0\",\n-â”Š35â”Š  â”Š    \"moment\": \"2.24.0\",\n â”Š36â”Š36â”Š    \"prettier\": \"1.18.2\",\n â”Š37â”Š37â”Š    \"react\": \"16.9.0\",\n â”Š38â”Š38â”Š    \"react-dom\": \"16.9.0\",\n```\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;MessagesList.tsx\n```diff\n@@ -1,4 +1,4 @@\n-â”Š1â”Š â”Šimport moment from 'moment';\n+â”Š â”Š1â”Šimport format from 'date-fns/format';\n â”Š2â”Š2â”Šimport React from 'react';\n â”Š3â”Š3â”Šimport { useEffect, useRef } from 'react';\n â”Š4â”Š4â”Šimport styled, { css } from 'styled-components';\n```\n```diff\n@@ -141,7 +141,7 @@\n â”Š141â”Š141â”Š          key={message.id}>\n â”Š142â”Š142â”Š          <Contents data-testid=\"message-content\">{message.content}</Contents>\n â”Š143â”Š143â”Š          <Timestamp data-testid=\"message-date\">\n-â”Š144â”Š   â”Š            {moment(message.createdAt).format('HH:mm')}\n+â”Š   â”Š144â”Š            {format(message.createdAt, 'HH:mm')}\n â”Š145â”Š145â”Š          </Timestamp>\n â”Š146â”Š146â”Š        </MessageItem>\n â”Š147â”Š147â”Š      ))}\n```\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -1,5 +1,5 @@\n â”Š1â”Š1â”Šimport React from 'react';\n-â”Š2â”Š â”Šimport moment from 'moment';\n+â”Š â”Š2â”Šimport format from 'date-fns/format';\n â”Š3â”Š3â”Šimport { List, ListItem } from '@material-ui/core';\n â”Š4â”Š4â”Šimport styled from 'styled-components';\n â”Š5â”Š5â”Šimport { useCallback } from 'react';\n```\n```diff\n@@ -104,7 +104,7 @@\n â”Š104â”Š104â”Š                    {chat.lastMessage.content}\n â”Š105â”Š105â”Š                  </MessageContent>\n â”Š106â”Š106â”Š                  <MessageDate data-testid=\"date\">\n-â”Š107â”Š   â”Š                    {moment(chat.lastMessage.createdAt).format('HH:mm')}\n+â”Š   â”Š107â”Š                    {format(chat.lastMessage.createdAt, 'HH:mm')}\n â”Š108â”Š108â”Š                  </MessageDate>\n â”Š109â”Š109â”Š                </React.Fragment>\n â”Š110â”Š110â”Š              )}\n```\n\n[}]: #\n\nNow when you run:\n\n    $ yarn build && yarn size\n\nYou should see the following results.\n\n![Source Map Explorer](../../../assets/step17/img-12.png \"Source Map Explorer with date-fns\")\n\nThe bundle size is a bit smaller and `date-fns` takes only _8.93KB_ which in comparison to _53.49KB_ is a significant change!\n\n## Load testing\n\nLoad testing, in short, is about finding the limit of an application and figure out how to push it even more. We simulate a stressful behavior and apply that to the server until it crashes. Weâ€™re trying to answer the question of how the api deals with a pressure.\n\nWhen to do load testing?\nI would say at least before and after major changes, when pre-launching and just from time to time to prevent regressions.\n\nBefore doing load testing, we need to prepare a bit first. Right now we use `ts-node` to run the server but it would be faster to run it directly using `node`, just to avoid on-the-fly transpilation of TypeScript files.\n\nIn order to do it, we need to define the `outDir` in `tsconfig.json` and add a build step.\n\n[{]: <helper> (diffStep \"14.12\" module=\"server\")\n\n#### [__Server__ Step 14.12: Produce transpiled code](https://github.com/Urigo/WhatsApp-Clone-Server/commit/5708d5846800446d4d9dd14a643d815da92da624)\n\n##### Changed .circleci&#x2F;config.yml\n```diff\n@@ -18,6 +18,9 @@\n â”Š18â”Š18â”Š      - run:\n â”Š19â”Š19â”Š          name: Install Dependencies\n â”Š20â”Š20â”Š          command: yarn\n+â”Š  â”Š21â”Š      - run:\n+â”Š  â”Š22â”Š          name: Build\n+â”Š  â”Š23â”Š          command: yarn build\n â”Š21â”Š24â”Š      - run:\n â”Š22â”Š25â”Š          name: Test\n â”Š23â”Š26â”Š          command: yarn test\n```\n\n##### Changed .gitignore\n```diff\n@@ -1,3 +1,4 @@\n+â”Š â”Š1â”Šdist\n â”Š1â”Š2â”Šnode_modules\n â”Š2â”Š3â”Šnpm-debug.log\n â”Š3â”Š4â”Štest-results/\n```\n\n##### Changed package.json\n```diff\n@@ -9,6 +9,8 @@\n â”Š 9â”Š 9â”Š  \"scripts\": {\n â”Š10â”Š10â”Š    \"prestart\": \"yarn codegen\",\n â”Š11â”Š11â”Š    \"start\": \"ts-node index.ts\",\n+â”Š  â”Š12â”Š    \"prebuild\": \"yarn codegen\",\n+â”Š  â”Š13â”Š    \"build\": \"tsc\",\n â”Š12â”Š14â”Š    \"test\": \"TZ=\\\"Asia/Jerusalem\\\" jest --runInBand --forceExit\",\n â”Š13â”Š15â”Š    \"codegen\": \"gql-gen\",\n â”Š14â”Š16â”Š    \"format\": \"prettier \\\"**/*.ts\\\" --write\"\n```\n\n##### Changed tsconfig.json\n```diff\n@@ -1,5 +1,6 @@\n â”Š1â”Š1â”Š{\n â”Š2â”Š2â”Š  \"compilerOptions\": {\n+â”Š â”Š3â”Š    \"outDir\": \"dist\",\n â”Š3â”Š4â”Š    \"target\": \"es2018\",\n â”Š4â”Š5â”Š    \"module\": \"commonjs\",\n â”Š5â”Š6â”Š    \"lib\": [\n```\n\n[}]: #\n\nNext, the script to actually run the server:\n\n[{]: <helper> (diffStep \"14.13\" files=\"package.json\" module=\"server\")\n\n#### [__Server__ Step 14.13: Prepare for production](https://github.com/Urigo/WhatsApp-Clone-Server/commit/f80770dce6559f7cff9936c0fdd8787487f1391e)\n\n##### Changed package.json\n```diff\n@@ -10,6 +10,7 @@\n â”Š10â”Š10â”Š    \"prestart\": \"yarn codegen\",\n â”Š11â”Š11â”Š    \"start\": \"ts-node index.ts\",\n â”Š12â”Š12â”Š    \"prebuild\": \"yarn codegen\",\n+â”Š  â”Š13â”Š    \"prod\": \"node dist/index.js\",\n â”Š13â”Š14â”Š    \"build\": \"tsc\",\n â”Š14â”Š15â”Š    \"test\": \"TZ=\\\"Asia/Jerusalem\\\" jest --runInBand --forceExit\",\n â”Š15â”Š16â”Š    \"codegen\": \"gql-gen\",\n```\n\n[}]: #\n\nOnce itâ€™s ready, we can move on to tooling.\n\n### Artillery\n\nArtillery is an open-source load testing and functional testing toolkit. Itâ€™s API is vast but we will focus on the core part of it which is relevant to this chapter. Artillery is available as a npm package:\n\n    $ yarn add -D artillery\n\nThe only step to use Artillery is to set it up. We will create the `artillery.yml` file, like this:\n\n[{]: <helper> (diffStep \"14.15\" module=\"server\")\n\n#### [__Server__ Step 14.15: Add artillery config](https://github.com/Urigo/WhatsApp-Clone-Server/commit/237cce305eaf31299f7acb7b6d287032191465f0)\n\n##### Added artillery.yml\n```diff\n@@ -0,0 +1,72 @@\n+â”Š  â”Š 1â”Šconfig:\n+â”Š  â”Š 2â”Š  target: 'http://localhost:4000/graphql'\n+â”Š  â”Š 3â”Š  phases:\n+â”Š  â”Š 4â”Š    - duration: 120\n+â”Š  â”Š 5â”Š      arrivalRate: 5\n+â”Š  â”Š 6â”Š      rampTo: 20\n+â”Š  â”Š 7â”Šscenarios:\n+â”Š  â”Š 8â”Š  - name: 'Sign in, send a new message and fetch a list of chats'\n+â”Š  â”Š 9â”Š    flow:\n+â”Š  â”Š10â”Š      - post:\n+â”Š  â”Š11â”Š          url: '/'\n+â”Š  â”Š12â”Š          json:\n+â”Š  â”Š13â”Š            variables:\n+â”Š  â”Š14â”Š              username: 'ray'\n+â”Š  â”Š15â”Š              password: '111'\n+â”Š  â”Š16â”Š            query: |\n+â”Š  â”Š17â”Š              mutation SignIn($username: String!, $password: String!) {\n+â”Š  â”Š18â”Š                signIn(username: $username, password: $password) {\n+â”Š  â”Š19â”Š                  id\n+â”Š  â”Š20â”Š                }\n+â”Š  â”Š21â”Š              }\n+â”Š  â”Š22â”Š      - post:\n+â”Š  â”Š23â”Š          url: '/'\n+â”Š  â”Š24â”Š          json:\n+â”Š  â”Š25â”Š            query: |\n+â”Š  â”Š26â”Š              mutation message {\n+â”Š  â”Š27â”Š                addMessage(chatId: \"1\", content: \"artillery\") {\n+â”Š  â”Š28â”Š                  id\n+â”Š  â”Š29â”Š                }\n+â”Š  â”Š30â”Š              }\n+â”Š  â”Š31â”Š      - post:\n+â”Š  â”Š32â”Š          url: '/'\n+â”Š  â”Š33â”Š          json:\n+â”Š  â”Š34â”Š            variables:\n+â”Š  â”Š35â”Š              limit: 20\n+â”Š  â”Š36â”Š            query: |\n+â”Š  â”Š37â”Š              fragment User on User {\n+â”Š  â”Š38â”Š                id\n+â”Š  â”Š39â”Š                name\n+â”Š  â”Š40â”Š                picture\n+â”Š  â”Š41â”Š              }\n+â”Š  â”Š42â”Š              fragment Message on Message {\n+â”Š  â”Š43â”Š                id\n+â”Š  â”Š44â”Š                content\n+â”Š  â”Š45â”Š                chat {\n+â”Š  â”Š46â”Š                  id\n+â”Š  â”Š47â”Š                }\n+â”Š  â”Š48â”Š                sender {\n+â”Š  â”Š49â”Š                  ...User\n+â”Š  â”Š50â”Š                }\n+â”Š  â”Š51â”Š                recipient {\n+â”Š  â”Š52â”Š                  ...User\n+â”Š  â”Š53â”Š                }\n+â”Š  â”Š54â”Š              }\n+â”Š  â”Š55â”Š              query GetChats($limit: Int!) {\n+â”Š  â”Š56â”Š                chats {\n+â”Š  â”Š57â”Š                  id\n+â”Š  â”Š58â”Š                  name\n+â”Š  â”Š59â”Š                  picture\n+â”Š  â”Š60â”Š                  lastMessage {\n+â”Š  â”Š61â”Š                    ...Message\n+â”Š  â”Š62â”Š                  }\n+â”Š  â”Š63â”Š                  messages(limit: $limit) {\n+â”Š  â”Š64â”Š                    messages {\n+â”Š  â”Š65â”Š                      ...Message\n+â”Š  â”Š66â”Š                    }\n+â”Š  â”Š67â”Š                  }\n+â”Š  â”Š68â”Š                  participants {\n+â”Š  â”Š69â”Š                    ...User\n+â”Š  â”Š70â”Š                  }\n+â”Š  â”Š71â”Š                }\n+â”Š  â”Š72â”Š              }\n```\n\n[}]: #\n\nAs you can see, the config file is built of two sections. First one is named `config` and it defines whatâ€™s our target and how the traffic should look like. We used one phase but it could have many. The `duration` parameter is to define how long the phase should take. The `arrivalRate` defines how many virtual users per second are going to hit the target and the `rampTo` directs Artillery to increase this number up to 20, at the middle of the phase.\n\nThe next section, called `scenarios`, is all about the actual requests. In our case, we want to authenticate user, submit a new message and fetch an entire list of chats with their messages at the end. Artillery shares cookies between request of the same virtual user, keep that on mind.\n\nWe used Ray as the user and fairly similar operations to what the client app sends. That should closely represent the actual usage of the API.\n\nEverything is fine with that config but we need to find the limit, to push even more. That's why we'll also add a second config with a bit more heavier traffic, something to simulate the more real life environment. It's pretty much the same setup except phases. First, we \"warms up\" the server for 2 minutes, same amount of times goes next with double the traffic, then we keep it for 5 minutes. At the end, we want to crash the server so we send nearly 100 virtual users per second for an entire minute. This way we know when it cracks.\n\n[{]: <helper> (diffStep \"14.16\" module=\"server\")\n\n#### [__Server__ Step 14.16: Artillery config to find a limit](https://github.com/Urigo/WhatsApp-Clone-Server/commit/7a6a509012f33d639637758007e82be3678c5139)\n\n##### Added artillery-limit.yml\n```diff\n@@ -0,0 +1,77 @@\n+â”Š  â”Š 1â”Šconfig:\n+â”Š  â”Š 2â”Š  target: 'http://localhost:4000/graphql'\n+â”Š  â”Š 3â”Š  phases:\n+â”Š  â”Š 4â”Š    - duration: 120\n+â”Š  â”Š 5â”Š      arrivalRate: 5\n+â”Š  â”Š 6â”Š    - duration: 120\n+â”Š  â”Š 7â”Š      arrivalRate: 10\n+â”Š  â”Š 8â”Š    - duration: 300\n+â”Š  â”Š 9â”Š      arrivalRate: 10\n+â”Š  â”Š10â”Š    - duration: 60\n+â”Š  â”Š11â”Š      arrivalRate: 100\n+â”Š  â”Š12â”Šscenarios:\n+â”Š  â”Š13â”Š  - name: 'Sign in, send a new message and fetch a list of chats'\n+â”Š  â”Š14â”Š    flow:\n+â”Š  â”Š15â”Š      - post:\n+â”Š  â”Š16â”Š          url: '/'\n+â”Š  â”Š17â”Š          json:\n+â”Š  â”Š18â”Š            variables:\n+â”Š  â”Š19â”Š              username: 'ray'\n+â”Š  â”Š20â”Š              password: '111'\n+â”Š  â”Š21â”Š            query: |\n+â”Š  â”Š22â”Š              mutation SignIn($username: String!, $password: String!) {\n+â”Š  â”Š23â”Š                signIn(username: $username, password: $password) {\n+â”Š  â”Š24â”Š                  id\n+â”Š  â”Š25â”Š                }\n+â”Š  â”Š26â”Š              }\n+â”Š  â”Š27â”Š      - post:\n+â”Š  â”Š28â”Š          url: '/'\n+â”Š  â”Š29â”Š          json:\n+â”Š  â”Š30â”Š            query: |\n+â”Š  â”Š31â”Š              mutation message {\n+â”Š  â”Š32â”Š                addMessage(chatId: \"1\", content: \"artillery\") {\n+â”Š  â”Š33â”Š                  id\n+â”Š  â”Š34â”Š                }\n+â”Š  â”Š35â”Š              }\n+â”Š  â”Š36â”Š      - post:\n+â”Š  â”Š37â”Š          url: '/'\n+â”Š  â”Š38â”Š          json:\n+â”Š  â”Š39â”Š            variables:\n+â”Š  â”Š40â”Š              limit: 20\n+â”Š  â”Š41â”Š            query: |\n+â”Š  â”Š42â”Š              fragment User on User {\n+â”Š  â”Š43â”Š                id\n+â”Š  â”Š44â”Š                name\n+â”Š  â”Š45â”Š                picture\n+â”Š  â”Š46â”Š              }\n+â”Š  â”Š47â”Š              fragment Message on Message {\n+â”Š  â”Š48â”Š                id\n+â”Š  â”Š49â”Š                content\n+â”Š  â”Š50â”Š                chat {\n+â”Š  â”Š51â”Š                  id\n+â”Š  â”Š52â”Š                }\n+â”Š  â”Š53â”Š                sender {\n+â”Š  â”Š54â”Š                  ...User\n+â”Š  â”Š55â”Š                }\n+â”Š  â”Š56â”Š                recipient {\n+â”Š  â”Š57â”Š                  ...User\n+â”Š  â”Š58â”Š                }\n+â”Š  â”Š59â”Š              }\n+â”Š  â”Š60â”Š              query GetChats($limit: Int!) {\n+â”Š  â”Š61â”Š                chats {\n+â”Š  â”Š62â”Š                  id\n+â”Š  â”Š63â”Š                  name\n+â”Š  â”Š64â”Š                  picture\n+â”Š  â”Š65â”Š                  lastMessage {\n+â”Š  â”Š66â”Š                    ...Message\n+â”Š  â”Š67â”Š                  }\n+â”Š  â”Š68â”Š                  messages(limit: $limit) {\n+â”Š  â”Š69â”Š                    messages {\n+â”Š  â”Š70â”Š                      ...Message\n+â”Š  â”Š71â”Š                    }\n+â”Š  â”Š72â”Š                  }\n+â”Š  â”Š73â”Š                  participants {\n+â”Š  â”Š74â”Š                    ...User\n+â”Š  â”Š75â”Š                  }\n+â”Š  â”Š76â”Š                }\n+â”Š  â”Š77â”Š              }ðŸš«â†µ\n```\n\n[}]: #\n\nOnce everything is ready, let's add npm scripts, one for a normal traffic and a second with the much more users:\n\n[{]: <helper> (diffStep \"14.17\" module=\"server\")\n\n#### [__Server__ Step 14.17: Add loadtest scripts](https://github.com/Urigo/WhatsApp-Clone-Server/commit/81129e17ed5afd4daea5f1ad3c9d021bc06ae9d9)\n\n##### Changed package.json\n```diff\n@@ -14,7 +14,9 @@\n â”Š14â”Š14â”Š    \"build\": \"tsc\",\n â”Š15â”Š15â”Š    \"test\": \"TZ=\\\"Asia/Jerusalem\\\" jest --runInBand --forceExit\",\n â”Š16â”Š16â”Š    \"codegen\": \"gql-gen\",\n-â”Š17â”Š  â”Š    \"format\": \"prettier \\\"**/*.ts\\\" --write\"\n+â”Š  â”Š17â”Š    \"format\": \"prettier \\\"**/*.ts\\\" --write\",\n+â”Š  â”Š18â”Š    \"loadtest\": \"yarn artillery run artillery.yml > loadtest.log\",\n+â”Š  â”Š19â”Š    \"loadtest:limit\": \"yarn artillery run artillery-limit.yml > loadtest.log\"\n â”Š18â”Š20â”Š  },\n â”Š19â”Š21â”Š  \"jest-junit\": {\n â”Š20â”Š22â”Š    \"outputDirectory\": \"./test-results\"\n```\n\n[}]: #\n\nYou probably noticed that we stream the output to the `loadtest.log` file and that's just to read the results in a bit more pleasent way, than in the terminal.\n\nLetâ€™s start the server and run artillery:\n\n    $ yarn build && yarn start\n    $ yarn loadtest\n\nYouâ€™ll see a loading indicator, might take a while but when it completes, you should see something like this in `loadtest.log` file:\n\n```\nSummary report @ 15:00:58(+0200) 2019-05-30\n  Scenarios launched:  1506\n  Scenarios completed: 1506\n  Requests completed:  4518\n  RPS sent: 37.35\n  Request latency:\n    min: 3.5\n    max: 115.7\n    median: 18.6\n    p95: 54.4\n    p99: 66.2\n  Scenario counts:\n    Sign in, send a new message and fetch a list of chats: 1506 (100%)\n  Codes:\n    200: 4518\n```\n\nWe ran the scenario 1506 times, all were completed and the total number of requests was 4518.  The **RPS** means requests per second.\n\nThe metrics in **Request latency** are in milliseconds. We see what was the shortest request and so on. These **p95** and **p99** values mean that for 95% of virtual users, the latency was 54.4ms or lower, for 99% it was 66.2ms. All requests finished with 200 status code.\n\nYou might also automate that process and integrate Artillery CLI with CI/CI systems or even send metrics to external monitoring systems.\n\n### Apollo Engine\n\nLet's bring back the Apollo Engine once again. It will be helpful to analyze the load testing results.\n\nOn the **Metrics** page, you will see the following view:\n\n![Metrics](../../../assets/step17/img-13.png \"Metrics\")\n\nClick on the filter and set a custom date range to match the time you were load testing. Just to filter out other requests.\n\n![Filter](../../../assets/step17/img-14.png \"Filter\")\n\nBy default, Apollo Engine counts all operations, but you can pick the one youâ€™re interesting in. We donâ€™t do it and inspect them all.\n\n![List](../../../assets/step17/img-15.png \"List of operations\")\n\nOn the main part of the view, you should see â€œLast day overviewâ€ panel.\n\n![Overview](../../../assets/step17/img-16.png \"Last day overview\")\n\nAs you can see, all operations we ran are listed there and no error occurred.\n\n![Request Rate](../../../assets/step17/img-17.png \"Request Rate Over Time\")\n\nNext section shows the Requests Per Minute (rpm) metric over time. Itâ€™s useful to understand which operations are sent more often than others.\n\n![Request 1](../../../assets/step17/img-18.png \"Request Latency Over time\")\n![Request 2](../../../assets/step17/img-19.png \"Request Latency Distribution\")\n\nLast two panels are there to understand at what number of requests the latency increases and to show the correlation between them. We see a distribution of the processing time (the horizontal axis) and the number of operations. It also has p50, p75, p90 and p99 marks on it."
          }
        ]
      }
    ]
  }
]
