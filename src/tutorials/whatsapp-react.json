[
  {
    "repoUrl": "https://Urigo@github.com/Urigo/WhatsApp-Clone-Tutorial",
    "branchName": "master",
    "historyBranchName": "master-history",
    "releases": [
      {
        "releaseVersion": "0.1.0",
        "releaseDate": "2019-03-05 15:04:23 +0800",
        "tagName": "master@0.1.0",
        "tagRevision": "747210bc9a7c919d1c18bb3bd328760123e1a873",
        "changesDiff": "",
        "manuals": [
          {
            "manualTitle": "WhatsApp Clone Tutorial",
            "stepRevision": "dd15479cdd433e0200d899f7be1af2382af4bb4d",
            "manualView": "<p align=\"center\"><img src=\"https://cdn-images-1.medium.com/max/1600/1*cSBu9zeo8fSnf1Cc-UeR_g.jpeg\" width=\"640\"></p>\n\nYou might have seen it around alreadyâ€Š-â€Šan open-source WhatsApp Clone tutorial; a project which was originally started in 2015 by [Uri Goldshtein](https://github.com/urigo) based on Angular-Meteor and Ionic, and have been throughout different incarnations ever since.\n\nThis time around, I'm happy to announce that a new version of the WhatsApp Clone is coming, and it's based on React 16.7 (Hooks & Suspense), Styled-Components, Material-UI, TypeScript, GraphQL-Subscriptions/Codegen/Modules, PostgreSQL and TypeORM.\n\nThe step-by-step implementations of the server and client can be found here:\n\n- Server - [urigo/whatsapp-clone-server](https://github.com/urigo/whatsapp-clone-server)\n\n- Client - [urigo/whatsapp-clone-client](https://github.com/urigo/whatsapp-clone-client-react)\n\n<p align=\"center\"><img src=\"https://cdn-images-1.medium.com/max/1040/1*fFUJd7moWtjvMZ5dE-A80g.gif\" alt=\"whatsapp\" width=\"240\"></p>\n\n### Why is it so good?\n\nThis app was built with all the latest and hottest technologies out there. The purpose is simpleâ€Š-â€Šit should be a guideline for building a proper app, thus we thought very carefully regards the design patterns and architecture used in it, plus, we made sure to cover all communication methods with the GraphQL-back-end in different variations (query, mutation, subscription). This way whenever you're looking to start a new app, maintain an existing one or upgrade your dev-stack, the WhatsApp-clone can be a great source to start with! It's full stack and has a complete flow.\n\n### Why did we choose this dev-stack?\n\nReact, GraphQL, PostgreSQL and TypeScript for obvious reasonsâ€Š-â€Šthey are backed by a strong ecosystem. These technologies can be used in endless variations, and there's no one way which is the most right of doing so, but we chose a way that makes the most sense for us and that we truly believe in when it comes to building apps. We've connected all 4 with TypeORM, GraphQL-Codegen, GraphQL-Modules for the following reasons:\n\n- The GraphQL back-end was implemented with GraphQL-Modules where logic was splitted into modules based on entity types. GraphQL-Modules is an amazing library which provides you with the ability to manage and maintain your GraphQL schema correctly. Not once nor twice I have seen people who struggle with that and get tangled upon their own creation, and with GraphQL-Modules where you have a very defined structure, this problem can be easily solved.\n\n- Every GraphQL/TypeScript definition were automatically generated with GraphQL-Codegen using a single command call. There's no need to maintain the same thing twice if it already exists in one way or another. This way you don't have to write TypeScript type definitions for your GraphQL documents (queries, mutations and subscriptions), GraphQL resolvers and GraphQL types.\n\n- The new version of React 16.7 was used with Hooks and Suspense and 100% of the project is made out of function components. The front-end communicates with the back-end using only hooks and there was no use in GraphQL-React components, which makes async tasks look a lot more readable with no extra indentations.\n\n- We used TypeORM to correctly split the logic of the entities in the database and define the relationships between them. Without a tool such as TypeORM, communication against the DB tends to get messy and confusion since there's no single module per entity which holds all its related logic.\n\n### What to expect?\n\n- Basic authentication.\n\n- Image uploading with [Cloudinary](https://cloudinary.com/).\n\n- Live updates with GraphQL subscriptions.\n\n- 100% function components with React Hooks.\n\n- GraphQL communication with [react-apollo-hooks](https://github.com/trojanowski/react-apollo-hooks).\n\nThis app be extremely useful for those who have little to no background in one of the technologies in our dev-stack."
          },
          {
            "manualTitle": "Step 1: Creating a React App with Apollo Server",
            "stepRevision": "6c895d70ac63351b7638cdc12b967c5fca914986",
            "manualView": "To create a new React app we're simply gonna use [`create-react-app`](https://github.com/facebook/create-react-app). It comes with a built-in TypeScript support which is exactly what we need. First, install the CLI if you haven't already:\n\n    $ yarn global add create-react-app\n\nAnd then create the app itself:\n\n    $ create-react-app whatsapp-clone-client\n\nBy default, `create-react-app` will create a JavaScript project. In order to use TypeScript, we will rename our app files to have the right extension `.tsx` (TypeScript + JSX):\n\n    src$ mv App.js App.tsx\n    src$ mv index.js index.tsx\n\nAnd then we will add a couple of configuration files that will basically set the building and linting rules for the TypeScript compiler:\n\n[{]: <helper> (diffStep 1.1 files=\"tsconfig.json, tslint.json\" module=\"client\")\n\n#### [Step 1.1: Setup TypeScript](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/614a414)\n\n##### Added tsconfig.json\n```diff\n@@ -0,0 +1,35 @@\n+â”Š  â”Š 1â”Š{\n+â”Š  â”Š 2â”Š  \"compilerOptions\": {\n+â”Š  â”Š 3â”Š    \"outDir\": \"build/dist\",\n+â”Š  â”Š 4â”Š    \"sourceMap\": true,\n+â”Š  â”Š 5â”Š    \"declaration\": false,\n+â”Š  â”Š 6â”Š    \"moduleResolution\": \"node\",\n+â”Š  â”Š 7â”Š    \"emitDecoratorMetadata\": true,\n+â”Š  â”Š 8â”Š    \"experimentalDecorators\": true,\n+â”Š  â”Š 9â”Š    \"downlevelIteration\": true,\n+â”Š  â”Š10â”Š    \"resolveJsonModule\": true,\n+â”Š  â”Š11â”Š    \"target\": \"es5\",\n+â”Š  â”Š12â”Š    \"jsx\": \"preserve\",\n+â”Š  â”Š13â”Š    \"typeRoots\": [\n+â”Š  â”Š14â”Š      \"node_modules/@types\"\n+â”Š  â”Š15â”Š    ],\n+â”Š  â”Š16â”Š    \"lib\": [\n+â”Š  â”Š17â”Š      \"es2017\",\n+â”Š  â”Š18â”Š      \"dom\",\n+â”Š  â”Š19â”Š      \"esnext.asynciterable\"\n+â”Š  â”Š20â”Š    ],\n+â”Š  â”Š21â”Š    \"allowJs\": true,\n+â”Š  â”Š22â”Š    \"skipLibCheck\": true,\n+â”Š  â”Š23â”Š    \"esModuleInterop\": false,\n+â”Š  â”Š24â”Š    \"allowSyntheticDefaultImports\": true,\n+â”Š  â”Š25â”Š    \"forceConsistentCasingInFileNames\": true,\n+â”Š  â”Š26â”Š    \"isolatedModules\": true,\n+â”Š  â”Š27â”Š    \"noEmit\": true,\n+â”Š  â”Š28â”Š    \"noImplicitAny\": false,\n+â”Š  â”Š29â”Š    \"strict\": false,\n+â”Š  â”Š30â”Š    \"module\": \"esnext\"\n+â”Š  â”Š31â”Š  },\n+â”Š  â”Š32â”Š  \"include\": [\n+â”Š  â”Š33â”Š    \"src\"\n+â”Š  â”Š34â”Š  ]\n+â”Š  â”Š35â”Š}\n```\n\n##### Added tslint.json\n```diff\n@@ -0,0 +1,29 @@\n+â”Š  â”Š 1â”Š{\n+â”Š  â”Š 2â”Š  \"extends\": [\"tslint:recommended\", \"tslint-react\", \"tslint-config-prettier\"],\n+â”Š  â”Š 3â”Š  \"rules\": {\n+â”Š  â”Š 4â”Š    \"ordered-imports\": false,\n+â”Š  â”Š 5â”Š    \"object-literal-sort-keys\": false,\n+â”Š  â”Š 6â”Š    \"jsx-boolean-value\": false,\n+â”Š  â”Š 7â”Š    \"interface-name\" : false,\n+â”Š  â”Š 8â”Š    \"variable-name\": false,\n+â”Š  â”Š 9â”Š    \"no-string-literal\": false,\n+â”Š  â”Š10â”Š    \"no-namespace\": false,\n+â”Š  â”Š11â”Š    \"interface-over-type-literal\": false,\n+â”Š  â”Š12â”Š    \"no-shadowed-variable\": false,\n+â”Š  â”Š13â”Š    \"curly\": false,\n+â”Š  â”Š14â”Š    \"no-label\": false,\n+â”Š  â”Š15â”Š    \"no-empty\": false,\n+â”Š  â”Š16â”Š    \"no-debugger\": false,\n+â”Š  â”Š17â”Š    \"no-console\": false,\n+â”Š  â”Š18â”Š    \"array-type\": false\n+â”Š  â”Š19â”Š  },\n+â”Š  â”Š20â”Š  \"linterOptions\": {\n+â”Š  â”Š21â”Š    \"exclude\": [\n+â”Š  â”Š22â”Š      \"config/**/*.js\",\n+â”Š  â”Š23â”Š      \"node_modules/**/*.ts\",\n+â”Š  â”Š24â”Š      \"coverage/lcov-report/*.js\",\n+â”Š  â”Š25â”Š      \"*.json\",\n+â”Š  â”Š26â”Š      \"**/*.json\"\n+â”Š  â”Š27â”Š    ]\n+â”Š  â”Š28â”Š  }\n+â”Š  â”Š29â”Š}\n```\n\n[}]: #\n\nOnce we will run the app for the first time, `react-scripts` (`create-react-app` utility scripts package) should automatically initialize some additional TypeScript related files.\n\n    $ yarn start\n\nSince in our app we'll be using the new React [hooks](https://reactjs.org/docs/hooks-intro.html) and [Suspense](https://reactjs.org/docs/react-api.html#reactsuspense) mechanisms, we will upgrade React's version to version `16.8`:\n\n    $ yarn upgrade react@16.8.1 react-dom@16.8.1\n\nThe plan is to make our app talk with a [GraphQL](https://graphql.org/) back-end, so we'll be using [Apollo](https://www.apollographql.com/) to setup a client which is actually capable of such.\n\nFirst we will install all the necessary packages:\n\n    $ yarn add apollo-cache-inmemory@1.4.3 apollo-client@2.4.13 apollo-link@1.2.8 apollo-link-http@1.5.11 apollo-link-ws@1.0.14 apollo-utilities@1.1.3 graphql@14.1.1 react-apollo-hooks@4.0.0 subscriptions-transport-ws@0.9.15\n    $ yarn add -D @types/graphql@14.0.7 @types/node@11.9.4\n\nThen we will set the server's connection URL under the `.env` file which is basically used to define constants for our application. The constants can be addressed using `process.env[CONSTANT_NAME]`. The identifier should be replaced automatically by `react-scripts` with the stored value, just like macros:\n\n[{]: <helper> (diffStep 1.3 files=\".env\" module=\"client\")\n\n#### [Step 1.3: Setup Apollo-client](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/9d7fe0f)\n\n##### Added .env\n```diff\n@@ -0,0 +1 @@\n+â”Š â”Š1â”ŠREACT_APP_SERVER_URL=http://localhost:4000\n```\n\n[}]: #\n\nAnd finally we can write our Apollo-GraphQL client module and connect it to our application:\n\n[{]: <helper> (diffStep 1.3 files=\"src/apollo-client.ts, src/index.tsx\" module=\"client\")\n\n#### [Step 1.3: Setup Apollo-client](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/9d7fe0f)\n\n##### Added src&#x2F;apollo-client.ts\n```diff\n@@ -0,0 +1,38 @@\n+â”Š  â”Š 1â”Šimport { InMemoryCache } from 'apollo-cache-inmemory'\n+â”Š  â”Š 2â”Šimport { ApolloClient } from 'apollo-client'\n+â”Š  â”Š 3â”Šimport { ApolloLink, split } from 'apollo-link'\n+â”Š  â”Š 4â”Šimport { HttpLink } from 'apollo-link-http'\n+â”Š  â”Š 5â”Šimport { WebSocketLink } from 'apollo-link-ws'\n+â”Š  â”Š 6â”Šimport { getMainDefinition } from 'apollo-utilities'\n+â”Š  â”Š 7â”Šimport { OperationDefinitionNode } from 'graphql'\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Šconst httpUri = process.env.REACT_APP_SERVER_URL + '/graphql'\n+â”Š  â”Š10â”Šconst wsUri = httpUri.replace(/^https?/, 'ws')\n+â”Š  â”Š11â”Š\n+â”Š  â”Š12â”Šconst httpLink = new HttpLink({\n+â”Š  â”Š13â”Š  uri: httpUri,\n+â”Š  â”Š14â”Š})\n+â”Š  â”Š15â”Š\n+â”Š  â”Š16â”Šconst wsLink = new WebSocketLink({\n+â”Š  â”Š17â”Š  uri: wsUri,\n+â”Š  â”Š18â”Š  options: {\n+â”Š  â”Š19â”Š    reconnect: true,\n+â”Š  â”Š20â”Š  },\n+â”Š  â”Š21â”Š})\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Šconst terminatingLink = split(\n+â”Š  â”Š24â”Š  ({ query }) => {\n+â”Š  â”Š25â”Š    const { kind, operation } = getMainDefinition(query) as OperationDefinitionNode\n+â”Š  â”Š26â”Š    return kind === 'OperationDefinition' && operation === 'subscription'\n+â”Š  â”Š27â”Š  },\n+â”Š  â”Š28â”Š  wsLink,\n+â”Š  â”Š29â”Š  httpLink,\n+â”Š  â”Š30â”Š)\n+â”Š  â”Š31â”Š\n+â”Š  â”Š32â”Šconst link = ApolloLink.from([terminatingLink])\n+â”Š  â”Š33â”Šconst cache = new InMemoryCache()\n+â”Š  â”Š34â”Š\n+â”Š  â”Š35â”Šexport default new ApolloClient({\n+â”Š  â”Š36â”Š  link,\n+â”Š  â”Š37â”Š  cache,\n+â”Š  â”Š38â”Š})\n```\n\n##### Changed src&#x2F;index.tsx\n```diff\n@@ -1,10 +1,16 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n â”Š 2â”Š 2â”Šimport ReactDOM from 'react-dom';\n+â”Š  â”Š 3â”Šimport { ApolloProvider } from 'react-apollo-hooks';\n â”Š 3â”Š 4â”Šimport './index.css';\n â”Š 4â”Š 5â”Šimport App from './App';\n+â”Š  â”Š 6â”Šimport apolloClient from './apollo-client'\n â”Š 5â”Š 7â”Šimport * as serviceWorker from './serviceWorker';\n â”Š 6â”Š 8â”Š\n-â”Š 7â”Š  â”ŠReactDOM.render(<App />, document.getElementById('root'));\n+â”Š  â”Š 9â”ŠReactDOM.render(\n+â”Š  â”Š10â”Š  <ApolloProvider client={apolloClient}>\n+â”Š  â”Š11â”Š    <App />\n+â”Š  â”Š12â”Š  </ApolloProvider>\n+â”Š  â”Š13â”Š, document.getElementById('root'));\n â”Š 8â”Š14â”Š\n â”Š 9â”Š15â”Š// If you want your app to work offline and load faster, you can change\n â”Š10â”Š16â”Š// unregister() to register() below. Note this comes with some pitfalls.\n```\n\n[}]: #\n\n> Note that this configuration assumes that the sever runs at `localhost:4000` and that it serves a GraphQL REST endpoint at `/graphql`. Feel free to make the right adjustments according to your needs.\n\nNeedless to say that we need a back-end for our application to function properly, and so this is what we're gonna focus on. We will initialize a second project for the server in a separate directory called `whatsapp-clone-server`:\n\n    $ mkdir whatsapp-clone-server\n    $ cd whatsapp-clone-server\n\nAnd then we will initialize a new Node.JS project using NPM:\n\n    $ npm init --yes\n\nThere's nothing special about this command, it only creates a basic `package.json` which we can add things on top (see [reference](https://docs.npmjs.com/cli/init)). We will be using TypeScript in our project, so let's set it up by installing the necessary packages:\n\n    $ yarn add -D typescript@3.3.3 ts-node@8.0.2 @types/node@11.9.4\n\nAnd creating a `tsconfig.json` file:\n\n[{]: <helper> (diffStep 1.1 files=\"tsconfig.json\" module=\"server\")\n\n#### [Step 1.1: Setup TypeScript](https://github.com/Urigo/WhatsApp-Clone-Server/commit/9302e04)\n\n##### Added tsconfig.json\n```diff\n@@ -0,0 +1,64 @@\n+â”Š  â”Š 1â”Š{\n+â”Š  â”Š 2â”Š  \"compilerOptions\": {\n+â”Š  â”Š 3â”Š    /* Basic Options */\n+â”Š  â”Š 4â”Š    \"target\": \"es2018\",                       /* Specify ECMAScript target version: 'ES3' (default), 'ES5', 'ES2015', 'ES2016', 'ES2017','ES2018' or 'ESNEXT'. */\n+â”Š  â”Š 5â”Š    \"module\": \"commonjs\",                     /* Specify module code generation: 'none', 'commonjs', 'amd', 'system', 'umd', 'es2015', or 'ESNext'. */\n+â”Š  â”Š 6â”Š    \"lib\": [                                  /* Specify library files to be included in the compilation. */\n+â”Š  â”Š 7â”Š      \"es2018\",\n+â”Š  â”Š 8â”Š      \"esnext.asynciterable\"\n+â”Š  â”Š 9â”Š    ],\n+â”Š  â”Š10â”Š    // \"allowJs\": true,                       /* Allow javascript files to be compiled. */\n+â”Š  â”Š11â”Š    // \"checkJs\": true,                       /* Report errors in .js files. */\n+â”Š  â”Š12â”Š    // \"jsx\": \"preserve\",                     /* Specify JSX code generation: 'preserve', 'react-native', or 'react'. */\n+â”Š  â”Š13â”Š    // \"declaration\": true,                   /* Generates corresponding '.d.ts' file. */\n+â”Š  â”Š14â”Š    // \"declarationMap\": true,                /* Generates a sourcemap for each corresponding '.d.ts' file. */\n+â”Š  â”Š15â”Š    // \"sourceMap\": true,                     /* Generates corresponding '.map' file. */\n+â”Š  â”Š16â”Š    // \"outFile\": \"./\",                       /* Concatenate and emit output to single file. */\n+â”Š  â”Š17â”Š    // \"outDir\": \"./\",                        /* Redirect output structure to the directory. */\n+â”Š  â”Š18â”Š    // \"rootDir\": \"./\",                       /* Specify the root directory of input files. Use to control the output directory structure with --outDir. */\n+â”Š  â”Š19â”Š    // \"composite\": true,                     /* Enable project compilation */\n+â”Š  â”Š20â”Š    // \"removeComments\": true,                /* Do not emit comments to output. */\n+â”Š  â”Š21â”Š    // \"noEmit\": true,                        /* Do not emit outputs. */\n+â”Š  â”Š22â”Š    // \"importHelpers\": true,                 /* Import emit helpers from 'tslib'. */\n+â”Š  â”Š23â”Š    // \"downlevelIteration\": true,            /* Provide full support for iterables in 'for-of', spread, and destructuring when targeting 'ES5' or 'ES3'. */\n+â”Š  â”Š24â”Š    // \"isolatedModules\": true,               /* Transpile each file as a separate module (similar to 'ts.transpileModule'). */\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Š    /* Strict Type-Checking Options */\n+â”Š  â”Š27â”Š    \"strict\": true,                           /* Enable all strict type-checking options. */\n+â”Š  â”Š28â”Š    // \"noImplicitAny\": true,                 /* Raise error on expressions and declarations with an implied 'any' type. */\n+â”Š  â”Š29â”Š    // \"strictNullChecks\": true,              /* Enable strict null checks. */\n+â”Š  â”Š30â”Š    // See https://github.com/DefinitelyTyped/DefinitelyTyped/issues/21359\n+â”Š  â”Š31â”Š    \"strictFunctionTypes\": false,             /* Enable strict checking of function types. */\n+â”Š  â”Š32â”Š    // \"strictBindCallApply\": true,           /* Enable strict 'bind', 'call', and 'apply' methods on functions. */\n+â”Š  â”Š33â”Š    \"strictPropertyInitialization\": false,    /* Enable strict checking of property initialization in classes. */\n+â”Š  â”Š34â”Š    // \"noImplicitThis\": true,                /* Raise error on 'this' expressions with an implied 'any' type. */\n+â”Š  â”Š35â”Š    // \"alwaysStrict\": true,                  /* Parse in strict mode and emit \"use strict\" for each source file. */\n+â”Š  â”Š36â”Š\n+â”Š  â”Š37â”Š    /* Additional Checks */\n+â”Š  â”Š38â”Š    // \"noUnusedLocals\": true,                /* Report errors on unused locals. */\n+â”Š  â”Š39â”Š    // \"noUnusedParameters\": true,            /* Report errors on unused parameters. */\n+â”Š  â”Š40â”Š    // \"noImplicitReturns\": true,             /* Report error when not all code paths in function return a value. */\n+â”Š  â”Š41â”Š    // \"noFallthroughCasesInSwitch\": true,    /* Report errors for fallthrough cases in switch statement. */\n+â”Š  â”Š42â”Š\n+â”Š  â”Š43â”Š    /* Module Resolution Options */\n+â”Š  â”Š44â”Š    // \"moduleResolution\": \"node\",            /* Specify module resolution strategy: 'node' (Node.js) or 'classic' (TypeScript pre-1.6). */\n+â”Š  â”Š45â”Š    // \"baseUrl\": \"./\",                       /* Base directory to resolve non-absolute module names. */\n+â”Š  â”Š46â”Š    // \"paths\": {},                           /* A series of entries which re-map imports to lookup locations relative to the 'baseUrl'. */\n+â”Š  â”Š47â”Š    // \"rootDirs\": [],                        /* List of root folders whose combined content represents the structure of the project at runtime. */\n+â”Š  â”Š48â”Š    // \"typeRoots\": [],                       /* List of folders to include type definitions from. */\n+â”Š  â”Š49â”Š    // \"types\": [],                           /* Type declaration files to be included in compilation. */\n+â”Š  â”Š50â”Š    // \"allowSyntheticDefaultImports\": true,  /* Allow default imports from modules with no default export. This does not affect code emit, just typechecking. */\n+â”Š  â”Š51â”Š    \"esModuleInterop\": true,                  /* Enables emit interoperability between CommonJS and ES Modules via creation of namespace objects for all imports. Implies 'allowSyntheticDefaultImports'. */\n+â”Š  â”Š52â”Š    // \"preserveSymlinks\": true,              /* Do not resolve the real path of symlinks. */\n+â”Š  â”Š53â”Š\n+â”Š  â”Š54â”Š    /* Source Map Options */\n+â”Š  â”Š55â”Š    // \"sourceRoot\": \"\",                      /* Specify the location where debugger should locate TypeScript files instead of source locations. */\n+â”Š  â”Š56â”Š    // \"mapRoot\": \"\",                         /* Specify the location where debugger should locate map files instead of generated locations. */\n+â”Š  â”Š57â”Š    // \"inlineSourceMap\": true,               /* Emit a single file with source maps instead of having a separate file. */\n+â”Š  â”Š58â”Š    // \"inlineSources\": true,                 /* Emit the source alongside the sourcemaps within a single file; requires '--inlineSourceMap' or '--sourceMap' to be set. */\n+â”Š  â”Š59â”Š\n+â”Š  â”Š60â”Š    /* Experimental Options */\n+â”Š  â”Š61â”Š    \"experimentalDecorators\": true,           /* Enables experimental support for ES7 decorators. */\n+â”Š  â”Š62â”Š    \"emitDecoratorMetadata\": true             /* Enables experimental support for emitting type metadata for decorators. */\n+â”Š  â”Š63â”Š  }\n+â”Š  â”Š64â”Š}\n```\n\n[}]: #\n\nWe will also set a script that will startup the server with `ts-node`, a TypeScript interpreter for Node.JS:\n\n```json\n{\n  \"start\": \"ts-node index.ts\"\n}\n```\n\nOur `pacakge.json` file should look like so by now:\n\n[{]: <helper> (diffStep 1.1 files=\"package.json\" module=\"server\")\n\n#### [Step 1.1: Setup TypeScript](https://github.com/Urigo/WhatsApp-Clone-Server/commit/9302e04)\n\n##### Changed package.json\n```diff\n@@ -4,5 +4,13 @@\n â”Š 4â”Š 4â”Š  \"repository\": {\n â”Š 5â”Š 5â”Š    \"type\": \"git\",\n â”Š 6â”Š 6â”Š    \"url\": \"https://Urigo@github.com/Urigo/WhatsApp-Clone-Server.git\"\n+â”Š  â”Š 7â”Š  },\n+â”Š  â”Š 8â”Š  \"scripts\": {\n+â”Š  â”Š 9â”Š    \"start\": \"ts-node index.ts\"\n+â”Š  â”Š10â”Š  },\n+â”Š  â”Š11â”Š  \"devDependencies\": {\n+â”Š  â”Š12â”Š    \"@types/node\": \"10.12.18\",\n+â”Š  â”Š13â”Š    \"ts-node\": \"8.0.1\",\n+â”Š  â”Š14â”Š    \"typescript\": \"3.2.4\"\n â”Š 7â”Š15â”Š  }\n â”Š 8â”Š16â”Š}\n```\n\n[}]: #\n\nIn our server we will be using [Express](https://expressjs.com/) to serve our GraphQL REST endpoint which will be handled by Apollo. Accordingly, let's install the necessary dependencies:\n\n    $ yarn add -D @types/body-parser@1.17.0 @types/cors@2.8.4 @types/express@4.16.0 @types/graphql@14.0.4\n    $ yarn add apollo-server-express@2.4.2 body-parser@1.18.3 cors@2.8.5 express@4.16.4 graphql@14.1.1\n\nAnd setup a basic express server with a `/graphql` REST endpoint:\n\n[{]: <helper> (diffStep 1.2 files=\"index.ts, schema\" module=\"server\")\n\n#### [Step 1.2: Setup a basic Express server with a GraphQL REST endpoint](https://github.com/Urigo/WhatsApp-Clone-Server/commit/6f524af)\n\n##### Added index.ts\n```diff\n@@ -0,0 +1,30 @@\n+â”Š  â”Š 1â”Šimport { ApolloServer } from 'apollo-server-express'\n+â”Š  â”Š 2â”Šimport bodyParser from 'body-parser'\n+â”Š  â”Š 3â”Šimport cors from 'cors'\n+â”Š  â”Š 4â”Šimport express from 'express'\n+â”Š  â”Š 5â”Šimport gql from 'graphql-tag'\n+â”Š  â”Š 6â”Šimport { createServer } from 'http'\n+â”Š  â”Š 7â”Šimport schema from './schema'\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Šconst PORT = 4000\n+â”Š  â”Š10â”Š\n+â”Š  â”Š11â”Šconst app = express()\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Šapp.use(cors())\n+â”Š  â”Š14â”Šapp.use(bodyParser.json())\n+â”Š  â”Š15â”Š\n+â”Š  â”Š16â”Šconst apollo = new ApolloServer({ schema })\n+â”Š  â”Š17â”Š\n+â”Š  â”Š18â”Šapollo.applyMiddleware({\n+â”Š  â”Š19â”Š  app,\n+â”Š  â”Š20â”Š  path: '/graphql',\n+â”Š  â”Š21â”Š})\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Š// Wrap the Express server\n+â”Š  â”Š24â”Šconst ws = createServer(app)\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Šapollo.installSubscriptionHandlers(ws)\n+â”Š  â”Š27â”Š\n+â”Š  â”Š28â”Šws.listen(PORT, () => {\n+â”Š  â”Š29â”Š  console.log(`Apollo Server is now running on http://localhost:${PORT}`)\n+â”Š  â”Š30â”Š})\n```\n\n##### Added schema&#x2F;index.ts\n```diff\n@@ -0,0 +1,8 @@\n+â”Š â”Š1â”Šimport { makeExecutableSchema } from 'apollo-server-express'\n+â”Š â”Š2â”Šimport resolvers from './resolvers'\n+â”Š â”Š3â”Šimport typeDefs from './typeDefs'\n+â”Š â”Š4â”Š\n+â”Š â”Š5â”Šexport default makeExecutableSchema({\n+â”Š â”Š6â”Š  typeDefs,\n+â”Š â”Š7â”Š  resolvers,\n+â”Š â”Š8â”Š})\n```\n\n##### Added schema&#x2F;resolvers.ts\n```diff\n@@ -0,0 +1,5 @@\n+â”Š â”Š1â”Šexport default {\n+â”Š â”Š2â”Š  Query: {\n+â”Š â”Š3â”Š    chats: () => [],\n+â”Š â”Š4â”Š  },\n+â”Š â”Š5â”Š}\n```\n\n##### Added schema&#x2F;typeDefs.ts\n```diff\n@@ -0,0 +1,9 @@\n+â”Š â”Š1â”Šexport default `\n+â”Š â”Š2â”Š  type Chat {\n+â”Š â”Š3â”Š    id: ID!\n+â”Š â”Š4â”Š  }\n+â”Š â”Š5â”Š\n+â”Š â”Š6â”Š  type Query {\n+â”Š â”Š7â”Š    chats: [Chat!]!\n+â”Š â”Š8â”Š  }\n+â”Š â”Š9â”Š`\n```\n\n[}]: #\n\nBefore we proceed any further there's an issue that needs to be clear. Since we're using TypeScript together with GraphQL, by default we will have to maintain 2 schemas: one for TypeScript and the other for GraphQL. Both schemas represent the same thing this way or another, which means that we will have to maintain the same thing twice. Instead of doing so, we will be using a tool called [GraphQL Code Generator](https://graphql-code-generator.com/) (Codegen, in short) to generate TypeScript definitions from our GraphQL schema.\n\nCodegen will change its behavior and generate code based on a set of templates and a configuration file that we will provide. We highly recommend you to go through the [docs page](https://graphql-code-generator.com/docs/getting-started/) of Codegen to get a better understanding of what it is and how it works. Let's install Codegen then, along with the templates that we're gonna use:\n\n    $ yarn -D add graphql-code-generator@0.16.1 graphql-codegen-typescript-common@0.16.1 graphql-codegen-typescript-resolvers@0.16.1\n\nAnd write its config under `codegen.yml` file:\n\n[{]: <helper> (diffStep 1.3 files=\"codegen.yml\" module=\"server\")\n\n#### [Step 1.3: Setup codegen](https://github.com/Urigo/WhatsApp-Clone-Server/commit/535995c)\n\n##### Added codegen.yml\n```diff\n@@ -0,0 +1,8 @@\n+â”Š â”Š1â”Šoverwrite: true\n+â”Š â”Š2â”Šschema: ./schema/typeDefs.ts\n+â”Š â”Š3â”Šrequire: ts-node/register/transpile-only\n+â”Š â”Š4â”Šgenerates:\n+â”Š â”Š5â”Š  ./types.d.ts:\n+â”Š â”Š6â”Š    plugins:\n+â”Š â”Š7â”Š      - typescript-common\n+â”Š â”Š8â”Š      - typescript-resolvers\n```\n\n[}]: #\n\nWe will also update the `.gitignore` file to exclude the generated typings file:\n\n[{]: <helper> (diffStep 1.3 files=\".gitignore\" module=\"server\")\n\n#### [Step 1.3: Setup codegen](https://github.com/Urigo/WhatsApp-Clone-Server/commit/535995c)\n\n##### Changed .gitignore\n```diff\n@@ -1,2 +1,3 @@\n â”Š1â”Š1â”Šnode_modules\n-â”Š2â”Š â”Šnpm-debug.logðŸš«â†µ\n+â”Š â”Š2â”Šnpm-debug.log\n+â”Š â”Š3â”Štypes.d.ts\n```\n\n[}]: #\n\nTo make things easy, we will add a code generation command in our `package.json` so we can have it available to us whenever we need it. First we will add few utility packages that are necessary for the task:\n\n    $ yarn -D add nodemon@1.18.9 concurrently@4.1.0\n\nAnd we will update the scripts section in the `package.json` file to look like so:\n\n```json\n{\n  \"generate\": \"gql-gen\",\n  \"generate:watch\": \"nodemon --exec yarn generate -e graphql\",\n  \"start:server\": \"ts-node index.ts\",\n  \"start:server:watch\": \"nodemon --exec yarn start:server -e ts\",\n  \"dev\": \"concurrently \\\"yarn generate:watch\\\" \\\"yarn start:server:watch\\\"\",\n  \"start\": \"yarn generate && yarn start:server\"\n}\n```\n\nThe `package.json` file should look like so by now:\n\n[{]: <helper> (diffStep 1.3 files=\"package.json\" module=\"server\")\n\n#### [Step 1.3: Setup codegen](https://github.com/Urigo/WhatsApp-Clone-Server/commit/535995c)\n\n##### Changed package.json\n```diff\n@@ -6,7 +6,12 @@\n â”Š 6â”Š 6â”Š    \"url\": \"https://Urigo@github.com/Urigo/WhatsApp-Clone-Server.git\"\n â”Š 7â”Š 7â”Š  },\n â”Š 8â”Š 8â”Š  \"scripts\": {\n-â”Š 9â”Š  â”Š    \"start\": \"ts-node index.ts\"\n+â”Š  â”Š 9â”Š    \"generate\": \"gql-gen\",\n+â”Š  â”Š10â”Š    \"generate:watch\": \"nodemon --exec yarn generate -e graphql\",\n+â”Š  â”Š11â”Š    \"start:server\": \"ts-node index.ts\",\n+â”Š  â”Š12â”Š    \"start:server:watch\": \"nodemon --exec yarn start:server -e ts\",\n+â”Š  â”Š13â”Š    \"dev\": \"concurrently \\\"yarn generate:watch\\\" \\\"yarn start:server:watch\\\"\",\n+â”Š  â”Š14â”Š    \"start\": \"yarn generate && yarn start:server\"\n â”Š10â”Š15â”Š  },\n â”Š11â”Š16â”Š  \"devDependencies\": {\n â”Š12â”Š17â”Š    \"@types/body-parser\": \"1.17.0\",\n```\n```diff\n@@ -14,6 +19,11 @@\n â”Š14â”Š19â”Š    \"@types/express\": \"4.16.0\",\n â”Š15â”Š20â”Š    \"@types/graphql\": \"14.0.4\",\n â”Š16â”Š21â”Š    \"@types/node\": \"10.12.18\",\n+â”Š  â”Š22â”Š    \"concurrently\": \"4.1.0\",\n+â”Š  â”Š23â”Š    \"graphql-code-generator\": \"0.16.0\",\n+â”Š  â”Š24â”Š    \"graphql-codegen-typescript-common\": \"0.16.0\",\n+â”Š  â”Š25â”Š    \"graphql-codegen-typescript-resolvers\": \"^0.16.1\",\n+â”Š  â”Š26â”Š    \"nodemon\": \"1.18.9\",\n â”Š17â”Š27â”Š    \"ts-node\": \"8.0.1\",\n â”Š18â”Š28â”Š    \"typescript\": \"3.2.4\"\n â”Š19â”Š29â”Š  },\n```\n\n[}]: #\n\nTo generate some TypeScript definitions all we have to do is run:\n\n    $ yarn generate\n\nAnd then we can safely run the server with:\n\n    $ yarn start\n\nAlternatively, you can run the server and watch for changes with the following command:\n\n    $ yarn start:server:watch\n\nFor practice purpose only, we're gonna serve some dummy data from our GraphQL API so we can have something to work with in our client. Later on we will connect everything to a real database. This would give us an easy start. Our dummy db will consist of a set of chats, each of them has a last message, a picture and a name:\n\n[{]: <helper> (diffStep 1.4 files=\"index.ts, db.ts, entity, schema, codegen.yml\" module=\"server\")\n\n#### [Step 1.4: Add fake DB](https://github.com/Urigo/WhatsApp-Clone-Server/commit/3223310)\n\n##### Changed codegen.yml\n```diff\n@@ -6,3 +6,9 @@\n â”Š 6â”Š 6â”Š    plugins:\n â”Š 7â”Š 7â”Š      - typescript-common\n â”Š 8â”Š 8â”Š      - typescript-resolvers\n+â”Š  â”Š 9â”Š    config:\n+â”Š  â”Š10â”Š      optionalType: undefined | null\n+â”Š  â”Š11â”Š      mappers:\n+â”Š  â”Š12â”Š        Chat: ./entity/chat#Chat\n+â”Š  â”Š13â”Š        Message: ./entity/message#Message\n+â”Š  â”Š14â”Š        User: ./entity/user#User\n```\n\n##### Added db.ts\n```diff\n@@ -0,0 +1,274 @@\n+â”Š   â”Š  1â”Šimport moment from 'moment'\n+â”Š   â”Š  2â”Šimport Chat from './entity/chat'\n+â”Š   â”Š  3â”Šimport Message, { MessageType } from './entity/message'\n+â”Š   â”Š  4â”Šimport User from './entity/user'\n+â”Š   â”Š  5â”Š\n+â”Š   â”Š  6â”Šconst users: User[] = [\n+â”Š   â”Š  7â”Š  {\n+â”Š   â”Š  8â”Š    id: '1',\n+â”Š   â”Š  9â”Š    username: 'ethan',\n+â”Š   â”Š 10â”Š    password: '$2a$08$NO9tkFLCoSqX1c5wk3s7z.JfxaVMKA.m7zUDdDwEquo4rvzimQeJm', // 111\n+â”Š   â”Š 11â”Š    name: 'Ethan Gonzalez',\n+â”Š   â”Š 12â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n+â”Š   â”Š 13â”Š  },\n+â”Š   â”Š 14â”Š  {\n+â”Š   â”Š 15â”Š    id: '2',\n+â”Š   â”Š 16â”Š    username: 'bryan',\n+â”Š   â”Š 17â”Š    password: '$2a$08$xE4FuCi/ifxjL2S8CzKAmuKLwv18ktksSN.F3XYEnpmcKtpbpeZgO', // 222\n+â”Š   â”Š 18â”Š    name: 'Bryan Wallace',\n+â”Š   â”Š 19â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n+â”Š   â”Š 20â”Š  },\n+â”Š   â”Š 21â”Š  {\n+â”Š   â”Š 22â”Š    id: '3',\n+â”Š   â”Š 23â”Š    username: 'avery',\n+â”Š   â”Š 24â”Š    password: '$2a$08$UHgH7J8G6z1mGQn2qx2kdeWv0jvgHItyAsL9hpEUI3KJmhVW5Q1d.', // 333\n+â”Š   â”Š 25â”Š    name: 'Avery Stewart',\n+â”Š   â”Š 26â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n+â”Š   â”Š 27â”Š  },\n+â”Š   â”Š 28â”Š  {\n+â”Š   â”Š 29â”Š    id: '4',\n+â”Š   â”Š 30â”Š    username: 'katie',\n+â”Š   â”Š 31â”Š    password: '$2a$08$wR1k5Q3T9FC7fUgB7Gdb9Os/GV7dGBBf4PLlWT7HERMFhmFDt47xi', // 444\n+â”Š   â”Š 32â”Š    name: 'Katie Peterson',\n+â”Š   â”Š 33â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n+â”Š   â”Š 34â”Š  },\n+â”Š   â”Š 35â”Š  {\n+â”Š   â”Š 36â”Š    id: '5',\n+â”Š   â”Š 37â”Š    username: 'ray',\n+â”Š   â”Š 38â”Š    password: '$2a$08$6.mbXqsDX82ZZ7q5d8Osb..JrGSsNp4R3IKj7mxgF6YGT0OmMw242', // 555\n+â”Š   â”Š 39â”Š    name: 'Ray Edwards',\n+â”Š   â”Š 40â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/3.jpg',\n+â”Š   â”Š 41â”Š  },\n+â”Š   â”Š 42â”Š  {\n+â”Š   â”Š 43â”Š    id: '6',\n+â”Š   â”Š 44â”Š    username: 'niko',\n+â”Š   â”Š 45â”Š    password: '$2a$08$fL5lZR.Rwf9FWWe8XwwlceiPBBim8n9aFtaem.INQhiKT4.Ux3Uq.', // 666\n+â”Š   â”Š 46â”Š    name: 'NiccolÃ² Belli',\n+â”Š   â”Š 47â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/4.jpg',\n+â”Š   â”Š 48â”Š  },\n+â”Š   â”Š 49â”Š  {\n+â”Š   â”Š 50â”Š    id: '7',\n+â”Š   â”Š 51â”Š    username: 'mario',\n+â”Š   â”Š 52â”Š    password: '$2a$08$nDHDmWcVxDnH5DDT3HMMC.psqcnu6wBiOgkmJUy9IH..qxa3R6YrO', // 777\n+â”Š   â”Š 53â”Š    name: 'Mario Rossi',\n+â”Š   â”Š 54â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/5.jpg',\n+â”Š   â”Š 55â”Š  },\n+â”Š   â”Š 56â”Š]\n+â”Š   â”Š 57â”Š\n+â”Š   â”Š 58â”Šconst chats: Chat[] = [\n+â”Š   â”Š 59â”Š  {\n+â”Š   â”Š 60â”Š    id: '1',\n+â”Š   â”Š 61â”Š    name: null,\n+â”Š   â”Š 62â”Š    picture: null,\n+â”Š   â”Š 63â”Š    allTimeMemberIds: ['1', '3'],\n+â”Š   â”Š 64â”Š    listingMemberIds: ['1', '3'],\n+â”Š   â”Š 65â”Š    ownerId: null,\n+â”Š   â”Š 66â”Š    messages: [\n+â”Š   â”Š 67â”Š      {\n+â”Š   â”Š 68â”Š        id: '1',\n+â”Š   â”Š 69â”Š        chatId: '1',\n+â”Š   â”Š 70â”Š        senderId: '1',\n+â”Š   â”Š 71â”Š        content: 'You on your way?',\n+â”Š   â”Š 72â”Š        createdAt: moment()\n+â”Š   â”Š 73â”Š          .subtract(1, 'hours')\n+â”Š   â”Š 74â”Š          .unix(),\n+â”Š   â”Š 75â”Š        type: MessageType.TEXT,\n+â”Š   â”Š 76â”Š        holderIds: ['1', '3'],\n+â”Š   â”Š 77â”Š      },\n+â”Š   â”Š 78â”Š      {\n+â”Š   â”Š 79â”Š        id: '2',\n+â”Š   â”Š 80â”Š        chatId: '1',\n+â”Š   â”Š 81â”Š        senderId: '3',\n+â”Š   â”Š 82â”Š        content: 'Yep!',\n+â”Š   â”Š 83â”Š        createdAt: moment()\n+â”Š   â”Š 84â”Š          .subtract(1, 'hours')\n+â”Š   â”Š 85â”Š          .add(5, 'minutes')\n+â”Š   â”Š 86â”Š          .unix(),\n+â”Š   â”Š 87â”Š        type: MessageType.TEXT,\n+â”Š   â”Š 88â”Š        holderIds: ['3', '1'],\n+â”Š   â”Š 89â”Š      },\n+â”Š   â”Š 90â”Š    ],\n+â”Š   â”Š 91â”Š  },\n+â”Š   â”Š 92â”Š  {\n+â”Š   â”Š 93â”Š    id: '2',\n+â”Š   â”Š 94â”Š    name: null,\n+â”Š   â”Š 95â”Š    picture: null,\n+â”Š   â”Š 96â”Š    allTimeMemberIds: ['1', '4'],\n+â”Š   â”Š 97â”Š    listingMemberIds: ['1', '4'],\n+â”Š   â”Š 98â”Š    ownerId: null,\n+â”Š   â”Š 99â”Š    messages: [\n+â”Š   â”Š100â”Š      {\n+â”Š   â”Š101â”Š        id: '1',\n+â”Š   â”Š102â”Š        chatId: '2',\n+â”Š   â”Š103â”Š        senderId: '1',\n+â”Š   â”Š104â”Š        content: \"Hey, it's me\",\n+â”Š   â”Š105â”Š        createdAt: moment()\n+â”Š   â”Š106â”Š          .subtract(2, 'hours')\n+â”Š   â”Š107â”Š          .unix(),\n+â”Š   â”Š108â”Š        type: MessageType.TEXT,\n+â”Š   â”Š109â”Š        holderIds: ['1', '4'],\n+â”Š   â”Š110â”Š      },\n+â”Š   â”Š111â”Š    ],\n+â”Š   â”Š112â”Š  },\n+â”Š   â”Š113â”Š  {\n+â”Š   â”Š114â”Š    id: '3',\n+â”Š   â”Š115â”Š    name: null,\n+â”Š   â”Š116â”Š    picture: null,\n+â”Š   â”Š117â”Š    allTimeMemberIds: ['1', '5'],\n+â”Š   â”Š118â”Š    listingMemberIds: ['1', '5'],\n+â”Š   â”Š119â”Š    ownerId: null,\n+â”Š   â”Š120â”Š    messages: [\n+â”Š   â”Š121â”Š      {\n+â”Š   â”Š122â”Š        id: '1',\n+â”Š   â”Š123â”Š        chatId: '3',\n+â”Š   â”Š124â”Š        senderId: '1',\n+â”Š   â”Š125â”Š        content: 'I should buy a boat',\n+â”Š   â”Š126â”Š        createdAt: moment()\n+â”Š   â”Š127â”Š          .subtract(1, 'days')\n+â”Š   â”Š128â”Š          .unix(),\n+â”Š   â”Š129â”Š        type: MessageType.TEXT,\n+â”Š   â”Š130â”Š        holderIds: ['1', '5'],\n+â”Š   â”Š131â”Š      },\n+â”Š   â”Š132â”Š      {\n+â”Š   â”Š133â”Š        id: '2',\n+â”Š   â”Š134â”Š        chatId: '3',\n+â”Š   â”Š135â”Š        senderId: '1',\n+â”Š   â”Š136â”Š        content: 'You still there?',\n+â”Š   â”Š137â”Š        createdAt: moment()\n+â”Š   â”Š138â”Š          .subtract(1, 'days')\n+â”Š   â”Š139â”Š          .add(16, 'hours')\n+â”Š   â”Š140â”Š          .unix(),\n+â”Š   â”Š141â”Š        type: MessageType.TEXT,\n+â”Š   â”Š142â”Š        holderIds: ['1', '5'],\n+â”Š   â”Š143â”Š      },\n+â”Š   â”Š144â”Š    ],\n+â”Š   â”Š145â”Š  },\n+â”Š   â”Š146â”Š  {\n+â”Š   â”Š147â”Š    id: '4',\n+â”Š   â”Š148â”Š    name: null,\n+â”Š   â”Š149â”Š    picture: null,\n+â”Š   â”Š150â”Š    allTimeMemberIds: ['3', '4'],\n+â”Š   â”Š151â”Š    listingMemberIds: ['3', '4'],\n+â”Š   â”Š152â”Š    ownerId: null,\n+â”Š   â”Š153â”Š    messages: [\n+â”Š   â”Š154â”Š      {\n+â”Š   â”Š155â”Š        id: '1',\n+â”Š   â”Š156â”Š        chatId: '4',\n+â”Š   â”Š157â”Š        senderId: '3',\n+â”Š   â”Š158â”Š        content: 'Look at my mukluks!',\n+â”Š   â”Š159â”Š        createdAt: moment()\n+â”Š   â”Š160â”Š          .subtract(4, 'days')\n+â”Š   â”Š161â”Š          .unix(),\n+â”Š   â”Š162â”Š        type: MessageType.TEXT,\n+â”Š   â”Š163â”Š        holderIds: ['3', '4'],\n+â”Š   â”Š164â”Š      },\n+â”Š   â”Š165â”Š    ],\n+â”Š   â”Š166â”Š  },\n+â”Š   â”Š167â”Š  {\n+â”Š   â”Š168â”Š    id: '5',\n+â”Š   â”Š169â”Š    name: null,\n+â”Š   â”Š170â”Š    picture: null,\n+â”Š   â”Š171â”Š    allTimeMemberIds: ['2', '5'],\n+â”Š   â”Š172â”Š    listingMemberIds: ['2', '5'],\n+â”Š   â”Š173â”Š    ownerId: null,\n+â”Š   â”Š174â”Š    messages: [\n+â”Š   â”Š175â”Š      {\n+â”Š   â”Š176â”Š        id: '1',\n+â”Š   â”Š177â”Š        chatId: '5',\n+â”Š   â”Š178â”Š        senderId: '2',\n+â”Š   â”Š179â”Š        content: 'This is wicked good ice cream.',\n+â”Š   â”Š180â”Š        createdAt: moment()\n+â”Š   â”Š181â”Š          .subtract(2, 'weeks')\n+â”Š   â”Š182â”Š          .unix(),\n+â”Š   â”Š183â”Š        type: MessageType.TEXT,\n+â”Š   â”Š184â”Š        holderIds: ['2', '5'],\n+â”Š   â”Š185â”Š      },\n+â”Š   â”Š186â”Š      {\n+â”Š   â”Š187â”Š        id: '2',\n+â”Š   â”Š188â”Š        chatId: '6',\n+â”Š   â”Š189â”Š        senderId: '5',\n+â”Š   â”Š190â”Š        content: 'Love it!',\n+â”Š   â”Š191â”Š        createdAt: moment()\n+â”Š   â”Š192â”Š          .subtract(2, 'weeks')\n+â”Š   â”Š193â”Š          .add(10, 'minutes')\n+â”Š   â”Š194â”Š          .unix(),\n+â”Š   â”Š195â”Š        type: MessageType.TEXT,\n+â”Š   â”Š196â”Š        holderIds: ['5', '2'],\n+â”Š   â”Š197â”Š      },\n+â”Š   â”Š198â”Š    ],\n+â”Š   â”Š199â”Š  },\n+â”Š   â”Š200â”Š  {\n+â”Š   â”Š201â”Š    id: '6',\n+â”Š   â”Š202â”Š    name: null,\n+â”Š   â”Š203â”Š    picture: null,\n+â”Š   â”Š204â”Š    allTimeMemberIds: ['1', '6'],\n+â”Š   â”Š205â”Š    listingMemberIds: ['1'],\n+â”Š   â”Š206â”Š    ownerId: null,\n+â”Š   â”Š207â”Š    messages: [],\n+â”Š   â”Š208â”Š  },\n+â”Š   â”Š209â”Š  {\n+â”Š   â”Š210â”Š    id: '7',\n+â”Š   â”Š211â”Š    name: null,\n+â”Š   â”Š212â”Š    picture: null,\n+â”Š   â”Š213â”Š    allTimeMemberIds: ['2', '1'],\n+â”Š   â”Š214â”Š    listingMemberIds: ['2'],\n+â”Š   â”Š215â”Š    ownerId: null,\n+â”Š   â”Š216â”Š    messages: [],\n+â”Š   â”Š217â”Š  },\n+â”Š   â”Š218â”Š  {\n+â”Š   â”Š219â”Š    id: '8',\n+â”Š   â”Š220â”Š    name: 'A user 0 group',\n+â”Š   â”Š221â”Š    picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n+â”Š   â”Š222â”Š    allTimeMemberIds: ['1', '3', '4', '6'],\n+â”Š   â”Š223â”Š    listingMemberIds: ['1', '3', '4', '6'],\n+â”Š   â”Š224â”Š    ownerId: '1',\n+â”Š   â”Š225â”Š    messages: [\n+â”Š   â”Š226â”Š      {\n+â”Š   â”Š227â”Š        id: '1',\n+â”Š   â”Š228â”Š        chatId: '8',\n+â”Š   â”Š229â”Š        senderId: '1',\n+â”Š   â”Š230â”Š        content: 'I made a group',\n+â”Š   â”Š231â”Š        createdAt: moment()\n+â”Š   â”Š232â”Š          .subtract(2, 'weeks')\n+â”Š   â”Š233â”Š          .unix(),\n+â”Š   â”Š234â”Š        type: MessageType.TEXT,\n+â”Š   â”Š235â”Š        holderIds: ['1', '3', '4', '6'],\n+â”Š   â”Š236â”Š      },\n+â”Š   â”Š237â”Š      {\n+â”Š   â”Š238â”Š        id: '2',\n+â”Š   â”Š239â”Š        chatId: '8',\n+â”Š   â”Š240â”Š        senderId: '1',\n+â”Š   â”Š241â”Š        content: 'Ops, user 3 was not supposed to be here',\n+â”Š   â”Š242â”Š        createdAt: moment()\n+â”Š   â”Š243â”Š          .subtract(2, 'weeks')\n+â”Š   â”Š244â”Š          .add(2, 'minutes')\n+â”Š   â”Š245â”Š          .unix(),\n+â”Š   â”Š246â”Š        type: MessageType.TEXT,\n+â”Š   â”Š247â”Š        holderIds: ['1', '4', '6'],\n+â”Š   â”Š248â”Š      },\n+â”Š   â”Š249â”Š      {\n+â”Š   â”Š250â”Š        id: '3',\n+â”Š   â”Š251â”Š        chatId: '8',\n+â”Š   â”Š252â”Š        senderId: '4',\n+â”Š   â”Š253â”Š        content: 'Awesome!',\n+â”Š   â”Š254â”Š        createdAt: moment()\n+â”Š   â”Š255â”Š          .subtract(2, 'weeks')\n+â”Š   â”Š256â”Š          .add(10, 'minutes')\n+â”Š   â”Š257â”Š          .unix(),\n+â”Š   â”Š258â”Š        type: MessageType.TEXT,\n+â”Š   â”Š259â”Š        holderIds: ['1', '4', '6'],\n+â”Š   â”Š260â”Š      },\n+â”Š   â”Š261â”Š    ],\n+â”Š   â”Š262â”Š  },\n+â”Š   â”Š263â”Š  {\n+â”Š   â”Š264â”Š    id: '9',\n+â”Š   â”Š265â”Š    name: 'A user 5 group',\n+â”Š   â”Š266â”Š    picture: null,\n+â”Š   â”Š267â”Š    allTimeMemberIds: ['6', '3'],\n+â”Š   â”Š268â”Š    listingMemberIds: ['6', '3'],\n+â”Š   â”Š269â”Š    ownerId: '6',\n+â”Š   â”Š270â”Š    messages: [],\n+â”Š   â”Š271â”Š  },\n+â”Š   â”Š272â”Š]\n+â”Š   â”Š273â”Š\n+â”Š   â”Š274â”Šexport default { users, chats }\n```\n\n##### Added entity&#x2F;chat.ts\n```diff\n@@ -0,0 +1,18 @@\n+â”Š  â”Š 1â”Šimport Message from './message'\n+â”Š  â”Š 2â”Š\n+â”Š  â”Š 3â”Šexport interface Chat {\n+â”Š  â”Š 4â”Š  id: string\n+â”Š  â”Š 5â”Š  name?: string | null\n+â”Š  â”Š 6â”Š  picture?: string | null\n+â”Š  â”Š 7â”Š  // All members, current and past ones.\n+â”Š  â”Š 8â”Š  allTimeMemberIds: string[]\n+â”Š  â”Š 9â”Š  // Whoever gets the chat listed. For groups includes past members who still didn't delete the group.\n+â”Š  â”Š10â”Š  listingMemberIds: string[]\n+â”Š  â”Š11â”Š  // Actual members of the group (they are not the only ones who get the group listed). Null for chats.\n+â”Š  â”Š12â”Š  actualGroupMemberIds?: string[] | null\n+â”Š  â”Š13â”Š  adminIds?: string[] | null\n+â”Š  â”Š14â”Š  ownerId?: string | null\n+â”Š  â”Š15â”Š  messages: Message[]\n+â”Š  â”Š16â”Š}\n+â”Š  â”Š17â”Š\n+â”Š  â”Š18â”Šexport default Chat\n```\n\n##### Added entity&#x2F;message.ts\n```diff\n@@ -0,0 +1,20 @@\n+â”Š  â”Š 1â”Šimport Recipient from './recipient'\n+â”Š  â”Š 2â”Š\n+â”Š  â”Š 3â”Šexport enum MessageType {\n+â”Š  â”Š 4â”Š  PICTURE,\n+â”Š  â”Š 5â”Š  TEXT,\n+â”Š  â”Š 6â”Š  LOCATION,\n+â”Š  â”Š 7â”Š}\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Šexport interface Message {\n+â”Š  â”Š10â”Š  id: string\n+â”Š  â”Š11â”Š  chatId: string\n+â”Š  â”Š12â”Š  senderId: string\n+â”Š  â”Š13â”Š  content: string\n+â”Š  â”Š14â”Š  createdAt: number\n+â”Š  â”Š15â”Š  type: MessageType\n+â”Š  â”Š16â”Š  recipients: Recipient[]\n+â”Š  â”Š17â”Š  holderIds: string[]\n+â”Š  â”Š18â”Š}\n+â”Š  â”Š19â”Š\n+â”Š  â”Š20â”Šexport default Message\n```\n\n##### Added entity&#x2F;user.ts\n```diff\n@@ -0,0 +1,10 @@\n+â”Š  â”Š 1â”Šexport interface User {\n+â”Š  â”Š 2â”Š  id: string\n+â”Š  â”Š 3â”Š  username: string\n+â”Š  â”Š 4â”Š  password: string\n+â”Š  â”Š 5â”Š  name: string\n+â”Š  â”Š 6â”Š  picture?: string | null\n+â”Š  â”Š 7â”Š  phone?: string | null\n+â”Š  â”Š 8â”Š}\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Šexport default User\n```\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,5 +1,83 @@\n+â”Š  â”Š 1â”Šimport { IResolvers as IApolloResolvers } from 'apollo-server-express'\n+â”Š  â”Š 2â”Šimport { GraphQLDateTime } from 'graphql-iso-date'\n+â”Š  â”Š 3â”Šimport db from '../db'\n+â”Š  â”Š 4â”Šimport Chat from '../entity/chat'\n+â”Š  â”Š 5â”Šimport Message from '../entity/message'\n+â”Š  â”Š 6â”Šimport Recipient from '../entity/recipient'\n+â”Š  â”Š 7â”Šimport User from '../entity/user'\n+â”Š  â”Š 8â”Šimport { IResolvers } from '../types'\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Šlet users = db.users\n+â”Š  â”Š11â”Šlet chats = db.chats\n+â”Š  â”Š12â”Šconst currentUser: string = '1'\n+â”Š  â”Š13â”Š\n â”Š 1â”Š14â”Šexport default {\n+â”Š  â”Š15â”Š  Date: GraphQLDateTime,\n â”Š 2â”Š16â”Š  Query: {\n-â”Š 3â”Š  â”Š    chats: () => [],\n+â”Š  â”Š17â”Š    // Show all users for the moment.\n+â”Š  â”Š18â”Š    users: () => users.filter(user => user.id !== currentUser),\n+â”Š  â”Š19â”Š    chats: () => chats.filter(chat => chat.listingMemberIds.includes(currentUser)),\n+â”Š  â”Š20â”Š    chat: (obj, { chatId }) => chats.find(chat => chat.id === chatId) || null,\n â”Š 4â”Š21â”Š  },\n-â”Š 5â”Š  â”Š}\n+â”Š  â”Š22â”Š  Chat: {\n+â”Š  â”Š23â”Š    name: (chat) =>\n+â”Š  â”Š24â”Š      chat.name\n+â”Š  â”Š25â”Š        ? chat.name\n+â”Š  â”Š26â”Š        : users.find(\n+â”Š  â”Š27â”Š            user => user.id === chat.allTimeMemberIds.find((userId: string) => userId !== currentUser)\n+â”Š  â”Š28â”Š          )!.name,\n+â”Š  â”Š29â”Š    picture: (chat) =>\n+â”Š  â”Š30â”Š      chat.name\n+â”Š  â”Š31â”Š        ? chat.picture\n+â”Š  â”Š32â”Š        : users.find(\n+â”Š  â”Š33â”Š            user => user.id === chat.allTimeMemberIds.find((userId: string) => userId !== currentUser)\n+â”Š  â”Š34â”Š          )!.picture,\n+â”Š  â”Š35â”Š    allTimeMembers: (chat) =>\n+â”Š  â”Š36â”Š      users.filter(user => chat.allTimeMemberIds.includes(user.id)),\n+â”Š  â”Š37â”Š    listingMembers: (chat) =>\n+â”Š  â”Š38â”Š      users.filter(user => chat.listingMemberIds.includes(user.id)),\n+â”Š  â”Š39â”Š    actualGroupMembers: (chat) =>\n+â”Š  â”Š40â”Š      users.filter(\n+â”Š  â”Š41â”Š        user => chat.actualGroupMemberIds && chat.actualGroupMemberIds.includes(user.id)\n+â”Š  â”Š42â”Š      ),\n+â”Š  â”Š43â”Š    admins: (chat) =>\n+â”Š  â”Š44â”Š      users.filter(user => chat.adminIds && chat.adminIds.includes(user.id)),\n+â”Š  â”Š45â”Š    owner: (chat) => users.find(user => chat.ownerId === user.id) || null,\n+â”Š  â”Š46â”Š    messages: (chat, { amount = 0 }) => {\n+â”Š  â”Š47â”Š      const messages =\n+â”Š  â”Š48â”Š        chat.messages\n+â”Š  â”Š49â”Š          .filter((message: Message) => message.holderIds.includes(currentUser))\n+â”Š  â”Š50â”Š          .sort((a: Message, b: Message) => b.createdAt - a.createdAt) || []\n+â”Š  â”Š51â”Š      return (amount ? messages.slice(0, amount) : messages).reverse()\n+â”Š  â”Š52â”Š    },\n+â”Š  â”Š53â”Š    unreadMessages: (chat) =>\n+â”Š  â”Š54â”Š      chat.messages.filter(\n+â”Š  â”Š55â”Š        (message: Message) =>\n+â”Š  â”Š56â”Š          message.holderIds.includes(currentUser) &&\n+â”Š  â”Š57â”Š          message.recipients.find(\n+â”Š  â”Š58â”Š            (recipient: Recipient) => recipient.userId === currentUser && !recipient.readAt\n+â”Š  â”Š59â”Š          )\n+â”Š  â”Š60â”Š      ).length,\n+â”Š  â”Š61â”Š    lastMessage: (chat) => chat.messages[chat.messages.length - 1],\n+â”Š  â”Š62â”Š    isGroup: (chat) => !!chat.name,\n+â”Š  â”Š63â”Š  },\n+â”Š  â”Š64â”Š  Message: {\n+â”Š  â”Š65â”Š    chat: (message) =>\n+â”Š  â”Š66â”Š      chats.find(chat => message.chatId === chat.id) || null,\n+â”Š  â”Š67â”Š    sender: (message) =>\n+â”Š  â”Š68â”Š      users.find(user => user.id === message.senderId) || null,\n+â”Š  â”Š69â”Š    holders: (message) =>\n+â”Š  â”Š70â”Š      users.filter(user => message.holderIds.includes(user.id)),\n+â”Š  â”Š71â”Š    ownership: (message) => message.senderId === currentUser,\n+â”Š  â”Š72â”Š  },\n+â”Š  â”Š73â”Š  Recipient: {\n+â”Š  â”Š74â”Š    user: (recipient) =>\n+â”Š  â”Š75â”Š      users.find(user => recipient.userId === user.id) || null,\n+â”Š  â”Š76â”Š    message: (recipient) => {\n+â”Š  â”Š77â”Š      const chat = chats.find(chat => recipient.chatId === chat.id)\n+â”Š  â”Š78â”Š      return chat ? chat.messages.find(message => recipient.messageId === message.id) || null : null\n+â”Š  â”Š79â”Š    },\n+â”Š  â”Š80â”Š    chat: (recipient) =>\n+â”Š  â”Š81â”Š      chats.find(chat => recipient.chatId === chat.id) || null,\n+â”Š  â”Š82â”Š  },\n+â”Š  â”Š83â”Š} as IResolvers as IApolloResolvers\n```\n\n##### Changed schema&#x2F;typeDefs.ts\n```diff\n@@ -1,9 +1,54 @@\n â”Š 1â”Š 1â”Šexport default `\n+â”Š  â”Š 2â”Š  scalar Date\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Š  type Query {\n+â”Š  â”Š 5â”Š    users: [User!]\n+â”Š  â”Š 6â”Š    chats: [Chat!]\n+â”Š  â”Š 7â”Š    chat(chatId: ID!): Chat\n+â”Š  â”Š 8â”Š  }\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Š  enum MessageType {\n+â”Š  â”Š11â”Š    LOCATION\n+â”Š  â”Š12â”Š    TEXT\n+â”Š  â”Š13â”Š    PICTURE\n+â”Š  â”Š14â”Š  }\n+â”Š  â”Š15â”Š\n â”Š 2â”Š16â”Š  type Chat {\n+â”Š  â”Š17â”Š    #May be a chat or a group\n â”Š 3â”Š18â”Š    id: ID!\n+â”Š  â”Š19â”Š    #Computed for chats\n+â”Š  â”Š20â”Š    name: String\n+â”Š  â”Š21â”Š    updatedAt: Date\n+â”Š  â”Š22â”Š    #Computed for chats\n+â”Š  â”Š23â”Š    picture: String\n+â”Š  â”Š24â”Š    #All members, current and past ones.\n+â”Š  â”Š25â”Š    allTimeMembers: [User!]!\n+â”Š  â”Š26â”Š    #Whoever gets the chat listed. For groups includes past members who still didn't delete the group.\n+â”Š  â”Š27â”Š    listingMembers: [User!]!\n+â”Š  â”Š28â”Š    #If null the group is read-only. Null for chats.\n+â”Š  â”Š29â”Š    owner: User\n+â”Š  â”Š30â”Š    messages(amount: Int): [Message]!\n+â”Š  â”Š31â”Š    lastMessage: Message\n â”Š 4â”Š32â”Š  }\n â”Š 5â”Š33â”Š\n-â”Š 6â”Š  â”Š  type Query {\n-â”Š 7â”Š  â”Š    chats: [Chat!]!\n+â”Š  â”Š34â”Š  type Message {\n+â”Š  â”Š35â”Š    id: ID!\n+â”Š  â”Š36â”Š    sender: User!\n+â”Š  â”Š37â”Š    chat: Chat!\n+â”Š  â”Š38â”Š    content: String!\n+â”Š  â”Š39â”Š    createdAt: Date!\n+â”Š  â”Š40â”Š    #FIXME: should return MessageType\n+â”Š  â”Š41â”Š    type: Int!\n+â”Š  â”Š42â”Š    #Whoever still holds a copy of the message. Cannot be null because the message gets deleted otherwise\n+â”Š  â”Š43â”Š    holders: [User!]!\n+â”Š  â”Š44â”Š    #Computed property\n+â”Š  â”Š45â”Š    ownership: Boolean!\n+â”Š  â”Š46â”Š  }\n+â”Š  â”Š47â”Š\n+â”Š  â”Š48â”Š  type User {\n+â”Š  â”Š49â”Š    id: ID!\n+â”Š  â”Š50â”Š    name: String\n+â”Š  â”Š51â”Š    picture: String\n+â”Š  â”Š52â”Š    phone: String\n â”Š 8â”Š53â”Š  }\n â”Š 9â”Š54â”Š`\n```\n\n[}]: #\n\nAs you can see, we've added an `entity` folder which treats each entity independently. This will server us greatly is the new future when we will connect each entity to a database. The GraphQL resolvers are the \"projectors\" of the data stored in the fake DB, and they will serve it based on their implementation and provided parameters.\n\nNow, let's make the necessary modifications to our client so it can work alongside the server and show the data that it contains. Similarly to the server, we don't wanna maintain a TypeScript code base for our GraphQL documents, therefore we will install Codegen for the client as well. Let's install the necessary NPM packages:\n\n    $ yarn add -D graphql-code-generator@0.16.1 graphql-codegen-typescript-client@0.16.1 graphql-codegen-typescript-common@0.16.1\n\nWrite a Codegen config:\n\n[{]: <helper> (diffStep 1.4 files=\"codegen.yml, codegen-interpreter.ts\" module=\"client\")\n\n#### [Step 1.4: Setup codegen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/16bdab6)\n\n##### Added codegen-interpreter.ts\n```diff\n@@ -0,0 +1,6 @@\n+â”Š â”Š1â”Šrequire('ts-node').register({\n+â”Š â”Š2â”Š  transpileOnly: true,\n+â”Š â”Š3â”Š  compilerOptions: {\n+â”Š â”Š4â”Š    module: 'commonjs'\n+â”Š â”Š5â”Š  }\n+â”Š â”Š6â”Š})\n```\n\n##### Added codegen.yml\n```diff\n@@ -0,0 +1,12 @@\n+â”Š  â”Š 1â”Šschema: ../WhatsApp-Clone-Server/schema/typeDefs.ts\n+â”Š  â”Š 2â”Šdocuments:\n+â”Š  â”Š 3â”Š  - ./src/**/*.tsx\n+â”Š  â”Š 4â”Š  - ./src/**/*.ts\n+â”Š  â”Š 5â”Šoverwrite: true\n+â”Š  â”Š 6â”Šrequire:\n+â”Š  â”Š 7â”Š  - ts-node/../../codegen-interpreter.ts\n+â”Š  â”Š 8â”Šgenerates:\n+â”Š  â”Š 9â”Š  ./src/graphql/types.ts:\n+â”Š  â”Š10â”Š    plugins:\n+â”Š  â”Š11â”Š      - typescript-common\n+â”Š  â”Š12â”Š      - typescript-client\n```\n\n[}]: #\n\nAnd define `.gitignore` rules that will not include generated files in our git project:\n\n[{]: <helper> (diffStep 1.4 files=\"src/graphql/.gitignore\" module=\"client\")\n\n#### [Step 1.4: Setup codegen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/16bdab6)\n\n##### Added src&#x2F;graphql&#x2F;.gitignore\n```diff\n@@ -0,0 +1,2 @@\n+â”Š â”Š1â”Šintrospection.json\n+â”Š â”Š2â”Štypes.ts\n```\n\n[}]: #\n\nFew things you should note:\n\n- Our `codegen.yml` config references directly to the schema file in our server, which means that the server should be cloned alongside the client. Codegen also supports providing a REST endpoint, but if possible it's better to avoid it because this way you don't need to provide credentials. Indeed, the plan is to have an authentication mechanism to guard our GraphQL REST endpoint.\n- The `codegen-interpreter.ts` file is necessary because it extends the `tsconfig.json` file without us actually changing it. If you'll try to edit the `tsconfig.json` file directly, then `react-scripts` will change it back to its original form.\n\nWe will also add the necessary scripts to our `pacakge.json` so we can run `code-gen`:\n\n```json\n{\n  \"start\": \"concurrently \\\"yarn generate:watch\\\" \\\"react-scripts start\\\"\",\n  \"generate\": \"gql-gen\",\n  \"generate:watch\": \"nodemon --exec yarn generate -e graphql\"\n}\n```\n\nBe sure to install `concurrently` and `nodemon` so the scripts can work as intended:\n\n    $ yarn add -D nodemon@1.18.9 ts-node@8.0.2 concurrently@4.1.0\n\nAt this point our `package.json` file should look like this:\n\n[{]: <helper> (diffStep 1.4 files=\"package.json\" module=\"client\")\n\n#### [Step 1.4: Setup codegen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/16bdab6)\n\n##### Changed package.json\n```diff\n@@ -22,13 +22,21 @@\n â”Š22â”Š22â”Š  },\n â”Š23â”Š23â”Š  \"devDependencies\": {\n â”Š24â”Š24â”Š    \"@types/graphql\": \"14.0.7\",\n-â”Š25â”Š  â”Š    \"@types/node\": \"11.9.4\"\n+â”Š  â”Š25â”Š    \"@types/node\": \"11.9.4\",\n+â”Š  â”Š26â”Š    \"concurrently\": \"4.1.0\",\n+â”Š  â”Š27â”Š    \"graphql-code-generator\": \"0.16.1\",\n+â”Š  â”Š28â”Š    \"graphql-codegen-typescript-client\": \"0.16.1\",\n+â”Š  â”Š29â”Š    \"graphql-codegen-typescript-common\": \"0.16.1\",\n+â”Š  â”Š30â”Š    \"nodemon\": \"1.18.10\",\n+â”Š  â”Š31â”Š    \"ts-node\": \"8.0.2\"\n â”Š26â”Š32â”Š  },\n â”Š27â”Š33â”Š  \"scripts\": {\n-â”Š28â”Š  â”Š    \"start\": \"react-scripts start\",\n+â”Š  â”Š34â”Š    \"start\": \"concurrently \\\"yarn generate:watch\\\" \\\"react-scripts start\\\"\",\n â”Š29â”Š35â”Š    \"build\": \"react-scripts build\",\n â”Š30â”Š36â”Š    \"test\": \"react-scripts test\",\n-â”Š31â”Š  â”Š    \"eject\": \"react-scripts eject\"\n+â”Š  â”Š37â”Š    \"eject\": \"react-scripts eject\",\n+â”Š  â”Š38â”Š    \"generate\": \"gql-gen\",\n+â”Š  â”Š39â”Š    \"generate:watch\": \"nodemon --exec yarn generate -e graphql\"\n â”Š32â”Š40â”Š  },\n â”Š33â”Š41â”Š  \"eslintConfig\": {\n â”Š34â”Š42â”Š    \"extends\": \"react-app\"\n```\n\n[}]: #\n\nNow whenever we would like to generate some TypeScript definitions we can simply run:\n\n    $ yarn generate\n\nAlternatively we can just start the app on watch mode with `$ yarn start` and the Codegen should be listening for changes as well.\n\n    $ yarn start\n\nNow let's build a dashboard that will show all the chats in the server. Rather than implementing all the components and stylesheets from scratch, we will be using [`material-ui`](https://material-ui.com/) (aka Material). Material comes with pre-made components which are highly functional and work smooth with animations. To set it up we will first install it:\n\n    $ yarn add @material-ui/core@3.9.2 @material-ui/icons@3.0.2\n\nAnd then we will initialize it with the right theme values:\n\n[{]: <helper> (diffStep 1.5 files=\"src/index.tsx\" module=\"client\")\n\n#### [Step 1.5: Setup theme](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/f593fc3)\n\n##### Changed src&#x2F;index.tsx\n```diff\n@@ -1,3 +1,4 @@\n+â”Š â”Š1â”Šimport { MuiThemeProvider, createMuiTheme } from '@material-ui/core/styles'\n â”Š1â”Š2â”Šimport React from 'react';\n â”Š2â”Š3â”Šimport ReactDOM from 'react-dom';\n â”Š3â”Š4â”Šimport { ApolloProvider } from 'react-apollo-hooks';\n```\n```diff\n@@ -6,10 +7,22 @@\n â”Š 6â”Š 7â”Šimport apolloClient from './apollo-client'\n â”Š 7â”Š 8â”Šimport * as serviceWorker from './serviceWorker';\n â”Š 8â”Š 9â”Š\n+â”Š  â”Š10â”Šconst theme = createMuiTheme({\n+â”Š  â”Š11â”Š  palette: {\n+â”Š  â”Š12â”Š    primary: { main: '#2c6157' },\n+â”Š  â”Š13â”Š    secondary: { main: '#6fd056' },\n+â”Š  â”Š14â”Š  },\n+â”Š  â”Š15â”Š  typography: {\n+â”Š  â”Š16â”Š    useNextVariants: true,\n+â”Š  â”Š17â”Š  },\n+â”Š  â”Š18â”Š})\n+â”Š  â”Š19â”Š\n â”Š 9â”Š20â”ŠReactDOM.render(\n-â”Š10â”Š  â”Š  <ApolloProvider client={apolloClient}>\n-â”Š11â”Š  â”Š    <App />\n-â”Š12â”Š  â”Š  </ApolloProvider>\n+â”Š  â”Š21â”Š  <MuiThemeProvider theme={theme}>\n+â”Š  â”Š22â”Š    <ApolloProvider client={apolloClient}>\n+â”Š  â”Š23â”Š      <App />\n+â”Š  â”Š24â”Š    </ApolloProvider>\n+â”Š  â”Š25â”Š  </MuiThemeProvider>\n â”Š13â”Š26â”Š, document.getElementById('root'));\n â”Š14â”Š27â”Š\n â”Š15â”Š28â”Š// If you want your app to work offline and load faster, you can change\n```\n\n[}]: #\n\nThe theme values represent the main colors in our app. If you're familiar with WhatsApp, you know that its main colors consist mostly of Green and White. The theme values will automatically give Material components the desired style.\n\nWe will also make sure that the same values are available in our CSS stylesheet so we can use it outside Material's scope:\n\n[{]: <helper> (diffStep 1.5 files=\"src/index.css\" module=\"client\")\n\n#### [Step 1.5: Setup theme](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/f593fc3)\n\n##### Changed src&#x2F;index.css\n```diff\n@@ -1,3 +1,10 @@\n+â”Š  â”Š 1â”Š:root {\n+â”Š  â”Š 2â”Š  --primary-bg: #2c6157;\n+â”Š  â”Š 3â”Š  --secondary-bg: #6fd056;\n+â”Š  â”Š 4â”Š  --primary-text: white;\n+â”Š  â”Š 5â”Š  --secondary-text: white;\n+â”Š  â”Š 6â”Š}\n+â”Š  â”Š 7â”Š\n â”Š 1â”Š 8â”Šbody {\n â”Š 2â”Š 9â”Š  margin: 0;\n â”Š 3â”Š10â”Š  padding: 0;\n```\n\n[}]: #\n\nNow we're ready to start implementing the view itself. The logic is very simple, we will use a query to fetch the chats from our back-end. Accordingly we will need to define the right [GraphQL fragments](https://www.apollographql.com/docs/react/advanced/fragments.html) so we can use them to build the query. In short, a fragment is used to represent an entity in our app. **It doesn't necessarily has to represent a type**, but indeed it's the most common use case:\n\n[{]: <helper> (diffStep 1.6 files=\"src/graphql/fragments\" module=\"client\")\n\n#### [Step 1.6: Add ChatsListScreen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/61e1047)\n\n##### Added src&#x2F;graphql&#x2F;fragments&#x2F;chat.fragment.ts\n```diff\n@@ -0,0 +1,22 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag'\n+â”Š  â”Š 2â”Šimport message from './message.fragment'\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šexport default gql `\n+â”Š  â”Š 5â”Š  fragment Chat on Chat {\n+â”Š  â”Š 6â”Š    id\n+â”Š  â”Š 7â”Š    name\n+â”Š  â”Š 8â”Š    picture\n+â”Š  â”Š 9â”Š    allTimeMembers {\n+â”Š  â”Š10â”Š      id\n+â”Š  â”Š11â”Š      name\n+â”Š  â”Š12â”Š      picture\n+â”Š  â”Š13â”Š    }\n+â”Š  â”Š14â”Š    owner {\n+â”Š  â”Š15â”Š      id\n+â”Š  â”Š16â”Š    }\n+â”Š  â”Š17â”Š    lastMessage {\n+â”Š  â”Š18â”Š      ...Message\n+â”Š  â”Š19â”Š    }\n+â”Š  â”Š20â”Š  }\n+â”Š  â”Š21â”Š  ${message}\n+â”Š  â”Š22â”Š`\n```\n\n##### Added src&#x2F;graphql&#x2F;fragments&#x2F;index.ts\n```diff\n@@ -0,0 +1,2 @@\n+â”Š â”Š1â”Šexport { default as chat } from './chat.fragment'\n+â”Š â”Š2â”Šexport { default as message } from './message.fragment'\n```\n\n##### Added src&#x2F;graphql&#x2F;fragments&#x2F;message.fragment.ts\n```diff\n@@ -0,0 +1,33 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag'\n+â”Š  â”Š 2â”Š\n+â”Š  â”Š 3â”Šexport default gql`\n+â”Š  â”Š 4â”Š  fragment Message on Message {\n+â”Š  â”Š 5â”Š    id\n+â”Š  â”Š 6â”Š    chat {\n+â”Š  â”Š 7â”Š      id\n+â”Š  â”Š 8â”Š    }\n+â”Š  â”Š 9â”Š    sender {\n+â”Š  â”Š10â”Š      id\n+â”Š  â”Š11â”Š      name\n+â”Š  â”Š12â”Š    }\n+â”Š  â”Š13â”Š    content\n+â”Š  â”Š14â”Š    createdAt\n+â”Š  â”Š15â”Š    recipients {\n+â”Š  â”Š16â”Š      user {\n+â”Š  â”Š17â”Š        id\n+â”Š  â”Š18â”Š      }\n+â”Š  â”Š19â”Š      message {\n+â”Š  â”Š20â”Š        id\n+â”Š  â”Š21â”Š        chat {\n+â”Š  â”Š22â”Š          id\n+â”Š  â”Š23â”Š        }\n+â”Š  â”Š24â”Š      }\n+â”Š  â”Š25â”Š      chat {\n+â”Š  â”Š26â”Š        id\n+â”Š  â”Š27â”Š      }\n+â”Š  â”Š28â”Š      receivedAt\n+â”Š  â”Š29â”Š      readAt\n+â”Š  â”Š30â”Š    }\n+â”Š  â”Š31â”Š    ownership\n+â”Š  â”Š32â”Š  }\n+â”Š  â”Š33â”Š`\n```\n\n[}]: #\n\nLet's move on to implementing the components. The layout is simple and consists of a navigation bar and a chats list. There are few important details you should note about the components:\n\n- They use [Material's](https://material-ui.com) pre-made components and icons, which are styled and highly functional right out of the box.\n- Instead of using CSS to style our components we use [`styled-components`](https://www.styled-components.com/). This way we can encapsulate the style and it will live right next to the component.\n- We will use [`react-apollo-hooks`](https://github.com/trojanowski/react-apollo-hooks) to connect our Apollo client with our React components. **This library is experimental and shouldn't be used in production yet**.\n\n[{]: <helper> (diffStep 1.6 files=\"src/components\" module=\"client\")\n\n#### [Step 1.6: Add ChatsListScreen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/61e1047)\n\n##### Added src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -0,0 +1,108 @@\n+â”Š   â”Š  1â”Šimport List from '@material-ui/core/List'\n+â”Š   â”Š  2â”Šimport ListItem from '@material-ui/core/ListItem'\n+â”Š   â”Š  3â”Šimport gql from 'graphql-tag'\n+â”Š   â”Š  4â”Šimport * as moment from 'moment'\n+â”Š   â”Š  5â”Šimport * as React from 'react'\n+â”Š   â”Š  6â”Šimport { useQuery } from 'react-apollo-hooks'\n+â”Š   â”Š  7â”Šimport * as ReactDOM from 'react-dom'\n+â”Š   â”Š  8â”Šimport styled from 'styled-components'\n+â”Š   â”Š  9â”Šimport * as fragments from '../../graphql/fragments'\n+â”Š   â”Š 10â”Šimport { ChatsListQuery } from '../../graphql/types'\n+â”Š   â”Š 11â”Š\n+â”Š   â”Š 12â”Šconst Style = styled.div`\n+â”Š   â”Š 13â”Š  height: calc(100% - 56px);\n+â”Š   â”Š 14â”Š  overflow-y: overlay;\n+â”Š   â”Š 15â”Š\n+â”Š   â”Š 16â”Š  .ChatsList-chats-list {\n+â”Š   â”Š 17â”Š    padding: 0;\n+â”Š   â”Š 18â”Š  }\n+â”Š   â”Š 19â”Š\n+â”Š   â”Š 20â”Š  .ChatsList-chat-item {\n+â”Š   â”Š 21â”Š    height: 76px;\n+â”Š   â”Š 22â”Š    padding: 0 15px;\n+â”Š   â”Š 23â”Š    display: flex;\n+â”Š   â”Š 24â”Š  }\n+â”Š   â”Š 25â”Š\n+â”Š   â”Š 26â”Š  .ChatsList-profile-pic {\n+â”Š   â”Š 27â”Š    height: 50px;\n+â”Š   â”Š 28â”Š    width: 50px;\n+â”Š   â”Š 29â”Š    object-fit: cover;\n+â”Š   â”Š 30â”Š    border-radius: 50%;\n+â”Š   â”Š 31â”Š  }\n+â”Š   â”Š 32â”Š\n+â”Š   â”Š 33â”Š  .ChatsList-info {\n+â”Š   â”Š 34â”Š    width: calc(100% - 60px);\n+â”Š   â”Š 35â”Š    height: calc(100% - 30px);\n+â”Š   â”Š 36â”Š    padding: 15px 0;\n+â”Š   â”Š 37â”Š    margin-left: 10px;\n+â”Š   â”Š 38â”Š    border-bottom: 0.5px solid silver;\n+â”Š   â”Š 39â”Š    position: relative;\n+â”Š   â”Š 40â”Š  }\n+â”Š   â”Š 41â”Š\n+â”Š   â”Š 42â”Š  .ChatsList-name {\n+â”Š   â”Š 43â”Š    margin-top: 5px;\n+â”Š   â”Š 44â”Š  }\n+â”Š   â”Š 45â”Š\n+â”Š   â”Š 46â”Š  .ChatsList-last-message {\n+â”Š   â”Š 47â”Š    color: gray;\n+â”Š   â”Š 48â”Š    font-size: 15px;\n+â”Š   â”Š 49â”Š    margin-top: 5px;\n+â”Š   â”Š 50â”Š    text-overflow: ellipsis;\n+â”Š   â”Š 51â”Š    overflow: hidden;\n+â”Š   â”Š 52â”Š    white-space: nowrap;\n+â”Š   â”Š 53â”Š  }\n+â”Š   â”Š 54â”Š\n+â”Š   â”Š 55â”Š  .ChatsList-timestamp {\n+â”Š   â”Š 56â”Š    position: absolute;\n+â”Š   â”Š 57â”Š    color: gray;\n+â”Š   â”Š 58â”Š    top: 20px;\n+â”Š   â”Š 59â”Š    right: 0;\n+â”Š   â”Š 60â”Š    font-size: 13px;\n+â”Š   â”Š 61â”Š  }\n+â”Š   â”Š 62â”Š`\n+â”Š   â”Š 63â”Š\n+â”Š   â”Š 64â”Šconst query = gql`\n+â”Š   â”Š 65â”Š  query ChatsListQuery {\n+â”Š   â”Š 66â”Š    chats {\n+â”Š   â”Š 67â”Š      ...Chat\n+â”Š   â”Š 68â”Š    }\n+â”Š   â”Š 69â”Š  }\n+â”Š   â”Š 70â”Š\n+â”Š   â”Š 71â”Š  ${fragments.chat}\n+â”Š   â”Š 72â”Š`\n+â”Š   â”Š 73â”Š\n+â”Š   â”Š 74â”Šexport default () => {\n+â”Š   â”Š 75â”Š  const {\n+â”Š   â”Š 76â”Š    data: { chats },\n+â”Š   â”Š 77â”Š  } = useQuery<ChatsListQuery.Query>(query, { suspend: true })\n+â”Š   â”Š 78â”Š\n+â”Š   â”Š 79â”Š  return (\n+â”Š   â”Š 80â”Š    <Style className=\"ChatsList\">\n+â”Š   â”Š 81â”Š      <List className=\"ChatsList-chats-list\">\n+â”Š   â”Š 82â”Š        {chats.map(chat => (\n+â”Š   â”Š 83â”Š          <ListItem\n+â”Š   â”Š 84â”Š            key={chat.id}\n+â”Š   â”Š 85â”Š            className=\"ChatsList-chat-item\"\n+â”Š   â”Š 86â”Š            button\n+â”Š   â”Š 87â”Š          >\n+â”Š   â”Š 88â”Š            <img\n+â”Š   â”Š 89â”Š              className=\"ChatsList-profile-pic\"\n+â”Š   â”Š 90â”Š              src={chat.picture || '/assets/default-profile-pic.jpg'}\n+â”Š   â”Š 91â”Š            />\n+â”Š   â”Š 92â”Š            <div className=\"ChatsList-info\">\n+â”Š   â”Š 93â”Š              <div className=\"ChatsList-name\">{chat.name}</div>\n+â”Š   â”Š 94â”Š              {chat.lastMessage && (\n+â”Š   â”Š 95â”Š                <React.Fragment>\n+â”Š   â”Š 96â”Š                  <div className=\"ChatsList-last-message\">{chat.lastMessage.content}</div>\n+â”Š   â”Š 97â”Š                  <div className=\"ChatsList-timestamp\">\n+â”Š   â”Š 98â”Š                    {moment(chat.lastMessage.createdAt).format('HH:mm')}\n+â”Š   â”Š 99â”Š                  </div>\n+â”Š   â”Š100â”Š                </React.Fragment>\n+â”Š   â”Š101â”Š              )}\n+â”Š   â”Š102â”Š            </div>\n+â”Š   â”Š103â”Š          </ListItem>\n+â”Š   â”Š104â”Š        ))}\n+â”Š   â”Š105â”Š      </List>\n+â”Š   â”Š106â”Š    </Style>\n+â”Š   â”Š107â”Š  )\n+â”Š   â”Š108â”Š}\n```\n\n##### Added src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsNavbar.tsx\n```diff\n@@ -0,0 +1,14 @@\n+â”Š  â”Š 1â”Šimport * as React from 'react'\n+â”Š  â”Š 2â”Šimport styled from 'styled-components'\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šconst Style = styled.div`\n+â”Š  â”Š 5â”Š  .ChatsNavbar-title {\n+â”Š  â”Š 6â”Š    float: left;\n+â”Š  â”Š 7â”Š  }\n+â”Š  â”Š 8â”Š`\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Šexport default () => (\n+â”Š  â”Š11â”Š  <Style className=\"ChatsNavbar\">\n+â”Š  â”Š12â”Š    <span className=\"ChatsNavbar-title\">WhatsApp Clone</span>\n+â”Š  â”Š13â”Š  </Style>\n+â”Š  â”Š14â”Š)\n```\n\n##### Added src&#x2F;components&#x2F;ChatsListScreen&#x2F;index.tsx\n```diff\n@@ -0,0 +1,16 @@\n+â”Š  â”Š 1â”Šimport * as React from 'react'\n+â”Š  â”Š 2â”Šimport { Suspense } from 'react'\n+â”Š  â”Š 3â”Šimport Navbar from '../Navbar'\n+â”Š  â”Š 4â”Šimport ChatsList from './ChatsList'\n+â”Š  â”Š 5â”Šimport ChatsNavbar from './ChatsNavbar'\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Šexport default () => (\n+â”Š  â”Š 8â”Š  <div className=\"ChatsListScreen Screen\">\n+â”Š  â”Š 9â”Š    <Navbar>\n+â”Š  â”Š10â”Š      <ChatsNavbar />\n+â”Š  â”Š11â”Š    </Navbar>\n+â”Š  â”Š12â”Š    <Suspense fallback={null}>\n+â”Š  â”Š13â”Š      <ChatsList />\n+â”Š  â”Š14â”Š    </Suspense>\n+â”Š  â”Š15â”Š  </div>\n+â”Š  â”Š16â”Š)\n```\n\n##### Added src&#x2F;components&#x2F;Navbar.tsx\n```diff\n@@ -0,0 +1,24 @@\n+â”Š  â”Š 1â”Šimport Toolbar from '@material-ui/core/Toolbar'\n+â”Š  â”Š 2â”Šimport * as React from 'react'\n+â”Š  â”Š 3â”Šimport styled from 'styled-components'\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šconst Style = styled(Toolbar)`\n+â”Š  â”Š 6â”Š  background-color: var(--primary-bg);\n+â”Š  â”Š 7â”Š  color: var(--primary-text);\n+â”Š  â”Š 8â”Š  font-size: 20px;\n+â”Š  â”Š 9â”Š  line-height: 40px;\n+â”Š  â”Š10â”Š\n+â”Š  â”Š11â”Š  .Navbar-body {\n+â”Š  â”Š12â”Š    width: 100%;\n+â”Š  â”Š13â”Š  }\n+â”Š  â”Š14â”Š`\n+â”Š  â”Š15â”Š\n+â”Š  â”Š16â”Šinterface NavbarProps {\n+â”Š  â”Š17â”Š  children: any\n+â”Š  â”Š18â”Š}\n+â”Š  â”Š19â”Š\n+â”Š  â”Š20â”Šexport default ({ children }: NavbarProps) => (\n+â”Š  â”Š21â”Š  <Style className=\"Navbar\">\n+â”Š  â”Š22â”Š    <div className=\"Navbar-body\">{children}</div>\n+â”Š  â”Š23â”Š  </Style>\n+â”Š  â”Š24â”Š)\n```\n\n[}]: #\n\nLet's install the missing dependencies:\n\n    $ yarn add -D @types/moment@2.13.0\n    $ yarn add graphql-tag@2.10.1 moment@2.24.0 subscriptions-transport-ws@0.9.15 styled-components@4.1.3\n\nAnd add a default profile picture to our assets directory under `public/assets/default-profile-pic.jpg`:\n\n![default-profile-pic.jpg](https://user-images.githubusercontent.com/7648874/51983273-38229280-24d3-11e9-98bd-363764dc6d97.jpg)\n\nThe chats which are currently served by the server already have a picture, but it's not uncommon to have a chat without any picture in our app.\n\nLastly, in order to make the list that we've just created visible, we will mount it at the main app component:\n\n[{]: <helper> (diffStep 1.6 files=\"src/App.tsx\" module=\"client\")\n\n#### [Step 1.6: Add ChatsListScreen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/61e1047)\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -1,25 +1,11 @@\n â”Š 1â”Š 1â”Šimport React, { Component } from 'react';\n-â”Š 2â”Š  â”Šimport logo from './logo.svg';\n-â”Š 3â”Š  â”Šimport './App.css';\n+â”Š  â”Š 2â”Šimport ChatsListScreen from './components/ChatsListScreen'\n â”Š 4â”Š 3â”Š\n â”Š 5â”Š 4â”Šclass App extends Component {\n â”Š 6â”Š 5â”Š  render() {\n â”Š 7â”Š 6â”Š    return (\n â”Š 8â”Š 7â”Š      <div className=\"App\">\n-â”Š 9â”Š  â”Š        <header className=\"App-header\">\n-â”Š10â”Š  â”Š          <img src={logo} className=\"App-logo\" alt=\"logo\" />\n-â”Š11â”Š  â”Š          <p>\n-â”Š12â”Š  â”Š            Edit <code>src/App.js</code> and save to reload.\n-â”Š13â”Š  â”Š          </p>\n-â”Š14â”Š  â”Š          <a\n-â”Š15â”Š  â”Š            className=\"App-link\"\n-â”Š16â”Š  â”Š            href=\"https://reactjs.org\"\n-â”Š17â”Š  â”Š            target=\"_blank\"\n-â”Š18â”Š  â”Š            rel=\"noopener noreferrer\"\n-â”Š19â”Š  â”Š          >\n-â”Š20â”Š  â”Š            Learn React\n-â”Š21â”Š  â”Š          </a>\n-â”Š22â”Š  â”Š        </header>\n+â”Š  â”Š 8â”Š        <ChatsListScreen />\n â”Š23â”Š 9â”Š      </div>\n â”Š24â”Š10â”Š    );\n â”Š25â”Š11â”Š  }\n```\n\n[}]: #\n\nNow we should be able to see the chats in the React app! We can test it out by running\n\n    # terminal 1\n    server$ yarn generate\n    server$ yarn start\n    # terminal 2\n    client$ yarn generate\n    client$ yarn start\n\nEverything works, but it's not over yet. Our application can't be based on a served hard-coded JSON. A real app has a database. There are many advantages for using a database over an in-memory or FS stored data:\n\n- It is VERY fast, and can deal with large amounts of data.\n- Data fetching can be optimized by defining indexes.\n- You need the right read/write permissions which makes it very secure.\n- Data will persist even if the server crashes or the machine is randomly closed.\n- A lot more...\n\nWe will be using [PostgreSQL](https://www.postgresql.org/) (Postgres, in short) as our database with [TypeORM](https://github.com/typeorm/typeorm) as an ORM around Postgres. First make sure that you install Postgres on your machine by following the [official installation instructions](https://www.labkey.org/Documentation/wiki-page.view?name=commonInstall).\n\nTo make sure the whole shebang works with Node.JS, we will install few packages:\n\n    $ yarn add pg@7.8.0 typeorm@0.2.11 reflect-metadata@0.1.12\n    $ yarn add -D @types/pg@7.4.11\n\n> The [`reflect-metadata`](https://www.npmjs.com/package/reflect-metadata) package will emit metadata for JavaScript [decorators](https://github.com/tc39/proposal-decorators). This will be used internally by TypeORM to determine column types based on their corresponding TypeScript type.\n\nThis would require us to set some configuration so TypeORM would know where and how to connect the DB. We will use the `whatsapp` DB with the `test` username:\n\n[{]: <helper> (diffStep 1.5 files=\"ormconfig.json, index.ts\" module=\"server\")\n\n#### [Step 1.5: Setup TypeORM](https://github.com/Urigo/WhatsApp-Clone-Server/commit/d89b9b3)\n\n##### Changed index.ts\n```diff\n@@ -4,27 +4,33 @@\n â”Š 4â”Š 4â”Šimport express from 'express'\n â”Š 5â”Š 5â”Šimport gql from 'graphql-tag'\n â”Š 6â”Š 6â”Šimport { createServer } from 'http'\n+â”Š  â”Š 7â”Šimport { createConnection } from 'typeorm'\n â”Š 7â”Š 8â”Šimport schema from './schema'\n â”Š 8â”Š 9â”Š\n â”Š 9â”Š10â”Šconst PORT = 4000\n â”Š10â”Š11â”Š\n-â”Š11â”Š  â”Šconst app = express()\n+â”Š  â”Š12â”ŠcreateConnection().then((connection) => {\n+â”Š  â”Š13â”Š  const app = express()\n â”Š12â”Š14â”Š\n-â”Š13â”Š  â”Šapp.use(cors())\n-â”Š14â”Š  â”Šapp.use(bodyParser.json())\n+â”Š  â”Š15â”Š  app.use(cors())\n+â”Š  â”Š16â”Š  app.use(bodyParser.json())\n â”Š15â”Š17â”Š\n-â”Š16â”Š  â”Šconst apollo = new ApolloServer({ schema })\n+â”Š  â”Š18â”Š  const apollo = new ApolloServer({\n+â”Š  â”Š19â”Š    schema,\n+â”Š  â”Š20â”Š    context: () => ({ connection }),\n+â”Š  â”Š21â”Š  })\n â”Š17â”Š22â”Š\n-â”Š18â”Š  â”Šapollo.applyMiddleware({\n-â”Š19â”Š  â”Š  app,\n-â”Š20â”Š  â”Š  path: '/graphql',\n-â”Š21â”Š  â”Š})\n+â”Š  â”Š23â”Š  apollo.applyMiddleware({\n+â”Š  â”Š24â”Š    app,\n+â”Š  â”Š25â”Š    path: '/graphql',\n+â”Š  â”Š26â”Š  })\n â”Š22â”Š27â”Š\n-â”Š23â”Š  â”Š// Wrap the Express server\n-â”Š24â”Š  â”Šconst ws = createServer(app)\n+â”Š  â”Š28â”Š  // Wrap the Express server\n+â”Š  â”Š29â”Š  const ws = createServer(app)\n â”Š25â”Š30â”Š\n-â”Š26â”Š  â”Šapollo.installSubscriptionHandlers(ws)\n+â”Š  â”Š31â”Š  apollo.installSubscriptionHandlers(ws)\n â”Š27â”Š32â”Š\n-â”Š28â”Š  â”Šws.listen(PORT, () => {\n-â”Š29â”Š  â”Š  console.log(`Apollo Server is now running on http://localhost:${PORT}`)\n+â”Š  â”Š33â”Š  ws.listen(PORT, () => {\n+â”Š  â”Š34â”Š    console.log(`Apollo Server is now running on http://localhost:${PORT}`)\n+â”Š  â”Š35â”Š  })\n â”Š30â”Š36â”Š})\n```\n\n##### Added ormconfig.json\n```diff\n@@ -0,0 +1,24 @@\n+â”Š  â”Š 1â”Š{\n+â”Š  â”Š 2â”Š   \"type\": \"postgres\",\n+â”Š  â”Š 3â”Š   \"host\": \"localhost\",\n+â”Š  â”Š 4â”Š   \"port\": 5432,\n+â”Š  â”Š 5â”Š   \"username\": \"test\",\n+â”Š  â”Š 6â”Š   \"password\": \"test\",\n+â”Š  â”Š 7â”Š   \"database\": \"whatsapp\",\n+â”Š  â”Š 8â”Š   \"synchronize\": true,\n+â”Š  â”Š 9â”Š   \"logging\": false,\n+â”Š  â”Š10â”Š   \"entities\": [\n+â”Š  â”Š11â”Š      \"entity/**/*.ts\"\n+â”Š  â”Š12â”Š   ],\n+â”Š  â”Š13â”Š   \"migrations\": [\n+â”Š  â”Š14â”Š      \"migration/**/*.ts\"\n+â”Š  â”Š15â”Š   ],\n+â”Š  â”Š16â”Š   \"subscribers\": [\n+â”Š  â”Š17â”Š      \"subscriber/**/*.ts\"\n+â”Š  â”Š18â”Š   ],\n+â”Š  â”Š19â”Š   \"cli\": {\n+â”Š  â”Š20â”Š      \"entitiesDir\": \"entity\",\n+â”Š  â”Š21â”Š      \"migrationsDir\": \"migration\",\n+â”Š  â”Š22â”Š      \"subscribersDir\": \"subscriber\"\n+â”Š  â”Š23â”Š   }\n+â”Š  â”Š24â”Š}\n```\n\n[}]: #\n\nTypeORM wraps the official Postgres driver so you shouldn't worry about interacting with it. Feel free to edit `ormconfig.json` file based on your needs.\n\nWe will also define the type of expected GraphQL context using Codegen. All we have to do is to create a `context.ts` file and specify it in the `codegen.yml` file:\n\n[{]: <helper> (diffStep 1.5 files=\"codegen.yml, context.ts\" module=\"server\")\n\n#### [Step 1.5: Setup TypeORM](https://github.com/Urigo/WhatsApp-Clone-Server/commit/d89b9b3)\n\n##### Changed codegen.yml\n```diff\n@@ -8,6 +8,7 @@\n â”Š 8â”Š 8â”Š      - typescript-resolvers\n â”Š 9â”Š 9â”Š    config:\n â”Š10â”Š10â”Š      optionalType: undefined | null\n+â”Š  â”Š11â”Š      contextType: ./context#Context\n â”Š11â”Š12â”Š      mappers:\n â”Š12â”Š13â”Š        Chat: ./entity/chat#Chat\n â”Š13â”Š14â”Š        Message: ./entity/message#Message\n```\n\n##### Added context.ts\n```diff\n@@ -0,0 +1,7 @@\n+â”Š â”Š1â”Šimport { Connection } from 'typeorm'\n+â”Š â”Š2â”Šimport User from './entity/user'\n+â”Š â”Š3â”Š\n+â”Š â”Š4â”Šexport interface Context {\n+â”Š â”Š5â”Š  connection: Connection\n+â”Š â”Š6â”Š  user: User\n+â”Š â”Š7â”Š}\n```\n\n[}]: #\n\nTypeORM has a very defined structure for organizing a project. Each table in our database, its columns and its relationships should be defined in an entity file under the `entity` folder. Why `entity` folder? Because the `ormconfig.json` says so. This is why originally we defined a TypeScript definition for each entity under a separate file. As for now, we will have 3 entities:\n\n- A chat entity.\n- A message entity.\n- A user entity.\n\nAs we make progress, we will add more entities and edit the relationships between them:\n\n[{]: <helper> (diffStep 1.6 files=\"entity\" module=\"server\")\n\n#### [Step 1.6: Implement resolvers against TypeORM](https://github.com/Urigo/WhatsApp-Clone-Server/commit/d4230cc)\n\n##### Changed entity&#x2F;chat.ts\n```diff\n@@ -1,18 +1,89 @@\n+â”Š  â”Š 1â”Šimport {\n+â”Š  â”Š 2â”Š  Entity,\n+â”Š  â”Š 3â”Š  Column,\n+â”Š  â”Š 4â”Š  PrimaryGeneratedColumn,\n+â”Š  â”Š 5â”Š  OneToMany,\n+â”Š  â”Š 6â”Š  JoinTable,\n+â”Š  â”Š 7â”Š  ManyToMany,\n+â”Š  â”Š 8â”Š  ManyToOne,\n+â”Š  â”Š 9â”Š  CreateDateColumn,\n+â”Š  â”Š10â”Š} from 'typeorm'\n â”Š 1â”Š11â”Šimport Message from './message'\n+â”Š  â”Š12â”Šimport User from './user'\n â”Š 2â”Š13â”Š\n-â”Š 3â”Š  â”Šexport interface Chat {\n+â”Š  â”Š14â”Šinterface ChatConstructor {\n+â”Š  â”Š15â”Š  name?: string\n+â”Š  â”Š16â”Š  picture?: string\n+â”Š  â”Š17â”Š  allTimeMembers?: User[]\n+â”Š  â”Š18â”Š  listingMembers?: User[]\n+â”Š  â”Š19â”Š  owner?: User\n+â”Š  â”Š20â”Š  messages?: Message[]\n+â”Š  â”Š21â”Š}\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Š@Entity()\n+â”Š  â”Š24â”Šexport class Chat {\n+â”Š  â”Š25â”Š  @PrimaryGeneratedColumn()\n â”Š 4â”Š26â”Š  id: string\n-â”Š 5â”Š  â”Š  name?: string | null\n-â”Š 6â”Š  â”Š  picture?: string | null\n-â”Š 7â”Š  â”Š  // All members, current and past ones.\n-â”Š 8â”Š  â”Š  allTimeMemberIds: string[]\n-â”Š 9â”Š  â”Š  // Whoever gets the chat listed. For groups includes past members who still didn't delete the group.\n-â”Š10â”Š  â”Š  listingMemberIds: string[]\n-â”Š11â”Š  â”Š  // Actual members of the group (they are not the only ones who get the group listed). Null for chats.\n-â”Š12â”Š  â”Š  actualGroupMemberIds?: string[] | null\n-â”Š13â”Š  â”Š  adminIds?: string[] | null\n-â”Š14â”Š  â”Š  ownerId?: string | null\n+â”Š  â”Š27â”Š\n+â”Š  â”Š28â”Š  @CreateDateColumn({ nullable: true })\n+â”Š  â”Š29â”Š  createdAt: Date\n+â”Š  â”Š30â”Š\n+â”Š  â”Š31â”Š  @Column({ nullable: true })\n+â”Š  â”Š32â”Š  name: string\n+â”Š  â”Š33â”Š\n+â”Š  â”Š34â”Š  @Column({ nullable: true })\n+â”Š  â”Š35â”Š  picture: string\n+â”Š  â”Š36â”Š\n+â”Š  â”Š37â”Š  @ManyToMany(type => User, user => user.allTimeMemberChats, {\n+â”Š  â”Š38â”Š    cascade: ['insert', 'update'],\n+â”Š  â”Š39â”Š    eager: false,\n+â”Š  â”Š40â”Š  })\n+â”Š  â”Š41â”Š  @JoinTable()\n+â”Š  â”Š42â”Š  allTimeMembers: User[]\n+â”Š  â”Š43â”Š\n+â”Š  â”Š44â”Š  @ManyToMany(type => User, user => user.listingMemberChats, {\n+â”Š  â”Š45â”Š    cascade: ['insert', 'update'],\n+â”Š  â”Š46â”Š    eager: false,\n+â”Š  â”Š47â”Š  })\n+â”Š  â”Š48â”Š  @JoinTable()\n+â”Š  â”Š49â”Š  listingMembers: User[]\n+â”Š  â”Š50â”Š\n+â”Š  â”Š51â”Š  @ManyToOne(type => User, user => user.ownerChats, { cascade: ['insert', 'update'], eager: false })\n+â”Š  â”Š52â”Š  owner?: User | null\n+â”Š  â”Š53â”Š\n+â”Š  â”Š54â”Š  @OneToMany(type => Message, message => message.chat, {\n+â”Š  â”Š55â”Š    cascade: ['insert', 'update'],\n+â”Š  â”Š56â”Š    eager: true,\n+â”Š  â”Š57â”Š  })\n â”Š15â”Š58â”Š  messages: Message[]\n+â”Š  â”Š59â”Š\n+â”Š  â”Š60â”Š  constructor({\n+â”Š  â”Š61â”Š    name,\n+â”Š  â”Š62â”Š    picture,\n+â”Š  â”Š63â”Š    allTimeMembers,\n+â”Š  â”Š64â”Š    listingMembers,\n+â”Š  â”Š65â”Š    owner,\n+â”Š  â”Š66â”Š    messages,\n+â”Š  â”Š67â”Š  }: ChatConstructor = {}) {\n+â”Š  â”Š68â”Š    if (name) {\n+â”Š  â”Š69â”Š      this.name = name\n+â”Š  â”Š70â”Š    }\n+â”Š  â”Š71â”Š    if (picture) {\n+â”Š  â”Š72â”Š      this.picture = picture\n+â”Š  â”Š73â”Š    }\n+â”Š  â”Š74â”Š    if (allTimeMembers) {\n+â”Š  â”Š75â”Š      this.allTimeMembers = allTimeMembers\n+â”Š  â”Š76â”Š    }\n+â”Š  â”Š77â”Š    if (listingMembers) {\n+â”Š  â”Š78â”Š      this.listingMembers = listingMembers\n+â”Š  â”Š79â”Š    }\n+â”Š  â”Š80â”Š    if (owner) {\n+â”Š  â”Š81â”Š      this.owner = owner\n+â”Š  â”Š82â”Š    }\n+â”Š  â”Š83â”Š    if (messages) {\n+â”Š  â”Š84â”Š      this.messages = messages\n+â”Š  â”Š85â”Š    }\n+â”Š  â”Š86â”Š  }\n â”Š16â”Š87â”Š}\n â”Š17â”Š88â”Š\n â”Š18â”Š89â”Šexport default Chat\n```\n\n##### Changed entity&#x2F;message.ts\n```diff\n@@ -1,20 +1,80 @@\n-â”Š 1â”Š  â”Šimport Recipient from './recipient'\n+â”Š  â”Š 1â”Šimport {\n+â”Š  â”Š 2â”Š  Entity,\n+â”Š  â”Š 3â”Š  Column,\n+â”Š  â”Š 4â”Š  PrimaryGeneratedColumn,\n+â”Š  â”Š 5â”Š  OneToMany,\n+â”Š  â”Š 6â”Š  ManyToOne,\n+â”Š  â”Š 7â”Š  ManyToMany,\n+â”Š  â”Š 8â”Š  JoinTable,\n+â”Š  â”Š 9â”Š  CreateDateColumn,\n+â”Š  â”Š10â”Š} from 'typeorm'\n+â”Š  â”Š11â”Šimport Chat from './chat'\n+â”Š  â”Š12â”Šimport User from './user'\n+â”Š  â”Š13â”Šimport { MessageType } from '../db'\n â”Š 2â”Š14â”Š\n-â”Š 3â”Š  â”Šexport enum MessageType {\n-â”Š 4â”Š  â”Š  PICTURE,\n-â”Š 5â”Š  â”Š  TEXT,\n-â”Š 6â”Š  â”Š  LOCATION,\n+â”Š  â”Š15â”Šinterface MessageConstructor {\n+â”Š  â”Š16â”Š  sender?: User\n+â”Š  â”Š17â”Š  content?: string\n+â”Š  â”Š18â”Š  createdAt?: Date\n+â”Š  â”Š19â”Š  type?: MessageType\n+â”Š  â”Š20â”Š  holders?: User[]\n+â”Š  â”Š21â”Š  chat?: Chat\n â”Š 7â”Š22â”Š}\n â”Š 8â”Š23â”Š\n-â”Š 9â”Š  â”Šexport interface Message {\n+â”Š  â”Š24â”Š@Entity()\n+â”Š  â”Š25â”Šexport class Message {\n+â”Š  â”Š26â”Š  @PrimaryGeneratedColumn()\n â”Š10â”Š27â”Š  id: string\n-â”Š11â”Š  â”Š  chatId: string\n-â”Š12â”Š  â”Š  senderId: string\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š  @ManyToOne(type => User, user => user.senderMessages, { eager: true })\n+â”Š  â”Š30â”Š  sender: User\n+â”Š  â”Š31â”Š\n+â”Š  â”Š32â”Š  @Column()\n â”Š13â”Š33â”Š  content: string\n-â”Š14â”Š  â”Š  createdAt: number\n-â”Š15â”Š  â”Š  type: MessageType\n-â”Š16â”Š  â”Š  recipients: Recipient[]\n-â”Š17â”Š  â”Š  holderIds: string[]\n+â”Š  â”Š34â”Š\n+â”Š  â”Š35â”Š  @CreateDateColumn({ nullable: true })\n+â”Š  â”Š36â”Š  createdAt: Date\n+â”Š  â”Š37â”Š\n+â”Š  â”Š38â”Š  @Column()\n+â”Š  â”Š39â”Š  type: number\n+â”Š  â”Š40â”Š\n+â”Š  â”Š41â”Š  @ManyToMany(type => User, user => user.holderMessages, {\n+â”Š  â”Š42â”Š    cascade: ['insert', 'update'],\n+â”Š  â”Š43â”Š    eager: true,\n+â”Š  â”Š44â”Š  })\n+â”Š  â”Š45â”Š  @JoinTable()\n+â”Š  â”Š46â”Š  holders: User[]\n+â”Š  â”Š47â”Š\n+â”Š  â”Š48â”Š  @ManyToOne(type => Chat, chat => chat.messages)\n+â”Š  â”Š49â”Š  chat: Chat\n+â”Š  â”Š50â”Š\n+â”Š  â”Š51â”Š  constructor({\n+â”Š  â”Š52â”Š    sender,\n+â”Š  â”Š53â”Š    content,\n+â”Š  â”Š54â”Š    createdAt,\n+â”Š  â”Š55â”Š    type,\n+â”Š  â”Š56â”Š    holders,\n+â”Š  â”Š57â”Š    chat,\n+â”Š  â”Š58â”Š  }: MessageConstructor = {}) {\n+â”Š  â”Š59â”Š    if (sender) {\n+â”Š  â”Š60â”Š      this.sender = sender\n+â”Š  â”Š61â”Š    }\n+â”Š  â”Š62â”Š    if (content) {\n+â”Š  â”Š63â”Š      this.content = content\n+â”Š  â”Š64â”Š    }\n+â”Š  â”Š65â”Š    if (createdAt) {\n+â”Š  â”Š66â”Š      this.createdAt = createdAt\n+â”Š  â”Š67â”Š    }\n+â”Š  â”Š68â”Š    if (type) {\n+â”Š  â”Š69â”Š      this.type = type\n+â”Š  â”Š70â”Š    }\n+â”Š  â”Š71â”Š    if (holders) {\n+â”Š  â”Š72â”Š      this.holders = holders\n+â”Š  â”Š73â”Š    }\n+â”Š  â”Š74â”Š    if (chat) {\n+â”Š  â”Š75â”Š      this.chat = chat\n+â”Š  â”Š76â”Š    }\n+â”Š  â”Š77â”Š  }\n â”Š18â”Š78â”Š}\n â”Š19â”Š79â”Š\n â”Š20â”Š80â”Šexport default Message\n```\n\n##### Changed entity&#x2F;user.ts\n```diff\n@@ -1,10 +1,60 @@\n-â”Š 1â”Š  â”Šexport interface User {\n+â”Š  â”Š 1â”Šimport { Entity, Column, PrimaryGeneratedColumn, ManyToMany, OneToMany } from 'typeorm'\n+â”Š  â”Š 2â”Šimport Chat from './chat'\n+â”Š  â”Š 3â”Šimport Message from './message'\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šinterface UserConstructor {\n+â”Š  â”Š 6â”Š  username?: string\n+â”Š  â”Š 7â”Š  password?: string\n+â”Š  â”Š 8â”Š  name?: string\n+â”Š  â”Š 9â”Š  picture?: string\n+â”Š  â”Š10â”Š}\n+â”Š  â”Š11â”Š\n+â”Š  â”Š12â”Š@Entity('app_user')\n+â”Š  â”Š13â”Šexport class User {\n+â”Š  â”Š14â”Š  @PrimaryGeneratedColumn()\n â”Š 2â”Š15â”Š  id: string\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š  @Column()\n â”Š 3â”Š18â”Š  username: string\n+â”Š  â”Š19â”Š\n+â”Š  â”Š20â”Š  @Column()\n â”Š 4â”Š21â”Š  password: string\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Š  @Column()\n â”Š 5â”Š24â”Š  name: string\n-â”Š 6â”Š  â”Š  picture?: string | null\n-â”Š 7â”Š  â”Š  phone?: string | null\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Š  @Column({ nullable: true })\n+â”Š  â”Š27â”Š  picture: string\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š  @ManyToMany(type => Chat, chat => chat.allTimeMembers)\n+â”Š  â”Š30â”Š  allTimeMemberChats: Chat[]\n+â”Š  â”Š31â”Š\n+â”Š  â”Š32â”Š  @ManyToMany(type => Chat, chat => chat.listingMembers)\n+â”Š  â”Š33â”Š  listingMemberChats: Chat[]\n+â”Š  â”Š34â”Š\n+â”Š  â”Š35â”Š  @ManyToMany(type => Message, message => message.holders)\n+â”Š  â”Š36â”Š  holderMessages: Message[]\n+â”Š  â”Š37â”Š\n+â”Š  â”Š38â”Š  @OneToMany(type => Chat, chat => chat.owner)\n+â”Š  â”Š39â”Š  ownerChats: Chat[]\n+â”Š  â”Š40â”Š\n+â”Š  â”Š41â”Š  @OneToMany(type => Message, message => message.sender)\n+â”Š  â”Š42â”Š  senderMessages: Message[]\n+â”Š  â”Š43â”Š\n+â”Š  â”Š44â”Š  constructor({ username, password, name, picture }: UserConstructor = {}) {\n+â”Š  â”Š45â”Š    if (username) {\n+â”Š  â”Š46â”Š      this.username = username\n+â”Š  â”Š47â”Š    }\n+â”Š  â”Š48â”Š    if (password) {\n+â”Š  â”Š49â”Š      this.password = password\n+â”Š  â”Š50â”Š    }\n+â”Š  â”Š51â”Š    if (name) {\n+â”Š  â”Š52â”Š      this.name = name\n+â”Š  â”Š53â”Š    }\n+â”Š  â”Š54â”Š    if (picture) {\n+â”Š  â”Š55â”Š      this.picture = picture\n+â”Š  â”Š56â”Š    }\n+â”Š  â”Š57â”Š  }\n â”Š 8â”Š58â”Š}\n â”Š 9â”Š59â”Š\n â”Š10â”Š60â”Šexport default User\n```\n\n[}]: #\n\nNow that we have the entities set, we can make requests to Postgres. Let's edit our resolvers to use the entities:\n\n[{]: <helper> (diffStep 1.6 files=\"schema\" module=\"server\")\n\n#### [Step 1.6: Implement resolvers against TypeORM](https://github.com/Urigo/WhatsApp-Clone-Server/commit/d4230cc)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,83 +1,197 @@\n â”Š  1â”Š  1â”Šimport { IResolvers as IApolloResolvers } from 'apollo-server-express'\n â”Š  2â”Š  2â”Šimport { GraphQLDateTime } from 'graphql-iso-date'\n-â”Š  3â”Š   â”Šimport db from '../db'\n â”Š  4â”Š  3â”Šimport Chat from '../entity/chat'\n â”Š  5â”Š  4â”Šimport Message from '../entity/message'\n-â”Š  6â”Š   â”Šimport Recipient from '../entity/recipient'\n â”Š  7â”Š  5â”Šimport User from '../entity/user'\n â”Š  8â”Š  6â”Šimport { IResolvers } from '../types'\n â”Š  9â”Š  7â”Š\n-â”Š 10â”Š   â”Šlet users = db.users\n-â”Š 11â”Š   â”Šlet chats = db.chats\n-â”Š 12â”Š   â”Šconst currentUser: string = '1'\n-â”Š 13â”Š   â”Š\n â”Š 14â”Š  8â”Šexport default {\n â”Š 15â”Š  9â”Š  Date: GraphQLDateTime,\n â”Š 16â”Š 10â”Š  Query: {\n â”Š 17â”Š 11â”Š    // Show all users for the moment.\n-â”Š 18â”Š   â”Š    users: () => users.filter(user => user.id !== currentUser),\n-â”Š 19â”Š   â”Š    chats: () => chats.filter(chat => chat.listingMemberIds.includes(currentUser)),\n-â”Š 20â”Š   â”Š    chat: (obj, { chatId }) => chats.find(chat => chat.id === chatId) || null,\n+â”Š   â”Š 12â”Š    users: (root, args, { connection, currentUser }) => {\n+â”Š   â”Š 13â”Š      return connection.createQueryBuilder(User, 'user').where('user.id != :id', {id: currentUser.id}).getMany();\n+â”Š   â”Š 14â”Š    },\n+â”Š   â”Š 15â”Š\n+â”Š   â”Š 16â”Š    chats: (root, args, { connection, currentUser }) => {\n+â”Š   â”Š 17â”Š      return connection\n+â”Š   â”Š 18â”Š        .createQueryBuilder(Chat, 'chat')\n+â”Š   â”Š 19â”Š        .leftJoin('chat.listingMembers', 'listingMembers')\n+â”Š   â”Š 20â”Š        .where('listingMembers.id = :id', { id: currentUser.id })\n+â”Š   â”Š 21â”Š        .orderBy('chat.createdAt', 'DESC')\n+â”Š   â”Š 22â”Š        .getMany();\n+â”Š   â”Š 23â”Š    },\n+â”Š   â”Š 24â”Š\n+â”Š   â”Š 25â”Š    chat: async (root, { chatId }, { connection }) => {\n+â”Š   â”Š 26â”Š      const chat = await connection\n+â”Š   â”Š 27â”Š        .createQueryBuilder(Chat, 'chat')\n+â”Š   â”Š 28â”Š        .whereInIds(chatId)\n+â”Š   â”Š 29â”Š        .getOne();\n+â”Š   â”Š 30â”Š\n+â”Š   â”Š 31â”Š      return chat || null;\n+â”Š   â”Š 32â”Š    },\n â”Š 21â”Š 33â”Š  },\n+â”Š   â”Š 34â”Š\n â”Š 22â”Š 35â”Š  Chat: {\n-â”Š 23â”Š   â”Š    name: (chat) =>\n-â”Š 24â”Š   â”Š      chat.name\n-â”Š 25â”Š   â”Š        ? chat.name\n-â”Š 26â”Š   â”Š        : users.find(\n-â”Š 27â”Š   â”Š            user => user.id === chat.allTimeMemberIds.find((userId: string) => userId !== currentUser)\n-â”Š 28â”Š   â”Š          )!.name,\n-â”Š 29â”Š   â”Š    picture: (chat) =>\n-â”Š 30â”Š   â”Š      chat.name\n-â”Š 31â”Š   â”Š        ? chat.picture\n-â”Š 32â”Š   â”Š        : users.find(\n-â”Š 33â”Š   â”Š            user => user.id === chat.allTimeMemberIds.find((userId: string) => userId !== currentUser)\n-â”Š 34â”Š   â”Š          )!.picture,\n-â”Š 35â”Š   â”Š    allTimeMembers: (chat) =>\n-â”Š 36â”Š   â”Š      users.filter(user => chat.allTimeMemberIds.includes(user.id)),\n-â”Š 37â”Š   â”Š    listingMembers: (chat) =>\n-â”Š 38â”Š   â”Š      users.filter(user => chat.listingMemberIds.includes(user.id)),\n-â”Š 39â”Š   â”Š    actualGroupMembers: (chat) =>\n-â”Š 40â”Š   â”Š      users.filter(\n-â”Š 41â”Š   â”Š        user => chat.actualGroupMemberIds && chat.actualGroupMemberIds.includes(user.id)\n-â”Š 42â”Š   â”Š      ),\n-â”Š 43â”Š   â”Š    admins: (chat) =>\n-â”Š 44â”Š   â”Š      users.filter(user => chat.adminIds && chat.adminIds.includes(user.id)),\n-â”Š 45â”Š   â”Š    owner: (chat) => users.find(user => chat.ownerId === user.id) || null,\n-â”Š 46â”Š   â”Š    messages: (chat, { amount = 0 }) => {\n-â”Š 47â”Š   â”Š      const messages =\n-â”Š 48â”Š   â”Š        chat.messages\n-â”Š 49â”Š   â”Š          .filter((message: Message) => message.holderIds.includes(currentUser))\n-â”Š 50â”Š   â”Š          .sort((a: Message, b: Message) => b.createdAt - a.createdAt) || []\n-â”Š 51â”Š   â”Š      return (amount ? messages.slice(0, amount) : messages).reverse()\n+â”Š   â”Š 36â”Š    name: async (chat, args, { connection, currentUser }) => {\n+â”Š   â”Š 37â”Š      if (chat.name) {\n+â”Š   â”Š 38â”Š        return chat.name;\n+â”Š   â”Š 39â”Š      }\n+â”Š   â”Š 40â”Š\n+â”Š   â”Š 41â”Š      const user = await connection\n+â”Š   â”Š 42â”Š        .createQueryBuilder(User, 'user')\n+â”Š   â”Š 43â”Š        .where('user.id != :userId', { userId: currentUser.id })\n+â”Š   â”Š 44â”Š        .innerJoin(\n+â”Š   â”Š 45â”Š          'user.allTimeMemberChats',\n+â”Š   â”Š 46â”Š          'allTimeMemberChats',\n+â”Š   â”Š 47â”Š          'allTimeMemberChats.id = :chatId',\n+â”Š   â”Š 48â”Š          { chatId: chat.id },\n+â”Š   â”Š 49â”Š        )\n+â”Š   â”Š 50â”Š        .getOne();\n+â”Š   â”Š 51â”Š\n+â”Š   â”Š 52â”Š      return user ? user.name : null\n+â”Š   â”Š 53â”Š    },\n+â”Š   â”Š 54â”Š\n+â”Š   â”Š 55â”Š    picture: async (chat, args, { connection, currentUser }) => {\n+â”Š   â”Š 56â”Š      if (chat.picture) {\n+â”Š   â”Š 57â”Š        return chat.picture;\n+â”Š   â”Š 58â”Š      }\n+â”Š   â”Š 59â”Š\n+â”Š   â”Š 60â”Š      const user = await connection\n+â”Š   â”Š 61â”Š        .createQueryBuilder(User, 'user')\n+â”Š   â”Š 62â”Š        .where('user.id != :userId', { userId: currentUser.id })\n+â”Š   â”Š 63â”Š        .innerJoin(\n+â”Š   â”Š 64â”Š          'user.allTimeMemberChats',\n+â”Š   â”Š 65â”Š          'allTimeMemberChats',\n+â”Š   â”Š 66â”Š          'allTimeMemberChats.id = :chatId',\n+â”Š   â”Š 67â”Š          { chatId: chat.id },\n+â”Š   â”Š 68â”Š        )\n+â”Š   â”Š 69â”Š        .getOne();\n+â”Š   â”Š 70â”Š\n+â”Š   â”Š 71â”Š      return user ? user.picture : null\n+â”Š   â”Š 72â”Š    },\n+â”Š   â”Š 73â”Š\n+â”Š   â”Š 74â”Š    allTimeMembers: (chat, args, { connection }) => {\n+â”Š   â”Š 75â”Š      return connection\n+â”Š   â”Š 76â”Š        .createQueryBuilder(User, 'user')\n+â”Š   â”Š 77â”Š        .innerJoin(\n+â”Š   â”Š 78â”Š          'user.listingMemberChats',\n+â”Š   â”Š 79â”Š          'listingMemberChats',\n+â”Š   â”Š 80â”Š          'listingMemberChats.id = :chatId',\n+â”Š   â”Š 81â”Š          { chatId: chat.id },\n+â”Š   â”Š 82â”Š        )\n+â”Š   â”Š 83â”Š        .getMany()\n+â”Š   â”Š 84â”Š    },\n+â”Š   â”Š 85â”Š\n+â”Š   â”Š 86â”Š    listingMembers: (chat, args, { connection }) => {\n+â”Š   â”Š 87â”Š      return connection\n+â”Š   â”Š 88â”Š        .createQueryBuilder(User, 'user')\n+â”Š   â”Š 89â”Š        .innerJoin(\n+â”Š   â”Š 90â”Š          'user.listingMemberChats',\n+â”Š   â”Š 91â”Š          'listingMemberChats',\n+â”Š   â”Š 92â”Š          'listingMemberChats.id = :chatId',\n+â”Š   â”Š 93â”Š          { chatId: chat.id },\n+â”Š   â”Š 94â”Š        )\n+â”Š   â”Š 95â”Š        .getMany();\n+â”Š   â”Š 96â”Š    },\n+â”Š   â”Š 97â”Š\n+â”Š   â”Š 98â”Š    owner: async (chat, args, { connection }) => {\n+â”Š   â”Š 99â”Š      const owner = await connection\n+â”Š   â”Š100â”Š        .createQueryBuilder(User, 'user')\n+â”Š   â”Š101â”Š        .innerJoin('user.ownerChats', 'ownerChats', 'ownerChats.id = :chatId', {\n+â”Š   â”Š102â”Š          chatId: chat.id,\n+â”Š   â”Š103â”Š        })\n+â”Š   â”Š104â”Š        .getOne();\n+â”Š   â”Š105â”Š\n+â”Š   â”Š106â”Š      return owner || null;\n+â”Š   â”Š107â”Š    },\n+â”Š   â”Š108â”Š\n+â”Š   â”Š109â”Š    messages: async (chat, { amount = 0 }, { connection, currentUser }) => {\n+â”Š   â”Š110â”Š      if (chat.messages) {\n+â”Š   â”Š111â”Š        return amount ? chat.messages.slice(-amount) : chat.messages;\n+â”Š   â”Š112â”Š      }\n+â”Š   â”Š113â”Š\n+â”Š   â”Š114â”Š      let query = connection\n+â”Š   â”Š115â”Š        .createQueryBuilder(Message, 'message')\n+â”Š   â”Š116â”Š        .innerJoin('message.chat', 'chat', 'chat.id = :chatId', { chatId: chat.id })\n+â”Š   â”Š117â”Š        .innerJoin('message.holders', 'holders', 'holders.id = :userId', {\n+â”Š   â”Š118â”Š          userId: currentUser.id,\n+â”Š   â”Š119â”Š        })\n+â”Š   â”Š120â”Š        .orderBy({ 'message.createdAt': { order: 'DESC', nulls: 'NULLS LAST' } });\n+â”Š   â”Š121â”Š\n+â”Š   â”Š122â”Š      if (amount) {\n+â”Š   â”Š123â”Š        query = query.take(amount);\n+â”Š   â”Š124â”Š      }\n+â”Š   â”Š125â”Š\n+â”Š   â”Š126â”Š      return (await query.getMany()).reverse();\n+â”Š   â”Š127â”Š    },\n+â”Š   â”Š128â”Š\n+â”Š   â”Š129â”Š    lastMessage: async (chat, args, { connection, currentUser }) => {\n+â”Š   â”Š130â”Š      if (chat.messages) {\n+â”Š   â”Š131â”Š        return chat.messages.length ? chat.messages[chat.messages.length - 1] : null;\n+â”Š   â”Š132â”Š      }\n+â”Š   â”Š133â”Š\n+â”Š   â”Š134â”Š      const messages = await connection\n+â”Š   â”Š135â”Š        .createQueryBuilder(Message, 'message')\n+â”Š   â”Š136â”Š        .innerJoin('message.chat', 'chat', 'chat.id = :chatId', { chatId: chat.id })\n+â”Š   â”Š137â”Š        .innerJoin('message.holders', 'holders', 'holders.id = :userId', {\n+â”Š   â”Š138â”Š          userId: currentUser.id,\n+â”Š   â”Š139â”Š        })\n+â”Š   â”Š140â”Š        .orderBy({ 'message.createdAt': { order: 'DESC', nulls: 'NULLS LAST' } })\n+â”Š   â”Š141â”Š        .getMany()\n+â”Š   â”Š142â”Š\n+â”Š   â”Š143â”Š      return messages && messages.length ? messages[messages.length - 1] : null;\n â”Š 52â”Š144â”Š    },\n-â”Š 53â”Š   â”Š    unreadMessages: (chat) =>\n-â”Š 54â”Š   â”Š      chat.messages.filter(\n-â”Š 55â”Š   â”Š        (message: Message) =>\n-â”Š 56â”Š   â”Š          message.holderIds.includes(currentUser) &&\n-â”Š 57â”Š   â”Š          message.recipients.find(\n-â”Š 58â”Š   â”Š            (recipient: Recipient) => recipient.userId === currentUser && !recipient.readAt\n-â”Š 59â”Š   â”Š          )\n-â”Š 60â”Š   â”Š      ).length,\n-â”Š 61â”Š   â”Š    lastMessage: (chat) => chat.messages[chat.messages.length - 1],\n-â”Š 62â”Š   â”Š    isGroup: (chat) => !!chat.name,\n â”Š 63â”Š145â”Š  },\n+â”Š   â”Š146â”Š\n â”Š 64â”Š147â”Š  Message: {\n-â”Š 65â”Š   â”Š    chat: (message) =>\n-â”Š 66â”Š   â”Š      chats.find(chat => message.chatId === chat.id) || null,\n-â”Š 67â”Š   â”Š    sender: (message) =>\n-â”Š 68â”Š   â”Š      users.find(user => user.id === message.senderId) || null,\n-â”Š 69â”Š   â”Š    holders: (message) =>\n-â”Š 70â”Š   â”Š      users.filter(user => message.holderIds.includes(user.id)),\n-â”Š 71â”Š   â”Š    ownership: (message) => message.senderId === currentUser,\n-â”Š 72â”Š   â”Š  },\n-â”Š 73â”Š   â”Š  Recipient: {\n-â”Š 74â”Š   â”Š    user: (recipient) =>\n-â”Š 75â”Š   â”Š      users.find(user => recipient.userId === user.id) || null,\n-â”Š 76â”Š   â”Š    message: (recipient) => {\n-â”Š 77â”Š   â”Š      const chat = chats.find(chat => recipient.chatId === chat.id)\n-â”Š 78â”Š   â”Š      return chat ? chat.messages.find(message => recipient.messageId === message.id) || null : null\n+â”Š   â”Š148â”Š    chat: async (message, args, { connection }) => {\n+â”Š   â”Š149â”Š      const chat = await connection\n+â”Š   â”Š150â”Š        .createQueryBuilder(Chat, 'chat')\n+â”Š   â”Š151â”Š        .innerJoin('chat.messages', 'messages', 'messages.id = :messageId', {\n+â”Š   â”Š152â”Š          messageId: message.id\n+â”Š   â”Š153â”Š        })\n+â”Š   â”Š154â”Š        .getOne();\n+â”Š   â”Š155â”Š\n+â”Š   â”Š156â”Š      if (!chat) {\n+â”Š   â”Š157â”Š        throw new Error(`Message must have a chat.`);\n+â”Š   â”Š158â”Š      }\n+â”Š   â”Š159â”Š\n+â”Š   â”Š160â”Š      return chat;\n+â”Š   â”Š161â”Š    },\n+â”Š   â”Š162â”Š\n+â”Š   â”Š163â”Š    sender: async (message, args, { connection }) => {\n+â”Š   â”Š164â”Š      const sender = await connection\n+â”Š   â”Š165â”Š        .createQueryBuilder(User, 'user')\n+â”Š   â”Š166â”Š        .innerJoin('user.senderMessages', 'senderMessages', 'senderMessages.id = :messageId', {\n+â”Š   â”Š167â”Š          messageId: message.id,\n+â”Š   â”Š168â”Š        })\n+â”Š   â”Š169â”Š        .getOne();\n+â”Š   â”Š170â”Š\n+â”Š   â”Š171â”Š      if (!sender) {\n+â”Š   â”Š172â”Š        throw new Error(`Message must have a sender.`);\n+â”Š   â”Š173â”Š      }\n+â”Š   â”Š174â”Š\n+â”Š   â”Š175â”Š      return sender;\n â”Š 79â”Š176â”Š    },\n-â”Š 80â”Š   â”Š    chat: (recipient) =>\n-â”Š 81â”Š   â”Š      chats.find(chat => recipient.chatId === chat.id) || null,\n+â”Š   â”Š177â”Š\n+â”Š   â”Š178â”Š    holders: async (message, args, { connection }) => {\n+â”Š   â”Š179â”Š      return connection\n+â”Š   â”Š180â”Š        .createQueryBuilder(User, 'user')\n+â”Š   â”Š181â”Š        .innerJoin('user.holderMessages', 'holderMessages', 'holderMessages.id = :messageId', {\n+â”Š   â”Š182â”Š          messageId: message.id,\n+â”Š   â”Š183â”Š        })\n+â”Š   â”Š184â”Š        .getMany();\n+â”Š   â”Š185â”Š    },\n+â”Š   â”Š186â”Š\n+â”Š   â”Š187â”Š    ownership: async (message, args, { connection, currentUser }) => {\n+â”Š   â”Š188â”Š      return !!(await connection\n+â”Š   â”Š189â”Š        .createQueryBuilder(User, 'user')\n+â”Š   â”Š190â”Š        .whereInIds(currentUser.id)\n+â”Š   â”Š191â”Š        .innerJoin('user.senderMessages', 'senderMessages', 'senderMessages.id = :messageId', {\n+â”Š   â”Š192â”Š          messageId: message.id,\n+â”Š   â”Š193â”Š        })\n+â”Š   â”Š194â”Š        .getCount())\n+â”Š   â”Š195â”Š    }\n â”Š 82â”Š196â”Š  },\n â”Š 83â”Š197â”Š} as IResolvers as IApolloResolvers\n```\n\n[}]: #\n\nNotice that we've used a custom scalar type to represent a `Date` object in our GraphQL schema using a package called [`graphql-iso-date`](https://www.npmjs.com/package/graphql-iso-date). Accordingly, let's install this package:\n\n    $ yarn add graphql-iso-date@3.6.1\n    $ yarn add -D @types/graphql-iso-date@3.3.1\n\nAnd update `codegen.yml` to use it in the generated code file:\n\n[{]: <helper> (diffStep 1.6 files=\"codegen\" module=\"server\")\n\n#### [Step 1.6: Implement resolvers against TypeORM](https://github.com/Urigo/WhatsApp-Clone-Server/commit/d4230cc)\n\n##### Changed codegen.yml\n```diff\n@@ -13,3 +13,5 @@\n â”Š13â”Š13â”Š        Chat: ./entity/chat#Chat\n â”Š14â”Š14â”Š        Message: ./entity/message#Message\n â”Š15â”Š15â”Š        User: ./entity/user#User\n+â”Š  â”Š16â”Š      scalars:\n+â”Š  â”Š17â”Š        Date: Date\n```\n\n[}]: #\n\nInstead of fabricating a DB into the memory, we will replace the `db.ts` module with a function that will add sample data, using entities of course. This will be very convenient because this way we can test our app:\n\n[{]: <helper> (diffStep 1.6 files=\"db\" module=\"server\")\n\n#### [Step 1.6: Implement resolvers against TypeORM](https://github.com/Urigo/WhatsApp-Clone-Server/commit/d4230cc)\n\n##### Changed db.ts\n```diff\n@@ -1,274 +1,254 @@\n+â”Š   â”Š  1â”Šimport 'reflect-metadata'\n â”Š  1â”Š  2â”Šimport moment from 'moment'\n-â”Š  2â”Š   â”Šimport Chat from './entity/chat'\n-â”Š  3â”Š   â”Šimport Message, { MessageType } from './entity/message'\n-â”Š  4â”Š   â”Šimport User from './entity/user'\n+â”Š   â”Š  3â”Šimport { Connection } from 'typeorm'\n+â”Š   â”Š  4â”Šimport { Chat } from './entity/chat'\n+â”Š   â”Š  5â”Šimport { Message } from './entity/message'\n+â”Š   â”Š  6â”Šimport { User } from './entity/user'\n â”Š  5â”Š  7â”Š\n-â”Š  6â”Š   â”Šconst users: User[] = [\n-â”Š  7â”Š   â”Š  {\n-â”Š  8â”Š   â”Š    id: '1',\n+â”Š   â”Š  8â”Šexport enum MessageType {\n+â”Š   â”Š  9â”Š  PICTURE,\n+â”Š   â”Š 10â”Š  TEXT,\n+â”Š   â”Š 11â”Š  LOCATION,\n+â”Š   â”Š 12â”Š}\n+â”Š   â”Š 13â”Š\n+â”Š   â”Š 14â”Šexport async function addSampleData(connection: Connection) {\n+â”Š   â”Š 15â”Š  const user1 = new User({\n â”Š  9â”Š 16â”Š    username: 'ethan',\n â”Š 10â”Š 17â”Š    password: '$2a$08$NO9tkFLCoSqX1c5wk3s7z.JfxaVMKA.m7zUDdDwEquo4rvzimQeJm', // 111\n â”Š 11â”Š 18â”Š    name: 'Ethan Gonzalez',\n â”Š 12â”Š 19â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n-â”Š 13â”Š   â”Š  },\n-â”Š 14â”Š   â”Š  {\n-â”Š 15â”Š   â”Š    id: '2',\n+â”Š   â”Š 20â”Š  })\n+â”Š   â”Š 21â”Š  await connection.manager.save(user1)\n+â”Š   â”Š 22â”Š\n+â”Š   â”Š 23â”Š  const user2 = new User({\n â”Š 16â”Š 24â”Š    username: 'bryan',\n â”Š 17â”Š 25â”Š    password: '$2a$08$xE4FuCi/ifxjL2S8CzKAmuKLwv18ktksSN.F3XYEnpmcKtpbpeZgO', // 222\n â”Š 18â”Š 26â”Š    name: 'Bryan Wallace',\n â”Š 19â”Š 27â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n-â”Š 20â”Š   â”Š  },\n-â”Š 21â”Š   â”Š  {\n-â”Š 22â”Š   â”Š    id: '3',\n+â”Š   â”Š 28â”Š  })\n+â”Š   â”Š 29â”Š  await connection.manager.save(user2)\n+â”Š   â”Š 30â”Š\n+â”Š   â”Š 31â”Š  const user3 = new User({\n â”Š 23â”Š 32â”Š    username: 'avery',\n â”Š 24â”Š 33â”Š    password: '$2a$08$UHgH7J8G6z1mGQn2qx2kdeWv0jvgHItyAsL9hpEUI3KJmhVW5Q1d.', // 333\n â”Š 25â”Š 34â”Š    name: 'Avery Stewart',\n â”Š 26â”Š 35â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n-â”Š 27â”Š   â”Š  },\n-â”Š 28â”Š   â”Š  {\n-â”Š 29â”Š   â”Š    id: '4',\n+â”Š   â”Š 36â”Š  })\n+â”Š   â”Š 37â”Š  await connection.manager.save(user3)\n+â”Š   â”Š 38â”Š\n+â”Š   â”Š 39â”Š  const user4 = new User({\n â”Š 30â”Š 40â”Š    username: 'katie',\n â”Š 31â”Š 41â”Š    password: '$2a$08$wR1k5Q3T9FC7fUgB7Gdb9Os/GV7dGBBf4PLlWT7HERMFhmFDt47xi', // 444\n â”Š 32â”Š 42â”Š    name: 'Katie Peterson',\n â”Š 33â”Š 43â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n-â”Š 34â”Š   â”Š  },\n-â”Š 35â”Š   â”Š  {\n-â”Š 36â”Š   â”Š    id: '5',\n+â”Š   â”Š 44â”Š  })\n+â”Š   â”Š 45â”Š  await connection.manager.save(user4)\n+â”Š   â”Š 46â”Š\n+â”Š   â”Š 47â”Š  const user5 = new User({\n â”Š 37â”Š 48â”Š    username: 'ray',\n â”Š 38â”Š 49â”Š    password: '$2a$08$6.mbXqsDX82ZZ7q5d8Osb..JrGSsNp4R3IKj7mxgF6YGT0OmMw242', // 555\n â”Š 39â”Š 50â”Š    name: 'Ray Edwards',\n â”Š 40â”Š 51â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/3.jpg',\n-â”Š 41â”Š   â”Š  },\n-â”Š 42â”Š   â”Š  {\n-â”Š 43â”Š   â”Š    id: '6',\n+â”Š   â”Š 52â”Š  })\n+â”Š   â”Š 53â”Š  await connection.manager.save(user5)\n+â”Š   â”Š 54â”Š\n+â”Š   â”Š 55â”Š  const user6 = new User({\n â”Š 44â”Š 56â”Š    username: 'niko',\n â”Š 45â”Š 57â”Š    password: '$2a$08$fL5lZR.Rwf9FWWe8XwwlceiPBBim8n9aFtaem.INQhiKT4.Ux3Uq.', // 666\n â”Š 46â”Š 58â”Š    name: 'NiccolÃ² Belli',\n â”Š 47â”Š 59â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/4.jpg',\n-â”Š 48â”Š   â”Š  },\n-â”Š 49â”Š   â”Š  {\n-â”Š 50â”Š   â”Š    id: '7',\n+â”Š   â”Š 60â”Š  })\n+â”Š   â”Š 61â”Š  await connection.manager.save(user6)\n+â”Š   â”Š 62â”Š\n+â”Š   â”Š 63â”Š  const user7 = new User({\n â”Š 51â”Š 64â”Š    username: 'mario',\n â”Š 52â”Š 65â”Š    password: '$2a$08$nDHDmWcVxDnH5DDT3HMMC.psqcnu6wBiOgkmJUy9IH..qxa3R6YrO', // 777\n â”Š 53â”Š 66â”Š    name: 'Mario Rossi',\n â”Š 54â”Š 67â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/5.jpg',\n-â”Š 55â”Š   â”Š  },\n-â”Š 56â”Š   â”Š]\n+â”Š   â”Š 68â”Š  })\n+â”Š   â”Š 69â”Š  await connection.manager.save(user7)\n+â”Š   â”Š 70â”Š\n+â”Š   â”Š 71â”Š  await connection.manager.save(\n+â”Š   â”Š 72â”Š    new Chat({\n+â”Š   â”Š 73â”Š      allTimeMembers: [user1, user3],\n+â”Š   â”Š 74â”Š      listingMembers: [user1, user3],\n+â”Š   â”Š 75â”Š      messages: [\n+â”Š   â”Š 76â”Š        new Message({\n+â”Š   â”Š 77â”Š          sender: user1,\n+â”Š   â”Š 78â”Š          content: 'You on your way?',\n+â”Š   â”Š 79â”Š          createdAt: moment()\n+â”Š   â”Š 80â”Š            .subtract(1, 'hours')\n+â”Š   â”Š 81â”Š            .toDate(),\n+â”Š   â”Š 82â”Š          type: MessageType.TEXT,\n+â”Š   â”Š 83â”Š          holders: [user1, user3],\n+â”Š   â”Š 84â”Š        }),\n+â”Š   â”Š 85â”Š        new Message({\n+â”Š   â”Š 86â”Š          sender: user3,\n+â”Š   â”Š 87â”Š          content: 'Yep!',\n+â”Š   â”Š 88â”Š          createdAt: moment()\n+â”Š   â”Š 89â”Š            .subtract(1, 'hours')\n+â”Š   â”Š 90â”Š            .add(5, 'minutes')\n+â”Š   â”Š 91â”Š            .toDate(),\n+â”Š   â”Š 92â”Š          type: MessageType.TEXT,\n+â”Š   â”Š 93â”Š          holders: [user1, user3],\n+â”Š   â”Š 94â”Š        }),\n+â”Š   â”Š 95â”Š      ],\n+â”Š   â”Š 96â”Š    })\n+â”Š   â”Š 97â”Š  )\n+â”Š   â”Š 98â”Š\n+â”Š   â”Š 99â”Š  await connection.manager.save(\n+â”Š   â”Š100â”Š    new Chat({\n+â”Š   â”Š101â”Š      allTimeMembers: [user1, user4],\n+â”Š   â”Š102â”Š      listingMembers: [user1, user4],\n+â”Š   â”Š103â”Š      messages: [\n+â”Š   â”Š104â”Š        new Message({\n+â”Š   â”Š105â”Š          sender: user1,\n+â”Š   â”Š106â”Š          content: \"Hey, it's me\",\n+â”Š   â”Š107â”Š          createdAt: moment()\n+â”Š   â”Š108â”Š            .subtract(2, 'hours')\n+â”Š   â”Š109â”Š            .toDate(),\n+â”Š   â”Š110â”Š          type: MessageType.TEXT,\n+â”Š   â”Š111â”Š          holders: [user1, user4],\n+â”Š   â”Š112â”Š        }),\n+â”Š   â”Š113â”Š      ],\n+â”Š   â”Š114â”Š    })\n+â”Š   â”Š115â”Š  )\n+â”Š   â”Š116â”Š\n+â”Š   â”Š117â”Š  await connection.manager.save(\n+â”Š   â”Š118â”Š    new Chat({\n+â”Š   â”Š119â”Š      allTimeMembers: [user1, user5],\n+â”Š   â”Š120â”Š      listingMembers: [user1, user5],\n+â”Š   â”Š121â”Š      messages: [\n+â”Š   â”Š122â”Š        new Message({\n+â”Š   â”Š123â”Š          sender: user1,\n+â”Š   â”Š124â”Š          content: 'I should buy a boat',\n+â”Š   â”Š125â”Š          createdAt: moment()\n+â”Š   â”Š126â”Š            .subtract(1, 'days')\n+â”Š   â”Š127â”Š            .toDate(),\n+â”Š   â”Š128â”Š          type: MessageType.TEXT,\n+â”Š   â”Š129â”Š          holders: [user1, user5],\n+â”Š   â”Š130â”Š        }),\n+â”Š   â”Š131â”Š        new Message({\n+â”Š   â”Š132â”Š          sender: user1,\n+â”Š   â”Š133â”Š          content: 'You still there?',\n+â”Š   â”Š134â”Š          createdAt: moment()\n+â”Š   â”Š135â”Š            .subtract(1, 'days')\n+â”Š   â”Š136â”Š            .add(16, 'hours')\n+â”Š   â”Š137â”Š            .toDate(),\n+â”Š   â”Š138â”Š          type: MessageType.TEXT,\n+â”Š   â”Š139â”Š          holders: [user1, user5],\n+â”Š   â”Š140â”Š        }),\n+â”Š   â”Š141â”Š      ],\n+â”Š   â”Š142â”Š    })\n+â”Š   â”Š143â”Š  )\n+â”Š   â”Š144â”Š\n+â”Š   â”Š145â”Š  await connection.manager.save(\n+â”Š   â”Š146â”Š    new Chat({\n+â”Š   â”Š147â”Š      allTimeMembers: [user3, user4],\n+â”Š   â”Š148â”Š      listingMembers: [user3, user4],\n+â”Š   â”Š149â”Š      messages: [\n+â”Š   â”Š150â”Š        new Message({\n+â”Š   â”Š151â”Š          sender: user3,\n+â”Š   â”Š152â”Š          content: 'Look at my mukluks!',\n+â”Š   â”Š153â”Š          createdAt: moment()\n+â”Š   â”Š154â”Š            .subtract(4, 'days')\n+â”Š   â”Š155â”Š            .toDate(),\n+â”Š   â”Š156â”Š          type: MessageType.TEXT,\n+â”Š   â”Š157â”Š          holders: [user3, user4],\n+â”Š   â”Š158â”Š        }),\n+â”Š   â”Š159â”Š      ],\n+â”Š   â”Š160â”Š    })\n+â”Š   â”Š161â”Š  )\n+â”Š   â”Š162â”Š\n+â”Š   â”Š163â”Š  await connection.manager.save(\n+â”Š   â”Š164â”Š    new Chat({\n+â”Š   â”Š165â”Š      allTimeMembers: [user2, user5],\n+â”Š   â”Š166â”Š      listingMembers: [user2, user5],\n+â”Š   â”Š167â”Š      messages: [\n+â”Š   â”Š168â”Š        new Message({\n+â”Š   â”Š169â”Š          sender: user2,\n+â”Š   â”Š170â”Š          content: 'This is wicked good ice cream.',\n+â”Š   â”Š171â”Š          createdAt: moment()\n+â”Š   â”Š172â”Š            .subtract(2, 'weeks')\n+â”Š   â”Š173â”Š            .toDate(),\n+â”Š   â”Š174â”Š          type: MessageType.TEXT,\n+â”Š   â”Š175â”Š          holders: [user2, user5],\n+â”Š   â”Š176â”Š        }),\n+â”Š   â”Š177â”Š        new Message({\n+â”Š   â”Š178â”Š          sender: user5,\n+â”Š   â”Š179â”Š          content: 'Love it!',\n+â”Š   â”Š180â”Š          createdAt: moment()\n+â”Š   â”Š181â”Š            .subtract(2, 'weeks')\n+â”Š   â”Š182â”Š            .add(10, 'minutes')\n+â”Š   â”Š183â”Š            .toDate(),\n+â”Š   â”Š184â”Š          type: MessageType.TEXT,\n+â”Š   â”Š185â”Š          holders: [user2, user5],\n+â”Š   â”Š186â”Š        }),\n+â”Š   â”Š187â”Š      ],\n+â”Š   â”Š188â”Š    })\n+â”Š   â”Š189â”Š  )\n+â”Š   â”Š190â”Š\n+â”Š   â”Š191â”Š  await connection.manager.save(\n+â”Š   â”Š192â”Š    new Chat({\n+â”Š   â”Š193â”Š      allTimeMembers: [user1, user6],\n+â”Š   â”Š194â”Š      listingMembers: [user1],\n+â”Š   â”Š195â”Š    })\n+â”Š   â”Š196â”Š  )\n+â”Š   â”Š197â”Š\n+â”Š   â”Š198â”Š  await connection.manager.save(\n+â”Š   â”Š199â”Š    new Chat({\n+â”Š   â”Š200â”Š      allTimeMembers: [user2, user1],\n+â”Š   â”Š201â”Š      listingMembers: [user2],\n+â”Š   â”Š202â”Š    })\n+â”Š   â”Š203â”Š  )\n â”Š 57â”Š204â”Š\n-â”Š 58â”Š   â”Šconst chats: Chat[] = [\n-â”Š 59â”Š   â”Š  {\n-â”Š 60â”Š   â”Š    id: '1',\n-â”Š 61â”Š   â”Š    name: null,\n-â”Š 62â”Š   â”Š    picture: null,\n-â”Š 63â”Š   â”Š    allTimeMemberIds: ['1', '3'],\n-â”Š 64â”Š   â”Š    listingMemberIds: ['1', '3'],\n-â”Š 65â”Š   â”Š    ownerId: null,\n-â”Š 66â”Š   â”Š    messages: [\n-â”Š 67â”Š   â”Š      {\n-â”Š 68â”Š   â”Š        id: '1',\n-â”Š 69â”Š   â”Š        chatId: '1',\n-â”Š 70â”Š   â”Š        senderId: '1',\n-â”Š 71â”Š   â”Š        content: 'You on your way?',\n-â”Š 72â”Š   â”Š        createdAt: moment()\n-â”Š 73â”Š   â”Š          .subtract(1, 'hours')\n-â”Š 74â”Š   â”Š          .unix(),\n-â”Š 75â”Š   â”Š        type: MessageType.TEXT,\n-â”Š 76â”Š   â”Š        holderIds: ['1', '3'],\n-â”Š 77â”Š   â”Š      },\n-â”Š 78â”Š   â”Š      {\n-â”Š 79â”Š   â”Š        id: '2',\n-â”Š 80â”Š   â”Š        chatId: '1',\n-â”Š 81â”Š   â”Š        senderId: '3',\n-â”Š 82â”Š   â”Š        content: 'Yep!',\n-â”Š 83â”Š   â”Š        createdAt: moment()\n-â”Š 84â”Š   â”Š          .subtract(1, 'hours')\n-â”Š 85â”Š   â”Š          .add(5, 'minutes')\n-â”Š 86â”Š   â”Š          .unix(),\n-â”Š 87â”Š   â”Š        type: MessageType.TEXT,\n-â”Š 88â”Š   â”Š        holderIds: ['3', '1'],\n-â”Š 89â”Š   â”Š      },\n-â”Š 90â”Š   â”Š    ],\n-â”Š 91â”Š   â”Š  },\n-â”Š 92â”Š   â”Š  {\n-â”Š 93â”Š   â”Š    id: '2',\n-â”Š 94â”Š   â”Š    name: null,\n-â”Š 95â”Š   â”Š    picture: null,\n-â”Š 96â”Š   â”Š    allTimeMemberIds: ['1', '4'],\n-â”Š 97â”Š   â”Š    listingMemberIds: ['1', '4'],\n-â”Š 98â”Š   â”Š    ownerId: null,\n-â”Š 99â”Š   â”Š    messages: [\n-â”Š100â”Š   â”Š      {\n-â”Š101â”Š   â”Š        id: '1',\n-â”Š102â”Š   â”Š        chatId: '2',\n-â”Š103â”Š   â”Š        senderId: '1',\n-â”Š104â”Š   â”Š        content: \"Hey, it's me\",\n-â”Š105â”Š   â”Š        createdAt: moment()\n-â”Š106â”Š   â”Š          .subtract(2, 'hours')\n-â”Š107â”Š   â”Š          .unix(),\n-â”Š108â”Š   â”Š        type: MessageType.TEXT,\n-â”Š109â”Š   â”Š        holderIds: ['1', '4'],\n-â”Š110â”Š   â”Š      },\n-â”Š111â”Š   â”Š    ],\n-â”Š112â”Š   â”Š  },\n-â”Š113â”Š   â”Š  {\n-â”Š114â”Š   â”Š    id: '3',\n-â”Š115â”Š   â”Š    name: null,\n-â”Š116â”Š   â”Š    picture: null,\n-â”Š117â”Š   â”Š    allTimeMemberIds: ['1', '5'],\n-â”Š118â”Š   â”Š    listingMemberIds: ['1', '5'],\n-â”Š119â”Š   â”Š    ownerId: null,\n-â”Š120â”Š   â”Š    messages: [\n-â”Š121â”Š   â”Š      {\n-â”Š122â”Š   â”Š        id: '1',\n-â”Š123â”Š   â”Š        chatId: '3',\n-â”Š124â”Š   â”Š        senderId: '1',\n-â”Š125â”Š   â”Š        content: 'I should buy a boat',\n-â”Š126â”Š   â”Š        createdAt: moment()\n-â”Š127â”Š   â”Š          .subtract(1, 'days')\n-â”Š128â”Š   â”Š          .unix(),\n-â”Š129â”Š   â”Š        type: MessageType.TEXT,\n-â”Š130â”Š   â”Š        holderIds: ['1', '5'],\n-â”Š131â”Š   â”Š      },\n-â”Š132â”Š   â”Š      {\n-â”Š133â”Š   â”Š        id: '2',\n-â”Š134â”Š   â”Š        chatId: '3',\n-â”Š135â”Š   â”Š        senderId: '1',\n-â”Š136â”Š   â”Š        content: 'You still there?',\n-â”Š137â”Š   â”Š        createdAt: moment()\n-â”Š138â”Š   â”Š          .subtract(1, 'days')\n-â”Š139â”Š   â”Š          .add(16, 'hours')\n-â”Š140â”Š   â”Š          .unix(),\n-â”Š141â”Š   â”Š        type: MessageType.TEXT,\n-â”Š142â”Š   â”Š        holderIds: ['1', '5'],\n-â”Š143â”Š   â”Š      },\n-â”Š144â”Š   â”Š    ],\n-â”Š145â”Š   â”Š  },\n-â”Š146â”Š   â”Š  {\n-â”Š147â”Š   â”Š    id: '4',\n-â”Š148â”Š   â”Š    name: null,\n-â”Š149â”Š   â”Š    picture: null,\n-â”Š150â”Š   â”Š    allTimeMemberIds: ['3', '4'],\n-â”Š151â”Š   â”Š    listingMemberIds: ['3', '4'],\n-â”Š152â”Š   â”Š    ownerId: null,\n-â”Š153â”Š   â”Š    messages: [\n-â”Š154â”Š   â”Š      {\n-â”Š155â”Š   â”Š        id: '1',\n-â”Š156â”Š   â”Š        chatId: '4',\n-â”Š157â”Š   â”Š        senderId: '3',\n-â”Š158â”Š   â”Š        content: 'Look at my mukluks!',\n-â”Š159â”Š   â”Š        createdAt: moment()\n-â”Š160â”Š   â”Š          .subtract(4, 'days')\n-â”Š161â”Š   â”Š          .unix(),\n-â”Š162â”Š   â”Š        type: MessageType.TEXT,\n-â”Š163â”Š   â”Š        holderIds: ['3', '4'],\n-â”Š164â”Š   â”Š      },\n-â”Š165â”Š   â”Š    ],\n-â”Š166â”Š   â”Š  },\n-â”Š167â”Š   â”Š  {\n-â”Š168â”Š   â”Š    id: '5',\n-â”Š169â”Š   â”Š    name: null,\n-â”Š170â”Š   â”Š    picture: null,\n-â”Š171â”Š   â”Š    allTimeMemberIds: ['2', '5'],\n-â”Š172â”Š   â”Š    listingMemberIds: ['2', '5'],\n-â”Š173â”Š   â”Š    ownerId: null,\n-â”Š174â”Š   â”Š    messages: [\n-â”Š175â”Š   â”Š      {\n-â”Š176â”Š   â”Š        id: '1',\n-â”Š177â”Š   â”Š        chatId: '5',\n-â”Š178â”Š   â”Š        senderId: '2',\n-â”Š179â”Š   â”Š        content: 'This is wicked good ice cream.',\n-â”Š180â”Š   â”Š        createdAt: moment()\n-â”Š181â”Š   â”Š          .subtract(2, 'weeks')\n-â”Š182â”Š   â”Š          .unix(),\n-â”Š183â”Š   â”Š        type: MessageType.TEXT,\n-â”Š184â”Š   â”Š        holderIds: ['2', '5'],\n-â”Š185â”Š   â”Š      },\n-â”Š186â”Š   â”Š      {\n-â”Š187â”Š   â”Š        id: '2',\n-â”Š188â”Š   â”Š        chatId: '6',\n-â”Š189â”Š   â”Š        senderId: '5',\n-â”Š190â”Š   â”Š        content: 'Love it!',\n-â”Š191â”Š   â”Š        createdAt: moment()\n-â”Š192â”Š   â”Š          .subtract(2, 'weeks')\n-â”Š193â”Š   â”Š          .add(10, 'minutes')\n-â”Š194â”Š   â”Š          .unix(),\n-â”Š195â”Š   â”Š        type: MessageType.TEXT,\n-â”Š196â”Š   â”Š        holderIds: ['5', '2'],\n-â”Š197â”Š   â”Š      },\n-â”Š198â”Š   â”Š    ],\n-â”Š199â”Š   â”Š  },\n-â”Š200â”Š   â”Š  {\n-â”Š201â”Š   â”Š    id: '6',\n-â”Š202â”Š   â”Š    name: null,\n-â”Š203â”Š   â”Š    picture: null,\n-â”Š204â”Š   â”Š    allTimeMemberIds: ['1', '6'],\n-â”Š205â”Š   â”Š    listingMemberIds: ['1'],\n-â”Š206â”Š   â”Š    ownerId: null,\n-â”Š207â”Š   â”Š    messages: [],\n-â”Š208â”Š   â”Š  },\n-â”Š209â”Š   â”Š  {\n-â”Š210â”Š   â”Š    id: '7',\n-â”Š211â”Š   â”Š    name: null,\n-â”Š212â”Š   â”Š    picture: null,\n-â”Š213â”Š   â”Š    allTimeMemberIds: ['2', '1'],\n-â”Š214â”Š   â”Š    listingMemberIds: ['2'],\n-â”Š215â”Š   â”Š    ownerId: null,\n-â”Š216â”Š   â”Š    messages: [],\n-â”Š217â”Š   â”Š  },\n-â”Š218â”Š   â”Š  {\n-â”Š219â”Š   â”Š    id: '8',\n-â”Š220â”Š   â”Š    name: 'A user 0 group',\n-â”Š221â”Š   â”Š    picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n-â”Š222â”Š   â”Š    allTimeMemberIds: ['1', '3', '4', '6'],\n-â”Š223â”Š   â”Š    listingMemberIds: ['1', '3', '4', '6'],\n-â”Š224â”Š   â”Š    ownerId: '1',\n-â”Š225â”Š   â”Š    messages: [\n-â”Š226â”Š   â”Š      {\n-â”Š227â”Š   â”Š        id: '1',\n-â”Š228â”Š   â”Š        chatId: '8',\n-â”Š229â”Š   â”Š        senderId: '1',\n-â”Š230â”Š   â”Š        content: 'I made a group',\n-â”Š231â”Š   â”Š        createdAt: moment()\n-â”Š232â”Š   â”Š          .subtract(2, 'weeks')\n-â”Š233â”Š   â”Š          .unix(),\n-â”Š234â”Š   â”Š        type: MessageType.TEXT,\n-â”Š235â”Š   â”Š        holderIds: ['1', '3', '4', '6'],\n-â”Š236â”Š   â”Š      },\n-â”Š237â”Š   â”Š      {\n-â”Š238â”Š   â”Š        id: '2',\n-â”Š239â”Š   â”Š        chatId: '8',\n-â”Š240â”Š   â”Š        senderId: '1',\n-â”Š241â”Š   â”Š        content: 'Ops, user 3 was not supposed to be here',\n-â”Š242â”Š   â”Š        createdAt: moment()\n-â”Š243â”Š   â”Š          .subtract(2, 'weeks')\n-â”Š244â”Š   â”Š          .add(2, 'minutes')\n-â”Š245â”Š   â”Š          .unix(),\n-â”Š246â”Š   â”Š        type: MessageType.TEXT,\n-â”Š247â”Š   â”Š        holderIds: ['1', '4', '6'],\n-â”Š248â”Š   â”Š      },\n-â”Š249â”Š   â”Š      {\n-â”Š250â”Š   â”Š        id: '3',\n-â”Š251â”Š   â”Š        chatId: '8',\n-â”Š252â”Š   â”Š        senderId: '4',\n-â”Š253â”Š   â”Š        content: 'Awesome!',\n-â”Š254â”Š   â”Š        createdAt: moment()\n-â”Š255â”Š   â”Š          .subtract(2, 'weeks')\n-â”Š256â”Š   â”Š          .add(10, 'minutes')\n-â”Š257â”Š   â”Š          .unix(),\n-â”Š258â”Š   â”Š        type: MessageType.TEXT,\n-â”Š259â”Š   â”Š        holderIds: ['1', '4', '6'],\n-â”Š260â”Š   â”Š      },\n-â”Š261â”Š   â”Š    ],\n-â”Š262â”Š   â”Š  },\n-â”Š263â”Š   â”Š  {\n-â”Š264â”Š   â”Š    id: '9',\n-â”Š265â”Š   â”Š    name: 'A user 5 group',\n-â”Š266â”Š   â”Š    picture: null,\n-â”Š267â”Š   â”Š    allTimeMemberIds: ['6', '3'],\n-â”Š268â”Š   â”Š    listingMemberIds: ['6', '3'],\n-â”Š269â”Š   â”Š    ownerId: '6',\n-â”Š270â”Š   â”Š    messages: [],\n-â”Š271â”Š   â”Š  },\n-â”Š272â”Š   â”Š]\n+â”Š   â”Š205â”Š  await connection.manager.save(\n+â”Š   â”Š206â”Š    new Chat({\n+â”Š   â”Š207â”Š      name: \"Ethan's group\",\n+â”Š   â”Š208â”Š      picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n+â”Š   â”Š209â”Š      allTimeMembers: [user1, user3, user4, user6],\n+â”Š   â”Š210â”Š      listingMembers: [user1, user3, user4, user6],\n+â”Š   â”Š211â”Š      owner: user1,\n+â”Š   â”Š212â”Š      messages: [\n+â”Š   â”Š213â”Š        new Message({\n+â”Š   â”Š214â”Š          sender: user1,\n+â”Š   â”Š215â”Š          content: 'I made a group',\n+â”Š   â”Š216â”Š          createdAt: moment()\n+â”Š   â”Š217â”Š            .subtract(2, 'weeks')\n+â”Š   â”Š218â”Š            .toDate(),\n+â”Š   â”Š219â”Š          type: MessageType.TEXT,\n+â”Š   â”Š220â”Š          holders: [user1, user3, user4, user6],\n+â”Š   â”Š221â”Š        }),\n+â”Š   â”Š222â”Š        new Message({\n+â”Š   â”Š223â”Š          sender: user1,\n+â”Š   â”Š224â”Š          content: 'Ops, Avery was not supposed to be here',\n+â”Š   â”Š225â”Š          createdAt: moment()\n+â”Š   â”Š226â”Š            .subtract(2, 'weeks')\n+â”Š   â”Š227â”Š            .add(2, 'minutes')\n+â”Š   â”Š228â”Š            .toDate(),\n+â”Š   â”Š229â”Š          type: MessageType.TEXT,\n+â”Š   â”Š230â”Š          holders: [user1, user4, user6],\n+â”Š   â”Š231â”Š        }),\n+â”Š   â”Š232â”Š        new Message({\n+â”Š   â”Š233â”Š          sender: user4,\n+â”Š   â”Š234â”Š          content: 'Awesome!',\n+â”Š   â”Š235â”Š          createdAt: moment()\n+â”Š   â”Š236â”Š            .subtract(2, 'weeks')\n+â”Š   â”Š237â”Š            .add(10, 'minutes')\n+â”Š   â”Š238â”Š            .toDate(),\n+â”Š   â”Š239â”Š          type: MessageType.TEXT,\n+â”Š   â”Š240â”Š          holders: [user1, user4, user6],\n+â”Š   â”Š241â”Š        }),\n+â”Š   â”Š242â”Š      ],\n+â”Š   â”Š243â”Š    })\n+â”Š   â”Š244â”Š  )\n â”Š273â”Š245â”Š\n-â”Š274â”Š   â”Šexport default { users, chats }\n+â”Š   â”Š246â”Š  await connection.manager.save(\n+â”Š   â”Š247â”Š    new Chat({\n+â”Š   â”Š248â”Š      name: \"Ray's group\",\n+â”Š   â”Š249â”Š      allTimeMembers: [user3, user6],\n+â”Š   â”Š250â”Š      listingMembers: [user3, user6],\n+â”Š   â”Š251â”Š      owner: user6,\n+â”Š   â”Š252â”Š    })\n+â”Š   â”Š253â”Š  )\n+â”Š   â”Š254â”Š}\n```\n\n[}]: #\n\nInstead of adding the sample data any time we start the server, we will use an `--add-sample-data` flag which will be provided to the server's process:\n\n[{]: <helper> (diffStep 1.6 files=\"index.ts\" module=\"server\")\n\n#### [Step 1.6: Implement resolvers against TypeORM](https://github.com/Urigo/WhatsApp-Clone-Server/commit/d4230cc)\n\n##### Changed index.ts\n```diff\n@@ -1,3 +1,4 @@\n+â”Š â”Š1â”Šimport 'reflect-metadata'\n â”Š1â”Š2â”Šimport { ApolloServer } from 'apollo-server-express'\n â”Š2â”Š3â”Šimport bodyParser from 'body-parser'\n â”Š3â”Š4â”Šimport cors from 'cors'\n```\n```diff\n@@ -5,11 +6,16 @@\n â”Š 5â”Š 6â”Šimport gql from 'graphql-tag'\n â”Š 6â”Š 7â”Šimport { createServer } from 'http'\n â”Š 7â”Š 8â”Šimport { createConnection } from 'typeorm'\n+â”Š  â”Š 9â”Šimport { addSampleData } from './db'\n â”Š 8â”Š10â”Šimport schema from './schema'\n â”Š 9â”Š11â”Š\n â”Š10â”Š12â”Šconst PORT = 4000\n â”Š11â”Š13â”Š\n â”Š12â”Š14â”ŠcreateConnection().then((connection) => {\n+â”Š  â”Š15â”Š  if (process.argv.includes('--add-sample-data')) {\n+â”Š  â”Š16â”Š    addSampleData(connection)\n+â”Š  â”Š17â”Š  }\n+â”Š  â”Š18â”Š\n â”Š13â”Š19â”Š  const app = express()\n â”Š14â”Š20â”Š\n â”Š15â”Š21â”Š  app.use(cors())\n```\n```diff\n@@ -17,7 +23,10 @@\n â”Š17â”Š23â”Š\n â”Š18â”Š24â”Š  const apollo = new ApolloServer({\n â”Š19â”Š25â”Š    schema,\n-â”Š20â”Š  â”Š    context: () => ({ connection }),\n+â”Š  â”Š26â”Š    context: () => ({\n+â”Š  â”Š27â”Š      connection,\n+â”Š  â”Š28â”Š      currentUser: { id: '1' },\n+â”Š  â”Š29â”Š    }),\n â”Š21â”Š30â”Š  })\n â”Š22â”Š31â”Š\n â”Š23â”Š32â”Š  apollo.applyMiddleware({\n```\n\n[}]: #\n\n> More about processes can be read [here](https://medium.com/the-guild/getting-to-know-nodes-child-process-module-8ed63038f3fa).\n\nMost Apollo-server implementations will assemble the GraphQL schema by importing a bunch of resolvers from different modules, if not having everything in a single place. This often times leads to a lot of problems as maintenance becomes harder the bigger the server gets, especially if we don't have a defined structure. Instead of going with that approach, we will be using [GraphQL-Modules](https://graphql-modules.com) (GQLModules, in short).\n\nThe idea behind GQLModules is to implement the Separation of Concerns design pattern in GraphQL, and to allow you to write simple modules that only do what they need to. This way it's easier to write, maintain and test. You should get a better understanding of GQLModules as we go further with this tutorial.\n\nTo setup GQLModules we will install a couple of packages:\n\n    $ yarn add @graphql-modules/core@0.4.2 @graphql-modules/sonar@0.4.0 @graphql-modules/di@0.4.0\n\n- The `sonar` package will be sued to detect `.graphql` files within our server.\n- The `di` package is responsible for dependencies injection.\n\nNow we're gonna implement a dedicated GraphQL module for each of our entity:\n\n[{]: <helper> (diffStep 1.7 files=\"modules/\\(utils|auth|chat|message|user\\)\" module=\"server\")\n\n#### [Step 1.7: Transition to GraphQL Modules](https://github.com/Urigo/WhatsApp-Clone-Server/commit/b4376a5)\n\n##### Added modules&#x2F;auth&#x2F;index.ts\n```diff\n@@ -0,0 +1,12 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core'\n+â”Š  â”Š 2â”Šimport { Connection } from 'typeorm'\n+â”Š  â”Š 3â”Šimport { AuthProvider } from './providers/auth.provider'\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šexport const AuthModule = new GraphQLModule({\n+â”Š  â”Š 6â”Š  name: 'Auth',\n+â”Š  â”Š 7â”Š  providers: ({ config: { connection } }) => [\n+â”Š  â”Š 8â”Š    { provide: Connection, useValue: connection },\n+â”Š  â”Š 9â”Š    AuthProvider,\n+â”Š  â”Š10â”Š  ],\n+â”Š  â”Š11â”Š  configRequired: true,\n+â”Š  â”Š12â”Š})\n```\n\n##### Added modules&#x2F;auth&#x2F;providers&#x2F;auth.provider.ts\n```diff\n@@ -0,0 +1,27 @@\n+â”Š  â”Š 1â”Šimport { OnRequest } from '@graphql-modules/core'\n+â”Š  â”Š 2â”Šimport { Injectable } from '@graphql-modules/di'\n+â”Š  â”Š 3â”Šimport { Connection } from 'typeorm'\n+â”Š  â”Š 4â”Šimport { User } from '../../../entity/user'\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Š@Injectable()\n+â”Š  â”Š 7â”Šexport class AuthProvider implements OnRequest {\n+â”Š  â”Š 8â”Š  currentUser: User\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Š  constructor(\n+â”Š  â”Š11â”Š    private connection: Connection\n+â”Š  â”Š12â”Š  ) {}\n+â”Š  â”Š13â”Š\n+â”Š  â”Š14â”Š  async onRequest() {\n+â”Š  â”Š15â”Š    if (this.currentUser) return\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š\n+â”Š  â”Š18â”Š    const currentUser = await this.connection\n+â”Š  â”Š19â”Š      .createQueryBuilder(User, 'user')\n+â”Š  â”Š20â”Š      .getOne()\n+â”Š  â”Š21â”Š\n+â”Š  â”Š22â”Š    if (currentUser) {\n+â”Š  â”Š23â”Š      console.log(currentUser)\n+â”Š  â”Š24â”Š      this.currentUser = currentUser\n+â”Š  â”Š25â”Š    }\n+â”Š  â”Š26â”Š  }\n+â”Š  â”Š27â”Š}\n```\n\n##### Added modules&#x2F;chat&#x2F;index.ts\n```diff\n@@ -0,0 +1,16 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core'\n+â”Š  â”Š 2â”Šimport { ProviderScope } from '@graphql-modules/di'\n+â”Š  â”Š 3â”Šimport { loadResolversFiles, loadSchemaFiles } from '@graphql-modules/sonar'\n+â”Š  â”Š 4â”Šimport { AuthModule } from '../auth'\n+â”Š  â”Š 5â”Šimport { UserModule } from '../user'\n+â”Š  â”Š 6â”Šimport { UtilsModule } from '../utils.module'\n+â”Š  â”Š 7â”Šimport { ChatProvider } from './providers/chat.provider'\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Šexport const ChatModule = new GraphQLModule({\n+â”Š  â”Š10â”Š  name: 'Chat',\n+â”Š  â”Š11â”Š  imports: [AuthModule, UtilsModule, UserModule],\n+â”Š  â”Š12â”Š  providers: [ChatProvider],\n+â”Š  â”Š13â”Š  defaultProviderScope: ProviderScope.Session,\n+â”Š  â”Š14â”Š  typeDefs: loadSchemaFiles(__dirname + '/schema/'),\n+â”Š  â”Š15â”Š  resolvers: loadResolversFiles(__dirname + '/resolvers/'),\n+â”Š  â”Š16â”Š})\n```\n\n##### Added modules&#x2F;chat&#x2F;providers&#x2F;chat.provider.ts\n```diff\n@@ -0,0 +1,111 @@\n+â”Š   â”Š  1â”Šimport { Injectable } from '@graphql-modules/di'\n+â”Š   â”Š  2â”Šimport { Connection } from 'typeorm'\n+â”Š   â”Š  3â”Šimport { Chat } from '../../../entity/chat'\n+â”Š   â”Š  4â”Šimport { User } from '../../../entity/user'\n+â”Š   â”Š  5â”Šimport { AuthProvider } from '../../auth/providers/auth.provider'\n+â”Š   â”Š  6â”Šimport { UserProvider } from '../../user/providers/user.provider'\n+â”Š   â”Š  7â”Š\n+â”Š   â”Š  8â”Š@Injectable()\n+â”Š   â”Š  9â”Šexport class ChatProvider {\n+â”Š   â”Š 10â”Š  constructor(\n+â”Š   â”Š 11â”Š    private connection: Connection,\n+â”Š   â”Š 12â”Š    private userProvider: UserProvider,\n+â”Š   â”Š 13â”Š    private authProvider: AuthProvider\n+â”Š   â”Š 14â”Š  ) {}\n+â”Š   â”Š 15â”Š\n+â”Š   â”Š 16â”Š  repository = this.connection.getRepository(Chat)\n+â”Š   â”Š 17â”Š  currentUser = this.authProvider.currentUser\n+â”Š   â”Š 18â”Š\n+â”Š   â”Š 19â”Š  createQueryBuilder() {\n+â”Š   â”Š 20â”Š    return this.connection.createQueryBuilder(Chat, 'chat')\n+â”Š   â”Š 21â”Š  }\n+â”Š   â”Š 22â”Š\n+â”Š   â”Š 23â”Š  async getChats() {\n+â”Š   â”Š 24â”Š    return this.createQueryBuilder()\n+â”Š   â”Š 25â”Š      .leftJoin('chat.listingMembers', 'listingMembers')\n+â”Š   â”Š 26â”Š      .where('listingMembers.id = :id', { id: this.currentUser.id })\n+â”Š   â”Š 27â”Š      .orderBy('chat.createdAt', 'DESC')\n+â”Š   â”Š 28â”Š      .getMany()\n+â”Š   â”Š 29â”Š  }\n+â”Š   â”Š 30â”Š\n+â”Š   â”Š 31â”Š  async getChat(chatId: string) {\n+â”Š   â”Š 32â”Š    const chat = await this.createQueryBuilder()\n+â”Š   â”Š 33â”Š      .whereInIds(chatId)\n+â”Š   â”Š 34â”Š      .getOne()\n+â”Š   â”Š 35â”Š\n+â”Š   â”Š 36â”Š    return chat || null\n+â”Š   â”Š 37â”Š  }\n+â”Š   â”Š 38â”Š\n+â”Š   â”Š 39â”Š  async getChatName(chat: Chat) {\n+â”Š   â”Š 40â”Š    if (chat.name) {\n+â”Š   â”Š 41â”Š      return chat.name\n+â”Š   â”Š 42â”Š    }\n+â”Š   â”Š 43â”Š\n+â”Š   â”Š 44â”Š    const user = await this.userProvider\n+â”Š   â”Š 45â”Š      .createQueryBuilder()\n+â”Š   â”Š 46â”Š      .where('user.id != :userId', { userId: this.currentUser.id })\n+â”Š   â”Š 47â”Š      .innerJoin(\n+â”Š   â”Š 48â”Š        'user.allTimeMemberChats',\n+â”Š   â”Š 49â”Š        'allTimeMemberChats',\n+â”Š   â”Š 50â”Š        'allTimeMemberChats.id = :chatId',\n+â”Š   â”Š 51â”Š        { chatId: chat.id }\n+â”Š   â”Š 52â”Š      )\n+â”Š   â”Š 53â”Š      .getOne()\n+â”Š   â”Š 54â”Š\n+â”Š   â”Š 55â”Š    return (user && user.name) || null\n+â”Š   â”Š 56â”Š  }\n+â”Š   â”Š 57â”Š\n+â”Š   â”Š 58â”Š  async getChatPicture(chat: Chat) {\n+â”Š   â”Š 59â”Š    if (chat.name) {\n+â”Š   â”Š 60â”Š      return chat.picture\n+â”Š   â”Š 61â”Š    }\n+â”Š   â”Š 62â”Š\n+â”Š   â”Š 63â”Š    const user = await this.userProvider\n+â”Š   â”Š 64â”Š      .createQueryBuilder()\n+â”Š   â”Š 65â”Š      .where('user.id != :userId', { userId: this.currentUser.id })\n+â”Š   â”Š 66â”Š      .innerJoin(\n+â”Š   â”Š 67â”Š        'user.allTimeMemberChats',\n+â”Š   â”Š 68â”Š        'allTimeMemberChats',\n+â”Š   â”Š 69â”Š        'allTimeMemberChats.id = :chatId',\n+â”Š   â”Š 70â”Š        { chatId: chat.id }\n+â”Š   â”Š 71â”Š      )\n+â”Š   â”Š 72â”Š      .getOne()\n+â”Š   â”Š 73â”Š\n+â”Š   â”Š 74â”Š    return user ? user.picture : null\n+â”Š   â”Š 75â”Š  }\n+â”Š   â”Š 76â”Š\n+â”Š   â”Š 77â”Š  getChatAllTimeMembers(chat: Chat) {\n+â”Š   â”Š 78â”Š    return this.userProvider\n+â”Š   â”Š 79â”Š      .createQueryBuilder()\n+â”Š   â”Š 80â”Š      .innerJoin(\n+â”Š   â”Š 81â”Š        'user.listingMemberChats',\n+â”Š   â”Š 82â”Š        'listingMemberChats',\n+â”Š   â”Š 83â”Š        'listingMemberChats.id = :chatId',\n+â”Š   â”Š 84â”Š        { chatId: chat.id }\n+â”Š   â”Š 85â”Š      )\n+â”Š   â”Š 86â”Š      .getMany()\n+â”Š   â”Š 87â”Š  }\n+â”Š   â”Š 88â”Š\n+â”Š   â”Š 89â”Š  getChatListingMembers(chat: Chat) {\n+â”Š   â”Š 90â”Š    return this.userProvider\n+â”Š   â”Š 91â”Š      .createQueryBuilder()\n+â”Š   â”Š 92â”Š      .innerJoin(\n+â”Š   â”Š 93â”Š        'user.listingMemberChats',\n+â”Š   â”Š 94â”Š        'listingMemberChats',\n+â”Š   â”Š 95â”Š        'listingMemberChats.id = :chatId',\n+â”Š   â”Š 96â”Š        { chatId: chat.id }\n+â”Š   â”Š 97â”Š      )\n+â”Š   â”Š 98â”Š      .getMany()\n+â”Š   â”Š 99â”Š  }\n+â”Š   â”Š100â”Š\n+â”Š   â”Š101â”Š  async getChatOwner(chat: Chat) {\n+â”Š   â”Š102â”Š    const owner = await this.userProvider\n+â”Š   â”Š103â”Š      .createQueryBuilder()\n+â”Š   â”Š104â”Š      .innerJoin('user.ownerChats', 'ownerChats', 'ownerChats.id = :chatId', {\n+â”Š   â”Š105â”Š        chatId: chat.id,\n+â”Š   â”Š106â”Š      })\n+â”Š   â”Š107â”Š      .getOne()\n+â”Š   â”Š108â”Š\n+â”Š   â”Š109â”Š    return owner || null\n+â”Š   â”Š110â”Š  }\n+â”Š   â”Š111â”Š}\n```\n\n##### Added modules&#x2F;chat&#x2F;resolvers&#x2F;resolvers.ts\n```diff\n@@ -0,0 +1,19 @@\n+â”Š  â”Š 1â”Šimport { ModuleContext } from '@graphql-modules/core'\n+â”Š  â”Š 2â”Šimport { IResolvers } from '../../../types'\n+â”Š  â”Š 3â”Šimport { ChatProvider } from '../providers/chat.provider'\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šexport default {\n+â”Š  â”Š 6â”Š  Query: {\n+â”Š  â”Š 7â”Š    chats: (obj, args, { injector }) => injector.get(ChatProvider).getChats(),\n+â”Š  â”Š 8â”Š    chat: (obj, { chatId }, { injector }) => injector.get(ChatProvider).getChat(chatId),\n+â”Š  â”Š 9â”Š  },\n+â”Š  â”Š10â”Š  Chat: {\n+â”Š  â”Š11â”Š    name: (chat, args, { injector }) => injector.get(ChatProvider).getChatName(chat),\n+â”Š  â”Š12â”Š    picture: (chat, args, { injector }) => injector.get(ChatProvider).getChatPicture(chat),\n+â”Š  â”Š13â”Š    allTimeMembers: (chat, args, { injector }) =>\n+â”Š  â”Š14â”Š      injector.get(ChatProvider).getChatAllTimeMembers(chat),\n+â”Š  â”Š15â”Š    listingMembers: (chat, args, { injector }) =>\n+â”Š  â”Š16â”Š      injector.get(ChatProvider).getChatListingMembers(chat),\n+â”Š  â”Š17â”Š    owner: (chat, args, { injector }) => injector.get(ChatProvider).getChatOwner(chat),\n+â”Š  â”Š18â”Š  },\n+â”Š  â”Š19â”Š} as IResolvers\n```\n\n##### Added modules&#x2F;chat&#x2F;schema&#x2F;typeDefs.graphql\n```diff\n@@ -0,0 +1,19 @@\n+â”Š  â”Š 1â”Štype Query {\n+â”Š  â”Š 2â”Š  chats: [Chat!]!\n+â”Š  â”Š 3â”Š  chat(chatId: ID!): Chat\n+â”Š  â”Š 4â”Š}\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Štype Chat {\n+â”Š  â”Š 7â”Š  #May be a chat or a group\n+â”Š  â”Š 8â”Š  id: ID!\n+â”Š  â”Š 9â”Š  #Computed for chats\n+â”Š  â”Š10â”Š  name: String\n+â”Š  â”Š11â”Š  #Computed for chats\n+â”Š  â”Š12â”Š  picture: String\n+â”Š  â”Š13â”Š  #All members, current and past ones.\n+â”Š  â”Š14â”Š  allTimeMembers: [User!]!\n+â”Š  â”Š15â”Š  #Whoever gets the chat listed. For groups includes past members who still didn't delete the group.\n+â”Š  â”Š16â”Š  listingMembers: [User!]!\n+â”Š  â”Š17â”Š  #If null the group is read-only. Null for chats.\n+â”Š  â”Š18â”Š  owner: User\n+â”Š  â”Š19â”Š}\n```\n\n##### Added modules&#x2F;message&#x2F;index.ts\n```diff\n@@ -0,0 +1,24 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core'\n+â”Š  â”Š 2â”Šimport { ProviderScope } from '@graphql-modules/di'\n+â”Š  â”Š 3â”Šimport { loadResolversFiles, loadSchemaFiles } from '@graphql-modules/sonar'\n+â”Š  â”Š 4â”Šimport { AuthModule } from '../auth'\n+â”Š  â”Š 5â”Šimport { ChatModule } from '../chat'\n+â”Š  â”Š 6â”Šimport { UserModule } from '../user'\n+â”Š  â”Š 7â”Šimport { UtilsModule } from '../utils.module'\n+â”Š  â”Š 8â”Šimport { MessageProvider } from './providers/message.provider'\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Šexport const MessageModule = new GraphQLModule({\n+â”Š  â”Š11â”Š  name: 'Message',\n+â”Š  â”Š12â”Š  imports: [\n+â”Š  â”Š13â”Š    AuthModule,\n+â”Š  â”Š14â”Š    UtilsModule,\n+â”Š  â”Š15â”Š    UserModule,\n+â”Š  â”Š16â”Š    ChatModule,\n+â”Š  â”Š17â”Š  ],\n+â”Š  â”Š18â”Š  providers: [\n+â”Š  â”Š19â”Š    MessageProvider,\n+â”Š  â”Š20â”Š  ],\n+â”Š  â”Š21â”Š  defaultProviderScope: ProviderScope.Session,\n+â”Š  â”Š22â”Š  typeDefs: loadSchemaFiles(__dirname + '/schema/'),\n+â”Š  â”Š23â”Š  resolvers: loadResolversFiles(__dirname + '/resolvers/'),\n+â”Š  â”Š24â”Š})\n```\n\n##### Added modules&#x2F;message&#x2F;providers&#x2F;message.provider.ts\n```diff\n@@ -0,0 +1,142 @@\n+â”Š   â”Š  1â”Šimport { Injectable } from '@graphql-modules/di'\n+â”Š   â”Š  2â”Šimport { Connection } from 'typeorm'\n+â”Š   â”Š  3â”Šimport { MessageType } from '../../../db'\n+â”Š   â”Š  4â”Šimport { Chat } from '../../../entity/chat'\n+â”Š   â”Š  5â”Šimport { Message } from '../../../entity/message'\n+â”Š   â”Š  6â”Šimport { User } from '../../../entity/user'\n+â”Š   â”Š  7â”Šimport { AuthProvider } from '../../auth/providers/auth.provider'\n+â”Š   â”Š  8â”Šimport { ChatProvider } from '../../chat/providers/chat.provider'\n+â”Š   â”Š  9â”Šimport { UserProvider } from '../../user/providers/user.provider'\n+â”Š   â”Š 10â”Š\n+â”Š   â”Š 11â”Š@Injectable()\n+â”Š   â”Š 12â”Šexport class MessageProvider {\n+â”Š   â”Š 13â”Š  constructor(\n+â”Š   â”Š 14â”Š    private connection: Connection,\n+â”Š   â”Š 15â”Š    private chatProvider: ChatProvider,\n+â”Š   â”Š 16â”Š    private authProvider: AuthProvider,\n+â”Š   â”Š 17â”Š    private userProvider: UserProvider\n+â”Š   â”Š 18â”Š  ) {}\n+â”Š   â”Š 19â”Š\n+â”Š   â”Š 20â”Š  repository = this.connection.getRepository(Message)\n+â”Š   â”Š 21â”Š  currentUser = this.authProvider.currentUser\n+â”Š   â”Š 22â”Š\n+â”Š   â”Š 23â”Š  createQueryBuilder() {\n+â”Š   â”Š 24â”Š    return this.connection.createQueryBuilder(Message, 'message')\n+â”Š   â”Š 25â”Š  }\n+â”Š   â”Š 26â”Š\n+â”Š   â”Š 27â”Š  async getMessageSender(message: Message) {\n+â”Š   â”Š 28â”Š    const sender = await this.userProvider\n+â”Š   â”Š 29â”Š      .createQueryBuilder()\n+â”Š   â”Š 30â”Š      .innerJoin('user.senderMessages', 'senderMessages', 'senderMessages.id = :messageId', {\n+â”Š   â”Š 31â”Š        messageId: message.id,\n+â”Š   â”Š 32â”Š      })\n+â”Š   â”Š 33â”Š      .getOne()\n+â”Š   â”Š 34â”Š\n+â”Š   â”Š 35â”Š    if (!sender) {\n+â”Š   â”Š 36â”Š      throw new Error(`Message must have a sender.`)\n+â”Š   â”Š 37â”Š    }\n+â”Š   â”Š 38â”Š\n+â”Š   â”Š 39â”Š    return sender\n+â”Š   â”Š 40â”Š  }\n+â”Š   â”Š 41â”Š\n+â”Š   â”Š 42â”Š  async getMessageOwnership(message: Message) {\n+â”Š   â”Š 43â”Š    return !!(await this.userProvider\n+â”Š   â”Š 44â”Š      .createQueryBuilder()\n+â”Š   â”Š 45â”Š      .whereInIds(this.currentUser.id)\n+â”Š   â”Š 46â”Š      .innerJoin('user.senderMessages', 'senderMessages', 'senderMessages.id = :messageId', {\n+â”Š   â”Š 47â”Š        messageId: message.id,\n+â”Š   â”Š 48â”Š      })\n+â”Š   â”Š 49â”Š      .getCount())\n+â”Š   â”Š 50â”Š  }\n+â”Š   â”Š 51â”Š\n+â”Š   â”Š 52â”Š  async getMessageHolders(message: Message) {\n+â”Š   â”Š 53â”Š    return await this.userProvider\n+â”Š   â”Š 54â”Š      .createQueryBuilder()\n+â”Š   â”Š 55â”Š      .innerJoin('user.holderMessages', 'holderMessages', 'holderMessages.id = :messageId', {\n+â”Š   â”Š 56â”Š        messageId: message.id,\n+â”Š   â”Š 57â”Š      })\n+â”Š   â”Š 58â”Š      .getMany()\n+â”Š   â”Š 59â”Š  }\n+â”Š   â”Š 60â”Š\n+â”Š   â”Š 61â”Š  async getMessageChat(message: Message) {\n+â”Š   â”Š 62â”Š    const chat = await this.chatProvider\n+â”Š   â”Š 63â”Š      .createQueryBuilder()\n+â”Š   â”Š 64â”Š      .innerJoin('chat.messages', 'messages', 'messages.id = :messageId', {\n+â”Š   â”Š 65â”Š        messageId: message.id,\n+â”Š   â”Š 66â”Š      })\n+â”Š   â”Š 67â”Š      .getOne()\n+â”Š   â”Š 68â”Š\n+â”Š   â”Š 69â”Š    if (!chat) {\n+â”Š   â”Š 70â”Š      throw new Error(`Message must have a chat.`)\n+â”Š   â”Š 71â”Š    }\n+â”Š   â”Š 72â”Š\n+â”Š   â”Š 73â”Š    return chat\n+â”Š   â”Š 74â”Š  }\n+â”Š   â”Š 75â”Š\n+â”Š   â”Š 76â”Š  async getChats() {\n+â”Š   â”Š 77â”Š    const chats = await this.chatProvider\n+â”Š   â”Š 78â”Š      .createQueryBuilder()\n+â”Š   â”Š 79â”Š      .leftJoin('chat.listingMembers', 'listingMembers')\n+â”Š   â”Š 80â”Š      .where('listingMembers.id = :id', { id: this.currentUser.id })\n+â”Š   â”Š 81â”Š      .getMany()\n+â”Š   â”Š 82â”Š\n+â”Š   â”Š 83â”Š    for (let chat of chats) {\n+â”Š   â”Š 84â”Š      chat.messages = await this.getChatMessages(chat)\n+â”Š   â”Š 85â”Š    }\n+â”Š   â”Š 86â”Š\n+â”Š   â”Š 87â”Š    return chats.sort((chatA, chatB) => {\n+â”Š   â”Š 88â”Š      const dateA = chatA.messages.length\n+â”Š   â”Š 89â”Š        ? chatA.messages[chatA.messages.length - 1].createdAt\n+â”Š   â”Š 90â”Š        : chatA.createdAt\n+â”Š   â”Š 91â”Š      const dateB = chatB.messages.length\n+â”Š   â”Š 92â”Š        ? chatB.messages[chatB.messages.length - 1].createdAt\n+â”Š   â”Š 93â”Š        : chatB.createdAt\n+â”Š   â”Š 94â”Š      return dateB.valueOf() - dateA.valueOf()\n+â”Š   â”Š 95â”Š    })\n+â”Š   â”Š 96â”Š  }\n+â”Š   â”Š 97â”Š\n+â”Š   â”Š 98â”Š  async getChatMessages(chat: Chat, amount?: number) {\n+â”Š   â”Š 99â”Š    if (chat.messages) {\n+â”Š   â”Š100â”Š      return amount ? chat.messages.slice(-amount) : chat.messages\n+â”Š   â”Š101â”Š    }\n+â”Š   â”Š102â”Š\n+â”Š   â”Š103â”Š    let query = this.createQueryBuilder()\n+â”Š   â”Š104â”Š      .innerJoin('message.chat', 'chat', 'chat.id = :chatId', { chatId: chat.id })\n+â”Š   â”Š105â”Š      .innerJoin('message.holders', 'holders', 'holders.id = :userId', {\n+â”Š   â”Š106â”Š        userId: this.currentUser.id,\n+â”Š   â”Š107â”Š      })\n+â”Š   â”Š108â”Š      .orderBy({ 'message.createdAt': { order: 'DESC', nulls: 'NULLS LAST' } })\n+â”Š   â”Š109â”Š\n+â”Š   â”Š110â”Š    if (amount) {\n+â”Š   â”Š111â”Š      query = query.take(amount)\n+â”Š   â”Š112â”Š    }\n+â”Š   â”Š113â”Š\n+â”Š   â”Š114â”Š    return (await query.getMany()).reverse()\n+â”Š   â”Š115â”Š  }\n+â”Š   â”Š116â”Š\n+â”Š   â”Š117â”Š  async getChatLastMessage(chat: Chat) {\n+â”Š   â”Š118â”Š    if (chat.messages) {\n+â”Š   â”Š119â”Š      return chat.messages.length ? chat.messages[chat.messages.length - 1] : null\n+â”Š   â”Š120â”Š    }\n+â”Š   â”Š121â”Š\n+â”Š   â”Š122â”Š    const messages = await this.getChatMessages(chat, 1)\n+â”Š   â”Š123â”Š\n+â”Š   â”Š124â”Š    return messages && messages.length ? messages[0] : null\n+â”Š   â”Š125â”Š  }\n+â”Š   â”Š126â”Š\n+â”Š   â”Š127â”Š  async getChatUpdatedAt(chat: Chat) {\n+â”Š   â”Š128â”Š    if (chat.messages) {\n+â”Š   â”Š129â”Š      return chat.messages.length ? chat.messages[0].createdAt : null\n+â”Š   â”Š130â”Š    }\n+â”Š   â”Š131â”Š\n+â”Š   â”Š132â”Š    const latestMessage = await this.createQueryBuilder()\n+â”Š   â”Š133â”Š      .innerJoin('message.chat', 'chat', 'chat.id = :chatId', { chatId: chat.id })\n+â”Š   â”Š134â”Š      .innerJoin('message.holders', 'holders', 'holders.id = :userId', {\n+â”Š   â”Š135â”Š        userId: this.currentUser.id,\n+â”Š   â”Š136â”Š      })\n+â”Š   â”Š137â”Š      .orderBy({ 'message.createdAt': 'DESC' })\n+â”Š   â”Š138â”Š      .getOne()\n+â”Š   â”Š139â”Š\n+â”Š   â”Š140â”Š    return latestMessage ? latestMessage.createdAt : null\n+â”Š   â”Š141â”Š  }\n+â”Š   â”Š142â”Š}\n```\n\n##### Added modules&#x2F;message&#x2F;resolvers&#x2F;resolvers.ts\n```diff\n@@ -0,0 +1,29 @@\n+â”Š  â”Š 1â”Šimport { ModuleContext } from '@graphql-modules/core'\n+â”Š  â”Š 2â”Šimport { Message } from '../../../entity/message'\n+â”Š  â”Š 3â”Šimport { IResolvers } from '../../../types'\n+â”Š  â”Š 4â”Šimport { MessageProvider } from '../providers/message.provider'\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šexport default {\n+â”Š  â”Š 7â”Š  Query: {\n+â”Š  â”Š 8â”Š    // The ordering depends on the messages\n+â”Š  â”Š 9â”Š    chats: (obj, args, { injector }) => injector.get(MessageProvider).getChats(),\n+â”Š  â”Š10â”Š  },\n+â”Š  â”Š11â”Š  Chat: {\n+â”Š  â”Š12â”Š    messages: async (chat, { amount }, { injector }) =>\n+â”Š  â”Š13â”Š      injector.get(MessageProvider).getChatMessages(chat, amount || 0),\n+â”Š  â”Š14â”Š    lastMessage: async (chat, args, { injector }) =>\n+â”Š  â”Š15â”Š      injector.get(MessageProvider).getChatLastMessage(chat),\n+â”Š  â”Š16â”Š    updatedAt: async (chat, args, { injector }) =>\n+â”Š  â”Š17â”Š      injector.get(MessageProvider).getChatUpdatedAt(chat),\n+â”Š  â”Š18â”Š  },\n+â”Š  â”Š19â”Š  Message: {\n+â”Š  â”Š20â”Š    sender: async (message, args, { injector }) =>\n+â”Š  â”Š21â”Š      injector.get(MessageProvider).getMessageSender(message),\n+â”Š  â”Š22â”Š    ownership: async (message, args, { injector }) =>\n+â”Š  â”Š23â”Š      injector.get(MessageProvider).getMessageOwnership(message),\n+â”Š  â”Š24â”Š    holders: async (message, args, { injector }) =>\n+â”Š  â”Š25â”Š      injector.get(MessageProvider).getMessageHolders(message),\n+â”Š  â”Š26â”Š    chat: async (message, args, { injector }) =>\n+â”Š  â”Š27â”Š      injector.get(MessageProvider).getMessageChat(message),\n+â”Š  â”Š28â”Š  },\n+â”Š  â”Š29â”Š} as IResolvers\n```\n\n##### Added modules&#x2F;message&#x2F;schema&#x2F;typeDefs.graphql\n```diff\n@@ -0,0 +1,25 @@\n+â”Š  â”Š 1â”Šenum MessageType {\n+â”Š  â”Š 2â”Š  LOCATION\n+â”Š  â”Š 3â”Š  TEXT\n+â”Š  â”Š 4â”Š  PICTURE\n+â”Š  â”Š 5â”Š}\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Šextend type Chat {\n+â”Š  â”Š 8â”Š  messages(amount: Int): [Message]!\n+â”Š  â”Š 9â”Š  lastMessage: Message\n+â”Š  â”Š10â”Š  updatedAt: Date!\n+â”Š  â”Š11â”Š}\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Štype Message {\n+â”Š  â”Š14â”Š  id: ID!\n+â”Š  â”Š15â”Š  sender: User!\n+â”Š  â”Š16â”Š  chat: Chat!\n+â”Š  â”Š17â”Š  content: String!\n+â”Š  â”Š18â”Š  createdAt: Date!\n+â”Š  â”Š19â”Š  #FIXME: should return MessageType\n+â”Š  â”Š20â”Š  type: Int!\n+â”Š  â”Š21â”Š  #Whoever still holds a copy of the message. Cannot be null because the message gets deleted otherwise\n+â”Š  â”Š22â”Š  holders: [User!]!\n+â”Š  â”Š23â”Š  #Computed property\n+â”Š  â”Š24â”Š  ownership: Boolean!\n+â”Š  â”Š25â”Š}\n```\n\n##### Added modules&#x2F;user&#x2F;index.ts\n```diff\n@@ -0,0 +1,18 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core'\n+â”Š  â”Š 2â”Šimport { InjectFunction, ProviderScope } from '@graphql-modules/di'\n+â”Š  â”Š 3â”Šimport { loadResolversFiles, loadSchemaFiles } from '@graphql-modules/sonar'\n+â”Š  â”Š 4â”Šimport { AuthModule } from '../auth'\n+â”Š  â”Š 5â”Šimport { UserProvider } from './providers/user.provider'\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Šexport const UserModule = new GraphQLModule({\n+â”Š  â”Š 8â”Š  name: 'User',\n+â”Š  â”Š 9â”Š  imports: [\n+â”Š  â”Š10â”Š    AuthModule,\n+â”Š  â”Š11â”Š  ],\n+â”Š  â”Š12â”Š  providers: [\n+â”Š  â”Š13â”Š    UserProvider,\n+â”Š  â”Š14â”Š  ],\n+â”Š  â”Š15â”Š  typeDefs: loadSchemaFiles(__dirname + '/schema/'),\n+â”Š  â”Š16â”Š  resolvers: loadResolversFiles(__dirname + '/resolvers/'),\n+â”Š  â”Š17â”Š  defaultProviderScope: ProviderScope.Session,\n+â”Š  â”Š18â”Š})\n```\n\n##### Added modules&#x2F;user&#x2F;providers&#x2F;user.provider.ts\n```diff\n@@ -0,0 +1,22 @@\n+â”Š  â”Š 1â”Šimport { Injectable, ProviderScope } from '@graphql-modules/di'\n+â”Š  â”Š 2â”Šimport { Connection } from 'typeorm'\n+â”Š  â”Š 3â”Šimport { User } from '../../../entity/user'\n+â”Š  â”Š 4â”Šimport { AuthProvider } from '../../auth/providers/auth.provider'\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Š@Injectable()\n+â”Š  â”Š 7â”Šexport class UserProvider {\n+â”Š  â”Š 8â”Š  constructor(private connection: Connection, private authProvider: AuthProvider) {}\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Š  public repository = this.connection.getRepository(User)\n+â”Š  â”Š11â”Š  private currentUser = this.authProvider.currentUser\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Š  createQueryBuilder() {\n+â”Š  â”Š14â”Š    return this.connection.createQueryBuilder(User, 'user')\n+â”Š  â”Š15â”Š  }\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š  getUsers() {\n+â”Š  â”Š18â”Š    return this.createQueryBuilder()\n+â”Š  â”Š19â”Š      .where('user.id != :id', { id: this.currentUser.id })\n+â”Š  â”Š20â”Š      .getMany()\n+â”Š  â”Š21â”Š  }\n+â”Š  â”Š22â”Š}\n```\n\n##### Added modules&#x2F;user&#x2F;resolvers&#x2F;resolvers.ts\n```diff\n@@ -0,0 +1,10 @@\n+â”Š  â”Š 1â”Šimport { ModuleContext } from '@graphql-modules/core'\n+â”Š  â”Š 2â”Šimport { User } from '../../../entity/User'\n+â”Š  â”Š 3â”Šimport { IResolvers } from '../../../types'\n+â”Š  â”Š 4â”Šimport { UserProvider } from '../providers/user.provider'\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šexport default {\n+â”Š  â”Š 7â”Š  Query: {\n+â”Š  â”Š 8â”Š    users: (obj, args, { injector }) => injector.get(UserProvider).getUsers(),\n+â”Š  â”Š 9â”Š  },\n+â”Š  â”Š10â”Š} as IResolvers\n```\n\n##### Added modules&#x2F;user&#x2F;schema&#x2F;typeDefs.graphql\n```diff\n@@ -0,0 +1,10 @@\n+â”Š  â”Š 1â”Štype Query {\n+â”Š  â”Š 2â”Š  users: [User!]\n+â”Š  â”Š 3â”Š}\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Štype User {\n+â”Š  â”Š 6â”Š  id: ID!\n+â”Š  â”Š 7â”Š  name: String\n+â”Š  â”Š 8â”Š  picture: String\n+â”Š  â”Š 9â”Š  phone: String\n+â”Š  â”Š10â”Š}\n```\n\n##### Added modules&#x2F;utils.module.ts\n```diff\n@@ -0,0 +1,12 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core'\n+â”Š  â”Š 2â”Šimport { GraphQLDateTime } from 'graphql-iso-date'\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šexport const UtilsModule = new GraphQLModule({\n+â”Š  â”Š 5â”Š  name: 'Utils',\n+â”Š  â”Š 6â”Š  typeDefs: `\n+â”Š  â”Š 7â”Š    scalar Date\n+â”Š  â”Š 8â”Š  `,\n+â”Š  â”Š 9â”Š  resolvers: {\n+â”Š  â”Š10â”Š    Date: GraphQLDateTime,\n+â”Š  â”Š11â”Š  },\n+â”Š  â”Š12â”Š})\n```\n\n[}]: #\n\nThe implementation of the resolvers is NOT implemented in the resolver functions themselves, but rather in a separate provider. With this working model we can import and use the providers in various modules, not necessarily a specific one. In addition, we can mock the provider handlers, which makes it more testable.\n\nWe've also created a module called `auth`, which will be responsible for authentication in the near future. For now we use a constant for `currentUser` so we can implement the handlers as if we already have authentication.\n\nWe will use a main GQLModule called `app` to connect all our components and export a unified schema:\n\n[{]: <helper> (diffStep 1.7 files=\"modules/app\" module=\"server\")\n\n#### [Step 1.7: Transition to GraphQL Modules](https://github.com/Urigo/WhatsApp-Clone-Server/commit/b4376a5)\n\n##### Added modules&#x2F;app.module.ts\n```diff\n@@ -0,0 +1,24 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core'\n+â”Š  â”Š 2â”Šimport { Connection } from 'typeorm'\n+â”Š  â”Š 3â”Šimport { Express } from 'express'\n+â”Š  â”Š 4â”Šimport { AuthModule } from './auth'\n+â”Š  â”Š 5â”Šimport { UserModule } from './user'\n+â”Š  â”Š 6â”Šimport { ChatModule } from './chat'\n+â”Š  â”Š 7â”Šimport { MessageModule } from './message'\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Šexport interface IAppModuleConfig {\n+â”Š  â”Š10â”Š  connection: Connection;\n+â”Š  â”Š11â”Š}\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Šexport const AppModule = new GraphQLModule<IAppModuleConfig>({\n+â”Š  â”Š14â”Š  name: 'App',\n+â”Š  â”Š15â”Š  imports: ({ config: { connection } }) => [\n+â”Š  â”Š16â”Š    AuthModule.forRoot({\n+â”Š  â”Š17â”Š      connection,\n+â”Š  â”Š18â”Š    }),\n+â”Š  â”Š19â”Š    UserModule,\n+â”Š  â”Š20â”Š    ChatModule,\n+â”Š  â”Š21â”Š    MessageModule,\n+â”Š  â”Š22â”Š  ],\n+â”Š  â”Š23â”Š  configRequired: true,\n+â”Š  â”Š24â”Š})\n```\n\n##### Added modules&#x2F;app.symbols.ts\n```diff\n@@ -0,0 +1 @@\n+â”Š â”Š1â”Šexport const APP = Symbol.for('APP')\n```\n\n[}]: #\n\nAccordingly, we will update the server to use the schema exported by the module we've just created\n\n[{]: <helper> (diffStep 1.7 files=\"index, schema\" module=\"server\")\n\n#### [Step 1.7: Transition to GraphQL Modules](https://github.com/Urigo/WhatsApp-Clone-Server/commit/b4376a5)\n\n##### Changed index.ts\n```diff\n@@ -7,7 +7,7 @@\n â”Š 7â”Š 7â”Šimport { createServer } from 'http'\n â”Š 8â”Š 8â”Šimport { createConnection } from 'typeorm'\n â”Š 9â”Š 9â”Šimport { addSampleData } from './db'\n-â”Š10â”Š  â”Šimport schema from './schema'\n+â”Š  â”Š10â”Šimport { AppModule } from './modules/app.module'\n â”Š11â”Š11â”Š\n â”Š12â”Š12â”Šconst PORT = 4000\n â”Š13â”Š13â”Š\n```\n```diff\n@@ -21,12 +21,11 @@\n â”Š21â”Š21â”Š  app.use(cors())\n â”Š22â”Š22â”Š  app.use(bodyParser.json())\n â”Š23â”Š23â”Š\n+â”Š  â”Š24â”Š  const { schema, context } = AppModule.forRoot({ connection })\n+â”Š  â”Š25â”Š\n â”Š24â”Š26â”Š  const apollo = new ApolloServer({\n â”Š25â”Š27â”Š    schema,\n-â”Š26â”Š  â”Š    context: () => ({\n-â”Š27â”Š  â”Š      connection,\n-â”Š28â”Š  â”Š      currentUser: { id: '1' },\n-â”Š29â”Š  â”Š    }),\n+â”Š  â”Š28â”Š    context,\n â”Š30â”Š29â”Š  })\n â”Š31â”Š30â”Š\n â”Š32â”Š31â”Š  apollo.applyMiddleware({\n```\n\n##### Added modules&#x2F;auth&#x2F;index.ts\n```diff\n@@ -0,0 +1,12 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core'\n+â”Š  â”Š 2â”Šimport { Connection } from 'typeorm'\n+â”Š  â”Š 3â”Šimport { AuthProvider } from './providers/auth.provider'\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šexport const AuthModule = new GraphQLModule({\n+â”Š  â”Š 6â”Š  name: 'Auth',\n+â”Š  â”Š 7â”Š  providers: ({ config: { connection } }) => [\n+â”Š  â”Š 8â”Š    { provide: Connection, useValue: connection },\n+â”Š  â”Š 9â”Š    AuthProvider,\n+â”Š  â”Š10â”Š  ],\n+â”Š  â”Š11â”Š  configRequired: true,\n+â”Š  â”Š12â”Š})\n```\n\n##### Added modules&#x2F;chat&#x2F;index.ts\n```diff\n@@ -0,0 +1,16 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core'\n+â”Š  â”Š 2â”Šimport { ProviderScope } from '@graphql-modules/di'\n+â”Š  â”Š 3â”Šimport { loadResolversFiles, loadSchemaFiles } from '@graphql-modules/sonar'\n+â”Š  â”Š 4â”Šimport { AuthModule } from '../auth'\n+â”Š  â”Š 5â”Šimport { UserModule } from '../user'\n+â”Š  â”Š 6â”Šimport { UtilsModule } from '../utils.module'\n+â”Š  â”Š 7â”Šimport { ChatProvider } from './providers/chat.provider'\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Šexport const ChatModule = new GraphQLModule({\n+â”Š  â”Š10â”Š  name: 'Chat',\n+â”Š  â”Š11â”Š  imports: [AuthModule, UtilsModule, UserModule],\n+â”Š  â”Š12â”Š  providers: [ChatProvider],\n+â”Š  â”Š13â”Š  defaultProviderScope: ProviderScope.Session,\n+â”Š  â”Š14â”Š  typeDefs: loadSchemaFiles(__dirname + '/schema/'),\n+â”Š  â”Š15â”Š  resolvers: loadResolversFiles(__dirname + '/resolvers/'),\n+â”Š  â”Š16â”Š})\n```\n\n##### Added modules&#x2F;chat&#x2F;schema&#x2F;typeDefs.graphql\n```diff\n@@ -0,0 +1,19 @@\n+â”Š  â”Š 1â”Štype Query {\n+â”Š  â”Š 2â”Š  chats: [Chat!]!\n+â”Š  â”Š 3â”Š  chat(chatId: ID!): Chat\n+â”Š  â”Š 4â”Š}\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Štype Chat {\n+â”Š  â”Š 7â”Š  #May be a chat or a group\n+â”Š  â”Š 8â”Š  id: ID!\n+â”Š  â”Š 9â”Š  #Computed for chats\n+â”Š  â”Š10â”Š  name: String\n+â”Š  â”Š11â”Š  #Computed for chats\n+â”Š  â”Š12â”Š  picture: String\n+â”Š  â”Š13â”Š  #All members, current and past ones.\n+â”Š  â”Š14â”Š  allTimeMembers: [User!]!\n+â”Š  â”Š15â”Š  #Whoever gets the chat listed. For groups includes past members who still didn't delete the group.\n+â”Š  â”Š16â”Š  listingMembers: [User!]!\n+â”Š  â”Š17â”Š  #If null the group is read-only. Null for chats.\n+â”Š  â”Š18â”Š  owner: User\n+â”Š  â”Š19â”Š}\n```\n\n##### Added modules&#x2F;message&#x2F;index.ts\n```diff\n@@ -0,0 +1,24 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core'\n+â”Š  â”Š 2â”Šimport { ProviderScope } from '@graphql-modules/di'\n+â”Š  â”Š 3â”Šimport { loadResolversFiles, loadSchemaFiles } from '@graphql-modules/sonar'\n+â”Š  â”Š 4â”Šimport { AuthModule } from '../auth'\n+â”Š  â”Š 5â”Šimport { ChatModule } from '../chat'\n+â”Š  â”Š 6â”Šimport { UserModule } from '../user'\n+â”Š  â”Š 7â”Šimport { UtilsModule } from '../utils.module'\n+â”Š  â”Š 8â”Šimport { MessageProvider } from './providers/message.provider'\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Šexport const MessageModule = new GraphQLModule({\n+â”Š  â”Š11â”Š  name: 'Message',\n+â”Š  â”Š12â”Š  imports: [\n+â”Š  â”Š13â”Š    AuthModule,\n+â”Š  â”Š14â”Š    UtilsModule,\n+â”Š  â”Š15â”Š    UserModule,\n+â”Š  â”Š16â”Š    ChatModule,\n+â”Š  â”Š17â”Š  ],\n+â”Š  â”Š18â”Š  providers: [\n+â”Š  â”Š19â”Š    MessageProvider,\n+â”Š  â”Š20â”Š  ],\n+â”Š  â”Š21â”Š  defaultProviderScope: ProviderScope.Session,\n+â”Š  â”Š22â”Š  typeDefs: loadSchemaFiles(__dirname + '/schema/'),\n+â”Š  â”Š23â”Š  resolvers: loadResolversFiles(__dirname + '/resolvers/'),\n+â”Š  â”Š24â”Š})\n```\n\n##### Added modules&#x2F;message&#x2F;schema&#x2F;typeDefs.graphql\n```diff\n@@ -0,0 +1,25 @@\n+â”Š  â”Š 1â”Šenum MessageType {\n+â”Š  â”Š 2â”Š  LOCATION\n+â”Š  â”Š 3â”Š  TEXT\n+â”Š  â”Š 4â”Š  PICTURE\n+â”Š  â”Š 5â”Š}\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Šextend type Chat {\n+â”Š  â”Š 8â”Š  messages(amount: Int): [Message]!\n+â”Š  â”Š 9â”Š  lastMessage: Message\n+â”Š  â”Š10â”Š  updatedAt: Date!\n+â”Š  â”Š11â”Š}\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Štype Message {\n+â”Š  â”Š14â”Š  id: ID!\n+â”Š  â”Š15â”Š  sender: User!\n+â”Š  â”Š16â”Š  chat: Chat!\n+â”Š  â”Š17â”Š  content: String!\n+â”Š  â”Š18â”Š  createdAt: Date!\n+â”Š  â”Š19â”Š  #FIXME: should return MessageType\n+â”Š  â”Š20â”Š  type: Int!\n+â”Š  â”Š21â”Š  #Whoever still holds a copy of the message. Cannot be null because the message gets deleted otherwise\n+â”Š  â”Š22â”Š  holders: [User!]!\n+â”Š  â”Š23â”Š  #Computed property\n+â”Š  â”Š24â”Š  ownership: Boolean!\n+â”Š  â”Š25â”Š}\n```\n\n##### Added modules&#x2F;user&#x2F;index.ts\n```diff\n@@ -0,0 +1,18 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core'\n+â”Š  â”Š 2â”Šimport { InjectFunction, ProviderScope } from '@graphql-modules/di'\n+â”Š  â”Š 3â”Šimport { loadResolversFiles, loadSchemaFiles } from '@graphql-modules/sonar'\n+â”Š  â”Š 4â”Šimport { AuthModule } from '../auth'\n+â”Š  â”Š 5â”Šimport { UserProvider } from './providers/user.provider'\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Šexport const UserModule = new GraphQLModule({\n+â”Š  â”Š 8â”Š  name: 'User',\n+â”Š  â”Š 9â”Š  imports: [\n+â”Š  â”Š10â”Š    AuthModule,\n+â”Š  â”Š11â”Š  ],\n+â”Š  â”Š12â”Š  providers: [\n+â”Š  â”Š13â”Š    UserProvider,\n+â”Š  â”Š14â”Š  ],\n+â”Š  â”Š15â”Š  typeDefs: loadSchemaFiles(__dirname + '/schema/'),\n+â”Š  â”Š16â”Š  resolvers: loadResolversFiles(__dirname + '/resolvers/'),\n+â”Š  â”Š17â”Š  defaultProviderScope: ProviderScope.Session,\n+â”Š  â”Š18â”Š})\n```\n\n##### Added modules&#x2F;user&#x2F;schema&#x2F;typeDefs.graphql\n```diff\n@@ -0,0 +1,10 @@\n+â”Š  â”Š 1â”Štype Query {\n+â”Š  â”Š 2â”Š  users: [User!]\n+â”Š  â”Š 3â”Š}\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Štype User {\n+â”Š  â”Š 6â”Š  id: ID!\n+â”Š  â”Š 7â”Š  name: String\n+â”Š  â”Š 8â”Š  picture: String\n+â”Š  â”Š 9â”Š  phone: String\n+â”Š  â”Š10â”Š}\n```\n\n##### Changed schema&#x2F;index.ts\n```diff\n@@ -1,8 +1,4 @@\n-â”Š1â”Š â”Šimport { makeExecutableSchema } from 'apollo-server-express'\n-â”Š2â”Š â”Šimport resolvers from './resolvers'\n-â”Š3â”Š â”Šimport typeDefs from './typeDefs'\n+â”Š â”Š1â”Šimport 'reflect-metadata'\n+â”Š â”Š2â”Šimport { AppModule } from '../modules/app.module'\n â”Š4â”Š3â”Š\n-â”Š5â”Š â”Šexport default makeExecutableSchema({\n-â”Š6â”Š â”Š  typeDefs,\n-â”Š7â”Š â”Š  resolvers,\n-â”Š8â”Š â”Š})\n+â”Š â”Š4â”Šexport default AppModule.forRoot({} as any).schema\n```\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,197 +1,4 @@\n-â”Š  1â”Š   â”Šimport { IResolvers as IApolloResolvers } from 'apollo-server-express'\n-â”Š  2â”Š   â”Šimport { GraphQLDateTime } from 'graphql-iso-date'\n-â”Š  3â”Š   â”Šimport Chat from '../entity/chat'\n-â”Š  4â”Š   â”Šimport Message from '../entity/message'\n-â”Š  5â”Š   â”Šimport User from '../entity/user'\n-â”Š  6â”Š   â”Šimport { IResolvers } from '../types'\n+â”Š   â”Š  1â”Šimport 'reflect-metadata'\n+â”Š   â”Š  2â”Šimport { AppModule } from '../modules/app.module'\n â”Š  7â”Š  3â”Š\n-â”Š  8â”Š   â”Šexport default {\n-â”Š  9â”Š   â”Š  Date: GraphQLDateTime,\n-â”Š 10â”Š   â”Š  Query: {\n-â”Š 11â”Š   â”Š    // Show all users for the moment.\n-â”Š 12â”Š   â”Š    users: (root, args, { connection, currentUser }) => {\n-â”Š 13â”Š   â”Š      return connection.createQueryBuilder(User, 'user').where('user.id != :id', {id: currentUser.id}).getMany();\n-â”Š 14â”Š   â”Š    },\n-â”Š 15â”Š   â”Š\n-â”Š 16â”Š   â”Š    chats: (root, args, { connection, currentUser }) => {\n-â”Š 17â”Š   â”Š      return connection\n-â”Š 18â”Š   â”Š        .createQueryBuilder(Chat, 'chat')\n-â”Š 19â”Š   â”Š        .leftJoin('chat.listingMembers', 'listingMembers')\n-â”Š 20â”Š   â”Š        .where('listingMembers.id = :id', { id: currentUser.id })\n-â”Š 21â”Š   â”Š        .orderBy('chat.createdAt', 'DESC')\n-â”Š 22â”Š   â”Š        .getMany();\n-â”Š 23â”Š   â”Š    },\n-â”Š 24â”Š   â”Š\n-â”Š 25â”Š   â”Š    chat: async (root, { chatId }, { connection }) => {\n-â”Š 26â”Š   â”Š      const chat = await connection\n-â”Š 27â”Š   â”Š        .createQueryBuilder(Chat, 'chat')\n-â”Š 28â”Š   â”Š        .whereInIds(chatId)\n-â”Š 29â”Š   â”Š        .getOne();\n-â”Š 30â”Š   â”Š\n-â”Š 31â”Š   â”Š      return chat || null;\n-â”Š 32â”Š   â”Š    },\n-â”Š 33â”Š   â”Š  },\n-â”Š 34â”Š   â”Š\n-â”Š 35â”Š   â”Š  Chat: {\n-â”Š 36â”Š   â”Š    name: async (chat, args, { connection, currentUser }) => {\n-â”Š 37â”Š   â”Š      if (chat.name) {\n-â”Š 38â”Š   â”Š        return chat.name;\n-â”Š 39â”Š   â”Š      }\n-â”Š 40â”Š   â”Š\n-â”Š 41â”Š   â”Š      const user = await connection\n-â”Š 42â”Š   â”Š        .createQueryBuilder(User, 'user')\n-â”Š 43â”Š   â”Š        .where('user.id != :userId', { userId: currentUser.id })\n-â”Š 44â”Š   â”Š        .innerJoin(\n-â”Š 45â”Š   â”Š          'user.allTimeMemberChats',\n-â”Š 46â”Š   â”Š          'allTimeMemberChats',\n-â”Š 47â”Š   â”Š          'allTimeMemberChats.id = :chatId',\n-â”Š 48â”Š   â”Š          { chatId: chat.id },\n-â”Š 49â”Š   â”Š        )\n-â”Š 50â”Š   â”Š        .getOne();\n-â”Š 51â”Š   â”Š\n-â”Š 52â”Š   â”Š      return user ? user.name : null\n-â”Š 53â”Š   â”Š    },\n-â”Š 54â”Š   â”Š\n-â”Š 55â”Š   â”Š    picture: async (chat, args, { connection, currentUser }) => {\n-â”Š 56â”Š   â”Š      if (chat.picture) {\n-â”Š 57â”Š   â”Š        return chat.picture;\n-â”Š 58â”Š   â”Š      }\n-â”Š 59â”Š   â”Š\n-â”Š 60â”Š   â”Š      const user = await connection\n-â”Š 61â”Š   â”Š        .createQueryBuilder(User, 'user')\n-â”Š 62â”Š   â”Š        .where('user.id != :userId', { userId: currentUser.id })\n-â”Š 63â”Š   â”Š        .innerJoin(\n-â”Š 64â”Š   â”Š          'user.allTimeMemberChats',\n-â”Š 65â”Š   â”Š          'allTimeMemberChats',\n-â”Š 66â”Š   â”Š          'allTimeMemberChats.id = :chatId',\n-â”Š 67â”Š   â”Š          { chatId: chat.id },\n-â”Š 68â”Š   â”Š        )\n-â”Š 69â”Š   â”Š        .getOne();\n-â”Š 70â”Š   â”Š\n-â”Š 71â”Š   â”Š      return user ? user.picture : null\n-â”Š 72â”Š   â”Š    },\n-â”Š 73â”Š   â”Š\n-â”Š 74â”Š   â”Š    allTimeMembers: (chat, args, { connection }) => {\n-â”Š 75â”Š   â”Š      return connection\n-â”Š 76â”Š   â”Š        .createQueryBuilder(User, 'user')\n-â”Š 77â”Š   â”Š        .innerJoin(\n-â”Š 78â”Š   â”Š          'user.listingMemberChats',\n-â”Š 79â”Š   â”Š          'listingMemberChats',\n-â”Š 80â”Š   â”Š          'listingMemberChats.id = :chatId',\n-â”Š 81â”Š   â”Š          { chatId: chat.id },\n-â”Š 82â”Š   â”Š        )\n-â”Š 83â”Š   â”Š        .getMany()\n-â”Š 84â”Š   â”Š    },\n-â”Š 85â”Š   â”Š\n-â”Š 86â”Š   â”Š    listingMembers: (chat, args, { connection }) => {\n-â”Š 87â”Š   â”Š      return connection\n-â”Š 88â”Š   â”Š        .createQueryBuilder(User, 'user')\n-â”Š 89â”Š   â”Š        .innerJoin(\n-â”Š 90â”Š   â”Š          'user.listingMemberChats',\n-â”Š 91â”Š   â”Š          'listingMemberChats',\n-â”Š 92â”Š   â”Š          'listingMemberChats.id = :chatId',\n-â”Š 93â”Š   â”Š          { chatId: chat.id },\n-â”Š 94â”Š   â”Š        )\n-â”Š 95â”Š   â”Š        .getMany();\n-â”Š 96â”Š   â”Š    },\n-â”Š 97â”Š   â”Š\n-â”Š 98â”Š   â”Š    owner: async (chat, args, { connection }) => {\n-â”Š 99â”Š   â”Š      const owner = await connection\n-â”Š100â”Š   â”Š        .createQueryBuilder(User, 'user')\n-â”Š101â”Š   â”Š        .innerJoin('user.ownerChats', 'ownerChats', 'ownerChats.id = :chatId', {\n-â”Š102â”Š   â”Š          chatId: chat.id,\n-â”Š103â”Š   â”Š        })\n-â”Š104â”Š   â”Š        .getOne();\n-â”Š105â”Š   â”Š\n-â”Š106â”Š   â”Š      return owner || null;\n-â”Š107â”Š   â”Š    },\n-â”Š108â”Š   â”Š\n-â”Š109â”Š   â”Š    messages: async (chat, { amount = 0 }, { connection, currentUser }) => {\n-â”Š110â”Š   â”Š      if (chat.messages) {\n-â”Š111â”Š   â”Š        return amount ? chat.messages.slice(-amount) : chat.messages;\n-â”Š112â”Š   â”Š      }\n-â”Š113â”Š   â”Š\n-â”Š114â”Š   â”Š      let query = connection\n-â”Š115â”Š   â”Š        .createQueryBuilder(Message, 'message')\n-â”Š116â”Š   â”Š        .innerJoin('message.chat', 'chat', 'chat.id = :chatId', { chatId: chat.id })\n-â”Š117â”Š   â”Š        .innerJoin('message.holders', 'holders', 'holders.id = :userId', {\n-â”Š118â”Š   â”Š          userId: currentUser.id,\n-â”Š119â”Š   â”Š        })\n-â”Š120â”Š   â”Š        .orderBy({ 'message.createdAt': { order: 'DESC', nulls: 'NULLS LAST' } });\n-â”Š121â”Š   â”Š\n-â”Š122â”Š   â”Š      if (amount) {\n-â”Š123â”Š   â”Š        query = query.take(amount);\n-â”Š124â”Š   â”Š      }\n-â”Š125â”Š   â”Š\n-â”Š126â”Š   â”Š      return (await query.getMany()).reverse();\n-â”Š127â”Š   â”Š    },\n-â”Š128â”Š   â”Š\n-â”Š129â”Š   â”Š    lastMessage: async (chat, args, { connection, currentUser }) => {\n-â”Š130â”Š   â”Š      if (chat.messages) {\n-â”Š131â”Š   â”Š        return chat.messages.length ? chat.messages[chat.messages.length - 1] : null;\n-â”Š132â”Š   â”Š      }\n-â”Š133â”Š   â”Š\n-â”Š134â”Š   â”Š      const messages = await connection\n-â”Š135â”Š   â”Š        .createQueryBuilder(Message, 'message')\n-â”Š136â”Š   â”Š        .innerJoin('message.chat', 'chat', 'chat.id = :chatId', { chatId: chat.id })\n-â”Š137â”Š   â”Š        .innerJoin('message.holders', 'holders', 'holders.id = :userId', {\n-â”Š138â”Š   â”Š          userId: currentUser.id,\n-â”Š139â”Š   â”Š        })\n-â”Š140â”Š   â”Š        .orderBy({ 'message.createdAt': { order: 'DESC', nulls: 'NULLS LAST' } })\n-â”Š141â”Š   â”Š        .getMany()\n-â”Š142â”Š   â”Š\n-â”Š143â”Š   â”Š      return messages && messages.length ? messages[messages.length - 1] : null;\n-â”Š144â”Š   â”Š    },\n-â”Š145â”Š   â”Š  },\n-â”Š146â”Š   â”Š\n-â”Š147â”Š   â”Š  Message: {\n-â”Š148â”Š   â”Š    chat: async (message, args, { connection }) => {\n-â”Š149â”Š   â”Š      const chat = await connection\n-â”Š150â”Š   â”Š        .createQueryBuilder(Chat, 'chat')\n-â”Š151â”Š   â”Š        .innerJoin('chat.messages', 'messages', 'messages.id = :messageId', {\n-â”Š152â”Š   â”Š          messageId: message.id\n-â”Š153â”Š   â”Š        })\n-â”Š154â”Š   â”Š        .getOne();\n-â”Š155â”Š   â”Š\n-â”Š156â”Š   â”Š      if (!chat) {\n-â”Š157â”Š   â”Š        throw new Error(`Message must have a chat.`);\n-â”Š158â”Š   â”Š      }\n-â”Š159â”Š   â”Š\n-â”Š160â”Š   â”Š      return chat;\n-â”Š161â”Š   â”Š    },\n-â”Š162â”Š   â”Š\n-â”Š163â”Š   â”Š    sender: async (message, args, { connection }) => {\n-â”Š164â”Š   â”Š      const sender = await connection\n-â”Š165â”Š   â”Š        .createQueryBuilder(User, 'user')\n-â”Š166â”Š   â”Š        .innerJoin('user.senderMessages', 'senderMessages', 'senderMessages.id = :messageId', {\n-â”Š167â”Š   â”Š          messageId: message.id,\n-â”Š168â”Š   â”Š        })\n-â”Š169â”Š   â”Š        .getOne();\n-â”Š170â”Š   â”Š\n-â”Š171â”Š   â”Š      if (!sender) {\n-â”Š172â”Š   â”Š        throw new Error(`Message must have a sender.`);\n-â”Š173â”Š   â”Š      }\n-â”Š174â”Š   â”Š\n-â”Š175â”Š   â”Š      return sender;\n-â”Š176â”Š   â”Š    },\n-â”Š177â”Š   â”Š\n-â”Š178â”Š   â”Š    holders: async (message, args, { connection }) => {\n-â”Š179â”Š   â”Š      return connection\n-â”Š180â”Š   â”Š        .createQueryBuilder(User, 'user')\n-â”Š181â”Š   â”Š        .innerJoin('user.holderMessages', 'holderMessages', 'holderMessages.id = :messageId', {\n-â”Š182â”Š   â”Š          messageId: message.id,\n-â”Š183â”Š   â”Š        })\n-â”Š184â”Š   â”Š        .getMany();\n-â”Š185â”Š   â”Š    },\n-â”Š186â”Š   â”Š\n-â”Š187â”Š   â”Š    ownership: async (message, args, { connection, currentUser }) => {\n-â”Š188â”Š   â”Š      return !!(await connection\n-â”Š189â”Š   â”Š        .createQueryBuilder(User, 'user')\n-â”Š190â”Š   â”Š        .whereInIds(currentUser.id)\n-â”Š191â”Š   â”Š        .innerJoin('user.senderMessages', 'senderMessages', 'senderMessages.id = :messageId', {\n-â”Š192â”Š   â”Š          messageId: message.id,\n-â”Š193â”Š   â”Š        })\n-â”Š194â”Š   â”Š        .getCount())\n-â”Š195â”Š   â”Š    }\n-â”Š196â”Š   â”Š  },\n-â”Š197â”Š   â”Š} as IResolvers as IApolloResolvers\n+â”Š   â”Š  4â”Šexport default AppModule.forRoot({} as any).resolvers\n```\n\n##### Changed schema&#x2F;typeDefs.ts\n```diff\n@@ -1,54 +1,4 @@\n-â”Š 1â”Š  â”Šexport default `\n-â”Š 2â”Š  â”Š  scalar Date\n+â”Š  â”Š 1â”Šimport 'reflect-metadata'\n+â”Š  â”Š 2â”Šimport { AppModule } from '../modules/app.module'\n â”Š 3â”Š 3â”Š\n-â”Š 4â”Š  â”Š  type Query {\n-â”Š 5â”Š  â”Š    users: [User!]\n-â”Š 6â”Š  â”Š    chats: [Chat!]\n-â”Š 7â”Š  â”Š    chat(chatId: ID!): Chat\n-â”Š 8â”Š  â”Š  }\n-â”Š 9â”Š  â”Š\n-â”Š10â”Š  â”Š  enum MessageType {\n-â”Š11â”Š  â”Š    LOCATION\n-â”Š12â”Š  â”Š    TEXT\n-â”Š13â”Š  â”Š    PICTURE\n-â”Š14â”Š  â”Š  }\n-â”Š15â”Š  â”Š\n-â”Š16â”Š  â”Š  type Chat {\n-â”Š17â”Š  â”Š    #May be a chat or a group\n-â”Š18â”Š  â”Š    id: ID!\n-â”Š19â”Š  â”Š    #Computed for chats\n-â”Š20â”Š  â”Š    name: String\n-â”Š21â”Š  â”Š    updatedAt: Date\n-â”Š22â”Š  â”Š    #Computed for chats\n-â”Š23â”Š  â”Š    picture: String\n-â”Š24â”Š  â”Š    #All members, current and past ones.\n-â”Š25â”Š  â”Š    allTimeMembers: [User!]!\n-â”Š26â”Š  â”Š    #Whoever gets the chat listed. For groups includes past members who still didn't delete the group.\n-â”Š27â”Š  â”Š    listingMembers: [User!]!\n-â”Š28â”Š  â”Š    #If null the group is read-only. Null for chats.\n-â”Š29â”Š  â”Š    owner: User\n-â”Š30â”Š  â”Š    messages(amount: Int): [Message]!\n-â”Š31â”Š  â”Š    lastMessage: Message\n-â”Š32â”Š  â”Š  }\n-â”Š33â”Š  â”Š\n-â”Š34â”Š  â”Š  type Message {\n-â”Š35â”Š  â”Š    id: ID!\n-â”Š36â”Š  â”Š    sender: User!\n-â”Š37â”Š  â”Š    chat: Chat!\n-â”Š38â”Š  â”Š    content: String!\n-â”Š39â”Š  â”Š    createdAt: Date!\n-â”Š40â”Š  â”Š    #FIXME: should return MessageType\n-â”Š41â”Š  â”Š    type: Int!\n-â”Š42â”Š  â”Š    #Whoever still holds a copy of the message. Cannot be null because the message gets deleted otherwise\n-â”Š43â”Š  â”Š    holders: [User!]!\n-â”Š44â”Š  â”Š    #Computed property\n-â”Š45â”Š  â”Š    ownership: Boolean!\n-â”Š46â”Š  â”Š  }\n-â”Š47â”Š  â”Š\n-â”Š48â”Š  â”Š  type User {\n-â”Š49â”Š  â”Š    id: ID!\n-â”Š50â”Š  â”Š    name: String\n-â”Š51â”Š  â”Š    picture: String\n-â”Š52â”Š  â”Š    phone: String\n-â”Š53â”Š  â”Š  }\n-â”Š54â”Š  â”Š`\n+â”Š  â”Š 4â”Šexport default AppModule.forRoot({} as any).typeDefs\n```\n\n[}]: #\n\nNow try to run the app again and see how things work. Of course, there shouldn't be any visual differences, but know that having a DB as an essential step.\n\n    $ yarn start --reset-dummy-data\n\nIn the next step we refactor our back-end so it can be more maintainable, and we will setup a basic authentication mechanism. WhatsApp is not WhatsApp without authentication!"
          },
          {
            "manualTitle": "Step 2: Authentication",
            "stepRevision": "20987e42da0e1af0ecaf80aaeb7f251f8c061b59",
            "manualView": "![login](https://user-images.githubusercontent.com/7648874/52663083-c9b4ea00-2f40-11e9-9783-bf36fd88e4bb.png)\n\nAs we're probably all familiar with WhatsApp, the app surrounds around authentication. It's a very crucial part because without authentication there would be no way to identify users and who communicates with whom. On top of all we would like to keep things private, because we don't want personal information to leak to other people. Although the original WhatsApp uses phone authentication with an SMS code, in our app we're gonna keep things simple and use a basic authentication.\n\nThe authentication flow in the front-end app is simple and consists of the following:\n\n- Sign-Up\n- Sign-In\n- Settings\n- Sign-Out\n\nThe more complicated part comes when we have to match each data with its owner and check if a user is authorized to perform an operation or not.\n\n### Server authentication\n\nAuthentication is a hot topic in the GraphQL world and there are some projects which aim at authenticating through GraphQL. Since often you will be required to use a specific auth framework (because of a feature you need or because of an existing authorization infrastructure) I will show you how to use a classic REST API framework within your GraphQL application. This approach is completely fine and in line with the official GraphQL best practices. We will use `Passport` for the authentication and `BasicAuth` as the auth mechanism:\n\n    $ yarn add bcrypt-nodejs@0.0.3 passport@0.4.0 passport-http@0.3.0\n    $ yarn add -D @types/bcrypt-nodejs@0.0.30 @types/passport@1.0.0 @types/passport-http@0.3.7\n\n`BasicAuth` is basically responsible for sending a username and password in an Authorization Header together with each request and it's fully supported by any browser (meaning that we will be able to use Graphiql simply by proving username and password in the login window provided by the browser itself). It's the most simple auth mechanism but it's completely fine for our needs. Later we could decide to use something more complicated like JWT, but it's outside of the scope of this tutorial.\n\nWe will connect the auth logic to our Express app within the auth GQLModule. Indeed, GQLModules can also be used to apply logic which is not directly related to GraphQL. This method is excellent because it ensures that our GraphQL resolvers will be set with the right infrastructure right out of the box and we can safely reuse the module:\n\n[{]: <helper> (diffStep 2.1 files=\"app, modules/auth\" module=\"server\")\n\n#### [Step 2.1: Add auth routes](https://github.com/Urigo/WhatsApp-Clone-Server/commit/fd32b7f)\n\n##### Changed modules&#x2F;app.module.ts\n```diff\n@@ -7,13 +7,15 @@\n â”Š 7â”Š 7â”Šimport { MessageModule } from './message'\n â”Š 8â”Š 8â”Š\n â”Š 9â”Š 9â”Šexport interface IAppModuleConfig {\n-â”Š10â”Š  â”Š  connection: Connection;\n+â”Š  â”Š10â”Š  connection: Connection\n+â”Š  â”Š11â”Š  app: Express\n â”Š11â”Š12â”Š}\n â”Š12â”Š13â”Š\n â”Š13â”Š14â”Šexport const AppModule = new GraphQLModule<IAppModuleConfig>({\n â”Š14â”Š15â”Š  name: 'App',\n-â”Š15â”Š  â”Š  imports: ({ config: { connection } }) => [\n+â”Š  â”Š16â”Š  imports: ({ config: { app, connection } }) => [\n â”Š16â”Š17â”Š    AuthModule.forRoot({\n+â”Š  â”Š18â”Š      app,\n â”Š17â”Š19â”Š      connection,\n â”Š18â”Š20â”Š    }),\n â”Š19â”Š21â”Š    UserModule,\n```\n\n##### Changed modules&#x2F;auth&#x2F;index.ts\n```diff\n@@ -1,12 +1,61 @@\n â”Š 1â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core'\n+â”Š  â”Š 2â”Šimport { loadResolversFiles, loadSchemaFiles } from '@graphql-modules/sonar'\n+â”Š  â”Š 3â”Šimport { Express } from 'express'\n â”Š 2â”Š 4â”Šimport { Connection } from 'typeorm'\n â”Š 3â”Š 5â”Šimport { AuthProvider } from './providers/auth.provider'\n+â”Š  â”Š 6â”Šimport { APP } from '../app.symbols'\n+â”Š  â”Š 7â”Šimport { PubSub } from 'apollo-server-express'\n+â”Š  â”Š 8â”Šimport passport from 'passport'\n+â”Š  â”Š 9â”Šimport basicStrategy from 'passport-http'\n+â”Š  â”Š10â”Šimport { InjectFunction } from '@graphql-modules/di'\n â”Š 4â”Š11â”Š\n-â”Š 5â”Š  â”Šexport const AuthModule = new GraphQLModule({\n+â”Š  â”Š12â”Šexport interface IAppModuleConfig {\n+â”Š  â”Š13â”Š  connection: Connection\n+â”Š  â”Š14â”Š  app: Express\n+â”Š  â”Š15â”Š}\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Šexport const AuthModule = new GraphQLModule<IAppModuleConfig>({\n â”Š 6â”Š18â”Š  name: 'Auth',\n-â”Š 7â”Š  â”Š  providers: ({ config: { connection } }) => [\n+â”Š  â”Š19â”Š  providers: ({ config: { connection, app } }) => [\n â”Š 8â”Š20â”Š    { provide: Connection, useValue: connection },\n+â”Š  â”Š21â”Š    { provide: APP, useValue: app },\n+â”Š  â”Š22â”Š    PubSub,\n â”Š 9â”Š23â”Š    AuthProvider,\n â”Š10â”Š24â”Š  ],\n+â”Š  â”Š25â”Š  typeDefs: loadSchemaFiles(__dirname + '/schema/'),\n+â”Š  â”Š26â”Š  resolvers: loadResolversFiles(__dirname + '/resolvers/'),\n â”Š11â”Š27â”Š  configRequired: true,\n+â”Š  â”Š28â”Š  middleware: InjectFunction(AuthProvider, APP)((authProvider, app: Express) => {\n+â”Š  â”Š29â”Š    passport.use(\n+â”Š  â”Š30â”Š      'basic-signin',\n+â”Š  â”Š31â”Š      new basicStrategy.BasicStrategy(async (username: string, password: string, done: any) => {\n+â”Š  â”Š32â”Š        done(null, await authProvider.signIn(username, password))\n+â”Š  â”Š33â”Š      })\n+â”Š  â”Š34â”Š    )\n+â”Š  â”Š35â”Š\n+â”Š  â”Š36â”Š    passport.use(\n+â”Š  â”Š37â”Š      'basic-signup',\n+â”Š  â”Š38â”Š      new basicStrategy.BasicStrategy(\n+â”Š  â”Š39â”Š        { passReqToCallback: true },\n+â”Š  â”Š40â”Š        async (\n+â”Š  â”Š41â”Š          req: Express.Request & { body: { name?: string } },\n+â”Š  â”Š42â”Š          username: string,\n+â”Š  â”Š43â”Š          password: string,\n+â”Š  â”Š44â”Š          done: any\n+â”Š  â”Š45â”Š        ) => {\n+â”Š  â”Š46â”Š          const name = req.body.name\n+â”Š  â”Š47â”Š          return done(null, !!name && (await authProvider.signUp(username, password, name)))\n+â”Š  â”Š48â”Š        }\n+â”Š  â”Š49â”Š      )\n+â”Š  â”Š50â”Š    )\n+â”Š  â”Š51â”Š\n+â”Š  â”Š52â”Š    app.post('/signup', passport.authenticate('basic-signup', { session: false }), (req, res) =>\n+â”Š  â”Š53â”Š      res.json(req.user)\n+â”Š  â”Š54â”Š    )\n+â”Š  â”Š55â”Š\n+â”Š  â”Š56â”Š    app.use(passport.authenticate('basic-signin', { session: false }))\n+â”Š  â”Š57â”Š\n+â”Š  â”Š58â”Š    app.post('/signin', (req, res) => res.json(req.user))\n+â”Š  â”Š59â”Š    return {}\n+â”Š  â”Š60â”Š  }),\n â”Š12â”Š61â”Š})\n```\n\n##### Changed modules&#x2F;auth&#x2F;providers&#x2F;auth.provider.ts\n```diff\n@@ -1,27 +1,75 @@\n-â”Š 1â”Š  â”Šimport { OnRequest } from '@graphql-modules/core'\n-â”Š 2â”Š  â”Šimport { Injectable } from '@graphql-modules/di'\n+â”Š  â”Š 1â”Šimport { Injectable, ProviderScope } from '@graphql-modules/di'\n+â”Š  â”Š 2â”Šimport { ModuleSessionInfo, OnRequest, OnConnect } from '@graphql-modules/core'\n â”Š 3â”Š 3â”Šimport { Connection } from 'typeorm'\n â”Š 4â”Š 4â”Šimport { User } from '../../../entity/user'\n+â”Š  â”Š 5â”Šimport bcrypt from 'bcrypt-nodejs'\n â”Š 5â”Š 6â”Š\n-â”Š 6â”Š  â”Š@Injectable()\n-â”Š 7â”Š  â”Šexport class AuthProvider implements OnRequest {\n+â”Š  â”Š 7â”Š@Injectable({\n+â”Š  â”Š 8â”Š  scope: ProviderScope.Session,\n+â”Š  â”Š 9â”Š})\n+â”Š  â”Š10â”Šexport class AuthProvider implements OnRequest, OnConnect {\n â”Š 8â”Š11â”Š  currentUser: User\n â”Š 9â”Š12â”Š\n-â”Š10â”Š  â”Š  constructor(\n-â”Š11â”Š  â”Š    private connection: Connection\n-â”Š12â”Š  â”Š  ) {}\n+â”Š  â”Š13â”Š  constructor(private connection: Connection) {}\n â”Š13â”Š14â”Š\n-â”Š14â”Š  â”Š  async onRequest() {\n-â”Š15â”Š  â”Š    if (this.currentUser) return\n+â”Š  â”Š15â”Š  onRequest({ session }: ModuleSessionInfo) {\n+â”Š  â”Š16â”Š    if ('req' in session) {\n+â”Š  â”Š17â”Š      this.currentUser = session.req.user\n+â”Š  â”Š18â”Š    }\n+â”Š  â”Š19â”Š  }\n+â”Š  â”Š20â”Š\n+â”Š  â”Š21â”Š  async onConnect(connectionParams: { authToken?: string }) {\n+â”Š  â”Š22â”Š    if (connectionParams.authToken) {\n+â”Š  â”Š23â”Š      // Create a buffer and tell it the data coming in is base64\n+â”Š  â”Š24â”Š      const buf = Buffer.from(connectionParams.authToken.split(' ')[1], 'base64')\n+â”Š  â”Š25â”Š      // Read it back out as a string\n+â”Š  â”Š26â”Š      const [username, password]: string[] = buf.toString().split(':')\n+â”Š  â”Š27â”Š      const user = await this.signIn(username, password)\n+â”Š  â”Š28â”Š      if (user) {\n+â”Š  â”Š29â”Š        // Set context for the WebSocket\n+â”Š  â”Š30â”Š        this.currentUser = user\n+â”Š  â”Š31â”Š      } else {\n+â”Š  â”Š32â”Š        throw new Error('Wrong credentials!')\n+â”Š  â”Š33â”Š      }\n+â”Š  â”Š34â”Š    } else {\n+â”Š  â”Š35â”Š      throw new Error('Missing auth token!')\n+â”Š  â”Š36â”Š    }\n+â”Š  â”Š37â”Š  }\n â”Š16â”Š38â”Š\n+â”Š  â”Š39â”Š  getUserByUsername(username: string) {\n+â”Š  â”Š40â”Š    return this.connection.getRepository(User).findOne({ where: { username } })\n+â”Š  â”Š41â”Š  }\n â”Š17â”Š42â”Š\n-â”Š18â”Š  â”Š    const currentUser = await this.connection\n-â”Š19â”Š  â”Š      .createQueryBuilder(User, 'user')\n-â”Š20â”Š  â”Š      .getOne()\n+â”Š  â”Š43â”Š  async signIn(username: string, password: string): Promise<User | false> {\n+â”Š  â”Š44â”Š    const user = await this.getUserByUsername(username)\n+â”Š  â”Š45â”Š    if (user && this.validPassword(password, user.password)) {\n+â”Š  â”Š46â”Š      return user\n+â”Š  â”Š47â”Š    } else {\n+â”Š  â”Š48â”Š      return false\n+â”Š  â”Š49â”Š    }\n+â”Š  â”Š50â”Š  }\n â”Š21â”Š51â”Š\n-â”Š22â”Š  â”Š    if (currentUser) {\n-â”Š23â”Š  â”Š      console.log(currentUser)\n-â”Š24â”Š  â”Š      this.currentUser = currentUser\n+â”Š  â”Š52â”Š  async signUp(username: string, password: string, name: string): Promise<User | false> {\n+â”Š  â”Š53â”Š    const userExists = !!(await this.getUserByUsername(username))\n+â”Š  â”Š54â”Š    if (!userExists) {\n+â”Š  â”Š55â”Š      const user = this.connection.manager.save(\n+â”Š  â”Š56â”Š        new User({\n+â”Š  â”Š57â”Š          username,\n+â”Š  â”Š58â”Š          password: this.generateHash(password),\n+â”Š  â”Š59â”Š          name,\n+â”Š  â”Š60â”Š        })\n+â”Š  â”Š61â”Š      )\n+â”Š  â”Š62â”Š      return user\n+â”Š  â”Š63â”Š    } else {\n+â”Š  â”Š64â”Š      return false\n â”Š25â”Š65â”Š    }\n â”Š26â”Š66â”Š  }\n+â”Š  â”Š67â”Š\n+â”Š  â”Š68â”Š  generateHash(password: string) {\n+â”Š  â”Š69â”Š    return bcrypt.hashSync(password, bcrypt.genSaltSync(8))\n+â”Š  â”Š70â”Š  }\n+â”Š  â”Š71â”Š\n+â”Š  â”Š72â”Š  validPassword(password: string, localPassword: string) {\n+â”Š  â”Š73â”Š    return bcrypt.compareSync(password, localPassword)\n+â”Š  â”Š74â”Š  }\n â”Š27â”Š75â”Š}\n```\n\n[}]: #\n\nWe are going to store hashes instead of plain passwords, that's why we're using `bcrypt-nodejs`. With `passport.use('basic-signin')` and `passport.use('basic-signup')` we define how the auth framework deals with our database. `app.post('/signup')` is the endpoint for creating new accounts, so we left it out of the authentication middleware (`app.use(passport.authenticate('basic-signin')`).\n\nWe will also add an additional query called `me` which will simply return the user which is currently logged in. This will come in handy in the client:\n\n[{]: <helper> (diffStep 2.1 files=\"modules/user\" module=\"server\")\n\n#### [Step 2.1: Add auth routes](https://github.com/Urigo/WhatsApp-Clone-Server/commit/fd32b7f)\n\n##### Changed modules&#x2F;user&#x2F;providers&#x2F;user.provider.ts\n```diff\n@@ -14,6 +14,10 @@\n â”Š14â”Š14â”Š    return this.connection.createQueryBuilder(User, 'user')\n â”Š15â”Š15â”Š  }\n â”Š16â”Š16â”Š\n+â”Š  â”Š17â”Š  getMe() {\n+â”Š  â”Š18â”Š    return this.currentUser\n+â”Š  â”Š19â”Š  }\n+â”Š  â”Š20â”Š\n â”Š17â”Š21â”Š  getUsers() {\n â”Š18â”Š22â”Š    return this.createQueryBuilder()\n â”Š19â”Š23â”Š      .where('user.id != :id', { id: this.currentUser.id })\n```\n\n##### Changed modules&#x2F;user&#x2F;resolvers&#x2F;resolvers.ts\n```diff\n@@ -5,6 +5,7 @@\n â”Š 5â”Š 5â”Š\n â”Š 6â”Š 6â”Šexport default {\n â”Š 7â”Š 7â”Š  Query: {\n+â”Š  â”Š 8â”Š    me: (obj, args, { injector }) => injector.get(UserProvider).getMe(),\n â”Š 8â”Š 9â”Š    users: (obj, args, { injector }) => injector.get(UserProvider).getUsers(),\n â”Š 9â”Š10â”Š  },\n â”Š10â”Š11â”Š} as IResolvers\n```\n\n##### Changed modules&#x2F;user&#x2F;schema&#x2F;typeDefs.graphql\n```diff\n@@ -1,4 +1,5 @@\n â”Š1â”Š1â”Štype Query {\n+â”Š â”Š2â”Š  me: User\n â”Š2â”Š3â”Š  users: [User!]\n â”Š3â”Š4â”Š}\n â”Š4â”Š5â”Š\n```\n\n[}]: #\n\n### Client authentication\n\nTo make things more convenient, we will create a dedicated authentication service under a separate module called `auth.service.tsx`. The auth service will take care of:\n\n- Performing sign-in/sign-up against the server.\n- Storing received auth token in local storage.\n- Providing a wrapper around guarded routes that require authorization.\n\n[{]: <helper> (diffStep 2.1 files=\"src/services, src/graphql\" module=\"client\")\n\n#### [Step 2.1: Add auth service](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/e01ef20)\n\n##### Changed src&#x2F;graphql&#x2F;fragments&#x2F;index.ts\n```diff\n@@ -1,2 +1,3 @@\n â”Š1â”Š1â”Šexport { default as chat } from './chat.fragment'\n â”Š2â”Š2â”Šexport { default as message } from './message.fragment'\n+â”Š â”Š3â”Šexport { default as user } from './user.fragment'\n```\n\n##### Added src&#x2F;graphql&#x2F;fragments&#x2F;user.fragment.ts\n```diff\n@@ -0,0 +1,9 @@\n+â”Š â”Š1â”Šimport gql from 'graphql-tag'\n+â”Š â”Š2â”Š\n+â”Š â”Š3â”Šexport default gql`\n+â”Š â”Š4â”Š  fragment User on User {\n+â”Š â”Š5â”Š    id\n+â”Š â”Š6â”Š    name\n+â”Š â”Š7â”Š    picture\n+â”Š â”Š8â”Š  }\n+â”Š â”Š9â”Š`\n```\n\n##### Added src&#x2F;graphql&#x2F;queries&#x2F;index.ts\n```diff\n@@ -0,0 +1 @@\n+â”Š â”Š1â”Šexport { default as me } from './me.query'\n```\n\n##### Added src&#x2F;graphql&#x2F;queries&#x2F;me.query.ts\n```diff\n@@ -0,0 +1,11 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag'\n+â”Š  â”Š 2â”Šimport * as fragments from '../fragments'\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šexport default gql `\n+â”Š  â”Š 5â”Š  query Me {\n+â”Š  â”Š 6â”Š    me {\n+â”Š  â”Š 7â”Š      ...User\n+â”Š  â”Š 8â”Š    }\n+â”Š  â”Š 9â”Š  }\n+â”Š  â”Š10â”Š  ${fragments.user}\n+â”Š  â”Š11â”Š`\n```\n\n##### Added src&#x2F;services&#x2F;auth.service.tsx\n```diff\n@@ -0,0 +1,84 @@\n+â”Š  â”Š 1â”Šimport * as React from 'react'\n+â”Š  â”Š 2â”Šimport { useContext } from 'react'\n+â”Š  â”Š 3â”Šimport { useQuery } from 'react-apollo-hooks'\n+â”Š  â”Š 4â”Šimport { Redirect } from 'react-router-dom'\n+â”Š  â”Š 5â”Šimport store from '../apollo-client'\n+â”Š  â”Š 6â”Šimport * as queries from '../graphql/queries'\n+â”Š  â”Š 7â”Šimport { Me, User } from '../graphql/types'\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Šconst MyContext = React.createContext<User.Fragment>(null)\n+â”Š  â”Š10â”Š\n+â”Š  â”Š11â”Šexport const useMe = () => {\n+â”Š  â”Š12â”Š  return useContext(MyContext)\n+â”Š  â”Š13â”Š}\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”Šexport const withAuth = (Component: React.ComponentType) => {\n+â”Š  â”Š16â”Š  return props => {\n+â”Š  â”Š17â”Š    if (!getAuthHeader()) return <Redirect to=\"/sign-in\" />\n+â”Š  â”Š18â”Š\n+â”Š  â”Š19â”Š    // Validating against server\n+â”Š  â”Š20â”Š    const myResult = useQuery<Me.Query>(queries.me, { suspend: true })\n+â”Š  â”Š21â”Š\n+â”Š  â”Š22â”Š    // Override TypeScript definition issue with the current version\n+â”Š  â”Š23â”Š    if (myResult.error) return <Redirect to=\"/sign-in\" />\n+â”Š  â”Š24â”Š\n+â”Š  â”Š25â”Š    return (\n+â”Š  â”Š26â”Š      <MyContext.Provider value={myResult.data.me}>\n+â”Š  â”Š27â”Š        <Component {...props} />\n+â”Š  â”Š28â”Š      </MyContext.Provider>\n+â”Š  â”Š29â”Š    )\n+â”Š  â”Š30â”Š  }\n+â”Š  â”Š31â”Š}\n+â”Š  â”Š32â”Š\n+â”Š  â”Š33â”Šexport const storeAuthHeader = (auth: string) => {\n+â”Š  â”Š34â”Š  localStorage.setItem('Authorization', auth)\n+â”Š  â”Š35â”Š}\n+â”Š  â”Š36â”Š\n+â”Š  â”Š37â”Šexport const getAuthHeader = (): string | null => {\n+â”Š  â”Š38â”Š  return localStorage.getItem('Authorization') || null\n+â”Š  â”Š39â”Š}\n+â”Š  â”Š40â”Š\n+â”Š  â”Š41â”Šexport const signIn = ({ username, password }) => {\n+â”Š  â”Š42â”Š  const auth = `Basic ${btoa(`${username}:${password}`)}`\n+â”Š  â”Š43â”Š\n+â”Š  â”Š44â”Š  return fetch(`${process.env.REACT_APP_SERVER_URL}/signin`, {\n+â”Š  â”Š45â”Š    method: 'POST',\n+â”Š  â”Š46â”Š    headers: {\n+â”Š  â”Š47â”Š      Authorization: auth,\n+â”Š  â”Š48â”Š    },\n+â”Š  â”Š49â”Š  }).then(res => {\n+â”Š  â”Š50â”Š    if (res.status < 400) {\n+â”Š  â”Š51â”Š      storeAuthHeader(auth)\n+â”Š  â”Š52â”Š    } else {\n+â”Š  â”Š53â”Š      return Promise.reject(res.statusText)\n+â”Š  â”Š54â”Š    }\n+â”Š  â”Š55â”Š  })\n+â”Š  â”Š56â”Š}\n+â”Š  â”Š57â”Š\n+â”Š  â”Š58â”Šexport const signUp = ({ username, password, name }) => {\n+â”Š  â”Š59â”Š  return fetch(`${process.env.REACT_APP_SERVER_URL}/signup`, {\n+â”Š  â”Š60â”Š    method: 'POST',\n+â”Š  â”Š61â”Š    body: JSON.stringify({ name }),\n+â”Š  â”Š62â”Š    headers: {\n+â”Š  â”Š63â”Š      Accept: 'application/json',\n+â”Š  â”Š64â”Š      'Content-Type': 'application/json',\n+â”Š  â”Š65â”Š      Authorization: `Basic ${btoa(`${username}:${password}`)}`,\n+â”Š  â”Š66â”Š    },\n+â”Š  â”Š67â”Š  })\n+â”Š  â”Š68â”Š}\n+â”Š  â”Š69â”Š\n+â”Š  â”Š70â”Šexport const signOut = () => {\n+â”Š  â”Š71â”Š  localStorage.removeItem('Authorization')\n+â”Š  â”Š72â”Š\n+â”Š  â”Š73â”Š  return store.clearStore()\n+â”Š  â”Š74â”Š}\n+â”Š  â”Š75â”Š\n+â”Š  â”Š76â”Šexport default {\n+â”Š  â”Š77â”Š  useMe,\n+â”Š  â”Š78â”Š  withAuth,\n+â”Š  â”Š79â”Š  storeAuthHeader,\n+â”Š  â”Š80â”Š  getAuthHeader,\n+â”Š  â”Š81â”Š  signIn,\n+â”Š  â”Š82â”Š  signUp,\n+â”Š  â”Š83â”Š  signOut,\n+â”Š  â”Š84â”Š}\n```\n\n[}]: #\n\nThe service also includes a `useMe()` GraphQL hook that will fetch the current user. Its definition is separate since it's used vastly and shared between many components.\n\nSince we're using token oriented authentication, it means that any time we make a request to our GraphQL back-end we would need to authorize ourselves by sending this token. This can easily be done thanks to Apollo. By setting the client correctly we can automatically set the headers and parameters for each request that is being done.\n\n[{]: <helper> (diffStep 2.1 files=\"src/apollo-client.ts\" module=\"client\")\n\n#### [Step 2.1: Add auth service](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/e01ef20)\n\n##### Changed src&#x2F;apollo-client.ts\n```diff\n@@ -1,10 +1,12 @@\n â”Š 1â”Š 1â”Šimport { InMemoryCache } from 'apollo-cache-inmemory'\n â”Š 2â”Š 2â”Šimport { ApolloClient } from 'apollo-client'\n â”Š 3â”Š 3â”Šimport { ApolloLink, split } from 'apollo-link'\n+â”Š  â”Š 4â”Šimport { setContext } from 'apollo-link-context'\n â”Š 4â”Š 5â”Šimport { HttpLink } from 'apollo-link-http'\n â”Š 5â”Š 6â”Šimport { WebSocketLink } from 'apollo-link-ws'\n â”Š 6â”Š 7â”Šimport { getMainDefinition } from 'apollo-utilities'\n â”Š 7â”Š 8â”Šimport { OperationDefinitionNode } from 'graphql'\n+â”Š  â”Š 9â”Šimport { getAuthHeader } from './services/auth.service'\n â”Š 8â”Š10â”Š\n â”Š 9â”Š11â”Šconst httpUri = process.env.REACT_APP_SERVER_URL + '/graphql'\n â”Š10â”Š12â”Šconst wsUri = httpUri.replace(/^https?/, 'ws')\n```\n```diff\n@@ -17,16 +19,30 @@\n â”Š17â”Š19â”Š  uri: wsUri,\n â”Š18â”Š20â”Š  options: {\n â”Š19â”Š21â”Š    reconnect: true,\n+â”Š  â”Š22â”Š    connectionParams: () => ({\n+â”Š  â”Š23â”Š      authToken: getAuthHeader(),\n+â”Š  â”Š24â”Š    }),\n â”Š20â”Š25â”Š  },\n â”Š21â”Š26â”Š})\n â”Š22â”Š27â”Š\n+â”Š  â”Š28â”Šconst authLink = setContext((_, { headers }) => {\n+â”Š  â”Š29â”Š  const auth = getAuthHeader()\n+â”Š  â”Š30â”Š\n+â”Š  â”Š31â”Š  return {\n+â”Š  â”Š32â”Š    headers: {\n+â”Š  â”Š33â”Š      ...headers,\n+â”Š  â”Š34â”Š      Authorization: auth,\n+â”Š  â”Š35â”Š    },\n+â”Š  â”Š36â”Š  }\n+â”Š  â”Š37â”Š})\n+â”Š  â”Š38â”Š\n â”Š23â”Š39â”Šconst terminatingLink = split(\n â”Š24â”Š40â”Š  ({ query }) => {\n â”Š25â”Š41â”Š    const { kind, operation } = getMainDefinition(query) as OperationDefinitionNode\n â”Š26â”Š42â”Š    return kind === 'OperationDefinition' && operation === 'subscription'\n â”Š27â”Š43â”Š  },\n â”Š28â”Š44â”Š  wsLink,\n-â”Š29â”Š  â”Š  httpLink,\n+â”Š  â”Š45â”Š  authLink.concat(httpLink),\n â”Š30â”Š46â”Š)\n â”Š31â”Š47â”Š\n â”Š32â”Š48â”Šconst link = ApolloLink.from([terminatingLink])\n```\n\n[}]: #\n\nThis would require us to install a package called `apollo-link-context`:\n\n    $ yarn add apollo-link-context@1.0.14\n\nNow that we have that mechanism implemented we need a way to access it. For that purpose we will be implementing a sign-in form and a sign-up form. Once we create a user and sign-in we will be promoted to the main chats list screen.\n\n[{]: <helper> (diffStep 2.2 files=\"src/components/AuthScreen\" module=\"client\")\n\n#### [Step 2.2: Implement auth components](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/a67226a)\n\n##### Added src&#x2F;components&#x2F;AuthScreen&#x2F;SignInForm.tsx\n```diff\n@@ -0,0 +1,84 @@\n+â”Š  â”Š 1â”Šimport Button from '@material-ui/core/Button'\n+â”Š  â”Š 2â”Šimport TextField from '@material-ui/core/TextField'\n+â”Š  â”Š 3â”Šimport { History } from 'history'\n+â”Š  â”Š 4â”Šimport * as React from 'react'\n+â”Š  â”Š 5â”Šimport { useState } from 'react'\n+â”Š  â”Š 6â”Šimport { signIn } from '../../services/auth.service'\n+â”Š  â”Š 7â”Š\n+â”Š  â”Š 8â”Šinterface SignInFormProps {\n+â”Š  â”Š 9â”Š  history: History\n+â”Š  â”Š10â”Š}\n+â”Š  â”Š11â”Š\n+â”Š  â”Š12â”Šexport default ({ history }: SignInFormProps) => {\n+â”Š  â”Š13â”Š  const [username, setUsername] = useState('')\n+â”Š  â”Š14â”Š  const [password, setPassword] = useState('')\n+â”Š  â”Š15â”Š  const [error, setError] = useState('')\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š  const onUsernameChange = ({ target }) => {\n+â”Š  â”Š18â”Š    setError('')\n+â”Š  â”Š19â”Š    setUsername(target.value)\n+â”Š  â”Š20â”Š  }\n+â”Š  â”Š21â”Š\n+â”Š  â”Š22â”Š  const onPasswordChange = ({ target }) => {\n+â”Š  â”Š23â”Š    setError('')\n+â”Š  â”Š24â”Š    setPassword(target.value)\n+â”Š  â”Š25â”Š  }\n+â”Š  â”Š26â”Š\n+â”Š  â”Š27â”Š  const maySignIn = () => {\n+â”Š  â”Š28â”Š    return !!(username && password)\n+â”Š  â”Š29â”Š  }\n+â”Š  â”Š30â”Š\n+â”Š  â”Š31â”Š  const handleSignIn = () => {\n+â”Š  â”Š32â”Š    signIn({ username, password })\n+â”Š  â”Š33â”Š      .then(() => {\n+â”Š  â”Š34â”Š        history.push('/chats')\n+â”Š  â”Š35â”Š      })\n+â”Š  â”Š36â”Š      .catch(error => {\n+â”Š  â”Š37â”Š        setError(error.message || error)\n+â”Š  â”Š38â”Š      })\n+â”Š  â”Š39â”Š  }\n+â”Š  â”Š40â”Š\n+â”Š  â”Š41â”Š  const handleSignUp = () => {\n+â”Š  â”Š42â”Š    history.push('/sign-up')\n+â”Š  â”Š43â”Š  }\n+â”Š  â”Š44â”Š\n+â”Š  â”Š45â”Š  return (\n+â”Š  â”Š46â”Š    <div className=\"SignInForm Screen\">\n+â”Š  â”Š47â”Š      <form>\n+â”Š  â”Š48â”Š        <legend>Sign in</legend>\n+â”Š  â”Š49â”Š        <div style={{ width: '100%' }}>\n+â”Š  â”Š50â”Š          <TextField\n+â”Š  â”Š51â”Š            className=\"AuthScreen-text-field\"\n+â”Š  â”Š52â”Š            label=\"Username\"\n+â”Š  â”Š53â”Š            value={username}\n+â”Š  â”Š54â”Š            onChange={onUsernameChange}\n+â”Š  â”Š55â”Š            margin=\"normal\"\n+â”Š  â”Š56â”Š            placeholder=\"Enter your username\"\n+â”Š  â”Š57â”Š          />\n+â”Š  â”Š58â”Š          <TextField\n+â”Š  â”Š59â”Š            className=\"AuthScreen-text-field\"\n+â”Š  â”Š60â”Š            label=\"Password\"\n+â”Š  â”Š61â”Š            type=\"password\"\n+â”Š  â”Š62â”Š            value={password}\n+â”Š  â”Š63â”Š            onChange={onPasswordChange}\n+â”Š  â”Š64â”Š            margin=\"normal\"\n+â”Š  â”Š65â”Š            placeholder=\"Enter your password\"\n+â”Š  â”Š66â”Š          />\n+â”Š  â”Š67â”Š        </div>\n+â”Š  â”Š68â”Š        <Button\n+â”Š  â”Š69â”Š          type=\"button\"\n+â”Š  â”Š70â”Š          color=\"secondary\"\n+â”Š  â”Š71â”Š          variant=\"contained\"\n+â”Š  â”Š72â”Š          disabled={!maySignIn()}\n+â”Š  â”Š73â”Š          onClick={handleSignIn}\n+â”Š  â”Š74â”Š        >\n+â”Š  â”Š75â”Š          Sign in\n+â”Š  â”Š76â”Š        </Button>\n+â”Š  â”Š77â”Š        <div className=\"AuthScreen-error\">{error}</div>\n+â”Š  â”Š78â”Š        <span className=\"AuthScreen-alternative\">\n+â”Š  â”Š79â”Š          Don't have an account yet? <a onClick={handleSignUp}>Sign up!</a>\n+â”Š  â”Š80â”Š        </span>\n+â”Š  â”Š81â”Š      </form>\n+â”Š  â”Š82â”Š    </div>\n+â”Š  â”Š83â”Š  )\n+â”Š  â”Š84â”Š}\n```\n\n##### Added src&#x2F;components&#x2F;AuthScreen&#x2F;SignUpForm.tsx\n```diff\n@@ -0,0 +1,127 @@\n+â”Š   â”Š  1â”Šimport Button from '@material-ui/core/Button'\n+â”Š   â”Š  2â”Šimport TextField from '@material-ui/core/TextField'\n+â”Š   â”Š  3â”Šimport { History } from 'history'\n+â”Š   â”Š  4â”Šimport * as React from 'react'\n+â”Š   â”Š  5â”Šimport { useState } from 'react'\n+â”Š   â”Š  6â”Šimport { signUp } from '../../services/auth.service'\n+â”Š   â”Š  7â”Š\n+â”Š   â”Š  8â”Šinterface SignUpFormProps {\n+â”Š   â”Š  9â”Š  history: History\n+â”Š   â”Š 10â”Š}\n+â”Š   â”Š 11â”Š\n+â”Š   â”Š 12â”Šexport default ({ history }: SignUpFormProps) => {\n+â”Š   â”Š 13â”Š  const [name, setName] = useState('')\n+â”Š   â”Š 14â”Š  const [username, setUsername] = useState('')\n+â”Š   â”Š 15â”Š  const [oldPassword, setOldPassword] = useState('')\n+â”Š   â”Š 16â”Š  const [password, setPassword] = useState('')\n+â”Š   â”Š 17â”Š  const [error, setError] = useState('')\n+â”Š   â”Š 18â”Š\n+â”Š   â”Š 19â”Š  const updateName = ({ target }) => {\n+â”Š   â”Š 20â”Š    setError('')\n+â”Š   â”Š 21â”Š    setName(target.value)\n+â”Š   â”Š 22â”Š  }\n+â”Š   â”Š 23â”Š\n+â”Š   â”Š 24â”Š  const updateUsername = ({ target }) => {\n+â”Š   â”Š 25â”Š    setError('')\n+â”Š   â”Š 26â”Š    setUsername(target.value)\n+â”Š   â”Š 27â”Š  }\n+â”Š   â”Š 28â”Š\n+â”Š   â”Š 29â”Š  const updateOldPassword = ({ target }) => {\n+â”Š   â”Š 30â”Š    setError('')\n+â”Š   â”Š 31â”Š    setOldPassword(target.value)\n+â”Š   â”Š 32â”Š  }\n+â”Š   â”Š 33â”Š\n+â”Š   â”Š 34â”Š  const updateNewPassword = ({ target }) => {\n+â”Š   â”Š 35â”Š    setError('')\n+â”Š   â”Š 36â”Š    setPassword(target.value)\n+â”Š   â”Š 37â”Š  }\n+â”Š   â”Š 38â”Š\n+â”Š   â”Š 39â”Š  const maySignUp = () => {\n+â”Š   â”Š 40â”Š    return !!(name && username && oldPassword && oldPassword === password)\n+â”Š   â”Š 41â”Š  }\n+â”Š   â”Š 42â”Š\n+â”Š   â”Š 43â”Š  const handleSignUp = () => {\n+â”Š   â”Š 44â”Š    signUp({ username, password, name })\n+â”Š   â”Š 45â”Š      .then(() => {\n+â”Š   â”Š 46â”Š        history.push('/sign-in')\n+â”Š   â”Š 47â”Š      })\n+â”Š   â”Š 48â”Š      .catch(error => {\n+â”Š   â”Š 49â”Š        setError(error.message || error)\n+â”Š   â”Š 50â”Š      })\n+â”Š   â”Š 51â”Š  }\n+â”Š   â”Š 52â”Š\n+â”Š   â”Š 53â”Š  const handleSignIn = () => {\n+â”Š   â”Š 54â”Š    history.push('/sign-in')\n+â”Š   â”Š 55â”Š  }\n+â”Š   â”Š 56â”Š\n+â”Š   â”Š 57â”Š  return (\n+â”Š   â”Š 58â”Š    <div className=\"SignUpForm Screen\">\n+â”Š   â”Š 59â”Š      <form>\n+â”Š   â”Š 60â”Š        <legend>Sign up</legend>\n+â”Š   â”Š 61â”Š        <div\n+â”Š   â”Š 62â”Š          style={{\n+â”Š   â”Š 63â”Š            float: 'left',\n+â”Š   â”Š 64â”Š            width: 'calc(50% - 10px)',\n+â”Š   â”Š 65â”Š            paddingRight: '10px',\n+â”Š   â”Š 66â”Š          }}\n+â”Š   â”Š 67â”Š        >\n+â”Š   â”Š 68â”Š          <TextField\n+â”Š   â”Š 69â”Š            className=\"AuthScreen-text-field\"\n+â”Š   â”Š 70â”Š            label=\"Name\"\n+â”Š   â”Š 71â”Š            value={name}\n+â”Š   â”Š 72â”Š            onChange={updateName}\n+â”Š   â”Š 73â”Š            autoComplete=\"off\"\n+â”Š   â”Š 74â”Š            margin=\"normal\"\n+â”Š   â”Š 75â”Š          />\n+â”Š   â”Š 76â”Š          <TextField\n+â”Š   â”Š 77â”Š            className=\"AuthScreen-text-field\"\n+â”Š   â”Š 78â”Š            label=\"Username\"\n+â”Š   â”Š 79â”Š            value={username}\n+â”Š   â”Š 80â”Š            onChange={updateUsername}\n+â”Š   â”Š 81â”Š            autoComplete=\"off\"\n+â”Š   â”Š 82â”Š            margin=\"normal\"\n+â”Š   â”Š 83â”Š          />\n+â”Š   â”Š 84â”Š        </div>\n+â”Š   â”Š 85â”Š        <div\n+â”Š   â”Š 86â”Š          style={{\n+â”Š   â”Š 87â”Š            float: 'right',\n+â”Š   â”Š 88â”Š            width: 'calc(50% - 10px)',\n+â”Š   â”Š 89â”Š            paddingLeft: '10px',\n+â”Š   â”Š 90â”Š          }}\n+â”Š   â”Š 91â”Š        >\n+â”Š   â”Š 92â”Š          <TextField\n+â”Š   â”Š 93â”Š            className=\"AuthScreen-text-field\"\n+â”Š   â”Š 94â”Š            label=\"Old password\"\n+â”Š   â”Š 95â”Š            type=\"password\"\n+â”Š   â”Š 96â”Š            value={oldPassword}\n+â”Š   â”Š 97â”Š            onChange={updateOldPassword}\n+â”Š   â”Š 98â”Š            autoComplete=\"off\"\n+â”Š   â”Š 99â”Š            margin=\"normal\"\n+â”Š   â”Š100â”Š          />\n+â”Š   â”Š101â”Š          <TextField\n+â”Š   â”Š102â”Š            className=\"AuthScreen-text-field\"\n+â”Š   â”Š103â”Š            label=\"New password\"\n+â”Š   â”Š104â”Š            type=\"password\"\n+â”Š   â”Š105â”Š            value={password}\n+â”Š   â”Š106â”Š            onChange={updateNewPassword}\n+â”Š   â”Š107â”Š            autoComplete=\"off\"\n+â”Š   â”Š108â”Š            margin=\"normal\"\n+â”Š   â”Š109â”Š          />\n+â”Š   â”Š110â”Š        </div>\n+â”Š   â”Š111â”Š        <Button\n+â”Š   â”Š112â”Š          type=\"button\"\n+â”Š   â”Š113â”Š          color=\"secondary\"\n+â”Š   â”Š114â”Š          variant=\"contained\"\n+â”Š   â”Š115â”Š          disabled={!maySignUp()}\n+â”Š   â”Š116â”Š          onClick={handleSignUp}\n+â”Š   â”Š117â”Š        >\n+â”Š   â”Š118â”Š          Sign up\n+â”Š   â”Š119â”Š        </Button>\n+â”Š   â”Š120â”Š        <div className=\"AuthScreen-error\">{error}</div>\n+â”Š   â”Š121â”Š        <span className=\"AuthScreen-alternative\">\n+â”Š   â”Š122â”Š          Already have an accout? <a onClick={handleSignIn}>Sign in!</a>\n+â”Š   â”Š123â”Š        </span>\n+â”Š   â”Š124â”Š      </form>\n+â”Š   â”Š125â”Š    </div>\n+â”Š   â”Š126â”Š  )\n+â”Š   â”Š127â”Š}\n```\n\n##### Added src&#x2F;components&#x2F;AuthScreen&#x2F;index.tsx\n```diff\n@@ -0,0 +1,118 @@\n+â”Š   â”Š  1â”Šimport * as React from 'react'\n+â”Š   â”Š  2â”Šimport { RouteComponentProps } from 'react-router-dom'\n+â”Š   â”Š  3â”Šimport { Route } from 'react-router-dom'\n+â”Š   â”Š  4â”Šimport styled from 'styled-components'\n+â”Š   â”Š  5â”Šimport AnimatedSwitch from '../AnimatedSwitch'\n+â”Š   â”Š  6â”Šimport SignInForm from './SignInForm'\n+â”Š   â”Š  7â”Šimport SignUpForm from './SignUpForm'\n+â”Š   â”Š  8â”Š\n+â”Š   â”Š  9â”Šconst Style = styled.div`\n+â”Š   â”Š 10â”Š  background: radial-gradient(rgb(34, 65, 67), rgb(17, 48, 50)),\n+â”Š   â”Š 11â”Š    url(/assets/chat-background.jpg) no-repeat;\n+â”Š   â”Š 12â”Š  background-size: cover;\n+â”Š   â”Š 13â”Š  background-blend-mode: multiply;\n+â”Š   â”Š 14â”Š  color: white;\n+â”Š   â”Š 15â”Š\n+â”Š   â”Š 16â”Š  .AuthScreen-intro {\n+â”Š   â”Š 17â”Š    height: 265px;\n+â”Š   â”Š 18â”Š  }\n+â”Š   â”Š 19â”Š\n+â”Š   â”Š 20â”Š  .AuthScreen-icon {\n+â”Š   â”Š 21â”Š    width: 125px;\n+â”Š   â”Š 22â”Š    height: auto;\n+â”Š   â”Š 23â”Š    margin-left: auto;\n+â”Š   â”Š 24â”Š    margin-right: auto;\n+â”Š   â”Š 25â”Š    padding-top: 70px;\n+â”Š   â”Š 26â”Š    display: block;\n+â”Š   â”Š 27â”Š  }\n+â”Š   â”Š 28â”Š\n+â”Š   â”Š 29â”Š  .AuthScreen-title {\n+â”Š   â”Š 30â”Š    width: 100%;\n+â”Š   â”Š 31â”Š    text-align: center;\n+â”Š   â”Š 32â”Š    color: white;\n+â”Š   â”Š 33â”Š  }\n+â”Š   â”Š 34â”Š\n+â”Š   â”Š 35â”Š  .AuthScreen-text-field {\n+â”Š   â”Š 36â”Š    width: 100%;\n+â”Š   â”Š 37â”Š    position: relative;\n+â”Š   â”Š 38â”Š  }\n+â”Š   â”Š 39â”Š\n+â”Š   â”Š 40â”Š  .AuthScreen-text-field > div::before {\n+â”Š   â”Š 41â”Š    border-color: white !important;\n+â”Š   â”Š 42â”Š  }\n+â”Š   â”Š 43â”Š\n+â”Š   â”Š 44â”Š  .AuthScreen-error {\n+â”Š   â”Š 45â”Š    position: absolute;\n+â”Š   â”Š 46â”Š    color: red;\n+â”Š   â”Š 47â”Š    font-size: 15px;\n+â”Š   â”Š 48â”Š    margin-top: 20px;\n+â”Š   â”Š 49â”Š  }\n+â”Š   â”Š 50â”Š\n+â”Š   â”Š 51â”Š  .AuthScreen-alternative {\n+â”Š   â”Š 52â”Š    position: absolute;\n+â”Š   â”Š 53â”Š    bottom: 10px;\n+â”Š   â”Š 54â”Š    left: 10px;\n+â”Š   â”Š 55â”Š\n+â”Š   â”Š 56â”Š    a {\n+â”Š   â”Š 57â”Š      color: var(--secondary-bg);\n+â”Š   â”Š 58â”Š    }\n+â”Š   â”Š 59â”Š  }\n+â”Š   â”Š 60â”Š\n+â”Š   â”Š 61â”Š  .Screen {\n+â”Š   â”Š 62â”Š    height: calc(100% - 265px);\n+â”Š   â”Š 63â”Š  }\n+â”Š   â”Š 64â”Š\n+â”Š   â”Š 65â”Š  form {\n+â”Š   â”Š 66â”Š    padding: 20px;\n+â”Š   â”Š 67â”Š\n+â”Š   â”Š 68â”Š    > div {\n+â”Š   â”Š 69â”Š      padding-bottom: 35px;\n+â”Š   â”Š 70â”Š    }\n+â”Š   â”Š 71â”Š  }\n+â”Š   â”Š 72â”Š\n+â”Š   â”Š 73â”Š  legend {\n+â”Š   â”Š 74â”Š    font-weight: bold;\n+â”Š   â”Š 75â”Š    color: white;\n+â”Š   â”Š 76â”Š  }\n+â”Š   â”Š 77â”Š\n+â”Š   â”Š 78â”Š  label {\n+â”Š   â”Š 79â”Š    color: white !important;\n+â”Š   â”Š 80â”Š  }\n+â”Š   â”Š 81â”Š\n+â”Š   â”Š 82â”Š  input {\n+â”Š   â”Š 83â”Š    color: white;\n+â”Š   â”Š 84â”Š\n+â”Š   â”Š 85â”Š    &::placeholder {\n+â”Š   â”Š 86â”Š      color: var(--primary-bg);\n+â”Š   â”Š 87â”Š    }\n+â”Š   â”Š 88â”Š  }\n+â”Š   â”Š 89â”Š\n+â”Š   â”Š 90â”Š  button {\n+â”Š   â”Š 91â”Š    width: 100px;\n+â”Š   â”Š 92â”Š    display: block;\n+â”Š   â”Š 93â”Š    margin-left: auto;\n+â”Š   â”Š 94â”Š    margin-right: auto;\n+â”Š   â”Š 95â”Š    background-color: var(--secondary-bg) !important;\n+â”Š   â”Š 96â”Š\n+â”Š   â”Š 97â”Š    &[disabled] {\n+â”Š   â”Š 98â”Š      color: #38a81c;\n+â”Š   â”Š 99â”Š    }\n+â”Š   â”Š100â”Š\n+â”Š   â”Š101â”Š    &:not([disabled]) {\n+â”Š   â”Š102â”Š      color: white;\n+â”Š   â”Š103â”Š    }\n+â”Š   â”Š104â”Š  }\n+â”Š   â”Š105â”Š`\n+â”Š   â”Š106â”Š\n+â”Š   â”Š107â”Šexport default ({ history, location }: RouteComponentProps) => (\n+â”Š   â”Š108â”Š  <Style className=\"AuthScreen Screen\">\n+â”Š   â”Š109â”Š    <div className=\"AuthScreen-intro\">\n+â”Š   â”Š110â”Š      <img src=\"assets/whatsapp-icon.png\" className=\"AuthScreen-icon\" />\n+â”Š   â”Š111â”Š      <h2 className=\"AuthScreen-title\">WhatsApp Clone</h2>\n+â”Š   â”Š112â”Š    </div>\n+â”Š   â”Š113â”Š    <AnimatedSwitch>\n+â”Š   â”Š114â”Š      <Route exact path=\"/sign-in\" component={SignInForm} />\n+â”Š   â”Š115â”Š      <Route exact path=\"/sign-up\" component={SignUpForm} />\n+â”Š   â”Š116â”Š    </AnimatedSwitch>\n+â”Š   â”Š117â”Š  </Style>\n+â”Š   â”Š118â”Š)\n```\n\n[}]: #\n\nIf you'll look at the main AuthScreen component you'll see that we use a router to alternate between the sign-in and the sign-up forms. That's the meaning behind a Switch component. However, you can also notice that we use an AnimatedSwitch. As it sounds, this component will ensure that transition between routes is animated. This upgrade our UX in the app, and it is also designated to be used across other routes. If so, let's implement it. First we will need to install a package called `react-router-transition`:\n\n    $ yarn add react-router-transition@1.2.1\n\nThis will enable the transition between the routes. However, we will need to specify the characteristics of the transition, so, let's implement our own version of AnimatedSwitch:\n\n[{]: <helper> (diffStep 2.2 files=\"src/components/AnimatedSwitch\" module=\"client\")\n\n#### [Step 2.2: Implement auth components](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/a67226a)\n\n##### Added src&#x2F;components&#x2F;AnimatedSwitch.tsx\n```diff\n@@ -0,0 +1,30 @@\n+â”Š  â”Š 1â”Šimport styled from 'styled-components'\n+â”Š  â”Š 2â”Šimport { AnimatedSwitch, spring } from 'react-router-transition'\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šconst glide = val =>\n+â”Š  â”Š 5â”Š  spring(val, {\n+â”Š  â”Š 6â”Š    stiffness: 174,\n+â”Š  â”Š 7â”Š    damping: 24,\n+â”Š  â”Š 8â”Š  })\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Šconst mapStyles = styles => ({\n+â”Š  â”Š11â”Š  transform: `translateX(${styles.offset}%)`,\n+â”Š  â”Š12â”Š})\n+â”Š  â”Š13â”Š\n+â”Š  â”Š14â”Šexport default styled(AnimatedSwitch).attrs(() => ({\n+â”Š  â”Š15â”Š  atEnter: { offset: 100 },\n+â”Š  â”Š16â”Š  atLeave: { offset: glide(-100) },\n+â”Š  â”Š17â”Š  atActive: { offset: glide(0) },\n+â”Š  â”Š18â”Š  mapStyles,\n+â”Š  â”Š19â”Š}))`\n+â”Š  â”Š20â”Š  position: relative;\n+â”Š  â”Š21â”Š  overflow: hidden;\n+â”Š  â”Š22â”Š  width: 100%;\n+â”Š  â”Š23â”Š  height: 100%;\n+â”Š  â”Š24â”Š  > div {\n+â”Š  â”Š25â”Š    position: absolute;\n+â”Š  â”Š26â”Š    overflow: hidden;\n+â”Š  â”Š27â”Š    width: 100%;\n+â”Š  â”Š28â”Š    height: 100%;\n+â”Š  â”Š29â”Š  }\n+â”Š  â”Š30â”Š`\n```\n\n[}]: #\n\nAs shown in the screenshot at the top of this page, the auth screen includes few assets that we should download: a background picture and a logo. Please download the assets below and save them in the `public/assets` directory as `chat-background.jpg` and `whatsapp-icon.jpg` respectively:\n\n![chat-background.jpg](https://user-images.githubusercontent.com/7648874/51983290-3f49a080-24d3-11e9-9de9-cf57354d1e3a.jpg)\n\n![whatsapp-icon.jpg](https://user-images.githubusercontent.com/7648874/52662552-768e6780-2f3f-11e9-931c-36a5c13ca49b.png)\n\nSo following that, we would need to define a router that will handle changes in routes. We will be using `react-router-dom`:\n\n    $ yarn add react-router-dom@4.3.1\n\nNow that we have it let's define our routes. Note how we take advantage of the `withAuth()` method to guard our routes and make them available only to users who are authorized:\n\n[{]: <helper> (diffStep 2.3 files=\"src/App\" module=\"client\")\n\n#### [Step 2.3: Create router with guarded routes](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/79ff9eb)\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -1,14 +1,20 @@\n-â”Š 1â”Š  â”Šimport React, { Component } from 'react';\n+â”Š  â”Š 1â”Šimport * as React from 'react'\n+â”Š  â”Š 2â”Šimport { BrowserRouter, Route, Redirect } from 'react-router-dom'\n+â”Š  â”Š 3â”Šimport AnimatedSwitch from './components/AnimatedSwitch'\n+â”Š  â”Š 4â”Šimport AuthScreen from './components/AuthScreen'\n â”Š 2â”Š 5â”Šimport ChatsListScreen from './components/ChatsListScreen'\n+â”Š  â”Š 6â”Šimport { withAuth } from './services/auth.service'\n â”Š 3â”Š 7â”Š\n-â”Š 4â”Š  â”Šclass App extends Component {\n-â”Š 5â”Š  â”Š  render() {\n-â”Š 6â”Š  â”Š    return (\n-â”Š 7â”Š  â”Š      <div className=\"App\">\n-â”Š 8â”Š  â”Š        <ChatsListScreen />\n-â”Š 9â”Š  â”Š      </div>\n-â”Š10â”Š  â”Š    );\n-â”Š11â”Š  â”Š  }\n-â”Š12â”Š  â”Š}\n+â”Š  â”Š 8â”Šconst RedirectToChats = () => (\n+â”Š  â”Š 9â”Š  <Redirect to=\"/chats\" />\n+â”Š  â”Š10â”Š)\n â”Š13â”Š11â”Š\n-â”Š14â”Š  â”Šexport default App;\n+â”Š  â”Š12â”Šexport default () => (\n+â”Š  â”Š13â”Š  <BrowserRouter>\n+â”Š  â”Š14â”Š    <AnimatedSwitch>\n+â”Š  â”Š15â”Š      <Route exact path=\"/sign-(in|up)\" component={AuthScreen} />\n+â”Š  â”Š16â”Š      <Route exact path=\"/chats\" component={withAuth(ChatsListScreen)} />\n+â”Š  â”Š17â”Š      <Route component={RedirectToChats} />\n+â”Š  â”Š18â”Š    </AnimatedSwitch>\n+â”Š  â”Š19â”Š  </BrowserRouter>\n+â”Š  â”Š20â”Š)\n```\n\n[}]: #\n\nSince in our auth service we basically check if the user is logged in by actually querying the server with a React hook, we will need to use a Suspense component that will catch the pending request.\n\n[{]: <helper> (diffStep 2.3 files=\"src/index\" module=\"client\")\n\n#### [Step 2.3: Create router with guarded routes](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/79ff9eb)\n\n##### Changed src&#x2F;index.tsx\n```diff\n@@ -1,5 +1,6 @@\n â”Š1â”Š1â”Šimport { MuiThemeProvider, createMuiTheme } from '@material-ui/core/styles'\n â”Š2â”Š2â”Šimport React from 'react';\n+â”Š â”Š3â”Šimport { Suspense } from 'react'\n â”Š3â”Š4â”Šimport ReactDOM from 'react-dom';\n â”Š4â”Š5â”Šimport { ApolloProvider } from 'react-apollo-hooks';\n â”Š5â”Š6â”Šimport './index.css';\n```\n```diff\n@@ -20,7 +21,9 @@\n â”Š20â”Š21â”ŠReactDOM.render(\n â”Š21â”Š22â”Š  <MuiThemeProvider theme={theme}>\n â”Š22â”Š23â”Š    <ApolloProvider client={apolloClient}>\n-â”Š23â”Š  â”Š      <App />\n+â”Š  â”Š24â”Š      <Suspense fallback={null}>\n+â”Š  â”Š25â”Š        <App />\n+â”Š  â”Š26â”Š      </Suspense>\n â”Š24â”Š27â”Š    </ApolloProvider>\n â”Š25â”Š28â”Š  </MuiThemeProvider>\n â”Š26â”Š29â”Š, document.getElementById('root'));\n```\n\n[}]: #\n\n> It's highly recommended to go through the [docs of Suspense](https://reactjs.org/docs/react-api.html#reactsuspense) before you proceed if you're not familiar with it.\n\nPerfect. Now we can sign-in and sign-up, and we can view chats which belong to us. Now we're gonna implement the settings screen, where we will be able to set our profile details, such as name and picture. Let's keep the image uploading thing for a bit later, we will focus on the component itself first. The settings screen layout includes:\n\n- A navbar.\n- A form with inputs.\n\nAccordingly, the implementation of the screen should look like so:\n\n[{]: <helper> (diffStep 2.4 files=\"src/components\" module=\"client\")\n\n#### [Step 2.4: Implement settings screen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/2ebdaf2)\n\n##### Added src&#x2F;components&#x2F;SettingsScreen&#x2F;SettingsForm.tsx\n```diff\n@@ -0,0 +1,127 @@\n+â”Š   â”Š  1â”Šimport TextField from '@material-ui/core/TextField'\n+â”Š   â”Š  2â”Šimport EditIcon from '@material-ui/icons/Edit'\n+â”Š   â”Š  3â”Šimport { defaultDataIdFromObject } from 'apollo-cache-inmemory'\n+â”Š   â”Š  4â”Šimport gql from 'graphql-tag'\n+â”Š   â”Š  5â”Šimport * as React from 'react'\n+â”Š   â”Š  6â”Šimport { useEffect, useState } from 'react'\n+â”Š   â”Š  7â”Šimport { useMutation } from 'react-apollo-hooks'\n+â”Š   â”Š  8â”Šimport { RouteComponentProps } from 'react-router-dom'\n+â”Š   â”Š  9â”Šimport styled from 'styled-components'\n+â”Š   â”Š 10â”Šimport * as fragments from '../../graphql/fragments'\n+â”Š   â”Š 11â”Šimport { SettingsFormMutation } from '../../graphql/types'\n+â”Š   â”Š 12â”Šimport { useMe } from '../../services/auth.service'\n+â”Š   â”Š 13â”Šimport Navbar from '../Navbar'\n+â”Š   â”Š 14â”Šimport SettingsNavbar from './SettingsNavbar'\n+â”Š   â”Š 15â”Š\n+â”Š   â”Š 16â”Šconst Style = styled.div`\n+â”Š   â”Š 17â”Š  .SettingsForm-picture {\n+â”Š   â”Š 18â”Š    max-width: 300px;\n+â”Š   â”Š 19â”Š    display: block;\n+â”Š   â”Š 20â”Š    margin: auto;\n+â”Š   â”Š 21â”Š    margin-top: 50px;\n+â”Š   â”Š 22â”Š\n+â”Š   â”Š 23â”Š    img {\n+â”Š   â”Š 24â”Š      object-fit: cover;\n+â”Š   â”Š 25â”Š      border-radius: 50%;\n+â”Š   â”Š 26â”Š      margin-bottom: -34px;\n+â”Š   â”Š 27â”Š      width: 300px;\n+â”Š   â”Š 28â”Š      height: 300px;\n+â”Š   â”Š 29â”Š    }\n+â”Š   â”Š 30â”Š\n+â”Š   â”Š 31â”Š    svg {\n+â”Š   â”Š 32â”Š      float: right;\n+â”Š   â”Š 33â”Š      font-size: 30px;\n+â”Š   â”Š 34â”Š      opacity: 0.5;\n+â”Š   â”Š 35â”Š      border-left: black solid 1px;\n+â”Š   â”Š 36â”Š      padding-left: 5px;\n+â”Š   â”Š 37â”Š      cursor: pointer;\n+â”Š   â”Š 38â”Š    }\n+â”Š   â”Š 39â”Š  }\n+â”Š   â”Š 40â”Š\n+â”Š   â”Š 41â”Š  .SettingsForm-name-input {\n+â”Š   â”Š 42â”Š    display: block;\n+â”Š   â”Š 43â”Š    margin: auto;\n+â”Š   â”Š 44â”Š    width: calc(100% - 50px);\n+â”Š   â”Š 45â”Š    margin-top: 50px;\n+â”Š   â”Š 46â”Š\n+â”Š   â”Š 47â”Š    > div {\n+â”Š   â”Š 48â”Š      width: 100%;\n+â”Š   â”Š 49â”Š    }\n+â”Š   â”Š 50â”Š  }\n+â”Š   â”Š 51â”Š`\n+â”Š   â”Š 52â”Š\n+â”Š   â”Š 53â”Šconst mutation = gql`\n+â”Š   â”Š 54â”Š  mutation SettingsFormMutation($name: String, $picture: String) {\n+â”Š   â”Š 55â”Š    updateUser(name: $name, picture: $picture) {\n+â”Š   â”Š 56â”Š      ...User\n+â”Š   â”Š 57â”Š    }\n+â”Š   â”Š 58â”Š  }\n+â”Š   â”Š 59â”Š  ${fragments.user}\n+â”Š   â”Š 60â”Š`\n+â”Š   â”Š 61â”Š\n+â”Š   â”Š 62â”Šexport default ({ history }: RouteComponentProps) => {\n+â”Š   â”Š 63â”Š  const me = useMe()\n+â”Š   â”Š 64â”Š  const [myName, setMyName] = useState(me.name)\n+â”Š   â”Š 65â”Š  const [myPicture, setMyPicture] = useState(me.picture)\n+â”Š   â”Š 66â”Š\n+â”Š   â”Š 67â”Š  const updateUser = useMutation<SettingsFormMutation.Mutation, SettingsFormMutation.Variables>(\n+â”Š   â”Š 68â”Š    mutation,\n+â”Š   â”Š 69â”Š    {\n+â”Š   â”Š 70â”Š      variables: { name: myName, picture: myPicture },\n+â”Š   â”Š 71â”Š      optimisticResponse: {\n+â”Š   â”Š 72â”Š        __typename: 'Mutation',\n+â”Š   â”Š 73â”Š        updateUser: {\n+â”Š   â”Š 74â”Š          __typename: 'User',\n+â”Š   â”Š 75â”Š          id: me.id,\n+â”Š   â”Š 76â”Š          picture: myPicture,\n+â”Š   â”Š 77â”Š          name: myName,\n+â”Š   â”Š 78â”Š        },\n+â”Š   â”Š 79â”Š      },\n+â”Š   â”Š 80â”Š      update: (client, { data: { updateUser } }) => {\n+â”Š   â”Š 81â”Š        me.picture = myPicture\n+â”Š   â”Š 82â”Š        me.name = myPicture\n+â”Š   â”Š 83â”Š\n+â”Š   â”Š 84â”Š        client.writeFragment({\n+â”Š   â”Š 85â”Š          id: defaultDataIdFromObject(me),\n+â”Š   â”Š 86â”Š          fragment: fragments.user,\n+â”Š   â”Š 87â”Š          data: me,\n+â”Š   â”Š 88â”Š        })\n+â”Š   â”Š 89â”Š      },\n+â”Š   â”Š 90â”Š    },\n+â”Š   â”Š 91â”Š  )\n+â”Š   â”Š 92â”Š\n+â”Š   â”Š 93â”Š  useEffect(\n+â”Š   â”Š 94â”Š    () => {\n+â”Š   â”Š 95â”Š      if (myPicture !== me.picture) {\n+â”Š   â”Š 96â”Š        updateUser()\n+â”Š   â”Š 97â”Š      }\n+â”Š   â”Š 98â”Š    },\n+â”Š   â”Š 99â”Š    [myPicture],\n+â”Š   â”Š100â”Š  )\n+â”Š   â”Š101â”Š\n+â”Š   â”Š102â”Š  const updateName = ({ target }) => {\n+â”Š   â”Š103â”Š    setMyName(target.value)\n+â”Š   â”Š104â”Š  }\n+â”Š   â”Š105â”Š\n+â”Š   â”Š106â”Š  const updatePicture = async () => {\n+â”Š   â”Š107â”Š    // TODO: Implement\n+â”Š   â”Š108â”Š  }\n+â”Š   â”Š109â”Š\n+â”Š   â”Š110â”Š  return (\n+â”Š   â”Š111â”Š    <Style className={name}>\n+â”Š   â”Š112â”Š      <div className=\"SettingsForm-picture\">\n+â”Š   â”Š113â”Š        <img src={myPicture || '/assets/default-profile-pic.jpg'} />\n+â”Š   â”Š114â”Š        <EditIcon onClick={updatePicture} />\n+â”Š   â”Š115â”Š      </div>\n+â”Š   â”Š116â”Š      <TextField\n+â”Š   â”Š117â”Š        className=\"SettingsForm-name-input\"\n+â”Š   â”Š118â”Š        label=\"Name\"\n+â”Š   â”Š119â”Š        value={myName}\n+â”Š   â”Š120â”Š        onChange={updateName}\n+â”Š   â”Š121â”Š        onBlur={updateUser}\n+â”Š   â”Š122â”Š        margin=\"normal\"\n+â”Š   â”Š123â”Š        placeholder=\"Enter your name\"\n+â”Š   â”Š124â”Š      />\n+â”Š   â”Š125â”Š    </Style>\n+â”Š   â”Š126â”Š  )\n+â”Š   â”Š127â”Š}\n```\n\n##### Added src&#x2F;components&#x2F;SettingsScreen&#x2F;SettingsNavbar.tsx\n```diff\n@@ -0,0 +1,49 @@\n+â”Š  â”Š 1â”Šimport Button from '@material-ui/core/Button'\n+â”Š  â”Š 2â”Šimport ArrowBackIcon from '@material-ui/icons/ArrowBack'\n+â”Š  â”Š 3â”Šimport { History } from 'history'\n+â”Š  â”Š 4â”Šimport * as React from 'react'\n+â”Š  â”Š 5â”Šimport styled from 'styled-components'\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Šconst Style = styled.div`\n+â”Š  â”Š 8â”Š  padding: 0;\n+â”Š  â”Š 9â”Š  display: flex;\n+â”Š  â”Š10â”Š  flex-direction: row;\n+â”Š  â”Š11â”Š  margin-left: -20px;\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Š  .SettingsNavbar-title {\n+â”Š  â”Š14â”Š    line-height: 56px;\n+â”Š  â”Š15â”Š  }\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š  .SettingsNavbar-back-button {\n+â”Š  â”Š18â”Š    color: var(--primary-text);\n+â”Š  â”Š19â”Š  }\n+â”Š  â”Š20â”Š\n+â”Š  â”Š21â”Š  .SettingsNavbar-picture {\n+â”Š  â”Š22â”Š    height: 40px;\n+â”Š  â”Š23â”Š    width: 40px;\n+â”Š  â”Š24â”Š    margin-top: 3px;\n+â”Š  â”Š25â”Š    margin-left: -22px;\n+â”Š  â”Š26â”Š    object-fit: cover;\n+â”Š  â”Š27â”Š    padding: 5px;\n+â”Š  â”Š28â”Š    border-radius: 50%;\n+â”Š  â”Š29â”Š  }\n+â”Š  â”Š30â”Š`\n+â”Š  â”Š31â”Š\n+â”Š  â”Š32â”Šinterface SettingsNavbarProps {\n+â”Š  â”Š33â”Š  history: History\n+â”Š  â”Š34â”Š}\n+â”Š  â”Š35â”Š\n+â”Š  â”Š36â”Šexport default ({ history }: SettingsNavbarProps) => {\n+â”Š  â”Š37â”Š  const navToChats = () => {\n+â”Š  â”Š38â”Š    history.push('/chats')\n+â”Š  â”Š39â”Š  }\n+â”Š  â”Š40â”Š\n+â”Š  â”Š41â”Š  return (\n+â”Š  â”Š42â”Š    <Style className={name}>\n+â”Š  â”Š43â”Š      <Button className=\"SettingsNavbar-back-button\" onClick={navToChats}>\n+â”Š  â”Š44â”Š        <ArrowBackIcon />\n+â”Š  â”Š45â”Š      </Button>\n+â”Š  â”Š46â”Š      <div className=\"SettingsNavbar-title\">Settings</div>\n+â”Š  â”Š47â”Š    </Style>\n+â”Š  â”Š48â”Š  )\n+â”Š  â”Š49â”Š}\n```\n\n##### Added src&#x2F;components&#x2F;SettingsScreen&#x2F;index.tsx\n```diff\n@@ -0,0 +1,17 @@\n+â”Š  â”Š 1â”Šimport * as React from 'react'\n+â”Š  â”Š 2â”Šimport { Suspense } from 'react'\n+â”Š  â”Š 3â”Šimport { RouteComponentProps } from 'react-router-dom'\n+â”Š  â”Š 4â”Šimport Navbar from '../Navbar'\n+â”Š  â”Š 5â”Šimport SettingsForm from './SettingsForm'\n+â”Š  â”Š 6â”Šimport SettingsNavbar from './SettingsNavbar'\n+â”Š  â”Š 7â”Š\n+â”Š  â”Š 8â”Šexport default ({ history }: RouteComponentProps) => (\n+â”Š  â”Š 9â”Š  <div className=\"SettingsScreen Screen\">\n+â”Š  â”Š10â”Š    <Navbar>\n+â”Š  â”Š11â”Š      <SettingsNavbar history={history} />\n+â”Š  â”Š12â”Š    </Navbar>\n+â”Š  â”Š13â”Š    <Suspense fallback={null}>\n+â”Š  â”Š14â”Š      <SettingsForm />\n+â”Š  â”Š15â”Š    </Suspense>\n+â”Š  â”Š16â”Š  </div>\n+â”Š  â”Š17â”Š)\n```\n\n[}]: #\n\nThe `optimisticResponse` object is used to predict the response so we can have it immediately and the `update` callback is used to update the cache. Anytime we receive a response from our GraphQL back-end we should update the cache, otherwise the data presented in our app will be out-dated.\n\nThe user should be updated on 2 scenarios: Either we loose focus on the name input or we upload a new image. We used the [`useEffect`](https://reactjs.org/docs/hooks-effect.html) to determine changes in the profile picture URL and trigger an update.\n\nWe will need to update our back-end to have an `updateUser` mutation:\n\n[{]: <helper> (diffStep 2.2 files=\"modules/user\" module=\"server\")\n\n#### [Step 2.2: Add updateUser() mutation](https://github.com/Urigo/WhatsApp-Clone-Server/commit/d3aa0fa)\n\n##### Changed modules&#x2F;user&#x2F;providers&#x2F;user.provider.ts\n```diff\n@@ -23,4 +23,23 @@\n â”Š23â”Š23â”Š      .where('user.id != :id', { id: this.currentUser.id })\n â”Š24â”Š24â”Š      .getMany()\n â”Š25â”Š25â”Š  }\n+â”Š  â”Š26â”Š\n+â”Š  â”Š27â”Š  async updateUser({\n+â”Š  â”Š28â”Š    name,\n+â”Š  â”Š29â”Š    picture,\n+â”Š  â”Š30â”Š  }: {\n+â”Š  â”Š31â”Š    name?: string,\n+â”Š  â”Š32â”Š    picture?: string,\n+â”Š  â”Š33â”Š  } = {}) {\n+â”Š  â”Š34â”Š    if (name === this.currentUser.name && picture === this.currentUser.picture) {\n+â”Š  â”Š35â”Š      return this.currentUser;\n+â”Š  â”Š36â”Š    }\n+â”Š  â”Š37â”Š\n+â”Š  â”Š38â”Š    this.currentUser.name = name || this.currentUser.name;\n+â”Š  â”Š39â”Š    this.currentUser.picture = picture || this.currentUser.picture;\n+â”Š  â”Š40â”Š\n+â”Š  â”Š41â”Š    await this.repository.save(this.currentUser);\n+â”Š  â”Š42â”Š\n+â”Š  â”Š43â”Š    return this.currentUser;\n+â”Š  â”Š44â”Š  }\n â”Š26â”Š45â”Š}\n```\n\n##### Changed modules&#x2F;user&#x2F;resolvers&#x2F;resolvers.ts\n```diff\n@@ -8,4 +8,10 @@\n â”Š 8â”Š 8â”Š    me: (obj, args, { injector }) => injector.get(UserProvider).getMe(),\n â”Š 9â”Š 9â”Š    users: (obj, args, { injector }) => injector.get(UserProvider).getUsers(),\n â”Š10â”Š10â”Š  },\n+â”Š  â”Š11â”Š  Mutation: {\n+â”Š  â”Š12â”Š    updateUser: (obj, { name, picture }, { injector }) => injector.get(UserProvider).updateUser({\n+â”Š  â”Š13â”Š      name: name || '',\n+â”Š  â”Š14â”Š      picture: picture || '',\n+â”Š  â”Š15â”Š    }),\n+â”Š  â”Š16â”Š  },\n â”Š11â”Š17â”Š} as IResolvers\n```\n\n##### Changed modules&#x2F;user&#x2F;schema&#x2F;typeDefs.graphql\n```diff\n@@ -3,6 +3,10 @@\n â”Š 3â”Š 3â”Š  users: [User!]\n â”Š 4â”Š 4â”Š}\n â”Š 5â”Š 5â”Š\n+â”Š  â”Š 6â”Štype Mutation {\n+â”Š  â”Š 7â”Š  updateUser(name: String, picture: String): User!\n+â”Š  â”Š 8â”Š}\n+â”Š  â”Š 9â”Š\n â”Š 6â”Š10â”Štype User {\n â”Š 7â”Š11â”Š  id: ID!\n â”Š 8â”Š12â”Š  name: String\n```\n\n[}]: #\n\nRemember that a user could be correlated to a chat, for example, if a user changes its information such as name or picture, the chat informationshould be changed as well. This means that we will need to listen to changes with a [subscription](https://www.apollographql.com/docs/react/advanced/subscriptions.html) and update our cache accordingly.\n\nSince `react-apollo-hooks` doesn't have a built-in `useSubscription()` hook as for version `0.3.1`, we will implement a polyfill that will do exactly that. First we will ad a utility package:\n\n    $ yarn add react-fast-compare@2.0.4\n\nAnd then we will implement the `useSubscription()` hook:\n\n[{]: <helper> (diffStep 2.5 files=\"src/polyfills\" module=\"client\")\n\n#### [Step 2.5: Handle chat update subscription](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/e5a2cf5)\n\n##### Added src&#x2F;polyfills&#x2F;react-apollo-hooks.ts\n```diff\n@@ -0,0 +1,72 @@\n+â”Š  â”Š 1â”Šimport { DataProxy } from 'apollo-cache'\n+â”Š  â”Š 2â”Šimport { OperationVariables, FetchPolicy } from 'apollo-client'\n+â”Š  â”Š 3â”Šimport { DocumentNode, GraphQLError } from 'graphql'\n+â”Š  â”Š 4â”Šimport { useEffect, useMemo, useRef, useState } from 'react'\n+â”Š  â”Š 5â”Šimport { useApolloClient } from 'react-apollo-hooks'\n+â”Š  â”Š 6â”Šimport * as isEqual from 'react-fast-compare'\n+â”Š  â”Š 7â”Š\n+â”Š  â”Š 8â”Šexport type SubscriptionOptions<T, TVariables> = {\n+â”Š  â”Š 9â”Š  variables?: TVariables\n+â”Š  â”Š10â”Š  fetchPolicy?: FetchPolicy\n+â”Š  â”Š11â”Š  onSubscriptionData?: (options?: { client?: DataProxy; subscriptionData?: T }) => any\n+â”Š  â”Š12â”Š}\n+â”Š  â”Š13â”Š\n+â”Š  â”Š14â”Šexport const useSubscription = <T, TVariables = OperationVariables>(\n+â”Š  â”Š15â”Š  query: DocumentNode,\n+â”Š  â”Š16â”Š  options: SubscriptionOptions<T, TVariables> = {},\n+â”Š  â”Š17â”Š): {\n+â”Š  â”Š18â”Š  data: T | { [key: string]: void }\n+â”Š  â”Š19â”Š  error?: GraphQLError\n+â”Š  â”Š20â”Š  loading: boolean\n+â”Š  â”Š21â”Š} => {\n+â”Š  â”Š22â”Š  const onSubscriptionData = options.onSubscriptionData\n+â”Š  â”Š23â”Š  const prevOptions = useRef<typeof options | null>(null)\n+â”Š  â”Š24â”Š  const client = useApolloClient()\n+â”Š  â”Š25â”Š  const [data, setData] = useState<T | {}>({})\n+â”Š  â”Š26â”Š  const [error, setError] = useState<GraphQLError | null>(null)\n+â”Š  â”Š27â”Š  const [loading, setLoading] = useState<boolean>(true)\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š  const subscriptionOptions = {\n+â”Š  â”Š30â”Š    query,\n+â”Š  â”Š31â”Š    variables: options.variables,\n+â”Š  â”Š32â”Š    fetchPolicy: options.fetchPolicy,\n+â”Š  â”Š33â”Š  }\n+â”Š  â”Š34â”Š\n+â”Š  â”Š35â”Š  useEffect(\n+â”Š  â”Š36â”Š    () => {\n+â”Š  â”Š37â”Š      prevOptions.current = subscriptionOptions\n+â”Š  â”Š38â”Š      const subscription = client\n+â”Š  â”Š39â”Š        .subscribe<{ data: T }, TVariables>(subscriptionOptions)\n+â”Š  â”Š40â”Š        .subscribe({\n+â”Š  â”Š41â”Š          next: ({ data }) => {\n+â”Š  â”Š42â”Š            setData(data)\n+â”Š  â”Š43â”Š\n+â”Š  â”Š44â”Š            if (onSubscriptionData) {\n+â”Š  â”Š45â”Š              onSubscriptionData({ client, subscriptionData: data })\n+â”Š  â”Š46â”Š            }\n+â”Š  â”Š47â”Š          },\n+â”Š  â”Š48â”Š          error: err => {\n+â”Š  â”Š49â”Š            setError(err)\n+â”Š  â”Š50â”Š            setLoading(false)\n+â”Š  â”Š51â”Š          },\n+â”Š  â”Š52â”Š          complete: () => {\n+â”Š  â”Š53â”Š            setLoading(false)\n+â”Š  â”Š54â”Š          },\n+â”Š  â”Š55â”Š        })\n+â”Š  â”Š56â”Š\n+â”Š  â”Š57â”Š      return () => {\n+â”Š  â”Š58â”Š        subscription.unsubscribe()\n+â”Š  â”Š59â”Š      }\n+â”Š  â”Š60â”Š    },\n+â”Š  â”Š61â”Š    [isEqual(prevOptions.current, subscriptionOptions) ? prevOptions.current : subscriptionOptions],\n+â”Š  â”Š62â”Š  )\n+â”Š  â”Š63â”Š\n+â”Š  â”Š64â”Š  return useMemo(\n+â”Š  â”Š65â”Š    () => ({\n+â”Š  â”Š66â”Š      data,\n+â”Š  â”Š67â”Š      error,\n+â”Š  â”Š68â”Š      loading,\n+â”Š  â”Š69â”Š    }),\n+â”Š  â”Š70â”Š    [data, error, loading],\n+â”Š  â”Š71â”Š  )\n+â”Š  â”Š72â”Š}\n```\n\n[}]: #\n\nThen we will define the subscription document and listen to it in a dedicated service called `cache.service`, which is responsible for updating the cache:\n\n[{]: <helper> (diffStep 2.5 files=\"src/graphql, src/services/cache\" module=\"client\")\n\n#### [Step 2.5: Handle chat update subscription](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/e5a2cf5)\n\n##### Added src&#x2F;graphql&#x2F;subscriptions&#x2F;chatUpdated.subscription.ts\n```diff\n@@ -0,0 +1,11 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag'\n+â”Š  â”Š 2â”Šimport * as fragments from '../fragments'\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šexport default gql `\n+â”Š  â”Š 5â”Š  subscription ChatUpdated {\n+â”Š  â”Š 6â”Š    chatUpdated {\n+â”Š  â”Š 7â”Š      ...Chat\n+â”Š  â”Š 8â”Š    }\n+â”Š  â”Š 9â”Š  }\n+â”Š  â”Š10â”Š  ${fragments.chat}\n+â”Š  â”Š11â”Š`\n```\n\n##### Added src&#x2F;graphql&#x2F;subscriptions&#x2F;index.ts\n```diff\n@@ -0,0 +1 @@\n+â”Š â”Š1â”Šexport { default as chatUpdated } from './chatUpdated.subscription'\n```\n\n##### Added src&#x2F;services&#x2F;cache.service.tsx\n```diff\n@@ -0,0 +1,18 @@\n+â”Š  â”Š 1â”Šimport { defaultDataIdFromObject } from 'apollo-cache-inmemory'\n+â”Š  â”Š 2â”Šimport * as fragments from '../graphql/fragments'\n+â”Š  â”Š 3â”Šimport * as subscriptions from '../graphql/subscriptions'\n+â”Š  â”Š 4â”Šimport { ChatUpdated } from '../graphql/types'\n+â”Š  â”Š 5â”Šimport { useSubscription } from '../polyfills/react-apollo-hooks'\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Šexport const useSubscriptions = () => {\n+â”Š  â”Š 8â”Š  useSubscription<ChatUpdated.Subscription>(subscriptions.chatUpdated, {\n+â”Š  â”Š 9â”Š    onSubscriptionData: ({ client, subscriptionData: { chatUpdated } }) => {\n+â”Š  â”Š10â”Š      client.writeFragment({\n+â”Š  â”Š11â”Š        id: defaultDataIdFromObject(chatUpdated),\n+â”Š  â”Š12â”Š        fragment: fragments.chat,\n+â”Š  â”Š13â”Š        fragmentName: 'Chat',\n+â”Š  â”Š14â”Š        data: chatUpdated,\n+â”Š  â”Š15â”Š      })\n+â”Š  â”Š16â”Š    },\n+â”Š  â”Š17â”Š  })\n+â”Š  â”Š18â”Š}\n```\n\n[}]: #\n\nWe should listen to subscriptions only once we're logged-in, therefore let's use the `useSubscriptions()` hook that we've just created in the `auth.service`:\n\n[{]: <helper> (diffStep 2.5 files=\"src/services/auth\" module=\"client\")\n\n#### [Step 2.5: Handle chat update subscription](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/e5a2cf5)\n\n##### Changed src&#x2F;services&#x2F;auth.service.tsx\n```diff\n@@ -5,6 +5,7 @@\n â”Š 5â”Š 5â”Šimport store from '../apollo-client'\n â”Š 6â”Š 6â”Šimport * as queries from '../graphql/queries'\n â”Š 7â”Š 7â”Šimport { Me, User } from '../graphql/types'\n+â”Š  â”Š 8â”Šimport { useSubscriptions } from './cache.service'\n â”Š 8â”Š 9â”Š\n â”Š 9â”Š10â”Šconst MyContext = React.createContext<User.Fragment>(null)\n â”Š10â”Š11â”Š\n```\n```diff\n@@ -22,6 +23,8 @@\n â”Š22â”Š23â”Š    // Override TypeScript definition issue with the current version\n â”Š23â”Š24â”Š    if (myResult.error) return <Redirect to=\"/sign-in\" />\n â”Š24â”Š25â”Š\n+â”Š  â”Š26â”Š    useSubscriptions()\n+â”Š  â”Š27â”Š\n â”Š25â”Š28â”Š    return (\n â”Š26â”Š29â”Š      <MyContext.Provider value={myResult.data.me}>\n â”Š27â”Š30â”Š        <Component {...props} />\n```\n\n[}]: #\n\nNow we will have to implement the subscription in our server. GraphQL subscriptions are a way to push data from the server to the clients that choose to listen to real time messages from the server. To trigger a subscription event we will use a method called `publish` which is used by a class called `PubSub`. Pubsub sits between your application's logic and the GraphQL subscriptions engine - it receives a publish command from your app logic and pushes it to your GraphQL execution engine. This is how it should look like in code, in relation to `chatUpdated` subscription:\n\n[{]: <helper> (diffStep 2.3 module=\"server\")\n\n#### [Step 2.3: Add chatUpdated subscription](https://github.com/Urigo/WhatsApp-Clone-Server/commit/44d94a5)\n\n##### Changed index.ts\n```diff\n@@ -21,11 +21,12 @@\n â”Š21â”Š21â”Š  app.use(cors())\n â”Š22â”Š22â”Š  app.use(bodyParser.json())\n â”Š23â”Š23â”Š\n-â”Š24â”Š  â”Š  const { schema, context } = AppModule.forRoot({ app, connection })\n+â”Š  â”Š24â”Š  const { schema, context, subscriptions } = AppModule.forRoot({ app, connection })\n â”Š25â”Š25â”Š\n â”Š26â”Š26â”Š  const apollo = new ApolloServer({\n â”Š27â”Š27â”Š    schema,\n â”Š28â”Š28â”Š    context,\n+â”Š  â”Š29â”Š    subscriptions,\n â”Š29â”Š30â”Š  })\n â”Š30â”Š31â”Š\n â”Š31â”Š32â”Š  apollo.applyMiddleware({\n```\n\n##### Changed modules&#x2F;chat&#x2F;providers&#x2F;chat.provider.ts\n```diff\n@@ -1,4 +1,5 @@\n â”Š1â”Š1â”Šimport { Injectable } from '@graphql-modules/di'\n+â”Š â”Š2â”Šimport { PubSub } from 'apollo-server-express'\n â”Š2â”Š3â”Šimport { Connection } from 'typeorm'\n â”Š3â”Š4â”Šimport { Chat } from '../../../entity/chat'\n â”Š4â”Š5â”Šimport { User } from '../../../entity/user'\n```\n```diff\n@@ -8,6 +9,7 @@\n â”Š 8â”Š 9â”Š@Injectable()\n â”Š 9â”Š10â”Šexport class ChatProvider {\n â”Š10â”Š11â”Š  constructor(\n+â”Š  â”Š12â”Š    private pubsub: PubSub,\n â”Š11â”Š13â”Š    private connection: Connection,\n â”Š12â”Š14â”Š    private userProvider: UserProvider,\n â”Š13â”Š15â”Š    private authProvider: AuthProvider\n```\n```diff\n@@ -108,4 +110,53 @@\n â”Š108â”Š110â”Š\n â”Š109â”Š111â”Š    return owner || null\n â”Š110â”Š112â”Š  }\n+â”Š   â”Š113â”Š\n+â”Š   â”Š114â”Š  async filterChatAddedOrUpdated(chatAddedOrUpdated: Chat, creatorOrUpdaterId: string) {\n+â”Š   â”Š115â”Š    return (\n+â”Š   â”Š116â”Š      creatorOrUpdaterId !== this.currentUser.id &&\n+â”Š   â”Š117â”Š      chatAddedOrUpdated.listingMembers.some((user: User) => user.id === this.currentUser.id)\n+â”Š   â”Š118â”Š    )\n+â”Š   â”Š119â”Š  }\n+â”Š   â”Š120â”Š\n+â”Š   â”Š121â”Š  async updateUser({\n+â”Š   â”Š122â”Š    name,\n+â”Š   â”Š123â”Š    picture,\n+â”Š   â”Š124â”Š  }: {\n+â”Š   â”Š125â”Š    name?: string\n+â”Š   â”Š126â”Š    picture?: string\n+â”Š   â”Š127â”Š  } = {}) {\n+â”Š   â”Š128â”Š    await this.userProvider.updateUser({ name, picture })\n+â”Š   â”Š129â”Š\n+â”Š   â”Š130â”Š    const data = await this.connection\n+â”Š   â”Š131â”Š      .createQueryBuilder(User, 'user')\n+â”Š   â”Š132â”Š      .where('user.id = :id', { id: this.currentUser.id })\n+â”Š   â”Š133â”Š      // Get a list of the chats who have/had currentUser involved\n+â”Š   â”Š134â”Š      .innerJoinAndSelect(\n+â”Š   â”Š135â”Š        'user.allTimeMemberChats',\n+â”Š   â”Š136â”Š        'allTimeMemberChats',\n+â”Š   â”Š137â”Š        // Groups are unaffected\n+â”Š   â”Š138â”Š        'allTimeMemberChats.name IS NULL'\n+â”Š   â”Š139â”Š      )\n+â”Š   â”Š140â”Š      // We need to notify only those who get the chat listed (except currentUser of course)\n+â”Š   â”Š141â”Š      .innerJoin(\n+â”Š   â”Š142â”Š        'allTimeMemberChats.listingMembers',\n+â”Š   â”Š143â”Š        'listingMembers',\n+â”Š   â”Š144â”Š        'listingMembers.id != :currentUserId',\n+â”Š   â”Š145â”Š        {\n+â”Š   â”Š146â”Š          currentUserId: this.currentUser.id,\n+â”Š   â”Š147â”Š        }\n+â”Š   â”Š148â”Š      )\n+â”Š   â”Š149â”Š      .getOne()\n+â”Š   â”Š150â”Š\n+â”Š   â”Š151â”Š    const chatsAffected = (data && data.allTimeMemberChats) || []\n+â”Š   â”Š152â”Š\n+â”Š   â”Š153â”Š    chatsAffected.forEach(chat => {\n+â”Š   â”Š154â”Š      this.pubsub.publish('chatUpdated', {\n+â”Š   â”Š155â”Š        updaterId: this.currentUser.id,\n+â”Š   â”Š156â”Š        chatUpdated: chat,\n+â”Š   â”Š157â”Š      })\n+â”Š   â”Š158â”Š    })\n+â”Š   â”Š159â”Š\n+â”Š   â”Š160â”Š    return this.currentUser\n+â”Š   â”Š161â”Š  }\n â”Š111â”Š162â”Š}\n```\n\n##### Changed modules&#x2F;chat&#x2F;resolvers&#x2F;resolvers.ts\n```diff\n@@ -1,12 +1,28 @@\n+â”Š  â”Š 1â”Šimport { PubSub, withFilter } from 'apollo-server-express'\n â”Š 1â”Š 2â”Šimport { ModuleContext } from '@graphql-modules/core'\n â”Š 2â”Š 3â”Šimport { IResolvers } from '../../../types'\n â”Š 3â”Š 4â”Šimport { ChatProvider } from '../providers/chat.provider'\n+â”Š  â”Š 5â”Šimport { Chat } from '../../../entity/chat'\n â”Š 4â”Š 6â”Š\n â”Š 5â”Š 7â”Šexport default {\n â”Š 6â”Š 8â”Š  Query: {\n â”Š 7â”Š 9â”Š    chats: (obj, args, { injector }) => injector.get(ChatProvider).getChats(),\n â”Š 8â”Š10â”Š    chat: (obj, { chatId }, { injector }) => injector.get(ChatProvider).getChat(chatId),\n â”Š 9â”Š11â”Š  },\n+â”Š  â”Š12â”Š  Mutation: {\n+â”Š  â”Š13â”Š    updateUser: (obj, { name, picture }, { injector }) => injector.get(ChatProvider).updateUser({\n+â”Š  â”Š14â”Š      name: name || '',\n+â”Š  â”Š15â”Š      picture: picture || '',\n+â”Š  â”Š16â”Š    }),\n+â”Š  â”Š17â”Š  },\n+â”Š  â”Š18â”Š  Subscription: {\n+â”Š  â”Š19â”Š    chatUpdated: {\n+â”Š  â”Š20â”Š      subscribe: withFilter((root, args, { injector }: ModuleContext) => injector.get(PubSub).asyncIterator('chatUpdated'),\n+â”Š  â”Š21â”Š        (data: { chatUpdated: Chat, updaterId: string }, variables, { injector }: ModuleContext) =>\n+â”Š  â”Š22â”Š          data && injector.get(ChatProvider).filterChatAddedOrUpdated(data.chatUpdated, data.updaterId)\n+â”Š  â”Š23â”Š      ),\n+â”Š  â”Š24â”Š    },\n+â”Š  â”Š25â”Š  },\n â”Š10â”Š26â”Š  Chat: {\n â”Š11â”Š27â”Š    name: (chat, args, { injector }) => injector.get(ChatProvider).getChatName(chat),\n â”Š12â”Š28â”Š    picture: (chat, args, { injector }) => injector.get(ChatProvider).getChatPicture(chat),\n```\n\n##### Changed modules&#x2F;chat&#x2F;schema&#x2F;typeDefs.graphql\n```diff\n@@ -3,6 +3,10 @@\n â”Š 3â”Š 3â”Š  chat(chatId: ID!): Chat\n â”Š 4â”Š 4â”Š}\n â”Š 5â”Š 5â”Š\n+â”Š  â”Š 6â”Štype Subscription {\n+â”Š  â”Š 7â”Š  chatUpdated: Chat\n+â”Š  â”Š 8â”Š}\n+â”Š  â”Š 9â”Š\n â”Š 6â”Š10â”Štype Chat {\n â”Š 7â”Š11â”Š  #May be a chat or a group\n â”Š 8â”Š12â”Š  id: ID!\n```\n\n[}]: #\n\n> See [official Apollo subscription docs page](https://www.apollographql.com/docs/apollo-server/features/subscriptions.html).\n\nNote that we've added a second `updateUser()` resolver in addition to the one which already exists in the `user` module. Reason being is because we want to keep the `user` module independent from the `chat` module, and so we apply logic on top of the existing one. GQLModule's engine will execute the resolvers in the right order based on the injected dependencies tree, so you shouldn't worry much about execution.\n\nI'd like to get back to the image uploading feature. Although it can be implemented manually, we will be using an external service for storing images. This is much more convenient: it will save us a lot of implementation, it's probably more secure, and it has built-in features such as transformation and projection.\n\nWe will be using [Cloudinary](https://cloudinary.com/) as our storage service. A Cloudinary instance should be set for each application separately, but for the sake of demonstration we will use an instance that we set up for the public, but just know **that you should never reveal the credentials of any service that you set up**.\n\nFirst of all be sure to open an account and setup your basic app information in Cloudinary.\n\nThen, add a new preset called `profile-pic` where we will be resettings uploaded images' dimensions to 300px by 300px. More information on how to do that can be found in [here](https://support.cloudinary.com/hc/en-us/articles/360004967272-Upload-Preset-Configuration).\n\n![upload-picture-settings](https://user-images.githubusercontent.com/7648874/51096173-a984f480-17f5-11e9-893f-5227e2c564af.jpg)\n\nUp next, we will implement the appropriate route in our app's server. The reason we don't upload the image directly to the cloud service directly from our application is because **we risk exposing some sensitive data regards the service and some users may abuse it**. We will start by installing the right packages:\n\n    $ yarn add tmp@0.0.33 multer@1.4.1 cloudinary@1.13.2\n    $ yarn add -D @types/tmp@0.0.33 @types/multer1.3.7\n\nWe will also write custom TypeScript definitions for the `cloudinary` package since they don't exist:\n\n[{]: <helper> (diffStep 2.4 files=\"cloudinary.d.ts\" module=\"server\")\n\n#### [Step 2.4: Add /upload-profile-pic REST endpoint](https://github.com/Urigo/WhatsApp-Clone-Server/commit/41c390c)\n\n##### Added cloudinary.d.ts\n```diff\n@@ -0,0 +1,10 @@\n+â”Š  â”Š 1â”Šdeclare module 'cloudinary' {\n+â”Š  â”Š 2â”Š  export function config(config: { cloud_name: string; api_key: string; api_secret: string }): void\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Š  export var v2: {\n+â”Š  â”Š 5â”Š    uploader: {\n+â”Š  â”Š 6â”Š      upload_stream: (callback?: (error: Error, result: any) => any) => NodeJS.WritableStream\n+â”Š  â”Š 7â”Š      upload: (path: string, callback?: (error: Error, result: any) => any) => any\n+â”Š  â”Š 8â”Š    }\n+â”Š  â”Š 9â”Š  }\n+â”Š  â”Š10â”Š}\n```\n\n[}]: #\n\nThen we will set the right API keys in the `.env` file:\n\n[{]: <helper> (diffStep 2.4 files=\".env\" module=\"server\")\n\n#### [Step 2.4: Add /upload-profile-pic REST endpoint](https://github.com/Urigo/WhatsApp-Clone-Server/commit/41c390c)\n\n##### Added .env\n```diff\n@@ -0,0 +1,2 @@\n+â”Š â”Š1â”Š# NEVER DEFINE HERE ONLY ON CLOUD\n+â”Š â”Š2â”ŠCLOUDINARY_URL=cloudinary://756494366771661:OttZILiLRKaB5tKR8F3vQhMrNRg@whatsapp-clone\n```\n\n[}]: #\n\nThe purpose of the `.env` file is to load environment variables into our app in a more comfortable way. For that to apply we will need to install and require a package which is called [`dotenv`](https://www.npmjs.com/package/dotenv).\n\n    $ yarn add dotenv@6.2.0\n\n[{]: <helper> (diffStep 2.4 files=\"index\" module=\"server\")\n\n#### [Step 2.4: Add /upload-profile-pic REST endpoint](https://github.com/Urigo/WhatsApp-Clone-Server/commit/41c390c)\n\n##### Changed index.ts\n```diff\n@@ -1,3 +1,5 @@\n+â”Š â”Š1â”Šrequire('dotenv').config()\n+â”Š â”Š2â”Š\n â”Š1â”Š3â”Šimport 'reflect-metadata'\n â”Š2â”Š4â”Šimport { ApolloServer } from 'apollo-server-express'\n â”Š3â”Š5â”Šimport bodyParser from 'body-parser'\n```\n\n##### Changed modules&#x2F;user&#x2F;index.ts\n```diff\n@@ -1,18 +1,43 @@\n+â”Š  â”Š 1â”Š/// <reference path=\"../../cloudinary.d.ts\" />\n â”Š 1â”Š 2â”Šimport { GraphQLModule } from '@graphql-modules/core'\n â”Š 2â”Š 3â”Šimport { InjectFunction, ProviderScope } from '@graphql-modules/di'\n â”Š 3â”Š 4â”Šimport { loadResolversFiles, loadSchemaFiles } from '@graphql-modules/sonar'\n+â”Š  â”Š 5â”Šimport { Express } from 'express'\n+â”Š  â”Š 6â”Šimport multer from 'multer'\n+â”Š  â”Š 7â”Šimport tmp from 'tmp'\n+â”Š  â”Š 8â”Šimport cloudinary from 'cloudinary'\n+â”Š  â”Š 9â”Šimport { APP } from '../app.symbols'\n â”Š 4â”Š10â”Šimport { AuthModule } from '../auth'\n â”Š 5â”Š11â”Šimport { UserProvider } from './providers/user.provider'\n â”Š 6â”Š12â”Š\n+â”Š  â”Š13â”Šconst CLOUDINARY_URL = process.env.CLOUDINARY_URL || ''\n+â”Š  â”Š14â”Š\n â”Š 7â”Š15â”Šexport const UserModule = new GraphQLModule({\n â”Š 8â”Š16â”Š  name: 'User',\n-â”Š 9â”Š  â”Š  imports: [\n-â”Š10â”Š  â”Š    AuthModule,\n-â”Š11â”Š  â”Š  ],\n-â”Š12â”Š  â”Š  providers: [\n-â”Š13â”Š  â”Š    UserProvider,\n-â”Š14â”Š  â”Š  ],\n+â”Š  â”Š17â”Š  imports: [AuthModule],\n+â”Š  â”Š18â”Š  providers: [UserProvider],\n â”Š15â”Š19â”Š  typeDefs: loadSchemaFiles(__dirname + '/schema/'),\n â”Š16â”Š20â”Š  resolvers: loadResolversFiles(__dirname + '/resolvers/'),\n â”Š17â”Š21â”Š  defaultProviderScope: ProviderScope.Session,\n+â”Š  â”Š22â”Š  middleware: InjectFunction(UserProvider, APP)((userProvider, app: Express) => {\n+â”Š  â”Š23â”Š    const match = CLOUDINARY_URL.match(/cloudinary:\\/\\/(\\d+):(\\w+)@(\\.+)/)\n+â”Š  â”Š24â”Š\n+â”Š  â”Š25â”Š    if (match) {\n+â”Š  â”Š26â”Š      const [api_key, api_secret, cloud_name] = match.slice(1)\n+â”Š  â”Š27â”Š      cloudinary.config({ api_key, api_secret, cloud_name })\n+â”Š  â”Š28â”Š    }\n+â”Š  â”Š29â”Š\n+â”Š  â”Š30â”Š    const upload = multer({\n+â”Š  â”Š31â”Š      dest: tmp.dirSync({ unsafeCleanup: true }).name,\n+â”Š  â”Š32â”Š    })\n+â”Š  â”Š33â”Š\n+â”Š  â”Š34â”Š    app.post('/upload-profile-pic', upload.single('file'), async (req: any, res, done) => {\n+â”Š  â”Š35â”Š      try {\n+â”Š  â”Š36â”Š        res.json(await userProvider.uploadProfilePic(req.file.path))\n+â”Š  â”Š37â”Š      } catch (e) {\n+â”Š  â”Š38â”Š        done(e)\n+â”Š  â”Š39â”Š      }\n+â”Š  â”Š40â”Š    })\n+â”Š  â”Š41â”Š    return {}\n+â”Š  â”Š42â”Š  }),\n â”Š18â”Š43â”Š})\n```\n\n[}]: #\n\n> See [Cloudinary's NodeJS API](https://cloudinary.com/documentation/node_integration).\n> See [API setup](https://cloudinary.com/documentation/solution_overview#account_and_api_setup).\n\nAnd finally, we will implement a REST endpoint in the `user` module under `/upload-profile-pic`:\n\n[{]: <helper> (diffStep 2.4 files=\"modules/user\" module=\"server\")\n\n#### [Step 2.4: Add /upload-profile-pic REST endpoint](https://github.com/Urigo/WhatsApp-Clone-Server/commit/41c390c)\n\n##### Changed modules&#x2F;user&#x2F;index.ts\n```diff\n@@ -1,18 +1,43 @@\n+â”Š  â”Š 1â”Š/// <reference path=\"../../cloudinary.d.ts\" />\n â”Š 1â”Š 2â”Šimport { GraphQLModule } from '@graphql-modules/core'\n â”Š 2â”Š 3â”Šimport { InjectFunction, ProviderScope } from '@graphql-modules/di'\n â”Š 3â”Š 4â”Šimport { loadResolversFiles, loadSchemaFiles } from '@graphql-modules/sonar'\n+â”Š  â”Š 5â”Šimport { Express } from 'express'\n+â”Š  â”Š 6â”Šimport multer from 'multer'\n+â”Š  â”Š 7â”Šimport tmp from 'tmp'\n+â”Š  â”Š 8â”Šimport cloudinary from 'cloudinary'\n+â”Š  â”Š 9â”Šimport { APP } from '../app.symbols'\n â”Š 4â”Š10â”Šimport { AuthModule } from '../auth'\n â”Š 5â”Š11â”Šimport { UserProvider } from './providers/user.provider'\n â”Š 6â”Š12â”Š\n+â”Š  â”Š13â”Šconst CLOUDINARY_URL = process.env.CLOUDINARY_URL || ''\n+â”Š  â”Š14â”Š\n â”Š 7â”Š15â”Šexport const UserModule = new GraphQLModule({\n â”Š 8â”Š16â”Š  name: 'User',\n-â”Š 9â”Š  â”Š  imports: [\n-â”Š10â”Š  â”Š    AuthModule,\n-â”Š11â”Š  â”Š  ],\n-â”Š12â”Š  â”Š  providers: [\n-â”Š13â”Š  â”Š    UserProvider,\n-â”Š14â”Š  â”Š  ],\n+â”Š  â”Š17â”Š  imports: [AuthModule],\n+â”Š  â”Š18â”Š  providers: [UserProvider],\n â”Š15â”Š19â”Š  typeDefs: loadSchemaFiles(__dirname + '/schema/'),\n â”Š16â”Š20â”Š  resolvers: loadResolversFiles(__dirname + '/resolvers/'),\n â”Š17â”Š21â”Š  defaultProviderScope: ProviderScope.Session,\n+â”Š  â”Š22â”Š  middleware: InjectFunction(UserProvider, APP)((userProvider, app: Express) => {\n+â”Š  â”Š23â”Š    const match = CLOUDINARY_URL.match(/cloudinary:\\/\\/(\\d+):(\\w+)@(\\.+)/)\n+â”Š  â”Š24â”Š\n+â”Š  â”Š25â”Š    if (match) {\n+â”Š  â”Š26â”Š      const [api_key, api_secret, cloud_name] = match.slice(1)\n+â”Š  â”Š27â”Š      cloudinary.config({ api_key, api_secret, cloud_name })\n+â”Š  â”Š28â”Š    }\n+â”Š  â”Š29â”Š\n+â”Š  â”Š30â”Š    const upload = multer({\n+â”Š  â”Š31â”Š      dest: tmp.dirSync({ unsafeCleanup: true }).name,\n+â”Š  â”Š32â”Š    })\n+â”Š  â”Š33â”Š\n+â”Š  â”Š34â”Š    app.post('/upload-profile-pic', upload.single('file'), async (req: any, res, done) => {\n+â”Š  â”Š35â”Š      try {\n+â”Š  â”Š36â”Š        res.json(await userProvider.uploadProfilePic(req.file.path))\n+â”Š  â”Š37â”Š      } catch (e) {\n+â”Š  â”Š38â”Š        done(e)\n+â”Š  â”Š39â”Š      }\n+â”Š  â”Š40â”Š    })\n+â”Š  â”Š41â”Š    return {}\n+â”Š  â”Š42â”Š  }),\n â”Š18â”Š43â”Š})\n```\n\n##### Changed modules&#x2F;user&#x2F;providers&#x2F;user.provider.ts\n```diff\n@@ -1,4 +1,5 @@\n â”Š1â”Š1â”Šimport { Injectable, ProviderScope } from '@graphql-modules/di'\n+â”Š â”Š2â”Šimport cloudinary from 'cloudinary'\n â”Š2â”Š3â”Šimport { Connection } from 'typeorm'\n â”Š3â”Š4â”Šimport { User } from '../../../entity/user'\n â”Š4â”Š5â”Šimport { AuthProvider } from '../../auth/providers/auth.provider'\n```\n```diff\n@@ -42,4 +43,16 @@\n â”Š42â”Š43â”Š\n â”Š43â”Š44â”Š    return this.currentUser;\n â”Š44â”Š45â”Š  }\n+â”Š  â”Š46â”Š\n+â”Š  â”Š47â”Š  uploadProfilePic(filePath: string) {\n+â”Š  â”Š48â”Š    return new Promise((resolve, reject) => {\n+â”Š  â”Š49â”Š      cloudinary.v2.uploader.upload(filePath, (error, result) => {\n+â”Š  â”Š50â”Š        if (error) {\n+â”Š  â”Š51â”Š          reject(error)\n+â”Š  â”Š52â”Š        } else {\n+â”Š  â”Š53â”Š          resolve(result)\n+â”Š  â”Š54â”Š        }\n+â”Š  â”Š55â”Š      })\n+â”Š  â”Š56â”Š    })\n+â”Š  â”Š57â”Š  }\n â”Š45â”Š58â”Š}\n```\n\n[}]: #\n\nNow getting back to the client, we will implement a `picture.service` that will be responsible for uploading images in our application:\n\n[{]: <helper> (diffStep 2.6 files=\"src/services/picture\" module=\"client\")\n\n#### [Step 2.6: Implement image uploading](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/99fd034)\n\n##### Added src&#x2F;services&#x2F;picture.service.tsx\n```diff\n@@ -0,0 +1,31 @@\n+â”Š  â”Š 1â”Šimport { getAuthHeader } from './auth.service'\n+â”Š  â”Š 2â”Š\n+â”Š  â”Š 3â”Šexport const pickPicture = () => {\n+â”Š  â”Š 4â”Š  return new Promise((resolve, reject) => {\n+â”Š  â”Š 5â”Š    const input = document.createElement('input')\n+â”Š  â”Š 6â”Š    input.type = 'file'\n+â”Š  â”Š 7â”Š    input.accept = 'image/*'\n+â”Š  â”Š 8â”Š    input.onchange = e => {\n+â”Š  â”Š 9â”Š      const target = e.target as HTMLInputElement\n+â”Š  â”Š10â”Š      resolve(target.files[0])\n+â”Š  â”Š11â”Š    }\n+â”Š  â”Š12â”Š    input.onerror = reject\n+â”Š  â”Š13â”Š    input.click()\n+â”Š  â”Š14â”Š  })\n+â”Š  â”Š15â”Š}\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Šexport const uploadProfilePicture = file => {\n+â”Š  â”Š18â”Š  const formData = new FormData()\n+â”Š  â”Š19â”Š  formData.append('file', file)\n+â”Š  â”Š20â”Š  formData.append('upload_preset', 'profile-pic')\n+â”Š  â”Š21â”Š\n+â”Š  â”Š22â”Š  return fetch(`${process.env.REACT_APP_SERVER_URL}/upload-profile-pic`, {\n+â”Š  â”Š23â”Š    method: 'POST',\n+â”Š  â”Š24â”Š    body: formData,\n+â”Š  â”Š25â”Š    headers: {\n+â”Š  â”Š26â”Š      Authorization: getAuthHeader(),\n+â”Š  â”Š27â”Š    }\n+â”Š  â”Š28â”Š  }).then(res => {\n+â”Š  â”Š29â”Š    return res.json()\n+â”Š  â”Š30â”Š  })\n+â”Š  â”Š31â”Š}\n```\n\n[}]: #\n\nAnd we will use it in the settings screen:\n\n[{]: <helper> (diffStep 2.6 files=\"src/components\" module=\"client\")\n\n#### [Step 2.6: Implement image uploading](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/99fd034)\n\n##### Changed src&#x2F;components&#x2F;SettingsScreen&#x2F;SettingsForm.tsx\n```diff\n@@ -10,6 +10,7 @@\n â”Š10â”Š10â”Šimport * as fragments from '../../graphql/fragments'\n â”Š11â”Š11â”Šimport { SettingsFormMutation } from '../../graphql/types'\n â”Š12â”Š12â”Šimport { useMe } from '../../services/auth.service'\n+â”Š  â”Š13â”Šimport { pickPicture, uploadProfilePicture } from '../../services/picture.service'\n â”Š13â”Š14â”Šimport Navbar from '../Navbar'\n â”Š14â”Š15â”Šimport SettingsNavbar from './SettingsNavbar'\n â”Š15â”Š16â”Š\n```\n```diff\n@@ -104,7 +105,13 @@\n â”Š104â”Š105â”Š  }\n â”Š105â”Š106â”Š\n â”Š106â”Š107â”Š  const updatePicture = async () => {\n-â”Š107â”Š   â”Š    // TODO: Implement\n+â”Š   â”Š108â”Š    const file = await pickPicture()\n+â”Š   â”Š109â”Š\n+â”Š   â”Š110â”Š    if (!file) return\n+â”Š   â”Š111â”Š\n+â”Š   â”Š112â”Š    const { url } = await uploadProfilePicture(file)\n+â”Š   â”Š113â”Š\n+â”Š   â”Š114â”Š    setMyPicture(url)\n â”Š108â”Š115â”Š  }\n â”Š109â”Š116â”Š\n â”Š110â”Š117â”Š  return (\n```\n\n[}]: #\n\nThe settings component is complete! We will connect it to the main flow by implementing the pop-over menu at the top right corner of the main screen where we will be able to navigate to the settings screen and sign-out:\n\n[{]: <helper> (diffStep 2.7 module=\"client\")\n\n#### [Step 2.7: Make components navigatable](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/fcc5b70)\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -3,6 +3,7 @@\n â”Š3â”Š3â”Šimport AnimatedSwitch from './components/AnimatedSwitch'\n â”Š4â”Š4â”Šimport AuthScreen from './components/AuthScreen'\n â”Š5â”Š5â”Šimport ChatsListScreen from './components/ChatsListScreen'\n+â”Š â”Š6â”Šimport SettingsScreen from './components/SettingsScreen'\n â”Š6â”Š7â”Šimport { withAuth } from './services/auth.service'\n â”Š7â”Š8â”Š\n â”Š8â”Š9â”Šconst RedirectToChats = () => (\n```\n```diff\n@@ -14,6 +15,7 @@\n â”Š14â”Š15â”Š    <AnimatedSwitch>\n â”Š15â”Š16â”Š      <Route exact path=\"/sign-(in|up)\" component={AuthScreen} />\n â”Š16â”Š17â”Š      <Route exact path=\"/chats\" component={withAuth(ChatsListScreen)} />\n+â”Š  â”Š18â”Š      <Route exact path=\"/settings\" component={withAuth(SettingsScreen)} />\n â”Š17â”Š19â”Š      <Route component={RedirectToChats} />\n â”Š18â”Š20â”Š    </AnimatedSwitch>\n â”Š19â”Š21â”Š  </BrowserRouter>\n```\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsNavbar.tsx\n```diff\n@@ -1,14 +1,95 @@\n+â”Š  â”Š 1â”Šimport Button from '@material-ui/core/Button'\n+â”Š  â”Š 2â”Šimport List from '@material-ui/core/List'\n+â”Š  â”Š 3â”Šimport ListItem from '@material-ui/core/ListItem'\n+â”Š  â”Š 4â”Šimport Popover from '@material-ui/core/Popover'\n+â”Š  â”Š 5â”Šimport MoreIcon from '@material-ui/icons/MoreVert'\n+â”Š  â”Š 6â”Šimport SignOutIcon from '@material-ui/icons/PowerSettingsNew'\n+â”Š  â”Š 7â”Šimport SettingsIcon from '@material-ui/icons/Settings'\n+â”Š  â”Š 8â”Šimport { History } from 'history'\n â”Š 1â”Š 9â”Šimport * as React from 'react'\n+â”Š  â”Š10â”Šimport { useState } from 'react'\n â”Š 2â”Š11â”Šimport styled from 'styled-components'\n+â”Š  â”Š12â”Šimport { signOut } from '../../services/auth.service'\n â”Š 3â”Š13â”Š\n â”Š 4â”Š14â”Šconst Style = styled.div`\n+â”Š  â”Š15â”Š  padding: 0;\n+â”Š  â”Š16â”Š  display: flex;\n+â”Š  â”Š17â”Š  flex-direction: row;\n+â”Š  â”Š18â”Š\n â”Š 5â”Š19â”Š  .ChatsNavbar-title {\n-â”Š 6â”Š  â”Š    float: left;\n+â”Š  â”Š20â”Š    line-height: 56px;\n+â”Š  â”Š21â”Š  }\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Š  .ChatsNavbar-options-btn {\n+â”Š  â”Š24â”Š    float: right;\n+â”Š  â”Š25â”Š    height: 100%;\n+â”Š  â”Š26â”Š    font-size: 1.2em;\n+â”Š  â”Š27â”Š    margin-right: -15px;\n+â”Š  â”Š28â”Š    color: var(--primary-text);\n+â”Š  â”Š29â”Š  }\n+â”Š  â”Š30â”Š\n+â”Š  â”Š31â”Š  .ChatsNavbar-rest {\n+â”Š  â”Š32â”Š    flex: 1;\n+â”Š  â”Š33â”Š    justify-content: flex-end;\n+â”Š  â”Š34â”Š  }\n+â”Š  â”Š35â”Š\n+â”Š  â”Š36â”Š  .ChatsNavbar-options-item svg {\n+â”Š  â”Š37â”Š    margin-right: 10px;\n â”Š 7â”Š38â”Š  }\n â”Š 8â”Š39â”Š`\n â”Š 9â”Š40â”Š\n-â”Š10â”Š  â”Šexport default () => (\n-â”Š11â”Š  â”Š  <Style className=\"ChatsNavbar\">\n-â”Š12â”Š  â”Š    <span className=\"ChatsNavbar-title\">WhatsApp Clone</span>\n-â”Š13â”Š  â”Š  </Style>\n-â”Š14â”Š  â”Š)\n+â”Š  â”Š41â”Šinterface ChatsNavbarProps {\n+â”Š  â”Š42â”Š  history: History\n+â”Š  â”Š43â”Š}\n+â”Š  â”Š44â”Š\n+â”Š  â”Š45â”Šexport default ({ history }: ChatsNavbarProps) => {\n+â”Š  â”Š46â”Š  const [popped, setPopped] = useState(false)\n+â”Š  â”Š47â”Š\n+â”Š  â”Š48â”Š  const navToSettings = () => {\n+â”Š  â”Š49â”Š    setPopped(false)\n+â”Š  â”Š50â”Š    history.push('/settings')\n+â”Š  â”Š51â”Š  }\n+â”Š  â”Š52â”Š\n+â”Š  â”Š53â”Š  const handleSignOut = () => {\n+â”Š  â”Š54â”Š    setPopped(false)\n+â”Š  â”Š55â”Š    signOut()\n+â”Š  â”Š56â”Š\n+â”Š  â”Š57â”Š    history.push('/sign-in')\n+â”Š  â”Š58â”Š  }\n+â”Š  â”Š59â”Š\n+â”Š  â”Š60â”Š  return (\n+â”Š  â”Š61â”Š    <Style className=\"ChatsNavbar\">\n+â”Š  â”Š62â”Š      <span className=\"ChatsNavbar-title\">WhatsApp Clone</span>\n+â”Š  â”Š63â”Š      <div className=\"ChatsNavbar-rest\">\n+â”Š  â”Š64â”Š        <Button className=\"ChatsNavbar-options-btn\" onClick={setPopped.bind(null, true)}>\n+â”Š  â”Š65â”Š          <MoreIcon />\n+â”Š  â”Š66â”Š        </Button>\n+â”Š  â”Š67â”Š      </div>\n+â”Š  â”Š68â”Š      <Popover\n+â”Š  â”Š69â”Š        open={popped}\n+â”Š  â”Š70â”Š        onClose={setPopped.bind(null, false)}\n+â”Š  â”Š71â”Š        anchorOrigin={{\n+â”Š  â”Š72â”Š          vertical: 'top',\n+â”Š  â”Š73â”Š          horizontal: 'right',\n+â”Š  â”Š74â”Š        }}\n+â”Š  â”Š75â”Š        transformOrigin={{\n+â”Š  â”Š76â”Š          vertical: 'top',\n+â”Š  â”Š77â”Š          horizontal: 'right',\n+â”Š  â”Š78â”Š        }}\n+â”Š  â”Š79â”Š      >\n+â”Š  â”Š80â”Š        <Style>\n+â”Š  â”Š81â”Š          <List>\n+â”Š  â”Š82â”Š            <ListItem className=\"ChatsNavbar-options-item\" button onClick={navToSettings}>\n+â”Š  â”Š83â”Š              <SettingsIcon />\n+â”Š  â”Š84â”Š              Settings\n+â”Š  â”Š85â”Š            </ListItem>\n+â”Š  â”Š86â”Š            <ListItem className=\"ChatsNavbar-options-item\" button onClick={handleSignOut}>\n+â”Š  â”Š87â”Š              <SignOutIcon />\n+â”Š  â”Š88â”Š              Sign Out\n+â”Š  â”Š89â”Š            </ListItem>\n+â”Š  â”Š90â”Š          </List>\n+â”Š  â”Š91â”Š        </Style>\n+â”Š  â”Š92â”Š      </Popover>\n+â”Š  â”Š93â”Š    </Style>\n+â”Š  â”Š94â”Š  )\n+â”Š  â”Š95â”Š}\n```\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;index.tsx\n```diff\n@@ -1,13 +1,14 @@\n â”Š 1â”Š 1â”Šimport * as React from 'react'\n â”Š 2â”Š 2â”Šimport { Suspense } from 'react'\n+â”Š  â”Š 3â”Šimport { RouteComponentProps } from 'react-router-dom'\n â”Š 3â”Š 4â”Šimport Navbar from '../Navbar'\n â”Š 4â”Š 5â”Šimport ChatsList from './ChatsList'\n â”Š 5â”Š 6â”Šimport ChatsNavbar from './ChatsNavbar'\n â”Š 6â”Š 7â”Š\n-â”Š 7â”Š  â”Šexport default () => (\n+â”Š  â”Š 8â”Šexport default ({ history }: RouteComponentProps) => (\n â”Š 8â”Š 9â”Š  <div className=\"ChatsListScreen Screen\">\n â”Š 9â”Š10â”Š    <Navbar>\n-â”Š10â”Š  â”Š      <ChatsNavbar />\n+â”Š  â”Š11â”Š      <ChatsNavbar history={history} />\n â”Š11â”Š12â”Š    </Navbar>\n â”Š12â”Š13â”Š    <Suspense fallback={null}>\n â”Š13â”Š14â”Š      <ChatsList />\n```\n\n[}]: #"
          },
          {
            "manualTitle": "Step 3: Creating a chat app",
            "stepRevision": "541b9d468edfcd0b8f49211e76498ccf13c0d27d",
            "manualView": "![chats](https://user-images.githubusercontent.com/7648874/52663040-aa1dc180-2f40-11e9-9ae4-bda648916bc4.png)\n\nIn this step we will be implementing a basic chat app. We will be able to:\n\n- Create chats.\n- Remove chats.\n- Send messages.\n\nThe flow is gonna go like this:\n\n- A chat can be created by picking a user from the users list.\n- When clicking on a chat, we will be promoted to a chat room.\n- The chat room will have a pop-over menu where we will be able to remove the chat.\n\nWe will start by adding a new entity called `Recipient`. The `Recipient` entity is the bridge between the `User` and the `Message` and it will tell us when the message was received and when it was read. Note that a message holds multiple recipients - this way we can extend its functionality to support group messaging where each message can have more than 2 recipients. Accordingly, we will have to make few adjustments to the existing entities:\n\n[{]: <helper> (diffStep 3.1 module=\"server\")\n\n#### [Step 3.1: Edit entities to serve chat app](https://github.com/Urigo/WhatsApp-Clone-Server/commit/a547772)\n\n##### Changed codegen.yml\n```diff\n@@ -12,6 +12,7 @@\n â”Š12â”Š12â”Š      mappers:\n â”Š13â”Š13â”Š        Chat: ./entity/chat#Chat\n â”Š14â”Š14â”Š        Message: ./entity/message#Message\n+â”Š  â”Š15â”Š        Recipient: ./entity/recipient#Recipient\n â”Š15â”Š16â”Š        User: ./entity/user#User\n â”Š16â”Š17â”Š      scalars:\n â”Š17â”Š18â”Š        Date: Date\n```\n\n##### Changed entity&#x2F;message.ts\n```diff\n@@ -9,6 +9,7 @@\n â”Š 9â”Š 9â”Š  CreateDateColumn,\n â”Š10â”Š10â”Š} from 'typeorm'\n â”Š11â”Š11â”Šimport Chat from './chat'\n+â”Š  â”Š12â”Šimport Recipient from './recipient'\n â”Š12â”Š13â”Šimport User from './user'\n â”Š13â”Š14â”Šimport { MessageType } from '../db'\n â”Š14â”Š15â”Š\n```\n```diff\n@@ -17,6 +18,7 @@\n â”Š17â”Š18â”Š  content?: string\n â”Š18â”Š19â”Š  createdAt?: Date\n â”Š19â”Š20â”Š  type?: MessageType\n+â”Š  â”Š21â”Š  recipients?: Recipient[]\n â”Š20â”Š22â”Š  holders?: User[]\n â”Š21â”Š23â”Š  chat?: Chat\n â”Š22â”Š24â”Š}\n```\n```diff\n@@ -38,6 +40,9 @@\n â”Š38â”Š40â”Š  @Column()\n â”Š39â”Š41â”Š  type: number\n â”Š40â”Š42â”Š\n+â”Š  â”Š43â”Š  @OneToMany(type => Recipient, recipient => recipient.message, { cascade: ['insert', 'update'], eager: true })\n+â”Š  â”Š44â”Š  recipients: Recipient[]\n+â”Š  â”Š45â”Š\n â”Š41â”Š46â”Š  @ManyToMany(type => User, user => user.holderMessages, {\n â”Š42â”Š47â”Š    cascade: ['insert', 'update'],\n â”Š43â”Š48â”Š    eager: true,\n```\n```diff\n@@ -53,6 +58,7 @@\n â”Š53â”Š58â”Š    content,\n â”Š54â”Š59â”Š    createdAt,\n â”Š55â”Š60â”Š    type,\n+â”Š  â”Š61â”Š    recipients,\n â”Š56â”Š62â”Š    holders,\n â”Š57â”Š63â”Š    chat,\n â”Š58â”Š64â”Š  }: MessageConstructor = {}) {\n```\n```diff\n@@ -68,6 +74,10 @@\n â”Š68â”Š74â”Š    if (type) {\n â”Š69â”Š75â”Š      this.type = type\n â”Š70â”Š76â”Š    }\n+â”Š  â”Š77â”Š    if (recipients) {\n+â”Š  â”Š78â”Š      recipients.forEach(recipient => recipient.message = this)\n+â”Š  â”Š79â”Š      this.recipients = recipients\n+â”Š  â”Š80â”Š    }\n â”Š71â”Š81â”Š    if (holders) {\n â”Š72â”Š82â”Š      this.holders = holders\n â”Š73â”Š83â”Š    }\n```\n\n##### Added entity&#x2F;recipient.ts\n```diff\n@@ -0,0 +1,42 @@\n+â”Š  â”Š 1â”Šimport { Entity, ManyToOne, Column } from 'typeorm'\n+â”Š  â”Š 2â”Šimport { Message } from './message'\n+â”Š  â”Š 3â”Šimport { User } from './user'\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šinterface RecipientConstructor {\n+â”Š  â”Š 6â”Š  user?: User\n+â”Š  â”Š 7â”Š  message?: Message\n+â”Š  â”Š 8â”Š  receivedAt?: Date\n+â”Š  â”Š 9â”Š  readAt?: Date\n+â”Š  â”Š10â”Š}\n+â”Š  â”Š11â”Š\n+â”Š  â”Š12â”Š@Entity()\n+â”Š  â”Š13â”Šexport class Recipient {\n+â”Š  â”Š14â”Š  @ManyToOne(type => User, user => user.recipients, { primary: true })\n+â”Š  â”Š15â”Š  user: User\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š  @ManyToOne(type => Message, message => message.recipients, { primary: true })\n+â”Š  â”Š18â”Š  message: Message\n+â”Š  â”Š19â”Š\n+â”Š  â”Š20â”Š  @Column({ nullable: true })\n+â”Š  â”Š21â”Š  receivedAt: Date\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Š  @Column({ nullable: true })\n+â”Š  â”Š24â”Š  readAt: Date\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Š  constructor({ user, message, receivedAt, readAt }: RecipientConstructor = {}) {\n+â”Š  â”Š27â”Š    if (user) {\n+â”Š  â”Š28â”Š      this.user = user\n+â”Š  â”Š29â”Š    }\n+â”Š  â”Š30â”Š    if (message) {\n+â”Š  â”Š31â”Š      this.message = message\n+â”Š  â”Š32â”Š    }\n+â”Š  â”Š33â”Š    if (receivedAt) {\n+â”Š  â”Š34â”Š      this.receivedAt = receivedAt\n+â”Š  â”Š35â”Š    }\n+â”Š  â”Š36â”Š    if (readAt) {\n+â”Š  â”Š37â”Š      this.readAt = readAt\n+â”Š  â”Š38â”Š    }\n+â”Š  â”Š39â”Š  }\n+â”Š  â”Š40â”Š}\n+â”Š  â”Š41â”Š\n+â”Š  â”Š42â”Šexport default Recipient\n```\n\n##### Changed entity&#x2F;user.ts\n```diff\n@@ -1,6 +1,7 @@\n â”Š1â”Š1â”Šimport { Entity, Column, PrimaryGeneratedColumn, ManyToMany, OneToMany } from 'typeorm'\n â”Š2â”Š2â”Šimport Chat from './chat'\n â”Š3â”Š3â”Šimport Message from './message'\n+â”Š â”Š4â”Šimport Recipient from './recipient'\n â”Š4â”Š5â”Š\n â”Š5â”Š6â”Šinterface UserConstructor {\n â”Š6â”Š7â”Š  username?: string\n```\n```diff\n@@ -41,6 +42,9 @@\n â”Š41â”Š42â”Š  @OneToMany(type => Message, message => message.sender)\n â”Š42â”Š43â”Š  senderMessages: Message[]\n â”Š43â”Š44â”Š\n+â”Š  â”Š45â”Š  @OneToMany(type => Recipient, recipient => recipient.user)\n+â”Š  â”Š46â”Š  recipients: Recipient[]\n+â”Š  â”Š47â”Š\n â”Š44â”Š48â”Š  constructor({ username, password, name, picture }: UserConstructor = {}) {\n â”Š45â”Š49â”Š    if (username) {\n â”Š46â”Š50â”Š      this.username = username\n```\n\n##### Changed modules&#x2F;app.module.ts\n```diff\n@@ -4,6 +4,7 @@\n â”Š 4â”Š 4â”Šimport { AuthModule } from './auth'\n â”Š 5â”Š 5â”Šimport { UserModule } from './user'\n â”Š 6â”Š 6â”Šimport { ChatModule } from './chat'\n+â”Š  â”Š 7â”Šimport { RecipientModule } from './recipient'\n â”Š 7â”Š 8â”Šimport { MessageModule } from './message'\n â”Š 8â”Š 9â”Š\n â”Š 9â”Š10â”Šexport interface IAppModuleConfig {\n```\n```diff\n@@ -21,6 +22,7 @@\n â”Š21â”Š22â”Š    UserModule,\n â”Š22â”Š23â”Š    ChatModule,\n â”Š23â”Š24â”Š    MessageModule,\n+â”Š  â”Š25â”Š    RecipientModule,\n â”Š24â”Š26â”Š  ],\n â”Š25â”Š27â”Š  configRequired: true,\n â”Š26â”Š28â”Š})\n```\n\n##### Added modules&#x2F;recipient&#x2F;index.ts\n```diff\n@@ -0,0 +1,22 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n+â”Š  â”Š 2â”Šimport { loadResolversFiles, loadSchemaFiles } from '@graphql-modules/sonar';\n+â”Š  â”Š 3â”Šimport { UserModule } from '../user';\n+â”Š  â”Š 4â”Šimport { MessageModule } from '../message';\n+â”Š  â”Š 5â”Šimport { ChatModule } from '../chat';\n+â”Š  â”Š 6â”Šimport { RecipientProvider } from './providers/recipient.provider';\n+â”Š  â”Š 7â”Šimport { AuthModule } from '../auth';\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Šexport const RecipientModule = new GraphQLModule({\n+â”Š  â”Š10â”Š  name: 'Recipient',\n+â”Š  â”Š11â”Š  imports: [\n+â”Š  â”Š12â”Š    AuthModule,\n+â”Š  â”Š13â”Š    UserModule,\n+â”Š  â”Š14â”Š    ChatModule,\n+â”Š  â”Š15â”Š    MessageModule,\n+â”Š  â”Š16â”Š  ],\n+â”Š  â”Š17â”Š  providers: [\n+â”Š  â”Š18â”Š    RecipientProvider,\n+â”Š  â”Š19â”Š  ],\n+â”Š  â”Š20â”Š  typeDefs: loadSchemaFiles(__dirname + '/schema/'),\n+â”Š  â”Š21â”Š  resolvers: loadResolversFiles(__dirname + '/resolvers/'),\n+â”Š  â”Š22â”Š});\n```\n\n##### Added modules&#x2F;recipient&#x2F;providers&#x2F;recipient.provider.ts\n```diff\n@@ -0,0 +1,123 @@\n+â”Š   â”Š  1â”Šimport { Injectable, ProviderScope } from '@graphql-modules/di'\n+â”Š   â”Š  2â”Šimport { Connection } from 'typeorm'\n+â”Š   â”Š  3â”Šimport { MessageProvider } from '../../message/providers/message.provider'\n+â”Š   â”Š  4â”Šimport { Chat } from '../../../entity/chat'\n+â”Š   â”Š  5â”Šimport { Message } from '../../../entity/message'\n+â”Š   â”Š  6â”Šimport { Recipient } from '../../../entity/recipient'\n+â”Š   â”Š  7â”Šimport { AuthProvider } from '../../auth/providers/auth.provider'\n+â”Š   â”Š  8â”Š\n+â”Š   â”Š  9â”Š@Injectable({\n+â”Š   â”Š 10â”Š  scope: ProviderScope.Session,\n+â”Š   â”Š 11â”Š})\n+â”Š   â”Š 12â”Šexport class RecipientProvider {\n+â”Š   â”Š 13â”Š  constructor(\n+â”Š   â”Š 14â”Š    private authProvider: AuthProvider,\n+â”Š   â”Š 15â”Š    private connection: Connection,\n+â”Š   â”Š 16â”Š    private messageProvider: MessageProvider\n+â”Š   â”Š 17â”Š  ) {}\n+â”Š   â”Š 18â”Š\n+â”Š   â”Š 19â”Š  public repository = this.connection.getRepository(Recipient)\n+â”Š   â”Š 20â”Š  public currentUser = this.authProvider.currentUser\n+â”Š   â”Š 21â”Š\n+â”Š   â”Š 22â”Š  createQueryBuilder() {\n+â”Š   â”Š 23â”Š    return this.connection.createQueryBuilder(Recipient, 'recipient')\n+â”Š   â”Š 24â”Š  }\n+â”Š   â”Š 25â”Š\n+â”Š   â”Š 26â”Š  getChatUnreadMessagesCount(chat: Chat) {\n+â”Š   â”Š 27â”Š    return this.messageProvider\n+â”Š   â”Š 28â”Š      .createQueryBuilder()\n+â”Š   â”Š 29â”Š      .innerJoin('message.chat', 'chat', 'chat.id = :chatId', { chatId: chat.id })\n+â”Š   â”Š 30â”Š      .innerJoin(\n+â”Š   â”Š 31â”Š        'message.recipients',\n+â”Š   â”Š 32â”Š        'recipients',\n+â”Š   â”Š 33â”Š        'recipients.user.id = :userId AND recipients.readAt IS NULL',\n+â”Š   â”Š 34â”Š        {\n+â”Š   â”Š 35â”Š          userId: this.currentUser.id,\n+â”Š   â”Š 36â”Š        }\n+â”Š   â”Š 37â”Š      )\n+â”Š   â”Š 38â”Š      .getCount()\n+â”Š   â”Š 39â”Š  }\n+â”Š   â”Š 40â”Š\n+â”Š   â”Š 41â”Š  getMessageRecipients(message: Message) {\n+â”Š   â”Š 42â”Š    return this.createQueryBuilder()\n+â”Š   â”Š 43â”Š      .innerJoinAndSelect('recipient.message', 'message', 'message.id = :messageId', {\n+â”Š   â”Š 44â”Š        messageId: message.id,\n+â”Š   â”Š 45â”Š      })\n+â”Š   â”Š 46â”Š      .innerJoinAndSelect('recipient.user', 'user')\n+â”Š   â”Š 47â”Š      .getMany()\n+â”Š   â”Š 48â”Š  }\n+â”Š   â”Š 49â”Š\n+â”Š   â”Š 50â”Š  async getRecipientChat(recipient: Recipient) {\n+â”Š   â”Š 51â”Š    if (recipient.message.chat) {\n+â”Š   â”Š 52â”Š      return recipient.message.chat\n+â”Š   â”Š 53â”Š    }\n+â”Š   â”Š 54â”Š\n+â”Š   â”Š 55â”Š    return this.messageProvider.getMessageChat(recipient.message)\n+â”Š   â”Š 56â”Š  }\n+â”Š   â”Š 57â”Š\n+â”Š   â”Š 58â”Š  async removeChat(chatId: string) {\n+â”Š   â”Š 59â”Š    const messages = await this.messageProvider._removeChatGetMessages(chatId)\n+â”Š   â”Š 60â”Š\n+â”Š   â”Š 61â”Š    for (let message of messages) {\n+â”Š   â”Š 62â”Š      if (message.holders.length === 0) {\n+â”Š   â”Š 63â”Š        const recipients = await this.createQueryBuilder()\n+â”Š   â”Š 64â”Š          .innerJoinAndSelect('recipient.message', 'message', 'message.id = :messageId', {\n+â”Š   â”Š 65â”Š            messageId: message.id,\n+â”Š   â”Š 66â”Š          })\n+â”Š   â”Š 67â”Š          .innerJoinAndSelect('recipient.user', 'user')\n+â”Š   â”Š 68â”Š          .getMany()\n+â”Š   â”Š 69â”Š\n+â”Š   â”Š 70â”Š        for (let recipient of recipients) {\n+â”Š   â”Š 71â”Š          await this.repository.remove(recipient)\n+â”Š   â”Š 72â”Š        }\n+â”Š   â”Š 73â”Š      }\n+â”Š   â”Š 74â”Š    }\n+â”Š   â”Š 75â”Š\n+â”Š   â”Š 76â”Š    return await this.messageProvider.removeChat(chatId, messages)\n+â”Š   â”Š 77â”Š  }\n+â”Š   â”Š 78â”Š\n+â”Š   â”Š 79â”Š  async addMessage(chatId: string, content: string) {\n+â”Š   â”Š 80â”Š    const message = await this.messageProvider.addMessage(chatId, content)\n+â”Š   â”Š 81â”Š\n+â”Š   â”Š 82â”Š    for (let user of message.holders) {\n+â”Š   â”Š 83â”Š      if (user.id !== this.currentUser.id) {\n+â”Š   â”Š 84â”Š        await this.repository.save(new Recipient({ user, message }))\n+â”Š   â”Š 85â”Š      }\n+â”Š   â”Š 86â”Š    }\n+â”Š   â”Š 87â”Š\n+â”Š   â”Š 88â”Š    return message\n+â”Š   â”Š 89â”Š  }\n+â”Š   â”Š 90â”Š\n+â”Š   â”Š 91â”Š  async removeMessages(\n+â”Š   â”Š 92â”Š    chatId: string,\n+â”Š   â”Š 93â”Š    {\n+â”Š   â”Š 94â”Š      messageIds,\n+â”Š   â”Š 95â”Š      all,\n+â”Š   â”Š 96â”Š    }: {\n+â”Š   â”Š 97â”Š      messageIds?: string[]\n+â”Š   â”Š 98â”Š      all?: boolean\n+â”Š   â”Š 99â”Š    } = {}\n+â”Š   â”Š100â”Š  ) {\n+â”Š   â”Š101â”Š    const { deletedIds, removedMessages } = await this.messageProvider._removeMessages(chatId, {\n+â”Š   â”Š102â”Š      messageIds,\n+â”Š   â”Š103â”Š      all,\n+â”Š   â”Š104â”Š    })\n+â”Š   â”Š105â”Š\n+â”Š   â”Š106â”Š    for (let message of removedMessages) {\n+â”Š   â”Š107â”Š      const recipients = await this.createQueryBuilder()\n+â”Š   â”Š108â”Š        .innerJoinAndSelect('recipient.message', 'message', 'message.id = :messageId', {\n+â”Š   â”Š109â”Š          messageId: message.id,\n+â”Š   â”Š110â”Š        })\n+â”Š   â”Š111â”Š        .innerJoinAndSelect('recipient.user', 'user')\n+â”Š   â”Š112â”Š        .getMany()\n+â”Š   â”Š113â”Š\n+â”Š   â”Š114â”Š      for (let recipient of recipients) {\n+â”Š   â”Š115â”Š        await this.repository.remove(recipient)\n+â”Š   â”Š116â”Š      }\n+â”Š   â”Š117â”Š\n+â”Š   â”Š118â”Š      await this.messageProvider.repository.remove(message)\n+â”Š   â”Š119â”Š    }\n+â”Š   â”Š120â”Š\n+â”Š   â”Š121â”Š    return deletedIds\n+â”Š   â”Š122â”Š  }\n+â”Š   â”Š123â”Š}\n```\n\n##### Added modules&#x2F;recipient&#x2F;resolvers&#x2F;resolvers.ts\n```diff\n@@ -0,0 +1,35 @@\n+â”Š  â”Š 1â”Šimport { IResolvers } from '../../../types'\n+â”Š  â”Š 2â”Šimport { RecipientProvider } from '../providers/recipient.provider'\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šexport default {\n+â”Š  â”Š 5â”Š  Mutation: {\n+â”Š  â”Š 6â”Š    // TODO: implement me\n+â”Š  â”Š 7â”Š    markAsReceived: async (obj, { chatId }) => false,\n+â”Š  â”Š 8â”Š    // TODO: implement me\n+â”Š  â”Š 9â”Š    markAsRead: async (obj, { chatId }) => false,\n+â”Š  â”Š10â”Š    // We may also need to remove the recipients\n+â”Š  â”Š11â”Š    removeChat: async (obj, { chatId }, { injector }) =>\n+â”Š  â”Š12â”Š      injector.get(RecipientProvider).removeChat(chatId),\n+â”Š  â”Š13â”Š    // We also need to create the recipients\n+â”Š  â”Š14â”Š    addMessage: async (obj, { chatId, content }, { injector }) =>\n+â”Š  â”Š15â”Š      injector.get(RecipientProvider).addMessage(chatId, content),\n+â”Š  â”Š16â”Š    // We may also need to remove the recipients\n+â”Š  â”Š17â”Š    removeMessages: async (obj, { chatId, messageIds, all }, { injector }) =>\n+â”Š  â”Š18â”Š      injector.get(RecipientProvider).removeMessages(chatId, {\n+â”Š  â”Š19â”Š        messageIds: messageIds || undefined,\n+â”Š  â”Š20â”Š        all: all || false,\n+â”Š  â”Š21â”Š      }),\n+â”Š  â”Š22â”Š  },\n+â”Š  â”Š23â”Š  Chat: {\n+â”Š  â”Š24â”Š    unreadMessages: async (chat, args, { injector }) =>\n+â”Š  â”Š25â”Š      injector.get(RecipientProvider).getChatUnreadMessagesCount(chat),\n+â”Š  â”Š26â”Š  },\n+â”Š  â”Š27â”Š  Message: {\n+â”Š  â”Š28â”Š    recipients: async (message, args, { injector }) =>\n+â”Š  â”Š29â”Š      injector.get(RecipientProvider).getMessageRecipients(message),\n+â”Š  â”Š30â”Š  },\n+â”Š  â”Š31â”Š  Recipient: {\n+â”Š  â”Š32â”Š    chat: async (recipient, args, { injector }) =>\n+â”Š  â”Š33â”Š      injector.get(RecipientProvider).getRecipientChat(recipient),\n+â”Š  â”Š34â”Š  },\n+â”Š  â”Š35â”Š} as IResolvers\n```\n\n##### Added modules&#x2F;recipient&#x2F;schema&#x2F;typeDefs.graphql\n```diff\n@@ -0,0 +1,22 @@\n+â”Š  â”Š 1â”Šextend type Chat {\n+â”Š  â”Š 2â”Š  #Computed property\n+â”Š  â”Š 3â”Š  unreadMessages: Int!\n+â”Š  â”Š 4â”Š}\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šextend type Message {\n+â”Š  â”Š 7â”Š  #Whoever received the message\n+â”Š  â”Š 8â”Š  recipients: [Recipient!]!\n+â”Š  â”Š 9â”Š}\n+â”Š  â”Š10â”Š\n+â”Š  â”Š11â”Štype Recipient {\n+â”Š  â”Š12â”Š  user: User!\n+â”Š  â”Š13â”Š  message: Message!\n+â”Š  â”Š14â”Š  chat: Chat!\n+â”Š  â”Š15â”Š  receivedAt: Date\n+â”Š  â”Š16â”Š  readAt: Date\n+â”Š  â”Š17â”Š}\n+â”Š  â”Š18â”Š\n+â”Š  â”Š19â”Štype Mutation {\n+â”Š  â”Š20â”Š  markAsReceived(chatId: ID!): Boolean\n+â”Š  â”Š21â”Š  markAsRead(chatId: ID!): Boolean\n+â”Š  â”Š22â”Š}\n```\n\n[}]: #\n\nThe flow will require us to implement the following GraphQL operations:\n\n- `users` query - Will be used to create a chat by picking a user from the users list.\n- `addMessage` mutation\n- `addChat` mutation\n- `removeChat` mutation\n\nAccordingly we will define the operations in our schema and implement their resolvers:\n\n[{]: <helper> (diffStep 3.2 module=\"server\")\n\n#### [Step 3.2: Implement mutations for chat app](https://github.com/Urigo/WhatsApp-Clone-Server/commit/7550441)\n\n##### Changed modules&#x2F;chat&#x2F;providers&#x2F;chat.provider.ts\n```diff\n@@ -38,6 +38,63 @@\n â”Š 38â”Š 38â”Š    return chat || null\n â”Š 39â”Š 39â”Š  }\n â”Š 40â”Š 40â”Š\n+â”Š   â”Š 41â”Š  async addChat(userId: string) {\n+â”Š   â”Š 42â”Š    const user = await this.userProvider\n+â”Š   â”Š 43â”Š      .createQueryBuilder()\n+â”Š   â”Š 44â”Š      .whereInIds(userId)\n+â”Š   â”Š 45â”Š      .getOne();\n+â”Š   â”Š 46â”Š\n+â”Š   â”Š 47â”Š    if (!user) {\n+â”Š   â”Š 48â”Š      throw new Error(`User ${userId} doesn't exist.`);\n+â”Š   â”Š 49â”Š    }\n+â”Š   â”Š 50â”Š\n+â”Š   â”Š 51â”Š    let chat = await this\n+â”Š   â”Š 52â”Š      .createQueryBuilder()\n+â”Š   â”Š 53â”Š      .where('chat.name IS NULL')\n+â”Š   â”Š 54â”Š      .innerJoin('chat.allTimeMembers', 'allTimeMembers1', 'allTimeMembers1.id = :currentUserId', {\n+â”Š   â”Š 55â”Š        currentUserId: this.currentUser.id,\n+â”Š   â”Š 56â”Š      })\n+â”Š   â”Š 57â”Š      .innerJoin('chat.allTimeMembers', 'allTimeMembers2', 'allTimeMembers2.id = :userId', {\n+â”Š   â”Š 58â”Š        userId: userId,\n+â”Š   â”Š 59â”Š      })\n+â”Š   â”Š 60â”Š      .innerJoinAndSelect('chat.listingMembers', 'listingMembers')\n+â”Š   â”Š 61â”Š      .getOne();\n+â”Š   â”Š 62â”Š\n+â”Š   â”Š 63â”Š    if (chat) {\n+â”Š   â”Š 64â”Š      // Chat already exists. Both users are already in the userIds array\n+â”Š   â”Š 65â”Š      const listingMembers = await this.userProvider\n+â”Š   â”Š 66â”Š        .createQueryBuilder()\n+â”Š   â”Š 67â”Š        .innerJoin(\n+â”Š   â”Š 68â”Š          'user.listingMemberChats',\n+â”Š   â”Š 69â”Š          'listingMemberChats',\n+â”Š   â”Š 70â”Š          'listingMemberChats.id = :chatId',\n+â”Š   â”Š 71â”Š          { chatId: chat.id },\n+â”Š   â”Š 72â”Š        )\n+â”Š   â”Š 73â”Š        .getMany();\n+â”Š   â”Š 74â”Š\n+â”Š   â”Š 75â”Š      if (!listingMembers.find(user => user.id === this.currentUser.id)) {\n+â”Š   â”Š 76â”Š        // The chat isn't listed for the current user. Add him to the memberIds\n+â”Š   â”Š 77â”Š        chat.listingMembers.push(this.currentUser);\n+â”Š   â”Š 78â”Š        chat = await this.repository.save(chat);\n+â”Š   â”Š 79â”Š\n+â”Š   â”Š 80â”Š        return chat || null;\n+â”Š   â”Š 81â”Š      } else {\n+â”Š   â”Š 82â”Š        return chat;\n+â”Š   â”Š 83â”Š      }\n+â”Š   â”Š 84â”Š    } else {\n+â”Š   â”Š 85â”Š      // Create the chat\n+â”Š   â”Š 86â”Š      chat = await this.repository.save(\n+â”Š   â”Š 87â”Š        new Chat({\n+â”Š   â”Š 88â”Š          allTimeMembers: [this.currentUser, user],\n+â”Š   â”Š 89â”Š          // Chat will not be listed to the other user until the first message gets written\n+â”Š   â”Š 90â”Š          listingMembers: [this.currentUser],\n+â”Š   â”Š 91â”Š        }),\n+â”Š   â”Š 92â”Š      );\n+â”Š   â”Š 93â”Š\n+â”Š   â”Š 94â”Š      return chat || null;\n+â”Š   â”Š 95â”Š    }\n+â”Š   â”Š 96â”Š  }\n+â”Š   â”Š 97â”Š\n â”Š 41â”Š 98â”Š  async getChatName(chat: Chat) {\n â”Š 42â”Š 99â”Š    if (chat.name) {\n â”Š 43â”Š100â”Š      return chat.name\n```\n```diff\n@@ -159,4 +216,55 @@\n â”Š159â”Š216â”Š\n â”Š160â”Š217â”Š    return this.currentUser\n â”Š161â”Š218â”Š  }\n+â”Š   â”Š219â”Š\n+â”Š   â”Š220â”Š  async removeChat(chatId: string) {\n+â”Š   â”Š221â”Š    const chat = await this.createQueryBuilder()\n+â”Š   â”Š222â”Š      .whereInIds(Number(chatId))\n+â”Š   â”Š223â”Š      .innerJoinAndSelect('chat.listingMembers', 'listingMembers')\n+â”Š   â”Š224â”Š      .leftJoinAndSelect('chat.owner', 'owner')\n+â”Š   â”Š225â”Š      .getOne();\n+â”Š   â”Š226â”Š\n+â”Š   â”Š227â”Š    if (!chat) {\n+â”Š   â”Š228â”Š      throw new Error(`The chat ${chatId} doesn't exist.`)\n+â”Š   â”Š229â”Š    }\n+â”Š   â”Š230â”Š\n+â”Š   â”Š231â”Š    if (!chat.name) {\n+â”Š   â”Š232â”Š      // Chat\n+â”Š   â”Š233â”Š      if (!chat.listingMembers.find(user => user.id === this.currentUser.id)) {\n+â”Š   â”Š234â”Š        throw new Error(`The user is not a listing member of the chat ${chatId}.`)\n+â”Š   â”Š235â”Š      }\n+â”Š   â”Š236â”Š\n+â”Š   â”Š237â”Š      // Remove the current user from who gets the chat listed. The chat will no longer appear in his list\n+â”Š   â”Š238â”Š      chat.listingMembers = chat.listingMembers.filter(user => user.id !== this.currentUser.id);\n+â”Š   â”Š239â”Š\n+â”Š   â”Š240â”Š      // Check how many members are left\n+â”Š   â”Š241â”Š      if (chat.listingMembers.length === 0) {\n+â”Š   â”Š242â”Š        // Delete the chat\n+â”Š   â”Š243â”Š        await this.repository.remove(chat);\n+â”Š   â”Š244â”Š      } else {\n+â”Š   â”Š245â”Š        // Update the chat\n+â”Š   â”Š246â”Š        await this.repository.save(chat);\n+â”Š   â”Š247â”Š      }\n+â”Š   â”Š248â”Š\n+â”Š   â”Š249â”Š      return chatId;\n+â”Š   â”Š250â”Š    } else {\n+â”Š   â”Š251â”Š      // Group\n+â”Š   â”Š252â”Š\n+â”Š   â”Š253â”Š      // Remove the current user from who gets the group listed. The group will no longer appear in his list\n+â”Š   â”Š254â”Š      chat.listingMembers = chat.listingMembers.filter(user => user.id !== this.currentUser.id);\n+â”Š   â”Š255â”Š\n+â”Š   â”Š256â”Š      // Check how many members (including previous ones who can still access old messages) are left\n+â”Š   â”Š257â”Š      if (chat.listingMembers.length === 0) {\n+â”Š   â”Š258â”Š        // Remove the group\n+â”Š   â”Š259â”Š        await this.repository.remove(chat);\n+â”Š   â”Š260â”Š      } else {\n+â”Š   â”Š261â”Š        // TODO: Implement for group\n+â”Š   â”Š262â”Š        chat.owner = chat.listingMembers[0]\n+â”Š   â”Š263â”Š\n+â”Š   â”Š264â”Š        await this.repository.save(chat);\n+â”Š   â”Š265â”Š      }\n+â”Š   â”Š266â”Š\n+â”Š   â”Š267â”Š      return chatId;\n+â”Š   â”Š268â”Š    }\n+â”Š   â”Š269â”Š  }\n â”Š162â”Š270â”Š}\n```\n\n##### Changed modules&#x2F;chat&#x2F;resolvers&#x2F;resolvers.ts\n```diff\n@@ -14,6 +14,8 @@\n â”Š14â”Š14â”Š      name: name || '',\n â”Š15â”Š15â”Š      picture: picture || '',\n â”Š16â”Š16â”Š    }),\n+â”Š  â”Š17â”Š    addChat: (obj, { userId }, { injector }) => injector.get(ChatProvider).addChat(userId),\n+â”Š  â”Š18â”Š    removeChat: (obj, { chatId }, { injector }) => injector.get(ChatProvider).removeChat(chatId),\n â”Š17â”Š19â”Š  },\n â”Š18â”Š20â”Š  Subscription: {\n â”Š19â”Š21â”Š    chatUpdated: {\n```\n\n##### Changed modules&#x2F;chat&#x2F;schema&#x2F;typeDefs.graphql\n```diff\n@@ -21,3 +21,8 @@\n â”Š21â”Š21â”Š  #If null the group is read-only. Null for chats.\n â”Š22â”Š22â”Š  owner: User\n â”Š23â”Š23â”Š}\n+â”Š  â”Š24â”Š\n+â”Š  â”Š25â”Štype Mutation {\n+â”Š  â”Š26â”Š  addChat(userId: ID!): Chat\n+â”Š  â”Š27â”Š  removeChat(chatId: ID!): ID\n+â”Š  â”Š28â”Š}\n```\n\n##### Changed modules&#x2F;message&#x2F;providers&#x2F;message.provider.ts\n```diff\n@@ -1,4 +1,5 @@\n â”Š1â”Š1â”Šimport { Injectable } from '@graphql-modules/di'\n+â”Š â”Š2â”Šimport { PubSub } from 'apollo-server-express'\n â”Š2â”Š3â”Šimport { Connection } from 'typeorm'\n â”Š3â”Š4â”Šimport { MessageType } from '../../../db'\n â”Š4â”Š5â”Šimport { Chat } from '../../../entity/chat'\n```\n```diff\n@@ -11,6 +12,7 @@\n â”Š11â”Š12â”Š@Injectable()\n â”Š12â”Š13â”Šexport class MessageProvider {\n â”Š13â”Š14â”Š  constructor(\n+â”Š  â”Š15â”Š    private pubsub: PubSub,\n â”Š14â”Š16â”Š    private connection: Connection,\n â”Š15â”Š17â”Š    private chatProvider: ChatProvider,\n â”Š16â”Š18â”Š    private authProvider: AuthProvider,\n```\n```diff\n@@ -24,6 +26,182 @@\n â”Š 24â”Š 26â”Š    return this.connection.createQueryBuilder(Message, 'message')\n â”Š 25â”Š 27â”Š  }\n â”Š 26â”Š 28â”Š\n+â”Š   â”Š 29â”Š  async addMessage(chatId: string, content: string) {\n+â”Š   â”Š 30â”Š    if (content === null || content === '') {\n+â”Š   â”Š 31â”Š      throw new Error(`Cannot add empty or null messages.`);\n+â”Š   â”Š 32â”Š    }\n+â”Š   â”Š 33â”Š\n+â”Š   â”Š 34â”Š    let chat = await this.chatProvider\n+â”Š   â”Š 35â”Š      .createQueryBuilder()\n+â”Š   â”Š 36â”Š      .whereInIds(chatId)\n+â”Š   â”Š 37â”Š      .innerJoinAndSelect('chat.allTimeMembers', 'allTimeMembers')\n+â”Š   â”Š 38â”Š      .innerJoinAndSelect('chat.listingMembers', 'listingMembers')\n+â”Š   â”Š 39â”Š      .getOne();\n+â”Š   â”Š 40â”Š\n+â”Š   â”Š 41â”Š    if (!chat) {\n+â”Š   â”Š 42â”Š      throw new Error(`Cannot find chat ${chatId}.`);\n+â”Š   â”Š 43â”Š    }\n+â”Š   â”Š 44â”Š\n+â”Š   â”Š 45â”Š    let holders: User[];\n+â”Š   â”Š 46â”Š\n+â”Š   â”Š 47â”Š    if (!chat.name) {\n+â”Š   â”Š 48â”Š      // Chat\n+â”Š   â”Š 49â”Š      if (!chat.listingMembers.map(user => user.id).includes(this.currentUser.id)) {\n+â”Š   â”Š 50â”Š        throw new Error(`The chat ${chatId} must be listed for the current user in order to add a message.`);\n+â”Š   â”Š 51â”Š      }\n+â”Š   â”Š 52â”Š\n+â”Š   â”Š 53â”Š      // Receiver's user\n+â”Š   â”Š 54â”Š      const user = chat.allTimeMembers.find(user => user.id !== this.currentUser.id);\n+â”Š   â”Š 55â”Š\n+â”Š   â”Š 56â”Š      if (!user) {\n+â”Š   â”Š 57â”Š        throw new Error(`Cannot find receiver's user.`);\n+â”Š   â”Š 58â”Š      }\n+â”Š   â”Š 59â”Š\n+â”Š   â”Š 60â”Š      if (!chat.listingMembers.find(listingMember => listingMember.id === user.id)) {\n+â”Š   â”Š 61â”Š        // Chat is not listed for the receiver user. Add him to the listingIds\n+â”Š   â”Š 62â”Š        chat.listingMembers.push(user);\n+â”Š   â”Š 63â”Š\n+â”Š   â”Š 64â”Š        await this.chatProvider.repository.save(chat);\n+â”Š   â”Š 65â”Š      }\n+â”Š   â”Š 66â”Š\n+â”Š   â”Š 67â”Š      holders = chat.listingMembers;\n+â”Š   â”Š 68â”Š    } else {\n+â”Š   â”Š 69â”Š      // TODO: Implement for groups\n+â”Š   â”Š 70â”Š      holders = chat.listingMembers\n+â”Š   â”Š 71â”Š    }\n+â”Š   â”Š 72â”Š\n+â”Š   â”Š 73â”Š    const message = await this.repository.save(new Message({\n+â”Š   â”Š 74â”Š      chat,\n+â”Š   â”Š 75â”Š      sender: this.currentUser,\n+â”Š   â”Š 76â”Š      content,\n+â”Š   â”Š 77â”Š      type: MessageType.TEXT,\n+â”Š   â”Š 78â”Š      holders,\n+â”Š   â”Š 79â”Š    }));\n+â”Š   â”Š 80â”Š\n+â”Š   â”Š 81â”Š    this.pubsub.publish('messageAdded', {\n+â”Š   â”Š 82â”Š      messageAdded: message,\n+â”Š   â”Š 83â”Š    });\n+â”Š   â”Š 84â”Š\n+â”Š   â”Š 85â”Š    return message || null;\n+â”Š   â”Š 86â”Š  }\n+â”Š   â”Š 87â”Š\n+â”Š   â”Š 88â”Š  async _removeMessages(\n+â”Š   â”Š 89â”Š\n+â”Š   â”Š 90â”Š    chatId: string,\n+â”Š   â”Š 91â”Š    {\n+â”Š   â”Š 92â”Š      messageIds,\n+â”Š   â”Š 93â”Š      all,\n+â”Š   â”Š 94â”Š    }: {\n+â”Š   â”Š 95â”Š      messageIds?: string[]\n+â”Š   â”Š 96â”Š      all?: boolean\n+â”Š   â”Š 97â”Š    } = {},\n+â”Š   â”Š 98â”Š  ) {\n+â”Š   â”Š 99â”Š    const chat = await this.chatProvider\n+â”Š   â”Š100â”Š      .createQueryBuilder()\n+â”Š   â”Š101â”Š      .whereInIds(chatId)\n+â”Š   â”Š102â”Š      .innerJoinAndSelect('chat.listingMembers', 'listingMembers')\n+â”Š   â”Š103â”Š      .innerJoinAndSelect('chat.messages', 'messages')\n+â”Š   â”Š104â”Š      .innerJoinAndSelect('messages.holders', 'holders')\n+â”Š   â”Š105â”Š      .getOne();\n+â”Š   â”Š106â”Š\n+â”Š   â”Š107â”Š    if (!chat) {\n+â”Š   â”Š108â”Š      throw new Error(`Cannot find chat ${chatId}.`);\n+â”Š   â”Š109â”Š    }\n+â”Š   â”Š110â”Š\n+â”Š   â”Š111â”Š    if (!chat.listingMembers.find(user => user.id === this.currentUser.id)) {\n+â”Š   â”Š112â”Š      throw new Error(`The chat/group ${chatId} is not listed for the current user so there is nothing to delete.`);\n+â”Š   â”Š113â”Š    }\n+â”Š   â”Š114â”Š\n+â”Š   â”Š115â”Š    if (all && messageIds) {\n+â”Š   â”Š116â”Š      throw new Error(`Cannot specify both 'all' and 'messageIds'.`)\n+â”Š   â”Š117â”Š    }\n+â”Š   â”Š118â”Š\n+â”Š   â”Š119â”Š    if (!all && !(messageIds && messageIds.length)) {\n+â”Š   â”Š120â”Š      throw new Error(`'all' and 'messageIds' cannot be both null`)\n+â”Š   â”Š121â”Š    }\n+â”Š   â”Š122â”Š\n+â”Š   â”Š123â”Š    let deletedIds: string[] = [];\n+â”Š   â”Š124â”Š    let removedMessages: Message[] = [];\n+â”Š   â”Š125â”Š    // Instead of chaining map and filter we can loop once using reduce\n+â”Š   â”Š126â”Š    chat.messages = await chat.messages.reduce<Promise<Message[]>>(async (filtered$, message) => {\n+â”Š   â”Š127â”Š      const filtered = await filtered$;\n+â”Š   â”Š128â”Š\n+â”Š   â”Š129â”Š      if (all || messageIds!.includes(message.id)) {\n+â”Š   â”Š130â”Š        deletedIds.push(message.id);\n+â”Š   â”Š131â”Š        // Remove the current user from the message holders\n+â”Š   â”Š132â”Š        message.holders = message.holders.filter(user => user.id !== this.currentUser.id);\n+â”Š   â”Š133â”Š\n+â”Š   â”Š134â”Š      }\n+â”Š   â”Š135â”Š\n+â”Š   â”Š136â”Š      if (message.holders.length !== 0) {\n+â”Š   â”Š137â”Š        // Remove the current user from the message holders\n+â”Š   â”Š138â”Š        await this.repository.save(message);\n+â”Š   â”Š139â”Š        filtered.push(message);\n+â”Š   â”Š140â”Š      } else {\n+â”Š   â”Š141â”Š        // Message is flagged for removal\n+â”Š   â”Š142â”Š        removedMessages.push(message);\n+â”Š   â”Š143â”Š      }\n+â”Š   â”Š144â”Š\n+â”Š   â”Š145â”Š      return filtered;\n+â”Š   â”Š146â”Š    }, Promise.resolve([]));\n+â”Š   â”Š147â”Š\n+â”Š   â”Š148â”Š    return { deletedIds, removedMessages };\n+â”Š   â”Š149â”Š  }\n+â”Š   â”Š150â”Š\n+â”Š   â”Š151â”Š  async removeMessages(\n+â”Š   â”Š152â”Š\n+â”Š   â”Š153â”Š    chatId: string,\n+â”Š   â”Š154â”Š    {\n+â”Š   â”Š155â”Š      messageIds,\n+â”Š   â”Š156â”Š      all,\n+â”Š   â”Š157â”Š    }: {\n+â”Š   â”Š158â”Š      messageIds?: string[]\n+â”Š   â”Š159â”Š      all?: boolean\n+â”Š   â”Š160â”Š    } = {},\n+â”Š   â”Š161â”Š  ) {\n+â”Š   â”Š162â”Š    const { deletedIds, removedMessages } = await this._removeMessages(chatId, { messageIds, all });\n+â”Š   â”Š163â”Š\n+â”Š   â”Š164â”Š    for (let message of removedMessages) {\n+â”Š   â”Š165â”Š      await this.repository.remove(message);\n+â”Š   â”Š166â”Š    }\n+â”Š   â”Š167â”Š\n+â”Š   â”Š168â”Š    return deletedIds;\n+â”Š   â”Š169â”Š  }\n+â”Š   â”Š170â”Š\n+â”Š   â”Š171â”Š  async _removeChatGetMessages(chatId: string) {\n+â”Š   â”Š172â”Š    let messages = await this.createQueryBuilder()\n+â”Š   â”Š173â”Š      .innerJoin('message.chat', 'chat', 'chat.id = :chatId', { chatId })\n+â”Š   â”Š174â”Š      .leftJoinAndSelect('message.holders', 'holders')\n+â”Š   â”Š175â”Š      .getMany();\n+â”Š   â”Š176â”Š\n+â”Š   â”Š177â”Š    messages = messages.map(message => ({\n+â”Š   â”Š178â”Š      ...message,\n+â”Š   â”Š179â”Š      holders: message.holders.filter(user => user.id !== this.currentUser.id),\n+â”Š   â”Š180â”Š    }));\n+â”Š   â”Š181â”Š\n+â”Š   â”Š182â”Š    return messages;\n+â”Š   â”Š183â”Š  }\n+â”Š   â”Š184â”Š\n+â”Š   â”Š185â”Š  async removeChat(chatId: string, messages?: Message[]) {\n+â”Š   â”Š186â”Š    if (!messages) {\n+â”Š   â”Š187â”Š      messages = await this._removeChatGetMessages(chatId);\n+â”Š   â”Š188â”Š    }\n+â”Š   â”Š189â”Š\n+â”Š   â”Š190â”Š    for (let message of messages) {\n+â”Š   â”Š191â”Š      message.holders = message.holders.filter(user => user.id !== this.currentUser.id);\n+â”Š   â”Š192â”Š\n+â”Š   â”Š193â”Š      if (message.holders.length !== 0) {\n+â”Š   â”Š194â”Š        // Remove the current user from the message holders\n+â”Š   â”Š195â”Š        await this.repository.save(message);\n+â”Š   â”Š196â”Š      } else {\n+â”Š   â”Š197â”Š        // Simply remove the message\n+â”Š   â”Š198â”Š        await this.repository.remove(message);\n+â”Š   â”Š199â”Š      }\n+â”Š   â”Š200â”Š    }\n+â”Š   â”Š201â”Š\n+â”Š   â”Š202â”Š    return await this.chatProvider.removeChat(chatId);\n+â”Š   â”Š203â”Š  }\n+â”Š   â”Š204â”Š\n â”Š 27â”Š205â”Š  async getMessageSender(message: Message) {\n â”Š 28â”Š206â”Š    const sender = await this.userProvider\n â”Š 29â”Š207â”Š      .createQueryBuilder()\n```\n\n##### Changed modules&#x2F;message&#x2F;resolvers&#x2F;resolvers.ts\n```diff\n@@ -8,6 +8,17 @@\n â”Š 8â”Š 8â”Š    // The ordering depends on the messages\n â”Š 9â”Š 9â”Š    chats: (obj, args, { injector }) => injector.get(MessageProvider).getChats(),\n â”Š10â”Š10â”Š  },\n+â”Š  â”Š11â”Š  Mutation: {\n+â”Š  â”Š12â”Š    addMessage: async (obj, { chatId, content }, { injector }) =>\n+â”Š  â”Š13â”Š      injector.get(MessageProvider).addMessage(chatId, content),\n+â”Š  â”Š14â”Š    removeMessages: async (obj, { chatId, messageIds, all }, { injector }) =>\n+â”Š  â”Š15â”Š      injector.get(MessageProvider).removeMessages(chatId, {\n+â”Š  â”Š16â”Š        messageIds: messageIds || undefined,\n+â”Š  â”Š17â”Š        all: all || false,\n+â”Š  â”Š18â”Š      }),\n+â”Š  â”Š19â”Š    // We may need to also remove the messages\n+â”Š  â”Š20â”Š    removeChat: async (obj, { chatId }, { injector }) => injector.get(MessageProvider).removeChat(chatId),\n+â”Š  â”Š21â”Š  },\n â”Š11â”Š22â”Š  Chat: {\n â”Š12â”Š23â”Š    messages: async (chat, { amount }, { injector }) =>\n â”Š13â”Š24â”Š      injector.get(MessageProvider).getChatMessages(chat, amount || 0),\n```\n\n##### Changed modules&#x2F;message&#x2F;schema&#x2F;typeDefs.graphql\n```diff\n@@ -23,3 +23,8 @@\n â”Š23â”Š23â”Š  #Computed property\n â”Š24â”Š24â”Š  ownership: Boolean!\n â”Š25â”Š25â”Š}\n+â”Š  â”Š26â”Š\n+â”Š  â”Š27â”Štype Mutation {\n+â”Š  â”Š28â”Š  addMessage(chatId: ID!, content: String!): Message\n+â”Š  â”Š29â”Š  removeMessages(chatId: ID!, messageIds: [ID!], all: Boolean): [ID]!\n+â”Š  â”Š30â”Š}\n```\n\n[}]: #\n\nRemember that every change that happens in the back-end should trigger a subscription that will notify all the use regards that change. For the current flow, we should have the following subscriptions:\n\n- `messageAdded` subscription\n- `userAdded` subscription\n- `userUpdated` subscription - Since we will be able to create a new chat by picking from a users list, this list needs to be synced with the most recent changes.\n\nLet's implement these subscriptions:\n\n[{]: <helper> (diffStep 3.3 module=\"server\")\n\n#### [Step 3.3: Add necessary subscriptions](https://github.com/Urigo/WhatsApp-Clone-Server/commit/e2ad65e)\n\n##### Changed modules&#x2F;chat&#x2F;resolvers&#x2F;resolvers.ts\n```diff\n@@ -18,6 +18,12 @@\n â”Š18â”Š18â”Š    removeChat: (obj, { chatId }, { injector }) => injector.get(ChatProvider).removeChat(chatId),\n â”Š19â”Š19â”Š  },\n â”Š20â”Š20â”Š  Subscription: {\n+â”Š  â”Š21â”Š    chatAdded: {\n+â”Š  â”Š22â”Š      subscribe: withFilter((root, args, { injector }: ModuleContext) => injector.get(PubSub).asyncIterator('chatAdded'),\n+â”Š  â”Š23â”Š        (data: { chatAdded: Chat, creatorId: string }, variables, { injector }: ModuleContext) =>\n+â”Š  â”Š24â”Š          data && injector.get(ChatProvider).filterChatAddedOrUpdated(data.chatAdded, data.creatorId)\n+â”Š  â”Š25â”Š      ),\n+â”Š  â”Š26â”Š    },\n â”Š21â”Š27â”Š    chatUpdated: {\n â”Š22â”Š28â”Š      subscribe: withFilter((root, args, { injector }: ModuleContext) => injector.get(PubSub).asyncIterator('chatUpdated'),\n â”Š23â”Š29â”Š        (data: { chatUpdated: Chat, updaterId: string }, variables, { injector }: ModuleContext) =>\n```\n\n##### Changed modules&#x2F;chat&#x2F;schema&#x2F;typeDefs.graphql\n```diff\n@@ -4,6 +4,7 @@\n â”Š 4â”Š 4â”Š}\n â”Š 5â”Š 5â”Š\n â”Š 6â”Š 6â”Štype Subscription {\n+â”Š  â”Š 7â”Š  chatAdded: Chat\n â”Š 7â”Š 8â”Š  chatUpdated: Chat\n â”Š 8â”Š 9â”Š}\n â”Š 9â”Š10â”Š\n```\n\n##### Changed modules&#x2F;message&#x2F;providers&#x2F;message.provider.ts\n```diff\n@@ -62,6 +62,11 @@\n â”Š62â”Š62â”Š        chat.listingMembers.push(user);\n â”Š63â”Š63â”Š\n â”Š64â”Š64â”Š        await this.chatProvider.repository.save(chat);\n+â”Š  â”Š65â”Š\n+â”Š  â”Š66â”Š        this.pubsub.publish('chatAdded', {\n+â”Š  â”Š67â”Š          creatorId: this.currentUser.id,\n+â”Š  â”Š68â”Š          chatAdded: chat,\n+â”Š  â”Š69â”Š        });\n â”Š65â”Š70â”Š      }\n â”Š66â”Š71â”Š\n â”Š67â”Š72â”Š      holders = chat.listingMembers;\n```\n```diff\n@@ -317,4 +322,18 @@\n â”Š317â”Š322â”Š\n â”Š318â”Š323â”Š    return latestMessage ? latestMessage.createdAt : null\n â”Š319â”Š324â”Š  }\n+â”Š   â”Š325â”Š\n+â”Š   â”Š326â”Š  async filterMessageAdded(messageAdded: Message) {\n+â”Š   â”Š327â”Š    const relevantUsers = (await this.userProvider\n+â”Š   â”Š328â”Š      .createQueryBuilder()\n+â”Š   â”Š329â”Š      .innerJoin(\n+â”Š   â”Š330â”Š        'user.listingMemberChats',\n+â”Š   â”Š331â”Š        'listingMemberChats',\n+â”Š   â”Š332â”Š        'listingMemberChats.id = :chatId',\n+â”Š   â”Š333â”Š        { chatId: messageAdded.chat.id }\n+â”Š   â”Š334â”Š      )\n+â”Š   â”Š335â”Š      .getMany()).filter(user => user.id != messageAdded.sender.id)\n+â”Š   â”Š336â”Š\n+â”Š   â”Š337â”Š    return relevantUsers.some(user => user.id === this.currentUser.id)\n+â”Š   â”Š338â”Š  }\n â”Š320â”Š339â”Š}\n```\n\n##### Changed modules&#x2F;message&#x2F;resolvers&#x2F;resolvers.ts\n```diff\n@@ -1,4 +1,5 @@\n â”Š1â”Š1â”Šimport { ModuleContext } from '@graphql-modules/core'\n+â”Š â”Š2â”Šimport { PubSub, withFilter } from 'apollo-server-express'\n â”Š2â”Š3â”Šimport { Message } from '../../../entity/message'\n â”Š3â”Š4â”Šimport { IResolvers } from '../../../types'\n â”Š4â”Š5â”Šimport { MessageProvider } from '../providers/message.provider'\n```\n```diff\n@@ -19,6 +20,13 @@\n â”Š19â”Š20â”Š    // We may need to also remove the messages\n â”Š20â”Š21â”Š    removeChat: async (obj, { chatId }, { injector }) => injector.get(MessageProvider).removeChat(chatId),\n â”Š21â”Š22â”Š  },\n+â”Š  â”Š23â”Š  Subscription: {\n+â”Š  â”Š24â”Š    messageAdded: {\n+â”Š  â”Š25â”Š      subscribe: withFilter((root, args, { injector }: ModuleContext) => injector.get(PubSub).asyncIterator('messageAdded'),\n+â”Š  â”Š26â”Š        (data: { messageAdded: Message }, variables, { injector }: ModuleContext) => data && injector.get(MessageProvider).filterMessageAdded(data.messageAdded)\n+â”Š  â”Š27â”Š      ),\n+â”Š  â”Š28â”Š    },\n+â”Š  â”Š29â”Š  },\n â”Š22â”Š30â”Š  Chat: {\n â”Š23â”Š31â”Š    messages: async (chat, { amount }, { injector }) =>\n â”Š24â”Š32â”Š      injector.get(MessageProvider).getChatMessages(chat, amount || 0),\n```\n\n##### Changed modules&#x2F;message&#x2F;schema&#x2F;typeDefs.graphql\n```diff\n@@ -1,3 +1,7 @@\n+â”Š â”Š1â”Štype Subscription {\n+â”Š â”Š2â”Š  messageAdded: Message\n+â”Š â”Š3â”Š}\n+â”Š â”Š4â”Š\n â”Š1â”Š5â”Šenum MessageType {\n â”Š2â”Š6â”Š  LOCATION\n â”Š3â”Š7â”Š  TEXT\n```\n\n##### Changed modules&#x2F;user&#x2F;providers&#x2F;user.provider.ts\n```diff\n@@ -1,4 +1,5 @@\n â”Š1â”Š1â”Šimport { Injectable, ProviderScope } from '@graphql-modules/di'\n+â”Š â”Š2â”Šimport { PubSub } from 'apollo-server-express'\n â”Š2â”Š3â”Šimport cloudinary from 'cloudinary'\n â”Š3â”Š4â”Šimport { Connection } from 'typeorm'\n â”Š4â”Š5â”Šimport { User } from '../../../entity/user'\n```\n```diff\n@@ -6,7 +7,11 @@\n â”Š 6â”Š 7â”Š\n â”Š 7â”Š 8â”Š@Injectable()\n â”Š 8â”Š 9â”Šexport class UserProvider {\n-â”Š 9â”Š  â”Š  constructor(private connection: Connection, private authProvider: AuthProvider) {}\n+â”Š  â”Š10â”Š  constructor(\n+â”Š  â”Š11â”Š    private pubsub: PubSub,\n+â”Š  â”Š12â”Š    private connection: Connection,\n+â”Š  â”Š13â”Š    private authProvider: AuthProvider,\n+â”Š  â”Š14â”Š  ) {}\n â”Š10â”Š15â”Š\n â”Š11â”Š16â”Š  public repository = this.connection.getRepository(User)\n â”Š12â”Š17â”Š  private currentUser = this.authProvider.currentUser\n```\n```diff\n@@ -41,9 +46,17 @@\n â”Š41â”Š46â”Š\n â”Š42â”Š47â”Š    await this.repository.save(this.currentUser);\n â”Š43â”Š48â”Š\n+â”Š  â”Š49â”Š    this.pubsub.publish('userUpdated', {\n+â”Š  â”Š50â”Š      userUpdated: this.currentUser,\n+â”Š  â”Š51â”Š    });\n+â”Š  â”Š52â”Š\n â”Š44â”Š53â”Š    return this.currentUser;\n â”Š45â”Š54â”Š  }\n â”Š46â”Š55â”Š\n+â”Š  â”Š56â”Š  filterUserAddedOrUpdated(userAddedOrUpdated: User) {\n+â”Š  â”Š57â”Š    return userAddedOrUpdated.id !== this.currentUser.id;\n+â”Š  â”Š58â”Š  }\n+â”Š  â”Š59â”Š\n â”Š47â”Š60â”Š  uploadProfilePic(filePath: string) {\n â”Š48â”Š61â”Š    return new Promise((resolve, reject) => {\n â”Š49â”Š62â”Š      cloudinary.v2.uploader.upload(filePath, (error, result) => {\n```\n\n##### Changed modules&#x2F;user&#x2F;resolvers&#x2F;resolvers.ts\n```diff\n@@ -1,4 +1,5 @@\n â”Š1â”Š1â”Šimport { ModuleContext } from '@graphql-modules/core'\n+â”Š â”Š2â”Šimport { PubSub, withFilter } from 'apollo-server-express'\n â”Š2â”Š3â”Šimport { User } from '../../../entity/User'\n â”Š3â”Š4â”Šimport { IResolvers } from '../../../types'\n â”Š4â”Š5â”Šimport { UserProvider } from '../providers/user.provider'\n```\n```diff\n@@ -14,4 +15,18 @@\n â”Š14â”Š15â”Š      picture: picture || '',\n â”Š15â”Š16â”Š    }),\n â”Š16â”Š17â”Š  },\n+â”Š  â”Š18â”Š  Subscription: {\n+â”Š  â”Š19â”Š    userAdded: {\n+â”Š  â”Š20â”Š      subscribe: withFilter(\n+â”Š  â”Š21â”Š        (root, args, { injector }: ModuleContext) => injector.get(PubSub).asyncIterator('userAdded'),\n+â”Š  â”Š22â”Š        (data: { userAdded: User }, variables, { injector }: ModuleContext) => data && injector.get(UserProvider).filterUserAddedOrUpdated(data.userAdded),\n+â”Š  â”Š23â”Š      ),\n+â”Š  â”Š24â”Š    },\n+â”Š  â”Š25â”Š    userUpdated: {\n+â”Š  â”Š26â”Š      subscribe: withFilter(\n+â”Š  â”Š27â”Š        (root, args, { injector }: ModuleContext) => injector.get(PubSub).asyncIterator('userAdded'),\n+â”Š  â”Š28â”Š        (data: { userUpdated: User }, variables, { injector }: ModuleContext) => data && injector.get(UserProvider).filterUserAddedOrUpdated(data.userUpdated)\n+â”Š  â”Š29â”Š      ),\n+â”Š  â”Š30â”Š    },\n+â”Š  â”Š31â”Š  },\n â”Š17â”Š32â”Š} as IResolvers\n```\n\n##### Changed modules&#x2F;user&#x2F;schema&#x2F;typeDefs.graphql\n```diff\n@@ -7,6 +7,11 @@\n â”Š 7â”Š 7â”Š  updateUser(name: String, picture: String): User!\n â”Š 8â”Š 8â”Š}\n â”Š 9â”Š 9â”Š\n+â”Š  â”Š10â”Štype Subscription {\n+â”Š  â”Š11â”Š  userAdded: User\n+â”Š  â”Š12â”Š  userUpdated: User\n+â”Š  â”Š13â”Š}\n+â”Š  â”Š14â”Š\n â”Š10â”Š15â”Štype User {\n â”Š11â”Š16â”Š  id: ID!\n â”Š12â”Š17â”Š  name: String\n```\n\n[}]: #\n\nNow that we have that ready, we will get back to the client and implement the necessary components. We will start with the chat room screen. The layout consists of the following component:\n\n- A navbar - Includes the name and a picture of the person we're chatting with, a \"back\" button to navigate back to the main screen, and a pop-over menu where we can remove the chat from.\n- A messages list - The list of messages that were sent and received in the chat. This will be a scrollable view where message bubbles are colored differently based on who they belong to. Just like WhatsApp!\n- A message box - The input that will be used to write the new message. This will include a \"send\" button right next to it.\n\nLet's implement the components\n\n[{]: <helper> (diffStep 3.1 files=\"src/components/ChatRoomScreen\" module=\"client\")\n\n#### [Step 3.1: Add chat room screen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/b2bc092)\n\n##### Added src&#x2F;components&#x2F;ChatRoomScreen&#x2F;ChatNavbar.tsx\n```diff\n@@ -0,0 +1,172 @@\n+â”Š   â”Š  1â”Šimport Button from '@material-ui/core/Button'\n+â”Š   â”Š  2â”Šimport List from '@material-ui/core/List'\n+â”Š   â”Š  3â”Šimport ListItem from '@material-ui/core/ListItem'\n+â”Š   â”Š  4â”Šimport Popover from '@material-ui/core/Popover'\n+â”Š   â”Š  5â”Šimport ArrowBackIcon from '@material-ui/icons/ArrowBack'\n+â”Š   â”Š  6â”Šimport DeleteIcon from '@material-ui/icons/Delete'\n+â”Š   â”Š  7â”Šimport MoreIcon from '@material-ui/icons/MoreVert'\n+â”Š   â”Š  8â”Šimport { defaultDataIdFromObject } from 'apollo-cache-inmemory'\n+â”Š   â”Š  9â”Šimport gql from 'graphql-tag'\n+â”Š   â”Š 10â”Šimport { History } from 'history'\n+â”Š   â”Š 11â”Šimport * as React from 'react'\n+â”Š   â”Š 12â”Šimport { useState } from 'react'\n+â”Š   â”Š 13â”Šimport { useQuery, useMutation } from 'react-apollo-hooks'\n+â”Š   â”Š 14â”Šimport styled from 'styled-components'\n+â”Š   â”Š 15â”Šimport * as fragments from '../../graphql/fragments'\n+â”Š   â”Š 16â”Šimport * as queries from '../../graphql/queries'\n+â”Š   â”Š 17â”Šimport { ChatNavbarMutation, ChatNavbarQuery, Chats } from '../../graphql/types'\n+â”Š   â”Š 18â”Š\n+â”Š   â”Š 19â”Šconst Style = styled.div`\n+â”Š   â”Š 20â”Š  padding: 0;\n+â”Š   â”Š 21â”Š  display: flex;\n+â”Š   â”Š 22â”Š  flex-direction: row;\n+â”Š   â”Š 23â”Š\n+â”Š   â”Š 24â”Š  margin-left: -20px;\n+â”Š   â”Š 25â”Š  .ChatNavbar-title {\n+â”Š   â”Š 26â”Š    line-height: 56px;\n+â”Š   â”Š 27â”Š  }\n+â”Š   â”Š 28â”Š\n+â”Š   â”Š 29â”Š  .ChatNavbar-back-button {\n+â”Š   â”Š 30â”Š    color: var(--primary-text);\n+â”Š   â”Š 31â”Š  }\n+â”Š   â”Š 32â”Š\n+â”Š   â”Š 33â”Š  .ChatNavbar-picture {\n+â”Š   â”Š 34â”Š    height: 40px;\n+â”Š   â”Š 35â”Š    width: 40px;\n+â”Š   â”Š 36â”Š    margin-top: 3px;\n+â”Š   â”Š 37â”Š    margin-left: -22px;\n+â”Š   â”Š 38â”Š    object-fit: cover;\n+â”Š   â”Š 39â”Š    padding: 5px;\n+â”Š   â”Š 40â”Š    border-radius: 50%;\n+â”Š   â”Š 41â”Š  }\n+â”Š   â”Š 42â”Š\n+â”Š   â”Š 43â”Š  .ChatNavbar-rest {\n+â”Š   â”Š 44â”Š    flex: 1;\n+â”Š   â”Š 45â”Š    justify-content: flex-end;\n+â”Š   â”Š 46â”Š  }\n+â”Š   â”Š 47â”Š\n+â”Š   â”Š 48â”Š  .ChatNavbar-options-btn {\n+â”Š   â”Š 49â”Š    float: right;\n+â”Š   â”Š 50â”Š    height: 100%;\n+â”Š   â”Š 51â”Š    font-size: 1.2em;\n+â”Š   â”Š 52â”Š    margin-right: -15px;\n+â”Š   â”Š 53â”Š    color: var(--primary-text);\n+â”Š   â”Š 54â”Š  }\n+â”Š   â”Š 55â”Š\n+â”Š   â”Š 56â”Š  .ChatNavbar-options-item svg {\n+â”Š   â”Š 57â”Š    margin-right: 10px;\n+â”Š   â”Š 58â”Š    padding-left: 15px;\n+â”Š   â”Š 59â”Š  }\n+â”Š   â”Š 60â”Š`\n+â”Š   â”Š 61â”Š\n+â”Š   â”Š 62â”Šconst query = gql`\n+â”Š   â”Š 63â”Š  query ChatNavbarQuery($chatId: ID!) {\n+â”Š   â”Š 64â”Š    chat(chatId: $chatId) {\n+â”Š   â”Š 65â”Š      ...Chat\n+â”Š   â”Š 66â”Š    }\n+â”Š   â”Š 67â”Š  }\n+â”Š   â”Š 68â”Š  ${fragments.chat}\n+â”Š   â”Š 69â”Š`\n+â”Š   â”Š 70â”Š\n+â”Š   â”Š 71â”Šconst mutation = gql`\n+â”Š   â”Š 72â”Š  mutation ChatNavbarMutation($chatId: ID!) {\n+â”Š   â”Š 73â”Š    removeChat(chatId: $chatId)\n+â”Š   â”Š 74â”Š  }\n+â”Š   â”Š 75â”Š`\n+â”Š   â”Š 76â”Š\n+â”Š   â”Š 77â”Šinterface ChatNavbarProps {\n+â”Š   â”Š 78â”Š  chatId: string\n+â”Š   â”Š 79â”Š  history: History\n+â”Š   â”Š 80â”Š}\n+â”Š   â”Š 81â”Š\n+â”Š   â”Š 82â”Šexport default ({ chatId, history }: ChatNavbarProps) => {\n+â”Š   â”Š 83â”Š  const {\n+â”Š   â”Š 84â”Š    data: { chat },\n+â”Š   â”Š 85â”Š  } = useQuery<ChatNavbarQuery.Query, ChatNavbarQuery.Variables>(query, {\n+â”Š   â”Š 86â”Š    variables: { chatId },\n+â”Š   â”Š 87â”Š    suspend: true,\n+â”Š   â”Š 88â”Š  })\n+â”Š   â”Š 89â”Š  const removeChat = useMutation<ChatNavbarMutation.Mutation, ChatNavbarMutation.Variables>(\n+â”Š   â”Š 90â”Š    mutation,\n+â”Š   â”Š 91â”Š    {\n+â”Š   â”Š 92â”Š      variables: { chatId },\n+â”Š   â”Š 93â”Š      update: (client, { data: { removeChat } }) => {\n+â”Š   â”Š 94â”Š        client.writeFragment({\n+â”Š   â”Š 95â”Š          id: defaultDataIdFromObject({\n+â”Š   â”Š 96â”Š            __typename: 'Chat',\n+â”Š   â”Š 97â”Š            id: removeChat,\n+â”Š   â”Š 98â”Š          }),\n+â”Š   â”Š 99â”Š          fragment: fragments.chat,\n+â”Š   â”Š100â”Š          fragmentName: 'Chat',\n+â”Š   â”Š101â”Š          data: null,\n+â”Š   â”Š102â”Š        })\n+â”Š   â”Š103â”Š\n+â”Š   â”Š104â”Š        let chats\n+â”Š   â”Š105â”Š        try {\n+â”Š   â”Š106â”Š          chats = client.readQuery<Chats.Query>({\n+â”Š   â”Š107â”Š            query: queries.chats,\n+â”Š   â”Š108â”Š          }).chats\n+â”Š   â”Š109â”Š        } catch (e) {}\n+â”Š   â”Š110â”Š\n+â”Š   â”Š111â”Š        if (chats && chats.some(chat => chat.id === removeChat)) {\n+â”Š   â”Š112â”Š          const index = chats.findIndex(chat => chat.id === removeChat)\n+â”Š   â”Š113â”Š          chats.splice(index, 1)\n+â”Š   â”Š114â”Š\n+â”Š   â”Š115â”Š          client.writeQuery({\n+â”Š   â”Š116â”Š            query: queries.chats,\n+â”Š   â”Š117â”Š            data: { chats },\n+â”Š   â”Š118â”Š          })\n+â”Š   â”Š119â”Š        }\n+â”Š   â”Š120â”Š      },\n+â”Š   â”Š121â”Š    },\n+â”Š   â”Š122â”Š  )\n+â”Š   â”Š123â”Š  const [popped, setPopped] = useState(false)\n+â”Š   â”Š124â”Š\n+â”Š   â”Š125â”Š  const navToChats = () => {\n+â”Š   â”Š126â”Š    history.push('/chats')\n+â”Š   â”Š127â”Š  }\n+â”Š   â”Š128â”Š\n+â”Š   â”Š129â”Š  const handleRemoveChat = () => {\n+â”Š   â”Š130â”Š    setPopped(false)\n+â”Š   â”Š131â”Š    removeChat().then(navToChats)\n+â”Š   â”Š132â”Š  }\n+â”Š   â”Š133â”Š\n+â”Š   â”Š134â”Š  return (\n+â”Š   â”Š135â”Š    <Style className={name}>\n+â”Š   â”Š136â”Š      <Button className=\"ChatNavbar-back-button\" onClick={navToChats}>\n+â”Š   â”Š137â”Š        <ArrowBackIcon />\n+â”Š   â”Š138â”Š      </Button>\n+â”Š   â”Š139â”Š      <img\n+â”Š   â”Š140â”Š        className=\"ChatNavbar-picture\"\n+â”Š   â”Š141â”Š        src={chat.picture || '/assets/default-profile-pic.jpg'}\n+â”Š   â”Š142â”Š      />\n+â”Š   â”Š143â”Š      <div className=\"ChatNavbar-title\">{chat.name}</div>\n+â”Š   â”Š144â”Š      <div className=\"ChatNavbar-rest\">\n+â”Š   â”Š145â”Š        <Button className=\"ChatNavbar-options-btn\" onClick={setPopped.bind(null, true)}>\n+â”Š   â”Š146â”Š          <MoreIcon />\n+â”Š   â”Š147â”Š        </Button>\n+â”Š   â”Š148â”Š      </div>\n+â”Š   â”Š149â”Š      <Popover\n+â”Š   â”Š150â”Š        open={popped}\n+â”Š   â”Š151â”Š        onClose={setPopped.bind(null, false)}\n+â”Š   â”Š152â”Š        anchorOrigin={{\n+â”Š   â”Š153â”Š          vertical: 'top',\n+â”Š   â”Š154â”Š          horizontal: 'right',\n+â”Š   â”Š155â”Š        }}\n+â”Š   â”Š156â”Š        transformOrigin={{\n+â”Š   â”Š157â”Š          vertical: 'top',\n+â”Š   â”Š158â”Š          horizontal: 'right',\n+â”Š   â”Š159â”Š        }}\n+â”Š   â”Š160â”Š      >\n+â”Š   â”Š161â”Š        <Style style={{ marginLeft: '-15px' }}>\n+â”Š   â”Š162â”Š          <List>\n+â”Š   â”Š163â”Š            <ListItem className=\"ChatNavbar-options-item\" button onClick={handleRemoveChat}>\n+â”Š   â”Š164â”Š              <DeleteIcon />\n+â”Š   â”Š165â”Š              Delete\n+â”Š   â”Š166â”Š            </ListItem>\n+â”Š   â”Š167â”Š          </List>\n+â”Š   â”Š168â”Š        </Style>\n+â”Š   â”Š169â”Š      </Popover>\n+â”Š   â”Š170â”Š    </Style>\n+â”Š   â”Š171â”Š  )\n+â”Š   â”Š172â”Š}\n```\n\n##### Added src&#x2F;components&#x2F;ChatRoomScreen&#x2F;MessageBox.tsx\n```diff\n@@ -0,0 +1,162 @@\n+â”Š   â”Š  1â”Šimport Button from '@material-ui/core/Button'\n+â”Š   â”Š  2â”Šimport SendIcon from '@material-ui/icons/Send'\n+â”Š   â”Š  3â”Šimport { defaultDataIdFromObject } from 'apollo-cache-inmemory'\n+â”Š   â”Š  4â”Šimport gql from 'graphql-tag'\n+â”Š   â”Š  5â”Šimport * as React from 'react'\n+â”Š   â”Š  6â”Šimport { useState } from 'react'\n+â”Š   â”Š  7â”Šimport { useMutation } from 'react-apollo-hooks'\n+â”Š   â”Š  8â”Šimport styled from 'styled-components'\n+â”Š   â”Š  9â”Šimport { time as uniqid } from 'uniqid'\n+â”Š   â”Š 10â”Šimport * as fragments from '../../graphql/fragments'\n+â”Š   â”Š 11â”Šimport { MessageBoxMutation, FullChat, Message } from '../../graphql/types'\n+â”Š   â”Š 12â”Šimport { useMe } from '../../services/auth.service'\n+â”Š   â”Š 13â”Š\n+â”Š   â”Š 14â”Šconst Style = styled.div`\n+â”Š   â”Š 15â”Š  display: flex;\n+â”Š   â”Š 16â”Š  height: 50px;\n+â”Š   â”Š 17â”Š  padding: 5px;\n+â”Š   â”Š 18â”Š  width: calc(100% - 10px);\n+â”Š   â”Š 19â”Š\n+â”Š   â”Š 20â”Š  .MessageBox-input {\n+â”Š   â”Š 21â”Š    width: calc(100% - 50px);\n+â”Š   â”Š 22â”Š    border: none;\n+â”Š   â”Š 23â”Š    border-radius: 999px;\n+â”Š   â”Š 24â”Š    padding: 10px;\n+â”Š   â”Š 25â”Š    padding-left: 20px;\n+â”Š   â”Š 26â”Š    padding-right: 20px;\n+â”Š   â”Š 27â”Š    font-size: 15px;\n+â”Š   â”Š 28â”Š    outline: none;\n+â”Š   â”Š 29â”Š    box-shadow: 0 1px silver;\n+â”Š   â”Š 30â”Š    font-size: 18px;\n+â”Š   â”Š 31â”Š    line-height: 45px;\n+â”Š   â”Š 32â”Š  }\n+â”Š   â”Š 33â”Š\n+â”Š   â”Š 34â”Š  .MessageBox-button {\n+â”Š   â”Š 35â”Š    min-width: 50px;\n+â”Š   â”Š 36â”Š    width: 50px;\n+â”Š   â”Š 37â”Š    border-radius: 999px;\n+â”Š   â”Š 38â”Š    background-color: var(--primary-bg);\n+â”Š   â”Š 39â”Š    margin: 0 5px;\n+â”Š   â”Š 40â”Š    margin-right: 0;\n+â”Š   â”Š 41â”Š    color: white;\n+â”Š   â”Š 42â”Š    padding-left: 20px;\n+â”Š   â”Š 43â”Š    svg {\n+â”Š   â”Š 44â”Š      margin-left: -3px;\n+â”Š   â”Š 45â”Š    }\n+â”Š   â”Š 46â”Š  }\n+â”Š   â”Š 47â”Š`\n+â”Š   â”Š 48â”Š\n+â”Š   â”Š 49â”Šconst mutation = gql`\n+â”Š   â”Š 50â”Š  mutation MessageBoxMutation($chatId: ID!, $content: String!) {\n+â”Š   â”Š 51â”Š    addMessage(chatId: $chatId, content: $content) {\n+â”Š   â”Š 52â”Š      ...Message\n+â”Š   â”Š 53â”Š    }\n+â”Š   â”Š 54â”Š  }\n+â”Š   â”Š 55â”Š  ${fragments.message}\n+â”Š   â”Š 56â”Š`\n+â”Š   â”Š 57â”Š\n+â”Š   â”Š 58â”Šinterface MessageBoxProps {\n+â”Š   â”Š 59â”Š  chatId: string\n+â”Š   â”Š 60â”Š}\n+â”Š   â”Š 61â”Š\n+â”Š   â”Š 62â”Šexport default ({ chatId }: MessageBoxProps) => {\n+â”Š   â”Š 63â”Š  const [message, setMessage] = useState('')\n+â”Š   â”Š 64â”Š  const me = useMe()\n+â”Š   â”Š 65â”Š\n+â”Š   â”Š 66â”Š  const addMessage = useMutation<MessageBoxMutation.Mutation, MessageBoxMutation.Variables>(\n+â”Š   â”Š 67â”Š    mutation,\n+â”Š   â”Š 68â”Š    {\n+â”Š   â”Š 69â”Š      variables: {\n+â”Š   â”Š 70â”Š        chatId,\n+â”Š   â”Š 71â”Š        content: message,\n+â”Š   â”Š 72â”Š      },\n+â”Š   â”Š 73â”Š      optimisticResponse: {\n+â”Š   â”Š 74â”Š        __typename: 'Mutation',\n+â”Š   â”Š 75â”Š        addMessage: {\n+â”Š   â”Š 76â”Š          id: uniqid(),\n+â”Š   â”Š 77â”Š          __typename: 'Message',\n+â”Š   â”Š 78â”Š          chat: {\n+â”Š   â”Š 79â”Š            id: chatId,\n+â”Š   â”Š 80â”Š            __typename: 'Chat',\n+â”Š   â”Š 81â”Š          },\n+â”Š   â”Š 82â”Š          sender: {\n+â”Š   â”Š 83â”Š            id: me.id,\n+â”Š   â”Š 84â”Š            __typename: 'User',\n+â”Š   â”Š 85â”Š            name: me.name,\n+â”Š   â”Š 86â”Š          },\n+â”Š   â”Š 87â”Š          content: message,\n+â”Š   â”Š 88â”Š          createdAt: new Date(),\n+â”Š   â”Š 89â”Š          type: 0,\n+â”Š   â”Š 90â”Š          recipients: [],\n+â”Š   â”Š 91â”Š          ownership: true,\n+â”Š   â”Š 92â”Š        },\n+â”Š   â”Š 93â”Š      },\n+â”Š   â”Š 94â”Š      update: (client, { data: { addMessage } }) => {\n+â”Š   â”Š 95â”Š        client.writeFragment({\n+â”Š   â”Š 96â”Š          id: defaultDataIdFromObject(addMessage),\n+â”Š   â”Š 97â”Š          fragment: fragments.message,\n+â”Š   â”Š 98â”Š          data: addMessage,\n+â”Š   â”Š 99â”Š        })\n+â”Š   â”Š100â”Š\n+â”Š   â”Š101â”Š        let fullChat\n+â”Š   â”Š102â”Š        try {\n+â”Š   â”Š103â”Š          fullChat = client.readFragment<FullChat.Fragment>({\n+â”Š   â”Š104â”Š            id: defaultDataIdFromObject(addMessage.chat),\n+â”Š   â”Š105â”Š            fragment: fragments.fullChat,\n+â”Š   â”Š106â”Š            fragmentName: 'FullChat',\n+â”Š   â”Š107â”Š          })\n+â”Š   â”Š108â”Š        } catch (e) {}\n+â”Š   â”Š109â”Š\n+â”Š   â”Š110â”Š        if (fullChat && !fullChat.messages.some(message => message.id === addMessage.id)) {\n+â”Š   â”Š111â”Š          fullChat.messages.push(addMessage)\n+â”Š   â”Š112â”Š          fullChat.lastMessage = addMessage\n+â”Š   â”Š113â”Š\n+â”Š   â”Š114â”Š          client.writeFragment({\n+â”Š   â”Š115â”Š            id: defaultDataIdFromObject(addMessage.chat),\n+â”Š   â”Š116â”Š            fragment: fragments.fullChat,\n+â”Š   â”Š117â”Š            fragmentName: 'FullChat',\n+â”Š   â”Š118â”Š            data: fullChat,\n+â”Š   â”Š119â”Š          })\n+â”Š   â”Š120â”Š        }\n+â”Š   â”Š121â”Š      },\n+â”Š   â”Š122â”Š    },\n+â”Š   â”Š123â”Š  )\n+â”Š   â”Š124â”Š\n+â”Š   â”Š125â”Š  const onKeyPress = e => {\n+â”Š   â”Š126â”Š    if (e.charCode === 13) {\n+â”Š   â”Š127â”Š      submitMessage()\n+â”Š   â”Š128â”Š    }\n+â”Š   â”Š129â”Š  }\n+â”Š   â”Š130â”Š\n+â”Š   â”Š131â”Š  const onChange = ({ target }) => {\n+â”Š   â”Š132â”Š    setMessage(target.value)\n+â”Š   â”Š133â”Š  }\n+â”Š   â”Š134â”Š\n+â”Š   â”Š135â”Š  const submitMessage = () => {\n+â”Š   â”Š136â”Š    if (!message) return\n+â”Š   â”Š137â”Š\n+â”Š   â”Š138â”Š    addMessage()\n+â”Š   â”Š139â”Š    setMessage('')\n+â”Š   â”Š140â”Š  }\n+â”Š   â”Š141â”Š\n+â”Š   â”Š142â”Š  return (\n+â”Š   â”Š143â”Š    <Style className=\"MessageBox\">\n+â”Š   â”Š144â”Š      <input\n+â”Š   â”Š145â”Š        className=\"MessageBox-input\"\n+â”Š   â”Š146â”Š        type=\"text\"\n+â”Š   â”Š147â”Š        placeholder=\"Type a message\"\n+â”Š   â”Š148â”Š        value={message}\n+â”Š   â”Š149â”Š        onKeyPress={onKeyPress}\n+â”Š   â”Š150â”Š        onChange={onChange}\n+â”Š   â”Š151â”Š      />\n+â”Š   â”Š152â”Š      <Button\n+â”Š   â”Š153â”Š        variant=\"contained\"\n+â”Š   â”Š154â”Š        color=\"primary\"\n+â”Š   â”Š155â”Š        className=\"MessageBox-button\"\n+â”Š   â”Š156â”Š        onClick={submitMessage}\n+â”Š   â”Š157â”Š      >\n+â”Š   â”Š158â”Š        <SendIcon />\n+â”Š   â”Š159â”Š      </Button>\n+â”Š   â”Š160â”Š    </Style>\n+â”Š   â”Š161â”Š  )\n+â”Š   â”Š162â”Š}\n```\n\n##### Added src&#x2F;components&#x2F;ChatRoomScreen&#x2F;MessagesList.tsx\n```diff\n@@ -0,0 +1,144 @@\n+â”Š   â”Š  1â”Šimport gql from 'graphql-tag'\n+â”Š   â”Š  2â”Šimport * as moment from 'moment'\n+â”Š   â”Š  3â”Šimport * as React from 'react'\n+â”Š   â”Š  4â”Šimport { useRef, useEffect } from 'react'\n+â”Š   â”Š  5â”Šimport { useQuery, useMutation } from 'react-apollo-hooks'\n+â”Š   â”Š  6â”Šimport * as ReactDOM from 'react-dom'\n+â”Š   â”Š  7â”Šimport styled from 'styled-components'\n+â”Š   â”Š  8â”Šimport * as fragments from '../../graphql/fragments'\n+â”Š   â”Š  9â”Šimport { MessagesListQuery } from '../../graphql/types'\n+â”Š   â”Š 10â”Š\n+â”Š   â”Š 11â”Šconst Style = styled.div`\n+â”Š   â”Š 12â”Š  display: block;\n+â”Š   â”Š 13â”Š  height: calc(100% - 60px);\n+â”Š   â”Š 14â”Š  width: calc(100% - 30px);\n+â”Š   â”Š 15â”Š  overflow-y: overlay;\n+â”Š   â”Š 16â”Š  padding: 0 15px;\n+â”Š   â”Š 17â”Š\n+â”Š   â”Š 18â”Š  .MessagesList-message {\n+â”Š   â”Š 19â”Š    display: inline-block;\n+â”Š   â”Š 20â”Š    position: relative;\n+â”Š   â”Š 21â”Š    max-width: 100%;\n+â”Š   â”Š 22â”Š    border-radius: 7px;\n+â”Š   â”Š 23â”Š    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.15);\n+â”Š   â”Š 24â”Š    margin-top: 10px;\n+â”Š   â”Š 25â”Š    margin-bottom: 10px;\n+â”Š   â”Š 26â”Š    clear: both;\n+â”Š   â”Š 27â”Š\n+â”Š   â”Š 28â”Š    &::after {\n+â”Š   â”Š 29â”Š      content: '';\n+â”Š   â”Š 30â”Š      display: table;\n+â”Š   â”Š 31â”Š      clear: both;\n+â”Š   â”Š 32â”Š    }\n+â”Š   â”Š 33â”Š  }\n+â”Š   â”Š 34â”Š\n+â”Š   â”Š 35â”Š  .MessagesList-message-mine {\n+â”Š   â”Š 36â”Š    float: right;\n+â”Š   â”Š 37â”Š    background-color: #dcf8c6;\n+â”Š   â”Š 38â”Š\n+â”Š   â”Š 39â”Š    &::before {\n+â”Š   â”Š 40â”Š      right: -11px;\n+â”Š   â”Š 41â”Š      background-image: url(/assets/message-mine.png);\n+â”Š   â”Š 42â”Š    }\n+â”Š   â”Š 43â”Š  }\n+â”Š   â”Š 44â”Š\n+â”Š   â”Š 45â”Š  .MessagesList-message-others {\n+â”Š   â”Š 46â”Š    float: left;\n+â”Š   â”Š 47â”Š    background-color: #fff;\n+â”Š   â”Š 48â”Š\n+â”Š   â”Š 49â”Š    &::before {\n+â”Š   â”Š 50â”Š      left: -11px;\n+â”Š   â”Š 51â”Š      background-image: url(/assets/message-other.png);\n+â”Š   â”Š 52â”Š    }\n+â”Š   â”Š 53â”Š  }\n+â”Š   â”Š 54â”Š\n+â”Š   â”Š 55â”Š  .MessagesList-message-others::before,\n+â”Š   â”Š 56â”Š  .MessagesList-message-mine::before {\n+â”Š   â”Š 57â”Š    content: '';\n+â”Š   â”Š 58â”Š    position: absolute;\n+â”Š   â”Š 59â”Š    bottom: 3px;\n+â”Š   â”Š 60â”Š    width: 12px;\n+â”Š   â”Š 61â”Š    height: 19px;\n+â”Š   â”Š 62â”Š    background-position: 50% 50%;\n+â”Š   â”Š 63â”Š    background-repeat: no-repeat;\n+â”Š   â”Š 64â”Š    background-size: contain;\n+â”Š   â”Š 65â”Š  }\n+â”Š   â”Š 66â”Š\n+â”Š   â”Š 67â”Š  .MessagesList-message-sender {\n+â”Š   â”Š 68â”Š    font-weight: bold;\n+â”Š   â”Š 69â”Š    margin-left: 5px;\n+â”Š   â”Š 70â”Š    margin-top: 5px;\n+â”Š   â”Š 71â”Š  }\n+â”Š   â”Š 72â”Š\n+â”Š   â”Š 73â”Š  .MessagesList-message-contents {\n+â”Š   â”Š 74â”Š    padding: 5px 7px;\n+â”Š   â”Š 75â”Š    word-wrap: break-word;\n+â”Š   â”Š 76â”Š\n+â”Š   â”Š 77â”Š    &::after {\n+â”Š   â”Š 78â”Š      content: ' \\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0';\n+â”Š   â”Š 79â”Š      display: inline;\n+â”Š   â”Š 80â”Š    }\n+â”Š   â”Š 81â”Š  }\n+â”Š   â”Š 82â”Š\n+â”Š   â”Š 83â”Š  .MessagesList-message-timestamp {\n+â”Š   â”Š 84â”Š    position: absolute;\n+â”Š   â”Š 85â”Š    bottom: 2px;\n+â”Š   â”Š 86â”Š    right: 7px;\n+â”Š   â”Š 87â”Š    color: gray;\n+â”Š   â”Š 88â”Š    font-size: 12px;\n+â”Š   â”Š 89â”Š  }\n+â”Š   â”Š 90â”Š`\n+â”Š   â”Š 91â”Š\n+â”Š   â”Š 92â”Šconst query = gql`\n+â”Š   â”Š 93â”Š  query MessagesListQuery($chatId: ID!) {\n+â”Š   â”Š 94â”Š    chat(chatId: $chatId) {\n+â”Š   â”Š 95â”Š      ...FullChat\n+â”Š   â”Š 96â”Š    }\n+â”Š   â”Š 97â”Š  }\n+â”Š   â”Š 98â”Š  ${fragments.fullChat}\n+â”Š   â”Š 99â”Š`\n+â”Š   â”Š100â”Š\n+â”Š   â”Š101â”Šinterface MessagesListProps {\n+â”Š   â”Š102â”Š  chatId: string\n+â”Š   â”Š103â”Š}\n+â”Š   â”Š104â”Š\n+â”Š   â”Š105â”Šexport default ({ chatId }: MessagesListProps) => {\n+â”Š   â”Š106â”Š  const {\n+â”Š   â”Š107â”Š    data: {\n+â”Š   â”Š108â”Š      chat: { messages },\n+â”Š   â”Š109â”Š    },\n+â”Š   â”Š110â”Š  } = useQuery<MessagesListQuery.Query, MessagesListQuery.Variables>(query, {\n+â”Š   â”Š111â”Š    variables: { chatId },\n+â”Š   â”Š112â”Š    suspend: true,\n+â”Š   â”Š113â”Š  })\n+â”Š   â”Š114â”Š  const selfRef = useRef(null)\n+â”Š   â”Š115â”Š\n+â”Š   â”Š116â”Š  const resetScrollTop = () => {\n+â”Š   â”Š117â”Š    if (!selfRef.current) return\n+â”Š   â”Š118â”Š\n+â”Š   â”Š119â”Š    const selfDOMNode = ReactDOM.findDOMNode(selfRef.current) as HTMLElement\n+â”Š   â”Š120â”Š    selfDOMNode.scrollTop = Number.MAX_SAFE_INTEGER\n+â”Š   â”Š121â”Š  }\n+â”Š   â”Š122â”Š\n+â”Š   â”Š123â”Š  useEffect(resetScrollTop, [selfRef.current])\n+â”Š   â”Š124â”Š  useEffect(resetScrollTop, [messages.length])\n+â”Š   â”Š125â”Š\n+â”Š   â”Š126â”Š  return (\n+â”Š   â”Š127â”Š    <Style className={name} ref={selfRef}>\n+â”Š   â”Š128â”Š      {messages &&\n+â”Š   â”Š129â”Š        messages.map(message => (\n+â”Š   â”Š130â”Š          <div\n+â”Š   â”Š131â”Š            key={message.id}\n+â”Š   â”Š132â”Š            className={`MessagesList-message ${\n+â”Š   â”Š133â”Š              message.ownership ? 'MessagesList-message-mine' : 'MessagesList-message-others'\n+â”Š   â”Š134â”Š            }`}\n+â”Š   â”Š135â”Š          >\n+â”Š   â”Š136â”Š            <div className=\"MessagesList-message-contents\">{message.content}</div>\n+â”Š   â”Š137â”Š            <span className=\"MessagesList-message-timestamp\">\n+â”Š   â”Š138â”Š              {moment(message.createdAt).format('HH:mm')}\n+â”Š   â”Š139â”Š            </span>\n+â”Š   â”Š140â”Š          </div>\n+â”Š   â”Š141â”Š        ))}\n+â”Š   â”Š142â”Š    </Style>\n+â”Š   â”Š143â”Š  )\n+â”Š   â”Š144â”Š}\n```\n\n##### Added src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -0,0 +1,56 @@\n+â”Š  â”Š 1â”Šimport * as React from 'react'\n+â”Š  â”Š 2â”Šimport { Suspense } from 'react'\n+â”Š  â”Š 3â”Šimport { RouteComponentProps } from 'react-router-dom'\n+â”Š  â”Š 4â”Šimport styled from 'styled-components'\n+â”Š  â”Š 5â”Šimport Navbar from '../Navbar'\n+â”Š  â”Š 6â”Šimport ChatNavbar from './ChatNavbar'\n+â”Š  â”Š 7â”Šimport MessageBox from './MessageBox'\n+â”Š  â”Š 8â”Šimport MessagesList from './MessagesList'\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Šconst Style = styled.div`\n+â”Š  â”Š11â”Š  .ChatScreen-body {\n+â”Š  â”Š12â”Š    position: relative;\n+â”Š  â”Š13â”Š    background: url(/assets/chat-background.jpg);\n+â”Š  â”Š14â”Š    width: 100%;\n+â”Š  â”Š15â”Š    height: calc(100% - 56px);\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š    .MessagesList {\n+â”Š  â”Š18â”Š      position: absolute;\n+â”Š  â”Š19â”Š      height: calc(100% - 60px);\n+â”Š  â”Š20â”Š      top: 0;\n+â”Š  â”Š21â”Š    }\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Š    .MessageBox {\n+â”Š  â”Š24â”Š      position: absolute;\n+â”Š  â”Š25â”Š      bottom: 0;\n+â”Š  â”Š26â”Š      left: 0;\n+â”Š  â”Š27â”Š    }\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š    .AddChatButton {\n+â”Š  â”Š30â”Š      right: 0;\n+â”Š  â”Š31â”Š      bottom: 0;\n+â”Š  â”Š32â”Š    }\n+â”Š  â”Š33â”Š  }\n+â”Š  â”Š34â”Š`\n+â”Š  â”Š35â”Š\n+â”Š  â”Š36â”Šexport default ({ match, history }: RouteComponentProps) => {\n+â”Š  â”Š37â”Š  const chatId = match.params.chatId\n+â”Š  â”Š38â”Š\n+â”Š  â”Š39â”Š  return (\n+â”Š  â”Š40â”Š    <Style className=\"ChatScreen Screen\">\n+â”Š  â”Š41â”Š      <Navbar>\n+â”Š  â”Š42â”Š        <Suspense fallback={null}>\n+â”Š  â”Š43â”Š          <ChatNavbar chatId={chatId} history={history} />\n+â”Š  â”Š44â”Š        </Suspense>\n+â”Š  â”Š45â”Š      </Navbar>\n+â”Š  â”Š46â”Š      <div className=\"ChatScreen-body\">\n+â”Š  â”Š47â”Š        <Suspense fallback={null}>\n+â”Š  â”Š48â”Š          <MessagesList chatId={chatId} />\n+â”Š  â”Š49â”Š        </Suspense>\n+â”Š  â”Š50â”Š        <Suspense fallback={null}>\n+â”Š  â”Š51â”Š          <MessageBox chatId={chatId} />\n+â”Š  â”Š52â”Š        </Suspense>\n+â”Š  â”Š53â”Š      </div>\n+â”Š  â”Š54â”Š    </Style>\n+â”Š  â”Š55â”Š  )\n+â”Š  â”Š56â”Š}\n```\n\n[}]: #\n\nWe're introduced to new 2 packages in the implementation above:\n\n- [`uniqid`](https://www.npmjs.com/package/uniqid) - Used to generate a unique ID in our optimistic response.\n- [`styled-components`](https://www.npmjs.com/package/styled-components) - Used to create encapsulated style for React components.\n\nLet's install them then:\n\n    $ yarn add uniqid@5.0.3 styled-components@4.1.3\n\nYou'll notice that there's a new fragment called `fullChat`. The full chat includes the base chat details, plus a list of messages that we're gonna view in the chat room screen. Let's define the fragment then:\n\n[{]: <helper> (diffStep 3.1 files=\"src/graphql/fragments\" module=\"client\")\n\n#### [Step 3.1: Add chat room screen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/b2bc092)\n\n##### Added src&#x2F;graphql&#x2F;fragments&#x2F;fullChat.fragment.ts\n```diff\n@@ -0,0 +1,14 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag'\n+â”Š  â”Š 2â”Šimport chat from './chat.fragment'\n+â”Š  â”Š 3â”Šimport message from './message.fragment'\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šexport default gql `\n+â”Š  â”Š 6â”Š  fragment FullChat on Chat {\n+â”Š  â”Š 7â”Š    ...Chat\n+â”Š  â”Š 8â”Š    messages {\n+â”Š  â”Š 9â”Š      ...Message\n+â”Š  â”Š10â”Š    }\n+â”Š  â”Š11â”Š  }\n+â”Š  â”Š12â”Š  ${chat}\n+â”Š  â”Š13â”Š  ${message}\n+â”Š  â”Š14â”Š`\n```\n\n##### Changed src&#x2F;graphql&#x2F;fragments&#x2F;index.ts\n```diff\n@@ -1,3 +1,4 @@\n â”Š1â”Š1â”Šexport { default as chat } from './chat.fragment'\n+â”Š â”Š2â”Šexport { default as fullChat } from './fullChat.fragment'\n â”Š2â”Š3â”Šexport { default as message } from './message.fragment'\n â”Š3â”Š4â”Šexport { default as user } from './user.fragment'\n```\n\n[}]: #\n\nAt this point the chat room should be functional. Let's add a dedicated route for it and make it navigatable by clicking on a chat item from the chats list screen:\n\n[{]: <helper> (diffStep 3.1 files=\"src/App, src/components/ChatsListScreen\" module=\"client\")\n\n#### [Step 3.1: Add chat room screen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/b2bc092)\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -1,5 +1,6 @@\n â”Š1â”Š1â”Šimport * as React from 'react'\n â”Š2â”Š2â”Šimport { BrowserRouter, Route, Redirect } from 'react-router-dom'\n+â”Š â”Š3â”Šimport ChatRoomScreen from './components/ChatRoomScreen'\n â”Š3â”Š4â”Šimport AnimatedSwitch from './components/AnimatedSwitch'\n â”Š4â”Š5â”Šimport AuthScreen from './components/AuthScreen'\n â”Š5â”Š6â”Šimport ChatsListScreen from './components/ChatsListScreen'\n```\n```diff\n@@ -16,6 +17,7 @@\n â”Š16â”Š17â”Š      <Route exact path=\"/sign-(in|up)\" component={AuthScreen} />\n â”Š17â”Š18â”Š      <Route exact path=\"/chats\" component={withAuth(ChatsListScreen)} />\n â”Š18â”Š19â”Š      <Route exact path=\"/settings\" component={withAuth(SettingsScreen)} />\n+â”Š  â”Š20â”Š      <Route exact path=\"/chats/:chatId\" component={withAuth(ChatRoomScreen)} />\n â”Š19â”Š21â”Š      <Route component={RedirectToChats} />\n â”Š20â”Š22â”Š    </AnimatedSwitch>\n â”Š21â”Š23â”Š  </BrowserRouter>\n```\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -1,6 +1,7 @@\n â”Š1â”Š1â”Šimport List from '@material-ui/core/List'\n â”Š2â”Š2â”Šimport ListItem from '@material-ui/core/ListItem'\n â”Š3â”Š3â”Šimport gql from 'graphql-tag'\n+â”Š â”Š4â”Šimport { History } from 'history'\n â”Š4â”Š5â”Šimport * as moment from 'moment'\n â”Š5â”Š6â”Šimport * as React from 'react'\n â”Š6â”Š7â”Šimport { useQuery } from 'react-apollo-hooks'\n```\n```diff\n@@ -71,11 +72,19 @@\n â”Š71â”Š72â”Š  ${fragments.chat}\n â”Š72â”Š73â”Š`\n â”Š73â”Š74â”Š\n-â”Š74â”Š  â”Šexport default () => {\n+â”Š  â”Š75â”Šinterface ChatsListProps {\n+â”Š  â”Š76â”Š  history: History\n+â”Š  â”Š77â”Š}\n+â”Š  â”Š78â”Š\n+â”Š  â”Š79â”Šexport default ({ history }: ChatsListProps) => {\n â”Š75â”Š80â”Š  const {\n â”Š76â”Š81â”Š    data: { chats },\n â”Š77â”Š82â”Š  } = useQuery<ChatsListQuery.Query>(query, { suspend: true })\n â”Š78â”Š83â”Š\n+â”Š  â”Š84â”Š  const navToChat = chatId => {\n+â”Š  â”Š85â”Š    history.push(`chats/${chatId}`)\n+â”Š  â”Š86â”Š  }\n+â”Š  â”Š87â”Š\n â”Š79â”Š88â”Š  return (\n â”Š80â”Š89â”Š    <Style className=\"ChatsList\">\n â”Š81â”Š90â”Š      <List className=\"ChatsList-chats-list\">\n```\n```diff\n@@ -84,6 +93,7 @@\n â”Š84â”Š93â”Š            key={chat.id}\n â”Š85â”Š94â”Š            className=\"ChatsList-chat-item\"\n â”Š86â”Š95â”Š            button\n+â”Š  â”Š96â”Š            onClick={navToChat.bind(null, chat.id)}\n â”Š87â”Š97â”Š          >\n â”Š88â”Š98â”Š            <img\n â”Š89â”Š99â”Š              className=\"ChatsList-profile-pic\"\n```\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;index.tsx\n```diff\n@@ -11,7 +11,7 @@\n â”Š11â”Š11â”Š      <ChatsNavbar history={history} />\n â”Š12â”Š12â”Š    </Navbar>\n â”Š13â”Š13â”Š    <Suspense fallback={null}>\n-â”Š14â”Š  â”Š      <ChatsList />\n+â”Š  â”Š14â”Š      <ChatsList history={history} />\n â”Š15â”Š15â”Š    </Suspense>\n â”Š16â”Š16â”Š  </div>\n â”Š17â”Š17â”Š)\n```\n\n[}]: #\n\nLike we said in the previous step, everything in our application is connected and so whenever there's a mutation or a change in data we should update the cache. Let's define the right subscriptions and update our `cache.service`:\n\n[{]: <helper> (diffStep 3.1 files=\"src/graphql/subscriptions, src/services/cache\" module=\"client\")\n\n#### [Step 3.1: Add chat room screen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/b2bc092)\n\n##### Changed src&#x2F;graphql&#x2F;subscriptions&#x2F;index.ts\n```diff\n@@ -1 +1,2 @@\n â”Š1â”Š1â”Šexport { default as chatUpdated } from './chatUpdated.subscription'\n+â”Š â”Š2â”Šexport { default as messageAdded } from './messageAdded.subscription'\n```\n\n##### Added src&#x2F;graphql&#x2F;subscriptions&#x2F;messageAdded.subscription.ts\n```diff\n@@ -0,0 +1,11 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag'\n+â”Š  â”Š 2â”Šimport * as fragments from '../fragments'\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šexport default gql `\n+â”Š  â”Š 5â”Š  subscription MessageAdded {\n+â”Š  â”Š 6â”Š    messageAdded {\n+â”Š  â”Š 7â”Š      ...Message\n+â”Š  â”Š 8â”Š    }\n+â”Š  â”Š 9â”Š  }\n+â”Š  â”Š10â”Š  ${fragments.message}\n+â”Š  â”Š11â”Š`\n```\n\n##### Changed src&#x2F;services&#x2F;cache.service.tsx\n```diff\n@@ -1,7 +1,8 @@\n â”Š1â”Š1â”Šimport { defaultDataIdFromObject } from 'apollo-cache-inmemory'\n â”Š2â”Š2â”Šimport * as fragments from '../graphql/fragments'\n â”Š3â”Š3â”Šimport * as subscriptions from '../graphql/subscriptions'\n-â”Š4â”Š â”Šimport { ChatUpdated } from '../graphql/types'\n+â”Š â”Š4â”Šimport * as queries from '../graphql/queries'\n+â”Š â”Š5â”Šimport { ChatUpdated, MessageAdded, Message, Chats, FullChat } from '../graphql/types'\n â”Š5â”Š6â”Šimport { useSubscription } from '../polyfills/react-apollo-hooks'\n â”Š6â”Š7â”Š\n â”Š7â”Š8â”Šexport const useSubscriptions = () => {\n```\n```diff\n@@ -15,4 +16,55 @@\n â”Š15â”Š16â”Š      })\n â”Š16â”Š17â”Š    },\n â”Š17â”Š18â”Š  })\n+â”Š  â”Š19â”Š\n+â”Š  â”Š20â”Š  useSubscription<MessageAdded.Subscription>(subscriptions.messageAdded, {\n+â”Š  â”Š21â”Š    onSubscriptionData: ({ client, subscriptionData: { messageAdded } }) => {\n+â”Š  â”Š22â”Š      client.writeFragment<Message.Fragment>({\n+â”Š  â”Š23â”Š        id: defaultDataIdFromObject(messageAdded),\n+â”Š  â”Š24â”Š        fragment: fragments.message,\n+â”Š  â”Š25â”Š        data: messageAdded,\n+â”Š  â”Š26â”Š      })\n+â”Š  â”Š27â”Š\n+â”Š  â”Š28â”Š      let fullChat\n+â”Š  â”Š29â”Š      try {\n+â”Š  â”Š30â”Š        fullChat = client.readFragment<FullChat.Fragment>({\n+â”Š  â”Š31â”Š          id: defaultDataIdFromObject(messageAdded.chat),\n+â”Š  â”Š32â”Š          fragment: fragments.fullChat,\n+â”Š  â”Š33â”Š          fragmentName: 'FullChat',\n+â”Š  â”Š34â”Š        })\n+â”Š  â”Š35â”Š      } catch (e) {}\n+â”Š  â”Š36â”Š\n+â”Š  â”Š37â”Š      if (fullChat && !fullChat.messages.some(message => message.id === messageAdded.id)) {\n+â”Š  â”Š38â”Š        fullChat.messages.push(messageAdded)\n+â”Š  â”Š39â”Š        fullChat.lastMessage = messageAdded\n+â”Š  â”Š40â”Š\n+â”Š  â”Š41â”Š        client.writeFragment({\n+â”Š  â”Š42â”Š          id: defaultDataIdFromObject(fullChat),\n+â”Š  â”Š43â”Š          fragment: fragments.fullChat,\n+â”Š  â”Š44â”Š          fragmentName: 'FullChat',\n+â”Š  â”Š45â”Š          data: fullChat,\n+â”Š  â”Š46â”Š        })\n+â”Š  â”Š47â”Š      }\n+â”Š  â”Š48â”Š\n+â”Š  â”Š49â”Š      let chats\n+â”Š  â”Š50â”Š      try {\n+â”Š  â”Š51â”Š        chats = client.readQuery<Chats.Query>({\n+â”Š  â”Š52â”Š          query: queries.chats,\n+â”Š  â”Š53â”Š        }).chats\n+â”Š  â”Š54â”Š      } catch (e) {}\n+â”Š  â”Š55â”Š\n+â”Š  â”Š56â”Š      if (chats) {\n+â”Š  â”Š57â”Š        const index = chats.findIndex(chat => chat.id === messageAdded.chat.id)\n+â”Š  â”Š58â”Š        const chat = chats[index]\n+â”Š  â”Š59â”Š        chat.lastMessage = messageAdded\n+â”Š  â”Š60â”Š        chats.splice(index, 1)\n+â”Š  â”Š61â”Š        chats.unshift(chat)\n+â”Š  â”Š62â”Š\n+â”Š  â”Š63â”Š        client.writeQuery({\n+â”Š  â”Š64â”Š          query: queries.chats,\n+â”Š  â”Š65â”Š          data: { chats },\n+â”Š  â”Š66â”Š        })\n+â”Š  â”Š67â”Š      }\n+â”Š  â”Š68â”Š    },\n+â”Š  â”Š69â”Š  })\n â”Š18â”Š70â”Š}\n```\n\n[}]: #\n\nWe've already implemented all the necessary subscription handlers in the server in the beginning of this step, so things should work smoothly.\n\nNow we're gonna implement a users list component where we will be able to pick users and chat with them. The users list component is gonna be global to the rest of the components because we will be using it in other screens in the upcoming steps.\n\n[{]: <helper> (diffStep 3.2 files=\"src/components/UsersList\" module=\"client\")\n\n#### [Step 3.2: Add new chat screen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/d0e8364)\n\n##### Added src&#x2F;components&#x2F;UsersList.tsx\n```diff\n@@ -0,0 +1,112 @@\n+â”Š   â”Š  1â”Šimport List from '@material-ui/core/List'\n+â”Š   â”Š  2â”Šimport ListItem from '@material-ui/core/ListItem'\n+â”Š   â”Š  3â”Šimport CheckCircle from '@material-ui/icons/CheckCircle'\n+â”Š   â”Š  4â”Šimport gql from 'graphql-tag'\n+â”Š   â”Š  5â”Šimport * as React from 'react'\n+â”Š   â”Š  6â”Šimport { useState } from 'react'\n+â”Š   â”Š  7â”Šimport { useQuery } from 'react-apollo-hooks'\n+â”Š   â”Š  8â”Šimport styled from 'styled-components'\n+â”Š   â”Š  9â”Šimport * as fragments from '../graphql/fragments'\n+â”Š   â”Š 10â”Šimport { UsersListQuery, User } from '../graphql/types'\n+â”Š   â”Š 11â”Š\n+â”Š   â”Š 12â”Šconst Style = styled.div`\n+â”Š   â”Š 13â”Š  .UsersList-users-list {\n+â”Š   â”Š 14â”Š    padding: 0;\n+â”Š   â”Š 15â”Š  }\n+â”Š   â”Š 16â”Š\n+â”Š   â”Š 17â”Š  .UsersList-user-item {\n+â”Š   â”Š 18â”Š    position: relative;\n+â”Š   â”Š 19â”Š    padding: 7.5px 15px;\n+â”Š   â”Š 20â”Š    display: flex;\n+â”Š   â”Š 21â”Š    ${props => props.selectable && 'cursor: pointer;'}\n+â”Š   â”Š 22â”Š  }\n+â”Š   â”Š 23â”Š\n+â”Š   â”Š 24â”Š  .UsersList-profile-pic {\n+â”Š   â”Š 25â”Š    height: 50px;\n+â”Š   â”Š 26â”Š    width: 50px;\n+â”Š   â”Š 27â”Š    object-fit: cover;\n+â”Š   â”Š 28â”Š    border-radius: 50%;\n+â”Š   â”Š 29â”Š  }\n+â”Š   â”Š 30â”Š\n+â”Š   â”Š 31â”Š  .UsersList-name {\n+â”Š   â”Š 32â”Š    padding-left: 15px;\n+â”Š   â”Š 33â”Š    font-weight: bold;\n+â”Š   â”Š 34â”Š  }\n+â”Š   â”Š 35â”Š\n+â”Š   â”Š 36â”Š  .UsersList-checkmark {\n+â”Š   â”Š 37â”Š    position: absolute;\n+â”Š   â”Š 38â”Š    left: 50px;\n+â”Š   â”Š 39â”Š    top: 35px;\n+â”Š   â”Š 40â”Š    color: var(--secondary-bg);\n+â”Š   â”Š 41â”Š    background-color: white;\n+â”Š   â”Š 42â”Š    border-radius: 50%;\n+â”Š   â”Š 43â”Š  }\n+â”Š   â”Š 44â”Š`\n+â”Š   â”Š 45â”Š\n+â”Š   â”Š 46â”Šconst query = gql`\n+â”Š   â”Š 47â”Š  query UsersListQuery {\n+â”Š   â”Š 48â”Š    users {\n+â”Š   â”Š 49â”Š      ...User\n+â”Š   â”Š 50â”Š    }\n+â”Š   â”Š 51â”Š  }\n+â”Š   â”Š 52â”Š  ${fragments.user}\n+â”Š   â”Š 53â”Š`\n+â”Š   â”Š 54â”Š\n+â”Š   â”Š 55â”Šinterface UsersListProps {\n+â”Š   â”Š 56â”Š  selectable?: boolean\n+â”Š   â”Š 57â”Š  onSelectionChange?: (users: User.Fragment[]) => void\n+â”Š   â”Š 58â”Š  onUserPick?: (user: User.Fragment) => void\n+â”Š   â”Š 59â”Š}\n+â”Š   â”Š 60â”Š\n+â”Š   â”Š 61â”Šexport default (props: UsersListProps) => {\n+â”Š   â”Š 62â”Š  const { selectable, onSelectionChange, onUserPick } = {\n+â”Š   â”Š 63â”Š    selectable: false,\n+â”Š   â”Š 64â”Š    onSelectionChange: () => {},\n+â”Š   â”Š 65â”Š    onUserPick: () => {},\n+â”Š   â”Š 66â”Š    ...props,\n+â”Š   â”Š 67â”Š  }\n+â”Š   â”Š 68â”Š\n+â”Š   â”Š 69â”Š  const [selectedUsers, setSelectedUsers] = useState([])\n+â”Š   â”Š 70â”Š  const {\n+â”Š   â”Š 71â”Š    data: { users },\n+â”Š   â”Š 72â”Š  } = useQuery<UsersListQuery.Query>(query, { suspend: true })\n+â”Š   â”Š 73â”Š\n+â”Š   â”Š 74â”Š  const onListItemClick = user => {\n+â”Š   â”Š 75â”Š    if (!selectable) {\n+â”Š   â”Š 76â”Š      return onUserPick(user)\n+â”Š   â”Š 77â”Š    }\n+â”Š   â”Š 78â”Š\n+â”Š   â”Š 79â”Š    if (selectedUsers.includes(user)) {\n+â”Š   â”Š 80â”Š      const index = selectedUsers.indexOf(user)\n+â”Š   â”Š 81â”Š      selectedUsers.splice(index, 1)\n+â”Š   â”Š 82â”Š    } else {\n+â”Š   â”Š 83â”Š      selectedUsers.push(user)\n+â”Š   â”Š 84â”Š    }\n+â”Š   â”Š 85â”Š\n+â”Š   â”Š 86â”Š    setSelectedUsers(selectedUsers)\n+â”Š   â”Š 87â”Š    onSelectionChange(selectedUsers)\n+â”Š   â”Š 88â”Š  }\n+â”Š   â”Š 89â”Š\n+â”Š   â”Š 90â”Š  return (\n+â”Š   â”Š 91â”Š    <Style className=\"UsersList\" selectable={selectable}>\n+â”Š   â”Š 92â”Š      <List className=\"UsersList-users-list\">\n+â”Š   â”Š 93â”Š        {users.map(user => (\n+â”Š   â”Š 94â”Š          <ListItem\n+â”Š   â”Š 95â”Š            className=\"UsersList-user-item\"\n+â”Š   â”Š 96â”Š            key={user.id}\n+â”Š   â”Š 97â”Š            button\n+â”Š   â”Š 98â”Š            onClick={onListItemClick.bind(null, user)}\n+â”Š   â”Š 99â”Š          >\n+â”Š   â”Š100â”Š            <img\n+â”Š   â”Š101â”Š              className=\"UsersList-profile-pic\"\n+â”Š   â”Š102â”Š              src={user.picture || '/assets/default-profile-pic.jpg'}\n+â”Š   â”Š103â”Š            />\n+â”Š   â”Š104â”Š            <div className=\"UsersList-name\">{user.name}</div>\n+â”Š   â”Š105â”Š\n+â”Š   â”Š106â”Š            {selectedUsers.includes(user) && <CheckCircle className=\"UsersList-checkmark\" />}\n+â”Š   â”Š107â”Š          </ListItem>\n+â”Š   â”Š108â”Š        ))}\n+â”Š   â”Š109â”Š      </List>\n+â”Š   â”Š110â”Š    </Style>\n+â”Š   â”Š111â”Š  )\n+â”Š   â”Š112â”Š}\n```\n\n[}]: #\n\nNow let's implement the new chat screen:\n\n[{]: <helper> (diffStep 3.2 files=\"src/components/NewChatScreen\" module=\"client\")\n\n#### [Step 3.2: Add new chat screen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/d0e8364)\n\n##### Added src&#x2F;components&#x2F;NewChatScreen&#x2F;NewChatNavbar.tsx\n```diff\n@@ -0,0 +1,39 @@\n+â”Š  â”Š 1â”Šimport Button from '@material-ui/core/Button'\n+â”Š  â”Š 2â”Šimport ArrowBackIcon from '@material-ui/icons/ArrowBack'\n+â”Š  â”Š 3â”Šimport { History } from 'history'\n+â”Š  â”Š 4â”Šimport * as React from 'react'\n+â”Š  â”Š 5â”Šimport styled from 'styled-components'\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Šconst Style = styled.div`\n+â”Š  â”Š 8â”Š  padding: 0;\n+â”Š  â”Š 9â”Š  display: flex;\n+â”Š  â”Š10â”Š  flex-direction: row;\n+â”Š  â”Š11â”Š  margin-left: -20px;\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Š  .NewChatNavbar-title {\n+â”Š  â”Š14â”Š    line-height: 56px;\n+â”Š  â”Š15â”Š  }\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š  .NewChatNavbar-back-button {\n+â”Š  â”Š18â”Š    color: var(--primary-text);\n+â”Š  â”Š19â”Š  }\n+â”Š  â”Š20â”Š`\n+â”Š  â”Š21â”Š\n+â”Š  â”Š22â”Šinterface NewChatNavbarProps {\n+â”Š  â”Š23â”Š  history: History\n+â”Š  â”Š24â”Š}\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Šexport default ({ history }: NewChatNavbarProps) => {\n+â”Š  â”Š27â”Š  const navToChats = () => {\n+â”Š  â”Š28â”Š    history.push('/chats')\n+â”Š  â”Š29â”Š  }\n+â”Š  â”Š30â”Š\n+â”Š  â”Š31â”Š  return (\n+â”Š  â”Š32â”Š    <Style className=\"NewChatNavbar\">\n+â”Š  â”Š33â”Š      <Button className=\"NewChatNavbar-back-button\" onClick={navToChats}>\n+â”Š  â”Š34â”Š        <ArrowBackIcon />\n+â”Š  â”Š35â”Š      </Button>\n+â”Š  â”Š36â”Š      <div className=\"NewChatNavbar-title\">New Chat</div>\n+â”Š  â”Š37â”Š    </Style>\n+â”Š  â”Š38â”Š  )\n+â”Š  â”Š39â”Š}\n```\n\n##### Added src&#x2F;components&#x2F;NewChatScreen&#x2F;index.tsx\n```diff\n@@ -0,0 +1,106 @@\n+â”Š   â”Š  1â”Šimport { defaultDataIdFromObject } from 'apollo-cache-inmemory'\n+â”Š   â”Š  2â”Šimport gql from 'graphql-tag'\n+â”Š   â”Š  3â”Šimport * as React from 'react'\n+â”Š   â”Š  4â”Šimport { Suspense } from 'react'\n+â”Š   â”Š  5â”Šimport { useMutation } from 'react-apollo-hooks'\n+â”Š   â”Š  6â”Šimport { RouteComponentProps } from 'react-router-dom'\n+â”Š   â”Š  7â”Šimport styled from 'styled-components'\n+â”Š   â”Š  8â”Šimport { time as uniqid } from 'uniqid'\n+â”Š   â”Š  9â”Šimport * as fragments from '../../graphql/fragments'\n+â”Š   â”Š 10â”Šimport * as queries from '../../graphql/queries'\n+â”Š   â”Š 11â”Šimport { Chats } from '../../graphql/types'\n+â”Š   â”Š 12â”Šimport { NewChatScreenMutation } from '../../graphql/types'\n+â”Š   â”Š 13â”Šimport { useMe } from '../../services/auth.service'\n+â”Š   â”Š 14â”Šimport Navbar from '../Navbar'\n+â”Š   â”Š 15â”Šimport UsersList from '../UsersList'\n+â”Š   â”Š 16â”Šimport NewChatNavbar from './NewChatNavbar'\n+â”Š   â”Š 17â”Š\n+â”Š   â”Š 18â”Šconst Style = styled.div`\n+â”Š   â”Š 19â”Š  .UsersList {\n+â”Š   â”Š 20â”Š    height: calc(100% - 56px);\n+â”Š   â”Š 21â”Š  }\n+â”Š   â”Š 22â”Š\n+â”Š   â”Š 23â”Š  .NewChatScreen-users-list {\n+â”Š   â”Š 24â”Š    height: calc(100% - 56px);\n+â”Š   â”Š 25â”Š    overflow-y: overlay;\n+â”Š   â”Š 26â”Š  }\n+â”Š   â”Š 27â”Š`\n+â”Š   â”Š 28â”Š\n+â”Š   â”Š 29â”Šconst mutation = gql`\n+â”Š   â”Š 30â”Š  mutation NewChatScreenMutation($userId: ID!) {\n+â”Š   â”Š 31â”Š    addChat(userId: $userId) {\n+â”Š   â”Š 32â”Š      ...Chat\n+â”Š   â”Š 33â”Š    }\n+â”Š   â”Š 34â”Š  }\n+â”Š   â”Š 35â”Š  ${fragments.chat}\n+â”Š   â”Š 36â”Š`\n+â”Š   â”Š 37â”Š\n+â”Š   â”Š 38â”Šexport default ({ history }: RouteComponentProps) => {\n+â”Š   â”Š 39â”Š  const me = useMe()\n+â”Š   â”Š 40â”Š\n+â”Š   â”Š 41â”Š  const addChat = useMutation<NewChatScreenMutation.Mutation, NewChatScreenMutation.Variables>(\n+â”Š   â”Š 42â”Š    mutation,\n+â”Š   â”Š 43â”Š    {\n+â”Š   â”Š 44â”Š      update: (client, { data: { addChat } }) => {\n+â”Š   â”Š 45â”Š        client.writeFragment({\n+â”Š   â”Š 46â”Š          id: defaultDataIdFromObject(addChat),\n+â”Š   â”Š 47â”Š          fragment: fragments.chat,\n+â”Š   â”Š 48â”Š          fragmentName: 'Chat',\n+â”Š   â”Š 49â”Š          data: addChat,\n+â”Š   â”Š 50â”Š        })\n+â”Š   â”Š 51â”Š\n+â”Š   â”Š 52â”Š        let chats\n+â”Š   â”Š 53â”Š        try {\n+â”Š   â”Š 54â”Š          chats = client.readQuery<Chats.Query>({\n+â”Š   â”Š 55â”Š            query: queries.chats,\n+â”Š   â”Š 56â”Š          }).chats\n+â”Š   â”Š 57â”Š        } catch (e) {}\n+â”Š   â”Š 58â”Š\n+â”Š   â”Š 59â”Š        if (chats && !chats.some(chat => chat.id === addChat.id)) {\n+â”Š   â”Š 60â”Š          chats.unshift(addChat)\n+â”Š   â”Š 61â”Š\n+â”Š   â”Š 62â”Š          client.writeQuery({\n+â”Š   â”Š 63â”Š            query: queries.chats,\n+â”Š   â”Š 64â”Š            data: { chats },\n+â”Š   â”Š 65â”Š          })\n+â”Š   â”Š 66â”Š        }\n+â”Š   â”Š 67â”Š      },\n+â”Š   â”Š 68â”Š    },\n+â”Š   â”Š 69â”Š  )\n+â”Š   â”Š 70â”Š\n+â”Š   â”Š 71â”Š  const onUserPick = user => {\n+â”Š   â”Š 72â”Š    addChat({\n+â”Š   â”Š 73â”Š      optimisticResponse: {\n+â”Š   â”Š 74â”Š        __typename: 'Mutation',\n+â”Š   â”Š 75â”Š        addChat: {\n+â”Š   â”Š 76â”Š          __typename: 'Chat',\n+â”Š   â”Š 77â”Š          id: uniqid(),\n+â”Š   â”Š 78â”Š          name: user.name,\n+â”Š   â”Š 79â”Š          picture: user.picture,\n+â”Š   â”Š 80â”Š          allTimeMembers: [],\n+â”Š   â”Š 81â”Š          owner: me,\n+â”Š   â”Š 82â”Š          isGroup: false,\n+â”Š   â”Š 83â”Š          lastMessage: null,\n+â”Š   â”Š 84â”Š        },\n+â”Š   â”Š 85â”Š      },\n+â”Š   â”Š 86â”Š      variables: {\n+â”Š   â”Š 87â”Š        userId: user.id,\n+â”Š   â”Š 88â”Š      },\n+â”Š   â”Š 89â”Š    }).then(({ data: { addChat } }) => {\n+â”Š   â”Š 90â”Š      history.push(`/chats/${addChat.id}`)\n+â”Š   â”Š 91â”Š    })\n+â”Š   â”Š 92â”Š  }\n+â”Š   â”Š 93â”Š\n+â”Š   â”Š 94â”Š  return (\n+â”Š   â”Š 95â”Š    <Style className=\"NewChatScreen Screen\">\n+â”Š   â”Š 96â”Š      <Navbar>\n+â”Š   â”Š 97â”Š        <NewChatNavbar history={history} />\n+â”Š   â”Š 98â”Š      </Navbar>\n+â”Š   â”Š 99â”Š      <div className=\"NewChatScreen-users-list\">\n+â”Š   â”Š100â”Š        <Suspense fallback={null}>\n+â”Š   â”Š101â”Š          <UsersList onUserPick={onUserPick} />\n+â”Š   â”Š102â”Š        </Suspense>\n+â”Š   â”Š103â”Š      </div>\n+â”Š   â”Š104â”Š    </Style>\n+â”Š   â”Š105â”Š  )\n+â”Š   â”Š106â”Š}\n```\n\n[}]: #\n\nAnd implement a dedicated route for it:\n\n[{]: <helper> (diffStep 3.2 files=\"src/App\" module=\"client\")\n\n#### [Step 3.2: Add new chat screen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/d0e8364)\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -1,6 +1,7 @@\n â”Š1â”Š1â”Šimport * as React from 'react'\n â”Š2â”Š2â”Šimport { BrowserRouter, Route, Redirect } from 'react-router-dom'\n â”Š3â”Š3â”Šimport ChatRoomScreen from './components/ChatRoomScreen'\n+â”Š â”Š4â”Šimport NewChatScreen from './components/NewChatScreen'\n â”Š4â”Š5â”Šimport AnimatedSwitch from './components/AnimatedSwitch'\n â”Š5â”Š6â”Šimport AuthScreen from './components/AuthScreen'\n â”Š6â”Š7â”Šimport ChatsListScreen from './components/ChatsListScreen'\n```\n```diff\n@@ -18,6 +19,7 @@\n â”Š18â”Š19â”Š      <Route exact path=\"/chats\" component={withAuth(ChatsListScreen)} />\n â”Š19â”Š20â”Š      <Route exact path=\"/settings\" component={withAuth(SettingsScreen)} />\n â”Š20â”Š21â”Š      <Route exact path=\"/chats/:chatId\" component={withAuth(ChatRoomScreen)} />\n+â”Š  â”Š22â”Š      <Route exact path=\"/new-chat\" component={withAuth(NewChatScreen)} />\n â”Š21â”Š23â”Š      <Route component={RedirectToChats} />\n â”Š22â”Š24â”Š    </AnimatedSwitch>\n â”Š23â”Š25â”Š  </BrowserRouter>\n```\n\n[}]: #\n\nWe will also add a button which will redirect us right to the new chat screen:\n\n[{]: <helper> (diffStep 3.2 files=\"src/components/ChatsListScreen\" module=\"client\")\n\n#### [Step 3.2: Add new chat screen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/d0e8364)\n\n##### Added src&#x2F;components&#x2F;ChatsListScreen&#x2F;AddChatButton.tsx\n```diff\n@@ -0,0 +1,38 @@\n+â”Š  â”Š 1â”Šimport Button from '@material-ui/core/Button'\n+â”Š  â”Š 2â”Šimport ChatIcon from '@material-ui/icons/Chat'\n+â”Š  â”Š 3â”Šimport { History } from 'history'\n+â”Š  â”Š 4â”Šimport * as React from 'react'\n+â”Š  â”Š 5â”Šimport styled from 'styled-components'\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Šconst Style = styled.div`\n+â”Š  â”Š 8â”Š  position: fixed;\n+â”Š  â”Š 9â”Š  right: 10px;\n+â”Š  â”Š10â”Š  bottom: 10px;\n+â”Š  â”Š11â”Š\n+â”Š  â”Š12â”Š  button {\n+â”Š  â”Š13â”Š    min-width: 50px;\n+â”Š  â”Š14â”Š    width: 50px;\n+â”Š  â”Š15â”Š    height: 50px;\n+â”Š  â”Š16â”Š    border-radius: 999px;\n+â”Š  â”Š17â”Š    background-color: var(--secondary-bg);\n+â”Š  â”Š18â”Š    color: white;\n+â”Š  â”Š19â”Š  }\n+â”Š  â”Š20â”Š`\n+â”Š  â”Š21â”Š\n+â”Š  â”Š22â”Šinterface AddChatButtonProps {\n+â”Š  â”Š23â”Š  history: History\n+â”Š  â”Š24â”Š}\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Šexport default ({ history }: AddChatButtonProps) => {\n+â”Š  â”Š27â”Š  const onClick = () => {\n+â”Š  â”Š28â”Š    history.push('/new-chat')\n+â”Š  â”Š29â”Š  }\n+â”Š  â”Š30â”Š\n+â”Š  â”Š31â”Š  return (\n+â”Š  â”Š32â”Š    <Style className=\"AddChatButton\">\n+â”Š  â”Š33â”Š      <Button variant=\"contained\" color=\"secondary\" onClick={onClick}>\n+â”Š  â”Š34â”Š        <ChatIcon />\n+â”Š  â”Š35â”Š      </Button>\n+â”Š  â”Š36â”Š    </Style>\n+â”Š  â”Š37â”Š  )\n+â”Š  â”Š38â”Š}\n```\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;index.tsx\n```diff\n@@ -2,6 +2,7 @@\n â”Š2â”Š2â”Šimport { Suspense } from 'react'\n â”Š3â”Š3â”Šimport { RouteComponentProps } from 'react-router-dom'\n â”Š4â”Š4â”Šimport Navbar from '../Navbar'\n+â”Š â”Š5â”Šimport AddChatButton from './AddChatButton'\n â”Š5â”Š6â”Šimport ChatsList from './ChatsList'\n â”Š6â”Š7â”Šimport ChatsNavbar from './ChatsNavbar'\n â”Š7â”Š8â”Š\n```\n```diff\n@@ -13,5 +14,6 @@\n â”Š13â”Š14â”Š    <Suspense fallback={null}>\n â”Š14â”Š15â”Š      <ChatsList history={history} />\n â”Š15â”Š16â”Š    </Suspense>\n+â”Š  â”Š17â”Š    <AddChatButton history={history} />\n â”Š16â”Š18â”Š  </div>\n â”Š17â”Š19â”Š)\n```\n\n[}]: #\n\nAgain, we will need to define the right subscriptions and update the cache accordingly:\n\n[{]: <helper> (diffStep 3.2 files=\"src/graphql/queries, src/graphql/subscriptions, src/services/cache\" module=\"client\")\n\n#### [Step 3.2: Add new chat screen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/d0e8364)\n\n##### Changed src&#x2F;graphql&#x2F;queries&#x2F;index.ts\n```diff\n@@ -1,2 +1,3 @@\n â”Š1â”Š1â”Šexport { default as chats } from './chats.query'\n+â”Š â”Š2â”Šexport { default as users } from './users.query'\n â”Š2â”Š3â”Šexport { default as me } from './me.query'\n```\n\n##### Added src&#x2F;graphql&#x2F;queries&#x2F;users.query.ts\n```diff\n@@ -0,0 +1,11 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag'\n+â”Š  â”Š 2â”Šimport * as fragments from '../fragments'\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šexport default gql `\n+â”Š  â”Š 5â”Š  query Users {\n+â”Š  â”Š 6â”Š    users {\n+â”Š  â”Š 7â”Š      ...User\n+â”Š  â”Š 8â”Š    }\n+â”Š  â”Š 9â”Š  }\n+â”Š  â”Š10â”Š  ${fragments.user}\n+â”Š  â”Š11â”Š`\n```\n\n##### Added src&#x2F;graphql&#x2F;subscriptions&#x2F;chatAdded.subscription.ts\n```diff\n@@ -0,0 +1,11 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag'\n+â”Š  â”Š 2â”Šimport * as fragments from '../fragments'\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šexport default gql `\n+â”Š  â”Š 5â”Š  subscription ChatAdded {\n+â”Š  â”Š 6â”Š    chatAdded {\n+â”Š  â”Š 7â”Š      ...Chat\n+â”Š  â”Š 8â”Š    }\n+â”Š  â”Š 9â”Š  }\n+â”Š  â”Š10â”Š  ${fragments.chat}\n+â”Š  â”Š11â”Š`\n```\n\n##### Changed src&#x2F;graphql&#x2F;subscriptions&#x2F;index.ts\n```diff\n@@ -1,2 +1,5 @@\n â”Š1â”Š1â”Šexport { default as chatUpdated } from './chatUpdated.subscription'\n â”Š2â”Š2â”Šexport { default as messageAdded } from './messageAdded.subscription'\n+â”Š â”Š3â”Šexport { default as chatAdded } from './chatAdded.subscription'\n+â”Š â”Š4â”Šexport { default as userAdded } from './userAdded.subscription'\n+â”Š â”Š5â”Šexport { default as userUpdated } from './userUpdated.subscription'\n```\n\n##### Added src&#x2F;graphql&#x2F;subscriptions&#x2F;userAdded.subscription.ts\n```diff\n@@ -0,0 +1,11 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag'\n+â”Š  â”Š 2â”Šimport * as fragments from '../fragments'\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šexport default gql `\n+â”Š  â”Š 5â”Š  subscription UserAdded {\n+â”Š  â”Š 6â”Š    userAdded {\n+â”Š  â”Š 7â”Š      ...User\n+â”Š  â”Š 8â”Š    }\n+â”Š  â”Š 9â”Š  }\n+â”Š  â”Š10â”Š  ${fragments.user}\n+â”Š  â”Š11â”Š`\n```\n\n##### Added src&#x2F;graphql&#x2F;subscriptions&#x2F;userUpdated.subscription.ts\n```diff\n@@ -0,0 +1,11 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag'\n+â”Š  â”Š 2â”Šimport * as fragments from '../fragments'\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šexport default gql `\n+â”Š  â”Š 5â”Š  subscription UserUpdated {\n+â”Š  â”Š 6â”Š    userUpdated {\n+â”Š  â”Š 7â”Š      ...User\n+â”Š  â”Š 8â”Š    }\n+â”Š  â”Š 9â”Š  }\n+â”Š  â”Š10â”Š  ${fragments.user}\n+â”Š  â”Š11â”Š`\n```\n\n##### Changed src&#x2F;services&#x2F;cache.service.tsx\n```diff\n@@ -2,10 +2,48 @@\n â”Š 2â”Š 2â”Šimport * as fragments from '../graphql/fragments'\n â”Š 3â”Š 3â”Šimport * as subscriptions from '../graphql/subscriptions'\n â”Š 4â”Š 4â”Šimport * as queries from '../graphql/queries'\n-â”Š 5â”Š  â”Šimport { ChatUpdated, MessageAdded, Message, Chats, FullChat } from '../graphql/types'\n+â”Š  â”Š 5â”Šimport {\n+â”Š  â”Š 6â”Š  ChatUpdated,\n+â”Š  â”Š 7â”Š  MessageAdded,\n+â”Š  â”Š 8â”Š  Message,\n+â”Š  â”Š 9â”Š  Chats,\n+â”Š  â”Š10â”Š  FullChat,\n+â”Š  â”Š11â”Š  User,\n+â”Š  â”Š12â”Š  Users,\n+â”Š  â”Š13â”Š  UserAdded,\n+â”Š  â”Š14â”Š  UserUpdated,\n+â”Š  â”Š15â”Š  ChatAdded,\n+â”Š  â”Š16â”Š} from '../graphql/types'\n â”Š 6â”Š17â”Šimport { useSubscription } from '../polyfills/react-apollo-hooks'\n â”Š 7â”Š18â”Š\n â”Š 8â”Š19â”Šexport const useSubscriptions = () => {\n+â”Š  â”Š20â”Š  useSubscription<ChatAdded.Subscription>(subscriptions.chatAdded, {\n+â”Š  â”Š21â”Š    onSubscriptionData: ({ client, subscriptionData: { chatAdded } }) => {\n+â”Š  â”Š22â”Š      client.writeFragment({\n+â”Š  â”Š23â”Š        id: defaultDataIdFromObject(chatAdded),\n+â”Š  â”Š24â”Š        fragment: fragments.chat,\n+â”Š  â”Š25â”Š        fragmentName: 'Chat',\n+â”Š  â”Š26â”Š        data: chatAdded,\n+â”Š  â”Š27â”Š      })\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š      let chats\n+â”Š  â”Š30â”Š      try {\n+â”Š  â”Š31â”Š        chats = client.readQuery<Chats.Query>({\n+â”Š  â”Š32â”Š          query: queries.chats,\n+â”Š  â”Š33â”Š        }).chats\n+â”Š  â”Š34â”Š      } catch (e) {}\n+â”Š  â”Š35â”Š\n+â”Š  â”Š36â”Š      if (chats && !chats.some(chat => chat.id === chatAdded.id)) {\n+â”Š  â”Š37â”Š        chats.unshift(chatAdded)\n+â”Š  â”Š38â”Š\n+â”Š  â”Š39â”Š        client.writeQuery({\n+â”Š  â”Š40â”Š          query: queries.chats,\n+â”Š  â”Š41â”Š          data: { chats },\n+â”Š  â”Š42â”Š        })\n+â”Š  â”Š43â”Š      }\n+â”Š  â”Š44â”Š    },\n+â”Š  â”Š45â”Š  })\n+â”Š  â”Š46â”Š\n â”Š 9â”Š47â”Š  useSubscription<ChatUpdated.Subscription>(subscriptions.chatUpdated, {\n â”Š10â”Š48â”Š    onSubscriptionData: ({ client, subscriptionData: { chatUpdated } }) => {\n â”Š11â”Š49â”Š      client.writeFragment({\n```\n```diff\n@@ -67,4 +105,40 @@\n â”Š 67â”Š105â”Š      }\n â”Š 68â”Š106â”Š    },\n â”Š 69â”Š107â”Š  })\n+â”Š   â”Š108â”Š\n+â”Š   â”Š109â”Š  useSubscription<UserAdded.Subscription>(subscriptions.userAdded, {\n+â”Š   â”Š110â”Š    onSubscriptionData: ({ client, subscriptionData: { userAdded } }) => {\n+â”Š   â”Š111â”Š      client.writeFragment({\n+â”Š   â”Š112â”Š        id: defaultDataIdFromObject(userAdded),\n+â”Š   â”Š113â”Š        fragment: fragments.user,\n+â”Š   â”Š114â”Š        data: userAdded,\n+â”Š   â”Š115â”Š      })\n+â”Š   â”Š116â”Š\n+â”Š   â”Š117â”Š      let users\n+â”Š   â”Š118â”Š      try {\n+â”Š   â”Š119â”Š        users = client.readQuery<Users.Query>({\n+â”Š   â”Š120â”Š          query: queries.users,\n+â”Š   â”Š121â”Š        }).users\n+â”Š   â”Š122â”Š      } catch (e) {}\n+â”Š   â”Š123â”Š\n+â”Š   â”Š124â”Š      if (users && !users.some(user => user.id === userAdded.id)) {\n+â”Š   â”Š125â”Š        users.push(userAdded)\n+â”Š   â”Š126â”Š\n+â”Š   â”Š127â”Š        client.writeQuery({\n+â”Š   â”Š128â”Š          query: queries.users,\n+â”Š   â”Š129â”Š          data: { users },\n+â”Š   â”Š130â”Š        })\n+â”Š   â”Š131â”Š      }\n+â”Š   â”Š132â”Š    },\n+â”Š   â”Š133â”Š  })\n+â”Š   â”Š134â”Š\n+â”Š   â”Š135â”Š  useSubscription<UserUpdated.Subscription>(subscriptions.userUpdated, {\n+â”Š   â”Š136â”Š    onSubscriptionData: ({ client, subscriptionData: { userUpdated } }) => {\n+â”Š   â”Š137â”Š      client.writeFragment({\n+â”Š   â”Š138â”Š        id: defaultDataIdFromObject(userUpdated),\n+â”Š   â”Š139â”Š        fragment: fragments.user,\n+â”Š   â”Š140â”Š        data: userUpdated,\n+â”Š   â”Š141â”Š      })\n+â”Š   â”Š142â”Š    },\n+â”Š   â”Š143â”Š  })\n â”Š 70â”Š144â”Š}\n```\n\n[}]: #\n\nNow we have a real, functional chat app! Where we have a complete flow of:\n\n- Signing in/up.\n- Editing profile.\n- Creating and removing chats.\n- Sending messages.\n\nIn the next step we will to something slightly more complex and extend the current functionality by adding a group chatting feature where we will be able to communicate with multiple users in a single chat room."
          },
          {
            "manualTitle": "Step 4: Bonus! Group chatting",
            "stepRevision": "6dfdb2f5ec57b959489ff220e8095ec7576d6e19",
            "manualView": "Group messaging can be quite tricky and so I would like to explain the hierarchy between the entities. `Chat` will have the following fields:\n\n- `Chat.actualGroupMembers` - The current users who are currently participating in the group. Once a message was sent by someone in the group, all the members under `actualGroupMembers` will be notified with the target message.\n\n- `Chat.listingMembers` - The current users which have the chat listed in their view. Any user who will be kicked out of the group will not only be absent from `Chat.actualGroupMembers`, but it will also be spliced from `Chat.listingMembers`, as its existence in the chat is correlated to what it can currently view.\n\n- `Chat.admins` - The users who currently control the group; they will have permissions to add and remove users from the group, and change its name and picture.\n\nTogether we can have a complete flow where users can chat with each-other in a group. In this step we will add a group-details screen, where we will be able to see the participants of the group, and we will use the existing users list component to select users that we would like to participate in our group chat. The back-end should include a new mutation called `addGroup()` that will help use create chat group.\n\nSo before we proceed to the front-end, let's take care of the back-end. We will add the missing fields to the Chat entity, and make the necessary adjustments in existing resolvers:\n\n[{]: <helper> (diffStep 4.1 module=\"server\")\n\n#### [Step 4.1: Add group-related fields to Chat type](https://github.com/Urigo/WhatsApp-Clone-Server/commit/1a1ba5e)\n\n##### Changed entity&#x2F;chat.ts\n```diff\n@@ -16,6 +16,8 @@\n â”Š16â”Š16â”Š  picture?: string\n â”Š17â”Š17â”Š  allTimeMembers?: User[]\n â”Š18â”Š18â”Š  listingMembers?: User[]\n+â”Š  â”Š19â”Š  actualGroupMembers?: User[]\n+â”Š  â”Š20â”Š  admins?: User[]\n â”Š19â”Š21â”Š  owner?: User\n â”Š20â”Š22â”Š  messages?: Message[]\n â”Š21â”Š23â”Š}\n```\n```diff\n@@ -48,6 +50,14 @@\n â”Š48â”Š50â”Š  @JoinTable()\n â”Š49â”Š51â”Š  listingMembers: User[]\n â”Š50â”Š52â”Š\n+â”Š  â”Š53â”Š  @ManyToMany(type => User, user => user.actualGroupMemberChats, { cascade: [\"insert\", \"update\"], eager: false })\n+â”Š  â”Š54â”Š  @JoinTable()\n+â”Š  â”Š55â”Š  actualGroupMembers?: User[]\n+â”Š  â”Š56â”Š\n+â”Š  â”Š57â”Š  @ManyToMany(type => User, user => user.adminChats, { cascade: [\"insert\", \"update\"], eager: false })\n+â”Š  â”Š58â”Š  @JoinTable()\n+â”Š  â”Š59â”Š  admins?: User[]\n+â”Š  â”Š60â”Š\n â”Š51â”Š61â”Š  @ManyToOne(type => User, user => user.ownerChats, { cascade: ['insert', 'update'], eager: false })\n â”Š52â”Š62â”Š  owner?: User | null\n â”Š53â”Š63â”Š\n```\n```diff\n@@ -62,6 +72,8 @@\n â”Š62â”Š72â”Š    picture,\n â”Š63â”Š73â”Š    allTimeMembers,\n â”Š64â”Š74â”Š    listingMembers,\n+â”Š  â”Š75â”Š    actualGroupMembers,\n+â”Š  â”Š76â”Š    admins,\n â”Š65â”Š77â”Š    owner,\n â”Š66â”Š78â”Š    messages,\n â”Š67â”Š79â”Š  }: ChatConstructor = {}) {\n```\n```diff\n@@ -74,6 +86,12 @@\n â”Š74â”Š86â”Š    if (allTimeMembers) {\n â”Š75â”Š87â”Š      this.allTimeMembers = allTimeMembers\n â”Š76â”Š88â”Š    }\n+â”Š  â”Š89â”Š    if (actualGroupMembers) {\n+â”Š  â”Š90â”Š      this.actualGroupMembers = actualGroupMembers\n+â”Š  â”Š91â”Š    }\n+â”Š  â”Š92â”Š    if (admins) {\n+â”Š  â”Š93â”Š      this.admins = admins\n+â”Š  â”Š94â”Š    }\n â”Š77â”Š95â”Š    if (listingMembers) {\n â”Š78â”Š96â”Š      this.listingMembers = listingMembers\n â”Š79â”Š97â”Š    }\n```\n\n##### Changed entity&#x2F;user.ts\n```diff\n@@ -33,6 +33,12 @@\n â”Š33â”Š33â”Š  @ManyToMany(type => Chat, chat => chat.listingMembers)\n â”Š34â”Š34â”Š  listingMemberChats: Chat[]\n â”Š35â”Š35â”Š\n+â”Š  â”Š36â”Š  @ManyToMany(type => Chat, chat => chat.actualGroupMembers)\n+â”Š  â”Š37â”Š  actualGroupMemberChats: Chat[]\n+â”Š  â”Š38â”Š\n+â”Š  â”Š39â”Š  @ManyToMany(type => Chat, chat => chat.admins)\n+â”Š  â”Š40â”Š  adminChats: Chat[]\n+â”Š  â”Š41â”Š\n â”Š36â”Š42â”Š  @ManyToMany(type => Message, message => message.holders)\n â”Š37â”Š43â”Š  holderMessages: Message[]\n â”Š38â”Š44â”Š\n```\n\n##### Changed modules&#x2F;chat&#x2F;providers&#x2F;chat.provider.ts\n```diff\n@@ -157,6 +157,27 @@\n â”Š157â”Š157â”Š      .getMany()\n â”Š158â”Š158â”Š  }\n â”Š159â”Š159â”Š\n+â”Š   â”Š160â”Š  getChatActualGroupMembers(chat: Chat) {\n+â”Š   â”Š161â”Š    return this.userProvider\n+â”Š   â”Š162â”Š      .createQueryBuilder()\n+â”Š   â”Š163â”Š      .innerJoin(\n+â”Š   â”Š164â”Š        'user.actualGroupMemberChats',\n+â”Š   â”Š165â”Š        'actualGroupMemberChats',\n+â”Š   â”Š166â”Š        'actualGroupMemberChats.id = :chatId',\n+â”Š   â”Š167â”Š        { chatId: chat.id },\n+â”Š   â”Š168â”Š      )\n+â”Š   â”Š169â”Š      .getMany();\n+â”Š   â”Š170â”Š  }\n+â”Š   â”Š171â”Š\n+â”Š   â”Š172â”Š  getChatAdmins(chat: Chat) {\n+â”Š   â”Š173â”Š    return this.userProvider\n+â”Š   â”Š174â”Š      .createQueryBuilder()\n+â”Š   â”Š175â”Š      .innerJoin('user.adminChats', 'adminChats', 'adminChats.id = :chatId', {\n+â”Š   â”Š176â”Š        chatId: chat.id,\n+â”Š   â”Š177â”Š      })\n+â”Š   â”Š178â”Š      .getMany();\n+â”Š   â”Š179â”Š  }\n+â”Š   â”Š180â”Š\n â”Š160â”Š181â”Š  async getChatOwner(chat: Chat) {\n â”Š161â”Š182â”Š    const owner = await this.userProvider\n â”Š162â”Š183â”Š      .createQueryBuilder()\n```\n```diff\n@@ -168,6 +189,10 @@\n â”Š168â”Š189â”Š    return owner || null\n â”Š169â”Š190â”Š  }\n â”Š170â”Š191â”Š\n+â”Š   â”Š192â”Š  async isChatGroup(chat: Chat) {\n+â”Š   â”Š193â”Š    return !!chat.name;\n+â”Š   â”Š194â”Š  }\n+â”Š   â”Š195â”Š\n â”Š171â”Š196â”Š  async filterChatAddedOrUpdated(chatAddedOrUpdated: Chat, creatorOrUpdaterId: string) {\n â”Š172â”Š197â”Š    return (\n â”Š173â”Š198â”Š      creatorOrUpdaterId !== this.currentUser.id &&\n```\n```diff\n@@ -221,6 +246,8 @@\n â”Š221â”Š246â”Š    const chat = await this.createQueryBuilder()\n â”Š222â”Š247â”Š      .whereInIds(Number(chatId))\n â”Š223â”Š248â”Š      .innerJoinAndSelect('chat.listingMembers', 'listingMembers')\n+â”Š   â”Š249â”Š      .leftJoinAndSelect('chat.actualGroupMembers', 'actualGroupMembers')\n+â”Š   â”Š250â”Š      .leftJoinAndSelect('chat.admins', 'admins')\n â”Š224â”Š251â”Š      .leftJoinAndSelect('chat.owner', 'owner')\n â”Š225â”Š252â”Š      .getOne();\n â”Š226â”Š253â”Š\n```\n```diff\n@@ -242,7 +269,18 @@\n â”Š242â”Š269â”Š        // Delete the chat\n â”Š243â”Š270â”Š        await this.repository.remove(chat);\n â”Š244â”Š271â”Š      } else {\n-â”Š245â”Š   â”Š        // Update the chat\n+â”Š   â”Š272â”Š        // Update the group\n+â”Š   â”Š273â”Š\n+â”Š   â”Š274â”Š        // Remove the current user from the chat members. He is no longer a member of the group\n+â”Š   â”Š275â”Š        chat.actualGroupMembers = chat.actualGroupMembers && chat.actualGroupMembers.filter(user =>\n+â”Š   â”Š276â”Š          user.id !== this.currentUser.id\n+â”Š   â”Š277â”Š        );\n+â”Š   â”Š278â”Š        // Remove the current user from the chat admins\n+â”Š   â”Š279â”Š        chat.admins = chat.admins && chat.admins.filter(user => user.id !== this.currentUser.id);\n+â”Š   â”Š280â”Š        // If there are no more admins left the group goes read only\n+â”Š   â”Š281â”Š        // A null owner means the group is read-only\n+â”Š   â”Š282â”Š        chat.owner = chat.admins && chat.admins[0] || null;\n+â”Š   â”Š283â”Š\n â”Š246â”Š284â”Š        await this.repository.save(chat);\n â”Š247â”Š285â”Š      }\n â”Š248â”Š286â”Š\n```\n\n##### Changed modules&#x2F;chat&#x2F;resolvers&#x2F;resolvers.ts\n```diff\n@@ -38,6 +38,9 @@\n â”Š38â”Š38â”Š      injector.get(ChatProvider).getChatAllTimeMembers(chat),\n â”Š39â”Š39â”Š    listingMembers: (chat, args, { injector }) =>\n â”Š40â”Š40â”Š      injector.get(ChatProvider).getChatListingMembers(chat),\n+â”Š  â”Š41â”Š    actualGroupMembers: (chat, args, { injector }) => injector.get(ChatProvider).getChatActualGroupMembers(chat),\n+â”Š  â”Š42â”Š    admins: (chat, args, { injector }) => injector.get(ChatProvider).getChatAdmins(chat),\n â”Š41â”Š43â”Š    owner: (chat, args, { injector }) => injector.get(ChatProvider).getChatOwner(chat),\n+â”Š  â”Š44â”Š    isGroup: (chat, args, { injector }) => injector.get(ChatProvider).isChatGroup(chat),\n â”Š42â”Š45â”Š  },\n â”Š43â”Š46â”Š} as IResolvers\n```\n\n##### Changed modules&#x2F;chat&#x2F;schema&#x2F;typeDefs.graphql\n```diff\n@@ -19,8 +19,14 @@\n â”Š19â”Š19â”Š  allTimeMembers: [User!]!\n â”Š20â”Š20â”Š  #Whoever gets the chat listed. For groups includes past members who still didn't delete the group.\n â”Š21â”Š21â”Š  listingMembers: [User!]!\n+â”Š  â”Š22â”Š  #Actual members of the group. Null for chats. For groups they are the only ones who can send messages. They aren't the only ones who get the group listed.\n+â”Š  â”Š23â”Š  actualGroupMembers: [User!]\n+â”Š  â”Š24â”Š  #Null for chats\n+â”Š  â”Š25â”Š  admins: [User!]\n â”Š22â”Š26â”Š  #If null the group is read-only. Null for chats.\n â”Š23â”Š27â”Š  owner: User\n+â”Š  â”Š28â”Š  #Computed property\n+â”Š  â”Š29â”Š  isGroup: Boolean!\n â”Š24â”Š30â”Š}\n â”Š25â”Š31â”Š\n â”Š26â”Š32â”Štype Mutation {\n```\n\n##### Changed modules&#x2F;message&#x2F;providers&#x2F;message.provider.ts\n```diff\n@@ -36,6 +36,7 @@\n â”Š36â”Š36â”Š      .whereInIds(chatId)\n â”Š37â”Š37â”Š      .innerJoinAndSelect('chat.allTimeMembers', 'allTimeMembers')\n â”Š38â”Š38â”Š      .innerJoinAndSelect('chat.listingMembers', 'listingMembers')\n+â”Š  â”Š39â”Š      .leftJoinAndSelect('chat.actualGroupMembers', 'actualGroupMembers')\n â”Š39â”Š40â”Š      .getOne();\n â”Š40â”Š41â”Š\n â”Š41â”Š42â”Š    if (!chat) {\n```\n```diff\n@@ -71,8 +72,12 @@\n â”Š71â”Š72â”Š\n â”Š72â”Š73â”Š      holders = chat.listingMembers;\n â”Š73â”Š74â”Š    } else {\n-â”Š74â”Š  â”Š      // TODO: Implement for groups\n-â”Š75â”Š  â”Š      holders = chat.listingMembers\n+â”Š  â”Š75â”Š      // Group\n+â”Š  â”Š76â”Š      if (!chat.actualGroupMembers || !chat.actualGroupMembers.find(user => user.id === this.currentUser.id)) {\n+â”Š  â”Š77â”Š        throw new Error(`The user is not a member of the group ${chatId}. Cannot add message.`);\n+â”Š  â”Š78â”Š      }\n+â”Š  â”Š79â”Š\n+â”Š  â”Š80â”Š      holders = chat.actualGroupMembers;\n â”Š76â”Š81â”Š    }\n â”Š77â”Š82â”Š\n â”Š78â”Š83â”Š    const message = await this.repository.save(new Message({\n```\n```diff\n@@ -324,15 +329,31 @@\n â”Š324â”Š329â”Š  }\n â”Š325â”Š330â”Š\n â”Š326â”Š331â”Š  async filterMessageAdded(messageAdded: Message) {\n-â”Š327â”Š   â”Š    const relevantUsers = (await this.userProvider\n-â”Š328â”Š   â”Š      .createQueryBuilder()\n-â”Š329â”Š   â”Š      .innerJoin(\n-â”Š330â”Š   â”Š        'user.listingMemberChats',\n-â”Š331â”Š   â”Š        'listingMemberChats',\n-â”Š332â”Š   â”Š        'listingMemberChats.id = :chatId',\n-â”Š333â”Š   â”Š        { chatId: messageAdded.chat.id }\n-â”Š334â”Š   â”Š      )\n-â”Š335â”Š   â”Š      .getMany()).filter(user => user.id != messageAdded.sender.id)\n+â”Š   â”Š332â”Š    let relevantUsers: User[]\n+â”Š   â”Š333â”Š\n+â”Š   â”Š334â”Š    if (!messageAdded.chat.name) {\n+â”Š   â”Š335â”Š      // Chat\n+â”Š   â”Š336â”Š      relevantUsers = (await this.userProvider\n+â”Š   â”Š337â”Š        .createQueryBuilder()\n+â”Š   â”Š338â”Š        .innerJoin(\n+â”Š   â”Š339â”Š          'user.listingMemberChats',\n+â”Š   â”Š340â”Š          'listingMemberChats',\n+â”Š   â”Š341â”Š          'listingMemberChats.id = :chatId',\n+â”Š   â”Š342â”Š          { chatId: messageAdded.chat.id }\n+â”Š   â”Š343â”Š        )\n+â”Š   â”Š344â”Š        .getMany()).filter(user => user.id != messageAdded.sender.id)\n+â”Š   â”Š345â”Š    } else {\n+â”Š   â”Š346â”Š      // Group\n+â”Š   â”Š347â”Š      relevantUsers = (await this.userProvider\n+â”Š   â”Š348â”Š        .createQueryBuilder()\n+â”Š   â”Š349â”Š        .innerJoin(\n+â”Š   â”Š350â”Š          'user.actualGroupMemberChats',\n+â”Š   â”Š351â”Š          'actualGroupMemberChats',\n+â”Š   â”Š352â”Š          'actualGroupMemberChats.id = :chatId',\n+â”Š   â”Š353â”Š          { chatId: messageAdded.chat.id }\n+â”Š   â”Š354â”Š        )\n+â”Š   â”Š355â”Š        .getMany()).filter(user => user.id != messageAdded.sender.id)\n+â”Š   â”Š356â”Š    }\n â”Š336â”Š357â”Š\n â”Š337â”Š358â”Š    return relevantUsers.some(user => user.id === this.currentUser.id)\n â”Š338â”Š359â”Š  }\n```\n\n[}]: #\n\nNow we will add 2 new mutations:\n\n- `addGroup` mutation - Responsible for creating chat groups.\n- `updateChat` mutation - Unlike a single chat which is synced with a user's info, a group chat will be independent, therefore we will need a method that could updated its fields.\n\nLet's implement those:\n\n[{]: <helper> (diffStep 4.2 module=\"server\")\n\n#### [Step 4.2: Add group related mutations](https://github.com/Urigo/WhatsApp-Clone-Server/commit/d94a68a)\n\n##### Changed modules&#x2F;chat&#x2F;providers&#x2F;chat.provider.ts\n```diff\n@@ -305,4 +305,80 @@\n â”Š305â”Š305â”Š      return chatId;\n â”Š306â”Š306â”Š    }\n â”Š307â”Š307â”Š  }\n+â”Š   â”Š308â”Š\n+â”Š   â”Š309â”Š  async addGroup(\n+â”Š   â”Š310â”Š    userIds: string[],\n+â”Š   â”Š311â”Š    {\n+â”Š   â”Š312â”Š      groupName,\n+â”Š   â”Š313â”Š      groupPicture,\n+â”Š   â”Š314â”Š    }: {\n+â”Š   â”Š315â”Š      groupName?: string\n+â”Š   â”Š316â”Š      groupPicture?: string\n+â”Š   â”Š317â”Š    } = {},\n+â”Š   â”Š318â”Š  ) {\n+â”Š   â”Š319â”Š    let users: User[] = [];\n+â”Š   â”Š320â”Š    for (let userId of userIds) {\n+â”Š   â”Š321â”Š      const user = await this.userProvider\n+â”Š   â”Š322â”Š        .createQueryBuilder()\n+â”Š   â”Š323â”Š        .whereInIds(userId)\n+â”Š   â”Š324â”Š        .getOne();\n+â”Š   â”Š325â”Š\n+â”Š   â”Š326â”Š      if (!user) {\n+â”Š   â”Š327â”Š        throw new Error(`User ${userId} doesn't exist.`);\n+â”Š   â”Š328â”Š      }\n+â”Š   â”Š329â”Š\n+â”Š   â”Š330â”Š      users.push(user);\n+â”Š   â”Š331â”Š    }\n+â”Š   â”Š332â”Š\n+â”Š   â”Š333â”Š    const chat = await this.repository.save(\n+â”Š   â”Š334â”Š      new Chat({\n+â”Š   â”Š335â”Š        name: groupName,\n+â”Š   â”Š336â”Š        admins: [this.currentUser],\n+â”Š   â”Š337â”Š        picture: groupPicture || undefined,\n+â”Š   â”Š338â”Š        owner: this.currentUser,\n+â”Š   â”Š339â”Š        allTimeMembers: [...users, this.currentUser],\n+â”Š   â”Š340â”Š        listingMembers: [...users, this.currentUser],\n+â”Š   â”Š341â”Š        actualGroupMembers: [...users, this.currentUser],\n+â”Š   â”Š342â”Š      }),\n+â”Š   â”Š343â”Š    );\n+â”Š   â”Š344â”Š\n+â”Š   â”Š345â”Š    this.pubsub.publish('chatAdded', {\n+â”Š   â”Š346â”Š      creatorId: this.currentUser.id,\n+â”Š   â”Š347â”Š      chatAdded: chat,\n+â”Š   â”Š348â”Š    });\n+â”Š   â”Š349â”Š\n+â”Š   â”Š350â”Š    return chat || null;\n+â”Š   â”Š351â”Š  }\n+â”Š   â”Š352â”Š\n+â”Š   â”Š353â”Š  async updateChat(\n+â”Š   â”Š354â”Š    chatId: string,\n+â”Š   â”Š355â”Š    {\n+â”Š   â”Š356â”Š      name,\n+â”Š   â”Š357â”Š      picture,\n+â”Š   â”Š358â”Š    }: {\n+â”Š   â”Š359â”Š      name?: string\n+â”Š   â”Š360â”Š      picture?: string\n+â”Š   â”Š361â”Š    } = {},\n+â”Š   â”Š362â”Š  ) {\n+â”Š   â”Š363â”Š    const chat = await this.createQueryBuilder()\n+â”Š   â”Š364â”Š      .whereInIds(chatId)\n+â”Š   â”Š365â”Š      .getOne();\n+â”Š   â”Š366â”Š\n+â”Š   â”Š367â”Š    if (!chat) return null;\n+â”Š   â”Š368â”Š    if (!chat.name) return chat;\n+â”Š   â”Š369â”Š\n+â”Š   â”Š370â”Š    name = name || chat.name;\n+â”Š   â”Š371â”Š    picture = picture || chat.picture;\n+â”Š   â”Š372â”Š    Object.assign(chat, { name, picture });\n+â”Š   â”Š373â”Š\n+â”Š   â”Š374â”Š    // Update the chat\n+â”Š   â”Š375â”Š    await this.repository.save(chat);\n+â”Š   â”Š376â”Š\n+â”Š   â”Š377â”Š    this.pubsub.publish('chatUpdated', {\n+â”Š   â”Š378â”Š      updaterId: this.currentUser.id,\n+â”Š   â”Š379â”Š      chatUpdated: chat,\n+â”Š   â”Š380â”Š    });\n+â”Š   â”Š381â”Š\n+â”Š   â”Š382â”Š    return chat || null;\n+â”Š   â”Š383â”Š  }\n â”Š308â”Š384â”Š}\n```\n\n##### Changed modules&#x2F;chat&#x2F;resolvers&#x2F;resolvers.ts\n```diff\n@@ -16,6 +16,15 @@\n â”Š16â”Š16â”Š    }),\n â”Š17â”Š17â”Š    addChat: (obj, { userId }, { injector }) => injector.get(ChatProvider).addChat(userId),\n â”Š18â”Š18â”Š    removeChat: (obj, { chatId }, { injector }) => injector.get(ChatProvider).removeChat(chatId),\n+â”Š  â”Š19â”Š    addGroup: (obj, { userIds, groupName, groupPicture }, { injector }) =>\n+â”Š  â”Š20â”Š      injector.get(ChatProvider).addGroup(userIds, {\n+â”Š  â”Š21â”Š        groupName: groupName || '',\n+â”Š  â”Š22â”Š        groupPicture: groupPicture || '',\n+â”Š  â”Š23â”Š      }),\n+â”Š  â”Š24â”Š    updateChat: (obj, { chatId, name, picture }, { injector }) => injector.get(ChatProvider).updateChat(chatId, {\n+â”Š  â”Š25â”Š      name: name || '',\n+â”Š  â”Š26â”Š      picture: picture || '',\n+â”Š  â”Š27â”Š    }),\n â”Š19â”Š28â”Š  },\n â”Š20â”Š29â”Š  Subscription: {\n â”Š21â”Š30â”Š    chatAdded: {\n```\n\n##### Changed modules&#x2F;chat&#x2F;schema&#x2F;typeDefs.graphql\n```diff\n@@ -32,4 +32,10 @@\n â”Š32â”Š32â”Štype Mutation {\n â”Š33â”Š33â”Š  addChat(userId: ID!): Chat\n â”Š34â”Š34â”Š  removeChat(chatId: ID!): ID\n+â”Š  â”Š35â”Š  addAdmins(groupId: ID!, userIds: [ID!]!): [ID]!\n+â”Š  â”Š36â”Š  removeAdmins(groupId: ID!, userIds: [ID!]!): [ID]!\n+â”Š  â”Š37â”Š  addMembers(groupId: ID!, userIds: [ID!]!): [ID]!\n+â”Š  â”Š38â”Š  removeMembers(groupId: ID!, userIds: [ID!]!): [ID]!\n+â”Š  â”Š39â”Š  addGroup(userIds: [ID!]!, groupName: String!, groupPicture: String): Chat\n+â”Š  â”Š40â”Š  updateChat(chatId: ID!, name: String, picture: String): Chat\n â”Š35â”Š41â”Š}\n```\n\n[}]: #\n\nNow that the back-end is set, we will need to update the chat fragment in the client to contain the new field `isGroup`:\n\n[{]: <helper> (diffStep 4.1 module=\"client\")\n\n#### [Step 4.1: Update chat fragment](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/f33f04b)\n\n##### Changed src&#x2F;graphql&#x2F;fragments&#x2F;chat.fragment.ts\n```diff\n@@ -17,6 +17,7 @@\n â”Š17â”Š17â”Š    lastMessage {\n â”Š18â”Š18â”Š      ...Message\n â”Š19â”Š19â”Š    }\n+â”Š  â”Š20â”Š    isGroup\n â”Š20â”Š21â”Š  }\n â”Š21â”Š22â”Š  ${message}\n â”Š22â”Š23â”Š`\n```\n\n[}]: #\n\nNow we will create the new-group screen. Like the new-chat screen, it will have an almost identical layout, only the behavior is gonna be slightly different. In the new screen we will be able to select multiple users before we proceed, then, we should be able to view the group details and edit them before we create the group. Let's implement the new-group screen:\n\n[{]: <helper> (diffStep 4.2 files=\"src/components/NewGroupScreen\" module=\"client\")\n\n#### [Step 4.2: Add new group screen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/90f5f5b)\n\n##### Added src&#x2F;components&#x2F;NewGroupScreen&#x2F;CreateGroupButton.tsx\n```diff\n@@ -0,0 +1,42 @@\n+â”Š  â”Š 1â”Šimport Button from '@material-ui/core/Button'\n+â”Š  â”Š 2â”Šimport AddIcon from '@material-ui/icons/Add'\n+â”Š  â”Š 3â”Šimport { History } from 'history'\n+â”Š  â”Š 4â”Šimport * as React from 'react'\n+â”Š  â”Š 5â”Šimport styled from 'styled-components'\n+â”Š  â”Š 6â”Šimport { User } from '../../graphql/types'\n+â”Š  â”Š 7â”Š\n+â”Š  â”Š 8â”Šconst Style = styled.div`\n+â”Š  â”Š 9â”Š  position: fixed;\n+â”Š  â”Š10â”Š  right: 10px;\n+â”Š  â”Š11â”Š  bottom: 10px;\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Š  button {\n+â”Š  â”Š14â”Š    min-width: 50px;\n+â”Š  â”Š15â”Š    width: 50px;\n+â”Š  â”Š16â”Š    height: 50px;\n+â”Š  â”Š17â”Š    border-radius: 999px;\n+â”Š  â”Š18â”Š    background-color: var(--secondary-bg);\n+â”Š  â”Š19â”Š    color: white;\n+â”Š  â”Š20â”Š  }\n+â”Š  â”Š21â”Š`\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Šinterface CreateGroupButtonProps {\n+â”Š  â”Š24â”Š  history: History\n+â”Š  â”Š25â”Š  users: User.Fragment[]\n+â”Š  â”Š26â”Š}\n+â”Š  â”Š27â”Š\n+â”Š  â”Š28â”Šexport default ({ history, users }: CreateGroupButtonProps) => {\n+â”Š  â”Š29â”Š  const onClick = () => {\n+â”Š  â”Š30â”Š    history.push('/new-chat/group/details', {\n+â”Š  â”Š31â”Š      users,\n+â”Š  â”Š32â”Š    })\n+â”Š  â”Š33â”Š  }\n+â”Š  â”Š34â”Š\n+â”Š  â”Š35â”Š  return (\n+â”Š  â”Š36â”Š    <Style className=\"CreateGroupButton\">\n+â”Š  â”Š37â”Š      <Button variant=\"contained\" color=\"secondary\" onClick={onClick}>\n+â”Š  â”Š38â”Š        <AddIcon />\n+â”Š  â”Š39â”Š      </Button>\n+â”Š  â”Š40â”Š    </Style>\n+â”Š  â”Š41â”Š  )\n+â”Š  â”Š42â”Š}\n```\n\n##### Added src&#x2F;components&#x2F;NewGroupScreen&#x2F;NewGroupNavbar.tsx\n```diff\n@@ -0,0 +1,39 @@\n+â”Š  â”Š 1â”Šimport Button from '@material-ui/core/Button'\n+â”Š  â”Š 2â”Šimport ArrowBackIcon from '@material-ui/icons/ArrowBack'\n+â”Š  â”Š 3â”Šimport { History } from 'history'\n+â”Š  â”Š 4â”Šimport * as React from 'react'\n+â”Š  â”Š 5â”Šimport styled from 'styled-components'\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Šconst Style = styled.div`\n+â”Š  â”Š 8â”Š  padding: 0;\n+â”Š  â”Š 9â”Š  display: flex;\n+â”Š  â”Š10â”Š  flex-direction: row;\n+â”Š  â”Š11â”Š  margin-left: -20px;\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Š  .NewGroupNavbar-title {\n+â”Š  â”Š14â”Š    line-height: 56px;\n+â”Š  â”Š15â”Š  }\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š  .NewGroupNavbar-back-button {\n+â”Š  â”Š18â”Š    color: var(--primary-text);\n+â”Š  â”Š19â”Š  }\n+â”Š  â”Š20â”Š`\n+â”Š  â”Š21â”Š\n+â”Š  â”Š22â”Šinterface NewGroupNavbarProps {\n+â”Š  â”Š23â”Š  history: History\n+â”Š  â”Š24â”Š}\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Šexport default ({ history }: NewGroupNavbarProps) => {\n+â”Š  â”Š27â”Š  const navToChats = () => {\n+â”Š  â”Š28â”Š    history.push('/new-chat')\n+â”Š  â”Š29â”Š  }\n+â”Š  â”Š30â”Š\n+â”Š  â”Š31â”Š  return (\n+â”Š  â”Š32â”Š    <Style className=\"NewGroupNavbar\">\n+â”Š  â”Š33â”Š      <Button className=\"NewGroupNavbar-back-button\" onClick={navToChats}>\n+â”Š  â”Š34â”Š        <ArrowBackIcon />\n+â”Š  â”Š35â”Š      </Button>\n+â”Š  â”Š36â”Š      <div className=\"NewGroupNavbar-title\">New Chat Group</div>\n+â”Š  â”Š37â”Š    </Style>\n+â”Š  â”Š38â”Š  )\n+â”Š  â”Š39â”Š}\n```\n\n##### Added src&#x2F;components&#x2F;NewGroupScreen&#x2F;index.tsx\n```diff\n@@ -0,0 +1,32 @@\n+â”Š  â”Š 1â”Šimport * as React from 'react'\n+â”Š  â”Š 2â”Šimport { useState, Suspense } from 'react'\n+â”Š  â”Š 3â”Šimport { RouteComponentProps } from 'react-router-dom'\n+â”Š  â”Š 4â”Šimport styled from 'styled-components'\n+â”Š  â”Š 5â”Šimport Navbar from '../Navbar'\n+â”Š  â”Š 6â”Šimport UsersList from '../UsersList'\n+â”Š  â”Š 7â”Šimport CreateGroupButton from './CreateGroupButton'\n+â”Š  â”Š 8â”Šimport NewGroupNavbar from './NewGroupNavbar'\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Šconst Style = styled.div`\n+â”Š  â”Š11â”Š  .UsersList {\n+â”Š  â”Š12â”Š    height: calc(100% - 56px);\n+â”Š  â”Š13â”Š    overflow-y: overlay;\n+â”Š  â”Š14â”Š  }\n+â”Š  â”Š15â”Š`\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Šexport default ({ history }: RouteComponentProps) => {\n+â”Š  â”Š18â”Š  const [selectedUsers, setSelectedUsers] = useState([])\n+â”Š  â”Š19â”Š\n+â”Š  â”Š20â”Š  return (\n+â”Š  â”Š21â”Š    <Style className=\"NewGroupScreen Screen\">\n+â”Š  â”Š22â”Š      <Navbar>\n+â”Š  â”Š23â”Š        <NewGroupNavbar history={history} />\n+â”Š  â”Š24â”Š      </Navbar>\n+â”Š  â”Š25â”Š      <Suspense fallback={null}>\n+â”Š  â”Š26â”Š        <UsersList selectable onSelectionChange={setSelectedUsers} />\n+â”Š  â”Š27â”Š      </Suspense>\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š      {!!selectedUsers.length && <CreateGroupButton history={history} users={selectedUsers} />}\n+â”Š  â”Š30â”Š    </Style>\n+â”Š  â”Š31â”Š  )\n+â”Š  â”Š32â”Š}\n```\n\n[}]: #\n\nNow we will add a dedicated route, and we will also create a \"New Group\" button which will be presented in the new chat screen. This way we can create a new group from the new chat screen if we want to, by simply clicking on that button and moving on to the new group screen.\n\n[{]: <helper> (diffStep 4.2 files=\"src/App, src/components/NewChatScreen\" module=\"client\")\n\n#### [Step 4.2: Add new group screen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/90f5f5b)\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -6,6 +6,7 @@\n â”Š 6â”Š 6â”Šimport AuthScreen from './components/AuthScreen'\n â”Š 7â”Š 7â”Šimport ChatsListScreen from './components/ChatsListScreen'\n â”Š 8â”Š 8â”Šimport SettingsScreen from './components/SettingsScreen'\n+â”Š  â”Š 9â”Šimport NewGroupScreen from './components/NewGroupScreen'\n â”Š 9â”Š10â”Šimport { withAuth } from './services/auth.service'\n â”Š10â”Š11â”Š\n â”Š11â”Š12â”Šconst RedirectToChats = () => (\n```\n```diff\n@@ -20,6 +21,7 @@\n â”Š20â”Š21â”Š      <Route exact path=\"/settings\" component={withAuth(SettingsScreen)} />\n â”Š21â”Š22â”Š      <Route exact path=\"/chats/:chatId\" component={withAuth(ChatRoomScreen)} />\n â”Š22â”Š23â”Š      <Route exact path=\"/new-chat\" component={withAuth(NewChatScreen)} />\n+â”Š  â”Š24â”Š      <Route exact path=\"/new-chat/group\" component={withAuth(NewGroupScreen)} />\n â”Š23â”Š25â”Š      <Route component={RedirectToChats} />\n â”Š24â”Š26â”Š    </AnimatedSwitch>\n â”Š25â”Š27â”Š  </BrowserRouter>\n```\n\n##### Added src&#x2F;components&#x2F;NewChatScreen&#x2F;NewGroupButton.tsx\n```diff\n@@ -0,0 +1,59 @@\n+â”Š  â”Š 1â”Šimport Button from '@material-ui/core/Button'\n+â”Š  â”Š 2â”Šimport GroupAddIcon from '@material-ui/icons/GroupAdd'\n+â”Š  â”Š 3â”Šimport { History } from 'history'\n+â”Š  â”Š 4â”Šimport * as React from 'react'\n+â”Š  â”Š 5â”Šimport styled from 'styled-components'\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Šconst Style = styled.div`\n+â”Š  â”Š 8â”Š  display: flex;\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Š  button {\n+â”Š  â”Š11â”Š    border-radius: 0;\n+â”Š  â”Š12â”Š    text-transform: none;\n+â”Š  â”Š13â”Š    font-size: inherit;\n+â”Š  â”Š14â”Š    width: 100%;\n+â”Š  â”Š15â”Š    justify-content: flex-start;\n+â”Š  â”Š16â”Š    padding-left: 15px;\n+â”Š  â”Š17â”Š    padding-right: 15px;\n+â”Š  â”Š18â”Š\n+â”Š  â”Š19â”Š    svg {\n+â”Š  â”Š20â”Š      font-size: 30px;\n+â”Š  â”Š21â”Š      margin-top: 10px;\n+â”Š  â”Š22â”Š    }\n+â”Š  â”Š23â”Š  }\n+â”Š  â”Š24â”Š\n+â”Š  â”Š25â”Š  .NewGroupButton-icon {\n+â”Š  â”Š26â”Š    height: 50px;\n+â”Š  â”Š27â”Š    width: 50px;\n+â”Š  â”Š28â”Š    object-fit: cover;\n+â”Š  â”Š29â”Š    border-radius: 50%;\n+â”Š  â”Š30â”Š    color: white;\n+â”Š  â”Š31â”Š    background-color: var(--secondary-bg);\n+â”Š  â”Š32â”Š  }\n+â”Š  â”Š33â”Š\n+â”Š  â”Š34â”Š  .NewGroupButton-title {\n+â”Š  â”Š35â”Š    padding-left: 15px;\n+â”Š  â”Š36â”Š    font-weight: bold;\n+â”Š  â”Š37â”Š  }\n+â”Š  â”Š38â”Š`\n+â”Š  â”Š39â”Š\n+â”Š  â”Š40â”Šinterface NewGroupButtonProps {\n+â”Š  â”Š41â”Š  history: History\n+â”Š  â”Š42â”Š}\n+â”Š  â”Š43â”Š\n+â”Š  â”Š44â”Šexport default ({ history }: NewGroupButtonProps) => {\n+â”Š  â”Š45â”Š  const navToGroup = () => {\n+â”Š  â”Š46â”Š    history.push('/new-chat/group')\n+â”Š  â”Š47â”Š  }\n+â”Š  â”Š48â”Š\n+â”Š  â”Š49â”Š  return (\n+â”Š  â”Š50â”Š    <Style>\n+â”Š  â”Š51â”Š      <Button onClick={navToGroup}>\n+â”Š  â”Š52â”Š        <div className=\"NewGroupButton-icon\">\n+â”Š  â”Š53â”Š          <GroupAddIcon />\n+â”Š  â”Š54â”Š        </div>\n+â”Š  â”Š55â”Š        <div className=\"NewGroupButton-title\">New Group</div>\n+â”Š  â”Š56â”Š      </Button>\n+â”Š  â”Š57â”Š    </Style>\n+â”Š  â”Š58â”Š  )\n+â”Š  â”Š59â”Š}\n```\n\n##### Changed src&#x2F;components&#x2F;NewChatScreen&#x2F;index.tsx\n```diff\n@@ -14,6 +14,7 @@\n â”Š14â”Š14â”Šimport Navbar from '../Navbar'\n â”Š15â”Š15â”Šimport UsersList from '../UsersList'\n â”Š16â”Š16â”Šimport NewChatNavbar from './NewChatNavbar'\n+â”Š  â”Š17â”Šimport NewGroupButton from './NewGroupButton'\n â”Š17â”Š18â”Š\n â”Š18â”Š19â”Šconst Style = styled.div`\n â”Š19â”Š20â”Š  .UsersList {\n```\n```diff\n@@ -97,6 +98,7 @@\n â”Š 97â”Š 98â”Š        <NewChatNavbar history={history} />\n â”Š 98â”Š 99â”Š      </Navbar>\n â”Š 99â”Š100â”Š      <div className=\"NewChatScreen-users-list\">\n+â”Š   â”Š101â”Š        <NewGroupButton history={history} />\n â”Š100â”Š102â”Š        <Suspense fallback={null}>\n â”Š101â”Š103â”Š          <UsersList onUserPick={onUserPick} />\n â”Š102â”Š104â”Š        </Suspense>\n```\n\n[}]: #\n\nUp-next would be the group details screen. The layout consists of:\n\n- A navbar with a back button.\n- Picture and name inputs.\n- A horizontal list of all the participants.\n- A \"complete\" button that will send a mutation request to the server.\n\nOnce a name has been typed, the \"complete\" button should pop-up. Let's implement the screen then:\n\n[{]: <helper> (diffStep 4.3 files=\"src/components/GroupDetailsScreen\" module=\"client\")\n\n#### [Step 4.3: Add group details screen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/b9b7c3f)\n\n##### Added src&#x2F;components&#x2F;GroupDetailsScreen&#x2F;CompleteGroupButton.tsx\n```diff\n@@ -0,0 +1,114 @@\n+â”Š   â”Š  1â”Šimport Button from '@material-ui/core/Button'\n+â”Š   â”Š  2â”Šimport ArrowRightIcon from '@material-ui/icons/ArrowRightAlt'\n+â”Š   â”Š  3â”Šimport { defaultDataIdFromObject } from 'apollo-cache-inmemory'\n+â”Š   â”Š  4â”Šimport gql from 'graphql-tag'\n+â”Š   â”Š  5â”Šimport { History } from 'history'\n+â”Š   â”Š  6â”Šimport * as React from 'react'\n+â”Š   â”Š  7â”Šimport { useMutation } from 'react-apollo-hooks'\n+â”Š   â”Š  8â”Šimport styled from 'styled-components'\n+â”Š   â”Š  9â”Šimport { time as uniqid } from 'uniqid'\n+â”Š   â”Š 10â”Šimport * as fragments from '../../graphql/fragments'\n+â”Š   â”Š 11â”Šimport * as queries from '../../graphql/queries'\n+â”Š   â”Š 12â”Šimport { Chats, User, CompleteGroupButtonMutation } from '../../graphql/types'\n+â”Š   â”Š 13â”Šimport { useMe } from '../../services/auth.service'\n+â”Š   â”Š 14â”Š\n+â”Š   â”Š 15â”Šconst Style = styled.div`\n+â”Š   â”Š 16â”Š  position: fixed;\n+â”Š   â”Š 17â”Š  right: 10px;\n+â”Š   â”Š 18â”Š  bottom: 10px;\n+â”Š   â”Š 19â”Š\n+â”Š   â”Š 20â”Š  button {\n+â”Š   â”Š 21â”Š    min-width: 50px;\n+â”Š   â”Š 22â”Š    width: 50px;\n+â”Š   â”Š 23â”Š    height: 50px;\n+â”Š   â”Š 24â”Š    border-radius: 999px;\n+â”Š   â”Š 25â”Š    background-color: var(--secondary-bg);\n+â”Š   â”Š 26â”Š    color: white;\n+â”Š   â”Š 27â”Š  }\n+â”Š   â”Š 28â”Š`\n+â”Š   â”Š 29â”Š\n+â”Š   â”Š 30â”Šconst mutation = gql`\n+â”Š   â”Š 31â”Š  mutation CompleteGroupButtonMutation(\n+â”Š   â”Š 32â”Š    $userIds: [ID!]!\n+â”Š   â”Š 33â”Š    $groupName: String!\n+â”Š   â”Š 34â”Š    $groupPicture: String\n+â”Š   â”Š 35â”Š  ) {\n+â”Š   â”Š 36â”Š    addGroup(userIds: $userIds, groupName: $groupName, groupPicture: $groupPicture) {\n+â”Š   â”Š 37â”Š      ...Chat\n+â”Š   â”Š 38â”Š    }\n+â”Š   â”Š 39â”Š  }\n+â”Š   â”Š 40â”Š  ${fragments.chat}\n+â”Š   â”Š 41â”Š`\n+â”Š   â”Š 42â”Š\n+â”Š   â”Š 43â”Šinterface CompleteGroupButtonProps {\n+â”Š   â”Š 44â”Š  history: History\n+â”Š   â”Š 45â”Š  users: User.Fragment[]\n+â”Š   â”Š 46â”Š  groupName: string\n+â”Š   â”Š 47â”Š  groupPicture: string\n+â”Š   â”Š 48â”Š}\n+â”Š   â”Š 49â”Š\n+â”Š   â”Š 50â”Šexport default ({ history, users, groupName, groupPicture }: CompleteGroupButtonProps) => {\n+â”Š   â”Š 51â”Š  const me = useMe()\n+â”Š   â”Š 52â”Š\n+â”Š   â”Š 53â”Š  const addGroup = useMutation<\n+â”Š   â”Š 54â”Š    CompleteGroupButtonMutation.Mutation,\n+â”Š   â”Š 55â”Š    CompleteGroupButtonMutation.Variables\n+â”Š   â”Š 56â”Š  >(mutation, {\n+â”Š   â”Š 57â”Š    optimisticResponse: {\n+â”Š   â”Š 58â”Š      __typename: 'Mutation',\n+â”Š   â”Š 59â”Š      addGroup: {\n+â”Š   â”Š 60â”Š        __typename: 'Chat',\n+â”Š   â”Š 61â”Š        id: uniqid(),\n+â”Š   â”Š 62â”Š        name: groupName,\n+â”Š   â”Š 63â”Š        picture: groupPicture,\n+â”Š   â”Š 64â”Š        allTimeMembers: users,\n+â”Š   â”Š 65â”Š        owner: me,\n+â”Š   â”Š 66â”Š        isGroup: true,\n+â”Š   â”Š 67â”Š        lastMessage: null,\n+â”Š   â”Š 68â”Š      },\n+â”Š   â”Š 69â”Š    },\n+â”Š   â”Š 70â”Š    variables: {\n+â”Š   â”Š 71â”Š      userIds: users.map(user => user.id),\n+â”Š   â”Š 72â”Š      groupName,\n+â”Š   â”Š 73â”Š      groupPicture,\n+â”Š   â”Š 74â”Š    },\n+â”Š   â”Š 75â”Š    update: (client, { data: { addGroup } }) => {\n+â”Š   â”Š 76â”Š      client.writeFragment({\n+â”Š   â”Š 77â”Š        id: defaultDataIdFromObject(addGroup),\n+â”Š   â”Š 78â”Š        fragment: fragments.chat,\n+â”Š   â”Š 79â”Š        fragmentName: 'Chat',\n+â”Š   â”Š 80â”Š        data: addGroup,\n+â”Š   â”Š 81â”Š      })\n+â”Š   â”Š 82â”Š\n+â”Š   â”Š 83â”Š      let chats\n+â”Š   â”Š 84â”Š      try {\n+â”Š   â”Š 85â”Š        chats = client.readQuery<Chats.Query>({\n+â”Š   â”Š 86â”Š          query: queries.chats,\n+â”Š   â”Š 87â”Š        }).chats\n+â”Š   â”Š 88â”Š      } catch (e) {}\n+â”Š   â”Š 89â”Š\n+â”Š   â”Š 90â”Š      if (chats && !chats.some(chat => chat.id === addGroup.id)) {\n+â”Š   â”Š 91â”Š        chats.unshift(addGroup)\n+â”Š   â”Š 92â”Š\n+â”Š   â”Š 93â”Š        client.writeQuery({\n+â”Š   â”Š 94â”Š          query: queries.chats,\n+â”Š   â”Š 95â”Š          data: { chats },\n+â”Š   â”Š 96â”Š        })\n+â”Š   â”Š 97â”Š      }\n+â”Š   â”Š 98â”Š    },\n+â”Š   â”Š 99â”Š  })\n+â”Š   â”Š100â”Š\n+â”Š   â”Š101â”Š  const onClick = () => {\n+â”Š   â”Š102â”Š    addGroup().then(({ data: { addGroup } }) => {\n+â”Š   â”Š103â”Š      history.push(`/chats/${addGroup.id}`)\n+â”Š   â”Š104â”Š    })\n+â”Š   â”Š105â”Š  }\n+â”Š   â”Š106â”Š\n+â”Š   â”Š107â”Š  return (\n+â”Š   â”Š108â”Š    <Style className=\"CompleteGroupButton\">\n+â”Š   â”Š109â”Š      <Button variant=\"contained\" color=\"secondary\" onClick={onClick}>\n+â”Š   â”Š110â”Š        <ArrowRightIcon />\n+â”Š   â”Š111â”Š      </Button>\n+â”Š   â”Š112â”Š    </Style>\n+â”Š   â”Š113â”Š  )\n+â”Š   â”Š114â”Š}\n```\n\n##### Added src&#x2F;components&#x2F;GroupDetailsScreen&#x2F;GroupDetailsNavbar.tsx\n```diff\n@@ -0,0 +1,39 @@\n+â”Š  â”Š 1â”Šimport Button from '@material-ui/core/Button'\n+â”Š  â”Š 2â”Šimport ArrowBackIcon from '@material-ui/icons/ArrowBack'\n+â”Š  â”Š 3â”Šimport { History } from 'history'\n+â”Š  â”Š 4â”Šimport * as React from 'react'\n+â”Š  â”Š 5â”Šimport styled from 'styled-components'\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Šconst Style = styled.div`\n+â”Š  â”Š 8â”Š  padding: 0;\n+â”Š  â”Š 9â”Š  display: flex;\n+â”Š  â”Š10â”Š  flex-direction: row;\n+â”Š  â”Š11â”Š  margin-left: -20px;\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Š  .GroupDetailsNavbar-title {\n+â”Š  â”Š14â”Š    line-height: 56px;\n+â”Š  â”Š15â”Š  }\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š  .GroupDetailsNavbar-back-button {\n+â”Š  â”Š18â”Š    color: var(--primary-text);\n+â”Š  â”Š19â”Š  }\n+â”Š  â”Š20â”Š`\n+â”Š  â”Š21â”Š\n+â”Š  â”Š22â”Šinterface GroupDetailsNavbarProps {\n+â”Š  â”Š23â”Š  history: History\n+â”Š  â”Š24â”Š}\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Šexport default ({ history }: GroupDetailsNavbarProps) => {\n+â”Š  â”Š27â”Š  const navToNewGroup = () => {\n+â”Š  â”Š28â”Š    history.push('/new-chat/group')\n+â”Š  â”Š29â”Š  }\n+â”Š  â”Š30â”Š\n+â”Š  â”Š31â”Š  return (\n+â”Š  â”Š32â”Š    <Style className=\"GroupDetailsNavbar\">\n+â”Š  â”Š33â”Š      <Button className=\"GroupDetailsNavbar-back-button\" onClick={navToNewGroup}>\n+â”Š  â”Š34â”Š        <ArrowBackIcon />\n+â”Š  â”Š35â”Š      </Button>\n+â”Š  â”Š36â”Š      <div className=\"GroupDetailsNavbar-title\">Group Details</div>\n+â”Š  â”Š37â”Š    </Style>\n+â”Š  â”Š38â”Š  )\n+â”Š  â”Š39â”Š}\n```\n\n##### Added src&#x2F;components&#x2F;GroupDetailsScreen&#x2F;index.tsx\n```diff\n@@ -0,0 +1,163 @@\n+â”Š   â”Š  1â”Šimport TextField from '@material-ui/core/TextField'\n+â”Š   â”Š  2â”Šimport { defaultDataIdFromObject } from 'apollo-cache-inmemory'\n+â”Š   â”Š  3â”Šimport gql from 'graphql-tag'\n+â”Š   â”Š  4â”Šimport * as React from 'react'\n+â”Š   â”Š  5â”Šimport { useState, useEffect } from 'react'\n+â”Š   â”Š  6â”Šimport { MutationHookOptions } from 'react-apollo-hooks'\n+â”Š   â”Š  7â”Šimport { useQuery, useMutation } from 'react-apollo-hooks'\n+â”Š   â”Š  8â”Šimport { Redirect } from 'react-router-dom'\n+â”Š   â”Š  9â”Šimport { RouteComponentProps } from 'react-router-dom'\n+â”Š   â”Š 10â”Šimport styled from 'styled-components'\n+â”Š   â”Š 11â”Šimport * as fragments from '../../graphql/fragments'\n+â”Š   â”Š 12â”Šimport { GroupDetailsScreenQuery, GroupDetailsScreenMutation, User } from '../../graphql/types'\n+â”Š   â”Š 13â”Šimport { useMe } from '../../services/auth.service'\n+â”Š   â”Š 14â”Šimport { pickPicture, uploadProfilePicture } from '../../services/picture.service'\n+â”Š   â”Š 15â”Šimport Navbar from '../Navbar'\n+â”Š   â”Š 16â”Šimport CompleteGroupButton from './CompleteGroupButton'\n+â”Š   â”Š 17â”Šimport GroupDetailsNavbar from './GroupDetailsNavbar'\n+â”Š   â”Š 18â”Š\n+â”Š   â”Š 19â”Šconst Style = styled.div`\n+â”Š   â”Š 20â”Š  .GroupDetailsScreen-group-name {\n+â”Š   â”Š 21â”Š    width: calc(100% - 30px);\n+â”Š   â”Š 22â”Š    margin: 15px;\n+â”Š   â”Š 23â”Š  }\n+â”Š   â”Š 24â”Š\n+â”Š   â”Š 25â”Š  .GroupDetailsScreen-participants-title {\n+â”Š   â”Š 26â”Š    margin-top: 10px;\n+â”Š   â”Š 27â”Š    margin-left: 15px;\n+â”Š   â”Š 28â”Š  }\n+â”Š   â”Š 29â”Š\n+â”Š   â”Š 30â”Š  .GroupDetailsScreen-participants-list {\n+â”Š   â”Š 31â”Š    display: flex;\n+â”Š   â”Š 32â”Š    overflow: overlay;\n+â”Š   â”Š 33â”Š    padding: 0;\n+â”Š   â”Š 34â”Š  }\n+â”Š   â”Š 35â”Š\n+â”Š   â”Š 36â”Š  .GroupDetailsScreen-participant-item {\n+â”Š   â”Š 37â”Š    padding: 10px;\n+â”Š   â”Š 38â”Š    flex-flow: row wrap;\n+â”Š   â”Š 39â”Š    text-align: center;\n+â”Š   â”Š 40â”Š  }\n+â”Š   â”Š 41â”Š\n+â”Š   â”Š 42â”Š  .GroupDetailsScreen-participant-picture {\n+â”Š   â”Š 43â”Š    flex: 0 1 50px;\n+â”Š   â”Š 44â”Š    height: 50px;\n+â”Š   â”Š 45â”Š    width: 50px;\n+â”Š   â”Š 46â”Š    object-fit: cover;\n+â”Š   â”Š 47â”Š    border-radius: 50%;\n+â”Š   â”Š 48â”Š    display: block;\n+â”Š   â”Š 49â”Š    margin-left: auto;\n+â”Š   â”Š 50â”Š    margin-right: auto;\n+â”Š   â”Š 51â”Š  }\n+â”Š   â”Š 52â”Š\n+â”Š   â”Š 53â”Š  .GroupDetailsScreen-group-info {\n+â”Š   â”Š 54â”Š    display: flex;\n+â”Š   â”Š 55â”Š    flex-direction: row;\n+â”Š   â”Š 56â”Š    align-items: center;\n+â”Š   â”Š 57â”Š  }\n+â”Š   â”Š 58â”Š\n+â”Š   â”Š 59â”Š  .GroupDetailsScreen-participant-name {\n+â”Š   â”Š 60â”Š    line-height: 10px;\n+â”Š   â”Š 61â”Š    font-size: 14px;\n+â”Š   â”Š 62â”Š  }\n+â”Š   â”Š 63â”Š\n+â”Š   â”Š 64â”Š  .GroupDetailsScreen-group-picture {\n+â”Š   â”Š 65â”Š    width: 50px;\n+â”Š   â”Š 66â”Š    flex-basis: 50px;\n+â”Š   â”Š 67â”Š    border-radius: 50%;\n+â”Š   â”Š 68â”Š    margin-left: 15px;\n+â”Š   â”Š 69â”Š    object-fit: cover;\n+â”Š   â”Š 70â”Š    cursor: pointer;\n+â”Š   â”Š 71â”Š  }\n+â”Š   â”Š 72â”Š`\n+â”Š   â”Š 73â”Š\n+â”Š   â”Š 74â”Šconst query = gql`\n+â”Š   â”Š 75â”Š  query GroupDetailsScreenQuery($chatId: ID!) {\n+â”Š   â”Š 76â”Š    chat(chatId: $chatId) {\n+â”Š   â”Š 77â”Š      ...Chat\n+â”Š   â”Š 78â”Š    }\n+â”Š   â”Š 79â”Š  }\n+â”Š   â”Š 80â”Š  ${fragments.chat}\n+â”Š   â”Š 81â”Š`\n+â”Š   â”Š 82â”Š\n+â”Š   â”Š 83â”Šconst mutation = gql`\n+â”Š   â”Š 84â”Š  mutation GroupDetailsScreenMutation($chatId: ID!, $name: String, $picture: String) {\n+â”Š   â”Š 85â”Š    updateGroup(chatId: $chatId, groupName: $name, groupPicture: $picture) {\n+â”Š   â”Š 86â”Š      ...Chat\n+â”Š   â”Š 87â”Š    }\n+â”Š   â”Š 88â”Š  }\n+â”Š   â”Š 89â”Š  ${fragments.chat}\n+â”Š   â”Š 90â”Š`\n+â”Š   â”Š 91â”Š\n+â”Š   â”Š 92â”Šexport default ({ location, history }: RouteComponentProps) => {\n+â”Š   â”Š 93â”Š  const users = location.state.users\n+â”Š   â”Š 94â”Š\n+â”Š   â”Š 95â”Š  // Users are missing from state\n+â”Š   â”Š 96â”Š  if (!(users instanceof Array)) {\n+â”Š   â”Š 97â”Š    return <Redirect to=\"/chats\" />\n+â”Š   â”Š 98â”Š  }\n+â”Š   â”Š 99â”Š\n+â”Š   â”Š100â”Š  const me = useMe()\n+â”Š   â”Š101â”Š  const [chatName, setChatName] = useState('')\n+â”Š   â”Š102â”Š  const [chatPicture, setChatPicture] = useState('')\n+â”Š   â”Š103â”Š  const participants = [me].concat(users)\n+â”Š   â”Š104â”Š\n+â”Š   â”Š105â”Š  const updateChatName = ({ target }) => {\n+â”Š   â”Š106â”Š    setChatName(target.value)\n+â”Š   â”Š107â”Š  }\n+â”Š   â”Š108â”Š\n+â”Š   â”Š109â”Š  const updateChatPicture = async () => {\n+â”Š   â”Š110â”Š    const file = await pickPicture()\n+â”Š   â”Š111â”Š\n+â”Š   â”Š112â”Š    if (!file) return\n+â”Š   â”Š113â”Š\n+â”Š   â”Š114â”Š    const { url } = await uploadProfilePicture(file)\n+â”Š   â”Š115â”Š\n+â”Š   â”Š116â”Š    setChatPicture(url)\n+â”Š   â”Š117â”Š  }\n+â”Š   â”Š118â”Š\n+â”Š   â”Š119â”Š  return (\n+â”Š   â”Š120â”Š    <Style className=\"GroupDetailsScreen Screen\">\n+â”Š   â”Š121â”Š      <Navbar>\n+â”Š   â”Š122â”Š        <GroupDetailsNavbar history={history} />\n+â”Š   â”Š123â”Š      </Navbar>\n+â”Š   â”Š124â”Š      <div className=\"GroupDetailsScreen-group-info\">\n+â”Š   â”Š125â”Š        <img\n+â”Š   â”Š126â”Š          className=\"GroupDetailsScreen-group-picture\"\n+â”Š   â”Š127â”Š          src={chatPicture || '/assets/default-group-pic.jpg'}\n+â”Š   â”Š128â”Š          onClick={updateChatPicture}\n+â”Š   â”Š129â”Š        />\n+â”Š   â”Š130â”Š        <TextField\n+â”Š   â”Š131â”Š          label=\"Group name\"\n+â”Š   â”Š132â”Š          placeholder=\"Enter group name\"\n+â”Š   â”Š133â”Š          className=\"GroupDetailsScreen-group-name\"\n+â”Š   â”Š134â”Š          value={chatName}\n+â”Š   â”Š135â”Š          onChange={updateChatName}\n+â”Š   â”Š136â”Š          autoFocus={true}\n+â”Š   â”Š137â”Š        />\n+â”Š   â”Š138â”Š      </div>\n+â”Š   â”Š139â”Š      <div className=\"GroupDetailsScreen-participants-title\">\n+â”Š   â”Š140â”Š        Participants: {participants.length}\n+â”Š   â”Š141â”Š      </div>\n+â”Š   â”Š142â”Š      <ul className=\"GroupDetailsScreen-participants-list\">\n+â”Š   â”Š143â”Š        {participants.map(participant => (\n+â”Š   â”Š144â”Š          <div key={participant.id} className=\"GroupDetailsScreen-participant-item\">\n+â”Š   â”Š145â”Š            <img\n+â”Š   â”Š146â”Š              src={participant.picture || '/assets/default-profile-pic.jpg'}\n+â”Š   â”Š147â”Š              className=\"GroupDetailsScreen-participant-picture\"\n+â”Š   â”Š148â”Š            />\n+â”Š   â”Š149â”Š            <span className=\"GroupDetailsScreen-participant-name\">{participant.name}</span>\n+â”Š   â”Š150â”Š          </div>\n+â”Š   â”Š151â”Š        ))}\n+â”Š   â”Š152â”Š      </ul>\n+â”Š   â”Š153â”Š      {chatName && (\n+â”Š   â”Š154â”Š        <CompleteGroupButton\n+â”Š   â”Š155â”Š          history={history}\n+â”Š   â”Š156â”Š          groupName={chatName}\n+â”Š   â”Š157â”Š          groupPicture={chatPicture}\n+â”Š   â”Š158â”Š          users={users}\n+â”Š   â”Š159â”Š        />\n+â”Š   â”Š160â”Š      )}\n+â”Š   â”Š161â”Š    </Style>\n+â”Š   â”Š162â”Š  )\n+â”Š   â”Š163â”Š}\n```\n\n[}]: #\n\nThis will require us to download a new asset to the `public/assets` directory which represents the default picture for a group. Please save it as `default-group-pic.jpg`:\n\n![default-group-pic.jpg](https://user-images.githubusercontent.com/7648874/51983284-3b1d8300-24d3-11e9-9f8b-afe36a3b9df1.jpg)\n\nLet's add a route for the screen we've just created:\n\n[{]: <helper> (diffStep 4.3 files=\"src/App\" module=\"client\")\n\n#### [Step 4.3: Add group details screen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/b9b7c3f)\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -5,6 +5,7 @@\n â”Š 5â”Š 5â”Šimport AnimatedSwitch from './components/AnimatedSwitch'\n â”Š 6â”Š 6â”Šimport AuthScreen from './components/AuthScreen'\n â”Š 7â”Š 7â”Šimport ChatsListScreen from './components/ChatsListScreen'\n+â”Š  â”Š 8â”Šimport GroupDetailsScreen from './components/GroupDetailsScreen'\n â”Š 8â”Š 9â”Šimport SettingsScreen from './components/SettingsScreen'\n â”Š 9â”Š10â”Šimport NewGroupScreen from './components/NewGroupScreen'\n â”Š10â”Š11â”Šimport { withAuth } from './services/auth.service'\n```\n```diff\n@@ -22,6 +23,7 @@\n â”Š22â”Š23â”Š      <Route exact path=\"/chats/:chatId\" component={withAuth(ChatRoomScreen)} />\n â”Š23â”Š24â”Š      <Route exact path=\"/new-chat\" component={withAuth(NewChatScreen)} />\n â”Š24â”Š25â”Š      <Route exact path=\"/new-chat/group\" component={withAuth(NewGroupScreen)} />\n+â”Š  â”Š26â”Š      <Route exact path=\"/new-chat/group/details\" component={withAuth(GroupDetailsScreen)} />\n â”Š25â”Š27â”Š      <Route component={RedirectToChats} />\n â”Š26â”Š28â”Š    </AnimatedSwitch>\n â”Š27â”Š29â”Š  </BrowserRouter>\n```\n\n[}]: #\n\nThere's one last thing missing in the flow and that would be migrating existing components to work well with the new feature of group chats.\n\nStarting with the chats list component, we would like to display the default profile picture for group chats:\n\n[{]: <helper> (diffStep 4.4 files=\"src/components/ChatsListScreen\" module=\"client\")\n\n#### [Step 4.4: Apply group logic to existing components](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/109773f)\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -97,7 +97,12 @@\n â”Š 97â”Š 97â”Š          >\n â”Š 98â”Š 98â”Š            <img\n â”Š 99â”Š 99â”Š              className=\"ChatsList-profile-pic\"\n-â”Š100â”Š   â”Š              src={chat.picture || '/assets/default-profile-pic.jpg'}\n+â”Š   â”Š100â”Š              src={\n+â”Š   â”Š101â”Š                chat.picture ||\n+â”Š   â”Š102â”Š                (chat.isGroup\n+â”Š   â”Š103â”Š                  ? '/assets/default-group-pic.jpg'\n+â”Š   â”Š104â”Š                  : '/assets/default-profile-pic.jpg')\n+â”Š   â”Š105â”Š              }\n â”Š101â”Š106â”Š            />\n â”Š102â”Š107â”Š            <div className=\"ChatsList-info\">\n â”Š103â”Š108â”Š              <div className=\"ChatsList-name\">{chat.name}</div>\n```\n\n[}]: #\n\nIn the messages list component, we would like to display the name of the owner of the message, so we would know exactly who sent it in case we're in a group chat:\n\n[{]: <helper> (diffStep 4.4 files=\"src/components/ChatRoomScreen/MessagesList\" module=\"client\")\n\n#### [Step 4.4: Apply group logic to existing components](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/109773f)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;MessagesList.tsx\n```diff\n@@ -105,7 +105,7 @@\n â”Š105â”Š105â”Šexport default ({ chatId }: MessagesListProps) => {\n â”Š106â”Š106â”Š  const {\n â”Š107â”Š107â”Š    data: {\n-â”Š108â”Š   â”Š      chat: { messages },\n+â”Š   â”Š108â”Š      chat: { messages, isGroup },\n â”Š109â”Š109â”Š    },\n â”Š110â”Š110â”Š  } = useQuery<MessagesListQuery.Query, MessagesListQuery.Variables>(query, {\n â”Š111â”Š111â”Š    variables: { chatId },\n```\n```diff\n@@ -133,6 +133,9 @@\n â”Š133â”Š133â”Š              message.ownership ? 'MessagesList-message-mine' : 'MessagesList-message-others'\n â”Š134â”Š134â”Š            }`}\n â”Š135â”Š135â”Š          >\n+â”Š   â”Š136â”Š            {isGroup && !message.ownership && (\n+â”Š   â”Š137â”Š              <div className=\"MessagesList-message-sender\">{message.sender.name}</div>\n+â”Š   â”Š138â”Š            )}\n â”Š136â”Š139â”Š            <div className=\"MessagesList-message-contents\">{message.content}</div>\n â”Š137â”Š140â”Š            <span className=\"MessagesList-message-timestamp\">\n â”Š138â”Š141â”Š              {moment(message.createdAt).format('HH:mm')}\n```\n\n[}]: #\n\nAnd now what we're gonna do is basically use the group details screen to show the details of the group that we're currently at. If we're an admin of the group, we would be able to edit its details, and if not, we will only be able to view its details without changing any of it. The view and some of the logic are the same whether it's a new group or an existing one, but there are slight differences. To deal with the differences, we will use \"if\" statements before we use the hooks, but **beware whenever you do that!** If you'll use an expression that is likely to change during the component's lifespan, you should NOT use a hook inside the \"if\" statement's block, because the React engine relies on the hooks to be called in a similar order.\n\n[{]: <helper> (diffStep 4.3 files=\"src/components/ChatRoomScreen/ChatNavBar, src/components/GroupDetailsScreen\" module=\"client\")\n\n#### [Step 4.3: Add group details screen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/b9b7c3f)\n\n##### Added src&#x2F;components&#x2F;GroupDetailsScreen&#x2F;CompleteGroupButton.tsx\n```diff\n@@ -0,0 +1,114 @@\n+â”Š   â”Š  1â”Šimport Button from '@material-ui/core/Button'\n+â”Š   â”Š  2â”Šimport ArrowRightIcon from '@material-ui/icons/ArrowRightAlt'\n+â”Š   â”Š  3â”Šimport { defaultDataIdFromObject } from 'apollo-cache-inmemory'\n+â”Š   â”Š  4â”Šimport gql from 'graphql-tag'\n+â”Š   â”Š  5â”Šimport { History } from 'history'\n+â”Š   â”Š  6â”Šimport * as React from 'react'\n+â”Š   â”Š  7â”Šimport { useMutation } from 'react-apollo-hooks'\n+â”Š   â”Š  8â”Šimport styled from 'styled-components'\n+â”Š   â”Š  9â”Šimport { time as uniqid } from 'uniqid'\n+â”Š   â”Š 10â”Šimport * as fragments from '../../graphql/fragments'\n+â”Š   â”Š 11â”Šimport * as queries from '../../graphql/queries'\n+â”Š   â”Š 12â”Šimport { Chats, User, CompleteGroupButtonMutation } from '../../graphql/types'\n+â”Š   â”Š 13â”Šimport { useMe } from '../../services/auth.service'\n+â”Š   â”Š 14â”Š\n+â”Š   â”Š 15â”Šconst Style = styled.div`\n+â”Š   â”Š 16â”Š  position: fixed;\n+â”Š   â”Š 17â”Š  right: 10px;\n+â”Š   â”Š 18â”Š  bottom: 10px;\n+â”Š   â”Š 19â”Š\n+â”Š   â”Š 20â”Š  button {\n+â”Š   â”Š 21â”Š    min-width: 50px;\n+â”Š   â”Š 22â”Š    width: 50px;\n+â”Š   â”Š 23â”Š    height: 50px;\n+â”Š   â”Š 24â”Š    border-radius: 999px;\n+â”Š   â”Š 25â”Š    background-color: var(--secondary-bg);\n+â”Š   â”Š 26â”Š    color: white;\n+â”Š   â”Š 27â”Š  }\n+â”Š   â”Š 28â”Š`\n+â”Š   â”Š 29â”Š\n+â”Š   â”Š 30â”Šconst mutation = gql`\n+â”Š   â”Š 31â”Š  mutation CompleteGroupButtonMutation(\n+â”Š   â”Š 32â”Š    $userIds: [ID!]!\n+â”Š   â”Š 33â”Š    $groupName: String!\n+â”Š   â”Š 34â”Š    $groupPicture: String\n+â”Š   â”Š 35â”Š  ) {\n+â”Š   â”Š 36â”Š    addGroup(userIds: $userIds, groupName: $groupName, groupPicture: $groupPicture) {\n+â”Š   â”Š 37â”Š      ...Chat\n+â”Š   â”Š 38â”Š    }\n+â”Š   â”Š 39â”Š  }\n+â”Š   â”Š 40â”Š  ${fragments.chat}\n+â”Š   â”Š 41â”Š`\n+â”Š   â”Š 42â”Š\n+â”Š   â”Š 43â”Šinterface CompleteGroupButtonProps {\n+â”Š   â”Š 44â”Š  history: History\n+â”Š   â”Š 45â”Š  users: User.Fragment[]\n+â”Š   â”Š 46â”Š  groupName: string\n+â”Š   â”Š 47â”Š  groupPicture: string\n+â”Š   â”Š 48â”Š}\n+â”Š   â”Š 49â”Š\n+â”Š   â”Š 50â”Šexport default ({ history, users, groupName, groupPicture }: CompleteGroupButtonProps) => {\n+â”Š   â”Š 51â”Š  const me = useMe()\n+â”Š   â”Š 52â”Š\n+â”Š   â”Š 53â”Š  const addGroup = useMutation<\n+â”Š   â”Š 54â”Š    CompleteGroupButtonMutation.Mutation,\n+â”Š   â”Š 55â”Š    CompleteGroupButtonMutation.Variables\n+â”Š   â”Š 56â”Š  >(mutation, {\n+â”Š   â”Š 57â”Š    optimisticResponse: {\n+â”Š   â”Š 58â”Š      __typename: 'Mutation',\n+â”Š   â”Š 59â”Š      addGroup: {\n+â”Š   â”Š 60â”Š        __typename: 'Chat',\n+â”Š   â”Š 61â”Š        id: uniqid(),\n+â”Š   â”Š 62â”Š        name: groupName,\n+â”Š   â”Š 63â”Š        picture: groupPicture,\n+â”Š   â”Š 64â”Š        allTimeMembers: users,\n+â”Š   â”Š 65â”Š        owner: me,\n+â”Š   â”Š 66â”Š        isGroup: true,\n+â”Š   â”Š 67â”Š        lastMessage: null,\n+â”Š   â”Š 68â”Š      },\n+â”Š   â”Š 69â”Š    },\n+â”Š   â”Š 70â”Š    variables: {\n+â”Š   â”Š 71â”Š      userIds: users.map(user => user.id),\n+â”Š   â”Š 72â”Š      groupName,\n+â”Š   â”Š 73â”Š      groupPicture,\n+â”Š   â”Š 74â”Š    },\n+â”Š   â”Š 75â”Š    update: (client, { data: { addGroup } }) => {\n+â”Š   â”Š 76â”Š      client.writeFragment({\n+â”Š   â”Š 77â”Š        id: defaultDataIdFromObject(addGroup),\n+â”Š   â”Š 78â”Š        fragment: fragments.chat,\n+â”Š   â”Š 79â”Š        fragmentName: 'Chat',\n+â”Š   â”Š 80â”Š        data: addGroup,\n+â”Š   â”Š 81â”Š      })\n+â”Š   â”Š 82â”Š\n+â”Š   â”Š 83â”Š      let chats\n+â”Š   â”Š 84â”Š      try {\n+â”Š   â”Š 85â”Š        chats = client.readQuery<Chats.Query>({\n+â”Š   â”Š 86â”Š          query: queries.chats,\n+â”Š   â”Š 87â”Š        }).chats\n+â”Š   â”Š 88â”Š      } catch (e) {}\n+â”Š   â”Š 89â”Š\n+â”Š   â”Š 90â”Š      if (chats && !chats.some(chat => chat.id === addGroup.id)) {\n+â”Š   â”Š 91â”Š        chats.unshift(addGroup)\n+â”Š   â”Š 92â”Š\n+â”Š   â”Š 93â”Š        client.writeQuery({\n+â”Š   â”Š 94â”Š          query: queries.chats,\n+â”Š   â”Š 95â”Š          data: { chats },\n+â”Š   â”Š 96â”Š        })\n+â”Š   â”Š 97â”Š      }\n+â”Š   â”Š 98â”Š    },\n+â”Š   â”Š 99â”Š  })\n+â”Š   â”Š100â”Š\n+â”Š   â”Š101â”Š  const onClick = () => {\n+â”Š   â”Š102â”Š    addGroup().then(({ data: { addGroup } }) => {\n+â”Š   â”Š103â”Š      history.push(`/chats/${addGroup.id}`)\n+â”Š   â”Š104â”Š    })\n+â”Š   â”Š105â”Š  }\n+â”Š   â”Š106â”Š\n+â”Š   â”Š107â”Š  return (\n+â”Š   â”Š108â”Š    <Style className=\"CompleteGroupButton\">\n+â”Š   â”Š109â”Š      <Button variant=\"contained\" color=\"secondary\" onClick={onClick}>\n+â”Š   â”Š110â”Š        <ArrowRightIcon />\n+â”Š   â”Š111â”Š      </Button>\n+â”Š   â”Š112â”Š    </Style>\n+â”Š   â”Š113â”Š  )\n+â”Š   â”Š114â”Š}\n```\n\n##### Added src&#x2F;components&#x2F;GroupDetailsScreen&#x2F;GroupDetailsNavbar.tsx\n```diff\n@@ -0,0 +1,39 @@\n+â”Š  â”Š 1â”Šimport Button from '@material-ui/core/Button'\n+â”Š  â”Š 2â”Šimport ArrowBackIcon from '@material-ui/icons/ArrowBack'\n+â”Š  â”Š 3â”Šimport { History } from 'history'\n+â”Š  â”Š 4â”Šimport * as React from 'react'\n+â”Š  â”Š 5â”Šimport styled from 'styled-components'\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Šconst Style = styled.div`\n+â”Š  â”Š 8â”Š  padding: 0;\n+â”Š  â”Š 9â”Š  display: flex;\n+â”Š  â”Š10â”Š  flex-direction: row;\n+â”Š  â”Š11â”Š  margin-left: -20px;\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Š  .GroupDetailsNavbar-title {\n+â”Š  â”Š14â”Š    line-height: 56px;\n+â”Š  â”Š15â”Š  }\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š  .GroupDetailsNavbar-back-button {\n+â”Š  â”Š18â”Š    color: var(--primary-text);\n+â”Š  â”Š19â”Š  }\n+â”Š  â”Š20â”Š`\n+â”Š  â”Š21â”Š\n+â”Š  â”Š22â”Šinterface GroupDetailsNavbarProps {\n+â”Š  â”Š23â”Š  history: History\n+â”Š  â”Š24â”Š}\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Šexport default ({ history }: GroupDetailsNavbarProps) => {\n+â”Š  â”Š27â”Š  const navToNewGroup = () => {\n+â”Š  â”Š28â”Š    history.push('/new-chat/group')\n+â”Š  â”Š29â”Š  }\n+â”Š  â”Š30â”Š\n+â”Š  â”Š31â”Š  return (\n+â”Š  â”Š32â”Š    <Style className=\"GroupDetailsNavbar\">\n+â”Š  â”Š33â”Š      <Button className=\"GroupDetailsNavbar-back-button\" onClick={navToNewGroup}>\n+â”Š  â”Š34â”Š        <ArrowBackIcon />\n+â”Š  â”Š35â”Š      </Button>\n+â”Š  â”Š36â”Š      <div className=\"GroupDetailsNavbar-title\">Group Details</div>\n+â”Š  â”Š37â”Š    </Style>\n+â”Š  â”Š38â”Š  )\n+â”Š  â”Š39â”Š}\n```\n\n##### Added src&#x2F;components&#x2F;GroupDetailsScreen&#x2F;index.tsx\n```diff\n@@ -0,0 +1,163 @@\n+â”Š   â”Š  1â”Šimport TextField from '@material-ui/core/TextField'\n+â”Š   â”Š  2â”Šimport { defaultDataIdFromObject } from 'apollo-cache-inmemory'\n+â”Š   â”Š  3â”Šimport gql from 'graphql-tag'\n+â”Š   â”Š  4â”Šimport * as React from 'react'\n+â”Š   â”Š  5â”Šimport { useState, useEffect } from 'react'\n+â”Š   â”Š  6â”Šimport { MutationHookOptions } from 'react-apollo-hooks'\n+â”Š   â”Š  7â”Šimport { useQuery, useMutation } from 'react-apollo-hooks'\n+â”Š   â”Š  8â”Šimport { Redirect } from 'react-router-dom'\n+â”Š   â”Š  9â”Šimport { RouteComponentProps } from 'react-router-dom'\n+â”Š   â”Š 10â”Šimport styled from 'styled-components'\n+â”Š   â”Š 11â”Šimport * as fragments from '../../graphql/fragments'\n+â”Š   â”Š 12â”Šimport { GroupDetailsScreenQuery, GroupDetailsScreenMutation, User } from '../../graphql/types'\n+â”Š   â”Š 13â”Šimport { useMe } from '../../services/auth.service'\n+â”Š   â”Š 14â”Šimport { pickPicture, uploadProfilePicture } from '../../services/picture.service'\n+â”Š   â”Š 15â”Šimport Navbar from '../Navbar'\n+â”Š   â”Š 16â”Šimport CompleteGroupButton from './CompleteGroupButton'\n+â”Š   â”Š 17â”Šimport GroupDetailsNavbar from './GroupDetailsNavbar'\n+â”Š   â”Š 18â”Š\n+â”Š   â”Š 19â”Šconst Style = styled.div`\n+â”Š   â”Š 20â”Š  .GroupDetailsScreen-group-name {\n+â”Š   â”Š 21â”Š    width: calc(100% - 30px);\n+â”Š   â”Š 22â”Š    margin: 15px;\n+â”Š   â”Š 23â”Š  }\n+â”Š   â”Š 24â”Š\n+â”Š   â”Š 25â”Š  .GroupDetailsScreen-participants-title {\n+â”Š   â”Š 26â”Š    margin-top: 10px;\n+â”Š   â”Š 27â”Š    margin-left: 15px;\n+â”Š   â”Š 28â”Š  }\n+â”Š   â”Š 29â”Š\n+â”Š   â”Š 30â”Š  .GroupDetailsScreen-participants-list {\n+â”Š   â”Š 31â”Š    display: flex;\n+â”Š   â”Š 32â”Š    overflow: overlay;\n+â”Š   â”Š 33â”Š    padding: 0;\n+â”Š   â”Š 34â”Š  }\n+â”Š   â”Š 35â”Š\n+â”Š   â”Š 36â”Š  .GroupDetailsScreen-participant-item {\n+â”Š   â”Š 37â”Š    padding: 10px;\n+â”Š   â”Š 38â”Š    flex-flow: row wrap;\n+â”Š   â”Š 39â”Š    text-align: center;\n+â”Š   â”Š 40â”Š  }\n+â”Š   â”Š 41â”Š\n+â”Š   â”Š 42â”Š  .GroupDetailsScreen-participant-picture {\n+â”Š   â”Š 43â”Š    flex: 0 1 50px;\n+â”Š   â”Š 44â”Š    height: 50px;\n+â”Š   â”Š 45â”Š    width: 50px;\n+â”Š   â”Š 46â”Š    object-fit: cover;\n+â”Š   â”Š 47â”Š    border-radius: 50%;\n+â”Š   â”Š 48â”Š    display: block;\n+â”Š   â”Š 49â”Š    margin-left: auto;\n+â”Š   â”Š 50â”Š    margin-right: auto;\n+â”Š   â”Š 51â”Š  }\n+â”Š   â”Š 52â”Š\n+â”Š   â”Š 53â”Š  .GroupDetailsScreen-group-info {\n+â”Š   â”Š 54â”Š    display: flex;\n+â”Š   â”Š 55â”Š    flex-direction: row;\n+â”Š   â”Š 56â”Š    align-items: center;\n+â”Š   â”Š 57â”Š  }\n+â”Š   â”Š 58â”Š\n+â”Š   â”Š 59â”Š  .GroupDetailsScreen-participant-name {\n+â”Š   â”Š 60â”Š    line-height: 10px;\n+â”Š   â”Š 61â”Š    font-size: 14px;\n+â”Š   â”Š 62â”Š  }\n+â”Š   â”Š 63â”Š\n+â”Š   â”Š 64â”Š  .GroupDetailsScreen-group-picture {\n+â”Š   â”Š 65â”Š    width: 50px;\n+â”Š   â”Š 66â”Š    flex-basis: 50px;\n+â”Š   â”Š 67â”Š    border-radius: 50%;\n+â”Š   â”Š 68â”Š    margin-left: 15px;\n+â”Š   â”Š 69â”Š    object-fit: cover;\n+â”Š   â”Š 70â”Š    cursor: pointer;\n+â”Š   â”Š 71â”Š  }\n+â”Š   â”Š 72â”Š`\n+â”Š   â”Š 73â”Š\n+â”Š   â”Š 74â”Šconst query = gql`\n+â”Š   â”Š 75â”Š  query GroupDetailsScreenQuery($chatId: ID!) {\n+â”Š   â”Š 76â”Š    chat(chatId: $chatId) {\n+â”Š   â”Š 77â”Š      ...Chat\n+â”Š   â”Š 78â”Š    }\n+â”Š   â”Š 79â”Š  }\n+â”Š   â”Š 80â”Š  ${fragments.chat}\n+â”Š   â”Š 81â”Š`\n+â”Š   â”Š 82â”Š\n+â”Š   â”Š 83â”Šconst mutation = gql`\n+â”Š   â”Š 84â”Š  mutation GroupDetailsScreenMutation($chatId: ID!, $name: String, $picture: String) {\n+â”Š   â”Š 85â”Š    updateGroup(chatId: $chatId, groupName: $name, groupPicture: $picture) {\n+â”Š   â”Š 86â”Š      ...Chat\n+â”Š   â”Š 87â”Š    }\n+â”Š   â”Š 88â”Š  }\n+â”Š   â”Š 89â”Š  ${fragments.chat}\n+â”Š   â”Š 90â”Š`\n+â”Š   â”Š 91â”Š\n+â”Š   â”Š 92â”Šexport default ({ location, history }: RouteComponentProps) => {\n+â”Š   â”Š 93â”Š  const users = location.state.users\n+â”Š   â”Š 94â”Š\n+â”Š   â”Š 95â”Š  // Users are missing from state\n+â”Š   â”Š 96â”Š  if (!(users instanceof Array)) {\n+â”Š   â”Š 97â”Š    return <Redirect to=\"/chats\" />\n+â”Š   â”Š 98â”Š  }\n+â”Š   â”Š 99â”Š\n+â”Š   â”Š100â”Š  const me = useMe()\n+â”Š   â”Š101â”Š  const [chatName, setChatName] = useState('')\n+â”Š   â”Š102â”Š  const [chatPicture, setChatPicture] = useState('')\n+â”Š   â”Š103â”Š  const participants = [me].concat(users)\n+â”Š   â”Š104â”Š\n+â”Š   â”Š105â”Š  const updateChatName = ({ target }) => {\n+â”Š   â”Š106â”Š    setChatName(target.value)\n+â”Š   â”Š107â”Š  }\n+â”Š   â”Š108â”Š\n+â”Š   â”Š109â”Š  const updateChatPicture = async () => {\n+â”Š   â”Š110â”Š    const file = await pickPicture()\n+â”Š   â”Š111â”Š\n+â”Š   â”Š112â”Š    if (!file) return\n+â”Š   â”Š113â”Š\n+â”Š   â”Š114â”Š    const { url } = await uploadProfilePicture(file)\n+â”Š   â”Š115â”Š\n+â”Š   â”Š116â”Š    setChatPicture(url)\n+â”Š   â”Š117â”Š  }\n+â”Š   â”Š118â”Š\n+â”Š   â”Š119â”Š  return (\n+â”Š   â”Š120â”Š    <Style className=\"GroupDetailsScreen Screen\">\n+â”Š   â”Š121â”Š      <Navbar>\n+â”Š   â”Š122â”Š        <GroupDetailsNavbar history={history} />\n+â”Š   â”Š123â”Š      </Navbar>\n+â”Š   â”Š124â”Š      <div className=\"GroupDetailsScreen-group-info\">\n+â”Š   â”Š125â”Š        <img\n+â”Š   â”Š126â”Š          className=\"GroupDetailsScreen-group-picture\"\n+â”Š   â”Š127â”Š          src={chatPicture || '/assets/default-group-pic.jpg'}\n+â”Š   â”Š128â”Š          onClick={updateChatPicture}\n+â”Š   â”Š129â”Š        />\n+â”Š   â”Š130â”Š        <TextField\n+â”Š   â”Š131â”Š          label=\"Group name\"\n+â”Š   â”Š132â”Š          placeholder=\"Enter group name\"\n+â”Š   â”Š133â”Š          className=\"GroupDetailsScreen-group-name\"\n+â”Š   â”Š134â”Š          value={chatName}\n+â”Š   â”Š135â”Š          onChange={updateChatName}\n+â”Š   â”Š136â”Š          autoFocus={true}\n+â”Š   â”Š137â”Š        />\n+â”Š   â”Š138â”Š      </div>\n+â”Š   â”Š139â”Š      <div className=\"GroupDetailsScreen-participants-title\">\n+â”Š   â”Š140â”Š        Participants: {participants.length}\n+â”Š   â”Š141â”Š      </div>\n+â”Š   â”Š142â”Š      <ul className=\"GroupDetailsScreen-participants-list\">\n+â”Š   â”Š143â”Š        {participants.map(participant => (\n+â”Š   â”Š144â”Š          <div key={participant.id} className=\"GroupDetailsScreen-participant-item\">\n+â”Š   â”Š145â”Š            <img\n+â”Š   â”Š146â”Š              src={participant.picture || '/assets/default-profile-pic.jpg'}\n+â”Š   â”Š147â”Š              className=\"GroupDetailsScreen-participant-picture\"\n+â”Š   â”Š148â”Š            />\n+â”Š   â”Š149â”Š            <span className=\"GroupDetailsScreen-participant-name\">{participant.name}</span>\n+â”Š   â”Š150â”Š          </div>\n+â”Š   â”Š151â”Š        ))}\n+â”Š   â”Š152â”Š      </ul>\n+â”Š   â”Š153â”Š      {chatName && (\n+â”Š   â”Š154â”Š        <CompleteGroupButton\n+â”Š   â”Š155â”Š          history={history}\n+â”Š   â”Š156â”Š          groupName={chatName}\n+â”Š   â”Š157â”Š          groupPicture={chatPicture}\n+â”Š   â”Š158â”Š          users={users}\n+â”Š   â”Š159â”Š        />\n+â”Š   â”Š160â”Š      )}\n+â”Š   â”Š161â”Š    </Style>\n+â”Š   â”Š162â”Š  )\n+â”Š   â”Š163â”Š}\n```\n\n[}]: #\n\nThat's it! Now we should be able to create group chats and message multiple people at once."
          }
        ]
      },
      {
        "releaseVersion": "next",
        "releaseDate": "2019-02-20 11:42:05 +0800",
        "tagName": "master@next",
        "tagRevision": "4ddba21c9d8bbc60a599a7328bc7342997e0aad6",
        "historyRevision": "64677662baf0f20f36f01c484d632d1230ac73c4",
        "changesDiff": "diff --git a/.gitignore b/.gitignore\nnew file mode 100644\nindex 0000000..5171c54\n--- /dev/null\n+++ b/.gitignore\n@@ -0,0 +1,2 @@\n+node_modules\n+npm-debug.log\n\\ No newline at end of file\ndiff --git a/.tortilla/manuals/templates/root.tmpl b/.tortilla/manuals/templates/root.tmpl\nnew file mode 100644\nindex 0000000..a1324b2\n--- /dev/null\n+++ b/.tortilla/manuals/templates/root.tmpl\n@@ -0,0 +1,43 @@\n+<p align=\"center\"><img src=\"https://cdn-images-1.medium.com/max/1600/1*cSBu9zeo8fSnf1Cc-UeR_g.jpeg\" width=\"640\"></p>\n+\n+You might have seen it around alreadyâ€Š-â€Šan open-source WhatsApp Clone tutorial; a project which was originally started in 2015 by [Uri Goldshtein](https://github.com/urigo) based on Angular-Meteor and Ionic, and have been throughout different incarnations ever since.\n+\n+This time around, I'm happy to announce that a new version of the WhatsApp Clone is coming, and it's based on React 16.7 (Hooks & Suspense), Styled-Components, Material-UI, TypeScript, GraphQL-Subscriptions/Codegen/Modules, PostgreSQL and TypeORM.\n+\n+The step-by-step implementations of the server and client can be found here:\n+\n+- Server - [urigo/whatsapp-clone-server](https://github.com/urigo/whatsapp-clone-server)\n+\n+- Client - [urigo/whatsapp-clone-client](https://github.com/urigo/whatsapp-clone-client-react)\n+\n+<p align=\"center\"><img src=\"https://cdn-images-1.medium.com/max/1040/1*fFUJd7moWtjvMZ5dE-A80g.gif\" alt=\"whatsapp\" width=\"240\"></p>\n+\n+### Why is it so good?\n+\n+This app was built with all the latest and hottest technologies out there. The purpose is simpleâ€Š-â€Šit should be a guideline for building a proper app, thus we thought very carefully regards the design patterns and architecture used in it, plus, we made sure to cover all communication methods with the GraphQL-back-end in different variations (query, mutation, subscription). This way whenever you're looking to start a new app, maintain an existing one or upgrade your dev-stack, the WhatsApp-clone can be a great source to start with! It's full stack and has a complete flow.\n+\n+### Why did we choose this dev-stack?\n+\n+React, GraphQL, PostgreSQL and TypeScript for obvious reasonsâ€Š-â€Šthey are backed by a strong ecosystem. These technologies can be used in endless variations, and there's no one way which is the most right of doing so, but we chose a way that makes the most sense for us and that we truly believe in when it comes to building apps. We've connected all 4 with TypeORM, GraphQL-Codegen, GraphQL-Modules for the following reasons:\n+\n+- The GraphQL back-end was implemented with GraphQL-Modules where logic was splitted into modules based on entity types. GraphQL-Modules is an amazing library which provides you with the ability to manage and maintain your GraphQL schema correctly. Not once nor twice I have seen people who struggle with that and get tangled upon their own creation, and with GraphQL-Modules where you have a very defined structure, this problem can be easily solved.\n+\n+- Every GraphQL/TypeScript definition were automatically generated with GraphQL-Codegen using a single command call. There's no need to maintain the same thing twice if it already exists in one way or another. This way you don't have to write TypeScript type definitions for your GraphQL documents (queries, mutations and subscriptions), GraphQL resolvers and GraphQL types.\n+\n+- The new version of React 16.7 was used with Hooks and Suspense and 100% of the project is made out of function components. The front-end communicates with the back-end using only hooks and there was no use in GraphQL-React components, which makes async tasks look a lot more readable with no extra indentations.\n+\n+- We used TypeORM to correctly split the logic of the entities in the database and define the relationships between them. Without a tool such as TypeORM, communication against the DB tends to get messy and confusion since there's no single module per entity which holds all its related logic.\n+\n+### What to expect?\n+\n+- Basic authentication.\n+\n+- Image uploading with [Cloudinary](https://cloudinary.com/).\n+\n+- Live updates with GraphQL subscriptions.\n+\n+- 100% function components with React Hooks.\n+\n+- GraphQL communication with [react-apollo-hooks](https://github.com/trojanowski/react-apollo-hooks).\n+\n+This app be extremely useful for those who have little to no background in one of the technologies in our dev-stack.\ndiff --git a/.tortilla/manuals/templates/step1.tmpl b/.tortilla/manuals/templates/step1.tmpl\nnew file mode 100644\nindex 0000000..b08a2d7\n--- /dev/null\n+++ b/.tortilla/manuals/templates/step1.tmpl\n@@ -0,0 +1,318 @@\n+To create a new React app we're simply gonna use [`create-react-app`](https://github.com/facebook/create-react-app). It comes with a built-in TypeScript support which is exactly what we need. First, install the CLI if you haven't already:\n+\n+    $ yarn global add create-react-app\n+\n+And then create the app itself:\n+\n+    $ create-react-app whatsapp-clone-client\n+\n+By default, `create-react-app` will create a JavaScript project. In order to use TypeScript, we will rename our app files to have the right extension `.tsx` (TypeScript + JSX):\n+\n+    src$ mv App.js App.tsx\n+    src$ mv index.js index.tsx\n+\n+And then we will add a couple of configuration files that will basically set the building and linting rules for the TypeScript compiler:\n+\n+{{{ diffStep 1.1 module=\"client\" files=\"tsconfig.json, tslint.json\" }}}\n+\n+Once we will run the app for the first time, `react-scripts` (`create-react-app` utility scripts package) should automatically initialize some additional TypeScript related files.\n+\n+    $ yarn start\n+\n+Since in our app we'll be using the new React [hooks](https://reactjs.org/docs/hooks-intro.html) and [Suspense](https://reactjs.org/docs/react-api.html#reactsuspense) mechanisms, we will upgrade React's version to version `16.8`:\n+\n+    $ yarn upgrade react@16.8.1 react-dom@16.8.1\n+\n+The plan is to make our app talk with a [GraphQL](https://graphql.org/) back-end, so we'll be using [Apollo](https://www.apollographql.com/) to setup a client which is actually capable of such.\n+\n+First we will install all the necessary packages:\n+\n+    $ yarn add apollo-cache-inmemory@1.4.3 apollo-client@2.4.13 apollo-link@1.2.8 apollo-link-http@1.5.11 apollo-link-ws@1.0.14 apollo-utilities@1.1.3 graphql@14.1.1 react-apollo-hooks@4.0.0 subscriptions-transport-ws@0.9.15\n+    $ yarn add -D @types/graphql@14.0.7 @types/node@11.9.4\n+\n+Then we will set the server's connection URL under the `.env` file which is basically used to define constants for our application. The constants can be addressed using `process.env[CONSTANT_NAME]`. The identifier should be replaced automatically by `react-scripts` with the stored value, just like macros:\n+\n+{{{ diffStep 1.3 module=\"client\" files=\".env\" }}}\n+\n+And finally we can write our Apollo-GraphQL client module and connect it to our application:\n+\n+{{{ diffStep 1.3 module=\"client\" files=\"src/apollo-client.ts, src/index.tsx\" }}}\n+\n+> Note that this configuration assumes that the sever runs at `localhost:4000` and that it serves a GraphQL REST endpoint at `/graphql`. Feel free to make the right adjustments according to your needs.\n+\n+Needless to say that we need a back-end for our application to function properly, and so this is what we're gonna focus on. We will initialize a second project for the server in a separate directory called `whatsapp-clone-server`:\n+\n+    $ mkdir whatsapp-clone-server\n+    $ cd whatsapp-clone-server\n+\n+And then we will initialize a new Node.JS project using NPM:\n+\n+    $ npm init --yes\n+\n+There's nothing special about this command, it only creates a basic `package.json` which we can add things on top (see [reference](https://docs.npmjs.com/cli/init)). We will be using TypeScript in our project, so let's set it up by installing the necessary packages:\n+\n+    $ yarn add -D typescript@3.3.3 ts-node@8.0.2 @types/node@11.9.4\n+\n+And creating a `tsconfig.json` file:\n+\n+{{{ diffStep 1.1 module=\"server\" files=\"tsconfig.json\" }}}\n+\n+We will also set a script that will startup the server with `ts-node`, a TypeScript interpreter for Node.JS:\n+\n+```json\n+{\n+  \"start\": \"ts-node index.ts\"\n+}\n+```\n+\n+Our `pacakge.json` file should look like so by now:\n+\n+{{{ diffStep 1.1 module=\"server\" files=\"package.json\" }}}\n+\n+In our server we will be using [Express](https://expressjs.com/) to serve our GraphQL REST endpoint which will be handled by Apollo. Accordingly, let's install the necessary dependencies:\n+\n+    $ yarn add -D @types/body-parser@1.17.0 @types/cors@2.8.4 @types/express@4.16.0 @types/graphql@14.0.4\n+    $ yarn add apollo-server-express@2.4.2 body-parser@1.18.3 cors@2.8.5 express@4.16.4 graphql@14.1.1\n+\n+And setup a basic express server with a `/graphql` REST endpoint:\n+\n+{{{ diffStep 1.2 module=\"server\" files=\"index.ts, schema\" }}}\n+\n+Before we proceed any further there's an issue that needs to be clear. Since we're using TypeScript together with GraphQL, by default we will have to maintain 2 schemas: one for TypeScript and the other for GraphQL. Both schemas represent the same thing this way or another, which means that we will have to maintain the same thing twice. Instead of doing so, we will be using a tool called [GraphQL Code Generator](https://graphql-code-generator.com/) (Codegen, in short) to generate TypeScript definitions from our GraphQL schema.\n+\n+Codegen will change its behavior and generate code based on a set of templates and a configuration file that we will provide. We highly recommend you to go through the [docs page](https://graphql-code-generator.com/docs/getting-started/) of Codegen to get a better understanding of what it is and how it works. Let's install Codegen then, along with the templates that we're gonna use:\n+\n+    $ yarn -D add graphql-code-generator@0.16.1 graphql-codegen-typescript-common@0.16.1 graphql-codegen-typescript-resolvers@0.16.1\n+\n+And write its config under `codegen.yml` file:\n+\n+{{{ diffStep 1.3 module=\"server\" files=\"codegen.yml\" }}}\n+\n+We will also update the `.gitignore` file to exclude the generated typings file:\n+\n+{{{ diffStep 1.3 module=\"server\" files=\".gitignore\" }}}\n+\n+To make things easy, we will add a code generation command in our `package.json` so we can have it available to us whenever we need it. First we will add few utility packages that are necessary for the task:\n+\n+    $ yarn -D add nodemon@1.18.9 concurrently@4.1.0\n+\n+And we will update the scripts section in the `package.json` file to look like so:\n+\n+```json\n+{\n+  \"generate\": \"gql-gen\",\n+  \"generate:watch\": \"nodemon --exec yarn generate -e graphql\",\n+  \"start:server\": \"ts-node index.ts\",\n+  \"start:server:watch\": \"nodemon --exec yarn start:server -e ts\",\n+  \"dev\": \"concurrently \\\"yarn generate:watch\\\" \\\"yarn start:server:watch\\\"\",\n+  \"start\": \"yarn generate && yarn start:server\"\n+}\n+```\n+\n+The `package.json` file should look like so by now:\n+\n+{{{ diffStep 1.3 module=\"server\" files=\"package.json\" }}}\n+\n+To generate some TypeScript definitions all we have to do is run:\n+\n+    $ yarn generate\n+\n+And then we can safely run the server with:\n+\n+    $ yarn start\n+\n+Alternatively, you can run the server and watch for changes with the following command:\n+\n+    $ yarn start:server:watch\n+\n+For practice purpose only, we're gonna serve some dummy data from our GraphQL API so we can have something to work with in our client. Later on we will connect everything to a real database. This would give us an easy start. Our dummy db will consist of a set of chats, each of them has a last message, a picture and a name:\n+\n+{{{ diffStep 1.4 module=\"server\" files=\"index.ts, db.ts, entity, schema, codegen.yml\" }}}\n+\n+As you can see, we've added an `entity` folder which treats each entity independently. This will server us greatly is the new future when we will connect each entity to a database. The GraphQL resolvers are the \"projectors\" of the data stored in the fake DB, and they will serve it based on their implementation and provided parameters.\n+\n+Now, let's make the necessary modifications to our client so it can work alongside the server and show the data that it contains. Similarly to the server, we don't wanna maintain a TypeScript code base for our GraphQL documents, therefore we will install Codegen for the client as well. Let's install the necessary NPM packages:\n+\n+    $ yarn add -D graphql-code-generator@0.16.1 graphql-codegen-typescript-client@0.16.1 graphql-codegen-typescript-common@0.16.1\n+\n+Write a Codegen config:\n+\n+{{{ diffStep 1.4 module=\"client\" files=\"codegen.yml, codegen-interpreter.ts\" }}}\n+\n+And define `.gitignore` rules that will not include generated files in our git project:\n+\n+{{{ diffStep 1.4 module=\"client\" files=\"src/graphql/.gitignore\" }}}\n+\n+Few things you should note:\n+\n+- Our `codegen.yml` config references directly to the schema file in our server, which means that the server should be cloned alongside the client. Codegen also supports providing a REST endpoint, but if possible it's better to avoid it because this way you don't need to provide credentials. Indeed, the plan is to have an authentication mechanism to guard our GraphQL REST endpoint.\n+- The `codegen-interpreter.ts` file is necessary because it extends the `tsconfig.json` file without us actually changing it. If you'll try to edit the `tsconfig.json` file directly, then `react-scripts` will change it back to its original form.\n+\n+We will also add the necessary scripts to our `pacakge.json` so we can run `code-gen`:\n+\n+```json\n+{\n+  \"start\": \"concurrently \\\"yarn generate:watch\\\" \\\"react-scripts start\\\"\",\n+  \"generate\": \"gql-gen\",\n+  \"generate:watch\": \"nodemon --exec yarn generate -e graphql\"\n+}\n+```\n+\n+Be sure to install `concurrently` and `nodemon` so the scripts can work as intended:\n+\n+    $ yarn add -D nodemon@1.18.9 ts-node@8.0.2 concurrently@4.1.0\n+\n+At this point our `package.json` file should look like this:\n+\n+{{{ diffStep 1.4 module=\"client\" files=\"package.json\" }}}\n+\n+Now whenever we would like to generate some TypeScript definitions we can simply run:\n+\n+    $ yarn generate\n+\n+Alternatively we can just start the app on watch mode with `$ yarn start` and the Codegen should be listening for changes as well.\n+\n+    $ yarn start\n+\n+Now let's build a dashboard that will show all the chats in the server. Rather than implementing all the components and stylesheets from scratch, we will be using [`material-ui`](https://material-ui.com/) (aka Material). Material comes with pre-made components which are highly functional and work smooth with animations. To set it up we will first install it:\n+\n+    $ yarn add @material-ui/core@3.9.2 @material-ui/icons@3.0.2\n+\n+And then we will initialize it with the right theme values:\n+\n+{{{ diffStep 1.5 module=\"client\" files=\"src/index.tsx\" }}}\n+\n+The theme values represent the main colors in our app. If you're familiar with WhatsApp, you know that its main colors consist mostly of Green and White. The theme values will automatically give Material components the desired style.\n+\n+We will also make sure that the same values are available in our CSS stylesheet so we can use it outside Material's scope:\n+\n+{{{ diffStep 1.5 module=\"client\" files=\"src/index.css\" }}}\n+\n+Now we're ready to start implementing the view itself. The logic is very simple, we will use a query to fetch the chats from our back-end. Accordingly we will need to define the right [GraphQL fragments](https://www.apollographql.com/docs/react/advanced/fragments.html) so we can use them to build the query. In short, a fragment is used to represent an entity in our app. **It doesn't necessarily has to represent a type**, but indeed it's the most common use case:\n+\n+{{{ diffStep 1.6 module=\"client\" files=\"src/graphql/fragments\" }}}\n+\n+Let's move on to implementing the components. The layout is simple and consists of a navigation bar and a chats list. There are few important details you should note about the components:\n+\n+- They use [Material's](https://material-ui.com) pre-made components and icons, which are styled and highly functional right out of the box.\n+- Instead of using CSS to style our components we use [`styled-components`](https://www.styled-components.com/). This way we can encapsulate the style and it will live right next to the component.\n+- We will use [`react-apollo-hooks`](https://github.com/trojanowski/react-apollo-hooks) to connect our Apollo client with our React components. **This library is experimental and shouldn't be used in production yet**.\n+\n+{{{ diffStep 1.6 module=\"client\" files=\"src/components\" }}}\n+\n+Let's install the missing dependencies:\n+\n+    $ yarn add -D @types/moment@2.13.0\n+    $ yarn add graphql-tag@2.10.1 moment@2.24.0 subscriptions-transport-ws@0.9.15 styled-components@4.1.3\n+\n+And add a default profile picture to our assets directory under `public/assets/default-profile-pic.jpg`:\n+\n+![default-profile-pic.jpg](https://user-images.githubusercontent.com/7648874/51983273-38229280-24d3-11e9-98bd-363764dc6d97.jpg)\n+\n+The chats which are currently served by the server already have a picture, but it's not uncommon to have a chat without any picture in our app.\n+\n+Lastly, in order to make the list that we've just created visible, we will mount it at the main app component:\n+\n+{{{ diffStep 1.6 module=\"client\" files=\"src/App.tsx\" }}}\n+\n+Now we should be able to see the chats in the React app! We can test it out by running\n+\n+    # terminal 1\n+    server$ yarn generate\n+    server$ yarn start\n+    # terminal 2\n+    client$ yarn generate\n+    client$ yarn start\n+\n+Everything works, but it's not over yet. Our application can't be based on a served hard-coded JSON. A real app has a database. There are many advantages for using a database over an in-memory or FS stored data:\n+\n+- It is VERY fast, and can deal with large amounts of data.\n+- Data fetching can be optimized by defining indexes.\n+- You need the right read/write permissions which makes it very secure.\n+- Data will persist even if the server crashes or the machine is randomly closed.\n+- A lot more...\n+\n+We will be using [PostgreSQL](https://www.postgresql.org/) (Postgres, in short) as our database with [TypeORM](https://github.com/typeorm/typeorm) as an ORM around Postgres. First make sure that you install Postgres on your machine by following the [official installation instructions](https://www.labkey.org/Documentation/wiki-page.view?name=commonInstall).\n+\n+To make sure the whole shebang works with Node.JS, we will install few packages:\n+\n+    $ yarn add pg@7.8.0 typeorm@0.2.11 reflect-metadata@0.1.12\n+    $ yarn add -D @types/pg@7.4.11\n+\n+> The [`reflect-metadata`](https://www.npmjs.com/package/reflect-metadata) package will emit metadata for JavaScript [decorators](https://github.com/tc39/proposal-decorators). This will be used internally by TypeORM to determine column types based on their corresponding TypeScript type.\n+\n+This would require us to set some configuration so TypeORM would know where and how to connect the DB. We will use the `whatsapp` DB with the `test` username:\n+\n+{{{ diffStep 1.5 module=\"server\" files=\"ormconfig.json, index.ts\" }}}\n+\n+TypeORM wraps the official Postgres driver so you shouldn't worry about interacting with it. Feel free to edit `ormconfig.json` file based on your needs.\n+\n+We will also define the type of expected GraphQL context using Codegen. All we have to do is to create a `context.ts` file and specify it in the `codegen.yml` file:\n+\n+{{{ diffStep 1.5 module=\"server\" files=\"codegen.yml, context.ts\" }}}\n+\n+TypeORM has a very defined structure for organizing a project. Each table in our database, its columns and its relationships should be defined in an entity file under the `entity` folder. Why `entity` folder? Because the `ormconfig.json` says so. This is why originally we defined a TypeScript definition for each entity under a separate file. As for now, we will have 3 entities:\n+\n+- A chat entity.\n+- A message entity.\n+- A user entity.\n+\n+As we make progress, we will add more entities and edit the relationships between them:\n+\n+{{{ diffStep 1.6 module=\"server\" files=\"entity\" }}}\n+\n+Now that we have the entities set, we can make requests to Postgres. Let's edit our resolvers to use the entities:\n+\n+{{{ diffStep 1.6 module=\"server\" files=\"schema\" }}}\n+\n+Notice that we've used a custom scalar type to represent a `Date` object in our GraphQL schema using a package called [`graphql-iso-date`](https://www.npmjs.com/package/graphql-iso-date). Accordingly, let's install this package:\n+\n+    $ yarn add graphql-iso-date@3.6.1\n+    $ yarn add -D @types/graphql-iso-date@3.3.1\n+\n+And update `codegen.yml` to use it in the generated code file:\n+\n+{{{ diffStep 1.6 module=\"server\" files=\"codegen\" }}}\n+\n+Instead of fabricating a DB into the memory, we will replace the `db.ts` module with a function that will add sample data, using entities of course. This will be very convenient because this way we can test our app:\n+\n+{{{ diffStep 1.6 module=\"server\" files=\"db\" }}}\n+\n+Instead of adding the sample data any time we start the server, we will use an `--add-sample-data` flag which will be provided to the server's process:\n+\n+{{{ diffStep 1.6 module=\"server\" files=\"index.ts\" }}}\n+\n+> More about processes can be read [here](https://medium.com/the-guild/getting-to-know-nodes-child-process-module-8ed63038f3fa).\n+\n+Most Apollo-server implementations will assemble the GraphQL schema by importing a bunch of resolvers from different modules, if not having everything in a single place. This often times leads to a lot of problems as maintenance becomes harder the bigger the server gets, especially if we don't have a defined structure. Instead of going with that approach, we will be using [GraphQL-Modules](https://graphql-modules.com) (GQLModules, in short).\n+\n+The idea behind GQLModules is to implement the Separation of Concerns design pattern in GraphQL, and to allow you to write simple modules that only do what they need to. This way it's easier to write, maintain and test. You should get a better understanding of GQLModules as we go further with this tutorial.\n+\n+To setup GQLModules we will install a couple of packages:\n+\n+    $ yarn add @graphql-modules/core@0.4.2 @graphql-modules/sonar@0.4.0 @graphql-modules/di@0.4.0\n+\n+- The `sonar` package will be sued to detect `.graphql` files within our server.\n+- The `di` package is responsible for dependencies injection.\n+\n+Now we're gonna implement a dedicated GraphQL module for each of our entity:\n+\n+{{{ diffStep 1.7 module=\"server\" files=\"modules/(utils|auth|chat|message|user)\" }}}\n+\n+The implementation of the resolvers is NOT implemented in the resolver functions themselves, but rather in a separate provider. With this working model we can import and use the providers in various modules, not necessarily a specific one. In addition, we can mock the provider handlers, which makes it more testable.\n+\n+We've also created a module called `auth`, which will be responsible for authentication in the near future. For now we use a constant for `currentUser` so we can implement the handlers as if we already have authentication.\n+\n+We will use a main GQLModule called `app` to connect all our components and export a unified schema:\n+\n+{{{ diffStep 1.7 module=\"server\" files=\"modules/app\" }}}\n+\n+Accordingly, we will update the server to use the schema exported by the module we've just created\n+\n+{{{ diffStep 1.7 module=\"server\" files=\"index, schema\" }}}\n+\n+Now try to run the app again and see how things work. Of course, there shouldn't be any visual differences, but know that having a DB as an essential step.\n+\n+    $ yarn start --reset-dummy-data\n+\n+In the next step we refactor our back-end so it can be more maintainable, and we will setup a basic authentication mechanism. WhatsApp is not WhatsApp without authentication!\ndiff --git a/.tortilla/manuals/templates/step2.tmpl b/.tortilla/manuals/templates/step2.tmpl\nnew file mode 100644\nindex 0000000..ccb8a26\n--- /dev/null\n+++ b/.tortilla/manuals/templates/step2.tmpl\n@@ -0,0 +1,174 @@\n+![login](https://user-images.githubusercontent.com/7648874/52663083-c9b4ea00-2f40-11e9-9783-bf36fd88e4bb.png)\n+\n+As we're probably all familiar with WhatsApp, the app surrounds around authentication. It's a very crucial part because without authentication there would be no way to identify users and who communicates with whom. On top of all we would like to keep things private, because we don't want personal information to leak to other people. Although the original WhatsApp uses phone authentication with an SMS code, in our app we're gonna keep things simple and use a basic authentication.\n+\n+The authentication flow in the front-end app is simple and consists of the following:\n+\n+- Sign-Up\n+- Sign-In\n+- Settings\n+- Sign-Out\n+\n+The more complicated part comes when we have to match each data with its owner and check if a user is authorized to perform an operation or not.\n+\n+### Server authentication\n+\n+Authentication is a hot topic in the GraphQL world and there are some projects which aim at authenticating through GraphQL. Since often you will be required to use a specific auth framework (because of a feature you need or because of an existing authorization infrastructure) I will show you how to use a classic REST API framework within your GraphQL application. This approach is completely fine and in line with the official GraphQL best practices. We will use `Passport` for the authentication and `BasicAuth` as the auth mechanism:\n+\n+    $ yarn add bcrypt-nodejs@0.0.3 passport@0.4.0 passport-http@0.3.0\n+    $ yarn add -D @types/bcrypt-nodejs@0.0.30 @types/passport@1.0.0 @types/passport-http@0.3.7\n+\n+`BasicAuth` is basically responsible for sending a username and password in an Authorization Header together with each request and it's fully supported by any browser (meaning that we will be able to use Graphiql simply by proving username and password in the login window provided by the browser itself). It's the most simple auth mechanism but it's completely fine for our needs. Later we could decide to use something more complicated like JWT, but it's outside of the scope of this tutorial.\n+\n+We will connect the auth logic to our Express app within the auth GQLModule. Indeed, GQLModules can also be used to apply logic which is not directly related to GraphQL. This method is excellent because it ensures that our GraphQL resolvers will be set with the right infrastructure right out of the box and we can safely reuse the module:\n+\n+{{{ diffStep 2.1 module=\"server\" files=\"app, modules/auth\" }}}\n+\n+We are going to store hashes instead of plain passwords, that's why we're using `bcrypt-nodejs`. With `passport.use('basic-signin')` and `passport.use('basic-signup')` we define how the auth framework deals with our database. `app.post('/signup')` is the endpoint for creating new accounts, so we left it out of the authentication middleware (`app.use(passport.authenticate('basic-signin')`).\n+\n+We will also add an additional query called `me` which will simply return the user which is currently logged in. This will come in handy in the client:\n+\n+{{{ diffStep 2.1 module=\"server\" files=\"modules/user\" }}}\n+\n+### Client authentication\n+\n+To make things more convenient, we will create a dedicated authentication service under a separate module called `auth.service.tsx`. The auth service will take care of:\n+\n+- Performing sign-in/sign-up against the server.\n+- Storing received auth token in local storage.\n+- Providing a wrapper around guarded routes that require authorization.\n+\n+{{{ diffStep 2.1 module=\"client\" files=\"src/services, src/graphql\" }}}\n+\n+The service also includes a `useMe()` GraphQL hook that will fetch the current user. Its definition is separate since it's used vastly and shared between many components.\n+\n+Since we're using token oriented authentication, it means that any time we make a request to our GraphQL back-end we would need to authorize ourselves by sending this token. This can easily be done thanks to Apollo. By setting the client correctly we can automatically set the headers and parameters for each request that is being done.\n+\n+{{{ diffStep 2.1 module=\"client\" files=\"src/apollo-client.ts\" }}}\n+\n+This would require us to install a package called `apollo-link-context`:\n+\n+    $ yarn add apollo-link-context@1.0.14\n+\n+Now that we have that mechanism implemented we need a way to access it. For that purpose we will be implementing a sign-in form and a sign-up form. Once we create a user and sign-in we will be promoted to the main chats list screen.\n+\n+{{{ diffStep 2.2 module=\"client\" files=\"src/components/AuthScreen\" }}}\n+\n+If you'll look at the main AuthScreen component you'll see that we use a router to alternate between the sign-in and the sign-up forms. That's the meaning behind a Switch component. However, you can also notice that we use an AnimatedSwitch. As it sounds, this component will ensure that transition between routes is animated. This upgrade our UX in the app, and it is also designated to be used across other routes. If so, let's implement it. First we will need to install a package called `react-router-transition`:\n+\n+    $ yarn add react-router-transition@1.2.1\n+\n+This will enable the transition between the routes. However, we will need to specify the characteristics of the transition, so, let's implement our own version of AnimatedSwitch:\n+\n+{{{ diffStep 2.2 module=\"client\" files=\"src/components/AnimatedSwitch\" }}}\n+\n+As shown in the screenshot at the top of this page, the auth screen includes few assets that we should download: a background picture and a logo. Please download the assets below and save them in the `public/assets` directory as `chat-background.jpg` and `whatsapp-icon.jpg` respectively:\n+\n+![chat-background.jpg](https://user-images.githubusercontent.com/7648874/51983290-3f49a080-24d3-11e9-9de9-cf57354d1e3a.jpg)\n+\n+![whatsapp-icon.jpg](https://user-images.githubusercontent.com/7648874/52662552-768e6780-2f3f-11e9-931c-36a5c13ca49b.png)\n+\n+So following that, we would need to define a router that will handle changes in routes. We will be using `react-router-dom`:\n+\n+    $ yarn add react-router-dom@4.3.1\n+\n+Now that we have it let's define our routes. Note how we take advantage of the `withAuth()` method to guard our routes and make them available only to users who are authorized:\n+\n+{{{ diffStep 2.3 module=\"client\" files=\"src/App\" }}}\n+\n+Since in our auth service we basically check if the user is logged in by actually querying the server with a React hook, we will need to use a Suspense component that will catch the pending request.\n+\n+{{{ diffStep 2.3 module=\"client\" files=\"src/index\" }}}\n+\n+> It's highly recommended to go through the [docs of Suspense](https://reactjs.org/docs/react-api.html#reactsuspense) before you proceed if you're not familiar with it.\n+\n+Perfect. Now we can sign-in and sign-up, and we can view chats which belong to us. Now we're gonna implement the settings screen, where we will be able to set our profile details, such as name and picture. Let's keep the image uploading thing for a bit later, we will focus on the component itself first. The settings screen layout includes:\n+\n+- A navbar.\n+- A form with inputs.\n+\n+Accordingly, the implementation of the screen should look like so:\n+\n+{{{ diffStep 2.4 module=\"client\" files=\"src/components\" }}}\n+\n+The `optimisticResponse` object is used to predict the response so we can have it immediately and the `update` callback is used to update the cache. Anytime we receive a response from our GraphQL back-end we should update the cache, otherwise the data presented in our app will be out-dated.\n+\n+The user should be updated on 2 scenarios: Either we loose focus on the name input or we upload a new image. We used the [`useEffect`](https://reactjs.org/docs/hooks-effect.html) to determine changes in the profile picture URL and trigger an update.\n+\n+We will need to update our back-end to have an `updateUser` mutation:\n+\n+{{{ diffStep 2.2 module=\"server\" files=\"modules/user\" }}}\n+\n+Remember that a user could be correlated to a chat, for example, if a user changes its information such as name or picture, the chat informationshould be changed as well. This means that we will need to listen to changes with a [subscription](https://www.apollographql.com/docs/react/advanced/subscriptions.html) and update our cache accordingly.\n+\n+Since `react-apollo-hooks` doesn't have a built-in `useSubscription()` hook as for version `0.3.1`, we will implement a polyfill that will do exactly that. First we will ad a utility package:\n+\n+    $ yarn add react-fast-compare@2.0.4\n+\n+And then we will implement the `useSubscription()` hook:\n+\n+{{{ diffStep 2.5 module=\"client\" files=\"src/polyfills\" }}}\n+\n+Then we will define the subscription document and listen to it in a dedicated service called `cache.service`, which is responsible for updating the cache:\n+\n+{{{ diffStep 2.5 module=\"client\" files=\"src/graphql, src/services/cache\" }}}\n+\n+We should listen to subscriptions only once we're logged-in, therefore let's use the `useSubscriptions()` hook that we've just created in the `auth.service`:\n+\n+{{{ diffStep 2.5 module=\"client\" files=\"src/services/auth\" }}}\n+\n+Now we will have to implement the subscription in our server. GraphQL subscriptions are a way to push data from the server to the clients that choose to listen to real time messages from the server. To trigger a subscription event we will use a method called `publish` which is used by a class called `PubSub`. Pubsub sits between your application's logic and the GraphQL subscriptions engine - it receives a publish command from your app logic and pushes it to your GraphQL execution engine. This is how it should look like in code, in relation to `chatUpdated` subscription:\n+\n+{{{ diffStep 2.3 module=\"server\" }}}\n+\n+> See [official Apollo subscription docs page](https://www.apollographql.com/docs/apollo-server/features/subscriptions.html).\n+\n+Note that we've added a second `updateUser()` resolver in addition to the one which already exists in the `user` module. Reason being is because we want to keep the `user` module independent from the `chat` module, and so we apply logic on top of the existing one. GQLModule's engine will execute the resolvers in the right order based on the injected dependencies tree, so you shouldn't worry much about execution.\n+\n+I'd like to get back to the image uploading feature. Although it can be implemented manually, we will be using an external service for storing images. This is much more convenient: it will save us a lot of implementation, it's probably more secure, and it has built-in features such as transformation and projection.\n+\n+We will be using [Cloudinary](https://cloudinary.com/) as our storage service. A Cloudinary instance should be set for each application separately, but for the sake of demonstration we will use an instance that we set up for the public, but just know **that you should never reveal the credentials of any service that you set up**.\n+\n+First of all be sure to open an account and setup your basic app information in Cloudinary.\n+\n+Then, add a new preset called `profile-pic` where we will be resettings uploaded images' dimensions to 300px by 300px. More information on how to do that can be found in [here](https://support.cloudinary.com/hc/en-us/articles/360004967272-Upload-Preset-Configuration).\n+\n+![upload-picture-settings](https://user-images.githubusercontent.com/7648874/51096173-a984f480-17f5-11e9-893f-5227e2c564af.jpg)\n+\n+Up next, we will implement the appropriate route in our app's server. The reason we don't upload the image directly to the cloud service directly from our application is because **we risk exposing some sensitive data regards the service and some users may abuse it**. We will start by installing the right packages:\n+\n+    $ yarn add tmp@0.0.33 multer@1.4.1 cloudinary@1.13.2\n+    $ yarn add -D @types/tmp@0.0.33 @types/multer1.3.7\n+\n+We will also write custom TypeScript definitions for the `cloudinary` package since they don't exist:\n+\n+{{{ diffStep 2.4 module=\"server\" files=\"cloudinary.d.ts\" }}}\n+\n+Then we will set the right API keys in the `.env` file:\n+\n+{{{ diffStep 2.4 module=\"server\" files=\".env\" }}}\n+\n+The purpose of the `.env` file is to load environment variables into our app in a more comfortable way. For that to apply we will need to install and require a package which is called [`dotenv`](https://www.npmjs.com/package/dotenv).\n+\n+    $ yarn add dotenv@6.2.0\n+\n+{{{ diffStep 2.4 module=\"server\" files=\"index\" }}}\n+\n+> See [Cloudinary's NodeJS API](https://cloudinary.com/documentation/node_integration).\n+> See [API setup](https://cloudinary.com/documentation/solution_overview#account_and_api_setup).\n+\n+And finally, we will implement a REST endpoint in the `user` module under `/upload-profile-pic`:\n+\n+{{{ diffStep 2.4 module=\"server\" files=\"modules/user\" }}}\n+\n+Now getting back to the client, we will implement a `picture.service` that will be responsible for uploading images in our application:\n+\n+{{{ diffStep 2.6 module=\"client\" files=\"src/services/picture\" }}}\n+\n+And we will use it in the settings screen:\n+\n+{{{ diffStep 2.6 module=\"client\" files=\"src/components\" }}}\n+\n+The settings component is complete! We will connect it to the main flow by implementing the pop-over menu at the top right corner of the main screen where we will be able to navigate to the settings screen and sign-out:\n+\n+{{{ diffStep 2.7 module=\"client\" }}}\ndiff --git a/.tortilla/manuals/templates/step3.tmpl b/.tortilla/manuals/templates/step3.tmpl\nnew file mode 100644\nindex 0000000..c92715f\n--- /dev/null\n+++ b/.tortilla/manuals/templates/step3.tmpl\n@@ -0,0 +1,100 @@\n+![chats](https://user-images.githubusercontent.com/7648874/52663040-aa1dc180-2f40-11e9-9ae4-bda648916bc4.png)\n+\n+In this step we will be implementing a basic chat app. We will be able to:\n+\n+- Create chats.\n+- Remove chats.\n+- Send messages.\n+\n+The flow is gonna go like this:\n+\n+- A chat can be created by picking a user from the users list.\n+- When clicking on a chat, we will be promoted to a chat room.\n+- The chat room will have a pop-over menu where we will be able to remove the chat.\n+\n+We will start by adding a new entity called `Recipient`. The `Recipient` entity is the bridge between the `User` and the `Message` and it will tell us when the message was received and when it was read. Note that a message holds multiple recipients - this way we can extend its functionality to support group messaging where each message can have more than 2 recipients. Accordingly, we will have to make few adjustments to the existing entities:\n+\n+{{{ diffStep 3.1 module=\"server\" }}}\n+\n+The flow will require us to implement the following GraphQL operations:\n+\n+- `users` query - Will be used to create a chat by picking a user from the users list.\n+- `addMessage` mutation\n+- `addChat` mutation\n+- `removeChat` mutation\n+\n+Accordingly we will define the operations in our schema and implement their resolvers:\n+\n+{{{ diffStep 3.2 module=\"server\" }}}\n+\n+Remember that every change that happens in the back-end should trigger a subscription that will notify all the use regards that change. For the current flow, we should have the following subscriptions:\n+\n+- `messageAdded` subscription\n+- `userAdded` subscription\n+- `userUpdated` subscription - Since we will be able to create a new chat by picking from a users list, this list needs to be synced with the most recent changes.\n+\n+Let's implement these subscriptions:\n+\n+{{{ diffStep 3.3 module=\"server\" }}}\n+\n+Now that we have that ready, we will get back to the client and implement the necessary components. We will start with the chat room screen. The layout consists of the following component:\n+\n+- A navbar - Includes the name and a picture of the person we're chatting with, a \"back\" button to navigate back to the main screen, and a pop-over menu where we can remove the chat from.\n+- A messages list - The list of messages that were sent and received in the chat. This will be a scrollable view where message bubbles are colored differently based on who they belong to. Just like WhatsApp!\n+- A message box - The input that will be used to write the new message. This will include a \"send\" button right next to it.\n+\n+Let's implement the components\n+\n+{{{ diffStep 3.1 module=\"client\" files=\"src/components/ChatRoomScreen\" }}}\n+\n+We're introduced to new 2 packages in the implementation above:\n+\n+- [`uniqid`](https://www.npmjs.com/package/uniqid) - Used to generate a unique ID in our optimistic response.\n+- [`styled-components`](https://www.npmjs.com/package/styled-components) - Used to create encapsulated style for React components.\n+\n+Let's install them then:\n+\n+    $ yarn add uniqid@5.0.3 styled-components@4.1.3\n+\n+You'll notice that there's a new fragment called `fullChat`. The full chat includes the base chat details, plus a list of messages that we're gonna view in the chat room screen. Let's define the fragment then:\n+\n+{{{ diffStep 3.1 module=\"client\" files=\"src/graphql/fragments\" }}}\n+\n+At this point the chat room should be functional. Let's add a dedicated route for it and make it navigatable by clicking on a chat item from the chats list screen:\n+\n+{{{ diffStep 3.1 module=\"client\" files=\"src/App, src/components/ChatsListScreen\" }}}\n+\n+Like we said in the previous step, everything in our application is connected and so whenever there's a mutation or a change in data we should update the cache. Let's define the right subscriptions and update our `cache.service`:\n+\n+{{{ diffStep 3.1 module=\"client\" files=\"src/graphql/subscriptions, src/services/cache\" }}}\n+\n+We've already implemented all the necessary subscription handlers in the server in the beginning of this step, so things should work smoothly.\n+\n+Now we're gonna implement a users list component where we will be able to pick users and chat with them. The users list component is gonna be global to the rest of the components because we will be using it in other screens in the upcoming steps.\n+\n+{{{ diffStep 3.2 module=\"client\" files=\"src/components/UsersList\" }}}\n+\n+Now let's implement the new chat screen:\n+\n+{{{ diffStep 3.2 module=\"client\" files=\"src/components/NewChatScreen\" }}}\n+\n+And implement a dedicated route for it:\n+\n+{{{ diffStep 3.2 module=\"client\" files=\"src/App\" }}}\n+\n+We will also add a button which will redirect us right to the new chat screen:\n+\n+{{{ diffStep 3.2 module=\"client\" files=\"src/components/ChatsListScreen\" }}}\n+\n+Again, we will need to define the right subscriptions and update the cache accordingly:\n+\n+{{{ diffStep 3.2 module=\"client\" files=\"src/graphql/queries, src/graphql/subscriptions, src/services/cache\" }}}\n+\n+Now we have a real, functional chat app! Where we have a complete flow of:\n+\n+- Signing in/up.\n+- Editing profile.\n+- Creating and removing chats.\n+- Sending messages.\n+\n+In the next step we will to something slightly more complex and extend the current functionality by adding a group chatting feature where we will be able to communicate with multiple users in a single chat room.\ndiff --git a/.tortilla/manuals/templates/step4.tmpl b/.tortilla/manuals/templates/step4.tmpl\nnew file mode 100644\nindex 0000000..e8ad2b8\n--- /dev/null\n+++ b/.tortilla/manuals/templates/step4.tmpl\n@@ -0,0 +1,69 @@\n+Group messaging can be quite tricky and so I would like to explain the hierarchy between the entities. `Chat` will have the following fields:\n+\n+- `Chat.actualGroupMembers` - The current users who are currently participating in the group. Once a message was sent by someone in the group, all the members under `actualGroupMembers` will be notified with the target message.\n+\n+- `Chat.listingMembers` - The current users which have the chat listed in their view. Any user who will be kicked out of the group will not only be absent from `Chat.actualGroupMembers`, but it will also be spliced from `Chat.listingMembers`, as its existence in the chat is correlated to what it can currently view.\n+\n+- `Chat.admins` - The users who currently control the group; they will have permissions to add and remove users from the group, and change its name and picture.\n+\n+Together we can have a complete flow where users can chat with each-other in a group. In this step we will add a group-details screen, where we will be able to see the participants of the group, and we will use the existing users list component to select users that we would like to participate in our group chat. The back-end should include a new mutation called `addGroup()` that will help use create chat group.\n+\n+So before we proceed to the front-end, let's take care of the back-end. We will add the missing fields to the Chat entity, and make the necessary adjustments in existing resolvers:\n+\n+{{{ diffStep 4.1 module=\"server\" }}}\n+\n+Now we will add 2 new mutations:\n+\n+- `addGroup` mutation - Responsible for creating chat groups.\n+- `updateChat` mutation - Unlike a single chat which is synced with a user's info, a group chat will be independent, therefore we will need a method that could updated its fields.\n+\n+Let's implement those:\n+\n+{{{ diffStep 4.2 module=\"server\" }}}\n+\n+Now that the back-end is set, we will need to update the chat fragment in the client to contain the new field `isGroup`:\n+\n+{{{ diffStep 4.1 module=\"client\" }}}\n+\n+Now we will create the new-group screen. Like the new-chat screen, it will have an almost identical layout, only the behavior is gonna be slightly different. In the new screen we will be able to select multiple users before we proceed, then, we should be able to view the group details and edit them before we create the group. Let's implement the new-group screen:\n+\n+{{{ diffStep 4.2 module=\"client\" files=\"src/components/NewGroupScreen\" }}}\n+\n+Now we will add a dedicated route, and we will also create a \"New Group\" button which will be presented in the new chat screen. This way we can create a new group from the new chat screen if we want to, by simply clicking on that button and moving on to the new group screen.\n+\n+{{{ diffStep 4.2 module=\"client\" files=\"src/App, src/components/NewChatScreen\" }}}\n+\n+Up-next would be the group details screen. The layout consists of:\n+\n+- A navbar with a back button.\n+- Picture and name inputs.\n+- A horizontal list of all the participants.\n+- A \"complete\" button that will send a mutation request to the server.\n+\n+Once a name has been typed, the \"complete\" button should pop-up. Let's implement the screen then:\n+\n+{{{ diffStep 4.3 module=\"client\" files=\"src/components/GroupDetailsScreen\" }}}\n+\n+This will require us to download a new asset to the `public/assets` directory which represents the default picture for a group. Please save it as `default-group-pic.jpg`:\n+\n+![default-group-pic.jpg](https://user-images.githubusercontent.com/7648874/51983284-3b1d8300-24d3-11e9-9f8b-afe36a3b9df1.jpg)\n+\n+Let's add a route for the screen we've just created:\n+\n+{{{ diffStep 4.3 module=\"client\" files=\"src/App\" }}}\n+\n+There's one last thing missing in the flow and that would be migrating existing components to work well with the new feature of group chats.\n+\n+Starting with the chats list component, we would like to display the default profile picture for group chats:\n+\n+{{{ diffStep 4.4 module=\"client\" files=\"src/components/ChatsListScreen\" }}}\n+\n+In the messages list component, we would like to display the name of the owner of the message, so we would know exactly who sent it in case we're in a group chat:\n+\n+{{{ diffStep 4.4 module=\"client\" files=\"src/components/ChatRoomScreen/MessagesList\" }}}\n+\n+And now what we're gonna do is basically use the group details screen to show the details of the group that we're currently at. If we're an admin of the group, we would be able to edit its details, and if not, we will only be able to view its details without changing any of it. The view and some of the logic are the same whether it's a new group or an existing one, but there are slight differences. To deal with the differences, we will use \"if\" statements before we use the hooks, but **beware whenever you do that!** If you'll use an expression that is likely to change during the component's lifespan, you should NOT use a hook inside the \"if\" statement's block, because the React engine relies on the hooks to be called in a similar order.\n+\n+{{{ diffStep 4.3 module=\"client\" files=\"src/components/ChatRoomScreen/ChatNavBar, src/components/GroupDetailsScreen\" }}}\n+\n+That's it! Now we should be able to create group chats and message multiple people at once.\ndiff --git a/client/.env b/client/.env\nnew file mode 100644\nindex 0000000..9321fd6\n--- /dev/null\n+++ b/client/.env\n@@ -0,0 +1 @@\n+REACT_APP_SERVER_URL=http://localhost:4000\ndiff --git a/client/.gitignore b/client/.gitignore\nnew file mode 100644\nindex 0000000..5171c54\n--- /dev/null\n+++ b/client/.gitignore\n@@ -0,0 +1,2 @@\n+node_modules\n+npm-debug.log\n\\ No newline at end of file\ndiff --git a/client/LICENSE b/client/LICENSE\nnew file mode 100644\nindex 0000000..ca7f5e8\n--- /dev/null\n+++ b/client/LICENSE\n@@ -0,0 +1,21 @@\n+The MIT License (MIT)\n+\n+Copyright (c) 2019 Uri Goldshtein\n+\n+Permission is hereby granted, free of charge, to any person obtaining a copy\n+of this software and associated documentation files (the \"Software\"), to deal\n+in the Software without restriction, including without limitation the rights\n+to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+copies of the Software, and to permit persons to whom the Software is\n+furnished to do so, subject to the following conditions:\n+\n+The above copyright notice and this permission notice shall be included in all\n+copies or substantial portions of the Software.\n+\n+THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+SOFTWARE.\ndiff --git a/client/codegen-interpreter.ts b/client/codegen-interpreter.ts\nnew file mode 100644\nindex 0000000..ee27c4c\n--- /dev/null\n+++ b/client/codegen-interpreter.ts\n@@ -0,0 +1,6 @@\n+require('ts-node').register({\n+  transpileOnly: true,\n+  compilerOptions: {\n+    module: 'commonjs'\n+  }\n+})\ndiff --git a/client/codegen.yml b/client/codegen.yml\nnew file mode 100644\nindex 0000000..48d0843\n--- /dev/null\n+++ b/client/codegen.yml\n@@ -0,0 +1,12 @@\n+schema: ../WhatsApp-Clone-Server/schema.ts\n+documents:\n+  - ./src/**/*.tsx\n+  - ./src/**/*.ts\n+overwrite: true\n+require:\n+  - ts-node/../../codegen-interpreter.ts\n+generates:\n+  ./src/graphql/types.ts:\n+    plugins:\n+      - typescript-common\n+      - typescript-client\ndiff --git a/client/package.json b/client/package.json\nnew file mode 100644\nindex 0000000..c8308af\n--- /dev/null\n+++ b/client/package.json\n@@ -0,0 +1,61 @@\n+{\n+  \"name\": \"whatsapp-clone-client\",\n+  \"version\": \"0.1.0\",\n+  \"private\": true,\n+  \"repository\": {\n+    \"type\": \"git\",\n+    \"url\": \"https://Urigo@github.com/Urigo/WhatsApp-Clone-Client-React.git\"\n+  },\n+  \"dependencies\": {\n+    \"@material-ui/core\": \"3.9.2\",\n+    \"@material-ui/icons\": \"3.0.2\",\n+    \"@types/moment\": \"2.13.0\",\n+    \"apollo-cache-inmemory\": \"1.5.1\",\n+    \"apollo-client\": \"2.5.1\",\n+    \"apollo-link\": \"1.2.9\",\n+    \"apollo-link-context\": \"1.0.15\",\n+    \"apollo-link-http\": \"1.5.12\",\n+    \"apollo-link-ws\": \"1.0.15\",\n+    \"apollo-utilities\": \"1.2.1\",\n+    \"graphql\": \"14.1.1\",\n+    \"graphql-tag\": \"2.10.1\",\n+    \"moment\": \"2.24.0\",\n+    \"react\": \"16.8.4\",\n+    \"react-apollo-hooks\": \"0.4.3\",\n+    \"react-dom\": \"16.8.4\",\n+    \"react-fast-compare\": \"2.0.4\",\n+    \"react-router-dom\": \"4.3.1\",\n+    \"react-router-transition\": \"1.3.0\",\n+    \"react-scripts\": \"2.1.8\",\n+    \"styled-components\": \"4.1.3\",\n+    \"subscriptions-transport-ws\": \"0.9.16\",\n+    \"uniqid\": \"5.0.3\"\n+  },\n+  \"devDependencies\": {\n+    \"@types/graphql\": \"14.0.7\",\n+    \"@types/node\": \"11.11.3\",\n+    \"concurrently\": \"4.1.0\",\n+    \"graphql-code-generator\": \"0.18.0\",\n+    \"graphql-codegen-typescript-client\": \"0.18.0\",\n+    \"graphql-codegen-typescript-common\": \"0.18.0\",\n+    \"nodemon\": \"1.18.10\",\n+    \"ts-node\": \"8.0.3\"\n+  },\n+  \"scripts\": {\n+    \"start\": \"concurrently \\\"yarn generate:watch\\\" \\\"react-scripts start\\\"\",\n+    \"build\": \"react-scripts build\",\n+    \"test\": \"react-scripts test\",\n+    \"eject\": \"react-scripts eject\",\n+    \"generate\": \"gql-gen\",\n+    \"generate:watch\": \"nodemon --exec yarn generate -e graphql\"\n+  },\n+  \"eslintConfig\": {\n+    \"extends\": \"react-app\"\n+  },\n+  \"browserslist\": [\n+    \">0.2%\",\n+    \"not dead\",\n+    \"not ie <= 11\",\n+    \"not op_mini all\"\n+  ]\n+}\n\\ No newline at end of file\ndiff --git a/client/public/assets/chat-background.jpg b/client/public/assets/chat-background.jpg\nnew file mode 100644\nindex 0000000..12cf45c\nBinary files /dev/null and b/client/public/assets/chat-background.jpg differ\ndiff --git a/client/public/assets/default-group-pic.jpg b/client/public/assets/default-group-pic.jpg\nnew file mode 100644\nindex 0000000..ea2b844\nBinary files /dev/null and b/client/public/assets/default-group-pic.jpg differ\ndiff --git a/client/public/assets/default-profile-pic.jpg b/client/public/assets/default-profile-pic.jpg\nnew file mode 100644\nindex 0000000..d73721b\nBinary files /dev/null and b/client/public/assets/default-profile-pic.jpg differ\ndiff --git a/client/public/assets/whatsapp-icon.png b/client/public/assets/whatsapp-icon.png\nnew file mode 100644\nindex 0000000..ef4c897\nBinary files /dev/null and b/client/public/assets/whatsapp-icon.png differ\ndiff --git a/client/public/favicon.ico b/client/public/favicon.ico\nnew file mode 100755\nindex 0000000..a11777c\nBinary files /dev/null and b/client/public/favicon.ico differ\ndiff --git a/client/public/index.html b/client/public/index.html\nnew file mode 100755\nindex 0000000..323182f\n--- /dev/null\n+++ b/client/public/index.html\n@@ -0,0 +1,41 @@\n+<!DOCTYPE html>\n+<html lang=\"en\">\n+  <head>\n+    <meta charset=\"utf-8\" />\n+    <link rel=\"shortcut icon\" href=\"%PUBLIC_URL%/favicon.ico\" />\n+    <meta\n+      name=\"viewport\"\n+      content=\"width=device-width, initial-scale=1, shrink-to-fit=no\"\n+    />\n+    <meta name=\"theme-color\" content=\"#000000\" />\n+    <!--\n+      manifest.json provides metadata used when your web app is added to the\n+      homescreen on Android. See https://developers.google.com/web/fundamentals/web-app-manifest/\n+    -->\n+    <link rel=\"manifest\" href=\"%PUBLIC_URL%/manifest.json\" />\n+    <!--\n+      Notice the use of %PUBLIC_URL% in the tags above.\n+      It will be replaced with the URL of the `public` folder during the build.\n+      Only files inside the `public` folder can be referenced from the HTML.\n+\n+      Unlike \"/favicon.ico\" or \"favicon.ico\", \"%PUBLIC_URL%/favicon.ico\" will\n+      work correctly both with client-side routing and a non-root public URL.\n+      Learn how to configure a non-root public URL by running `npm run build`.\n+    -->\n+    <title>React App</title>\n+  </head>\n+  <body>\n+    <noscript>You need to enable JavaScript to run this app.</noscript>\n+    <div id=\"root\"></div>\n+    <!--\n+      This HTML file is a template.\n+      If you open it directly in the browser, you will see an empty page.\n+\n+      You can add webfonts, meta tags, or analytics to this file.\n+      The build step will place the bundled scripts into the <body> tag.\n+\n+      To begin the development, run `npm start` or `yarn start`.\n+      To create a production bundle, use `npm run build` or `yarn build`.\n+    -->\n+  </body>\n+</html>\ndiff --git a/client/public/manifest.json b/client/public/manifest.json\nnew file mode 100755\nindex 0000000..1f2f141\n--- /dev/null\n+++ b/client/public/manifest.json\n@@ -0,0 +1,15 @@\n+{\n+  \"short_name\": \"React App\",\n+  \"name\": \"Create React App Sample\",\n+  \"icons\": [\n+    {\n+      \"src\": \"favicon.ico\",\n+      \"sizes\": \"64x64 32x32 24x24 16x16\",\n+      \"type\": \"image/x-icon\"\n+    }\n+  ],\n+  \"start_url\": \".\",\n+  \"display\": \"standalone\",\n+  \"theme_color\": \"#000000\",\n+  \"background_color\": \"#ffffff\"\n+}\ndiff --git a/client/src/App.css b/client/src/App.css\nnew file mode 100755\nindex 0000000..92f956e\n--- /dev/null\n+++ b/client/src/App.css\n@@ -0,0 +1,32 @@\n+.App {\n+  text-align: center;\n+}\n+\n+.App-logo {\n+  animation: App-logo-spin infinite 20s linear;\n+  height: 40vmin;\n+}\n+\n+.App-header {\n+  background-color: #282c34;\n+  min-height: 100vh;\n+  display: flex;\n+  flex-direction: column;\n+  align-items: center;\n+  justify-content: center;\n+  font-size: calc(10px + 2vmin);\n+  color: white;\n+}\n+\n+.App-link {\n+  color: #61dafb;\n+}\n+\n+@keyframes App-logo-spin {\n+  from {\n+    transform: rotate(0deg);\n+  }\n+  to {\n+    transform: rotate(360deg);\n+  }\n+}\ndiff --git a/client/src/App.test.tsx b/client/src/App.test.tsx\nnew file mode 100755\nindex 0000000..a754b20\n--- /dev/null\n+++ b/client/src/App.test.tsx\n@@ -0,0 +1,9 @@\n+import React from 'react';\n+import ReactDOM from 'react-dom';\n+import App from './App';\n+\n+it('renders without crashing', () => {\n+  const div = document.createElement('div');\n+  ReactDOM.render(<App />, div);\n+  ReactDOM.unmountComponentAtNode(div);\n+});\ndiff --git a/client/src/App.tsx b/client/src/App.tsx\nnew file mode 100755\nindex 0000000..964d761\n--- /dev/null\n+++ b/client/src/App.tsx\n@@ -0,0 +1,31 @@\n+import * as React from 'react'\n+import { BrowserRouter, Route, Redirect } from 'react-router-dom'\n+import ChatRoomScreen from './components/ChatRoomScreen'\n+import NewChatScreen from './components/NewChatScreen'\n+import AnimatedSwitch from './components/AnimatedSwitch'\n+import AuthScreen from './components/AuthScreen'\n+import ChatsListScreen from './components/ChatsListScreen'\n+import GroupDetailsScreen from './components/GroupDetailsScreen'\n+import SettingsScreen from './components/SettingsScreen'\n+import NewGroupScreen from './components/NewGroupScreen'\n+import { withAuth } from './services/auth.service'\n+\n+const RedirectToChats = () => (\n+  <Redirect to=\"/chats\" />\n+)\n+\n+export default () => (\n+  <BrowserRouter>\n+    <AnimatedSwitch>\n+      <Route exact path=\"/sign-(in|up)\" component={AuthScreen} />\n+      <Route exact path=\"/chats\" component={withAuth(ChatsListScreen)} />\n+      <Route exact path=\"/settings\" component={withAuth(SettingsScreen)} />\n+      <Route exact path=\"/chats/:chatId\" component={withAuth(ChatRoomScreen)} />\n+      <Route exact path=\"/new-chat\" component={withAuth(NewChatScreen)} />\n+      <Route exact path=\"/new-chat/group\" component={withAuth(NewGroupScreen)} />\n+      <Route exact path=\"/new-chat/group/details\" component={withAuth(GroupDetailsScreen)} />\n+      <Route exact path=\"/chats/:chatId/details\" component={withAuth(GroupDetailsScreen)} />\n+      <Route component={RedirectToChats} />\n+    </AnimatedSwitch>\n+  </BrowserRouter>\n+)\ndiff --git a/client/src/apollo-client.ts b/client/src/apollo-client.ts\nnew file mode 100644\nindex 0000000..b9fbab1\n--- /dev/null\n+++ b/client/src/apollo-client.ts\n@@ -0,0 +1,54 @@\n+import { InMemoryCache } from 'apollo-cache-inmemory'\n+import { ApolloClient } from 'apollo-client'\n+import { ApolloLink, split } from 'apollo-link'\n+import { setContext } from 'apollo-link-context'\n+import { HttpLink } from 'apollo-link-http'\n+import { WebSocketLink } from 'apollo-link-ws'\n+import { getMainDefinition } from 'apollo-utilities'\n+import { OperationDefinitionNode } from 'graphql'\n+import { getAuthHeader } from './services/auth.service'\n+\n+const httpUri = process.env.REACT_APP_SERVER_URL + '/graphql'\n+const wsUri = httpUri.replace(/^https?/, 'ws')\n+\n+const httpLink = new HttpLink({\n+  uri: httpUri,\n+})\n+\n+const wsLink = new WebSocketLink({\n+  uri: wsUri,\n+  options: {\n+    reconnect: true,\n+    connectionParams: () => ({\n+      authToken: getAuthHeader(),\n+    }),\n+  },\n+})\n+\n+const authLink = setContext((_, { headers }) => {\n+  const auth = getAuthHeader()\n+\n+  return {\n+    headers: {\n+      ...headers,\n+      Authorization: auth,\n+    },\n+  }\n+})\n+\n+const terminatingLink = split(\n+  ({ query }) => {\n+    const { kind, operation } = getMainDefinition(query) as OperationDefinitionNode\n+    return kind === 'OperationDefinition' && operation === 'subscription'\n+  },\n+  wsLink,\n+  authLink.concat(httpLink),\n+)\n+\n+const link = ApolloLink.from([terminatingLink])\n+const cache = new InMemoryCache()\n+\n+export default new ApolloClient({\n+  link,\n+  cache,\n+})\ndiff --git a/client/src/components/AnimatedSwitch.tsx b/client/src/components/AnimatedSwitch.tsx\nnew file mode 100644\nindex 0000000..a7522ab\n--- /dev/null\n+++ b/client/src/components/AnimatedSwitch.tsx\n@@ -0,0 +1,30 @@\n+import styled from 'styled-components'\n+import { AnimatedSwitch, spring } from 'react-router-transition'\n+\n+const glide = val =>\n+  spring(val, {\n+    stiffness: 174,\n+    damping: 24,\n+  })\n+\n+const mapStyles = styles => ({\n+  transform: `translateX(${styles.offset}%)`,\n+})\n+\n+export default styled(AnimatedSwitch).attrs(() => ({\n+  atEnter: { offset: 100 },\n+  atLeave: { offset: glide(-100) },\n+  atActive: { offset: glide(0) },\n+  mapStyles,\n+}))`\n+  position: relative;\n+  overflow: hidden;\n+  width: 100%;\n+  height: 100%;\n+  > div {\n+    position: absolute;\n+    overflow: hidden;\n+    width: 100%;\n+    height: 100%;\n+  }\n+`\ndiff --git a/client/src/components/AuthScreen/SignInForm.tsx b/client/src/components/AuthScreen/SignInForm.tsx\nnew file mode 100644\nindex 0000000..4f8ef5c\n--- /dev/null\n+++ b/client/src/components/AuthScreen/SignInForm.tsx\n@@ -0,0 +1,84 @@\n+import Button from '@material-ui/core/Button'\n+import TextField from '@material-ui/core/TextField'\n+import { History } from 'history'\n+import * as React from 'react'\n+import { useState } from 'react'\n+import { signIn } from '../../services/auth.service'\n+\n+interface SignInFormProps {\n+  history: History\n+}\n+\n+export default ({ history }: SignInFormProps) => {\n+  const [username, setUsername] = useState('')\n+  const [password, setPassword] = useState('')\n+  const [error, setError] = useState('')\n+\n+  const onUsernameChange = ({ target }) => {\n+    setError('')\n+    setUsername(target.value)\n+  }\n+\n+  const onPasswordChange = ({ target }) => {\n+    setError('')\n+    setPassword(target.value)\n+  }\n+\n+  const maySignIn = () => {\n+    return !!(username && password)\n+  }\n+\n+  const handleSignIn = () => {\n+    signIn({ username, password })\n+      .then(() => {\n+        history.push('/chats')\n+      })\n+      .catch(error => {\n+        setError(error.message || error)\n+      })\n+  }\n+\n+  const handleSignUp = () => {\n+    history.push('/sign-up')\n+  }\n+\n+  return (\n+    <div className=\"SignInForm Screen\">\n+      <form>\n+        <legend>Sign in</legend>\n+        <div style={{ width: '100%' }}>\n+          <TextField\n+            className=\"AuthScreen-text-field\"\n+            label=\"Username\"\n+            value={username}\n+            onChange={onUsernameChange}\n+            margin=\"normal\"\n+            placeholder=\"Enter your username\"\n+          />\n+          <TextField\n+            className=\"AuthScreen-text-field\"\n+            label=\"Password\"\n+            type=\"password\"\n+            value={password}\n+            onChange={onPasswordChange}\n+            margin=\"normal\"\n+            placeholder=\"Enter your password\"\n+          />\n+        </div>\n+        <Button\n+          type=\"button\"\n+          color=\"secondary\"\n+          variant=\"contained\"\n+          disabled={!maySignIn()}\n+          onClick={handleSignIn}\n+        >\n+          Sign in\n+        </Button>\n+        <div className=\"AuthScreen-error\">{error}</div>\n+        <span className=\"AuthScreen-alternative\">\n+          Don't have an account yet? <a onClick={handleSignUp}>Sign up!</a>\n+        </span>\n+      </form>\n+    </div>\n+  )\n+}\ndiff --git a/client/src/components/AuthScreen/SignUpForm.tsx b/client/src/components/AuthScreen/SignUpForm.tsx\nnew file mode 100644\nindex 0000000..b486bbc\n--- /dev/null\n+++ b/client/src/components/AuthScreen/SignUpForm.tsx\n@@ -0,0 +1,127 @@\n+import Button from '@material-ui/core/Button'\n+import TextField from '@material-ui/core/TextField'\n+import { History } from 'history'\n+import * as React from 'react'\n+import { useState } from 'react'\n+import { signUp } from '../../services/auth.service'\n+\n+interface SignUpFormProps {\n+  history: History\n+}\n+\n+export default ({ history }: SignUpFormProps) => {\n+  const [name, setName] = useState('')\n+  const [username, setUsername] = useState('')\n+  const [oldPassword, setOldPassword] = useState('')\n+  const [password, setPassword] = useState('')\n+  const [error, setError] = useState('')\n+\n+  const updateName = ({ target }) => {\n+    setError('')\n+    setName(target.value)\n+  }\n+\n+  const updateUsername = ({ target }) => {\n+    setError('')\n+    setUsername(target.value)\n+  }\n+\n+  const updateOldPassword = ({ target }) => {\n+    setError('')\n+    setOldPassword(target.value)\n+  }\n+\n+  const updateNewPassword = ({ target }) => {\n+    setError('')\n+    setPassword(target.value)\n+  }\n+\n+  const maySignUp = () => {\n+    return !!(name && username && oldPassword && oldPassword === password)\n+  }\n+\n+  const handleSignUp = () => {\n+    signUp({ username, password, name })\n+      .then(() => {\n+        history.push('/sign-in')\n+      })\n+      .catch(error => {\n+        setError(error.message || error)\n+      })\n+  }\n+\n+  const handleSignIn = () => {\n+    history.push('/sign-in')\n+  }\n+\n+  return (\n+    <div className=\"SignUpForm Screen\">\n+      <form>\n+        <legend>Sign up</legend>\n+        <div\n+          style={{\n+            float: 'left',\n+            width: 'calc(50% - 10px)',\n+            paddingRight: '10px',\n+          }}\n+        >\n+          <TextField\n+            className=\"AuthScreen-text-field\"\n+            label=\"Name\"\n+            value={name}\n+            onChange={updateName}\n+            autoComplete=\"off\"\n+            margin=\"normal\"\n+          />\n+          <TextField\n+            className=\"AuthScreen-text-field\"\n+            label=\"Username\"\n+            value={username}\n+            onChange={updateUsername}\n+            autoComplete=\"off\"\n+            margin=\"normal\"\n+          />\n+        </div>\n+        <div\n+          style={{\n+            float: 'right',\n+            width: 'calc(50% - 10px)',\n+            paddingLeft: '10px',\n+          }}\n+        >\n+          <TextField\n+            className=\"AuthScreen-text-field\"\n+            label=\"Old password\"\n+            type=\"password\"\n+            value={oldPassword}\n+            onChange={updateOldPassword}\n+            autoComplete=\"off\"\n+            margin=\"normal\"\n+          />\n+          <TextField\n+            className=\"AuthScreen-text-field\"\n+            label=\"New password\"\n+            type=\"password\"\n+            value={password}\n+            onChange={updateNewPassword}\n+            autoComplete=\"off\"\n+            margin=\"normal\"\n+          />\n+        </div>\n+        <Button\n+          type=\"button\"\n+          color=\"secondary\"\n+          variant=\"contained\"\n+          disabled={!maySignUp()}\n+          onClick={handleSignUp}\n+        >\n+          Sign up\n+        </Button>\n+        <div className=\"AuthScreen-error\">{error}</div>\n+        <span className=\"AuthScreen-alternative\">\n+          Already have an accout? <a onClick={handleSignIn}>Sign in!</a>\n+        </span>\n+      </form>\n+    </div>\n+  )\n+}\ndiff --git a/client/src/components/AuthScreen/index.tsx b/client/src/components/AuthScreen/index.tsx\nnew file mode 100644\nindex 0000000..e321f08\n--- /dev/null\n+++ b/client/src/components/AuthScreen/index.tsx\n@@ -0,0 +1,118 @@\n+import * as React from 'react'\n+import { RouteComponentProps } from 'react-router-dom'\n+import { Route } from 'react-router-dom'\n+import styled from 'styled-components'\n+import AnimatedSwitch from '../AnimatedSwitch'\n+import SignInForm from './SignInForm'\n+import SignUpForm from './SignUpForm'\n+\n+const Style = styled.div`\n+  background: radial-gradient(rgb(34, 65, 67), rgb(17, 48, 50)),\n+    url(/assets/chat-background.jpg) no-repeat;\n+  background-size: cover;\n+  background-blend-mode: multiply;\n+  color: white;\n+\n+  .AuthScreen-intro {\n+    height: 265px;\n+  }\n+\n+  .AuthScreen-icon {\n+    width: 125px;\n+    height: auto;\n+    margin-left: auto;\n+    margin-right: auto;\n+    padding-top: 70px;\n+    display: block;\n+  }\n+\n+  .AuthScreen-title {\n+    width: 100%;\n+    text-align: center;\n+    color: white;\n+  }\n+\n+  .AuthScreen-text-field {\n+    width: 100%;\n+    position: relative;\n+  }\n+\n+  .AuthScreen-text-field > div::before {\n+    border-color: white !important;\n+  }\n+\n+  .AuthScreen-error {\n+    position: absolute;\n+    color: red;\n+    font-size: 15px;\n+    margin-top: 20px;\n+  }\n+\n+  .AuthScreen-alternative {\n+    position: absolute;\n+    bottom: 10px;\n+    left: 10px;\n+\n+    a {\n+      color: var(--secondary-bg);\n+    }\n+  }\n+\n+  .Screen {\n+    height: calc(100% - 265px);\n+  }\n+\n+  form {\n+    padding: 20px;\n+\n+    > div {\n+      padding-bottom: 35px;\n+    }\n+  }\n+\n+  legend {\n+    font-weight: bold;\n+    color: white;\n+  }\n+\n+  label {\n+    color: white !important;\n+  }\n+\n+  input {\n+    color: white;\n+\n+    &::placeholder {\n+      color: var(--primary-bg);\n+    }\n+  }\n+\n+  button {\n+    width: 100px;\n+    display: block;\n+    margin-left: auto;\n+    margin-right: auto;\n+    background-color: var(--secondary-bg) !important;\n+\n+    &[disabled] {\n+      color: #38a81c;\n+    }\n+\n+    &:not([disabled]) {\n+      color: white;\n+    }\n+  }\n+`\n+\n+export default ({ history, location }: RouteComponentProps) => (\n+  <Style className=\"AuthScreen Screen\">\n+    <div className=\"AuthScreen-intro\">\n+      <img src=\"assets/whatsapp-icon.png\" className=\"AuthScreen-icon\" />\n+      <h2 className=\"AuthScreen-title\">WhatsApp Clone</h2>\n+    </div>\n+    <AnimatedSwitch>\n+      <Route exact path=\"/sign-in\" component={SignInForm} />\n+      <Route exact path=\"/sign-up\" component={SignUpForm} />\n+    </AnimatedSwitch>\n+  </Style>\n+)\ndiff --git a/client/src/components/ChatRoomScreen/ChatNavbar.tsx b/client/src/components/ChatRoomScreen/ChatNavbar.tsx\nnew file mode 100644\nindex 0000000..9ddce52\n--- /dev/null\n+++ b/client/src/components/ChatRoomScreen/ChatNavbar.tsx\n@@ -0,0 +1,187 @@\n+import Button from '@material-ui/core/Button'\n+import List from '@material-ui/core/List'\n+import ListItem from '@material-ui/core/ListItem'\n+import Popover from '@material-ui/core/Popover'\n+import ArrowBackIcon from '@material-ui/icons/ArrowBack'\n+import DeleteIcon from '@material-ui/icons/Delete'\n+import InfoIcon from '@material-ui/icons/Info'\n+import MoreIcon from '@material-ui/icons/MoreVert'\n+import { defaultDataIdFromObject } from 'apollo-cache-inmemory'\n+import gql from 'graphql-tag'\n+import { History } from 'history'\n+import * as React from 'react'\n+import { useState } from 'react'\n+import { useQuery, useMutation } from 'react-apollo-hooks'\n+import styled from 'styled-components'\n+import * as fragments from '../../graphql/fragments'\n+import * as queries from '../../graphql/queries'\n+import { ChatNavbarMutation, ChatNavbarQuery, Chats } from '../../graphql/types'\n+\n+const Style = styled.div`\n+  padding: 0;\n+  display: flex;\n+  flex-direction: row;\n+\n+  margin-left: -20px;\n+  .ChatNavbar-title {\n+    line-height: 56px;\n+  }\n+\n+  .ChatNavbar-back-button {\n+    color: var(--primary-text);\n+  }\n+\n+  .ChatNavbar-picture {\n+    height: 40px;\n+    width: 40px;\n+    margin-top: 3px;\n+    margin-left: -22px;\n+    object-fit: cover;\n+    padding: 5px;\n+    border-radius: 50%;\n+  }\n+\n+  .ChatNavbar-rest {\n+    flex: 1;\n+    justify-content: flex-end;\n+  }\n+\n+  .ChatNavbar-options-btn {\n+    float: right;\n+    height: 100%;\n+    font-size: 1.2em;\n+    margin-right: -15px;\n+    color: var(--primary-text);\n+  }\n+\n+  .ChatNavbar-options-item svg {\n+    margin-right: 10px;\n+    padding-left: 15px;\n+  }\n+`\n+\n+const query = gql`\n+  query ChatNavbarQuery($chatId: ID!) {\n+    chat(chatId: $chatId) {\n+      ...Chat\n+    }\n+  }\n+  ${fragments.chat}\n+`\n+\n+const mutation = gql`\n+  mutation ChatNavbarMutation($chatId: ID!) {\n+    removeChat(chatId: $chatId)\n+  }\n+`\n+\n+interface ChatNavbarProps {\n+  chatId: string\n+  history: History\n+}\n+\n+export default ({ chatId, history }: ChatNavbarProps) => {\n+  const {\n+    data: { chat },\n+  } = useQuery<ChatNavbarQuery.Query, ChatNavbarQuery.Variables>(query, {\n+    variables: { chatId },\n+    suspend: true,\n+  })\n+  const removeChat = useMutation<ChatNavbarMutation.Mutation, ChatNavbarMutation.Variables>(\n+    mutation,\n+    {\n+      variables: { chatId },\n+      update: (client, { data: { removeChat } }) => {\n+        client.writeFragment({\n+          id: defaultDataIdFromObject({\n+            __typename: 'Chat',\n+            id: removeChat,\n+          }),\n+          fragment: fragments.chat,\n+          fragmentName: 'Chat',\n+          data: null,\n+        })\n+\n+        let chats\n+        try {\n+          chats = client.readQuery<Chats.Query>({\n+            query: queries.chats,\n+          }).chats\n+        } catch (e) {}\n+\n+        if (chats && chats.some(chat => chat.id === removeChat)) {\n+          const index = chats.findIndex(chat => chat.id === removeChat)\n+          chats.splice(index, 1)\n+\n+          client.writeQuery({\n+            query: queries.chats,\n+            data: { chats },\n+          })\n+        }\n+      },\n+    },\n+  )\n+  const [popped, setPopped] = useState(false)\n+\n+  const navToChats = () => {\n+    history.push('/chats')\n+  }\n+\n+  const navToGroupDetails = () => {\n+    setPopped(false)\n+    history.push(`/chats/${chatId}/details`, { chat })\n+  }\n+\n+  const handleRemoveChat = () => {\n+    setPopped(false)\n+    removeChat().then(navToChats)\n+  }\n+\n+  return (\n+    <Style className={name}>\n+      <Button className=\"ChatNavbar-back-button\" onClick={navToChats}>\n+        <ArrowBackIcon />\n+      </Button>\n+      <img\n+        className=\"ChatNavbar-picture\"\n+        src={\n+          chat.picture ||\n+          (chat.isGroup ? '/assets/default-group-pic.jpg' : '/assets/default-profile-pic.jpg')\n+        }\n+      />\n+      <div className=\"ChatNavbar-title\">{chat.name}</div>\n+      <div className=\"ChatNavbar-rest\">\n+        <Button className=\"ChatNavbar-options-btn\" onClick={setPopped.bind(null, true)}>\n+          <MoreIcon />\n+        </Button>\n+      </div>\n+      <Popover\n+        open={popped}\n+        onClose={setPopped.bind(null, false)}\n+        anchorOrigin={{\n+          vertical: 'top',\n+          horizontal: 'right',\n+        }}\n+        transformOrigin={{\n+          vertical: 'top',\n+          horizontal: 'right',\n+        }}\n+      >\n+        <Style style={{ marginLeft: '-15px' }}>\n+          <List>\n+            {chat.isGroup && (\n+              <ListItem className=\"ChatNavbar-options-item\" button onClick={navToGroupDetails}>\n+                <InfoIcon />\n+                Details\n+              </ListItem>\n+            )}\n+            <ListItem className=\"ChatNavbar-options-item\" button onClick={handleRemoveChat}>\n+              <DeleteIcon />\n+              Delete\n+            </ListItem>\n+          </List>\n+        </Style>\n+      </Popover>\n+    </Style>\n+  )\n+}\ndiff --git a/client/src/components/ChatRoomScreen/MessageBox.tsx b/client/src/components/ChatRoomScreen/MessageBox.tsx\nnew file mode 100644\nindex 0000000..9097533\n--- /dev/null\n+++ b/client/src/components/ChatRoomScreen/MessageBox.tsx\n@@ -0,0 +1,162 @@\n+import Button from '@material-ui/core/Button'\n+import SendIcon from '@material-ui/icons/Send'\n+import { defaultDataIdFromObject } from 'apollo-cache-inmemory'\n+import gql from 'graphql-tag'\n+import * as React from 'react'\n+import { useState } from 'react'\n+import { useMutation } from 'react-apollo-hooks'\n+import styled from 'styled-components'\n+import { time as uniqid } from 'uniqid'\n+import * as fragments from '../../graphql/fragments'\n+import { MessageBoxMutation, FullChat, Message } from '../../graphql/types'\n+import { useMe } from '../../services/auth.service'\n+\n+const Style = styled.div`\n+  display: flex;\n+  height: 50px;\n+  padding: 5px;\n+  width: calc(100% - 10px);\n+\n+  .MessageBox-input {\n+    width: calc(100% - 50px);\n+    border: none;\n+    border-radius: 999px;\n+    padding: 10px;\n+    padding-left: 20px;\n+    padding-right: 20px;\n+    font-size: 15px;\n+    outline: none;\n+    box-shadow: 0 1px silver;\n+    font-size: 18px;\n+    line-height: 45px;\n+  }\n+\n+  .MessageBox-button {\n+    min-width: 50px;\n+    width: 50px;\n+    border-radius: 999px;\n+    background-color: var(--primary-bg);\n+    margin: 0 5px;\n+    margin-right: 0;\n+    color: white;\n+    padding-left: 20px;\n+    svg {\n+      margin-left: -3px;\n+    }\n+  }\n+`\n+\n+const mutation = gql`\n+  mutation MessageBoxMutation($chatId: ID!, $content: String!) {\n+    addMessage(chatId: $chatId, content: $content) {\n+      ...Message\n+    }\n+  }\n+  ${fragments.message}\n+`\n+\n+interface MessageBoxProps {\n+  chatId: string\n+}\n+\n+export default ({ chatId }: MessageBoxProps) => {\n+  const [message, setMessage] = useState('')\n+  const me = useMe()\n+\n+  const addMessage = useMutation<MessageBoxMutation.Mutation, MessageBoxMutation.Variables>(\n+    mutation,\n+    {\n+      variables: {\n+        chatId,\n+        content: message,\n+      },\n+      optimisticResponse: {\n+        __typename: 'Mutation',\n+        addMessage: {\n+          id: uniqid(),\n+          __typename: 'Message',\n+          chat: {\n+            id: chatId,\n+            __typename: 'Chat',\n+          },\n+          sender: {\n+            id: me.id,\n+            __typename: 'User',\n+            name: me.name,\n+          },\n+          content: message,\n+          createdAt: new Date(),\n+          type: 0,\n+          recipients: [],\n+          ownership: true,\n+        },\n+      },\n+      update: (client, { data: { addMessage } }) => {\n+        client.writeFragment({\n+          id: defaultDataIdFromObject(addMessage),\n+          fragment: fragments.message,\n+          data: addMessage,\n+        })\n+\n+        let fullChat\n+        try {\n+          fullChat = client.readFragment<FullChat.Fragment>({\n+            id: defaultDataIdFromObject(addMessage.chat),\n+            fragment: fragments.fullChat,\n+            fragmentName: 'FullChat',\n+          })\n+        } catch (e) {}\n+\n+        if (fullChat && !fullChat.messages.some(message => message.id === addMessage.id)) {\n+          fullChat.messages.push(addMessage)\n+          fullChat.lastMessage = addMessage\n+\n+          client.writeFragment({\n+            id: defaultDataIdFromObject(addMessage.chat),\n+            fragment: fragments.fullChat,\n+            fragmentName: 'FullChat',\n+            data: fullChat,\n+          })\n+        }\n+      },\n+    },\n+  )\n+\n+  const onKeyPress = e => {\n+    if (e.charCode === 13) {\n+      submitMessage()\n+    }\n+  }\n+\n+  const onChange = ({ target }) => {\n+    setMessage(target.value)\n+  }\n+\n+  const submitMessage = () => {\n+    if (!message) return\n+\n+    addMessage()\n+    setMessage('')\n+  }\n+\n+  return (\n+    <Style className=\"MessageBox\">\n+      <input\n+        className=\"MessageBox-input\"\n+        type=\"text\"\n+        placeholder=\"Type a message\"\n+        value={message}\n+        onKeyPress={onKeyPress}\n+        onChange={onChange}\n+      />\n+      <Button\n+        variant=\"contained\"\n+        color=\"primary\"\n+        className=\"MessageBox-button\"\n+        onClick={submitMessage}\n+      >\n+        <SendIcon />\n+      </Button>\n+    </Style>\n+  )\n+}\ndiff --git a/client/src/components/ChatRoomScreen/MessagesList.tsx b/client/src/components/ChatRoomScreen/MessagesList.tsx\nnew file mode 100644\nindex 0000000..26988ac\n--- /dev/null\n+++ b/client/src/components/ChatRoomScreen/MessagesList.tsx\n@@ -0,0 +1,147 @@\n+import gql from 'graphql-tag'\n+import * as moment from 'moment'\n+import * as React from 'react'\n+import { useRef, useEffect } from 'react'\n+import { useQuery, useMutation } from 'react-apollo-hooks'\n+import * as ReactDOM from 'react-dom'\n+import styled from 'styled-components'\n+import * as fragments from '../../graphql/fragments'\n+import { MessagesListQuery } from '../../graphql/types'\n+\n+const Style = styled.div`\n+  display: block;\n+  height: calc(100% - 60px);\n+  width: calc(100% - 30px);\n+  overflow-y: overlay;\n+  padding: 0 15px;\n+\n+  .MessagesList-message {\n+    display: inline-block;\n+    position: relative;\n+    max-width: 100%;\n+    border-radius: 7px;\n+    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.15);\n+    margin-top: 10px;\n+    margin-bottom: 10px;\n+    clear: both;\n+\n+    &::after {\n+      content: '';\n+      display: table;\n+      clear: both;\n+    }\n+  }\n+\n+  .MessagesList-message-mine {\n+    float: right;\n+    background-color: #dcf8c6;\n+\n+    &::before {\n+      right: -11px;\n+      background-image: url(/assets/message-mine.png);\n+    }\n+  }\n+\n+  .MessagesList-message-others {\n+    float: left;\n+    background-color: #fff;\n+\n+    &::before {\n+      left: -11px;\n+      background-image: url(/assets/message-other.png);\n+    }\n+  }\n+\n+  .MessagesList-message-others::before,\n+  .MessagesList-message-mine::before {\n+    content: '';\n+    position: absolute;\n+    bottom: 3px;\n+    width: 12px;\n+    height: 19px;\n+    background-position: 50% 50%;\n+    background-repeat: no-repeat;\n+    background-size: contain;\n+  }\n+\n+  .MessagesList-message-sender {\n+    font-weight: bold;\n+    margin-left: 5px;\n+    margin-top: 5px;\n+  }\n+\n+  .MessagesList-message-contents {\n+    padding: 5px 7px;\n+    word-wrap: break-word;\n+\n+    &::after {\n+      content: ' \\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0';\n+      display: inline;\n+    }\n+  }\n+\n+  .MessagesList-message-timestamp {\n+    position: absolute;\n+    bottom: 2px;\n+    right: 7px;\n+    color: gray;\n+    font-size: 12px;\n+  }\n+`\n+\n+const query = gql`\n+  query MessagesListQuery($chatId: ID!) {\n+    chat(chatId: $chatId) {\n+      ...FullChat\n+    }\n+  }\n+  ${fragments.fullChat}\n+`\n+\n+interface MessagesListProps {\n+  chatId: string\n+}\n+\n+export default ({ chatId }: MessagesListProps) => {\n+  const {\n+    data: {\n+      chat: { messages, isGroup },\n+    },\n+  } = useQuery<MessagesListQuery.Query, MessagesListQuery.Variables>(query, {\n+    variables: { chatId },\n+    suspend: true,\n+  })\n+  const selfRef = useRef(null)\n+\n+  const resetScrollTop = () => {\n+    if (!selfRef.current) return\n+\n+    const selfDOMNode = ReactDOM.findDOMNode(selfRef.current) as HTMLElement\n+    selfDOMNode.scrollTop = Number.MAX_SAFE_INTEGER\n+  }\n+\n+  useEffect(resetScrollTop, [selfRef.current])\n+  useEffect(resetScrollTop, [messages.length])\n+\n+  return (\n+    <Style className={name} ref={selfRef}>\n+      {messages &&\n+        messages.map(message => (\n+          <div\n+            key={message.id}\n+            className={`MessagesList-message ${\n+              message.ownership ? 'MessagesList-message-mine' : 'MessagesList-message-others'\n+            }`}\n+          >\n+            {isGroup && !message.ownership && (\n+              <div className=\"MessagesList-message-sender\">{message.sender.name}</div>\n+            )}\n+            <div className=\"MessagesList-message-contents\">{message.content}</div>\n+            <span className=\"MessagesList-message-timestamp\">\n+              {moment(message.createdAt).format('HH:mm')}\n+            </span>\n+          </div>\n+        ))}\n+    </Style>\n+  )\n+}\ndiff --git a/client/src/components/ChatRoomScreen/index.tsx b/client/src/components/ChatRoomScreen/index.tsx\nnew file mode 100644\nindex 0000000..1a59a6b\n--- /dev/null\n+++ b/client/src/components/ChatRoomScreen/index.tsx\n@@ -0,0 +1,56 @@\n+import * as React from 'react'\n+import { Suspense } from 'react'\n+import { RouteComponentProps } from 'react-router-dom'\n+import styled from 'styled-components'\n+import Navbar from '../Navbar'\n+import ChatNavbar from './ChatNavbar'\n+import MessageBox from './MessageBox'\n+import MessagesList from './MessagesList'\n+\n+const Style = styled.div`\n+  .ChatScreen-body {\n+    position: relative;\n+    background: url(/assets/chat-background.jpg);\n+    width: 100%;\n+    height: calc(100% - 56px);\n+\n+    .MessagesList {\n+      position: absolute;\n+      height: calc(100% - 60px);\n+      top: 0;\n+    }\n+\n+    .MessageBox {\n+      position: absolute;\n+      bottom: 0;\n+      left: 0;\n+    }\n+\n+    .AddChatButton {\n+      right: 0;\n+      bottom: 0;\n+    }\n+  }\n+`\n+\n+export default ({ match, history }: RouteComponentProps) => {\n+  const chatId = match.params.chatId\n+\n+  return (\n+    <Style className=\"ChatScreen Screen\">\n+      <Navbar>\n+        <Suspense fallback={null}>\n+          <ChatNavbar chatId={chatId} history={history} />\n+        </Suspense>\n+      </Navbar>\n+      <div className=\"ChatScreen-body\">\n+        <Suspense fallback={null}>\n+          <MessagesList chatId={chatId} />\n+        </Suspense>\n+        <Suspense fallback={null}>\n+          <MessageBox chatId={chatId} />\n+        </Suspense>\n+      </div>\n+    </Style>\n+  )\n+}\ndiff --git a/client/src/components/ChatsListScreen/AddChatButton.tsx b/client/src/components/ChatsListScreen/AddChatButton.tsx\nnew file mode 100644\nindex 0000000..cc02ede\n--- /dev/null\n+++ b/client/src/components/ChatsListScreen/AddChatButton.tsx\n@@ -0,0 +1,38 @@\n+import Button from '@material-ui/core/Button'\n+import ChatIcon from '@material-ui/icons/Chat'\n+import { History } from 'history'\n+import * as React from 'react'\n+import styled from 'styled-components'\n+\n+const Style = styled.div`\n+  position: fixed;\n+  right: 10px;\n+  bottom: 10px;\n+\n+  button {\n+    min-width: 50px;\n+    width: 50px;\n+    height: 50px;\n+    border-radius: 999px;\n+    background-color: var(--secondary-bg);\n+    color: white;\n+  }\n+`\n+\n+interface AddChatButtonProps {\n+  history: History\n+}\n+\n+export default ({ history }: AddChatButtonProps) => {\n+  const onClick = () => {\n+    history.push('/new-chat')\n+  }\n+\n+  return (\n+    <Style className=\"AddChatButton\">\n+      <Button variant=\"contained\" color=\"secondary\" onClick={onClick}>\n+        <ChatIcon />\n+      </Button>\n+    </Style>\n+  )\n+}\ndiff --git a/client/src/components/ChatsListScreen/ChatsList.tsx b/client/src/components/ChatsListScreen/ChatsList.tsx\nnew file mode 100644\nindex 0000000..73ebf07\n--- /dev/null\n+++ b/client/src/components/ChatsListScreen/ChatsList.tsx\n@@ -0,0 +1,123 @@\n+import List from '@material-ui/core/List'\n+import ListItem from '@material-ui/core/ListItem'\n+import gql from 'graphql-tag'\n+import { History } from 'history'\n+import * as moment from 'moment'\n+import * as React from 'react'\n+import { useQuery } from 'react-apollo-hooks'\n+import * as ReactDOM from 'react-dom'\n+import styled from 'styled-components'\n+import * as fragments from '../../graphql/fragments'\n+import { ChatsListQuery } from '../../graphql/types'\n+\n+const Style = styled.div`\n+  height: calc(100% - 56px);\n+  overflow-y: overlay;\n+\n+  .ChatsList-chats-list {\n+    padding: 0;\n+  }\n+\n+  .ChatsList-chat-item {\n+    height: 76px;\n+    padding: 0 15px;\n+    display: flex;\n+  }\n+\n+  .ChatsList-profile-pic {\n+    height: 50px;\n+    width: 50px;\n+    object-fit: cover;\n+    border-radius: 50%;\n+  }\n+\n+  .ChatsList-info {\n+    width: calc(100% - 60px);\n+    height: calc(100% - 30px);\n+    padding: 15px 0;\n+    margin-left: 10px;\n+    border-bottom: 0.5px solid silver;\n+    position: relative;\n+  }\n+\n+  .ChatsList-name {\n+    margin-top: 5px;\n+  }\n+\n+  .ChatsList-last-message {\n+    color: gray;\n+    font-size: 15px;\n+    margin-top: 5px;\n+    text-overflow: ellipsis;\n+    overflow: hidden;\n+    white-space: nowrap;\n+  }\n+\n+  .ChatsList-timestamp {\n+    position: absolute;\n+    color: gray;\n+    top: 20px;\n+    right: 0;\n+    font-size: 13px;\n+  }\n+`\n+\n+const query = gql`\n+  query ChatsListQuery {\n+    chats {\n+      ...Chat\n+    }\n+  }\n+\n+  ${fragments.chat}\n+`\n+\n+interface ChatsListProps {\n+  history: History\n+}\n+\n+export default ({ history }: ChatsListProps) => {\n+  const {\n+    data: { chats },\n+  } = useQuery<ChatsListQuery.Query>(query, { suspend: true })\n+\n+  const navToChat = chatId => {\n+    history.push(`chats/${chatId}`)\n+  }\n+\n+  return (\n+    <Style className=\"ChatsList\">\n+      <List className=\"ChatsList-chats-list\">\n+        {chats.map(chat => (\n+          <ListItem\n+            key={chat.id}\n+            className=\"ChatsList-chat-item\"\n+            button\n+            onClick={navToChat.bind(null, chat.id)}\n+          >\n+            <img\n+              className=\"ChatsList-profile-pic\"\n+              src={\n+                chat.picture ||\n+                (chat.isGroup\n+                  ? '/assets/default-group-pic.jpg'\n+                  : '/assets/default-profile-pic.jpg')\n+              }\n+            />\n+            <div className=\"ChatsList-info\">\n+              <div className=\"ChatsList-name\">{chat.name}</div>\n+              {chat.lastMessage && (\n+                <React.Fragment>\n+                  <div className=\"ChatsList-last-message\">{chat.lastMessage.content}</div>\n+                  <div className=\"ChatsList-timestamp\">\n+                    {moment(chat.lastMessage.createdAt).format('HH:mm')}\n+                  </div>\n+                </React.Fragment>\n+              )}\n+            </div>\n+          </ListItem>\n+        ))}\n+      </List>\n+    </Style>\n+  )\n+}\ndiff --git a/client/src/components/ChatsListScreen/ChatsNavbar.tsx b/client/src/components/ChatsListScreen/ChatsNavbar.tsx\nnew file mode 100644\nindex 0000000..9201cbf\n--- /dev/null\n+++ b/client/src/components/ChatsListScreen/ChatsNavbar.tsx\n@@ -0,0 +1,95 @@\n+import Button from '@material-ui/core/Button'\n+import List from '@material-ui/core/List'\n+import ListItem from '@material-ui/core/ListItem'\n+import Popover from '@material-ui/core/Popover'\n+import MoreIcon from '@material-ui/icons/MoreVert'\n+import SignOutIcon from '@material-ui/icons/PowerSettingsNew'\n+import SettingsIcon from '@material-ui/icons/Settings'\n+import { History } from 'history'\n+import * as React from 'react'\n+import { useState } from 'react'\n+import styled from 'styled-components'\n+import { signOut } from '../../services/auth.service'\n+\n+const Style = styled.div`\n+  padding: 0;\n+  display: flex;\n+  flex-direction: row;\n+\n+  .ChatsNavbar-title {\n+    line-height: 56px;\n+  }\n+\n+  .ChatsNavbar-options-btn {\n+    float: right;\n+    height: 100%;\n+    font-size: 1.2em;\n+    margin-right: -15px;\n+    color: var(--primary-text);\n+  }\n+\n+  .ChatsNavbar-rest {\n+    flex: 1;\n+    justify-content: flex-end;\n+  }\n+\n+  .ChatsNavbar-options-item svg {\n+    margin-right: 10px;\n+  }\n+`\n+\n+interface ChatsNavbarProps {\n+  history: History\n+}\n+\n+export default ({ history }: ChatsNavbarProps) => {\n+  const [popped, setPopped] = useState(false)\n+\n+  const navToSettings = () => {\n+    setPopped(false)\n+    history.push('/settings')\n+  }\n+\n+  const handleSignOut = () => {\n+    setPopped(false)\n+    signOut()\n+\n+    history.push('/sign-in')\n+  }\n+\n+  return (\n+    <Style className=\"ChatsNavbar\">\n+      <span className=\"ChatsNavbar-title\">WhatsApp Clone</span>\n+      <div className=\"ChatsNavbar-rest\">\n+        <Button className=\"ChatsNavbar-options-btn\" onClick={setPopped.bind(null, true)}>\n+          <MoreIcon />\n+        </Button>\n+      </div>\n+      <Popover\n+        open={popped}\n+        onClose={setPopped.bind(null, false)}\n+        anchorOrigin={{\n+          vertical: 'top',\n+          horizontal: 'right',\n+        }}\n+        transformOrigin={{\n+          vertical: 'top',\n+          horizontal: 'right',\n+        }}\n+      >\n+        <Style>\n+          <List>\n+            <ListItem className=\"ChatsNavbar-options-item\" button onClick={navToSettings}>\n+              <SettingsIcon />\n+              Settings\n+            </ListItem>\n+            <ListItem className=\"ChatsNavbar-options-item\" button onClick={handleSignOut}>\n+              <SignOutIcon />\n+              Sign Out\n+            </ListItem>\n+          </List>\n+        </Style>\n+      </Popover>\n+    </Style>\n+  )\n+}\ndiff --git a/client/src/components/ChatsListScreen/index.tsx b/client/src/components/ChatsListScreen/index.tsx\nnew file mode 100644\nindex 0000000..bbbd36e\n--- /dev/null\n+++ b/client/src/components/ChatsListScreen/index.tsx\n@@ -0,0 +1,19 @@\n+import * as React from 'react'\n+import { Suspense } from 'react'\n+import { RouteComponentProps } from 'react-router-dom'\n+import Navbar from '../Navbar'\n+import AddChatButton from './AddChatButton'\n+import ChatsList from './ChatsList'\n+import ChatsNavbar from './ChatsNavbar'\n+\n+export default ({ history }: RouteComponentProps) => (\n+  <div className=\"ChatsListScreen Screen\">\n+    <Navbar>\n+      <ChatsNavbar history={history} />\n+    </Navbar>\n+    <Suspense fallback={null}>\n+      <ChatsList history={history} />\n+    </Suspense>\n+    <AddChatButton history={history} />\n+  </div>\n+)\ndiff --git a/client/src/components/GroupDetailsScreen/CompleteGroupButton.tsx b/client/src/components/GroupDetailsScreen/CompleteGroupButton.tsx\nnew file mode 100644\nindex 0000000..604246a\n--- /dev/null\n+++ b/client/src/components/GroupDetailsScreen/CompleteGroupButton.tsx\n@@ -0,0 +1,114 @@\n+import Button from '@material-ui/core/Button'\n+import ArrowRightIcon from '@material-ui/icons/ArrowRightAlt'\n+import { defaultDataIdFromObject } from 'apollo-cache-inmemory'\n+import gql from 'graphql-tag'\n+import { History } from 'history'\n+import * as React from 'react'\n+import { useMutation } from 'react-apollo-hooks'\n+import styled from 'styled-components'\n+import { time as uniqid } from 'uniqid'\n+import * as fragments from '../../graphql/fragments'\n+import * as queries from '../../graphql/queries'\n+import { Chats, User, CompleteGroupButtonMutation } from '../../graphql/types'\n+import { useMe } from '../../services/auth.service'\n+\n+const Style = styled.div`\n+  position: fixed;\n+  right: 10px;\n+  bottom: 10px;\n+\n+  button {\n+    min-width: 50px;\n+    width: 50px;\n+    height: 50px;\n+    border-radius: 999px;\n+    background-color: var(--secondary-bg);\n+    color: white;\n+  }\n+`\n+\n+const mutation = gql`\n+  mutation CompleteGroupButtonMutation(\n+    $userIds: [ID!]!\n+    $groupName: String!\n+    $groupPicture: String\n+  ) {\n+    addGroup(userIds: $userIds, groupName: $groupName, groupPicture: $groupPicture) {\n+      ...Chat\n+    }\n+  }\n+  ${fragments.chat}\n+`\n+\n+interface CompleteGroupButtonProps {\n+  history: History\n+  users: User.Fragment[]\n+  groupName: string\n+  groupPicture: string\n+}\n+\n+export default ({ history, users, groupName, groupPicture }: CompleteGroupButtonProps) => {\n+  const me = useMe()\n+\n+  const addGroup = useMutation<\n+    CompleteGroupButtonMutation.Mutation,\n+    CompleteGroupButtonMutation.Variables\n+  >(mutation, {\n+    optimisticResponse: {\n+      __typename: 'Mutation',\n+      addGroup: {\n+        __typename: 'Chat',\n+        id: uniqid(),\n+        name: groupName,\n+        picture: groupPicture,\n+        allTimeMembers: users,\n+        owner: me,\n+        isGroup: true,\n+        lastMessage: null,\n+      },\n+    },\n+    variables: {\n+      userIds: users.map(user => user.id),\n+      groupName,\n+      groupPicture,\n+    },\n+    update: (client, { data: { addGroup } }) => {\n+      client.writeFragment({\n+        id: defaultDataIdFromObject(addGroup),\n+        fragment: fragments.chat,\n+        fragmentName: 'Chat',\n+        data: addGroup,\n+      })\n+\n+      let chats\n+      try {\n+        chats = client.readQuery<Chats.Query>({\n+          query: queries.chats,\n+        }).chats\n+      } catch (e) {}\n+\n+      if (chats && !chats.some(chat => chat.id === addGroup.id)) {\n+        chats.unshift(addGroup)\n+\n+        client.writeQuery({\n+          query: queries.chats,\n+          data: { chats },\n+        })\n+      }\n+    },\n+  })\n+\n+  const onClick = () => {\n+    addGroup().then(({ data: { addGroup } }) => {\n+      history.push(`/chats/${addGroup.id}`)\n+    })\n+  }\n+\n+  return (\n+    <Style className=\"CompleteGroupButton\">\n+      <Button variant=\"contained\" color=\"secondary\" onClick={onClick}>\n+        <ArrowRightIcon />\n+      </Button>\n+    </Style>\n+  )\n+}\ndiff --git a/client/src/components/GroupDetailsScreen/GroupDetailsNavbar.tsx b/client/src/components/GroupDetailsScreen/GroupDetailsNavbar.tsx\nnew file mode 100644\nindex 0000000..3763fa6\n--- /dev/null\n+++ b/client/src/components/GroupDetailsScreen/GroupDetailsNavbar.tsx\n@@ -0,0 +1,44 @@\n+import Button from '@material-ui/core/Button'\n+import ArrowBackIcon from '@material-ui/icons/ArrowBack'\n+import { History } from 'history'\n+import * as React from 'react'\n+import styled from 'styled-components'\n+\n+const Style = styled.div`\n+  padding: 0;\n+  display: flex;\n+  flex-direction: row;\n+  margin-left: -20px;\n+\n+  .GroupDetailsNavbar-title {\n+    line-height: 56px;\n+  }\n+\n+  .GroupDetailsNavbar-back-button {\n+    color: var(--primary-text);\n+  }\n+`\n+\n+interface GroupDetailsNavbarProps {\n+  history: History\n+  chatId?: string\n+}\n+\n+export default ({ history, chatId }: GroupDetailsNavbarProps) => {\n+  const navToNewGroup = () => {\n+    if (chatId) {\n+      history.push(`/chats/${chatId}`)\n+    } else {\n+      history.push('/new-chat/group')\n+    }\n+  }\n+\n+  return (\n+    <Style className=\"GroupDetailsNavbar\">\n+      <Button className=\"GroupDetailsNavbar-back-button\" onClick={navToNewGroup}>\n+        <ArrowBackIcon />\n+      </Button>\n+      <div className=\"GroupDetailsNavbar-title\">Group Details</div>\n+    </Style>\n+  )\n+}\ndiff --git a/client/src/components/GroupDetailsScreen/index.tsx b/client/src/components/GroupDetailsScreen/index.tsx\nnew file mode 100644\nindex 0000000..3dbf68f\n--- /dev/null\n+++ b/client/src/components/GroupDetailsScreen/index.tsx\n@@ -0,0 +1,254 @@\n+import TextField from '@material-ui/core/TextField'\n+import { defaultDataIdFromObject } from 'apollo-cache-inmemory'\n+import gql from 'graphql-tag'\n+import * as React from 'react'\n+import { useState, useEffect } from 'react'\n+import { MutationHookOptions } from 'react-apollo-hooks'\n+import { useQuery, useMutation } from 'react-apollo-hooks'\n+import { Redirect } from 'react-router-dom'\n+import { RouteComponentProps } from 'react-router-dom'\n+import styled from 'styled-components'\n+import * as fragments from '../../graphql/fragments'\n+import { GroupDetailsScreenQuery, GroupDetailsScreenMutation, User } from '../../graphql/types'\n+import { useMe } from '../../services/auth.service'\n+import { pickPicture, uploadProfilePicture } from '../../services/picture.service'\n+import Navbar from '../Navbar'\n+import CompleteGroupButton from './CompleteGroupButton'\n+import GroupDetailsNavbar from './GroupDetailsNavbar'\n+\n+const Style = styled.div`\n+  .GroupDetailsScreen-group-name {\n+    width: calc(100% - 30px);\n+    margin: 15px;\n+  }\n+\n+  .GroupDetailsScreen-participants-title {\n+    margin-top: 10px;\n+    margin-left: 15px;\n+  }\n+\n+  .GroupDetailsScreen-participants-list {\n+    display: flex;\n+    overflow: overlay;\n+    padding: 0;\n+  }\n+\n+  .GroupDetailsScreen-participant-item {\n+    padding: 10px;\n+    flex-flow: row wrap;\n+    text-align: center;\n+  }\n+\n+  .GroupDetailsScreen-participant-picture {\n+    flex: 0 1 50px;\n+    height: 50px;\n+    width: 50px;\n+    object-fit: cover;\n+    border-radius: 50%;\n+    display: block;\n+    margin-left: auto;\n+    margin-right: auto;\n+  }\n+\n+  .GroupDetailsScreen-group-info {\n+    display: flex;\n+    flex-direction: row;\n+    align-items: center;\n+  }\n+\n+  .GroupDetailsScreen-participant-name {\n+    line-height: 10px;\n+    font-size: 14px;\n+  }\n+\n+  .GroupDetailsScreen-group-picture {\n+    width: 50px;\n+    flex-basis: 50px;\n+    border-radius: 50%;\n+    margin-left: 15px;\n+    object-fit: cover;\n+    ${props => props.ownedByMe && 'cursor: pointer;'}\n+  }\n+`\n+\n+const query = gql`\n+  query GroupDetailsScreenQuery($chatId: ID!) {\n+    chat(chatId: $chatId) {\n+      ...Chat\n+    }\n+  }\n+  ${fragments.chat}\n+`\n+\n+const mutation = gql`\n+  mutation GroupDetailsScreenMutation($chatId: ID!, $name: String, $picture: String) {\n+    updateGroup(chatId: $chatId, groupName: $name, groupPicture: $picture) {\n+      ...Chat\n+    }\n+  }\n+  ${fragments.chat}\n+`\n+\n+export default ({ location, match, history }: RouteComponentProps) => {\n+  const chatId = match.params.chatId\n+  const me = useMe()\n+\n+  let ownedByMe: boolean\n+  let users: User.Fragment[]\n+  let participants: User.Fragment[]\n+  let updateChat: () => any\n+  let chatNameState\n+  let chatPictureState\n+\n+  // The entire component functionality will be determined by the provided route param\n+  if (chatId) {\n+    const {\n+      data: { chat },\n+    } = useQuery<GroupDetailsScreenQuery.Query, GroupDetailsScreenQuery.Variables>(query, {\n+      variables: { chatId },\n+      suspend: true,\n+    })\n+    ownedByMe = chat.owner.id === me.id\n+    users = chat.allTimeMembers\n+    participants = users.slice()\n+\n+    // Read-only if not owned by me\n+    if (ownedByMe) {\n+      chatNameState = useState(chat.name)\n+      chatPictureState = useState(chat.picture)\n+    } else {\n+      chatNameState = [chat.name, () => {}]\n+      chatPictureState = [chat.picture, () => {}]\n+    }\n+\n+    const [chatName] = chatNameState\n+    const [chatPicture] = chatPictureState\n+\n+    updateChat = useMutation<\n+      GroupDetailsScreenMutation.Mutation,\n+      GroupDetailsScreenMutation.Variables\n+    >(mutation, {\n+      variables: {\n+        chatId,\n+        name: chatName,\n+        picture: chatPicture,\n+      },\n+      optimisticResponse: {\n+        __typename: 'Mutation',\n+        updateGroup: {\n+          ...chat,\n+          __typename: 'Chat',\n+          picture: chatPicture,\n+          name: chatName,\n+        },\n+      },\n+      update: (client, { data: { updateGroup } }) => {\n+        chat.picture = updateGroup.picture\n+        chat.name = updateGroup.name\n+\n+        client.writeFragment({\n+          id: defaultDataIdFromObject(chat),\n+          fragment: fragments.chat,\n+          fragmentName: 'Chat',\n+          data: chat,\n+        })\n+      },\n+    })\n+\n+    // Update picture once changed\n+    useEffect(\n+      () => {\n+        if (chatPicture !== chat.picture) {\n+          updateChat()\n+        }\n+      },\n+      [chatPicture],\n+    )\n+  } else {\n+    ownedByMe = true\n+    updateChat = () => {}\n+    chatNameState = useState('')\n+    chatPictureState = useState('')\n+    users = location.state.users\n+    participants = [me].concat(users)\n+  }\n+\n+  // Users are missing from state\n+  if (!(users instanceof Array)) {\n+    return <Redirect to=\"/chats\" />\n+  }\n+\n+  // Put me first\n+  {\n+    const index = participants.findIndex(participant => participant.id === me.id)\n+    participants.splice(index, 1)\n+    participants.unshift(me)\n+  }\n+\n+  const [chatName, setChatName] = chatNameState\n+  const [chatPicture, setChatPicture] = chatPictureState\n+\n+  const updateChatName = ({ target }) => {\n+    setChatName(target.value)\n+  }\n+\n+  const updateChatPicture = async () => {\n+    // You have to be an admin\n+    if (!ownedByMe) return\n+\n+    const file = await pickPicture()\n+\n+    if (!file) return\n+\n+    const { url } = await uploadProfilePicture(file)\n+\n+    setChatPicture(url)\n+  }\n+\n+  return (\n+    <Style className=\"GroupDetailsScreen Screen\" ownedByMe={ownedByMe}>\n+      <Navbar>\n+        <GroupDetailsNavbar chatId={chatId} history={history} />\n+      </Navbar>\n+      <div className=\"GroupDetailsScreen-group-info\">\n+        <img\n+          className=\"GroupDetailsScreen-group-picture\"\n+          src={chatPicture || '/assets/default-group-pic.jpg'}\n+          onClick={updateChatPicture}\n+        />\n+        <TextField\n+          label=\"Group name\"\n+          placeholder=\"Enter group name\"\n+          className=\"GroupDetailsScreen-group-name\"\n+          value={chatName}\n+          onChange={updateChatName}\n+          onBlur={updateChat}\n+          disabled={!ownedByMe}\n+          autoFocus={true}\n+        />\n+      </div>\n+      <div className=\"GroupDetailsScreen-participants-title\">\n+        Participants: {participants.length}\n+      </div>\n+      <ul className=\"GroupDetailsScreen-participants-list\">\n+        {participants.map(participant => (\n+          <div key={participant.id} className=\"GroupDetailsScreen-participant-item\">\n+            <img\n+              src={participant.picture || '/assets/default-profile-pic.jpg'}\n+              className=\"GroupDetailsScreen-participant-picture\"\n+            />\n+            <span className=\"GroupDetailsScreen-participant-name\">{participant.name}</span>\n+          </div>\n+        ))}\n+      </ul>\n+      {!chatId && chatName && (\n+        <CompleteGroupButton\n+          history={history}\n+          groupName={chatName}\n+          groupPicture={chatPicture}\n+          users={users}\n+        />\n+      )}\n+    </Style>\n+  )\n+}\ndiff --git a/client/src/components/Navbar.tsx b/client/src/components/Navbar.tsx\nnew file mode 100644\nindex 0000000..fd52289\n--- /dev/null\n+++ b/client/src/components/Navbar.tsx\n@@ -0,0 +1,24 @@\n+import Toolbar from '@material-ui/core/Toolbar'\n+import * as React from 'react'\n+import styled from 'styled-components'\n+\n+const Style = styled(Toolbar)`\n+  background-color: var(--primary-bg);\n+  color: var(--primary-text);\n+  font-size: 20px;\n+  line-height: 40px;\n+\n+  .Navbar-body {\n+    width: 100%;\n+  }\n+`\n+\n+interface NavbarProps {\n+  children: any\n+}\n+\n+export default ({ children }: NavbarProps) => (\n+  <Style className=\"Navbar\">\n+    <div className=\"Navbar-body\">{children}</div>\n+  </Style>\n+)\ndiff --git a/client/src/components/NewChatScreen/NewChatNavbar.tsx b/client/src/components/NewChatScreen/NewChatNavbar.tsx\nnew file mode 100644\nindex 0000000..d0bb3d1\n--- /dev/null\n+++ b/client/src/components/NewChatScreen/NewChatNavbar.tsx\n@@ -0,0 +1,39 @@\n+import Button from '@material-ui/core/Button'\n+import ArrowBackIcon from '@material-ui/icons/ArrowBack'\n+import { History } from 'history'\n+import * as React from 'react'\n+import styled from 'styled-components'\n+\n+const Style = styled.div`\n+  padding: 0;\n+  display: flex;\n+  flex-direction: row;\n+  margin-left: -20px;\n+\n+  .NewChatNavbar-title {\n+    line-height: 56px;\n+  }\n+\n+  .NewChatNavbar-back-button {\n+    color: var(--primary-text);\n+  }\n+`\n+\n+interface NewChatNavbarProps {\n+  history: History\n+}\n+\n+export default ({ history }: NewChatNavbarProps) => {\n+  const navToChats = () => {\n+    history.push('/chats')\n+  }\n+\n+  return (\n+    <Style className=\"NewChatNavbar\">\n+      <Button className=\"NewChatNavbar-back-button\" onClick={navToChats}>\n+        <ArrowBackIcon />\n+      </Button>\n+      <div className=\"NewChatNavbar-title\">New Chat</div>\n+    </Style>\n+  )\n+}\ndiff --git a/client/src/components/NewChatScreen/NewGroupButton.tsx b/client/src/components/NewChatScreen/NewGroupButton.tsx\nnew file mode 100644\nindex 0000000..48bd761\n--- /dev/null\n+++ b/client/src/components/NewChatScreen/NewGroupButton.tsx\n@@ -0,0 +1,59 @@\n+import Button from '@material-ui/core/Button'\n+import GroupAddIcon from '@material-ui/icons/GroupAdd'\n+import { History } from 'history'\n+import * as React from 'react'\n+import styled from 'styled-components'\n+\n+const Style = styled.div`\n+  display: flex;\n+\n+  button {\n+    border-radius: 0;\n+    text-transform: none;\n+    font-size: inherit;\n+    width: 100%;\n+    justify-content: flex-start;\n+    padding-left: 15px;\n+    padding-right: 15px;\n+\n+    svg {\n+      font-size: 30px;\n+      margin-top: 10px;\n+    }\n+  }\n+\n+  .NewGroupButton-icon {\n+    height: 50px;\n+    width: 50px;\n+    object-fit: cover;\n+    border-radius: 50%;\n+    color: white;\n+    background-color: var(--secondary-bg);\n+  }\n+\n+  .NewGroupButton-title {\n+    padding-left: 15px;\n+    font-weight: bold;\n+  }\n+`\n+\n+interface NewGroupButtonProps {\n+  history: History\n+}\n+\n+export default ({ history }: NewGroupButtonProps) => {\n+  const navToGroup = () => {\n+    history.push('/new-chat/group')\n+  }\n+\n+  return (\n+    <Style>\n+      <Button onClick={navToGroup}>\n+        <div className=\"NewGroupButton-icon\">\n+          <GroupAddIcon />\n+        </div>\n+        <div className=\"NewGroupButton-title\">New Group</div>\n+      </Button>\n+    </Style>\n+  )\n+}\ndiff --git a/client/src/components/NewChatScreen/index.tsx b/client/src/components/NewChatScreen/index.tsx\nnew file mode 100644\nindex 0000000..1bac6a4\n--- /dev/null\n+++ b/client/src/components/NewChatScreen/index.tsx\n@@ -0,0 +1,108 @@\n+import { defaultDataIdFromObject } from 'apollo-cache-inmemory'\n+import gql from 'graphql-tag'\n+import * as React from 'react'\n+import { Suspense } from 'react'\n+import { useMutation } from 'react-apollo-hooks'\n+import { RouteComponentProps } from 'react-router-dom'\n+import styled from 'styled-components'\n+import { time as uniqid } from 'uniqid'\n+import * as fragments from '../../graphql/fragments'\n+import * as queries from '../../graphql/queries'\n+import { Chats } from '../../graphql/types'\n+import { NewChatScreenMutation } from '../../graphql/types'\n+import { useMe } from '../../services/auth.service'\n+import Navbar from '../Navbar'\n+import UsersList from '../UsersList'\n+import NewChatNavbar from './NewChatNavbar'\n+import NewGroupButton from './NewGroupButton'\n+\n+const Style = styled.div`\n+  .UsersList {\n+    height: calc(100% - 56px);\n+  }\n+\n+  .NewChatScreen-users-list {\n+    height: calc(100% - 56px);\n+    overflow-y: overlay;\n+  }\n+`\n+\n+const mutation = gql`\n+  mutation NewChatScreenMutation($userId: ID!) {\n+    addChat(userId: $userId) {\n+      ...Chat\n+    }\n+  }\n+  ${fragments.chat}\n+`\n+\n+export default ({ history }: RouteComponentProps) => {\n+  const me = useMe()\n+\n+  const addChat = useMutation<NewChatScreenMutation.Mutation, NewChatScreenMutation.Variables>(\n+    mutation,\n+    {\n+      update: (client, { data: { addChat } }) => {\n+        client.writeFragment({\n+          id: defaultDataIdFromObject(addChat),\n+          fragment: fragments.chat,\n+          fragmentName: 'Chat',\n+          data: addChat,\n+        })\n+\n+        let chats\n+        try {\n+          chats = client.readQuery<Chats.Query>({\n+            query: queries.chats,\n+          }).chats\n+        } catch (e) {}\n+\n+        if (chats && !chats.some(chat => chat.id === addChat.id)) {\n+          chats.unshift(addChat)\n+\n+          client.writeQuery({\n+            query: queries.chats,\n+            data: { chats },\n+          })\n+        }\n+      },\n+    },\n+  )\n+\n+  const onUserPick = user => {\n+    addChat({\n+      optimisticResponse: {\n+        __typename: 'Mutation',\n+        addChat: {\n+          __typename: 'Chat',\n+          id: uniqid(),\n+          name: user.name,\n+          picture: user.picture,\n+          allTimeMembers: [],\n+          owner: me,\n+          isGroup: false,\n+          lastMessage: null,\n+        },\n+      },\n+      variables: {\n+        userId: user.id,\n+      },\n+    }).then(({ data: { addChat } }) => {\n+      history.push(`/chats/${addChat.id}`)\n+    })\n+  }\n+\n+  return (\n+    <Style className=\"NewChatScreen Screen\">\n+      <Navbar>\n+        <NewChatNavbar history={history} />\n+      </Navbar>\n+      <div className=\"NewChatScreen-users-list\">\n+        <NewGroupButton history={history} />\n+        <Suspense fallback={null}>\n+          <UsersList onUserPick={onUserPick} />\n+        </Suspense>\n+      </div>\n+    </Style>\n+  )\n+}\ndiff --git a/client/src/components/NewGroupScreen/CreateGroupButton.tsx b/client/src/components/NewGroupScreen/CreateGroupButton.tsx\nnew file mode 100644\nindex 0000000..587bbb1\n--- /dev/null\n+++ b/client/src/components/NewGroupScreen/CreateGroupButton.tsx\n@@ -0,0 +1,42 @@\n+import Button from '@material-ui/core/Button'\n+import AddIcon from '@material-ui/icons/Add'\n+import { History } from 'history'\n+import * as React from 'react'\n+import styled from 'styled-components'\n+import { User } from '../../graphql/types'\n+\n+const Style = styled.div`\n+  position: fixed;\n+  right: 10px;\n+  bottom: 10px;\n+\n+  button {\n+    min-width: 50px;\n+    width: 50px;\n+    height: 50px;\n+    border-radius: 999px;\n+    background-color: var(--secondary-bg);\n+    color: white;\n+  }\n+`\n+\n+interface CreateGroupButtonProps {\n+  history: History\n+  users: User.Fragment[]\n+}\n+\n+export default ({ history, users }: CreateGroupButtonProps) => {\n+  const onClick = () => {\n+    history.push('/new-chat/group/details', {\n+      users,\n+    })\n+  }\n+\n+  return (\n+    <Style className=\"CreateGroupButton\">\n+      <Button variant=\"contained\" color=\"secondary\" onClick={onClick}>\n+        <AddIcon />\n+      </Button>\n+    </Style>\n+  )\n+}\ndiff --git a/client/src/components/NewGroupScreen/NewGroupNavbar.tsx b/client/src/components/NewGroupScreen/NewGroupNavbar.tsx\nnew file mode 100644\nindex 0000000..49c6e24\n--- /dev/null\n+++ b/client/src/components/NewGroupScreen/NewGroupNavbar.tsx\n@@ -0,0 +1,39 @@\n+import Button from '@material-ui/core/Button'\n+import ArrowBackIcon from '@material-ui/icons/ArrowBack'\n+import { History } from 'history'\n+import * as React from 'react'\n+import styled from 'styled-components'\n+\n+const Style = styled.div`\n+  padding: 0;\n+  display: flex;\n+  flex-direction: row;\n+  margin-left: -20px;\n+\n+  .NewGroupNavbar-title {\n+    line-height: 56px;\n+  }\n+\n+  .NewGroupNavbar-back-button {\n+    color: var(--primary-text);\n+  }\n+`\n+\n+interface NewGroupNavbarProps {\n+  history: History\n+}\n+\n+export default ({ history }: NewGroupNavbarProps) => {\n+  const navToChats = () => {\n+    history.push('/new-chat')\n+  }\n+\n+  return (\n+    <Style className=\"NewGroupNavbar\">\n+      <Button className=\"NewGroupNavbar-back-button\" onClick={navToChats}>\n+        <ArrowBackIcon />\n+      </Button>\n+      <div className=\"NewGroupNavbar-title\">New Chat Group</div>\n+    </Style>\n+  )\n+}\ndiff --git a/client/src/components/NewGroupScreen/index.tsx b/client/src/components/NewGroupScreen/index.tsx\nnew file mode 100644\nindex 0000000..a9ca6f3\n--- /dev/null\n+++ b/client/src/components/NewGroupScreen/index.tsx\n@@ -0,0 +1,32 @@\n+import * as React from 'react'\n+import { useState, Suspense } from 'react'\n+import { RouteComponentProps } from 'react-router-dom'\n+import styled from 'styled-components'\n+import Navbar from '../Navbar'\n+import UsersList from '../UsersList'\n+import CreateGroupButton from './CreateGroupButton'\n+import NewGroupNavbar from './NewGroupNavbar'\n+\n+const Style = styled.div`\n+  .UsersList {\n+    height: calc(100% - 56px);\n+    overflow-y: overlay;\n+  }\n+`\n+\n+export default ({ history }: RouteComponentProps) => {\n+  const [selectedUsers, setSelectedUsers] = useState([])\n+\n+  return (\n+    <Style className=\"NewGroupScreen Screen\">\n+      <Navbar>\n+        <NewGroupNavbar history={history} />\n+      </Navbar>\n+      <Suspense fallback={null}>\n+        <UsersList selectable onSelectionChange={setSelectedUsers} />\n+      </Suspense>\n+\n+      {!!selectedUsers.length && <CreateGroupButton history={history} users={selectedUsers} />}\n+    </Style>\n+  )\n+}\ndiff --git a/client/src/components/SettingsScreen/SettingsForm.tsx b/client/src/components/SettingsScreen/SettingsForm.tsx\nnew file mode 100644\nindex 0000000..9baca3a\n--- /dev/null\n+++ b/client/src/components/SettingsScreen/SettingsForm.tsx\n@@ -0,0 +1,134 @@\n+import TextField from '@material-ui/core/TextField'\n+import EditIcon from '@material-ui/icons/Edit'\n+import { defaultDataIdFromObject } from 'apollo-cache-inmemory'\n+import gql from 'graphql-tag'\n+import * as React from 'react'\n+import { useEffect, useState } from 'react'\n+import { useMutation } from 'react-apollo-hooks'\n+import { RouteComponentProps } from 'react-router-dom'\n+import styled from 'styled-components'\n+import * as fragments from '../../graphql/fragments'\n+import { SettingsFormMutation } from '../../graphql/types'\n+import { useMe } from '../../services/auth.service'\n+import { pickPicture, uploadProfilePicture } from '../../services/picture.service'\n+import Navbar from '../Navbar'\n+import SettingsNavbar from './SettingsNavbar'\n+\n+const Style = styled.div`\n+  .SettingsForm-picture {\n+    max-width: 300px;\n+    display: block;\n+    margin: auto;\n+    margin-top: 50px;\n+\n+    img {\n+      object-fit: cover;\n+      border-radius: 50%;\n+      margin-bottom: -34px;\n+      width: 300px;\n+      height: 300px;\n+    }\n+\n+    svg {\n+      float: right;\n+      font-size: 30px;\n+      opacity: 0.5;\n+      border-left: black solid 1px;\n+      padding-left: 5px;\n+      cursor: pointer;\n+    }\n+  }\n+\n+  .SettingsForm-name-input {\n+    display: block;\n+    margin: auto;\n+    width: calc(100% - 50px);\n+    margin-top: 50px;\n+\n+    > div {\n+      width: 100%;\n+    }\n+  }\n+`\n+\n+const mutation = gql`\n+  mutation SettingsFormMutation($name: String, $picture: String) {\n+    updateUser(name: $name, picture: $picture) {\n+      ...User\n+    }\n+  }\n+  ${fragments.user}\n+`\n+\n+export default ({ history }: RouteComponentProps) => {\n+  const me = useMe()\n+  const [myName, setMyName] = useState(me.name)\n+  const [myPicture, setMyPicture] = useState(me.picture)\n+\n+  const updateUser = useMutation<SettingsFormMutation.Mutation, SettingsFormMutation.Variables>(\n+    mutation,\n+    {\n+      variables: { name: myName, picture: myPicture },\n+      optimisticResponse: {\n+        __typename: 'Mutation',\n+        updateUser: {\n+          __typename: 'User',\n+          id: me.id,\n+          picture: myPicture,\n+          name: myName,\n+        },\n+      },\n+      update: (client, { data: { updateUser } }) => {\n+        me.picture = myPicture\n+        me.name = myPicture\n+\n+        client.writeFragment({\n+          id: defaultDataIdFromObject(me),\n+          fragment: fragments.user,\n+          data: me,\n+        })\n+      },\n+    },\n+  )\n+\n+  useEffect(\n+    () => {\n+      if (myPicture !== me.picture) {\n+        updateUser()\n+      }\n+    },\n+    [myPicture],\n+  )\n+\n+  const updateName = ({ target }) => {\n+    setMyName(target.value)\n+  }\n+\n+  const updatePicture = async () => {\n+    const file = await pickPicture()\n+\n+    if (!file) return\n+\n+    const { url } = await uploadProfilePicture(file)\n+\n+    setMyPicture(url)\n+  }\n+\n+  return (\n+    <Style className={name}>\n+      <div className=\"SettingsForm-picture\">\n+        <img src={myPicture || '/assets/default-profile-pic.jpg'} />\n+        <EditIcon onClick={updatePicture} />\n+      </div>\n+      <TextField\n+        className=\"SettingsForm-name-input\"\n+        label=\"Name\"\n+        value={myName}\n+        onChange={updateName}\n+        onBlur={updateUser}\n+        margin=\"normal\"\n+        placeholder=\"Enter your name\"\n+      />\n+    </Style>\n+  )\n+}\ndiff --git a/client/src/components/SettingsScreen/SettingsNavbar.tsx b/client/src/components/SettingsScreen/SettingsNavbar.tsx\nnew file mode 100644\nindex 0000000..bad30c8\n--- /dev/null\n+++ b/client/src/components/SettingsScreen/SettingsNavbar.tsx\n@@ -0,0 +1,49 @@\n+import Button from '@material-ui/core/Button'\n+import ArrowBackIcon from '@material-ui/icons/ArrowBack'\n+import { History } from 'history'\n+import * as React from 'react'\n+import styled from 'styled-components'\n+\n+const Style = styled.div`\n+  padding: 0;\n+  display: flex;\n+  flex-direction: row;\n+  margin-left: -20px;\n+\n+  .SettingsNavbar-title {\n+    line-height: 56px;\n+  }\n+\n+  .SettingsNavbar-back-button {\n+    color: var(--primary-text);\n+  }\n+\n+  .SettingsNavbar-picture {\n+    height: 40px;\n+    width: 40px;\n+    margin-top: 3px;\n+    margin-left: -22px;\n+    object-fit: cover;\n+    padding: 5px;\n+    border-radius: 50%;\n+  }\n+`\n+\n+interface SettingsNavbarProps {\n+  history: History\n+}\n+\n+export default ({ history }: SettingsNavbarProps) => {\n+  const navToChats = () => {\n+    history.push('/chats')\n+  }\n+\n+  return (\n+    <Style className={name}>\n+      <Button className=\"SettingsNavbar-back-button\" onClick={navToChats}>\n+        <ArrowBackIcon />\n+      </Button>\n+      <div className=\"SettingsNavbar-title\">Settings</div>\n+    </Style>\n+  )\n+}\ndiff --git a/client/src/components/SettingsScreen/index.tsx b/client/src/components/SettingsScreen/index.tsx\nnew file mode 100644\nindex 0000000..c5bbbe5\n--- /dev/null\n+++ b/client/src/components/SettingsScreen/index.tsx\n@@ -0,0 +1,17 @@\n+import * as React from 'react'\n+import { Suspense } from 'react'\n+import { RouteComponentProps } from 'react-router-dom'\n+import Navbar from '../Navbar'\n+import SettingsForm from './SettingsForm'\n+import SettingsNavbar from './SettingsNavbar'\n+\n+export default ({ history }: RouteComponentProps) => (\n+  <div className=\"SettingsScreen Screen\">\n+    <Navbar>\n+      <SettingsNavbar history={history} />\n+    </Navbar>\n+    <Suspense fallback={null}>\n+      <SettingsForm />\n+    </Suspense>\n+  </div>\n+)\ndiff --git a/client/src/components/UsersList.tsx b/client/src/components/UsersList.tsx\nnew file mode 100644\nindex 0000000..41bf73e\n--- /dev/null\n+++ b/client/src/components/UsersList.tsx\n@@ -0,0 +1,112 @@\n+import List from '@material-ui/core/List'\n+import ListItem from '@material-ui/core/ListItem'\n+import CheckCircle from '@material-ui/icons/CheckCircle'\n+import gql from 'graphql-tag'\n+import * as React from 'react'\n+import { useState } from 'react'\n+import { useQuery } from 'react-apollo-hooks'\n+import styled from 'styled-components'\n+import * as fragments from '../graphql/fragments'\n+import { UsersListQuery, User } from '../graphql/types'\n+\n+const Style = styled.div`\n+  .UsersList-users-list {\n+    padding: 0;\n+  }\n+\n+  .UsersList-user-item {\n+    position: relative;\n+    padding: 7.5px 15px;\n+    display: flex;\n+    ${props => props.selectable && 'cursor: pointer;'}\n+  }\n+\n+  .UsersList-profile-pic {\n+    height: 50px;\n+    width: 50px;\n+    object-fit: cover;\n+    border-radius: 50%;\n+  }\n+\n+  .UsersList-name {\n+    padding-left: 15px;\n+    font-weight: bold;\n+  }\n+\n+  .UsersList-checkmark {\n+    position: absolute;\n+    left: 50px;\n+    top: 35px;\n+    color: var(--secondary-bg);\n+    background-color: white;\n+    border-radius: 50%;\n+  }\n+`\n+\n+const query = gql`\n+  query UsersListQuery {\n+    users {\n+      ...User\n+    }\n+  }\n+  ${fragments.user}\n+`\n+\n+interface UsersListProps {\n+  selectable?: boolean\n+  onSelectionChange?: (users: User.Fragment[]) => void\n+  onUserPick?: (user: User.Fragment) => void\n+}\n+\n+export default (props: UsersListProps) => {\n+  const { selectable, onSelectionChange, onUserPick } = {\n+    selectable: false,\n+    onSelectionChange: () => {},\n+    onUserPick: () => {},\n+    ...props,\n+  }\n+\n+  const [selectedUsers, setSelectedUsers] = useState([])\n+  const {\n+    data: { users },\n+  } = useQuery<UsersListQuery.Query>(query, { suspend: true })\n+\n+  const onListItemClick = user => {\n+    if (!selectable) {\n+      return onUserPick(user)\n+    }\n+\n+    if (selectedUsers.includes(user)) {\n+      const index = selectedUsers.indexOf(user)\n+      selectedUsers.splice(index, 1)\n+    } else {\n+      selectedUsers.push(user)\n+    }\n+\n+    setSelectedUsers(selectedUsers)\n+    onSelectionChange(selectedUsers)\n+  }\n+\n+  return (\n+    <Style className=\"UsersList\" selectable={selectable}>\n+      <List className=\"UsersList-users-list\">\n+        {users.map(user => (\n+          <ListItem\n+            className=\"UsersList-user-item\"\n+            key={user.id}\n+            button\n+            onClick={onListItemClick.bind(null, user)}\n+          >\n+            <img\n+              className=\"UsersList-profile-pic\"\n+              src={user.picture || '/assets/default-profile-pic.jpg'}\n+            />\n+            <div className=\"UsersList-name\">{user.name}</div>\n+\n+            {selectedUsers.includes(user) && <CheckCircle className=\"UsersList-checkmark\" />}\n+          </ListItem>\n+        ))}\n+      </List>\n+    </Style>\n+  )\n+}\ndiff --git a/client/src/graphql/.gitignore b/client/src/graphql/.gitignore\nnew file mode 100644\nindex 0000000..92fa9bc\n--- /dev/null\n+++ b/client/src/graphql/.gitignore\n@@ -0,0 +1,2 @@\n+introspection.json\n+types.ts\ndiff --git a/client/src/graphql/fragments/chat.fragment.ts b/client/src/graphql/fragments/chat.fragment.ts\nnew file mode 100644\nindex 0000000..b72541d\n--- /dev/null\n+++ b/client/src/graphql/fragments/chat.fragment.ts\n@@ -0,0 +1,23 @@\n+import gql from 'graphql-tag'\n+import message from './message.fragment'\n+\n+export default gql `\n+  fragment Chat on Chat {\n+    id\n+    name\n+    picture\n+    allTimeMembers {\n+      id\n+      name\n+      picture\n+    }\n+    owner {\n+      id\n+    }\n+    lastMessage {\n+      ...Message\n+    }\n+    isGroup\n+  }\n+  ${message}\n+`\ndiff --git a/client/src/graphql/fragments/fullChat.fragment.ts b/client/src/graphql/fragments/fullChat.fragment.ts\nnew file mode 100644\nindex 0000000..631a41d\n--- /dev/null\n+++ b/client/src/graphql/fragments/fullChat.fragment.ts\n@@ -0,0 +1,14 @@\n+import gql from 'graphql-tag'\n+import chat from './chat.fragment'\n+import message from './message.fragment'\n+\n+export default gql `\n+  fragment FullChat on Chat {\n+    ...Chat\n+    messages {\n+      ...Message\n+    }\n+  }\n+  ${chat}\n+  ${message}\n+`\ndiff --git a/client/src/graphql/fragments/index.ts b/client/src/graphql/fragments/index.ts\nnew file mode 100644\nindex 0000000..7b6c3c0\n--- /dev/null\n+++ b/client/src/graphql/fragments/index.ts\n@@ -0,0 +1,4 @@\n+export { default as chat } from './chat.fragment'\n+export { default as fullChat } from './fullChat.fragment'\n+export { default as message } from './message.fragment'\n+export { default as user } from './user.fragment'\ndiff --git a/client/src/graphql/fragments/message.fragment.ts b/client/src/graphql/fragments/message.fragment.ts\nnew file mode 100644\nindex 0000000..77ab13d\n--- /dev/null\n+++ b/client/src/graphql/fragments/message.fragment.ts\n@@ -0,0 +1,33 @@\n+import gql from 'graphql-tag'\n+\n+export default gql`\n+  fragment Message on Message {\n+    id\n+    chat {\n+      id\n+    }\n+    sender {\n+      id\n+      name\n+    }\n+    content\n+    createdAt\n+    recipients {\n+      user {\n+        id\n+      }\n+      message {\n+        id\n+        chat {\n+          id\n+        }\n+      }\n+      chat {\n+        id\n+      }\n+      receivedAt\n+      readAt\n+    }\n+    ownership\n+  }\n+`\ndiff --git a/client/src/graphql/fragments/user.fragment.ts b/client/src/graphql/fragments/user.fragment.ts\nnew file mode 100644\nindex 0000000..c87010b\n--- /dev/null\n+++ b/client/src/graphql/fragments/user.fragment.ts\n@@ -0,0 +1,9 @@\n+import gql from 'graphql-tag'\n+\n+export default gql`\n+  fragment User on User {\n+    id\n+    name\n+    picture\n+  }\n+`\ndiff --git a/client/src/graphql/queries/chats.query.ts b/client/src/graphql/queries/chats.query.ts\nnew file mode 100644\nindex 0000000..40016ed\n--- /dev/null\n+++ b/client/src/graphql/queries/chats.query.ts\n@@ -0,0 +1,11 @@\n+import gql from 'graphql-tag'\n+import * as fragments from '../fragments'\n+\n+export default gql `\n+  query Chats {\n+    chats {\n+      ...Chat\n+    }\n+  }\n+  ${fragments.chat}\n+`\ndiff --git a/client/src/graphql/queries/index.ts b/client/src/graphql/queries/index.ts\nnew file mode 100644\nindex 0000000..a54febb\n--- /dev/null\n+++ b/client/src/graphql/queries/index.ts\n@@ -0,0 +1,3 @@\n+export { default as chats } from './chats.query'\n+export { default as users } from './users.query'\n+export { default as me } from './me.query'\ndiff --git a/client/src/graphql/queries/me.query.ts b/client/src/graphql/queries/me.query.ts\nnew file mode 100644\nindex 0000000..d48ee66\n--- /dev/null\n+++ b/client/src/graphql/queries/me.query.ts\n@@ -0,0 +1,11 @@\n+import gql from 'graphql-tag'\n+import * as fragments from '../fragments'\n+\n+export default gql `\n+  query Me {\n+    me {\n+      ...User\n+    }\n+  }\n+  ${fragments.user}\n+`\ndiff --git a/client/src/graphql/queries/users.query.ts b/client/src/graphql/queries/users.query.ts\nnew file mode 100644\nindex 0000000..6b8c8cc\n--- /dev/null\n+++ b/client/src/graphql/queries/users.query.ts\n@@ -0,0 +1,11 @@\n+import gql from 'graphql-tag'\n+import * as fragments from '../fragments'\n+\n+export default gql `\n+  query Users {\n+    users {\n+      ...User\n+    }\n+  }\n+  ${fragments.user}\n+`\ndiff --git a/client/src/graphql/subscriptions/chatAdded.subscription.ts b/client/src/graphql/subscriptions/chatAdded.subscription.ts\nnew file mode 100644\nindex 0000000..747116c\n--- /dev/null\n+++ b/client/src/graphql/subscriptions/chatAdded.subscription.ts\n@@ -0,0 +1,11 @@\n+import gql from 'graphql-tag'\n+import * as fragments from '../fragments'\n+\n+export default gql `\n+  subscription ChatAdded {\n+    chatAdded {\n+      ...Chat\n+    }\n+  }\n+  ${fragments.chat}\n+`\ndiff --git a/client/src/graphql/subscriptions/chatUpdated.subscription.ts b/client/src/graphql/subscriptions/chatUpdated.subscription.ts\nnew file mode 100644\nindex 0000000..1cca07e\n--- /dev/null\n+++ b/client/src/graphql/subscriptions/chatUpdated.subscription.ts\n@@ -0,0 +1,11 @@\n+import gql from 'graphql-tag'\n+import * as fragments from '../fragments'\n+\n+export default gql `\n+  subscription ChatUpdated {\n+    chatUpdated {\n+      ...Chat\n+    }\n+  }\n+  ${fragments.chat}\n+`\ndiff --git a/client/src/graphql/subscriptions/index.ts b/client/src/graphql/subscriptions/index.ts\nnew file mode 100644\nindex 0000000..45ad20d\n--- /dev/null\n+++ b/client/src/graphql/subscriptions/index.ts\n@@ -0,0 +1,5 @@\n+export { default as chatUpdated } from './chatUpdated.subscription'\n+export { default as messageAdded } from './messageAdded.subscription'\n+export { default as chatAdded } from './chatAdded.subscription'\n+export { default as userAdded } from './userAdded.subscription'\n+export { default as userUpdated } from './userUpdated.subscription'\ndiff --git a/client/src/graphql/subscriptions/messageAdded.subscription.ts b/client/src/graphql/subscriptions/messageAdded.subscription.ts\nnew file mode 100644\nindex 0000000..b16392b\n--- /dev/null\n+++ b/client/src/graphql/subscriptions/messageAdded.subscription.ts\n@@ -0,0 +1,11 @@\n+import gql from 'graphql-tag'\n+import * as fragments from '../fragments'\n+\n+export default gql `\n+  subscription MessageAdded {\n+    messageAdded {\n+      ...Message\n+    }\n+  }\n+  ${fragments.message}\n+`\ndiff --git a/client/src/graphql/subscriptions/userAdded.subscription.ts b/client/src/graphql/subscriptions/userAdded.subscription.ts\nnew file mode 100644\nindex 0000000..e5bfaba\n--- /dev/null\n+++ b/client/src/graphql/subscriptions/userAdded.subscription.ts\n@@ -0,0 +1,11 @@\n+import gql from 'graphql-tag'\n+import * as fragments from '../fragments'\n+\n+export default gql `\n+  subscription UserAdded {\n+    userAdded {\n+      ...User\n+    }\n+  }\n+  ${fragments.user}\n+`\ndiff --git a/client/src/graphql/subscriptions/userUpdated.subscription.ts b/client/src/graphql/subscriptions/userUpdated.subscription.ts\nnew file mode 100644\nindex 0000000..e467b69\n--- /dev/null\n+++ b/client/src/graphql/subscriptions/userUpdated.subscription.ts\n@@ -0,0 +1,11 @@\n+import gql from 'graphql-tag'\n+import * as fragments from '../fragments'\n+\n+export default gql `\n+  subscription UserUpdated {\n+    userUpdated {\n+      ...User\n+    }\n+  }\n+  ${fragments.user}\n+`\ndiff --git a/client/src/index.css b/client/src/index.css\nnew file mode 100755\nindex 0000000..0f4d0fe\n--- /dev/null\n+++ b/client/src/index.css\n@@ -0,0 +1,26 @@\n+:root {\n+  --primary-bg: #2c6157;\n+  --secondary-bg: #6fd056;\n+  --primary-text: white;\n+  --secondary-text: white;\n+}\n+\n+html {\n+  height: 100%;\n+}\n+\n+body {\n+  height: 100%;\n+  margin: 0;\n+  padding: 0;\n+  font-family: Roboto, \"Helvetica Neue\", sans-serif;\n+}\n+\n+#root {\n+  height: 100%;\n+}\n+\n+.Screen {\n+  position: relative;\n+  height: 100%;\n+}\ndiff --git a/client/src/index.tsx b/client/src/index.tsx\nnew file mode 100755\nindex 0000000..092f7f7\n--- /dev/null\n+++ b/client/src/index.tsx\n@@ -0,0 +1,34 @@\n+import { MuiThemeProvider, createMuiTheme } from '@material-ui/core/styles'\n+import React from 'react';\n+import { Suspense } from 'react'\n+import ReactDOM from 'react-dom';\n+import { ApolloProvider } from 'react-apollo-hooks';\n+import './index.css';\n+import App from './App';\n+import apolloClient from './apollo-client'\n+import * as serviceWorker from './serviceWorker';\n+\n+const theme = createMuiTheme({\n+  palette: {\n+    primary: { main: '#2c6157' },\n+    secondary: { main: '#6fd056' },\n+  },\n+  typography: {\n+    useNextVariants: true,\n+  },\n+})\n+\n+ReactDOM.render(\n+  <MuiThemeProvider theme={theme}>\n+    <ApolloProvider client={apolloClient}>\n+      <Suspense fallback={null}>\n+        <App />\n+      </Suspense>\n+    </ApolloProvider>\n+  </MuiThemeProvider>\n+, document.getElementById('root'));\n+\n+// If you want your app to work offline and load faster, you can change\n+// unregister() to register() below. Note this comes with some pitfalls.\n+// Learn more about service workers: http://bit.ly/CRA-PWA\n+serviceWorker.unregister();\ndiff --git a/client/src/logo.svg b/client/src/logo.svg\nnew file mode 100755\nindex 0000000..6b60c10\n--- /dev/null\n+++ b/client/src/logo.svg\n@@ -0,0 +1,7 @@\n+<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 841.9 595.3\">\n+    <g fill=\"#61DAFB\">\n+        <path d=\"M666.3 296.5c0-32.5-40.7-63.3-103.1-82.4 14.4-63.6 8-114.2-20.2-130.4-6.5-3.8-14.1-5.6-22.4-5.6v22.3c4.6 0 8.3.9 11.4 2.6 13.6 7.8 19.5 37.5 14.9 75.7-1.1 9.4-2.9 19.3-5.1 29.4-19.6-4.8-41-8.5-63.5-10.9-13.5-18.5-27.5-35.3-41.6-50 32.6-30.3 63.2-46.9 84-46.9V78c-27.5 0-63.5 19.6-99.9 53.6-36.4-33.8-72.4-53.2-99.9-53.2v22.3c20.7 0 51.4 16.5 84 46.6-14 14.7-28 31.4-41.3 49.9-22.6 2.4-44 6.1-63.6 11-2.3-10-4-19.7-5.2-29-4.7-38.2 1.1-67.9 14.6-75.8 3-1.8 6.9-2.6 11.5-2.6V78.5c-8.4 0-16 1.8-22.6 5.6-28.1 16.2-34.4 66.7-19.9 130.1-62.2 19.2-102.7 49.9-102.7 82.3 0 32.5 40.7 63.3 103.1 82.4-14.4 63.6-8 114.2 20.2 130.4 6.5 3.8 14.1 5.6 22.5 5.6 27.5 0 63.5-19.6 99.9-53.6 36.4 33.8 72.4 53.2 99.9 53.2 8.4 0 16-1.8 22.6-5.6 28.1-16.2 34.4-66.7 19.9-130.1 62-19.1 102.5-49.9 102.5-82.3zm-130.2-66.7c-3.7 12.9-8.3 26.2-13.5 39.5-4.1-8-8.4-16-13.1-24-4.6-8-9.5-15.8-14.4-23.4 14.2 2.1 27.9 4.7 41 7.9zm-45.8 106.5c-7.8 13.5-15.8 26.3-24.1 38.2-14.9 1.3-30 2-45.2 2-15.1 0-30.2-.7-45-1.9-8.3-11.9-16.4-24.6-24.2-38-7.6-13.1-14.5-26.4-20.8-39.8 6.2-13.4 13.2-26.8 20.7-39.9 7.8-13.5 15.8-26.3 24.1-38.2 14.9-1.3 30-2 45.2-2 15.1 0 30.2.7 45 1.9 8.3 11.9 16.4 24.6 24.2 38 7.6 13.1 14.5 26.4 20.8 39.8-6.3 13.4-13.2 26.8-20.7 39.9zm32.3-13c5.4 13.4 10 26.8 13.8 39.8-13.1 3.2-26.9 5.9-41.2 8 4.9-7.7 9.8-15.6 14.4-23.7 4.6-8 8.9-16.1 13-24.1zM421.2 430c-9.3-9.6-18.6-20.3-27.8-32 9 .4 18.2.7 27.5.7 9.4 0 18.7-.2 27.8-.7-9 11.7-18.3 22.4-27.5 32zm-74.4-58.9c-14.2-2.1-27.9-4.7-41-7.9 3.7-12.9 8.3-26.2 13.5-39.5 4.1 8 8.4 16 13.1 24 4.7 8 9.5 15.8 14.4 23.4zM420.7 163c9.3 9.6 18.6 20.3 27.8 32-9-.4-18.2-.7-27.5-.7-9.4 0-18.7.2-27.8.7 9-11.7 18.3-22.4 27.5-32zm-74 58.9c-4.9 7.7-9.8 15.6-14.4 23.7-4.6 8-8.9 16-13 24-5.4-13.4-10-26.8-13.8-39.8 13.1-3.1 26.9-5.8 41.2-7.9zm-90.5 125.2c-35.4-15.1-58.3-34.9-58.3-50.6 0-15.7 22.9-35.6 58.3-50.6 8.6-3.7 18-7 27.7-10.1 5.7 19.6 13.2 40 22.5 60.9-9.2 20.8-16.6 41.1-22.2 60.6-9.9-3.1-19.3-6.5-28-10.2zM310 490c-13.6-7.8-19.5-37.5-14.9-75.7 1.1-9.4 2.9-19.3 5.1-29.4 19.6 4.8 41 8.5 63.5 10.9 13.5 18.5 27.5 35.3 41.6 50-32.6 30.3-63.2 46.9-84 46.9-4.5-.1-8.3-1-11.3-2.7zm237.2-76.2c4.7 38.2-1.1 67.9-14.6 75.8-3 1.8-6.9 2.6-11.5 2.6-20.7 0-51.4-16.5-84-46.6 14-14.7 28-31.4 41.3-49.9 22.6-2.4 44-6.1 63.6-11 2.3 10.1 4.1 19.8 5.2 29.1zm38.5-66.7c-8.6 3.7-18 7-27.7 10.1-5.7-19.6-13.2-40-22.5-60.9 9.2-20.8 16.6-41.1 22.2-60.6 9.9 3.1 19.3 6.5 28.1 10.2 35.4 15.1 58.3 34.9 58.3 50.6-.1 15.7-23 35.6-58.4 50.6zM320.8 78.4z\"/>\n+        <circle cx=\"420.9\" cy=\"296.5\" r=\"45.7\"/>\n+        <path d=\"M520.5 78.1z\"/>\n+    </g>\n+</svg>\ndiff --git a/client/src/polyfills/react-apollo-hooks.ts b/client/src/polyfills/react-apollo-hooks.ts\nnew file mode 100644\nindex 0000000..92c1d12\n--- /dev/null\n+++ b/client/src/polyfills/react-apollo-hooks.ts\n@@ -0,0 +1,72 @@\n+import { DataProxy } from 'apollo-cache'\n+import { OperationVariables, FetchPolicy } from 'apollo-client'\n+import { DocumentNode, GraphQLError } from 'graphql'\n+import { useEffect, useMemo, useRef, useState } from 'react'\n+import { useApolloClient } from 'react-apollo-hooks'\n+import * as isEqual from 'react-fast-compare'\n+\n+export type SubscriptionOptions<T, TVariables> = {\n+  variables?: TVariables\n+  fetchPolicy?: FetchPolicy\n+  onSubscriptionData?: (options?: { client?: DataProxy; subscriptionData?: T }) => any\n+}\n+\n+export const useSubscription = <T, TVariables = OperationVariables>(\n+  query: DocumentNode,\n+  options: SubscriptionOptions<T, TVariables> = {},\n+): {\n+  data: T | { [key: string]: void }\n+  error?: GraphQLError\n+  loading: boolean\n+} => {\n+  const onSubscriptionData = options.onSubscriptionData\n+  const prevOptions = useRef<typeof options | null>(null)\n+  const client = useApolloClient()\n+  const [data, setData] = useState<T | {}>({})\n+  const [error, setError] = useState<GraphQLError | null>(null)\n+  const [loading, setLoading] = useState<boolean>(true)\n+\n+  const subscriptionOptions = {\n+    query,\n+    variables: options.variables,\n+    fetchPolicy: options.fetchPolicy,\n+  }\n+\n+  useEffect(\n+    () => {\n+      prevOptions.current = subscriptionOptions\n+      const subscription = client\n+        .subscribe<{ data: T }, TVariables>(subscriptionOptions)\n+        .subscribe({\n+          next: ({ data }) => {\n+            setData(data)\n+\n+            if (onSubscriptionData) {\n+              onSubscriptionData({ client, subscriptionData: data })\n+            }\n+          },\n+          error: err => {\n+            setError(err)\n+            setLoading(false)\n+          },\n+          complete: () => {\n+            setLoading(false)\n+          },\n+        })\n+\n+      return () => {\n+        subscription.unsubscribe()\n+      }\n+    },\n+    [isEqual(prevOptions.current, subscriptionOptions) ? prevOptions.current : subscriptionOptions],\n+  )\n+\n+  return useMemo(\n+    () => ({\n+      data,\n+      error,\n+      loading,\n+    }),\n+    [data, error, loading],\n+  )\n+}\ndiff --git a/client/src/react-app-env.d.ts b/client/src/react-app-env.d.ts\nnew file mode 100644\nindex 0000000..6431bc5\n--- /dev/null\n+++ b/client/src/react-app-env.d.ts\n@@ -0,0 +1 @@\n+/// <reference types=\"react-scripts\" />\ndiff --git a/client/src/serviceWorker.js b/client/src/serviceWorker.js\nnew file mode 100755\nindex 0000000..2283ff9\n--- /dev/null\n+++ b/client/src/serviceWorker.js\n@@ -0,0 +1,135 @@\n+// This optional code is used to register a service worker.\n+// register() is not called by default.\n+\n+// This lets the app load faster on subsequent visits in production, and gives\n+// it offline capabilities. However, it also means that developers (and users)\n+// will only see deployed updates on subsequent visits to a page, after all the\n+// existing tabs open on the page have been closed, since previously cached\n+// resources are updated in the background.\n+\n+// To learn more about the benefits of this model and instructions on how to\n+// opt-in, read http://bit.ly/CRA-PWA\n+\n+const isLocalhost = Boolean(\n+  window.location.hostname === 'localhost' ||\n+    // [::1] is the IPv6 localhost address.\n+    window.location.hostname === '[::1]' ||\n+    // 127.0.0.1/8 is considered localhost for IPv4.\n+    window.location.hostname.match(\n+      /^127(?:\\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/\n+    )\n+);\n+\n+export function register(config) {\n+  if (process.env.NODE_ENV === 'production' && 'serviceWorker' in navigator) {\n+    // The URL constructor is available in all browsers that support SW.\n+    const publicUrl = new URL(process.env.PUBLIC_URL, window.location.href);\n+    if (publicUrl.origin !== window.location.origin) {\n+      // Our service worker won't work if PUBLIC_URL is on a different origin\n+      // from what our page is served on. This might happen if a CDN is used to\n+      // serve assets; see https://github.com/facebook/create-react-app/issues/2374\n+      return;\n+    }\n+\n+    window.addEventListener('load', () => {\n+      const swUrl = `${process.env.PUBLIC_URL}/service-worker.js`;\n+\n+      if (isLocalhost) {\n+        // This is running on localhost. Let's check if a service worker still exists or not.\n+        checkValidServiceWorker(swUrl, config);\n+\n+        // Add some additional logging to localhost, pointing developers to the\n+        // service worker/PWA documentation.\n+        navigator.serviceWorker.ready.then(() => {\n+          console.log(\n+            'This web app is being served cache-first by a service ' +\n+              'worker. To learn more, visit http://bit.ly/CRA-PWA'\n+          );\n+        });\n+      } else {\n+        // Is not localhost. Just register service worker\n+        registerValidSW(swUrl, config);\n+      }\n+    });\n+  }\n+}\n+\n+function registerValidSW(swUrl, config) {\n+  navigator.serviceWorker\n+    .register(swUrl)\n+    .then(registration => {\n+      registration.onupdatefound = () => {\n+        const installingWorker = registration.installing;\n+        if (installingWorker == null) {\n+          return;\n+        }\n+        installingWorker.onstatechange = () => {\n+          if (installingWorker.state === 'installed') {\n+            if (navigator.serviceWorker.controller) {\n+              // At this point, the updated precached content has been fetched,\n+              // but the previous service worker will still serve the older\n+              // content until all client tabs are closed.\n+              console.log(\n+                'New content is available and will be used when all ' +\n+                  'tabs for this page are closed. See http://bit.ly/CRA-PWA.'\n+              );\n+\n+              // Execute callback\n+              if (config && config.onUpdate) {\n+                config.onUpdate(registration);\n+              }\n+            } else {\n+              // At this point, everything has been precached.\n+              // It's the perfect time to display a\n+              // \"Content is cached for offline use.\" message.\n+              console.log('Content is cached for offline use.');\n+\n+              // Execute callback\n+              if (config && config.onSuccess) {\n+                config.onSuccess(registration);\n+              }\n+            }\n+          }\n+        };\n+      };\n+    })\n+    .catch(error => {\n+      console.error('Error during service worker registration:', error);\n+    });\n+}\n+\n+function checkValidServiceWorker(swUrl, config) {\n+  // Check if the service worker can be found. If it can't reload the page.\n+  fetch(swUrl)\n+    .then(response => {\n+      // Ensure service worker exists, and that we really are getting a JS file.\n+      const contentType = response.headers.get('content-type');\n+      if (\n+        response.status === 404 ||\n+        (contentType != null && contentType.indexOf('javascript') === -1)\n+      ) {\n+        // No service worker found. Probably a different app. Reload the page.\n+        navigator.serviceWorker.ready.then(registration => {\n+          registration.unregister().then(() => {\n+            window.location.reload();\n+          });\n+        });\n+      } else {\n+        // Service worker found. Proceed as normal.\n+        registerValidSW(swUrl, config);\n+      }\n+    })\n+    .catch(() => {\n+      console.log(\n+        'No internet connection found. App is running in offline mode.'\n+      );\n+    });\n+}\n+\n+export function unregister() {\n+  if ('serviceWorker' in navigator) {\n+    navigator.serviceWorker.ready.then(registration => {\n+      registration.unregister();\n+    });\n+  }\n+}\ndiff --git a/client/src/services/auth.service.tsx b/client/src/services/auth.service.tsx\nnew file mode 100644\nindex 0000000..3290541\n--- /dev/null\n+++ b/client/src/services/auth.service.tsx\n@@ -0,0 +1,87 @@\n+import * as React from 'react'\n+import { useContext } from 'react'\n+import { useQuery } from 'react-apollo-hooks'\n+import { Redirect } from 'react-router-dom'\n+import store from '../apollo-client'\n+import * as queries from '../graphql/queries'\n+import { Me, User } from '../graphql/types'\n+import { useSubscriptions } from './cache.service'\n+\n+const MyContext = React.createContext<User.Fragment>(null)\n+\n+export const useMe = () => {\n+  return useContext(MyContext)\n+}\n+\n+export const withAuth = (Component: React.ComponentType) => {\n+  return props => {\n+    if (!getAuthHeader()) return <Redirect to=\"/sign-in\" />\n+\n+    // Validating against server\n+    const myResult = useQuery<Me.Query>(queries.me, { suspend: true })\n+\n+    // Override TypeScript definition issue with the current version\n+    if (myResult.error) return <Redirect to=\"/sign-in\" />\n+\n+    useSubscriptions()\n+\n+    return (\n+      <MyContext.Provider value={myResult.data.me}>\n+        <Component {...props} />\n+      </MyContext.Provider>\n+    )\n+  }\n+}\n+\n+export const storeAuthHeader = (auth: string) => {\n+  localStorage.setItem('Authorization', auth)\n+}\n+\n+export const getAuthHeader = (): string | null => {\n+  return localStorage.getItem('Authorization') || null\n+}\n+\n+export const signIn = ({ username, password }) => {\n+  const auth = `Basic ${btoa(`${username}:${password}`)}`\n+\n+  return fetch(`${process.env.REACT_APP_SERVER_URL}/signin`, {\n+    method: 'POST',\n+    headers: {\n+      Authorization: auth,\n+    },\n+  }).then(res => {\n+    if (res.status < 400) {\n+      storeAuthHeader(auth)\n+    } else {\n+      return Promise.reject(res.statusText)\n+    }\n+  })\n+}\n+\n+export const signUp = ({ username, password, name }) => {\n+  return fetch(`${process.env.REACT_APP_SERVER_URL}/signup`, {\n+    method: 'POST',\n+    body: JSON.stringify({ name }),\n+    headers: {\n+      Accept: 'application/json',\n+      'Content-Type': 'application/json',\n+      Authorization: `Basic ${btoa(`${username}:${password}`)}`,\n+    },\n+  })\n+}\n+\n+export const signOut = () => {\n+  localStorage.removeItem('Authorization')\n+\n+  return store.clearStore()\n+}\n+\n+export default {\n+  useMe,\n+  withAuth,\n+  storeAuthHeader,\n+  getAuthHeader,\n+  signIn,\n+  signUp,\n+  signOut,\n+}\ndiff --git a/client/src/services/cache.service.tsx b/client/src/services/cache.service.tsx\nnew file mode 100644\nindex 0000000..8e110fb\n--- /dev/null\n+++ b/client/src/services/cache.service.tsx\n@@ -0,0 +1,144 @@\n+import { defaultDataIdFromObject } from 'apollo-cache-inmemory'\n+import * as fragments from '../graphql/fragments'\n+import * as subscriptions from '../graphql/subscriptions'\n+import * as queries from '../graphql/queries'\n+import {\n+  ChatUpdated,\n+  MessageAdded,\n+  Message,\n+  Chats,\n+  FullChat,\n+  User,\n+  Users,\n+  UserAdded,\n+  UserUpdated,\n+  ChatAdded,\n+} from '../graphql/types'\n+import { useSubscription } from '../polyfills/react-apollo-hooks'\n+\n+export const useSubscriptions = () => {\n+  useSubscription<ChatAdded.Subscription>(subscriptions.chatAdded, {\n+    onSubscriptionData: ({ client, subscriptionData: { chatAdded } }) => {\n+      client.writeFragment({\n+        id: defaultDataIdFromObject(chatAdded),\n+        fragment: fragments.chat,\n+        fragmentName: 'Chat',\n+        data: chatAdded,\n+      })\n+\n+      let chats\n+      try {\n+        chats = client.readQuery<Chats.Query>({\n+          query: queries.chats,\n+        }).chats\n+      } catch (e) {}\n+\n+      if (chats && !chats.some(chat => chat.id === chatAdded.id)) {\n+        chats.unshift(chatAdded)\n+\n+        client.writeQuery({\n+          query: queries.chats,\n+          data: { chats },\n+        })\n+      }\n+    },\n+  })\n+\n+  useSubscription<ChatUpdated.Subscription>(subscriptions.chatUpdated, {\n+    onSubscriptionData: ({ client, subscriptionData: { chatUpdated } }) => {\n+      client.writeFragment({\n+        id: defaultDataIdFromObject(chatUpdated),\n+        fragment: fragments.chat,\n+        fragmentName: 'Chat',\n+        data: chatUpdated,\n+      })\n+    },\n+  })\n+\n+  useSubscription<MessageAdded.Subscription>(subscriptions.messageAdded, {\n+    onSubscriptionData: ({ client, subscriptionData: { messageAdded } }) => {\n+      client.writeFragment<Message.Fragment>({\n+        id: defaultDataIdFromObject(messageAdded),\n+        fragment: fragments.message,\n+        data: messageAdded,\n+      })\n+\n+      let fullChat\n+      try {\n+        fullChat = client.readFragment<FullChat.Fragment>({\n+          id: defaultDataIdFromObject(messageAdded.chat),\n+          fragment: fragments.fullChat,\n+          fragmentName: 'FullChat',\n+        })\n+      } catch (e) {}\n+\n+      if (fullChat && !fullChat.messages.some(message => message.id === messageAdded.id)) {\n+        fullChat.messages.push(messageAdded)\n+        fullChat.lastMessage = messageAdded\n+\n+        client.writeFragment({\n+          id: defaultDataIdFromObject(fullChat),\n+          fragment: fragments.fullChat,\n+          fragmentName: 'FullChat',\n+          data: fullChat,\n+        })\n+      }\n+\n+      let chats\n+      try {\n+        chats = client.readQuery<Chats.Query>({\n+          query: queries.chats,\n+        }).chats\n+      } catch (e) {}\n+\n+      if (chats) {\n+        const index = chats.findIndex(chat => chat.id === messageAdded.chat.id)\n+        const chat = chats[index]\n+        chat.lastMessage = messageAdded\n+        chats.splice(index, 1)\n+        chats.unshift(chat)\n+\n+        client.writeQuery({\n+          query: queries.chats,\n+          data: { chats },\n+        })\n+      }\n+    },\n+  })\n+\n+  useSubscription<UserAdded.Subscription>(subscriptions.userAdded, {\n+    onSubscriptionData: ({ client, subscriptionData: { userAdded } }) => {\n+      client.writeFragment({\n+        id: defaultDataIdFromObject(userAdded),\n+        fragment: fragments.user,\n+        data: userAdded,\n+      })\n+\n+      let users\n+      try {\n+        users = client.readQuery<Users.Query>({\n+          query: queries.users,\n+        }).users\n+      } catch (e) {}\n+\n+      if (users && !users.some(user => user.id === userAdded.id)) {\n+        users.push(userAdded)\n+\n+        client.writeQuery({\n+          query: queries.users,\n+          data: { users },\n+        })\n+      }\n+    },\n+  })\n+\n+  useSubscription<UserUpdated.Subscription>(subscriptions.userUpdated, {\n+    onSubscriptionData: ({ client, subscriptionData: { userUpdated } }) => {\n+      client.writeFragment({\n+        id: defaultDataIdFromObject(userUpdated),\n+        fragment: fragments.user,\n+        data: userUpdated,\n+      })\n+    },\n+  })\n+}\ndiff --git a/client/src/services/picture.service.tsx b/client/src/services/picture.service.tsx\nnew file mode 100644\nindex 0000000..0bfad30\n--- /dev/null\n+++ b/client/src/services/picture.service.tsx\n@@ -0,0 +1,31 @@\n+import { getAuthHeader } from './auth.service'\n+\n+export const pickPicture = () => {\n+  return new Promise((resolve, reject) => {\n+    const input = document.createElement('input')\n+    input.type = 'file'\n+    input.accept = 'image/*'\n+    input.onchange = e => {\n+      const target = e.target as HTMLInputElement\n+      resolve(target.files[0])\n+    }\n+    input.onerror = reject\n+    input.click()\n+  })\n+}\n+\n+export const uploadProfilePicture = file => {\n+  const formData = new FormData()\n+  formData.append('file', file)\n+  formData.append('upload_preset', 'profile-pic')\n+\n+  return fetch(`${process.env.REACT_APP_SERVER_URL}/upload-profile-pic`, {\n+    method: 'POST',\n+    body: formData,\n+    headers: {\n+      Authorization: getAuthHeader(),\n+    }\n+  }).then(res => {\n+    return res.json()\n+  })\n+}\ndiff --git a/client/tsconfig.json b/client/tsconfig.json\nnew file mode 100644\nindex 0000000..ad80f6a\n--- /dev/null\n+++ b/client/tsconfig.json\n@@ -0,0 +1,35 @@\n+{\n+  \"compilerOptions\": {\n+    \"outDir\": \"build/dist\",\n+    \"sourceMap\": true,\n+    \"declaration\": false,\n+    \"moduleResolution\": \"node\",\n+    \"emitDecoratorMetadata\": true,\n+    \"experimentalDecorators\": true,\n+    \"downlevelIteration\": true,\n+    \"resolveJsonModule\": true,\n+    \"target\": \"es5\",\n+    \"jsx\": \"preserve\",\n+    \"typeRoots\": [\n+      \"node_modules/@types\"\n+    ],\n+    \"lib\": [\n+      \"es2017\",\n+      \"dom\",\n+      \"esnext.asynciterable\"\n+    ],\n+    \"allowJs\": true,\n+    \"skipLibCheck\": true,\n+    \"esModuleInterop\": false,\n+    \"allowSyntheticDefaultImports\": true,\n+    \"forceConsistentCasingInFileNames\": true,\n+    \"isolatedModules\": true,\n+    \"noEmit\": true,\n+    \"noImplicitAny\": false,\n+    \"strict\": false,\n+    \"module\": \"esnext\"\n+  },\n+  \"include\": [\n+    \"src\"\n+  ]\n+}\ndiff --git a/client/tslint.json b/client/tslint.json\nnew file mode 100644\nindex 0000000..446ec3d\n--- /dev/null\n+++ b/client/tslint.json\n@@ -0,0 +1,29 @@\n+{\n+  \"extends\": [\"tslint:recommended\", \"tslint-react\", \"tslint-config-prettier\"],\n+  \"rules\": {\n+    \"ordered-imports\": false,\n+    \"object-literal-sort-keys\": false,\n+    \"jsx-boolean-value\": false,\n+    \"interface-name\" : false,\n+    \"variable-name\": false,\n+    \"no-string-literal\": false,\n+    \"no-namespace\": false,\n+    \"interface-over-type-literal\": false,\n+    \"no-shadowed-variable\": false,\n+    \"curly\": false,\n+    \"no-label\": false,\n+    \"no-empty\": false,\n+    \"no-debugger\": false,\n+    \"no-console\": false,\n+    \"array-type\": false\n+  },\n+  \"linterOptions\": {\n+    \"exclude\": [\n+      \"config/**/*.js\",\n+      \"node_modules/**/*.ts\",\n+      \"coverage/lcov-report/*.js\",\n+      \"*.json\",\n+      \"**/*.json\"\n+    ]\n+  }\n+}\ndiff --git a/package.json b/package.json\nnew file mode 100644\nindex 0000000..3dbe77d\n--- /dev/null\n+++ b/package.json\n@@ -0,0 +1,9 @@\n+{\n+  \"name\": \"whatsApp-clone-tutorial\",\n+  \"description\": \"Fully functional WhatsApp Clone using React (Hooks+Suspense), GraphQL, Apollo, TypeScript and PostgreSQL\",\n+  \"private\": true,\n+  \"repository\": {\n+    \"type\": \"git\",\n+    \"url\": \"https://Urigo@github.com/Urigo/WhatsApp-Clone-Tutorial.git\"\n+  }\n+}\ndiff --git a/server/.env b/server/.env\nnew file mode 100644\nindex 0000000..38922bf\n--- /dev/null\n+++ b/server/.env\n@@ -0,0 +1,2 @@\n+# NEVER DEFINE HERE ONLY ON CLOUD\n+CLOUDINARY_URL=cloudinary://756494366771661:OttZILiLRKaB5tKR8F3vQhMrNRg@whatsapp-clone\ndiff --git a/server/.gitignore b/server/.gitignore\nnew file mode 100644\nindex 0000000..fe3a2f3\n--- /dev/null\n+++ b/server/.gitignore\n@@ -0,0 +1,3 @@\n+node_modules\n+npm-debug.log\n+types.d.ts\ndiff --git a/server/LICENSE b/server/LICENSE\nnew file mode 100644\nindex 0000000..ca7f5e8\n--- /dev/null\n+++ b/server/LICENSE\n@@ -0,0 +1,21 @@\n+The MIT License (MIT)\n+\n+Copyright (c) 2019 Uri Goldshtein\n+\n+Permission is hereby granted, free of charge, to any person obtaining a copy\n+of this software and associated documentation files (the \"Software\"), to deal\n+in the Software without restriction, including without limitation the rights\n+to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+copies of the Software, and to permit persons to whom the Software is\n+furnished to do so, subject to the following conditions:\n+\n+The above copyright notice and this permission notice shall be included in all\n+copies or substantial portions of the Software.\n+\n+THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+SOFTWARE.\ndiff --git a/server/cloudinary.d.ts b/server/cloudinary.d.ts\nnew file mode 100644\nindex 0000000..3217c87\n--- /dev/null\n+++ b/server/cloudinary.d.ts\n@@ -0,0 +1,10 @@\n+declare module 'cloudinary' {\n+  export function config(config: { cloud_name: string; api_key: string; api_secret: string }): void\n+\n+  export var v2: {\n+    uploader: {\n+      upload_stream: (callback?: (error: Error, result: any) => any) => NodeJS.WritableStream\n+      upload: (path: string, callback?: (error: Error, result: any) => any) => any\n+    }\n+  }\n+}\ndiff --git a/server/codegen.yml b/server/codegen.yml\nnew file mode 100644\nindex 0000000..c4191d9\n--- /dev/null\n+++ b/server/codegen.yml\n@@ -0,0 +1,18 @@\n+overwrite: true\n+schema: ./schema.ts\n+require: ts-node/register/transpile-only\n+generates:\n+  ./types.d.ts:\n+    plugins:\n+      - typescript-common\n+      - typescript-resolvers\n+    config:\n+      optionalType: undefined | null\n+      contextType: \"@graphql-modules/core#ModuleContext\"\n+      mappers:\n+        Chat: ./entity/chat#Chat\n+        Message: ./entity/message#Message\n+        Recipient: ./entity/recipient#Recipient\n+        User: ./entity/user#User\n+      scalars:\n+        Date: Date\ndiff --git a/server/db.ts b/server/db.ts\nnew file mode 100644\nindex 0000000..c70cb27\n--- /dev/null\n+++ b/server/db.ts\n@@ -0,0 +1,254 @@\n+import 'reflect-metadata'\n+import moment from 'moment'\n+import { Connection } from 'typeorm'\n+import { Chat } from './entity/chat'\n+import { Message } from './entity/message'\n+import { User } from './entity/user'\n+\n+export enum MessageType {\n+  PICTURE,\n+  TEXT,\n+  LOCATION,\n+}\n+\n+export async function addSampleData(connection: Connection) {\n+  const user1 = new User({\n+    username: 'ethan',\n+    password: '$2a$08$NO9tkFLCoSqX1c5wk3s7z.JfxaVMKA.m7zUDdDwEquo4rvzimQeJm', // 111\n+    name: 'Ethan Gonzalez',\n+    picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n+  })\n+  await connection.manager.save(user1)\n+\n+  const user2 = new User({\n+    username: 'bryan',\n+    password: '$2a$08$xE4FuCi/ifxjL2S8CzKAmuKLwv18ktksSN.F3XYEnpmcKtpbpeZgO', // 222\n+    name: 'Bryan Wallace',\n+    picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n+  })\n+  await connection.manager.save(user2)\n+\n+  const user3 = new User({\n+    username: 'avery',\n+    password: '$2a$08$UHgH7J8G6z1mGQn2qx2kdeWv0jvgHItyAsL9hpEUI3KJmhVW5Q1d.', // 333\n+    name: 'Avery Stewart',\n+    picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n+  })\n+  await connection.manager.save(user3)\n+\n+  const user4 = new User({\n+    username: 'katie',\n+    password: '$2a$08$wR1k5Q3T9FC7fUgB7Gdb9Os/GV7dGBBf4PLlWT7HERMFhmFDt47xi', // 444\n+    name: 'Katie Peterson',\n+    picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n+  })\n+  await connection.manager.save(user4)\n+\n+  const user5 = new User({\n+    username: 'ray',\n+    password: '$2a$08$6.mbXqsDX82ZZ7q5d8Osb..JrGSsNp4R3IKj7mxgF6YGT0OmMw242', // 555\n+    name: 'Ray Edwards',\n+    picture: 'https://randomuser.me/api/portraits/thumb/men/3.jpg',\n+  })\n+  await connection.manager.save(user5)\n+\n+  const user6 = new User({\n+    username: 'niko',\n+    password: '$2a$08$fL5lZR.Rwf9FWWe8XwwlceiPBBim8n9aFtaem.INQhiKT4.Ux3Uq.', // 666\n+    name: 'NiccolÃ² Belli',\n+    picture: 'https://randomuser.me/api/portraits/thumb/men/4.jpg',\n+  })\n+  await connection.manager.save(user6)\n+\n+  const user7 = new User({\n+    username: 'mario',\n+    password: '$2a$08$nDHDmWcVxDnH5DDT3HMMC.psqcnu6wBiOgkmJUy9IH..qxa3R6YrO', // 777\n+    name: 'Mario Rossi',\n+    picture: 'https://randomuser.me/api/portraits/thumb/men/5.jpg',\n+  })\n+  await connection.manager.save(user7)\n+\n+  await connection.manager.save(\n+    new Chat({\n+      allTimeMembers: [user1, user3],\n+      listingMembers: [user1, user3],\n+      messages: [\n+        new Message({\n+          sender: user1,\n+          content: 'You on your way?',\n+          createdAt: moment()\n+            .subtract(1, 'hours')\n+            .toDate(),\n+          type: MessageType.TEXT,\n+          holders: [user1, user3],\n+        }),\n+        new Message({\n+          sender: user3,\n+          content: 'Yep!',\n+          createdAt: moment()\n+            .subtract(1, 'hours')\n+            .add(5, 'minutes')\n+            .toDate(),\n+          type: MessageType.TEXT,\n+          holders: [user1, user3],\n+        }),\n+      ],\n+    })\n+  )\n+\n+  await connection.manager.save(\n+    new Chat({\n+      allTimeMembers: [user1, user4],\n+      listingMembers: [user1, user4],\n+      messages: [\n+        new Message({\n+          sender: user1,\n+          content: \"Hey, it's me\",\n+          createdAt: moment()\n+            .subtract(2, 'hours')\n+            .toDate(),\n+          type: MessageType.TEXT,\n+          holders: [user1, user4],\n+        }),\n+      ],\n+    })\n+  )\n+\n+  await connection.manager.save(\n+    new Chat({\n+      allTimeMembers: [user1, user5],\n+      listingMembers: [user1, user5],\n+      messages: [\n+        new Message({\n+          sender: user1,\n+          content: 'I should buy a boat',\n+          createdAt: moment()\n+            .subtract(1, 'days')\n+            .toDate(),\n+          type: MessageType.TEXT,\n+          holders: [user1, user5],\n+        }),\n+        new Message({\n+          sender: user1,\n+          content: 'You still there?',\n+          createdAt: moment()\n+            .subtract(1, 'days')\n+            .add(16, 'hours')\n+            .toDate(),\n+          type: MessageType.TEXT,\n+          holders: [user1, user5],\n+        }),\n+      ],\n+    })\n+  )\n+\n+  await connection.manager.save(\n+    new Chat({\n+      allTimeMembers: [user3, user4],\n+      listingMembers: [user3, user4],\n+      messages: [\n+        new Message({\n+          sender: user3,\n+          content: 'Look at my mukluks!',\n+          createdAt: moment()\n+            .subtract(4, 'days')\n+            .toDate(),\n+          type: MessageType.TEXT,\n+          holders: [user3, user4],\n+        }),\n+      ],\n+    })\n+  )\n+\n+  await connection.manager.save(\n+    new Chat({\n+      allTimeMembers: [user2, user5],\n+      listingMembers: [user2, user5],\n+      messages: [\n+        new Message({\n+          sender: user2,\n+          content: 'This is wicked good ice cream.',\n+          createdAt: moment()\n+            .subtract(2, 'weeks')\n+            .toDate(),\n+          type: MessageType.TEXT,\n+          holders: [user2, user5],\n+        }),\n+        new Message({\n+          sender: user5,\n+          content: 'Love it!',\n+          createdAt: moment()\n+            .subtract(2, 'weeks')\n+            .add(10, 'minutes')\n+            .toDate(),\n+          type: MessageType.TEXT,\n+          holders: [user2, user5],\n+        }),\n+      ],\n+    })\n+  )\n+\n+  await connection.manager.save(\n+    new Chat({\n+      allTimeMembers: [user1, user6],\n+      listingMembers: [user1],\n+    })\n+  )\n+\n+  await connection.manager.save(\n+    new Chat({\n+      allTimeMembers: [user2, user1],\n+      listingMembers: [user2],\n+    })\n+  )\n+\n+  await connection.manager.save(\n+    new Chat({\n+      name: \"Ethan's group\",\n+      picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n+      allTimeMembers: [user1, user3, user4, user6],\n+      listingMembers: [user1, user3, user4, user6],\n+      owner: user1,\n+      messages: [\n+        new Message({\n+          sender: user1,\n+          content: 'I made a group',\n+          createdAt: moment()\n+            .subtract(2, 'weeks')\n+            .toDate(),\n+          type: MessageType.TEXT,\n+          holders: [user1, user3, user4, user6],\n+        }),\n+        new Message({\n+          sender: user1,\n+          content: 'Ops, Avery was not supposed to be here',\n+          createdAt: moment()\n+            .subtract(2, 'weeks')\n+            .add(2, 'minutes')\n+            .toDate(),\n+          type: MessageType.TEXT,\n+          holders: [user1, user4, user6],\n+        }),\n+        new Message({\n+          sender: user4,\n+          content: 'Awesome!',\n+          createdAt: moment()\n+            .subtract(2, 'weeks')\n+            .add(10, 'minutes')\n+            .toDate(),\n+          type: MessageType.TEXT,\n+          holders: [user1, user4, user6],\n+        }),\n+      ],\n+    })\n+  )\n+\n+  await connection.manager.save(\n+    new Chat({\n+      name: \"Ray's group\",\n+      allTimeMembers: [user3, user6],\n+      listingMembers: [user3, user6],\n+      owner: user6,\n+    })\n+  )\n+}\ndiff --git a/server/entity/chat.ts b/server/entity/chat.ts\nnew file mode 100644\nindex 0000000..797b830\n--- /dev/null\n+++ b/server/entity/chat.ts\n@@ -0,0 +1,107 @@\n+import {\n+  Entity,\n+  Column,\n+  PrimaryGeneratedColumn,\n+  OneToMany,\n+  JoinTable,\n+  ManyToMany,\n+  ManyToOne,\n+  CreateDateColumn,\n+} from 'typeorm'\n+import Message from './message'\n+import User from './user'\n+\n+interface ChatConstructor {\n+  name?: string\n+  picture?: string\n+  allTimeMembers?: User[]\n+  listingMembers?: User[]\n+  actualGroupMembers?: User[]\n+  admins?: User[]\n+  owner?: User\n+  messages?: Message[]\n+}\n+\n+@Entity()\n+export class Chat {\n+  @PrimaryGeneratedColumn()\n+  id: string\n+\n+  @CreateDateColumn({ nullable: true })\n+  createdAt: Date\n+\n+  @Column({ nullable: true })\n+  name: string\n+\n+  @Column({ nullable: true })\n+  picture: string\n+\n+  @ManyToMany(type => User, user => user.allTimeMemberChats, {\n+    cascade: ['insert', 'update'],\n+    eager: false,\n+  })\n+  @JoinTable()\n+  allTimeMembers: User[]\n+\n+  @ManyToMany(type => User, user => user.listingMemberChats, {\n+    cascade: ['insert', 'update'],\n+    eager: false,\n+  })\n+  @JoinTable()\n+  listingMembers: User[]\n+\n+  @ManyToMany(type => User, user => user.actualGroupMemberChats, { cascade: [\"insert\", \"update\"], eager: false })\n+  @JoinTable()\n+  actualGroupMembers?: User[]\n+\n+  @ManyToMany(type => User, user => user.adminChats, { cascade: [\"insert\", \"update\"], eager: false })\n+  @JoinTable()\n+  admins?: User[]\n+\n+  @ManyToOne(type => User, user => user.ownerChats, { cascade: ['insert', 'update'], eager: false })\n+  owner?: User | null\n+\n+  @OneToMany(type => Message, message => message.chat, {\n+    cascade: ['insert', 'update'],\n+    eager: true,\n+  })\n+  messages: Message[]\n+\n+  constructor({\n+    name,\n+    picture,\n+    allTimeMembers,\n+    listingMembers,\n+    actualGroupMembers,\n+    admins,\n+    owner,\n+    messages,\n+  }: ChatConstructor = {}) {\n+    if (name) {\n+      this.name = name\n+    }\n+    if (picture) {\n+      this.picture = picture\n+    }\n+    if (allTimeMembers) {\n+      this.allTimeMembers = allTimeMembers\n+    }\n+    if (actualGroupMembers) {\n+      this.actualGroupMembers = actualGroupMembers\n+    }\n+    if (admins) {\n+      this.admins = admins\n+    }\n+    if (listingMembers) {\n+      this.listingMembers = listingMembers\n+    }\n+    if (owner) {\n+      this.owner = owner\n+    }\n+    if (messages) {\n+      this.messages = messages\n+    }\n+  }\n+}\n+\n+export default Chat\ndiff --git a/server/entity/message.ts b/server/entity/message.ts\nnew file mode 100644\nindex 0000000..3479c00\n--- /dev/null\n+++ b/server/entity/message.ts\n@@ -0,0 +1,90 @@\n+import {\n+  Entity,\n+  Column,\n+  PrimaryGeneratedColumn,\n+  OneToMany,\n+  ManyToOne,\n+  ManyToMany,\n+  JoinTable,\n+  CreateDateColumn,\n+} from 'typeorm'\n+import Chat from './chat'\n+import Recipient from './recipient'\n+import User from './user'\n+import { MessageType } from '../db'\n+\n+interface MessageConstructor {\n+  sender?: User\n+  content?: string\n+  createdAt?: Date\n+  type?: MessageType\n+  recipients?: Recipient[]\n+  holders?: User[]\n+  chat?: Chat\n+}\n+\n+@Entity()\n+export class Message {\n+  @PrimaryGeneratedColumn()\n+  id: string\n+\n+  @ManyToOne(type => User, user => user.senderMessages, { eager: true })\n+  sender: User\n+\n+  @Column()\n+  content: string\n+\n+  @CreateDateColumn({ nullable: true })\n+  createdAt: Date\n+\n+  @Column()\n+  type: number\n+\n+  @OneToMany(type => Recipient, recipient => recipient.message, { cascade: ['insert', 'update'], eager: true })\n+  recipients: Recipient[]\n+\n+  @ManyToMany(type => User, user => user.holderMessages, {\n+    cascade: ['insert', 'update'],\n+    eager: true,\n+  })\n+  @JoinTable()\n+  holders: User[]\n+\n+  @ManyToOne(type => Chat, chat => chat.messages)\n+  chat: Chat\n+\n+  constructor({\n+    sender,\n+    content,\n+    createdAt,\n+    type,\n+    recipients,\n+    holders,\n+    chat,\n+  }: MessageConstructor = {}) {\n+    if (sender) {\n+      this.sender = sender\n+    }\n+    if (content) {\n+      this.content = content\n+    }\n+    if (createdAt) {\n+      this.createdAt = createdAt\n+    }\n+    if (type) {\n+      this.type = type\n+    }\n+    if (recipients) {\n+      recipients.forEach(recipient => recipient.message = this)\n+      this.recipients = recipients\n+    }\n+    if (holders) {\n+      this.holders = holders\n+    }\n+    if (chat) {\n+      this.chat = chat\n+    }\n+  }\n+}\n+\n+export default Message\ndiff --git a/server/entity/recipient.ts b/server/entity/recipient.ts\nnew file mode 100644\nindex 0000000..0165bdf\n--- /dev/null\n+++ b/server/entity/recipient.ts\n@@ -0,0 +1,42 @@\n+import { Entity, ManyToOne, Column } from 'typeorm'\n+import { Message } from './message'\n+import { User } from './user'\n+\n+interface RecipientConstructor {\n+  user?: User\n+  message?: Message\n+  receivedAt?: Date\n+  readAt?: Date\n+}\n+\n+@Entity()\n+export class Recipient {\n+  @ManyToOne(type => User, user => user.recipients, { primary: true })\n+  user: User\n+\n+  @ManyToOne(type => Message, message => message.recipients, { primary: true })\n+  message: Message\n+\n+  @Column({ nullable: true })\n+  receivedAt: Date\n+\n+  @Column({ nullable: true })\n+  readAt: Date\n+\n+  constructor({ user, message, receivedAt, readAt }: RecipientConstructor = {}) {\n+    if (user) {\n+      this.user = user\n+    }\n+    if (message) {\n+      this.message = message\n+    }\n+    if (receivedAt) {\n+      this.receivedAt = receivedAt\n+    }\n+    if (readAt) {\n+      this.readAt = readAt\n+    }\n+  }\n+}\n+\n+export default Recipient\ndiff --git a/server/entity/user.ts b/server/entity/user.ts\nnew file mode 100644\nindex 0000000..a9fb1a6\n--- /dev/null\n+++ b/server/entity/user.ts\n@@ -0,0 +1,70 @@\n+import { Entity, Column, PrimaryGeneratedColumn, ManyToMany, OneToMany } from 'typeorm'\n+import Chat from './chat'\n+import Message from './message'\n+import Recipient from './recipient'\n+\n+interface UserConstructor {\n+  username?: string\n+  password?: string\n+  name?: string\n+  picture?: string\n+}\n+\n+@Entity('app_user')\n+export class User {\n+  @PrimaryGeneratedColumn()\n+  id: string\n+\n+  @Column()\n+  username: string\n+\n+  @Column()\n+  password: string\n+\n+  @Column()\n+  name: string\n+\n+  @Column({ nullable: true })\n+  picture: string\n+\n+  @ManyToMany(type => Chat, chat => chat.allTimeMembers)\n+  allTimeMemberChats: Chat[]\n+\n+  @ManyToMany(type => Chat, chat => chat.listingMembers)\n+  listingMemberChats: Chat[]\n+\n+  @ManyToMany(type => Chat, chat => chat.actualGroupMembers)\n+  actualGroupMemberChats: Chat[]\n+\n+  @ManyToMany(type => Chat, chat => chat.admins)\n+  adminChats: Chat[]\n+\n+  @ManyToMany(type => Message, message => message.holders)\n+  holderMessages: Message[]\n+\n+  @OneToMany(type => Chat, chat => chat.owner)\n+  ownerChats: Chat[]\n+\n+  @OneToMany(type => Message, message => message.sender)\n+  senderMessages: Message[]\n+\n+  @OneToMany(type => Recipient, recipient => recipient.user)\n+  recipients: Recipient[]\n+\n+  constructor({ username, password, name, picture }: UserConstructor = {}) {\n+    if (username) {\n+      this.username = username\n+    }\n+    if (password) {\n+      this.password = password\n+    }\n+    if (name) {\n+      this.name = name\n+    }\n+    if (picture) {\n+      this.picture = picture\n+    }\n+  }\n+}\n+\n+export default User\ndiff --git a/server/index.ts b/server/index.ts\nnew file mode 100644\nindex 0000000..edef669\n--- /dev/null\n+++ b/server/index.ts\n@@ -0,0 +1,47 @@\n+require('dotenv').config()\n+\n+import 'reflect-metadata'\n+import { ApolloServer } from 'apollo-server-express'\n+import bodyParser from 'body-parser'\n+import cors from 'cors'\n+import express from 'express'\n+import gql from 'graphql-tag'\n+import { createServer } from 'http'\n+import { createConnection } from 'typeorm'\n+import { addSampleData } from './db'\n+import { AppModule } from './modules/app.module'\n+\n+const PORT = 4000\n+\n+createConnection().then((connection) => {\n+  if (process.argv.includes('--add-sample-data')) {\n+    addSampleData(connection)\n+  }\n+\n+  const app = express()\n+\n+  app.use(cors())\n+  app.use(bodyParser.json())\n+\n+  const { schema, context, subscriptions } = AppModule.forRoot({ app, connection })\n+\n+  const apollo = new ApolloServer({\n+    schema,\n+    context,\n+    subscriptions,\n+  })\n+\n+  apollo.applyMiddleware({\n+    app,\n+    path: '/graphql',\n+  })\n+\n+  // Wrap the Express server\n+  const ws = createServer(app)\n+\n+  apollo.installSubscriptionHandlers(ws)\n+\n+  ws.listen(PORT, () => {\n+    console.log(`Apollo Server is now running on http://localhost:${PORT}`)\n+  })\n+})\ndiff --git a/server/modules/app.module.ts b/server/modules/app.module.ts\nnew file mode 100644\nindex 0000000..4cc95f6\n--- /dev/null\n+++ b/server/modules/app.module.ts\n@@ -0,0 +1,28 @@\n+import { GraphQLModule } from '@graphql-modules/core'\n+import { Connection } from 'typeorm'\n+import { Express } from 'express'\n+import { AuthModule } from './auth'\n+import { UserModule } from './user'\n+import { ChatModule } from './chat'\n+import { RecipientModule } from './recipient'\n+import { MessageModule } from './message'\n+\n+export interface IAppModuleConfig {\n+  connection: Connection\n+  app: Express\n+}\n+\n+export const AppModule = new GraphQLModule<IAppModuleConfig>({\n+  name: 'App',\n+  imports: ({ config: { app, connection } }) => [\n+    AuthModule.forRoot({\n+      app,\n+      connection,\n+    }),\n+    UserModule,\n+    ChatModule,\n+    MessageModule,\n+    RecipientModule,\n+  ],\n+  configRequired: true,\n+})\ndiff --git a/server/modules/app.symbols.ts b/server/modules/app.symbols.ts\nnew file mode 100644\nindex 0000000..8c01bd3\n--- /dev/null\n+++ b/server/modules/app.symbols.ts\n@@ -0,0 +1 @@\n+export const APP = Symbol.for('APP')\ndiff --git a/server/modules/auth/index.ts b/server/modules/auth/index.ts\nnew file mode 100644\nindex 0000000..dd4993a\n--- /dev/null\n+++ b/server/modules/auth/index.ts\n@@ -0,0 +1,61 @@\n+import { GraphQLModule } from '@graphql-modules/core'\n+import { loadResolversFiles, loadSchemaFiles } from '@graphql-modules/sonar'\n+import { Express } from 'express'\n+import { Connection } from 'typeorm'\n+import { AuthProvider } from './providers/auth.provider'\n+import { APP } from '../app.symbols'\n+import { PubSub } from 'apollo-server-express'\n+import passport from 'passport'\n+import basicStrategy from 'passport-http'\n+import { InjectFunction } from '@graphql-modules/di'\n+\n+export interface IAppModuleConfig {\n+  connection: Connection\n+  app: Express\n+}\n+\n+export const AuthModule = new GraphQLModule<IAppModuleConfig>({\n+  name: 'Auth',\n+  providers: ({ config: { connection, app } }) => [\n+    { provide: Connection, useValue: connection },\n+    { provide: APP, useValue: app },\n+    PubSub,\n+    AuthProvider,\n+  ],\n+  typeDefs: loadSchemaFiles(__dirname + '/schema/'),\n+  resolvers: loadResolversFiles(__dirname + '/resolvers/'),\n+  configRequired: true,\n+  middleware: InjectFunction(AuthProvider, APP)((authProvider, app: Express) => {\n+    passport.use(\n+      'basic-signin',\n+      new basicStrategy.BasicStrategy(async (username: string, password: string, done: any) => {\n+        done(null, await authProvider.signIn(username, password))\n+      })\n+    )\n+\n+    passport.use(\n+      'basic-signup',\n+      new basicStrategy.BasicStrategy(\n+        { passReqToCallback: true },\n+        async (\n+          req: Express.Request & { body: { name?: string } },\n+          username: string,\n+          password: string,\n+          done: any\n+        ) => {\n+          const name = req.body.name\n+          return done(null, !!name && (await authProvider.signUp(username, password, name)))\n+        }\n+      )\n+    )\n+\n+    app.post('/signup', passport.authenticate('basic-signup', { session: false }), (req, res) =>\n+      res.json(req.user)\n+    )\n+\n+    app.use(passport.authenticate('basic-signin', { session: false }))\n+\n+    app.post('/signin', (req, res) => res.json(req.user))\n+    return {}\n+  }),\n+})\ndiff --git a/server/modules/auth/providers/auth.provider.ts b/server/modules/auth/providers/auth.provider.ts\nnew file mode 100644\nindex 0000000..795f424\n--- /dev/null\n+++ b/server/modules/auth/providers/auth.provider.ts\n@@ -0,0 +1,75 @@\n+import { Injectable, ProviderScope } from '@graphql-modules/di'\n+import { ModuleSessionInfo, OnRequest, OnConnect } from '@graphql-modules/core'\n+import { Connection } from 'typeorm'\n+import { User } from '../../../entity/user'\n+import bcrypt from 'bcrypt-nodejs'\n+\n+@Injectable({\n+  scope: ProviderScope.Session,\n+})\n+export class AuthProvider implements OnRequest, OnConnect {\n+  currentUser: User\n+\n+  constructor(private connection: Connection) {}\n+\n+  onRequest({ session }: ModuleSessionInfo) {\n+    if ('req' in session) {\n+      this.currentUser = session.req.user\n+    }\n+  }\n+\n+  async onConnect(connectionParams: { authToken?: string }) {\n+    if (connectionParams.authToken) {\n+      // Create a buffer and tell it the data coming in is base64\n+      const buf = Buffer.from(connectionParams.authToken.split(' ')[1], 'base64')\n+      // Read it back out as a string\n+      const [username, password]: string[] = buf.toString().split(':')\n+      const user = await this.signIn(username, password)\n+      if (user) {\n+        // Set context for the WebSocket\n+        this.currentUser = user\n+      } else {\n+        throw new Error('Wrong credentials!')\n+      }\n+    } else {\n+      throw new Error('Missing auth token!')\n+    }\n+  }\n+\n+  getUserByUsername(username: string) {\n+    return this.connection.getRepository(User).findOne({ where: { username } })\n+  }\n+\n+  async signIn(username: string, password: string): Promise<User | false> {\n+    const user = await this.getUserByUsername(username)\n+    if (user && this.validPassword(password, user.password)) {\n+      return user\n+    } else {\n+      return false\n+    }\n+  }\n+\n+  async signUp(username: string, password: string, name: string): Promise<User | false> {\n+    const userExists = !!(await this.getUserByUsername(username))\n+    if (!userExists) {\n+      const user = this.connection.manager.save(\n+        new User({\n+          username,\n+          password: this.generateHash(password),\n+          name,\n+        })\n+      )\n+      return user\n+    } else {\n+      return false\n+    }\n+  }\n+\n+  generateHash(password: string) {\n+    return bcrypt.hashSync(password, bcrypt.genSaltSync(8))\n+  }\n+\n+  validPassword(password: string, localPassword: string) {\n+    return bcrypt.compareSync(password, localPassword)\n+  }\n+}\ndiff --git a/server/modules/chat/index.ts b/server/modules/chat/index.ts\nnew file mode 100644\nindex 0000000..bb66825\n--- /dev/null\n+++ b/server/modules/chat/index.ts\n@@ -0,0 +1,16 @@\n+import { GraphQLModule } from '@graphql-modules/core'\n+import { ProviderScope } from '@graphql-modules/di'\n+import { loadResolversFiles, loadSchemaFiles } from '@graphql-modules/sonar'\n+import { AuthModule } from '../auth'\n+import { UserModule } from '../user'\n+import { UtilsModule } from '../utils.module'\n+import { ChatProvider } from './providers/chat.provider'\n+\n+export const ChatModule = new GraphQLModule({\n+  name: 'Chat',\n+  imports: [AuthModule, UtilsModule, UserModule],\n+  providers: [ChatProvider],\n+  defaultProviderScope: ProviderScope.Session,\n+  typeDefs: loadSchemaFiles(__dirname + '/schema/'),\n+  resolvers: loadResolversFiles(__dirname + '/resolvers/'),\n+})\ndiff --git a/server/modules/chat/providers/chat.provider.ts b/server/modules/chat/providers/chat.provider.ts\nnew file mode 100644\nindex 0000000..b3f0de8\n--- /dev/null\n+++ b/server/modules/chat/providers/chat.provider.ts\n@@ -0,0 +1,387 @@\n+import { Injectable } from '@graphql-modules/di'\n+import { PubSub } from 'apollo-server-express'\n+import { Connection } from 'typeorm'\n+import { Chat } from '../../../entity/chat'\n+import { User } from '../../../entity/user'\n+import { AuthProvider } from '../../auth/providers/auth.provider'\n+import { UserProvider } from '../../user/providers/user.provider'\n+\n+@Injectable()\n+export class ChatProvider {\n+  constructor(\n+    private pubsub: PubSub,\n+    private connection: Connection,\n+    private userProvider: UserProvider,\n+    private authProvider: AuthProvider\n+  ) {}\n+\n+  repository = this.connection.getRepository(Chat)\n+  currentUser = this.authProvider.currentUser\n+\n+  createQueryBuilder() {\n+    return this.connection.createQueryBuilder(Chat, 'chat')\n+  }\n+\n+  async getChats() {\n+    return this.createQueryBuilder()\n+      .leftJoin('chat.listingMembers', 'listingMembers')\n+      .where('listingMembers.id = :id', { id: this.currentUser.id })\n+      .orderBy('chat.createdAt', 'DESC')\n+      .getMany()\n+  }\n+\n+  async getChat(chatId: string) {\n+    const chat = await this.createQueryBuilder()\n+      .whereInIds(chatId)\n+      .getOne()\n+\n+    return chat || null\n+  }\n+\n+  async addChat(userId: string) {\n+    const user = await this.userProvider\n+      .createQueryBuilder()\n+      .whereInIds(userId)\n+      .getOne();\n+\n+    if (!user) {\n+      throw new Error(`User ${userId} doesn't exist.`);\n+    }\n+\n+    let chat = await this\n+      .createQueryBuilder()\n+      .where('chat.name IS NULL')\n+      .innerJoin('chat.allTimeMembers', 'allTimeMembers1', 'allTimeMembers1.id = :currentUserId', {\n+        currentUserId: this.currentUser.id,\n+      })\n+      .innerJoin('chat.allTimeMembers', 'allTimeMembers2', 'allTimeMembers2.id = :userId', {\n+        userId: userId,\n+      })\n+      .innerJoinAndSelect('chat.listingMembers', 'listingMembers')\n+      .getOne();\n+\n+    if (chat) {\n+      // Chat already exists. Both users are already in the userIds array\n+      const listingMembers = await this.userProvider\n+        .createQueryBuilder()\n+        .innerJoin(\n+          'user.listingMemberChats',\n+          'listingMemberChats',\n+          'listingMemberChats.id = :chatId',\n+          { chatId: chat.id },\n+        )\n+        .getMany();\n+\n+      if (!listingMembers.find(user => user.id === this.currentUser.id)) {\n+        // The chat isn't listed for the current user. Add him to the memberIds\n+        chat.listingMembers.push(this.currentUser);\n+        chat = await this.repository.save(chat);\n+\n+        return chat || null;\n+      } else {\n+        return chat;\n+      }\n+    } else {\n+      // Create the chat\n+      chat = await this.repository.save(\n+        new Chat({\n+          allTimeMembers: [this.currentUser, user],\n+          // Chat will not be listed to the other user until the first message gets written\n+          listingMembers: [this.currentUser],\n+        }),\n+      );\n+\n+      return chat || null;\n+    }\n+  }\n+\n+  async getChatName(chat: Chat) {\n+    if (chat.name) {\n+      return chat.name\n+    }\n+\n+    const user = await this.userProvider\n+      .createQueryBuilder()\n+      .where('user.id != :userId', { userId: this.currentUser.id })\n+      .innerJoin(\n+        'user.allTimeMemberChats',\n+        'allTimeMemberChats',\n+        'allTimeMemberChats.id = :chatId',\n+        { chatId: chat.id }\n+      )\n+      .getOne()\n+\n+    return (user && user.name) || null\n+  }\n+\n+  async getChatPicture(chat: Chat) {\n+    if (chat.name) {\n+      return chat.picture\n+    }\n+\n+    const user = await this.userProvider\n+      .createQueryBuilder()\n+      .where('user.id != :userId', { userId: this.currentUser.id })\n+      .innerJoin(\n+        'user.allTimeMemberChats',\n+        'allTimeMemberChats',\n+        'allTimeMemberChats.id = :chatId',\n+        { chatId: chat.id }\n+      )\n+      .getOne()\n+\n+    return user ? user.picture : null\n+  }\n+\n+  getChatAllTimeMembers(chat: Chat) {\n+    return this.userProvider\n+      .createQueryBuilder()\n+      .innerJoin(\n+        'user.listingMemberChats',\n+        'listingMemberChats',\n+        'listingMemberChats.id = :chatId',\n+        { chatId: chat.id }\n+      )\n+      .getMany()\n+  }\n+\n+  getChatListingMembers(chat: Chat) {\n+    return this.userProvider\n+      .createQueryBuilder()\n+      .innerJoin(\n+        'user.listingMemberChats',\n+        'listingMemberChats',\n+        'listingMemberChats.id = :chatId',\n+        { chatId: chat.id }\n+      )\n+      .getMany()\n+  }\n+\n+  getChatActualGroupMembers(chat: Chat) {\n+    return this.userProvider\n+      .createQueryBuilder()\n+      .innerJoin(\n+        'user.actualGroupMemberChats',\n+        'actualGroupMemberChats',\n+        'actualGroupMemberChats.id = :chatId',\n+        { chatId: chat.id },\n+      )\n+      .getMany();\n+  }\n+\n+  getChatAdmins(chat: Chat) {\n+    return this.userProvider\n+      .createQueryBuilder()\n+      .innerJoin('user.adminChats', 'adminChats', 'adminChats.id = :chatId', {\n+        chatId: chat.id,\n+      })\n+      .getMany();\n+  }\n+\n+  async getChatOwner(chat: Chat) {\n+    const owner = await this.userProvider\n+      .createQueryBuilder()\n+      .innerJoin('user.ownerChats', 'ownerChats', 'ownerChats.id = :chatId', {\n+        chatId: chat.id,\n+      })\n+      .getOne()\n+\n+    return owner || null\n+  }\n+\n+  async isChatGroup(chat: Chat) {\n+    return !!chat.name;\n+  }\n+\n+  async filterChatAddedOrUpdated(chatAddedOrUpdated: Chat, creatorOrUpdaterId: string) {\n+    return (\n+      creatorOrUpdaterId !== this.currentUser.id &&\n+      chatAddedOrUpdated.listingMembers.some((user: User) => user.id === this.currentUser.id)\n+    )\n+  }\n+\n+  async updateUser({\n+    name,\n+    picture,\n+  }: {\n+    name?: string\n+    picture?: string\n+  } = {}) {\n+    await this.userProvider.updateUser({ name, picture })\n+\n+    const data = await this.connection\n+      .createQueryBuilder(User, 'user')\n+      .where('user.id = :id', { id: this.currentUser.id })\n+      // Get a list of the chats who have/had currentUser involved\n+      .innerJoinAndSelect(\n+        'user.allTimeMemberChats',\n+        'allTimeMemberChats',\n+        // Groups are unaffected\n+        'allTimeMemberChats.name IS NULL'\n+      )\n+      // We need to notify only those who get the chat listed (except currentUser of course)\n+      .innerJoin(\n+        'allTimeMemberChats.listingMembers',\n+        'listingMembers',\n+        'listingMembers.id != :currentUserId',\n+        {\n+          currentUserId: this.currentUser.id,\n+        }\n+      )\n+      .getOne()\n+\n+    const chatsAffected = (data && data.allTimeMemberChats) || []\n+\n+    chatsAffected.forEach(chat => {\n+      this.pubsub.publish('chatUpdated', {\n+        updaterId: this.currentUser.id,\n+        chatUpdated: chat,\n+      })\n+    })\n+\n+    return this.currentUser\n+  }\n+\n+  async removeChat(chatId: string) {\n+    const chat = await this.createQueryBuilder()\n+      .whereInIds(Number(chatId))\n+      .innerJoinAndSelect('chat.listingMembers', 'listingMembers')\n+      .leftJoinAndSelect('chat.actualGroupMembers', 'actualGroupMembers')\n+      .leftJoinAndSelect('chat.admins', 'admins')\n+      .leftJoinAndSelect('chat.owner', 'owner')\n+      .getOne();\n+\n+    if (!chat) {\n+      throw new Error(`The chat ${chatId} doesn't exist.`)\n+    }\n+\n+    if (!chat.name) {\n+      // Chat\n+      if (!chat.listingMembers.find(user => user.id === this.currentUser.id)) {\n+        throw new Error(`The user is not a listing member of the chat ${chatId}.`)\n+      }\n+\n+      // Remove the current user from who gets the chat listed. The chat will no longer appear in his list\n+      chat.listingMembers = chat.listingMembers.filter(user => user.id !== this.currentUser.id);\n+\n+      // Check how many members are left\n+      if (chat.listingMembers.length === 0) {\n+        // Delete the chat\n+        await this.repository.remove(chat);\n+      } else {\n+        // Update the group\n+\n+        // Remove the current user from the chat members. He is no longer a member of the group\n+        chat.actualGroupMembers = chat.actualGroupMembers && chat.actualGroupMembers.filter(user =>\n+          user.id !== this.currentUser.id\n+        );\n+        // Remove the current user from the chat admins\n+        chat.admins = chat.admins && chat.admins.filter(user => user.id !== this.currentUser.id);\n+        // If there are no more admins left the group goes read only\n+        // A null owner means the group is read-only\n+        chat.owner = chat.admins && chat.admins[0] || null;\n+\n+        await this.repository.save(chat);\n+      }\n+\n+      return chatId;\n+    } else {\n+      // Group\n+\n+      // Remove the current user from who gets the group listed. The group will no longer appear in his list\n+      chat.listingMembers = chat.listingMembers.filter(user => user.id !== this.currentUser.id);\n+\n+      // Check how many members (including previous ones who can still access old messages) are left\n+      if (chat.listingMembers.length === 0) {\n+        // Remove the group\n+        await this.repository.remove(chat);\n+      } else {\n+        // TODO: Implement for group\n+        chat.owner = chat.listingMembers[0]\n+\n+        await this.repository.save(chat);\n+      }\n+\n+      return chatId;\n+    }\n+  }\n+\n+  async addGroup(\n+    userIds: string[],\n+    {\n+      groupName,\n+      groupPicture,\n+    }: {\n+      groupName?: string\n+      groupPicture?: string\n+    } = {},\n+  ) {\n+    let users: User[] = [];\n+    for (let userId of userIds) {\n+      const user = await this.userProvider\n+        .createQueryBuilder()\n+        .whereInIds(userId)\n+        .getOne();\n+\n+      if (!user) {\n+        throw new Error(`User ${userId} doesn't exist.`);\n+      }\n+\n+      users.push(user);\n+    }\n+\n+    const chat = await this.repository.save(\n+      new Chat({\n+        name: groupName,\n+        admins: [this.currentUser],\n+        picture: groupPicture || undefined,\n+        owner: this.currentUser,\n+        allTimeMembers: [...users, this.currentUser],\n+        listingMembers: [...users, this.currentUser],\n+        actualGroupMembers: [...users, this.currentUser],\n+      }),\n+    );\n+\n+    this.pubsub.publish('chatAdded', {\n+      creatorId: this.currentUser.id,\n+      chatAdded: chat,\n+    });\n+\n+    return chat || null;\n+  }\n+\n+  async updateGroup(\n+    chatId: string,\n+    {\n+      groupName,\n+      groupPicture,\n+    }: {\n+      groupName?: string\n+      groupPicture?: string\n+    } = {},\n+  ) {\n+    const chat = await this.createQueryBuilder()\n+      .whereInIds(chatId)\n+      .getOne();\n+\n+    if (!chat) return null;\n+    if (!chat.name) return chat;\n+\n+    groupName = groupName || chat.name;\n+    groupPicture = groupPicture || chat.picture;\n+    Object.assign(chat, {\n+      name: groupName,\n+      picture: groupPicture,\n+    });\n+\n+    // Update the chat\n+    await this.repository.save(chat);\n+\n+    this.pubsub.publish('chatUpdated', {\n+      updaterId: this.currentUser.id,\n+      chatUpdated: chat,\n+    });\n+\n+    return chat || null;\n+  }\n+}\ndiff --git a/server/modules/chat/resolvers/resolvers.ts b/server/modules/chat/resolvers/resolvers.ts\nnew file mode 100644\nindex 0000000..bfc4d16\n--- /dev/null\n+++ b/server/modules/chat/resolvers/resolvers.ts\n@@ -0,0 +1,55 @@\n+import { PubSub, withFilter } from 'apollo-server-express'\n+import { ModuleContext } from '@graphql-modules/core'\n+import { IResolvers } from '../../../types'\n+import { ChatProvider } from '../providers/chat.provider'\n+import { Chat } from '../../../entity/chat'\n+\n+export default {\n+  Query: {\n+    chats: (obj, args, { injector }) => injector.get(ChatProvider).getChats(),\n+    chat: (obj, { chatId }, { injector }) => injector.get(ChatProvider).getChat(chatId),\n+  },\n+  Mutation: {\n+    updateUser: (obj, { name, picture }, { injector }) => injector.get(ChatProvider).updateUser({\n+      name: name || '',\n+      picture: picture || '',\n+    }),\n+    addChat: (obj, { userId }, { injector }) => injector.get(ChatProvider).addChat(userId),\n+    removeChat: (obj, { chatId }, { injector }) => injector.get(ChatProvider).removeChat(chatId),\n+    addGroup: (obj, { userIds, groupName, groupPicture }, { injector }) =>\n+      injector.get(ChatProvider).addGroup(userIds, {\n+        groupName: groupName || '',\n+        groupPicture: groupPicture || '',\n+      }),\n+    updateGroup: (obj, { chatId, groupName, groupPicture }, { injector }) => injector.get(ChatProvider).updateGroup(chatId, {\n+      groupName: groupName || '',\n+      groupPicture: groupPicture || '',\n+    }),\n+  },\n+  Subscription: {\n+    chatAdded: {\n+      subscribe: withFilter((root, args, { injector }: ModuleContext) => injector.get(PubSub).asyncIterator('chatAdded'),\n+        (data: { chatAdded: Chat, creatorId: string }, variables, { injector }: ModuleContext) =>\n+          data && injector.get(ChatProvider).filterChatAddedOrUpdated(data.chatAdded, data.creatorId)\n+      ),\n+    },\n+    chatUpdated: {\n+      subscribe: withFilter((root, args, { injector }: ModuleContext) => injector.get(PubSub).asyncIterator('chatUpdated'),\n+        (data: { chatUpdated: Chat, updaterId: string }, variables, { injector }: ModuleContext) =>\n+          data && injector.get(ChatProvider).filterChatAddedOrUpdated(data.chatUpdated, data.updaterId)\n+      ),\n+    },\n+  },\n+  Chat: {\n+    name: (chat, args, { injector }) => injector.get(ChatProvider).getChatName(chat),\n+    picture: (chat, args, { injector }) => injector.get(ChatProvider).getChatPicture(chat),\n+    allTimeMembers: (chat, args, { injector }) =>\n+      injector.get(ChatProvider).getChatAllTimeMembers(chat),\n+    listingMembers: (chat, args, { injector }) =>\n+      injector.get(ChatProvider).getChatListingMembers(chat),\n+    actualGroupMembers: (chat, args, { injector }) => injector.get(ChatProvider).getChatActualGroupMembers(chat),\n+    admins: (chat, args, { injector }) => injector.get(ChatProvider).getChatAdmins(chat),\n+    owner: (chat, args, { injector }) => injector.get(ChatProvider).getChatOwner(chat),\n+    isGroup: (chat, args, { injector }) => injector.get(ChatProvider).isChatGroup(chat),\n+  },\n+} as IResolvers\ndiff --git a/server/modules/chat/schema/typeDefs.graphql b/server/modules/chat/schema/typeDefs.graphql\nnew file mode 100644\nindex 0000000..77ec14c\n--- /dev/null\n+++ b/server/modules/chat/schema/typeDefs.graphql\n@@ -0,0 +1,41 @@\n+type Query {\n+  chats: [Chat!]!\n+  chat(chatId: ID!): Chat\n+}\n+\n+type Subscription {\n+  chatAdded: Chat\n+  chatUpdated: Chat\n+}\n+\n+type Chat {\n+  #May be a chat or a group\n+  id: ID!\n+  #Computed for chats\n+  name: String\n+  #Computed for chats\n+  picture: String\n+  #All members, current and past ones.\n+  allTimeMembers: [User!]!\n+  #Whoever gets the chat listed. For groups includes past members who still didn't delete the group.\n+  listingMembers: [User!]!\n+  #Actual members of the group. Null for chats. For groups they are the only ones who can send messages. They aren't the only ones who get the group listed.\n+  actualGroupMembers: [User!]\n+  #Null for chats\n+  admins: [User!]\n+  #If null the group is read-only. Null for chats.\n+  owner: User\n+  #Computed property\n+  isGroup: Boolean!\n+}\n+\n+type Mutation {\n+  addChat(userId: ID!): Chat\n+  removeChat(chatId: ID!): ID\n+  addAdmins(groupId: ID!, userIds: [ID!]!): [ID]!\n+  removeAdmins(groupId: ID!, userIds: [ID!]!): [ID]!\n+  addMembers(groupId: ID!, userIds: [ID!]!): [ID]!\n+  removeMembers(groupId: ID!, userIds: [ID!]!): [ID]!\n+  addGroup(userIds: [ID!]!, groupName: String!, groupPicture: String): Chat\n+  updateGroup(chatId: ID!, groupName: String, groupPicture: String): Chat\n+}\ndiff --git a/server/modules/message/index.ts b/server/modules/message/index.ts\nnew file mode 100644\nindex 0000000..e97283f\n--- /dev/null\n+++ b/server/modules/message/index.ts\n@@ -0,0 +1,24 @@\n+import { GraphQLModule } from '@graphql-modules/core'\n+import { ProviderScope } from '@graphql-modules/di'\n+import { loadResolversFiles, loadSchemaFiles } from '@graphql-modules/sonar'\n+import { AuthModule } from '../auth'\n+import { ChatModule } from '../chat'\n+import { UserModule } from '../user'\n+import { UtilsModule } from '../utils.module'\n+import { MessageProvider } from './providers/message.provider'\n+\n+export const MessageModule = new GraphQLModule({\n+  name: 'Message',\n+  imports: [\n+    AuthModule,\n+    UtilsModule,\n+    UserModule,\n+    ChatModule,\n+  ],\n+  providers: [\n+    MessageProvider,\n+  ],\n+  defaultProviderScope: ProviderScope.Session,\n+  typeDefs: loadSchemaFiles(__dirname + '/schema/'),\n+  resolvers: loadResolversFiles(__dirname + '/resolvers/'),\n+})\ndiff --git a/server/modules/message/providers/message.provider.ts b/server/modules/message/providers/message.provider.ts\nnew file mode 100644\nindex 0000000..737e769\n--- /dev/null\n+++ b/server/modules/message/providers/message.provider.ts\n@@ -0,0 +1,360 @@\n+import { Injectable } from '@graphql-modules/di'\n+import { PubSub } from 'apollo-server-express'\n+import { Connection } from 'typeorm'\n+import { MessageType } from '../../../db'\n+import { Chat } from '../../../entity/chat'\n+import { Message } from '../../../entity/message'\n+import { User } from '../../../entity/user'\n+import { AuthProvider } from '../../auth/providers/auth.provider'\n+import { ChatProvider } from '../../chat/providers/chat.provider'\n+import { UserProvider } from '../../user/providers/user.provider'\n+\n+@Injectable()\n+export class MessageProvider {\n+  constructor(\n+    private pubsub: PubSub,\n+    private connection: Connection,\n+    private chatProvider: ChatProvider,\n+    private authProvider: AuthProvider,\n+    private userProvider: UserProvider\n+  ) {}\n+\n+  repository = this.connection.getRepository(Message)\n+  currentUser = this.authProvider.currentUser\n+\n+  createQueryBuilder() {\n+    return this.connection.createQueryBuilder(Message, 'message')\n+  }\n+\n+  async addMessage(chatId: string, content: string) {\n+    if (content === null || content === '') {\n+      throw new Error(`Cannot add empty or null messages.`);\n+    }\n+\n+    let chat = await this.chatProvider\n+      .createQueryBuilder()\n+      .whereInIds(chatId)\n+      .innerJoinAndSelect('chat.allTimeMembers', 'allTimeMembers')\n+      .innerJoinAndSelect('chat.listingMembers', 'listingMembers')\n+      .leftJoinAndSelect('chat.actualGroupMembers', 'actualGroupMembers')\n+      .getOne();\n+\n+    if (!chat) {\n+      throw new Error(`Cannot find chat ${chatId}.`);\n+    }\n+\n+    let holders: User[];\n+\n+    if (!chat.name) {\n+      // Chat\n+      if (!chat.listingMembers.map(user => user.id).includes(this.currentUser.id)) {\n+        throw new Error(`The chat ${chatId} must be listed for the current user in order to add a message.`);\n+      }\n+\n+      // Receiver's user\n+      const user = chat.allTimeMembers.find(user => user.id !== this.currentUser.id);\n+\n+      if (!user) {\n+        throw new Error(`Cannot find receiver's user.`);\n+      }\n+\n+      if (!chat.listingMembers.find(listingMember => listingMember.id === user.id)) {\n+        // Chat is not listed for the receiver user. Add him to the listingIds\n+        chat.listingMembers.push(user);\n+\n+        await this.chatProvider.repository.save(chat);\n+\n+        this.pubsub.publish('chatAdded', {\n+          creatorId: this.currentUser.id,\n+          chatAdded: chat,\n+        });\n+      }\n+\n+      holders = chat.listingMembers;\n+    } else {\n+      // Group\n+      if (!chat.actualGroupMembers || !chat.actualGroupMembers.find(user => user.id === this.currentUser.id)) {\n+        throw new Error(`The user is not a member of the group ${chatId}. Cannot add message.`);\n+      }\n+\n+      holders = chat.actualGroupMembers;\n+    }\n+\n+    const message = await this.repository.save(new Message({\n+      chat,\n+      sender: this.currentUser,\n+      content,\n+      type: MessageType.TEXT,\n+      holders,\n+    }));\n+\n+    this.pubsub.publish('messageAdded', {\n+      messageAdded: message,\n+    });\n+\n+    return message || null;\n+  }\n+\n+  async _removeMessages(\n+\n+    chatId: string,\n+    {\n+      messageIds,\n+      all,\n+    }: {\n+      messageIds?: string[]\n+      all?: boolean\n+    } = {},\n+  ) {\n+    const chat = await this.chatProvider\n+      .createQueryBuilder()\n+      .whereInIds(chatId)\n+      .innerJoinAndSelect('chat.listingMembers', 'listingMembers')\n+      .innerJoinAndSelect('chat.messages', 'messages')\n+      .innerJoinAndSelect('messages.holders', 'holders')\n+      .getOne();\n+\n+    if (!chat) {\n+      throw new Error(`Cannot find chat ${chatId}.`);\n+    }\n+\n+    if (!chat.listingMembers.find(user => user.id === this.currentUser.id)) {\n+      throw new Error(`The chat/group ${chatId} is not listed for the current user so there is nothing to delete.`);\n+    }\n+\n+    if (all && messageIds) {\n+      throw new Error(`Cannot specify both 'all' and 'messageIds'.`)\n+    }\n+\n+    if (!all && !(messageIds && messageIds.length)) {\n+      throw new Error(`'all' and 'messageIds' cannot be both null`)\n+    }\n+\n+    let deletedIds: string[] = [];\n+    let removedMessages: Message[] = [];\n+    // Instead of chaining map and filter we can loop once using reduce\n+    chat.messages = await chat.messages.reduce<Promise<Message[]>>(async (filtered$, message) => {\n+      const filtered = await filtered$;\n+\n+      if (all || messageIds!.includes(message.id)) {\n+        deletedIds.push(message.id);\n+        // Remove the current user from the message holders\n+        message.holders = message.holders.filter(user => user.id !== this.currentUser.id);\n+\n+      }\n+\n+      if (message.holders.length !== 0) {\n+        // Remove the current user from the message holders\n+        await this.repository.save(message);\n+        filtered.push(message);\n+      } else {\n+        // Message is flagged for removal\n+        removedMessages.push(message);\n+      }\n+\n+      return filtered;\n+    }, Promise.resolve([]));\n+\n+    return { deletedIds, removedMessages };\n+  }\n+\n+  async removeMessages(\n+\n+    chatId: string,\n+    {\n+      messageIds,\n+      all,\n+    }: {\n+      messageIds?: string[]\n+      all?: boolean\n+    } = {},\n+  ) {\n+    const { deletedIds, removedMessages } = await this._removeMessages(chatId, { messageIds, all });\n+\n+    for (let message of removedMessages) {\n+      await this.repository.remove(message);\n+    }\n+\n+    return deletedIds;\n+  }\n+\n+  async _removeChatGetMessages(chatId: string) {\n+    let messages = await this.createQueryBuilder()\n+      .innerJoin('message.chat', 'chat', 'chat.id = :chatId', { chatId })\n+      .leftJoinAndSelect('message.holders', 'holders')\n+      .getMany();\n+\n+    messages = messages.map(message => ({\n+      ...message,\n+      holders: message.holders.filter(user => user.id !== this.currentUser.id),\n+    }));\n+\n+    return messages;\n+  }\n+\n+  async removeChat(chatId: string, messages?: Message[]) {\n+    if (!messages) {\n+      messages = await this._removeChatGetMessages(chatId);\n+    }\n+\n+    for (let message of messages) {\n+      message.holders = message.holders.filter(user => user.id !== this.currentUser.id);\n+\n+      if (message.holders.length !== 0) {\n+        // Remove the current user from the message holders\n+        await this.repository.save(message);\n+      } else {\n+        // Simply remove the message\n+        await this.repository.remove(message);\n+      }\n+    }\n+\n+    return await this.chatProvider.removeChat(chatId);\n+  }\n+\n+  async getMessageSender(message: Message) {\n+    const sender = await this.userProvider\n+      .createQueryBuilder()\n+      .innerJoin('user.senderMessages', 'senderMessages', 'senderMessages.id = :messageId', {\n+        messageId: message.id,\n+      })\n+      .getOne()\n+\n+    if (!sender) {\n+      throw new Error(`Message must have a sender.`)\n+    }\n+\n+    return sender\n+  }\n+\n+  async getMessageOwnership(message: Message) {\n+    return !!(await this.userProvider\n+      .createQueryBuilder()\n+      .whereInIds(this.currentUser.id)\n+      .innerJoin('user.senderMessages', 'senderMessages', 'senderMessages.id = :messageId', {\n+        messageId: message.id,\n+      })\n+      .getCount())\n+  }\n+\n+  async getMessageHolders(message: Message) {\n+    return await this.userProvider\n+      .createQueryBuilder()\n+      .innerJoin('user.holderMessages', 'holderMessages', 'holderMessages.id = :messageId', {\n+        messageId: message.id,\n+      })\n+      .getMany()\n+  }\n+\n+  async getMessageChat(message: Message) {\n+    const chat = await this.chatProvider\n+      .createQueryBuilder()\n+      .innerJoin('chat.messages', 'messages', 'messages.id = :messageId', {\n+        messageId: message.id,\n+      })\n+      .getOne()\n+\n+    if (!chat) {\n+      throw new Error(`Message must have a chat.`)\n+    }\n+\n+    return chat\n+  }\n+\n+  async getChats() {\n+    const chats = await this.chatProvider\n+      .createQueryBuilder()\n+      .leftJoin('chat.listingMembers', 'listingMembers')\n+      .where('listingMembers.id = :id', { id: this.currentUser.id })\n+      .getMany()\n+\n+    for (let chat of chats) {\n+      chat.messages = await this.getChatMessages(chat)\n+    }\n+\n+    return chats.sort((chatA, chatB) => {\n+      const dateA = chatA.messages.length\n+        ? chatA.messages[chatA.messages.length - 1].createdAt\n+        : chatA.createdAt\n+      const dateB = chatB.messages.length\n+        ? chatB.messages[chatB.messages.length - 1].createdAt\n+        : chatB.createdAt\n+      return dateB.valueOf() - dateA.valueOf()\n+    })\n+  }\n+\n+  async getChatMessages(chat: Chat, amount?: number) {\n+    if (chat.messages) {\n+      return amount ? chat.messages.slice(-amount) : chat.messages\n+    }\n+\n+    let query = this.createQueryBuilder()\n+      .innerJoin('message.chat', 'chat', 'chat.id = :chatId', { chatId: chat.id })\n+      .innerJoin('message.holders', 'holders', 'holders.id = :userId', {\n+        userId: this.currentUser.id,\n+      })\n+      .orderBy({ 'message.createdAt': { order: 'DESC', nulls: 'NULLS LAST' } })\n+\n+    if (amount) {\n+      query = query.take(amount)\n+    }\n+\n+    return (await query.getMany()).reverse()\n+  }\n+\n+  async getChatLastMessage(chat: Chat) {\n+    if (chat.messages) {\n+      return chat.messages.length ? chat.messages[chat.messages.length - 1] : null\n+    }\n+\n+    const messages = await this.getChatMessages(chat, 1)\n+\n+    return messages && messages.length ? messages[0] : null\n+  }\n+\n+  async getChatUpdatedAt(chat: Chat) {\n+    if (chat.messages) {\n+      return chat.messages.length ? chat.messages[0].createdAt : null\n+    }\n+\n+    const latestMessage = await this.createQueryBuilder()\n+      .innerJoin('message.chat', 'chat', 'chat.id = :chatId', { chatId: chat.id })\n+      .innerJoin('message.holders', 'holders', 'holders.id = :userId', {\n+        userId: this.currentUser.id,\n+      })\n+      .orderBy({ 'message.createdAt': 'DESC' })\n+      .getOne()\n+\n+    return latestMessage ? latestMessage.createdAt : null\n+  }\n+\n+  async filterMessageAdded(messageAdded: Message) {\n+    let relevantUsers: User[]\n+\n+    if (!messageAdded.chat.name) {\n+      // Chat\n+      relevantUsers = (await this.userProvider\n+        .createQueryBuilder()\n+        .innerJoin(\n+          'user.listingMemberChats',\n+          'listingMemberChats',\n+          'listingMemberChats.id = :chatId',\n+          { chatId: messageAdded.chat.id }\n+        )\n+        .getMany()).filter(user => user.id != messageAdded.sender.id)\n+    } else {\n+      // Group\n+      relevantUsers = (await this.userProvider\n+        .createQueryBuilder()\n+        .innerJoin(\n+          'user.actualGroupMemberChats',\n+          'actualGroupMemberChats',\n+          'actualGroupMemberChats.id = :chatId',\n+          { chatId: messageAdded.chat.id }\n+        )\n+        .getMany()).filter(user => user.id != messageAdded.sender.id)\n+    }\n+\n+    return relevantUsers.some(user => user.id === this.currentUser.id)\n+  }\n+}\ndiff --git a/server/modules/message/resolvers/resolvers.ts b/server/modules/message/resolvers/resolvers.ts\nnew file mode 100644\nindex 0000000..7c1db53\n--- /dev/null\n+++ b/server/modules/message/resolvers/resolvers.ts\n@@ -0,0 +1,48 @@\n+import { ModuleContext } from '@graphql-modules/core'\n+import { PubSub, withFilter } from 'apollo-server-express'\n+import { Message } from '../../../entity/message'\n+import { IResolvers } from '../../../types'\n+import { MessageProvider } from '../providers/message.provider'\n+\n+export default {\n+  Query: {\n+    // The ordering depends on the messages\n+    chats: (obj, args, { injector }) => injector.get(MessageProvider).getChats(),\n+  },\n+  Mutation: {\n+    addMessage: async (obj, { chatId, content }, { injector }) =>\n+      injector.get(MessageProvider).addMessage(chatId, content),\n+    removeMessages: async (obj, { chatId, messageIds, all }, { injector }) =>\n+      injector.get(MessageProvider).removeMessages(chatId, {\n+        messageIds: messageIds || undefined,\n+        all: all || false,\n+      }),\n+    // We may need to also remove the messages\n+    removeChat: async (obj, { chatId }, { injector }) => injector.get(MessageProvider).removeChat(chatId),\n+  },\n+  Subscription: {\n+    messageAdded: {\n+      subscribe: withFilter((root, args, { injector }: ModuleContext) => injector.get(PubSub).asyncIterator('messageAdded'),\n+        (data: { messageAdded: Message }, variables, { injector }: ModuleContext) => data && injector.get(MessageProvider).filterMessageAdded(data.messageAdded)\n+      ),\n+    },\n+  },\n+  Chat: {\n+    messages: async (chat, { amount }, { injector }) =>\n+      injector.get(MessageProvider).getChatMessages(chat, amount || 0),\n+    lastMessage: async (chat, args, { injector }) =>\n+      injector.get(MessageProvider).getChatLastMessage(chat),\n+    updatedAt: async (chat, args, { injector }) =>\n+      injector.get(MessageProvider).getChatUpdatedAt(chat),\n+  },\n+  Message: {\n+    sender: async (message, args, { injector }) =>\n+      injector.get(MessageProvider).getMessageSender(message),\n+    ownership: async (message, args, { injector }) =>\n+      injector.get(MessageProvider).getMessageOwnership(message),\n+    holders: async (message, args, { injector }) =>\n+      injector.get(MessageProvider).getMessageHolders(message),\n+    chat: async (message, args, { injector }) =>\n+      injector.get(MessageProvider).getMessageChat(message),\n+  },\n+} as IResolvers\ndiff --git a/server/modules/message/schema/typeDefs.graphql b/server/modules/message/schema/typeDefs.graphql\nnew file mode 100644\nindex 0000000..a92d52d\n--- /dev/null\n+++ b/server/modules/message/schema/typeDefs.graphql\n@@ -0,0 +1,34 @@\n+type Subscription {\n+  messageAdded: Message\n+}\n+\n+enum MessageType {\n+  LOCATION\n+  TEXT\n+  PICTURE\n+}\n+\n+extend type Chat {\n+  messages(amount: Int): [Message]!\n+  lastMessage: Message\n+  updatedAt: Date!\n+}\n+\n+type Message {\n+  id: ID!\n+  sender: User!\n+  chat: Chat!\n+  content: String!\n+  createdAt: Date!\n+  #FIXME: should return MessageType\n+  type: Int!\n+  #Whoever still holds a copy of the message. Cannot be null because the message gets deleted otherwise\n+  holders: [User!]!\n+  #Computed property\n+  ownership: Boolean!\n+}\n+\n+type Mutation {\n+  addMessage(chatId: ID!, content: String!): Message\n+  removeMessages(chatId: ID!, messageIds: [ID!], all: Boolean): [ID]!\n+}\ndiff --git a/server/modules/recipient/index.ts b/server/modules/recipient/index.ts\nnew file mode 100644\nindex 0000000..7a562f8\n--- /dev/null\n+++ b/server/modules/recipient/index.ts\n@@ -0,0 +1,22 @@\n+import { GraphQLModule } from '@graphql-modules/core';\n+import { loadResolversFiles, loadSchemaFiles } from '@graphql-modules/sonar';\n+import { UserModule } from '../user';\n+import { MessageModule } from '../message';\n+import { ChatModule } from '../chat';\n+import { RecipientProvider } from './providers/recipient.provider';\n+import { AuthModule } from '../auth';\n+\n+export const RecipientModule = new GraphQLModule({\n+  name: 'Recipient',\n+  imports: [\n+    AuthModule,\n+    UserModule,\n+    ChatModule,\n+    MessageModule,\n+  ],\n+  providers: [\n+    RecipientProvider,\n+  ],\n+  typeDefs: loadSchemaFiles(__dirname + '/schema/'),\n+  resolvers: loadResolversFiles(__dirname + '/resolvers/'),\n+});\ndiff --git a/server/modules/recipient/providers/recipient.provider.ts b/server/modules/recipient/providers/recipient.provider.ts\nnew file mode 100644\nindex 0000000..9b13e20\n--- /dev/null\n+++ b/server/modules/recipient/providers/recipient.provider.ts\n@@ -0,0 +1,123 @@\n+import { Injectable, ProviderScope } from '@graphql-modules/di'\n+import { Connection } from 'typeorm'\n+import { MessageProvider } from '../../message/providers/message.provider'\n+import { Chat } from '../../../entity/chat'\n+import { Message } from '../../../entity/message'\n+import { Recipient } from '../../../entity/recipient'\n+import { AuthProvider } from '../../auth/providers/auth.provider'\n+\n+@Injectable({\n+  scope: ProviderScope.Session,\n+})\n+export class RecipientProvider {\n+  constructor(\n+    private authProvider: AuthProvider,\n+    private connection: Connection,\n+    private messageProvider: MessageProvider\n+  ) {}\n+\n+  public repository = this.connection.getRepository(Recipient)\n+  public currentUser = this.authProvider.currentUser\n+\n+  createQueryBuilder() {\n+    return this.connection.createQueryBuilder(Recipient, 'recipient')\n+  }\n+\n+  getChatUnreadMessagesCount(chat: Chat) {\n+    return this.messageProvider\n+      .createQueryBuilder()\n+      .innerJoin('message.chat', 'chat', 'chat.id = :chatId', { chatId: chat.id })\n+      .innerJoin(\n+        'message.recipients',\n+        'recipients',\n+        'recipients.user.id = :userId AND recipients.readAt IS NULL',\n+        {\n+          userId: this.currentUser.id,\n+        }\n+      )\n+      .getCount()\n+  }\n+\n+  getMessageRecipients(message: Message) {\n+    return this.createQueryBuilder()\n+      .innerJoinAndSelect('recipient.message', 'message', 'message.id = :messageId', {\n+        messageId: message.id,\n+      })\n+      .innerJoinAndSelect('recipient.user', 'user')\n+      .getMany()\n+  }\n+\n+  async getRecipientChat(recipient: Recipient) {\n+    if (recipient.message.chat) {\n+      return recipient.message.chat\n+    }\n+\n+    return this.messageProvider.getMessageChat(recipient.message)\n+  }\n+\n+  async removeChat(chatId: string) {\n+    const messages = await this.messageProvider._removeChatGetMessages(chatId)\n+\n+    for (let message of messages) {\n+      if (message.holders.length === 0) {\n+        const recipients = await this.createQueryBuilder()\n+          .innerJoinAndSelect('recipient.message', 'message', 'message.id = :messageId', {\n+            messageId: message.id,\n+          })\n+          .innerJoinAndSelect('recipient.user', 'user')\n+          .getMany()\n+\n+        for (let recipient of recipients) {\n+          await this.repository.remove(recipient)\n+        }\n+      }\n+    }\n+\n+    return await this.messageProvider.removeChat(chatId, messages)\n+  }\n+\n+  async addMessage(chatId: string, content: string) {\n+    const message = await this.messageProvider.addMessage(chatId, content)\n+\n+    for (let user of message.holders) {\n+      if (user.id !== this.currentUser.id) {\n+        await this.repository.save(new Recipient({ user, message }))\n+      }\n+    }\n+\n+    return message\n+  }\n+\n+  async removeMessages(\n+    chatId: string,\n+    {\n+      messageIds,\n+      all,\n+    }: {\n+      messageIds?: string[]\n+      all?: boolean\n+    } = {}\n+  ) {\n+    const { deletedIds, removedMessages } = await this.messageProvider._removeMessages(chatId, {\n+      messageIds,\n+      all,\n+    })\n+\n+    for (let message of removedMessages) {\n+      const recipients = await this.createQueryBuilder()\n+        .innerJoinAndSelect('recipient.message', 'message', 'message.id = :messageId', {\n+          messageId: message.id,\n+        })\n+        .innerJoinAndSelect('recipient.user', 'user')\n+        .getMany()\n+\n+      for (let recipient of recipients) {\n+        await this.repository.remove(recipient)\n+      }\n+\n+      await this.messageProvider.repository.remove(message)\n+    }\n+\n+    return deletedIds\n+  }\n+}\ndiff --git a/server/modules/recipient/resolvers/resolvers.ts b/server/modules/recipient/resolvers/resolvers.ts\nnew file mode 100644\nindex 0000000..adfc187\n--- /dev/null\n+++ b/server/modules/recipient/resolvers/resolvers.ts\n@@ -0,0 +1,35 @@\n+import { IResolvers } from '../../../types'\n+import { RecipientProvider } from '../providers/recipient.provider'\n+\n+export default {\n+  Mutation: {\n+    // TODO: implement me\n+    markAsReceived: async (obj, { chatId }) => false,\n+    // TODO: implement me\n+    markAsRead: async (obj, { chatId }) => false,\n+    // We may also need to remove the recipients\n+    removeChat: async (obj, { chatId }, { injector }) =>\n+      injector.get(RecipientProvider).removeChat(chatId),\n+    // We also need to create the recipients\n+    addMessage: async (obj, { chatId, content }, { injector }) =>\n+      injector.get(RecipientProvider).addMessage(chatId, content),\n+    // We may also need to remove the recipients\n+    removeMessages: async (obj, { chatId, messageIds, all }, { injector }) =>\n+      injector.get(RecipientProvider).removeMessages(chatId, {\n+        messageIds: messageIds || undefined,\n+        all: all || false,\n+      }),\n+  },\n+  Chat: {\n+    unreadMessages: async (chat, args, { injector }) =>\n+      injector.get(RecipientProvider).getChatUnreadMessagesCount(chat),\n+  },\n+  Message: {\n+    recipients: async (message, args, { injector }) =>\n+      injector.get(RecipientProvider).getMessageRecipients(message),\n+  },\n+  Recipient: {\n+    chat: async (recipient, args, { injector }) =>\n+      injector.get(RecipientProvider).getRecipientChat(recipient),\n+  },\n+} as IResolvers\ndiff --git a/server/modules/recipient/schema/typeDefs.graphql b/server/modules/recipient/schema/typeDefs.graphql\nnew file mode 100644\nindex 0000000..ef4638d\n--- /dev/null\n+++ b/server/modules/recipient/schema/typeDefs.graphql\n@@ -0,0 +1,22 @@\n+extend type Chat {\n+  #Computed property\n+  unreadMessages: Int!\n+}\n+\n+extend type Message {\n+  #Whoever received the message\n+  recipients: [Recipient!]!\n+}\n+\n+type Recipient {\n+  user: User!\n+  message: Message!\n+  chat: Chat!\n+  receivedAt: Date\n+  readAt: Date\n+}\n+\n+type Mutation {\n+  markAsReceived(chatId: ID!): Boolean\n+  markAsRead(chatId: ID!): Boolean\n+}\ndiff --git a/server/modules/user/index.ts b/server/modules/user/index.ts\nnew file mode 100644\nindex 0000000..fece9e2\n--- /dev/null\n+++ b/server/modules/user/index.ts\n@@ -0,0 +1,43 @@\n+/// <reference path=\"../../cloudinary.d.ts\" />\n+import { GraphQLModule } from '@graphql-modules/core'\n+import { InjectFunction, ProviderScope } from '@graphql-modules/di'\n+import { loadResolversFiles, loadSchemaFiles } from '@graphql-modules/sonar'\n+import { Express } from 'express'\n+import multer from 'multer'\n+import tmp from 'tmp'\n+import cloudinary from 'cloudinary'\n+import { APP } from '../app.symbols'\n+import { AuthModule } from '../auth'\n+import { UserProvider } from './providers/user.provider'\n+\n+const CLOUDINARY_URL = process.env.CLOUDINARY_URL || ''\n+\n+export const UserModule = new GraphQLModule({\n+  name: 'User',\n+  imports: [AuthModule],\n+  providers: [UserProvider],\n+  typeDefs: loadSchemaFiles(__dirname + '/schema/'),\n+  resolvers: loadResolversFiles(__dirname + '/resolvers/'),\n+  defaultProviderScope: ProviderScope.Session,\n+  middleware: InjectFunction(UserProvider, APP)((userProvider, app: Express) => {\n+    const match = CLOUDINARY_URL.match(/cloudinary:\\/\\/(\\d+):(\\w+)@(\\.+)/)\n+\n+    if (match) {\n+      const [api_key, api_secret, cloud_name] = match.slice(1)\n+      cloudinary.config({ api_key, api_secret, cloud_name })\n+    }\n+\n+    const upload = multer({\n+      dest: tmp.dirSync({ unsafeCleanup: true }).name,\n+    })\n+\n+    app.post('/upload-profile-pic', upload.single('file'), async (req: any, res, done) => {\n+      try {\n+        res.json(await userProvider.uploadProfilePic(req.file.path))\n+      } catch (e) {\n+        done(e)\n+      }\n+    })\n+    return {}\n+  }),\n+})\ndiff --git a/server/modules/user/providers/user.provider.ts b/server/modules/user/providers/user.provider.ts\nnew file mode 100644\nindex 0000000..bdda1ed\n--- /dev/null\n+++ b/server/modules/user/providers/user.provider.ts\n@@ -0,0 +1,71 @@\n+import { Injectable, ProviderScope } from '@graphql-modules/di'\n+import { PubSub } from 'apollo-server-express'\n+import cloudinary from 'cloudinary'\n+import { Connection } from 'typeorm'\n+import { User } from '../../../entity/user'\n+import { AuthProvider } from '../../auth/providers/auth.provider'\n+\n+@Injectable()\n+export class UserProvider {\n+  constructor(\n+    private pubsub: PubSub,\n+    private connection: Connection,\n+    private authProvider: AuthProvider,\n+  ) {}\n+\n+  public repository = this.connection.getRepository(User)\n+  private currentUser = this.authProvider.currentUser\n+\n+  createQueryBuilder() {\n+    return this.connection.createQueryBuilder(User, 'user')\n+  }\n+\n+  getMe() {\n+    return this.currentUser\n+  }\n+\n+  getUsers() {\n+    return this.createQueryBuilder()\n+      .where('user.id != :id', { id: this.currentUser.id })\n+      .getMany()\n+  }\n+\n+  async updateUser({\n+    name,\n+    picture,\n+  }: {\n+    name?: string,\n+    picture?: string,\n+  } = {}) {\n+    if (name === this.currentUser.name && picture === this.currentUser.picture) {\n+      return this.currentUser;\n+    }\n+\n+    this.currentUser.name = name || this.currentUser.name;\n+    this.currentUser.picture = picture || this.currentUser.picture;\n+\n+    await this.repository.save(this.currentUser);\n+\n+    this.pubsub.publish('userUpdated', {\n+      userUpdated: this.currentUser,\n+    });\n+\n+    return this.currentUser;\n+  }\n+\n+  filterUserAddedOrUpdated(userAddedOrUpdated: User) {\n+    return userAddedOrUpdated.id !== this.currentUser.id;\n+  }\n+\n+  uploadProfilePic(filePath: string) {\n+    return new Promise((resolve, reject) => {\n+      cloudinary.v2.uploader.upload(filePath, (error, result) => {\n+        if (error) {\n+          reject(error)\n+        } else {\n+          resolve(result)\n+        }\n+      })\n+    })\n+  }\n+}\ndiff --git a/server/modules/user/resolvers/resolvers.ts b/server/modules/user/resolvers/resolvers.ts\nnew file mode 100644\nindex 0000000..871a641\n--- /dev/null\n+++ b/server/modules/user/resolvers/resolvers.ts\n@@ -0,0 +1,32 @@\n+import { ModuleContext } from '@graphql-modules/core'\n+import { PubSub, withFilter } from 'apollo-server-express'\n+import { User } from '../../../entity/User'\n+import { IResolvers } from '../../../types'\n+import { UserProvider } from '../providers/user.provider'\n+\n+export default {\n+  Query: {\n+    me: (obj, args, { injector }) => injector.get(UserProvider).getMe(),\n+    users: (obj, args, { injector }) => injector.get(UserProvider).getUsers(),\n+  },\n+  Mutation: {\n+    updateUser: (obj, { name, picture }, { injector }) => injector.get(UserProvider).updateUser({\n+      name: name || '',\n+      picture: picture || '',\n+    }),\n+  },\n+  Subscription: {\n+    userAdded: {\n+      subscribe: withFilter(\n+        (root, args, { injector }: ModuleContext) => injector.get(PubSub).asyncIterator('userAdded'),\n+        (data: { userAdded: User }, variables, { injector }: ModuleContext) => data && injector.get(UserProvider).filterUserAddedOrUpdated(data.userAdded),\n+      ),\n+    },\n+    userUpdated: {\n+      subscribe: withFilter(\n+        (root, args, { injector }: ModuleContext) => injector.get(PubSub).asyncIterator('userAdded'),\n+        (data: { userUpdated: User }, variables, { injector }: ModuleContext) => data && injector.get(UserProvider).filterUserAddedOrUpdated(data.userUpdated)\n+      ),\n+    },\n+  },\n+} as IResolvers\ndiff --git a/server/modules/user/schema/typeDefs.graphql b/server/modules/user/schema/typeDefs.graphql\nnew file mode 100644\nindex 0000000..d9abfa5\n--- /dev/null\n+++ b/server/modules/user/schema/typeDefs.graphql\n@@ -0,0 +1,20 @@\n+type Query {\n+  me: User\n+  users: [User!]\n+}\n+\n+type Mutation {\n+  updateUser(name: String, picture: String): User!\n+}\n+\n+type Subscription {\n+  userAdded: User\n+  userUpdated: User\n+}\n+\n+type User {\n+  id: ID!\n+  name: String\n+  picture: String\n+  phone: String\n+}\ndiff --git a/server/modules/utils.module.ts b/server/modules/utils.module.ts\nnew file mode 100644\nindex 0000000..9243d15\n--- /dev/null\n+++ b/server/modules/utils.module.ts\n@@ -0,0 +1,12 @@\n+import { GraphQLModule } from '@graphql-modules/core'\n+import { GraphQLDateTime } from 'graphql-iso-date'\n+\n+export const UtilsModule = new GraphQLModule({\n+  name: 'Utils',\n+  typeDefs: `\n+    scalar Date\n+  `,\n+  resolvers: {\n+    Date: GraphQLDateTime,\n+  },\n+})\ndiff --git a/server/ormconfig.json b/server/ormconfig.json\nnew file mode 100644\nindex 0000000..276a346\n--- /dev/null\n+++ b/server/ormconfig.json\n@@ -0,0 +1,24 @@\n+{\n+   \"type\": \"postgres\",\n+   \"host\": \"localhost\",\n+   \"port\": 5432,\n+   \"username\": \"test\",\n+   \"password\": \"test\",\n+   \"database\": \"whatsapp\",\n+   \"synchronize\": true,\n+   \"logging\": false,\n+   \"entities\": [\n+      \"entity/**/*.ts\"\n+   ],\n+   \"migrations\": [\n+      \"migration/**/*.ts\"\n+   ],\n+   \"subscribers\": [\n+      \"subscriber/**/*.ts\"\n+   ],\n+   \"cli\": {\n+      \"entitiesDir\": \"entity\",\n+      \"migrationsDir\": \"migration\",\n+      \"subscribersDir\": \"subscriber\"\n+   }\n+}\ndiff --git a/server/package.json b/server/package.json\nnew file mode 100644\nindex 0000000..a0b9695\n--- /dev/null\n+++ b/server/package.json\n@@ -0,0 +1,60 @@\n+{\n+  \"name\": \"whatsapp-clone-server\",\n+  \"private\": true,\n+  \"repository\": {\n+    \"type\": \"git\",\n+    \"url\": \"https://Urigo@github.com/Urigo/WhatsApp-Clone-Server.git\"\n+  },\n+  \"scripts\": {\n+    \"generate\": \"gql-gen\",\n+    \"generate:watch\": \"nodemon --exec yarn generate -e graphql\",\n+    \"start:server\": \"ts-node index.ts\",\n+    \"start:server:watch\": \"nodemon --exec yarn start:server -e ts\",\n+    \"dev\": \"concurrently \\\"yarn generate:watch\\\" \\\"yarn start:server:watch\\\"\",\n+    \"start\": \"yarn generate && yarn start:server\"\n+  },\n+  \"devDependencies\": {\n+    \"@types/bcrypt-nodejs\": \"0.0.30\",\n+    \"@types/body-parser\": \"1.17.0\",\n+    \"@types/cors\": \"2.8.4\",\n+    \"@types/express\": \"4.16.1\",\n+    \"@types/graphql\": \"14.0.7\",\n+    \"@types/graphql-iso-date\": \"3.3.1\",\n+    \"@types/multer\": \"1.3.7\",\n+    \"@types/node\": \"11.11.3\",\n+    \"@types/passport\": \"1.0.0\",\n+    \"@types/passport-http\": \"0.3.7\",\n+    \"@types/pg\": \"7.4.13\",\n+    \"@types/tmp\": \"0.0.34\",\n+    \"concurrently\": \"4.1.0\",\n+    \"graphql-code-generator\": \"0.18.0\",\n+    \"graphql-codegen-typescript-common\": \"0.18.0\",\n+    \"graphql-codegen-typescript-resolvers\": \"0.18.0\",\n+    \"nodemon\": \"1.18.10\",\n+    \"ts-node\": \"8.0.3\",\n+    \"typescript\": \"3.3.3333\"\n+  },\n+  \"dependencies\": {\n+    \"@graphql-modules/core\": \"0.4.2\",\n+    \"@graphql-modules/di\": \"0.4.2\",\n+    \"@graphql-modules/sonar\": \"0.4.0\",\n+    \"apollo-server-express\": \"2.4.8\",\n+    \"bcrypt-nodejs\": \"0.0.3\",\n+    \"body-parser\": \"1.18.3\",\n+    \"cloudinary\": \"1.13.2\",\n+    \"core-js\": \"3.0.0-beta.16\",\n+    \"cors\": \"2.8.5\",\n+    \"dotenv\": \"6.2.0\",\n+    \"express\": \"4.16.4\",\n+    \"graphql\": \"14.1.1\",\n+    \"graphql-iso-date\": \"3.6.1\",\n+    \"moment\": \"2.24.0\",\n+    \"multer\": \"1.4.1\",\n+    \"passport\": \"0.4.0\",\n+    \"passport-http\": \"0.3.0\",\n+    \"pg\": \"7.8.2\",\n+    \"reflect-metadata\": \"0.1.13\",\n+    \"tmp\": \"0.0.33\",\n+    \"typeorm\": \"0.2.14\"\n+  }\n+}\n\\ No newline at end of file\ndiff --git a/server/renovate.json b/server/renovate.json\nnew file mode 100644\nindex 0000000..6900905\n--- /dev/null\n+++ b/server/renovate.json\n@@ -0,0 +1,8 @@\n+{\n+  \"extends\": [\n+    \"config:base\",\n+    \":automergeMajor\"\n+  ],\n+  \"prHourlyLimit\": 60,\n+  \"recreateClosed\": true\n+}\ndiff --git a/server/schema.ts b/server/schema.ts\nnew file mode 100644\nindex 0000000..794ab98\n--- /dev/null\n+++ b/server/schema.ts\n@@ -0,0 +1,4 @@\n+import 'reflect-metadata'\n+import { AppModule } from './modules/app.module'\n+\n+export default AppModule.forRoot({} as any).typeDefs\ndiff --git a/server/tsconfig.json b/server/tsconfig.json\nnew file mode 100644\nindex 0000000..0a6e32f\n--- /dev/null\n+++ b/server/tsconfig.json\n@@ -0,0 +1,64 @@\n+{\n+  \"compilerOptions\": {\n+    /* Basic Options */\n+    \"target\": \"es2018\",                       /* Specify ECMAScript target version: 'ES3' (default), 'ES5', 'ES2015', 'ES2016', 'ES2017','ES2018' or 'ESNEXT'. */\n+    \"module\": \"commonjs\",                     /* Specify module code generation: 'none', 'commonjs', 'amd', 'system', 'umd', 'es2015', or 'ESNext'. */\n+    \"lib\": [                                  /* Specify library files to be included in the compilation. */\n+      \"es2018\",\n+      \"esnext.asynciterable\"\n+    ],\n+    // \"allowJs\": true,                       /* Allow javascript files to be compiled. */\n+    // \"checkJs\": true,                       /* Report errors in .js files. */\n+    // \"jsx\": \"preserve\",                     /* Specify JSX code generation: 'preserve', 'react-native', or 'react'. */\n+    // \"declaration\": true,                   /* Generates corresponding '.d.ts' file. */\n+    // \"declarationMap\": true,                /* Generates a sourcemap for each corresponding '.d.ts' file. */\n+    // \"sourceMap\": true,                     /* Generates corresponding '.map' file. */\n+    // \"outFile\": \"./\",                       /* Concatenate and emit output to single file. */\n+    // \"outDir\": \"./\",                        /* Redirect output structure to the directory. */\n+    // \"rootDir\": \"./\",                       /* Specify the root directory of input files. Use to control the output directory structure with --outDir. */\n+    // \"composite\": true,                     /* Enable project compilation */\n+    // \"removeComments\": true,                /* Do not emit comments to output. */\n+    // \"noEmit\": true,                        /* Do not emit outputs. */\n+    // \"importHelpers\": true,                 /* Import emit helpers from 'tslib'. */\n+    // \"downlevelIteration\": true,            /* Provide full support for iterables in 'for-of', spread, and destructuring when targeting 'ES5' or 'ES3'. */\n+    // \"isolatedModules\": true,               /* Transpile each file as a separate module (similar to 'ts.transpileModule'). */\n+\n+    /* Strict Type-Checking Options */\n+    \"strict\": true,                           /* Enable all strict type-checking options. */\n+    // \"noImplicitAny\": true,                 /* Raise error on expressions and declarations with an implied 'any' type. */\n+    // \"strictNullChecks\": true,              /* Enable strict null checks. */\n+    // See https://github.com/DefinitelyTyped/DefinitelyTyped/issues/21359\n+    \"strictFunctionTypes\": false,             /* Enable strict checking of function types. */\n+    // \"strictBindCallApply\": true,           /* Enable strict 'bind', 'call', and 'apply' methods on functions. */\n+    \"strictPropertyInitialization\": false,    /* Enable strict checking of property initialization in classes. */\n+    // \"noImplicitThis\": true,                /* Raise error on 'this' expressions with an implied 'any' type. */\n+    // \"alwaysStrict\": true,                  /* Parse in strict mode and emit \"use strict\" for each source file. */\n+\n+    /* Additional Checks */\n+    // \"noUnusedLocals\": true,                /* Report errors on unused locals. */\n+    // \"noUnusedParameters\": true,            /* Report errors on unused parameters. */\n+    // \"noImplicitReturns\": true,             /* Report error when not all code paths in function return a value. */\n+    // \"noFallthroughCasesInSwitch\": true,    /* Report errors for fallthrough cases in switch statement. */\n+\n+    /* Module Resolution Options */\n+    // \"moduleResolution\": \"node\",            /* Specify module resolution strategy: 'node' (Node.js) or 'classic' (TypeScript pre-1.6). */\n+    // \"baseUrl\": \"./\",                       /* Base directory to resolve non-absolute module names. */\n+    // \"paths\": {},                           /* A series of entries which re-map imports to lookup locations relative to the 'baseUrl'. */\n+    // \"rootDirs\": [],                        /* List of root folders whose combined content represents the structure of the project at runtime. */\n+    // \"typeRoots\": [],                       /* List of folders to include type definitions from. */\n+    // \"types\": [],                           /* Type declaration files to be included in compilation. */\n+    // \"allowSyntheticDefaultImports\": true,  /* Allow default imports from modules with no default export. This does not affect code emit, just typechecking. */\n+    \"esModuleInterop\": true,                  /* Enables emit interoperability between CommonJS and ES Modules via creation of namespace objects for all imports. Implies 'allowSyntheticDefaultImports'. */\n+    // \"preserveSymlinks\": true,              /* Do not resolve the real path of symlinks. */\n+\n+    /* Source Map Options */\n+    // \"sourceRoot\": \"\",                      /* Specify the location where debugger should locate TypeScript files instead of source locations. */\n+    // \"mapRoot\": \"\",                         /* Specify the location where debugger should locate map files instead of generated locations. */\n+    // \"inlineSourceMap\": true,               /* Emit a single file with source maps instead of having a separate file. */\n+    // \"inlineSources\": true,                 /* Emit the source alongside the sourcemaps within a single file; requires '--inlineSourceMap' or '--sourceMap' to be set. */\n+\n+    /* Experimental Options */\n+    \"experimentalDecorators\": true,           /* Enables experimental support for ES7 decorators. */\n+    \"emitDecoratorMetadata\": true             /* Enables experimental support for emitting type metadata for decorators. */\n+  }\n+}\n",
        "manuals": [
          {
            "manualTitle": "WhatsApp Clone Tutorial",
            "stepRevision": "dd15479cdd433e0200d899f7be1af2382af4bb4d",
            "manualView": "<p align=\"center\"><img src=\"https://cdn-images-1.medium.com/max/1600/1*cSBu9zeo8fSnf1Cc-UeR_g.jpeg\" width=\"640\"></p>\n\nYou might have seen it around alreadyâ€Š-â€Šan open-source WhatsApp Clone tutorial; a project which was originally started in 2015 by [Uri Goldshtein](https://github.com/urigo) based on Angular-Meteor and Ionic, and have been throughout different incarnations ever since.\n\nThis time around, I'm happy to announce that a new version of the WhatsApp Clone is coming, and it's based on React 16.7 (Hooks & Suspense), Styled-Components, Material-UI, TypeScript, GraphQL-Subscriptions/Codegen/Modules, PostgreSQL and TypeORM.\n\nThe step-by-step implementations of the server and client can be found here:\n\n- Server - [urigo/whatsapp-clone-server](https://github.com/urigo/whatsapp-clone-server)\n\n- Client - [urigo/whatsapp-clone-client](https://github.com/urigo/whatsapp-clone-client-react)\n\n<p align=\"center\"><img src=\"https://cdn-images-1.medium.com/max/1040/1*fFUJd7moWtjvMZ5dE-A80g.gif\" alt=\"whatsapp\" width=\"240\"></p>\n\n### Why is it so good?\n\nThis app was built with all the latest and hottest technologies out there. The purpose is simpleâ€Š-â€Šit should be a guideline for building a proper app, thus we thought very carefully regards the design patterns and architecture used in it, plus, we made sure to cover all communication methods with the GraphQL-back-end in different variations (query, mutation, subscription). This way whenever you're looking to start a new app, maintain an existing one or upgrade your dev-stack, the WhatsApp-clone can be a great source to start with! It's full stack and has a complete flow.\n\n### Why did we choose this dev-stack?\n\nReact, GraphQL, PostgreSQL and TypeScript for obvious reasonsâ€Š-â€Šthey are backed by a strong ecosystem. These technologies can be used in endless variations, and there's no one way which is the most right of doing so, but we chose a way that makes the most sense for us and that we truly believe in when it comes to building apps. We've connected all 4 with TypeORM, GraphQL-Codegen, GraphQL-Modules for the following reasons:\n\n- The GraphQL back-end was implemented with GraphQL-Modules where logic was splitted into modules based on entity types. GraphQL-Modules is an amazing library which provides you with the ability to manage and maintain your GraphQL schema correctly. Not once nor twice I have seen people who struggle with that and get tangled upon their own creation, and with GraphQL-Modules where you have a very defined structure, this problem can be easily solved.\n\n- Every GraphQL/TypeScript definition were automatically generated with GraphQL-Codegen using a single command call. There's no need to maintain the same thing twice if it already exists in one way or another. This way you don't have to write TypeScript type definitions for your GraphQL documents (queries, mutations and subscriptions), GraphQL resolvers and GraphQL types.\n\n- The new version of React 16.7 was used with Hooks and Suspense and 100% of the project is made out of function components. The front-end communicates with the back-end using only hooks and there was no use in GraphQL-React components, which makes async tasks look a lot more readable with no extra indentations.\n\n- We used TypeORM to correctly split the logic of the entities in the database and define the relationships between them. Without a tool such as TypeORM, communication against the DB tends to get messy and confusion since there's no single module per entity which holds all its related logic.\n\n### What to expect?\n\n- Basic authentication.\n\n- Image uploading with [Cloudinary](https://cloudinary.com/).\n\n- Live updates with GraphQL subscriptions.\n\n- 100% function components with React Hooks.\n\n- GraphQL communication with [react-apollo-hooks](https://github.com/trojanowski/react-apollo-hooks).\n\nThis app be extremely useful for those who have little to no background in one of the technologies in our dev-stack."
          },
          {
            "manualTitle": "Step 1: Creating a React App with Apollo Server",
            "stepRevision": "a35a28b40001a7a7966316ec66c0371fe884ba8c",
            "manualView": "To create a new React app we're simply gonna use [`create-react-app`](https://github.com/facebook/create-react-app). It comes with a built-in TypeScript support which is exactly what we need. First, install the CLI if you haven't already:\n\n    $ yarn global add create-react-app\n\nAnd then create the app itself:\n\n    $ create-react-app whatsapp-clone-client\n\nBy default, `create-react-app` will create a JavaScript project. In order to use TypeScript, we will rename our app files to have the right extension `.tsx` (TypeScript + JSX):\n\n    src$ mv App.js App.tsx\n    src$ mv index.js index.tsx\n\nAnd then we will add a couple of configuration files that will basically set the building and linting rules for the TypeScript compiler:\n\n[{]: <helper> (diffStep 1.1 files=\"tsconfig.json, tslint.json\" module=\"client\")\n\n#### [Step 1.1: Setup TypeScript](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/614a414)\n\n##### Added tsconfig.json\n```diff\n@@ -0,0 +1,35 @@\n+â”Š  â”Š 1â”Š{\n+â”Š  â”Š 2â”Š  \"compilerOptions\": {\n+â”Š  â”Š 3â”Š    \"outDir\": \"build/dist\",\n+â”Š  â”Š 4â”Š    \"sourceMap\": true,\n+â”Š  â”Š 5â”Š    \"declaration\": false,\n+â”Š  â”Š 6â”Š    \"moduleResolution\": \"node\",\n+â”Š  â”Š 7â”Š    \"emitDecoratorMetadata\": true,\n+â”Š  â”Š 8â”Š    \"experimentalDecorators\": true,\n+â”Š  â”Š 9â”Š    \"downlevelIteration\": true,\n+â”Š  â”Š10â”Š    \"resolveJsonModule\": true,\n+â”Š  â”Š11â”Š    \"target\": \"es5\",\n+â”Š  â”Š12â”Š    \"jsx\": \"preserve\",\n+â”Š  â”Š13â”Š    \"typeRoots\": [\n+â”Š  â”Š14â”Š      \"node_modules/@types\"\n+â”Š  â”Š15â”Š    ],\n+â”Š  â”Š16â”Š    \"lib\": [\n+â”Š  â”Š17â”Š      \"es2017\",\n+â”Š  â”Š18â”Š      \"dom\",\n+â”Š  â”Š19â”Š      \"esnext.asynciterable\"\n+â”Š  â”Š20â”Š    ],\n+â”Š  â”Š21â”Š    \"allowJs\": true,\n+â”Š  â”Š22â”Š    \"skipLibCheck\": true,\n+â”Š  â”Š23â”Š    \"esModuleInterop\": false,\n+â”Š  â”Š24â”Š    \"allowSyntheticDefaultImports\": true,\n+â”Š  â”Š25â”Š    \"forceConsistentCasingInFileNames\": true,\n+â”Š  â”Š26â”Š    \"isolatedModules\": true,\n+â”Š  â”Š27â”Š    \"noEmit\": true,\n+â”Š  â”Š28â”Š    \"noImplicitAny\": false,\n+â”Š  â”Š29â”Š    \"strict\": false,\n+â”Š  â”Š30â”Š    \"module\": \"esnext\"\n+â”Š  â”Š31â”Š  },\n+â”Š  â”Š32â”Š  \"include\": [\n+â”Š  â”Š33â”Š    \"src\"\n+â”Š  â”Š34â”Š  ]\n+â”Š  â”Š35â”Š}\n```\n\n##### Added tslint.json\n```diff\n@@ -0,0 +1,29 @@\n+â”Š  â”Š 1â”Š{\n+â”Š  â”Š 2â”Š  \"extends\": [\"tslint:recommended\", \"tslint-react\", \"tslint-config-prettier\"],\n+â”Š  â”Š 3â”Š  \"rules\": {\n+â”Š  â”Š 4â”Š    \"ordered-imports\": false,\n+â”Š  â”Š 5â”Š    \"object-literal-sort-keys\": false,\n+â”Š  â”Š 6â”Š    \"jsx-boolean-value\": false,\n+â”Š  â”Š 7â”Š    \"interface-name\" : false,\n+â”Š  â”Š 8â”Š    \"variable-name\": false,\n+â”Š  â”Š 9â”Š    \"no-string-literal\": false,\n+â”Š  â”Š10â”Š    \"no-namespace\": false,\n+â”Š  â”Š11â”Š    \"interface-over-type-literal\": false,\n+â”Š  â”Š12â”Š    \"no-shadowed-variable\": false,\n+â”Š  â”Š13â”Š    \"curly\": false,\n+â”Š  â”Š14â”Š    \"no-label\": false,\n+â”Š  â”Š15â”Š    \"no-empty\": false,\n+â”Š  â”Š16â”Š    \"no-debugger\": false,\n+â”Š  â”Š17â”Š    \"no-console\": false,\n+â”Š  â”Š18â”Š    \"array-type\": false\n+â”Š  â”Š19â”Š  },\n+â”Š  â”Š20â”Š  \"linterOptions\": {\n+â”Š  â”Š21â”Š    \"exclude\": [\n+â”Š  â”Š22â”Š      \"config/**/*.js\",\n+â”Š  â”Š23â”Š      \"node_modules/**/*.ts\",\n+â”Š  â”Š24â”Š      \"coverage/lcov-report/*.js\",\n+â”Š  â”Š25â”Š      \"*.json\",\n+â”Š  â”Š26â”Š      \"**/*.json\"\n+â”Š  â”Š27â”Š    ]\n+â”Š  â”Š28â”Š  }\n+â”Š  â”Š29â”Š}\n```\n\n[}]: #\n\nOnce we will run the app for the first time, `react-scripts` (`create-react-app` utility scripts package) should automatically initialize some additional TypeScript related files.\n\n    $ yarn start\n\nSince in our app we'll be using the new React [hooks](https://reactjs.org/docs/hooks-intro.html) and [Suspense](https://reactjs.org/docs/react-api.html#reactsuspense) mechanisms, we will upgrade React's version to version `16.8`:\n\n    $ yarn upgrade react@16.8.1 react-dom@16.8.1\n\nThe plan is to make our app talk with a [GraphQL](https://graphql.org/) back-end, so we'll be using [Apollo](https://www.apollographql.com/) to setup a client which is actually capable of such.\n\nFirst we will install all the necessary packages:\n\n    $ yarn add apollo-cache-inmemory@1.4.3 apollo-client@2.4.13 apollo-link@1.2.8 apollo-link-http@1.5.11 apollo-link-ws@1.0.14 apollo-utilities@1.1.3 graphql@14.1.1 react-apollo-hooks@4.0.0 subscriptions-transport-ws@0.9.15\n    $ yarn add -D @types/graphql@14.0.7 @types/node@11.9.4\n\nThen we will set the server's connection URL under the `.env` file which is basically used to define constants for our application. The constants can be addressed using `process.env[CONSTANT_NAME]`. The identifier should be replaced automatically by `react-scripts` with the stored value, just like macros:\n\n[{]: <helper> (diffStep 1.3 files=\".env\" module=\"client\")\n\n#### [Step 1.3: Setup Apollo-client](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/9d7fe0f)\n\n##### Added .env\n```diff\n@@ -0,0 +1 @@\n+â”Š â”Š1â”ŠREACT_APP_SERVER_URL=http://localhost:4000\n```\n\n[}]: #\n\nAnd finally we can write our Apollo-GraphQL client module and connect it to our application:\n\n[{]: <helper> (diffStep 1.3 files=\"src/apollo-client.ts, src/index.tsx\" module=\"client\")\n\n#### [Step 1.3: Setup Apollo-client](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/9d7fe0f)\n\n##### Added src&#x2F;apollo-client.ts\n```diff\n@@ -0,0 +1,38 @@\n+â”Š  â”Š 1â”Šimport { InMemoryCache } from 'apollo-cache-inmemory'\n+â”Š  â”Š 2â”Šimport { ApolloClient } from 'apollo-client'\n+â”Š  â”Š 3â”Šimport { ApolloLink, split } from 'apollo-link'\n+â”Š  â”Š 4â”Šimport { HttpLink } from 'apollo-link-http'\n+â”Š  â”Š 5â”Šimport { WebSocketLink } from 'apollo-link-ws'\n+â”Š  â”Š 6â”Šimport { getMainDefinition } from 'apollo-utilities'\n+â”Š  â”Š 7â”Šimport { OperationDefinitionNode } from 'graphql'\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Šconst httpUri = process.env.REACT_APP_SERVER_URL + '/graphql'\n+â”Š  â”Š10â”Šconst wsUri = httpUri.replace(/^https?/, 'ws')\n+â”Š  â”Š11â”Š\n+â”Š  â”Š12â”Šconst httpLink = new HttpLink({\n+â”Š  â”Š13â”Š  uri: httpUri,\n+â”Š  â”Š14â”Š})\n+â”Š  â”Š15â”Š\n+â”Š  â”Š16â”Šconst wsLink = new WebSocketLink({\n+â”Š  â”Š17â”Š  uri: wsUri,\n+â”Š  â”Š18â”Š  options: {\n+â”Š  â”Š19â”Š    reconnect: true,\n+â”Š  â”Š20â”Š  },\n+â”Š  â”Š21â”Š})\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Šconst terminatingLink = split(\n+â”Š  â”Š24â”Š  ({ query }) => {\n+â”Š  â”Š25â”Š    const { kind, operation } = getMainDefinition(query) as OperationDefinitionNode\n+â”Š  â”Š26â”Š    return kind === 'OperationDefinition' && operation === 'subscription'\n+â”Š  â”Š27â”Š  },\n+â”Š  â”Š28â”Š  wsLink,\n+â”Š  â”Š29â”Š  httpLink,\n+â”Š  â”Š30â”Š)\n+â”Š  â”Š31â”Š\n+â”Š  â”Š32â”Šconst link = ApolloLink.from([terminatingLink])\n+â”Š  â”Š33â”Šconst cache = new InMemoryCache()\n+â”Š  â”Š34â”Š\n+â”Š  â”Š35â”Šexport default new ApolloClient({\n+â”Š  â”Š36â”Š  link,\n+â”Š  â”Š37â”Š  cache,\n+â”Š  â”Š38â”Š})\n```\n\n##### Changed src&#x2F;index.tsx\n```diff\n@@ -1,10 +1,16 @@\n â”Š 1â”Š 1â”Šimport React from 'react';\n â”Š 2â”Š 2â”Šimport ReactDOM from 'react-dom';\n+â”Š  â”Š 3â”Šimport { ApolloProvider } from 'react-apollo-hooks';\n â”Š 3â”Š 4â”Šimport './index.css';\n â”Š 4â”Š 5â”Šimport App from './App';\n+â”Š  â”Š 6â”Šimport apolloClient from './apollo-client'\n â”Š 5â”Š 7â”Šimport * as serviceWorker from './serviceWorker';\n â”Š 6â”Š 8â”Š\n-â”Š 7â”Š  â”ŠReactDOM.render(<App />, document.getElementById('root'));\n+â”Š  â”Š 9â”ŠReactDOM.render(\n+â”Š  â”Š10â”Š  <ApolloProvider client={apolloClient}>\n+â”Š  â”Š11â”Š    <App />\n+â”Š  â”Š12â”Š  </ApolloProvider>\n+â”Š  â”Š13â”Š, document.getElementById('root'));\n â”Š 8â”Š14â”Š\n â”Š 9â”Š15â”Š// If you want your app to work offline and load faster, you can change\n â”Š10â”Š16â”Š// unregister() to register() below. Note this comes with some pitfalls.\n```\n\n[}]: #\n\n> Note that this configuration assumes that the sever runs at `localhost:4000` and that it serves a GraphQL REST endpoint at `/graphql`. Feel free to make the right adjustments according to your needs.\n\nNeedless to say that we need a back-end for our application to function properly, and so this is what we're gonna focus on. We will initialize a second project for the server in a separate directory called `whatsapp-clone-server`:\n\n    $ mkdir whatsapp-clone-server\n    $ cd whatsapp-clone-server\n\nAnd then we will initialize a new Node.JS project using NPM:\n\n    $ npm init --yes\n\nThere's nothing special about this command, it only creates a basic `package.json` which we can add things on top (see [reference](https://docs.npmjs.com/cli/init)). We will be using TypeScript in our project, so let's set it up by installing the necessary packages:\n\n    $ yarn add -D typescript@3.3.3 ts-node@8.0.2 @types/node@11.9.4\n\nAnd creating a `tsconfig.json` file:\n\n[{]: <helper> (diffStep 1.1 files=\"tsconfig.json\" module=\"server\")\n\n#### Step 1.1: Setup TypeScript\n\n##### Added tsconfig.json\n```diff\n@@ -0,0 +1,64 @@\n+â”Š  â”Š 1â”Š{\n+â”Š  â”Š 2â”Š  \"compilerOptions\": {\n+â”Š  â”Š 3â”Š    /* Basic Options */\n+â”Š  â”Š 4â”Š    \"target\": \"es2018\",                       /* Specify ECMAScript target version: 'ES3' (default), 'ES5', 'ES2015', 'ES2016', 'ES2017','ES2018' or 'ESNEXT'. */\n+â”Š  â”Š 5â”Š    \"module\": \"commonjs\",                     /* Specify module code generation: 'none', 'commonjs', 'amd', 'system', 'umd', 'es2015', or 'ESNext'. */\n+â”Š  â”Š 6â”Š    \"lib\": [                                  /* Specify library files to be included in the compilation. */\n+â”Š  â”Š 7â”Š      \"es2018\",\n+â”Š  â”Š 8â”Š      \"esnext.asynciterable\"\n+â”Š  â”Š 9â”Š    ],\n+â”Š  â”Š10â”Š    // \"allowJs\": true,                       /* Allow javascript files to be compiled. */\n+â”Š  â”Š11â”Š    // \"checkJs\": true,                       /* Report errors in .js files. */\n+â”Š  â”Š12â”Š    // \"jsx\": \"preserve\",                     /* Specify JSX code generation: 'preserve', 'react-native', or 'react'. */\n+â”Š  â”Š13â”Š    // \"declaration\": true,                   /* Generates corresponding '.d.ts' file. */\n+â”Š  â”Š14â”Š    // \"declarationMap\": true,                /* Generates a sourcemap for each corresponding '.d.ts' file. */\n+â”Š  â”Š15â”Š    // \"sourceMap\": true,                     /* Generates corresponding '.map' file. */\n+â”Š  â”Š16â”Š    // \"outFile\": \"./\",                       /* Concatenate and emit output to single file. */\n+â”Š  â”Š17â”Š    // \"outDir\": \"./\",                        /* Redirect output structure to the directory. */\n+â”Š  â”Š18â”Š    // \"rootDir\": \"./\",                       /* Specify the root directory of input files. Use to control the output directory structure with --outDir. */\n+â”Š  â”Š19â”Š    // \"composite\": true,                     /* Enable project compilation */\n+â”Š  â”Š20â”Š    // \"removeComments\": true,                /* Do not emit comments to output. */\n+â”Š  â”Š21â”Š    // \"noEmit\": true,                        /* Do not emit outputs. */\n+â”Š  â”Š22â”Š    // \"importHelpers\": true,                 /* Import emit helpers from 'tslib'. */\n+â”Š  â”Š23â”Š    // \"downlevelIteration\": true,            /* Provide full support for iterables in 'for-of', spread, and destructuring when targeting 'ES5' or 'ES3'. */\n+â”Š  â”Š24â”Š    // \"isolatedModules\": true,               /* Transpile each file as a separate module (similar to 'ts.transpileModule'). */\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Š    /* Strict Type-Checking Options */\n+â”Š  â”Š27â”Š    \"strict\": true,                           /* Enable all strict type-checking options. */\n+â”Š  â”Š28â”Š    // \"noImplicitAny\": true,                 /* Raise error on expressions and declarations with an implied 'any' type. */\n+â”Š  â”Š29â”Š    // \"strictNullChecks\": true,              /* Enable strict null checks. */\n+â”Š  â”Š30â”Š    // See https://github.com/DefinitelyTyped/DefinitelyTyped/issues/21359\n+â”Š  â”Š31â”Š    \"strictFunctionTypes\": false,             /* Enable strict checking of function types. */\n+â”Š  â”Š32â”Š    // \"strictBindCallApply\": true,           /* Enable strict 'bind', 'call', and 'apply' methods on functions. */\n+â”Š  â”Š33â”Š    \"strictPropertyInitialization\": false,    /* Enable strict checking of property initialization in classes. */\n+â”Š  â”Š34â”Š    // \"noImplicitThis\": true,                /* Raise error on 'this' expressions with an implied 'any' type. */\n+â”Š  â”Š35â”Š    // \"alwaysStrict\": true,                  /* Parse in strict mode and emit \"use strict\" for each source file. */\n+â”Š  â”Š36â”Š\n+â”Š  â”Š37â”Š    /* Additional Checks */\n+â”Š  â”Š38â”Š    // \"noUnusedLocals\": true,                /* Report errors on unused locals. */\n+â”Š  â”Š39â”Š    // \"noUnusedParameters\": true,            /* Report errors on unused parameters. */\n+â”Š  â”Š40â”Š    // \"noImplicitReturns\": true,             /* Report error when not all code paths in function return a value. */\n+â”Š  â”Š41â”Š    // \"noFallthroughCasesInSwitch\": true,    /* Report errors for fallthrough cases in switch statement. */\n+â”Š  â”Š42â”Š\n+â”Š  â”Š43â”Š    /* Module Resolution Options */\n+â”Š  â”Š44â”Š    // \"moduleResolution\": \"node\",            /* Specify module resolution strategy: 'node' (Node.js) or 'classic' (TypeScript pre-1.6). */\n+â”Š  â”Š45â”Š    // \"baseUrl\": \"./\",                       /* Base directory to resolve non-absolute module names. */\n+â”Š  â”Š46â”Š    // \"paths\": {},                           /* A series of entries which re-map imports to lookup locations relative to the 'baseUrl'. */\n+â”Š  â”Š47â”Š    // \"rootDirs\": [],                        /* List of root folders whose combined content represents the structure of the project at runtime. */\n+â”Š  â”Š48â”Š    // \"typeRoots\": [],                       /* List of folders to include type definitions from. */\n+â”Š  â”Š49â”Š    // \"types\": [],                           /* Type declaration files to be included in compilation. */\n+â”Š  â”Š50â”Š    // \"allowSyntheticDefaultImports\": true,  /* Allow default imports from modules with no default export. This does not affect code emit, just typechecking. */\n+â”Š  â”Š51â”Š    \"esModuleInterop\": true,                  /* Enables emit interoperability between CommonJS and ES Modules via creation of namespace objects for all imports. Implies 'allowSyntheticDefaultImports'. */\n+â”Š  â”Š52â”Š    // \"preserveSymlinks\": true,              /* Do not resolve the real path of symlinks. */\n+â”Š  â”Š53â”Š\n+â”Š  â”Š54â”Š    /* Source Map Options */\n+â”Š  â”Š55â”Š    // \"sourceRoot\": \"\",                      /* Specify the location where debugger should locate TypeScript files instead of source locations. */\n+â”Š  â”Š56â”Š    // \"mapRoot\": \"\",                         /* Specify the location where debugger should locate map files instead of generated locations. */\n+â”Š  â”Š57â”Š    // \"inlineSourceMap\": true,               /* Emit a single file with source maps instead of having a separate file. */\n+â”Š  â”Š58â”Š    // \"inlineSources\": true,                 /* Emit the source alongside the sourcemaps within a single file; requires '--inlineSourceMap' or '--sourceMap' to be set. */\n+â”Š  â”Š59â”Š\n+â”Š  â”Š60â”Š    /* Experimental Options */\n+â”Š  â”Š61â”Š    \"experimentalDecorators\": true,           /* Enables experimental support for ES7 decorators. */\n+â”Š  â”Š62â”Š    \"emitDecoratorMetadata\": true             /* Enables experimental support for emitting type metadata for decorators. */\n+â”Š  â”Š63â”Š  }\n+â”Š  â”Š64â”Š}\n```\n\n[}]: #\n\nWe will also set a script that will startup the server with `ts-node`, a TypeScript interpreter for Node.JS:\n\n```json\n{\n  \"start\": \"ts-node index.ts\"\n}\n```\n\nOur `pacakge.json` file should look like so by now:\n\n[{]: <helper> (diffStep 1.1 files=\"package.json\" module=\"server\")\n\n#### Step 1.1: Setup TypeScript\n\n##### Changed package.json\n```diff\n@@ -4,5 +4,13 @@\n â”Š 4â”Š 4â”Š  \"repository\": {\n â”Š 5â”Š 5â”Š    \"type\": \"git\",\n â”Š 6â”Š 6â”Š    \"url\": \"https://Urigo@github.com/Urigo/WhatsApp-Clone-Server.git\"\n+â”Š  â”Š 7â”Š  },\n+â”Š  â”Š 8â”Š  \"scripts\": {\n+â”Š  â”Š 9â”Š    \"start\": \"ts-node index.ts\"\n+â”Š  â”Š10â”Š  },\n+â”Š  â”Š11â”Š  \"devDependencies\": {\n+â”Š  â”Š12â”Š    \"@types/node\": \"11.9.4\",\n+â”Š  â”Š13â”Š    \"ts-node\": \"8.0.2\",\n+â”Š  â”Š14â”Š    \"typescript\": \"3.3.3\"\n â”Š 7â”Š15â”Š  }\n â”Š 8â”Š16â”Š}\n```\n\n[}]: #\n\nIn our server we will be using [Express](https://expressjs.com/) to serve our GraphQL REST endpoint which will be handled by Apollo. Accordingly, let's install the necessary dependencies:\n\n    $ yarn add -D @types/body-parser@1.17.0 @types/cors@2.8.4 @types/express@4.16.0 @types/graphql@14.0.4\n    $ yarn add apollo-server-express@2.4.2 body-parser@1.18.3 cors@2.8.5 express@4.16.4 graphql@14.1.1\n\nAnd setup a basic express server with a `/graphql` REST endpoint:\n\n[{]: <helper> (diffStep 1.2 files=\"index.ts, schema\" module=\"server\")\n\n#### Step 1.2: Setup a basic Express server with a GraphQL REST endpoint\n\n##### Added index.ts\n```diff\n@@ -0,0 +1,30 @@\n+â”Š  â”Š 1â”Šimport { ApolloServer } from 'apollo-server-express'\n+â”Š  â”Š 2â”Šimport bodyParser from 'body-parser'\n+â”Š  â”Š 3â”Šimport cors from 'cors'\n+â”Š  â”Š 4â”Šimport express from 'express'\n+â”Š  â”Š 5â”Šimport gql from 'graphql-tag'\n+â”Š  â”Š 6â”Šimport { createServer } from 'http'\n+â”Š  â”Š 7â”Šimport schema from './schema'\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Šconst PORT = 4000\n+â”Š  â”Š10â”Š\n+â”Š  â”Š11â”Šconst app = express()\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Šapp.use(cors())\n+â”Š  â”Š14â”Šapp.use(bodyParser.json())\n+â”Š  â”Š15â”Š\n+â”Š  â”Š16â”Šconst apollo = new ApolloServer({ schema })\n+â”Š  â”Š17â”Š\n+â”Š  â”Š18â”Šapollo.applyMiddleware({\n+â”Š  â”Š19â”Š  app,\n+â”Š  â”Š20â”Š  path: '/graphql',\n+â”Š  â”Š21â”Š})\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Š// Wrap the Express server\n+â”Š  â”Š24â”Šconst ws = createServer(app)\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Šapollo.installSubscriptionHandlers(ws)\n+â”Š  â”Š27â”Š\n+â”Š  â”Š28â”Šws.listen(PORT, () => {\n+â”Š  â”Š29â”Š  console.log(`Apollo Server is now running on http://localhost:${PORT}`)\n+â”Š  â”Š30â”Š})\n```\n\n##### Added schema&#x2F;index.ts\n```diff\n@@ -0,0 +1,8 @@\n+â”Š â”Š1â”Šimport { makeExecutableSchema } from 'apollo-server-express'\n+â”Š â”Š2â”Šimport resolvers from './resolvers'\n+â”Š â”Š3â”Šimport typeDefs from './typeDefs'\n+â”Š â”Š4â”Š\n+â”Š â”Š5â”Šexport default makeExecutableSchema({\n+â”Š â”Š6â”Š  typeDefs,\n+â”Š â”Š7â”Š  resolvers,\n+â”Š â”Š8â”Š})\n```\n\n##### Added schema&#x2F;resolvers.ts\n```diff\n@@ -0,0 +1,5 @@\n+â”Š â”Š1â”Šexport default {\n+â”Š â”Š2â”Š  Query: {\n+â”Š â”Š3â”Š    chats: () => [],\n+â”Š â”Š4â”Š  },\n+â”Š â”Š5â”Š}\n```\n\n##### Added schema&#x2F;typeDefs.ts\n```diff\n@@ -0,0 +1,9 @@\n+â”Š â”Š1â”Šexport default `\n+â”Š â”Š2â”Š  type Chat {\n+â”Š â”Š3â”Š    id: ID!\n+â”Š â”Š4â”Š  }\n+â”Š â”Š5â”Š\n+â”Š â”Š6â”Š  type Query {\n+â”Š â”Š7â”Š    chats: [Chat!]!\n+â”Š â”Š8â”Š  }\n+â”Š â”Š9â”Š`\n```\n\n[}]: #\n\nBefore we proceed any further there's an issue that needs to be clear. Since we're using TypeScript together with GraphQL, by default we will have to maintain 2 schemas: one for TypeScript and the other for GraphQL. Both schemas represent the same thing this way or another, which means that we will have to maintain the same thing twice. Instead of doing so, we will be using a tool called [GraphQL Code Generator](https://graphql-code-generator.com/) (Codegen, in short) to generate TypeScript definitions from our GraphQL schema.\n\nCodegen will change its behavior and generate code based on a set of templates and a configuration file that we will provide. We highly recommend you to go through the [docs page](https://graphql-code-generator.com/docs/getting-started/) of Codegen to get a better understanding of what it is and how it works. Let's install Codegen then, along with the templates that we're gonna use:\n\n    $ yarn -D add graphql-code-generator@0.16.1 graphql-codegen-typescript-common@0.16.1 graphql-codegen-typescript-resolvers@0.16.1\n\nAnd write its config under `codegen.yml` file:\n\n[{]: <helper> (diffStep 1.3 files=\"codegen.yml\" module=\"server\")\n\n#### Step 1.3: Setup codegen\n\n##### Added codegen.yml\n```diff\n@@ -0,0 +1,8 @@\n+â”Š â”Š1â”Šoverwrite: true\n+â”Š â”Š2â”Šschema: ./schema/typeDefs.ts\n+â”Š â”Š3â”Šrequire: ts-node/register/transpile-only\n+â”Š â”Š4â”Šgenerates:\n+â”Š â”Š5â”Š  ./types.d.ts:\n+â”Š â”Š6â”Š    plugins:\n+â”Š â”Š7â”Š      - typescript-common\n+â”Š â”Š8â”Š      - typescript-resolvers\n```\n\n[}]: #\n\nWe will also update the `.gitignore` file to exclude the generated typings file:\n\n[{]: <helper> (diffStep 1.3 files=\".gitignore\" module=\"server\")\n\n#### Step 1.3: Setup codegen\n\n##### Changed .gitignore\n```diff\n@@ -1,2 +1,3 @@\n â”Š1â”Š1â”Šnode_modules\n-â”Š2â”Š â”Šnpm-debug.logðŸš«â†µ\n+â”Š â”Š2â”Šnpm-debug.log\n+â”Š â”Š3â”Štypes.d.ts\n```\n\n[}]: #\n\nTo make things easy, we will add a code generation command in our `package.json` so we can have it available to us whenever we need it. First we will add few utility packages that are necessary for the task:\n\n    $ yarn -D add nodemon@1.18.9 concurrently@4.1.0\n\nAnd we will update the scripts section in the `package.json` file to look like so:\n\n```json\n{\n  \"generate\": \"gql-gen\",\n  \"generate:watch\": \"nodemon --exec yarn generate -e graphql\",\n  \"start:server\": \"ts-node index.ts\",\n  \"start:server:watch\": \"nodemon --exec yarn start:server -e ts\",\n  \"dev\": \"concurrently \\\"yarn generate:watch\\\" \\\"yarn start:server:watch\\\"\",\n  \"start\": \"yarn generate && yarn start:server\"\n}\n```\n\nThe `package.json` file should look like so by now:\n\n[{]: <helper> (diffStep 1.3 files=\"package.json\" module=\"server\")\n\n#### Step 1.3: Setup codegen\n\n##### Changed package.json\n```diff\n@@ -6,7 +6,12 @@\n â”Š 6â”Š 6â”Š    \"url\": \"https://Urigo@github.com/Urigo/WhatsApp-Clone-Server.git\"\n â”Š 7â”Š 7â”Š  },\n â”Š 8â”Š 8â”Š  \"scripts\": {\n-â”Š 9â”Š  â”Š    \"start\": \"ts-node index.ts\"\n+â”Š  â”Š 9â”Š    \"generate\": \"gql-gen\",\n+â”Š  â”Š10â”Š    \"generate:watch\": \"nodemon --exec yarn generate -e graphql\",\n+â”Š  â”Š11â”Š    \"start:server\": \"ts-node index.ts\",\n+â”Š  â”Š12â”Š    \"start:server:watch\": \"nodemon --exec yarn start:server -e ts\",\n+â”Š  â”Š13â”Š    \"dev\": \"concurrently \\\"yarn generate:watch\\\" \\\"yarn start:server:watch\\\"\",\n+â”Š  â”Š14â”Š    \"start\": \"yarn generate && yarn start:server\"\n â”Š10â”Š15â”Š  },\n â”Š11â”Š16â”Š  \"devDependencies\": {\n â”Š12â”Š17â”Š    \"@types/body-parser\": \"1.17.0\",\n```\n```diff\n@@ -14,6 +19,11 @@\n â”Š14â”Š19â”Š    \"@types/express\": \"4.16.0\",\n â”Š15â”Š20â”Š    \"@types/graphql\": \"14.0.4\",\n â”Š16â”Š21â”Š    \"@types/node\": \"11.9.4\",\n+â”Š  â”Š22â”Š    \"concurrently\": \"4.1.0\",\n+â”Š  â”Š23â”Š    \"graphql-code-generator\": \"0.16.1\",\n+â”Š  â”Š24â”Š    \"graphql-codegen-typescript-common\": \"0.16.1\",\n+â”Š  â”Š25â”Š    \"graphql-codegen-typescript-resolvers\": \"0.16.1\",\n+â”Š  â”Š26â”Š    \"nodemon\": \"1.18.9\",\n â”Š17â”Š27â”Š    \"ts-node\": \"8.0.2\",\n â”Š18â”Š28â”Š    \"typescript\": \"3.3.3\"\n â”Š19â”Š29â”Š  },\n```\n\n[}]: #\n\nTo generate some TypeScript definitions all we have to do is run:\n\n    $ yarn generate\n\nAnd then we can safely run the server with:\n\n    $ yarn start\n\nAlternatively, you can run the server and watch for changes with the following command:\n\n    $ yarn start:server:watch\n\nFor practice purpose only, we're gonna serve some dummy data from our GraphQL API so we can have something to work with in our client. Later on we will connect everything to a real database. This would give us an easy start. Our dummy db will consist of a set of chats, each of them has a last message, a picture and a name:\n\n[{]: <helper> (diffStep 1.4 files=\"index.ts, db.ts, entity, schema, codegen.yml\" module=\"server\")\n\n#### Step 1.4: Add fake DB\n\n##### Changed codegen.yml\n```diff\n@@ -6,3 +6,9 @@\n â”Š 6â”Š 6â”Š    plugins:\n â”Š 7â”Š 7â”Š      - typescript-common\n â”Š 8â”Š 8â”Š      - typescript-resolvers\n+â”Š  â”Š 9â”Š    config:\n+â”Š  â”Š10â”Š      optionalType: undefined | null\n+â”Š  â”Š11â”Š      mappers:\n+â”Š  â”Š12â”Š        Chat: ./entity/chat#Chat\n+â”Š  â”Š13â”Š        Message: ./entity/message#Message\n+â”Š  â”Š14â”Š        User: ./entity/user#User\n```\n\n##### Added db.ts\n```diff\n@@ -0,0 +1,274 @@\n+â”Š   â”Š  1â”Šimport moment from 'moment'\n+â”Š   â”Š  2â”Šimport Chat from './entity/chat'\n+â”Š   â”Š  3â”Šimport Message, { MessageType } from './entity/message'\n+â”Š   â”Š  4â”Šimport User from './entity/user'\n+â”Š   â”Š  5â”Š\n+â”Š   â”Š  6â”Šconst users: User[] = [\n+â”Š   â”Š  7â”Š  {\n+â”Š   â”Š  8â”Š    id: '1',\n+â”Š   â”Š  9â”Š    username: 'ethan',\n+â”Š   â”Š 10â”Š    password: '$2a$08$NO9tkFLCoSqX1c5wk3s7z.JfxaVMKA.m7zUDdDwEquo4rvzimQeJm', // 111\n+â”Š   â”Š 11â”Š    name: 'Ethan Gonzalez',\n+â”Š   â”Š 12â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n+â”Š   â”Š 13â”Š  },\n+â”Š   â”Š 14â”Š  {\n+â”Š   â”Š 15â”Š    id: '2',\n+â”Š   â”Š 16â”Š    username: 'bryan',\n+â”Š   â”Š 17â”Š    password: '$2a$08$xE4FuCi/ifxjL2S8CzKAmuKLwv18ktksSN.F3XYEnpmcKtpbpeZgO', // 222\n+â”Š   â”Š 18â”Š    name: 'Bryan Wallace',\n+â”Š   â”Š 19â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n+â”Š   â”Š 20â”Š  },\n+â”Š   â”Š 21â”Š  {\n+â”Š   â”Š 22â”Š    id: '3',\n+â”Š   â”Š 23â”Š    username: 'avery',\n+â”Š   â”Š 24â”Š    password: '$2a$08$UHgH7J8G6z1mGQn2qx2kdeWv0jvgHItyAsL9hpEUI3KJmhVW5Q1d.', // 333\n+â”Š   â”Š 25â”Š    name: 'Avery Stewart',\n+â”Š   â”Š 26â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n+â”Š   â”Š 27â”Š  },\n+â”Š   â”Š 28â”Š  {\n+â”Š   â”Š 29â”Š    id: '4',\n+â”Š   â”Š 30â”Š    username: 'katie',\n+â”Š   â”Š 31â”Š    password: '$2a$08$wR1k5Q3T9FC7fUgB7Gdb9Os/GV7dGBBf4PLlWT7HERMFhmFDt47xi', // 444\n+â”Š   â”Š 32â”Š    name: 'Katie Peterson',\n+â”Š   â”Š 33â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n+â”Š   â”Š 34â”Š  },\n+â”Š   â”Š 35â”Š  {\n+â”Š   â”Š 36â”Š    id: '5',\n+â”Š   â”Š 37â”Š    username: 'ray',\n+â”Š   â”Š 38â”Š    password: '$2a$08$6.mbXqsDX82ZZ7q5d8Osb..JrGSsNp4R3IKj7mxgF6YGT0OmMw242', // 555\n+â”Š   â”Š 39â”Š    name: 'Ray Edwards',\n+â”Š   â”Š 40â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/3.jpg',\n+â”Š   â”Š 41â”Š  },\n+â”Š   â”Š 42â”Š  {\n+â”Š   â”Š 43â”Š    id: '6',\n+â”Š   â”Š 44â”Š    username: 'niko',\n+â”Š   â”Š 45â”Š    password: '$2a$08$fL5lZR.Rwf9FWWe8XwwlceiPBBim8n9aFtaem.INQhiKT4.Ux3Uq.', // 666\n+â”Š   â”Š 46â”Š    name: 'NiccolÃ² Belli',\n+â”Š   â”Š 47â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/4.jpg',\n+â”Š   â”Š 48â”Š  },\n+â”Š   â”Š 49â”Š  {\n+â”Š   â”Š 50â”Š    id: '7',\n+â”Š   â”Š 51â”Š    username: 'mario',\n+â”Š   â”Š 52â”Š    password: '$2a$08$nDHDmWcVxDnH5DDT3HMMC.psqcnu6wBiOgkmJUy9IH..qxa3R6YrO', // 777\n+â”Š   â”Š 53â”Š    name: 'Mario Rossi',\n+â”Š   â”Š 54â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/5.jpg',\n+â”Š   â”Š 55â”Š  },\n+â”Š   â”Š 56â”Š]\n+â”Š   â”Š 57â”Š\n+â”Š   â”Š 58â”Šconst chats: Chat[] = [\n+â”Š   â”Š 59â”Š  {\n+â”Š   â”Š 60â”Š    id: '1',\n+â”Š   â”Š 61â”Š    name: null,\n+â”Š   â”Š 62â”Š    picture: null,\n+â”Š   â”Š 63â”Š    allTimeMemberIds: ['1', '3'],\n+â”Š   â”Š 64â”Š    listingMemberIds: ['1', '3'],\n+â”Š   â”Š 65â”Š    ownerId: null,\n+â”Š   â”Š 66â”Š    messages: [\n+â”Š   â”Š 67â”Š      {\n+â”Š   â”Š 68â”Š        id: '1',\n+â”Š   â”Š 69â”Š        chatId: '1',\n+â”Š   â”Š 70â”Š        senderId: '1',\n+â”Š   â”Š 71â”Š        content: 'You on your way?',\n+â”Š   â”Š 72â”Š        createdAt: moment()\n+â”Š   â”Š 73â”Š          .subtract(1, 'hours')\n+â”Š   â”Š 74â”Š          .unix(),\n+â”Š   â”Š 75â”Š        type: MessageType.TEXT,\n+â”Š   â”Š 76â”Š        holderIds: ['1', '3'],\n+â”Š   â”Š 77â”Š      },\n+â”Š   â”Š 78â”Š      {\n+â”Š   â”Š 79â”Š        id: '2',\n+â”Š   â”Š 80â”Š        chatId: '1',\n+â”Š   â”Š 81â”Š        senderId: '3',\n+â”Š   â”Š 82â”Š        content: 'Yep!',\n+â”Š   â”Š 83â”Š        createdAt: moment()\n+â”Š   â”Š 84â”Š          .subtract(1, 'hours')\n+â”Š   â”Š 85â”Š          .add(5, 'minutes')\n+â”Š   â”Š 86â”Š          .unix(),\n+â”Š   â”Š 87â”Š        type: MessageType.TEXT,\n+â”Š   â”Š 88â”Š        holderIds: ['3', '1'],\n+â”Š   â”Š 89â”Š      },\n+â”Š   â”Š 90â”Š    ],\n+â”Š   â”Š 91â”Š  },\n+â”Š   â”Š 92â”Š  {\n+â”Š   â”Š 93â”Š    id: '2',\n+â”Š   â”Š 94â”Š    name: null,\n+â”Š   â”Š 95â”Š    picture: null,\n+â”Š   â”Š 96â”Š    allTimeMemberIds: ['1', '4'],\n+â”Š   â”Š 97â”Š    listingMemberIds: ['1', '4'],\n+â”Š   â”Š 98â”Š    ownerId: null,\n+â”Š   â”Š 99â”Š    messages: [\n+â”Š   â”Š100â”Š      {\n+â”Š   â”Š101â”Š        id: '1',\n+â”Š   â”Š102â”Š        chatId: '2',\n+â”Š   â”Š103â”Š        senderId: '1',\n+â”Š   â”Š104â”Š        content: \"Hey, it's me\",\n+â”Š   â”Š105â”Š        createdAt: moment()\n+â”Š   â”Š106â”Š          .subtract(2, 'hours')\n+â”Š   â”Š107â”Š          .unix(),\n+â”Š   â”Š108â”Š        type: MessageType.TEXT,\n+â”Š   â”Š109â”Š        holderIds: ['1', '4'],\n+â”Š   â”Š110â”Š      },\n+â”Š   â”Š111â”Š    ],\n+â”Š   â”Š112â”Š  },\n+â”Š   â”Š113â”Š  {\n+â”Š   â”Š114â”Š    id: '3',\n+â”Š   â”Š115â”Š    name: null,\n+â”Š   â”Š116â”Š    picture: null,\n+â”Š   â”Š117â”Š    allTimeMemberIds: ['1', '5'],\n+â”Š   â”Š118â”Š    listingMemberIds: ['1', '5'],\n+â”Š   â”Š119â”Š    ownerId: null,\n+â”Š   â”Š120â”Š    messages: [\n+â”Š   â”Š121â”Š      {\n+â”Š   â”Š122â”Š        id: '1',\n+â”Š   â”Š123â”Š        chatId: '3',\n+â”Š   â”Š124â”Š        senderId: '1',\n+â”Š   â”Š125â”Š        content: 'I should buy a boat',\n+â”Š   â”Š126â”Š        createdAt: moment()\n+â”Š   â”Š127â”Š          .subtract(1, 'days')\n+â”Š   â”Š128â”Š          .unix(),\n+â”Š   â”Š129â”Š        type: MessageType.TEXT,\n+â”Š   â”Š130â”Š        holderIds: ['1', '5'],\n+â”Š   â”Š131â”Š      },\n+â”Š   â”Š132â”Š      {\n+â”Š   â”Š133â”Š        id: '2',\n+â”Š   â”Š134â”Š        chatId: '3',\n+â”Š   â”Š135â”Š        senderId: '1',\n+â”Š   â”Š136â”Š        content: 'You still there?',\n+â”Š   â”Š137â”Š        createdAt: moment()\n+â”Š   â”Š138â”Š          .subtract(1, 'days')\n+â”Š   â”Š139â”Š          .add(16, 'hours')\n+â”Š   â”Š140â”Š          .unix(),\n+â”Š   â”Š141â”Š        type: MessageType.TEXT,\n+â”Š   â”Š142â”Š        holderIds: ['1', '5'],\n+â”Š   â”Š143â”Š      },\n+â”Š   â”Š144â”Š    ],\n+â”Š   â”Š145â”Š  },\n+â”Š   â”Š146â”Š  {\n+â”Š   â”Š147â”Š    id: '4',\n+â”Š   â”Š148â”Š    name: null,\n+â”Š   â”Š149â”Š    picture: null,\n+â”Š   â”Š150â”Š    allTimeMemberIds: ['3', '4'],\n+â”Š   â”Š151â”Š    listingMemberIds: ['3', '4'],\n+â”Š   â”Š152â”Š    ownerId: null,\n+â”Š   â”Š153â”Š    messages: [\n+â”Š   â”Š154â”Š      {\n+â”Š   â”Š155â”Š        id: '1',\n+â”Š   â”Š156â”Š        chatId: '4',\n+â”Š   â”Š157â”Š        senderId: '3',\n+â”Š   â”Š158â”Š        content: 'Look at my mukluks!',\n+â”Š   â”Š159â”Š        createdAt: moment()\n+â”Š   â”Š160â”Š          .subtract(4, 'days')\n+â”Š   â”Š161â”Š          .unix(),\n+â”Š   â”Š162â”Š        type: MessageType.TEXT,\n+â”Š   â”Š163â”Š        holderIds: ['3', '4'],\n+â”Š   â”Š164â”Š      },\n+â”Š   â”Š165â”Š    ],\n+â”Š   â”Š166â”Š  },\n+â”Š   â”Š167â”Š  {\n+â”Š   â”Š168â”Š    id: '5',\n+â”Š   â”Š169â”Š    name: null,\n+â”Š   â”Š170â”Š    picture: null,\n+â”Š   â”Š171â”Š    allTimeMemberIds: ['2', '5'],\n+â”Š   â”Š172â”Š    listingMemberIds: ['2', '5'],\n+â”Š   â”Š173â”Š    ownerId: null,\n+â”Š   â”Š174â”Š    messages: [\n+â”Š   â”Š175â”Š      {\n+â”Š   â”Š176â”Š        id: '1',\n+â”Š   â”Š177â”Š        chatId: '5',\n+â”Š   â”Š178â”Š        senderId: '2',\n+â”Š   â”Š179â”Š        content: 'This is wicked good ice cream.',\n+â”Š   â”Š180â”Š        createdAt: moment()\n+â”Š   â”Š181â”Š          .subtract(2, 'weeks')\n+â”Š   â”Š182â”Š          .unix(),\n+â”Š   â”Š183â”Š        type: MessageType.TEXT,\n+â”Š   â”Š184â”Š        holderIds: ['2', '5'],\n+â”Š   â”Š185â”Š      },\n+â”Š   â”Š186â”Š      {\n+â”Š   â”Š187â”Š        id: '2',\n+â”Š   â”Š188â”Š        chatId: '6',\n+â”Š   â”Š189â”Š        senderId: '5',\n+â”Š   â”Š190â”Š        content: 'Love it!',\n+â”Š   â”Š191â”Š        createdAt: moment()\n+â”Š   â”Š192â”Š          .subtract(2, 'weeks')\n+â”Š   â”Š193â”Š          .add(10, 'minutes')\n+â”Š   â”Š194â”Š          .unix(),\n+â”Š   â”Š195â”Š        type: MessageType.TEXT,\n+â”Š   â”Š196â”Š        holderIds: ['5', '2'],\n+â”Š   â”Š197â”Š      },\n+â”Š   â”Š198â”Š    ],\n+â”Š   â”Š199â”Š  },\n+â”Š   â”Š200â”Š  {\n+â”Š   â”Š201â”Š    id: '6',\n+â”Š   â”Š202â”Š    name: null,\n+â”Š   â”Š203â”Š    picture: null,\n+â”Š   â”Š204â”Š    allTimeMemberIds: ['1', '6'],\n+â”Š   â”Š205â”Š    listingMemberIds: ['1'],\n+â”Š   â”Š206â”Š    ownerId: null,\n+â”Š   â”Š207â”Š    messages: [],\n+â”Š   â”Š208â”Š  },\n+â”Š   â”Š209â”Š  {\n+â”Š   â”Š210â”Š    id: '7',\n+â”Š   â”Š211â”Š    name: null,\n+â”Š   â”Š212â”Š    picture: null,\n+â”Š   â”Š213â”Š    allTimeMemberIds: ['2', '1'],\n+â”Š   â”Š214â”Š    listingMemberIds: ['2'],\n+â”Š   â”Š215â”Š    ownerId: null,\n+â”Š   â”Š216â”Š    messages: [],\n+â”Š   â”Š217â”Š  },\n+â”Š   â”Š218â”Š  {\n+â”Š   â”Š219â”Š    id: '8',\n+â”Š   â”Š220â”Š    name: 'A user 0 group',\n+â”Š   â”Š221â”Š    picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n+â”Š   â”Š222â”Š    allTimeMemberIds: ['1', '3', '4', '6'],\n+â”Š   â”Š223â”Š    listingMemberIds: ['1', '3', '4', '6'],\n+â”Š   â”Š224â”Š    ownerId: '1',\n+â”Š   â”Š225â”Š    messages: [\n+â”Š   â”Š226â”Š      {\n+â”Š   â”Š227â”Š        id: '1',\n+â”Š   â”Š228â”Š        chatId: '8',\n+â”Š   â”Š229â”Š        senderId: '1',\n+â”Š   â”Š230â”Š        content: 'I made a group',\n+â”Š   â”Š231â”Š        createdAt: moment()\n+â”Š   â”Š232â”Š          .subtract(2, 'weeks')\n+â”Š   â”Š233â”Š          .unix(),\n+â”Š   â”Š234â”Š        type: MessageType.TEXT,\n+â”Š   â”Š235â”Š        holderIds: ['1', '3', '4', '6'],\n+â”Š   â”Š236â”Š      },\n+â”Š   â”Š237â”Š      {\n+â”Š   â”Š238â”Š        id: '2',\n+â”Š   â”Š239â”Š        chatId: '8',\n+â”Š   â”Š240â”Š        senderId: '1',\n+â”Š   â”Š241â”Š        content: 'Ops, user 3 was not supposed to be here',\n+â”Š   â”Š242â”Š        createdAt: moment()\n+â”Š   â”Š243â”Š          .subtract(2, 'weeks')\n+â”Š   â”Š244â”Š          .add(2, 'minutes')\n+â”Š   â”Š245â”Š          .unix(),\n+â”Š   â”Š246â”Š        type: MessageType.TEXT,\n+â”Š   â”Š247â”Š        holderIds: ['1', '4', '6'],\n+â”Š   â”Š248â”Š      },\n+â”Š   â”Š249â”Š      {\n+â”Š   â”Š250â”Š        id: '3',\n+â”Š   â”Š251â”Š        chatId: '8',\n+â”Š   â”Š252â”Š        senderId: '4',\n+â”Š   â”Š253â”Š        content: 'Awesome!',\n+â”Š   â”Š254â”Š        createdAt: moment()\n+â”Š   â”Š255â”Š          .subtract(2, 'weeks')\n+â”Š   â”Š256â”Š          .add(10, 'minutes')\n+â”Š   â”Š257â”Š          .unix(),\n+â”Š   â”Š258â”Š        type: MessageType.TEXT,\n+â”Š   â”Š259â”Š        holderIds: ['1', '4', '6'],\n+â”Š   â”Š260â”Š      },\n+â”Š   â”Š261â”Š    ],\n+â”Š   â”Š262â”Š  },\n+â”Š   â”Š263â”Š  {\n+â”Š   â”Š264â”Š    id: '9',\n+â”Š   â”Š265â”Š    name: 'A user 5 group',\n+â”Š   â”Š266â”Š    picture: null,\n+â”Š   â”Š267â”Š    allTimeMemberIds: ['6', '3'],\n+â”Š   â”Š268â”Š    listingMemberIds: ['6', '3'],\n+â”Š   â”Š269â”Š    ownerId: '6',\n+â”Š   â”Š270â”Š    messages: [],\n+â”Š   â”Š271â”Š  },\n+â”Š   â”Š272â”Š]\n+â”Š   â”Š273â”Š\n+â”Š   â”Š274â”Šexport default { users, chats }\n```\n\n##### Added entity&#x2F;chat.ts\n```diff\n@@ -0,0 +1,18 @@\n+â”Š  â”Š 1â”Šimport Message from './message'\n+â”Š  â”Š 2â”Š\n+â”Š  â”Š 3â”Šexport interface Chat {\n+â”Š  â”Š 4â”Š  id: string\n+â”Š  â”Š 5â”Š  name?: string | null\n+â”Š  â”Š 6â”Š  picture?: string | null\n+â”Š  â”Š 7â”Š  // All members, current and past ones.\n+â”Š  â”Š 8â”Š  allTimeMemberIds: string[]\n+â”Š  â”Š 9â”Š  // Whoever gets the chat listed. For groups includes past members who still didn't delete the group.\n+â”Š  â”Š10â”Š  listingMemberIds: string[]\n+â”Š  â”Š11â”Š  // Actual members of the group (they are not the only ones who get the group listed). Null for chats.\n+â”Š  â”Š12â”Š  actualGroupMemberIds?: string[] | null\n+â”Š  â”Š13â”Š  adminIds?: string[] | null\n+â”Š  â”Š14â”Š  ownerId?: string | null\n+â”Š  â”Š15â”Š  messages: Message[]\n+â”Š  â”Š16â”Š}\n+â”Š  â”Š17â”Š\n+â”Š  â”Š18â”Šexport default Chat\n```\n\n##### Added entity&#x2F;message.ts\n```diff\n@@ -0,0 +1,20 @@\n+â”Š  â”Š 1â”Šimport Recipient from './recipient'\n+â”Š  â”Š 2â”Š\n+â”Š  â”Š 3â”Šexport enum MessageType {\n+â”Š  â”Š 4â”Š  PICTURE,\n+â”Š  â”Š 5â”Š  TEXT,\n+â”Š  â”Š 6â”Š  LOCATION,\n+â”Š  â”Š 7â”Š}\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Šexport interface Message {\n+â”Š  â”Š10â”Š  id: string\n+â”Š  â”Š11â”Š  chatId: string\n+â”Š  â”Š12â”Š  senderId: string\n+â”Š  â”Š13â”Š  content: string\n+â”Š  â”Š14â”Š  createdAt: number\n+â”Š  â”Š15â”Š  type: MessageType\n+â”Š  â”Š16â”Š  recipients: Recipient[]\n+â”Š  â”Š17â”Š  holderIds: string[]\n+â”Š  â”Š18â”Š}\n+â”Š  â”Š19â”Š\n+â”Š  â”Š20â”Šexport default Message\n```\n\n##### Added entity&#x2F;user.ts\n```diff\n@@ -0,0 +1,10 @@\n+â”Š  â”Š 1â”Šexport interface User {\n+â”Š  â”Š 2â”Š  id: string\n+â”Š  â”Š 3â”Š  username: string\n+â”Š  â”Š 4â”Š  password: string\n+â”Š  â”Š 5â”Š  name: string\n+â”Š  â”Š 6â”Š  picture?: string | null\n+â”Š  â”Š 7â”Š  phone?: string | null\n+â”Š  â”Š 8â”Š}\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Šexport default User\n```\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,5 +1,83 @@\n+â”Š  â”Š 1â”Šimport { IResolvers as IApolloResolvers } from 'apollo-server-express'\n+â”Š  â”Š 2â”Šimport { GraphQLDateTime } from 'graphql-iso-date'\n+â”Š  â”Š 3â”Šimport db from '../db'\n+â”Š  â”Š 4â”Šimport Chat from '../entity/chat'\n+â”Š  â”Š 5â”Šimport Message from '../entity/message'\n+â”Š  â”Š 6â”Šimport Recipient from '../entity/recipient'\n+â”Š  â”Š 7â”Šimport User from '../entity/user'\n+â”Š  â”Š 8â”Šimport { IResolvers } from '../types'\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Šlet users = db.users\n+â”Š  â”Š11â”Šlet chats = db.chats\n+â”Š  â”Š12â”Šconst currentUser: string = '1'\n+â”Š  â”Š13â”Š\n â”Š 1â”Š14â”Šexport default {\n+â”Š  â”Š15â”Š  Date: GraphQLDateTime,\n â”Š 2â”Š16â”Š  Query: {\n-â”Š 3â”Š  â”Š    chats: () => [],\n+â”Š  â”Š17â”Š    // Show all users for the moment.\n+â”Š  â”Š18â”Š    users: () => users.filter(user => user.id !== currentUser),\n+â”Š  â”Š19â”Š    chats: () => chats.filter(chat => chat.listingMemberIds.includes(currentUser)),\n+â”Š  â”Š20â”Š    chat: (obj, { chatId }) => chats.find(chat => chat.id === chatId) || null,\n â”Š 4â”Š21â”Š  },\n-â”Š 5â”Š  â”Š}\n+â”Š  â”Š22â”Š  Chat: {\n+â”Š  â”Š23â”Š    name: (chat) =>\n+â”Š  â”Š24â”Š      chat.name\n+â”Š  â”Š25â”Š        ? chat.name\n+â”Š  â”Š26â”Š        : users.find(\n+â”Š  â”Š27â”Š            user => user.id === chat.allTimeMemberIds.find((userId: string) => userId !== currentUser)\n+â”Š  â”Š28â”Š          )!.name,\n+â”Š  â”Š29â”Š    picture: (chat) =>\n+â”Š  â”Š30â”Š      chat.name\n+â”Š  â”Š31â”Š        ? chat.picture\n+â”Š  â”Š32â”Š        : users.find(\n+â”Š  â”Š33â”Š            user => user.id === chat.allTimeMemberIds.find((userId: string) => userId !== currentUser)\n+â”Š  â”Š34â”Š          )!.picture,\n+â”Š  â”Š35â”Š    allTimeMembers: (chat) =>\n+â”Š  â”Š36â”Š      users.filter(user => chat.allTimeMemberIds.includes(user.id)),\n+â”Š  â”Š37â”Š    listingMembers: (chat) =>\n+â”Š  â”Š38â”Š      users.filter(user => chat.listingMemberIds.includes(user.id)),\n+â”Š  â”Š39â”Š    actualGroupMembers: (chat) =>\n+â”Š  â”Š40â”Š      users.filter(\n+â”Š  â”Š41â”Š        user => chat.actualGroupMemberIds && chat.actualGroupMemberIds.includes(user.id)\n+â”Š  â”Š42â”Š      ),\n+â”Š  â”Š43â”Š    admins: (chat) =>\n+â”Š  â”Š44â”Š      users.filter(user => chat.adminIds && chat.adminIds.includes(user.id)),\n+â”Š  â”Š45â”Š    owner: (chat) => users.find(user => chat.ownerId === user.id) || null,\n+â”Š  â”Š46â”Š    messages: (chat, { amount = 0 }) => {\n+â”Š  â”Š47â”Š      const messages =\n+â”Š  â”Š48â”Š        chat.messages\n+â”Š  â”Š49â”Š          .filter((message: Message) => message.holderIds.includes(currentUser))\n+â”Š  â”Š50â”Š          .sort((a: Message, b: Message) => b.createdAt - a.createdAt) || []\n+â”Š  â”Š51â”Š      return (amount ? messages.slice(0, amount) : messages).reverse()\n+â”Š  â”Š52â”Š    },\n+â”Š  â”Š53â”Š    unreadMessages: (chat) =>\n+â”Š  â”Š54â”Š      chat.messages.filter(\n+â”Š  â”Š55â”Š        (message: Message) =>\n+â”Š  â”Š56â”Š          message.holderIds.includes(currentUser) &&\n+â”Š  â”Š57â”Š          message.recipients.find(\n+â”Š  â”Š58â”Š            (recipient: Recipient) => recipient.userId === currentUser && !recipient.readAt\n+â”Š  â”Š59â”Š          )\n+â”Š  â”Š60â”Š      ).length,\n+â”Š  â”Š61â”Š    lastMessage: (chat) => chat.messages[chat.messages.length - 1],\n+â”Š  â”Š62â”Š    isGroup: (chat) => !!chat.name,\n+â”Š  â”Š63â”Š  },\n+â”Š  â”Š64â”Š  Message: {\n+â”Š  â”Š65â”Š    chat: (message) =>\n+â”Š  â”Š66â”Š      chats.find(chat => message.chatId === chat.id) || null,\n+â”Š  â”Š67â”Š    sender: (message) =>\n+â”Š  â”Š68â”Š      users.find(user => user.id === message.senderId) || null,\n+â”Š  â”Š69â”Š    holders: (message) =>\n+â”Š  â”Š70â”Š      users.filter(user => message.holderIds.includes(user.id)),\n+â”Š  â”Š71â”Š    ownership: (message) => message.senderId === currentUser,\n+â”Š  â”Š72â”Š  },\n+â”Š  â”Š73â”Š  Recipient: {\n+â”Š  â”Š74â”Š    user: (recipient) =>\n+â”Š  â”Š75â”Š      users.find(user => recipient.userId === user.id) || null,\n+â”Š  â”Š76â”Š    message: (recipient) => {\n+â”Š  â”Š77â”Š      const chat = chats.find(chat => recipient.chatId === chat.id)\n+â”Š  â”Š78â”Š      return chat ? chat.messages.find(message => recipient.messageId === message.id) || null : null\n+â”Š  â”Š79â”Š    },\n+â”Š  â”Š80â”Š    chat: (recipient) =>\n+â”Š  â”Š81â”Š      chats.find(chat => recipient.chatId === chat.id) || null,\n+â”Š  â”Š82â”Š  },\n+â”Š  â”Š83â”Š} as IResolvers as IApolloResolvers\n```\n\n##### Changed schema&#x2F;typeDefs.ts\n```diff\n@@ -1,9 +1,54 @@\n â”Š 1â”Š 1â”Šexport default `\n+â”Š  â”Š 2â”Š  scalar Date\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Š  type Query {\n+â”Š  â”Š 5â”Š    users: [User!]\n+â”Š  â”Š 6â”Š    chats: [Chat!]\n+â”Š  â”Š 7â”Š    chat(chatId: ID!): Chat\n+â”Š  â”Š 8â”Š  }\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Š  enum MessageType {\n+â”Š  â”Š11â”Š    LOCATION\n+â”Š  â”Š12â”Š    TEXT\n+â”Š  â”Š13â”Š    PICTURE\n+â”Š  â”Š14â”Š  }\n+â”Š  â”Š15â”Š\n â”Š 2â”Š16â”Š  type Chat {\n+â”Š  â”Š17â”Š    #May be a chat or a group\n â”Š 3â”Š18â”Š    id: ID!\n+â”Š  â”Š19â”Š    #Computed for chats\n+â”Š  â”Š20â”Š    name: String\n+â”Š  â”Š21â”Š    updatedAt: Date\n+â”Š  â”Š22â”Š    #Computed for chats\n+â”Š  â”Š23â”Š    picture: String\n+â”Š  â”Š24â”Š    #All members, current and past ones.\n+â”Š  â”Š25â”Š    allTimeMembers: [User!]!\n+â”Š  â”Š26â”Š    #Whoever gets the chat listed. For groups includes past members who still didn't delete the group.\n+â”Š  â”Š27â”Š    listingMembers: [User!]!\n+â”Š  â”Š28â”Š    #If null the group is read-only. Null for chats.\n+â”Š  â”Š29â”Š    owner: User\n+â”Š  â”Š30â”Š    messages(amount: Int): [Message]!\n+â”Š  â”Š31â”Š    lastMessage: Message\n â”Š 4â”Š32â”Š  }\n â”Š 5â”Š33â”Š\n-â”Š 6â”Š  â”Š  type Query {\n-â”Š 7â”Š  â”Š    chats: [Chat!]!\n+â”Š  â”Š34â”Š  type Message {\n+â”Š  â”Š35â”Š    id: ID!\n+â”Š  â”Š36â”Š    sender: User!\n+â”Š  â”Š37â”Š    chat: Chat!\n+â”Š  â”Š38â”Š    content: String!\n+â”Š  â”Š39â”Š    createdAt: Date!\n+â”Š  â”Š40â”Š    #FIXME: should return MessageType\n+â”Š  â”Š41â”Š    type: Int!\n+â”Š  â”Š42â”Š    #Whoever still holds a copy of the message. Cannot be null because the message gets deleted otherwise\n+â”Š  â”Š43â”Š    holders: [User!]!\n+â”Š  â”Š44â”Š    #Computed property\n+â”Š  â”Š45â”Š    ownership: Boolean!\n+â”Š  â”Š46â”Š  }\n+â”Š  â”Š47â”Š\n+â”Š  â”Š48â”Š  type User {\n+â”Š  â”Š49â”Š    id: ID!\n+â”Š  â”Š50â”Š    name: String\n+â”Š  â”Š51â”Š    picture: String\n+â”Š  â”Š52â”Š    phone: String\n â”Š 8â”Š53â”Š  }\n â”Š 9â”Š54â”Š`\n```\n\n[}]: #\n\nAs you can see, we've added an `entity` folder which treats each entity independently. This will server us greatly is the new future when we will connect each entity to a database. The GraphQL resolvers are the \"projectors\" of the data stored in the fake DB, and they will serve it based on their implementation and provided parameters.\n\nNow, let's make the necessary modifications to our client so it can work alongside the server and show the data that it contains. Similarly to the server, we don't wanna maintain a TypeScript code base for our GraphQL documents, therefore we will install Codegen for the client as well. Let's install the necessary NPM packages:\n\n    $ yarn add -D graphql-code-generator@0.16.1 graphql-codegen-typescript-client@0.16.1 graphql-codegen-typescript-common@0.16.1\n\nWrite a Codegen config:\n\n[{]: <helper> (diffStep 1.4 files=\"codegen.yml, codegen-interpreter.ts\" module=\"client\")\n\n#### [Step 1.4: Setup codegen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/16bdab6)\n\n##### Added codegen-interpreter.ts\n```diff\n@@ -0,0 +1,6 @@\n+â”Š â”Š1â”Šrequire('ts-node').register({\n+â”Š â”Š2â”Š  transpileOnly: true,\n+â”Š â”Š3â”Š  compilerOptions: {\n+â”Š â”Š4â”Š    module: 'commonjs'\n+â”Š â”Š5â”Š  }\n+â”Š â”Š6â”Š})\n```\n\n##### Added codegen.yml\n```diff\n@@ -0,0 +1,12 @@\n+â”Š  â”Š 1â”Šschema: ../WhatsApp-Clone-Server/schema/typeDefs.ts\n+â”Š  â”Š 2â”Šdocuments:\n+â”Š  â”Š 3â”Š  - ./src/**/*.tsx\n+â”Š  â”Š 4â”Š  - ./src/**/*.ts\n+â”Š  â”Š 5â”Šoverwrite: true\n+â”Š  â”Š 6â”Šrequire:\n+â”Š  â”Š 7â”Š  - ts-node/../../codegen-interpreter.ts\n+â”Š  â”Š 8â”Šgenerates:\n+â”Š  â”Š 9â”Š  ./src/graphql/types.ts:\n+â”Š  â”Š10â”Š    plugins:\n+â”Š  â”Š11â”Š      - typescript-common\n+â”Š  â”Š12â”Š      - typescript-client\n```\n\n[}]: #\n\nAnd define `.gitignore` rules that will not include generated files in our git project:\n\n[{]: <helper> (diffStep 1.4 files=\"src/graphql/.gitignore\" module=\"client\")\n\n#### [Step 1.4: Setup codegen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/16bdab6)\n\n##### Added src&#x2F;graphql&#x2F;.gitignore\n```diff\n@@ -0,0 +1,2 @@\n+â”Š â”Š1â”Šintrospection.json\n+â”Š â”Š2â”Štypes.ts\n```\n\n[}]: #\n\nFew things you should note:\n\n- Our `codegen.yml` config references directly to the schema file in our server, which means that the server should be cloned alongside the client. Codegen also supports providing a REST endpoint, but if possible it's better to avoid it because this way you don't need to provide credentials. Indeed, the plan is to have an authentication mechanism to guard our GraphQL REST endpoint.\n- The `codegen-interpreter.ts` file is necessary because it extends the `tsconfig.json` file without us actually changing it. If you'll try to edit the `tsconfig.json` file directly, then `react-scripts` will change it back to its original form.\n\nWe will also add the necessary scripts to our `pacakge.json` so we can run `code-gen`:\n\n```json\n{\n  \"start\": \"concurrently \\\"yarn generate:watch\\\" \\\"react-scripts start\\\"\",\n  \"generate\": \"gql-gen\",\n  \"generate:watch\": \"nodemon --exec yarn generate -e graphql\"\n}\n```\n\nBe sure to install `concurrently` and `nodemon` so the scripts can work as intended:\n\n    $ yarn add -D nodemon@1.18.9 ts-node@8.0.2 concurrently@4.1.0\n\nAt this point our `package.json` file should look like this:\n\n[{]: <helper> (diffStep 1.4 files=\"package.json\" module=\"client\")\n\n#### [Step 1.4: Setup codegen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/16bdab6)\n\n##### Changed package.json\n```diff\n@@ -22,13 +22,21 @@\n â”Š22â”Š22â”Š  },\n â”Š23â”Š23â”Š  \"devDependencies\": {\n â”Š24â”Š24â”Š    \"@types/graphql\": \"14.0.7\",\n-â”Š25â”Š  â”Š    \"@types/node\": \"11.9.4\"\n+â”Š  â”Š25â”Š    \"@types/node\": \"11.9.4\",\n+â”Š  â”Š26â”Š    \"concurrently\": \"4.1.0\",\n+â”Š  â”Š27â”Š    \"graphql-code-generator\": \"0.16.1\",\n+â”Š  â”Š28â”Š    \"graphql-codegen-typescript-client\": \"0.16.1\",\n+â”Š  â”Š29â”Š    \"graphql-codegen-typescript-common\": \"0.16.1\",\n+â”Š  â”Š30â”Š    \"nodemon\": \"1.18.10\",\n+â”Š  â”Š31â”Š    \"ts-node\": \"8.0.2\"\n â”Š26â”Š32â”Š  },\n â”Š27â”Š33â”Š  \"scripts\": {\n-â”Š28â”Š  â”Š    \"start\": \"react-scripts start\",\n+â”Š  â”Š34â”Š    \"start\": \"concurrently \\\"yarn generate:watch\\\" \\\"react-scripts start\\\"\",\n â”Š29â”Š35â”Š    \"build\": \"react-scripts build\",\n â”Š30â”Š36â”Š    \"test\": \"react-scripts test\",\n-â”Š31â”Š  â”Š    \"eject\": \"react-scripts eject\"\n+â”Š  â”Š37â”Š    \"eject\": \"react-scripts eject\",\n+â”Š  â”Š38â”Š    \"generate\": \"gql-gen\",\n+â”Š  â”Š39â”Š    \"generate:watch\": \"nodemon --exec yarn generate -e graphql\"\n â”Š32â”Š40â”Š  },\n â”Š33â”Š41â”Š  \"eslintConfig\": {\n â”Š34â”Š42â”Š    \"extends\": \"react-app\"\n```\n\n[}]: #\n\nNow whenever we would like to generate some TypeScript definitions we can simply run:\n\n    $ yarn generate\n\nAlternatively we can just start the app on watch mode with `$ yarn start` and the Codegen should be listening for changes as well.\n\n    $ yarn start\n\nNow let's build a dashboard that will show all the chats in the server. Rather than implementing all the components and stylesheets from scratch, we will be using [`material-ui`](https://material-ui.com/) (aka Material). Material comes with pre-made components which are highly functional and work smooth with animations. To set it up we will first install it:\n\n    $ yarn add @material-ui/core@3.9.2 @material-ui/icons@3.0.2\n\nAnd then we will initialize it with the right theme values:\n\n[{]: <helper> (diffStep 1.5 files=\"src/index.tsx\" module=\"client\")\n\n#### [Step 1.5: Setup theme](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/f593fc3)\n\n##### Changed src&#x2F;index.tsx\n```diff\n@@ -1,3 +1,4 @@\n+â”Š â”Š1â”Šimport { MuiThemeProvider, createMuiTheme } from '@material-ui/core/styles'\n â”Š1â”Š2â”Šimport React from 'react';\n â”Š2â”Š3â”Šimport ReactDOM from 'react-dom';\n â”Š3â”Š4â”Šimport { ApolloProvider } from 'react-apollo-hooks';\n```\n```diff\n@@ -6,10 +7,22 @@\n â”Š 6â”Š 7â”Šimport apolloClient from './apollo-client'\n â”Š 7â”Š 8â”Šimport * as serviceWorker from './serviceWorker';\n â”Š 8â”Š 9â”Š\n+â”Š  â”Š10â”Šconst theme = createMuiTheme({\n+â”Š  â”Š11â”Š  palette: {\n+â”Š  â”Š12â”Š    primary: { main: '#2c6157' },\n+â”Š  â”Š13â”Š    secondary: { main: '#6fd056' },\n+â”Š  â”Š14â”Š  },\n+â”Š  â”Š15â”Š  typography: {\n+â”Š  â”Š16â”Š    useNextVariants: true,\n+â”Š  â”Š17â”Š  },\n+â”Š  â”Š18â”Š})\n+â”Š  â”Š19â”Š\n â”Š 9â”Š20â”ŠReactDOM.render(\n-â”Š10â”Š  â”Š  <ApolloProvider client={apolloClient}>\n-â”Š11â”Š  â”Š    <App />\n-â”Š12â”Š  â”Š  </ApolloProvider>\n+â”Š  â”Š21â”Š  <MuiThemeProvider theme={theme}>\n+â”Š  â”Š22â”Š    <ApolloProvider client={apolloClient}>\n+â”Š  â”Š23â”Š      <App />\n+â”Š  â”Š24â”Š    </ApolloProvider>\n+â”Š  â”Š25â”Š  </MuiThemeProvider>\n â”Š13â”Š26â”Š, document.getElementById('root'));\n â”Š14â”Š27â”Š\n â”Š15â”Š28â”Š// If you want your app to work offline and load faster, you can change\n```\n\n[}]: #\n\nThe theme values represent the main colors in our app. If you're familiar with WhatsApp, you know that its main colors consist mostly of Green and White. The theme values will automatically give Material components the desired style.\n\nWe will also make sure that the same values are available in our CSS stylesheet so we can use it outside Material's scope:\n\n[{]: <helper> (diffStep 1.5 files=\"src/index.css\" module=\"client\")\n\n#### [Step 1.5: Setup theme](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/f593fc3)\n\n##### Changed src&#x2F;index.css\n```diff\n@@ -1,3 +1,10 @@\n+â”Š  â”Š 1â”Š:root {\n+â”Š  â”Š 2â”Š  --primary-bg: #2c6157;\n+â”Š  â”Š 3â”Š  --secondary-bg: #6fd056;\n+â”Š  â”Š 4â”Š  --primary-text: white;\n+â”Š  â”Š 5â”Š  --secondary-text: white;\n+â”Š  â”Š 6â”Š}\n+â”Š  â”Š 7â”Š\n â”Š 1â”Š 8â”Šbody {\n â”Š 2â”Š 9â”Š  margin: 0;\n â”Š 3â”Š10â”Š  padding: 0;\n```\n\n[}]: #\n\nNow we're ready to start implementing the view itself. The logic is very simple, we will use a query to fetch the chats from our back-end. Accordingly we will need to define the right [GraphQL fragments](https://www.apollographql.com/docs/react/advanced/fragments.html) so we can use them to build the query. In short, a fragment is used to represent an entity in our app. **It doesn't necessarily has to represent a type**, but indeed it's the most common use case:\n\n[{]: <helper> (diffStep 1.6 files=\"src/graphql/fragments\" module=\"client\")\n\n#### [Step 1.6: Add ChatsListScreen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/61e1047)\n\n##### Added src&#x2F;graphql&#x2F;fragments&#x2F;chat.fragment.ts\n```diff\n@@ -0,0 +1,22 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag'\n+â”Š  â”Š 2â”Šimport message from './message.fragment'\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šexport default gql `\n+â”Š  â”Š 5â”Š  fragment Chat on Chat {\n+â”Š  â”Š 6â”Š    id\n+â”Š  â”Š 7â”Š    name\n+â”Š  â”Š 8â”Š    picture\n+â”Š  â”Š 9â”Š    allTimeMembers {\n+â”Š  â”Š10â”Š      id\n+â”Š  â”Š11â”Š      name\n+â”Š  â”Š12â”Š      picture\n+â”Š  â”Š13â”Š    }\n+â”Š  â”Š14â”Š    owner {\n+â”Š  â”Š15â”Š      id\n+â”Š  â”Š16â”Š    }\n+â”Š  â”Š17â”Š    lastMessage {\n+â”Š  â”Š18â”Š      ...Message\n+â”Š  â”Š19â”Š    }\n+â”Š  â”Š20â”Š  }\n+â”Š  â”Š21â”Š  ${message}\n+â”Š  â”Š22â”Š`\n```\n\n##### Added src&#x2F;graphql&#x2F;fragments&#x2F;index.ts\n```diff\n@@ -0,0 +1,2 @@\n+â”Š â”Š1â”Šexport { default as chat } from './chat.fragment'\n+â”Š â”Š2â”Šexport { default as message } from './message.fragment'\n```\n\n##### Added src&#x2F;graphql&#x2F;fragments&#x2F;message.fragment.ts\n```diff\n@@ -0,0 +1,33 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag'\n+â”Š  â”Š 2â”Š\n+â”Š  â”Š 3â”Šexport default gql`\n+â”Š  â”Š 4â”Š  fragment Message on Message {\n+â”Š  â”Š 5â”Š    id\n+â”Š  â”Š 6â”Š    chat {\n+â”Š  â”Š 7â”Š      id\n+â”Š  â”Š 8â”Š    }\n+â”Š  â”Š 9â”Š    sender {\n+â”Š  â”Š10â”Š      id\n+â”Š  â”Š11â”Š      name\n+â”Š  â”Š12â”Š    }\n+â”Š  â”Š13â”Š    content\n+â”Š  â”Š14â”Š    createdAt\n+â”Š  â”Š15â”Š    recipients {\n+â”Š  â”Š16â”Š      user {\n+â”Š  â”Š17â”Š        id\n+â”Š  â”Š18â”Š      }\n+â”Š  â”Š19â”Š      message {\n+â”Š  â”Š20â”Š        id\n+â”Š  â”Š21â”Š        chat {\n+â”Š  â”Š22â”Š          id\n+â”Š  â”Š23â”Š        }\n+â”Š  â”Š24â”Š      }\n+â”Š  â”Š25â”Š      chat {\n+â”Š  â”Š26â”Š        id\n+â”Š  â”Š27â”Š      }\n+â”Š  â”Š28â”Š      receivedAt\n+â”Š  â”Š29â”Š      readAt\n+â”Š  â”Š30â”Š    }\n+â”Š  â”Š31â”Š    ownership\n+â”Š  â”Š32â”Š  }\n+â”Š  â”Š33â”Š`\n```\n\n[}]: #\n\nLet's move on to implementing the components. The layout is simple and consists of a navigation bar and a chats list. There are few important details you should note about the components:\n\n- They use [Material's](https://material-ui.com) pre-made components and icons, which are styled and highly functional right out of the box.\n- Instead of using CSS to style our components we use [`styled-components`](https://www.styled-components.com/). This way we can encapsulate the style and it will live right next to the component.\n- We will use [`react-apollo-hooks`](https://github.com/trojanowski/react-apollo-hooks) to connect our Apollo client with our React components. **This library is experimental and shouldn't be used in production yet**.\n\n[{]: <helper> (diffStep 1.6 files=\"src/components\" module=\"client\")\n\n#### [Step 1.6: Add ChatsListScreen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/61e1047)\n\n##### Added src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -0,0 +1,108 @@\n+â”Š   â”Š  1â”Šimport List from '@material-ui/core/List'\n+â”Š   â”Š  2â”Šimport ListItem from '@material-ui/core/ListItem'\n+â”Š   â”Š  3â”Šimport gql from 'graphql-tag'\n+â”Š   â”Š  4â”Šimport * as moment from 'moment'\n+â”Š   â”Š  5â”Šimport * as React from 'react'\n+â”Š   â”Š  6â”Šimport { useQuery } from 'react-apollo-hooks'\n+â”Š   â”Š  7â”Šimport * as ReactDOM from 'react-dom'\n+â”Š   â”Š  8â”Šimport styled from 'styled-components'\n+â”Š   â”Š  9â”Šimport * as fragments from '../../graphql/fragments'\n+â”Š   â”Š 10â”Šimport { ChatsListQuery } from '../../graphql/types'\n+â”Š   â”Š 11â”Š\n+â”Š   â”Š 12â”Šconst Style = styled.div`\n+â”Š   â”Š 13â”Š  height: calc(100% - 56px);\n+â”Š   â”Š 14â”Š  overflow-y: overlay;\n+â”Š   â”Š 15â”Š\n+â”Š   â”Š 16â”Š  .ChatsList-chats-list {\n+â”Š   â”Š 17â”Š    padding: 0;\n+â”Š   â”Š 18â”Š  }\n+â”Š   â”Š 19â”Š\n+â”Š   â”Š 20â”Š  .ChatsList-chat-item {\n+â”Š   â”Š 21â”Š    height: 76px;\n+â”Š   â”Š 22â”Š    padding: 0 15px;\n+â”Š   â”Š 23â”Š    display: flex;\n+â”Š   â”Š 24â”Š  }\n+â”Š   â”Š 25â”Š\n+â”Š   â”Š 26â”Š  .ChatsList-profile-pic {\n+â”Š   â”Š 27â”Š    height: 50px;\n+â”Š   â”Š 28â”Š    width: 50px;\n+â”Š   â”Š 29â”Š    object-fit: cover;\n+â”Š   â”Š 30â”Š    border-radius: 50%;\n+â”Š   â”Š 31â”Š  }\n+â”Š   â”Š 32â”Š\n+â”Š   â”Š 33â”Š  .ChatsList-info {\n+â”Š   â”Š 34â”Š    width: calc(100% - 60px);\n+â”Š   â”Š 35â”Š    height: calc(100% - 30px);\n+â”Š   â”Š 36â”Š    padding: 15px 0;\n+â”Š   â”Š 37â”Š    margin-left: 10px;\n+â”Š   â”Š 38â”Š    border-bottom: 0.5px solid silver;\n+â”Š   â”Š 39â”Š    position: relative;\n+â”Š   â”Š 40â”Š  }\n+â”Š   â”Š 41â”Š\n+â”Š   â”Š 42â”Š  .ChatsList-name {\n+â”Š   â”Š 43â”Š    margin-top: 5px;\n+â”Š   â”Š 44â”Š  }\n+â”Š   â”Š 45â”Š\n+â”Š   â”Š 46â”Š  .ChatsList-last-message {\n+â”Š   â”Š 47â”Š    color: gray;\n+â”Š   â”Š 48â”Š    font-size: 15px;\n+â”Š   â”Š 49â”Š    margin-top: 5px;\n+â”Š   â”Š 50â”Š    text-overflow: ellipsis;\n+â”Š   â”Š 51â”Š    overflow: hidden;\n+â”Š   â”Š 52â”Š    white-space: nowrap;\n+â”Š   â”Š 53â”Š  }\n+â”Š   â”Š 54â”Š\n+â”Š   â”Š 55â”Š  .ChatsList-timestamp {\n+â”Š   â”Š 56â”Š    position: absolute;\n+â”Š   â”Š 57â”Š    color: gray;\n+â”Š   â”Š 58â”Š    top: 20px;\n+â”Š   â”Š 59â”Š    right: 0;\n+â”Š   â”Š 60â”Š    font-size: 13px;\n+â”Š   â”Š 61â”Š  }\n+â”Š   â”Š 62â”Š`\n+â”Š   â”Š 63â”Š\n+â”Š   â”Š 64â”Šconst query = gql`\n+â”Š   â”Š 65â”Š  query ChatsListQuery {\n+â”Š   â”Š 66â”Š    chats {\n+â”Š   â”Š 67â”Š      ...Chat\n+â”Š   â”Š 68â”Š    }\n+â”Š   â”Š 69â”Š  }\n+â”Š   â”Š 70â”Š\n+â”Š   â”Š 71â”Š  ${fragments.chat}\n+â”Š   â”Š 72â”Š`\n+â”Š   â”Š 73â”Š\n+â”Š   â”Š 74â”Šexport default () => {\n+â”Š   â”Š 75â”Š  const {\n+â”Š   â”Š 76â”Š    data: { chats },\n+â”Š   â”Š 77â”Š  } = useQuery<ChatsListQuery.Query>(query, { suspend: true })\n+â”Š   â”Š 78â”Š\n+â”Š   â”Š 79â”Š  return (\n+â”Š   â”Š 80â”Š    <Style className=\"ChatsList\">\n+â”Š   â”Š 81â”Š      <List className=\"ChatsList-chats-list\">\n+â”Š   â”Š 82â”Š        {chats.map(chat => (\n+â”Š   â”Š 83â”Š          <ListItem\n+â”Š   â”Š 84â”Š            key={chat.id}\n+â”Š   â”Š 85â”Š            className=\"ChatsList-chat-item\"\n+â”Š   â”Š 86â”Š            button\n+â”Š   â”Š 87â”Š          >\n+â”Š   â”Š 88â”Š            <img\n+â”Š   â”Š 89â”Š              className=\"ChatsList-profile-pic\"\n+â”Š   â”Š 90â”Š              src={chat.picture || '/assets/default-profile-pic.jpg'}\n+â”Š   â”Š 91â”Š            />\n+â”Š   â”Š 92â”Š            <div className=\"ChatsList-info\">\n+â”Š   â”Š 93â”Š              <div className=\"ChatsList-name\">{chat.name}</div>\n+â”Š   â”Š 94â”Š              {chat.lastMessage && (\n+â”Š   â”Š 95â”Š                <React.Fragment>\n+â”Š   â”Š 96â”Š                  <div className=\"ChatsList-last-message\">{chat.lastMessage.content}</div>\n+â”Š   â”Š 97â”Š                  <div className=\"ChatsList-timestamp\">\n+â”Š   â”Š 98â”Š                    {moment(chat.lastMessage.createdAt).format('HH:mm')}\n+â”Š   â”Š 99â”Š                  </div>\n+â”Š   â”Š100â”Š                </React.Fragment>\n+â”Š   â”Š101â”Š              )}\n+â”Š   â”Š102â”Š            </div>\n+â”Š   â”Š103â”Š          </ListItem>\n+â”Š   â”Š104â”Š        ))}\n+â”Š   â”Š105â”Š      </List>\n+â”Š   â”Š106â”Š    </Style>\n+â”Š   â”Š107â”Š  )\n+â”Š   â”Š108â”Š}\n```\n\n##### Added src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsNavbar.tsx\n```diff\n@@ -0,0 +1,14 @@\n+â”Š  â”Š 1â”Šimport * as React from 'react'\n+â”Š  â”Š 2â”Šimport styled from 'styled-components'\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šconst Style = styled.div`\n+â”Š  â”Š 5â”Š  .ChatsNavbar-title {\n+â”Š  â”Š 6â”Š    float: left;\n+â”Š  â”Š 7â”Š  }\n+â”Š  â”Š 8â”Š`\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Šexport default () => (\n+â”Š  â”Š11â”Š  <Style className=\"ChatsNavbar\">\n+â”Š  â”Š12â”Š    <span className=\"ChatsNavbar-title\">WhatsApp Clone</span>\n+â”Š  â”Š13â”Š  </Style>\n+â”Š  â”Š14â”Š)\n```\n\n##### Added src&#x2F;components&#x2F;ChatsListScreen&#x2F;index.tsx\n```diff\n@@ -0,0 +1,16 @@\n+â”Š  â”Š 1â”Šimport * as React from 'react'\n+â”Š  â”Š 2â”Šimport { Suspense } from 'react'\n+â”Š  â”Š 3â”Šimport Navbar from '../Navbar'\n+â”Š  â”Š 4â”Šimport ChatsList from './ChatsList'\n+â”Š  â”Š 5â”Šimport ChatsNavbar from './ChatsNavbar'\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Šexport default () => (\n+â”Š  â”Š 8â”Š  <div className=\"ChatsListScreen Screen\">\n+â”Š  â”Š 9â”Š    <Navbar>\n+â”Š  â”Š10â”Š      <ChatsNavbar />\n+â”Š  â”Š11â”Š    </Navbar>\n+â”Š  â”Š12â”Š    <Suspense fallback={null}>\n+â”Š  â”Š13â”Š      <ChatsList />\n+â”Š  â”Š14â”Š    </Suspense>\n+â”Š  â”Š15â”Š  </div>\n+â”Š  â”Š16â”Š)\n```\n\n##### Added src&#x2F;components&#x2F;Navbar.tsx\n```diff\n@@ -0,0 +1,24 @@\n+â”Š  â”Š 1â”Šimport Toolbar from '@material-ui/core/Toolbar'\n+â”Š  â”Š 2â”Šimport * as React from 'react'\n+â”Š  â”Š 3â”Šimport styled from 'styled-components'\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šconst Style = styled(Toolbar)`\n+â”Š  â”Š 6â”Š  background-color: var(--primary-bg);\n+â”Š  â”Š 7â”Š  color: var(--primary-text);\n+â”Š  â”Š 8â”Š  font-size: 20px;\n+â”Š  â”Š 9â”Š  line-height: 40px;\n+â”Š  â”Š10â”Š\n+â”Š  â”Š11â”Š  .Navbar-body {\n+â”Š  â”Š12â”Š    width: 100%;\n+â”Š  â”Š13â”Š  }\n+â”Š  â”Š14â”Š`\n+â”Š  â”Š15â”Š\n+â”Š  â”Š16â”Šinterface NavbarProps {\n+â”Š  â”Š17â”Š  children: any\n+â”Š  â”Š18â”Š}\n+â”Š  â”Š19â”Š\n+â”Š  â”Š20â”Šexport default ({ children }: NavbarProps) => (\n+â”Š  â”Š21â”Š  <Style className=\"Navbar\">\n+â”Š  â”Š22â”Š    <div className=\"Navbar-body\">{children}</div>\n+â”Š  â”Š23â”Š  </Style>\n+â”Š  â”Š24â”Š)\n```\n\n[}]: #\n\nLet's install the missing dependencies:\n\n    $ yarn add -D @types/moment@2.13.0\n    $ yarn add graphql-tag@2.10.1 moment@2.24.0 subscriptions-transport-ws@0.9.15 styled-components@4.1.3\n\nAnd add a default profile picture to our assets directory under `public/assets/default-profile-pic.jpg`:\n\n![default-profile-pic.jpg](https://user-images.githubusercontent.com/7648874/51983273-38229280-24d3-11e9-98bd-363764dc6d97.jpg)\n\nThe chats which are currently served by the server already have a picture, but it's not uncommon to have a chat without any picture in our app.\n\nLastly, in order to make the list that we've just created visible, we will mount it at the main app component:\n\n[{]: <helper> (diffStep 1.6 files=\"src/App.tsx\" module=\"client\")\n\n#### [Step 1.6: Add ChatsListScreen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/61e1047)\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -1,25 +1,11 @@\n â”Š 1â”Š 1â”Šimport React, { Component } from 'react';\n-â”Š 2â”Š  â”Šimport logo from './logo.svg';\n-â”Š 3â”Š  â”Šimport './App.css';\n+â”Š  â”Š 2â”Šimport ChatsListScreen from './components/ChatsListScreen'\n â”Š 4â”Š 3â”Š\n â”Š 5â”Š 4â”Šclass App extends Component {\n â”Š 6â”Š 5â”Š  render() {\n â”Š 7â”Š 6â”Š    return (\n â”Š 8â”Š 7â”Š      <div className=\"App\">\n-â”Š 9â”Š  â”Š        <header className=\"App-header\">\n-â”Š10â”Š  â”Š          <img src={logo} className=\"App-logo\" alt=\"logo\" />\n-â”Š11â”Š  â”Š          <p>\n-â”Š12â”Š  â”Š            Edit <code>src/App.js</code> and save to reload.\n-â”Š13â”Š  â”Š          </p>\n-â”Š14â”Š  â”Š          <a\n-â”Š15â”Š  â”Š            className=\"App-link\"\n-â”Š16â”Š  â”Š            href=\"https://reactjs.org\"\n-â”Š17â”Š  â”Š            target=\"_blank\"\n-â”Š18â”Š  â”Š            rel=\"noopener noreferrer\"\n-â”Š19â”Š  â”Š          >\n-â”Š20â”Š  â”Š            Learn React\n-â”Š21â”Š  â”Š          </a>\n-â”Š22â”Š  â”Š        </header>\n+â”Š  â”Š 8â”Š        <ChatsListScreen />\n â”Š23â”Š 9â”Š      </div>\n â”Š24â”Š10â”Š    );\n â”Š25â”Š11â”Š  }\n```\n\n[}]: #\n\nNow we should be able to see the chats in the React app! We can test it out by running\n\n    # terminal 1\n    server$ yarn generate\n    server$ yarn start\n    # terminal 2\n    client$ yarn generate\n    client$ yarn start\n\nEverything works, but it's not over yet. Our application can't be based on a served hard-coded JSON. A real app has a database. There are many advantages for using a database over an in-memory or FS stored data:\n\n- It is VERY fast, and can deal with large amounts of data.\n- Data fetching can be optimized by defining indexes.\n- You need the right read/write permissions which makes it very secure.\n- Data will persist even if the server crashes or the machine is randomly closed.\n- A lot more...\n\nWe will be using [PostgreSQL](https://www.postgresql.org/) (Postgres, in short) as our database with [TypeORM](https://github.com/typeorm/typeorm) as an ORM around Postgres. First make sure that you install Postgres on your machine by following the [official installation instructions](https://www.labkey.org/Documentation/wiki-page.view?name=commonInstall).\n\nTo make sure the whole shebang works with Node.JS, we will install few packages:\n\n    $ yarn add pg@7.8.0 typeorm@0.2.11 reflect-metadata@0.1.12\n    $ yarn add -D @types/pg@7.4.11\n\n> The [`reflect-metadata`](https://www.npmjs.com/package/reflect-metadata) package will emit metadata for JavaScript [decorators](https://github.com/tc39/proposal-decorators). This will be used internally by TypeORM to determine column types based on their corresponding TypeScript type.\n\nThis would require us to set some configuration so TypeORM would know where and how to connect the DB. We will use the `whatsapp` DB with the `test` username:\n\n[{]: <helper> (diffStep 1.5 files=\"ormconfig.json, index.ts\" module=\"server\")\n\n#### Step 1.5: Setup TypeORM\n\n##### Changed index.ts\n```diff\n@@ -4,27 +4,33 @@\n â”Š 4â”Š 4â”Šimport express from 'express'\n â”Š 5â”Š 5â”Šimport gql from 'graphql-tag'\n â”Š 6â”Š 6â”Šimport { createServer } from 'http'\n+â”Š  â”Š 7â”Šimport { createConnection } from 'typeorm'\n â”Š 7â”Š 8â”Šimport schema from './schema'\n â”Š 8â”Š 9â”Š\n â”Š 9â”Š10â”Šconst PORT = 4000\n â”Š10â”Š11â”Š\n-â”Š11â”Š  â”Šconst app = express()\n+â”Š  â”Š12â”ŠcreateConnection().then((connection) => {\n+â”Š  â”Š13â”Š  const app = express()\n â”Š12â”Š14â”Š\n-â”Š13â”Š  â”Šapp.use(cors())\n-â”Š14â”Š  â”Šapp.use(bodyParser.json())\n+â”Š  â”Š15â”Š  app.use(cors())\n+â”Š  â”Š16â”Š  app.use(bodyParser.json())\n â”Š15â”Š17â”Š\n-â”Š16â”Š  â”Šconst apollo = new ApolloServer({ schema })\n+â”Š  â”Š18â”Š  const apollo = new ApolloServer({\n+â”Š  â”Š19â”Š    schema,\n+â”Š  â”Š20â”Š    context: () => ({ connection }),\n+â”Š  â”Š21â”Š  })\n â”Š17â”Š22â”Š\n-â”Š18â”Š  â”Šapollo.applyMiddleware({\n-â”Š19â”Š  â”Š  app,\n-â”Š20â”Š  â”Š  path: '/graphql',\n-â”Š21â”Š  â”Š})\n+â”Š  â”Š23â”Š  apollo.applyMiddleware({\n+â”Š  â”Š24â”Š    app,\n+â”Š  â”Š25â”Š    path: '/graphql',\n+â”Š  â”Š26â”Š  })\n â”Š22â”Š27â”Š\n-â”Š23â”Š  â”Š// Wrap the Express server\n-â”Š24â”Š  â”Šconst ws = createServer(app)\n+â”Š  â”Š28â”Š  // Wrap the Express server\n+â”Š  â”Š29â”Š  const ws = createServer(app)\n â”Š25â”Š30â”Š\n-â”Š26â”Š  â”Šapollo.installSubscriptionHandlers(ws)\n+â”Š  â”Š31â”Š  apollo.installSubscriptionHandlers(ws)\n â”Š27â”Š32â”Š\n-â”Š28â”Š  â”Šws.listen(PORT, () => {\n-â”Š29â”Š  â”Š  console.log(`Apollo Server is now running on http://localhost:${PORT}`)\n+â”Š  â”Š33â”Š  ws.listen(PORT, () => {\n+â”Š  â”Š34â”Š    console.log(`Apollo Server is now running on http://localhost:${PORT}`)\n+â”Š  â”Š35â”Š  })\n â”Š30â”Š36â”Š})\n```\n\n##### Added ormconfig.json\n```diff\n@@ -0,0 +1,24 @@\n+â”Š  â”Š 1â”Š{\n+â”Š  â”Š 2â”Š   \"type\": \"postgres\",\n+â”Š  â”Š 3â”Š   \"host\": \"localhost\",\n+â”Š  â”Š 4â”Š   \"port\": 5432,\n+â”Š  â”Š 5â”Š   \"username\": \"test\",\n+â”Š  â”Š 6â”Š   \"password\": \"test\",\n+â”Š  â”Š 7â”Š   \"database\": \"whatsapp\",\n+â”Š  â”Š 8â”Š   \"synchronize\": true,\n+â”Š  â”Š 9â”Š   \"logging\": false,\n+â”Š  â”Š10â”Š   \"entities\": [\n+â”Š  â”Š11â”Š      \"entity/**/*.ts\"\n+â”Š  â”Š12â”Š   ],\n+â”Š  â”Š13â”Š   \"migrations\": [\n+â”Š  â”Š14â”Š      \"migration/**/*.ts\"\n+â”Š  â”Š15â”Š   ],\n+â”Š  â”Š16â”Š   \"subscribers\": [\n+â”Š  â”Š17â”Š      \"subscriber/**/*.ts\"\n+â”Š  â”Š18â”Š   ],\n+â”Š  â”Š19â”Š   \"cli\": {\n+â”Š  â”Š20â”Š      \"entitiesDir\": \"entity\",\n+â”Š  â”Š21â”Š      \"migrationsDir\": \"migration\",\n+â”Š  â”Š22â”Š      \"subscribersDir\": \"subscriber\"\n+â”Š  â”Š23â”Š   }\n+â”Š  â”Š24â”Š}\n```\n\n[}]: #\n\nTypeORM wraps the official Postgres driver so you shouldn't worry about interacting with it. Feel free to edit `ormconfig.json` file based on your needs.\n\nWe will also define the type of expected GraphQL context using Codegen. All we have to do is to create a `context.ts` file and specify it in the `codegen.yml` file:\n\n[{]: <helper> (diffStep 1.5 files=\"codegen.yml, context.ts\" module=\"server\")\n\n#### Step 1.5: Setup TypeORM\n\n##### Changed codegen.yml\n```diff\n@@ -8,6 +8,7 @@\n â”Š 8â”Š 8â”Š      - typescript-resolvers\n â”Š 9â”Š 9â”Š    config:\n â”Š10â”Š10â”Š      optionalType: undefined | null\n+â”Š  â”Š11â”Š      contextType: ./context#Context\n â”Š11â”Š12â”Š      mappers:\n â”Š12â”Š13â”Š        Chat: ./entity/chat#Chat\n â”Š13â”Š14â”Š        Message: ./entity/message#Message\n```\n\n##### Added context.ts\n```diff\n@@ -0,0 +1,7 @@\n+â”Š â”Š1â”Šimport { Connection } from 'typeorm'\n+â”Š â”Š2â”Šimport User from './entity/user'\n+â”Š â”Š3â”Š\n+â”Š â”Š4â”Šexport interface Context {\n+â”Š â”Š5â”Š  connection: Connection\n+â”Š â”Š6â”Š  user: User\n+â”Š â”Š7â”Š}\n```\n\n[}]: #\n\nTypeORM has a very defined structure for organizing a project. Each table in our database, its columns and its relationships should be defined in an entity file under the `entity` folder. Why `entity` folder? Because the `ormconfig.json` says so. This is why originally we defined a TypeScript definition for each entity under a separate file. As for now, we will have 3 entities:\n\n- A chat entity.\n- A message entity.\n- A user entity.\n\nAs we make progress, we will add more entities and edit the relationships between them:\n\n[{]: <helper> (diffStep 1.6 files=\"entity\" module=\"server\")\n\n#### Step 1.6: Implement resolvers against TypeORM\n\n##### Changed entity&#x2F;chat.ts\n```diff\n@@ -1,18 +1,89 @@\n+â”Š  â”Š 1â”Šimport {\n+â”Š  â”Š 2â”Š  Entity,\n+â”Š  â”Š 3â”Š  Column,\n+â”Š  â”Š 4â”Š  PrimaryGeneratedColumn,\n+â”Š  â”Š 5â”Š  OneToMany,\n+â”Š  â”Š 6â”Š  JoinTable,\n+â”Š  â”Š 7â”Š  ManyToMany,\n+â”Š  â”Š 8â”Š  ManyToOne,\n+â”Š  â”Š 9â”Š  CreateDateColumn,\n+â”Š  â”Š10â”Š} from 'typeorm'\n â”Š 1â”Š11â”Šimport Message from './message'\n+â”Š  â”Š12â”Šimport User from './user'\n â”Š 2â”Š13â”Š\n-â”Š 3â”Š  â”Šexport interface Chat {\n+â”Š  â”Š14â”Šinterface ChatConstructor {\n+â”Š  â”Š15â”Š  name?: string\n+â”Š  â”Š16â”Š  picture?: string\n+â”Š  â”Š17â”Š  allTimeMembers?: User[]\n+â”Š  â”Š18â”Š  listingMembers?: User[]\n+â”Š  â”Š19â”Š  owner?: User\n+â”Š  â”Š20â”Š  messages?: Message[]\n+â”Š  â”Š21â”Š}\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Š@Entity()\n+â”Š  â”Š24â”Šexport class Chat {\n+â”Š  â”Š25â”Š  @PrimaryGeneratedColumn()\n â”Š 4â”Š26â”Š  id: string\n-â”Š 5â”Š  â”Š  name?: string | null\n-â”Š 6â”Š  â”Š  picture?: string | null\n-â”Š 7â”Š  â”Š  // All members, current and past ones.\n-â”Š 8â”Š  â”Š  allTimeMemberIds: string[]\n-â”Š 9â”Š  â”Š  // Whoever gets the chat listed. For groups includes past members who still didn't delete the group.\n-â”Š10â”Š  â”Š  listingMemberIds: string[]\n-â”Š11â”Š  â”Š  // Actual members of the group (they are not the only ones who get the group listed). Null for chats.\n-â”Š12â”Š  â”Š  actualGroupMemberIds?: string[] | null\n-â”Š13â”Š  â”Š  adminIds?: string[] | null\n-â”Š14â”Š  â”Š  ownerId?: string | null\n+â”Š  â”Š27â”Š\n+â”Š  â”Š28â”Š  @CreateDateColumn({ nullable: true })\n+â”Š  â”Š29â”Š  createdAt: Date\n+â”Š  â”Š30â”Š\n+â”Š  â”Š31â”Š  @Column({ nullable: true })\n+â”Š  â”Š32â”Š  name: string\n+â”Š  â”Š33â”Š\n+â”Š  â”Š34â”Š  @Column({ nullable: true })\n+â”Š  â”Š35â”Š  picture: string\n+â”Š  â”Š36â”Š\n+â”Š  â”Š37â”Š  @ManyToMany(type => User, user => user.allTimeMemberChats, {\n+â”Š  â”Š38â”Š    cascade: ['insert', 'update'],\n+â”Š  â”Š39â”Š    eager: false,\n+â”Š  â”Š40â”Š  })\n+â”Š  â”Š41â”Š  @JoinTable()\n+â”Š  â”Š42â”Š  allTimeMembers: User[]\n+â”Š  â”Š43â”Š\n+â”Š  â”Š44â”Š  @ManyToMany(type => User, user => user.listingMemberChats, {\n+â”Š  â”Š45â”Š    cascade: ['insert', 'update'],\n+â”Š  â”Š46â”Š    eager: false,\n+â”Š  â”Š47â”Š  })\n+â”Š  â”Š48â”Š  @JoinTable()\n+â”Š  â”Š49â”Š  listingMembers: User[]\n+â”Š  â”Š50â”Š\n+â”Š  â”Š51â”Š  @ManyToOne(type => User, user => user.ownerChats, { cascade: ['insert', 'update'], eager: false })\n+â”Š  â”Š52â”Š  owner?: User | null\n+â”Š  â”Š53â”Š\n+â”Š  â”Š54â”Š  @OneToMany(type => Message, message => message.chat, {\n+â”Š  â”Š55â”Š    cascade: ['insert', 'update'],\n+â”Š  â”Š56â”Š    eager: true,\n+â”Š  â”Š57â”Š  })\n â”Š15â”Š58â”Š  messages: Message[]\n+â”Š  â”Š59â”Š\n+â”Š  â”Š60â”Š  constructor({\n+â”Š  â”Š61â”Š    name,\n+â”Š  â”Š62â”Š    picture,\n+â”Š  â”Š63â”Š    allTimeMembers,\n+â”Š  â”Š64â”Š    listingMembers,\n+â”Š  â”Š65â”Š    owner,\n+â”Š  â”Š66â”Š    messages,\n+â”Š  â”Š67â”Š  }: ChatConstructor = {}) {\n+â”Š  â”Š68â”Š    if (name) {\n+â”Š  â”Š69â”Š      this.name = name\n+â”Š  â”Š70â”Š    }\n+â”Š  â”Š71â”Š    if (picture) {\n+â”Š  â”Š72â”Š      this.picture = picture\n+â”Š  â”Š73â”Š    }\n+â”Š  â”Š74â”Š    if (allTimeMembers) {\n+â”Š  â”Š75â”Š      this.allTimeMembers = allTimeMembers\n+â”Š  â”Š76â”Š    }\n+â”Š  â”Š77â”Š    if (listingMembers) {\n+â”Š  â”Š78â”Š      this.listingMembers = listingMembers\n+â”Š  â”Š79â”Š    }\n+â”Š  â”Š80â”Š    if (owner) {\n+â”Š  â”Š81â”Š      this.owner = owner\n+â”Š  â”Š82â”Š    }\n+â”Š  â”Š83â”Š    if (messages) {\n+â”Š  â”Š84â”Š      this.messages = messages\n+â”Š  â”Š85â”Š    }\n+â”Š  â”Š86â”Š  }\n â”Š16â”Š87â”Š}\n â”Š17â”Š88â”Š\n â”Š18â”Š89â”Šexport default Chat\n```\n\n##### Changed entity&#x2F;message.ts\n```diff\n@@ -1,20 +1,80 @@\n-â”Š 1â”Š  â”Šimport Recipient from './recipient'\n+â”Š  â”Š 1â”Šimport {\n+â”Š  â”Š 2â”Š  Entity,\n+â”Š  â”Š 3â”Š  Column,\n+â”Š  â”Š 4â”Š  PrimaryGeneratedColumn,\n+â”Š  â”Š 5â”Š  OneToMany,\n+â”Š  â”Š 6â”Š  ManyToOne,\n+â”Š  â”Š 7â”Š  ManyToMany,\n+â”Š  â”Š 8â”Š  JoinTable,\n+â”Š  â”Š 9â”Š  CreateDateColumn,\n+â”Š  â”Š10â”Š} from 'typeorm'\n+â”Š  â”Š11â”Šimport Chat from './chat'\n+â”Š  â”Š12â”Šimport User from './user'\n+â”Š  â”Š13â”Šimport { MessageType } from '../db'\n â”Š 2â”Š14â”Š\n-â”Š 3â”Š  â”Šexport enum MessageType {\n-â”Š 4â”Š  â”Š  PICTURE,\n-â”Š 5â”Š  â”Š  TEXT,\n-â”Š 6â”Š  â”Š  LOCATION,\n+â”Š  â”Š15â”Šinterface MessageConstructor {\n+â”Š  â”Š16â”Š  sender?: User\n+â”Š  â”Š17â”Š  content?: string\n+â”Š  â”Š18â”Š  createdAt?: Date\n+â”Š  â”Š19â”Š  type?: MessageType\n+â”Š  â”Š20â”Š  holders?: User[]\n+â”Š  â”Š21â”Š  chat?: Chat\n â”Š 7â”Š22â”Š}\n â”Š 8â”Š23â”Š\n-â”Š 9â”Š  â”Šexport interface Message {\n+â”Š  â”Š24â”Š@Entity()\n+â”Š  â”Š25â”Šexport class Message {\n+â”Š  â”Š26â”Š  @PrimaryGeneratedColumn()\n â”Š10â”Š27â”Š  id: string\n-â”Š11â”Š  â”Š  chatId: string\n-â”Š12â”Š  â”Š  senderId: string\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š  @ManyToOne(type => User, user => user.senderMessages, { eager: true })\n+â”Š  â”Š30â”Š  sender: User\n+â”Š  â”Š31â”Š\n+â”Š  â”Š32â”Š  @Column()\n â”Š13â”Š33â”Š  content: string\n-â”Š14â”Š  â”Š  createdAt: number\n-â”Š15â”Š  â”Š  type: MessageType\n-â”Š16â”Š  â”Š  recipients: Recipient[]\n-â”Š17â”Š  â”Š  holderIds: string[]\n+â”Š  â”Š34â”Š\n+â”Š  â”Š35â”Š  @CreateDateColumn({ nullable: true })\n+â”Š  â”Š36â”Š  createdAt: Date\n+â”Š  â”Š37â”Š\n+â”Š  â”Š38â”Š  @Column()\n+â”Š  â”Š39â”Š  type: number\n+â”Š  â”Š40â”Š\n+â”Š  â”Š41â”Š  @ManyToMany(type => User, user => user.holderMessages, {\n+â”Š  â”Š42â”Š    cascade: ['insert', 'update'],\n+â”Š  â”Š43â”Š    eager: true,\n+â”Š  â”Š44â”Š  })\n+â”Š  â”Š45â”Š  @JoinTable()\n+â”Š  â”Š46â”Š  holders: User[]\n+â”Š  â”Š47â”Š\n+â”Š  â”Š48â”Š  @ManyToOne(type => Chat, chat => chat.messages)\n+â”Š  â”Š49â”Š  chat: Chat\n+â”Š  â”Š50â”Š\n+â”Š  â”Š51â”Š  constructor({\n+â”Š  â”Š52â”Š    sender,\n+â”Š  â”Š53â”Š    content,\n+â”Š  â”Š54â”Š    createdAt,\n+â”Š  â”Š55â”Š    type,\n+â”Š  â”Š56â”Š    holders,\n+â”Š  â”Š57â”Š    chat,\n+â”Š  â”Š58â”Š  }: MessageConstructor = {}) {\n+â”Š  â”Š59â”Š    if (sender) {\n+â”Š  â”Š60â”Š      this.sender = sender\n+â”Š  â”Š61â”Š    }\n+â”Š  â”Š62â”Š    if (content) {\n+â”Š  â”Š63â”Š      this.content = content\n+â”Š  â”Š64â”Š    }\n+â”Š  â”Š65â”Š    if (createdAt) {\n+â”Š  â”Š66â”Š      this.createdAt = createdAt\n+â”Š  â”Š67â”Š    }\n+â”Š  â”Š68â”Š    if (type) {\n+â”Š  â”Š69â”Š      this.type = type\n+â”Š  â”Š70â”Š    }\n+â”Š  â”Š71â”Š    if (holders) {\n+â”Š  â”Š72â”Š      this.holders = holders\n+â”Š  â”Š73â”Š    }\n+â”Š  â”Š74â”Š    if (chat) {\n+â”Š  â”Š75â”Š      this.chat = chat\n+â”Š  â”Š76â”Š    }\n+â”Š  â”Š77â”Š  }\n â”Š18â”Š78â”Š}\n â”Š19â”Š79â”Š\n â”Š20â”Š80â”Šexport default Message\n```\n\n##### Changed entity&#x2F;user.ts\n```diff\n@@ -1,10 +1,60 @@\n-â”Š 1â”Š  â”Šexport interface User {\n+â”Š  â”Š 1â”Šimport { Entity, Column, PrimaryGeneratedColumn, ManyToMany, OneToMany } from 'typeorm'\n+â”Š  â”Š 2â”Šimport Chat from './chat'\n+â”Š  â”Š 3â”Šimport Message from './message'\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šinterface UserConstructor {\n+â”Š  â”Š 6â”Š  username?: string\n+â”Š  â”Š 7â”Š  password?: string\n+â”Š  â”Š 8â”Š  name?: string\n+â”Š  â”Š 9â”Š  picture?: string\n+â”Š  â”Š10â”Š}\n+â”Š  â”Š11â”Š\n+â”Š  â”Š12â”Š@Entity('app_user')\n+â”Š  â”Š13â”Šexport class User {\n+â”Š  â”Š14â”Š  @PrimaryGeneratedColumn()\n â”Š 2â”Š15â”Š  id: string\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š  @Column()\n â”Š 3â”Š18â”Š  username: string\n+â”Š  â”Š19â”Š\n+â”Š  â”Š20â”Š  @Column()\n â”Š 4â”Š21â”Š  password: string\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Š  @Column()\n â”Š 5â”Š24â”Š  name: string\n-â”Š 6â”Š  â”Š  picture?: string | null\n-â”Š 7â”Š  â”Š  phone?: string | null\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Š  @Column({ nullable: true })\n+â”Š  â”Š27â”Š  picture: string\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š  @ManyToMany(type => Chat, chat => chat.allTimeMembers)\n+â”Š  â”Š30â”Š  allTimeMemberChats: Chat[]\n+â”Š  â”Š31â”Š\n+â”Š  â”Š32â”Š  @ManyToMany(type => Chat, chat => chat.listingMembers)\n+â”Š  â”Š33â”Š  listingMemberChats: Chat[]\n+â”Š  â”Š34â”Š\n+â”Š  â”Š35â”Š  @ManyToMany(type => Message, message => message.holders)\n+â”Š  â”Š36â”Š  holderMessages: Message[]\n+â”Š  â”Š37â”Š\n+â”Š  â”Š38â”Š  @OneToMany(type => Chat, chat => chat.owner)\n+â”Š  â”Š39â”Š  ownerChats: Chat[]\n+â”Š  â”Š40â”Š\n+â”Š  â”Š41â”Š  @OneToMany(type => Message, message => message.sender)\n+â”Š  â”Š42â”Š  senderMessages: Message[]\n+â”Š  â”Š43â”Š\n+â”Š  â”Š44â”Š  constructor({ username, password, name, picture }: UserConstructor = {}) {\n+â”Š  â”Š45â”Š    if (username) {\n+â”Š  â”Š46â”Š      this.username = username\n+â”Š  â”Š47â”Š    }\n+â”Š  â”Š48â”Š    if (password) {\n+â”Š  â”Š49â”Š      this.password = password\n+â”Š  â”Š50â”Š    }\n+â”Š  â”Š51â”Š    if (name) {\n+â”Š  â”Š52â”Š      this.name = name\n+â”Š  â”Š53â”Š    }\n+â”Š  â”Š54â”Š    if (picture) {\n+â”Š  â”Š55â”Š      this.picture = picture\n+â”Š  â”Š56â”Š    }\n+â”Š  â”Š57â”Š  }\n â”Š 8â”Š58â”Š}\n â”Š 9â”Š59â”Š\n â”Š10â”Š60â”Šexport default User\n```\n\n[}]: #\n\nNow that we have the entities set, we can make requests to Postgres. Let's edit our resolvers to use the entities:\n\n[{]: <helper> (diffStep 1.6 files=\"schema\" module=\"server\")\n\n#### Step 1.6: Implement resolvers against TypeORM\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,83 +1,197 @@\n â”Š  1â”Š  1â”Šimport { IResolvers as IApolloResolvers } from 'apollo-server-express'\n â”Š  2â”Š  2â”Šimport { GraphQLDateTime } from 'graphql-iso-date'\n-â”Š  3â”Š   â”Šimport db from '../db'\n â”Š  4â”Š  3â”Šimport Chat from '../entity/chat'\n â”Š  5â”Š  4â”Šimport Message from '../entity/message'\n-â”Š  6â”Š   â”Šimport Recipient from '../entity/recipient'\n â”Š  7â”Š  5â”Šimport User from '../entity/user'\n â”Š  8â”Š  6â”Šimport { IResolvers } from '../types'\n â”Š  9â”Š  7â”Š\n-â”Š 10â”Š   â”Šlet users = db.users\n-â”Š 11â”Š   â”Šlet chats = db.chats\n-â”Š 12â”Š   â”Šconst currentUser: string = '1'\n-â”Š 13â”Š   â”Š\n â”Š 14â”Š  8â”Šexport default {\n â”Š 15â”Š  9â”Š  Date: GraphQLDateTime,\n â”Š 16â”Š 10â”Š  Query: {\n â”Š 17â”Š 11â”Š    // Show all users for the moment.\n-â”Š 18â”Š   â”Š    users: () => users.filter(user => user.id !== currentUser),\n-â”Š 19â”Š   â”Š    chats: () => chats.filter(chat => chat.listingMemberIds.includes(currentUser)),\n-â”Š 20â”Š   â”Š    chat: (obj, { chatId }) => chats.find(chat => chat.id === chatId) || null,\n+â”Š   â”Š 12â”Š    users: (root, args, { connection, currentUser }) => {\n+â”Š   â”Š 13â”Š      return connection.createQueryBuilder(User, 'user').where('user.id != :id', {id: currentUser.id}).getMany();\n+â”Š   â”Š 14â”Š    },\n+â”Š   â”Š 15â”Š\n+â”Š   â”Š 16â”Š    chats: (root, args, { connection, currentUser }) => {\n+â”Š   â”Š 17â”Š      return connection\n+â”Š   â”Š 18â”Š        .createQueryBuilder(Chat, 'chat')\n+â”Š   â”Š 19â”Š        .leftJoin('chat.listingMembers', 'listingMembers')\n+â”Š   â”Š 20â”Š        .where('listingMembers.id = :id', { id: currentUser.id })\n+â”Š   â”Š 21â”Š        .orderBy('chat.createdAt', 'DESC')\n+â”Š   â”Š 22â”Š        .getMany();\n+â”Š   â”Š 23â”Š    },\n+â”Š   â”Š 24â”Š\n+â”Š   â”Š 25â”Š    chat: async (root, { chatId }, { connection }) => {\n+â”Š   â”Š 26â”Š      const chat = await connection\n+â”Š   â”Š 27â”Š        .createQueryBuilder(Chat, 'chat')\n+â”Š   â”Š 28â”Š        .whereInIds(chatId)\n+â”Š   â”Š 29â”Š        .getOne();\n+â”Š   â”Š 30â”Š\n+â”Š   â”Š 31â”Š      return chat || null;\n+â”Š   â”Š 32â”Š    },\n â”Š 21â”Š 33â”Š  },\n+â”Š   â”Š 34â”Š\n â”Š 22â”Š 35â”Š  Chat: {\n-â”Š 23â”Š   â”Š    name: (chat) =>\n-â”Š 24â”Š   â”Š      chat.name\n-â”Š 25â”Š   â”Š        ? chat.name\n-â”Š 26â”Š   â”Š        : users.find(\n-â”Š 27â”Š   â”Š            user => user.id === chat.allTimeMemberIds.find((userId: string) => userId !== currentUser)\n-â”Š 28â”Š   â”Š          )!.name,\n-â”Š 29â”Š   â”Š    picture: (chat) =>\n-â”Š 30â”Š   â”Š      chat.name\n-â”Š 31â”Š   â”Š        ? chat.picture\n-â”Š 32â”Š   â”Š        : users.find(\n-â”Š 33â”Š   â”Š            user => user.id === chat.allTimeMemberIds.find((userId: string) => userId !== currentUser)\n-â”Š 34â”Š   â”Š          )!.picture,\n-â”Š 35â”Š   â”Š    allTimeMembers: (chat) =>\n-â”Š 36â”Š   â”Š      users.filter(user => chat.allTimeMemberIds.includes(user.id)),\n-â”Š 37â”Š   â”Š    listingMembers: (chat) =>\n-â”Š 38â”Š   â”Š      users.filter(user => chat.listingMemberIds.includes(user.id)),\n-â”Š 39â”Š   â”Š    actualGroupMembers: (chat) =>\n-â”Š 40â”Š   â”Š      users.filter(\n-â”Š 41â”Š   â”Š        user => chat.actualGroupMemberIds && chat.actualGroupMemberIds.includes(user.id)\n-â”Š 42â”Š   â”Š      ),\n-â”Š 43â”Š   â”Š    admins: (chat) =>\n-â”Š 44â”Š   â”Š      users.filter(user => chat.adminIds && chat.adminIds.includes(user.id)),\n-â”Š 45â”Š   â”Š    owner: (chat) => users.find(user => chat.ownerId === user.id) || null,\n-â”Š 46â”Š   â”Š    messages: (chat, { amount = 0 }) => {\n-â”Š 47â”Š   â”Š      const messages =\n-â”Š 48â”Š   â”Š        chat.messages\n-â”Š 49â”Š   â”Š          .filter((message: Message) => message.holderIds.includes(currentUser))\n-â”Š 50â”Š   â”Š          .sort((a: Message, b: Message) => b.createdAt - a.createdAt) || []\n-â”Š 51â”Š   â”Š      return (amount ? messages.slice(0, amount) : messages).reverse()\n+â”Š   â”Š 36â”Š    name: async (chat, args, { connection, currentUser }) => {\n+â”Š   â”Š 37â”Š      if (chat.name) {\n+â”Š   â”Š 38â”Š        return chat.name;\n+â”Š   â”Š 39â”Š      }\n+â”Š   â”Š 40â”Š\n+â”Š   â”Š 41â”Š      const user = await connection\n+â”Š   â”Š 42â”Š        .createQueryBuilder(User, 'user')\n+â”Š   â”Š 43â”Š        .where('user.id != :userId', { userId: currentUser.id })\n+â”Š   â”Š 44â”Š        .innerJoin(\n+â”Š   â”Š 45â”Š          'user.allTimeMemberChats',\n+â”Š   â”Š 46â”Š          'allTimeMemberChats',\n+â”Š   â”Š 47â”Š          'allTimeMemberChats.id = :chatId',\n+â”Š   â”Š 48â”Š          { chatId: chat.id },\n+â”Š   â”Š 49â”Š        )\n+â”Š   â”Š 50â”Š        .getOne();\n+â”Š   â”Š 51â”Š\n+â”Š   â”Š 52â”Š      return user ? user.name : null\n+â”Š   â”Š 53â”Š    },\n+â”Š   â”Š 54â”Š\n+â”Š   â”Š 55â”Š    picture: async (chat, args, { connection, currentUser }) => {\n+â”Š   â”Š 56â”Š      if (chat.picture) {\n+â”Š   â”Š 57â”Š        return chat.picture;\n+â”Š   â”Š 58â”Š      }\n+â”Š   â”Š 59â”Š\n+â”Š   â”Š 60â”Š      const user = await connection\n+â”Š   â”Š 61â”Š        .createQueryBuilder(User, 'user')\n+â”Š   â”Š 62â”Š        .where('user.id != :userId', { userId: currentUser.id })\n+â”Š   â”Š 63â”Š        .innerJoin(\n+â”Š   â”Š 64â”Š          'user.allTimeMemberChats',\n+â”Š   â”Š 65â”Š          'allTimeMemberChats',\n+â”Š   â”Š 66â”Š          'allTimeMemberChats.id = :chatId',\n+â”Š   â”Š 67â”Š          { chatId: chat.id },\n+â”Š   â”Š 68â”Š        )\n+â”Š   â”Š 69â”Š        .getOne();\n+â”Š   â”Š 70â”Š\n+â”Š   â”Š 71â”Š      return user ? user.picture : null\n+â”Š   â”Š 72â”Š    },\n+â”Š   â”Š 73â”Š\n+â”Š   â”Š 74â”Š    allTimeMembers: (chat, args, { connection }) => {\n+â”Š   â”Š 75â”Š      return connection\n+â”Š   â”Š 76â”Š        .createQueryBuilder(User, 'user')\n+â”Š   â”Š 77â”Š        .innerJoin(\n+â”Š   â”Š 78â”Š          'user.listingMemberChats',\n+â”Š   â”Š 79â”Š          'listingMemberChats',\n+â”Š   â”Š 80â”Š          'listingMemberChats.id = :chatId',\n+â”Š   â”Š 81â”Š          { chatId: chat.id },\n+â”Š   â”Š 82â”Š        )\n+â”Š   â”Š 83â”Š        .getMany()\n+â”Š   â”Š 84â”Š    },\n+â”Š   â”Š 85â”Š\n+â”Š   â”Š 86â”Š    listingMembers: (chat, args, { connection }) => {\n+â”Š   â”Š 87â”Š      return connection\n+â”Š   â”Š 88â”Š        .createQueryBuilder(User, 'user')\n+â”Š   â”Š 89â”Š        .innerJoin(\n+â”Š   â”Š 90â”Š          'user.listingMemberChats',\n+â”Š   â”Š 91â”Š          'listingMemberChats',\n+â”Š   â”Š 92â”Š          'listingMemberChats.id = :chatId',\n+â”Š   â”Š 93â”Š          { chatId: chat.id },\n+â”Š   â”Š 94â”Š        )\n+â”Š   â”Š 95â”Š        .getMany();\n+â”Š   â”Š 96â”Š    },\n+â”Š   â”Š 97â”Š\n+â”Š   â”Š 98â”Š    owner: async (chat, args, { connection }) => {\n+â”Š   â”Š 99â”Š      const owner = await connection\n+â”Š   â”Š100â”Š        .createQueryBuilder(User, 'user')\n+â”Š   â”Š101â”Š        .innerJoin('user.ownerChats', 'ownerChats', 'ownerChats.id = :chatId', {\n+â”Š   â”Š102â”Š          chatId: chat.id,\n+â”Š   â”Š103â”Š        })\n+â”Š   â”Š104â”Š        .getOne();\n+â”Š   â”Š105â”Š\n+â”Š   â”Š106â”Š      return owner || null;\n+â”Š   â”Š107â”Š    },\n+â”Š   â”Š108â”Š\n+â”Š   â”Š109â”Š    messages: async (chat, { amount = 0 }, { connection, currentUser }) => {\n+â”Š   â”Š110â”Š      if (chat.messages) {\n+â”Š   â”Š111â”Š        return amount ? chat.messages.slice(-amount) : chat.messages;\n+â”Š   â”Š112â”Š      }\n+â”Š   â”Š113â”Š\n+â”Š   â”Š114â”Š      let query = connection\n+â”Š   â”Š115â”Š        .createQueryBuilder(Message, 'message')\n+â”Š   â”Š116â”Š        .innerJoin('message.chat', 'chat', 'chat.id = :chatId', { chatId: chat.id })\n+â”Š   â”Š117â”Š        .innerJoin('message.holders', 'holders', 'holders.id = :userId', {\n+â”Š   â”Š118â”Š          userId: currentUser.id,\n+â”Š   â”Š119â”Š        })\n+â”Š   â”Š120â”Š        .orderBy({ 'message.createdAt': { order: 'DESC', nulls: 'NULLS LAST' } });\n+â”Š   â”Š121â”Š\n+â”Š   â”Š122â”Š      if (amount) {\n+â”Š   â”Š123â”Š        query = query.take(amount);\n+â”Š   â”Š124â”Š      }\n+â”Š   â”Š125â”Š\n+â”Š   â”Š126â”Š      return (await query.getMany()).reverse();\n+â”Š   â”Š127â”Š    },\n+â”Š   â”Š128â”Š\n+â”Š   â”Š129â”Š    lastMessage: async (chat, args, { connection, currentUser }) => {\n+â”Š   â”Š130â”Š      if (chat.messages) {\n+â”Š   â”Š131â”Š        return chat.messages.length ? chat.messages[chat.messages.length - 1] : null;\n+â”Š   â”Š132â”Š      }\n+â”Š   â”Š133â”Š\n+â”Š   â”Š134â”Š      const messages = await connection\n+â”Š   â”Š135â”Š        .createQueryBuilder(Message, 'message')\n+â”Š   â”Š136â”Š        .innerJoin('message.chat', 'chat', 'chat.id = :chatId', { chatId: chat.id })\n+â”Š   â”Š137â”Š        .innerJoin('message.holders', 'holders', 'holders.id = :userId', {\n+â”Š   â”Š138â”Š          userId: currentUser.id,\n+â”Š   â”Š139â”Š        })\n+â”Š   â”Š140â”Š        .orderBy({ 'message.createdAt': { order: 'DESC', nulls: 'NULLS LAST' } })\n+â”Š   â”Š141â”Š        .getMany()\n+â”Š   â”Š142â”Š\n+â”Š   â”Š143â”Š      return messages && messages.length ? messages[messages.length - 1] : null;\n â”Š 52â”Š144â”Š    },\n-â”Š 53â”Š   â”Š    unreadMessages: (chat) =>\n-â”Š 54â”Š   â”Š      chat.messages.filter(\n-â”Š 55â”Š   â”Š        (message: Message) =>\n-â”Š 56â”Š   â”Š          message.holderIds.includes(currentUser) &&\n-â”Š 57â”Š   â”Š          message.recipients.find(\n-â”Š 58â”Š   â”Š            (recipient: Recipient) => recipient.userId === currentUser && !recipient.readAt\n-â”Š 59â”Š   â”Š          )\n-â”Š 60â”Š   â”Š      ).length,\n-â”Š 61â”Š   â”Š    lastMessage: (chat) => chat.messages[chat.messages.length - 1],\n-â”Š 62â”Š   â”Š    isGroup: (chat) => !!chat.name,\n â”Š 63â”Š145â”Š  },\n+â”Š   â”Š146â”Š\n â”Š 64â”Š147â”Š  Message: {\n-â”Š 65â”Š   â”Š    chat: (message) =>\n-â”Š 66â”Š   â”Š      chats.find(chat => message.chatId === chat.id) || null,\n-â”Š 67â”Š   â”Š    sender: (message) =>\n-â”Š 68â”Š   â”Š      users.find(user => user.id === message.senderId) || null,\n-â”Š 69â”Š   â”Š    holders: (message) =>\n-â”Š 70â”Š   â”Š      users.filter(user => message.holderIds.includes(user.id)),\n-â”Š 71â”Š   â”Š    ownership: (message) => message.senderId === currentUser,\n-â”Š 72â”Š   â”Š  },\n-â”Š 73â”Š   â”Š  Recipient: {\n-â”Š 74â”Š   â”Š    user: (recipient) =>\n-â”Š 75â”Š   â”Š      users.find(user => recipient.userId === user.id) || null,\n-â”Š 76â”Š   â”Š    message: (recipient) => {\n-â”Š 77â”Š   â”Š      const chat = chats.find(chat => recipient.chatId === chat.id)\n-â”Š 78â”Š   â”Š      return chat ? chat.messages.find(message => recipient.messageId === message.id) || null : null\n+â”Š   â”Š148â”Š    chat: async (message, args, { connection }) => {\n+â”Š   â”Š149â”Š      const chat = await connection\n+â”Š   â”Š150â”Š        .createQueryBuilder(Chat, 'chat')\n+â”Š   â”Š151â”Š        .innerJoin('chat.messages', 'messages', 'messages.id = :messageId', {\n+â”Š   â”Š152â”Š          messageId: message.id\n+â”Š   â”Š153â”Š        })\n+â”Š   â”Š154â”Š        .getOne();\n+â”Š   â”Š155â”Š\n+â”Š   â”Š156â”Š      if (!chat) {\n+â”Š   â”Š157â”Š        throw new Error(`Message must have a chat.`);\n+â”Š   â”Š158â”Š      }\n+â”Š   â”Š159â”Š\n+â”Š   â”Š160â”Š      return chat;\n+â”Š   â”Š161â”Š    },\n+â”Š   â”Š162â”Š\n+â”Š   â”Š163â”Š    sender: async (message, args, { connection }) => {\n+â”Š   â”Š164â”Š      const sender = await connection\n+â”Š   â”Š165â”Š        .createQueryBuilder(User, 'user')\n+â”Š   â”Š166â”Š        .innerJoin('user.senderMessages', 'senderMessages', 'senderMessages.id = :messageId', {\n+â”Š   â”Š167â”Š          messageId: message.id,\n+â”Š   â”Š168â”Š        })\n+â”Š   â”Š169â”Š        .getOne();\n+â”Š   â”Š170â”Š\n+â”Š   â”Š171â”Š      if (!sender) {\n+â”Š   â”Š172â”Š        throw new Error(`Message must have a sender.`);\n+â”Š   â”Š173â”Š      }\n+â”Š   â”Š174â”Š\n+â”Š   â”Š175â”Š      return sender;\n â”Š 79â”Š176â”Š    },\n-â”Š 80â”Š   â”Š    chat: (recipient) =>\n-â”Š 81â”Š   â”Š      chats.find(chat => recipient.chatId === chat.id) || null,\n+â”Š   â”Š177â”Š\n+â”Š   â”Š178â”Š    holders: async (message, args, { connection }) => {\n+â”Š   â”Š179â”Š      return connection\n+â”Š   â”Š180â”Š        .createQueryBuilder(User, 'user')\n+â”Š   â”Š181â”Š        .innerJoin('user.holderMessages', 'holderMessages', 'holderMessages.id = :messageId', {\n+â”Š   â”Š182â”Š          messageId: message.id,\n+â”Š   â”Š183â”Š        })\n+â”Š   â”Š184â”Š        .getMany();\n+â”Š   â”Š185â”Š    },\n+â”Š   â”Š186â”Š\n+â”Š   â”Š187â”Š    ownership: async (message, args, { connection, currentUser }) => {\n+â”Š   â”Š188â”Š      return !!(await connection\n+â”Š   â”Š189â”Š        .createQueryBuilder(User, 'user')\n+â”Š   â”Š190â”Š        .whereInIds(currentUser.id)\n+â”Š   â”Š191â”Š        .innerJoin('user.senderMessages', 'senderMessages', 'senderMessages.id = :messageId', {\n+â”Š   â”Š192â”Š          messageId: message.id,\n+â”Š   â”Š193â”Š        })\n+â”Š   â”Š194â”Š        .getCount())\n+â”Š   â”Š195â”Š    }\n â”Š 82â”Š196â”Š  },\n â”Š 83â”Š197â”Š} as IResolvers as IApolloResolvers\n```\n\n[}]: #\n\nNotice that we've used a custom scalar type to represent a `Date` object in our GraphQL schema using a package called [`graphql-iso-date`](https://www.npmjs.com/package/graphql-iso-date). Accordingly, let's install this package:\n\n    $ yarn add graphql-iso-date@3.6.1\n    $ yarn add -D @types/graphql-iso-date@3.3.1\n\nAnd update `codegen.yml` to use it in the generated code file:\n\n[{]: <helper> (diffStep 1.6 files=\"codegen\" module=\"server\")\n\n#### Step 1.6: Implement resolvers against TypeORM\n\n##### Changed codegen.yml\n```diff\n@@ -13,3 +13,5 @@\n â”Š13â”Š13â”Š        Chat: ./entity/chat#Chat\n â”Š14â”Š14â”Š        Message: ./entity/message#Message\n â”Š15â”Š15â”Š        User: ./entity/user#User\n+â”Š  â”Š16â”Š      scalars:\n+â”Š  â”Š17â”Š        Date: Date\n```\n\n[}]: #\n\nInstead of fabricating a DB into the memory, we will replace the `db.ts` module with a function that will add sample data, using entities of course. This will be very convenient because this way we can test our app:\n\n[{]: <helper> (diffStep 1.6 files=\"db\" module=\"server\")\n\n#### Step 1.6: Implement resolvers against TypeORM\n\n##### Changed db.ts\n```diff\n@@ -1,274 +1,254 @@\n+â”Š   â”Š  1â”Šimport 'reflect-metadata'\n â”Š  1â”Š  2â”Šimport moment from 'moment'\n-â”Š  2â”Š   â”Šimport Chat from './entity/chat'\n-â”Š  3â”Š   â”Šimport Message, { MessageType } from './entity/message'\n-â”Š  4â”Š   â”Šimport User from './entity/user'\n+â”Š   â”Š  3â”Šimport { Connection } from 'typeorm'\n+â”Š   â”Š  4â”Šimport { Chat } from './entity/chat'\n+â”Š   â”Š  5â”Šimport { Message } from './entity/message'\n+â”Š   â”Š  6â”Šimport { User } from './entity/user'\n â”Š  5â”Š  7â”Š\n-â”Š  6â”Š   â”Šconst users: User[] = [\n-â”Š  7â”Š   â”Š  {\n-â”Š  8â”Š   â”Š    id: '1',\n+â”Š   â”Š  8â”Šexport enum MessageType {\n+â”Š   â”Š  9â”Š  PICTURE,\n+â”Š   â”Š 10â”Š  TEXT,\n+â”Š   â”Š 11â”Š  LOCATION,\n+â”Š   â”Š 12â”Š}\n+â”Š   â”Š 13â”Š\n+â”Š   â”Š 14â”Šexport async function addSampleData(connection: Connection) {\n+â”Š   â”Š 15â”Š  const user1 = new User({\n â”Š  9â”Š 16â”Š    username: 'ethan',\n â”Š 10â”Š 17â”Š    password: '$2a$08$NO9tkFLCoSqX1c5wk3s7z.JfxaVMKA.m7zUDdDwEquo4rvzimQeJm', // 111\n â”Š 11â”Š 18â”Š    name: 'Ethan Gonzalez',\n â”Š 12â”Š 19â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n-â”Š 13â”Š   â”Š  },\n-â”Š 14â”Š   â”Š  {\n-â”Š 15â”Š   â”Š    id: '2',\n+â”Š   â”Š 20â”Š  })\n+â”Š   â”Š 21â”Š  await connection.manager.save(user1)\n+â”Š   â”Š 22â”Š\n+â”Š   â”Š 23â”Š  const user2 = new User({\n â”Š 16â”Š 24â”Š    username: 'bryan',\n â”Š 17â”Š 25â”Š    password: '$2a$08$xE4FuCi/ifxjL2S8CzKAmuKLwv18ktksSN.F3XYEnpmcKtpbpeZgO', // 222\n â”Š 18â”Š 26â”Š    name: 'Bryan Wallace',\n â”Š 19â”Š 27â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n-â”Š 20â”Š   â”Š  },\n-â”Š 21â”Š   â”Š  {\n-â”Š 22â”Š   â”Š    id: '3',\n+â”Š   â”Š 28â”Š  })\n+â”Š   â”Š 29â”Š  await connection.manager.save(user2)\n+â”Š   â”Š 30â”Š\n+â”Š   â”Š 31â”Š  const user3 = new User({\n â”Š 23â”Š 32â”Š    username: 'avery',\n â”Š 24â”Š 33â”Š    password: '$2a$08$UHgH7J8G6z1mGQn2qx2kdeWv0jvgHItyAsL9hpEUI3KJmhVW5Q1d.', // 333\n â”Š 25â”Š 34â”Š    name: 'Avery Stewart',\n â”Š 26â”Š 35â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n-â”Š 27â”Š   â”Š  },\n-â”Š 28â”Š   â”Š  {\n-â”Š 29â”Š   â”Š    id: '4',\n+â”Š   â”Š 36â”Š  })\n+â”Š   â”Š 37â”Š  await connection.manager.save(user3)\n+â”Š   â”Š 38â”Š\n+â”Š   â”Š 39â”Š  const user4 = new User({\n â”Š 30â”Š 40â”Š    username: 'katie',\n â”Š 31â”Š 41â”Š    password: '$2a$08$wR1k5Q3T9FC7fUgB7Gdb9Os/GV7dGBBf4PLlWT7HERMFhmFDt47xi', // 444\n â”Š 32â”Š 42â”Š    name: 'Katie Peterson',\n â”Š 33â”Š 43â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n-â”Š 34â”Š   â”Š  },\n-â”Š 35â”Š   â”Š  {\n-â”Š 36â”Š   â”Š    id: '5',\n+â”Š   â”Š 44â”Š  })\n+â”Š   â”Š 45â”Š  await connection.manager.save(user4)\n+â”Š   â”Š 46â”Š\n+â”Š   â”Š 47â”Š  const user5 = new User({\n â”Š 37â”Š 48â”Š    username: 'ray',\n â”Š 38â”Š 49â”Š    password: '$2a$08$6.mbXqsDX82ZZ7q5d8Osb..JrGSsNp4R3IKj7mxgF6YGT0OmMw242', // 555\n â”Š 39â”Š 50â”Š    name: 'Ray Edwards',\n â”Š 40â”Š 51â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/3.jpg',\n-â”Š 41â”Š   â”Š  },\n-â”Š 42â”Š   â”Š  {\n-â”Š 43â”Š   â”Š    id: '6',\n+â”Š   â”Š 52â”Š  })\n+â”Š   â”Š 53â”Š  await connection.manager.save(user5)\n+â”Š   â”Š 54â”Š\n+â”Š   â”Š 55â”Š  const user6 = new User({\n â”Š 44â”Š 56â”Š    username: 'niko',\n â”Š 45â”Š 57â”Š    password: '$2a$08$fL5lZR.Rwf9FWWe8XwwlceiPBBim8n9aFtaem.INQhiKT4.Ux3Uq.', // 666\n â”Š 46â”Š 58â”Š    name: 'NiccolÃ² Belli',\n â”Š 47â”Š 59â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/4.jpg',\n-â”Š 48â”Š   â”Š  },\n-â”Š 49â”Š   â”Š  {\n-â”Š 50â”Š   â”Š    id: '7',\n+â”Š   â”Š 60â”Š  })\n+â”Š   â”Š 61â”Š  await connection.manager.save(user6)\n+â”Š   â”Š 62â”Š\n+â”Š   â”Š 63â”Š  const user7 = new User({\n â”Š 51â”Š 64â”Š    username: 'mario',\n â”Š 52â”Š 65â”Š    password: '$2a$08$nDHDmWcVxDnH5DDT3HMMC.psqcnu6wBiOgkmJUy9IH..qxa3R6YrO', // 777\n â”Š 53â”Š 66â”Š    name: 'Mario Rossi',\n â”Š 54â”Š 67â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/5.jpg',\n-â”Š 55â”Š   â”Š  },\n-â”Š 56â”Š   â”Š]\n+â”Š   â”Š 68â”Š  })\n+â”Š   â”Š 69â”Š  await connection.manager.save(user7)\n+â”Š   â”Š 70â”Š\n+â”Š   â”Š 71â”Š  await connection.manager.save(\n+â”Š   â”Š 72â”Š    new Chat({\n+â”Š   â”Š 73â”Š      allTimeMembers: [user1, user3],\n+â”Š   â”Š 74â”Š      listingMembers: [user1, user3],\n+â”Š   â”Š 75â”Š      messages: [\n+â”Š   â”Š 76â”Š        new Message({\n+â”Š   â”Š 77â”Š          sender: user1,\n+â”Š   â”Š 78â”Š          content: 'You on your way?',\n+â”Š   â”Š 79â”Š          createdAt: moment()\n+â”Š   â”Š 80â”Š            .subtract(1, 'hours')\n+â”Š   â”Š 81â”Š            .toDate(),\n+â”Š   â”Š 82â”Š          type: MessageType.TEXT,\n+â”Š   â”Š 83â”Š          holders: [user1, user3],\n+â”Š   â”Š 84â”Š        }),\n+â”Š   â”Š 85â”Š        new Message({\n+â”Š   â”Š 86â”Š          sender: user3,\n+â”Š   â”Š 87â”Š          content: 'Yep!',\n+â”Š   â”Š 88â”Š          createdAt: moment()\n+â”Š   â”Š 89â”Š            .subtract(1, 'hours')\n+â”Š   â”Š 90â”Š            .add(5, 'minutes')\n+â”Š   â”Š 91â”Š            .toDate(),\n+â”Š   â”Š 92â”Š          type: MessageType.TEXT,\n+â”Š   â”Š 93â”Š          holders: [user1, user3],\n+â”Š   â”Š 94â”Š        }),\n+â”Š   â”Š 95â”Š      ],\n+â”Š   â”Š 96â”Š    })\n+â”Š   â”Š 97â”Š  )\n+â”Š   â”Š 98â”Š\n+â”Š   â”Š 99â”Š  await connection.manager.save(\n+â”Š   â”Š100â”Š    new Chat({\n+â”Š   â”Š101â”Š      allTimeMembers: [user1, user4],\n+â”Š   â”Š102â”Š      listingMembers: [user1, user4],\n+â”Š   â”Š103â”Š      messages: [\n+â”Š   â”Š104â”Š        new Message({\n+â”Š   â”Š105â”Š          sender: user1,\n+â”Š   â”Š106â”Š          content: \"Hey, it's me\",\n+â”Š   â”Š107â”Š          createdAt: moment()\n+â”Š   â”Š108â”Š            .subtract(2, 'hours')\n+â”Š   â”Š109â”Š            .toDate(),\n+â”Š   â”Š110â”Š          type: MessageType.TEXT,\n+â”Š   â”Š111â”Š          holders: [user1, user4],\n+â”Š   â”Š112â”Š        }),\n+â”Š   â”Š113â”Š      ],\n+â”Š   â”Š114â”Š    })\n+â”Š   â”Š115â”Š  )\n+â”Š   â”Š116â”Š\n+â”Š   â”Š117â”Š  await connection.manager.save(\n+â”Š   â”Š118â”Š    new Chat({\n+â”Š   â”Š119â”Š      allTimeMembers: [user1, user5],\n+â”Š   â”Š120â”Š      listingMembers: [user1, user5],\n+â”Š   â”Š121â”Š      messages: [\n+â”Š   â”Š122â”Š        new Message({\n+â”Š   â”Š123â”Š          sender: user1,\n+â”Š   â”Š124â”Š          content: 'I should buy a boat',\n+â”Š   â”Š125â”Š          createdAt: moment()\n+â”Š   â”Š126â”Š            .subtract(1, 'days')\n+â”Š   â”Š127â”Š            .toDate(),\n+â”Š   â”Š128â”Š          type: MessageType.TEXT,\n+â”Š   â”Š129â”Š          holders: [user1, user5],\n+â”Š   â”Š130â”Š        }),\n+â”Š   â”Š131â”Š        new Message({\n+â”Š   â”Š132â”Š          sender: user1,\n+â”Š   â”Š133â”Š          content: 'You still there?',\n+â”Š   â”Š134â”Š          createdAt: moment()\n+â”Š   â”Š135â”Š            .subtract(1, 'days')\n+â”Š   â”Š136â”Š            .add(16, 'hours')\n+â”Š   â”Š137â”Š            .toDate(),\n+â”Š   â”Š138â”Š          type: MessageType.TEXT,\n+â”Š   â”Š139â”Š          holders: [user1, user5],\n+â”Š   â”Š140â”Š        }),\n+â”Š   â”Š141â”Š      ],\n+â”Š   â”Š142â”Š    })\n+â”Š   â”Š143â”Š  )\n+â”Š   â”Š144â”Š\n+â”Š   â”Š145â”Š  await connection.manager.save(\n+â”Š   â”Š146â”Š    new Chat({\n+â”Š   â”Š147â”Š      allTimeMembers: [user3, user4],\n+â”Š   â”Š148â”Š      listingMembers: [user3, user4],\n+â”Š   â”Š149â”Š      messages: [\n+â”Š   â”Š150â”Š        new Message({\n+â”Š   â”Š151â”Š          sender: user3,\n+â”Š   â”Š152â”Š          content: 'Look at my mukluks!',\n+â”Š   â”Š153â”Š          createdAt: moment()\n+â”Š   â”Š154â”Š            .subtract(4, 'days')\n+â”Š   â”Š155â”Š            .toDate(),\n+â”Š   â”Š156â”Š          type: MessageType.TEXT,\n+â”Š   â”Š157â”Š          holders: [user3, user4],\n+â”Š   â”Š158â”Š        }),\n+â”Š   â”Š159â”Š      ],\n+â”Š   â”Š160â”Š    })\n+â”Š   â”Š161â”Š  )\n+â”Š   â”Š162â”Š\n+â”Š   â”Š163â”Š  await connection.manager.save(\n+â”Š   â”Š164â”Š    new Chat({\n+â”Š   â”Š165â”Š      allTimeMembers: [user2, user5],\n+â”Š   â”Š166â”Š      listingMembers: [user2, user5],\n+â”Š   â”Š167â”Š      messages: [\n+â”Š   â”Š168â”Š        new Message({\n+â”Š   â”Š169â”Š          sender: user2,\n+â”Š   â”Š170â”Š          content: 'This is wicked good ice cream.',\n+â”Š   â”Š171â”Š          createdAt: moment()\n+â”Š   â”Š172â”Š            .subtract(2, 'weeks')\n+â”Š   â”Š173â”Š            .toDate(),\n+â”Š   â”Š174â”Š          type: MessageType.TEXT,\n+â”Š   â”Š175â”Š          holders: [user2, user5],\n+â”Š   â”Š176â”Š        }),\n+â”Š   â”Š177â”Š        new Message({\n+â”Š   â”Š178â”Š          sender: user5,\n+â”Š   â”Š179â”Š          content: 'Love it!',\n+â”Š   â”Š180â”Š          createdAt: moment()\n+â”Š   â”Š181â”Š            .subtract(2, 'weeks')\n+â”Š   â”Š182â”Š            .add(10, 'minutes')\n+â”Š   â”Š183â”Š            .toDate(),\n+â”Š   â”Š184â”Š          type: MessageType.TEXT,\n+â”Š   â”Š185â”Š          holders: [user2, user5],\n+â”Š   â”Š186â”Š        }),\n+â”Š   â”Š187â”Š      ],\n+â”Š   â”Š188â”Š    })\n+â”Š   â”Š189â”Š  )\n+â”Š   â”Š190â”Š\n+â”Š   â”Š191â”Š  await connection.manager.save(\n+â”Š   â”Š192â”Š    new Chat({\n+â”Š   â”Š193â”Š      allTimeMembers: [user1, user6],\n+â”Š   â”Š194â”Š      listingMembers: [user1],\n+â”Š   â”Š195â”Š    })\n+â”Š   â”Š196â”Š  )\n+â”Š   â”Š197â”Š\n+â”Š   â”Š198â”Š  await connection.manager.save(\n+â”Š   â”Š199â”Š    new Chat({\n+â”Š   â”Š200â”Š      allTimeMembers: [user2, user1],\n+â”Š   â”Š201â”Š      listingMembers: [user2],\n+â”Š   â”Š202â”Š    })\n+â”Š   â”Š203â”Š  )\n â”Š 57â”Š204â”Š\n-â”Š 58â”Š   â”Šconst chats: Chat[] = [\n-â”Š 59â”Š   â”Š  {\n-â”Š 60â”Š   â”Š    id: '1',\n-â”Š 61â”Š   â”Š    name: null,\n-â”Š 62â”Š   â”Š    picture: null,\n-â”Š 63â”Š   â”Š    allTimeMemberIds: ['1', '3'],\n-â”Š 64â”Š   â”Š    listingMemberIds: ['1', '3'],\n-â”Š 65â”Š   â”Š    ownerId: null,\n-â”Š 66â”Š   â”Š    messages: [\n-â”Š 67â”Š   â”Š      {\n-â”Š 68â”Š   â”Š        id: '1',\n-â”Š 69â”Š   â”Š        chatId: '1',\n-â”Š 70â”Š   â”Š        senderId: '1',\n-â”Š 71â”Š   â”Š        content: 'You on your way?',\n-â”Š 72â”Š   â”Š        createdAt: moment()\n-â”Š 73â”Š   â”Š          .subtract(1, 'hours')\n-â”Š 74â”Š   â”Š          .unix(),\n-â”Š 75â”Š   â”Š        type: MessageType.TEXT,\n-â”Š 76â”Š   â”Š        holderIds: ['1', '3'],\n-â”Š 77â”Š   â”Š      },\n-â”Š 78â”Š   â”Š      {\n-â”Š 79â”Š   â”Š        id: '2',\n-â”Š 80â”Š   â”Š        chatId: '1',\n-â”Š 81â”Š   â”Š        senderId: '3',\n-â”Š 82â”Š   â”Š        content: 'Yep!',\n-â”Š 83â”Š   â”Š        createdAt: moment()\n-â”Š 84â”Š   â”Š          .subtract(1, 'hours')\n-â”Š 85â”Š   â”Š          .add(5, 'minutes')\n-â”Š 86â”Š   â”Š          .unix(),\n-â”Š 87â”Š   â”Š        type: MessageType.TEXT,\n-â”Š 88â”Š   â”Š        holderIds: ['3', '1'],\n-â”Š 89â”Š   â”Š      },\n-â”Š 90â”Š   â”Š    ],\n-â”Š 91â”Š   â”Š  },\n-â”Š 92â”Š   â”Š  {\n-â”Š 93â”Š   â”Š    id: '2',\n-â”Š 94â”Š   â”Š    name: null,\n-â”Š 95â”Š   â”Š    picture: null,\n-â”Š 96â”Š   â”Š    allTimeMemberIds: ['1', '4'],\n-â”Š 97â”Š   â”Š    listingMemberIds: ['1', '4'],\n-â”Š 98â”Š   â”Š    ownerId: null,\n-â”Š 99â”Š   â”Š    messages: [\n-â”Š100â”Š   â”Š      {\n-â”Š101â”Š   â”Š        id: '1',\n-â”Š102â”Š   â”Š        chatId: '2',\n-â”Š103â”Š   â”Š        senderId: '1',\n-â”Š104â”Š   â”Š        content: \"Hey, it's me\",\n-â”Š105â”Š   â”Š        createdAt: moment()\n-â”Š106â”Š   â”Š          .subtract(2, 'hours')\n-â”Š107â”Š   â”Š          .unix(),\n-â”Š108â”Š   â”Š        type: MessageType.TEXT,\n-â”Š109â”Š   â”Š        holderIds: ['1', '4'],\n-â”Š110â”Š   â”Š      },\n-â”Š111â”Š   â”Š    ],\n-â”Š112â”Š   â”Š  },\n-â”Š113â”Š   â”Š  {\n-â”Š114â”Š   â”Š    id: '3',\n-â”Š115â”Š   â”Š    name: null,\n-â”Š116â”Š   â”Š    picture: null,\n-â”Š117â”Š   â”Š    allTimeMemberIds: ['1', '5'],\n-â”Š118â”Š   â”Š    listingMemberIds: ['1', '5'],\n-â”Š119â”Š   â”Š    ownerId: null,\n-â”Š120â”Š   â”Š    messages: [\n-â”Š121â”Š   â”Š      {\n-â”Š122â”Š   â”Š        id: '1',\n-â”Š123â”Š   â”Š        chatId: '3',\n-â”Š124â”Š   â”Š        senderId: '1',\n-â”Š125â”Š   â”Š        content: 'I should buy a boat',\n-â”Š126â”Š   â”Š        createdAt: moment()\n-â”Š127â”Š   â”Š          .subtract(1, 'days')\n-â”Š128â”Š   â”Š          .unix(),\n-â”Š129â”Š   â”Š        type: MessageType.TEXT,\n-â”Š130â”Š   â”Š        holderIds: ['1', '5'],\n-â”Š131â”Š   â”Š      },\n-â”Š132â”Š   â”Š      {\n-â”Š133â”Š   â”Š        id: '2',\n-â”Š134â”Š   â”Š        chatId: '3',\n-â”Š135â”Š   â”Š        senderId: '1',\n-â”Š136â”Š   â”Š        content: 'You still there?',\n-â”Š137â”Š   â”Š        createdAt: moment()\n-â”Š138â”Š   â”Š          .subtract(1, 'days')\n-â”Š139â”Š   â”Š          .add(16, 'hours')\n-â”Š140â”Š   â”Š          .unix(),\n-â”Š141â”Š   â”Š        type: MessageType.TEXT,\n-â”Š142â”Š   â”Š        holderIds: ['1', '5'],\n-â”Š143â”Š   â”Š      },\n-â”Š144â”Š   â”Š    ],\n-â”Š145â”Š   â”Š  },\n-â”Š146â”Š   â”Š  {\n-â”Š147â”Š   â”Š    id: '4',\n-â”Š148â”Š   â”Š    name: null,\n-â”Š149â”Š   â”Š    picture: null,\n-â”Š150â”Š   â”Š    allTimeMemberIds: ['3', '4'],\n-â”Š151â”Š   â”Š    listingMemberIds: ['3', '4'],\n-â”Š152â”Š   â”Š    ownerId: null,\n-â”Š153â”Š   â”Š    messages: [\n-â”Š154â”Š   â”Š      {\n-â”Š155â”Š   â”Š        id: '1',\n-â”Š156â”Š   â”Š        chatId: '4',\n-â”Š157â”Š   â”Š        senderId: '3',\n-â”Š158â”Š   â”Š        content: 'Look at my mukluks!',\n-â”Š159â”Š   â”Š        createdAt: moment()\n-â”Š160â”Š   â”Š          .subtract(4, 'days')\n-â”Š161â”Š   â”Š          .unix(),\n-â”Š162â”Š   â”Š        type: MessageType.TEXT,\n-â”Š163â”Š   â”Š        holderIds: ['3', '4'],\n-â”Š164â”Š   â”Š      },\n-â”Š165â”Š   â”Š    ],\n-â”Š166â”Š   â”Š  },\n-â”Š167â”Š   â”Š  {\n-â”Š168â”Š   â”Š    id: '5',\n-â”Š169â”Š   â”Š    name: null,\n-â”Š170â”Š   â”Š    picture: null,\n-â”Š171â”Š   â”Š    allTimeMemberIds: ['2', '5'],\n-â”Š172â”Š   â”Š    listingMemberIds: ['2', '5'],\n-â”Š173â”Š   â”Š    ownerId: null,\n-â”Š174â”Š   â”Š    messages: [\n-â”Š175â”Š   â”Š      {\n-â”Š176â”Š   â”Š        id: '1',\n-â”Š177â”Š   â”Š        chatId: '5',\n-â”Š178â”Š   â”Š        senderId: '2',\n-â”Š179â”Š   â”Š        content: 'This is wicked good ice cream.',\n-â”Š180â”Š   â”Š        createdAt: moment()\n-â”Š181â”Š   â”Š          .subtract(2, 'weeks')\n-â”Š182â”Š   â”Š          .unix(),\n-â”Š183â”Š   â”Š        type: MessageType.TEXT,\n-â”Š184â”Š   â”Š        holderIds: ['2', '5'],\n-â”Š185â”Š   â”Š      },\n-â”Š186â”Š   â”Š      {\n-â”Š187â”Š   â”Š        id: '2',\n-â”Š188â”Š   â”Š        chatId: '6',\n-â”Š189â”Š   â”Š        senderId: '5',\n-â”Š190â”Š   â”Š        content: 'Love it!',\n-â”Š191â”Š   â”Š        createdAt: moment()\n-â”Š192â”Š   â”Š          .subtract(2, 'weeks')\n-â”Š193â”Š   â”Š          .add(10, 'minutes')\n-â”Š194â”Š   â”Š          .unix(),\n-â”Š195â”Š   â”Š        type: MessageType.TEXT,\n-â”Š196â”Š   â”Š        holderIds: ['5', '2'],\n-â”Š197â”Š   â”Š      },\n-â”Š198â”Š   â”Š    ],\n-â”Š199â”Š   â”Š  },\n-â”Š200â”Š   â”Š  {\n-â”Š201â”Š   â”Š    id: '6',\n-â”Š202â”Š   â”Š    name: null,\n-â”Š203â”Š   â”Š    picture: null,\n-â”Š204â”Š   â”Š    allTimeMemberIds: ['1', '6'],\n-â”Š205â”Š   â”Š    listingMemberIds: ['1'],\n-â”Š206â”Š   â”Š    ownerId: null,\n-â”Š207â”Š   â”Š    messages: [],\n-â”Š208â”Š   â”Š  },\n-â”Š209â”Š   â”Š  {\n-â”Š210â”Š   â”Š    id: '7',\n-â”Š211â”Š   â”Š    name: null,\n-â”Š212â”Š   â”Š    picture: null,\n-â”Š213â”Š   â”Š    allTimeMemberIds: ['2', '1'],\n-â”Š214â”Š   â”Š    listingMemberIds: ['2'],\n-â”Š215â”Š   â”Š    ownerId: null,\n-â”Š216â”Š   â”Š    messages: [],\n-â”Š217â”Š   â”Š  },\n-â”Š218â”Š   â”Š  {\n-â”Š219â”Š   â”Š    id: '8',\n-â”Š220â”Š   â”Š    name: 'A user 0 group',\n-â”Š221â”Š   â”Š    picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n-â”Š222â”Š   â”Š    allTimeMemberIds: ['1', '3', '4', '6'],\n-â”Š223â”Š   â”Š    listingMemberIds: ['1', '3', '4', '6'],\n-â”Š224â”Š   â”Š    ownerId: '1',\n-â”Š225â”Š   â”Š    messages: [\n-â”Š226â”Š   â”Š      {\n-â”Š227â”Š   â”Š        id: '1',\n-â”Š228â”Š   â”Š        chatId: '8',\n-â”Š229â”Š   â”Š        senderId: '1',\n-â”Š230â”Š   â”Š        content: 'I made a group',\n-â”Š231â”Š   â”Š        createdAt: moment()\n-â”Š232â”Š   â”Š          .subtract(2, 'weeks')\n-â”Š233â”Š   â”Š          .unix(),\n-â”Š234â”Š   â”Š        type: MessageType.TEXT,\n-â”Š235â”Š   â”Š        holderIds: ['1', '3', '4', '6'],\n-â”Š236â”Š   â”Š      },\n-â”Š237â”Š   â”Š      {\n-â”Š238â”Š   â”Š        id: '2',\n-â”Š239â”Š   â”Š        chatId: '8',\n-â”Š240â”Š   â”Š        senderId: '1',\n-â”Š241â”Š   â”Š        content: 'Ops, user 3 was not supposed to be here',\n-â”Š242â”Š   â”Š        createdAt: moment()\n-â”Š243â”Š   â”Š          .subtract(2, 'weeks')\n-â”Š244â”Š   â”Š          .add(2, 'minutes')\n-â”Š245â”Š   â”Š          .unix(),\n-â”Š246â”Š   â”Š        type: MessageType.TEXT,\n-â”Š247â”Š   â”Š        holderIds: ['1', '4', '6'],\n-â”Š248â”Š   â”Š      },\n-â”Š249â”Š   â”Š      {\n-â”Š250â”Š   â”Š        id: '3',\n-â”Š251â”Š   â”Š        chatId: '8',\n-â”Š252â”Š   â”Š        senderId: '4',\n-â”Š253â”Š   â”Š        content: 'Awesome!',\n-â”Š254â”Š   â”Š        createdAt: moment()\n-â”Š255â”Š   â”Š          .subtract(2, 'weeks')\n-â”Š256â”Š   â”Š          .add(10, 'minutes')\n-â”Š257â”Š   â”Š          .unix(),\n-â”Š258â”Š   â”Š        type: MessageType.TEXT,\n-â”Š259â”Š   â”Š        holderIds: ['1', '4', '6'],\n-â”Š260â”Š   â”Š      },\n-â”Š261â”Š   â”Š    ],\n-â”Š262â”Š   â”Š  },\n-â”Š263â”Š   â”Š  {\n-â”Š264â”Š   â”Š    id: '9',\n-â”Š265â”Š   â”Š    name: 'A user 5 group',\n-â”Š266â”Š   â”Š    picture: null,\n-â”Š267â”Š   â”Š    allTimeMemberIds: ['6', '3'],\n-â”Š268â”Š   â”Š    listingMemberIds: ['6', '3'],\n-â”Š269â”Š   â”Š    ownerId: '6',\n-â”Š270â”Š   â”Š    messages: [],\n-â”Š271â”Š   â”Š  },\n-â”Š272â”Š   â”Š]\n+â”Š   â”Š205â”Š  await connection.manager.save(\n+â”Š   â”Š206â”Š    new Chat({\n+â”Š   â”Š207â”Š      name: \"Ethan's group\",\n+â”Š   â”Š208â”Š      picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n+â”Š   â”Š209â”Š      allTimeMembers: [user1, user3, user4, user6],\n+â”Š   â”Š210â”Š      listingMembers: [user1, user3, user4, user6],\n+â”Š   â”Š211â”Š      owner: user1,\n+â”Š   â”Š212â”Š      messages: [\n+â”Š   â”Š213â”Š        new Message({\n+â”Š   â”Š214â”Š          sender: user1,\n+â”Š   â”Š215â”Š          content: 'I made a group',\n+â”Š   â”Š216â”Š          createdAt: moment()\n+â”Š   â”Š217â”Š            .subtract(2, 'weeks')\n+â”Š   â”Š218â”Š            .toDate(),\n+â”Š   â”Š219â”Š          type: MessageType.TEXT,\n+â”Š   â”Š220â”Š          holders: [user1, user3, user4, user6],\n+â”Š   â”Š221â”Š        }),\n+â”Š   â”Š222â”Š        new Message({\n+â”Š   â”Š223â”Š          sender: user1,\n+â”Š   â”Š224â”Š          content: 'Ops, Avery was not supposed to be here',\n+â”Š   â”Š225â”Š          createdAt: moment()\n+â”Š   â”Š226â”Š            .subtract(2, 'weeks')\n+â”Š   â”Š227â”Š            .add(2, 'minutes')\n+â”Š   â”Š228â”Š            .toDate(),\n+â”Š   â”Š229â”Š          type: MessageType.TEXT,\n+â”Š   â”Š230â”Š          holders: [user1, user4, user6],\n+â”Š   â”Š231â”Š        }),\n+â”Š   â”Š232â”Š        new Message({\n+â”Š   â”Š233â”Š          sender: user4,\n+â”Š   â”Š234â”Š          content: 'Awesome!',\n+â”Š   â”Š235â”Š          createdAt: moment()\n+â”Š   â”Š236â”Š            .subtract(2, 'weeks')\n+â”Š   â”Š237â”Š            .add(10, 'minutes')\n+â”Š   â”Š238â”Š            .toDate(),\n+â”Š   â”Š239â”Š          type: MessageType.TEXT,\n+â”Š   â”Š240â”Š          holders: [user1, user4, user6],\n+â”Š   â”Š241â”Š        }),\n+â”Š   â”Š242â”Š      ],\n+â”Š   â”Š243â”Š    })\n+â”Š   â”Š244â”Š  )\n â”Š273â”Š245â”Š\n-â”Š274â”Š   â”Šexport default { users, chats }\n+â”Š   â”Š246â”Š  await connection.manager.save(\n+â”Š   â”Š247â”Š    new Chat({\n+â”Š   â”Š248â”Š      name: \"Ray's group\",\n+â”Š   â”Š249â”Š      allTimeMembers: [user3, user6],\n+â”Š   â”Š250â”Š      listingMembers: [user3, user6],\n+â”Š   â”Š251â”Š      owner: user6,\n+â”Š   â”Š252â”Š    })\n+â”Š   â”Š253â”Š  )\n+â”Š   â”Š254â”Š}\n```\n\n[}]: #\n\nInstead of adding the sample data any time we start the server, we will use an `--add-sample-data` flag which will be provided to the server's process:\n\n[{]: <helper> (diffStep 1.6 files=\"index.ts\" module=\"server\")\n\n#### Step 1.6: Implement resolvers against TypeORM\n\n##### Changed index.ts\n```diff\n@@ -1,3 +1,4 @@\n+â”Š â”Š1â”Šimport 'reflect-metadata'\n â”Š1â”Š2â”Šimport { ApolloServer } from 'apollo-server-express'\n â”Š2â”Š3â”Šimport bodyParser from 'body-parser'\n â”Š3â”Š4â”Šimport cors from 'cors'\n```\n```diff\n@@ -5,11 +6,16 @@\n â”Š 5â”Š 6â”Šimport gql from 'graphql-tag'\n â”Š 6â”Š 7â”Šimport { createServer } from 'http'\n â”Š 7â”Š 8â”Šimport { createConnection } from 'typeorm'\n+â”Š  â”Š 9â”Šimport { addSampleData } from './db'\n â”Š 8â”Š10â”Šimport schema from './schema'\n â”Š 9â”Š11â”Š\n â”Š10â”Š12â”Šconst PORT = 4000\n â”Š11â”Š13â”Š\n â”Š12â”Š14â”ŠcreateConnection().then((connection) => {\n+â”Š  â”Š15â”Š  if (process.argv.includes('--add-sample-data')) {\n+â”Š  â”Š16â”Š    addSampleData(connection)\n+â”Š  â”Š17â”Š  }\n+â”Š  â”Š18â”Š\n â”Š13â”Š19â”Š  const app = express()\n â”Š14â”Š20â”Š\n â”Š15â”Š21â”Š  app.use(cors())\n```\n```diff\n@@ -17,7 +23,10 @@\n â”Š17â”Š23â”Š\n â”Š18â”Š24â”Š  const apollo = new ApolloServer({\n â”Š19â”Š25â”Š    schema,\n-â”Š20â”Š  â”Š    context: () => ({ connection }),\n+â”Š  â”Š26â”Š    context: () => ({\n+â”Š  â”Š27â”Š      connection,\n+â”Š  â”Š28â”Š      currentUser: { id: '1' },\n+â”Š  â”Š29â”Š    }),\n â”Š21â”Š30â”Š  })\n â”Š22â”Š31â”Š\n â”Š23â”Š32â”Š  apollo.applyMiddleware({\n```\n\n[}]: #\n\n> More about processes can be read [here](https://medium.com/the-guild/getting-to-know-nodes-child-process-module-8ed63038f3fa).\n\nMost Apollo-server implementations will assemble the GraphQL schema by importing a bunch of resolvers from different modules, if not having everything in a single place. This often times leads to a lot of problems as maintenance becomes harder the bigger the server gets, especially if we don't have a defined structure. Instead of going with that approach, we will be using [GraphQL-Modules](https://graphql-modules.com) (GQLModules, in short).\n\nThe idea behind GQLModules is to implement the Separation of Concerns design pattern in GraphQL, and to allow you to write simple modules that only do what they need to. This way it's easier to write, maintain and test. You should get a better understanding of GQLModules as we go further with this tutorial.\n\nTo setup GQLModules we will install a couple of packages:\n\n    $ yarn add @graphql-modules/core@0.4.2 @graphql-modules/sonar@0.4.0 @graphql-modules/di@0.4.0\n\n- The `sonar` package will be sued to detect `.graphql` files within our server.\n- The `di` package is responsible for dependencies injection.\n\nNow we're gonna implement a dedicated GraphQL module for each of our entity:\n\n[{]: <helper> (diffStep 1.7 files=\"modules/\\(utils|auth|chat|message|user\\)\" module=\"server\")\n\n#### Step 1.7: Transition to GraphQL Modules\n\n##### Added modules&#x2F;auth&#x2F;index.ts\n```diff\n@@ -0,0 +1,12 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core'\n+â”Š  â”Š 2â”Šimport { Connection } from 'typeorm'\n+â”Š  â”Š 3â”Šimport { AuthProvider } from './providers/auth.provider'\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šexport const AuthModule = new GraphQLModule({\n+â”Š  â”Š 6â”Š  name: 'Auth',\n+â”Š  â”Š 7â”Š  providers: ({ config: { connection } }) => [\n+â”Š  â”Š 8â”Š    { provide: Connection, useValue: connection },\n+â”Š  â”Š 9â”Š    AuthProvider,\n+â”Š  â”Š10â”Š  ],\n+â”Š  â”Š11â”Š  configRequired: true,\n+â”Š  â”Š12â”Š})\n```\n\n##### Added modules&#x2F;auth&#x2F;providers&#x2F;auth.provider.ts\n```diff\n@@ -0,0 +1,27 @@\n+â”Š  â”Š 1â”Šimport { OnRequest } from '@graphql-modules/core'\n+â”Š  â”Š 2â”Šimport { Injectable } from '@graphql-modules/di'\n+â”Š  â”Š 3â”Šimport { Connection } from 'typeorm'\n+â”Š  â”Š 4â”Šimport { User } from '../../../entity/user'\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Š@Injectable()\n+â”Š  â”Š 7â”Šexport class AuthProvider implements OnRequest {\n+â”Š  â”Š 8â”Š  currentUser: User\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Š  constructor(\n+â”Š  â”Š11â”Š    private connection: Connection\n+â”Š  â”Š12â”Š  ) {}\n+â”Š  â”Š13â”Š\n+â”Š  â”Š14â”Š  async onRequest() {\n+â”Š  â”Š15â”Š    if (this.currentUser) return\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š\n+â”Š  â”Š18â”Š    const currentUser = await this.connection\n+â”Š  â”Š19â”Š      .createQueryBuilder(User, 'user')\n+â”Š  â”Š20â”Š      .getOne()\n+â”Š  â”Š21â”Š\n+â”Š  â”Š22â”Š    if (currentUser) {\n+â”Š  â”Š23â”Š      console.log(currentUser)\n+â”Š  â”Š24â”Š      this.currentUser = currentUser\n+â”Š  â”Š25â”Š    }\n+â”Š  â”Š26â”Š  }\n+â”Š  â”Š27â”Š}\n```\n\n##### Added modules&#x2F;chat&#x2F;index.ts\n```diff\n@@ -0,0 +1,16 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core'\n+â”Š  â”Š 2â”Šimport { ProviderScope } from '@graphql-modules/di'\n+â”Š  â”Š 3â”Šimport { loadResolversFiles, loadSchemaFiles } from '@graphql-modules/sonar'\n+â”Š  â”Š 4â”Šimport { AuthModule } from '../auth'\n+â”Š  â”Š 5â”Šimport { UserModule } from '../user'\n+â”Š  â”Š 6â”Šimport { UtilsModule } from '../utils.module'\n+â”Š  â”Š 7â”Šimport { ChatProvider } from './providers/chat.provider'\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Šexport const ChatModule = new GraphQLModule({\n+â”Š  â”Š10â”Š  name: 'Chat',\n+â”Š  â”Š11â”Š  imports: [AuthModule, UtilsModule, UserModule],\n+â”Š  â”Š12â”Š  providers: [ChatProvider],\n+â”Š  â”Š13â”Š  defaultProviderScope: ProviderScope.Session,\n+â”Š  â”Š14â”Š  typeDefs: loadSchemaFiles(__dirname + '/schema/'),\n+â”Š  â”Š15â”Š  resolvers: loadResolversFiles(__dirname + '/resolvers/'),\n+â”Š  â”Š16â”Š})\n```\n\n##### Added modules&#x2F;chat&#x2F;providers&#x2F;chat.provider.ts\n```diff\n@@ -0,0 +1,111 @@\n+â”Š   â”Š  1â”Šimport { Injectable } from '@graphql-modules/di'\n+â”Š   â”Š  2â”Šimport { Connection } from 'typeorm'\n+â”Š   â”Š  3â”Šimport { Chat } from '../../../entity/chat'\n+â”Š   â”Š  4â”Šimport { User } from '../../../entity/user'\n+â”Š   â”Š  5â”Šimport { AuthProvider } from '../../auth/providers/auth.provider'\n+â”Š   â”Š  6â”Šimport { UserProvider } from '../../user/providers/user.provider'\n+â”Š   â”Š  7â”Š\n+â”Š   â”Š  8â”Š@Injectable()\n+â”Š   â”Š  9â”Šexport class ChatProvider {\n+â”Š   â”Š 10â”Š  constructor(\n+â”Š   â”Š 11â”Š    private connection: Connection,\n+â”Š   â”Š 12â”Š    private userProvider: UserProvider,\n+â”Š   â”Š 13â”Š    private authProvider: AuthProvider\n+â”Š   â”Š 14â”Š  ) {}\n+â”Š   â”Š 15â”Š\n+â”Š   â”Š 16â”Š  repository = this.connection.getRepository(Chat)\n+â”Š   â”Š 17â”Š  currentUser = this.authProvider.currentUser\n+â”Š   â”Š 18â”Š\n+â”Š   â”Š 19â”Š  createQueryBuilder() {\n+â”Š   â”Š 20â”Š    return this.connection.createQueryBuilder(Chat, 'chat')\n+â”Š   â”Š 21â”Š  }\n+â”Š   â”Š 22â”Š\n+â”Š   â”Š 23â”Š  async getChats() {\n+â”Š   â”Š 24â”Š    return this.createQueryBuilder()\n+â”Š   â”Š 25â”Š      .leftJoin('chat.listingMembers', 'listingMembers')\n+â”Š   â”Š 26â”Š      .where('listingMembers.id = :id', { id: this.currentUser.id })\n+â”Š   â”Š 27â”Š      .orderBy('chat.createdAt', 'DESC')\n+â”Š   â”Š 28â”Š      .getMany()\n+â”Š   â”Š 29â”Š  }\n+â”Š   â”Š 30â”Š\n+â”Š   â”Š 31â”Š  async getChat(chatId: string) {\n+â”Š   â”Š 32â”Š    const chat = await this.createQueryBuilder()\n+â”Š   â”Š 33â”Š      .whereInIds(chatId)\n+â”Š   â”Š 34â”Š      .getOne()\n+â”Š   â”Š 35â”Š\n+â”Š   â”Š 36â”Š    return chat || null\n+â”Š   â”Š 37â”Š  }\n+â”Š   â”Š 38â”Š\n+â”Š   â”Š 39â”Š  async getChatName(chat: Chat) {\n+â”Š   â”Š 40â”Š    if (chat.name) {\n+â”Š   â”Š 41â”Š      return chat.name\n+â”Š   â”Š 42â”Š    }\n+â”Š   â”Š 43â”Š\n+â”Š   â”Š 44â”Š    const user = await this.userProvider\n+â”Š   â”Š 45â”Š      .createQueryBuilder()\n+â”Š   â”Š 46â”Š      .where('user.id != :userId', { userId: this.currentUser.id })\n+â”Š   â”Š 47â”Š      .innerJoin(\n+â”Š   â”Š 48â”Š        'user.allTimeMemberChats',\n+â”Š   â”Š 49â”Š        'allTimeMemberChats',\n+â”Š   â”Š 50â”Š        'allTimeMemberChats.id = :chatId',\n+â”Š   â”Š 51â”Š        { chatId: chat.id }\n+â”Š   â”Š 52â”Š      )\n+â”Š   â”Š 53â”Š      .getOne()\n+â”Š   â”Š 54â”Š\n+â”Š   â”Š 55â”Š    return (user && user.name) || null\n+â”Š   â”Š 56â”Š  }\n+â”Š   â”Š 57â”Š\n+â”Š   â”Š 58â”Š  async getChatPicture(chat: Chat) {\n+â”Š   â”Š 59â”Š    if (chat.name) {\n+â”Š   â”Š 60â”Š      return chat.picture\n+â”Š   â”Š 61â”Š    }\n+â”Š   â”Š 62â”Š\n+â”Š   â”Š 63â”Š    const user = await this.userProvider\n+â”Š   â”Š 64â”Š      .createQueryBuilder()\n+â”Š   â”Š 65â”Š      .where('user.id != :userId', { userId: this.currentUser.id })\n+â”Š   â”Š 66â”Š      .innerJoin(\n+â”Š   â”Š 67â”Š        'user.allTimeMemberChats',\n+â”Š   â”Š 68â”Š        'allTimeMemberChats',\n+â”Š   â”Š 69â”Š        'allTimeMemberChats.id = :chatId',\n+â”Š   â”Š 70â”Š        { chatId: chat.id }\n+â”Š   â”Š 71â”Š      )\n+â”Š   â”Š 72â”Š      .getOne()\n+â”Š   â”Š 73â”Š\n+â”Š   â”Š 74â”Š    return user ? user.picture : null\n+â”Š   â”Š 75â”Š  }\n+â”Š   â”Š 76â”Š\n+â”Š   â”Š 77â”Š  getChatAllTimeMembers(chat: Chat) {\n+â”Š   â”Š 78â”Š    return this.userProvider\n+â”Š   â”Š 79â”Š      .createQueryBuilder()\n+â”Š   â”Š 80â”Š      .innerJoin(\n+â”Š   â”Š 81â”Š        'user.listingMemberChats',\n+â”Š   â”Š 82â”Š        'listingMemberChats',\n+â”Š   â”Š 83â”Š        'listingMemberChats.id = :chatId',\n+â”Š   â”Š 84â”Š        { chatId: chat.id }\n+â”Š   â”Š 85â”Š      )\n+â”Š   â”Š 86â”Š      .getMany()\n+â”Š   â”Š 87â”Š  }\n+â”Š   â”Š 88â”Š\n+â”Š   â”Š 89â”Š  getChatListingMembers(chat: Chat) {\n+â”Š   â”Š 90â”Š    return this.userProvider\n+â”Š   â”Š 91â”Š      .createQueryBuilder()\n+â”Š   â”Š 92â”Š      .innerJoin(\n+â”Š   â”Š 93â”Š        'user.listingMemberChats',\n+â”Š   â”Š 94â”Š        'listingMemberChats',\n+â”Š   â”Š 95â”Š        'listingMemberChats.id = :chatId',\n+â”Š   â”Š 96â”Š        { chatId: chat.id }\n+â”Š   â”Š 97â”Š      )\n+â”Š   â”Š 98â”Š      .getMany()\n+â”Š   â”Š 99â”Š  }\n+â”Š   â”Š100â”Š\n+â”Š   â”Š101â”Š  async getChatOwner(chat: Chat) {\n+â”Š   â”Š102â”Š    const owner = await this.userProvider\n+â”Š   â”Š103â”Š      .createQueryBuilder()\n+â”Š   â”Š104â”Š      .innerJoin('user.ownerChats', 'ownerChats', 'ownerChats.id = :chatId', {\n+â”Š   â”Š105â”Š        chatId: chat.id,\n+â”Š   â”Š106â”Š      })\n+â”Š   â”Š107â”Š      .getOne()\n+â”Š   â”Š108â”Š\n+â”Š   â”Š109â”Š    return owner || null\n+â”Š   â”Š110â”Š  }\n+â”Š   â”Š111â”Š}\n```\n\n##### Added modules&#x2F;chat&#x2F;resolvers&#x2F;resolvers.ts\n```diff\n@@ -0,0 +1,19 @@\n+â”Š  â”Š 1â”Šimport { ModuleContext } from '@graphql-modules/core'\n+â”Š  â”Š 2â”Šimport { IResolvers } from '../../../types'\n+â”Š  â”Š 3â”Šimport { ChatProvider } from '../providers/chat.provider'\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šexport default {\n+â”Š  â”Š 6â”Š  Query: {\n+â”Š  â”Š 7â”Š    chats: (obj, args, { injector }) => injector.get(ChatProvider).getChats(),\n+â”Š  â”Š 8â”Š    chat: (obj, { chatId }, { injector }) => injector.get(ChatProvider).getChat(chatId),\n+â”Š  â”Š 9â”Š  },\n+â”Š  â”Š10â”Š  Chat: {\n+â”Š  â”Š11â”Š    name: (chat, args, { injector }) => injector.get(ChatProvider).getChatName(chat),\n+â”Š  â”Š12â”Š    picture: (chat, args, { injector }) => injector.get(ChatProvider).getChatPicture(chat),\n+â”Š  â”Š13â”Š    allTimeMembers: (chat, args, { injector }) =>\n+â”Š  â”Š14â”Š      injector.get(ChatProvider).getChatAllTimeMembers(chat),\n+â”Š  â”Š15â”Š    listingMembers: (chat, args, { injector }) =>\n+â”Š  â”Š16â”Š      injector.get(ChatProvider).getChatListingMembers(chat),\n+â”Š  â”Š17â”Š    owner: (chat, args, { injector }) => injector.get(ChatProvider).getChatOwner(chat),\n+â”Š  â”Š18â”Š  },\n+â”Š  â”Š19â”Š} as IResolvers\n```\n\n##### Added modules&#x2F;chat&#x2F;schema&#x2F;typeDefs.graphql\n```diff\n@@ -0,0 +1,19 @@\n+â”Š  â”Š 1â”Štype Query {\n+â”Š  â”Š 2â”Š  chats: [Chat!]!\n+â”Š  â”Š 3â”Š  chat(chatId: ID!): Chat\n+â”Š  â”Š 4â”Š}\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Štype Chat {\n+â”Š  â”Š 7â”Š  #May be a chat or a group\n+â”Š  â”Š 8â”Š  id: ID!\n+â”Š  â”Š 9â”Š  #Computed for chats\n+â”Š  â”Š10â”Š  name: String\n+â”Š  â”Š11â”Š  #Computed for chats\n+â”Š  â”Š12â”Š  picture: String\n+â”Š  â”Š13â”Š  #All members, current and past ones.\n+â”Š  â”Š14â”Š  allTimeMembers: [User!]!\n+â”Š  â”Š15â”Š  #Whoever gets the chat listed. For groups includes past members who still didn't delete the group.\n+â”Š  â”Š16â”Š  listingMembers: [User!]!\n+â”Š  â”Š17â”Š  #If null the group is read-only. Null for chats.\n+â”Š  â”Š18â”Š  owner: User\n+â”Š  â”Š19â”Š}\n```\n\n##### Added modules&#x2F;message&#x2F;index.ts\n```diff\n@@ -0,0 +1,24 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core'\n+â”Š  â”Š 2â”Šimport { ProviderScope } from '@graphql-modules/di'\n+â”Š  â”Š 3â”Šimport { loadResolversFiles, loadSchemaFiles } from '@graphql-modules/sonar'\n+â”Š  â”Š 4â”Šimport { AuthModule } from '../auth'\n+â”Š  â”Š 5â”Šimport { ChatModule } from '../chat'\n+â”Š  â”Š 6â”Šimport { UserModule } from '../user'\n+â”Š  â”Š 7â”Šimport { UtilsModule } from '../utils.module'\n+â”Š  â”Š 8â”Šimport { MessageProvider } from './providers/message.provider'\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Šexport const MessageModule = new GraphQLModule({\n+â”Š  â”Š11â”Š  name: 'Message',\n+â”Š  â”Š12â”Š  imports: [\n+â”Š  â”Š13â”Š    AuthModule,\n+â”Š  â”Š14â”Š    UtilsModule,\n+â”Š  â”Š15â”Š    UserModule,\n+â”Š  â”Š16â”Š    ChatModule,\n+â”Š  â”Š17â”Š  ],\n+â”Š  â”Š18â”Š  providers: [\n+â”Š  â”Š19â”Š    MessageProvider,\n+â”Š  â”Š20â”Š  ],\n+â”Š  â”Š21â”Š  defaultProviderScope: ProviderScope.Session,\n+â”Š  â”Š22â”Š  typeDefs: loadSchemaFiles(__dirname + '/schema/'),\n+â”Š  â”Š23â”Š  resolvers: loadResolversFiles(__dirname + '/resolvers/'),\n+â”Š  â”Š24â”Š})\n```\n\n##### Added modules&#x2F;message&#x2F;providers&#x2F;message.provider.ts\n```diff\n@@ -0,0 +1,142 @@\n+â”Š   â”Š  1â”Šimport { Injectable } from '@graphql-modules/di'\n+â”Š   â”Š  2â”Šimport { Connection } from 'typeorm'\n+â”Š   â”Š  3â”Šimport { MessageType } from '../../../db'\n+â”Š   â”Š  4â”Šimport { Chat } from '../../../entity/chat'\n+â”Š   â”Š  5â”Šimport { Message } from '../../../entity/message'\n+â”Š   â”Š  6â”Šimport { User } from '../../../entity/user'\n+â”Š   â”Š  7â”Šimport { AuthProvider } from '../../auth/providers/auth.provider'\n+â”Š   â”Š  8â”Šimport { ChatProvider } from '../../chat/providers/chat.provider'\n+â”Š   â”Š  9â”Šimport { UserProvider } from '../../user/providers/user.provider'\n+â”Š   â”Š 10â”Š\n+â”Š   â”Š 11â”Š@Injectable()\n+â”Š   â”Š 12â”Šexport class MessageProvider {\n+â”Š   â”Š 13â”Š  constructor(\n+â”Š   â”Š 14â”Š    private connection: Connection,\n+â”Š   â”Š 15â”Š    private chatProvider: ChatProvider,\n+â”Š   â”Š 16â”Š    private authProvider: AuthProvider,\n+â”Š   â”Š 17â”Š    private userProvider: UserProvider\n+â”Š   â”Š 18â”Š  ) {}\n+â”Š   â”Š 19â”Š\n+â”Š   â”Š 20â”Š  repository = this.connection.getRepository(Message)\n+â”Š   â”Š 21â”Š  currentUser = this.authProvider.currentUser\n+â”Š   â”Š 22â”Š\n+â”Š   â”Š 23â”Š  createQueryBuilder() {\n+â”Š   â”Š 24â”Š    return this.connection.createQueryBuilder(Message, 'message')\n+â”Š   â”Š 25â”Š  }\n+â”Š   â”Š 26â”Š\n+â”Š   â”Š 27â”Š  async getMessageSender(message: Message) {\n+â”Š   â”Š 28â”Š    const sender = await this.userProvider\n+â”Š   â”Š 29â”Š      .createQueryBuilder()\n+â”Š   â”Š 30â”Š      .innerJoin('user.senderMessages', 'senderMessages', 'senderMessages.id = :messageId', {\n+â”Š   â”Š 31â”Š        messageId: message.id,\n+â”Š   â”Š 32â”Š      })\n+â”Š   â”Š 33â”Š      .getOne()\n+â”Š   â”Š 34â”Š\n+â”Š   â”Š 35â”Š    if (!sender) {\n+â”Š   â”Š 36â”Š      throw new Error(`Message must have a sender.`)\n+â”Š   â”Š 37â”Š    }\n+â”Š   â”Š 38â”Š\n+â”Š   â”Š 39â”Š    return sender\n+â”Š   â”Š 40â”Š  }\n+â”Š   â”Š 41â”Š\n+â”Š   â”Š 42â”Š  async getMessageOwnership(message: Message) {\n+â”Š   â”Š 43â”Š    return !!(await this.userProvider\n+â”Š   â”Š 44â”Š      .createQueryBuilder()\n+â”Š   â”Š 45â”Š      .whereInIds(this.currentUser.id)\n+â”Š   â”Š 46â”Š      .innerJoin('user.senderMessages', 'senderMessages', 'senderMessages.id = :messageId', {\n+â”Š   â”Š 47â”Š        messageId: message.id,\n+â”Š   â”Š 48â”Š      })\n+â”Š   â”Š 49â”Š      .getCount())\n+â”Š   â”Š 50â”Š  }\n+â”Š   â”Š 51â”Š\n+â”Š   â”Š 52â”Š  async getMessageHolders(message: Message) {\n+â”Š   â”Š 53â”Š    return await this.userProvider\n+â”Š   â”Š 54â”Š      .createQueryBuilder()\n+â”Š   â”Š 55â”Š      .innerJoin('user.holderMessages', 'holderMessages', 'holderMessages.id = :messageId', {\n+â”Š   â”Š 56â”Š        messageId: message.id,\n+â”Š   â”Š 57â”Š      })\n+â”Š   â”Š 58â”Š      .getMany()\n+â”Š   â”Š 59â”Š  }\n+â”Š   â”Š 60â”Š\n+â”Š   â”Š 61â”Š  async getMessageChat(message: Message) {\n+â”Š   â”Š 62â”Š    const chat = await this.chatProvider\n+â”Š   â”Š 63â”Š      .createQueryBuilder()\n+â”Š   â”Š 64â”Š      .innerJoin('chat.messages', 'messages', 'messages.id = :messageId', {\n+â”Š   â”Š 65â”Š        messageId: message.id,\n+â”Š   â”Š 66â”Š      })\n+â”Š   â”Š 67â”Š      .getOne()\n+â”Š   â”Š 68â”Š\n+â”Š   â”Š 69â”Š    if (!chat) {\n+â”Š   â”Š 70â”Š      throw new Error(`Message must have a chat.`)\n+â”Š   â”Š 71â”Š    }\n+â”Š   â”Š 72â”Š\n+â”Š   â”Š 73â”Š    return chat\n+â”Š   â”Š 74â”Š  }\n+â”Š   â”Š 75â”Š\n+â”Š   â”Š 76â”Š  async getChats() {\n+â”Š   â”Š 77â”Š    const chats = await this.chatProvider\n+â”Š   â”Š 78â”Š      .createQueryBuilder()\n+â”Š   â”Š 79â”Š      .leftJoin('chat.listingMembers', 'listingMembers')\n+â”Š   â”Š 80â”Š      .where('listingMembers.id = :id', { id: this.currentUser.id })\n+â”Š   â”Š 81â”Š      .getMany()\n+â”Š   â”Š 82â”Š\n+â”Š   â”Š 83â”Š    for (let chat of chats) {\n+â”Š   â”Š 84â”Š      chat.messages = await this.getChatMessages(chat)\n+â”Š   â”Š 85â”Š    }\n+â”Š   â”Š 86â”Š\n+â”Š   â”Š 87â”Š    return chats.sort((chatA, chatB) => {\n+â”Š   â”Š 88â”Š      const dateA = chatA.messages.length\n+â”Š   â”Š 89â”Š        ? chatA.messages[chatA.messages.length - 1].createdAt\n+â”Š   â”Š 90â”Š        : chatA.createdAt\n+â”Š   â”Š 91â”Š      const dateB = chatB.messages.length\n+â”Š   â”Š 92â”Š        ? chatB.messages[chatB.messages.length - 1].createdAt\n+â”Š   â”Š 93â”Š        : chatB.createdAt\n+â”Š   â”Š 94â”Š      return dateB.valueOf() - dateA.valueOf()\n+â”Š   â”Š 95â”Š    })\n+â”Š   â”Š 96â”Š  }\n+â”Š   â”Š 97â”Š\n+â”Š   â”Š 98â”Š  async getChatMessages(chat: Chat, amount?: number) {\n+â”Š   â”Š 99â”Š    if (chat.messages) {\n+â”Š   â”Š100â”Š      return amount ? chat.messages.slice(-amount) : chat.messages\n+â”Š   â”Š101â”Š    }\n+â”Š   â”Š102â”Š\n+â”Š   â”Š103â”Š    let query = this.createQueryBuilder()\n+â”Š   â”Š104â”Š      .innerJoin('message.chat', 'chat', 'chat.id = :chatId', { chatId: chat.id })\n+â”Š   â”Š105â”Š      .innerJoin('message.holders', 'holders', 'holders.id = :userId', {\n+â”Š   â”Š106â”Š        userId: this.currentUser.id,\n+â”Š   â”Š107â”Š      })\n+â”Š   â”Š108â”Š      .orderBy({ 'message.createdAt': { order: 'DESC', nulls: 'NULLS LAST' } })\n+â”Š   â”Š109â”Š\n+â”Š   â”Š110â”Š    if (amount) {\n+â”Š   â”Š111â”Š      query = query.take(amount)\n+â”Š   â”Š112â”Š    }\n+â”Š   â”Š113â”Š\n+â”Š   â”Š114â”Š    return (await query.getMany()).reverse()\n+â”Š   â”Š115â”Š  }\n+â”Š   â”Š116â”Š\n+â”Š   â”Š117â”Š  async getChatLastMessage(chat: Chat) {\n+â”Š   â”Š118â”Š    if (chat.messages) {\n+â”Š   â”Š119â”Š      return chat.messages.length ? chat.messages[chat.messages.length - 1] : null\n+â”Š   â”Š120â”Š    }\n+â”Š   â”Š121â”Š\n+â”Š   â”Š122â”Š    const messages = await this.getChatMessages(chat, 1)\n+â”Š   â”Š123â”Š\n+â”Š   â”Š124â”Š    return messages && messages.length ? messages[0] : null\n+â”Š   â”Š125â”Š  }\n+â”Š   â”Š126â”Š\n+â”Š   â”Š127â”Š  async getChatUpdatedAt(chat: Chat) {\n+â”Š   â”Š128â”Š    if (chat.messages) {\n+â”Š   â”Š129â”Š      return chat.messages.length ? chat.messages[0].createdAt : null\n+â”Š   â”Š130â”Š    }\n+â”Š   â”Š131â”Š\n+â”Š   â”Š132â”Š    const latestMessage = await this.createQueryBuilder()\n+â”Š   â”Š133â”Š      .innerJoin('message.chat', 'chat', 'chat.id = :chatId', { chatId: chat.id })\n+â”Š   â”Š134â”Š      .innerJoin('message.holders', 'holders', 'holders.id = :userId', {\n+â”Š   â”Š135â”Š        userId: this.currentUser.id,\n+â”Š   â”Š136â”Š      })\n+â”Š   â”Š137â”Š      .orderBy({ 'message.createdAt': 'DESC' })\n+â”Š   â”Š138â”Š      .getOne()\n+â”Š   â”Š139â”Š\n+â”Š   â”Š140â”Š    return latestMessage ? latestMessage.createdAt : null\n+â”Š   â”Š141â”Š  }\n+â”Š   â”Š142â”Š}\n```\n\n##### Added modules&#x2F;message&#x2F;resolvers&#x2F;resolvers.ts\n```diff\n@@ -0,0 +1,29 @@\n+â”Š  â”Š 1â”Šimport { ModuleContext } from '@graphql-modules/core'\n+â”Š  â”Š 2â”Šimport { Message } from '../../../entity/message'\n+â”Š  â”Š 3â”Šimport { IResolvers } from '../../../types'\n+â”Š  â”Š 4â”Šimport { MessageProvider } from '../providers/message.provider'\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šexport default {\n+â”Š  â”Š 7â”Š  Query: {\n+â”Š  â”Š 8â”Š    // The ordering depends on the messages\n+â”Š  â”Š 9â”Š    chats: (obj, args, { injector }) => injector.get(MessageProvider).getChats(),\n+â”Š  â”Š10â”Š  },\n+â”Š  â”Š11â”Š  Chat: {\n+â”Š  â”Š12â”Š    messages: async (chat, { amount }, { injector }) =>\n+â”Š  â”Š13â”Š      injector.get(MessageProvider).getChatMessages(chat, amount || 0),\n+â”Š  â”Š14â”Š    lastMessage: async (chat, args, { injector }) =>\n+â”Š  â”Š15â”Š      injector.get(MessageProvider).getChatLastMessage(chat),\n+â”Š  â”Š16â”Š    updatedAt: async (chat, args, { injector }) =>\n+â”Š  â”Š17â”Š      injector.get(MessageProvider).getChatUpdatedAt(chat),\n+â”Š  â”Š18â”Š  },\n+â”Š  â”Š19â”Š  Message: {\n+â”Š  â”Š20â”Š    sender: async (message, args, { injector }) =>\n+â”Š  â”Š21â”Š      injector.get(MessageProvider).getMessageSender(message),\n+â”Š  â”Š22â”Š    ownership: async (message, args, { injector }) =>\n+â”Š  â”Š23â”Š      injector.get(MessageProvider).getMessageOwnership(message),\n+â”Š  â”Š24â”Š    holders: async (message, args, { injector }) =>\n+â”Š  â”Š25â”Š      injector.get(MessageProvider).getMessageHolders(message),\n+â”Š  â”Š26â”Š    chat: async (message, args, { injector }) =>\n+â”Š  â”Š27â”Š      injector.get(MessageProvider).getMessageChat(message),\n+â”Š  â”Š28â”Š  },\n+â”Š  â”Š29â”Š} as IResolvers\n```\n\n##### Added modules&#x2F;message&#x2F;schema&#x2F;typeDefs.graphql\n```diff\n@@ -0,0 +1,25 @@\n+â”Š  â”Š 1â”Šenum MessageType {\n+â”Š  â”Š 2â”Š  LOCATION\n+â”Š  â”Š 3â”Š  TEXT\n+â”Š  â”Š 4â”Š  PICTURE\n+â”Š  â”Š 5â”Š}\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Šextend type Chat {\n+â”Š  â”Š 8â”Š  messages(amount: Int): [Message]!\n+â”Š  â”Š 9â”Š  lastMessage: Message\n+â”Š  â”Š10â”Š  updatedAt: Date!\n+â”Š  â”Š11â”Š}\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Štype Message {\n+â”Š  â”Š14â”Š  id: ID!\n+â”Š  â”Š15â”Š  sender: User!\n+â”Š  â”Š16â”Š  chat: Chat!\n+â”Š  â”Š17â”Š  content: String!\n+â”Š  â”Š18â”Š  createdAt: Date!\n+â”Š  â”Š19â”Š  #FIXME: should return MessageType\n+â”Š  â”Š20â”Š  type: Int!\n+â”Š  â”Š21â”Š  #Whoever still holds a copy of the message. Cannot be null because the message gets deleted otherwise\n+â”Š  â”Š22â”Š  holders: [User!]!\n+â”Š  â”Š23â”Š  #Computed property\n+â”Š  â”Š24â”Š  ownership: Boolean!\n+â”Š  â”Š25â”Š}\n```\n\n##### Added modules&#x2F;user&#x2F;index.ts\n```diff\n@@ -0,0 +1,18 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core'\n+â”Š  â”Š 2â”Šimport { InjectFunction, ProviderScope } from '@graphql-modules/di'\n+â”Š  â”Š 3â”Šimport { loadResolversFiles, loadSchemaFiles } from '@graphql-modules/sonar'\n+â”Š  â”Š 4â”Šimport { AuthModule } from '../auth'\n+â”Š  â”Š 5â”Šimport { UserProvider } from './providers/user.provider'\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Šexport const UserModule = new GraphQLModule({\n+â”Š  â”Š 8â”Š  name: 'User',\n+â”Š  â”Š 9â”Š  imports: [\n+â”Š  â”Š10â”Š    AuthModule,\n+â”Š  â”Š11â”Š  ],\n+â”Š  â”Š12â”Š  providers: [\n+â”Š  â”Š13â”Š    UserProvider,\n+â”Š  â”Š14â”Š  ],\n+â”Š  â”Š15â”Š  typeDefs: loadSchemaFiles(__dirname + '/schema/'),\n+â”Š  â”Š16â”Š  resolvers: loadResolversFiles(__dirname + '/resolvers/'),\n+â”Š  â”Š17â”Š  defaultProviderScope: ProviderScope.Session,\n+â”Š  â”Š18â”Š})\n```\n\n##### Added modules&#x2F;user&#x2F;providers&#x2F;user.provider.ts\n```diff\n@@ -0,0 +1,22 @@\n+â”Š  â”Š 1â”Šimport { Injectable, ProviderScope } from '@graphql-modules/di'\n+â”Š  â”Š 2â”Šimport { Connection } from 'typeorm'\n+â”Š  â”Š 3â”Šimport { User } from '../../../entity/user'\n+â”Š  â”Š 4â”Šimport { AuthProvider } from '../../auth/providers/auth.provider'\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Š@Injectable()\n+â”Š  â”Š 7â”Šexport class UserProvider {\n+â”Š  â”Š 8â”Š  constructor(private connection: Connection, private authProvider: AuthProvider) {}\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Š  public repository = this.connection.getRepository(User)\n+â”Š  â”Š11â”Š  private currentUser = this.authProvider.currentUser\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Š  createQueryBuilder() {\n+â”Š  â”Š14â”Š    return this.connection.createQueryBuilder(User, 'user')\n+â”Š  â”Š15â”Š  }\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š  getUsers() {\n+â”Š  â”Š18â”Š    return this.createQueryBuilder()\n+â”Š  â”Š19â”Š      .where('user.id != :id', { id: this.currentUser.id })\n+â”Š  â”Š20â”Š      .getMany()\n+â”Š  â”Š21â”Š  }\n+â”Š  â”Š22â”Š}\n```\n\n##### Added modules&#x2F;user&#x2F;resolvers&#x2F;resolvers.ts\n```diff\n@@ -0,0 +1,10 @@\n+â”Š  â”Š 1â”Šimport { ModuleContext } from '@graphql-modules/core'\n+â”Š  â”Š 2â”Šimport { User } from '../../../entity/User'\n+â”Š  â”Š 3â”Šimport { IResolvers } from '../../../types'\n+â”Š  â”Š 4â”Šimport { UserProvider } from '../providers/user.provider'\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šexport default {\n+â”Š  â”Š 7â”Š  Query: {\n+â”Š  â”Š 8â”Š    users: (obj, args, { injector }) => injector.get(UserProvider).getUsers(),\n+â”Š  â”Š 9â”Š  },\n+â”Š  â”Š10â”Š} as IResolvers\n```\n\n##### Added modules&#x2F;user&#x2F;schema&#x2F;typeDefs.graphql\n```diff\n@@ -0,0 +1,10 @@\n+â”Š  â”Š 1â”Štype Query {\n+â”Š  â”Š 2â”Š  users: [User!]\n+â”Š  â”Š 3â”Š}\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Štype User {\n+â”Š  â”Š 6â”Š  id: ID!\n+â”Š  â”Š 7â”Š  name: String\n+â”Š  â”Š 8â”Š  picture: String\n+â”Š  â”Š 9â”Š  phone: String\n+â”Š  â”Š10â”Š}\n```\n\n##### Added modules&#x2F;utils.module.ts\n```diff\n@@ -0,0 +1,12 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core'\n+â”Š  â”Š 2â”Šimport { GraphQLDateTime } from 'graphql-iso-date'\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šexport const UtilsModule = new GraphQLModule({\n+â”Š  â”Š 5â”Š  name: 'Utils',\n+â”Š  â”Š 6â”Š  typeDefs: `\n+â”Š  â”Š 7â”Š    scalar Date\n+â”Š  â”Š 8â”Š  `,\n+â”Š  â”Š 9â”Š  resolvers: {\n+â”Š  â”Š10â”Š    Date: GraphQLDateTime,\n+â”Š  â”Š11â”Š  },\n+â”Š  â”Š12â”Š})\n```\n\n[}]: #\n\nThe implementation of the resolvers is NOT implemented in the resolver functions themselves, but rather in a separate provider. With this working model we can import and use the providers in various modules, not necessarily a specific one. In addition, we can mock the provider handlers, which makes it more testable.\n\nWe've also created a module called `auth`, which will be responsible for authentication in the near future. For now we use a constant for `currentUser` so we can implement the handlers as if we already have authentication.\n\nWe will use a main GQLModule called `app` to connect all our components and export a unified schema:\n\n[{]: <helper> (diffStep 1.7 files=\"modules/app\" module=\"server\")\n\n#### Step 1.7: Transition to GraphQL Modules\n\n##### Added modules&#x2F;app.module.ts\n```diff\n@@ -0,0 +1,24 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core'\n+â”Š  â”Š 2â”Šimport { Connection } from 'typeorm'\n+â”Š  â”Š 3â”Šimport { Express } from 'express'\n+â”Š  â”Š 4â”Šimport { AuthModule } from './auth'\n+â”Š  â”Š 5â”Šimport { UserModule } from './user'\n+â”Š  â”Š 6â”Šimport { ChatModule } from './chat'\n+â”Š  â”Š 7â”Šimport { MessageModule } from './message'\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Šexport interface IAppModuleConfig {\n+â”Š  â”Š10â”Š  connection: Connection;\n+â”Š  â”Š11â”Š}\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Šexport const AppModule = new GraphQLModule<IAppModuleConfig>({\n+â”Š  â”Š14â”Š  name: 'App',\n+â”Š  â”Š15â”Š  imports: ({ config: { connection } }) => [\n+â”Š  â”Š16â”Š    AuthModule.forRoot({\n+â”Š  â”Š17â”Š      connection,\n+â”Š  â”Š18â”Š    }),\n+â”Š  â”Š19â”Š    UserModule,\n+â”Š  â”Š20â”Š    ChatModule,\n+â”Š  â”Š21â”Š    MessageModule,\n+â”Š  â”Š22â”Š  ],\n+â”Š  â”Š23â”Š  configRequired: true,\n+â”Š  â”Š24â”Š})\n```\n\n##### Added modules&#x2F;app.symbols.ts\n```diff\n@@ -0,0 +1 @@\n+â”Š â”Š1â”Šexport const APP = Symbol.for('APP')\n```\n\n[}]: #\n\nAccordingly, we will update the server to use the schema exported by the module we've just created\n\n[{]: <helper> (diffStep 1.7 files=\"index, schema\" module=\"server\")\n\n#### Step 1.7: Transition to GraphQL Modules\n\n##### Changed index.ts\n```diff\n@@ -7,7 +7,7 @@\n â”Š 7â”Š 7â”Šimport { createServer } from 'http'\n â”Š 8â”Š 8â”Šimport { createConnection } from 'typeorm'\n â”Š 9â”Š 9â”Šimport { addSampleData } from './db'\n-â”Š10â”Š  â”Šimport schema from './schema'\n+â”Š  â”Š10â”Šimport { AppModule } from './modules/app.module'\n â”Š11â”Š11â”Š\n â”Š12â”Š12â”Šconst PORT = 4000\n â”Š13â”Š13â”Š\n```\n```diff\n@@ -21,12 +21,11 @@\n â”Š21â”Š21â”Š  app.use(cors())\n â”Š22â”Š22â”Š  app.use(bodyParser.json())\n â”Š23â”Š23â”Š\n+â”Š  â”Š24â”Š  const { schema, context } = AppModule.forRoot({ connection })\n+â”Š  â”Š25â”Š\n â”Š24â”Š26â”Š  const apollo = new ApolloServer({\n â”Š25â”Š27â”Š    schema,\n-â”Š26â”Š  â”Š    context: () => ({\n-â”Š27â”Š  â”Š      connection,\n-â”Š28â”Š  â”Š      currentUser: { id: '1' },\n-â”Š29â”Š  â”Š    }),\n+â”Š  â”Š28â”Š    context,\n â”Š30â”Š29â”Š  })\n â”Š31â”Š30â”Š\n â”Š32â”Š31â”Š  apollo.applyMiddleware({\n```\n\n##### Added modules&#x2F;auth&#x2F;index.ts\n```diff\n@@ -0,0 +1,12 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core'\n+â”Š  â”Š 2â”Šimport { Connection } from 'typeorm'\n+â”Š  â”Š 3â”Šimport { AuthProvider } from './providers/auth.provider'\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šexport const AuthModule = new GraphQLModule({\n+â”Š  â”Š 6â”Š  name: 'Auth',\n+â”Š  â”Š 7â”Š  providers: ({ config: { connection } }) => [\n+â”Š  â”Š 8â”Š    { provide: Connection, useValue: connection },\n+â”Š  â”Š 9â”Š    AuthProvider,\n+â”Š  â”Š10â”Š  ],\n+â”Š  â”Š11â”Š  configRequired: true,\n+â”Š  â”Š12â”Š})\n```\n\n##### Added modules&#x2F;chat&#x2F;index.ts\n```diff\n@@ -0,0 +1,16 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core'\n+â”Š  â”Š 2â”Šimport { ProviderScope } from '@graphql-modules/di'\n+â”Š  â”Š 3â”Šimport { loadResolversFiles, loadSchemaFiles } from '@graphql-modules/sonar'\n+â”Š  â”Š 4â”Šimport { AuthModule } from '../auth'\n+â”Š  â”Š 5â”Šimport { UserModule } from '../user'\n+â”Š  â”Š 6â”Šimport { UtilsModule } from '../utils.module'\n+â”Š  â”Š 7â”Šimport { ChatProvider } from './providers/chat.provider'\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Šexport const ChatModule = new GraphQLModule({\n+â”Š  â”Š10â”Š  name: 'Chat',\n+â”Š  â”Š11â”Š  imports: [AuthModule, UtilsModule, UserModule],\n+â”Š  â”Š12â”Š  providers: [ChatProvider],\n+â”Š  â”Š13â”Š  defaultProviderScope: ProviderScope.Session,\n+â”Š  â”Š14â”Š  typeDefs: loadSchemaFiles(__dirname + '/schema/'),\n+â”Š  â”Š15â”Š  resolvers: loadResolversFiles(__dirname + '/resolvers/'),\n+â”Š  â”Š16â”Š})\n```\n\n##### Added modules&#x2F;chat&#x2F;schema&#x2F;typeDefs.graphql\n```diff\n@@ -0,0 +1,19 @@\n+â”Š  â”Š 1â”Štype Query {\n+â”Š  â”Š 2â”Š  chats: [Chat!]!\n+â”Š  â”Š 3â”Š  chat(chatId: ID!): Chat\n+â”Š  â”Š 4â”Š}\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Štype Chat {\n+â”Š  â”Š 7â”Š  #May be a chat or a group\n+â”Š  â”Š 8â”Š  id: ID!\n+â”Š  â”Š 9â”Š  #Computed for chats\n+â”Š  â”Š10â”Š  name: String\n+â”Š  â”Š11â”Š  #Computed for chats\n+â”Š  â”Š12â”Š  picture: String\n+â”Š  â”Š13â”Š  #All members, current and past ones.\n+â”Š  â”Š14â”Š  allTimeMembers: [User!]!\n+â”Š  â”Š15â”Š  #Whoever gets the chat listed. For groups includes past members who still didn't delete the group.\n+â”Š  â”Š16â”Š  listingMembers: [User!]!\n+â”Š  â”Š17â”Š  #If null the group is read-only. Null for chats.\n+â”Š  â”Š18â”Š  owner: User\n+â”Š  â”Š19â”Š}\n```\n\n##### Added modules&#x2F;message&#x2F;index.ts\n```diff\n@@ -0,0 +1,24 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core'\n+â”Š  â”Š 2â”Šimport { ProviderScope } from '@graphql-modules/di'\n+â”Š  â”Š 3â”Šimport { loadResolversFiles, loadSchemaFiles } from '@graphql-modules/sonar'\n+â”Š  â”Š 4â”Šimport { AuthModule } from '../auth'\n+â”Š  â”Š 5â”Šimport { ChatModule } from '../chat'\n+â”Š  â”Š 6â”Šimport { UserModule } from '../user'\n+â”Š  â”Š 7â”Šimport { UtilsModule } from '../utils.module'\n+â”Š  â”Š 8â”Šimport { MessageProvider } from './providers/message.provider'\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Šexport const MessageModule = new GraphQLModule({\n+â”Š  â”Š11â”Š  name: 'Message',\n+â”Š  â”Š12â”Š  imports: [\n+â”Š  â”Š13â”Š    AuthModule,\n+â”Š  â”Š14â”Š    UtilsModule,\n+â”Š  â”Š15â”Š    UserModule,\n+â”Š  â”Š16â”Š    ChatModule,\n+â”Š  â”Š17â”Š  ],\n+â”Š  â”Š18â”Š  providers: [\n+â”Š  â”Š19â”Š    MessageProvider,\n+â”Š  â”Š20â”Š  ],\n+â”Š  â”Š21â”Š  defaultProviderScope: ProviderScope.Session,\n+â”Š  â”Š22â”Š  typeDefs: loadSchemaFiles(__dirname + '/schema/'),\n+â”Š  â”Š23â”Š  resolvers: loadResolversFiles(__dirname + '/resolvers/'),\n+â”Š  â”Š24â”Š})\n```\n\n##### Added modules&#x2F;message&#x2F;schema&#x2F;typeDefs.graphql\n```diff\n@@ -0,0 +1,25 @@\n+â”Š  â”Š 1â”Šenum MessageType {\n+â”Š  â”Š 2â”Š  LOCATION\n+â”Š  â”Š 3â”Š  TEXT\n+â”Š  â”Š 4â”Š  PICTURE\n+â”Š  â”Š 5â”Š}\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Šextend type Chat {\n+â”Š  â”Š 8â”Š  messages(amount: Int): [Message]!\n+â”Š  â”Š 9â”Š  lastMessage: Message\n+â”Š  â”Š10â”Š  updatedAt: Date!\n+â”Š  â”Š11â”Š}\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Štype Message {\n+â”Š  â”Š14â”Š  id: ID!\n+â”Š  â”Š15â”Š  sender: User!\n+â”Š  â”Š16â”Š  chat: Chat!\n+â”Š  â”Š17â”Š  content: String!\n+â”Š  â”Š18â”Š  createdAt: Date!\n+â”Š  â”Š19â”Š  #FIXME: should return MessageType\n+â”Š  â”Š20â”Š  type: Int!\n+â”Š  â”Š21â”Š  #Whoever still holds a copy of the message. Cannot be null because the message gets deleted otherwise\n+â”Š  â”Š22â”Š  holders: [User!]!\n+â”Š  â”Š23â”Š  #Computed property\n+â”Š  â”Š24â”Š  ownership: Boolean!\n+â”Š  â”Š25â”Š}\n```\n\n##### Added modules&#x2F;user&#x2F;index.ts\n```diff\n@@ -0,0 +1,18 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core'\n+â”Š  â”Š 2â”Šimport { InjectFunction, ProviderScope } from '@graphql-modules/di'\n+â”Š  â”Š 3â”Šimport { loadResolversFiles, loadSchemaFiles } from '@graphql-modules/sonar'\n+â”Š  â”Š 4â”Šimport { AuthModule } from '../auth'\n+â”Š  â”Š 5â”Šimport { UserProvider } from './providers/user.provider'\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Šexport const UserModule = new GraphQLModule({\n+â”Š  â”Š 8â”Š  name: 'User',\n+â”Š  â”Š 9â”Š  imports: [\n+â”Š  â”Š10â”Š    AuthModule,\n+â”Š  â”Š11â”Š  ],\n+â”Š  â”Š12â”Š  providers: [\n+â”Š  â”Š13â”Š    UserProvider,\n+â”Š  â”Š14â”Š  ],\n+â”Š  â”Š15â”Š  typeDefs: loadSchemaFiles(__dirname + '/schema/'),\n+â”Š  â”Š16â”Š  resolvers: loadResolversFiles(__dirname + '/resolvers/'),\n+â”Š  â”Š17â”Š  defaultProviderScope: ProviderScope.Session,\n+â”Š  â”Š18â”Š})\n```\n\n##### Added modules&#x2F;user&#x2F;schema&#x2F;typeDefs.graphql\n```diff\n@@ -0,0 +1,10 @@\n+â”Š  â”Š 1â”Štype Query {\n+â”Š  â”Š 2â”Š  users: [User!]\n+â”Š  â”Š 3â”Š}\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Štype User {\n+â”Š  â”Š 6â”Š  id: ID!\n+â”Š  â”Š 7â”Š  name: String\n+â”Š  â”Š 8â”Š  picture: String\n+â”Š  â”Š 9â”Š  phone: String\n+â”Š  â”Š10â”Š}\n```\n\n##### Changed schema&#x2F;index.ts\n```diff\n@@ -1,8 +1,4 @@\n-â”Š1â”Š â”Šimport { makeExecutableSchema } from 'apollo-server-express'\n-â”Š2â”Š â”Šimport resolvers from './resolvers'\n-â”Š3â”Š â”Šimport typeDefs from './typeDefs'\n+â”Š â”Š1â”Šimport 'reflect-metadata'\n+â”Š â”Š2â”Šimport { AppModule } from '../modules/app.module'\n â”Š4â”Š3â”Š\n-â”Š5â”Š â”Šexport default makeExecutableSchema({\n-â”Š6â”Š â”Š  typeDefs,\n-â”Š7â”Š â”Š  resolvers,\n-â”Š8â”Š â”Š})\n+â”Š â”Š4â”Šexport default AppModule.forRoot({} as any).schema\n```\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,197 +1,4 @@\n-â”Š  1â”Š   â”Šimport { IResolvers as IApolloResolvers } from 'apollo-server-express'\n-â”Š  2â”Š   â”Šimport { GraphQLDateTime } from 'graphql-iso-date'\n-â”Š  3â”Š   â”Šimport Chat from '../entity/chat'\n-â”Š  4â”Š   â”Šimport Message from '../entity/message'\n-â”Š  5â”Š   â”Šimport User from '../entity/user'\n-â”Š  6â”Š   â”Šimport { IResolvers } from '../types'\n+â”Š   â”Š  1â”Šimport 'reflect-metadata'\n+â”Š   â”Š  2â”Šimport { AppModule } from '../modules/app.module'\n â”Š  7â”Š  3â”Š\n-â”Š  8â”Š   â”Šexport default {\n-â”Š  9â”Š   â”Š  Date: GraphQLDateTime,\n-â”Š 10â”Š   â”Š  Query: {\n-â”Š 11â”Š   â”Š    // Show all users for the moment.\n-â”Š 12â”Š   â”Š    users: (root, args, { connection, currentUser }) => {\n-â”Š 13â”Š   â”Š      return connection.createQueryBuilder(User, 'user').where('user.id != :id', {id: currentUser.id}).getMany();\n-â”Š 14â”Š   â”Š    },\n-â”Š 15â”Š   â”Š\n-â”Š 16â”Š   â”Š    chats: (root, args, { connection, currentUser }) => {\n-â”Š 17â”Š   â”Š      return connection\n-â”Š 18â”Š   â”Š        .createQueryBuilder(Chat, 'chat')\n-â”Š 19â”Š   â”Š        .leftJoin('chat.listingMembers', 'listingMembers')\n-â”Š 20â”Š   â”Š        .where('listingMembers.id = :id', { id: currentUser.id })\n-â”Š 21â”Š   â”Š        .orderBy('chat.createdAt', 'DESC')\n-â”Š 22â”Š   â”Š        .getMany();\n-â”Š 23â”Š   â”Š    },\n-â”Š 24â”Š   â”Š\n-â”Š 25â”Š   â”Š    chat: async (root, { chatId }, { connection }) => {\n-â”Š 26â”Š   â”Š      const chat = await connection\n-â”Š 27â”Š   â”Š        .createQueryBuilder(Chat, 'chat')\n-â”Š 28â”Š   â”Š        .whereInIds(chatId)\n-â”Š 29â”Š   â”Š        .getOne();\n-â”Š 30â”Š   â”Š\n-â”Š 31â”Š   â”Š      return chat || null;\n-â”Š 32â”Š   â”Š    },\n-â”Š 33â”Š   â”Š  },\n-â”Š 34â”Š   â”Š\n-â”Š 35â”Š   â”Š  Chat: {\n-â”Š 36â”Š   â”Š    name: async (chat, args, { connection, currentUser }) => {\n-â”Š 37â”Š   â”Š      if (chat.name) {\n-â”Š 38â”Š   â”Š        return chat.name;\n-â”Š 39â”Š   â”Š      }\n-â”Š 40â”Š   â”Š\n-â”Š 41â”Š   â”Š      const user = await connection\n-â”Š 42â”Š   â”Š        .createQueryBuilder(User, 'user')\n-â”Š 43â”Š   â”Š        .where('user.id != :userId', { userId: currentUser.id })\n-â”Š 44â”Š   â”Š        .innerJoin(\n-â”Š 45â”Š   â”Š          'user.allTimeMemberChats',\n-â”Š 46â”Š   â”Š          'allTimeMemberChats',\n-â”Š 47â”Š   â”Š          'allTimeMemberChats.id = :chatId',\n-â”Š 48â”Š   â”Š          { chatId: chat.id },\n-â”Š 49â”Š   â”Š        )\n-â”Š 50â”Š   â”Š        .getOne();\n-â”Š 51â”Š   â”Š\n-â”Š 52â”Š   â”Š      return user ? user.name : null\n-â”Š 53â”Š   â”Š    },\n-â”Š 54â”Š   â”Š\n-â”Š 55â”Š   â”Š    picture: async (chat, args, { connection, currentUser }) => {\n-â”Š 56â”Š   â”Š      if (chat.picture) {\n-â”Š 57â”Š   â”Š        return chat.picture;\n-â”Š 58â”Š   â”Š      }\n-â”Š 59â”Š   â”Š\n-â”Š 60â”Š   â”Š      const user = await connection\n-â”Š 61â”Š   â”Š        .createQueryBuilder(User, 'user')\n-â”Š 62â”Š   â”Š        .where('user.id != :userId', { userId: currentUser.id })\n-â”Š 63â”Š   â”Š        .innerJoin(\n-â”Š 64â”Š   â”Š          'user.allTimeMemberChats',\n-â”Š 65â”Š   â”Š          'allTimeMemberChats',\n-â”Š 66â”Š   â”Š          'allTimeMemberChats.id = :chatId',\n-â”Š 67â”Š   â”Š          { chatId: chat.id },\n-â”Š 68â”Š   â”Š        )\n-â”Š 69â”Š   â”Š        .getOne();\n-â”Š 70â”Š   â”Š\n-â”Š 71â”Š   â”Š      return user ? user.picture : null\n-â”Š 72â”Š   â”Š    },\n-â”Š 73â”Š   â”Š\n-â”Š 74â”Š   â”Š    allTimeMembers: (chat, args, { connection }) => {\n-â”Š 75â”Š   â”Š      return connection\n-â”Š 76â”Š   â”Š        .createQueryBuilder(User, 'user')\n-â”Š 77â”Š   â”Š        .innerJoin(\n-â”Š 78â”Š   â”Š          'user.listingMemberChats',\n-â”Š 79â”Š   â”Š          'listingMemberChats',\n-â”Š 80â”Š   â”Š          'listingMemberChats.id = :chatId',\n-â”Š 81â”Š   â”Š          { chatId: chat.id },\n-â”Š 82â”Š   â”Š        )\n-â”Š 83â”Š   â”Š        .getMany()\n-â”Š 84â”Š   â”Š    },\n-â”Š 85â”Š   â”Š\n-â”Š 86â”Š   â”Š    listingMembers: (chat, args, { connection }) => {\n-â”Š 87â”Š   â”Š      return connection\n-â”Š 88â”Š   â”Š        .createQueryBuilder(User, 'user')\n-â”Š 89â”Š   â”Š        .innerJoin(\n-â”Š 90â”Š   â”Š          'user.listingMemberChats',\n-â”Š 91â”Š   â”Š          'listingMemberChats',\n-â”Š 92â”Š   â”Š          'listingMemberChats.id = :chatId',\n-â”Š 93â”Š   â”Š          { chatId: chat.id },\n-â”Š 94â”Š   â”Š        )\n-â”Š 95â”Š   â”Š        .getMany();\n-â”Š 96â”Š   â”Š    },\n-â”Š 97â”Š   â”Š\n-â”Š 98â”Š   â”Š    owner: async (chat, args, { connection }) => {\n-â”Š 99â”Š   â”Š      const owner = await connection\n-â”Š100â”Š   â”Š        .createQueryBuilder(User, 'user')\n-â”Š101â”Š   â”Š        .innerJoin('user.ownerChats', 'ownerChats', 'ownerChats.id = :chatId', {\n-â”Š102â”Š   â”Š          chatId: chat.id,\n-â”Š103â”Š   â”Š        })\n-â”Š104â”Š   â”Š        .getOne();\n-â”Š105â”Š   â”Š\n-â”Š106â”Š   â”Š      return owner || null;\n-â”Š107â”Š   â”Š    },\n-â”Š108â”Š   â”Š\n-â”Š109â”Š   â”Š    messages: async (chat, { amount = 0 }, { connection, currentUser }) => {\n-â”Š110â”Š   â”Š      if (chat.messages) {\n-â”Š111â”Š   â”Š        return amount ? chat.messages.slice(-amount) : chat.messages;\n-â”Š112â”Š   â”Š      }\n-â”Š113â”Š   â”Š\n-â”Š114â”Š   â”Š      let query = connection\n-â”Š115â”Š   â”Š        .createQueryBuilder(Message, 'message')\n-â”Š116â”Š   â”Š        .innerJoin('message.chat', 'chat', 'chat.id = :chatId', { chatId: chat.id })\n-â”Š117â”Š   â”Š        .innerJoin('message.holders', 'holders', 'holders.id = :userId', {\n-â”Š118â”Š   â”Š          userId: currentUser.id,\n-â”Š119â”Š   â”Š        })\n-â”Š120â”Š   â”Š        .orderBy({ 'message.createdAt': { order: 'DESC', nulls: 'NULLS LAST' } });\n-â”Š121â”Š   â”Š\n-â”Š122â”Š   â”Š      if (amount) {\n-â”Š123â”Š   â”Š        query = query.take(amount);\n-â”Š124â”Š   â”Š      }\n-â”Š125â”Š   â”Š\n-â”Š126â”Š   â”Š      return (await query.getMany()).reverse();\n-â”Š127â”Š   â”Š    },\n-â”Š128â”Š   â”Š\n-â”Š129â”Š   â”Š    lastMessage: async (chat, args, { connection, currentUser }) => {\n-â”Š130â”Š   â”Š      if (chat.messages) {\n-â”Š131â”Š   â”Š        return chat.messages.length ? chat.messages[chat.messages.length - 1] : null;\n-â”Š132â”Š   â”Š      }\n-â”Š133â”Š   â”Š\n-â”Š134â”Š   â”Š      const messages = await connection\n-â”Š135â”Š   â”Š        .createQueryBuilder(Message, 'message')\n-â”Š136â”Š   â”Š        .innerJoin('message.chat', 'chat', 'chat.id = :chatId', { chatId: chat.id })\n-â”Š137â”Š   â”Š        .innerJoin('message.holders', 'holders', 'holders.id = :userId', {\n-â”Š138â”Š   â”Š          userId: currentUser.id,\n-â”Š139â”Š   â”Š        })\n-â”Š140â”Š   â”Š        .orderBy({ 'message.createdAt': { order: 'DESC', nulls: 'NULLS LAST' } })\n-â”Š141â”Š   â”Š        .getMany()\n-â”Š142â”Š   â”Š\n-â”Š143â”Š   â”Š      return messages && messages.length ? messages[messages.length - 1] : null;\n-â”Š144â”Š   â”Š    },\n-â”Š145â”Š   â”Š  },\n-â”Š146â”Š   â”Š\n-â”Š147â”Š   â”Š  Message: {\n-â”Š148â”Š   â”Š    chat: async (message, args, { connection }) => {\n-â”Š149â”Š   â”Š      const chat = await connection\n-â”Š150â”Š   â”Š        .createQueryBuilder(Chat, 'chat')\n-â”Š151â”Š   â”Š        .innerJoin('chat.messages', 'messages', 'messages.id = :messageId', {\n-â”Š152â”Š   â”Š          messageId: message.id\n-â”Š153â”Š   â”Š        })\n-â”Š154â”Š   â”Š        .getOne();\n-â”Š155â”Š   â”Š\n-â”Š156â”Š   â”Š      if (!chat) {\n-â”Š157â”Š   â”Š        throw new Error(`Message must have a chat.`);\n-â”Š158â”Š   â”Š      }\n-â”Š159â”Š   â”Š\n-â”Š160â”Š   â”Š      return chat;\n-â”Š161â”Š   â”Š    },\n-â”Š162â”Š   â”Š\n-â”Š163â”Š   â”Š    sender: async (message, args, { connection }) => {\n-â”Š164â”Š   â”Š      const sender = await connection\n-â”Š165â”Š   â”Š        .createQueryBuilder(User, 'user')\n-â”Š166â”Š   â”Š        .innerJoin('user.senderMessages', 'senderMessages', 'senderMessages.id = :messageId', {\n-â”Š167â”Š   â”Š          messageId: message.id,\n-â”Š168â”Š   â”Š        })\n-â”Š169â”Š   â”Š        .getOne();\n-â”Š170â”Š   â”Š\n-â”Š171â”Š   â”Š      if (!sender) {\n-â”Š172â”Š   â”Š        throw new Error(`Message must have a sender.`);\n-â”Š173â”Š   â”Š      }\n-â”Š174â”Š   â”Š\n-â”Š175â”Š   â”Š      return sender;\n-â”Š176â”Š   â”Š    },\n-â”Š177â”Š   â”Š\n-â”Š178â”Š   â”Š    holders: async (message, args, { connection }) => {\n-â”Š179â”Š   â”Š      return connection\n-â”Š180â”Š   â”Š        .createQueryBuilder(User, 'user')\n-â”Š181â”Š   â”Š        .innerJoin('user.holderMessages', 'holderMessages', 'holderMessages.id = :messageId', {\n-â”Š182â”Š   â”Š          messageId: message.id,\n-â”Š183â”Š   â”Š        })\n-â”Š184â”Š   â”Š        .getMany();\n-â”Š185â”Š   â”Š    },\n-â”Š186â”Š   â”Š\n-â”Š187â”Š   â”Š    ownership: async (message, args, { connection, currentUser }) => {\n-â”Š188â”Š   â”Š      return !!(await connection\n-â”Š189â”Š   â”Š        .createQueryBuilder(User, 'user')\n-â”Š190â”Š   â”Š        .whereInIds(currentUser.id)\n-â”Š191â”Š   â”Š        .innerJoin('user.senderMessages', 'senderMessages', 'senderMessages.id = :messageId', {\n-â”Š192â”Š   â”Š          messageId: message.id,\n-â”Š193â”Š   â”Š        })\n-â”Š194â”Š   â”Š        .getCount())\n-â”Š195â”Š   â”Š    }\n-â”Š196â”Š   â”Š  },\n-â”Š197â”Š   â”Š} as IResolvers as IApolloResolvers\n+â”Š   â”Š  4â”Šexport default AppModule.forRoot({} as any).resolvers\n```\n\n##### Changed schema&#x2F;typeDefs.ts\n```diff\n@@ -1,54 +1,4 @@\n-â”Š 1â”Š  â”Šexport default `\n-â”Š 2â”Š  â”Š  scalar Date\n+â”Š  â”Š 1â”Šimport 'reflect-metadata'\n+â”Š  â”Š 2â”Šimport { AppModule } from '../modules/app.module'\n â”Š 3â”Š 3â”Š\n-â”Š 4â”Š  â”Š  type Query {\n-â”Š 5â”Š  â”Š    users: [User!]\n-â”Š 6â”Š  â”Š    chats: [Chat!]\n-â”Š 7â”Š  â”Š    chat(chatId: ID!): Chat\n-â”Š 8â”Š  â”Š  }\n-â”Š 9â”Š  â”Š\n-â”Š10â”Š  â”Š  enum MessageType {\n-â”Š11â”Š  â”Š    LOCATION\n-â”Š12â”Š  â”Š    TEXT\n-â”Š13â”Š  â”Š    PICTURE\n-â”Š14â”Š  â”Š  }\n-â”Š15â”Š  â”Š\n-â”Š16â”Š  â”Š  type Chat {\n-â”Š17â”Š  â”Š    #May be a chat or a group\n-â”Š18â”Š  â”Š    id: ID!\n-â”Š19â”Š  â”Š    #Computed for chats\n-â”Š20â”Š  â”Š    name: String\n-â”Š21â”Š  â”Š    updatedAt: Date\n-â”Š22â”Š  â”Š    #Computed for chats\n-â”Š23â”Š  â”Š    picture: String\n-â”Š24â”Š  â”Š    #All members, current and past ones.\n-â”Š25â”Š  â”Š    allTimeMembers: [User!]!\n-â”Š26â”Š  â”Š    #Whoever gets the chat listed. For groups includes past members who still didn't delete the group.\n-â”Š27â”Š  â”Š    listingMembers: [User!]!\n-â”Š28â”Š  â”Š    #If null the group is read-only. Null for chats.\n-â”Š29â”Š  â”Š    owner: User\n-â”Š30â”Š  â”Š    messages(amount: Int): [Message]!\n-â”Š31â”Š  â”Š    lastMessage: Message\n-â”Š32â”Š  â”Š  }\n-â”Š33â”Š  â”Š\n-â”Š34â”Š  â”Š  type Message {\n-â”Š35â”Š  â”Š    id: ID!\n-â”Š36â”Š  â”Š    sender: User!\n-â”Š37â”Š  â”Š    chat: Chat!\n-â”Š38â”Š  â”Š    content: String!\n-â”Š39â”Š  â”Š    createdAt: Date!\n-â”Š40â”Š  â”Š    #FIXME: should return MessageType\n-â”Š41â”Š  â”Š    type: Int!\n-â”Š42â”Š  â”Š    #Whoever still holds a copy of the message. Cannot be null because the message gets deleted otherwise\n-â”Š43â”Š  â”Š    holders: [User!]!\n-â”Š44â”Š  â”Š    #Computed property\n-â”Š45â”Š  â”Š    ownership: Boolean!\n-â”Š46â”Š  â”Š  }\n-â”Š47â”Š  â”Š\n-â”Š48â”Š  â”Š  type User {\n-â”Š49â”Š  â”Š    id: ID!\n-â”Š50â”Š  â”Š    name: String\n-â”Š51â”Š  â”Š    picture: String\n-â”Š52â”Š  â”Š    phone: String\n-â”Š53â”Š  â”Š  }\n-â”Š54â”Š  â”Š`\n+â”Š  â”Š 4â”Šexport default AppModule.forRoot({} as any).typeDefs\n```\n\n[}]: #\n\nNow try to run the app again and see how things work. Of course, there shouldn't be any visual differences, but know that having a DB as an essential step.\n\n    $ yarn start --reset-dummy-data\n\nIn the next step we refactor our back-end so it can be more maintainable, and we will setup a basic authentication mechanism. WhatsApp is not WhatsApp without authentication!"
          },
          {
            "manualTitle": "Step 2: Authentication",
            "stepRevision": "ec5c3ba5fdf653a9b4f66b94043525289a2fc6f9",
            "manualView": "![login](https://user-images.githubusercontent.com/7648874/52663083-c9b4ea00-2f40-11e9-9783-bf36fd88e4bb.png)\n\nAs we're probably all familiar with WhatsApp, the app surrounds around authentication. It's a very crucial part because without authentication there would be no way to identify users and who communicates with whom. On top of all we would like to keep things private, because we don't want personal information to leak to other people. Although the original WhatsApp uses phone authentication with an SMS code, in our app we're gonna keep things simple and use a basic authentication.\n\nThe authentication flow in the front-end app is simple and consists of the following:\n\n- Sign-Up\n- Sign-In\n- Settings\n- Sign-Out\n\nThe more complicated part comes when we have to match each data with its owner and check if a user is authorized to perform an operation or not.\n\n### Server authentication\n\nAuthentication is a hot topic in the GraphQL world and there are some projects which aim at authenticating through GraphQL. Since often you will be required to use a specific auth framework (because of a feature you need or because of an existing authorization infrastructure) I will show you how to use a classic REST API framework within your GraphQL application. This approach is completely fine and in line with the official GraphQL best practices. We will use `Passport` for the authentication and `BasicAuth` as the auth mechanism:\n\n    $ yarn add bcrypt-nodejs@0.0.3 passport@0.4.0 passport-http@0.3.0\n    $ yarn add -D @types/bcrypt-nodejs@0.0.30 @types/passport@1.0.0 @types/passport-http@0.3.7\n\n`BasicAuth` is basically responsible for sending a username and password in an Authorization Header together with each request and it's fully supported by any browser (meaning that we will be able to use Graphiql simply by proving username and password in the login window provided by the browser itself). It's the most simple auth mechanism but it's completely fine for our needs. Later we could decide to use something more complicated like JWT, but it's outside of the scope of this tutorial.\n\nWe will connect the auth logic to our Express app within the auth GQLModule. Indeed, GQLModules can also be used to apply logic which is not directly related to GraphQL. This method is excellent because it ensures that our GraphQL resolvers will be set with the right infrastructure right out of the box and we can safely reuse the module:\n\n[{]: <helper> (diffStep 2.1 files=\"app, modules/auth\" module=\"server\")\n\n#### Step 2.1: Add auth routes\n\n##### Changed modules&#x2F;app.module.ts\n```diff\n@@ -7,13 +7,15 @@\n â”Š 7â”Š 7â”Šimport { MessageModule } from './message'\n â”Š 8â”Š 8â”Š\n â”Š 9â”Š 9â”Šexport interface IAppModuleConfig {\n-â”Š10â”Š  â”Š  connection: Connection;\n+â”Š  â”Š10â”Š  connection: Connection\n+â”Š  â”Š11â”Š  app: Express\n â”Š11â”Š12â”Š}\n â”Š12â”Š13â”Š\n â”Š13â”Š14â”Šexport const AppModule = new GraphQLModule<IAppModuleConfig>({\n â”Š14â”Š15â”Š  name: 'App',\n-â”Š15â”Š  â”Š  imports: ({ config: { connection } }) => [\n+â”Š  â”Š16â”Š  imports: ({ config: { app, connection } }) => [\n â”Š16â”Š17â”Š    AuthModule.forRoot({\n+â”Š  â”Š18â”Š      app,\n â”Š17â”Š19â”Š      connection,\n â”Š18â”Š20â”Š    }),\n â”Š19â”Š21â”Š    UserModule,\n```\n\n##### Changed modules&#x2F;auth&#x2F;index.ts\n```diff\n@@ -1,12 +1,61 @@\n â”Š 1â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core'\n+â”Š  â”Š 2â”Šimport { loadResolversFiles, loadSchemaFiles } from '@graphql-modules/sonar'\n+â”Š  â”Š 3â”Šimport { Express } from 'express'\n â”Š 2â”Š 4â”Šimport { Connection } from 'typeorm'\n â”Š 3â”Š 5â”Šimport { AuthProvider } from './providers/auth.provider'\n+â”Š  â”Š 6â”Šimport { APP } from '../app.symbols'\n+â”Š  â”Š 7â”Šimport { PubSub } from 'apollo-server-express'\n+â”Š  â”Š 8â”Šimport passport from 'passport'\n+â”Š  â”Š 9â”Šimport basicStrategy from 'passport-http'\n+â”Š  â”Š10â”Šimport { InjectFunction } from '@graphql-modules/di'\n â”Š 4â”Š11â”Š\n-â”Š 5â”Š  â”Šexport const AuthModule = new GraphQLModule({\n+â”Š  â”Š12â”Šexport interface IAppModuleConfig {\n+â”Š  â”Š13â”Š  connection: Connection\n+â”Š  â”Š14â”Š  app: Express\n+â”Š  â”Š15â”Š}\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Šexport const AuthModule = new GraphQLModule<IAppModuleConfig>({\n â”Š 6â”Š18â”Š  name: 'Auth',\n-â”Š 7â”Š  â”Š  providers: ({ config: { connection } }) => [\n+â”Š  â”Š19â”Š  providers: ({ config: { connection, app } }) => [\n â”Š 8â”Š20â”Š    { provide: Connection, useValue: connection },\n+â”Š  â”Š21â”Š    { provide: APP, useValue: app },\n+â”Š  â”Š22â”Š    PubSub,\n â”Š 9â”Š23â”Š    AuthProvider,\n â”Š10â”Š24â”Š  ],\n+â”Š  â”Š25â”Š  typeDefs: loadSchemaFiles(__dirname + '/schema/'),\n+â”Š  â”Š26â”Š  resolvers: loadResolversFiles(__dirname + '/resolvers/'),\n â”Š11â”Š27â”Š  configRequired: true,\n+â”Š  â”Š28â”Š  middleware: InjectFunction(AuthProvider, APP)((authProvider, app: Express) => {\n+â”Š  â”Š29â”Š    passport.use(\n+â”Š  â”Š30â”Š      'basic-signin',\n+â”Š  â”Š31â”Š      new basicStrategy.BasicStrategy(async (username: string, password: string, done: any) => {\n+â”Š  â”Š32â”Š        done(null, await authProvider.signIn(username, password))\n+â”Š  â”Š33â”Š      })\n+â”Š  â”Š34â”Š    )\n+â”Š  â”Š35â”Š\n+â”Š  â”Š36â”Š    passport.use(\n+â”Š  â”Š37â”Š      'basic-signup',\n+â”Š  â”Š38â”Š      new basicStrategy.BasicStrategy(\n+â”Š  â”Š39â”Š        { passReqToCallback: true },\n+â”Š  â”Š40â”Š        async (\n+â”Š  â”Š41â”Š          req: Express.Request & { body: { name?: string } },\n+â”Š  â”Š42â”Š          username: string,\n+â”Š  â”Š43â”Š          password: string,\n+â”Š  â”Š44â”Š          done: any\n+â”Š  â”Š45â”Š        ) => {\n+â”Š  â”Š46â”Š          const name = req.body.name\n+â”Š  â”Š47â”Š          return done(null, !!name && (await authProvider.signUp(username, password, name)))\n+â”Š  â”Š48â”Š        }\n+â”Š  â”Š49â”Š      )\n+â”Š  â”Š50â”Š    )\n+â”Š  â”Š51â”Š\n+â”Š  â”Š52â”Š    app.post('/signup', passport.authenticate('basic-signup', { session: false }), (req, res) =>\n+â”Š  â”Š53â”Š      res.json(req.user)\n+â”Š  â”Š54â”Š    )\n+â”Š  â”Š55â”Š\n+â”Š  â”Š56â”Š    app.use(passport.authenticate('basic-signin', { session: false }))\n+â”Š  â”Š57â”Š\n+â”Š  â”Š58â”Š    app.post('/signin', (req, res) => res.json(req.user))\n+â”Š  â”Š59â”Š    return {}\n+â”Š  â”Š60â”Š  }),\n â”Š12â”Š61â”Š})\n```\n\n##### Changed modules&#x2F;auth&#x2F;providers&#x2F;auth.provider.ts\n```diff\n@@ -1,27 +1,75 @@\n-â”Š 1â”Š  â”Šimport { OnRequest } from '@graphql-modules/core'\n-â”Š 2â”Š  â”Šimport { Injectable } from '@graphql-modules/di'\n+â”Š  â”Š 1â”Šimport { Injectable, ProviderScope } from '@graphql-modules/di'\n+â”Š  â”Š 2â”Šimport { ModuleSessionInfo, OnRequest, OnConnect } from '@graphql-modules/core'\n â”Š 3â”Š 3â”Šimport { Connection } from 'typeorm'\n â”Š 4â”Š 4â”Šimport { User } from '../../../entity/user'\n+â”Š  â”Š 5â”Šimport bcrypt from 'bcrypt-nodejs'\n â”Š 5â”Š 6â”Š\n-â”Š 6â”Š  â”Š@Injectable()\n-â”Š 7â”Š  â”Šexport class AuthProvider implements OnRequest {\n+â”Š  â”Š 7â”Š@Injectable({\n+â”Š  â”Š 8â”Š  scope: ProviderScope.Session,\n+â”Š  â”Š 9â”Š})\n+â”Š  â”Š10â”Šexport class AuthProvider implements OnRequest, OnConnect {\n â”Š 8â”Š11â”Š  currentUser: User\n â”Š 9â”Š12â”Š\n-â”Š10â”Š  â”Š  constructor(\n-â”Š11â”Š  â”Š    private connection: Connection\n-â”Š12â”Š  â”Š  ) {}\n+â”Š  â”Š13â”Š  constructor(private connection: Connection) {}\n â”Š13â”Š14â”Š\n-â”Š14â”Š  â”Š  async onRequest() {\n-â”Š15â”Š  â”Š    if (this.currentUser) return\n+â”Š  â”Š15â”Š  onRequest({ session }: ModuleSessionInfo) {\n+â”Š  â”Š16â”Š    if ('req' in session) {\n+â”Š  â”Š17â”Š      this.currentUser = session.req.user\n+â”Š  â”Š18â”Š    }\n+â”Š  â”Š19â”Š  }\n+â”Š  â”Š20â”Š\n+â”Š  â”Š21â”Š  async onConnect(connectionParams: { authToken?: string }) {\n+â”Š  â”Š22â”Š    if (connectionParams.authToken) {\n+â”Š  â”Š23â”Š      // Create a buffer and tell it the data coming in is base64\n+â”Š  â”Š24â”Š      const buf = Buffer.from(connectionParams.authToken.split(' ')[1], 'base64')\n+â”Š  â”Š25â”Š      // Read it back out as a string\n+â”Š  â”Š26â”Š      const [username, password]: string[] = buf.toString().split(':')\n+â”Š  â”Š27â”Š      const user = await this.signIn(username, password)\n+â”Š  â”Š28â”Š      if (user) {\n+â”Š  â”Š29â”Š        // Set context for the WebSocket\n+â”Š  â”Š30â”Š        this.currentUser = user\n+â”Š  â”Š31â”Š      } else {\n+â”Š  â”Š32â”Š        throw new Error('Wrong credentials!')\n+â”Š  â”Š33â”Š      }\n+â”Š  â”Š34â”Š    } else {\n+â”Š  â”Š35â”Š      throw new Error('Missing auth token!')\n+â”Š  â”Š36â”Š    }\n+â”Š  â”Š37â”Š  }\n â”Š16â”Š38â”Š\n+â”Š  â”Š39â”Š  getUserByUsername(username: string) {\n+â”Š  â”Š40â”Š    return this.connection.getRepository(User).findOne({ where: { username } })\n+â”Š  â”Š41â”Š  }\n â”Š17â”Š42â”Š\n-â”Š18â”Š  â”Š    const currentUser = await this.connection\n-â”Š19â”Š  â”Š      .createQueryBuilder(User, 'user')\n-â”Š20â”Š  â”Š      .getOne()\n+â”Š  â”Š43â”Š  async signIn(username: string, password: string): Promise<User | false> {\n+â”Š  â”Š44â”Š    const user = await this.getUserByUsername(username)\n+â”Š  â”Š45â”Š    if (user && this.validPassword(password, user.password)) {\n+â”Š  â”Š46â”Š      return user\n+â”Š  â”Š47â”Š    } else {\n+â”Š  â”Š48â”Š      return false\n+â”Š  â”Š49â”Š    }\n+â”Š  â”Š50â”Š  }\n â”Š21â”Š51â”Š\n-â”Š22â”Š  â”Š    if (currentUser) {\n-â”Š23â”Š  â”Š      console.log(currentUser)\n-â”Š24â”Š  â”Š      this.currentUser = currentUser\n+â”Š  â”Š52â”Š  async signUp(username: string, password: string, name: string): Promise<User | false> {\n+â”Š  â”Š53â”Š    const userExists = !!(await this.getUserByUsername(username))\n+â”Š  â”Š54â”Š    if (!userExists) {\n+â”Š  â”Š55â”Š      const user = this.connection.manager.save(\n+â”Š  â”Š56â”Š        new User({\n+â”Š  â”Š57â”Š          username,\n+â”Š  â”Š58â”Š          password: this.generateHash(password),\n+â”Š  â”Š59â”Š          name,\n+â”Š  â”Š60â”Š        })\n+â”Š  â”Š61â”Š      )\n+â”Š  â”Š62â”Š      return user\n+â”Š  â”Š63â”Š    } else {\n+â”Š  â”Š64â”Š      return false\n â”Š25â”Š65â”Š    }\n â”Š26â”Š66â”Š  }\n+â”Š  â”Š67â”Š\n+â”Š  â”Š68â”Š  generateHash(password: string) {\n+â”Š  â”Š69â”Š    return bcrypt.hashSync(password, bcrypt.genSaltSync(8))\n+â”Š  â”Š70â”Š  }\n+â”Š  â”Š71â”Š\n+â”Š  â”Š72â”Š  validPassword(password: string, localPassword: string) {\n+â”Š  â”Š73â”Š    return bcrypt.compareSync(password, localPassword)\n+â”Š  â”Š74â”Š  }\n â”Š27â”Š75â”Š}\n```\n\n[}]: #\n\nWe are going to store hashes instead of plain passwords, that's why we're using `bcrypt-nodejs`. With `passport.use('basic-signin')` and `passport.use('basic-signup')` we define how the auth framework deals with our database. `app.post('/signup')` is the endpoint for creating new accounts, so we left it out of the authentication middleware (`app.use(passport.authenticate('basic-signin')`).\n\nWe will also add an additional query called `me` which will simply return the user which is currently logged in. This will come in handy in the client:\n\n[{]: <helper> (diffStep 2.1 files=\"modules/user\" module=\"server\")\n\n#### Step 2.1: Add auth routes\n\n##### Changed modules&#x2F;user&#x2F;providers&#x2F;user.provider.ts\n```diff\n@@ -14,6 +14,10 @@\n â”Š14â”Š14â”Š    return this.connection.createQueryBuilder(User, 'user')\n â”Š15â”Š15â”Š  }\n â”Š16â”Š16â”Š\n+â”Š  â”Š17â”Š  getMe() {\n+â”Š  â”Š18â”Š    return this.currentUser\n+â”Š  â”Š19â”Š  }\n+â”Š  â”Š20â”Š\n â”Š17â”Š21â”Š  getUsers() {\n â”Š18â”Š22â”Š    return this.createQueryBuilder()\n â”Š19â”Š23â”Š      .where('user.id != :id', { id: this.currentUser.id })\n```\n\n##### Changed modules&#x2F;user&#x2F;resolvers&#x2F;resolvers.ts\n```diff\n@@ -5,6 +5,7 @@\n â”Š 5â”Š 5â”Š\n â”Š 6â”Š 6â”Šexport default {\n â”Š 7â”Š 7â”Š  Query: {\n+â”Š  â”Š 8â”Š    me: (obj, args, { injector }) => injector.get(UserProvider).getMe(),\n â”Š 8â”Š 9â”Š    users: (obj, args, { injector }) => injector.get(UserProvider).getUsers(),\n â”Š 9â”Š10â”Š  },\n â”Š10â”Š11â”Š} as IResolvers\n```\n\n##### Changed modules&#x2F;user&#x2F;schema&#x2F;typeDefs.graphql\n```diff\n@@ -1,4 +1,5 @@\n â”Š1â”Š1â”Štype Query {\n+â”Š â”Š2â”Š  me: User\n â”Š2â”Š3â”Š  users: [User!]\n â”Š3â”Š4â”Š}\n â”Š4â”Š5â”Š\n```\n\n[}]: #\n\n### Client authentication\n\nTo make things more convenient, we will create a dedicated authentication service under a separate module called `auth.service.tsx`. The auth service will take care of:\n\n- Performing sign-in/sign-up against the server.\n- Storing received auth token in local storage.\n- Providing a wrapper around guarded routes that require authorization.\n\n[{]: <helper> (diffStep 2.1 files=\"src/services, src/graphql\" module=\"client\")\n\n#### [Step 2.1: Add auth service](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/e01ef20)\n\n##### Changed src&#x2F;graphql&#x2F;fragments&#x2F;index.ts\n```diff\n@@ -1,2 +1,3 @@\n â”Š1â”Š1â”Šexport { default as chat } from './chat.fragment'\n â”Š2â”Š2â”Šexport { default as message } from './message.fragment'\n+â”Š â”Š3â”Šexport { default as user } from './user.fragment'\n```\n\n##### Added src&#x2F;graphql&#x2F;fragments&#x2F;user.fragment.ts\n```diff\n@@ -0,0 +1,9 @@\n+â”Š â”Š1â”Šimport gql from 'graphql-tag'\n+â”Š â”Š2â”Š\n+â”Š â”Š3â”Šexport default gql`\n+â”Š â”Š4â”Š  fragment User on User {\n+â”Š â”Š5â”Š    id\n+â”Š â”Š6â”Š    name\n+â”Š â”Š7â”Š    picture\n+â”Š â”Š8â”Š  }\n+â”Š â”Š9â”Š`\n```\n\n##### Added src&#x2F;graphql&#x2F;queries&#x2F;index.ts\n```diff\n@@ -0,0 +1 @@\n+â”Š â”Š1â”Šexport { default as me } from './me.query'\n```\n\n##### Added src&#x2F;graphql&#x2F;queries&#x2F;me.query.ts\n```diff\n@@ -0,0 +1,11 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag'\n+â”Š  â”Š 2â”Šimport * as fragments from '../fragments'\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šexport default gql `\n+â”Š  â”Š 5â”Š  query Me {\n+â”Š  â”Š 6â”Š    me {\n+â”Š  â”Š 7â”Š      ...User\n+â”Š  â”Š 8â”Š    }\n+â”Š  â”Š 9â”Š  }\n+â”Š  â”Š10â”Š  ${fragments.user}\n+â”Š  â”Š11â”Š`\n```\n\n##### Added src&#x2F;services&#x2F;auth.service.tsx\n```diff\n@@ -0,0 +1,84 @@\n+â”Š  â”Š 1â”Šimport * as React from 'react'\n+â”Š  â”Š 2â”Šimport { useContext } from 'react'\n+â”Š  â”Š 3â”Šimport { useQuery } from 'react-apollo-hooks'\n+â”Š  â”Š 4â”Šimport { Redirect } from 'react-router-dom'\n+â”Š  â”Š 5â”Šimport store from '../apollo-client'\n+â”Š  â”Š 6â”Šimport * as queries from '../graphql/queries'\n+â”Š  â”Š 7â”Šimport { Me, User } from '../graphql/types'\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Šconst MyContext = React.createContext<User.Fragment>(null)\n+â”Š  â”Š10â”Š\n+â”Š  â”Š11â”Šexport const useMe = () => {\n+â”Š  â”Š12â”Š  return useContext(MyContext)\n+â”Š  â”Š13â”Š}\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”Šexport const withAuth = (Component: React.ComponentType) => {\n+â”Š  â”Š16â”Š  return props => {\n+â”Š  â”Š17â”Š    if (!getAuthHeader()) return <Redirect to=\"/sign-in\" />\n+â”Š  â”Š18â”Š\n+â”Š  â”Š19â”Š    // Validating against server\n+â”Š  â”Š20â”Š    const myResult = useQuery<Me.Query>(queries.me, { suspend: true })\n+â”Š  â”Š21â”Š\n+â”Š  â”Š22â”Š    // Override TypeScript definition issue with the current version\n+â”Š  â”Š23â”Š    if (myResult.error) return <Redirect to=\"/sign-in\" />\n+â”Š  â”Š24â”Š\n+â”Š  â”Š25â”Š    return (\n+â”Š  â”Š26â”Š      <MyContext.Provider value={myResult.data.me}>\n+â”Š  â”Š27â”Š        <Component {...props} />\n+â”Š  â”Š28â”Š      </MyContext.Provider>\n+â”Š  â”Š29â”Š    )\n+â”Š  â”Š30â”Š  }\n+â”Š  â”Š31â”Š}\n+â”Š  â”Š32â”Š\n+â”Š  â”Š33â”Šexport const storeAuthHeader = (auth: string) => {\n+â”Š  â”Š34â”Š  localStorage.setItem('Authorization', auth)\n+â”Š  â”Š35â”Š}\n+â”Š  â”Š36â”Š\n+â”Š  â”Š37â”Šexport const getAuthHeader = (): string | null => {\n+â”Š  â”Š38â”Š  return localStorage.getItem('Authorization') || null\n+â”Š  â”Š39â”Š}\n+â”Š  â”Š40â”Š\n+â”Š  â”Š41â”Šexport const signIn = ({ username, password }) => {\n+â”Š  â”Š42â”Š  const auth = `Basic ${btoa(`${username}:${password}`)}`\n+â”Š  â”Š43â”Š\n+â”Š  â”Š44â”Š  return fetch(`${process.env.REACT_APP_SERVER_URL}/signin`, {\n+â”Š  â”Š45â”Š    method: 'POST',\n+â”Š  â”Š46â”Š    headers: {\n+â”Š  â”Š47â”Š      Authorization: auth,\n+â”Š  â”Š48â”Š    },\n+â”Š  â”Š49â”Š  }).then(res => {\n+â”Š  â”Š50â”Š    if (res.status < 400) {\n+â”Š  â”Š51â”Š      storeAuthHeader(auth)\n+â”Š  â”Š52â”Š    } else {\n+â”Š  â”Š53â”Š      return Promise.reject(res.statusText)\n+â”Š  â”Š54â”Š    }\n+â”Š  â”Š55â”Š  })\n+â”Š  â”Š56â”Š}\n+â”Š  â”Š57â”Š\n+â”Š  â”Š58â”Šexport const signUp = ({ username, password, name }) => {\n+â”Š  â”Š59â”Š  return fetch(`${process.env.REACT_APP_SERVER_URL}/signup`, {\n+â”Š  â”Š60â”Š    method: 'POST',\n+â”Š  â”Š61â”Š    body: JSON.stringify({ name }),\n+â”Š  â”Š62â”Š    headers: {\n+â”Š  â”Š63â”Š      Accept: 'application/json',\n+â”Š  â”Š64â”Š      'Content-Type': 'application/json',\n+â”Š  â”Š65â”Š      Authorization: `Basic ${btoa(`${username}:${password}`)}`,\n+â”Š  â”Š66â”Š    },\n+â”Š  â”Š67â”Š  })\n+â”Š  â”Š68â”Š}\n+â”Š  â”Š69â”Š\n+â”Š  â”Š70â”Šexport const signOut = () => {\n+â”Š  â”Š71â”Š  localStorage.removeItem('Authorization')\n+â”Š  â”Š72â”Š\n+â”Š  â”Š73â”Š  return store.clearStore()\n+â”Š  â”Š74â”Š}\n+â”Š  â”Š75â”Š\n+â”Š  â”Š76â”Šexport default {\n+â”Š  â”Š77â”Š  useMe,\n+â”Š  â”Š78â”Š  withAuth,\n+â”Š  â”Š79â”Š  storeAuthHeader,\n+â”Š  â”Š80â”Š  getAuthHeader,\n+â”Š  â”Š81â”Š  signIn,\n+â”Š  â”Š82â”Š  signUp,\n+â”Š  â”Š83â”Š  signOut,\n+â”Š  â”Š84â”Š}\n```\n\n[}]: #\n\nThe service also includes a `useMe()` GraphQL hook that will fetch the current user. Its definition is separate since it's used vastly and shared between many components.\n\nSince we're using token oriented authentication, it means that any time we make a request to our GraphQL back-end we would need to authorize ourselves by sending this token. This can easily be done thanks to Apollo. By setting the client correctly we can automatically set the headers and parameters for each request that is being done.\n\n[{]: <helper> (diffStep 2.1 files=\"src/apollo-client.ts\" module=\"client\")\n\n#### [Step 2.1: Add auth service](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/e01ef20)\n\n##### Changed src&#x2F;apollo-client.ts\n```diff\n@@ -1,10 +1,12 @@\n â”Š 1â”Š 1â”Šimport { InMemoryCache } from 'apollo-cache-inmemory'\n â”Š 2â”Š 2â”Šimport { ApolloClient } from 'apollo-client'\n â”Š 3â”Š 3â”Šimport { ApolloLink, split } from 'apollo-link'\n+â”Š  â”Š 4â”Šimport { setContext } from 'apollo-link-context'\n â”Š 4â”Š 5â”Šimport { HttpLink } from 'apollo-link-http'\n â”Š 5â”Š 6â”Šimport { WebSocketLink } from 'apollo-link-ws'\n â”Š 6â”Š 7â”Šimport { getMainDefinition } from 'apollo-utilities'\n â”Š 7â”Š 8â”Šimport { OperationDefinitionNode } from 'graphql'\n+â”Š  â”Š 9â”Šimport { getAuthHeader } from './services/auth.service'\n â”Š 8â”Š10â”Š\n â”Š 9â”Š11â”Šconst httpUri = process.env.REACT_APP_SERVER_URL + '/graphql'\n â”Š10â”Š12â”Šconst wsUri = httpUri.replace(/^https?/, 'ws')\n```\n```diff\n@@ -17,16 +19,30 @@\n â”Š17â”Š19â”Š  uri: wsUri,\n â”Š18â”Š20â”Š  options: {\n â”Š19â”Š21â”Š    reconnect: true,\n+â”Š  â”Š22â”Š    connectionParams: () => ({\n+â”Š  â”Š23â”Š      authToken: getAuthHeader(),\n+â”Š  â”Š24â”Š    }),\n â”Š20â”Š25â”Š  },\n â”Š21â”Š26â”Š})\n â”Š22â”Š27â”Š\n+â”Š  â”Š28â”Šconst authLink = setContext((_, { headers }) => {\n+â”Š  â”Š29â”Š  const auth = getAuthHeader()\n+â”Š  â”Š30â”Š\n+â”Š  â”Š31â”Š  return {\n+â”Š  â”Š32â”Š    headers: {\n+â”Š  â”Š33â”Š      ...headers,\n+â”Š  â”Š34â”Š      Authorization: auth,\n+â”Š  â”Š35â”Š    },\n+â”Š  â”Š36â”Š  }\n+â”Š  â”Š37â”Š})\n+â”Š  â”Š38â”Š\n â”Š23â”Š39â”Šconst terminatingLink = split(\n â”Š24â”Š40â”Š  ({ query }) => {\n â”Š25â”Š41â”Š    const { kind, operation } = getMainDefinition(query) as OperationDefinitionNode\n â”Š26â”Š42â”Š    return kind === 'OperationDefinition' && operation === 'subscription'\n â”Š27â”Š43â”Š  },\n â”Š28â”Š44â”Š  wsLink,\n-â”Š29â”Š  â”Š  httpLink,\n+â”Š  â”Š45â”Š  authLink.concat(httpLink),\n â”Š30â”Š46â”Š)\n â”Š31â”Š47â”Š\n â”Š32â”Š48â”Šconst link = ApolloLink.from([terminatingLink])\n```\n\n[}]: #\n\nThis would require us to install a package called `apollo-link-context`:\n\n    $ yarn add apollo-link-context@1.0.14\n\nNow that we have that mechanism implemented we need a way to access it. For that purpose we will be implementing a sign-in form and a sign-up form. Once we create a user and sign-in we will be promoted to the main chats list screen.\n\n[{]: <helper> (diffStep 2.2 files=\"src/components/AuthScreen\" module=\"client\")\n\n#### [Step 2.2: Implement auth components](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/a67226a)\n\n##### Added src&#x2F;components&#x2F;AuthScreen&#x2F;SignInForm.tsx\n```diff\n@@ -0,0 +1,84 @@\n+â”Š  â”Š 1â”Šimport Button from '@material-ui/core/Button'\n+â”Š  â”Š 2â”Šimport TextField from '@material-ui/core/TextField'\n+â”Š  â”Š 3â”Šimport { History } from 'history'\n+â”Š  â”Š 4â”Šimport * as React from 'react'\n+â”Š  â”Š 5â”Šimport { useState } from 'react'\n+â”Š  â”Š 6â”Šimport { signIn } from '../../services/auth.service'\n+â”Š  â”Š 7â”Š\n+â”Š  â”Š 8â”Šinterface SignInFormProps {\n+â”Š  â”Š 9â”Š  history: History\n+â”Š  â”Š10â”Š}\n+â”Š  â”Š11â”Š\n+â”Š  â”Š12â”Šexport default ({ history }: SignInFormProps) => {\n+â”Š  â”Š13â”Š  const [username, setUsername] = useState('')\n+â”Š  â”Š14â”Š  const [password, setPassword] = useState('')\n+â”Š  â”Š15â”Š  const [error, setError] = useState('')\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š  const onUsernameChange = ({ target }) => {\n+â”Š  â”Š18â”Š    setError('')\n+â”Š  â”Š19â”Š    setUsername(target.value)\n+â”Š  â”Š20â”Š  }\n+â”Š  â”Š21â”Š\n+â”Š  â”Š22â”Š  const onPasswordChange = ({ target }) => {\n+â”Š  â”Š23â”Š    setError('')\n+â”Š  â”Š24â”Š    setPassword(target.value)\n+â”Š  â”Š25â”Š  }\n+â”Š  â”Š26â”Š\n+â”Š  â”Š27â”Š  const maySignIn = () => {\n+â”Š  â”Š28â”Š    return !!(username && password)\n+â”Š  â”Š29â”Š  }\n+â”Š  â”Š30â”Š\n+â”Š  â”Š31â”Š  const handleSignIn = () => {\n+â”Š  â”Š32â”Š    signIn({ username, password })\n+â”Š  â”Š33â”Š      .then(() => {\n+â”Š  â”Š34â”Š        history.push('/chats')\n+â”Š  â”Š35â”Š      })\n+â”Š  â”Š36â”Š      .catch(error => {\n+â”Š  â”Š37â”Š        setError(error.message || error)\n+â”Š  â”Š38â”Š      })\n+â”Š  â”Š39â”Š  }\n+â”Š  â”Š40â”Š\n+â”Š  â”Š41â”Š  const handleSignUp = () => {\n+â”Š  â”Š42â”Š    history.push('/sign-up')\n+â”Š  â”Š43â”Š  }\n+â”Š  â”Š44â”Š\n+â”Š  â”Š45â”Š  return (\n+â”Š  â”Š46â”Š    <div className=\"SignInForm Screen\">\n+â”Š  â”Š47â”Š      <form>\n+â”Š  â”Š48â”Š        <legend>Sign in</legend>\n+â”Š  â”Š49â”Š        <div style={{ width: '100%' }}>\n+â”Š  â”Š50â”Š          <TextField\n+â”Š  â”Š51â”Š            className=\"AuthScreen-text-field\"\n+â”Š  â”Š52â”Š            label=\"Username\"\n+â”Š  â”Š53â”Š            value={username}\n+â”Š  â”Š54â”Š            onChange={onUsernameChange}\n+â”Š  â”Š55â”Š            margin=\"normal\"\n+â”Š  â”Š56â”Š            placeholder=\"Enter your username\"\n+â”Š  â”Š57â”Š          />\n+â”Š  â”Š58â”Š          <TextField\n+â”Š  â”Š59â”Š            className=\"AuthScreen-text-field\"\n+â”Š  â”Š60â”Š            label=\"Password\"\n+â”Š  â”Š61â”Š            type=\"password\"\n+â”Š  â”Š62â”Š            value={password}\n+â”Š  â”Š63â”Š            onChange={onPasswordChange}\n+â”Š  â”Š64â”Š            margin=\"normal\"\n+â”Š  â”Š65â”Š            placeholder=\"Enter your password\"\n+â”Š  â”Š66â”Š          />\n+â”Š  â”Š67â”Š        </div>\n+â”Š  â”Š68â”Š        <Button\n+â”Š  â”Š69â”Š          type=\"button\"\n+â”Š  â”Š70â”Š          color=\"secondary\"\n+â”Š  â”Š71â”Š          variant=\"contained\"\n+â”Š  â”Š72â”Š          disabled={!maySignIn()}\n+â”Š  â”Š73â”Š          onClick={handleSignIn}\n+â”Š  â”Š74â”Š        >\n+â”Š  â”Š75â”Š          Sign in\n+â”Š  â”Š76â”Š        </Button>\n+â”Š  â”Š77â”Š        <div className=\"AuthScreen-error\">{error}</div>\n+â”Š  â”Š78â”Š        <span className=\"AuthScreen-alternative\">\n+â”Š  â”Š79â”Š          Don't have an account yet? <a onClick={handleSignUp}>Sign up!</a>\n+â”Š  â”Š80â”Š        </span>\n+â”Š  â”Š81â”Š      </form>\n+â”Š  â”Š82â”Š    </div>\n+â”Š  â”Š83â”Š  )\n+â”Š  â”Š84â”Š}\n```\n\n##### Added src&#x2F;components&#x2F;AuthScreen&#x2F;SignUpForm.tsx\n```diff\n@@ -0,0 +1,127 @@\n+â”Š   â”Š  1â”Šimport Button from '@material-ui/core/Button'\n+â”Š   â”Š  2â”Šimport TextField from '@material-ui/core/TextField'\n+â”Š   â”Š  3â”Šimport { History } from 'history'\n+â”Š   â”Š  4â”Šimport * as React from 'react'\n+â”Š   â”Š  5â”Šimport { useState } from 'react'\n+â”Š   â”Š  6â”Šimport { signUp } from '../../services/auth.service'\n+â”Š   â”Š  7â”Š\n+â”Š   â”Š  8â”Šinterface SignUpFormProps {\n+â”Š   â”Š  9â”Š  history: History\n+â”Š   â”Š 10â”Š}\n+â”Š   â”Š 11â”Š\n+â”Š   â”Š 12â”Šexport default ({ history }: SignUpFormProps) => {\n+â”Š   â”Š 13â”Š  const [name, setName] = useState('')\n+â”Š   â”Š 14â”Š  const [username, setUsername] = useState('')\n+â”Š   â”Š 15â”Š  const [oldPassword, setOldPassword] = useState('')\n+â”Š   â”Š 16â”Š  const [password, setPassword] = useState('')\n+â”Š   â”Š 17â”Š  const [error, setError] = useState('')\n+â”Š   â”Š 18â”Š\n+â”Š   â”Š 19â”Š  const updateName = ({ target }) => {\n+â”Š   â”Š 20â”Š    setError('')\n+â”Š   â”Š 21â”Š    setName(target.value)\n+â”Š   â”Š 22â”Š  }\n+â”Š   â”Š 23â”Š\n+â”Š   â”Š 24â”Š  const updateUsername = ({ target }) => {\n+â”Š   â”Š 25â”Š    setError('')\n+â”Š   â”Š 26â”Š    setUsername(target.value)\n+â”Š   â”Š 27â”Š  }\n+â”Š   â”Š 28â”Š\n+â”Š   â”Š 29â”Š  const updateOldPassword = ({ target }) => {\n+â”Š   â”Š 30â”Š    setError('')\n+â”Š   â”Š 31â”Š    setOldPassword(target.value)\n+â”Š   â”Š 32â”Š  }\n+â”Š   â”Š 33â”Š\n+â”Š   â”Š 34â”Š  const updateNewPassword = ({ target }) => {\n+â”Š   â”Š 35â”Š    setError('')\n+â”Š   â”Š 36â”Š    setPassword(target.value)\n+â”Š   â”Š 37â”Š  }\n+â”Š   â”Š 38â”Š\n+â”Š   â”Š 39â”Š  const maySignUp = () => {\n+â”Š   â”Š 40â”Š    return !!(name && username && oldPassword && oldPassword === password)\n+â”Š   â”Š 41â”Š  }\n+â”Š   â”Š 42â”Š\n+â”Š   â”Š 43â”Š  const handleSignUp = () => {\n+â”Š   â”Š 44â”Š    signUp({ username, password, name })\n+â”Š   â”Š 45â”Š      .then(() => {\n+â”Š   â”Š 46â”Š        history.push('/sign-in')\n+â”Š   â”Š 47â”Š      })\n+â”Š   â”Š 48â”Š      .catch(error => {\n+â”Š   â”Š 49â”Š        setError(error.message || error)\n+â”Š   â”Š 50â”Š      })\n+â”Š   â”Š 51â”Š  }\n+â”Š   â”Š 52â”Š\n+â”Š   â”Š 53â”Š  const handleSignIn = () => {\n+â”Š   â”Š 54â”Š    history.push('/sign-in')\n+â”Š   â”Š 55â”Š  }\n+â”Š   â”Š 56â”Š\n+â”Š   â”Š 57â”Š  return (\n+â”Š   â”Š 58â”Š    <div className=\"SignUpForm Screen\">\n+â”Š   â”Š 59â”Š      <form>\n+â”Š   â”Š 60â”Š        <legend>Sign up</legend>\n+â”Š   â”Š 61â”Š        <div\n+â”Š   â”Š 62â”Š          style={{\n+â”Š   â”Š 63â”Š            float: 'left',\n+â”Š   â”Š 64â”Š            width: 'calc(50% - 10px)',\n+â”Š   â”Š 65â”Š            paddingRight: '10px',\n+â”Š   â”Š 66â”Š          }}\n+â”Š   â”Š 67â”Š        >\n+â”Š   â”Š 68â”Š          <TextField\n+â”Š   â”Š 69â”Š            className=\"AuthScreen-text-field\"\n+â”Š   â”Š 70â”Š            label=\"Name\"\n+â”Š   â”Š 71â”Š            value={name}\n+â”Š   â”Š 72â”Š            onChange={updateName}\n+â”Š   â”Š 73â”Š            autoComplete=\"off\"\n+â”Š   â”Š 74â”Š            margin=\"normal\"\n+â”Š   â”Š 75â”Š          />\n+â”Š   â”Š 76â”Š          <TextField\n+â”Š   â”Š 77â”Š            className=\"AuthScreen-text-field\"\n+â”Š   â”Š 78â”Š            label=\"Username\"\n+â”Š   â”Š 79â”Š            value={username}\n+â”Š   â”Š 80â”Š            onChange={updateUsername}\n+â”Š   â”Š 81â”Š            autoComplete=\"off\"\n+â”Š   â”Š 82â”Š            margin=\"normal\"\n+â”Š   â”Š 83â”Š          />\n+â”Š   â”Š 84â”Š        </div>\n+â”Š   â”Š 85â”Š        <div\n+â”Š   â”Š 86â”Š          style={{\n+â”Š   â”Š 87â”Š            float: 'right',\n+â”Š   â”Š 88â”Š            width: 'calc(50% - 10px)',\n+â”Š   â”Š 89â”Š            paddingLeft: '10px',\n+â”Š   â”Š 90â”Š          }}\n+â”Š   â”Š 91â”Š        >\n+â”Š   â”Š 92â”Š          <TextField\n+â”Š   â”Š 93â”Š            className=\"AuthScreen-text-field\"\n+â”Š   â”Š 94â”Š            label=\"Old password\"\n+â”Š   â”Š 95â”Š            type=\"password\"\n+â”Š   â”Š 96â”Š            value={oldPassword}\n+â”Š   â”Š 97â”Š            onChange={updateOldPassword}\n+â”Š   â”Š 98â”Š            autoComplete=\"off\"\n+â”Š   â”Š 99â”Š            margin=\"normal\"\n+â”Š   â”Š100â”Š          />\n+â”Š   â”Š101â”Š          <TextField\n+â”Š   â”Š102â”Š            className=\"AuthScreen-text-field\"\n+â”Š   â”Š103â”Š            label=\"New password\"\n+â”Š   â”Š104â”Š            type=\"password\"\n+â”Š   â”Š105â”Š            value={password}\n+â”Š   â”Š106â”Š            onChange={updateNewPassword}\n+â”Š   â”Š107â”Š            autoComplete=\"off\"\n+â”Š   â”Š108â”Š            margin=\"normal\"\n+â”Š   â”Š109â”Š          />\n+â”Š   â”Š110â”Š        </div>\n+â”Š   â”Š111â”Š        <Button\n+â”Š   â”Š112â”Š          type=\"button\"\n+â”Š   â”Š113â”Š          color=\"secondary\"\n+â”Š   â”Š114â”Š          variant=\"contained\"\n+â”Š   â”Š115â”Š          disabled={!maySignUp()}\n+â”Š   â”Š116â”Š          onClick={handleSignUp}\n+â”Š   â”Š117â”Š        >\n+â”Š   â”Š118â”Š          Sign up\n+â”Š   â”Š119â”Š        </Button>\n+â”Š   â”Š120â”Š        <div className=\"AuthScreen-error\">{error}</div>\n+â”Š   â”Š121â”Š        <span className=\"AuthScreen-alternative\">\n+â”Š   â”Š122â”Š          Already have an accout? <a onClick={handleSignIn}>Sign in!</a>\n+â”Š   â”Š123â”Š        </span>\n+â”Š   â”Š124â”Š      </form>\n+â”Š   â”Š125â”Š    </div>\n+â”Š   â”Š126â”Š  )\n+â”Š   â”Š127â”Š}\n```\n\n##### Added src&#x2F;components&#x2F;AuthScreen&#x2F;index.tsx\n```diff\n@@ -0,0 +1,118 @@\n+â”Š   â”Š  1â”Šimport * as React from 'react'\n+â”Š   â”Š  2â”Šimport { RouteComponentProps } from 'react-router-dom'\n+â”Š   â”Š  3â”Šimport { Route } from 'react-router-dom'\n+â”Š   â”Š  4â”Šimport styled from 'styled-components'\n+â”Š   â”Š  5â”Šimport AnimatedSwitch from '../AnimatedSwitch'\n+â”Š   â”Š  6â”Šimport SignInForm from './SignInForm'\n+â”Š   â”Š  7â”Šimport SignUpForm from './SignUpForm'\n+â”Š   â”Š  8â”Š\n+â”Š   â”Š  9â”Šconst Style = styled.div`\n+â”Š   â”Š 10â”Š  background: radial-gradient(rgb(34, 65, 67), rgb(17, 48, 50)),\n+â”Š   â”Š 11â”Š    url(/assets/chat-background.jpg) no-repeat;\n+â”Š   â”Š 12â”Š  background-size: cover;\n+â”Š   â”Š 13â”Š  background-blend-mode: multiply;\n+â”Š   â”Š 14â”Š  color: white;\n+â”Š   â”Š 15â”Š\n+â”Š   â”Š 16â”Š  .AuthScreen-intro {\n+â”Š   â”Š 17â”Š    height: 265px;\n+â”Š   â”Š 18â”Š  }\n+â”Š   â”Š 19â”Š\n+â”Š   â”Š 20â”Š  .AuthScreen-icon {\n+â”Š   â”Š 21â”Š    width: 125px;\n+â”Š   â”Š 22â”Š    height: auto;\n+â”Š   â”Š 23â”Š    margin-left: auto;\n+â”Š   â”Š 24â”Š    margin-right: auto;\n+â”Š   â”Š 25â”Š    padding-top: 70px;\n+â”Š   â”Š 26â”Š    display: block;\n+â”Š   â”Š 27â”Š  }\n+â”Š   â”Š 28â”Š\n+â”Š   â”Š 29â”Š  .AuthScreen-title {\n+â”Š   â”Š 30â”Š    width: 100%;\n+â”Š   â”Š 31â”Š    text-align: center;\n+â”Š   â”Š 32â”Š    color: white;\n+â”Š   â”Š 33â”Š  }\n+â”Š   â”Š 34â”Š\n+â”Š   â”Š 35â”Š  .AuthScreen-text-field {\n+â”Š   â”Š 36â”Š    width: 100%;\n+â”Š   â”Š 37â”Š    position: relative;\n+â”Š   â”Š 38â”Š  }\n+â”Š   â”Š 39â”Š\n+â”Š   â”Š 40â”Š  .AuthScreen-text-field > div::before {\n+â”Š   â”Š 41â”Š    border-color: white !important;\n+â”Š   â”Š 42â”Š  }\n+â”Š   â”Š 43â”Š\n+â”Š   â”Š 44â”Š  .AuthScreen-error {\n+â”Š   â”Š 45â”Š    position: absolute;\n+â”Š   â”Š 46â”Š    color: red;\n+â”Š   â”Š 47â”Š    font-size: 15px;\n+â”Š   â”Š 48â”Š    margin-top: 20px;\n+â”Š   â”Š 49â”Š  }\n+â”Š   â”Š 50â”Š\n+â”Š   â”Š 51â”Š  .AuthScreen-alternative {\n+â”Š   â”Š 52â”Š    position: absolute;\n+â”Š   â”Š 53â”Š    bottom: 10px;\n+â”Š   â”Š 54â”Š    left: 10px;\n+â”Š   â”Š 55â”Š\n+â”Š   â”Š 56â”Š    a {\n+â”Š   â”Š 57â”Š      color: var(--secondary-bg);\n+â”Š   â”Š 58â”Š    }\n+â”Š   â”Š 59â”Š  }\n+â”Š   â”Š 60â”Š\n+â”Š   â”Š 61â”Š  .Screen {\n+â”Š   â”Š 62â”Š    height: calc(100% - 265px);\n+â”Š   â”Š 63â”Š  }\n+â”Š   â”Š 64â”Š\n+â”Š   â”Š 65â”Š  form {\n+â”Š   â”Š 66â”Š    padding: 20px;\n+â”Š   â”Š 67â”Š\n+â”Š   â”Š 68â”Š    > div {\n+â”Š   â”Š 69â”Š      padding-bottom: 35px;\n+â”Š   â”Š 70â”Š    }\n+â”Š   â”Š 71â”Š  }\n+â”Š   â”Š 72â”Š\n+â”Š   â”Š 73â”Š  legend {\n+â”Š   â”Š 74â”Š    font-weight: bold;\n+â”Š   â”Š 75â”Š    color: white;\n+â”Š   â”Š 76â”Š  }\n+â”Š   â”Š 77â”Š\n+â”Š   â”Š 78â”Š  label {\n+â”Š   â”Š 79â”Š    color: white !important;\n+â”Š   â”Š 80â”Š  }\n+â”Š   â”Š 81â”Š\n+â”Š   â”Š 82â”Š  input {\n+â”Š   â”Š 83â”Š    color: white;\n+â”Š   â”Š 84â”Š\n+â”Š   â”Š 85â”Š    &::placeholder {\n+â”Š   â”Š 86â”Š      color: var(--primary-bg);\n+â”Š   â”Š 87â”Š    }\n+â”Š   â”Š 88â”Š  }\n+â”Š   â”Š 89â”Š\n+â”Š   â”Š 90â”Š  button {\n+â”Š   â”Š 91â”Š    width: 100px;\n+â”Š   â”Š 92â”Š    display: block;\n+â”Š   â”Š 93â”Š    margin-left: auto;\n+â”Š   â”Š 94â”Š    margin-right: auto;\n+â”Š   â”Š 95â”Š    background-color: var(--secondary-bg) !important;\n+â”Š   â”Š 96â”Š\n+â”Š   â”Š 97â”Š    &[disabled] {\n+â”Š   â”Š 98â”Š      color: #38a81c;\n+â”Š   â”Š 99â”Š    }\n+â”Š   â”Š100â”Š\n+â”Š   â”Š101â”Š    &:not([disabled]) {\n+â”Š   â”Š102â”Š      color: white;\n+â”Š   â”Š103â”Š    }\n+â”Š   â”Š104â”Š  }\n+â”Š   â”Š105â”Š`\n+â”Š   â”Š106â”Š\n+â”Š   â”Š107â”Šexport default ({ history, location }: RouteComponentProps) => (\n+â”Š   â”Š108â”Š  <Style className=\"AuthScreen Screen\">\n+â”Š   â”Š109â”Š    <div className=\"AuthScreen-intro\">\n+â”Š   â”Š110â”Š      <img src=\"assets/whatsapp-icon.png\" className=\"AuthScreen-icon\" />\n+â”Š   â”Š111â”Š      <h2 className=\"AuthScreen-title\">WhatsApp Clone</h2>\n+â”Š   â”Š112â”Š    </div>\n+â”Š   â”Š113â”Š    <AnimatedSwitch>\n+â”Š   â”Š114â”Š      <Route exact path=\"/sign-in\" component={SignInForm} />\n+â”Š   â”Š115â”Š      <Route exact path=\"/sign-up\" component={SignUpForm} />\n+â”Š   â”Š116â”Š    </AnimatedSwitch>\n+â”Š   â”Š117â”Š  </Style>\n+â”Š   â”Š118â”Š)\n```\n\n[}]: #\n\nIf you'll look at the main AuthScreen component you'll see that we use a router to alternate between the sign-in and the sign-up forms. That's the meaning behind a Switch component. However, you can also notice that we use an AnimatedSwitch. As it sounds, this component will ensure that transition between routes is animated. This upgrade our UX in the app, and it is also designated to be used across other routes. If so, let's implement it. First we will need to install a package called `react-router-transition`:\n\n    $ yarn add react-router-transition@1.2.1\n\nThis will enable the transition between the routes. However, we will need to specify the characteristics of the transition, so, let's implement our own version of AnimatedSwitch:\n\n[{]: <helper> (diffStep 2.2 files=\"src/components/AnimatedSwitch\" module=\"client\")\n\n#### [Step 2.2: Implement auth components](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/a67226a)\n\n##### Added src&#x2F;components&#x2F;AnimatedSwitch.tsx\n```diff\n@@ -0,0 +1,30 @@\n+â”Š  â”Š 1â”Šimport styled from 'styled-components'\n+â”Š  â”Š 2â”Šimport { AnimatedSwitch, spring } from 'react-router-transition'\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šconst glide = val =>\n+â”Š  â”Š 5â”Š  spring(val, {\n+â”Š  â”Š 6â”Š    stiffness: 174,\n+â”Š  â”Š 7â”Š    damping: 24,\n+â”Š  â”Š 8â”Š  })\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Šconst mapStyles = styles => ({\n+â”Š  â”Š11â”Š  transform: `translateX(${styles.offset}%)`,\n+â”Š  â”Š12â”Š})\n+â”Š  â”Š13â”Š\n+â”Š  â”Š14â”Šexport default styled(AnimatedSwitch).attrs(() => ({\n+â”Š  â”Š15â”Š  atEnter: { offset: 100 },\n+â”Š  â”Š16â”Š  atLeave: { offset: glide(-100) },\n+â”Š  â”Š17â”Š  atActive: { offset: glide(0) },\n+â”Š  â”Š18â”Š  mapStyles,\n+â”Š  â”Š19â”Š}))`\n+â”Š  â”Š20â”Š  position: relative;\n+â”Š  â”Š21â”Š  overflow: hidden;\n+â”Š  â”Š22â”Š  width: 100%;\n+â”Š  â”Š23â”Š  height: 100%;\n+â”Š  â”Š24â”Š  > div {\n+â”Š  â”Š25â”Š    position: absolute;\n+â”Š  â”Š26â”Š    overflow: hidden;\n+â”Š  â”Š27â”Š    width: 100%;\n+â”Š  â”Š28â”Š    height: 100%;\n+â”Š  â”Š29â”Š  }\n+â”Š  â”Š30â”Š`\n```\n\n[}]: #\n\nAs shown in the screenshot at the top of this page, the auth screen includes few assets that we should download: a background picture and a logo. Please download the assets below and save them in the `public/assets` directory as `chat-background.jpg` and `whatsapp-icon.jpg` respectively:\n\n![chat-background.jpg](https://user-images.githubusercontent.com/7648874/51983290-3f49a080-24d3-11e9-9de9-cf57354d1e3a.jpg)\n\n![whatsapp-icon.jpg](https://user-images.githubusercontent.com/7648874/52662552-768e6780-2f3f-11e9-931c-36a5c13ca49b.png)\n\nSo following that, we would need to define a router that will handle changes in routes. We will be using `react-router-dom`:\n\n    $ yarn add react-router-dom@4.3.1\n\nNow that we have it let's define our routes. Note how we take advantage of the `withAuth()` method to guard our routes and make them available only to users who are authorized:\n\n[{]: <helper> (diffStep 2.3 files=\"src/App\" module=\"client\")\n\n#### [Step 2.3: Create router with guarded routes](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/79ff9eb)\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -1,14 +1,20 @@\n-â”Š 1â”Š  â”Šimport React, { Component } from 'react';\n+â”Š  â”Š 1â”Šimport * as React from 'react'\n+â”Š  â”Š 2â”Šimport { BrowserRouter, Route, Redirect } from 'react-router-dom'\n+â”Š  â”Š 3â”Šimport AnimatedSwitch from './components/AnimatedSwitch'\n+â”Š  â”Š 4â”Šimport AuthScreen from './components/AuthScreen'\n â”Š 2â”Š 5â”Šimport ChatsListScreen from './components/ChatsListScreen'\n+â”Š  â”Š 6â”Šimport { withAuth } from './services/auth.service'\n â”Š 3â”Š 7â”Š\n-â”Š 4â”Š  â”Šclass App extends Component {\n-â”Š 5â”Š  â”Š  render() {\n-â”Š 6â”Š  â”Š    return (\n-â”Š 7â”Š  â”Š      <div className=\"App\">\n-â”Š 8â”Š  â”Š        <ChatsListScreen />\n-â”Š 9â”Š  â”Š      </div>\n-â”Š10â”Š  â”Š    );\n-â”Š11â”Š  â”Š  }\n-â”Š12â”Š  â”Š}\n+â”Š  â”Š 8â”Šconst RedirectToChats = () => (\n+â”Š  â”Š 9â”Š  <Redirect to=\"/chats\" />\n+â”Š  â”Š10â”Š)\n â”Š13â”Š11â”Š\n-â”Š14â”Š  â”Šexport default App;\n+â”Š  â”Š12â”Šexport default () => (\n+â”Š  â”Š13â”Š  <BrowserRouter>\n+â”Š  â”Š14â”Š    <AnimatedSwitch>\n+â”Š  â”Š15â”Š      <Route exact path=\"/sign-(in|up)\" component={AuthScreen} />\n+â”Š  â”Š16â”Š      <Route exact path=\"/chats\" component={withAuth(ChatsListScreen)} />\n+â”Š  â”Š17â”Š      <Route component={RedirectToChats} />\n+â”Š  â”Š18â”Š    </AnimatedSwitch>\n+â”Š  â”Š19â”Š  </BrowserRouter>\n+â”Š  â”Š20â”Š)\n```\n\n[}]: #\n\nSince in our auth service we basically check if the user is logged in by actually querying the server with a React hook, we will need to use a Suspense component that will catch the pending request.\n\n[{]: <helper> (diffStep 2.3 files=\"src/index\" module=\"client\")\n\n#### [Step 2.3: Create router with guarded routes](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/79ff9eb)\n\n##### Changed src&#x2F;index.tsx\n```diff\n@@ -1,5 +1,6 @@\n â”Š1â”Š1â”Šimport { MuiThemeProvider, createMuiTheme } from '@material-ui/core/styles'\n â”Š2â”Š2â”Šimport React from 'react';\n+â”Š â”Š3â”Šimport { Suspense } from 'react'\n â”Š3â”Š4â”Šimport ReactDOM from 'react-dom';\n â”Š4â”Š5â”Šimport { ApolloProvider } from 'react-apollo-hooks';\n â”Š5â”Š6â”Šimport './index.css';\n```\n```diff\n@@ -20,7 +21,9 @@\n â”Š20â”Š21â”ŠReactDOM.render(\n â”Š21â”Š22â”Š  <MuiThemeProvider theme={theme}>\n â”Š22â”Š23â”Š    <ApolloProvider client={apolloClient}>\n-â”Š23â”Š  â”Š      <App />\n+â”Š  â”Š24â”Š      <Suspense fallback={null}>\n+â”Š  â”Š25â”Š        <App />\n+â”Š  â”Š26â”Š      </Suspense>\n â”Š24â”Š27â”Š    </ApolloProvider>\n â”Š25â”Š28â”Š  </MuiThemeProvider>\n â”Š26â”Š29â”Š, document.getElementById('root'));\n```\n\n[}]: #\n\n> It's highly recommended to go through the [docs of Suspense](https://reactjs.org/docs/react-api.html#reactsuspense) before you proceed if you're not familiar with it.\n\nPerfect. Now we can sign-in and sign-up, and we can view chats which belong to us. Now we're gonna implement the settings screen, where we will be able to set our profile details, such as name and picture. Let's keep the image uploading thing for a bit later, we will focus on the component itself first. The settings screen layout includes:\n\n- A navbar.\n- A form with inputs.\n\nAccordingly, the implementation of the screen should look like so:\n\n[{]: <helper> (diffStep 2.4 files=\"src/components\" module=\"client\")\n\n#### [Step 2.4: Implement settings screen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/2ebdaf2)\n\n##### Added src&#x2F;components&#x2F;SettingsScreen&#x2F;SettingsForm.tsx\n```diff\n@@ -0,0 +1,127 @@\n+â”Š   â”Š  1â”Šimport TextField from '@material-ui/core/TextField'\n+â”Š   â”Š  2â”Šimport EditIcon from '@material-ui/icons/Edit'\n+â”Š   â”Š  3â”Šimport { defaultDataIdFromObject } from 'apollo-cache-inmemory'\n+â”Š   â”Š  4â”Šimport gql from 'graphql-tag'\n+â”Š   â”Š  5â”Šimport * as React from 'react'\n+â”Š   â”Š  6â”Šimport { useEffect, useState } from 'react'\n+â”Š   â”Š  7â”Šimport { useMutation } from 'react-apollo-hooks'\n+â”Š   â”Š  8â”Šimport { RouteComponentProps } from 'react-router-dom'\n+â”Š   â”Š  9â”Šimport styled from 'styled-components'\n+â”Š   â”Š 10â”Šimport * as fragments from '../../graphql/fragments'\n+â”Š   â”Š 11â”Šimport { SettingsFormMutation } from '../../graphql/types'\n+â”Š   â”Š 12â”Šimport { useMe } from '../../services/auth.service'\n+â”Š   â”Š 13â”Šimport Navbar from '../Navbar'\n+â”Š   â”Š 14â”Šimport SettingsNavbar from './SettingsNavbar'\n+â”Š   â”Š 15â”Š\n+â”Š   â”Š 16â”Šconst Style = styled.div`\n+â”Š   â”Š 17â”Š  .SettingsForm-picture {\n+â”Š   â”Š 18â”Š    max-width: 300px;\n+â”Š   â”Š 19â”Š    display: block;\n+â”Š   â”Š 20â”Š    margin: auto;\n+â”Š   â”Š 21â”Š    margin-top: 50px;\n+â”Š   â”Š 22â”Š\n+â”Š   â”Š 23â”Š    img {\n+â”Š   â”Š 24â”Š      object-fit: cover;\n+â”Š   â”Š 25â”Š      border-radius: 50%;\n+â”Š   â”Š 26â”Š      margin-bottom: -34px;\n+â”Š   â”Š 27â”Š      width: 300px;\n+â”Š   â”Š 28â”Š      height: 300px;\n+â”Š   â”Š 29â”Š    }\n+â”Š   â”Š 30â”Š\n+â”Š   â”Š 31â”Š    svg {\n+â”Š   â”Š 32â”Š      float: right;\n+â”Š   â”Š 33â”Š      font-size: 30px;\n+â”Š   â”Š 34â”Š      opacity: 0.5;\n+â”Š   â”Š 35â”Š      border-left: black solid 1px;\n+â”Š   â”Š 36â”Š      padding-left: 5px;\n+â”Š   â”Š 37â”Š      cursor: pointer;\n+â”Š   â”Š 38â”Š    }\n+â”Š   â”Š 39â”Š  }\n+â”Š   â”Š 40â”Š\n+â”Š   â”Š 41â”Š  .SettingsForm-name-input {\n+â”Š   â”Š 42â”Š    display: block;\n+â”Š   â”Š 43â”Š    margin: auto;\n+â”Š   â”Š 44â”Š    width: calc(100% - 50px);\n+â”Š   â”Š 45â”Š    margin-top: 50px;\n+â”Š   â”Š 46â”Š\n+â”Š   â”Š 47â”Š    > div {\n+â”Š   â”Š 48â”Š      width: 100%;\n+â”Š   â”Š 49â”Š    }\n+â”Š   â”Š 50â”Š  }\n+â”Š   â”Š 51â”Š`\n+â”Š   â”Š 52â”Š\n+â”Š   â”Š 53â”Šconst mutation = gql`\n+â”Š   â”Š 54â”Š  mutation SettingsFormMutation($name: String, $picture: String) {\n+â”Š   â”Š 55â”Š    updateUser(name: $name, picture: $picture) {\n+â”Š   â”Š 56â”Š      ...User\n+â”Š   â”Š 57â”Š    }\n+â”Š   â”Š 58â”Š  }\n+â”Š   â”Š 59â”Š  ${fragments.user}\n+â”Š   â”Š 60â”Š`\n+â”Š   â”Š 61â”Š\n+â”Š   â”Š 62â”Šexport default ({ history }: RouteComponentProps) => {\n+â”Š   â”Š 63â”Š  const me = useMe()\n+â”Š   â”Š 64â”Š  const [myName, setMyName] = useState(me.name)\n+â”Š   â”Š 65â”Š  const [myPicture, setMyPicture] = useState(me.picture)\n+â”Š   â”Š 66â”Š\n+â”Š   â”Š 67â”Š  const updateUser = useMutation<SettingsFormMutation.Mutation, SettingsFormMutation.Variables>(\n+â”Š   â”Š 68â”Š    mutation,\n+â”Š   â”Š 69â”Š    {\n+â”Š   â”Š 70â”Š      variables: { name: myName, picture: myPicture },\n+â”Š   â”Š 71â”Š      optimisticResponse: {\n+â”Š   â”Š 72â”Š        __typename: 'Mutation',\n+â”Š   â”Š 73â”Š        updateUser: {\n+â”Š   â”Š 74â”Š          __typename: 'User',\n+â”Š   â”Š 75â”Š          id: me.id,\n+â”Š   â”Š 76â”Š          picture: myPicture,\n+â”Š   â”Š 77â”Š          name: myName,\n+â”Š   â”Š 78â”Š        },\n+â”Š   â”Š 79â”Š      },\n+â”Š   â”Š 80â”Š      update: (client, { data: { updateUser } }) => {\n+â”Š   â”Š 81â”Š        me.picture = myPicture\n+â”Š   â”Š 82â”Š        me.name = myPicture\n+â”Š   â”Š 83â”Š\n+â”Š   â”Š 84â”Š        client.writeFragment({\n+â”Š   â”Š 85â”Š          id: defaultDataIdFromObject(me),\n+â”Š   â”Š 86â”Š          fragment: fragments.user,\n+â”Š   â”Š 87â”Š          data: me,\n+â”Š   â”Š 88â”Š        })\n+â”Š   â”Š 89â”Š      },\n+â”Š   â”Š 90â”Š    },\n+â”Š   â”Š 91â”Š  )\n+â”Š   â”Š 92â”Š\n+â”Š   â”Š 93â”Š  useEffect(\n+â”Š   â”Š 94â”Š    () => {\n+â”Š   â”Š 95â”Š      if (myPicture !== me.picture) {\n+â”Š   â”Š 96â”Š        updateUser()\n+â”Š   â”Š 97â”Š      }\n+â”Š   â”Š 98â”Š    },\n+â”Š   â”Š 99â”Š    [myPicture],\n+â”Š   â”Š100â”Š  )\n+â”Š   â”Š101â”Š\n+â”Š   â”Š102â”Š  const updateName = ({ target }) => {\n+â”Š   â”Š103â”Š    setMyName(target.value)\n+â”Š   â”Š104â”Š  }\n+â”Š   â”Š105â”Š\n+â”Š   â”Š106â”Š  const updatePicture = async () => {\n+â”Š   â”Š107â”Š    // TODO: Implement\n+â”Š   â”Š108â”Š  }\n+â”Š   â”Š109â”Š\n+â”Š   â”Š110â”Š  return (\n+â”Š   â”Š111â”Š    <Style className={name}>\n+â”Š   â”Š112â”Š      <div className=\"SettingsForm-picture\">\n+â”Š   â”Š113â”Š        <img src={myPicture || '/assets/default-profile-pic.jpg'} />\n+â”Š   â”Š114â”Š        <EditIcon onClick={updatePicture} />\n+â”Š   â”Š115â”Š      </div>\n+â”Š   â”Š116â”Š      <TextField\n+â”Š   â”Š117â”Š        className=\"SettingsForm-name-input\"\n+â”Š   â”Š118â”Š        label=\"Name\"\n+â”Š   â”Š119â”Š        value={myName}\n+â”Š   â”Š120â”Š        onChange={updateName}\n+â”Š   â”Š121â”Š        onBlur={updateUser}\n+â”Š   â”Š122â”Š        margin=\"normal\"\n+â”Š   â”Š123â”Š        placeholder=\"Enter your name\"\n+â”Š   â”Š124â”Š      />\n+â”Š   â”Š125â”Š    </Style>\n+â”Š   â”Š126â”Š  )\n+â”Š   â”Š127â”Š}\n```\n\n##### Added src&#x2F;components&#x2F;SettingsScreen&#x2F;SettingsNavbar.tsx\n```diff\n@@ -0,0 +1,49 @@\n+â”Š  â”Š 1â”Šimport Button from '@material-ui/core/Button'\n+â”Š  â”Š 2â”Šimport ArrowBackIcon from '@material-ui/icons/ArrowBack'\n+â”Š  â”Š 3â”Šimport { History } from 'history'\n+â”Š  â”Š 4â”Šimport * as React from 'react'\n+â”Š  â”Š 5â”Šimport styled from 'styled-components'\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Šconst Style = styled.div`\n+â”Š  â”Š 8â”Š  padding: 0;\n+â”Š  â”Š 9â”Š  display: flex;\n+â”Š  â”Š10â”Š  flex-direction: row;\n+â”Š  â”Š11â”Š  margin-left: -20px;\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Š  .SettingsNavbar-title {\n+â”Š  â”Š14â”Š    line-height: 56px;\n+â”Š  â”Š15â”Š  }\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š  .SettingsNavbar-back-button {\n+â”Š  â”Š18â”Š    color: var(--primary-text);\n+â”Š  â”Š19â”Š  }\n+â”Š  â”Š20â”Š\n+â”Š  â”Š21â”Š  .SettingsNavbar-picture {\n+â”Š  â”Š22â”Š    height: 40px;\n+â”Š  â”Š23â”Š    width: 40px;\n+â”Š  â”Š24â”Š    margin-top: 3px;\n+â”Š  â”Š25â”Š    margin-left: -22px;\n+â”Š  â”Š26â”Š    object-fit: cover;\n+â”Š  â”Š27â”Š    padding: 5px;\n+â”Š  â”Š28â”Š    border-radius: 50%;\n+â”Š  â”Š29â”Š  }\n+â”Š  â”Š30â”Š`\n+â”Š  â”Š31â”Š\n+â”Š  â”Š32â”Šinterface SettingsNavbarProps {\n+â”Š  â”Š33â”Š  history: History\n+â”Š  â”Š34â”Š}\n+â”Š  â”Š35â”Š\n+â”Š  â”Š36â”Šexport default ({ history }: SettingsNavbarProps) => {\n+â”Š  â”Š37â”Š  const navToChats = () => {\n+â”Š  â”Š38â”Š    history.push('/chats')\n+â”Š  â”Š39â”Š  }\n+â”Š  â”Š40â”Š\n+â”Š  â”Š41â”Š  return (\n+â”Š  â”Š42â”Š    <Style className={name}>\n+â”Š  â”Š43â”Š      <Button className=\"SettingsNavbar-back-button\" onClick={navToChats}>\n+â”Š  â”Š44â”Š        <ArrowBackIcon />\n+â”Š  â”Š45â”Š      </Button>\n+â”Š  â”Š46â”Š      <div className=\"SettingsNavbar-title\">Settings</div>\n+â”Š  â”Š47â”Š    </Style>\n+â”Š  â”Š48â”Š  )\n+â”Š  â”Š49â”Š}\n```\n\n##### Added src&#x2F;components&#x2F;SettingsScreen&#x2F;index.tsx\n```diff\n@@ -0,0 +1,17 @@\n+â”Š  â”Š 1â”Šimport * as React from 'react'\n+â”Š  â”Š 2â”Šimport { Suspense } from 'react'\n+â”Š  â”Š 3â”Šimport { RouteComponentProps } from 'react-router-dom'\n+â”Š  â”Š 4â”Šimport Navbar from '../Navbar'\n+â”Š  â”Š 5â”Šimport SettingsForm from './SettingsForm'\n+â”Š  â”Š 6â”Šimport SettingsNavbar from './SettingsNavbar'\n+â”Š  â”Š 7â”Š\n+â”Š  â”Š 8â”Šexport default ({ history }: RouteComponentProps) => (\n+â”Š  â”Š 9â”Š  <div className=\"SettingsScreen Screen\">\n+â”Š  â”Š10â”Š    <Navbar>\n+â”Š  â”Š11â”Š      <SettingsNavbar history={history} />\n+â”Š  â”Š12â”Š    </Navbar>\n+â”Š  â”Š13â”Š    <Suspense fallback={null}>\n+â”Š  â”Š14â”Š      <SettingsForm />\n+â”Š  â”Š15â”Š    </Suspense>\n+â”Š  â”Š16â”Š  </div>\n+â”Š  â”Š17â”Š)\n```\n\n[}]: #\n\nThe `optimisticResponse` object is used to predict the response so we can have it immediately and the `update` callback is used to update the cache. Anytime we receive a response from our GraphQL back-end we should update the cache, otherwise the data presented in our app will be out-dated.\n\nThe user should be updated on 2 scenarios: Either we loose focus on the name input or we upload a new image. We used the [`useEffect`](https://reactjs.org/docs/hooks-effect.html) to determine changes in the profile picture URL and trigger an update.\n\nWe will need to update our back-end to have an `updateUser` mutation:\n\n[{]: <helper> (diffStep 2.2 files=\"modules/user\" module=\"server\")\n\n#### Step 2.2: Add updateUser() mutation\n\n##### Changed modules&#x2F;user&#x2F;providers&#x2F;user.provider.ts\n```diff\n@@ -23,4 +23,23 @@\n â”Š23â”Š23â”Š      .where('user.id != :id', { id: this.currentUser.id })\n â”Š24â”Š24â”Š      .getMany()\n â”Š25â”Š25â”Š  }\n+â”Š  â”Š26â”Š\n+â”Š  â”Š27â”Š  async updateUser({\n+â”Š  â”Š28â”Š    name,\n+â”Š  â”Š29â”Š    picture,\n+â”Š  â”Š30â”Š  }: {\n+â”Š  â”Š31â”Š    name?: string,\n+â”Š  â”Š32â”Š    picture?: string,\n+â”Š  â”Š33â”Š  } = {}) {\n+â”Š  â”Š34â”Š    if (name === this.currentUser.name && picture === this.currentUser.picture) {\n+â”Š  â”Š35â”Š      return this.currentUser;\n+â”Š  â”Š36â”Š    }\n+â”Š  â”Š37â”Š\n+â”Š  â”Š38â”Š    this.currentUser.name = name || this.currentUser.name;\n+â”Š  â”Š39â”Š    this.currentUser.picture = picture || this.currentUser.picture;\n+â”Š  â”Š40â”Š\n+â”Š  â”Š41â”Š    await this.repository.save(this.currentUser);\n+â”Š  â”Š42â”Š\n+â”Š  â”Š43â”Š    return this.currentUser;\n+â”Š  â”Š44â”Š  }\n â”Š26â”Š45â”Š}\n```\n\n##### Changed modules&#x2F;user&#x2F;resolvers&#x2F;resolvers.ts\n```diff\n@@ -8,4 +8,10 @@\n â”Š 8â”Š 8â”Š    me: (obj, args, { injector }) => injector.get(UserProvider).getMe(),\n â”Š 9â”Š 9â”Š    users: (obj, args, { injector }) => injector.get(UserProvider).getUsers(),\n â”Š10â”Š10â”Š  },\n+â”Š  â”Š11â”Š  Mutation: {\n+â”Š  â”Š12â”Š    updateUser: (obj, { name, picture }, { injector }) => injector.get(UserProvider).updateUser({\n+â”Š  â”Š13â”Š      name: name || '',\n+â”Š  â”Š14â”Š      picture: picture || '',\n+â”Š  â”Š15â”Š    }),\n+â”Š  â”Š16â”Š  },\n â”Š11â”Š17â”Š} as IResolvers\n```\n\n##### Changed modules&#x2F;user&#x2F;schema&#x2F;typeDefs.graphql\n```diff\n@@ -3,6 +3,10 @@\n â”Š 3â”Š 3â”Š  users: [User!]\n â”Š 4â”Š 4â”Š}\n â”Š 5â”Š 5â”Š\n+â”Š  â”Š 6â”Štype Mutation {\n+â”Š  â”Š 7â”Š  updateUser(name: String, picture: String): User!\n+â”Š  â”Š 8â”Š}\n+â”Š  â”Š 9â”Š\n â”Š 6â”Š10â”Štype User {\n â”Š 7â”Š11â”Š  id: ID!\n â”Š 8â”Š12â”Š  name: String\n```\n\n[}]: #\n\nRemember that a user could be correlated to a chat, for example, if a user changes its information such as name or picture, the chat informationshould be changed as well. This means that we will need to listen to changes with a [subscription](https://www.apollographql.com/docs/react/advanced/subscriptions.html) and update our cache accordingly.\n\nSince `react-apollo-hooks` doesn't have a built-in `useSubscription()` hook as for version `0.3.1`, we will implement a polyfill that will do exactly that. First we will ad a utility package:\n\n    $ yarn add react-fast-compare@2.0.4\n\nAnd then we will implement the `useSubscription()` hook:\n\n[{]: <helper> (diffStep 2.5 files=\"src/polyfills\" module=\"client\")\n\n#### [Step 2.5: Handle chat update subscription](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/e5a2cf5)\n\n##### Added src&#x2F;polyfills&#x2F;react-apollo-hooks.ts\n```diff\n@@ -0,0 +1,72 @@\n+â”Š  â”Š 1â”Šimport { DataProxy } from 'apollo-cache'\n+â”Š  â”Š 2â”Šimport { OperationVariables, FetchPolicy } from 'apollo-client'\n+â”Š  â”Š 3â”Šimport { DocumentNode, GraphQLError } from 'graphql'\n+â”Š  â”Š 4â”Šimport { useEffect, useMemo, useRef, useState } from 'react'\n+â”Š  â”Š 5â”Šimport { useApolloClient } from 'react-apollo-hooks'\n+â”Š  â”Š 6â”Šimport * as isEqual from 'react-fast-compare'\n+â”Š  â”Š 7â”Š\n+â”Š  â”Š 8â”Šexport type SubscriptionOptions<T, TVariables> = {\n+â”Š  â”Š 9â”Š  variables?: TVariables\n+â”Š  â”Š10â”Š  fetchPolicy?: FetchPolicy\n+â”Š  â”Š11â”Š  onSubscriptionData?: (options?: { client?: DataProxy; subscriptionData?: T }) => any\n+â”Š  â”Š12â”Š}\n+â”Š  â”Š13â”Š\n+â”Š  â”Š14â”Šexport const useSubscription = <T, TVariables = OperationVariables>(\n+â”Š  â”Š15â”Š  query: DocumentNode,\n+â”Š  â”Š16â”Š  options: SubscriptionOptions<T, TVariables> = {},\n+â”Š  â”Š17â”Š): {\n+â”Š  â”Š18â”Š  data: T | { [key: string]: void }\n+â”Š  â”Š19â”Š  error?: GraphQLError\n+â”Š  â”Š20â”Š  loading: boolean\n+â”Š  â”Š21â”Š} => {\n+â”Š  â”Š22â”Š  const onSubscriptionData = options.onSubscriptionData\n+â”Š  â”Š23â”Š  const prevOptions = useRef<typeof options | null>(null)\n+â”Š  â”Š24â”Š  const client = useApolloClient()\n+â”Š  â”Š25â”Š  const [data, setData] = useState<T | {}>({})\n+â”Š  â”Š26â”Š  const [error, setError] = useState<GraphQLError | null>(null)\n+â”Š  â”Š27â”Š  const [loading, setLoading] = useState<boolean>(true)\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š  const subscriptionOptions = {\n+â”Š  â”Š30â”Š    query,\n+â”Š  â”Š31â”Š    variables: options.variables,\n+â”Š  â”Š32â”Š    fetchPolicy: options.fetchPolicy,\n+â”Š  â”Š33â”Š  }\n+â”Š  â”Š34â”Š\n+â”Š  â”Š35â”Š  useEffect(\n+â”Š  â”Š36â”Š    () => {\n+â”Š  â”Š37â”Š      prevOptions.current = subscriptionOptions\n+â”Š  â”Š38â”Š      const subscription = client\n+â”Š  â”Š39â”Š        .subscribe<{ data: T }, TVariables>(subscriptionOptions)\n+â”Š  â”Š40â”Š        .subscribe({\n+â”Š  â”Š41â”Š          next: ({ data }) => {\n+â”Š  â”Š42â”Š            setData(data)\n+â”Š  â”Š43â”Š\n+â”Š  â”Š44â”Š            if (onSubscriptionData) {\n+â”Š  â”Š45â”Š              onSubscriptionData({ client, subscriptionData: data })\n+â”Š  â”Š46â”Š            }\n+â”Š  â”Š47â”Š          },\n+â”Š  â”Š48â”Š          error: err => {\n+â”Š  â”Š49â”Š            setError(err)\n+â”Š  â”Š50â”Š            setLoading(false)\n+â”Š  â”Š51â”Š          },\n+â”Š  â”Š52â”Š          complete: () => {\n+â”Š  â”Š53â”Š            setLoading(false)\n+â”Š  â”Š54â”Š          },\n+â”Š  â”Š55â”Š        })\n+â”Š  â”Š56â”Š\n+â”Š  â”Š57â”Š      return () => {\n+â”Š  â”Š58â”Š        subscription.unsubscribe()\n+â”Š  â”Š59â”Š      }\n+â”Š  â”Š60â”Š    },\n+â”Š  â”Š61â”Š    [isEqual(prevOptions.current, subscriptionOptions) ? prevOptions.current : subscriptionOptions],\n+â”Š  â”Š62â”Š  )\n+â”Š  â”Š63â”Š\n+â”Š  â”Š64â”Š  return useMemo(\n+â”Š  â”Š65â”Š    () => ({\n+â”Š  â”Š66â”Š      data,\n+â”Š  â”Š67â”Š      error,\n+â”Š  â”Š68â”Š      loading,\n+â”Š  â”Š69â”Š    }),\n+â”Š  â”Š70â”Š    [data, error, loading],\n+â”Š  â”Š71â”Š  )\n+â”Š  â”Š72â”Š}\n```\n\n[}]: #\n\nThen we will define the subscription document and listen to it in a dedicated service called `cache.service`, which is responsible for updating the cache:\n\n[{]: <helper> (diffStep 2.5 files=\"src/graphql, src/services/cache\" module=\"client\")\n\n#### [Step 2.5: Handle chat update subscription](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/e5a2cf5)\n\n##### Added src&#x2F;graphql&#x2F;subscriptions&#x2F;chatUpdated.subscription.ts\n```diff\n@@ -0,0 +1,11 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag'\n+â”Š  â”Š 2â”Šimport * as fragments from '../fragments'\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šexport default gql `\n+â”Š  â”Š 5â”Š  subscription ChatUpdated {\n+â”Š  â”Š 6â”Š    chatUpdated {\n+â”Š  â”Š 7â”Š      ...Chat\n+â”Š  â”Š 8â”Š    }\n+â”Š  â”Š 9â”Š  }\n+â”Š  â”Š10â”Š  ${fragments.chat}\n+â”Š  â”Š11â”Š`\n```\n\n##### Added src&#x2F;graphql&#x2F;subscriptions&#x2F;index.ts\n```diff\n@@ -0,0 +1 @@\n+â”Š â”Š1â”Šexport { default as chatUpdated } from './chatUpdated.subscription'\n```\n\n##### Added src&#x2F;services&#x2F;cache.service.tsx\n```diff\n@@ -0,0 +1,18 @@\n+â”Š  â”Š 1â”Šimport { defaultDataIdFromObject } from 'apollo-cache-inmemory'\n+â”Š  â”Š 2â”Šimport * as fragments from '../graphql/fragments'\n+â”Š  â”Š 3â”Šimport * as subscriptions from '../graphql/subscriptions'\n+â”Š  â”Š 4â”Šimport { ChatUpdated } from '../graphql/types'\n+â”Š  â”Š 5â”Šimport { useSubscription } from '../polyfills/react-apollo-hooks'\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Šexport const useSubscriptions = () => {\n+â”Š  â”Š 8â”Š  useSubscription<ChatUpdated.Subscription>(subscriptions.chatUpdated, {\n+â”Š  â”Š 9â”Š    onSubscriptionData: ({ client, subscriptionData: { chatUpdated } }) => {\n+â”Š  â”Š10â”Š      client.writeFragment({\n+â”Š  â”Š11â”Š        id: defaultDataIdFromObject(chatUpdated),\n+â”Š  â”Š12â”Š        fragment: fragments.chat,\n+â”Š  â”Š13â”Š        fragmentName: 'Chat',\n+â”Š  â”Š14â”Š        data: chatUpdated,\n+â”Š  â”Š15â”Š      })\n+â”Š  â”Š16â”Š    },\n+â”Š  â”Š17â”Š  })\n+â”Š  â”Š18â”Š}\n```\n\n[}]: #\n\nWe should listen to subscriptions only once we're logged-in, therefore let's use the `useSubscriptions()` hook that we've just created in the `auth.service`:\n\n[{]: <helper> (diffStep 2.5 files=\"src/services/auth\" module=\"client\")\n\n#### [Step 2.5: Handle chat update subscription](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/e5a2cf5)\n\n##### Changed src&#x2F;services&#x2F;auth.service.tsx\n```diff\n@@ -5,6 +5,7 @@\n â”Š 5â”Š 5â”Šimport store from '../apollo-client'\n â”Š 6â”Š 6â”Šimport * as queries from '../graphql/queries'\n â”Š 7â”Š 7â”Šimport { Me, User } from '../graphql/types'\n+â”Š  â”Š 8â”Šimport { useSubscriptions } from './cache.service'\n â”Š 8â”Š 9â”Š\n â”Š 9â”Š10â”Šconst MyContext = React.createContext<User.Fragment>(null)\n â”Š10â”Š11â”Š\n```\n```diff\n@@ -22,6 +23,8 @@\n â”Š22â”Š23â”Š    // Override TypeScript definition issue with the current version\n â”Š23â”Š24â”Š    if (myResult.error) return <Redirect to=\"/sign-in\" />\n â”Š24â”Š25â”Š\n+â”Š  â”Š26â”Š    useSubscriptions()\n+â”Š  â”Š27â”Š\n â”Š25â”Š28â”Š    return (\n â”Š26â”Š29â”Š      <MyContext.Provider value={myResult.data.me}>\n â”Š27â”Š30â”Š        <Component {...props} />\n```\n\n[}]: #\n\nNow we will have to implement the subscription in our server. GraphQL subscriptions are a way to push data from the server to the clients that choose to listen to real time messages from the server. To trigger a subscription event we will use a method called `publish` which is used by a class called `PubSub`. Pubsub sits between your application's logic and the GraphQL subscriptions engine - it receives a publish command from your app logic and pushes it to your GraphQL execution engine. This is how it should look like in code, in relation to `chatUpdated` subscription:\n\n[{]: <helper> (diffStep 2.3 module=\"server\")\n\n#### Step 2.3: Add chatUpdated subscription\n\n##### Changed index.ts\n```diff\n@@ -21,11 +21,12 @@\n â”Š21â”Š21â”Š  app.use(cors())\n â”Š22â”Š22â”Š  app.use(bodyParser.json())\n â”Š23â”Š23â”Š\n-â”Š24â”Š  â”Š  const { schema, context } = AppModule.forRoot({ app, connection })\n+â”Š  â”Š24â”Š  const { schema, context, subscriptions } = AppModule.forRoot({ app, connection })\n â”Š25â”Š25â”Š\n â”Š26â”Š26â”Š  const apollo = new ApolloServer({\n â”Š27â”Š27â”Š    schema,\n â”Š28â”Š28â”Š    context,\n+â”Š  â”Š29â”Š    subscriptions,\n â”Š29â”Š30â”Š  })\n â”Š30â”Š31â”Š\n â”Š31â”Š32â”Š  apollo.applyMiddleware({\n```\n\n##### Changed modules&#x2F;chat&#x2F;providers&#x2F;chat.provider.ts\n```diff\n@@ -1,4 +1,5 @@\n â”Š1â”Š1â”Šimport { Injectable } from '@graphql-modules/di'\n+â”Š â”Š2â”Šimport { PubSub } from 'apollo-server-express'\n â”Š2â”Š3â”Šimport { Connection } from 'typeorm'\n â”Š3â”Š4â”Šimport { Chat } from '../../../entity/chat'\n â”Š4â”Š5â”Šimport { User } from '../../../entity/user'\n```\n```diff\n@@ -8,6 +9,7 @@\n â”Š 8â”Š 9â”Š@Injectable()\n â”Š 9â”Š10â”Šexport class ChatProvider {\n â”Š10â”Š11â”Š  constructor(\n+â”Š  â”Š12â”Š    private pubsub: PubSub,\n â”Š11â”Š13â”Š    private connection: Connection,\n â”Š12â”Š14â”Š    private userProvider: UserProvider,\n â”Š13â”Š15â”Š    private authProvider: AuthProvider\n```\n```diff\n@@ -108,4 +110,53 @@\n â”Š108â”Š110â”Š\n â”Š109â”Š111â”Š    return owner || null\n â”Š110â”Š112â”Š  }\n+â”Š   â”Š113â”Š\n+â”Š   â”Š114â”Š  async filterChatAddedOrUpdated(chatAddedOrUpdated: Chat, creatorOrUpdaterId: string) {\n+â”Š   â”Š115â”Š    return (\n+â”Š   â”Š116â”Š      creatorOrUpdaterId !== this.currentUser.id &&\n+â”Š   â”Š117â”Š      chatAddedOrUpdated.listingMembers.some((user: User) => user.id === this.currentUser.id)\n+â”Š   â”Š118â”Š    )\n+â”Š   â”Š119â”Š  }\n+â”Š   â”Š120â”Š\n+â”Š   â”Š121â”Š  async updateUser({\n+â”Š   â”Š122â”Š    name,\n+â”Š   â”Š123â”Š    picture,\n+â”Š   â”Š124â”Š  }: {\n+â”Š   â”Š125â”Š    name?: string\n+â”Š   â”Š126â”Š    picture?: string\n+â”Š   â”Š127â”Š  } = {}) {\n+â”Š   â”Š128â”Š    await this.userProvider.updateUser({ name, picture })\n+â”Š   â”Š129â”Š\n+â”Š   â”Š130â”Š    const data = await this.connection\n+â”Š   â”Š131â”Š      .createQueryBuilder(User, 'user')\n+â”Š   â”Š132â”Š      .where('user.id = :id', { id: this.currentUser.id })\n+â”Š   â”Š133â”Š      // Get a list of the chats who have/had currentUser involved\n+â”Š   â”Š134â”Š      .innerJoinAndSelect(\n+â”Š   â”Š135â”Š        'user.allTimeMemberChats',\n+â”Š   â”Š136â”Š        'allTimeMemberChats',\n+â”Š   â”Š137â”Š        // Groups are unaffected\n+â”Š   â”Š138â”Š        'allTimeMemberChats.name IS NULL'\n+â”Š   â”Š139â”Š      )\n+â”Š   â”Š140â”Š      // We need to notify only those who get the chat listed (except currentUser of course)\n+â”Š   â”Š141â”Š      .innerJoin(\n+â”Š   â”Š142â”Š        'allTimeMemberChats.listingMembers',\n+â”Š   â”Š143â”Š        'listingMembers',\n+â”Š   â”Š144â”Š        'listingMembers.id != :currentUserId',\n+â”Š   â”Š145â”Š        {\n+â”Š   â”Š146â”Š          currentUserId: this.currentUser.id,\n+â”Š   â”Š147â”Š        }\n+â”Š   â”Š148â”Š      )\n+â”Š   â”Š149â”Š      .getOne()\n+â”Š   â”Š150â”Š\n+â”Š   â”Š151â”Š    const chatsAffected = (data && data.allTimeMemberChats) || []\n+â”Š   â”Š152â”Š\n+â”Š   â”Š153â”Š    chatsAffected.forEach(chat => {\n+â”Š   â”Š154â”Š      this.pubsub.publish('chatUpdated', {\n+â”Š   â”Š155â”Š        updaterId: this.currentUser.id,\n+â”Š   â”Š156â”Š        chatUpdated: chat,\n+â”Š   â”Š157â”Š      })\n+â”Š   â”Š158â”Š    })\n+â”Š   â”Š159â”Š\n+â”Š   â”Š160â”Š    return this.currentUser\n+â”Š   â”Š161â”Š  }\n â”Š111â”Š162â”Š}\n```\n\n##### Changed modules&#x2F;chat&#x2F;resolvers&#x2F;resolvers.ts\n```diff\n@@ -1,12 +1,28 @@\n+â”Š  â”Š 1â”Šimport { PubSub, withFilter } from 'apollo-server-express'\n â”Š 1â”Š 2â”Šimport { ModuleContext } from '@graphql-modules/core'\n â”Š 2â”Š 3â”Šimport { IResolvers } from '../../../types'\n â”Š 3â”Š 4â”Šimport { ChatProvider } from '../providers/chat.provider'\n+â”Š  â”Š 5â”Šimport { Chat } from '../../../entity/chat'\n â”Š 4â”Š 6â”Š\n â”Š 5â”Š 7â”Šexport default {\n â”Š 6â”Š 8â”Š  Query: {\n â”Š 7â”Š 9â”Š    chats: (obj, args, { injector }) => injector.get(ChatProvider).getChats(),\n â”Š 8â”Š10â”Š    chat: (obj, { chatId }, { injector }) => injector.get(ChatProvider).getChat(chatId),\n â”Š 9â”Š11â”Š  },\n+â”Š  â”Š12â”Š  Mutation: {\n+â”Š  â”Š13â”Š    updateUser: (obj, { name, picture }, { injector }) => injector.get(ChatProvider).updateUser({\n+â”Š  â”Š14â”Š      name: name || '',\n+â”Š  â”Š15â”Š      picture: picture || '',\n+â”Š  â”Š16â”Š    }),\n+â”Š  â”Š17â”Š  },\n+â”Š  â”Š18â”Š  Subscription: {\n+â”Š  â”Š19â”Š    chatUpdated: {\n+â”Š  â”Š20â”Š      subscribe: withFilter((root, args, { injector }: ModuleContext) => injector.get(PubSub).asyncIterator('chatUpdated'),\n+â”Š  â”Š21â”Š        (data: { chatUpdated: Chat, updaterId: string }, variables, { injector }: ModuleContext) =>\n+â”Š  â”Š22â”Š          data && injector.get(ChatProvider).filterChatAddedOrUpdated(data.chatUpdated, data.updaterId)\n+â”Š  â”Š23â”Š      ),\n+â”Š  â”Š24â”Š    },\n+â”Š  â”Š25â”Š  },\n â”Š10â”Š26â”Š  Chat: {\n â”Š11â”Š27â”Š    name: (chat, args, { injector }) => injector.get(ChatProvider).getChatName(chat),\n â”Š12â”Š28â”Š    picture: (chat, args, { injector }) => injector.get(ChatProvider).getChatPicture(chat),\n```\n\n##### Changed modules&#x2F;chat&#x2F;schema&#x2F;typeDefs.graphql\n```diff\n@@ -3,6 +3,10 @@\n â”Š 3â”Š 3â”Š  chat(chatId: ID!): Chat\n â”Š 4â”Š 4â”Š}\n â”Š 5â”Š 5â”Š\n+â”Š  â”Š 6â”Štype Subscription {\n+â”Š  â”Š 7â”Š  chatUpdated: Chat\n+â”Š  â”Š 8â”Š}\n+â”Š  â”Š 9â”Š\n â”Š 6â”Š10â”Štype Chat {\n â”Š 7â”Š11â”Š  #May be a chat or a group\n â”Š 8â”Š12â”Š  id: ID!\n```\n\n[}]: #\n\n> See [official Apollo subscription docs page](https://www.apollographql.com/docs/apollo-server/features/subscriptions.html).\n\nNote that we've added a second `updateUser()` resolver in addition to the one which already exists in the `user` module. Reason being is because we want to keep the `user` module independent from the `chat` module, and so we apply logic on top of the existing one. GQLModule's engine will execute the resolvers in the right order based on the injected dependencies tree, so you shouldn't worry much about execution.\n\nI'd like to get back to the image uploading feature. Although it can be implemented manually, we will be using an external service for storing images. This is much more convenient: it will save us a lot of implementation, it's probably more secure, and it has built-in features such as transformation and projection.\n\nWe will be using [Cloudinary](https://cloudinary.com/) as our storage service. A Cloudinary instance should be set for each application separately, but for the sake of demonstration we will use an instance that we set up for the public, but just know **that you should never reveal the credentials of any service that you set up**.\n\nFirst of all be sure to open an account and setup your basic app information in Cloudinary.\n\nThen, add a new preset called `profile-pic` where we will be resettings uploaded images' dimensions to 300px by 300px. More information on how to do that can be found in [here](https://support.cloudinary.com/hc/en-us/articles/360004967272-Upload-Preset-Configuration).\n\n![upload-picture-settings](https://user-images.githubusercontent.com/7648874/51096173-a984f480-17f5-11e9-893f-5227e2c564af.jpg)\n\nUp next, we will implement the appropriate route in our app's server. The reason we don't upload the image directly to the cloud service directly from our application is because **we risk exposing some sensitive data regards the service and some users may abuse it**. We will start by installing the right packages:\n\n    $ yarn add tmp@0.0.33 multer@1.4.1 cloudinary@1.13.2\n    $ yarn add -D @types/tmp@0.0.33 @types/multer1.3.7\n\nWe will also write custom TypeScript definitions for the `cloudinary` package since they don't exist:\n\n[{]: <helper> (diffStep 2.4 files=\"cloudinary.d.ts\" module=\"server\")\n\n#### Step 2.4: Add /upload-profile-pic REST endpoint\n\n##### Added cloudinary.d.ts\n```diff\n@@ -0,0 +1,10 @@\n+â”Š  â”Š 1â”Šdeclare module 'cloudinary' {\n+â”Š  â”Š 2â”Š  export function config(config: { cloud_name: string; api_key: string; api_secret: string }): void\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Š  export var v2: {\n+â”Š  â”Š 5â”Š    uploader: {\n+â”Š  â”Š 6â”Š      upload_stream: (callback?: (error: Error, result: any) => any) => NodeJS.WritableStream\n+â”Š  â”Š 7â”Š      upload: (path: string, callback?: (error: Error, result: any) => any) => any\n+â”Š  â”Š 8â”Š    }\n+â”Š  â”Š 9â”Š  }\n+â”Š  â”Š10â”Š}\n```\n\n[}]: #\n\nThen we will set the right API keys in the `.env` file:\n\n[{]: <helper> (diffStep 2.4 files=\".env\" module=\"server\")\n\n#### Step 2.4: Add /upload-profile-pic REST endpoint\n\n##### Added .env\n```diff\n@@ -0,0 +1,2 @@\n+â”Š â”Š1â”Š# NEVER DEFINE HERE ONLY ON CLOUD\n+â”Š â”Š2â”ŠCLOUDINARY_URL=cloudinary://756494366771661:OttZILiLRKaB5tKR8F3vQhMrNRg@whatsapp-clone\n```\n\n[}]: #\n\nThe purpose of the `.env` file is to load environment variables into our app in a more comfortable way. For that to apply we will need to install and require a package which is called [`dotenv`](https://www.npmjs.com/package/dotenv).\n\n    $ yarn add dotenv@6.2.0\n\n[{]: <helper> (diffStep 2.4 files=\"index\" module=\"server\")\n\n#### Step 2.4: Add /upload-profile-pic REST endpoint\n\n##### Changed index.ts\n```diff\n@@ -1,3 +1,5 @@\n+â”Š â”Š1â”Šrequire('dotenv').config()\n+â”Š â”Š2â”Š\n â”Š1â”Š3â”Šimport 'reflect-metadata'\n â”Š2â”Š4â”Šimport { ApolloServer } from 'apollo-server-express'\n â”Š3â”Š5â”Šimport bodyParser from 'body-parser'\n```\n\n##### Changed modules&#x2F;user&#x2F;index.ts\n```diff\n@@ -1,18 +1,43 @@\n+â”Š  â”Š 1â”Š/// <reference path=\"../../cloudinary.d.ts\" />\n â”Š 1â”Š 2â”Šimport { GraphQLModule } from '@graphql-modules/core'\n â”Š 2â”Š 3â”Šimport { InjectFunction, ProviderScope } from '@graphql-modules/di'\n â”Š 3â”Š 4â”Šimport { loadResolversFiles, loadSchemaFiles } from '@graphql-modules/sonar'\n+â”Š  â”Š 5â”Šimport { Express } from 'express'\n+â”Š  â”Š 6â”Šimport multer from 'multer'\n+â”Š  â”Š 7â”Šimport tmp from 'tmp'\n+â”Š  â”Š 8â”Šimport cloudinary from 'cloudinary'\n+â”Š  â”Š 9â”Šimport { APP } from '../app.symbols'\n â”Š 4â”Š10â”Šimport { AuthModule } from '../auth'\n â”Š 5â”Š11â”Šimport { UserProvider } from './providers/user.provider'\n â”Š 6â”Š12â”Š\n+â”Š  â”Š13â”Šconst CLOUDINARY_URL = process.env.CLOUDINARY_URL || ''\n+â”Š  â”Š14â”Š\n â”Š 7â”Š15â”Šexport const UserModule = new GraphQLModule({\n â”Š 8â”Š16â”Š  name: 'User',\n-â”Š 9â”Š  â”Š  imports: [\n-â”Š10â”Š  â”Š    AuthModule,\n-â”Š11â”Š  â”Š  ],\n-â”Š12â”Š  â”Š  providers: [\n-â”Š13â”Š  â”Š    UserProvider,\n-â”Š14â”Š  â”Š  ],\n+â”Š  â”Š17â”Š  imports: [AuthModule],\n+â”Š  â”Š18â”Š  providers: [UserProvider],\n â”Š15â”Š19â”Š  typeDefs: loadSchemaFiles(__dirname + '/schema/'),\n â”Š16â”Š20â”Š  resolvers: loadResolversFiles(__dirname + '/resolvers/'),\n â”Š17â”Š21â”Š  defaultProviderScope: ProviderScope.Session,\n+â”Š  â”Š22â”Š  middleware: InjectFunction(UserProvider, APP)((userProvider, app: Express) => {\n+â”Š  â”Š23â”Š    const match = CLOUDINARY_URL.match(/cloudinary:\\/\\/(\\d+):(\\w+)@(\\.+)/)\n+â”Š  â”Š24â”Š\n+â”Š  â”Š25â”Š    if (match) {\n+â”Š  â”Š26â”Š      const [api_key, api_secret, cloud_name] = match.slice(1)\n+â”Š  â”Š27â”Š      cloudinary.config({ api_key, api_secret, cloud_name })\n+â”Š  â”Š28â”Š    }\n+â”Š  â”Š29â”Š\n+â”Š  â”Š30â”Š    const upload = multer({\n+â”Š  â”Š31â”Š      dest: tmp.dirSync({ unsafeCleanup: true }).name,\n+â”Š  â”Š32â”Š    })\n+â”Š  â”Š33â”Š\n+â”Š  â”Š34â”Š    app.post('/upload-profile-pic', upload.single('file'), async (req: any, res, done) => {\n+â”Š  â”Š35â”Š      try {\n+â”Š  â”Š36â”Š        res.json(await userProvider.uploadProfilePic(req.file.path))\n+â”Š  â”Š37â”Š      } catch (e) {\n+â”Š  â”Š38â”Š        done(e)\n+â”Š  â”Š39â”Š      }\n+â”Š  â”Š40â”Š    })\n+â”Š  â”Š41â”Š    return {}\n+â”Š  â”Š42â”Š  }),\n â”Š18â”Š43â”Š})\n```\n\n[}]: #\n\n> See [Cloudinary's NodeJS API](https://cloudinary.com/documentation/node_integration).\n> See [API setup](https://cloudinary.com/documentation/solution_overview#account_and_api_setup).\n\nAnd finally, we will implement a REST endpoint in the `user` module under `/upload-profile-pic`:\n\n[{]: <helper> (diffStep 2.4 files=\"modules/user\" module=\"server\")\n\n#### Step 2.4: Add /upload-profile-pic REST endpoint\n\n##### Changed modules&#x2F;user&#x2F;index.ts\n```diff\n@@ -1,18 +1,43 @@\n+â”Š  â”Š 1â”Š/// <reference path=\"../../cloudinary.d.ts\" />\n â”Š 1â”Š 2â”Šimport { GraphQLModule } from '@graphql-modules/core'\n â”Š 2â”Š 3â”Šimport { InjectFunction, ProviderScope } from '@graphql-modules/di'\n â”Š 3â”Š 4â”Šimport { loadResolversFiles, loadSchemaFiles } from '@graphql-modules/sonar'\n+â”Š  â”Š 5â”Šimport { Express } from 'express'\n+â”Š  â”Š 6â”Šimport multer from 'multer'\n+â”Š  â”Š 7â”Šimport tmp from 'tmp'\n+â”Š  â”Š 8â”Šimport cloudinary from 'cloudinary'\n+â”Š  â”Š 9â”Šimport { APP } from '../app.symbols'\n â”Š 4â”Š10â”Šimport { AuthModule } from '../auth'\n â”Š 5â”Š11â”Šimport { UserProvider } from './providers/user.provider'\n â”Š 6â”Š12â”Š\n+â”Š  â”Š13â”Šconst CLOUDINARY_URL = process.env.CLOUDINARY_URL || ''\n+â”Š  â”Š14â”Š\n â”Š 7â”Š15â”Šexport const UserModule = new GraphQLModule({\n â”Š 8â”Š16â”Š  name: 'User',\n-â”Š 9â”Š  â”Š  imports: [\n-â”Š10â”Š  â”Š    AuthModule,\n-â”Š11â”Š  â”Š  ],\n-â”Š12â”Š  â”Š  providers: [\n-â”Š13â”Š  â”Š    UserProvider,\n-â”Š14â”Š  â”Š  ],\n+â”Š  â”Š17â”Š  imports: [AuthModule],\n+â”Š  â”Š18â”Š  providers: [UserProvider],\n â”Š15â”Š19â”Š  typeDefs: loadSchemaFiles(__dirname + '/schema/'),\n â”Š16â”Š20â”Š  resolvers: loadResolversFiles(__dirname + '/resolvers/'),\n â”Š17â”Š21â”Š  defaultProviderScope: ProviderScope.Session,\n+â”Š  â”Š22â”Š  middleware: InjectFunction(UserProvider, APP)((userProvider, app: Express) => {\n+â”Š  â”Š23â”Š    const match = CLOUDINARY_URL.match(/cloudinary:\\/\\/(\\d+):(\\w+)@(\\.+)/)\n+â”Š  â”Š24â”Š\n+â”Š  â”Š25â”Š    if (match) {\n+â”Š  â”Š26â”Š      const [api_key, api_secret, cloud_name] = match.slice(1)\n+â”Š  â”Š27â”Š      cloudinary.config({ api_key, api_secret, cloud_name })\n+â”Š  â”Š28â”Š    }\n+â”Š  â”Š29â”Š\n+â”Š  â”Š30â”Š    const upload = multer({\n+â”Š  â”Š31â”Š      dest: tmp.dirSync({ unsafeCleanup: true }).name,\n+â”Š  â”Š32â”Š    })\n+â”Š  â”Š33â”Š\n+â”Š  â”Š34â”Š    app.post('/upload-profile-pic', upload.single('file'), async (req: any, res, done) => {\n+â”Š  â”Š35â”Š      try {\n+â”Š  â”Š36â”Š        res.json(await userProvider.uploadProfilePic(req.file.path))\n+â”Š  â”Š37â”Š      } catch (e) {\n+â”Š  â”Š38â”Š        done(e)\n+â”Š  â”Š39â”Š      }\n+â”Š  â”Š40â”Š    })\n+â”Š  â”Š41â”Š    return {}\n+â”Š  â”Š42â”Š  }),\n â”Š18â”Š43â”Š})\n```\n\n##### Changed modules&#x2F;user&#x2F;providers&#x2F;user.provider.ts\n```diff\n@@ -1,4 +1,5 @@\n â”Š1â”Š1â”Šimport { Injectable, ProviderScope } from '@graphql-modules/di'\n+â”Š â”Š2â”Šimport cloudinary from 'cloudinary'\n â”Š2â”Š3â”Šimport { Connection } from 'typeorm'\n â”Š3â”Š4â”Šimport { User } from '../../../entity/user'\n â”Š4â”Š5â”Šimport { AuthProvider } from '../../auth/providers/auth.provider'\n```\n```diff\n@@ -42,4 +43,16 @@\n â”Š42â”Š43â”Š\n â”Š43â”Š44â”Š    return this.currentUser;\n â”Š44â”Š45â”Š  }\n+â”Š  â”Š46â”Š\n+â”Š  â”Š47â”Š  uploadProfilePic(filePath: string) {\n+â”Š  â”Š48â”Š    return new Promise((resolve, reject) => {\n+â”Š  â”Š49â”Š      cloudinary.v2.uploader.upload(filePath, (error, result) => {\n+â”Š  â”Š50â”Š        if (error) {\n+â”Š  â”Š51â”Š          reject(error)\n+â”Š  â”Š52â”Š        } else {\n+â”Š  â”Š53â”Š          resolve(result)\n+â”Š  â”Š54â”Š        }\n+â”Š  â”Š55â”Š      })\n+â”Š  â”Š56â”Š    })\n+â”Š  â”Š57â”Š  }\n â”Š45â”Š58â”Š}\n```\n\n[}]: #\n\nNow getting back to the client, we will implement a `picture.service` that will be responsible for uploading images in our application:\n\n[{]: <helper> (diffStep 2.6 files=\"src/services/picture\" module=\"client\")\n\n#### [Step 2.6: Implement image uploading](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/99fd034)\n\n##### Added src&#x2F;services&#x2F;picture.service.tsx\n```diff\n@@ -0,0 +1,31 @@\n+â”Š  â”Š 1â”Šimport { getAuthHeader } from './auth.service'\n+â”Š  â”Š 2â”Š\n+â”Š  â”Š 3â”Šexport const pickPicture = () => {\n+â”Š  â”Š 4â”Š  return new Promise((resolve, reject) => {\n+â”Š  â”Š 5â”Š    const input = document.createElement('input')\n+â”Š  â”Š 6â”Š    input.type = 'file'\n+â”Š  â”Š 7â”Š    input.accept = 'image/*'\n+â”Š  â”Š 8â”Š    input.onchange = e => {\n+â”Š  â”Š 9â”Š      const target = e.target as HTMLInputElement\n+â”Š  â”Š10â”Š      resolve(target.files[0])\n+â”Š  â”Š11â”Š    }\n+â”Š  â”Š12â”Š    input.onerror = reject\n+â”Š  â”Š13â”Š    input.click()\n+â”Š  â”Š14â”Š  })\n+â”Š  â”Š15â”Š}\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Šexport const uploadProfilePicture = file => {\n+â”Š  â”Š18â”Š  const formData = new FormData()\n+â”Š  â”Š19â”Š  formData.append('file', file)\n+â”Š  â”Š20â”Š  formData.append('upload_preset', 'profile-pic')\n+â”Š  â”Š21â”Š\n+â”Š  â”Š22â”Š  return fetch(`${process.env.REACT_APP_SERVER_URL}/upload-profile-pic`, {\n+â”Š  â”Š23â”Š    method: 'POST',\n+â”Š  â”Š24â”Š    body: formData,\n+â”Š  â”Š25â”Š    headers: {\n+â”Š  â”Š26â”Š      Authorization: getAuthHeader(),\n+â”Š  â”Š27â”Š    }\n+â”Š  â”Š28â”Š  }).then(res => {\n+â”Š  â”Š29â”Š    return res.json()\n+â”Š  â”Š30â”Š  })\n+â”Š  â”Š31â”Š}\n```\n\n[}]: #\n\nAnd we will use it in the settings screen:\n\n[{]: <helper> (diffStep 2.6 files=\"src/components\" module=\"client\")\n\n#### [Step 2.6: Implement image uploading](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/99fd034)\n\n##### Changed src&#x2F;components&#x2F;SettingsScreen&#x2F;SettingsForm.tsx\n```diff\n@@ -10,6 +10,7 @@\n â”Š10â”Š10â”Šimport * as fragments from '../../graphql/fragments'\n â”Š11â”Š11â”Šimport { SettingsFormMutation } from '../../graphql/types'\n â”Š12â”Š12â”Šimport { useMe } from '../../services/auth.service'\n+â”Š  â”Š13â”Šimport { pickPicture, uploadProfilePicture } from '../../services/picture.service'\n â”Š13â”Š14â”Šimport Navbar from '../Navbar'\n â”Š14â”Š15â”Šimport SettingsNavbar from './SettingsNavbar'\n â”Š15â”Š16â”Š\n```\n```diff\n@@ -104,7 +105,13 @@\n â”Š104â”Š105â”Š  }\n â”Š105â”Š106â”Š\n â”Š106â”Š107â”Š  const updatePicture = async () => {\n-â”Š107â”Š   â”Š    // TODO: Implement\n+â”Š   â”Š108â”Š    const file = await pickPicture()\n+â”Š   â”Š109â”Š\n+â”Š   â”Š110â”Š    if (!file) return\n+â”Š   â”Š111â”Š\n+â”Š   â”Š112â”Š    const { url } = await uploadProfilePicture(file)\n+â”Š   â”Š113â”Š\n+â”Š   â”Š114â”Š    setMyPicture(url)\n â”Š108â”Š115â”Š  }\n â”Š109â”Š116â”Š\n â”Š110â”Š117â”Š  return (\n```\n\n[}]: #\n\nThe settings component is complete! We will connect it to the main flow by implementing the pop-over menu at the top right corner of the main screen where we will be able to navigate to the settings screen and sign-out:\n\n[{]: <helper> (diffStep 2.7 module=\"client\")\n\n#### [Step 2.7: Make components navigatable](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/fcc5b70)\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -3,6 +3,7 @@\n â”Š3â”Š3â”Šimport AnimatedSwitch from './components/AnimatedSwitch'\n â”Š4â”Š4â”Šimport AuthScreen from './components/AuthScreen'\n â”Š5â”Š5â”Šimport ChatsListScreen from './components/ChatsListScreen'\n+â”Š â”Š6â”Šimport SettingsScreen from './components/SettingsScreen'\n â”Š6â”Š7â”Šimport { withAuth } from './services/auth.service'\n â”Š7â”Š8â”Š\n â”Š8â”Š9â”Šconst RedirectToChats = () => (\n```\n```diff\n@@ -14,6 +15,7 @@\n â”Š14â”Š15â”Š    <AnimatedSwitch>\n â”Š15â”Š16â”Š      <Route exact path=\"/sign-(in|up)\" component={AuthScreen} />\n â”Š16â”Š17â”Š      <Route exact path=\"/chats\" component={withAuth(ChatsListScreen)} />\n+â”Š  â”Š18â”Š      <Route exact path=\"/settings\" component={withAuth(SettingsScreen)} />\n â”Š17â”Š19â”Š      <Route component={RedirectToChats} />\n â”Š18â”Š20â”Š    </AnimatedSwitch>\n â”Š19â”Š21â”Š  </BrowserRouter>\n```\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsNavbar.tsx\n```diff\n@@ -1,14 +1,95 @@\n+â”Š  â”Š 1â”Šimport Button from '@material-ui/core/Button'\n+â”Š  â”Š 2â”Šimport List from '@material-ui/core/List'\n+â”Š  â”Š 3â”Šimport ListItem from '@material-ui/core/ListItem'\n+â”Š  â”Š 4â”Šimport Popover from '@material-ui/core/Popover'\n+â”Š  â”Š 5â”Šimport MoreIcon from '@material-ui/icons/MoreVert'\n+â”Š  â”Š 6â”Šimport SignOutIcon from '@material-ui/icons/PowerSettingsNew'\n+â”Š  â”Š 7â”Šimport SettingsIcon from '@material-ui/icons/Settings'\n+â”Š  â”Š 8â”Šimport { History } from 'history'\n â”Š 1â”Š 9â”Šimport * as React from 'react'\n+â”Š  â”Š10â”Šimport { useState } from 'react'\n â”Š 2â”Š11â”Šimport styled from 'styled-components'\n+â”Š  â”Š12â”Šimport { signOut } from '../../services/auth.service'\n â”Š 3â”Š13â”Š\n â”Š 4â”Š14â”Šconst Style = styled.div`\n+â”Š  â”Š15â”Š  padding: 0;\n+â”Š  â”Š16â”Š  display: flex;\n+â”Š  â”Š17â”Š  flex-direction: row;\n+â”Š  â”Š18â”Š\n â”Š 5â”Š19â”Š  .ChatsNavbar-title {\n-â”Š 6â”Š  â”Š    float: left;\n+â”Š  â”Š20â”Š    line-height: 56px;\n+â”Š  â”Š21â”Š  }\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Š  .ChatsNavbar-options-btn {\n+â”Š  â”Š24â”Š    float: right;\n+â”Š  â”Š25â”Š    height: 100%;\n+â”Š  â”Š26â”Š    font-size: 1.2em;\n+â”Š  â”Š27â”Š    margin-right: -15px;\n+â”Š  â”Š28â”Š    color: var(--primary-text);\n+â”Š  â”Š29â”Š  }\n+â”Š  â”Š30â”Š\n+â”Š  â”Š31â”Š  .ChatsNavbar-rest {\n+â”Š  â”Š32â”Š    flex: 1;\n+â”Š  â”Š33â”Š    justify-content: flex-end;\n+â”Š  â”Š34â”Š  }\n+â”Š  â”Š35â”Š\n+â”Š  â”Š36â”Š  .ChatsNavbar-options-item svg {\n+â”Š  â”Š37â”Š    margin-right: 10px;\n â”Š 7â”Š38â”Š  }\n â”Š 8â”Š39â”Š`\n â”Š 9â”Š40â”Š\n-â”Š10â”Š  â”Šexport default () => (\n-â”Š11â”Š  â”Š  <Style className=\"ChatsNavbar\">\n-â”Š12â”Š  â”Š    <span className=\"ChatsNavbar-title\">WhatsApp Clone</span>\n-â”Š13â”Š  â”Š  </Style>\n-â”Š14â”Š  â”Š)\n+â”Š  â”Š41â”Šinterface ChatsNavbarProps {\n+â”Š  â”Š42â”Š  history: History\n+â”Š  â”Š43â”Š}\n+â”Š  â”Š44â”Š\n+â”Š  â”Š45â”Šexport default ({ history }: ChatsNavbarProps) => {\n+â”Š  â”Š46â”Š  const [popped, setPopped] = useState(false)\n+â”Š  â”Š47â”Š\n+â”Š  â”Š48â”Š  const navToSettings = () => {\n+â”Š  â”Š49â”Š    setPopped(false)\n+â”Š  â”Š50â”Š    history.push('/settings')\n+â”Š  â”Š51â”Š  }\n+â”Š  â”Š52â”Š\n+â”Š  â”Š53â”Š  const handleSignOut = () => {\n+â”Š  â”Š54â”Š    setPopped(false)\n+â”Š  â”Š55â”Š    signOut()\n+â”Š  â”Š56â”Š\n+â”Š  â”Š57â”Š    history.push('/sign-in')\n+â”Š  â”Š58â”Š  }\n+â”Š  â”Š59â”Š\n+â”Š  â”Š60â”Š  return (\n+â”Š  â”Š61â”Š    <Style className=\"ChatsNavbar\">\n+â”Š  â”Š62â”Š      <span className=\"ChatsNavbar-title\">WhatsApp Clone</span>\n+â”Š  â”Š63â”Š      <div className=\"ChatsNavbar-rest\">\n+â”Š  â”Š64â”Š        <Button className=\"ChatsNavbar-options-btn\" onClick={setPopped.bind(null, true)}>\n+â”Š  â”Š65â”Š          <MoreIcon />\n+â”Š  â”Š66â”Š        </Button>\n+â”Š  â”Š67â”Š      </div>\n+â”Š  â”Š68â”Š      <Popover\n+â”Š  â”Š69â”Š        open={popped}\n+â”Š  â”Š70â”Š        onClose={setPopped.bind(null, false)}\n+â”Š  â”Š71â”Š        anchorOrigin={{\n+â”Š  â”Š72â”Š          vertical: 'top',\n+â”Š  â”Š73â”Š          horizontal: 'right',\n+â”Š  â”Š74â”Š        }}\n+â”Š  â”Š75â”Š        transformOrigin={{\n+â”Š  â”Š76â”Š          vertical: 'top',\n+â”Š  â”Š77â”Š          horizontal: 'right',\n+â”Š  â”Š78â”Š        }}\n+â”Š  â”Š79â”Š      >\n+â”Š  â”Š80â”Š        <Style>\n+â”Š  â”Š81â”Š          <List>\n+â”Š  â”Š82â”Š            <ListItem className=\"ChatsNavbar-options-item\" button onClick={navToSettings}>\n+â”Š  â”Š83â”Š              <SettingsIcon />\n+â”Š  â”Š84â”Š              Settings\n+â”Š  â”Š85â”Š            </ListItem>\n+â”Š  â”Š86â”Š            <ListItem className=\"ChatsNavbar-options-item\" button onClick={handleSignOut}>\n+â”Š  â”Š87â”Š              <SignOutIcon />\n+â”Š  â”Š88â”Š              Sign Out\n+â”Š  â”Š89â”Š            </ListItem>\n+â”Š  â”Š90â”Š          </List>\n+â”Š  â”Š91â”Š        </Style>\n+â”Š  â”Š92â”Š      </Popover>\n+â”Š  â”Š93â”Š    </Style>\n+â”Š  â”Š94â”Š  )\n+â”Š  â”Š95â”Š}\n```\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;index.tsx\n```diff\n@@ -1,13 +1,14 @@\n â”Š 1â”Š 1â”Šimport * as React from 'react'\n â”Š 2â”Š 2â”Šimport { Suspense } from 'react'\n+â”Š  â”Š 3â”Šimport { RouteComponentProps } from 'react-router-dom'\n â”Š 3â”Š 4â”Šimport Navbar from '../Navbar'\n â”Š 4â”Š 5â”Šimport ChatsList from './ChatsList'\n â”Š 5â”Š 6â”Šimport ChatsNavbar from './ChatsNavbar'\n â”Š 6â”Š 7â”Š\n-â”Š 7â”Š  â”Šexport default () => (\n+â”Š  â”Š 8â”Šexport default ({ history }: RouteComponentProps) => (\n â”Š 8â”Š 9â”Š  <div className=\"ChatsListScreen Screen\">\n â”Š 9â”Š10â”Š    <Navbar>\n-â”Š10â”Š  â”Š      <ChatsNavbar />\n+â”Š  â”Š11â”Š      <ChatsNavbar history={history} />\n â”Š11â”Š12â”Š    </Navbar>\n â”Š12â”Š13â”Š    <Suspense fallback={null}>\n â”Š13â”Š14â”Š      <ChatsList />\n```\n\n[}]: #"
          },
          {
            "manualTitle": "Step 3: Creating a chat app",
            "stepRevision": "947b94d4ef434e3e47b9685095bd88dc763f74e8",
            "manualView": "![chats](https://user-images.githubusercontent.com/7648874/52663040-aa1dc180-2f40-11e9-9ae4-bda648916bc4.png)\n\nIn this step we will be implementing a basic chat app. We will be able to:\n\n- Create chats.\n- Remove chats.\n- Send messages.\n\nThe flow is gonna go like this:\n\n- A chat can be created by picking a user from the users list.\n- When clicking on a chat, we will be promoted to a chat room.\n- The chat room will have a pop-over menu where we will be able to remove the chat.\n\nWe will start by adding a new entity called `Recipient`. The `Recipient` entity is the bridge between the `User` and the `Message` and it will tell us when the message was received and when it was read. Note that a message holds multiple recipients - this way we can extend its functionality to support group messaging where each message can have more than 2 recipients. Accordingly, we will have to make few adjustments to the existing entities:\n\n[{]: <helper> (diffStep 3.1 module=\"server\")\n\n#### Step 3.1: Edit entities to serve chat app\n\n##### Changed codegen.yml\n```diff\n@@ -12,6 +12,7 @@\n â”Š12â”Š12â”Š      mappers:\n â”Š13â”Š13â”Š        Chat: ./entity/chat#Chat\n â”Š14â”Š14â”Š        Message: ./entity/message#Message\n+â”Š  â”Š15â”Š        Recipient: ./entity/recipient#Recipient\n â”Š15â”Š16â”Š        User: ./entity/user#User\n â”Š16â”Š17â”Š      scalars:\n â”Š17â”Š18â”Š        Date: Date\n```\n\n##### Changed entity&#x2F;message.ts\n```diff\n@@ -9,6 +9,7 @@\n â”Š 9â”Š 9â”Š  CreateDateColumn,\n â”Š10â”Š10â”Š} from 'typeorm'\n â”Š11â”Š11â”Šimport Chat from './chat'\n+â”Š  â”Š12â”Šimport Recipient from './recipient'\n â”Š12â”Š13â”Šimport User from './user'\n â”Š13â”Š14â”Šimport { MessageType } from '../db'\n â”Š14â”Š15â”Š\n```\n```diff\n@@ -17,6 +18,7 @@\n â”Š17â”Š18â”Š  content?: string\n â”Š18â”Š19â”Š  createdAt?: Date\n â”Š19â”Š20â”Š  type?: MessageType\n+â”Š  â”Š21â”Š  recipients?: Recipient[]\n â”Š20â”Š22â”Š  holders?: User[]\n â”Š21â”Š23â”Š  chat?: Chat\n â”Š22â”Š24â”Š}\n```\n```diff\n@@ -38,6 +40,9 @@\n â”Š38â”Š40â”Š  @Column()\n â”Š39â”Š41â”Š  type: number\n â”Š40â”Š42â”Š\n+â”Š  â”Š43â”Š  @OneToMany(type => Recipient, recipient => recipient.message, { cascade: ['insert', 'update'], eager: true })\n+â”Š  â”Š44â”Š  recipients: Recipient[]\n+â”Š  â”Š45â”Š\n â”Š41â”Š46â”Š  @ManyToMany(type => User, user => user.holderMessages, {\n â”Š42â”Š47â”Š    cascade: ['insert', 'update'],\n â”Š43â”Š48â”Š    eager: true,\n```\n```diff\n@@ -53,6 +58,7 @@\n â”Š53â”Š58â”Š    content,\n â”Š54â”Š59â”Š    createdAt,\n â”Š55â”Š60â”Š    type,\n+â”Š  â”Š61â”Š    recipients,\n â”Š56â”Š62â”Š    holders,\n â”Š57â”Š63â”Š    chat,\n â”Š58â”Š64â”Š  }: MessageConstructor = {}) {\n```\n```diff\n@@ -68,6 +74,10 @@\n â”Š68â”Š74â”Š    if (type) {\n â”Š69â”Š75â”Š      this.type = type\n â”Š70â”Š76â”Š    }\n+â”Š  â”Š77â”Š    if (recipients) {\n+â”Š  â”Š78â”Š      recipients.forEach(recipient => recipient.message = this)\n+â”Š  â”Š79â”Š      this.recipients = recipients\n+â”Š  â”Š80â”Š    }\n â”Š71â”Š81â”Š    if (holders) {\n â”Š72â”Š82â”Š      this.holders = holders\n â”Š73â”Š83â”Š    }\n```\n\n##### Added entity&#x2F;recipient.ts\n```diff\n@@ -0,0 +1,42 @@\n+â”Š  â”Š 1â”Šimport { Entity, ManyToOne, Column } from 'typeorm'\n+â”Š  â”Š 2â”Šimport { Message } from './message'\n+â”Š  â”Š 3â”Šimport { User } from './user'\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šinterface RecipientConstructor {\n+â”Š  â”Š 6â”Š  user?: User\n+â”Š  â”Š 7â”Š  message?: Message\n+â”Š  â”Š 8â”Š  receivedAt?: Date\n+â”Š  â”Š 9â”Š  readAt?: Date\n+â”Š  â”Š10â”Š}\n+â”Š  â”Š11â”Š\n+â”Š  â”Š12â”Š@Entity()\n+â”Š  â”Š13â”Šexport class Recipient {\n+â”Š  â”Š14â”Š  @ManyToOne(type => User, user => user.recipients, { primary: true })\n+â”Š  â”Š15â”Š  user: User\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š  @ManyToOne(type => Message, message => message.recipients, { primary: true })\n+â”Š  â”Š18â”Š  message: Message\n+â”Š  â”Š19â”Š\n+â”Š  â”Š20â”Š  @Column({ nullable: true })\n+â”Š  â”Š21â”Š  receivedAt: Date\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Š  @Column({ nullable: true })\n+â”Š  â”Š24â”Š  readAt: Date\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Š  constructor({ user, message, receivedAt, readAt }: RecipientConstructor = {}) {\n+â”Š  â”Š27â”Š    if (user) {\n+â”Š  â”Š28â”Š      this.user = user\n+â”Š  â”Š29â”Š    }\n+â”Š  â”Š30â”Š    if (message) {\n+â”Š  â”Š31â”Š      this.message = message\n+â”Š  â”Š32â”Š    }\n+â”Š  â”Š33â”Š    if (receivedAt) {\n+â”Š  â”Š34â”Š      this.receivedAt = receivedAt\n+â”Š  â”Š35â”Š    }\n+â”Š  â”Š36â”Š    if (readAt) {\n+â”Š  â”Š37â”Š      this.readAt = readAt\n+â”Š  â”Š38â”Š    }\n+â”Š  â”Š39â”Š  }\n+â”Š  â”Š40â”Š}\n+â”Š  â”Š41â”Š\n+â”Š  â”Š42â”Šexport default Recipient\n```\n\n##### Changed entity&#x2F;user.ts\n```diff\n@@ -1,6 +1,7 @@\n â”Š1â”Š1â”Šimport { Entity, Column, PrimaryGeneratedColumn, ManyToMany, OneToMany } from 'typeorm'\n â”Š2â”Š2â”Šimport Chat from './chat'\n â”Š3â”Š3â”Šimport Message from './message'\n+â”Š â”Š4â”Šimport Recipient from './recipient'\n â”Š4â”Š5â”Š\n â”Š5â”Š6â”Šinterface UserConstructor {\n â”Š6â”Š7â”Š  username?: string\n```\n```diff\n@@ -41,6 +42,9 @@\n â”Š41â”Š42â”Š  @OneToMany(type => Message, message => message.sender)\n â”Š42â”Š43â”Š  senderMessages: Message[]\n â”Š43â”Š44â”Š\n+â”Š  â”Š45â”Š  @OneToMany(type => Recipient, recipient => recipient.user)\n+â”Š  â”Š46â”Š  recipients: Recipient[]\n+â”Š  â”Š47â”Š\n â”Š44â”Š48â”Š  constructor({ username, password, name, picture }: UserConstructor = {}) {\n â”Š45â”Š49â”Š    if (username) {\n â”Š46â”Š50â”Š      this.username = username\n```\n\n##### Changed modules&#x2F;app.module.ts\n```diff\n@@ -4,6 +4,7 @@\n â”Š 4â”Š 4â”Šimport { AuthModule } from './auth'\n â”Š 5â”Š 5â”Šimport { UserModule } from './user'\n â”Š 6â”Š 6â”Šimport { ChatModule } from './chat'\n+â”Š  â”Š 7â”Šimport { RecipientModule } from './recipient'\n â”Š 7â”Š 8â”Šimport { MessageModule } from './message'\n â”Š 8â”Š 9â”Š\n â”Š 9â”Š10â”Šexport interface IAppModuleConfig {\n```\n```diff\n@@ -21,6 +22,7 @@\n â”Š21â”Š22â”Š    UserModule,\n â”Š22â”Š23â”Š    ChatModule,\n â”Š23â”Š24â”Š    MessageModule,\n+â”Š  â”Š25â”Š    RecipientModule,\n â”Š24â”Š26â”Š  ],\n â”Š25â”Š27â”Š  configRequired: true,\n â”Š26â”Š28â”Š})\n```\n\n##### Added modules&#x2F;recipient&#x2F;index.ts\n```diff\n@@ -0,0 +1,22 @@\n+â”Š  â”Š 1â”Šimport { GraphQLModule } from '@graphql-modules/core';\n+â”Š  â”Š 2â”Šimport { loadResolversFiles, loadSchemaFiles } from '@graphql-modules/sonar';\n+â”Š  â”Š 3â”Šimport { UserModule } from '../user';\n+â”Š  â”Š 4â”Šimport { MessageModule } from '../message';\n+â”Š  â”Š 5â”Šimport { ChatModule } from '../chat';\n+â”Š  â”Š 6â”Šimport { RecipientProvider } from './providers/recipient.provider';\n+â”Š  â”Š 7â”Šimport { AuthModule } from '../auth';\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Šexport const RecipientModule = new GraphQLModule({\n+â”Š  â”Š10â”Š  name: 'Recipient',\n+â”Š  â”Š11â”Š  imports: [\n+â”Š  â”Š12â”Š    AuthModule,\n+â”Š  â”Š13â”Š    UserModule,\n+â”Š  â”Š14â”Š    ChatModule,\n+â”Š  â”Š15â”Š    MessageModule,\n+â”Š  â”Š16â”Š  ],\n+â”Š  â”Š17â”Š  providers: [\n+â”Š  â”Š18â”Š    RecipientProvider,\n+â”Š  â”Š19â”Š  ],\n+â”Š  â”Š20â”Š  typeDefs: loadSchemaFiles(__dirname + '/schema/'),\n+â”Š  â”Š21â”Š  resolvers: loadResolversFiles(__dirname + '/resolvers/'),\n+â”Š  â”Š22â”Š});\n```\n\n##### Added modules&#x2F;recipient&#x2F;providers&#x2F;recipient.provider.ts\n```diff\n@@ -0,0 +1,123 @@\n+â”Š   â”Š  1â”Šimport { Injectable, ProviderScope } from '@graphql-modules/di'\n+â”Š   â”Š  2â”Šimport { Connection } from 'typeorm'\n+â”Š   â”Š  3â”Šimport { MessageProvider } from '../../message/providers/message.provider'\n+â”Š   â”Š  4â”Šimport { Chat } from '../../../entity/chat'\n+â”Š   â”Š  5â”Šimport { Message } from '../../../entity/message'\n+â”Š   â”Š  6â”Šimport { Recipient } from '../../../entity/recipient'\n+â”Š   â”Š  7â”Šimport { AuthProvider } from '../../auth/providers/auth.provider'\n+â”Š   â”Š  8â”Š\n+â”Š   â”Š  9â”Š@Injectable({\n+â”Š   â”Š 10â”Š  scope: ProviderScope.Session,\n+â”Š   â”Š 11â”Š})\n+â”Š   â”Š 12â”Šexport class RecipientProvider {\n+â”Š   â”Š 13â”Š  constructor(\n+â”Š   â”Š 14â”Š    private authProvider: AuthProvider,\n+â”Š   â”Š 15â”Š    private connection: Connection,\n+â”Š   â”Š 16â”Š    private messageProvider: MessageProvider\n+â”Š   â”Š 17â”Š  ) {}\n+â”Š   â”Š 18â”Š\n+â”Š   â”Š 19â”Š  public repository = this.connection.getRepository(Recipient)\n+â”Š   â”Š 20â”Š  public currentUser = this.authProvider.currentUser\n+â”Š   â”Š 21â”Š\n+â”Š   â”Š 22â”Š  createQueryBuilder() {\n+â”Š   â”Š 23â”Š    return this.connection.createQueryBuilder(Recipient, 'recipient')\n+â”Š   â”Š 24â”Š  }\n+â”Š   â”Š 25â”Š\n+â”Š   â”Š 26â”Š  getChatUnreadMessagesCount(chat: Chat) {\n+â”Š   â”Š 27â”Š    return this.messageProvider\n+â”Š   â”Š 28â”Š      .createQueryBuilder()\n+â”Š   â”Š 29â”Š      .innerJoin('message.chat', 'chat', 'chat.id = :chatId', { chatId: chat.id })\n+â”Š   â”Š 30â”Š      .innerJoin(\n+â”Š   â”Š 31â”Š        'message.recipients',\n+â”Š   â”Š 32â”Š        'recipients',\n+â”Š   â”Š 33â”Š        'recipients.user.id = :userId AND recipients.readAt IS NULL',\n+â”Š   â”Š 34â”Š        {\n+â”Š   â”Š 35â”Š          userId: this.currentUser.id,\n+â”Š   â”Š 36â”Š        }\n+â”Š   â”Š 37â”Š      )\n+â”Š   â”Š 38â”Š      .getCount()\n+â”Š   â”Š 39â”Š  }\n+â”Š   â”Š 40â”Š\n+â”Š   â”Š 41â”Š  getMessageRecipients(message: Message) {\n+â”Š   â”Š 42â”Š    return this.createQueryBuilder()\n+â”Š   â”Š 43â”Š      .innerJoinAndSelect('recipient.message', 'message', 'message.id = :messageId', {\n+â”Š   â”Š 44â”Š        messageId: message.id,\n+â”Š   â”Š 45â”Š      })\n+â”Š   â”Š 46â”Š      .innerJoinAndSelect('recipient.user', 'user')\n+â”Š   â”Š 47â”Š      .getMany()\n+â”Š   â”Š 48â”Š  }\n+â”Š   â”Š 49â”Š\n+â”Š   â”Š 50â”Š  async getRecipientChat(recipient: Recipient) {\n+â”Š   â”Š 51â”Š    if (recipient.message.chat) {\n+â”Š   â”Š 52â”Š      return recipient.message.chat\n+â”Š   â”Š 53â”Š    }\n+â”Š   â”Š 54â”Š\n+â”Š   â”Š 55â”Š    return this.messageProvider.getMessageChat(recipient.message)\n+â”Š   â”Š 56â”Š  }\n+â”Š   â”Š 57â”Š\n+â”Š   â”Š 58â”Š  async removeChat(chatId: string) {\n+â”Š   â”Š 59â”Š    const messages = await this.messageProvider._removeChatGetMessages(chatId)\n+â”Š   â”Š 60â”Š\n+â”Š   â”Š 61â”Š    for (let message of messages) {\n+â”Š   â”Š 62â”Š      if (message.holders.length === 0) {\n+â”Š   â”Š 63â”Š        const recipients = await this.createQueryBuilder()\n+â”Š   â”Š 64â”Š          .innerJoinAndSelect('recipient.message', 'message', 'message.id = :messageId', {\n+â”Š   â”Š 65â”Š            messageId: message.id,\n+â”Š   â”Š 66â”Š          })\n+â”Š   â”Š 67â”Š          .innerJoinAndSelect('recipient.user', 'user')\n+â”Š   â”Š 68â”Š          .getMany()\n+â”Š   â”Š 69â”Š\n+â”Š   â”Š 70â”Š        for (let recipient of recipients) {\n+â”Š   â”Š 71â”Š          await this.repository.remove(recipient)\n+â”Š   â”Š 72â”Š        }\n+â”Š   â”Š 73â”Š      }\n+â”Š   â”Š 74â”Š    }\n+â”Š   â”Š 75â”Š\n+â”Š   â”Š 76â”Š    return await this.messageProvider.removeChat(chatId, messages)\n+â”Š   â”Š 77â”Š  }\n+â”Š   â”Š 78â”Š\n+â”Š   â”Š 79â”Š  async addMessage(chatId: string, content: string) {\n+â”Š   â”Š 80â”Š    const message = await this.messageProvider.addMessage(chatId, content)\n+â”Š   â”Š 81â”Š\n+â”Š   â”Š 82â”Š    for (let user of message.holders) {\n+â”Š   â”Š 83â”Š      if (user.id !== this.currentUser.id) {\n+â”Š   â”Š 84â”Š        await this.repository.save(new Recipient({ user, message }))\n+â”Š   â”Š 85â”Š      }\n+â”Š   â”Š 86â”Š    }\n+â”Š   â”Š 87â”Š\n+â”Š   â”Š 88â”Š    return message\n+â”Š   â”Š 89â”Š  }\n+â”Š   â”Š 90â”Š\n+â”Š   â”Š 91â”Š  async removeMessages(\n+â”Š   â”Š 92â”Š    chatId: string,\n+â”Š   â”Š 93â”Š    {\n+â”Š   â”Š 94â”Š      messageIds,\n+â”Š   â”Š 95â”Š      all,\n+â”Š   â”Š 96â”Š    }: {\n+â”Š   â”Š 97â”Š      messageIds?: string[]\n+â”Š   â”Š 98â”Š      all?: boolean\n+â”Š   â”Š 99â”Š    } = {}\n+â”Š   â”Š100â”Š  ) {\n+â”Š   â”Š101â”Š    const { deletedIds, removedMessages } = await this.messageProvider._removeMessages(chatId, {\n+â”Š   â”Š102â”Š      messageIds,\n+â”Š   â”Š103â”Š      all,\n+â”Š   â”Š104â”Š    })\n+â”Š   â”Š105â”Š\n+â”Š   â”Š106â”Š    for (let message of removedMessages) {\n+â”Š   â”Š107â”Š      const recipients = await this.createQueryBuilder()\n+â”Š   â”Š108â”Š        .innerJoinAndSelect('recipient.message', 'message', 'message.id = :messageId', {\n+â”Š   â”Š109â”Š          messageId: message.id,\n+â”Š   â”Š110â”Š        })\n+â”Š   â”Š111â”Š        .innerJoinAndSelect('recipient.user', 'user')\n+â”Š   â”Š112â”Š        .getMany()\n+â”Š   â”Š113â”Š\n+â”Š   â”Š114â”Š      for (let recipient of recipients) {\n+â”Š   â”Š115â”Š        await this.repository.remove(recipient)\n+â”Š   â”Š116â”Š      }\n+â”Š   â”Š117â”Š\n+â”Š   â”Š118â”Š      await this.messageProvider.repository.remove(message)\n+â”Š   â”Š119â”Š    }\n+â”Š   â”Š120â”Š\n+â”Š   â”Š121â”Š    return deletedIds\n+â”Š   â”Š122â”Š  }\n+â”Š   â”Š123â”Š}\n```\n\n##### Added modules&#x2F;recipient&#x2F;resolvers&#x2F;resolvers.ts\n```diff\n@@ -0,0 +1,35 @@\n+â”Š  â”Š 1â”Šimport { IResolvers } from '../../../types'\n+â”Š  â”Š 2â”Šimport { RecipientProvider } from '../providers/recipient.provider'\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šexport default {\n+â”Š  â”Š 5â”Š  Mutation: {\n+â”Š  â”Š 6â”Š    // TODO: implement me\n+â”Š  â”Š 7â”Š    markAsReceived: async (obj, { chatId }) => false,\n+â”Š  â”Š 8â”Š    // TODO: implement me\n+â”Š  â”Š 9â”Š    markAsRead: async (obj, { chatId }) => false,\n+â”Š  â”Š10â”Š    // We may also need to remove the recipients\n+â”Š  â”Š11â”Š    removeChat: async (obj, { chatId }, { injector }) =>\n+â”Š  â”Š12â”Š      injector.get(RecipientProvider).removeChat(chatId),\n+â”Š  â”Š13â”Š    // We also need to create the recipients\n+â”Š  â”Š14â”Š    addMessage: async (obj, { chatId, content }, { injector }) =>\n+â”Š  â”Š15â”Š      injector.get(RecipientProvider).addMessage(chatId, content),\n+â”Š  â”Š16â”Š    // We may also need to remove the recipients\n+â”Š  â”Š17â”Š    removeMessages: async (obj, { chatId, messageIds, all }, { injector }) =>\n+â”Š  â”Š18â”Š      injector.get(RecipientProvider).removeMessages(chatId, {\n+â”Š  â”Š19â”Š        messageIds: messageIds || undefined,\n+â”Š  â”Š20â”Š        all: all || false,\n+â”Š  â”Š21â”Š      }),\n+â”Š  â”Š22â”Š  },\n+â”Š  â”Š23â”Š  Chat: {\n+â”Š  â”Š24â”Š    unreadMessages: async (chat, args, { injector }) =>\n+â”Š  â”Š25â”Š      injector.get(RecipientProvider).getChatUnreadMessagesCount(chat),\n+â”Š  â”Š26â”Š  },\n+â”Š  â”Š27â”Š  Message: {\n+â”Š  â”Š28â”Š    recipients: async (message, args, { injector }) =>\n+â”Š  â”Š29â”Š      injector.get(RecipientProvider).getMessageRecipients(message),\n+â”Š  â”Š30â”Š  },\n+â”Š  â”Š31â”Š  Recipient: {\n+â”Š  â”Š32â”Š    chat: async (recipient, args, { injector }) =>\n+â”Š  â”Š33â”Š      injector.get(RecipientProvider).getRecipientChat(recipient),\n+â”Š  â”Š34â”Š  },\n+â”Š  â”Š35â”Š} as IResolvers\n```\n\n##### Added modules&#x2F;recipient&#x2F;schema&#x2F;typeDefs.graphql\n```diff\n@@ -0,0 +1,22 @@\n+â”Š  â”Š 1â”Šextend type Chat {\n+â”Š  â”Š 2â”Š  #Computed property\n+â”Š  â”Š 3â”Š  unreadMessages: Int!\n+â”Š  â”Š 4â”Š}\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šextend type Message {\n+â”Š  â”Š 7â”Š  #Whoever received the message\n+â”Š  â”Š 8â”Š  recipients: [Recipient!]!\n+â”Š  â”Š 9â”Š}\n+â”Š  â”Š10â”Š\n+â”Š  â”Š11â”Štype Recipient {\n+â”Š  â”Š12â”Š  user: User!\n+â”Š  â”Š13â”Š  message: Message!\n+â”Š  â”Š14â”Š  chat: Chat!\n+â”Š  â”Š15â”Š  receivedAt: Date\n+â”Š  â”Š16â”Š  readAt: Date\n+â”Š  â”Š17â”Š}\n+â”Š  â”Š18â”Š\n+â”Š  â”Š19â”Štype Mutation {\n+â”Š  â”Š20â”Š  markAsReceived(chatId: ID!): Boolean\n+â”Š  â”Š21â”Š  markAsRead(chatId: ID!): Boolean\n+â”Š  â”Š22â”Š}\n```\n\n[}]: #\n\nThe flow will require us to implement the following GraphQL operations:\n\n- `users` query - Will be used to create a chat by picking a user from the users list.\n- `addMessage` mutation\n- `addChat` mutation\n- `removeChat` mutation\n\nAccordingly we will define the operations in our schema and implement their resolvers:\n\n[{]: <helper> (diffStep 3.2 module=\"server\")\n\n#### Step 3.2: Implement mutations for chat app\n\n##### Changed modules&#x2F;chat&#x2F;providers&#x2F;chat.provider.ts\n```diff\n@@ -38,6 +38,63 @@\n â”Š 38â”Š 38â”Š    return chat || null\n â”Š 39â”Š 39â”Š  }\n â”Š 40â”Š 40â”Š\n+â”Š   â”Š 41â”Š  async addChat(userId: string) {\n+â”Š   â”Š 42â”Š    const user = await this.userProvider\n+â”Š   â”Š 43â”Š      .createQueryBuilder()\n+â”Š   â”Š 44â”Š      .whereInIds(userId)\n+â”Š   â”Š 45â”Š      .getOne();\n+â”Š   â”Š 46â”Š\n+â”Š   â”Š 47â”Š    if (!user) {\n+â”Š   â”Š 48â”Š      throw new Error(`User ${userId} doesn't exist.`);\n+â”Š   â”Š 49â”Š    }\n+â”Š   â”Š 50â”Š\n+â”Š   â”Š 51â”Š    let chat = await this\n+â”Š   â”Š 52â”Š      .createQueryBuilder()\n+â”Š   â”Š 53â”Š      .where('chat.name IS NULL')\n+â”Š   â”Š 54â”Š      .innerJoin('chat.allTimeMembers', 'allTimeMembers1', 'allTimeMembers1.id = :currentUserId', {\n+â”Š   â”Š 55â”Š        currentUserId: this.currentUser.id,\n+â”Š   â”Š 56â”Š      })\n+â”Š   â”Š 57â”Š      .innerJoin('chat.allTimeMembers', 'allTimeMembers2', 'allTimeMembers2.id = :userId', {\n+â”Š   â”Š 58â”Š        userId: userId,\n+â”Š   â”Š 59â”Š      })\n+â”Š   â”Š 60â”Š      .innerJoinAndSelect('chat.listingMembers', 'listingMembers')\n+â”Š   â”Š 61â”Š      .getOne();\n+â”Š   â”Š 62â”Š\n+â”Š   â”Š 63â”Š    if (chat) {\n+â”Š   â”Š 64â”Š      // Chat already exists. Both users are already in the userIds array\n+â”Š   â”Š 65â”Š      const listingMembers = await this.userProvider\n+â”Š   â”Š 66â”Š        .createQueryBuilder()\n+â”Š   â”Š 67â”Š        .innerJoin(\n+â”Š   â”Š 68â”Š          'user.listingMemberChats',\n+â”Š   â”Š 69â”Š          'listingMemberChats',\n+â”Š   â”Š 70â”Š          'listingMemberChats.id = :chatId',\n+â”Š   â”Š 71â”Š          { chatId: chat.id },\n+â”Š   â”Š 72â”Š        )\n+â”Š   â”Š 73â”Š        .getMany();\n+â”Š   â”Š 74â”Š\n+â”Š   â”Š 75â”Š      if (!listingMembers.find(user => user.id === this.currentUser.id)) {\n+â”Š   â”Š 76â”Š        // The chat isn't listed for the current user. Add him to the memberIds\n+â”Š   â”Š 77â”Š        chat.listingMembers.push(this.currentUser);\n+â”Š   â”Š 78â”Š        chat = await this.repository.save(chat);\n+â”Š   â”Š 79â”Š\n+â”Š   â”Š 80â”Š        return chat || null;\n+â”Š   â”Š 81â”Š      } else {\n+â”Š   â”Š 82â”Š        return chat;\n+â”Š   â”Š 83â”Š      }\n+â”Š   â”Š 84â”Š    } else {\n+â”Š   â”Š 85â”Š      // Create the chat\n+â”Š   â”Š 86â”Š      chat = await this.repository.save(\n+â”Š   â”Š 87â”Š        new Chat({\n+â”Š   â”Š 88â”Š          allTimeMembers: [this.currentUser, user],\n+â”Š   â”Š 89â”Š          // Chat will not be listed to the other user until the first message gets written\n+â”Š   â”Š 90â”Š          listingMembers: [this.currentUser],\n+â”Š   â”Š 91â”Š        }),\n+â”Š   â”Š 92â”Š      );\n+â”Š   â”Š 93â”Š\n+â”Š   â”Š 94â”Š      return chat || null;\n+â”Š   â”Š 95â”Š    }\n+â”Š   â”Š 96â”Š  }\n+â”Š   â”Š 97â”Š\n â”Š 41â”Š 98â”Š  async getChatName(chat: Chat) {\n â”Š 42â”Š 99â”Š    if (chat.name) {\n â”Š 43â”Š100â”Š      return chat.name\n```\n```diff\n@@ -159,4 +216,55 @@\n â”Š159â”Š216â”Š\n â”Š160â”Š217â”Š    return this.currentUser\n â”Š161â”Š218â”Š  }\n+â”Š   â”Š219â”Š\n+â”Š   â”Š220â”Š  async removeChat(chatId: string) {\n+â”Š   â”Š221â”Š    const chat = await this.createQueryBuilder()\n+â”Š   â”Š222â”Š      .whereInIds(Number(chatId))\n+â”Š   â”Š223â”Š      .innerJoinAndSelect('chat.listingMembers', 'listingMembers')\n+â”Š   â”Š224â”Š      .leftJoinAndSelect('chat.owner', 'owner')\n+â”Š   â”Š225â”Š      .getOne();\n+â”Š   â”Š226â”Š\n+â”Š   â”Š227â”Š    if (!chat) {\n+â”Š   â”Š228â”Š      throw new Error(`The chat ${chatId} doesn't exist.`)\n+â”Š   â”Š229â”Š    }\n+â”Š   â”Š230â”Š\n+â”Š   â”Š231â”Š    if (!chat.name) {\n+â”Š   â”Š232â”Š      // Chat\n+â”Š   â”Š233â”Š      if (!chat.listingMembers.find(user => user.id === this.currentUser.id)) {\n+â”Š   â”Š234â”Š        throw new Error(`The user is not a listing member of the chat ${chatId}.`)\n+â”Š   â”Š235â”Š      }\n+â”Š   â”Š236â”Š\n+â”Š   â”Š237â”Š      // Remove the current user from who gets the chat listed. The chat will no longer appear in his list\n+â”Š   â”Š238â”Š      chat.listingMembers = chat.listingMembers.filter(user => user.id !== this.currentUser.id);\n+â”Š   â”Š239â”Š\n+â”Š   â”Š240â”Š      // Check how many members are left\n+â”Š   â”Š241â”Š      if (chat.listingMembers.length === 0) {\n+â”Š   â”Š242â”Š        // Delete the chat\n+â”Š   â”Š243â”Š        await this.repository.remove(chat);\n+â”Š   â”Š244â”Š      } else {\n+â”Š   â”Š245â”Š        // Update the chat\n+â”Š   â”Š246â”Š        await this.repository.save(chat);\n+â”Š   â”Š247â”Š      }\n+â”Š   â”Š248â”Š\n+â”Š   â”Š249â”Š      return chatId;\n+â”Š   â”Š250â”Š    } else {\n+â”Š   â”Š251â”Š      // Group\n+â”Š   â”Š252â”Š\n+â”Š   â”Š253â”Š      // Remove the current user from who gets the group listed. The group will no longer appear in his list\n+â”Š   â”Š254â”Š      chat.listingMembers = chat.listingMembers.filter(user => user.id !== this.currentUser.id);\n+â”Š   â”Š255â”Š\n+â”Š   â”Š256â”Š      // Check how many members (including previous ones who can still access old messages) are left\n+â”Š   â”Š257â”Š      if (chat.listingMembers.length === 0) {\n+â”Š   â”Š258â”Š        // Remove the group\n+â”Š   â”Š259â”Š        await this.repository.remove(chat);\n+â”Š   â”Š260â”Š      } else {\n+â”Š   â”Š261â”Š        // TODO: Implement for group\n+â”Š   â”Š262â”Š        chat.owner = chat.listingMembers[0]\n+â”Š   â”Š263â”Š\n+â”Š   â”Š264â”Š        await this.repository.save(chat);\n+â”Š   â”Š265â”Š      }\n+â”Š   â”Š266â”Š\n+â”Š   â”Š267â”Š      return chatId;\n+â”Š   â”Š268â”Š    }\n+â”Š   â”Š269â”Š  }\n â”Š162â”Š270â”Š}\n```\n\n##### Changed modules&#x2F;chat&#x2F;resolvers&#x2F;resolvers.ts\n```diff\n@@ -14,6 +14,8 @@\n â”Š14â”Š14â”Š      name: name || '',\n â”Š15â”Š15â”Š      picture: picture || '',\n â”Š16â”Š16â”Š    }),\n+â”Š  â”Š17â”Š    addChat: (obj, { userId }, { injector }) => injector.get(ChatProvider).addChat(userId),\n+â”Š  â”Š18â”Š    removeChat: (obj, { chatId }, { injector }) => injector.get(ChatProvider).removeChat(chatId),\n â”Š17â”Š19â”Š  },\n â”Š18â”Š20â”Š  Subscription: {\n â”Š19â”Š21â”Š    chatUpdated: {\n```\n\n##### Changed modules&#x2F;chat&#x2F;schema&#x2F;typeDefs.graphql\n```diff\n@@ -21,3 +21,8 @@\n â”Š21â”Š21â”Š  #If null the group is read-only. Null for chats.\n â”Š22â”Š22â”Š  owner: User\n â”Š23â”Š23â”Š}\n+â”Š  â”Š24â”Š\n+â”Š  â”Š25â”Štype Mutation {\n+â”Š  â”Š26â”Š  addChat(userId: ID!): Chat\n+â”Š  â”Š27â”Š  removeChat(chatId: ID!): ID\n+â”Š  â”Š28â”Š}\n```\n\n##### Changed modules&#x2F;message&#x2F;providers&#x2F;message.provider.ts\n```diff\n@@ -1,4 +1,5 @@\n â”Š1â”Š1â”Šimport { Injectable } from '@graphql-modules/di'\n+â”Š â”Š2â”Šimport { PubSub } from 'apollo-server-express'\n â”Š2â”Š3â”Šimport { Connection } from 'typeorm'\n â”Š3â”Š4â”Šimport { MessageType } from '../../../db'\n â”Š4â”Š5â”Šimport { Chat } from '../../../entity/chat'\n```\n```diff\n@@ -11,6 +12,7 @@\n â”Š11â”Š12â”Š@Injectable()\n â”Š12â”Š13â”Šexport class MessageProvider {\n â”Š13â”Š14â”Š  constructor(\n+â”Š  â”Š15â”Š    private pubsub: PubSub,\n â”Š14â”Š16â”Š    private connection: Connection,\n â”Š15â”Š17â”Š    private chatProvider: ChatProvider,\n â”Š16â”Š18â”Š    private authProvider: AuthProvider,\n```\n```diff\n@@ -24,6 +26,182 @@\n â”Š 24â”Š 26â”Š    return this.connection.createQueryBuilder(Message, 'message')\n â”Š 25â”Š 27â”Š  }\n â”Š 26â”Š 28â”Š\n+â”Š   â”Š 29â”Š  async addMessage(chatId: string, content: string) {\n+â”Š   â”Š 30â”Š    if (content === null || content === '') {\n+â”Š   â”Š 31â”Š      throw new Error(`Cannot add empty or null messages.`);\n+â”Š   â”Š 32â”Š    }\n+â”Š   â”Š 33â”Š\n+â”Š   â”Š 34â”Š    let chat = await this.chatProvider\n+â”Š   â”Š 35â”Š      .createQueryBuilder()\n+â”Š   â”Š 36â”Š      .whereInIds(chatId)\n+â”Š   â”Š 37â”Š      .innerJoinAndSelect('chat.allTimeMembers', 'allTimeMembers')\n+â”Š   â”Š 38â”Š      .innerJoinAndSelect('chat.listingMembers', 'listingMembers')\n+â”Š   â”Š 39â”Š      .getOne();\n+â”Š   â”Š 40â”Š\n+â”Š   â”Š 41â”Š    if (!chat) {\n+â”Š   â”Š 42â”Š      throw new Error(`Cannot find chat ${chatId}.`);\n+â”Š   â”Š 43â”Š    }\n+â”Š   â”Š 44â”Š\n+â”Š   â”Š 45â”Š    let holders: User[];\n+â”Š   â”Š 46â”Š\n+â”Š   â”Š 47â”Š    if (!chat.name) {\n+â”Š   â”Š 48â”Š      // Chat\n+â”Š   â”Š 49â”Š      if (!chat.listingMembers.map(user => user.id).includes(this.currentUser.id)) {\n+â”Š   â”Š 50â”Š        throw new Error(`The chat ${chatId} must be listed for the current user in order to add a message.`);\n+â”Š   â”Š 51â”Š      }\n+â”Š   â”Š 52â”Š\n+â”Š   â”Š 53â”Š      // Receiver's user\n+â”Š   â”Š 54â”Š      const user = chat.allTimeMembers.find(user => user.id !== this.currentUser.id);\n+â”Š   â”Š 55â”Š\n+â”Š   â”Š 56â”Š      if (!user) {\n+â”Š   â”Š 57â”Š        throw new Error(`Cannot find receiver's user.`);\n+â”Š   â”Š 58â”Š      }\n+â”Š   â”Š 59â”Š\n+â”Š   â”Š 60â”Š      if (!chat.listingMembers.find(listingMember => listingMember.id === user.id)) {\n+â”Š   â”Š 61â”Š        // Chat is not listed for the receiver user. Add him to the listingIds\n+â”Š   â”Š 62â”Š        chat.listingMembers.push(user);\n+â”Š   â”Š 63â”Š\n+â”Š   â”Š 64â”Š        await this.chatProvider.repository.save(chat);\n+â”Š   â”Š 65â”Š      }\n+â”Š   â”Š 66â”Š\n+â”Š   â”Š 67â”Š      holders = chat.listingMembers;\n+â”Š   â”Š 68â”Š    } else {\n+â”Š   â”Š 69â”Š      // TODO: Implement for groups\n+â”Š   â”Š 70â”Š      holders = chat.listingMembers\n+â”Š   â”Š 71â”Š    }\n+â”Š   â”Š 72â”Š\n+â”Š   â”Š 73â”Š    const message = await this.repository.save(new Message({\n+â”Š   â”Š 74â”Š      chat,\n+â”Š   â”Š 75â”Š      sender: this.currentUser,\n+â”Š   â”Š 76â”Š      content,\n+â”Š   â”Š 77â”Š      type: MessageType.TEXT,\n+â”Š   â”Š 78â”Š      holders,\n+â”Š   â”Š 79â”Š    }));\n+â”Š   â”Š 80â”Š\n+â”Š   â”Š 81â”Š    this.pubsub.publish('messageAdded', {\n+â”Š   â”Š 82â”Š      messageAdded: message,\n+â”Š   â”Š 83â”Š    });\n+â”Š   â”Š 84â”Š\n+â”Š   â”Š 85â”Š    return message || null;\n+â”Š   â”Š 86â”Š  }\n+â”Š   â”Š 87â”Š\n+â”Š   â”Š 88â”Š  async _removeMessages(\n+â”Š   â”Š 89â”Š\n+â”Š   â”Š 90â”Š    chatId: string,\n+â”Š   â”Š 91â”Š    {\n+â”Š   â”Š 92â”Š      messageIds,\n+â”Š   â”Š 93â”Š      all,\n+â”Š   â”Š 94â”Š    }: {\n+â”Š   â”Š 95â”Š      messageIds?: string[]\n+â”Š   â”Š 96â”Š      all?: boolean\n+â”Š   â”Š 97â”Š    } = {},\n+â”Š   â”Š 98â”Š  ) {\n+â”Š   â”Š 99â”Š    const chat = await this.chatProvider\n+â”Š   â”Š100â”Š      .createQueryBuilder()\n+â”Š   â”Š101â”Š      .whereInIds(chatId)\n+â”Š   â”Š102â”Š      .innerJoinAndSelect('chat.listingMembers', 'listingMembers')\n+â”Š   â”Š103â”Š      .innerJoinAndSelect('chat.messages', 'messages')\n+â”Š   â”Š104â”Š      .innerJoinAndSelect('messages.holders', 'holders')\n+â”Š   â”Š105â”Š      .getOne();\n+â”Š   â”Š106â”Š\n+â”Š   â”Š107â”Š    if (!chat) {\n+â”Š   â”Š108â”Š      throw new Error(`Cannot find chat ${chatId}.`);\n+â”Š   â”Š109â”Š    }\n+â”Š   â”Š110â”Š\n+â”Š   â”Š111â”Š    if (!chat.listingMembers.find(user => user.id === this.currentUser.id)) {\n+â”Š   â”Š112â”Š      throw new Error(`The chat/group ${chatId} is not listed for the current user so there is nothing to delete.`);\n+â”Š   â”Š113â”Š    }\n+â”Š   â”Š114â”Š\n+â”Š   â”Š115â”Š    if (all && messageIds) {\n+â”Š   â”Š116â”Š      throw new Error(`Cannot specify both 'all' and 'messageIds'.`)\n+â”Š   â”Š117â”Š    }\n+â”Š   â”Š118â”Š\n+â”Š   â”Š119â”Š    if (!all && !(messageIds && messageIds.length)) {\n+â”Š   â”Š120â”Š      throw new Error(`'all' and 'messageIds' cannot be both null`)\n+â”Š   â”Š121â”Š    }\n+â”Š   â”Š122â”Š\n+â”Š   â”Š123â”Š    let deletedIds: string[] = [];\n+â”Š   â”Š124â”Š    let removedMessages: Message[] = [];\n+â”Š   â”Š125â”Š    // Instead of chaining map and filter we can loop once using reduce\n+â”Š   â”Š126â”Š    chat.messages = await chat.messages.reduce<Promise<Message[]>>(async (filtered$, message) => {\n+â”Š   â”Š127â”Š      const filtered = await filtered$;\n+â”Š   â”Š128â”Š\n+â”Š   â”Š129â”Š      if (all || messageIds!.includes(message.id)) {\n+â”Š   â”Š130â”Š        deletedIds.push(message.id);\n+â”Š   â”Š131â”Š        // Remove the current user from the message holders\n+â”Š   â”Š132â”Š        message.holders = message.holders.filter(user => user.id !== this.currentUser.id);\n+â”Š   â”Š133â”Š\n+â”Š   â”Š134â”Š      }\n+â”Š   â”Š135â”Š\n+â”Š   â”Š136â”Š      if (message.holders.length !== 0) {\n+â”Š   â”Š137â”Š        // Remove the current user from the message holders\n+â”Š   â”Š138â”Š        await this.repository.save(message);\n+â”Š   â”Š139â”Š        filtered.push(message);\n+â”Š   â”Š140â”Š      } else {\n+â”Š   â”Š141â”Š        // Message is flagged for removal\n+â”Š   â”Š142â”Š        removedMessages.push(message);\n+â”Š   â”Š143â”Š      }\n+â”Š   â”Š144â”Š\n+â”Š   â”Š145â”Š      return filtered;\n+â”Š   â”Š146â”Š    }, Promise.resolve([]));\n+â”Š   â”Š147â”Š\n+â”Š   â”Š148â”Š    return { deletedIds, removedMessages };\n+â”Š   â”Š149â”Š  }\n+â”Š   â”Š150â”Š\n+â”Š   â”Š151â”Š  async removeMessages(\n+â”Š   â”Š152â”Š\n+â”Š   â”Š153â”Š    chatId: string,\n+â”Š   â”Š154â”Š    {\n+â”Š   â”Š155â”Š      messageIds,\n+â”Š   â”Š156â”Š      all,\n+â”Š   â”Š157â”Š    }: {\n+â”Š   â”Š158â”Š      messageIds?: string[]\n+â”Š   â”Š159â”Š      all?: boolean\n+â”Š   â”Š160â”Š    } = {},\n+â”Š   â”Š161â”Š  ) {\n+â”Š   â”Š162â”Š    const { deletedIds, removedMessages } = await this._removeMessages(chatId, { messageIds, all });\n+â”Š   â”Š163â”Š\n+â”Š   â”Š164â”Š    for (let message of removedMessages) {\n+â”Š   â”Š165â”Š      await this.repository.remove(message);\n+â”Š   â”Š166â”Š    }\n+â”Š   â”Š167â”Š\n+â”Š   â”Š168â”Š    return deletedIds;\n+â”Š   â”Š169â”Š  }\n+â”Š   â”Š170â”Š\n+â”Š   â”Š171â”Š  async _removeChatGetMessages(chatId: string) {\n+â”Š   â”Š172â”Š    let messages = await this.createQueryBuilder()\n+â”Š   â”Š173â”Š      .innerJoin('message.chat', 'chat', 'chat.id = :chatId', { chatId })\n+â”Š   â”Š174â”Š      .leftJoinAndSelect('message.holders', 'holders')\n+â”Š   â”Š175â”Š      .getMany();\n+â”Š   â”Š176â”Š\n+â”Š   â”Š177â”Š    messages = messages.map(message => ({\n+â”Š   â”Š178â”Š      ...message,\n+â”Š   â”Š179â”Š      holders: message.holders.filter(user => user.id !== this.currentUser.id),\n+â”Š   â”Š180â”Š    }));\n+â”Š   â”Š181â”Š\n+â”Š   â”Š182â”Š    return messages;\n+â”Š   â”Š183â”Š  }\n+â”Š   â”Š184â”Š\n+â”Š   â”Š185â”Š  async removeChat(chatId: string, messages?: Message[]) {\n+â”Š   â”Š186â”Š    if (!messages) {\n+â”Š   â”Š187â”Š      messages = await this._removeChatGetMessages(chatId);\n+â”Š   â”Š188â”Š    }\n+â”Š   â”Š189â”Š\n+â”Š   â”Š190â”Š    for (let message of messages) {\n+â”Š   â”Š191â”Š      message.holders = message.holders.filter(user => user.id !== this.currentUser.id);\n+â”Š   â”Š192â”Š\n+â”Š   â”Š193â”Š      if (message.holders.length !== 0) {\n+â”Š   â”Š194â”Š        // Remove the current user from the message holders\n+â”Š   â”Š195â”Š        await this.repository.save(message);\n+â”Š   â”Š196â”Š      } else {\n+â”Š   â”Š197â”Š        // Simply remove the message\n+â”Š   â”Š198â”Š        await this.repository.remove(message);\n+â”Š   â”Š199â”Š      }\n+â”Š   â”Š200â”Š    }\n+â”Š   â”Š201â”Š\n+â”Š   â”Š202â”Š    return await this.chatProvider.removeChat(chatId);\n+â”Š   â”Š203â”Š  }\n+â”Š   â”Š204â”Š\n â”Š 27â”Š205â”Š  async getMessageSender(message: Message) {\n â”Š 28â”Š206â”Š    const sender = await this.userProvider\n â”Š 29â”Š207â”Š      .createQueryBuilder()\n```\n\n##### Changed modules&#x2F;message&#x2F;resolvers&#x2F;resolvers.ts\n```diff\n@@ -8,6 +8,17 @@\n â”Š 8â”Š 8â”Š    // The ordering depends on the messages\n â”Š 9â”Š 9â”Š    chats: (obj, args, { injector }) => injector.get(MessageProvider).getChats(),\n â”Š10â”Š10â”Š  },\n+â”Š  â”Š11â”Š  Mutation: {\n+â”Š  â”Š12â”Š    addMessage: async (obj, { chatId, content }, { injector }) =>\n+â”Š  â”Š13â”Š      injector.get(MessageProvider).addMessage(chatId, content),\n+â”Š  â”Š14â”Š    removeMessages: async (obj, { chatId, messageIds, all }, { injector }) =>\n+â”Š  â”Š15â”Š      injector.get(MessageProvider).removeMessages(chatId, {\n+â”Š  â”Š16â”Š        messageIds: messageIds || undefined,\n+â”Š  â”Š17â”Š        all: all || false,\n+â”Š  â”Š18â”Š      }),\n+â”Š  â”Š19â”Š    // We may need to also remove the messages\n+â”Š  â”Š20â”Š    removeChat: async (obj, { chatId }, { injector }) => injector.get(MessageProvider).removeChat(chatId),\n+â”Š  â”Š21â”Š  },\n â”Š11â”Š22â”Š  Chat: {\n â”Š12â”Š23â”Š    messages: async (chat, { amount }, { injector }) =>\n â”Š13â”Š24â”Š      injector.get(MessageProvider).getChatMessages(chat, amount || 0),\n```\n\n##### Changed modules&#x2F;message&#x2F;schema&#x2F;typeDefs.graphql\n```diff\n@@ -23,3 +23,8 @@\n â”Š23â”Š23â”Š  #Computed property\n â”Š24â”Š24â”Š  ownership: Boolean!\n â”Š25â”Š25â”Š}\n+â”Š  â”Š26â”Š\n+â”Š  â”Š27â”Štype Mutation {\n+â”Š  â”Š28â”Š  addMessage(chatId: ID!, content: String!): Message\n+â”Š  â”Š29â”Š  removeMessages(chatId: ID!, messageIds: [ID!], all: Boolean): [ID]!\n+â”Š  â”Š30â”Š}\n```\n\n[}]: #\n\nRemember that every change that happens in the back-end should trigger a subscription that will notify all the use regards that change. For the current flow, we should have the following subscriptions:\n\n- `messageAdded` subscription\n- `userAdded` subscription\n- `userUpdated` subscription - Since we will be able to create a new chat by picking from a users list, this list needs to be synced with the most recent changes.\n\nLet's implement these subscriptions:\n\n[{]: <helper> (diffStep 3.3 module=\"server\")\n\n#### Step 3.3: Add necessary subscriptions\n\n##### Changed modules&#x2F;chat&#x2F;resolvers&#x2F;resolvers.ts\n```diff\n@@ -18,6 +18,12 @@\n â”Š18â”Š18â”Š    removeChat: (obj, { chatId }, { injector }) => injector.get(ChatProvider).removeChat(chatId),\n â”Š19â”Š19â”Š  },\n â”Š20â”Š20â”Š  Subscription: {\n+â”Š  â”Š21â”Š    chatAdded: {\n+â”Š  â”Š22â”Š      subscribe: withFilter((root, args, { injector }: ModuleContext) => injector.get(PubSub).asyncIterator('chatAdded'),\n+â”Š  â”Š23â”Š        (data: { chatAdded: Chat, creatorId: string }, variables, { injector }: ModuleContext) =>\n+â”Š  â”Š24â”Š          data && injector.get(ChatProvider).filterChatAddedOrUpdated(data.chatAdded, data.creatorId)\n+â”Š  â”Š25â”Š      ),\n+â”Š  â”Š26â”Š    },\n â”Š21â”Š27â”Š    chatUpdated: {\n â”Š22â”Š28â”Š      subscribe: withFilter((root, args, { injector }: ModuleContext) => injector.get(PubSub).asyncIterator('chatUpdated'),\n â”Š23â”Š29â”Š        (data: { chatUpdated: Chat, updaterId: string }, variables, { injector }: ModuleContext) =>\n```\n\n##### Changed modules&#x2F;chat&#x2F;schema&#x2F;typeDefs.graphql\n```diff\n@@ -4,6 +4,7 @@\n â”Š 4â”Š 4â”Š}\n â”Š 5â”Š 5â”Š\n â”Š 6â”Š 6â”Štype Subscription {\n+â”Š  â”Š 7â”Š  chatAdded: Chat\n â”Š 7â”Š 8â”Š  chatUpdated: Chat\n â”Š 8â”Š 9â”Š}\n â”Š 9â”Š10â”Š\n```\n\n##### Changed modules&#x2F;message&#x2F;providers&#x2F;message.provider.ts\n```diff\n@@ -62,6 +62,11 @@\n â”Š62â”Š62â”Š        chat.listingMembers.push(user);\n â”Š63â”Š63â”Š\n â”Š64â”Š64â”Š        await this.chatProvider.repository.save(chat);\n+â”Š  â”Š65â”Š\n+â”Š  â”Š66â”Š        this.pubsub.publish('chatAdded', {\n+â”Š  â”Š67â”Š          creatorId: this.currentUser.id,\n+â”Š  â”Š68â”Š          chatAdded: chat,\n+â”Š  â”Š69â”Š        });\n â”Š65â”Š70â”Š      }\n â”Š66â”Š71â”Š\n â”Š67â”Š72â”Š      holders = chat.listingMembers;\n```\n```diff\n@@ -317,4 +322,18 @@\n â”Š317â”Š322â”Š\n â”Š318â”Š323â”Š    return latestMessage ? latestMessage.createdAt : null\n â”Š319â”Š324â”Š  }\n+â”Š   â”Š325â”Š\n+â”Š   â”Š326â”Š  async filterMessageAdded(messageAdded: Message) {\n+â”Š   â”Š327â”Š    const relevantUsers = (await this.userProvider\n+â”Š   â”Š328â”Š      .createQueryBuilder()\n+â”Š   â”Š329â”Š      .innerJoin(\n+â”Š   â”Š330â”Š        'user.listingMemberChats',\n+â”Š   â”Š331â”Š        'listingMemberChats',\n+â”Š   â”Š332â”Š        'listingMemberChats.id = :chatId',\n+â”Š   â”Š333â”Š        { chatId: messageAdded.chat.id }\n+â”Š   â”Š334â”Š      )\n+â”Š   â”Š335â”Š      .getMany()).filter(user => user.id != messageAdded.sender.id)\n+â”Š   â”Š336â”Š\n+â”Š   â”Š337â”Š    return relevantUsers.some(user => user.id === this.currentUser.id)\n+â”Š   â”Š338â”Š  }\n â”Š320â”Š339â”Š}\n```\n\n##### Changed modules&#x2F;message&#x2F;resolvers&#x2F;resolvers.ts\n```diff\n@@ -1,4 +1,5 @@\n â”Š1â”Š1â”Šimport { ModuleContext } from '@graphql-modules/core'\n+â”Š â”Š2â”Šimport { PubSub, withFilter } from 'apollo-server-express'\n â”Š2â”Š3â”Šimport { Message } from '../../../entity/message'\n â”Š3â”Š4â”Šimport { IResolvers } from '../../../types'\n â”Š4â”Š5â”Šimport { MessageProvider } from '../providers/message.provider'\n```\n```diff\n@@ -19,6 +20,13 @@\n â”Š19â”Š20â”Š    // We may need to also remove the messages\n â”Š20â”Š21â”Š    removeChat: async (obj, { chatId }, { injector }) => injector.get(MessageProvider).removeChat(chatId),\n â”Š21â”Š22â”Š  },\n+â”Š  â”Š23â”Š  Subscription: {\n+â”Š  â”Š24â”Š    messageAdded: {\n+â”Š  â”Š25â”Š      subscribe: withFilter((root, args, { injector }: ModuleContext) => injector.get(PubSub).asyncIterator('messageAdded'),\n+â”Š  â”Š26â”Š        (data: { messageAdded: Message }, variables, { injector }: ModuleContext) => data && injector.get(MessageProvider).filterMessageAdded(data.messageAdded)\n+â”Š  â”Š27â”Š      ),\n+â”Š  â”Š28â”Š    },\n+â”Š  â”Š29â”Š  },\n â”Š22â”Š30â”Š  Chat: {\n â”Š23â”Š31â”Š    messages: async (chat, { amount }, { injector }) =>\n â”Š24â”Š32â”Š      injector.get(MessageProvider).getChatMessages(chat, amount || 0),\n```\n\n##### Changed modules&#x2F;message&#x2F;schema&#x2F;typeDefs.graphql\n```diff\n@@ -1,3 +1,7 @@\n+â”Š â”Š1â”Štype Subscription {\n+â”Š â”Š2â”Š  messageAdded: Message\n+â”Š â”Š3â”Š}\n+â”Š â”Š4â”Š\n â”Š1â”Š5â”Šenum MessageType {\n â”Š2â”Š6â”Š  LOCATION\n â”Š3â”Š7â”Š  TEXT\n```\n\n##### Changed modules&#x2F;user&#x2F;providers&#x2F;user.provider.ts\n```diff\n@@ -1,4 +1,5 @@\n â”Š1â”Š1â”Šimport { Injectable, ProviderScope } from '@graphql-modules/di'\n+â”Š â”Š2â”Šimport { PubSub } from 'apollo-server-express'\n â”Š2â”Š3â”Šimport cloudinary from 'cloudinary'\n â”Š3â”Š4â”Šimport { Connection } from 'typeorm'\n â”Š4â”Š5â”Šimport { User } from '../../../entity/user'\n```\n```diff\n@@ -6,7 +7,11 @@\n â”Š 6â”Š 7â”Š\n â”Š 7â”Š 8â”Š@Injectable()\n â”Š 8â”Š 9â”Šexport class UserProvider {\n-â”Š 9â”Š  â”Š  constructor(private connection: Connection, private authProvider: AuthProvider) {}\n+â”Š  â”Š10â”Š  constructor(\n+â”Š  â”Š11â”Š    private pubsub: PubSub,\n+â”Š  â”Š12â”Š    private connection: Connection,\n+â”Š  â”Š13â”Š    private authProvider: AuthProvider,\n+â”Š  â”Š14â”Š  ) {}\n â”Š10â”Š15â”Š\n â”Š11â”Š16â”Š  public repository = this.connection.getRepository(User)\n â”Š12â”Š17â”Š  private currentUser = this.authProvider.currentUser\n```\n```diff\n@@ -41,9 +46,17 @@\n â”Š41â”Š46â”Š\n â”Š42â”Š47â”Š    await this.repository.save(this.currentUser);\n â”Š43â”Š48â”Š\n+â”Š  â”Š49â”Š    this.pubsub.publish('userUpdated', {\n+â”Š  â”Š50â”Š      userUpdated: this.currentUser,\n+â”Š  â”Š51â”Š    });\n+â”Š  â”Š52â”Š\n â”Š44â”Š53â”Š    return this.currentUser;\n â”Š45â”Š54â”Š  }\n â”Š46â”Š55â”Š\n+â”Š  â”Š56â”Š  filterUserAddedOrUpdated(userAddedOrUpdated: User) {\n+â”Š  â”Š57â”Š    return userAddedOrUpdated.id !== this.currentUser.id;\n+â”Š  â”Š58â”Š  }\n+â”Š  â”Š59â”Š\n â”Š47â”Š60â”Š  uploadProfilePic(filePath: string) {\n â”Š48â”Š61â”Š    return new Promise((resolve, reject) => {\n â”Š49â”Š62â”Š      cloudinary.v2.uploader.upload(filePath, (error, result) => {\n```\n\n##### Changed modules&#x2F;user&#x2F;resolvers&#x2F;resolvers.ts\n```diff\n@@ -1,4 +1,5 @@\n â”Š1â”Š1â”Šimport { ModuleContext } from '@graphql-modules/core'\n+â”Š â”Š2â”Šimport { PubSub, withFilter } from 'apollo-server-express'\n â”Š2â”Š3â”Šimport { User } from '../../../entity/User'\n â”Š3â”Š4â”Šimport { IResolvers } from '../../../types'\n â”Š4â”Š5â”Šimport { UserProvider } from '../providers/user.provider'\n```\n```diff\n@@ -14,4 +15,18 @@\n â”Š14â”Š15â”Š      picture: picture || '',\n â”Š15â”Š16â”Š    }),\n â”Š16â”Š17â”Š  },\n+â”Š  â”Š18â”Š  Subscription: {\n+â”Š  â”Š19â”Š    userAdded: {\n+â”Š  â”Š20â”Š      subscribe: withFilter(\n+â”Š  â”Š21â”Š        (root, args, { injector }: ModuleContext) => injector.get(PubSub).asyncIterator('userAdded'),\n+â”Š  â”Š22â”Š        (data: { userAdded: User }, variables, { injector }: ModuleContext) => data && injector.get(UserProvider).filterUserAddedOrUpdated(data.userAdded),\n+â”Š  â”Š23â”Š      ),\n+â”Š  â”Š24â”Š    },\n+â”Š  â”Š25â”Š    userUpdated: {\n+â”Š  â”Š26â”Š      subscribe: withFilter(\n+â”Š  â”Š27â”Š        (root, args, { injector }: ModuleContext) => injector.get(PubSub).asyncIterator('userAdded'),\n+â”Š  â”Š28â”Š        (data: { userUpdated: User }, variables, { injector }: ModuleContext) => data && injector.get(UserProvider).filterUserAddedOrUpdated(data.userUpdated)\n+â”Š  â”Š29â”Š      ),\n+â”Š  â”Š30â”Š    },\n+â”Š  â”Š31â”Š  },\n â”Š17â”Š32â”Š} as IResolvers\n```\n\n##### Changed modules&#x2F;user&#x2F;schema&#x2F;typeDefs.graphql\n```diff\n@@ -7,6 +7,11 @@\n â”Š 7â”Š 7â”Š  updateUser(name: String, picture: String): User!\n â”Š 8â”Š 8â”Š}\n â”Š 9â”Š 9â”Š\n+â”Š  â”Š10â”Štype Subscription {\n+â”Š  â”Š11â”Š  userAdded: User\n+â”Š  â”Š12â”Š  userUpdated: User\n+â”Š  â”Š13â”Š}\n+â”Š  â”Š14â”Š\n â”Š10â”Š15â”Štype User {\n â”Š11â”Š16â”Š  id: ID!\n â”Š12â”Š17â”Š  name: String\n```\n\n[}]: #\n\nNow that we have that ready, we will get back to the client and implement the necessary components. We will start with the chat room screen. The layout consists of the following component:\n\n- A navbar - Includes the name and a picture of the person we're chatting with, a \"back\" button to navigate back to the main screen, and a pop-over menu where we can remove the chat from.\n- A messages list - The list of messages that were sent and received in the chat. This will be a scrollable view where message bubbles are colored differently based on who they belong to. Just like WhatsApp!\n- A message box - The input that will be used to write the new message. This will include a \"send\" button right next to it.\n\nLet's implement the components\n\n[{]: <helper> (diffStep 3.1 files=\"src/components/ChatRoomScreen\" module=\"client\")\n\n#### [Step 3.1: Add chat room screen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/b2bc092)\n\n##### Added src&#x2F;components&#x2F;ChatRoomScreen&#x2F;ChatNavbar.tsx\n```diff\n@@ -0,0 +1,172 @@\n+â”Š   â”Š  1â”Šimport Button from '@material-ui/core/Button'\n+â”Š   â”Š  2â”Šimport List from '@material-ui/core/List'\n+â”Š   â”Š  3â”Šimport ListItem from '@material-ui/core/ListItem'\n+â”Š   â”Š  4â”Šimport Popover from '@material-ui/core/Popover'\n+â”Š   â”Š  5â”Šimport ArrowBackIcon from '@material-ui/icons/ArrowBack'\n+â”Š   â”Š  6â”Šimport DeleteIcon from '@material-ui/icons/Delete'\n+â”Š   â”Š  7â”Šimport MoreIcon from '@material-ui/icons/MoreVert'\n+â”Š   â”Š  8â”Šimport { defaultDataIdFromObject } from 'apollo-cache-inmemory'\n+â”Š   â”Š  9â”Šimport gql from 'graphql-tag'\n+â”Š   â”Š 10â”Šimport { History } from 'history'\n+â”Š   â”Š 11â”Šimport * as React from 'react'\n+â”Š   â”Š 12â”Šimport { useState } from 'react'\n+â”Š   â”Š 13â”Šimport { useQuery, useMutation } from 'react-apollo-hooks'\n+â”Š   â”Š 14â”Šimport styled from 'styled-components'\n+â”Š   â”Š 15â”Šimport * as fragments from '../../graphql/fragments'\n+â”Š   â”Š 16â”Šimport * as queries from '../../graphql/queries'\n+â”Š   â”Š 17â”Šimport { ChatNavbarMutation, ChatNavbarQuery, Chats } from '../../graphql/types'\n+â”Š   â”Š 18â”Š\n+â”Š   â”Š 19â”Šconst Style = styled.div`\n+â”Š   â”Š 20â”Š  padding: 0;\n+â”Š   â”Š 21â”Š  display: flex;\n+â”Š   â”Š 22â”Š  flex-direction: row;\n+â”Š   â”Š 23â”Š\n+â”Š   â”Š 24â”Š  margin-left: -20px;\n+â”Š   â”Š 25â”Š  .ChatNavbar-title {\n+â”Š   â”Š 26â”Š    line-height: 56px;\n+â”Š   â”Š 27â”Š  }\n+â”Š   â”Š 28â”Š\n+â”Š   â”Š 29â”Š  .ChatNavbar-back-button {\n+â”Š   â”Š 30â”Š    color: var(--primary-text);\n+â”Š   â”Š 31â”Š  }\n+â”Š   â”Š 32â”Š\n+â”Š   â”Š 33â”Š  .ChatNavbar-picture {\n+â”Š   â”Š 34â”Š    height: 40px;\n+â”Š   â”Š 35â”Š    width: 40px;\n+â”Š   â”Š 36â”Š    margin-top: 3px;\n+â”Š   â”Š 37â”Š    margin-left: -22px;\n+â”Š   â”Š 38â”Š    object-fit: cover;\n+â”Š   â”Š 39â”Š    padding: 5px;\n+â”Š   â”Š 40â”Š    border-radius: 50%;\n+â”Š   â”Š 41â”Š  }\n+â”Š   â”Š 42â”Š\n+â”Š   â”Š 43â”Š  .ChatNavbar-rest {\n+â”Š   â”Š 44â”Š    flex: 1;\n+â”Š   â”Š 45â”Š    justify-content: flex-end;\n+â”Š   â”Š 46â”Š  }\n+â”Š   â”Š 47â”Š\n+â”Š   â”Š 48â”Š  .ChatNavbar-options-btn {\n+â”Š   â”Š 49â”Š    float: right;\n+â”Š   â”Š 50â”Š    height: 100%;\n+â”Š   â”Š 51â”Š    font-size: 1.2em;\n+â”Š   â”Š 52â”Š    margin-right: -15px;\n+â”Š   â”Š 53â”Š    color: var(--primary-text);\n+â”Š   â”Š 54â”Š  }\n+â”Š   â”Š 55â”Š\n+â”Š   â”Š 56â”Š  .ChatNavbar-options-item svg {\n+â”Š   â”Š 57â”Š    margin-right: 10px;\n+â”Š   â”Š 58â”Š    padding-left: 15px;\n+â”Š   â”Š 59â”Š  }\n+â”Š   â”Š 60â”Š`\n+â”Š   â”Š 61â”Š\n+â”Š   â”Š 62â”Šconst query = gql`\n+â”Š   â”Š 63â”Š  query ChatNavbarQuery($chatId: ID!) {\n+â”Š   â”Š 64â”Š    chat(chatId: $chatId) {\n+â”Š   â”Š 65â”Š      ...Chat\n+â”Š   â”Š 66â”Š    }\n+â”Š   â”Š 67â”Š  }\n+â”Š   â”Š 68â”Š  ${fragments.chat}\n+â”Š   â”Š 69â”Š`\n+â”Š   â”Š 70â”Š\n+â”Š   â”Š 71â”Šconst mutation = gql`\n+â”Š   â”Š 72â”Š  mutation ChatNavbarMutation($chatId: ID!) {\n+â”Š   â”Š 73â”Š    removeChat(chatId: $chatId)\n+â”Š   â”Š 74â”Š  }\n+â”Š   â”Š 75â”Š`\n+â”Š   â”Š 76â”Š\n+â”Š   â”Š 77â”Šinterface ChatNavbarProps {\n+â”Š   â”Š 78â”Š  chatId: string\n+â”Š   â”Š 79â”Š  history: History\n+â”Š   â”Š 80â”Š}\n+â”Š   â”Š 81â”Š\n+â”Š   â”Š 82â”Šexport default ({ chatId, history }: ChatNavbarProps) => {\n+â”Š   â”Š 83â”Š  const {\n+â”Š   â”Š 84â”Š    data: { chat },\n+â”Š   â”Š 85â”Š  } = useQuery<ChatNavbarQuery.Query, ChatNavbarQuery.Variables>(query, {\n+â”Š   â”Š 86â”Š    variables: { chatId },\n+â”Š   â”Š 87â”Š    suspend: true,\n+â”Š   â”Š 88â”Š  })\n+â”Š   â”Š 89â”Š  const removeChat = useMutation<ChatNavbarMutation.Mutation, ChatNavbarMutation.Variables>(\n+â”Š   â”Š 90â”Š    mutation,\n+â”Š   â”Š 91â”Š    {\n+â”Š   â”Š 92â”Š      variables: { chatId },\n+â”Š   â”Š 93â”Š      update: (client, { data: { removeChat } }) => {\n+â”Š   â”Š 94â”Š        client.writeFragment({\n+â”Š   â”Š 95â”Š          id: defaultDataIdFromObject({\n+â”Š   â”Š 96â”Š            __typename: 'Chat',\n+â”Š   â”Š 97â”Š            id: removeChat,\n+â”Š   â”Š 98â”Š          }),\n+â”Š   â”Š 99â”Š          fragment: fragments.chat,\n+â”Š   â”Š100â”Š          fragmentName: 'Chat',\n+â”Š   â”Š101â”Š          data: null,\n+â”Š   â”Š102â”Š        })\n+â”Š   â”Š103â”Š\n+â”Š   â”Š104â”Š        let chats\n+â”Š   â”Š105â”Š        try {\n+â”Š   â”Š106â”Š          chats = client.readQuery<Chats.Query>({\n+â”Š   â”Š107â”Š            query: queries.chats,\n+â”Š   â”Š108â”Š          }).chats\n+â”Š   â”Š109â”Š        } catch (e) {}\n+â”Š   â”Š110â”Š\n+â”Š   â”Š111â”Š        if (chats && chats.some(chat => chat.id === removeChat)) {\n+â”Š   â”Š112â”Š          const index = chats.findIndex(chat => chat.id === removeChat)\n+â”Š   â”Š113â”Š          chats.splice(index, 1)\n+â”Š   â”Š114â”Š\n+â”Š   â”Š115â”Š          client.writeQuery({\n+â”Š   â”Š116â”Š            query: queries.chats,\n+â”Š   â”Š117â”Š            data: { chats },\n+â”Š   â”Š118â”Š          })\n+â”Š   â”Š119â”Š        }\n+â”Š   â”Š120â”Š      },\n+â”Š   â”Š121â”Š    },\n+â”Š   â”Š122â”Š  )\n+â”Š   â”Š123â”Š  const [popped, setPopped] = useState(false)\n+â”Š   â”Š124â”Š\n+â”Š   â”Š125â”Š  const navToChats = () => {\n+â”Š   â”Š126â”Š    history.push('/chats')\n+â”Š   â”Š127â”Š  }\n+â”Š   â”Š128â”Š\n+â”Š   â”Š129â”Š  const handleRemoveChat = () => {\n+â”Š   â”Š130â”Š    setPopped(false)\n+â”Š   â”Š131â”Š    removeChat().then(navToChats)\n+â”Š   â”Š132â”Š  }\n+â”Š   â”Š133â”Š\n+â”Š   â”Š134â”Š  return (\n+â”Š   â”Š135â”Š    <Style className={name}>\n+â”Š   â”Š136â”Š      <Button className=\"ChatNavbar-back-button\" onClick={navToChats}>\n+â”Š   â”Š137â”Š        <ArrowBackIcon />\n+â”Š   â”Š138â”Š      </Button>\n+â”Š   â”Š139â”Š      <img\n+â”Š   â”Š140â”Š        className=\"ChatNavbar-picture\"\n+â”Š   â”Š141â”Š        src={chat.picture || '/assets/default-profile-pic.jpg'}\n+â”Š   â”Š142â”Š      />\n+â”Š   â”Š143â”Š      <div className=\"ChatNavbar-title\">{chat.name}</div>\n+â”Š   â”Š144â”Š      <div className=\"ChatNavbar-rest\">\n+â”Š   â”Š145â”Š        <Button className=\"ChatNavbar-options-btn\" onClick={setPopped.bind(null, true)}>\n+â”Š   â”Š146â”Š          <MoreIcon />\n+â”Š   â”Š147â”Š        </Button>\n+â”Š   â”Š148â”Š      </div>\n+â”Š   â”Š149â”Š      <Popover\n+â”Š   â”Š150â”Š        open={popped}\n+â”Š   â”Š151â”Š        onClose={setPopped.bind(null, false)}\n+â”Š   â”Š152â”Š        anchorOrigin={{\n+â”Š   â”Š153â”Š          vertical: 'top',\n+â”Š   â”Š154â”Š          horizontal: 'right',\n+â”Š   â”Š155â”Š        }}\n+â”Š   â”Š156â”Š        transformOrigin={{\n+â”Š   â”Š157â”Š          vertical: 'top',\n+â”Š   â”Š158â”Š          horizontal: 'right',\n+â”Š   â”Š159â”Š        }}\n+â”Š   â”Š160â”Š      >\n+â”Š   â”Š161â”Š        <Style style={{ marginLeft: '-15px' }}>\n+â”Š   â”Š162â”Š          <List>\n+â”Š   â”Š163â”Š            <ListItem className=\"ChatNavbar-options-item\" button onClick={handleRemoveChat}>\n+â”Š   â”Š164â”Š              <DeleteIcon />\n+â”Š   â”Š165â”Š              Delete\n+â”Š   â”Š166â”Š            </ListItem>\n+â”Š   â”Š167â”Š          </List>\n+â”Š   â”Š168â”Š        </Style>\n+â”Š   â”Š169â”Š      </Popover>\n+â”Š   â”Š170â”Š    </Style>\n+â”Š   â”Š171â”Š  )\n+â”Š   â”Š172â”Š}\n```\n\n##### Added src&#x2F;components&#x2F;ChatRoomScreen&#x2F;MessageBox.tsx\n```diff\n@@ -0,0 +1,162 @@\n+â”Š   â”Š  1â”Šimport Button from '@material-ui/core/Button'\n+â”Š   â”Š  2â”Šimport SendIcon from '@material-ui/icons/Send'\n+â”Š   â”Š  3â”Šimport { defaultDataIdFromObject } from 'apollo-cache-inmemory'\n+â”Š   â”Š  4â”Šimport gql from 'graphql-tag'\n+â”Š   â”Š  5â”Šimport * as React from 'react'\n+â”Š   â”Š  6â”Šimport { useState } from 'react'\n+â”Š   â”Š  7â”Šimport { useMutation } from 'react-apollo-hooks'\n+â”Š   â”Š  8â”Šimport styled from 'styled-components'\n+â”Š   â”Š  9â”Šimport { time as uniqid } from 'uniqid'\n+â”Š   â”Š 10â”Šimport * as fragments from '../../graphql/fragments'\n+â”Š   â”Š 11â”Šimport { MessageBoxMutation, FullChat, Message } from '../../graphql/types'\n+â”Š   â”Š 12â”Šimport { useMe } from '../../services/auth.service'\n+â”Š   â”Š 13â”Š\n+â”Š   â”Š 14â”Šconst Style = styled.div`\n+â”Š   â”Š 15â”Š  display: flex;\n+â”Š   â”Š 16â”Š  height: 50px;\n+â”Š   â”Š 17â”Š  padding: 5px;\n+â”Š   â”Š 18â”Š  width: calc(100% - 10px);\n+â”Š   â”Š 19â”Š\n+â”Š   â”Š 20â”Š  .MessageBox-input {\n+â”Š   â”Š 21â”Š    width: calc(100% - 50px);\n+â”Š   â”Š 22â”Š    border: none;\n+â”Š   â”Š 23â”Š    border-radius: 999px;\n+â”Š   â”Š 24â”Š    padding: 10px;\n+â”Š   â”Š 25â”Š    padding-left: 20px;\n+â”Š   â”Š 26â”Š    padding-right: 20px;\n+â”Š   â”Š 27â”Š    font-size: 15px;\n+â”Š   â”Š 28â”Š    outline: none;\n+â”Š   â”Š 29â”Š    box-shadow: 0 1px silver;\n+â”Š   â”Š 30â”Š    font-size: 18px;\n+â”Š   â”Š 31â”Š    line-height: 45px;\n+â”Š   â”Š 32â”Š  }\n+â”Š   â”Š 33â”Š\n+â”Š   â”Š 34â”Š  .MessageBox-button {\n+â”Š   â”Š 35â”Š    min-width: 50px;\n+â”Š   â”Š 36â”Š    width: 50px;\n+â”Š   â”Š 37â”Š    border-radius: 999px;\n+â”Š   â”Š 38â”Š    background-color: var(--primary-bg);\n+â”Š   â”Š 39â”Š    margin: 0 5px;\n+â”Š   â”Š 40â”Š    margin-right: 0;\n+â”Š   â”Š 41â”Š    color: white;\n+â”Š   â”Š 42â”Š    padding-left: 20px;\n+â”Š   â”Š 43â”Š    svg {\n+â”Š   â”Š 44â”Š      margin-left: -3px;\n+â”Š   â”Š 45â”Š    }\n+â”Š   â”Š 46â”Š  }\n+â”Š   â”Š 47â”Š`\n+â”Š   â”Š 48â”Š\n+â”Š   â”Š 49â”Šconst mutation = gql`\n+â”Š   â”Š 50â”Š  mutation MessageBoxMutation($chatId: ID!, $content: String!) {\n+â”Š   â”Š 51â”Š    addMessage(chatId: $chatId, content: $content) {\n+â”Š   â”Š 52â”Š      ...Message\n+â”Š   â”Š 53â”Š    }\n+â”Š   â”Š 54â”Š  }\n+â”Š   â”Š 55â”Š  ${fragments.message}\n+â”Š   â”Š 56â”Š`\n+â”Š   â”Š 57â”Š\n+â”Š   â”Š 58â”Šinterface MessageBoxProps {\n+â”Š   â”Š 59â”Š  chatId: string\n+â”Š   â”Š 60â”Š}\n+â”Š   â”Š 61â”Š\n+â”Š   â”Š 62â”Šexport default ({ chatId }: MessageBoxProps) => {\n+â”Š   â”Š 63â”Š  const [message, setMessage] = useState('')\n+â”Š   â”Š 64â”Š  const me = useMe()\n+â”Š   â”Š 65â”Š\n+â”Š   â”Š 66â”Š  const addMessage = useMutation<MessageBoxMutation.Mutation, MessageBoxMutation.Variables>(\n+â”Š   â”Š 67â”Š    mutation,\n+â”Š   â”Š 68â”Š    {\n+â”Š   â”Š 69â”Š      variables: {\n+â”Š   â”Š 70â”Š        chatId,\n+â”Š   â”Š 71â”Š        content: message,\n+â”Š   â”Š 72â”Š      },\n+â”Š   â”Š 73â”Š      optimisticResponse: {\n+â”Š   â”Š 74â”Š        __typename: 'Mutation',\n+â”Š   â”Š 75â”Š        addMessage: {\n+â”Š   â”Š 76â”Š          id: uniqid(),\n+â”Š   â”Š 77â”Š          __typename: 'Message',\n+â”Š   â”Š 78â”Š          chat: {\n+â”Š   â”Š 79â”Š            id: chatId,\n+â”Š   â”Š 80â”Š            __typename: 'Chat',\n+â”Š   â”Š 81â”Š          },\n+â”Š   â”Š 82â”Š          sender: {\n+â”Š   â”Š 83â”Š            id: me.id,\n+â”Š   â”Š 84â”Š            __typename: 'User',\n+â”Š   â”Š 85â”Š            name: me.name,\n+â”Š   â”Š 86â”Š          },\n+â”Š   â”Š 87â”Š          content: message,\n+â”Š   â”Š 88â”Š          createdAt: new Date(),\n+â”Š   â”Š 89â”Š          type: 0,\n+â”Š   â”Š 90â”Š          recipients: [],\n+â”Š   â”Š 91â”Š          ownership: true,\n+â”Š   â”Š 92â”Š        },\n+â”Š   â”Š 93â”Š      },\n+â”Š   â”Š 94â”Š      update: (client, { data: { addMessage } }) => {\n+â”Š   â”Š 95â”Š        client.writeFragment({\n+â”Š   â”Š 96â”Š          id: defaultDataIdFromObject(addMessage),\n+â”Š   â”Š 97â”Š          fragment: fragments.message,\n+â”Š   â”Š 98â”Š          data: addMessage,\n+â”Š   â”Š 99â”Š        })\n+â”Š   â”Š100â”Š\n+â”Š   â”Š101â”Š        let fullChat\n+â”Š   â”Š102â”Š        try {\n+â”Š   â”Š103â”Š          fullChat = client.readFragment<FullChat.Fragment>({\n+â”Š   â”Š104â”Š            id: defaultDataIdFromObject(addMessage.chat),\n+â”Š   â”Š105â”Š            fragment: fragments.fullChat,\n+â”Š   â”Š106â”Š            fragmentName: 'FullChat',\n+â”Š   â”Š107â”Š          })\n+â”Š   â”Š108â”Š        } catch (e) {}\n+â”Š   â”Š109â”Š\n+â”Š   â”Š110â”Š        if (fullChat && !fullChat.messages.some(message => message.id === addMessage.id)) {\n+â”Š   â”Š111â”Š          fullChat.messages.push(addMessage)\n+â”Š   â”Š112â”Š          fullChat.lastMessage = addMessage\n+â”Š   â”Š113â”Š\n+â”Š   â”Š114â”Š          client.writeFragment({\n+â”Š   â”Š115â”Š            id: defaultDataIdFromObject(addMessage.chat),\n+â”Š   â”Š116â”Š            fragment: fragments.fullChat,\n+â”Š   â”Š117â”Š            fragmentName: 'FullChat',\n+â”Š   â”Š118â”Š            data: fullChat,\n+â”Š   â”Š119â”Š          })\n+â”Š   â”Š120â”Š        }\n+â”Š   â”Š121â”Š      },\n+â”Š   â”Š122â”Š    },\n+â”Š   â”Š123â”Š  )\n+â”Š   â”Š124â”Š\n+â”Š   â”Š125â”Š  const onKeyPress = e => {\n+â”Š   â”Š126â”Š    if (e.charCode === 13) {\n+â”Š   â”Š127â”Š      submitMessage()\n+â”Š   â”Š128â”Š    }\n+â”Š   â”Š129â”Š  }\n+â”Š   â”Š130â”Š\n+â”Š   â”Š131â”Š  const onChange = ({ target }) => {\n+â”Š   â”Š132â”Š    setMessage(target.value)\n+â”Š   â”Š133â”Š  }\n+â”Š   â”Š134â”Š\n+â”Š   â”Š135â”Š  const submitMessage = () => {\n+â”Š   â”Š136â”Š    if (!message) return\n+â”Š   â”Š137â”Š\n+â”Š   â”Š138â”Š    addMessage()\n+â”Š   â”Š139â”Š    setMessage('')\n+â”Š   â”Š140â”Š  }\n+â”Š   â”Š141â”Š\n+â”Š   â”Š142â”Š  return (\n+â”Š   â”Š143â”Š    <Style className=\"MessageBox\">\n+â”Š   â”Š144â”Š      <input\n+â”Š   â”Š145â”Š        className=\"MessageBox-input\"\n+â”Š   â”Š146â”Š        type=\"text\"\n+â”Š   â”Š147â”Š        placeholder=\"Type a message\"\n+â”Š   â”Š148â”Š        value={message}\n+â”Š   â”Š149â”Š        onKeyPress={onKeyPress}\n+â”Š   â”Š150â”Š        onChange={onChange}\n+â”Š   â”Š151â”Š      />\n+â”Š   â”Š152â”Š      <Button\n+â”Š   â”Š153â”Š        variant=\"contained\"\n+â”Š   â”Š154â”Š        color=\"primary\"\n+â”Š   â”Š155â”Š        className=\"MessageBox-button\"\n+â”Š   â”Š156â”Š        onClick={submitMessage}\n+â”Š   â”Š157â”Š      >\n+â”Š   â”Š158â”Š        <SendIcon />\n+â”Š   â”Š159â”Š      </Button>\n+â”Š   â”Š160â”Š    </Style>\n+â”Š   â”Š161â”Š  )\n+â”Š   â”Š162â”Š}\n```\n\n##### Added src&#x2F;components&#x2F;ChatRoomScreen&#x2F;MessagesList.tsx\n```diff\n@@ -0,0 +1,144 @@\n+â”Š   â”Š  1â”Šimport gql from 'graphql-tag'\n+â”Š   â”Š  2â”Šimport * as moment from 'moment'\n+â”Š   â”Š  3â”Šimport * as React from 'react'\n+â”Š   â”Š  4â”Šimport { useRef, useEffect } from 'react'\n+â”Š   â”Š  5â”Šimport { useQuery, useMutation } from 'react-apollo-hooks'\n+â”Š   â”Š  6â”Šimport * as ReactDOM from 'react-dom'\n+â”Š   â”Š  7â”Šimport styled from 'styled-components'\n+â”Š   â”Š  8â”Šimport * as fragments from '../../graphql/fragments'\n+â”Š   â”Š  9â”Šimport { MessagesListQuery } from '../../graphql/types'\n+â”Š   â”Š 10â”Š\n+â”Š   â”Š 11â”Šconst Style = styled.div`\n+â”Š   â”Š 12â”Š  display: block;\n+â”Š   â”Š 13â”Š  height: calc(100% - 60px);\n+â”Š   â”Š 14â”Š  width: calc(100% - 30px);\n+â”Š   â”Š 15â”Š  overflow-y: overlay;\n+â”Š   â”Š 16â”Š  padding: 0 15px;\n+â”Š   â”Š 17â”Š\n+â”Š   â”Š 18â”Š  .MessagesList-message {\n+â”Š   â”Š 19â”Š    display: inline-block;\n+â”Š   â”Š 20â”Š    position: relative;\n+â”Š   â”Š 21â”Š    max-width: 100%;\n+â”Š   â”Š 22â”Š    border-radius: 7px;\n+â”Š   â”Š 23â”Š    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.15);\n+â”Š   â”Š 24â”Š    margin-top: 10px;\n+â”Š   â”Š 25â”Š    margin-bottom: 10px;\n+â”Š   â”Š 26â”Š    clear: both;\n+â”Š   â”Š 27â”Š\n+â”Š   â”Š 28â”Š    &::after {\n+â”Š   â”Š 29â”Š      content: '';\n+â”Š   â”Š 30â”Š      display: table;\n+â”Š   â”Š 31â”Š      clear: both;\n+â”Š   â”Š 32â”Š    }\n+â”Š   â”Š 33â”Š  }\n+â”Š   â”Š 34â”Š\n+â”Š   â”Š 35â”Š  .MessagesList-message-mine {\n+â”Š   â”Š 36â”Š    float: right;\n+â”Š   â”Š 37â”Š    background-color: #dcf8c6;\n+â”Š   â”Š 38â”Š\n+â”Š   â”Š 39â”Š    &::before {\n+â”Š   â”Š 40â”Š      right: -11px;\n+â”Š   â”Š 41â”Š      background-image: url(/assets/message-mine.png);\n+â”Š   â”Š 42â”Š    }\n+â”Š   â”Š 43â”Š  }\n+â”Š   â”Š 44â”Š\n+â”Š   â”Š 45â”Š  .MessagesList-message-others {\n+â”Š   â”Š 46â”Š    float: left;\n+â”Š   â”Š 47â”Š    background-color: #fff;\n+â”Š   â”Š 48â”Š\n+â”Š   â”Š 49â”Š    &::before {\n+â”Š   â”Š 50â”Š      left: -11px;\n+â”Š   â”Š 51â”Š      background-image: url(/assets/message-other.png);\n+â”Š   â”Š 52â”Š    }\n+â”Š   â”Š 53â”Š  }\n+â”Š   â”Š 54â”Š\n+â”Š   â”Š 55â”Š  .MessagesList-message-others::before,\n+â”Š   â”Š 56â”Š  .MessagesList-message-mine::before {\n+â”Š   â”Š 57â”Š    content: '';\n+â”Š   â”Š 58â”Š    position: absolute;\n+â”Š   â”Š 59â”Š    bottom: 3px;\n+â”Š   â”Š 60â”Š    width: 12px;\n+â”Š   â”Š 61â”Š    height: 19px;\n+â”Š   â”Š 62â”Š    background-position: 50% 50%;\n+â”Š   â”Š 63â”Š    background-repeat: no-repeat;\n+â”Š   â”Š 64â”Š    background-size: contain;\n+â”Š   â”Š 65â”Š  }\n+â”Š   â”Š 66â”Š\n+â”Š   â”Š 67â”Š  .MessagesList-message-sender {\n+â”Š   â”Š 68â”Š    font-weight: bold;\n+â”Š   â”Š 69â”Š    margin-left: 5px;\n+â”Š   â”Š 70â”Š    margin-top: 5px;\n+â”Š   â”Š 71â”Š  }\n+â”Š   â”Š 72â”Š\n+â”Š   â”Š 73â”Š  .MessagesList-message-contents {\n+â”Š   â”Š 74â”Š    padding: 5px 7px;\n+â”Š   â”Š 75â”Š    word-wrap: break-word;\n+â”Š   â”Š 76â”Š\n+â”Š   â”Š 77â”Š    &::after {\n+â”Š   â”Š 78â”Š      content: ' \\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0';\n+â”Š   â”Š 79â”Š      display: inline;\n+â”Š   â”Š 80â”Š    }\n+â”Š   â”Š 81â”Š  }\n+â”Š   â”Š 82â”Š\n+â”Š   â”Š 83â”Š  .MessagesList-message-timestamp {\n+â”Š   â”Š 84â”Š    position: absolute;\n+â”Š   â”Š 85â”Š    bottom: 2px;\n+â”Š   â”Š 86â”Š    right: 7px;\n+â”Š   â”Š 87â”Š    color: gray;\n+â”Š   â”Š 88â”Š    font-size: 12px;\n+â”Š   â”Š 89â”Š  }\n+â”Š   â”Š 90â”Š`\n+â”Š   â”Š 91â”Š\n+â”Š   â”Š 92â”Šconst query = gql`\n+â”Š   â”Š 93â”Š  query MessagesListQuery($chatId: ID!) {\n+â”Š   â”Š 94â”Š    chat(chatId: $chatId) {\n+â”Š   â”Š 95â”Š      ...FullChat\n+â”Š   â”Š 96â”Š    }\n+â”Š   â”Š 97â”Š  }\n+â”Š   â”Š 98â”Š  ${fragments.fullChat}\n+â”Š   â”Š 99â”Š`\n+â”Š   â”Š100â”Š\n+â”Š   â”Š101â”Šinterface MessagesListProps {\n+â”Š   â”Š102â”Š  chatId: string\n+â”Š   â”Š103â”Š}\n+â”Š   â”Š104â”Š\n+â”Š   â”Š105â”Šexport default ({ chatId }: MessagesListProps) => {\n+â”Š   â”Š106â”Š  const {\n+â”Š   â”Š107â”Š    data: {\n+â”Š   â”Š108â”Š      chat: { messages },\n+â”Š   â”Š109â”Š    },\n+â”Š   â”Š110â”Š  } = useQuery<MessagesListQuery.Query, MessagesListQuery.Variables>(query, {\n+â”Š   â”Š111â”Š    variables: { chatId },\n+â”Š   â”Š112â”Š    suspend: true,\n+â”Š   â”Š113â”Š  })\n+â”Š   â”Š114â”Š  const selfRef = useRef(null)\n+â”Š   â”Š115â”Š\n+â”Š   â”Š116â”Š  const resetScrollTop = () => {\n+â”Š   â”Š117â”Š    if (!selfRef.current) return\n+â”Š   â”Š118â”Š\n+â”Š   â”Š119â”Š    const selfDOMNode = ReactDOM.findDOMNode(selfRef.current) as HTMLElement\n+â”Š   â”Š120â”Š    selfDOMNode.scrollTop = Number.MAX_SAFE_INTEGER\n+â”Š   â”Š121â”Š  }\n+â”Š   â”Š122â”Š\n+â”Š   â”Š123â”Š  useEffect(resetScrollTop, [selfRef.current])\n+â”Š   â”Š124â”Š  useEffect(resetScrollTop, [messages.length])\n+â”Š   â”Š125â”Š\n+â”Š   â”Š126â”Š  return (\n+â”Š   â”Š127â”Š    <Style className={name} ref={selfRef}>\n+â”Š   â”Š128â”Š      {messages &&\n+â”Š   â”Š129â”Š        messages.map(message => (\n+â”Š   â”Š130â”Š          <div\n+â”Š   â”Š131â”Š            key={message.id}\n+â”Š   â”Š132â”Š            className={`MessagesList-message ${\n+â”Š   â”Š133â”Š              message.ownership ? 'MessagesList-message-mine' : 'MessagesList-message-others'\n+â”Š   â”Š134â”Š            }`}\n+â”Š   â”Š135â”Š          >\n+â”Š   â”Š136â”Š            <div className=\"MessagesList-message-contents\">{message.content}</div>\n+â”Š   â”Š137â”Š            <span className=\"MessagesList-message-timestamp\">\n+â”Š   â”Š138â”Š              {moment(message.createdAt).format('HH:mm')}\n+â”Š   â”Š139â”Š            </span>\n+â”Š   â”Š140â”Š          </div>\n+â”Š   â”Š141â”Š        ))}\n+â”Š   â”Š142â”Š    </Style>\n+â”Š   â”Š143â”Š  )\n+â”Š   â”Š144â”Š}\n```\n\n##### Added src&#x2F;components&#x2F;ChatRoomScreen&#x2F;index.tsx\n```diff\n@@ -0,0 +1,56 @@\n+â”Š  â”Š 1â”Šimport * as React from 'react'\n+â”Š  â”Š 2â”Šimport { Suspense } from 'react'\n+â”Š  â”Š 3â”Šimport { RouteComponentProps } from 'react-router-dom'\n+â”Š  â”Š 4â”Šimport styled from 'styled-components'\n+â”Š  â”Š 5â”Šimport Navbar from '../Navbar'\n+â”Š  â”Š 6â”Šimport ChatNavbar from './ChatNavbar'\n+â”Š  â”Š 7â”Šimport MessageBox from './MessageBox'\n+â”Š  â”Š 8â”Šimport MessagesList from './MessagesList'\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Šconst Style = styled.div`\n+â”Š  â”Š11â”Š  .ChatScreen-body {\n+â”Š  â”Š12â”Š    position: relative;\n+â”Š  â”Š13â”Š    background: url(/assets/chat-background.jpg);\n+â”Š  â”Š14â”Š    width: 100%;\n+â”Š  â”Š15â”Š    height: calc(100% - 56px);\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š    .MessagesList {\n+â”Š  â”Š18â”Š      position: absolute;\n+â”Š  â”Š19â”Š      height: calc(100% - 60px);\n+â”Š  â”Š20â”Š      top: 0;\n+â”Š  â”Š21â”Š    }\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Š    .MessageBox {\n+â”Š  â”Š24â”Š      position: absolute;\n+â”Š  â”Š25â”Š      bottom: 0;\n+â”Š  â”Š26â”Š      left: 0;\n+â”Š  â”Š27â”Š    }\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š    .AddChatButton {\n+â”Š  â”Š30â”Š      right: 0;\n+â”Š  â”Š31â”Š      bottom: 0;\n+â”Š  â”Š32â”Š    }\n+â”Š  â”Š33â”Š  }\n+â”Š  â”Š34â”Š`\n+â”Š  â”Š35â”Š\n+â”Š  â”Š36â”Šexport default ({ match, history }: RouteComponentProps) => {\n+â”Š  â”Š37â”Š  const chatId = match.params.chatId\n+â”Š  â”Š38â”Š\n+â”Š  â”Š39â”Š  return (\n+â”Š  â”Š40â”Š    <Style className=\"ChatScreen Screen\">\n+â”Š  â”Š41â”Š      <Navbar>\n+â”Š  â”Š42â”Š        <Suspense fallback={null}>\n+â”Š  â”Š43â”Š          <ChatNavbar chatId={chatId} history={history} />\n+â”Š  â”Š44â”Š        </Suspense>\n+â”Š  â”Š45â”Š      </Navbar>\n+â”Š  â”Š46â”Š      <div className=\"ChatScreen-body\">\n+â”Š  â”Š47â”Š        <Suspense fallback={null}>\n+â”Š  â”Š48â”Š          <MessagesList chatId={chatId} />\n+â”Š  â”Š49â”Š        </Suspense>\n+â”Š  â”Š50â”Š        <Suspense fallback={null}>\n+â”Š  â”Š51â”Š          <MessageBox chatId={chatId} />\n+â”Š  â”Š52â”Š        </Suspense>\n+â”Š  â”Š53â”Š      </div>\n+â”Š  â”Š54â”Š    </Style>\n+â”Š  â”Š55â”Š  )\n+â”Š  â”Š56â”Š}\n```\n\n[}]: #\n\nWe're introduced to new 2 packages in the implementation above:\n\n- [`uniqid`](https://www.npmjs.com/package/uniqid) - Used to generate a unique ID in our optimistic response.\n- [`styled-components`](https://www.npmjs.com/package/styled-components) - Used to create encapsulated style for React components.\n\nLet's install them then:\n\n    $ yarn add uniqid@5.0.3 styled-components@4.1.3\n\nYou'll notice that there's a new fragment called `fullChat`. The full chat includes the base chat details, plus a list of messages that we're gonna view in the chat room screen. Let's define the fragment then:\n\n[{]: <helper> (diffStep 3.1 files=\"src/graphql/fragments\" module=\"client\")\n\n#### [Step 3.1: Add chat room screen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/b2bc092)\n\n##### Added src&#x2F;graphql&#x2F;fragments&#x2F;fullChat.fragment.ts\n```diff\n@@ -0,0 +1,14 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag'\n+â”Š  â”Š 2â”Šimport chat from './chat.fragment'\n+â”Š  â”Š 3â”Šimport message from './message.fragment'\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šexport default gql `\n+â”Š  â”Š 6â”Š  fragment FullChat on Chat {\n+â”Š  â”Š 7â”Š    ...Chat\n+â”Š  â”Š 8â”Š    messages {\n+â”Š  â”Š 9â”Š      ...Message\n+â”Š  â”Š10â”Š    }\n+â”Š  â”Š11â”Š  }\n+â”Š  â”Š12â”Š  ${chat}\n+â”Š  â”Š13â”Š  ${message}\n+â”Š  â”Š14â”Š`\n```\n\n##### Changed src&#x2F;graphql&#x2F;fragments&#x2F;index.ts\n```diff\n@@ -1,3 +1,4 @@\n â”Š1â”Š1â”Šexport { default as chat } from './chat.fragment'\n+â”Š â”Š2â”Šexport { default as fullChat } from './fullChat.fragment'\n â”Š2â”Š3â”Šexport { default as message } from './message.fragment'\n â”Š3â”Š4â”Šexport { default as user } from './user.fragment'\n```\n\n[}]: #\n\nAt this point the chat room should be functional. Let's add a dedicated route for it and make it navigatable by clicking on a chat item from the chats list screen:\n\n[{]: <helper> (diffStep 3.1 files=\"src/App, src/components/ChatsListScreen\" module=\"client\")\n\n#### [Step 3.1: Add chat room screen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/b2bc092)\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -1,5 +1,6 @@\n â”Š1â”Š1â”Šimport * as React from 'react'\n â”Š2â”Š2â”Šimport { BrowserRouter, Route, Redirect } from 'react-router-dom'\n+â”Š â”Š3â”Šimport ChatRoomScreen from './components/ChatRoomScreen'\n â”Š3â”Š4â”Šimport AnimatedSwitch from './components/AnimatedSwitch'\n â”Š4â”Š5â”Šimport AuthScreen from './components/AuthScreen'\n â”Š5â”Š6â”Šimport ChatsListScreen from './components/ChatsListScreen'\n```\n```diff\n@@ -16,6 +17,7 @@\n â”Š16â”Š17â”Š      <Route exact path=\"/sign-(in|up)\" component={AuthScreen} />\n â”Š17â”Š18â”Š      <Route exact path=\"/chats\" component={withAuth(ChatsListScreen)} />\n â”Š18â”Š19â”Š      <Route exact path=\"/settings\" component={withAuth(SettingsScreen)} />\n+â”Š  â”Š20â”Š      <Route exact path=\"/chats/:chatId\" component={withAuth(ChatRoomScreen)} />\n â”Š19â”Š21â”Š      <Route component={RedirectToChats} />\n â”Š20â”Š22â”Š    </AnimatedSwitch>\n â”Š21â”Š23â”Š  </BrowserRouter>\n```\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -1,6 +1,7 @@\n â”Š1â”Š1â”Šimport List from '@material-ui/core/List'\n â”Š2â”Š2â”Šimport ListItem from '@material-ui/core/ListItem'\n â”Š3â”Š3â”Šimport gql from 'graphql-tag'\n+â”Š â”Š4â”Šimport { History } from 'history'\n â”Š4â”Š5â”Šimport * as moment from 'moment'\n â”Š5â”Š6â”Šimport * as React from 'react'\n â”Š6â”Š7â”Šimport { useQuery } from 'react-apollo-hooks'\n```\n```diff\n@@ -71,11 +72,19 @@\n â”Š71â”Š72â”Š  ${fragments.chat}\n â”Š72â”Š73â”Š`\n â”Š73â”Š74â”Š\n-â”Š74â”Š  â”Šexport default () => {\n+â”Š  â”Š75â”Šinterface ChatsListProps {\n+â”Š  â”Š76â”Š  history: History\n+â”Š  â”Š77â”Š}\n+â”Š  â”Š78â”Š\n+â”Š  â”Š79â”Šexport default ({ history }: ChatsListProps) => {\n â”Š75â”Š80â”Š  const {\n â”Š76â”Š81â”Š    data: { chats },\n â”Š77â”Š82â”Š  } = useQuery<ChatsListQuery.Query>(query, { suspend: true })\n â”Š78â”Š83â”Š\n+â”Š  â”Š84â”Š  const navToChat = chatId => {\n+â”Š  â”Š85â”Š    history.push(`chats/${chatId}`)\n+â”Š  â”Š86â”Š  }\n+â”Š  â”Š87â”Š\n â”Š79â”Š88â”Š  return (\n â”Š80â”Š89â”Š    <Style className=\"ChatsList\">\n â”Š81â”Š90â”Š      <List className=\"ChatsList-chats-list\">\n```\n```diff\n@@ -84,6 +93,7 @@\n â”Š84â”Š93â”Š            key={chat.id}\n â”Š85â”Š94â”Š            className=\"ChatsList-chat-item\"\n â”Š86â”Š95â”Š            button\n+â”Š  â”Š96â”Š            onClick={navToChat.bind(null, chat.id)}\n â”Š87â”Š97â”Š          >\n â”Š88â”Š98â”Š            <img\n â”Š89â”Š99â”Š              className=\"ChatsList-profile-pic\"\n```\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;index.tsx\n```diff\n@@ -11,7 +11,7 @@\n â”Š11â”Š11â”Š      <ChatsNavbar history={history} />\n â”Š12â”Š12â”Š    </Navbar>\n â”Š13â”Š13â”Š    <Suspense fallback={null}>\n-â”Š14â”Š  â”Š      <ChatsList />\n+â”Š  â”Š14â”Š      <ChatsList history={history} />\n â”Š15â”Š15â”Š    </Suspense>\n â”Š16â”Š16â”Š  </div>\n â”Š17â”Š17â”Š)\n```\n\n[}]: #\n\nLike we said in the previous step, everything in our application is connected and so whenever there's a mutation or a change in data we should update the cache. Let's define the right subscriptions and update our `cache.service`:\n\n[{]: <helper> (diffStep 3.1 files=\"src/graphql/subscriptions, src/services/cache\" module=\"client\")\n\n#### [Step 3.1: Add chat room screen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/b2bc092)\n\n##### Changed src&#x2F;graphql&#x2F;subscriptions&#x2F;index.ts\n```diff\n@@ -1 +1,2 @@\n â”Š1â”Š1â”Šexport { default as chatUpdated } from './chatUpdated.subscription'\n+â”Š â”Š2â”Šexport { default as messageAdded } from './messageAdded.subscription'\n```\n\n##### Added src&#x2F;graphql&#x2F;subscriptions&#x2F;messageAdded.subscription.ts\n```diff\n@@ -0,0 +1,11 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag'\n+â”Š  â”Š 2â”Šimport * as fragments from '../fragments'\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šexport default gql `\n+â”Š  â”Š 5â”Š  subscription MessageAdded {\n+â”Š  â”Š 6â”Š    messageAdded {\n+â”Š  â”Š 7â”Š      ...Message\n+â”Š  â”Š 8â”Š    }\n+â”Š  â”Š 9â”Š  }\n+â”Š  â”Š10â”Š  ${fragments.message}\n+â”Š  â”Š11â”Š`\n```\n\n##### Changed src&#x2F;services&#x2F;cache.service.tsx\n```diff\n@@ -1,7 +1,8 @@\n â”Š1â”Š1â”Šimport { defaultDataIdFromObject } from 'apollo-cache-inmemory'\n â”Š2â”Š2â”Šimport * as fragments from '../graphql/fragments'\n â”Š3â”Š3â”Šimport * as subscriptions from '../graphql/subscriptions'\n-â”Š4â”Š â”Šimport { ChatUpdated } from '../graphql/types'\n+â”Š â”Š4â”Šimport * as queries from '../graphql/queries'\n+â”Š â”Š5â”Šimport { ChatUpdated, MessageAdded, Message, Chats, FullChat } from '../graphql/types'\n â”Š5â”Š6â”Šimport { useSubscription } from '../polyfills/react-apollo-hooks'\n â”Š6â”Š7â”Š\n â”Š7â”Š8â”Šexport const useSubscriptions = () => {\n```\n```diff\n@@ -15,4 +16,55 @@\n â”Š15â”Š16â”Š      })\n â”Š16â”Š17â”Š    },\n â”Š17â”Š18â”Š  })\n+â”Š  â”Š19â”Š\n+â”Š  â”Š20â”Š  useSubscription<MessageAdded.Subscription>(subscriptions.messageAdded, {\n+â”Š  â”Š21â”Š    onSubscriptionData: ({ client, subscriptionData: { messageAdded } }) => {\n+â”Š  â”Š22â”Š      client.writeFragment<Message.Fragment>({\n+â”Š  â”Š23â”Š        id: defaultDataIdFromObject(messageAdded),\n+â”Š  â”Š24â”Š        fragment: fragments.message,\n+â”Š  â”Š25â”Š        data: messageAdded,\n+â”Š  â”Š26â”Š      })\n+â”Š  â”Š27â”Š\n+â”Š  â”Š28â”Š      let fullChat\n+â”Š  â”Š29â”Š      try {\n+â”Š  â”Š30â”Š        fullChat = client.readFragment<FullChat.Fragment>({\n+â”Š  â”Š31â”Š          id: defaultDataIdFromObject(messageAdded.chat),\n+â”Š  â”Š32â”Š          fragment: fragments.fullChat,\n+â”Š  â”Š33â”Š          fragmentName: 'FullChat',\n+â”Š  â”Š34â”Š        })\n+â”Š  â”Š35â”Š      } catch (e) {}\n+â”Š  â”Š36â”Š\n+â”Š  â”Š37â”Š      if (fullChat && !fullChat.messages.some(message => message.id === messageAdded.id)) {\n+â”Š  â”Š38â”Š        fullChat.messages.push(messageAdded)\n+â”Š  â”Š39â”Š        fullChat.lastMessage = messageAdded\n+â”Š  â”Š40â”Š\n+â”Š  â”Š41â”Š        client.writeFragment({\n+â”Š  â”Š42â”Š          id: defaultDataIdFromObject(fullChat),\n+â”Š  â”Š43â”Š          fragment: fragments.fullChat,\n+â”Š  â”Š44â”Š          fragmentName: 'FullChat',\n+â”Š  â”Š45â”Š          data: fullChat,\n+â”Š  â”Š46â”Š        })\n+â”Š  â”Š47â”Š      }\n+â”Š  â”Š48â”Š\n+â”Š  â”Š49â”Š      let chats\n+â”Š  â”Š50â”Š      try {\n+â”Š  â”Š51â”Š        chats = client.readQuery<Chats.Query>({\n+â”Š  â”Š52â”Š          query: queries.chats,\n+â”Š  â”Š53â”Š        }).chats\n+â”Š  â”Š54â”Š      } catch (e) {}\n+â”Š  â”Š55â”Š\n+â”Š  â”Š56â”Š      if (chats) {\n+â”Š  â”Š57â”Š        const index = chats.findIndex(chat => chat.id === messageAdded.chat.id)\n+â”Š  â”Š58â”Š        const chat = chats[index]\n+â”Š  â”Š59â”Š        chat.lastMessage = messageAdded\n+â”Š  â”Š60â”Š        chats.splice(index, 1)\n+â”Š  â”Š61â”Š        chats.unshift(chat)\n+â”Š  â”Š62â”Š\n+â”Š  â”Š63â”Š        client.writeQuery({\n+â”Š  â”Š64â”Š          query: queries.chats,\n+â”Š  â”Š65â”Š          data: { chats },\n+â”Š  â”Š66â”Š        })\n+â”Š  â”Š67â”Š      }\n+â”Š  â”Š68â”Š    },\n+â”Š  â”Š69â”Š  })\n â”Š18â”Š70â”Š}\n```\n\n[}]: #\n\nWe've already implemented all the necessary subscription handlers in the server in the beginning of this step, so things should work smoothly.\n\nNow we're gonna implement a users list component where we will be able to pick users and chat with them. The users list component is gonna be global to the rest of the components because we will be using it in other screens in the upcoming steps.\n\n[{]: <helper> (diffStep 3.2 files=\"src/components/UsersList\" module=\"client\")\n\n#### [Step 3.2: Add new chat screen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/d0e8364)\n\n##### Added src&#x2F;components&#x2F;UsersList.tsx\n```diff\n@@ -0,0 +1,112 @@\n+â”Š   â”Š  1â”Šimport List from '@material-ui/core/List'\n+â”Š   â”Š  2â”Šimport ListItem from '@material-ui/core/ListItem'\n+â”Š   â”Š  3â”Šimport CheckCircle from '@material-ui/icons/CheckCircle'\n+â”Š   â”Š  4â”Šimport gql from 'graphql-tag'\n+â”Š   â”Š  5â”Šimport * as React from 'react'\n+â”Š   â”Š  6â”Šimport { useState } from 'react'\n+â”Š   â”Š  7â”Šimport { useQuery } from 'react-apollo-hooks'\n+â”Š   â”Š  8â”Šimport styled from 'styled-components'\n+â”Š   â”Š  9â”Šimport * as fragments from '../graphql/fragments'\n+â”Š   â”Š 10â”Šimport { UsersListQuery, User } from '../graphql/types'\n+â”Š   â”Š 11â”Š\n+â”Š   â”Š 12â”Šconst Style = styled.div`\n+â”Š   â”Š 13â”Š  .UsersList-users-list {\n+â”Š   â”Š 14â”Š    padding: 0;\n+â”Š   â”Š 15â”Š  }\n+â”Š   â”Š 16â”Š\n+â”Š   â”Š 17â”Š  .UsersList-user-item {\n+â”Š   â”Š 18â”Š    position: relative;\n+â”Š   â”Š 19â”Š    padding: 7.5px 15px;\n+â”Š   â”Š 20â”Š    display: flex;\n+â”Š   â”Š 21â”Š    ${props => props.selectable && 'cursor: pointer;'}\n+â”Š   â”Š 22â”Š  }\n+â”Š   â”Š 23â”Š\n+â”Š   â”Š 24â”Š  .UsersList-profile-pic {\n+â”Š   â”Š 25â”Š    height: 50px;\n+â”Š   â”Š 26â”Š    width: 50px;\n+â”Š   â”Š 27â”Š    object-fit: cover;\n+â”Š   â”Š 28â”Š    border-radius: 50%;\n+â”Š   â”Š 29â”Š  }\n+â”Š   â”Š 30â”Š\n+â”Š   â”Š 31â”Š  .UsersList-name {\n+â”Š   â”Š 32â”Š    padding-left: 15px;\n+â”Š   â”Š 33â”Š    font-weight: bold;\n+â”Š   â”Š 34â”Š  }\n+â”Š   â”Š 35â”Š\n+â”Š   â”Š 36â”Š  .UsersList-checkmark {\n+â”Š   â”Š 37â”Š    position: absolute;\n+â”Š   â”Š 38â”Š    left: 50px;\n+â”Š   â”Š 39â”Š    top: 35px;\n+â”Š   â”Š 40â”Š    color: var(--secondary-bg);\n+â”Š   â”Š 41â”Š    background-color: white;\n+â”Š   â”Š 42â”Š    border-radius: 50%;\n+â”Š   â”Š 43â”Š  }\n+â”Š   â”Š 44â”Š`\n+â”Š   â”Š 45â”Š\n+â”Š   â”Š 46â”Šconst query = gql`\n+â”Š   â”Š 47â”Š  query UsersListQuery {\n+â”Š   â”Š 48â”Š    users {\n+â”Š   â”Š 49â”Š      ...User\n+â”Š   â”Š 50â”Š    }\n+â”Š   â”Š 51â”Š  }\n+â”Š   â”Š 52â”Š  ${fragments.user}\n+â”Š   â”Š 53â”Š`\n+â”Š   â”Š 54â”Š\n+â”Š   â”Š 55â”Šinterface UsersListProps {\n+â”Š   â”Š 56â”Š  selectable?: boolean\n+â”Š   â”Š 57â”Š  onSelectionChange?: (users: User.Fragment[]) => void\n+â”Š   â”Š 58â”Š  onUserPick?: (user: User.Fragment) => void\n+â”Š   â”Š 59â”Š}\n+â”Š   â”Š 60â”Š\n+â”Š   â”Š 61â”Šexport default (props: UsersListProps) => {\n+â”Š   â”Š 62â”Š  const { selectable, onSelectionChange, onUserPick } = {\n+â”Š   â”Š 63â”Š    selectable: false,\n+â”Š   â”Š 64â”Š    onSelectionChange: () => {},\n+â”Š   â”Š 65â”Š    onUserPick: () => {},\n+â”Š   â”Š 66â”Š    ...props,\n+â”Š   â”Š 67â”Š  }\n+â”Š   â”Š 68â”Š\n+â”Š   â”Š 69â”Š  const [selectedUsers, setSelectedUsers] = useState([])\n+â”Š   â”Š 70â”Š  const {\n+â”Š   â”Š 71â”Š    data: { users },\n+â”Š   â”Š 72â”Š  } = useQuery<UsersListQuery.Query>(query, { suspend: true })\n+â”Š   â”Š 73â”Š\n+â”Š   â”Š 74â”Š  const onListItemClick = user => {\n+â”Š   â”Š 75â”Š    if (!selectable) {\n+â”Š   â”Š 76â”Š      return onUserPick(user)\n+â”Š   â”Š 77â”Š    }\n+â”Š   â”Š 78â”Š\n+â”Š   â”Š 79â”Š    if (selectedUsers.includes(user)) {\n+â”Š   â”Š 80â”Š      const index = selectedUsers.indexOf(user)\n+â”Š   â”Š 81â”Š      selectedUsers.splice(index, 1)\n+â”Š   â”Š 82â”Š    } else {\n+â”Š   â”Š 83â”Š      selectedUsers.push(user)\n+â”Š   â”Š 84â”Š    }\n+â”Š   â”Š 85â”Š\n+â”Š   â”Š 86â”Š    setSelectedUsers(selectedUsers)\n+â”Š   â”Š 87â”Š    onSelectionChange(selectedUsers)\n+â”Š   â”Š 88â”Š  }\n+â”Š   â”Š 89â”Š\n+â”Š   â”Š 90â”Š  return (\n+â”Š   â”Š 91â”Š    <Style className=\"UsersList\" selectable={selectable}>\n+â”Š   â”Š 92â”Š      <List className=\"UsersList-users-list\">\n+â”Š   â”Š 93â”Š        {users.map(user => (\n+â”Š   â”Š 94â”Š          <ListItem\n+â”Š   â”Š 95â”Š            className=\"UsersList-user-item\"\n+â”Š   â”Š 96â”Š            key={user.id}\n+â”Š   â”Š 97â”Š            button\n+â”Š   â”Š 98â”Š            onClick={onListItemClick.bind(null, user)}\n+â”Š   â”Š 99â”Š          >\n+â”Š   â”Š100â”Š            <img\n+â”Š   â”Š101â”Š              className=\"UsersList-profile-pic\"\n+â”Š   â”Š102â”Š              src={user.picture || '/assets/default-profile-pic.jpg'}\n+â”Š   â”Š103â”Š            />\n+â”Š   â”Š104â”Š            <div className=\"UsersList-name\">{user.name}</div>\n+â”Š   â”Š105â”Š\n+â”Š   â”Š106â”Š            {selectedUsers.includes(user) && <CheckCircle className=\"UsersList-checkmark\" />}\n+â”Š   â”Š107â”Š          </ListItem>\n+â”Š   â”Š108â”Š        ))}\n+â”Š   â”Š109â”Š      </List>\n+â”Š   â”Š110â”Š    </Style>\n+â”Š   â”Š111â”Š  )\n+â”Š   â”Š112â”Š}\n```\n\n[}]: #\n\nNow let's implement the new chat screen:\n\n[{]: <helper> (diffStep 3.2 files=\"src/components/NewChatScreen\" module=\"client\")\n\n#### [Step 3.2: Add new chat screen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/d0e8364)\n\n##### Added src&#x2F;components&#x2F;NewChatScreen&#x2F;NewChatNavbar.tsx\n```diff\n@@ -0,0 +1,39 @@\n+â”Š  â”Š 1â”Šimport Button from '@material-ui/core/Button'\n+â”Š  â”Š 2â”Šimport ArrowBackIcon from '@material-ui/icons/ArrowBack'\n+â”Š  â”Š 3â”Šimport { History } from 'history'\n+â”Š  â”Š 4â”Šimport * as React from 'react'\n+â”Š  â”Š 5â”Šimport styled from 'styled-components'\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Šconst Style = styled.div`\n+â”Š  â”Š 8â”Š  padding: 0;\n+â”Š  â”Š 9â”Š  display: flex;\n+â”Š  â”Š10â”Š  flex-direction: row;\n+â”Š  â”Š11â”Š  margin-left: -20px;\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Š  .NewChatNavbar-title {\n+â”Š  â”Š14â”Š    line-height: 56px;\n+â”Š  â”Š15â”Š  }\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š  .NewChatNavbar-back-button {\n+â”Š  â”Š18â”Š    color: var(--primary-text);\n+â”Š  â”Š19â”Š  }\n+â”Š  â”Š20â”Š`\n+â”Š  â”Š21â”Š\n+â”Š  â”Š22â”Šinterface NewChatNavbarProps {\n+â”Š  â”Š23â”Š  history: History\n+â”Š  â”Š24â”Š}\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Šexport default ({ history }: NewChatNavbarProps) => {\n+â”Š  â”Š27â”Š  const navToChats = () => {\n+â”Š  â”Š28â”Š    history.push('/chats')\n+â”Š  â”Š29â”Š  }\n+â”Š  â”Š30â”Š\n+â”Š  â”Š31â”Š  return (\n+â”Š  â”Š32â”Š    <Style className=\"NewChatNavbar\">\n+â”Š  â”Š33â”Š      <Button className=\"NewChatNavbar-back-button\" onClick={navToChats}>\n+â”Š  â”Š34â”Š        <ArrowBackIcon />\n+â”Š  â”Š35â”Š      </Button>\n+â”Š  â”Š36â”Š      <div className=\"NewChatNavbar-title\">New Chat</div>\n+â”Š  â”Š37â”Š    </Style>\n+â”Š  â”Š38â”Š  )\n+â”Š  â”Š39â”Š}\n```\n\n##### Added src&#x2F;components&#x2F;NewChatScreen&#x2F;index.tsx\n```diff\n@@ -0,0 +1,106 @@\n+â”Š   â”Š  1â”Šimport { defaultDataIdFromObject } from 'apollo-cache-inmemory'\n+â”Š   â”Š  2â”Šimport gql from 'graphql-tag'\n+â”Š   â”Š  3â”Šimport * as React from 'react'\n+â”Š   â”Š  4â”Šimport { Suspense } from 'react'\n+â”Š   â”Š  5â”Šimport { useMutation } from 'react-apollo-hooks'\n+â”Š   â”Š  6â”Šimport { RouteComponentProps } from 'react-router-dom'\n+â”Š   â”Š  7â”Šimport styled from 'styled-components'\n+â”Š   â”Š  8â”Šimport { time as uniqid } from 'uniqid'\n+â”Š   â”Š  9â”Šimport * as fragments from '../../graphql/fragments'\n+â”Š   â”Š 10â”Šimport * as queries from '../../graphql/queries'\n+â”Š   â”Š 11â”Šimport { Chats } from '../../graphql/types'\n+â”Š   â”Š 12â”Šimport { NewChatScreenMutation } from '../../graphql/types'\n+â”Š   â”Š 13â”Šimport { useMe } from '../../services/auth.service'\n+â”Š   â”Š 14â”Šimport Navbar from '../Navbar'\n+â”Š   â”Š 15â”Šimport UsersList from '../UsersList'\n+â”Š   â”Š 16â”Šimport NewChatNavbar from './NewChatNavbar'\n+â”Š   â”Š 17â”Š\n+â”Š   â”Š 18â”Šconst Style = styled.div`\n+â”Š   â”Š 19â”Š  .UsersList {\n+â”Š   â”Š 20â”Š    height: calc(100% - 56px);\n+â”Š   â”Š 21â”Š  }\n+â”Š   â”Š 22â”Š\n+â”Š   â”Š 23â”Š  .NewChatScreen-users-list {\n+â”Š   â”Š 24â”Š    height: calc(100% - 56px);\n+â”Š   â”Š 25â”Š    overflow-y: overlay;\n+â”Š   â”Š 26â”Š  }\n+â”Š   â”Š 27â”Š`\n+â”Š   â”Š 28â”Š\n+â”Š   â”Š 29â”Šconst mutation = gql`\n+â”Š   â”Š 30â”Š  mutation NewChatScreenMutation($userId: ID!) {\n+â”Š   â”Š 31â”Š    addChat(userId: $userId) {\n+â”Š   â”Š 32â”Š      ...Chat\n+â”Š   â”Š 33â”Š    }\n+â”Š   â”Š 34â”Š  }\n+â”Š   â”Š 35â”Š  ${fragments.chat}\n+â”Š   â”Š 36â”Š`\n+â”Š   â”Š 37â”Š\n+â”Š   â”Š 38â”Šexport default ({ history }: RouteComponentProps) => {\n+â”Š   â”Š 39â”Š  const me = useMe()\n+â”Š   â”Š 40â”Š\n+â”Š   â”Š 41â”Š  const addChat = useMutation<NewChatScreenMutation.Mutation, NewChatScreenMutation.Variables>(\n+â”Š   â”Š 42â”Š    mutation,\n+â”Š   â”Š 43â”Š    {\n+â”Š   â”Š 44â”Š      update: (client, { data: { addChat } }) => {\n+â”Š   â”Š 45â”Š        client.writeFragment({\n+â”Š   â”Š 46â”Š          id: defaultDataIdFromObject(addChat),\n+â”Š   â”Š 47â”Š          fragment: fragments.chat,\n+â”Š   â”Š 48â”Š          fragmentName: 'Chat',\n+â”Š   â”Š 49â”Š          data: addChat,\n+â”Š   â”Š 50â”Š        })\n+â”Š   â”Š 51â”Š\n+â”Š   â”Š 52â”Š        let chats\n+â”Š   â”Š 53â”Š        try {\n+â”Š   â”Š 54â”Š          chats = client.readQuery<Chats.Query>({\n+â”Š   â”Š 55â”Š            query: queries.chats,\n+â”Š   â”Š 56â”Š          }).chats\n+â”Š   â”Š 57â”Š        } catch (e) {}\n+â”Š   â”Š 58â”Š\n+â”Š   â”Š 59â”Š        if (chats && !chats.some(chat => chat.id === addChat.id)) {\n+â”Š   â”Š 60â”Š          chats.unshift(addChat)\n+â”Š   â”Š 61â”Š\n+â”Š   â”Š 62â”Š          client.writeQuery({\n+â”Š   â”Š 63â”Š            query: queries.chats,\n+â”Š   â”Š 64â”Š            data: { chats },\n+â”Š   â”Š 65â”Š          })\n+â”Š   â”Š 66â”Š        }\n+â”Š   â”Š 67â”Š      },\n+â”Š   â”Š 68â”Š    },\n+â”Š   â”Š 69â”Š  )\n+â”Š   â”Š 70â”Š\n+â”Š   â”Š 71â”Š  const onUserPick = user => {\n+â”Š   â”Š 72â”Š    addChat({\n+â”Š   â”Š 73â”Š      optimisticResponse: {\n+â”Š   â”Š 74â”Š        __typename: 'Mutation',\n+â”Š   â”Š 75â”Š        addChat: {\n+â”Š   â”Š 76â”Š          __typename: 'Chat',\n+â”Š   â”Š 77â”Š          id: uniqid(),\n+â”Š   â”Š 78â”Š          name: user.name,\n+â”Š   â”Š 79â”Š          picture: user.picture,\n+â”Š   â”Š 80â”Š          allTimeMembers: [],\n+â”Š   â”Š 81â”Š          owner: me,\n+â”Š   â”Š 82â”Š          isGroup: false,\n+â”Š   â”Š 83â”Š          lastMessage: null,\n+â”Š   â”Š 84â”Š        },\n+â”Š   â”Š 85â”Š      },\n+â”Š   â”Š 86â”Š      variables: {\n+â”Š   â”Š 87â”Š        userId: user.id,\n+â”Š   â”Š 88â”Š      },\n+â”Š   â”Š 89â”Š    }).then(({ data: { addChat } }) => {\n+â”Š   â”Š 90â”Š      history.push(`/chats/${addChat.id}`)\n+â”Š   â”Š 91â”Š    })\n+â”Š   â”Š 92â”Š  }\n+â”Š   â”Š 93â”Š\n+â”Š   â”Š 94â”Š  return (\n+â”Š   â”Š 95â”Š    <Style className=\"NewChatScreen Screen\">\n+â”Š   â”Š 96â”Š      <Navbar>\n+â”Š   â”Š 97â”Š        <NewChatNavbar history={history} />\n+â”Š   â”Š 98â”Š      </Navbar>\n+â”Š   â”Š 99â”Š      <div className=\"NewChatScreen-users-list\">\n+â”Š   â”Š100â”Š        <Suspense fallback={null}>\n+â”Š   â”Š101â”Š          <UsersList onUserPick={onUserPick} />\n+â”Š   â”Š102â”Š        </Suspense>\n+â”Š   â”Š103â”Š      </div>\n+â”Š   â”Š104â”Š    </Style>\n+â”Š   â”Š105â”Š  )\n+â”Š   â”Š106â”Š}\n```\n\n[}]: #\n\nAnd implement a dedicated route for it:\n\n[{]: <helper> (diffStep 3.2 files=\"src/App\" module=\"client\")\n\n#### [Step 3.2: Add new chat screen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/d0e8364)\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -1,6 +1,7 @@\n â”Š1â”Š1â”Šimport * as React from 'react'\n â”Š2â”Š2â”Šimport { BrowserRouter, Route, Redirect } from 'react-router-dom'\n â”Š3â”Š3â”Šimport ChatRoomScreen from './components/ChatRoomScreen'\n+â”Š â”Š4â”Šimport NewChatScreen from './components/NewChatScreen'\n â”Š4â”Š5â”Šimport AnimatedSwitch from './components/AnimatedSwitch'\n â”Š5â”Š6â”Šimport AuthScreen from './components/AuthScreen'\n â”Š6â”Š7â”Šimport ChatsListScreen from './components/ChatsListScreen'\n```\n```diff\n@@ -18,6 +19,7 @@\n â”Š18â”Š19â”Š      <Route exact path=\"/chats\" component={withAuth(ChatsListScreen)} />\n â”Š19â”Š20â”Š      <Route exact path=\"/settings\" component={withAuth(SettingsScreen)} />\n â”Š20â”Š21â”Š      <Route exact path=\"/chats/:chatId\" component={withAuth(ChatRoomScreen)} />\n+â”Š  â”Š22â”Š      <Route exact path=\"/new-chat\" component={withAuth(NewChatScreen)} />\n â”Š21â”Š23â”Š      <Route component={RedirectToChats} />\n â”Š22â”Š24â”Š    </AnimatedSwitch>\n â”Š23â”Š25â”Š  </BrowserRouter>\n```\n\n[}]: #\n\nWe will also add a button which will redirect us right to the new chat screen:\n\n[{]: <helper> (diffStep 3.2 files=\"src/components/ChatsListScreen\" module=\"client\")\n\n#### [Step 3.2: Add new chat screen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/d0e8364)\n\n##### Added src&#x2F;components&#x2F;ChatsListScreen&#x2F;AddChatButton.tsx\n```diff\n@@ -0,0 +1,38 @@\n+â”Š  â”Š 1â”Šimport Button from '@material-ui/core/Button'\n+â”Š  â”Š 2â”Šimport ChatIcon from '@material-ui/icons/Chat'\n+â”Š  â”Š 3â”Šimport { History } from 'history'\n+â”Š  â”Š 4â”Šimport * as React from 'react'\n+â”Š  â”Š 5â”Šimport styled from 'styled-components'\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Šconst Style = styled.div`\n+â”Š  â”Š 8â”Š  position: fixed;\n+â”Š  â”Š 9â”Š  right: 10px;\n+â”Š  â”Š10â”Š  bottom: 10px;\n+â”Š  â”Š11â”Š\n+â”Š  â”Š12â”Š  button {\n+â”Š  â”Š13â”Š    min-width: 50px;\n+â”Š  â”Š14â”Š    width: 50px;\n+â”Š  â”Š15â”Š    height: 50px;\n+â”Š  â”Š16â”Š    border-radius: 999px;\n+â”Š  â”Š17â”Š    background-color: var(--secondary-bg);\n+â”Š  â”Š18â”Š    color: white;\n+â”Š  â”Š19â”Š  }\n+â”Š  â”Š20â”Š`\n+â”Š  â”Š21â”Š\n+â”Š  â”Š22â”Šinterface AddChatButtonProps {\n+â”Š  â”Š23â”Š  history: History\n+â”Š  â”Š24â”Š}\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Šexport default ({ history }: AddChatButtonProps) => {\n+â”Š  â”Š27â”Š  const onClick = () => {\n+â”Š  â”Š28â”Š    history.push('/new-chat')\n+â”Š  â”Š29â”Š  }\n+â”Š  â”Š30â”Š\n+â”Š  â”Š31â”Š  return (\n+â”Š  â”Š32â”Š    <Style className=\"AddChatButton\">\n+â”Š  â”Š33â”Š      <Button variant=\"contained\" color=\"secondary\" onClick={onClick}>\n+â”Š  â”Š34â”Š        <ChatIcon />\n+â”Š  â”Š35â”Š      </Button>\n+â”Š  â”Š36â”Š    </Style>\n+â”Š  â”Š37â”Š  )\n+â”Š  â”Š38â”Š}\n```\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;index.tsx\n```diff\n@@ -2,6 +2,7 @@\n â”Š2â”Š2â”Šimport { Suspense } from 'react'\n â”Š3â”Š3â”Šimport { RouteComponentProps } from 'react-router-dom'\n â”Š4â”Š4â”Šimport Navbar from '../Navbar'\n+â”Š â”Š5â”Šimport AddChatButton from './AddChatButton'\n â”Š5â”Š6â”Šimport ChatsList from './ChatsList'\n â”Š6â”Š7â”Šimport ChatsNavbar from './ChatsNavbar'\n â”Š7â”Š8â”Š\n```\n```diff\n@@ -13,5 +14,6 @@\n â”Š13â”Š14â”Š    <Suspense fallback={null}>\n â”Š14â”Š15â”Š      <ChatsList history={history} />\n â”Š15â”Š16â”Š    </Suspense>\n+â”Š  â”Š17â”Š    <AddChatButton history={history} />\n â”Š16â”Š18â”Š  </div>\n â”Š17â”Š19â”Š)\n```\n\n[}]: #\n\nAgain, we will need to define the right subscriptions and update the cache accordingly:\n\n[{]: <helper> (diffStep 3.2 files=\"src/graphql/queries, src/graphql/subscriptions, src/services/cache\" module=\"client\")\n\n#### [Step 3.2: Add new chat screen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/d0e8364)\n\n##### Changed src&#x2F;graphql&#x2F;queries&#x2F;index.ts\n```diff\n@@ -1,2 +1,3 @@\n â”Š1â”Š1â”Šexport { default as chats } from './chats.query'\n+â”Š â”Š2â”Šexport { default as users } from './users.query'\n â”Š2â”Š3â”Šexport { default as me } from './me.query'\n```\n\n##### Added src&#x2F;graphql&#x2F;queries&#x2F;users.query.ts\n```diff\n@@ -0,0 +1,11 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag'\n+â”Š  â”Š 2â”Šimport * as fragments from '../fragments'\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šexport default gql `\n+â”Š  â”Š 5â”Š  query Users {\n+â”Š  â”Š 6â”Š    users {\n+â”Š  â”Š 7â”Š      ...User\n+â”Š  â”Š 8â”Š    }\n+â”Š  â”Š 9â”Š  }\n+â”Š  â”Š10â”Š  ${fragments.user}\n+â”Š  â”Š11â”Š`\n```\n\n##### Added src&#x2F;graphql&#x2F;subscriptions&#x2F;chatAdded.subscription.ts\n```diff\n@@ -0,0 +1,11 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag'\n+â”Š  â”Š 2â”Šimport * as fragments from '../fragments'\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šexport default gql `\n+â”Š  â”Š 5â”Š  subscription ChatAdded {\n+â”Š  â”Š 6â”Š    chatAdded {\n+â”Š  â”Š 7â”Š      ...Chat\n+â”Š  â”Š 8â”Š    }\n+â”Š  â”Š 9â”Š  }\n+â”Š  â”Š10â”Š  ${fragments.chat}\n+â”Š  â”Š11â”Š`\n```\n\n##### Changed src&#x2F;graphql&#x2F;subscriptions&#x2F;index.ts\n```diff\n@@ -1,2 +1,5 @@\n â”Š1â”Š1â”Šexport { default as chatUpdated } from './chatUpdated.subscription'\n â”Š2â”Š2â”Šexport { default as messageAdded } from './messageAdded.subscription'\n+â”Š â”Š3â”Šexport { default as chatAdded } from './chatAdded.subscription'\n+â”Š â”Š4â”Šexport { default as userAdded } from './userAdded.subscription'\n+â”Š â”Š5â”Šexport { default as userUpdated } from './userUpdated.subscription'\n```\n\n##### Added src&#x2F;graphql&#x2F;subscriptions&#x2F;userAdded.subscription.ts\n```diff\n@@ -0,0 +1,11 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag'\n+â”Š  â”Š 2â”Šimport * as fragments from '../fragments'\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šexport default gql `\n+â”Š  â”Š 5â”Š  subscription UserAdded {\n+â”Š  â”Š 6â”Š    userAdded {\n+â”Š  â”Š 7â”Š      ...User\n+â”Š  â”Š 8â”Š    }\n+â”Š  â”Š 9â”Š  }\n+â”Š  â”Š10â”Š  ${fragments.user}\n+â”Š  â”Š11â”Š`\n```\n\n##### Added src&#x2F;graphql&#x2F;subscriptions&#x2F;userUpdated.subscription.ts\n```diff\n@@ -0,0 +1,11 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag'\n+â”Š  â”Š 2â”Šimport * as fragments from '../fragments'\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šexport default gql `\n+â”Š  â”Š 5â”Š  subscription UserUpdated {\n+â”Š  â”Š 6â”Š    userUpdated {\n+â”Š  â”Š 7â”Š      ...User\n+â”Š  â”Š 8â”Š    }\n+â”Š  â”Š 9â”Š  }\n+â”Š  â”Š10â”Š  ${fragments.user}\n+â”Š  â”Š11â”Š`\n```\n\n##### Changed src&#x2F;services&#x2F;cache.service.tsx\n```diff\n@@ -2,10 +2,48 @@\n â”Š 2â”Š 2â”Šimport * as fragments from '../graphql/fragments'\n â”Š 3â”Š 3â”Šimport * as subscriptions from '../graphql/subscriptions'\n â”Š 4â”Š 4â”Šimport * as queries from '../graphql/queries'\n-â”Š 5â”Š  â”Šimport { ChatUpdated, MessageAdded, Message, Chats, FullChat } from '../graphql/types'\n+â”Š  â”Š 5â”Šimport {\n+â”Š  â”Š 6â”Š  ChatUpdated,\n+â”Š  â”Š 7â”Š  MessageAdded,\n+â”Š  â”Š 8â”Š  Message,\n+â”Š  â”Š 9â”Š  Chats,\n+â”Š  â”Š10â”Š  FullChat,\n+â”Š  â”Š11â”Š  User,\n+â”Š  â”Š12â”Š  Users,\n+â”Š  â”Š13â”Š  UserAdded,\n+â”Š  â”Š14â”Š  UserUpdated,\n+â”Š  â”Š15â”Š  ChatAdded,\n+â”Š  â”Š16â”Š} from '../graphql/types'\n â”Š 6â”Š17â”Šimport { useSubscription } from '../polyfills/react-apollo-hooks'\n â”Š 7â”Š18â”Š\n â”Š 8â”Š19â”Šexport const useSubscriptions = () => {\n+â”Š  â”Š20â”Š  useSubscription<ChatAdded.Subscription>(subscriptions.chatAdded, {\n+â”Š  â”Š21â”Š    onSubscriptionData: ({ client, subscriptionData: { chatAdded } }) => {\n+â”Š  â”Š22â”Š      client.writeFragment({\n+â”Š  â”Š23â”Š        id: defaultDataIdFromObject(chatAdded),\n+â”Š  â”Š24â”Š        fragment: fragments.chat,\n+â”Š  â”Š25â”Š        fragmentName: 'Chat',\n+â”Š  â”Š26â”Š        data: chatAdded,\n+â”Š  â”Š27â”Š      })\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š      let chats\n+â”Š  â”Š30â”Š      try {\n+â”Š  â”Š31â”Š        chats = client.readQuery<Chats.Query>({\n+â”Š  â”Š32â”Š          query: queries.chats,\n+â”Š  â”Š33â”Š        }).chats\n+â”Š  â”Š34â”Š      } catch (e) {}\n+â”Š  â”Š35â”Š\n+â”Š  â”Š36â”Š      if (chats && !chats.some(chat => chat.id === chatAdded.id)) {\n+â”Š  â”Š37â”Š        chats.unshift(chatAdded)\n+â”Š  â”Š38â”Š\n+â”Š  â”Š39â”Š        client.writeQuery({\n+â”Š  â”Š40â”Š          query: queries.chats,\n+â”Š  â”Š41â”Š          data: { chats },\n+â”Š  â”Š42â”Š        })\n+â”Š  â”Š43â”Š      }\n+â”Š  â”Š44â”Š    },\n+â”Š  â”Š45â”Š  })\n+â”Š  â”Š46â”Š\n â”Š 9â”Š47â”Š  useSubscription<ChatUpdated.Subscription>(subscriptions.chatUpdated, {\n â”Š10â”Š48â”Š    onSubscriptionData: ({ client, subscriptionData: { chatUpdated } }) => {\n â”Š11â”Š49â”Š      client.writeFragment({\n```\n```diff\n@@ -67,4 +105,40 @@\n â”Š 67â”Š105â”Š      }\n â”Š 68â”Š106â”Š    },\n â”Š 69â”Š107â”Š  })\n+â”Š   â”Š108â”Š\n+â”Š   â”Š109â”Š  useSubscription<UserAdded.Subscription>(subscriptions.userAdded, {\n+â”Š   â”Š110â”Š    onSubscriptionData: ({ client, subscriptionData: { userAdded } }) => {\n+â”Š   â”Š111â”Š      client.writeFragment({\n+â”Š   â”Š112â”Š        id: defaultDataIdFromObject(userAdded),\n+â”Š   â”Š113â”Š        fragment: fragments.user,\n+â”Š   â”Š114â”Š        data: userAdded,\n+â”Š   â”Š115â”Š      })\n+â”Š   â”Š116â”Š\n+â”Š   â”Š117â”Š      let users\n+â”Š   â”Š118â”Š      try {\n+â”Š   â”Š119â”Š        users = client.readQuery<Users.Query>({\n+â”Š   â”Š120â”Š          query: queries.users,\n+â”Š   â”Š121â”Š        }).users\n+â”Š   â”Š122â”Š      } catch (e) {}\n+â”Š   â”Š123â”Š\n+â”Š   â”Š124â”Š      if (users && !users.some(user => user.id === userAdded.id)) {\n+â”Š   â”Š125â”Š        users.push(userAdded)\n+â”Š   â”Š126â”Š\n+â”Š   â”Š127â”Š        client.writeQuery({\n+â”Š   â”Š128â”Š          query: queries.users,\n+â”Š   â”Š129â”Š          data: { users },\n+â”Š   â”Š130â”Š        })\n+â”Š   â”Š131â”Š      }\n+â”Š   â”Š132â”Š    },\n+â”Š   â”Š133â”Š  })\n+â”Š   â”Š134â”Š\n+â”Š   â”Š135â”Š  useSubscription<UserUpdated.Subscription>(subscriptions.userUpdated, {\n+â”Š   â”Š136â”Š    onSubscriptionData: ({ client, subscriptionData: { userUpdated } }) => {\n+â”Š   â”Š137â”Š      client.writeFragment({\n+â”Š   â”Š138â”Š        id: defaultDataIdFromObject(userUpdated),\n+â”Š   â”Š139â”Š        fragment: fragments.user,\n+â”Š   â”Š140â”Š        data: userUpdated,\n+â”Š   â”Š141â”Š      })\n+â”Š   â”Š142â”Š    },\n+â”Š   â”Š143â”Š  })\n â”Š 70â”Š144â”Š}\n```\n\n[}]: #\n\nNow we have a real, functional chat app! Where we have a complete flow of:\n\n- Signing in/up.\n- Editing profile.\n- Creating and removing chats.\n- Sending messages.\n\nIn the next step we will to something slightly more complex and extend the current functionality by adding a group chatting feature where we will be able to communicate with multiple users in a single chat room."
          },
          {
            "manualTitle": "Step 4: Bonus! Group chatting",
            "stepRevision": "945f273800bc59579a8ce801d694187ee5cc334c",
            "manualView": "Group messaging can be quite tricky and so I would like to explain the hierarchy between the entities. `Chat` will have the following fields:\n\n- `Chat.actualGroupMembers` - The current users who are currently participating in the group. Once a message was sent by someone in the group, all the members under `actualGroupMembers` will be notified with the target message.\n\n- `Chat.listingMembers` - The current users which have the chat listed in their view. Any user who will be kicked out of the group will not only be absent from `Chat.actualGroupMembers`, but it will also be spliced from `Chat.listingMembers`, as its existence in the chat is correlated to what it can currently view.\n\n- `Chat.admins` - The users who currently control the group; they will have permissions to add and remove users from the group, and change its name and picture.\n\nTogether we can have a complete flow where users can chat with each-other in a group. In this step we will add a group-details screen, where we will be able to see the participants of the group, and we will use the existing users list component to select users that we would like to participate in our group chat. The back-end should include a new mutation called `addGroup()` that will help use create chat group.\n\nSo before we proceed to the front-end, let's take care of the back-end. We will add the missing fields to the Chat entity, and make the necessary adjustments in existing resolvers:\n\n[{]: <helper> (diffStep 4.1 module=\"server\")\n\n#### Step 4.1: Add group-related fields to Chat type\n\n##### Changed entity&#x2F;chat.ts\n```diff\n@@ -16,6 +16,8 @@\n â”Š16â”Š16â”Š  picture?: string\n â”Š17â”Š17â”Š  allTimeMembers?: User[]\n â”Š18â”Š18â”Š  listingMembers?: User[]\n+â”Š  â”Š19â”Š  actualGroupMembers?: User[]\n+â”Š  â”Š20â”Š  admins?: User[]\n â”Š19â”Š21â”Š  owner?: User\n â”Š20â”Š22â”Š  messages?: Message[]\n â”Š21â”Š23â”Š}\n```\n```diff\n@@ -48,6 +50,14 @@\n â”Š48â”Š50â”Š  @JoinTable()\n â”Š49â”Š51â”Š  listingMembers: User[]\n â”Š50â”Š52â”Š\n+â”Š  â”Š53â”Š  @ManyToMany(type => User, user => user.actualGroupMemberChats, { cascade: [\"insert\", \"update\"], eager: false })\n+â”Š  â”Š54â”Š  @JoinTable()\n+â”Š  â”Š55â”Š  actualGroupMembers?: User[]\n+â”Š  â”Š56â”Š\n+â”Š  â”Š57â”Š  @ManyToMany(type => User, user => user.adminChats, { cascade: [\"insert\", \"update\"], eager: false })\n+â”Š  â”Š58â”Š  @JoinTable()\n+â”Š  â”Š59â”Š  admins?: User[]\n+â”Š  â”Š60â”Š\n â”Š51â”Š61â”Š  @ManyToOne(type => User, user => user.ownerChats, { cascade: ['insert', 'update'], eager: false })\n â”Š52â”Š62â”Š  owner?: User | null\n â”Š53â”Š63â”Š\n```\n```diff\n@@ -62,6 +72,8 @@\n â”Š62â”Š72â”Š    picture,\n â”Š63â”Š73â”Š    allTimeMembers,\n â”Š64â”Š74â”Š    listingMembers,\n+â”Š  â”Š75â”Š    actualGroupMembers,\n+â”Š  â”Š76â”Š    admins,\n â”Š65â”Š77â”Š    owner,\n â”Š66â”Š78â”Š    messages,\n â”Š67â”Š79â”Š  }: ChatConstructor = {}) {\n```\n```diff\n@@ -74,6 +86,12 @@\n â”Š74â”Š86â”Š    if (allTimeMembers) {\n â”Š75â”Š87â”Š      this.allTimeMembers = allTimeMembers\n â”Š76â”Š88â”Š    }\n+â”Š  â”Š89â”Š    if (actualGroupMembers) {\n+â”Š  â”Š90â”Š      this.actualGroupMembers = actualGroupMembers\n+â”Š  â”Š91â”Š    }\n+â”Š  â”Š92â”Š    if (admins) {\n+â”Š  â”Š93â”Š      this.admins = admins\n+â”Š  â”Š94â”Š    }\n â”Š77â”Š95â”Š    if (listingMembers) {\n â”Š78â”Š96â”Š      this.listingMembers = listingMembers\n â”Š79â”Š97â”Š    }\n```\n\n##### Changed entity&#x2F;user.ts\n```diff\n@@ -33,6 +33,12 @@\n â”Š33â”Š33â”Š  @ManyToMany(type => Chat, chat => chat.listingMembers)\n â”Š34â”Š34â”Š  listingMemberChats: Chat[]\n â”Š35â”Š35â”Š\n+â”Š  â”Š36â”Š  @ManyToMany(type => Chat, chat => chat.actualGroupMembers)\n+â”Š  â”Š37â”Š  actualGroupMemberChats: Chat[]\n+â”Š  â”Š38â”Š\n+â”Š  â”Š39â”Š  @ManyToMany(type => Chat, chat => chat.admins)\n+â”Š  â”Š40â”Š  adminChats: Chat[]\n+â”Š  â”Š41â”Š\n â”Š36â”Š42â”Š  @ManyToMany(type => Message, message => message.holders)\n â”Š37â”Š43â”Š  holderMessages: Message[]\n â”Š38â”Š44â”Š\n```\n\n##### Changed modules&#x2F;chat&#x2F;providers&#x2F;chat.provider.ts\n```diff\n@@ -157,6 +157,27 @@\n â”Š157â”Š157â”Š      .getMany()\n â”Š158â”Š158â”Š  }\n â”Š159â”Š159â”Š\n+â”Š   â”Š160â”Š  getChatActualGroupMembers(chat: Chat) {\n+â”Š   â”Š161â”Š    return this.userProvider\n+â”Š   â”Š162â”Š      .createQueryBuilder()\n+â”Š   â”Š163â”Š      .innerJoin(\n+â”Š   â”Š164â”Š        'user.actualGroupMemberChats',\n+â”Š   â”Š165â”Š        'actualGroupMemberChats',\n+â”Š   â”Š166â”Š        'actualGroupMemberChats.id = :chatId',\n+â”Š   â”Š167â”Š        { chatId: chat.id },\n+â”Š   â”Š168â”Š      )\n+â”Š   â”Š169â”Š      .getMany();\n+â”Š   â”Š170â”Š  }\n+â”Š   â”Š171â”Š\n+â”Š   â”Š172â”Š  getChatAdmins(chat: Chat) {\n+â”Š   â”Š173â”Š    return this.userProvider\n+â”Š   â”Š174â”Š      .createQueryBuilder()\n+â”Š   â”Š175â”Š      .innerJoin('user.adminChats', 'adminChats', 'adminChats.id = :chatId', {\n+â”Š   â”Š176â”Š        chatId: chat.id,\n+â”Š   â”Š177â”Š      })\n+â”Š   â”Š178â”Š      .getMany();\n+â”Š   â”Š179â”Š  }\n+â”Š   â”Š180â”Š\n â”Š160â”Š181â”Š  async getChatOwner(chat: Chat) {\n â”Š161â”Š182â”Š    const owner = await this.userProvider\n â”Š162â”Š183â”Š      .createQueryBuilder()\n```\n```diff\n@@ -168,6 +189,10 @@\n â”Š168â”Š189â”Š    return owner || null\n â”Š169â”Š190â”Š  }\n â”Š170â”Š191â”Š\n+â”Š   â”Š192â”Š  async isChatGroup(chat: Chat) {\n+â”Š   â”Š193â”Š    return !!chat.name;\n+â”Š   â”Š194â”Š  }\n+â”Š   â”Š195â”Š\n â”Š171â”Š196â”Š  async filterChatAddedOrUpdated(chatAddedOrUpdated: Chat, creatorOrUpdaterId: string) {\n â”Š172â”Š197â”Š    return (\n â”Š173â”Š198â”Š      creatorOrUpdaterId !== this.currentUser.id &&\n```\n```diff\n@@ -221,6 +246,8 @@\n â”Š221â”Š246â”Š    const chat = await this.createQueryBuilder()\n â”Š222â”Š247â”Š      .whereInIds(Number(chatId))\n â”Š223â”Š248â”Š      .innerJoinAndSelect('chat.listingMembers', 'listingMembers')\n+â”Š   â”Š249â”Š      .leftJoinAndSelect('chat.actualGroupMembers', 'actualGroupMembers')\n+â”Š   â”Š250â”Š      .leftJoinAndSelect('chat.admins', 'admins')\n â”Š224â”Š251â”Š      .leftJoinAndSelect('chat.owner', 'owner')\n â”Š225â”Š252â”Š      .getOne();\n â”Š226â”Š253â”Š\n```\n```diff\n@@ -242,7 +269,18 @@\n â”Š242â”Š269â”Š        // Delete the chat\n â”Š243â”Š270â”Š        await this.repository.remove(chat);\n â”Š244â”Š271â”Š      } else {\n-â”Š245â”Š   â”Š        // Update the chat\n+â”Š   â”Š272â”Š        // Update the group\n+â”Š   â”Š273â”Š\n+â”Š   â”Š274â”Š        // Remove the current user from the chat members. He is no longer a member of the group\n+â”Š   â”Š275â”Š        chat.actualGroupMembers = chat.actualGroupMembers && chat.actualGroupMembers.filter(user =>\n+â”Š   â”Š276â”Š          user.id !== this.currentUser.id\n+â”Š   â”Š277â”Š        );\n+â”Š   â”Š278â”Š        // Remove the current user from the chat admins\n+â”Š   â”Š279â”Š        chat.admins = chat.admins && chat.admins.filter(user => user.id !== this.currentUser.id);\n+â”Š   â”Š280â”Š        // If there are no more admins left the group goes read only\n+â”Š   â”Š281â”Š        // A null owner means the group is read-only\n+â”Š   â”Š282â”Š        chat.owner = chat.admins && chat.admins[0] || null;\n+â”Š   â”Š283â”Š\n â”Š246â”Š284â”Š        await this.repository.save(chat);\n â”Š247â”Š285â”Š      }\n â”Š248â”Š286â”Š\n```\n\n##### Changed modules&#x2F;chat&#x2F;resolvers&#x2F;resolvers.ts\n```diff\n@@ -38,6 +38,9 @@\n â”Š38â”Š38â”Š      injector.get(ChatProvider).getChatAllTimeMembers(chat),\n â”Š39â”Š39â”Š    listingMembers: (chat, args, { injector }) =>\n â”Š40â”Š40â”Š      injector.get(ChatProvider).getChatListingMembers(chat),\n+â”Š  â”Š41â”Š    actualGroupMembers: (chat, args, { injector }) => injector.get(ChatProvider).getChatActualGroupMembers(chat),\n+â”Š  â”Š42â”Š    admins: (chat, args, { injector }) => injector.get(ChatProvider).getChatAdmins(chat),\n â”Š41â”Š43â”Š    owner: (chat, args, { injector }) => injector.get(ChatProvider).getChatOwner(chat),\n+â”Š  â”Š44â”Š    isGroup: (chat, args, { injector }) => injector.get(ChatProvider).isChatGroup(chat),\n â”Š42â”Š45â”Š  },\n â”Š43â”Š46â”Š} as IResolvers\n```\n\n##### Changed modules&#x2F;chat&#x2F;schema&#x2F;typeDefs.graphql\n```diff\n@@ -19,8 +19,14 @@\n â”Š19â”Š19â”Š  allTimeMembers: [User!]!\n â”Š20â”Š20â”Š  #Whoever gets the chat listed. For groups includes past members who still didn't delete the group.\n â”Š21â”Š21â”Š  listingMembers: [User!]!\n+â”Š  â”Š22â”Š  #Actual members of the group. Null for chats. For groups they are the only ones who can send messages. They aren't the only ones who get the group listed.\n+â”Š  â”Š23â”Š  actualGroupMembers: [User!]\n+â”Š  â”Š24â”Š  #Null for chats\n+â”Š  â”Š25â”Š  admins: [User!]\n â”Š22â”Š26â”Š  #If null the group is read-only. Null for chats.\n â”Š23â”Š27â”Š  owner: User\n+â”Š  â”Š28â”Š  #Computed property\n+â”Š  â”Š29â”Š  isGroup: Boolean!\n â”Š24â”Š30â”Š}\n â”Š25â”Š31â”Š\n â”Š26â”Š32â”Štype Mutation {\n```\n\n##### Changed modules&#x2F;message&#x2F;providers&#x2F;message.provider.ts\n```diff\n@@ -36,6 +36,7 @@\n â”Š36â”Š36â”Š      .whereInIds(chatId)\n â”Š37â”Š37â”Š      .innerJoinAndSelect('chat.allTimeMembers', 'allTimeMembers')\n â”Š38â”Š38â”Š      .innerJoinAndSelect('chat.listingMembers', 'listingMembers')\n+â”Š  â”Š39â”Š      .leftJoinAndSelect('chat.actualGroupMembers', 'actualGroupMembers')\n â”Š39â”Š40â”Š      .getOne();\n â”Š40â”Š41â”Š\n â”Š41â”Š42â”Š    if (!chat) {\n```\n```diff\n@@ -71,8 +72,12 @@\n â”Š71â”Š72â”Š\n â”Š72â”Š73â”Š      holders = chat.listingMembers;\n â”Š73â”Š74â”Š    } else {\n-â”Š74â”Š  â”Š      // TODO: Implement for groups\n-â”Š75â”Š  â”Š      holders = chat.listingMembers\n+â”Š  â”Š75â”Š      // Group\n+â”Š  â”Š76â”Š      if (!chat.actualGroupMembers || !chat.actualGroupMembers.find(user => user.id === this.currentUser.id)) {\n+â”Š  â”Š77â”Š        throw new Error(`The user is not a member of the group ${chatId}. Cannot add message.`);\n+â”Š  â”Š78â”Š      }\n+â”Š  â”Š79â”Š\n+â”Š  â”Š80â”Š      holders = chat.actualGroupMembers;\n â”Š76â”Š81â”Š    }\n â”Š77â”Š82â”Š\n â”Š78â”Š83â”Š    const message = await this.repository.save(new Message({\n```\n```diff\n@@ -324,15 +329,31 @@\n â”Š324â”Š329â”Š  }\n â”Š325â”Š330â”Š\n â”Š326â”Š331â”Š  async filterMessageAdded(messageAdded: Message) {\n-â”Š327â”Š   â”Š    const relevantUsers = (await this.userProvider\n-â”Š328â”Š   â”Š      .createQueryBuilder()\n-â”Š329â”Š   â”Š      .innerJoin(\n-â”Š330â”Š   â”Š        'user.listingMemberChats',\n-â”Š331â”Š   â”Š        'listingMemberChats',\n-â”Š332â”Š   â”Š        'listingMemberChats.id = :chatId',\n-â”Š333â”Š   â”Š        { chatId: messageAdded.chat.id }\n-â”Š334â”Š   â”Š      )\n-â”Š335â”Š   â”Š      .getMany()).filter(user => user.id != messageAdded.sender.id)\n+â”Š   â”Š332â”Š    let relevantUsers: User[]\n+â”Š   â”Š333â”Š\n+â”Š   â”Š334â”Š    if (!messageAdded.chat.name) {\n+â”Š   â”Š335â”Š      // Chat\n+â”Š   â”Š336â”Š      relevantUsers = (await this.userProvider\n+â”Š   â”Š337â”Š        .createQueryBuilder()\n+â”Š   â”Š338â”Š        .innerJoin(\n+â”Š   â”Š339â”Š          'user.listingMemberChats',\n+â”Š   â”Š340â”Š          'listingMemberChats',\n+â”Š   â”Š341â”Š          'listingMemberChats.id = :chatId',\n+â”Š   â”Š342â”Š          { chatId: messageAdded.chat.id }\n+â”Š   â”Š343â”Š        )\n+â”Š   â”Š344â”Š        .getMany()).filter(user => user.id != messageAdded.sender.id)\n+â”Š   â”Š345â”Š    } else {\n+â”Š   â”Š346â”Š      // Group\n+â”Š   â”Š347â”Š      relevantUsers = (await this.userProvider\n+â”Š   â”Š348â”Š        .createQueryBuilder()\n+â”Š   â”Š349â”Š        .innerJoin(\n+â”Š   â”Š350â”Š          'user.actualGroupMemberChats',\n+â”Š   â”Š351â”Š          'actualGroupMemberChats',\n+â”Š   â”Š352â”Š          'actualGroupMemberChats.id = :chatId',\n+â”Š   â”Š353â”Š          { chatId: messageAdded.chat.id }\n+â”Š   â”Š354â”Š        )\n+â”Š   â”Š355â”Š        .getMany()).filter(user => user.id != messageAdded.sender.id)\n+â”Š   â”Š356â”Š    }\n â”Š336â”Š357â”Š\n â”Š337â”Š358â”Š    return relevantUsers.some(user => user.id === this.currentUser.id)\n â”Š338â”Š359â”Š  }\n```\n\n[}]: #\n\nNow we will add 2 new mutations:\n\n- `addGroup` mutation - Responsible for creating chat groups.\n- `updateChat` mutation - Unlike a single chat which is synced with a user's info, a group chat will be independent, therefore we will need a method that could updated its fields.\n\nLet's implement those:\n\n[{]: <helper> (diffStep 4.2 module=\"server\")\n\n#### Step 4.2: Add group related mutations\n\n##### Changed modules&#x2F;chat&#x2F;providers&#x2F;chat.provider.ts\n```diff\n@@ -305,4 +305,83 @@\n â”Š305â”Š305â”Š      return chatId;\n â”Š306â”Š306â”Š    }\n â”Š307â”Š307â”Š  }\n+â”Š   â”Š308â”Š\n+â”Š   â”Š309â”Š  async addGroup(\n+â”Š   â”Š310â”Š    userIds: string[],\n+â”Š   â”Š311â”Š    {\n+â”Š   â”Š312â”Š      groupName,\n+â”Š   â”Š313â”Š      groupPicture,\n+â”Š   â”Š314â”Š    }: {\n+â”Š   â”Š315â”Š      groupName?: string\n+â”Š   â”Š316â”Š      groupPicture?: string\n+â”Š   â”Š317â”Š    } = {},\n+â”Š   â”Š318â”Š  ) {\n+â”Š   â”Š319â”Š    let users: User[] = [];\n+â”Š   â”Š320â”Š    for (let userId of userIds) {\n+â”Š   â”Š321â”Š      const user = await this.userProvider\n+â”Š   â”Š322â”Š        .createQueryBuilder()\n+â”Š   â”Š323â”Š        .whereInIds(userId)\n+â”Š   â”Š324â”Š        .getOne();\n+â”Š   â”Š325â”Š\n+â”Š   â”Š326â”Š      if (!user) {\n+â”Š   â”Š327â”Š        throw new Error(`User ${userId} doesn't exist.`);\n+â”Š   â”Š328â”Š      }\n+â”Š   â”Š329â”Š\n+â”Š   â”Š330â”Š      users.push(user);\n+â”Š   â”Š331â”Š    }\n+â”Š   â”Š332â”Š\n+â”Š   â”Š333â”Š    const chat = await this.repository.save(\n+â”Š   â”Š334â”Š      new Chat({\n+â”Š   â”Š335â”Š        name: groupName,\n+â”Š   â”Š336â”Š        admins: [this.currentUser],\n+â”Š   â”Š337â”Š        picture: groupPicture || undefined,\n+â”Š   â”Š338â”Š        owner: this.currentUser,\n+â”Š   â”Š339â”Š        allTimeMembers: [...users, this.currentUser],\n+â”Š   â”Š340â”Š        listingMembers: [...users, this.currentUser],\n+â”Š   â”Š341â”Š        actualGroupMembers: [...users, this.currentUser],\n+â”Š   â”Š342â”Š      }),\n+â”Š   â”Š343â”Š    );\n+â”Š   â”Š344â”Š\n+â”Š   â”Š345â”Š    this.pubsub.publish('chatAdded', {\n+â”Š   â”Š346â”Š      creatorId: this.currentUser.id,\n+â”Š   â”Š347â”Š      chatAdded: chat,\n+â”Š   â”Š348â”Š    });\n+â”Š   â”Š349â”Š\n+â”Š   â”Š350â”Š    return chat || null;\n+â”Š   â”Š351â”Š  }\n+â”Š   â”Š352â”Š\n+â”Š   â”Š353â”Š  async updateGroup(\n+â”Š   â”Š354â”Š    chatId: string,\n+â”Š   â”Š355â”Š    {\n+â”Š   â”Š356â”Š      groupName,\n+â”Š   â”Š357â”Š      groupPicture,\n+â”Š   â”Š358â”Š    }: {\n+â”Š   â”Š359â”Š      groupName?: string\n+â”Š   â”Š360â”Š      groupPicture?: string\n+â”Š   â”Š361â”Š    } = {},\n+â”Š   â”Š362â”Š  ) {\n+â”Š   â”Š363â”Š    const chat = await this.createQueryBuilder()\n+â”Š   â”Š364â”Š      .whereInIds(chatId)\n+â”Š   â”Š365â”Š      .getOne();\n+â”Š   â”Š366â”Š\n+â”Š   â”Š367â”Š    if (!chat) return null;\n+â”Š   â”Š368â”Š    if (!chat.name) return chat;\n+â”Š   â”Š369â”Š\n+â”Š   â”Š370â”Š    groupName = groupName || chat.name;\n+â”Š   â”Š371â”Š    groupPicture = groupPicture || chat.picture;\n+â”Š   â”Š372â”Š    Object.assign(chat, {\n+â”Š   â”Š373â”Š      name: groupName,\n+â”Š   â”Š374â”Š      picture: groupPicture,\n+â”Š   â”Š375â”Š    });\n+â”Š   â”Š376â”Š\n+â”Š   â”Š377â”Š    // Update the chat\n+â”Š   â”Š378â”Š    await this.repository.save(chat);\n+â”Š   â”Š379â”Š\n+â”Š   â”Š380â”Š    this.pubsub.publish('chatUpdated', {\n+â”Š   â”Š381â”Š      updaterId: this.currentUser.id,\n+â”Š   â”Š382â”Š      chatUpdated: chat,\n+â”Š   â”Š383â”Š    });\n+â”Š   â”Š384â”Š\n+â”Š   â”Š385â”Š    return chat || null;\n+â”Š   â”Š386â”Š  }\n â”Š308â”Š387â”Š}\n```\n\n##### Changed modules&#x2F;chat&#x2F;resolvers&#x2F;resolvers.ts\n```diff\n@@ -16,6 +16,15 @@\n â”Š16â”Š16â”Š    }),\n â”Š17â”Š17â”Š    addChat: (obj, { userId }, { injector }) => injector.get(ChatProvider).addChat(userId),\n â”Š18â”Š18â”Š    removeChat: (obj, { chatId }, { injector }) => injector.get(ChatProvider).removeChat(chatId),\n+â”Š  â”Š19â”Š    addGroup: (obj, { userIds, groupName, groupPicture }, { injector }) =>\n+â”Š  â”Š20â”Š      injector.get(ChatProvider).addGroup(userIds, {\n+â”Š  â”Š21â”Š        groupName: groupName || '',\n+â”Š  â”Š22â”Š        groupPicture: groupPicture || '',\n+â”Š  â”Š23â”Š      }),\n+â”Š  â”Š24â”Š    updateGroup: (obj, { chatId, groupName, groupPicture }, { injector }) => injector.get(ChatProvider).updateGroup(chatId, {\n+â”Š  â”Š25â”Š      groupName: groupName || '',\n+â”Š  â”Š26â”Š      groupPicture: groupPicture || '',\n+â”Š  â”Š27â”Š    }),\n â”Š19â”Š28â”Š  },\n â”Š20â”Š29â”Š  Subscription: {\n â”Š21â”Š30â”Š    chatAdded: {\n```\n\n##### Changed modules&#x2F;chat&#x2F;schema&#x2F;typeDefs.graphql\n```diff\n@@ -32,4 +32,10 @@\n â”Š32â”Š32â”Štype Mutation {\n â”Š33â”Š33â”Š  addChat(userId: ID!): Chat\n â”Š34â”Š34â”Š  removeChat(chatId: ID!): ID\n+â”Š  â”Š35â”Š  addAdmins(groupId: ID!, userIds: [ID!]!): [ID]!\n+â”Š  â”Š36â”Š  removeAdmins(groupId: ID!, userIds: [ID!]!): [ID]!\n+â”Š  â”Š37â”Š  addMembers(groupId: ID!, userIds: [ID!]!): [ID]!\n+â”Š  â”Š38â”Š  removeMembers(groupId: ID!, userIds: [ID!]!): [ID]!\n+â”Š  â”Š39â”Š  addGroup(userIds: [ID!]!, groupName: String!, groupPicture: String): Chat\n+â”Š  â”Š40â”Š  updateGroup(chatId: ID!, groupName: String, groupPicture: String): Chat\n â”Š35â”Š41â”Š}\n```\n\n[}]: #\n\nNow that the back-end is set, we will need to update the chat fragment in the client to contain the new field `isGroup`:\n\n[{]: <helper> (diffStep 4.1 module=\"client\")\n\n#### [Step 4.1: Update chat fragment](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/f33f04b)\n\n##### Changed src&#x2F;graphql&#x2F;fragments&#x2F;chat.fragment.ts\n```diff\n@@ -17,6 +17,7 @@\n â”Š17â”Š17â”Š    lastMessage {\n â”Š18â”Š18â”Š      ...Message\n â”Š19â”Š19â”Š    }\n+â”Š  â”Š20â”Š    isGroup\n â”Š20â”Š21â”Š  }\n â”Š21â”Š22â”Š  ${message}\n â”Š22â”Š23â”Š`\n```\n\n[}]: #\n\nNow we will create the new-group screen. Like the new-chat screen, it will have an almost identical layout, only the behavior is gonna be slightly different. In the new screen we will be able to select multiple users before we proceed, then, we should be able to view the group details and edit them before we create the group. Let's implement the new-group screen:\n\n[{]: <helper> (diffStep 4.2 files=\"src/components/NewGroupScreen\" module=\"client\")\n\n#### [Step 4.2: Add new group screen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/90f5f5b)\n\n##### Added src&#x2F;components&#x2F;NewGroupScreen&#x2F;CreateGroupButton.tsx\n```diff\n@@ -0,0 +1,42 @@\n+â”Š  â”Š 1â”Šimport Button from '@material-ui/core/Button'\n+â”Š  â”Š 2â”Šimport AddIcon from '@material-ui/icons/Add'\n+â”Š  â”Š 3â”Šimport { History } from 'history'\n+â”Š  â”Š 4â”Šimport * as React from 'react'\n+â”Š  â”Š 5â”Šimport styled from 'styled-components'\n+â”Š  â”Š 6â”Šimport { User } from '../../graphql/types'\n+â”Š  â”Š 7â”Š\n+â”Š  â”Š 8â”Šconst Style = styled.div`\n+â”Š  â”Š 9â”Š  position: fixed;\n+â”Š  â”Š10â”Š  right: 10px;\n+â”Š  â”Š11â”Š  bottom: 10px;\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Š  button {\n+â”Š  â”Š14â”Š    min-width: 50px;\n+â”Š  â”Š15â”Š    width: 50px;\n+â”Š  â”Š16â”Š    height: 50px;\n+â”Š  â”Š17â”Š    border-radius: 999px;\n+â”Š  â”Š18â”Š    background-color: var(--secondary-bg);\n+â”Š  â”Š19â”Š    color: white;\n+â”Š  â”Š20â”Š  }\n+â”Š  â”Š21â”Š`\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Šinterface CreateGroupButtonProps {\n+â”Š  â”Š24â”Š  history: History\n+â”Š  â”Š25â”Š  users: User.Fragment[]\n+â”Š  â”Š26â”Š}\n+â”Š  â”Š27â”Š\n+â”Š  â”Š28â”Šexport default ({ history, users }: CreateGroupButtonProps) => {\n+â”Š  â”Š29â”Š  const onClick = () => {\n+â”Š  â”Š30â”Š    history.push('/new-chat/group/details', {\n+â”Š  â”Š31â”Š      users,\n+â”Š  â”Š32â”Š    })\n+â”Š  â”Š33â”Š  }\n+â”Š  â”Š34â”Š\n+â”Š  â”Š35â”Š  return (\n+â”Š  â”Š36â”Š    <Style className=\"CreateGroupButton\">\n+â”Š  â”Š37â”Š      <Button variant=\"contained\" color=\"secondary\" onClick={onClick}>\n+â”Š  â”Š38â”Š        <AddIcon />\n+â”Š  â”Š39â”Š      </Button>\n+â”Š  â”Š40â”Š    </Style>\n+â”Š  â”Š41â”Š  )\n+â”Š  â”Š42â”Š}\n```\n\n##### Added src&#x2F;components&#x2F;NewGroupScreen&#x2F;NewGroupNavbar.tsx\n```diff\n@@ -0,0 +1,39 @@\n+â”Š  â”Š 1â”Šimport Button from '@material-ui/core/Button'\n+â”Š  â”Š 2â”Šimport ArrowBackIcon from '@material-ui/icons/ArrowBack'\n+â”Š  â”Š 3â”Šimport { History } from 'history'\n+â”Š  â”Š 4â”Šimport * as React from 'react'\n+â”Š  â”Š 5â”Šimport styled from 'styled-components'\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Šconst Style = styled.div`\n+â”Š  â”Š 8â”Š  padding: 0;\n+â”Š  â”Š 9â”Š  display: flex;\n+â”Š  â”Š10â”Š  flex-direction: row;\n+â”Š  â”Š11â”Š  margin-left: -20px;\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Š  .NewGroupNavbar-title {\n+â”Š  â”Š14â”Š    line-height: 56px;\n+â”Š  â”Š15â”Š  }\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š  .NewGroupNavbar-back-button {\n+â”Š  â”Š18â”Š    color: var(--primary-text);\n+â”Š  â”Š19â”Š  }\n+â”Š  â”Š20â”Š`\n+â”Š  â”Š21â”Š\n+â”Š  â”Š22â”Šinterface NewGroupNavbarProps {\n+â”Š  â”Š23â”Š  history: History\n+â”Š  â”Š24â”Š}\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Šexport default ({ history }: NewGroupNavbarProps) => {\n+â”Š  â”Š27â”Š  const navToChats = () => {\n+â”Š  â”Š28â”Š    history.push('/new-chat')\n+â”Š  â”Š29â”Š  }\n+â”Š  â”Š30â”Š\n+â”Š  â”Š31â”Š  return (\n+â”Š  â”Š32â”Š    <Style className=\"NewGroupNavbar\">\n+â”Š  â”Š33â”Š      <Button className=\"NewGroupNavbar-back-button\" onClick={navToChats}>\n+â”Š  â”Š34â”Š        <ArrowBackIcon />\n+â”Š  â”Š35â”Š      </Button>\n+â”Š  â”Š36â”Š      <div className=\"NewGroupNavbar-title\">New Chat Group</div>\n+â”Š  â”Š37â”Š    </Style>\n+â”Š  â”Š38â”Š  )\n+â”Š  â”Š39â”Š}\n```\n\n##### Added src&#x2F;components&#x2F;NewGroupScreen&#x2F;index.tsx\n```diff\n@@ -0,0 +1,32 @@\n+â”Š  â”Š 1â”Šimport * as React from 'react'\n+â”Š  â”Š 2â”Šimport { useState, Suspense } from 'react'\n+â”Š  â”Š 3â”Šimport { RouteComponentProps } from 'react-router-dom'\n+â”Š  â”Š 4â”Šimport styled from 'styled-components'\n+â”Š  â”Š 5â”Šimport Navbar from '../Navbar'\n+â”Š  â”Š 6â”Šimport UsersList from '../UsersList'\n+â”Š  â”Š 7â”Šimport CreateGroupButton from './CreateGroupButton'\n+â”Š  â”Š 8â”Šimport NewGroupNavbar from './NewGroupNavbar'\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Šconst Style = styled.div`\n+â”Š  â”Š11â”Š  .UsersList {\n+â”Š  â”Š12â”Š    height: calc(100% - 56px);\n+â”Š  â”Š13â”Š    overflow-y: overlay;\n+â”Š  â”Š14â”Š  }\n+â”Š  â”Š15â”Š`\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Šexport default ({ history }: RouteComponentProps) => {\n+â”Š  â”Š18â”Š  const [selectedUsers, setSelectedUsers] = useState([])\n+â”Š  â”Š19â”Š\n+â”Š  â”Š20â”Š  return (\n+â”Š  â”Š21â”Š    <Style className=\"NewGroupScreen Screen\">\n+â”Š  â”Š22â”Š      <Navbar>\n+â”Š  â”Š23â”Š        <NewGroupNavbar history={history} />\n+â”Š  â”Š24â”Š      </Navbar>\n+â”Š  â”Š25â”Š      <Suspense fallback={null}>\n+â”Š  â”Š26â”Š        <UsersList selectable onSelectionChange={setSelectedUsers} />\n+â”Š  â”Š27â”Š      </Suspense>\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š      {!!selectedUsers.length && <CreateGroupButton history={history} users={selectedUsers} />}\n+â”Š  â”Š30â”Š    </Style>\n+â”Š  â”Š31â”Š  )\n+â”Š  â”Š32â”Š}\n```\n\n[}]: #\n\nNow we will add a dedicated route, and we will also create a \"New Group\" button which will be presented in the new chat screen. This way we can create a new group from the new chat screen if we want to, by simply clicking on that button and moving on to the new group screen.\n\n[{]: <helper> (diffStep 4.2 files=\"src/App, src/components/NewChatScreen\" module=\"client\")\n\n#### [Step 4.2: Add new group screen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/90f5f5b)\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -6,6 +6,7 @@\n â”Š 6â”Š 6â”Šimport AuthScreen from './components/AuthScreen'\n â”Š 7â”Š 7â”Šimport ChatsListScreen from './components/ChatsListScreen'\n â”Š 8â”Š 8â”Šimport SettingsScreen from './components/SettingsScreen'\n+â”Š  â”Š 9â”Šimport NewGroupScreen from './components/NewGroupScreen'\n â”Š 9â”Š10â”Šimport { withAuth } from './services/auth.service'\n â”Š10â”Š11â”Š\n â”Š11â”Š12â”Šconst RedirectToChats = () => (\n```\n```diff\n@@ -20,6 +21,7 @@\n â”Š20â”Š21â”Š      <Route exact path=\"/settings\" component={withAuth(SettingsScreen)} />\n â”Š21â”Š22â”Š      <Route exact path=\"/chats/:chatId\" component={withAuth(ChatRoomScreen)} />\n â”Š22â”Š23â”Š      <Route exact path=\"/new-chat\" component={withAuth(NewChatScreen)} />\n+â”Š  â”Š24â”Š      <Route exact path=\"/new-chat/group\" component={withAuth(NewGroupScreen)} />\n â”Š23â”Š25â”Š      <Route component={RedirectToChats} />\n â”Š24â”Š26â”Š    </AnimatedSwitch>\n â”Š25â”Š27â”Š  </BrowserRouter>\n```\n\n##### Added src&#x2F;components&#x2F;NewChatScreen&#x2F;NewGroupButton.tsx\n```diff\n@@ -0,0 +1,59 @@\n+â”Š  â”Š 1â”Šimport Button from '@material-ui/core/Button'\n+â”Š  â”Š 2â”Šimport GroupAddIcon from '@material-ui/icons/GroupAdd'\n+â”Š  â”Š 3â”Šimport { History } from 'history'\n+â”Š  â”Š 4â”Šimport * as React from 'react'\n+â”Š  â”Š 5â”Šimport styled from 'styled-components'\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Šconst Style = styled.div`\n+â”Š  â”Š 8â”Š  display: flex;\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Š  button {\n+â”Š  â”Š11â”Š    border-radius: 0;\n+â”Š  â”Š12â”Š    text-transform: none;\n+â”Š  â”Š13â”Š    font-size: inherit;\n+â”Š  â”Š14â”Š    width: 100%;\n+â”Š  â”Š15â”Š    justify-content: flex-start;\n+â”Š  â”Š16â”Š    padding-left: 15px;\n+â”Š  â”Š17â”Š    padding-right: 15px;\n+â”Š  â”Š18â”Š\n+â”Š  â”Š19â”Š    svg {\n+â”Š  â”Š20â”Š      font-size: 30px;\n+â”Š  â”Š21â”Š      margin-top: 10px;\n+â”Š  â”Š22â”Š    }\n+â”Š  â”Š23â”Š  }\n+â”Š  â”Š24â”Š\n+â”Š  â”Š25â”Š  .NewGroupButton-icon {\n+â”Š  â”Š26â”Š    height: 50px;\n+â”Š  â”Š27â”Š    width: 50px;\n+â”Š  â”Š28â”Š    object-fit: cover;\n+â”Š  â”Š29â”Š    border-radius: 50%;\n+â”Š  â”Š30â”Š    color: white;\n+â”Š  â”Š31â”Š    background-color: var(--secondary-bg);\n+â”Š  â”Š32â”Š  }\n+â”Š  â”Š33â”Š\n+â”Š  â”Š34â”Š  .NewGroupButton-title {\n+â”Š  â”Š35â”Š    padding-left: 15px;\n+â”Š  â”Š36â”Š    font-weight: bold;\n+â”Š  â”Š37â”Š  }\n+â”Š  â”Š38â”Š`\n+â”Š  â”Š39â”Š\n+â”Š  â”Š40â”Šinterface NewGroupButtonProps {\n+â”Š  â”Š41â”Š  history: History\n+â”Š  â”Š42â”Š}\n+â”Š  â”Š43â”Š\n+â”Š  â”Š44â”Šexport default ({ history }: NewGroupButtonProps) => {\n+â”Š  â”Š45â”Š  const navToGroup = () => {\n+â”Š  â”Š46â”Š    history.push('/new-chat/group')\n+â”Š  â”Š47â”Š  }\n+â”Š  â”Š48â”Š\n+â”Š  â”Š49â”Š  return (\n+â”Š  â”Š50â”Š    <Style>\n+â”Š  â”Š51â”Š      <Button onClick={navToGroup}>\n+â”Š  â”Š52â”Š        <div className=\"NewGroupButton-icon\">\n+â”Š  â”Š53â”Š          <GroupAddIcon />\n+â”Š  â”Š54â”Š        </div>\n+â”Š  â”Š55â”Š        <div className=\"NewGroupButton-title\">New Group</div>\n+â”Š  â”Š56â”Š      </Button>\n+â”Š  â”Š57â”Š    </Style>\n+â”Š  â”Š58â”Š  )\n+â”Š  â”Š59â”Š}\n```\n\n##### Changed src&#x2F;components&#x2F;NewChatScreen&#x2F;index.tsx\n```diff\n@@ -14,6 +14,7 @@\n â”Š14â”Š14â”Šimport Navbar from '../Navbar'\n â”Š15â”Š15â”Šimport UsersList from '../UsersList'\n â”Š16â”Š16â”Šimport NewChatNavbar from './NewChatNavbar'\n+â”Š  â”Š17â”Šimport NewGroupButton from './NewGroupButton'\n â”Š17â”Š18â”Š\n â”Š18â”Š19â”Šconst Style = styled.div`\n â”Š19â”Š20â”Š  .UsersList {\n```\n```diff\n@@ -97,6 +98,7 @@\n â”Š 97â”Š 98â”Š        <NewChatNavbar history={history} />\n â”Š 98â”Š 99â”Š      </Navbar>\n â”Š 99â”Š100â”Š      <div className=\"NewChatScreen-users-list\">\n+â”Š   â”Š101â”Š        <NewGroupButton history={history} />\n â”Š100â”Š102â”Š        <Suspense fallback={null}>\n â”Š101â”Š103â”Š          <UsersList onUserPick={onUserPick} />\n â”Š102â”Š104â”Š        </Suspense>\n```\n\n[}]: #\n\nUp-next would be the group details screen. The layout consists of:\n\n- A navbar with a back button.\n- Picture and name inputs.\n- A horizontal list of all the participants.\n- A \"complete\" button that will send a mutation request to the server.\n\nOnce a name has been typed, the \"complete\" button should pop-up. Let's implement the screen then:\n\n[{]: <helper> (diffStep 4.3 files=\"src/components/GroupDetailsScreen\" module=\"client\")\n\n#### [Step 4.3: Add group details screen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/b9b7c3f)\n\n##### Added src&#x2F;components&#x2F;GroupDetailsScreen&#x2F;CompleteGroupButton.tsx\n```diff\n@@ -0,0 +1,114 @@\n+â”Š   â”Š  1â”Šimport Button from '@material-ui/core/Button'\n+â”Š   â”Š  2â”Šimport ArrowRightIcon from '@material-ui/icons/ArrowRightAlt'\n+â”Š   â”Š  3â”Šimport { defaultDataIdFromObject } from 'apollo-cache-inmemory'\n+â”Š   â”Š  4â”Šimport gql from 'graphql-tag'\n+â”Š   â”Š  5â”Šimport { History } from 'history'\n+â”Š   â”Š  6â”Šimport * as React from 'react'\n+â”Š   â”Š  7â”Šimport { useMutation } from 'react-apollo-hooks'\n+â”Š   â”Š  8â”Šimport styled from 'styled-components'\n+â”Š   â”Š  9â”Šimport { time as uniqid } from 'uniqid'\n+â”Š   â”Š 10â”Šimport * as fragments from '../../graphql/fragments'\n+â”Š   â”Š 11â”Šimport * as queries from '../../graphql/queries'\n+â”Š   â”Š 12â”Šimport { Chats, User, CompleteGroupButtonMutation } from '../../graphql/types'\n+â”Š   â”Š 13â”Šimport { useMe } from '../../services/auth.service'\n+â”Š   â”Š 14â”Š\n+â”Š   â”Š 15â”Šconst Style = styled.div`\n+â”Š   â”Š 16â”Š  position: fixed;\n+â”Š   â”Š 17â”Š  right: 10px;\n+â”Š   â”Š 18â”Š  bottom: 10px;\n+â”Š   â”Š 19â”Š\n+â”Š   â”Š 20â”Š  button {\n+â”Š   â”Š 21â”Š    min-width: 50px;\n+â”Š   â”Š 22â”Š    width: 50px;\n+â”Š   â”Š 23â”Š    height: 50px;\n+â”Š   â”Š 24â”Š    border-radius: 999px;\n+â”Š   â”Š 25â”Š    background-color: var(--secondary-bg);\n+â”Š   â”Š 26â”Š    color: white;\n+â”Š   â”Š 27â”Š  }\n+â”Š   â”Š 28â”Š`\n+â”Š   â”Š 29â”Š\n+â”Š   â”Š 30â”Šconst mutation = gql`\n+â”Š   â”Š 31â”Š  mutation CompleteGroupButtonMutation(\n+â”Š   â”Š 32â”Š    $userIds: [ID!]!\n+â”Š   â”Š 33â”Š    $groupName: String!\n+â”Š   â”Š 34â”Š    $groupPicture: String\n+â”Š   â”Š 35â”Š  ) {\n+â”Š   â”Š 36â”Š    addGroup(userIds: $userIds, groupName: $groupName, groupPicture: $groupPicture) {\n+â”Š   â”Š 37â”Š      ...Chat\n+â”Š   â”Š 38â”Š    }\n+â”Š   â”Š 39â”Š  }\n+â”Š   â”Š 40â”Š  ${fragments.chat}\n+â”Š   â”Š 41â”Š`\n+â”Š   â”Š 42â”Š\n+â”Š   â”Š 43â”Šinterface CompleteGroupButtonProps {\n+â”Š   â”Š 44â”Š  history: History\n+â”Š   â”Š 45â”Š  users: User.Fragment[]\n+â”Š   â”Š 46â”Š  groupName: string\n+â”Š   â”Š 47â”Š  groupPicture: string\n+â”Š   â”Š 48â”Š}\n+â”Š   â”Š 49â”Š\n+â”Š   â”Š 50â”Šexport default ({ history, users, groupName, groupPicture }: CompleteGroupButtonProps) => {\n+â”Š   â”Š 51â”Š  const me = useMe()\n+â”Š   â”Š 52â”Š\n+â”Š   â”Š 53â”Š  const addGroup = useMutation<\n+â”Š   â”Š 54â”Š    CompleteGroupButtonMutation.Mutation,\n+â”Š   â”Š 55â”Š    CompleteGroupButtonMutation.Variables\n+â”Š   â”Š 56â”Š  >(mutation, {\n+â”Š   â”Š 57â”Š    optimisticResponse: {\n+â”Š   â”Š 58â”Š      __typename: 'Mutation',\n+â”Š   â”Š 59â”Š      addGroup: {\n+â”Š   â”Š 60â”Š        __typename: 'Chat',\n+â”Š   â”Š 61â”Š        id: uniqid(),\n+â”Š   â”Š 62â”Š        name: groupName,\n+â”Š   â”Š 63â”Š        picture: groupPicture,\n+â”Š   â”Š 64â”Š        allTimeMembers: users,\n+â”Š   â”Š 65â”Š        owner: me,\n+â”Š   â”Š 66â”Š        isGroup: true,\n+â”Š   â”Š 67â”Š        lastMessage: null,\n+â”Š   â”Š 68â”Š      },\n+â”Š   â”Š 69â”Š    },\n+â”Š   â”Š 70â”Š    variables: {\n+â”Š   â”Š 71â”Š      userIds: users.map(user => user.id),\n+â”Š   â”Š 72â”Š      groupName,\n+â”Š   â”Š 73â”Š      groupPicture,\n+â”Š   â”Š 74â”Š    },\n+â”Š   â”Š 75â”Š    update: (client, { data: { addGroup } }) => {\n+â”Š   â”Š 76â”Š      client.writeFragment({\n+â”Š   â”Š 77â”Š        id: defaultDataIdFromObject(addGroup),\n+â”Š   â”Š 78â”Š        fragment: fragments.chat,\n+â”Š   â”Š 79â”Š        fragmentName: 'Chat',\n+â”Š   â”Š 80â”Š        data: addGroup,\n+â”Š   â”Š 81â”Š      })\n+â”Š   â”Š 82â”Š\n+â”Š   â”Š 83â”Š      let chats\n+â”Š   â”Š 84â”Š      try {\n+â”Š   â”Š 85â”Š        chats = client.readQuery<Chats.Query>({\n+â”Š   â”Š 86â”Š          query: queries.chats,\n+â”Š   â”Š 87â”Š        }).chats\n+â”Š   â”Š 88â”Š      } catch (e) {}\n+â”Š   â”Š 89â”Š\n+â”Š   â”Š 90â”Š      if (chats && !chats.some(chat => chat.id === addGroup.id)) {\n+â”Š   â”Š 91â”Š        chats.unshift(addGroup)\n+â”Š   â”Š 92â”Š\n+â”Š   â”Š 93â”Š        client.writeQuery({\n+â”Š   â”Š 94â”Š          query: queries.chats,\n+â”Š   â”Š 95â”Š          data: { chats },\n+â”Š   â”Š 96â”Š        })\n+â”Š   â”Š 97â”Š      }\n+â”Š   â”Š 98â”Š    },\n+â”Š   â”Š 99â”Š  })\n+â”Š   â”Š100â”Š\n+â”Š   â”Š101â”Š  const onClick = () => {\n+â”Š   â”Š102â”Š    addGroup().then(({ data: { addGroup } }) => {\n+â”Š   â”Š103â”Š      history.push(`/chats/${addGroup.id}`)\n+â”Š   â”Š104â”Š    })\n+â”Š   â”Š105â”Š  }\n+â”Š   â”Š106â”Š\n+â”Š   â”Š107â”Š  return (\n+â”Š   â”Š108â”Š    <Style className=\"CompleteGroupButton\">\n+â”Š   â”Š109â”Š      <Button variant=\"contained\" color=\"secondary\" onClick={onClick}>\n+â”Š   â”Š110â”Š        <ArrowRightIcon />\n+â”Š   â”Š111â”Š      </Button>\n+â”Š   â”Š112â”Š    </Style>\n+â”Š   â”Š113â”Š  )\n+â”Š   â”Š114â”Š}\n```\n\n##### Added src&#x2F;components&#x2F;GroupDetailsScreen&#x2F;GroupDetailsNavbar.tsx\n```diff\n@@ -0,0 +1,39 @@\n+â”Š  â”Š 1â”Šimport Button from '@material-ui/core/Button'\n+â”Š  â”Š 2â”Šimport ArrowBackIcon from '@material-ui/icons/ArrowBack'\n+â”Š  â”Š 3â”Šimport { History } from 'history'\n+â”Š  â”Š 4â”Šimport * as React from 'react'\n+â”Š  â”Š 5â”Šimport styled from 'styled-components'\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Šconst Style = styled.div`\n+â”Š  â”Š 8â”Š  padding: 0;\n+â”Š  â”Š 9â”Š  display: flex;\n+â”Š  â”Š10â”Š  flex-direction: row;\n+â”Š  â”Š11â”Š  margin-left: -20px;\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Š  .GroupDetailsNavbar-title {\n+â”Š  â”Š14â”Š    line-height: 56px;\n+â”Š  â”Š15â”Š  }\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š  .GroupDetailsNavbar-back-button {\n+â”Š  â”Š18â”Š    color: var(--primary-text);\n+â”Š  â”Š19â”Š  }\n+â”Š  â”Š20â”Š`\n+â”Š  â”Š21â”Š\n+â”Š  â”Š22â”Šinterface GroupDetailsNavbarProps {\n+â”Š  â”Š23â”Š  history: History\n+â”Š  â”Š24â”Š}\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Šexport default ({ history }: GroupDetailsNavbarProps) => {\n+â”Š  â”Š27â”Š  const navToNewGroup = () => {\n+â”Š  â”Š28â”Š    history.push('/new-chat/group')\n+â”Š  â”Š29â”Š  }\n+â”Š  â”Š30â”Š\n+â”Š  â”Š31â”Š  return (\n+â”Š  â”Š32â”Š    <Style className=\"GroupDetailsNavbar\">\n+â”Š  â”Š33â”Š      <Button className=\"GroupDetailsNavbar-back-button\" onClick={navToNewGroup}>\n+â”Š  â”Š34â”Š        <ArrowBackIcon />\n+â”Š  â”Š35â”Š      </Button>\n+â”Š  â”Š36â”Š      <div className=\"GroupDetailsNavbar-title\">Group Details</div>\n+â”Š  â”Š37â”Š    </Style>\n+â”Š  â”Š38â”Š  )\n+â”Š  â”Š39â”Š}\n```\n\n##### Added src&#x2F;components&#x2F;GroupDetailsScreen&#x2F;index.tsx\n```diff\n@@ -0,0 +1,163 @@\n+â”Š   â”Š  1â”Šimport TextField from '@material-ui/core/TextField'\n+â”Š   â”Š  2â”Šimport { defaultDataIdFromObject } from 'apollo-cache-inmemory'\n+â”Š   â”Š  3â”Šimport gql from 'graphql-tag'\n+â”Š   â”Š  4â”Šimport * as React from 'react'\n+â”Š   â”Š  5â”Šimport { useState, useEffect } from 'react'\n+â”Š   â”Š  6â”Šimport { MutationHookOptions } from 'react-apollo-hooks'\n+â”Š   â”Š  7â”Šimport { useQuery, useMutation } from 'react-apollo-hooks'\n+â”Š   â”Š  8â”Šimport { Redirect } from 'react-router-dom'\n+â”Š   â”Š  9â”Šimport { RouteComponentProps } from 'react-router-dom'\n+â”Š   â”Š 10â”Šimport styled from 'styled-components'\n+â”Š   â”Š 11â”Šimport * as fragments from '../../graphql/fragments'\n+â”Š   â”Š 12â”Šimport { GroupDetailsScreenQuery, GroupDetailsScreenMutation, User } from '../../graphql/types'\n+â”Š   â”Š 13â”Šimport { useMe } from '../../services/auth.service'\n+â”Š   â”Š 14â”Šimport { pickPicture, uploadProfilePicture } from '../../services/picture.service'\n+â”Š   â”Š 15â”Šimport Navbar from '../Navbar'\n+â”Š   â”Š 16â”Šimport CompleteGroupButton from './CompleteGroupButton'\n+â”Š   â”Š 17â”Šimport GroupDetailsNavbar from './GroupDetailsNavbar'\n+â”Š   â”Š 18â”Š\n+â”Š   â”Š 19â”Šconst Style = styled.div`\n+â”Š   â”Š 20â”Š  .GroupDetailsScreen-group-name {\n+â”Š   â”Š 21â”Š    width: calc(100% - 30px);\n+â”Š   â”Š 22â”Š    margin: 15px;\n+â”Š   â”Š 23â”Š  }\n+â”Š   â”Š 24â”Š\n+â”Š   â”Š 25â”Š  .GroupDetailsScreen-participants-title {\n+â”Š   â”Š 26â”Š    margin-top: 10px;\n+â”Š   â”Š 27â”Š    margin-left: 15px;\n+â”Š   â”Š 28â”Š  }\n+â”Š   â”Š 29â”Š\n+â”Š   â”Š 30â”Š  .GroupDetailsScreen-participants-list {\n+â”Š   â”Š 31â”Š    display: flex;\n+â”Š   â”Š 32â”Š    overflow: overlay;\n+â”Š   â”Š 33â”Š    padding: 0;\n+â”Š   â”Š 34â”Š  }\n+â”Š   â”Š 35â”Š\n+â”Š   â”Š 36â”Š  .GroupDetailsScreen-participant-item {\n+â”Š   â”Š 37â”Š    padding: 10px;\n+â”Š   â”Š 38â”Š    flex-flow: row wrap;\n+â”Š   â”Š 39â”Š    text-align: center;\n+â”Š   â”Š 40â”Š  }\n+â”Š   â”Š 41â”Š\n+â”Š   â”Š 42â”Š  .GroupDetailsScreen-participant-picture {\n+â”Š   â”Š 43â”Š    flex: 0 1 50px;\n+â”Š   â”Š 44â”Š    height: 50px;\n+â”Š   â”Š 45â”Š    width: 50px;\n+â”Š   â”Š 46â”Š    object-fit: cover;\n+â”Š   â”Š 47â”Š    border-radius: 50%;\n+â”Š   â”Š 48â”Š    display: block;\n+â”Š   â”Š 49â”Š    margin-left: auto;\n+â”Š   â”Š 50â”Š    margin-right: auto;\n+â”Š   â”Š 51â”Š  }\n+â”Š   â”Š 52â”Š\n+â”Š   â”Š 53â”Š  .GroupDetailsScreen-group-info {\n+â”Š   â”Š 54â”Š    display: flex;\n+â”Š   â”Š 55â”Š    flex-direction: row;\n+â”Š   â”Š 56â”Š    align-items: center;\n+â”Š   â”Š 57â”Š  }\n+â”Š   â”Š 58â”Š\n+â”Š   â”Š 59â”Š  .GroupDetailsScreen-participant-name {\n+â”Š   â”Š 60â”Š    line-height: 10px;\n+â”Š   â”Š 61â”Š    font-size: 14px;\n+â”Š   â”Š 62â”Š  }\n+â”Š   â”Š 63â”Š\n+â”Š   â”Š 64â”Š  .GroupDetailsScreen-group-picture {\n+â”Š   â”Š 65â”Š    width: 50px;\n+â”Š   â”Š 66â”Š    flex-basis: 50px;\n+â”Š   â”Š 67â”Š    border-radius: 50%;\n+â”Š   â”Š 68â”Š    margin-left: 15px;\n+â”Š   â”Š 69â”Š    object-fit: cover;\n+â”Š   â”Š 70â”Š    cursor: pointer;\n+â”Š   â”Š 71â”Š  }\n+â”Š   â”Š 72â”Š`\n+â”Š   â”Š 73â”Š\n+â”Š   â”Š 74â”Šconst query = gql`\n+â”Š   â”Š 75â”Š  query GroupDetailsScreenQuery($chatId: ID!) {\n+â”Š   â”Š 76â”Š    chat(chatId: $chatId) {\n+â”Š   â”Š 77â”Š      ...Chat\n+â”Š   â”Š 78â”Š    }\n+â”Š   â”Š 79â”Š  }\n+â”Š   â”Š 80â”Š  ${fragments.chat}\n+â”Š   â”Š 81â”Š`\n+â”Š   â”Š 82â”Š\n+â”Š   â”Š 83â”Šconst mutation = gql`\n+â”Š   â”Š 84â”Š  mutation GroupDetailsScreenMutation($chatId: ID!, $name: String, $picture: String) {\n+â”Š   â”Š 85â”Š    updateGroup(chatId: $chatId, groupName: $name, groupPicture: $picture) {\n+â”Š   â”Š 86â”Š      ...Chat\n+â”Š   â”Š 87â”Š    }\n+â”Š   â”Š 88â”Š  }\n+â”Š   â”Š 89â”Š  ${fragments.chat}\n+â”Š   â”Š 90â”Š`\n+â”Š   â”Š 91â”Š\n+â”Š   â”Š 92â”Šexport default ({ location, history }: RouteComponentProps) => {\n+â”Š   â”Š 93â”Š  const users = location.state.users\n+â”Š   â”Š 94â”Š\n+â”Š   â”Š 95â”Š  // Users are missing from state\n+â”Š   â”Š 96â”Š  if (!(users instanceof Array)) {\n+â”Š   â”Š 97â”Š    return <Redirect to=\"/chats\" />\n+â”Š   â”Š 98â”Š  }\n+â”Š   â”Š 99â”Š\n+â”Š   â”Š100â”Š  const me = useMe()\n+â”Š   â”Š101â”Š  const [chatName, setChatName] = useState('')\n+â”Š   â”Š102â”Š  const [chatPicture, setChatPicture] = useState('')\n+â”Š   â”Š103â”Š  const participants = [me].concat(users)\n+â”Š   â”Š104â”Š\n+â”Š   â”Š105â”Š  const updateChatName = ({ target }) => {\n+â”Š   â”Š106â”Š    setChatName(target.value)\n+â”Š   â”Š107â”Š  }\n+â”Š   â”Š108â”Š\n+â”Š   â”Š109â”Š  const updateChatPicture = async () => {\n+â”Š   â”Š110â”Š    const file = await pickPicture()\n+â”Š   â”Š111â”Š\n+â”Š   â”Š112â”Š    if (!file) return\n+â”Š   â”Š113â”Š\n+â”Š   â”Š114â”Š    const { url } = await uploadProfilePicture(file)\n+â”Š   â”Š115â”Š\n+â”Š   â”Š116â”Š    setChatPicture(url)\n+â”Š   â”Š117â”Š  }\n+â”Š   â”Š118â”Š\n+â”Š   â”Š119â”Š  return (\n+â”Š   â”Š120â”Š    <Style className=\"GroupDetailsScreen Screen\">\n+â”Š   â”Š121â”Š      <Navbar>\n+â”Š   â”Š122â”Š        <GroupDetailsNavbar history={history} />\n+â”Š   â”Š123â”Š      </Navbar>\n+â”Š   â”Š124â”Š      <div className=\"GroupDetailsScreen-group-info\">\n+â”Š   â”Š125â”Š        <img\n+â”Š   â”Š126â”Š          className=\"GroupDetailsScreen-group-picture\"\n+â”Š   â”Š127â”Š          src={chatPicture || '/assets/default-group-pic.jpg'}\n+â”Š   â”Š128â”Š          onClick={updateChatPicture}\n+â”Š   â”Š129â”Š        />\n+â”Š   â”Š130â”Š        <TextField\n+â”Š   â”Š131â”Š          label=\"Group name\"\n+â”Š   â”Š132â”Š          placeholder=\"Enter group name\"\n+â”Š   â”Š133â”Š          className=\"GroupDetailsScreen-group-name\"\n+â”Š   â”Š134â”Š          value={chatName}\n+â”Š   â”Š135â”Š          onChange={updateChatName}\n+â”Š   â”Š136â”Š          autoFocus={true}\n+â”Š   â”Š137â”Š        />\n+â”Š   â”Š138â”Š      </div>\n+â”Š   â”Š139â”Š      <div className=\"GroupDetailsScreen-participants-title\">\n+â”Š   â”Š140â”Š        Participants: {participants.length}\n+â”Š   â”Š141â”Š      </div>\n+â”Š   â”Š142â”Š      <ul className=\"GroupDetailsScreen-participants-list\">\n+â”Š   â”Š143â”Š        {participants.map(participant => (\n+â”Š   â”Š144â”Š          <div key={participant.id} className=\"GroupDetailsScreen-participant-item\">\n+â”Š   â”Š145â”Š            <img\n+â”Š   â”Š146â”Š              src={participant.picture || '/assets/default-profile-pic.jpg'}\n+â”Š   â”Š147â”Š              className=\"GroupDetailsScreen-participant-picture\"\n+â”Š   â”Š148â”Š            />\n+â”Š   â”Š149â”Š            <span className=\"GroupDetailsScreen-participant-name\">{participant.name}</span>\n+â”Š   â”Š150â”Š          </div>\n+â”Š   â”Š151â”Š        ))}\n+â”Š   â”Š152â”Š      </ul>\n+â”Š   â”Š153â”Š      {chatName && (\n+â”Š   â”Š154â”Š        <CompleteGroupButton\n+â”Š   â”Š155â”Š          history={history}\n+â”Š   â”Š156â”Š          groupName={chatName}\n+â”Š   â”Š157â”Š          groupPicture={chatPicture}\n+â”Š   â”Š158â”Š          users={users}\n+â”Š   â”Š159â”Š        />\n+â”Š   â”Š160â”Š      )}\n+â”Š   â”Š161â”Š    </Style>\n+â”Š   â”Š162â”Š  )\n+â”Š   â”Š163â”Š}\n```\n\n[}]: #\n\nThis will require us to download a new asset to the `public/assets` directory which represents the default picture for a group. Please save it as `default-group-pic.jpg`:\n\n![default-group-pic.jpg](https://user-images.githubusercontent.com/7648874/51983284-3b1d8300-24d3-11e9-9f8b-afe36a3b9df1.jpg)\n\nLet's add a route for the screen we've just created:\n\n[{]: <helper> (diffStep 4.3 files=\"src/App\" module=\"client\")\n\n#### [Step 4.3: Add group details screen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/b9b7c3f)\n\n##### Changed src&#x2F;App.tsx\n```diff\n@@ -5,6 +5,7 @@\n â”Š 5â”Š 5â”Šimport AnimatedSwitch from './components/AnimatedSwitch'\n â”Š 6â”Š 6â”Šimport AuthScreen from './components/AuthScreen'\n â”Š 7â”Š 7â”Šimport ChatsListScreen from './components/ChatsListScreen'\n+â”Š  â”Š 8â”Šimport GroupDetailsScreen from './components/GroupDetailsScreen'\n â”Š 8â”Š 9â”Šimport SettingsScreen from './components/SettingsScreen'\n â”Š 9â”Š10â”Šimport NewGroupScreen from './components/NewGroupScreen'\n â”Š10â”Š11â”Šimport { withAuth } from './services/auth.service'\n```\n```diff\n@@ -22,6 +23,7 @@\n â”Š22â”Š23â”Š      <Route exact path=\"/chats/:chatId\" component={withAuth(ChatRoomScreen)} />\n â”Š23â”Š24â”Š      <Route exact path=\"/new-chat\" component={withAuth(NewChatScreen)} />\n â”Š24â”Š25â”Š      <Route exact path=\"/new-chat/group\" component={withAuth(NewGroupScreen)} />\n+â”Š  â”Š26â”Š      <Route exact path=\"/new-chat/group/details\" component={withAuth(GroupDetailsScreen)} />\n â”Š25â”Š27â”Š      <Route component={RedirectToChats} />\n â”Š26â”Š28â”Š    </AnimatedSwitch>\n â”Š27â”Š29â”Š  </BrowserRouter>\n```\n\n[}]: #\n\nThere's one last thing missing in the flow and that would be migrating existing components to work well with the new feature of group chats.\n\nStarting with the chats list component, we would like to display the default profile picture for group chats:\n\n[{]: <helper> (diffStep 4.4 files=\"src/components/ChatsListScreen\" module=\"client\")\n\n#### [Step 4.4: Apply group logic to existing components](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/109773f)\n\n##### Changed src&#x2F;components&#x2F;ChatsListScreen&#x2F;ChatsList.tsx\n```diff\n@@ -97,7 +97,12 @@\n â”Š 97â”Š 97â”Š          >\n â”Š 98â”Š 98â”Š            <img\n â”Š 99â”Š 99â”Š              className=\"ChatsList-profile-pic\"\n-â”Š100â”Š   â”Š              src={chat.picture || '/assets/default-profile-pic.jpg'}\n+â”Š   â”Š100â”Š              src={\n+â”Š   â”Š101â”Š                chat.picture ||\n+â”Š   â”Š102â”Š                (chat.isGroup\n+â”Š   â”Š103â”Š                  ? '/assets/default-group-pic.jpg'\n+â”Š   â”Š104â”Š                  : '/assets/default-profile-pic.jpg')\n+â”Š   â”Š105â”Š              }\n â”Š101â”Š106â”Š            />\n â”Š102â”Š107â”Š            <div className=\"ChatsList-info\">\n â”Š103â”Š108â”Š              <div className=\"ChatsList-name\">{chat.name}</div>\n```\n\n[}]: #\n\nIn the messages list component, we would like to display the name of the owner of the message, so we would know exactly who sent it in case we're in a group chat:\n\n[{]: <helper> (diffStep 4.4 files=\"src/components/ChatRoomScreen/MessagesList\" module=\"client\")\n\n#### [Step 4.4: Apply group logic to existing components](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/109773f)\n\n##### Changed src&#x2F;components&#x2F;ChatRoomScreen&#x2F;MessagesList.tsx\n```diff\n@@ -105,7 +105,7 @@\n â”Š105â”Š105â”Šexport default ({ chatId }: MessagesListProps) => {\n â”Š106â”Š106â”Š  const {\n â”Š107â”Š107â”Š    data: {\n-â”Š108â”Š   â”Š      chat: { messages },\n+â”Š   â”Š108â”Š      chat: { messages, isGroup },\n â”Š109â”Š109â”Š    },\n â”Š110â”Š110â”Š  } = useQuery<MessagesListQuery.Query, MessagesListQuery.Variables>(query, {\n â”Š111â”Š111â”Š    variables: { chatId },\n```\n```diff\n@@ -133,6 +133,9 @@\n â”Š133â”Š133â”Š              message.ownership ? 'MessagesList-message-mine' : 'MessagesList-message-others'\n â”Š134â”Š134â”Š            }`}\n â”Š135â”Š135â”Š          >\n+â”Š   â”Š136â”Š            {isGroup && !message.ownership && (\n+â”Š   â”Š137â”Š              <div className=\"MessagesList-message-sender\">{message.sender.name}</div>\n+â”Š   â”Š138â”Š            )}\n â”Š136â”Š139â”Š            <div className=\"MessagesList-message-contents\">{message.content}</div>\n â”Š137â”Š140â”Š            <span className=\"MessagesList-message-timestamp\">\n â”Š138â”Š141â”Š              {moment(message.createdAt).format('HH:mm')}\n```\n\n[}]: #\n\nAnd now what we're gonna do is basically use the group details screen to show the details of the group that we're currently at. If we're an admin of the group, we would be able to edit its details, and if not, we will only be able to view its details without changing any of it. The view and some of the logic are the same whether it's a new group or an existing one, but there are slight differences. To deal with the differences, we will use \"if\" statements before we use the hooks, but **beware whenever you do that!** If you'll use an expression that is likely to change during the component's lifespan, you should NOT use a hook inside the \"if\" statement's block, because the React engine relies on the hooks to be called in a similar order.\n\n[{]: <helper> (diffStep 4.3 files=\"src/components/ChatRoomScreen/ChatNavBar, src/components/GroupDetailsScreen\" module=\"client\")\n\n#### [Step 4.3: Add group details screen](https://github.com/Urigo/WhatsApp-Clone-Client-React/commit/b9b7c3f)\n\n##### Added src&#x2F;components&#x2F;GroupDetailsScreen&#x2F;CompleteGroupButton.tsx\n```diff\n@@ -0,0 +1,114 @@\n+â”Š   â”Š  1â”Šimport Button from '@material-ui/core/Button'\n+â”Š   â”Š  2â”Šimport ArrowRightIcon from '@material-ui/icons/ArrowRightAlt'\n+â”Š   â”Š  3â”Šimport { defaultDataIdFromObject } from 'apollo-cache-inmemory'\n+â”Š   â”Š  4â”Šimport gql from 'graphql-tag'\n+â”Š   â”Š  5â”Šimport { History } from 'history'\n+â”Š   â”Š  6â”Šimport * as React from 'react'\n+â”Š   â”Š  7â”Šimport { useMutation } from 'react-apollo-hooks'\n+â”Š   â”Š  8â”Šimport styled from 'styled-components'\n+â”Š   â”Š  9â”Šimport { time as uniqid } from 'uniqid'\n+â”Š   â”Š 10â”Šimport * as fragments from '../../graphql/fragments'\n+â”Š   â”Š 11â”Šimport * as queries from '../../graphql/queries'\n+â”Š   â”Š 12â”Šimport { Chats, User, CompleteGroupButtonMutation } from '../../graphql/types'\n+â”Š   â”Š 13â”Šimport { useMe } from '../../services/auth.service'\n+â”Š   â”Š 14â”Š\n+â”Š   â”Š 15â”Šconst Style = styled.div`\n+â”Š   â”Š 16â”Š  position: fixed;\n+â”Š   â”Š 17â”Š  right: 10px;\n+â”Š   â”Š 18â”Š  bottom: 10px;\n+â”Š   â”Š 19â”Š\n+â”Š   â”Š 20â”Š  button {\n+â”Š   â”Š 21â”Š    min-width: 50px;\n+â”Š   â”Š 22â”Š    width: 50px;\n+â”Š   â”Š 23â”Š    height: 50px;\n+â”Š   â”Š 24â”Š    border-radius: 999px;\n+â”Š   â”Š 25â”Š    background-color: var(--secondary-bg);\n+â”Š   â”Š 26â”Š    color: white;\n+â”Š   â”Š 27â”Š  }\n+â”Š   â”Š 28â”Š`\n+â”Š   â”Š 29â”Š\n+â”Š   â”Š 30â”Šconst mutation = gql`\n+â”Š   â”Š 31â”Š  mutation CompleteGroupButtonMutation(\n+â”Š   â”Š 32â”Š    $userIds: [ID!]!\n+â”Š   â”Š 33â”Š    $groupName: String!\n+â”Š   â”Š 34â”Š    $groupPicture: String\n+â”Š   â”Š 35â”Š  ) {\n+â”Š   â”Š 36â”Š    addGroup(userIds: $userIds, groupName: $groupName, groupPicture: $groupPicture) {\n+â”Š   â”Š 37â”Š      ...Chat\n+â”Š   â”Š 38â”Š    }\n+â”Š   â”Š 39â”Š  }\n+â”Š   â”Š 40â”Š  ${fragments.chat}\n+â”Š   â”Š 41â”Š`\n+â”Š   â”Š 42â”Š\n+â”Š   â”Š 43â”Šinterface CompleteGroupButtonProps {\n+â”Š   â”Š 44â”Š  history: History\n+â”Š   â”Š 45â”Š  users: User.Fragment[]\n+â”Š   â”Š 46â”Š  groupName: string\n+â”Š   â”Š 47â”Š  groupPicture: string\n+â”Š   â”Š 48â”Š}\n+â”Š   â”Š 49â”Š\n+â”Š   â”Š 50â”Šexport default ({ history, users, groupName, groupPicture }: CompleteGroupButtonProps) => {\n+â”Š   â”Š 51â”Š  const me = useMe()\n+â”Š   â”Š 52â”Š\n+â”Š   â”Š 53â”Š  const addGroup = useMutation<\n+â”Š   â”Š 54â”Š    CompleteGroupButtonMutation.Mutation,\n+â”Š   â”Š 55â”Š    CompleteGroupButtonMutation.Variables\n+â”Š   â”Š 56â”Š  >(mutation, {\n+â”Š   â”Š 57â”Š    optimisticResponse: {\n+â”Š   â”Š 58â”Š      __typename: 'Mutation',\n+â”Š   â”Š 59â”Š      addGroup: {\n+â”Š   â”Š 60â”Š        __typename: 'Chat',\n+â”Š   â”Š 61â”Š        id: uniqid(),\n+â”Š   â”Š 62â”Š        name: groupName,\n+â”Š   â”Š 63â”Š        picture: groupPicture,\n+â”Š   â”Š 64â”Š        allTimeMembers: users,\n+â”Š   â”Š 65â”Š        owner: me,\n+â”Š   â”Š 66â”Š        isGroup: true,\n+â”Š   â”Š 67â”Š        lastMessage: null,\n+â”Š   â”Š 68â”Š      },\n+â”Š   â”Š 69â”Š    },\n+â”Š   â”Š 70â”Š    variables: {\n+â”Š   â”Š 71â”Š      userIds: users.map(user => user.id),\n+â”Š   â”Š 72â”Š      groupName,\n+â”Š   â”Š 73â”Š      groupPicture,\n+â”Š   â”Š 74â”Š    },\n+â”Š   â”Š 75â”Š    update: (client, { data: { addGroup } }) => {\n+â”Š   â”Š 76â”Š      client.writeFragment({\n+â”Š   â”Š 77â”Š        id: defaultDataIdFromObject(addGroup),\n+â”Š   â”Š 78â”Š        fragment: fragments.chat,\n+â”Š   â”Š 79â”Š        fragmentName: 'Chat',\n+â”Š   â”Š 80â”Š        data: addGroup,\n+â”Š   â”Š 81â”Š      })\n+â”Š   â”Š 82â”Š\n+â”Š   â”Š 83â”Š      let chats\n+â”Š   â”Š 84â”Š      try {\n+â”Š   â”Š 85â”Š        chats = client.readQuery<Chats.Query>({\n+â”Š   â”Š 86â”Š          query: queries.chats,\n+â”Š   â”Š 87â”Š        }).chats\n+â”Š   â”Š 88â”Š      } catch (e) {}\n+â”Š   â”Š 89â”Š\n+â”Š   â”Š 90â”Š      if (chats && !chats.some(chat => chat.id === addGroup.id)) {\n+â”Š   â”Š 91â”Š        chats.unshift(addGroup)\n+â”Š   â”Š 92â”Š\n+â”Š   â”Š 93â”Š        client.writeQuery({\n+â”Š   â”Š 94â”Š          query: queries.chats,\n+â”Š   â”Š 95â”Š          data: { chats },\n+â”Š   â”Š 96â”Š        })\n+â”Š   â”Š 97â”Š      }\n+â”Š   â”Š 98â”Š    },\n+â”Š   â”Š 99â”Š  })\n+â”Š   â”Š100â”Š\n+â”Š   â”Š101â”Š  const onClick = () => {\n+â”Š   â”Š102â”Š    addGroup().then(({ data: { addGroup } }) => {\n+â”Š   â”Š103â”Š      history.push(`/chats/${addGroup.id}`)\n+â”Š   â”Š104â”Š    })\n+â”Š   â”Š105â”Š  }\n+â”Š   â”Š106â”Š\n+â”Š   â”Š107â”Š  return (\n+â”Š   â”Š108â”Š    <Style className=\"CompleteGroupButton\">\n+â”Š   â”Š109â”Š      <Button variant=\"contained\" color=\"secondary\" onClick={onClick}>\n+â”Š   â”Š110â”Š        <ArrowRightIcon />\n+â”Š   â”Š111â”Š      </Button>\n+â”Š   â”Š112â”Š    </Style>\n+â”Š   â”Š113â”Š  )\n+â”Š   â”Š114â”Š}\n```\n\n##### Added src&#x2F;components&#x2F;GroupDetailsScreen&#x2F;GroupDetailsNavbar.tsx\n```diff\n@@ -0,0 +1,39 @@\n+â”Š  â”Š 1â”Šimport Button from '@material-ui/core/Button'\n+â”Š  â”Š 2â”Šimport ArrowBackIcon from '@material-ui/icons/ArrowBack'\n+â”Š  â”Š 3â”Šimport { History } from 'history'\n+â”Š  â”Š 4â”Šimport * as React from 'react'\n+â”Š  â”Š 5â”Šimport styled from 'styled-components'\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Šconst Style = styled.div`\n+â”Š  â”Š 8â”Š  padding: 0;\n+â”Š  â”Š 9â”Š  display: flex;\n+â”Š  â”Š10â”Š  flex-direction: row;\n+â”Š  â”Š11â”Š  margin-left: -20px;\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Š  .GroupDetailsNavbar-title {\n+â”Š  â”Š14â”Š    line-height: 56px;\n+â”Š  â”Š15â”Š  }\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š  .GroupDetailsNavbar-back-button {\n+â”Š  â”Š18â”Š    color: var(--primary-text);\n+â”Š  â”Š19â”Š  }\n+â”Š  â”Š20â”Š`\n+â”Š  â”Š21â”Š\n+â”Š  â”Š22â”Šinterface GroupDetailsNavbarProps {\n+â”Š  â”Š23â”Š  history: History\n+â”Š  â”Š24â”Š}\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Šexport default ({ history }: GroupDetailsNavbarProps) => {\n+â”Š  â”Š27â”Š  const navToNewGroup = () => {\n+â”Š  â”Š28â”Š    history.push('/new-chat/group')\n+â”Š  â”Š29â”Š  }\n+â”Š  â”Š30â”Š\n+â”Š  â”Š31â”Š  return (\n+â”Š  â”Š32â”Š    <Style className=\"GroupDetailsNavbar\">\n+â”Š  â”Š33â”Š      <Button className=\"GroupDetailsNavbar-back-button\" onClick={navToNewGroup}>\n+â”Š  â”Š34â”Š        <ArrowBackIcon />\n+â”Š  â”Š35â”Š      </Button>\n+â”Š  â”Š36â”Š      <div className=\"GroupDetailsNavbar-title\">Group Details</div>\n+â”Š  â”Š37â”Š    </Style>\n+â”Š  â”Š38â”Š  )\n+â”Š  â”Š39â”Š}\n```\n\n##### Added src&#x2F;components&#x2F;GroupDetailsScreen&#x2F;index.tsx\n```diff\n@@ -0,0 +1,163 @@\n+â”Š   â”Š  1â”Šimport TextField from '@material-ui/core/TextField'\n+â”Š   â”Š  2â”Šimport { defaultDataIdFromObject } from 'apollo-cache-inmemory'\n+â”Š   â”Š  3â”Šimport gql from 'graphql-tag'\n+â”Š   â”Š  4â”Šimport * as React from 'react'\n+â”Š   â”Š  5â”Šimport { useState, useEffect } from 'react'\n+â”Š   â”Š  6â”Šimport { MutationHookOptions } from 'react-apollo-hooks'\n+â”Š   â”Š  7â”Šimport { useQuery, useMutation } from 'react-apollo-hooks'\n+â”Š   â”Š  8â”Šimport { Redirect } from 'react-router-dom'\n+â”Š   â”Š  9â”Šimport { RouteComponentProps } from 'react-router-dom'\n+â”Š   â”Š 10â”Šimport styled from 'styled-components'\n+â”Š   â”Š 11â”Šimport * as fragments from '../../graphql/fragments'\n+â”Š   â”Š 12â”Šimport { GroupDetailsScreenQuery, GroupDetailsScreenMutation, User } from '../../graphql/types'\n+â”Š   â”Š 13â”Šimport { useMe } from '../../services/auth.service'\n+â”Š   â”Š 14â”Šimport { pickPicture, uploadProfilePicture } from '../../services/picture.service'\n+â”Š   â”Š 15â”Šimport Navbar from '../Navbar'\n+â”Š   â”Š 16â”Šimport CompleteGroupButton from './CompleteGroupButton'\n+â”Š   â”Š 17â”Šimport GroupDetailsNavbar from './GroupDetailsNavbar'\n+â”Š   â”Š 18â”Š\n+â”Š   â”Š 19â”Šconst Style = styled.div`\n+â”Š   â”Š 20â”Š  .GroupDetailsScreen-group-name {\n+â”Š   â”Š 21â”Š    width: calc(100% - 30px);\n+â”Š   â”Š 22â”Š    margin: 15px;\n+â”Š   â”Š 23â”Š  }\n+â”Š   â”Š 24â”Š\n+â”Š   â”Š 25â”Š  .GroupDetailsScreen-participants-title {\n+â”Š   â”Š 26â”Š    margin-top: 10px;\n+â”Š   â”Š 27â”Š    margin-left: 15px;\n+â”Š   â”Š 28â”Š  }\n+â”Š   â”Š 29â”Š\n+â”Š   â”Š 30â”Š  .GroupDetailsScreen-participants-list {\n+â”Š   â”Š 31â”Š    display: flex;\n+â”Š   â”Š 32â”Š    overflow: overlay;\n+â”Š   â”Š 33â”Š    padding: 0;\n+â”Š   â”Š 34â”Š  }\n+â”Š   â”Š 35â”Š\n+â”Š   â”Š 36â”Š  .GroupDetailsScreen-participant-item {\n+â”Š   â”Š 37â”Š    padding: 10px;\n+â”Š   â”Š 38â”Š    flex-flow: row wrap;\n+â”Š   â”Š 39â”Š    text-align: center;\n+â”Š   â”Š 40â”Š  }\n+â”Š   â”Š 41â”Š\n+â”Š   â”Š 42â”Š  .GroupDetailsScreen-participant-picture {\n+â”Š   â”Š 43â”Š    flex: 0 1 50px;\n+â”Š   â”Š 44â”Š    height: 50px;\n+â”Š   â”Š 45â”Š    width: 50px;\n+â”Š   â”Š 46â”Š    object-fit: cover;\n+â”Š   â”Š 47â”Š    border-radius: 50%;\n+â”Š   â”Š 48â”Š    display: block;\n+â”Š   â”Š 49â”Š    margin-left: auto;\n+â”Š   â”Š 50â”Š    margin-right: auto;\n+â”Š   â”Š 51â”Š  }\n+â”Š   â”Š 52â”Š\n+â”Š   â”Š 53â”Š  .GroupDetailsScreen-group-info {\n+â”Š   â”Š 54â”Š    display: flex;\n+â”Š   â”Š 55â”Š    flex-direction: row;\n+â”Š   â”Š 56â”Š    align-items: center;\n+â”Š   â”Š 57â”Š  }\n+â”Š   â”Š 58â”Š\n+â”Š   â”Š 59â”Š  .GroupDetailsScreen-participant-name {\n+â”Š   â”Š 60â”Š    line-height: 10px;\n+â”Š   â”Š 61â”Š    font-size: 14px;\n+â”Š   â”Š 62â”Š  }\n+â”Š   â”Š 63â”Š\n+â”Š   â”Š 64â”Š  .GroupDetailsScreen-group-picture {\n+â”Š   â”Š 65â”Š    width: 50px;\n+â”Š   â”Š 66â”Š    flex-basis: 50px;\n+â”Š   â”Š 67â”Š    border-radius: 50%;\n+â”Š   â”Š 68â”Š    margin-left: 15px;\n+â”Š   â”Š 69â”Š    object-fit: cover;\n+â”Š   â”Š 70â”Š    cursor: pointer;\n+â”Š   â”Š 71â”Š  }\n+â”Š   â”Š 72â”Š`\n+â”Š   â”Š 73â”Š\n+â”Š   â”Š 74â”Šconst query = gql`\n+â”Š   â”Š 75â”Š  query GroupDetailsScreenQuery($chatId: ID!) {\n+â”Š   â”Š 76â”Š    chat(chatId: $chatId) {\n+â”Š   â”Š 77â”Š      ...Chat\n+â”Š   â”Š 78â”Š    }\n+â”Š   â”Š 79â”Š  }\n+â”Š   â”Š 80â”Š  ${fragments.chat}\n+â”Š   â”Š 81â”Š`\n+â”Š   â”Š 82â”Š\n+â”Š   â”Š 83â”Šconst mutation = gql`\n+â”Š   â”Š 84â”Š  mutation GroupDetailsScreenMutation($chatId: ID!, $name: String, $picture: String) {\n+â”Š   â”Š 85â”Š    updateGroup(chatId: $chatId, groupName: $name, groupPicture: $picture) {\n+â”Š   â”Š 86â”Š      ...Chat\n+â”Š   â”Š 87â”Š    }\n+â”Š   â”Š 88â”Š  }\n+â”Š   â”Š 89â”Š  ${fragments.chat}\n+â”Š   â”Š 90â”Š`\n+â”Š   â”Š 91â”Š\n+â”Š   â”Š 92â”Šexport default ({ location, history }: RouteComponentProps) => {\n+â”Š   â”Š 93â”Š  const users = location.state.users\n+â”Š   â”Š 94â”Š\n+â”Š   â”Š 95â”Š  // Users are missing from state\n+â”Š   â”Š 96â”Š  if (!(users instanceof Array)) {\n+â”Š   â”Š 97â”Š    return <Redirect to=\"/chats\" />\n+â”Š   â”Š 98â”Š  }\n+â”Š   â”Š 99â”Š\n+â”Š   â”Š100â”Š  const me = useMe()\n+â”Š   â”Š101â”Š  const [chatName, setChatName] = useState('')\n+â”Š   â”Š102â”Š  const [chatPicture, setChatPicture] = useState('')\n+â”Š   â”Š103â”Š  const participants = [me].concat(users)\n+â”Š   â”Š104â”Š\n+â”Š   â”Š105â”Š  const updateChatName = ({ target }) => {\n+â”Š   â”Š106â”Š    setChatName(target.value)\n+â”Š   â”Š107â”Š  }\n+â”Š   â”Š108â”Š\n+â”Š   â”Š109â”Š  const updateChatPicture = async () => {\n+â”Š   â”Š110â”Š    const file = await pickPicture()\n+â”Š   â”Š111â”Š\n+â”Š   â”Š112â”Š    if (!file) return\n+â”Š   â”Š113â”Š\n+â”Š   â”Š114â”Š    const { url } = await uploadProfilePicture(file)\n+â”Š   â”Š115â”Š\n+â”Š   â”Š116â”Š    setChatPicture(url)\n+â”Š   â”Š117â”Š  }\n+â”Š   â”Š118â”Š\n+â”Š   â”Š119â”Š  return (\n+â”Š   â”Š120â”Š    <Style className=\"GroupDetailsScreen Screen\">\n+â”Š   â”Š121â”Š      <Navbar>\n+â”Š   â”Š122â”Š        <GroupDetailsNavbar history={history} />\n+â”Š   â”Š123â”Š      </Navbar>\n+â”Š   â”Š124â”Š      <div className=\"GroupDetailsScreen-group-info\">\n+â”Š   â”Š125â”Š        <img\n+â”Š   â”Š126â”Š          className=\"GroupDetailsScreen-group-picture\"\n+â”Š   â”Š127â”Š          src={chatPicture || '/assets/default-group-pic.jpg'}\n+â”Š   â”Š128â”Š          onClick={updateChatPicture}\n+â”Š   â”Š129â”Š        />\n+â”Š   â”Š130â”Š        <TextField\n+â”Š   â”Š131â”Š          label=\"Group name\"\n+â”Š   â”Š132â”Š          placeholder=\"Enter group name\"\n+â”Š   â”Š133â”Š          className=\"GroupDetailsScreen-group-name\"\n+â”Š   â”Š134â”Š          value={chatName}\n+â”Š   â”Š135â”Š          onChange={updateChatName}\n+â”Š   â”Š136â”Š          autoFocus={true}\n+â”Š   â”Š137â”Š        />\n+â”Š   â”Š138â”Š      </div>\n+â”Š   â”Š139â”Š      <div className=\"GroupDetailsScreen-participants-title\">\n+â”Š   â”Š140â”Š        Participants: {participants.length}\n+â”Š   â”Š141â”Š      </div>\n+â”Š   â”Š142â”Š      <ul className=\"GroupDetailsScreen-participants-list\">\n+â”Š   â”Š143â”Š        {participants.map(participant => (\n+â”Š   â”Š144â”Š          <div key={participant.id} className=\"GroupDetailsScreen-participant-item\">\n+â”Š   â”Š145â”Š            <img\n+â”Š   â”Š146â”Š              src={participant.picture || '/assets/default-profile-pic.jpg'}\n+â”Š   â”Š147â”Š              className=\"GroupDetailsScreen-participant-picture\"\n+â”Š   â”Š148â”Š            />\n+â”Š   â”Š149â”Š            <span className=\"GroupDetailsScreen-participant-name\">{participant.name}</span>\n+â”Š   â”Š150â”Š          </div>\n+â”Š   â”Š151â”Š        ))}\n+â”Š   â”Š152â”Š      </ul>\n+â”Š   â”Š153â”Š      {chatName && (\n+â”Š   â”Š154â”Š        <CompleteGroupButton\n+â”Š   â”Š155â”Š          history={history}\n+â”Š   â”Š156â”Š          groupName={chatName}\n+â”Š   â”Š157â”Š          groupPicture={chatPicture}\n+â”Š   â”Š158â”Š          users={users}\n+â”Š   â”Š159â”Š        />\n+â”Š   â”Š160â”Š      )}\n+â”Š   â”Š161â”Š    </Style>\n+â”Š   â”Š162â”Š  )\n+â”Š   â”Š163â”Š}\n```\n\n[}]: #\n\nThat's it! Now we should be able to create group chats and message multiple people at once."
          }
        ]
      }
    ]
  }
]
