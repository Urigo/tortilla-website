[
  {
    "repoUrl": "https://github.com/Urigo/whatsapp-textrepo-angularcli-express",
    "branchName": "master",
    "historyBranchName": "master-history",
    "releases": [
      {
        "releaseVersion": "next",
        "releaseDate": "2018-11-30 16:34:02 +0800",
        "tagName": "master@next",
        "tagRevision": "2258c51d4b5ec75ee1d6d29608500559ce315144",
        "historyRevision": "c66e2a09d72f04deef1646a02213aa4004c89580",
        "changesDiff": "diff --git a/.tortilla/manuals/templates/step12.tmpl b/.tortilla/manuals/templates/step12.tmpl\nindex 89e1449..45f3693 100644\n--- a/.tortilla/manuals/templates/step12.tmpl\n+++ b/.tortilla/manuals/templates/step12.tmpl\n@@ -1,9 +1,13 @@\n+![new-chat](https://user-images.githubusercontent.com/7648874/49270347-ea25ea00-f4a3-11e8-98ac-f67de8bfd8d5.png)\n+\n+![new-group](https://user-images.githubusercontent.com/7648874/49270350-ec884400-f4a3-11e8-8baa-b6bba0f7f539.png)\n+\n We still cannot create new chats or groups, so let's implement it.\n\n We're going to create a `ChatsCreation` module, with a `NewChat` and a `NewGroup` containers, along with several presentational components.\n\n We're going to make use of the selectable list directive once again, to ease selecting the users when we're creating a new group.\n-You should also notice that we are looking for existing chats before creating a new one: if it already exists we're are simply redirecting to that chat instead of creating a new one (the server wouldn't allow that anyway and it will simply\n+You should also notice that we are looking for existing chats before creating a new one: if it already exists we're simply redirecting to that chat instead of creating a new one (the server wouldn't allow that anyway and it will simply\n return the chat id).\n\n {{{ diffStep \"8.1\" module=\"client\" files=\"src/graphql/\" }}}\n@@ -18,11 +22,19 @@ Let's jump straight into `ChatsService` and add few new methods:\n\n Okay, now since we got the GraphQL part ready, we're going to focus on the component.\n\n-First, space to add a new group:\n+First, we will download the default group-chat picture:\n+\n+    $ wget https://raw.githubusercontent.com/DAB0mB/whatsapp-client-angularcli-material/c75c2416b1990da3588015f76b8338764f44d6ec/src/assets/default-group-pic.jpg -P src/assets\n+\n+And update the relevant chat components to use it when necessary:\n+\n+{{{ diffStep \"8.1\" module=\"client\" files=\"src/app/chat-viewer/containers/chat/chat.component.ts, src/app/chats-lister/components/chat-item/chat-item.component.ts\" }}}\n+\n+Then we will create a space to add a new group:\n\n {{{ diffStep \"8.1\" module=\"client\" files=\"src/app/chats-creation/containers/new-group/new-group.component.ts, src/app/chats-creation/containers/new-group/new-group.component.scss\" }}}\n\n-Next, a new chat view:\n+And after, a new chat view:\n\n src/app/chats-creation/containers/new-chat/new-chat.component.scss, src/app/chats-creation/containers/new-chat/new-chat.component.ts\n\ndiff --git a/.tortilla/manuals/templates/step14.tmpl b/.tortilla/manuals/templates/step14.tmpl\nindex 43bf21b..fc7d5e6 100644\n--- a/.tortilla/manuals/templates/step14.tmpl\n+++ b/.tortilla/manuals/templates/step14.tmpl\n@@ -1,3 +1,5 @@\n+![login](https://user-images.githubusercontent.com/7648874/49270369-06c22200-f4a4-11e8-83e5-cef2400989a6.jpg)\n+\n ## Authentication on server\n\n Authentication is an hot topic in the GraphQL world and there are some projects which aim at authenticating through GraphQL.\n@@ -45,6 +47,12 @@ Now it's time to create a `SignIn`/`SignUp` component. Since we use Passport in\n Since we use `Basic Auth` we will simply combine the username and the password together to create the authentication header.\n We will also store the response from the server, which will contain the user information like the ID, etc. which we are going to need later.\n\n+First we we will download a WhatsApp picture that will be used in the login component:\n+\n+    $ wget https://user-images.githubusercontent.com/7648874/49260078-e7f96680-f476-11e8-8711-06bc6490858a.png -P src/assets\n+\n+And then we will proceed to creating the component itself and everything around it:\n+\n {{{ diffStep \"10.1\" module=\"client\" files=\"src/app/login/containers, src/app/login/login.module.ts\" }}}\n\n Now it's time use the Interceptor we just created:\ndiff --git a/.tortilla/manuals/templates/step5.tmpl b/.tortilla/manuals/templates/step5.tmpl\nindex 9485eda..5024019 100644\n--- a/.tortilla/manuals/templates/step5.tmpl\n+++ b/.tortilla/manuals/templates/step5.tmpl\n@@ -1,3 +1,5 @@\n+![chats-list](https://user-images.githubusercontent.com/7648874/49271096-36bef480-f4a7-11e8-87a9-c9f203f20f6a.png)\n+\n ## Server\n\n After the planning phase it's finally time to start writing some real code!\n@@ -346,7 +348,11 @@ We're now creating a `shared` module where we will define our header component w\n\n {{{ diffStep \"1.3\" module=\"client\" files=\"src/app/shared/*\" }}}\n\n-Now we want to create the `chats-lister` module, with a container component called `ChatsComponent` and a couple of presentational components.\n+Now we want to create the `chats-lister` module, with a container component called `ChatsComponent` and a couple of presentational components. Each and every chat item would be presented with a default profile picture as a placeholder, so before we proceed we will have to download it to the `src/assets` directory:\n+\n+    $ wget https://raw.githubusercontent.com/DAB0mB/whatsapp-client-angularcli-material/c75c2416b1990da3588015f76b8338764f44d6ec/src/assets/default-profile-pic.jpg -P src/assets\n+\n+And now we can proceed to creating the relevant components and their style sheets:\n\n {{{ diffStep \"1.3\" module=\"client\" files=\"src/app/chats-lister/*\" }}}\n\ndiff --git a/.tortilla/manuals/templates/step8.tmpl b/.tortilla/manuals/templates/step8.tmpl\nindex 628619b..db5130c 100644\n--- a/.tortilla/manuals/templates/step8.tmpl\n+++ b/.tortilla/manuals/templates/step8.tmpl\n@@ -1,3 +1,5 @@\n+![chat](https://user-images.githubusercontent.com/7648874/49270290-92877e80-f4a3-11e8-8984-d3ee920838ed.png)\n+\n At this point we have a module which lists all of our chats, but we still need to show a particular chat.\n We're going to implement in in this chapter.\n\n@@ -40,7 +42,13 @@ The `ChatComponent` component contains:\n\n ### List of messages\n\n-We now split the list of messages to the host:\n+First we'll download and a couple of images which will help us create a \"bubble\" effect for received messages:\n+\n+    $ wget https://raw.githubusercontent.com/Urigo/whatsapp-client-angularcli-material/c75c2416b1990da3588015f76b8338764f44d6ec/src/assets/chat-background.jpg -P src/assets\n+    $ wget https://raw.githubusercontent.com/Urigo/whatsapp-client-angularcli-material/https://raw.githubusercontent.com/Urigo/whatsapp-client-angularcli-material/c75c2416b1990da3588015f76b8338764f44d6ec/src/assets/chat-background.jpg/src/assets/message-mine.png -P src/assets\n+    $ wget https://raw.githubusercontent.com/Urigo/whatsapp-client-angularcli-material/https://raw.githubusercontent.com/Urigo/whatsapp-client-angularcli-material/c75c2416b1990da3588015f76b8338764f44d6ec/src/assets/chat-background.jpg/src/assets/message-other.png -P src/assets\n+\n+We'll now split the list of messages to the host:\n\n {{{ diffStep \"4.1\" module=\"client\" files=\"src/app/chat-viewer/components/messages-list/messages-list.component.ts, src/app/chat-viewer/components/messages-list/messages-list.component.scss\" }}}\n\ndiff --git a/client/src/app/chat-viewer/components/message-item/message-item.component.scss b/client/src/app/chat-viewer/components/message-item/message-item.component.scss\nindex d680766..d5cd428 100644\n--- a/client/src/app/chat-viewer/components/message-item/message-item.component.scss\n+++ b/client/src/app/chat-viewer/components/message-item/message-item.component.scss\n@@ -1,18 +1,74 @@\n :host {\n-  display: flex;\n-  width: 100%;\n+  margin-bottom: 9px;\n+\n+  &::after {\n+    content: \"\";\n+    display: table;\n+    clear: both;\n+  }\n }\n\n .message {\n-  max-width: 75%;\n-  background-color: lightgoldenrodyellow;\n+  display: inline-block;\n+  position: relative;\n+  max-width: 100%;\n+  border-radius: 7px;\n+  box-shadow: 0 1px 2px rgba(0, 0, 0, .15);\n+  margin-bottom: 20px;\n+  clear: both;\n+\n+  &.message-mine {\n+    float: right;\n+    background-color: #DCF8C6;\n+\n+    &::before {\n+      right: -11px;\n+      background-image: url(/assets/message-mine.png)\n+    }\n+  }\n+\n+  &.message-other {\n+    float: left;\n+    background-color: #FFF;\n+\n+    &::before {\n+      left: -11px;\n+      background-image: url(/assets/message-other.png)\n+    }\n+  }\n+\n+  &.message-other::before, &.message-mine::before {\n+    content: \"\";\n+    position: absolute;\n+    bottom: 3px;\n+    width: 12px;\n+    height: 19px;\n+    background-position: 50% 50%;\n+    background-repeat: no-repeat;\n+    background-size: contain;\n+  }\n+\n+  .message-content {\n+    padding: 5px 7px;\n+    word-wrap: break-word;\n\n-  &.mine {\n-    background-color: lightcyan;\n-    margin-left: auto;\n+    &::after {\n+      content: \" \\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\";\n+      display: inline;\n+    }\n   }\n\n   .message-sender {\n-    font-size: small;\n+    font-weight: bold;\n+    font-size: 0.9em;\n+    padding: 5px;\n   }\n-}\n+\n+  .message-timestamp {\n+    position: absolute;\n+    bottom: 2px;\n+    right: 7px;\n+    color: gray;\n+    font-size: 12px;\n+  }\n+}\n\\ No newline at end of file\ndiff --git a/client/src/app/chat-viewer/components/message-item/message-item.component.ts b/client/src/app/chat-viewer/components/message-item/message-item.component.ts\nindex 9a9d401..447821e 100644\n--- a/client/src/app/chat-viewer/components/message-item/message-item.component.ts\n+++ b/client/src/app/chat-viewer/components/message-item/message-item.component.ts\n@@ -5,9 +5,10 @@ import {GetChat} from '../../../../graphql';\n   selector: 'app-message-item',\n   template: `\n     <div class=\"message\"\n-         [ngClass]=\"{'mine': message.ownership}\">\n+         [ngClass]=\"message.ownership ? 'message-mine' : 'message-other'\">\n       <div *ngIf=\"isGroup && !message.ownership\" class=\"message-sender\">{{ message.sender.name }}</div>\n-      <div>{{ message.content }}</div>\n+      <div class=\"message-content\">{{ message.content }}</div>\n+      <span class=\"message-timestamp\">00:00</span>\n     </div>\n   `,\n   styleUrls: ['message-item.component.scss'],\ndiff --git a/client/src/app/chat-viewer/components/messages-list/messages-list.component.scss b/client/src/app/chat-viewer/components/messages-list/messages-list.component.scss\nindex ed1ac7c..f478838 100644\n--- a/client/src/app/chat-viewer/components/messages-list/messages-list.component.scss\n+++ b/client/src/app/chat-viewer/components/messages-list/messages-list.component.scss\n@@ -1,12 +1,15 @@\n :host {\n   display: block;\n   height: 100%;\n-  overflow-y: scroll;\n-  background-color: aliceblue;\n+  overflow-y: overlay;\n+}\n+\n+::ng-deep .mat-list-item-content {\n+  display: block !important;\n }\n\n /*\n :host::-webkit-scrollbar {\n   display: none;\n }\n-*/\n+*/\n\\ No newline at end of file\ndiff --git a/client/src/app/chat-viewer/components/new-message/new-message.component.scss b/client/src/app/chat-viewer/components/new-message/new-message.component.scss\nindex da4ed4f..b76b70e 100644\n--- a/client/src/app/chat-viewer/components/new-message/new-message.component.scss\n+++ b/client/src/app/chat-viewer/components/new-message/new-message.component.scss\n@@ -1,13 +1,32 @@\n :host {\n   display: flex;\n-  height: 8vh;\n+  height: 50px;\n+  padding: 5px;\n }\n\n input {\n   width: 100%;\n+  border: none;\n+  border-radius: 999px;\n+  padding: 10px;\n+  padding-left: 20px;\n+  padding-right: 20px;\n+  font-size: 15px;\n+  outline: none;\n+  box-shadow: 0 1px silver;\n+  font-size: 18px;\n+  line-height: 45px;\n }\n\n button {\n-  width: 8vh;\n-  min-width: 56px;\n-}\n+  min-width: 45px;\n+  width: 45px;\n+  border-radius: 999px;\n+  background-color: var(--primary);\n+  margin-left: 5px;\n+  color: white;\n+\n+  mat-icon {\n+    margin-left: -3px;\n+  }\n+}\n\\ No newline at end of file\ndiff --git a/client/src/app/chat-viewer/components/new-message/new-message.component.ts b/client/src/app/chat-viewer/components/new-message/new-message.component.ts\nindex 10b526c..2eeb454 100644\n--- a/client/src/app/chat-viewer/components/new-message/new-message.component.ts\n+++ b/client/src/app/chat-viewer/components/new-message/new-message.component.ts\n@@ -3,7 +3,7 @@ import {Component, EventEmitter, Input, Output} from '@angular/core';\n @Component({\n   selector: 'app-new-message',\n   template: `\n-    <input type=\"text\" [(ngModel)]=\"message\" (keyup)=\"onInputKeyup($event)\"/>\n+    <input type=\"text\" placeholder=\"Type a message\" [(ngModel)]=\"message\" (keyup)=\"onInputKeyup($event)\"/>\n     <button mat-button (click)=\"emitMessage()\" [disabled]=\"disabled\">\n       <mat-icon aria-label=\"Icon-button with a send icon\">send</mat-icon>\n     </button>\ndiff --git a/client/src/app/chat-viewer/containers/chat/chat.component.scss b/client/src/app/chat-viewer/containers/chat/chat.component.scss\nindex 56ffb7e..f411507 100644\n--- a/client/src/app/chat-viewer/containers/chat/chat.component.scss\n+++ b/client/src/app/chat-viewer/containers/chat/chat.component.scss\n@@ -1,10 +1,33 @@\n+app-toolbar {\n+  .navigation {\n+    padding: 0;\n+    display: inherit;\n+    margin-right: -40px;\n+  }\n+\n+  .title {\n+    line-height: 8vh;\n+  }\n+\n+  .profile-pic {\n+    height: calc(100% - 10px);\n+    width: auto;\n+    padding: 5px;\n+    border-radius: 50%;\n+  }\n+}\n+\n .container {\n   display: flex;\n   flex-flow: column;\n   justify-content: space-between;\n   height: calc(100vh - 8vh);\n+  background-image: url(/assets/chat-background.jpg);\n+  background-color: #E0DAD6;\n+  background-repeat: no-repeat;\n+  background-size: cover;\n\n   app-confirm-selection {\n     bottom: 10vh;\n   }\n-}\n+}\n\\ No newline at end of file\ndiff --git a/client/src/app/chat-viewer/containers/chat/chat.component.ts b/client/src/app/chat-viewer/containers/chat/chat.component.ts\nindex 7c83ea2..cc5cfb6 100644\n--- a/client/src/app/chat-viewer/containers/chat/chat.component.ts\n+++ b/client/src/app/chat-viewer/containers/chat/chat.component.ts\n@@ -12,6 +12,7 @@ import {QueryRef} from 'apollo-angular';\n       <button class=\"navigation\" mat-button (click)=\"goToChats()\">\n         <mat-icon aria-label=\"Icon-button with an arrow back icon\">arrow_back</mat-icon>\n       </button>\n+      <img class=\"profile-pic\" src=\"assets/default-profile-pic.jpg\">\n       <div class=\"title\">{{ name }}</div>\n     </app-toolbar>\n     <div class=\"container\">\ndiff --git a/client/src/app/chats-creation/components/new-group-details/new-group-details.component.scss b/client/src/app/chats-creation/components/new-group-details/new-group-details.component.scss\nindex 458b376..e78980b 100644\n--- a/client/src/app/chats-creation/components/new-group-details/new-group-details.component.scss\n+++ b/client/src/app/chats-creation/components/new-group-details/new-group-details.component.scss\n@@ -1,5 +1,6 @@\n :host {\n   display: block;\n+  font-family: Roboto, \"Helvetica Neue\", sans-serif;\n }\n\n div {\n@@ -17,9 +18,25 @@ div {\n\n .users {\n   display: flex;\n-  flex-flow: row wrap;\n-  img {\n-    flex: 0 1 8vh;\n-    height: 8vh;\n+  overflow: overlay;\n+\n+  .user {\n+    padding-top: 0;\n+    flex-flow: row wrap;\n+    text-align: center;\n   }\n-}\n+\n+  .user-profile-pic {\n+    flex: 0 1 50px;\n+    height: 50px;\n+    border-radius: 50%;\n+    display: block;\n+    margin-left: auto;\n+    margin-right: auto;\n+  }\n+\n+  .user-name {\n+    line-height: 10px;\n+    font-size: 14px;\n+  }\n+}\n\\ No newline at end of file\ndiff --git a/client/src/app/chats-creation/components/new-group-details/new-group-details.component.ts b/client/src/app/chats-creation/components/new-group-details/new-group-details.component.ts\nindex 0342057..af76b84 100644\n--- a/client/src/app/chats-creation/components/new-group-details/new-group-details.component.ts\n+++ b/client/src/app/chats-creation/components/new-group-details/new-group-details.component.ts\n@@ -5,17 +5,20 @@ import {GetUsers} from '../../../../graphql';\n   selector: 'app-new-group-details',\n   template: `\n     <div>\n-      <mat-form-field>\n+      <mat-form-field color=\"default\">\n         <input matInput placeholder=\"Group name\" [(ngModel)]=\"groupName\">\n       </mat-form-field>\n     </div>\n-    <button [disabled]=\"!groupName\" class=\"new-group\" mat-fab color=\"primary\" (click)=\"emitGroupDetails()\">\n+    <button *ngIf=\"groupName\" class=\"new-group\" mat-fab color=\"secondary\" (click)=\"emitGroupDetails()\">\n       <mat-icon aria-label=\"Icon-button with a + icon\">arrow_forward</mat-icon>\n     </button>\n-    <div>Members</div>\n-    <div class=\"users\">\n-      <img *ngFor=\"let user of users;\" [src]=\"user.picture\"/>\n-    </div>\n+    <div>Participants: {{ users.length }}</div>\n+    <span class=\"users\">\n+      <div class=\"user\" *ngFor=\"let user of users\">\n+        <img class=\"user-profile-pic\" [src]=\"user.picture || 'assets/default-profile-pic.jpg'\"/>\n+        <span class=\"user-name\">{{ user.name }}</span>\n+      </div>\n+    </span>\n   `,\n   styleUrls: ['new-group-details.component.scss'],\n })\n@@ -31,4 +34,4 @@ export class NewGroupDetailsComponent {\n       this.groupDetails.emit(this.groupName);\n     }\n   }\n-}\n+}\n\\ No newline at end of file\ndiff --git a/client/src/app/chats-creation/components/user-item/user-item.component.scss b/client/src/app/chats-creation/components/user-item/user-item.component.scss\nindex 9d7b0cf..f7fbc5e 100644\n--- a/client/src/app/chats-creation/components/user-item/user-item.component.scss\n+++ b/client/src/app/chats-creation/components/user-item/user-item.component.scss\n@@ -5,24 +5,39 @@\n }\n\n button {\n-  padding: 0;\n-  display: flex;\n-  align-items: center;\n-  height: 100%;\n-  width: 100%;\n+  background-color: inherit !important;\n+  outline: none !important;\n+  margin: 10px;\n+  height: 50px;\n+  padding: 1px 6px;\n+  line-height: 50px;\n   border: none;\n+  margin: 0;\n+  position: relative;\n\n-  div:first-of-type {\n-    display: flex;\n-    justify-content: center;\n-    align-items: center;\n+  img {\n+    float: left;\n+    margin-right: 10px;\n+    height: 50px;\n+    width: 50px;\n+    text-align: center;\n+    line-height: inherit;\n+    border-radius: 50%;\n+  }\n\n-    img {\n-      max-width: 100%;\n-    }\n+  div {\n+    float: left;\n+    line-height: inherit;\n+    font-family: Roboto, \"Helvetica Neue\", sans-serif;\n+    font-weight: bold;\n+    font-size: 16px;\n   }\n\n-  div:nth-of-type(2) {\n-    padding-left: 16px;\n+  mat-icon {\n+    color: var(--primary) !important;\n+    opacity: .7;\n+    position: absolute;\n+    left: 40px;\n+    top: 30px;\n   }\n-}\n+}\n\\ No newline at end of file\ndiff --git a/client/src/app/chats-creation/components/user-item/user-item.component.ts b/client/src/app/chats-creation/components/user-item/user-item.component.ts\nindex 6a89cf6..110315e 100644\n--- a/client/src/app/chats-creation/components/user-item/user-item.component.ts\n+++ b/client/src/app/chats-creation/components/user-item/user-item.component.ts\n@@ -5,16 +5,16 @@ import {GetUsers} from '../../../../graphql';\n   selector: 'app-user-item',\n   template: `\n     <button mat-menu-item>\n-      <div>\n-        <img [src]=\"user.picture\" *ngIf=\"user.picture\">\n-      </div>\n+      <img [src]=\"user.picture || 'assets/default-profile-pic.jpg'\">\n       <div>{{ user.name }}</div>\n+      <mat-icon *ngIf=\"selected\" aria-label=\"Icon-button with a group add icon\">check_circle</mat-icon>\n     </button>\n   `,\n   styleUrls: ['user-item.component.scss']\n })\n export class UserItemComponent {\n   // tslint:disable-next-line:no-input-rename\n-  @Input('item')\n-  user: GetUsers.Users;\n-}\n+  @Input('item') user: GetUsers.Users;\n+  // tslint:disable-next-line:no-input-rename\n+  @Input() selected: string;\n+}\n\\ No newline at end of file\ndiff --git a/client/src/app/chats-creation/components/users-list/users-list.component.scss b/client/src/app/chats-creation/components/users-list/users-list.component.scss\nindex 5d4e87f..826a5a4 100644\n--- a/client/src/app/chats-creation/components/users-list/users-list.component.scss\n+++ b/client/src/app/chats-creation/components/users-list/users-list.component.scss\n@@ -1,3 +1,13 @@\n :host {\n   display: block;\n }\n+\n+:host ::ng-deep mat-list:first-child > mat-list-item div:first-child {\n+  padding: 0 !important;\n+  margin: 5px;\n+  margin-top: 20px;\n+}\n+\n+mat-list {\n+  padding: 0;\n+}\n\\ No newline at end of file\ndiff --git a/client/src/app/chats-creation/components/users-list/users-list.component.ts b/client/src/app/chats-creation/components/users-list/users-list.component.ts\nindex fadcf36..01092e5 100644\n--- a/client/src/app/chats-creation/components/users-list/users-list.component.ts\n+++ b/client/src/app/chats-creation/components/users-list/users-list.component.ts\n@@ -8,6 +8,7 @@ import {SelectableListDirective} from 'ngx-selectable-list';\n     <mat-list>\n       <mat-list-item *ngFor=\"let user of users\">\n         <app-user-item [item]=\"user\"\n+                       [selected]=\"selectableListDirective.selectedItemIds.includes(user.id)\"\n                        libSelectableItem></app-user-item>\n       </mat-list-item>\n     </mat-list>\ndiff --git a/client/src/app/chats-creation/containers/new-chat/new-chat.component.scss b/client/src/app/chats-creation/containers/new-chat/new-chat.component.scss\nindex ec7b4f8..54c73ad 100644\n--- a/client/src/app/chats-creation/containers/new-chat/new-chat.component.scss\n+++ b/client/src/app/chats-creation/containers/new-chat/new-chat.component.scss\n@@ -1,23 +1,23 @@\n .new-group {\n-  display: flex;\n-  height: 8vh;\n-  align-items: center;\n+  margin: 10px;\n+  height: 50px;\n+  line-height: 50px;\n+  margin-top: 20px;\n\n-  div:first-of-type {\n-    height: 8vh;\n-    width: 8vh;\n-    display: flex;\n-    justify-content: center;\n-    align-items: center;\n-\n-    mat-icon {\n-      height: 5vh;\n-      width: 5vh;\n-      font-size: 5vh;\n-    }\n+  mat-icon {\n+    float: left;\n+    margin-right: 10px;\n+    height: 50px;\n+    width: 50px;\n+    text-align: center;\n+    line-height: inherit;\n+    border-radius: 50%;\n   }\n\n-  div:nth-of-type(2) {\n-    padding: 16px;\n+  div {\n+    float: left;\n+    line-height: inherit;\n+    font-family: Roboto, \"Helvetica Neue\", sans-serif;\n+    font-weight: bold;\n   }\n-}\n+}\n\\ No newline at end of file\ndiff --git a/client/src/app/chats-creation/containers/new-chat/new-chat.component.ts b/client/src/app/chats-creation/containers/new-chat/new-chat.component.ts\nindex 44deb10..d8470a5 100644\n--- a/client/src/app/chats-creation/containers/new-chat/new-chat.component.ts\n+++ b/client/src/app/chats-creation/containers/new-chat/new-chat.component.ts\n@@ -12,14 +12,10 @@ import {ChatsService} from '../../../services/chats.service';\n       </button>\n       <div class=\"title\">New chat</div>\n     </app-toolbar>\n-\n     <div class=\"new-group\" (click)=\"goToNewGroup()\">\n-      <div>\n-        <mat-icon aria-label=\"Icon-button with a group add icon\">group_add</mat-icon>\n-      </div>\n+      <mat-icon color=\"secondary\" aria-label=\"Icon-button with a group add icon\">group_add</mat-icon>\n       <div>New group</div>\n     </div>\n-\n     <app-users-list [items]=\"users\"\n                     libSelectableList=\"single\" (single)=\"addChat($event)\">\n     </app-users-list>\ndiff --git a/client/src/app/chats-lister/components/chat-item/chat-item.component.scss b/client/src/app/chats-lister/components/chat-item/chat-item.component.scss\nindex 78a5e41..4ce2548 100644\n--- a/client/src/app/chats-lister/components/chat-item/chat-item.component.scss\n+++ b/client/src/app/chats-lister/components/chat-item/chat-item.component.scss\n@@ -4,14 +4,41 @@\n }\n\n .chat-row {\n-  padding: 0;\n+  margin: 10px 0 0 10px;\n+  height: 60px;\n   display: flex;\n-  width: 100%;\n-  justify-content: space-between;\n-  align-items: center;\n\n-  .chat-recipient {\n-    display: flex;\n-    width: 60%;\n+  .chat-pic {\n+    height: 50px;\n+    width: auto;\n+    border-radius: 50%;\n   }\n-}\n+\n+  .chat-info {\n+    width: calc(100% - 60px);\n+    height: 100%;\n+    margin-left: 10px;\n+    border-bottom: .5px solid silver;\n+    position: relative;\n+\n+    .chat-name {\n+      margin-top: 5px;\n+    }\n+\n+    .chat-last-message {\n+      color: gray;\n+      font-size: 15px;\n+      margin-top: 5px;\n+      text-overflow: ellipsis;\n+      overflow: hidden;\n+    }\n+\n+    .chat-timestamp {\n+      position: absolute;\n+      color: gray;\n+      top: 5px;\n+      right: 5px;\n+      font-size: 13px;\n+    }\n+  }\n+}\n\\ No newline at end of file\ndiff --git a/client/src/app/chats-lister/components/chat-item/chat-item.component.ts b/client/src/app/chats-lister/components/chat-item/chat-item.component.ts\nindex d10268a..297ef7d 100644\n--- a/client/src/app/chats-lister/components/chat-item/chat-item.component.ts\n+++ b/client/src/app/chats-lister/components/chat-item/chat-item.component.ts\n@@ -5,13 +5,12 @@ import {GetChats} from '../../../../graphql';\n   selector: 'app-chat-item',\n   template: `\n     <div class=\"chat-row\">\n-        <div class=\"chat-recipient\">\n-          <img *ngIf=\"chat.picture\" [src]=\"chat.picture\" width=\"48\" height=\"48\">\n-          <div>{{ chat.name }} [id: {{ chat.id }}]</div>\n-        </div>\n-        <div class=\"chat-content\">\n-          {{ chat.messageFeed.messages[chat.messageFeed.messages.length - 1]?.content | truncate : 20 : '...' }}\n-        </div>\n+      <img class=\"chat-pic\" [src]=\"chat.picture || 'assets/default-profile-pic.jpg'\">\n+      <div class=\"chat-info\">\n+        <div class=\"chat-name\">{{ chat.name }}</div>\n+        <div class=\"chat-last-message\">{{ chat.messageFeed.messages[chat.messageFeed.messages.length - 1]?.content }}</div>\n+        <div class=\"chat-timestamp\">00:00</div>\n+      </div>\n     </div>\n   `,\n   styleUrls: ['chat-item.component.scss'],\ndiff --git a/client/src/app/chats-lister/components/chats-list/chats-list.component.scss b/client/src/app/chats-lister/components/chats-list/chats-list.component.scss\nindex 5d4e87f..c06f0c2 100644\n--- a/client/src/app/chats-lister/components/chats-list/chats-list.component.scss\n+++ b/client/src/app/chats-lister/components/chats-list/chats-list.component.scss\n@@ -1,3 +1,13 @@\n :host {\n   display: block;\n+  height: 60px;\n }\n+\n+:host ::ng-deep .mat-list-item-content:first-child {\n+  padding-left: 0 !important;\n+  display: flow-root !important;\n+}\n+\n+mat-list-item {\n+  height: 75px !important;\n+}\n\\ No newline at end of file\ndiff --git a/client/src/app/chats-lister/containers/chats/chats.component.ts b/client/src/app/chats-lister/containers/chats/chats.component.ts\nindex da62ccb..16a4f52 100644\n--- a/client/src/app/chats-lister/containers/chats/chats.component.ts\n+++ b/client/src/app/chats-lister/containers/chats/chats.component.ts\n@@ -34,8 +34,8 @@ import {Router} from '@angular/router';\n       <app-confirm-selection #confirmSelection></app-confirm-selection>\n     </app-chats-list>\n\n-    <button *ngIf=\"!isSelecting\" class=\"chat-button\" mat-fab color=\"primary\" (click)=\"goToNewChat()\">\n-      <mat-icon aria-label=\"Icon-button with a + icon\">add</mat-icon>\n+    <button *ngIf=\"!isSelecting\" class=\"chat-button\" mat-fab color=\"secondary\" (click)=\"goToNewChat()\">\n+      <mat-icon aria-label=\"Icon-button with a + icon\">chat</mat-icon>\n     </button>\n   `,\n   styleUrls: ['./chats.component.scss'],\ndiff --git a/client/src/app/login/containers/login.component.scss b/client/src/app/login/containers/login.component.scss\nindex 1897a22..3402e12 100644\n--- a/client/src/app/login/containers/login.component.scss\n+++ b/client/src/app/login/containers/login.component.scss\n@@ -1,10 +1,67 @@\n :host {\n+  height: 100vh;\n   display: block;\n+  background: radial-gradient(rgb(34,65,67), rgb(17,48,50)), url(/assets/chat-background.jpg) no-repeat;\n+  background-size: cover;\n+  background-blend-mode: multiply;\n+\n+  > img {\n+    width: 35%;\n+    height: auto;\n+    margin-left: auto;\n+    margin-right: auto;\n+    padding-top: 70px;\n+    display: block;\n+  }\n+\n+  > h2 {\n+    width: 100%;\n+    text-align: center;\n+    color: white;\n+  }\n+}\n+\n+form {\n+  padding: 20px;\n+\n+  > div {\n+    padding-top: 20px;\n+    padding-bottom: 20px;\n+  }\n+}\n+\n+mat-form-field ::ng-deep {\n+  width: 100%;\n+  background-color: transparent !important;\n+\n+  mat-label {\n+    color: white !important ;\n+  }\n+\n+  .mat-form-field-underline {\n+    background-color: white !important;\n+  }\n+\n+  .mat-focused .mat-form-field-label {\n+    color: white !important;\n+  }\n+\n+  .mat-form-field-ripple {\n+    background-color: var(--primary) !important;\n+  }\n+\n+  .mat-input-element {\n+    caret-color: white !important;\n+  }\n+\n+  .mat-input-element::placeholder {\n+    color: var(--primary);\n+  }\n }\n\n-form:first-of-type {\n-  margin-top: 24px;\n-  margin-bottom: 48px;\n+legend {\n+  font-weight: bold;\n+  color: white;\n }\n\n label {\n@@ -13,6 +70,27 @@ label {\n   margin-bottom: 4px;\n }\n\n+button {\n+  width: 100px;\n+  display: block;\n+  margin-left: auto;\n+  margin-right: auto;\n+}\n+\n .error {\n   color: red;\n+  font-size: 13px;\n+  margin-top: -15.5px;\n }\n+\n+.alternative {\n+  position: fixed;\n+  left: 10px;\n+  bottom: 10px;\n+  color: white;\n+  font-size: 14px;\n+\n+  a {\n+    color: var(--secondary);\n+  }\n+}\n\\ No newline at end of file\ndiff --git a/client/src/app/login/containers/login.component.ts b/client/src/app/login/containers/login.component.ts\nindex 4cac0d4..b8c8095 100644\n--- a/client/src/app/login/containers/login.component.ts\n+++ b/client/src/app/login/containers/login.component.ts\n@@ -9,63 +9,62 @@ import {LoginService} from '../services/login.service';\n @Component({\n   selector: 'app-login',\n   template: `\n-    <form (ngSubmit)=\"signIn()\" [formGroup]=\"signInForm\" novalidate>\n-      <fieldset fxLayout=\"column\" fxLayoutGap=\"17px\">\n-        <legend>Sign in</legend>\n-        <div>\n-          <label>Username</label>\n-          <input formControlName=\"username\" autocomplete=\"username\" type=\"text\">\n-        </div>\n+    <img src=\"assets/whatsapp-icon.png\" />\n+    <h2>WhatsApp Clone</h2>\n+    <form *ngIf=\"signingIn\" (ngSubmit)=\"signIn()\" [formGroup]=\"signInForm\" novalidate>\n+      <legend>Sign in</legend>\n+      <div style=\"width: 100%\">\n+        <mat-form-field>\n+          <mat-label>Username</mat-label>\n+          <input matInput autocomplete=\"username\" formControlName=\"username\" type=\"text\" placeholder=\"Enter your username\" />\n+        </mat-form-field>\n         <div class=\"error\" *ngIf=\"signInForm.get('username').hasError('required') && signInForm.get('username').touched\">\n           Username is required\n         </div>\n-\n-        <div>\n-          <label>Password</label>\n-          <input formControlName=\"password\" autocomplete=\"current-password\" type=\"password\">\n-        </div>\n+        <mat-form-field>\n+          <mat-label>Password</mat-label>\n+          <input matInput autocomplete=\"current-password\" formControlName=\"password\" type=\"password\" placeholder=\"Enter your password\" />\n+        </mat-form-field>\n         <div class=\"error\" *ngIf=\"signInForm.get('password').hasError('required') && signInForm.get('password').touched\">\n           Password is required\n         </div>\n-\n-        <button type=\"submit\" [disabled]=\"signInForm.invalid\">Sign in</button>\n-      </fieldset>\n+      </div>\n+      <button mat-button type=\"submit\" color=\"secondary\" [disabled]=\"signInForm.invalid\">Sign in</button>\n+      <span class=\"alternative\">Don't have an account yet? <a (click)=\"signingIn = false\">Sign up!</a></span>\n     </form>\n-\n-    <form (ngSubmit)=\"signUp()\" [formGroup]=\"signUpForm\" novalidate>\n-      <fieldset fxLayout=\"column\" fxLayoutGap=\"17px\">\n-        <legend>Sign up</legend>\n-        <div>\n-          <label>Name</label>\n-          <input formControlName=\"name\" type=\"text\">\n-        </div>\n-\n-        <div>\n-          <label>Username</label>\n-          <input formControlName=\"username\" autocomplete=\"username\" type=\"text\">\n-        </div>\n+    <form *ngIf=\"!signingIn\" (ngSubmit)=\"signUp()\" [formGroup]=\"signUpForm\" novalidate>\n+      <legend>Sign up</legend>\n+      <div style=\"float: left; width: calc(50% - 10px); padding-right: 10px;\">\n+        <mat-form-field>\n+          <mat-label>Name</mat-label>\n+          <input matInput autocomplete=\"name\" formControlName=\"name\" type=\"text\" placeholder=\"Enter your name\" />\n+        </mat-form-field>\n+        <mat-form-field>\n+          <mat-label>Username</mat-label>\n+          <input matInput autocomplete=\"username\" formControlName=\"username\" type=\"text\" placeholder=\"Enter your username\" />\n+        </mat-form-field>\n         <div class=\"error\" *ngIf=\"signUpForm.get('username').hasError('required') && signUpForm.get('username').touched\">\n           Username is required\n         </div>\n-\n-        <div>\n-          <label>Password</label>\n-          <input formControlName=\"newPassword\" autocomplete=\"new-password\" type=\"password\">\n-        </div>\n+      </div>\n+      <div style=\"float: right; width: calc(50% - 10px); padding-left: 10px;\">\n+        <mat-form-field>\n+          <mat-label>Password</mat-label>\n+          <input matInput autocomplete=\"new-password\" formControlName=\"newPassword\" type=\"password\" placeholder=\"Enter your password\" />\n+        </mat-form-field>\n         <div class=\"error\" *ngIf=\"signUpForm.get('newPassword').hasError('required') && signUpForm.get('newPassword').touched\">\n           Password is required\n         </div>\n-\n-        <div>\n-          <label>Password</label>\n-          <input formControlName=\"confirmPassword\" type=\"password\">\n-        </div>\n+        <mat-form-field>\n+          <mat-label>Confirm Password</mat-label>\n+          <input matInput autocomplete=\"new-password\" formControlName=\"confirmPassword\" type=\"password\" placeholder=\"Confirm your password\" />\n+        </mat-form-field>\n         <div class=\"error\" *ngIf=\"signUpForm.get('confirmPassword').hasError('required') && signUpForm.get('confirmPassword').touched\">\n           Passwords must match\n         </div>\n-\n-        <button type=\"submit\" [disabled]=\"signUpForm.invalid\">Sign up</button>\n-      </fieldset>\n+      </div>\n+      <button mat-button type=\"submit\" color=\"secondary\" [disabled]=\"signUpForm.invalid\">Sign up</button>\n+      <span class=\"alternative\">Already have an account? <a (click)=\"signingIn = true\">Sign in!</a></span>\n     </form>\n   `,\n   styleUrls: ['./login.component.scss'],\n@@ -96,6 +95,8 @@ export class LoginComponent {\n     ]],\n   });\n\n+  private signingIn = true\n+\n   constructor(private http: HttpClient,\n               private fb: FormBuilder,\n               private router: Router,\n@@ -116,7 +117,7 @@ export class LoginComponent {\n   }\n\n   signUp() {\n-    const {username, newPassword: password, name} = this.signInForm.value;\n+    const {username, newPassword: password, name} = this.signUpForm.value;\n     const auth = `Basic ${btoa(`${username}:${password}`)}`;\n     this.http.post('http://localhost:3000/signup', {\n       name,\n@@ -130,4 +131,4 @@ export class LoginComponent {\n       this.router.navigate(['/chats']);\n     }, err => console.error(err));\n   }\n-}\n+}\n\\ No newline at end of file\ndiff --git a/client/src/app/login/login.module.ts b/client/src/app/login/login.module.ts\nindex 9fdda69..efb1666 100644\n--- a/client/src/app/login/login.module.ts\n+++ b/client/src/app/login/login.module.ts\n@@ -1,7 +1,7 @@\n import {RouterModule, Routes} from '@angular/router';\n import {NgModule} from '@angular/core';\n import {TruncateModule} from 'ng2-truncate';\n-import {MatButtonModule, MatIconModule, MatListModule, MatMenuModule} from '@angular/material';\n+import {MatButtonModule, MatIconModule, MatListModule, MatMenuModule, MatFormFieldModule, MatInputModule} from '@angular/material';\n import {SharedModule} from '../shared/shared.module';\n import {BrowserModule} from '@angular/platform-browser';\n import {FormsModule, ReactiveFormsModule} from '@angular/forms';\n@@ -24,6 +24,8 @@ const routes: Routes = [\n   imports: [\n     BrowserModule,\n     // Material\n+    MatInputModule,\n+    MatFormFieldModule,\n     MatMenuModule,\n     MatIconModule,\n     MatButtonModule,\n@@ -49,4 +51,4 @@ const routes: Routes = [\n   ],\n })\n export class LoginModule {\n-}\n+}\n\\ No newline at end of file\ndiff --git a/client/src/app/shared/components/confirm-selection/confirm-selection.component.ts b/client/src/app/shared/components/confirm-selection/confirm-selection.component.ts\nindex 26bd9a9..879daa7 100644\n--- a/client/src/app/shared/components/confirm-selection/confirm-selection.component.ts\n+++ b/client/src/app/shared/components/confirm-selection/confirm-selection.component.ts\n@@ -3,7 +3,7 @@ import {Component, EventEmitter, Input, Output} from '@angular/core';\n @Component({\n   selector: 'app-confirm-selection',\n   template: `\n-    <button mat-fab color=\"primary\" (click)=\"handleClick()\">\n+    <button mat-fab color=\"secondary\" (click)=\"handleClick()\">\n       <mat-icon aria-label=\"Icon-button\">{{ icon }}</mat-icon>\n     </button>\n   `,\ndiff --git a/client/src/app/shared/components/toolbar/toolbar.component.scss b/client/src/app/shared/components/toolbar/toolbar.component.scss\nindex 974207c..2c9049d 100644\n--- a/client/src/app/shared/components/toolbar/toolbar.component.scss\n+++ b/client/src/app/shared/components/toolbar/toolbar.component.scss\n@@ -9,5 +9,7 @@\n\n   .left-block {\n     display: flex;\n+    height: 8vh;\n+    line-height: 8vh;\n   }\n }\ndiff --git a/client/src/app/shared/components/toolbar/toolbar.component.ts b/client/src/app/shared/components/toolbar/toolbar.component.ts\nindex d986d30..0145bf4 100644\n--- a/client/src/app/shared/components/toolbar/toolbar.component.ts\n+++ b/client/src/app/shared/components/toolbar/toolbar.component.ts\n@@ -6,6 +6,7 @@ import {Component} from '@angular/core';\n     <mat-toolbar>\n       <div class=\"left-block\">\n         <ng-content select=\".navigation\"></ng-content>\n+        <ng-content select=\".profile-pic\"></ng-content>\n         <ng-content select=\".title\"></ng-content>\n       </div>\n       <ng-content select=\".menu\"></ng-content>\ndiff --git a/client/src/assets/chat-background.jpg b/client/src/assets/chat-background.jpg\nnew file mode 100644\nindex 0000000..12cf45c\nBinary files /dev/null and b/client/src/assets/chat-background.jpg differ\ndiff --git a/client/src/assets/default-group-pic.jpg b/client/src/assets/default-group-pic.jpg\nnew file mode 100644\nindex 0000000..ea2b844\nBinary files /dev/null and b/client/src/assets/default-group-pic.jpg differ\ndiff --git a/client/src/assets/default-profile-pic.jpg b/client/src/assets/default-profile-pic.jpg\nnew file mode 100644\nindex 0000000..d73721b\nBinary files /dev/null and b/client/src/assets/default-profile-pic.jpg differ\ndiff --git a/client/src/assets/message-mine.png b/client/src/assets/message-mine.png\nnew file mode 100644\nindex 0000000..a5503eb\nBinary files /dev/null and b/client/src/assets/message-mine.png differ\ndiff --git a/client/src/assets/message-other.png b/client/src/assets/message-other.png\nnew file mode 100644\nindex 0000000..a9477be\nBinary files /dev/null and b/client/src/assets/message-other.png differ\ndiff --git a/client/src/assets/whatsapp-icon.png b/client/src/assets/whatsapp-icon.png\nnew file mode 100644\nindex 0000000..d598c08\nBinary files /dev/null and b/client/src/assets/whatsapp-icon.png differ\ndiff --git a/client/src/styles.scss b/client/src/styles.scss\nindex efd56a4..1333057 100644\n--- a/client/src/styles.scss\n+++ b/client/src/styles.scss\n@@ -3,6 +3,54 @@\n /* Meterial theme */\n @import \"~@angular/material/prebuilt-themes/indigo-pink.css\";\n\n+:root {\n+  --primary: #2c6157;\n+  --secondary: #6fd056;\n+}\n+\n body {\n   margin: 0;\n+  font-family: Roboto, \"Helvetica Neue\", sans-serif;\n+}\n+\n+.mat-primary {\n+  background-color: var(--primary) !important;\n+  color: white;\n+}\n+\n+.mat-secondary {\n+  background-color: var(--secondary) !important;\n+  color: white;\n+}\n+\n+.mat-primary-negative {\n+  background-color: white !important;\n+  color: var(--primary);\n+}\n+\n+.mat-secondary-negative {\n+  background-color: white !important;\n+  color: var(--secondary);\n }\n+\n+.mat-default {\n+  background-color: transparent !important;\n+  color: black;\n+}\n+\n+.mat-toolbar {\n+  color: white;\n+  background-color: var(--primary) !important;\n+}\n+\n+.mat-focused .mat-form-field-label {\n+  color: var(--primary) !important;\n+}\n+\n+.mat-form-field-ripple {\n+  background-color: var(--primary) !important;\n+}\n+\n+.mat-input-element {\n+  caret-color: var(--primary) !important;\n+}\n\\ No newline at end of file\ndiff --git a/package.json b/package.json\nindex b1d25d1..1bd4fcf 100644\n--- a/package.json\n+++ b/package.json\n@@ -1,5 +1,7 @@\n {\n   \"name\": \"whatsapp-textrepo-angularcli-express\",\n   \"description\": \"A newly created Tortilla project\",\n-  \"private\": true\n+  \"private\": true,\n+  \"repository\": \"https://github.com/Urigo/whatsapp-textrepo-angularcli-express\",\n+  \"author\": \"Uri Goldshtein <uri.goldshtein@gmail.com>\"\n }\n",
        "manuals": [
          {
            "manualTitle": "A Whatsapp clone written with Angular, Material, Express, Postgresql and Apollo GraphQL.",
            "stepRevision": "56e3257d75fc18dd1850ba8a76ecdc46ad19f508",
            "manualView": "## Startup instructions\n\nThis project is made out of 2 sub-projects - the one is client and the other is server. We will go through the initialization for each of these individually. We will start with the server since the client is dependent on it.\n\n### Server\n\nFirst we need to clone the server project:\n\n    $ git clone git@github.com:Urigo/whatsapp-server-express.git\n\nThen we need to install the NPM dependencies:\n\n    $ npm install\n\nBefore starting the server make sure that postgresql is installed:\n\n    $ sudo apt-get update\n    $ sudo apt-get install postgresql postgresql-contrib\n\nSetup a user named \"test\" with no password by first switching into \"postgres\" account:\n\n    $ sudo -u postgres psql\n\nAnd running the following command:\n\n    postgres=# ALTER USER test WITH PASSWORD '';\n\nTry to run the server:\n\n    $ npm start\n\nIf logs show that connection refused, kill the process and set a random password for the \"test\" user (e.g. \"test\"):\n\n    postgres=# ALTER USER test WITH PASSWORD 'test';\n\nBe sure to set the password in the `ormconfig.json` as well:\n\n```js\n{\n  // ...\n  \"password\": \"test\",\n  // ...\n}\n```\n\nRun the start command again:\n\n    $ npm start\n\n### Client\n\n**Be sure to go through server initialization first**\n\nFirst we need to clone the server project:\n\n    $ git clone git@github.com:Urigo/whatsapp-client-angularcli-material.git\n\nThen we need to install the NPM dependencies:\n\n    $ npm install\n\nStart the app:\n\n    $ npm start"
          },
          {
            "manualTitle": "Step 1: Introduction",
            "stepRevision": "2437e47edf7c1f7530c8b6a38374120ad60b1287",
            "manualView": "# Step 1: How to build an app?\n\nSo you want to build an app!\nThe good news is, it’s not that difficult and after a while anyone can do it!\nAnother good news is that it’s a great skill to have, there is a lot of demand in the job market and you can get to be very creative. Also you can be part of basically any industry you can think of if you know how to program (Healthcare,\nbanking, education, defense, gaming, etc…).\n\nSoftware builds as layers on top of layers.  Every code you write is using code that others have written before already and you can just use it even without fully understanding it.\nThat’s what makes software advance so fast and makes the pace of progress increase as time goes by.\nAlso, most software today is written in an open and free way - everyone can share their code and use other people's code for free.  We even have a social network for that!  It’s called Github.\n\nOne way of learning how to build an app is to study software from the origins. How computers, operating systems and compilers work. It is very interesting but that also takes a long time.\nAnother way to learn how to create a new app is to start by first using all the code that has been already written out there and once we have a real world running app, go deeper to understand how it works from the inside.\n\nI’ll try to use the later approach because I think it is more fun and also it gives context when we will dive inside on how things work. Also it helps when we try to compare between different technologies that do the same thing (Angular vs.\nReact , etc…).\nThat’s because understanding the bigger picture is more important than knowing and remembering the details.\n\nYou noticed that the chapter started with a simple question.\nAll the lessons will start and include many of those questions.  Those are the questions you will need to Google.  The reason is that the most important skill a creator has today is to know how to search Google for the things they need. Most\nprogrammers, even the best ones, don’t remember anything, they just use Google for almost every line of code they write. So know that you don’t need to know it all, Google knows it all for you.\nThis tutorial might get outdated (it won't, hopefully!), but Google will always have the answers so it is more important to know to ask the right questions.\nIn my opinion the most important skill a programmer needs to have is patience and acceptance when something just doesn’t work, enjoy that feeling and start Googling around in order to learn new things and solve this new problem (this process of\nfeeling like you don’t know anything will happen 1000 times a day, also after 20 years of programming).\n\n## Planning the app: how to design an app?\n\nThe first and most important phase in the process is the beginning - designing the app, its parts, components and architecture, and how it all works together.\nFor this tutorial we will build a WhatsApp clone so we have the designs already prepared.\n\nThe process will looks like that:\n\n1. **Visually sketch the screens of the app**. We already know how WhatsApp looks so we’ll just copy it on pen and paper.\n2. **Break down to components**. The best way to describe the UI of apps is to break the UI into separate components and mix them up together. When breaking down to components we would need to think about the following steps:\n  * **Presentational components**: the small building blocks of the UI. For example input fields, images, text, buttons etc…\n  * **Layout**: how the components are positioned inside each other (talk about flex, grid and older layout types)\n  * **Styles**: colors, fonts etc… We might skip that part at the beginning because we can have a perfectly working app without it\n  * **Data dependencies**: the data that those components need - chats, messages, people etc… We will need to to do the following:\n    * Gather data for each component\n    * Attach all those dependencies into one schema\n    * Attach actions for each component\n    * Data updates: decide when the data should be updated in the view (ideally we shouldn’t have to say when but for technical and performance reasons it helps)\n3. **Routing flow**: Moving between screens, what are the different paths the user can navigate through our app\n\nOnce we will finish that process, you will have a big picture in your head (and on your paper) and implementing it with code will be much easier and more technical, meaning you won’t need to know a lot, just Google how to do each step...\n\nAnother interesting thing is, that implementing this same process can be done with a variety of different technologies, so this work will make sense whether you are using web with React or Angular, native apps, Windows UWP or any other\ntechnology for the UI and also relevant whether your data source is a Node, .NET or Ruby server with Mongo, Postgres or MySQL database (if all those words doesn’t mean anything for you, don’t worry, those are just different names to very similar\nideas and we will learn all of them later on and of course you can always just Google them).\n\nHead over to the next chapter to start planning."
          },
          {
            "manualTitle": "Step 2: Planning process",
            "stepRevision": "e59198836c58fead22e1226d1556f7f70003af47",
            "manualView": "## Visual sketch\nWell, not a lot to say about that: just draw your app on paper.\nDoesn’t matter if you don’t know how to draw, it’s just squares and circles.\n\n![alt text](../../assets/chats.png \"Chats\")\n![alt text](../../assets/chat.png \"Chat\")\n![alt text](../../assets/new_chat.png \"New chat\")\n![alt text](../../assets/new_group.png \"New group\")\n![alt text](../../assets/new_group_details.png \"New group details\")\n\n## Breaking down to components\n### -> Google Search\nThis part is a bit more tricky, but after a few examples you’ll get the hang of it.\n\nDraw boxes around every component and subcomponent in different colors and name each one.\nBut how do you know what should be its own component?\nJust follow the **single responsibility principle**, that is, a component should ideally only do one thing. If it ends up growing, it should be decomposed into smaller subcomponents.\n\n![alt text](../../assets/chats_components.png \"Chats components\")\n![alt text](../../assets/chat_components.png \"Chat components\")\n![alt text](../../assets/new_chat_components.png \"New chat components\")\n![alt text](../../assets/new_group_components.png \"New group components\")\n![alt text](../../assets/new_group_details_components.png \"New group details components\")\n\n  * Chats Component\n  * Header Component\n  * ChatsList Component\n  * ChatItem Component\n  * Chat Component\n  * MessagesList Component\n  * MessageItem Component\n  * NewMessage Component\n  * NewChat Component\n  * UsersList Component\n  * UserItem Component\n  * NewGroup Component\n  * NewGroupDetails Component\n\nNow let’s organize them in hierarchy:\n* Chats\n  * Header\n  * ChatsList\n    * ChatItem\n* Chat\n  * Header\n  * MessagesList\n    * MessageItem\n  * NewMessage\n* NewChat\n  * Header\n  * UsersList\n    * UserItem\n* NewGroup\n  * Header\n  * UsersList\n    * UserItem\n  * NewGroupDetails\n\n## Layout\n### -> Google Search\nNow let’s describe how the components are placed within each other.\nThere are infinite ways to explain how components sits inside of each other.\nAny approach has its benefits and limitations.\nWe are going to use one pattern that is pretty common, simple and also covers many types of UI structures.\nUsing that pattern we will keep us covered for a long while (until you would want to create a computer game or a graph. then you’ll need to expand your horizons).\nThis pattern is called flexbox.\n\nIn Flexbox we can separate the alignment in two ways:\nContainer (parent) component behaviour\nChild component behaviour inside the container\n\nWhen describing the parent, we have 3 main properties:\n* Flex-Flow: it's a shorthand for flex-direction and flex-wrap and lets you control the direction in which the items are displayed and whether or not they can wrap onto the next line. There are four possible settings, each of them in the wrap or\nnowrap variant:\n  * row `[wrap, nowrap]`\n  * row-reverse `[wrap, nowrap]`\n  * column `[wrap, nowrap]` - this is the normal way a group of divs would be displayed, so you might not use this often\n  * column-reverse `[wrap, nowrap]`\n* Justify-content: determines where a browser should place the flex items within the row. It works only if the flex items have set widths and if the total width of the items is less than the flex container. There are five possible settings:\n  * Flex-start - squash them to the left\n  * Center - Squash them to the center\n  * Flex-end - squash them to the right\n  * Space-around - squash them away from each other and the ends. Place as much space as possible between all elements\n  * Space-between - Squash the sides to the ends and place as much space between the rest of the elements as possible\n* alignItems: Same as justifyContent but on the secondary axis\n  * Flex-start - squash them to the left\n  * Center - Squash them to the center\n  * Flex-end - squash them to the right\n  * Space-around - squash them away from each other and the ends. Place as much space as possible between all elements\n  * Space-between - Squash the sides to the ends and place as much space between the rest of the elements as possible\n\nThe easiest way to explain that is by showing live examples:\n[awaiting for McFarland's permission to share his pictures]\n\n## Data dependencies\n### -> Google Search\nOur app needs to display data. Otherwise it will be just a nice moving set of pictures…\nSo let’s see what data each component needs and create a descriptions of all the data in our app.\n\nLet’s start with the chats list component:\n\n* Chats: Chats, Users, Messages\n  * Header\n  * ChatsList: Chats, Users, Messages\n    * ChatItem: Chats`[chatId]`, Users`[UserId]`, Message`[messageId]`\n\nWe need to have some basic information about the chats we are part of, like the chat id, the user id and the latest message content.\nThat means we will have to query for all the chats who we are part of, then look at the user IDs and query for those users to retrieve the name. Finally we need to query for the last message of each chat.\n\nNow let’s talk about the chat component (after clicking the single chat app).\nWe need a list of all the messages inside the chat, along with some info about the user or chat on the top corner:\n\n* Chat: Chat, User, Messages\n  * Header: User.name || Chat.name (Because we can have multiple participant could differ from the other person’s name)\n  * MessagesList: Messages\n    * MessageItem: Messages`[ID]`\n  * NewMessage\n\nThe NewChat and NewGroup components will need just some basic info about the user:\n\n* NewChat: Users\n  * Header\n  * UsersList: Users\n    * UserItem: Users`[ID]`\n\n* NewGroup: Users\n  * Header\n  * UsersList: Users\n    * UserItem: Users`[ID]`\n  * NewGroupDetails\n\n## Actions\n### -> Google Search\nBut components can also do thing beyond just displaying data.\nLet’s write all the actions each component can do.\n  * Chats list\n    * tap -> go to chat page\n    * press -> enable selection of multiple chats, confirming the selection will delete them\n  * Single Chat\n    * tap -> send the message\n    * press -> enable selection of multiple messages, confirming the selection will delete them\n  * New Chat\n    * tap -> create new chat or go to the NewGroup component\n  * New Group\n    * tap -> go to NewGroupDetails, then create the group\n\n## Communications\n### -> Google Search\nLet’s define when do we need to get the data from our data source.\nSounds easy but there are a few tricky pitfalls. (query and subscriptions).\nWe will start by simply requesting the data when we first start the component, later on we will tackle subscriptions.\n\n## UI flow\n### -> Google Search\nLet’s draw a diagram of how the user can navigate our app.\n  * Open the app ->\n    * Chats list ->\n      * Click on chat ->\n        * Specific chat page\n          * Click back ->\n            * Chat page\n    * Click on '+' ->\n      * NewChat page ->\n        * Click on user ->\n          * Chat page\n        * Click back ->\n          * Chats list\n        * Click on 'New Group' ->\n          * New Group page\n            * Multiple selection and subsequent confirmation ->\n              * NewGroupDetails page\n                * Insert name and click on confirm ->\n                  * Chat page\n              * Click back ->\n                * New Group page\n          * Click back ->\n            * New Group page\n\nNow let’s look at the whole diagram we created.\nThat basically describes all of our app.\nIf computers were smart enough to understand english and drawings, we would have an app by now.\nBut programming languages are very similar to regular languages so we now just need to translate this into any programming language, just choose a tool and start filling in the gaps.\n\nNext chapter will be about Scaffolding which will tell us the structure to put our code into.\nJust like our sketch has defined parts, we would do the same just with folders and files."
          },
          {
            "manualTitle": "Step 3: Scaffolding",
            "stepRevision": "5bed487598e50759764f608eb4ca3b347c4d6ac5",
            "manualView": "Now we can start writing code!\n\nBut like we said before, software is build in layers and instead of starting from nothing, we can use existing software with prepared structure.\n\n## Tools\n\nFirst let’s install some software that we need on our computer:\n\n### Windows\n\nThe following instructions are for computers with the Windows operating system.\n\nFirst let's start by installing node.js. You need to download an installer, by visiting:\n\n    https://nodejs.org/en/download/\n\nSame, with Yarn:\n\n    https://yarnpkg.com/en/docs/install#windows-stable\n\n\n### Linux\n\nThe following instructions are for computers with the Arch Linux operating system, so your mileage may vary.\n\nFirst let's start by installing npm and node.js, as simple as\n\n    # NodeJS\n    pacman -S nodejs npm\n\n    # Yarn\n    pacman -S yarn\n\n\n### MacOS\n\nThe following instructions are for computers with the MacOS operating system:\n\n    # NodeJS\n    brew install node\n\n    # Yarn\n    brew install yarn --without-node\n\n\n## Packages\n\nThen we will need a way to install our npm global packages on a per-user basis, instead of relying on sudo: https://github.com/sindresorhus/guides/blob/master/npm-global-without-sudo.md\n\nNow it's the right moment to install a couple of global packages we will need later on:\n\n    yarn global add @angular/cli node-sass tortilla typescript\n\n\n## IDE\n\nNow it's time to choose our IDE. I suggest you VSCode, it's available for free: https://code.visualstudio.com/.\nTo have a look at some of the VSCode features you can have a look at the documentation: https://code.visualstudio.com/docs.\n\nVSCode team prepared an Interactive Playground where you can learn what the editor is cappable of and play with it. I highly recommend to check it out!\n\n    Toolbar: Help > Interactive Playground\n\nThere are also many IDEs to recommend and at the end the choice is yours.\n\n## Mobile\n\nWe will talk once again about scaffolding once we will introduce `Android` and `Cordova`."
          },
          {
            "manualTitle": "Step 4: Debugging",
            "stepRevision": "55bc04cf5573341cce8cdfe5fea67fb603e3a74f",
            "manualView": "Before we start writing code, it is important that we learn how to check our code.\n\nThe computer runs through everything we write in split second but we can still pause the computer and go through step by step, check what actually happens when the computer runs our code instructions.\n\nThis phase is sometimes being skipped by developers but trust me, you never want to skip this phase and you should always be super comfortable in debugging your code on whatever environment it’s running on.\n\nThe easiest way to debug your Javascript application is right into your editor:\n  * https://code.visualstudio.com/docs/introvideos/debugging\n  * https://www.jetbrains.com/help/webstorm/debugging-javascript-in-chrome.html\n  * https://blog.jetbrains.com/webstorm/2017/01/debugging-angular-apps/\n\nLater on we will learn how to debug mobile applications."
          },
          {
            "manualTitle": "Step 5: Chats listing",
            "stepRevision": "665d3c8014800890c694d121848b3448cd6335ec",
            "manualView": "![chats-list](https://user-images.githubusercontent.com/7648874/49271096-36bef480-f4a7-11e8-87a9-c9f203f20f6a.png)\n\n## Server\n\nAfter the planning phase it's finally time to start writing some real code!\nWe'll start with the server, so let's install a couple of packages first:\n\n    yarn add apollo-server-express body-parser cors express graphql\n    yarn add -D @types/body-parser @types/cors @types/express @types/graphql\n\nExpress is a fast, unopinionated, minimalist web framework for node.\nCross-Origin Resource Sharing (CORS) is a mechanism that uses additional HTTP headers to let a user agent gain permission to access selected resources from a server on a different origin (domain) than the site currently in use. A user agent makes a cross-origin HTTP request when it requests a resource from a different domain, protocol, or port than the one from which the current document originated.\nWe will need CORS because Webpack's development server used in the client will make use of a different port than the Express server, thus configuring a different origin.\nGraphQL is a query language for APIs and a runtime for fulfilling those queries with your existing data. GraphQL provides a complete and understandable description of the data in your API, gives clients the power to ask for exactly what they need and nothing more, makes it easier to evolve APIs over time, and enables powerful developer tools.\nApollo Server is a community-maintained open-source GraphQL server. It works with pretty much all Node.js HTTP server frameworks. Apollo Server works with any GraphQL schema built with GraphQL.js or with a convenience library such as graphql-tools.\n\nThe GraphQL query language is basically about selecting fields on objects. Because the shape of a GraphQL query closely matches the result, you can predict what the query will return without knowing that much about the server. But it's useful to have an exact description of the data we can ask for - what fields can we select? What kinds of objects might they return? What fields are available on those sub-objects? That's where the schema comes in.\nEvery GraphQL service defines a set of types which completely describe the set of possible data you can query on that service. Then, when queries come in, they are validated and executed against that schema.\n\nFor the moment let's create some empty schemas and resolvers:\n\n[{]: <helper> (diffStep \"1.1\" files=\"schema/*\" module=\"server\")\n\n#### [Step 1.1: Create empty Apollo server](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/1ac723e)\n\n##### Added schema&#x2F;index.ts\n```diff\n@@ -0,0 +1,8 @@\n+┊ ┊1┊import { makeExecutableSchema } from 'apollo-server-express';\n+┊ ┊2┊import typeDefs from './typeDefs';\n+┊ ┊3┊import { resolvers } from './resolvers';\n+┊ ┊4┊\n+┊ ┊5┊export const schema = makeExecutableSchema({\n+┊ ┊6┊  typeDefs,\n+┊ ┊7┊  resolvers,\n+┊ ┊8┊});\n```\n\n##### Added schema&#x2F;resolvers.ts\n```diff\n@@ -0,0 +1,5 @@\n+┊ ┊1┊import { IResolvers } from 'apollo-server-express';\n+┊ ┊2┊\n+┊ ┊3┊export const resolvers: IResolvers = {\n+┊ ┊4┊  Query: {},\n+┊ ┊5┊};\n```\n\n##### Added schema&#x2F;typeDefs.ts\n```diff\n@@ -0,0 +1,2 @@\n+┊ ┊1┊export default `\n+┊ ┊2┊`;\n```\n\n[}]: #\n\nTime to create our index:\n\n[{]: <helper> (diffStep \"1.1\" files=\"^index.ts\" module=\"server\")\n\n#### [Step 1.1: Create empty Apollo server](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/1ac723e)\n\n##### Added index.ts\n```diff\n@@ -0,0 +1,23 @@\n+┊  ┊ 1┊import { schema } from \"./schema\";\n+┊  ┊ 2┊import * as bodyParser from \"body-parser\";\n+┊  ┊ 3┊import * as cors from 'cors';\n+┊  ┊ 4┊import * as express from 'express';\n+┊  ┊ 5┊import { ApolloServer } from \"apollo-server-express\";\n+┊  ┊ 6┊\n+┊  ┊ 7┊const PORT = 3000;\n+┊  ┊ 8┊\n+┊  ┊ 9┊const app = express();\n+┊  ┊10┊\n+┊  ┊11┊app.use(cors());\n+┊  ┊12┊app.use(bodyParser.json());\n+┊  ┊13┊\n+┊  ┊14┊const apollo = new ApolloServer({\n+┊  ┊15┊  schema\n+┊  ┊16┊});\n+┊  ┊17┊\n+┊  ┊18┊apollo.applyMiddleware({\n+┊  ┊19┊  app,\n+┊  ┊20┊  path: '/graphql'\n+┊  ┊21┊});\n+┊  ┊22┊\n+┊  ┊23┊app.listen(PORT);\n```\n\n[}]: #\n\nNow we want to feed our graphql server with some data. Soon we will need `moment`, so let's install it:\n\n    yarn add moment\n\nNow we can create a fake db:\n\n[{]: <helper> (diffStep \"1.2\" files=\"db.ts\" module=\"server\")\n\n#### [Step 1.2: Add fake db](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/a168978)\n\n##### Added db.ts\n```diff\n@@ -0,0 +1,438 @@\n+┊   ┊  1┊import * as moment from 'moment';\n+┊   ┊  2┊\n+┊   ┊  3┊export enum MessageType {\n+┊   ┊  4┊  PICTURE,\n+┊   ┊  5┊  TEXT,\n+┊   ┊  6┊  LOCATION,\n+┊   ┊  7┊}\n+┊   ┊  8┊\n+┊   ┊  9┊export interface User {\n+┊   ┊ 10┊  id: number,\n+┊   ┊ 11┊  username: string,\n+┊   ┊ 12┊  password: string,\n+┊   ┊ 13┊  name: string,\n+┊   ┊ 14┊  picture?: string | null,\n+┊   ┊ 15┊  phone?: string | null,\n+┊   ┊ 16┊}\n+┊   ┊ 17┊\n+┊   ┊ 18┊export interface Chat {\n+┊   ┊ 19┊  id: number,\n+┊   ┊ 20┊  name?: string | null,\n+┊   ┊ 21┊  picture?: string | null,\n+┊   ┊ 22┊  // All members, current and past ones.\n+┊   ┊ 23┊  allTimeMemberIds: number[],\n+┊   ┊ 24┊  // Whoever gets the chat listed. For groups includes past members who still didn't delete the group.\n+┊   ┊ 25┊  listingMemberIds: number[],\n+┊   ┊ 26┊  // Actual members of the group (they are not the only ones who get the group listed). Null for chats.\n+┊   ┊ 27┊  actualGroupMemberIds?: number[] | null,\n+┊   ┊ 28┊  adminIds?: number[] | null,\n+┊   ┊ 29┊  ownerId?: number | null,\n+┊   ┊ 30┊  messages: Message[],\n+┊   ┊ 31┊}\n+┊   ┊ 32┊\n+┊   ┊ 33┊export interface Message {\n+┊   ┊ 34┊  id: number,\n+┊   ┊ 35┊  chatId: number,\n+┊   ┊ 36┊  senderId: number,\n+┊   ┊ 37┊  content: string,\n+┊   ┊ 38┊  createdAt: number,\n+┊   ┊ 39┊  type: MessageType,\n+┊   ┊ 40┊  recipients: Recipient[],\n+┊   ┊ 41┊  holderIds: number[],\n+┊   ┊ 42┊}\n+┊   ┊ 43┊\n+┊   ┊ 44┊export interface Recipient {\n+┊   ┊ 45┊  userId: number,\n+┊   ┊ 46┊  messageId: number,\n+┊   ┊ 47┊  chatId: number,\n+┊   ┊ 48┊  receivedAt: number | null,\n+┊   ┊ 49┊  readAt: number | null,\n+┊   ┊ 50┊}\n+┊   ┊ 51┊\n+┊   ┊ 52┊const users: User[] = [\n+┊   ┊ 53┊  {\n+┊   ┊ 54┊    id: 1,\n+┊   ┊ 55┊    username: 'ethan',\n+┊   ┊ 56┊    password: '$2a$08$NO9tkFLCoSqX1c5wk3s7z.JfxaVMKA.m7zUDdDwEquo4rvzimQeJm', // 111\n+┊   ┊ 57┊    name: 'Ethan Gonzalez',\n+┊   ┊ 58┊    picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n+┊   ┊ 59┊    phone: '+391234567890',\n+┊   ┊ 60┊  },\n+┊   ┊ 61┊  {\n+┊   ┊ 62┊    id: 2,\n+┊   ┊ 63┊    username: 'bryan',\n+┊   ┊ 64┊    password: '$2a$08$xE4FuCi/ifxjL2S8CzKAmuKLwv18ktksSN.F3XYEnpmcKtpbpeZgO', // 222\n+┊   ┊ 65┊    name: 'Bryan Wallace',\n+┊   ┊ 66┊    picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n+┊   ┊ 67┊    phone: '+391234567891',\n+┊   ┊ 68┊  },\n+┊   ┊ 69┊  {\n+┊   ┊ 70┊    id: 3,\n+┊   ┊ 71┊    username: 'avery',\n+┊   ┊ 72┊    password: '$2a$08$UHgH7J8G6z1mGQn2qx2kdeWv0jvgHItyAsL9hpEUI3KJmhVW5Q1d.', // 333\n+┊   ┊ 73┊    name: 'Avery Stewart',\n+┊   ┊ 74┊    picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n+┊   ┊ 75┊    phone: '+391234567892',\n+┊   ┊ 76┊  },\n+┊   ┊ 77┊  {\n+┊   ┊ 78┊    id: 4,\n+┊   ┊ 79┊    username: 'katie',\n+┊   ┊ 80┊    password: '$2a$08$wR1k5Q3T9FC7fUgB7Gdb9Os/GV7dGBBf4PLlWT7HERMFhmFDt47xi', // 444\n+┊   ┊ 81┊    name: 'Katie Peterson',\n+┊   ┊ 82┊    picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n+┊   ┊ 83┊    phone: '+391234567893',\n+┊   ┊ 84┊  },\n+┊   ┊ 85┊  {\n+┊   ┊ 86┊    id: 5,\n+┊   ┊ 87┊    username: 'ray',\n+┊   ┊ 88┊    password: '$2a$08$6.mbXqsDX82ZZ7q5d8Osb..JrGSsNp4R3IKj7mxgF6YGT0OmMw242', // 555\n+┊   ┊ 89┊    name: 'Ray Edwards',\n+┊   ┊ 90┊    picture: 'https://randomuser.me/api/portraits/thumb/men/3.jpg',\n+┊   ┊ 91┊    phone: '+391234567894',\n+┊   ┊ 92┊  },\n+┊   ┊ 93┊  {\n+┊   ┊ 94┊    id: 6,\n+┊   ┊ 95┊    username: 'niko',\n+┊   ┊ 96┊    password: '$2a$08$fL5lZR.Rwf9FWWe8XwwlceiPBBim8n9aFtaem.INQhiKT4.Ux3Uq.', // 666\n+┊   ┊ 97┊    name: 'Niccolò Belli',\n+┊   ┊ 98┊    picture: 'https://randomuser.me/api/portraits/thumb/men/4.jpg',\n+┊   ┊ 99┊    phone: '+391234567895',\n+┊   ┊100┊  },\n+┊   ┊101┊  {\n+┊   ┊102┊    id: 7,\n+┊   ┊103┊    username: 'mario',\n+┊   ┊104┊    password: '$2a$08$nDHDmWcVxDnH5DDT3HMMC.psqcnu6wBiOgkmJUy9IH..qxa3R6YrO', // 777\n+┊   ┊105┊    name: 'Mario Rossi',\n+┊   ┊106┊    picture: 'https://randomuser.me/api/portraits/thumb/men/5.jpg',\n+┊   ┊107┊    phone: '+391234567896',\n+┊   ┊108┊  },\n+┊   ┊109┊];\n+┊   ┊110┊\n+┊   ┊111┊const chats: Chat[] = [\n+┊   ┊112┊  {\n+┊   ┊113┊    id: 1,\n+┊   ┊114┊    name: null,\n+┊   ┊115┊    picture: null,\n+┊   ┊116┊    allTimeMemberIds: [1, 3],\n+┊   ┊117┊    listingMemberIds: [1, 3],\n+┊   ┊118┊    adminIds: null,\n+┊   ┊119┊    ownerId: null,\n+┊   ┊120┊    messages: [\n+┊   ┊121┊      {\n+┊   ┊122┊        id: 1,\n+┊   ┊123┊        chatId: 1,\n+┊   ┊124┊        senderId: 1,\n+┊   ┊125┊        content: 'You on your way?',\n+┊   ┊126┊        createdAt: moment().subtract(1, 'hours').unix(),\n+┊   ┊127┊        type: MessageType.TEXT,\n+┊   ┊128┊        recipients: [\n+┊   ┊129┊          {\n+┊   ┊130┊            userId: 3,\n+┊   ┊131┊            messageId: 1,\n+┊   ┊132┊            chatId: 1,\n+┊   ┊133┊            receivedAt: null,\n+┊   ┊134┊            readAt: null,\n+┊   ┊135┊          },\n+┊   ┊136┊        ],\n+┊   ┊137┊        holderIds: [1, 3],\n+┊   ┊138┊      },\n+┊   ┊139┊      {\n+┊   ┊140┊        id: 2,\n+┊   ┊141┊        chatId: 1,\n+┊   ┊142┊        senderId: 3,\n+┊   ┊143┊        content: 'Yep!',\n+┊   ┊144┊        createdAt: moment().subtract(1, 'hours').add(5, 'minutes').unix(),\n+┊   ┊145┊        type: MessageType.TEXT,\n+┊   ┊146┊        recipients: [\n+┊   ┊147┊          {\n+┊   ┊148┊            userId: 1,\n+┊   ┊149┊            messageId: 2,\n+┊   ┊150┊            chatId: 1,\n+┊   ┊151┊            receivedAt: null,\n+┊   ┊152┊            readAt: null,\n+┊   ┊153┊          },\n+┊   ┊154┊        ],\n+┊   ┊155┊        holderIds: [3, 1],\n+┊   ┊156┊      },\n+┊   ┊157┊    ],\n+┊   ┊158┊  },\n+┊   ┊159┊  {\n+┊   ┊160┊    id: 2,\n+┊   ┊161┊    name: null,\n+┊   ┊162┊    picture: null,\n+┊   ┊163┊    allTimeMemberIds: [1, 4],\n+┊   ┊164┊    listingMemberIds: [1, 4],\n+┊   ┊165┊    adminIds: null,\n+┊   ┊166┊    ownerId: null,\n+┊   ┊167┊    messages: [\n+┊   ┊168┊      {\n+┊   ┊169┊        id: 1,\n+┊   ┊170┊        chatId: 2,\n+┊   ┊171┊        senderId: 1,\n+┊   ┊172┊        content: 'Hey, it\\'s me',\n+┊   ┊173┊        createdAt: moment().subtract(2, 'hours').unix(),\n+┊   ┊174┊        type: MessageType.TEXT,\n+┊   ┊175┊        recipients: [\n+┊   ┊176┊          {\n+┊   ┊177┊            userId: 4,\n+┊   ┊178┊            messageId: 1,\n+┊   ┊179┊            chatId: 2,\n+┊   ┊180┊            receivedAt: null,\n+┊   ┊181┊            readAt: null,\n+┊   ┊182┊          },\n+┊   ┊183┊        ],\n+┊   ┊184┊        holderIds: [1, 4],\n+┊   ┊185┊      },\n+┊   ┊186┊    ],\n+┊   ┊187┊  },\n+┊   ┊188┊  {\n+┊   ┊189┊    id: 3,\n+┊   ┊190┊    name: null,\n+┊   ┊191┊    picture: null,\n+┊   ┊192┊    allTimeMemberIds: [1, 5],\n+┊   ┊193┊    listingMemberIds: [1, 5],\n+┊   ┊194┊    adminIds: null,\n+┊   ┊195┊    ownerId: null,\n+┊   ┊196┊    messages: [\n+┊   ┊197┊      {\n+┊   ┊198┊        id: 1,\n+┊   ┊199┊        chatId: 3,\n+┊   ┊200┊        senderId: 1,\n+┊   ┊201┊        content: 'I should buy a boat',\n+┊   ┊202┊        createdAt: moment().subtract(1, 'days').unix(),\n+┊   ┊203┊        type: MessageType.TEXT,\n+┊   ┊204┊        recipients: [\n+┊   ┊205┊          {\n+┊   ┊206┊            userId: 5,\n+┊   ┊207┊            messageId: 1,\n+┊   ┊208┊            chatId: 3,\n+┊   ┊209┊            receivedAt: null,\n+┊   ┊210┊            readAt: null,\n+┊   ┊211┊          },\n+┊   ┊212┊        ],\n+┊   ┊213┊        holderIds: [1, 5],\n+┊   ┊214┊      },\n+┊   ┊215┊      {\n+┊   ┊216┊        id: 2,\n+┊   ┊217┊        chatId: 3,\n+┊   ┊218┊        senderId: 1,\n+┊   ┊219┊        content: 'You still there?',\n+┊   ┊220┊        createdAt: moment().subtract(1, 'days').add(16, 'hours').unix(),\n+┊   ┊221┊        type: MessageType.TEXT,\n+┊   ┊222┊        recipients: [\n+┊   ┊223┊          {\n+┊   ┊224┊            userId: 5,\n+┊   ┊225┊            messageId: 2,\n+┊   ┊226┊            chatId: 3,\n+┊   ┊227┊            receivedAt: null,\n+┊   ┊228┊            readAt: null,\n+┊   ┊229┊          },\n+┊   ┊230┊        ],\n+┊   ┊231┊        holderIds: [1, 5],\n+┊   ┊232┊      },\n+┊   ┊233┊    ],\n+┊   ┊234┊  },\n+┊   ┊235┊  {\n+┊   ┊236┊    id: 4,\n+┊   ┊237┊    name: null,\n+┊   ┊238┊    picture: null,\n+┊   ┊239┊    allTimeMemberIds: [3, 4],\n+┊   ┊240┊    listingMemberIds: [3, 4],\n+┊   ┊241┊    adminIds: null,\n+┊   ┊242┊    ownerId: null,\n+┊   ┊243┊    messages: [\n+┊   ┊244┊      {\n+┊   ┊245┊        id: 1,\n+┊   ┊246┊        chatId: 4,\n+┊   ┊247┊        senderId: 3,\n+┊   ┊248┊        content: 'Look at my mukluks!',\n+┊   ┊249┊        createdAt: moment().subtract(4, 'days').unix(),\n+┊   ┊250┊        type: MessageType.TEXT,\n+┊   ┊251┊        recipients: [\n+┊   ┊252┊          {\n+┊   ┊253┊            userId: 4,\n+┊   ┊254┊            messageId: 1,\n+┊   ┊255┊            chatId: 4,\n+┊   ┊256┊            receivedAt: null,\n+┊   ┊257┊            readAt: null,\n+┊   ┊258┊          },\n+┊   ┊259┊        ],\n+┊   ┊260┊        holderIds: [3, 4],\n+┊   ┊261┊      },\n+┊   ┊262┊    ],\n+┊   ┊263┊  },\n+┊   ┊264┊  {\n+┊   ┊265┊    id: 5,\n+┊   ┊266┊    name: null,\n+┊   ┊267┊    picture: null,\n+┊   ┊268┊    allTimeMemberIds: [2, 5],\n+┊   ┊269┊    listingMemberIds: [2, 5],\n+┊   ┊270┊    adminIds: null,\n+┊   ┊271┊    ownerId: null,\n+┊   ┊272┊    messages: [\n+┊   ┊273┊      {\n+┊   ┊274┊        id: 1,\n+┊   ┊275┊        chatId: 5,\n+┊   ┊276┊        senderId: 2,\n+┊   ┊277┊        content: 'This is wicked good ice cream.',\n+┊   ┊278┊        createdAt: moment().subtract(2, 'weeks').unix(),\n+┊   ┊279┊        type: MessageType.TEXT,\n+┊   ┊280┊        recipients: [\n+┊   ┊281┊          {\n+┊   ┊282┊            userId: 5,\n+┊   ┊283┊            messageId: 1,\n+┊   ┊284┊            chatId: 5,\n+┊   ┊285┊            receivedAt: null,\n+┊   ┊286┊            readAt: null,\n+┊   ┊287┊          },\n+┊   ┊288┊        ],\n+┊   ┊289┊        holderIds: [2, 5],\n+┊   ┊290┊      },\n+┊   ┊291┊      {\n+┊   ┊292┊        id: 2,\n+┊   ┊293┊        chatId: 6,\n+┊   ┊294┊        senderId: 5,\n+┊   ┊295┊        content: 'Love it!',\n+┊   ┊296┊        createdAt: moment().subtract(2, 'weeks').add(10, 'minutes').unix(),\n+┊   ┊297┊        type: MessageType.TEXT,\n+┊   ┊298┊        recipients: [\n+┊   ┊299┊          {\n+┊   ┊300┊            userId: 2,\n+┊   ┊301┊            messageId: 2,\n+┊   ┊302┊            chatId: 5,\n+┊   ┊303┊            receivedAt: null,\n+┊   ┊304┊            readAt: null,\n+┊   ┊305┊          },\n+┊   ┊306┊        ],\n+┊   ┊307┊        holderIds: [5, 2],\n+┊   ┊308┊      },\n+┊   ┊309┊    ],\n+┊   ┊310┊  },\n+┊   ┊311┊  {\n+┊   ┊312┊    id: 6,\n+┊   ┊313┊    name: null,\n+┊   ┊314┊    picture: null,\n+┊   ┊315┊    allTimeMemberIds: [1, 6],\n+┊   ┊316┊    listingMemberIds: [1],\n+┊   ┊317┊    adminIds: null,\n+┊   ┊318┊    ownerId: null,\n+┊   ┊319┊    messages: [],\n+┊   ┊320┊  },\n+┊   ┊321┊  {\n+┊   ┊322┊    id: 7,\n+┊   ┊323┊    name: null,\n+┊   ┊324┊    picture: null,\n+┊   ┊325┊    allTimeMemberIds: [2, 1],\n+┊   ┊326┊    listingMemberIds: [2],\n+┊   ┊327┊    adminIds: null,\n+┊   ┊328┊    ownerId: null,\n+┊   ┊329┊    messages: [],\n+┊   ┊330┊  },\n+┊   ┊331┊  {\n+┊   ┊332┊    id: 8,\n+┊   ┊333┊    name: 'A user 0 group',\n+┊   ┊334┊    picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n+┊   ┊335┊    allTimeMemberIds: [1, 3, 4, 6],\n+┊   ┊336┊    listingMemberIds: [1, 3, 4, 6],\n+┊   ┊337┊    actualGroupMemberIds: [1, 4, 6],\n+┊   ┊338┊    adminIds: [1, 6],\n+┊   ┊339┊    ownerId: 1,\n+┊   ┊340┊    messages: [\n+┊   ┊341┊      {\n+┊   ┊342┊        id: 1,\n+┊   ┊343┊        chatId: 8,\n+┊   ┊344┊        senderId: 1,\n+┊   ┊345┊        content: 'I made a group',\n+┊   ┊346┊        createdAt: moment().subtract(2, 'weeks').unix(),\n+┊   ┊347┊        type: MessageType.TEXT,\n+┊   ┊348┊        recipients: [\n+┊   ┊349┊          {\n+┊   ┊350┊            userId: 3,\n+┊   ┊351┊            messageId: 1,\n+┊   ┊352┊            chatId: 8,\n+┊   ┊353┊            receivedAt: null,\n+┊   ┊354┊            readAt: null,\n+┊   ┊355┊          },\n+┊   ┊356┊          {\n+┊   ┊357┊            userId: 4,\n+┊   ┊358┊            messageId: 1,\n+┊   ┊359┊            chatId: 8,\n+┊   ┊360┊            receivedAt: moment().subtract(2, 'weeks').add(1, 'minutes').unix(),\n+┊   ┊361┊            readAt: moment().subtract(2, 'weeks').add(5, 'minutes').unix(),\n+┊   ┊362┊          },\n+┊   ┊363┊          {\n+┊   ┊364┊            userId: 6,\n+┊   ┊365┊            messageId: 1,\n+┊   ┊366┊            chatId: 8,\n+┊   ┊367┊            receivedAt: null,\n+┊   ┊368┊            readAt: null,\n+┊   ┊369┊          },\n+┊   ┊370┊        ],\n+┊   ┊371┊        holderIds: [1, 3, 4, 6],\n+┊   ┊372┊      },\n+┊   ┊373┊      {\n+┊   ┊374┊        id: 2,\n+┊   ┊375┊        chatId: 8,\n+┊   ┊376┊        senderId: 1,\n+┊   ┊377┊        content: 'Ops, user 3 was not supposed to be here',\n+┊   ┊378┊        createdAt: moment().subtract(2, 'weeks').add(2, 'minutes').unix(),\n+┊   ┊379┊        type: MessageType.TEXT,\n+┊   ┊380┊        recipients: [\n+┊   ┊381┊          {\n+┊   ┊382┊            userId: 4,\n+┊   ┊383┊            messageId: 2,\n+┊   ┊384┊            chatId: 8,\n+┊   ┊385┊            receivedAt: moment().subtract(2, 'weeks').add(3, 'minutes').unix(),\n+┊   ┊386┊            readAt: moment().subtract(2, 'weeks').add(5, 'minutes').unix(),\n+┊   ┊387┊          },\n+┊   ┊388┊          {\n+┊   ┊389┊            userId: 6,\n+┊   ┊390┊            messageId: 2,\n+┊   ┊391┊            chatId: 8,\n+┊   ┊392┊            receivedAt: null,\n+┊   ┊393┊            readAt: null,\n+┊   ┊394┊          },\n+┊   ┊395┊        ],\n+┊   ┊396┊        holderIds: [1, 4, 6],\n+┊   ┊397┊      },\n+┊   ┊398┊      {\n+┊   ┊399┊        id: 3,\n+┊   ┊400┊        chatId: 8,\n+┊   ┊401┊        senderId: 4,\n+┊   ┊402┊        content: 'Awesome!',\n+┊   ┊403┊        createdAt: moment().subtract(2, 'weeks').add(10, 'minutes').unix(),\n+┊   ┊404┊        type: MessageType.TEXT,\n+┊   ┊405┊        recipients: [\n+┊   ┊406┊          {\n+┊   ┊407┊            userId: 1,\n+┊   ┊408┊            messageId: 3,\n+┊   ┊409┊            chatId: 8,\n+┊   ┊410┊            receivedAt: null,\n+┊   ┊411┊            readAt: null,\n+┊   ┊412┊          },\n+┊   ┊413┊          {\n+┊   ┊414┊            userId: 6,\n+┊   ┊415┊            messageId: 3,\n+┊   ┊416┊            chatId: 8,\n+┊   ┊417┊            receivedAt: null,\n+┊   ┊418┊            readAt: null,\n+┊   ┊419┊          },\n+┊   ┊420┊        ],\n+┊   ┊421┊        holderIds: [1, 4, 6],\n+┊   ┊422┊      },\n+┊   ┊423┊    ],\n+┊   ┊424┊  },\n+┊   ┊425┊  {\n+┊   ┊426┊    id: 9,\n+┊   ┊427┊    name: 'A user 5 group',\n+┊   ┊428┊    picture: null,\n+┊   ┊429┊    allTimeMemberIds: [6, 3],\n+┊   ┊430┊    listingMemberIds: [6, 3],\n+┊   ┊431┊    actualGroupMemberIds: [6, 3],\n+┊   ┊432┊    adminIds: [6],\n+┊   ┊433┊    ownerId: 6,\n+┊   ┊434┊    messages: [],\n+┊   ┊435┊  },\n+┊   ┊436┊];\n+┊   ┊437┊\n+┊   ┊438┊export const db = {users, chats};\n```\n\n[}]: #\n\nIts' finally time to create our schema\n\n[{]: <helper> (diffStep \"1.3\" files=\"schema/typeDefs.ts\" module=\"server\")\n\n#### [Step 1.3: Add resolvers and schema](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/a2cb658)\n\n##### Changed schema&#x2F;typeDefs.ts\n```diff\n@@ -1,2 +1,68 @@\n ┊ 1┊ 1┊export default `\n+┊  ┊ 2┊  type Query {\n+┊  ┊ 3┊    users: [User!]\n+┊  ┊ 4┊    chats: [Chat!]\n+┊  ┊ 5┊    chat(chatId: ID!): Chat\n+┊  ┊ 6┊  }\n+┊  ┊ 7┊\n+┊  ┊ 8┊  enum MessageType {\n+┊  ┊ 9┊    LOCATION\n+┊  ┊10┊    TEXT\n+┊  ┊11┊    PICTURE\n+┊  ┊12┊  }\n+┊  ┊13┊\n+┊  ┊14┊  type Chat {\n+┊  ┊15┊    #May be a chat or a group\n+┊  ┊16┊    id: ID!\n+┊  ┊17┊    #Computed for chats\n+┊  ┊18┊    name: String\n+┊  ┊19┊    #Computed for chats\n+┊  ┊20┊    picture: String\n+┊  ┊21┊    #All members, current and past ones.\n+┊  ┊22┊    allTimeMembers: [User!]!\n+┊  ┊23┊    #Whoever gets the chat listed. For groups includes past members who still didn't delete the group.\n+┊  ┊24┊    listingMembers: [User!]!\n+┊  ┊25┊    #Actual members of the group (they are not the only ones who get the group listed). Null for chats.\n+┊  ┊26┊    actualGroupMembers: [User!]!\n+┊  ┊27┊    #Null for chats\n+┊  ┊28┊    admins: [User!]\n+┊  ┊29┊    #If null the group is read-only. Null for chats.\n+┊  ┊30┊    owner: User\n+┊  ┊31┊    messages(amount: Int): [Message]!\n+┊  ┊32┊    #Computed property\n+┊  ┊33┊    unreadMessages: Int!\n+┊  ┊34┊    #Computed property\n+┊  ┊35┊    isGroup: Boolean!\n+┊  ┊36┊  }\n+┊  ┊37┊\n+┊  ┊38┊  type Message {\n+┊  ┊39┊    id: ID!\n+┊  ┊40┊    sender: User!\n+┊  ┊41┊    chat: Chat!\n+┊  ┊42┊    content: String!\n+┊  ┊43┊    createdAt: String!\n+┊  ┊44┊    #FIXME: should return MessageType\n+┊  ┊45┊    type: Int!\n+┊  ┊46┊    #Whoever received the message\n+┊  ┊47┊    recipients: [Recipient!]!\n+┊  ┊48┊    #Whoever still holds a copy of the message. Cannot be null because the message gets deleted otherwise\n+┊  ┊49┊    holders: [User!]!\n+┊  ┊50┊    #Computed property\n+┊  ┊51┊    ownership: Boolean!\n+┊  ┊52┊  }\n+┊  ┊53┊\n+┊  ┊54┊  type Recipient {\n+┊  ┊55┊    user: User!\n+┊  ┊56┊    message: Message!\n+┊  ┊57┊    chat: Chat!\n+┊  ┊58┊    receivedAt: String\n+┊  ┊59┊    readAt: String\n+┊  ┊60┊  }\n+┊  ┊61┊\n+┊  ┊62┊  type User {\n+┊  ┊63┊    id: ID!\n+┊  ┊64┊    name: String\n+┊  ┊65┊    picture: String\n+┊  ┊66┊    phone: String\n+┊  ┊67┊  }\n ┊ 2┊68┊`;\n```\n\n[}]: #\n\nand our resolvers\n\n[{]: <helper> (diffStep \"1.3\" files=\"schema/resolvers.ts\" module=\"server\")\n\n#### [Step 1.3: Add resolvers and schema](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/a2cb658)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,5 +1,51 @@\n ┊ 1┊ 1┊import { IResolvers } from 'apollo-server-express';\n+┊  ┊ 2┊import { Chat, db, Message, Recipient, User } from \"../db\";\n+┊  ┊ 3┊\n+┊  ┊ 4┊let users = db.users;\n+┊  ┊ 5┊let chats = db.chats;\n+┊  ┊ 6┊const currentUser = 1;\n ┊ 2┊ 7┊\n ┊ 3┊ 8┊export const resolvers: IResolvers = {\n-┊ 4┊  ┊  Query: {},\n+┊  ┊ 9┊  Query: {\n+┊  ┊10┊    // Show all users for the moment.\n+┊  ┊11┊    users: (): User[] => users.filter(user => user.id !== currentUser),\n+┊  ┊12┊    chats: (): Chat[] => chats.filter(chat => chat.listingMemberIds.includes(currentUser)),\n+┊  ┊13┊    chat: (obj: any, {chatId}): Chat | null => chats.find(chat => chat.id === chatId) || null,\n+┊  ┊14┊  },\n+┊  ┊15┊  Chat: {\n+┊  ┊16┊    name: (chat: Chat): string => chat.name ? chat.name : users\n+┊  ┊17┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser))!.name,\n+┊  ┊18┊    picture: (chat: Chat) => chat.name ? chat.picture : users\n+┊  ┊19┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser))!.picture,\n+┊  ┊20┊    allTimeMembers: (chat: Chat): User[] => users.filter(user => chat.allTimeMemberIds.includes(user.id)),\n+┊  ┊21┊    listingMembers: (chat: Chat): User[] => users.filter(user => chat.listingMemberIds.includes(user.id)),\n+┊  ┊22┊    actualGroupMembers: (chat: Chat): User[] => users.filter(user => chat.actualGroupMemberIds && chat.actualGroupMemberIds.includes(user.id)),\n+┊  ┊23┊    admins: (chat: Chat): User[] => users.filter(user => chat.adminIds && chat.adminIds.includes(user.id)),\n+┊  ┊24┊    owner: (chat: Chat): User | null => users.find(user => chat.ownerId === user.id) || null,\n+┊  ┊25┊    messages: (chat: Chat, {amount = 0}: {amount: number}): Message[] => {\n+┊  ┊26┊      const messages = chat.messages\n+┊  ┊27┊      .filter(message => message.holderIds.includes(currentUser))\n+┊  ┊28┊      .sort((a, b) => b.createdAt - a.createdAt) || <Message[]>[];\n+┊  ┊29┊      return (amount ? messages.slice(0, amount) : messages).reverse();\n+┊  ┊30┊    },\n+┊  ┊31┊    unreadMessages: (chat: Chat): number => chat.messages\n+┊  ┊32┊      .filter(message => message.holderIds.includes(currentUser) &&\n+┊  ┊33┊        message.recipients.find(recipient => recipient.userId === currentUser && !recipient.readAt))\n+┊  ┊34┊      .length,\n+┊  ┊35┊    isGroup: (chat: Chat): boolean => !!chat.name,\n+┊  ┊36┊  },\n+┊  ┊37┊  Message: {\n+┊  ┊38┊    chat: (message: Message): Chat | null => chats.find(chat => message.chatId === chat.id) || null,\n+┊  ┊39┊    sender: (message: Message): User | null => users.find(user => user.id === message.senderId) || null,\n+┊  ┊40┊    holders: (message: Message): User[] => users.filter(user => message.holderIds.includes(user.id)),\n+┊  ┊41┊    ownership: (message: Message): boolean => message.senderId === currentUser,\n+┊  ┊42┊  },\n+┊  ┊43┊  Recipient: {\n+┊  ┊44┊    user: (recipient: Recipient): User | null => users.find(user => recipient.userId === user.id) || null,\n+┊  ┊45┊    message: (recipient: Recipient): Message | null => {\n+┊  ┊46┊      const chat = chats.find(chat => recipient.chatId === chat.id);\n+┊  ┊47┊      return chat ? chat.messages.find(message => recipient.messageId === message.id) || null : null;\n+┊  ┊48┊    },\n+┊  ┊49┊    chat: (recipient: Recipient): Chat | null => chats.find(chat => recipient.chatId === chat.id) || null,\n+┊  ┊50┊  },\n ┊ 5┊51┊};\n```\n\n[}]: #\n\nOut basic server is already done and working. We still have no way to do any kind of mutation, but we already set up several queries to return a list of users or chats.\nIn particular we can choose if we want to return all the chats (and how many messages we want to return for each chat) or if we want to return a single chat. We can also choose which and how many properties we want to return for each query.\nWe can start the server by simply running:\n\n    yarn start\n\n## Client\n\nNow we can concentrate on the client and bootstrap it using Angular-CLI.\nFirst you will need to install it globally with:\n\n    yarn global add @angular/cli\n\nThen we can create a new project from scratch:\n\n    ng new client --style scss\n\nTime to install a couple of packages:\n\n    ng add apollo-angular\n    yarn add -D @types/graphql\n\nApollo's Schematics sets everything for us. The only thing missing is to fill the `url`.\n\n[{]: <helper> (diffStep \"1.1\" files=\"src/app/graphql.module.ts\" module=\"client\")\n\n#### [Step 1.1: Add angular-apollo to app module](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/3a40362)\n\n##### Added src&#x2F;app&#x2F;graphql.module.ts\n```diff\n@@ -0,0 +1,25 @@\n+┊  ┊ 1┊import { NgModule} from '@angular/core';\n+┊  ┊ 2┊import { ApolloModule, APOLLO_OPTIONS } from 'apollo-angular';\n+┊  ┊ 3┊import { HttpLinkModule, HttpLink } from 'apollo-angular-link-http';\n+┊  ┊ 4┊import { InMemoryCache } from 'apollo-cache-inmemory';\n+┊  ┊ 5┊\n+┊  ┊ 6┊const uri = 'http://localhost:3000/graphql';\n+┊  ┊ 7┊\n+┊  ┊ 8┊export function createApollo(httpLink: HttpLink) {\n+┊  ┊ 9┊  return {\n+┊  ┊10┊    link: httpLink.create({uri}),\n+┊  ┊11┊    cache: new InMemoryCache(),\n+┊  ┊12┊  };\n+┊  ┊13┊}\n+┊  ┊14┊\n+┊  ┊15┊@NgModule({\n+┊  ┊16┊  exports: [ApolloModule, HttpLinkModule],\n+┊  ┊17┊  providers: [\n+┊  ┊18┊    {\n+┊  ┊19┊      provide: APOLLO_OPTIONS,\n+┊  ┊20┊      useFactory: createApollo,\n+┊  ┊21┊      deps: [HttpLink],\n+┊  ┊22┊    },\n+┊  ┊23┊  ],\n+┊  ┊24┊})\n+┊  ┊25┊export class GraphQLModule {}\n```\n\n[}]: #\n\nLet's take a closer look what Schematics prepared for us.\n\nFirst, it created `graphql.module.ts` and used `ApolloModule` and `HttpLinkModule`.\n\n- `ApolloModule` is the center of using GraphQL in your app! It includes all needed services that allows to use ApolloClient’s features.\n- `HttpLinkModule` makes it easy to fetch data in Angular.\n\n`HttpLinkModule` is optional, you can replace it with any other Link.\nIts biggest advantage of all is that it uses Angular's `HttpClient` internally so it's possible to use it in `NativeScript` or in combination with any other `HttpClient` provider. By using `HttpLinkModule` you get Server-Side Rendering for free, without any additional work.\n\nNext, we got `APOLLO_OPTIONS` provided to Angular.\n\nWe're using the `InMemoryCache` cache, but there are several options like `Redux`, `Hermes` and even `ngrx`.\n\n- `apollo-cache-inmemory` is an official and recommended Apollo Cache.\n\n### Cache and Links\n\nThese are two main parts of Apollo Stack, both are pluggable and customizable.\n\n- **Cache** is responsible for storing data and keeping it consistent.\n- **Links** describe how to access the source of data (usually a GraphQL endpoint).\n\nLet's take a closer look on what cache means for Apollo, we're going to base it on the official `apollo-cache-inmemory`, one of many implementations.\n\nBut first, imagine, we write our own amazing Apollo Cache implementation.\n\n```graphql\nquery getMessages {\n  messages {\n    id\n    content\n    likes\n  }\n}\n```\n\nWhen we execute a query like one above what we get in return is an array of all messages of logged in user:\n\n```json\n{\n  \"data\": {\n    \"messages\": [\n      {\n        \"id\": 0,\n        \"content\": \"Hi\",\n        \"likes\": 0\n      },\n      {\n        \"id\": 1,\n        \"content\": \"Hello\",\n        \"likes\": 0\n      }\n    ]\n  }\n}\n```\n\nOur cache stores the result in exact shape as above.\n\nLater on we add more queries and one of them returns a list of messages from one conversation.\n\nNow, a short story. We've got two users, Niccolo and Dotan.\n\n1. Niccolo opens the app and Apollo fetches all of his messages (I know, it's stupid but stay with me)\n1. One message is to Dotan, Niccolo said \"Hi\" to him.\n1. Now Dotan opens the app and reacts to the message with a like.\n1. After few minutes Niccolo asks for messages from a conversation with Dotan.\n1. Apollo fetches those messages and there is one in which Niccolo says \"Hi\" and it's liked by Dotan.\n1. Now we have the same message twice, one has different state that the other, in one place there is no like, in other, we have +1.\n\nAs you see, our cache is not smart enough to figure out one query might be a subset of another.\nThat's because it doesn't get enough informations.\n\nLet's go back to InMemoryCache and see how it describes itself:\n\n> Thanks to InMemoryCache, it's possible for the results of a query or mutation to update the UI in all the right places. In many cases it's possible for that to happen automatically, whereas in others you need to help the client out a little in doing so.\n\nIt means it could solve the issue we have with duplicated messages with different state.\n\nIt's very important to understand one concept that InMemoryCache is heavily based on, it's called normalization.\n\nThe InMemoryCache splits the result into individual objects, creates a unique identifier for each of them and flattens everything up before saving it to the store.\nMight seem complicated at first, but as InMemoryCache, let's break everything into smaller parts.\n\nFirst, \"breaking the result into pieces\" part. The InMemoryCache tells ApolloClient to add `__typename` field to your query before passing it to the server. I used server for simplicity, it actually passes it to Apollo Links and they are responsible to make a HTTP request. Every Apollo Cache is able to transform a document, that's as a side note.\n\n```graphql\nquery getMessages {\n  messages {\n    id\n    content\n    likes\n    __typename\n  }\n}\n```\n\nThe `__typename` field tells about the type of the object. It's compatible with every GraphQL server as it's part of the specification.\n\n```graphql\ntype Message {\n  id: ID\n  content: String\n  likes: Int\n}\n\ntype Query {\n  messages: [Message]\n}\n```\n\nIn our case, `__typename` returns `Message`. So now InMemoryCache knows that a message is a Message. Computers are stupid, we have to tell them everything!\n\nNext, let's take a look at \"creates a unique identifier\" part.\n\nThe InMemoryCache iterates through every object and looks for the `__typename` and two fields, `id` and `_id` that usually are used as identifiers. Taking our example, it turns every Message object into `Message:1`, `Message:2`, `Message:3` and so on. You get the idea.\n\nIt's the default behaviour but you can change it as you wish:\n\n```typescript\nconst cache = new InMemoryCache({\n  dataIdFromObject(result) {\n    if (result.__typename) {\n      const id = result.uid || result.id || result._id;\n\n      if (id !== undefined) {\n        return `${result.__typename}:${id}`;\n      }\n    }\n    return null;\n  },\n});\n```\n\nGreat, we covered two out of three things InMemoryCache does. Now we're going to explore \"flattens everything up\".\n\nWe're able to understand the type of each individual object and it's unique identifier. It still has to be stored.\n\nWhat InMemoryCache does is it's saves every element on root level in a plain object where the key contains a unique identifier and the value has a body.\n\n```json\n{\n  \"Message:1\": {\n    \"id\": 1,\n    \"content\": \"Hi\",\n    \"likes\": 1,\n    \"__typename\": \"Message\"\n  },\n  \"Message:2\": {\n    \"id\": 2,\n    \"content\": \"Hello\",\n    \"likes\": 0,\n    \"__typename\": \"Message\"\n  },\n  \"ROOT_QUERY\": {\n    \"messages\": [\n      {\n        \"id\": \"Message:1\",\n        \"typename\": \"Message\"\n      },\n      {\n        \"id\": \"Message:2\",\n        \"typename\": \"Message\"\n      }\n    ]\n  }\n}\n```\n\nWait, `ROOT_QUERY`? Yes, it has to somehow store the actual result of every executed query so next time you ask for the same thing, it matches it with the query in store and resolves right away.\n\n> You should be aware that the InMemoryCache stringifies variables of a query too, which means the same queries but with different variables are stored separately. Even the order of those variables matters.\n\nAs you can see, each element in `ROOT_QUERY.message` is kind of a reference to a message record.\n\nLet's bring back our short story, a scenario.\nWhen Niccolo asks for all messages, the whole three part process is started, each message is saved to the store.\nWhen he asks for history of a conversation with Dotan, InMemoryCache starts the process again and if it sees that there is already a massage with the same unique identifier, it knows they both are the same so it merged them.\nThe InMemoryCache can tell what changed and emits the new object to the UI.\nThanks to that we no longer have the same message in two places where one has a like and other doesn't.\n\nUff, Apollo Cache part is done. Thanks for being with us that long, I hope you didn't get bored because there's a lot ahead of us.\n\nLet's talk Apollo Link.\n\nAs I mentioned it's kind of a network stack of Apollo. You execute a document with some metadata like variables or a context, Apollo Client receives it and passes it to the chain of Links.\n\nThe ApolloLink is based on an Observable (not RxJS) and if you know `RxJS` you're familiar with `pipe`. Each Link is basically a function that receives a requested operation and a function that runs the next Link. Just like a pipe!\n\n```typescript\nimport { ApolloLink } from 'apollo-link';\n\nconst log = new ApolloLink((operation, next) => {\n  console.log('Name', operation.operationName);\n  return next(operation);\n});\n```\n\nNow when we add it in `graphql.module.ts` we see the name of each requested operation.\n\nWe can even intercept the result.\n\n```typescript\nconst intercept = new ApolloLink((operation, next) => {\n    return forward(operation).map((data) => {\n        // data from a previous link\n        console.log('data', data);\n        return data;\n    });\n});\n```\n\nAs you can see below, by network we don't always mean making HTTP requests. It could be Http Link at the end of Links chain or WebSocket Link or even something that works on in-memory data.\n\n```typescript\nimport { ApolloLink, Observable } from 'apollo-link';\n\nconst inmemory = new ApolloLink(operation => {\n    return Observable(observer => {\n        // function that executes the operation and returns data\n        const result = resolveOperation(operation);\n\n        observer.next(result);\n        observer.complete();\n    });\n});\n```\n\nYou can find tons of helpful Links [on npm](https://www.npmjs.com/search?q=apollo-link-) and [on Apollo Link documentation](https://www.apollographql.com/docs/link/links/community.html).\n\nWe highly recommend to take a look at Angular related Links [on Apollo Angular documentation](https://www.apollographql.com/docs/angular/guides/tools-and-packages.html).\n\n### GQL Tag\n\nThe `gql` template tag is what you use to define GraphQL queries in your Apollo apps. It parses your GraphQL query into the `GraphQL.js AST format` which may then be consumed by Apollo methods. Whenever Apollo is asking for a GraphQL query you will always want to wrap it in a `gql` template tag.\n\nYou can embed a GraphQL document containing only fragments inside of another GraphQL document using template string interpolation. This allows you to use fragments defined in one part of your codebase inside of a query defined in a completely different file.\n\n[{]: <helper> (diffStep \"1.2\" file=\"src/graphql/fragment.ts\" module=\"client\")\n\n#### [Step 1.2: Add chats service](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/591a455)\n\n##### Added src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -0,0 +1,25 @@\n+┊  ┊ 1┊import {map} from 'rxjs/operators';\n+┊  ┊ 2┊import {Apollo} from 'apollo-angular';\n+┊  ┊ 3┊import {Injectable} from '@angular/core';\n+┊  ┊ 4┊import {getChatsQuery} from '../../graphql/getChats.query';\n+┊  ┊ 5┊\n+┊  ┊ 6┊@Injectable()\n+┊  ┊ 7┊export class ChatsService {\n+┊  ┊ 8┊  messagesAmount = 3;\n+┊  ┊ 9┊\n+┊  ┊10┊  constructor(private apollo: Apollo) {}\n+┊  ┊11┊\n+┊  ┊12┊  getChats() {\n+┊  ┊13┊    const query = this.apollo.watchQuery<any>({\n+┊  ┊14┊      query: getChatsQuery,\n+┊  ┊15┊      variables: {\n+┊  ┊16┊        amount: this.messagesAmount,\n+┊  ┊17┊      },\n+┊  ┊18┊    });\n+┊  ┊19┊    const chats$ = query.valueChanges.pipe(\n+┊  ┊20┊      map((result) => result.data.chats)\n+┊  ┊21┊    );\n+┊  ┊22┊\n+┊  ┊23┊    return {query, chats$};\n+┊  ┊24┊  }\n+┊  ┊25┊}\n```\n\n##### Added src&#x2F;graphql&#x2F;fragment.ts\n```diff\n@@ -0,0 +1,51 @@\n+┊  ┊ 1┊import gql from 'graphql-tag';\n+┊  ┊ 2┊import {DocumentNode} from 'graphql';\n+┊  ┊ 3┊\n+┊  ┊ 4┊export const fragments: {\n+┊  ┊ 5┊  [key: string]: DocumentNode\n+┊  ┊ 6┊} = {\n+┊  ┊ 7┊  chatWithoutMessages: gql`\n+┊  ┊ 8┊    fragment ChatWithoutMessages on Chat {\n+┊  ┊ 9┊      id\n+┊  ┊10┊      name\n+┊  ┊11┊      picture\n+┊  ┊12┊      allTimeMembers {\n+┊  ┊13┊        id\n+┊  ┊14┊      }\n+┊  ┊15┊      unreadMessages\n+┊  ┊16┊      isGroup\n+┊  ┊17┊    }\n+┊  ┊18┊  `,\n+┊  ┊19┊  message: gql`\n+┊  ┊20┊    fragment Message on Message {\n+┊  ┊21┊      id\n+┊  ┊22┊      chat {\n+┊  ┊23┊        id\n+┊  ┊24┊      }\n+┊  ┊25┊      sender {\n+┊  ┊26┊        id\n+┊  ┊27┊        name\n+┊  ┊28┊      }\n+┊  ┊29┊      content\n+┊  ┊30┊      createdAt\n+┊  ┊31┊      type\n+┊  ┊32┊      recipients {\n+┊  ┊33┊        user {\n+┊  ┊34┊          id\n+┊  ┊35┊        }\n+┊  ┊36┊        message {\n+┊  ┊37┊          id\n+┊  ┊38┊          chat {\n+┊  ┊39┊            id\n+┊  ┊40┊          }\n+┊  ┊41┊        }\n+┊  ┊42┊        chat {\n+┊  ┊43┊          id\n+┊  ┊44┊        }\n+┊  ┊45┊        receivedAt\n+┊  ┊46┊        readAt\n+┊  ┊47┊      }\n+┊  ┊48┊      ownership\n+┊  ┊49┊    }\n+┊  ┊50┊  `,\n+┊  ┊51┊};\n```\n\n##### Added src&#x2F;graphql&#x2F;getChats.query.ts\n```diff\n@@ -0,0 +1,17 @@\n+┊  ┊ 1┊import gql from 'graphql-tag';\n+┊  ┊ 2┊import {fragments} from './fragment';\n+┊  ┊ 3┊\n+┊  ┊ 4┊// We use the gql tag to parse our query string into a query document\n+┊  ┊ 5┊export const getChatsQuery = gql`\n+┊  ┊ 6┊  query GetChats($amount: Int) {\n+┊  ┊ 7┊    chats {\n+┊  ┊ 8┊      ...ChatWithoutMessages\n+┊  ┊ 9┊      messages(amount: $amount) {\n+┊  ┊10┊        ...Message\n+┊  ┊11┊      }\n+┊  ┊12┊    }\n+┊  ┊13┊  }\n+┊  ┊14┊\n+┊  ┊15┊  ${fragments['chatWithoutMessages']}\n+┊  ┊16┊  ${fragments['message']}\n+┊  ┊17┊`;\n```\n\n[}]: #\n\n### Use Apollo service\n\nLet's create a simple service to query the chats from our just created server:\n\n[{]: <helper> (diffStep \"1.2\" files=\"src/app/services\" module=\"client\")\n\n#### [Step 1.2: Add chats service](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/591a455)\n\n##### Added src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -0,0 +1,25 @@\n+┊  ┊ 1┊import {map} from 'rxjs/operators';\n+┊  ┊ 2┊import {Apollo} from 'apollo-angular';\n+┊  ┊ 3┊import {Injectable} from '@angular/core';\n+┊  ┊ 4┊import {getChatsQuery} from '../../graphql/getChats.query';\n+┊  ┊ 5┊\n+┊  ┊ 6┊@Injectable()\n+┊  ┊ 7┊export class ChatsService {\n+┊  ┊ 8┊  messagesAmount = 3;\n+┊  ┊ 9┊\n+┊  ┊10┊  constructor(private apollo: Apollo) {}\n+┊  ┊11┊\n+┊  ┊12┊  getChats() {\n+┊  ┊13┊    const query = this.apollo.watchQuery<any>({\n+┊  ┊14┊      query: getChatsQuery,\n+┊  ┊15┊      variables: {\n+┊  ┊16┊        amount: this.messagesAmount,\n+┊  ┊17┊      },\n+┊  ┊18┊    });\n+┊  ┊19┊    const chats$ = query.valueChanges.pipe(\n+┊  ┊20┊      map((result) => result.data.chats)\n+┊  ┊21┊    );\n+┊  ┊22┊\n+┊  ┊23┊    return {query, chats$};\n+┊  ┊24┊  }\n+┊  ┊25┊}\n```\n\n[}]: #\n\nWe just learned how to use Apollo to attach GraphQL query results to the Angular UI.\n\nThe `watchQuery` method returns a `QueryRef` object which has the `valueChanges` property that is an `Observable`.\n\nEvery fetched data is stored in Apollo Client’s cache, so if some other query fetches new information about the chats, this component will update to remain consistent.\n\nIt’s also possible to fetch data only once. You simply use `query` method instead of `watchQuery`. The query method of Apollo service returns an Observable too that also resolves with the same result as above.\n\n#### But what is a `QueryRef`?\n\nAs you know, `query` method returns an Observable that emits a result, just once, then the observable completes. `watchQuery` works a bit different. It fetches data then stays open and listens to the Cache for updates.\n\nSo why `watchQuery` can not simply expose an Observable and it serves `QueryRef` instead?\n\nBecause Apollo Angular is a bridge between Apollo Client (core library) and Angular framework it has to operate on RxJS based Observables. RxJS Observable has a simple API that cannot be easily extended and it's in general a bad practice.\n\nWhy we're talking about those things? Apollo Client exposes an Observable that has bunch of custom method on it. They are super useful and their purpose is to talk to Apollo through them.\n\nSince we have to turn Apollo's Observable to something that is compatible with RxJS we decided to expose an object that has all those methods and `valueChanges` property that is a regular RxJS Observable.\n\n#### Make our app pretty\n\nWe will use Materials for the UI, so let's install it:\n\n    yarn add @angular/cdk @angular/material hammerjs ng2-truncate\n\nLet's configure Material:\n\n[{]: <helper> (diffStep \"1.3\" files=\"src/index.ts, src/main.ts, src/styles.scss\" module=\"client\")\n\n#### [Step 1.3: List the chats](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/7d716ee)\n\n##### Changed src&#x2F;main.ts\n```diff\n@@ -4,6 +4,9 @@\n ┊ 4┊ 4┊import { AppModule } from './app/app.module';\n ┊ 5┊ 5┊import { environment } from './environments/environment';\n ┊ 6┊ 6┊\n+┊  ┊ 7┊// Material gestures\n+┊  ┊ 8┊import 'hammerjs';\n+┊  ┊ 9┊\n ┊ 7┊10┊if (environment.production) {\n ┊ 8┊11┊  enableProdMode();\n ┊ 9┊12┊}\n```\n\n##### Changed src&#x2F;styles.scss\n```diff\n@@ -1 +1,28 @@\n ┊ 1┊ 1┊/* You can add global styles to this file, and also import other style files */\n+┊  ┊ 2┊\n+┊  ┊ 3┊/* Meterial theme */\n+┊  ┊ 4┊@import \"~@angular/material/prebuilt-themes/indigo-pink.css\";\n+┊  ┊ 5┊\n+┊  ┊ 6┊:root {\n+┊  ┊ 7┊  --primary: #2c6157;\n+┊  ┊ 8┊  --secondary: #6fd056;\n+┊  ┊ 9┊}\n+┊  ┊10┊\n+┊  ┊11┊body {\n+┊  ┊12┊  margin: 0;\n+┊  ┊13┊}\n+┊  ┊14┊\n+┊  ┊15┊.mat-primary {\n+┊  ┊16┊  background-color: var(--primary) !important;\n+┊  ┊17┊  color: white;\n+┊  ┊18┊}\n+┊  ┊19┊\n+┊  ┊20┊.mat-secondary {\n+┊  ┊21┊  background-color: var(--secondary) !important;\n+┊  ┊22┊  color: white;\n+┊  ┊23┊}\n+┊  ┊24┊\n+┊  ┊25┊.mat-toolbar {\n+┊  ┊26┊  color: white;\n+┊  ┊27┊  background-color: var(--primary) !important;\n+┊  ┊28┊}\n```\n\n[}]: #\n\nWe're now creating a `shared` module where we will define our header component where we're going to project a different content from each component:\n\n[{]: <helper> (diffStep \"1.3\" files=\"src/app/shared/*\" module=\"client\")\n\n#### [Step 1.3: List the chats](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/7d716ee)\n\n##### Added src&#x2F;app&#x2F;shared&#x2F;components&#x2F;toolbar&#x2F;toolbar.component.scss\n```diff\n@@ -0,0 +1,15 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊  height: 8vh;\n+┊  ┊ 4┊}\n+┊  ┊ 5┊\n+┊  ┊ 6┊.mat-toolbar {\n+┊  ┊ 7┊  justify-content: space-between;\n+┊  ┊ 8┊  height: 100%;\n+┊  ┊ 9┊\n+┊  ┊10┊  .left-block {\n+┊  ┊11┊    display: flex;\n+┊  ┊12┊    height: 8vh;\n+┊  ┊13┊    line-height: 8vh;\n+┊  ┊14┊  }\n+┊  ┊15┊}\n```\n\n##### Added src&#x2F;app&#x2F;shared&#x2F;components&#x2F;toolbar&#x2F;toolbar.component.ts\n```diff\n@@ -0,0 +1,19 @@\n+┊  ┊ 1┊import {Component} from '@angular/core';\n+┊  ┊ 2┊\n+┊  ┊ 3┊@Component({\n+┊  ┊ 4┊  selector: 'app-toolbar',\n+┊  ┊ 5┊  template: `\n+┊  ┊ 6┊    <mat-toolbar>\n+┊  ┊ 7┊      <div class=\"left-block\">\n+┊  ┊ 8┊        <ng-content select=\".navigation\"></ng-content>\n+┊  ┊ 9┊        <ng-content select=\".profile-pic\"></ng-content>\n+┊  ┊10┊        <ng-content select=\".title\"></ng-content>\n+┊  ┊11┊      </div>\n+┊  ┊12┊      <ng-content select=\".menu\"></ng-content>\n+┊  ┊13┊    </mat-toolbar>\n+┊  ┊14┊  `,\n+┊  ┊15┊  styleUrls: ['./toolbar.component.scss']\n+┊  ┊16┊})\n+┊  ┊17┊export class ToolbarComponent {\n+┊  ┊18┊\n+┊  ┊19┊}\n```\n\n##### Added src&#x2F;app&#x2F;shared&#x2F;shared.module.ts\n```diff\n@@ -0,0 +1,28 @@\n+┊  ┊ 1┊import {BrowserModule} from '@angular/platform-browser';\n+┊  ┊ 2┊import {NgModule} from '@angular/core';\n+┊  ┊ 3┊\n+┊  ┊ 4┊import {MatToolbarModule} from '@angular/material';\n+┊  ┊ 5┊import {ToolbarComponent} from './components/toolbar/toolbar.component';\n+┊  ┊ 6┊import {FormsModule} from '@angular/forms';\n+┊  ┊ 7┊import {BrowserAnimationsModule} from '@angular/platform-browser/animations';\n+┊  ┊ 8┊\n+┊  ┊ 9┊@NgModule({\n+┊  ┊10┊  declarations: [\n+┊  ┊11┊    ToolbarComponent,\n+┊  ┊12┊  ],\n+┊  ┊13┊  imports: [\n+┊  ┊14┊    BrowserModule,\n+┊  ┊15┊    // Material\n+┊  ┊16┊    MatToolbarModule,\n+┊  ┊17┊    // Animations\n+┊  ┊18┊    BrowserAnimationsModule,\n+┊  ┊19┊    // Forms\n+┊  ┊20┊    FormsModule,\n+┊  ┊21┊  ],\n+┊  ┊22┊  providers: [],\n+┊  ┊23┊  exports: [\n+┊  ┊24┊    ToolbarComponent,\n+┊  ┊25┊  ],\n+┊  ┊26┊})\n+┊  ┊27┊export class SharedModule {\n+┊  ┊28┊}\n```\n\n[}]: #\n\nNow we want to create the `chats-lister` module, with a container component called `ChatsComponent` and a couple of presentational components. Each and every chat item would be presented with a default profile picture as a placeholder, so before we proceed we will have to download it to the `src/assets` directory:\n\n    $ wget https://raw.githubusercontent.com/DAB0mB/whatsapp-client-angularcli-material/c75c2416b1990da3588015f76b8338764f44d6ec/src/assets/default-profile-pic.jpg -P src/assets\n\nAnd now we can proceed to creating the relevant components and their style sheets:\n\n[{]: <helper> (diffStep \"1.3\" files=\"src/app/chats-lister/*\" module=\"client\")\n\n#### [Step 1.3: List the chats](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/7d716ee)\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;chats-lister.module.ts\n```diff\n@@ -0,0 +1,49 @@\n+┊  ┊ 1┊import { BrowserModule } from '@angular/platform-browser';\n+┊  ┊ 2┊import { NgModule } from '@angular/core';\n+┊  ┊ 3┊\n+┊  ┊ 4┊import {BrowserAnimationsModule} from '@angular/platform-browser/animations';\n+┊  ┊ 5┊import {MatButtonModule, MatIconModule, MatListModule, MatMenuModule} from '@angular/material';\n+┊  ┊ 6┊import {RouterModule, Routes} from '@angular/router';\n+┊  ┊ 7┊import {FormsModule} from '@angular/forms';\n+┊  ┊ 8┊import {ChatsService} from '../services/chats.service';\n+┊  ┊ 9┊import {ChatItemComponent} from './components/chat-item/chat-item.component';\n+┊  ┊10┊import {ChatsComponent} from './containers/chats/chats.component';\n+┊  ┊11┊import {ChatsListComponent} from './components/chats-list/chats-list.component';\n+┊  ┊12┊import {TruncateModule} from 'ng2-truncate';\n+┊  ┊13┊import {SharedModule} from '../shared/shared.module';\n+┊  ┊14┊\n+┊  ┊15┊const routes: Routes = [\n+┊  ┊16┊  {path: '', redirectTo: 'chats', pathMatch: 'full'},\n+┊  ┊17┊  {path: 'chats', component: ChatsComponent},\n+┊  ┊18┊];\n+┊  ┊19┊\n+┊  ┊20┊@NgModule({\n+┊  ┊21┊  declarations: [\n+┊  ┊22┊    ChatsComponent,\n+┊  ┊23┊    ChatsListComponent,\n+┊  ┊24┊    ChatItemComponent,\n+┊  ┊25┊  ],\n+┊  ┊26┊  imports: [\n+┊  ┊27┊    BrowserModule,\n+┊  ┊28┊    // Material\n+┊  ┊29┊    MatMenuModule,\n+┊  ┊30┊    MatIconModule,\n+┊  ┊31┊    MatButtonModule,\n+┊  ┊32┊    MatListModule,\n+┊  ┊33┊    // Animations\n+┊  ┊34┊    BrowserAnimationsModule,\n+┊  ┊35┊    // Routing\n+┊  ┊36┊    RouterModule.forChild(routes),\n+┊  ┊37┊    // Forms\n+┊  ┊38┊    FormsModule,\n+┊  ┊39┊    // Truncate Pipe\n+┊  ┊40┊    TruncateModule,\n+┊  ┊41┊    // Feature modules\n+┊  ┊42┊    SharedModule,\n+┊  ┊43┊  ],\n+┊  ┊44┊  providers: [\n+┊  ┊45┊    ChatsService,\n+┊  ┊46┊  ],\n+┊  ┊47┊})\n+┊  ┊48┊export class ChatsListerModule {\n+┊  ┊49┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chat-item&#x2F;chat-item.component.scss\n```diff\n@@ -0,0 +1,44 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊  width: 100%;\n+┊  ┊ 4┊}\n+┊  ┊ 5┊\n+┊  ┊ 6┊.chat-row {\n+┊  ┊ 7┊  margin: 10px 0 0 10px;\n+┊  ┊ 8┊  height: 60px;\n+┊  ┊ 9┊  display: flex;\n+┊  ┊10┊\n+┊  ┊11┊  .chat-pic {\n+┊  ┊12┊    height: 50px;\n+┊  ┊13┊    width: auto;\n+┊  ┊14┊    border-radius: 50%;\n+┊  ┊15┊  }\n+┊  ┊16┊\n+┊  ┊17┊  .chat-info {\n+┊  ┊18┊    width: calc(100% - 60px);\n+┊  ┊19┊    height: 100%;\n+┊  ┊20┊    margin-left: 10px;\n+┊  ┊21┊    border-bottom: .5px solid silver;\n+┊  ┊22┊    position: relative;\n+┊  ┊23┊\n+┊  ┊24┊    .chat-name {\n+┊  ┊25┊      margin-top: 5px;\n+┊  ┊26┊    }\n+┊  ┊27┊\n+┊  ┊28┊    .chat-last-message {\n+┊  ┊29┊      color: gray;\n+┊  ┊30┊      font-size: 15px;\n+┊  ┊31┊      margin-top: 5px;\n+┊  ┊32┊      text-overflow: ellipsis;\n+┊  ┊33┊      overflow: hidden;\n+┊  ┊34┊    }\n+┊  ┊35┊\n+┊  ┊36┊    .chat-timestamp {\n+┊  ┊37┊      position: absolute;\n+┊  ┊38┊      color: gray;\n+┊  ┊39┊      top: 5px;\n+┊  ┊40┊      right: 5px;\n+┊  ┊41┊      font-size: 13px;\n+┊  ┊42┊    }\n+┊  ┊43┊  }\n+┊  ┊44┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chat-item&#x2F;chat-item.component.ts\n```diff\n@@ -0,0 +1,21 @@\n+┊  ┊ 1┊import {Component, Input} from '@angular/core';\n+┊  ┊ 2┊\n+┊  ┊ 3┊@Component({\n+┊  ┊ 4┊  selector: 'app-chat-item',\n+┊  ┊ 5┊  template: `\n+┊  ┊ 6┊    <div class=\"chat-row\">\n+┊  ┊ 7┊      <img class=\"chat-pic\" [src]=\"chat.picture || 'assets/default-profile-pic.jpg'\">\n+┊  ┊ 8┊      <div class=\"chat-info\">\n+┊  ┊ 9┊        <div class=\"chat-name\">{{ chat.name }}</div>\n+┊  ┊10┊        <div class=\"chat-last-message\">{{ chat.messages?[chat.messages?.length - 1]?.content }}</div>\n+┊  ┊11┊        <div class=\"chat-timestamp\">00:00</div>\n+┊  ┊12┊      </div>\n+┊  ┊13┊    </div>\n+┊  ┊14┊  `,\n+┊  ┊15┊  styleUrls: ['chat-item.component.scss'],\n+┊  ┊16┊})\n+┊  ┊17┊export class ChatItemComponent {\n+┊  ┊18┊  // tslint:disable-next-line:no-input-rename\n+┊  ┊19┊  @Input('item')\n+┊  ┊20┊  chat: any;\n+┊  ┊21┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chats-list&#x2F;chats-list.component.scss\n```diff\n@@ -0,0 +1,8 @@\n+┊ ┊1┊:host {\n+┊ ┊2┊  display: block;\n+┊ ┊3┊}\n+┊ ┊4┊\n+┊ ┊5┊:host ::ng-deep .mat-list-item-content:first-child {\n+┊ ┊6┊  padding-left: 0 !important;\n+┊ ┊7┊  display: flow-root !important;\n+┊ ┊8┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chats-list&#x2F;chats-list.component.ts\n```diff\n@@ -0,0 +1,20 @@\n+┊  ┊ 1┊import {Component, Input} from '@angular/core';\n+┊  ┊ 2┊\n+┊  ┊ 3┊@Component({\n+┊  ┊ 4┊  selector: 'app-chats-list',\n+┊  ┊ 5┊  template: `\n+┊  ┊ 6┊    <mat-list>\n+┊  ┊ 7┊      <mat-list-item *ngFor=\"let chat of chats\">\n+┊  ┊ 8┊        <app-chat-item [item]=\"chat\"></app-chat-item>\n+┊  ┊ 9┊      </mat-list-item>\n+┊  ┊10┊    </mat-list>\n+┊  ┊11┊  `,\n+┊  ┊12┊  styleUrls: ['chats-list.component.scss'],\n+┊  ┊13┊})\n+┊  ┊14┊export class ChatsListComponent {\n+┊  ┊15┊  // tslint:disable-next-line:no-input-rename\n+┊  ┊16┊  @Input('items')\n+┊  ┊17┊  chats: any[];\n+┊  ┊18┊\n+┊  ┊19┊  constructor() {}\n+┊  ┊20┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.scss\n```diff\n@@ -0,0 +1,5 @@\n+┊ ┊1┊.chat-button {\n+┊ ┊2┊  position: absolute;\n+┊ ┊3┊  bottom: 5vw;\n+┊ ┊4┊  right: 5vw;\n+┊ ┊5┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.ts\n```diff\n@@ -0,0 +1,46 @@\n+┊  ┊ 1┊import {Component, OnInit} from '@angular/core';\n+┊  ┊ 2┊import {ChatsService} from '../../../services/chats.service';\n+┊  ┊ 3┊import {Observable} from 'rxjs';\n+┊  ┊ 4┊\n+┊  ┊ 5┊@Component({\n+┊  ┊ 6┊  template: `\n+┊  ┊ 7┊    <app-toolbar>\n+┊  ┊ 8┊      <div class=\"title\">Whatsapp Clone</div>\n+┊  ┊ 9┊      <button mat-icon-button [matMenuTriggerFor]=\"menu\" class=\"menu\">\n+┊  ┊10┊        <mat-icon>more_vert</mat-icon>\n+┊  ┊11┊      </button>\n+┊  ┊12┊    </app-toolbar>\n+┊  ┊13┊\n+┊  ┊14┊    <mat-menu #menu=\"matMenu\">\n+┊  ┊15┊      <button mat-menu-item>\n+┊  ┊16┊        <mat-icon>dialpad</mat-icon>\n+┊  ┊17┊        <span>Redial</span>\n+┊  ┊18┊      </button>\n+┊  ┊19┊      <button mat-menu-item disabled>\n+┊  ┊20┊        <mat-icon>voicemail</mat-icon>\n+┊  ┊21┊        <span>Check voicemail</span>\n+┊  ┊22┊      </button>\n+┊  ┊23┊      <button mat-menu-item>\n+┊  ┊24┊        <mat-icon>notifications_off</mat-icon>\n+┊  ┊25┊        <span>Disable alerts</span>\n+┊  ┊26┊      </button>\n+┊  ┊27┊    </mat-menu>\n+┊  ┊28┊\n+┊  ┊29┊    <app-chats-list [items]=\"chats$ | async\"></app-chats-list>\n+┊  ┊30┊\n+┊  ┊31┊    <button class=\"chat-button\" mat-fab color=\"secondary\">\n+┊  ┊32┊      <mat-icon aria-label=\"Icon-button with a + icon\">chat</mat-icon>\n+┊  ┊33┊    </button>\n+┊  ┊34┊  `,\n+┊  ┊35┊  styleUrls: ['./chats.component.scss'],\n+┊  ┊36┊})\n+┊  ┊37┊export class ChatsComponent implements OnInit {\n+┊  ┊38┊  chats$: Observable<any[]>;\n+┊  ┊39┊\n+┊  ┊40┊  constructor(private chatsService: ChatsService) {\n+┊  ┊41┊  }\n+┊  ┊42┊\n+┊  ┊43┊  ngOnInit() {\n+┊  ┊44┊    this.chats$ = this.chatsService.getChats().chats$;\n+┊  ┊45┊  }\n+┊  ┊46┊}\n```\n\n[}]: #\n\nFinally let's wire everything up to the main module:\n\n[{]: <helper> (diffStep \"1.3\" files=\"src/app/app.component.ts, src/app/app.module.ts\" module=\"client\")\n\n#### [Step 1.3: List the chats](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/7d716ee)\n\n##### Changed src&#x2F;app&#x2F;app.component.ts\n```diff\n@@ -2,7 +2,9 @@\n ┊ 2┊ 2┊\n ┊ 3┊ 3┊@Component({\n ┊ 4┊ 4┊  selector: 'app-root',\n-┊ 5┊  ┊  templateUrl: './app.component.html',\n+┊  ┊ 5┊  template: `\n+┊  ┊ 6┊    <router-outlet></router-outlet>\n+┊  ┊ 7┊  `,\n ┊ 6┊ 8┊  styleUrls: ['./app.component.scss']\n ┊ 7┊ 9┊})\n ┊ 8┊10┊export class AppComponent {\n```\n\n##### Changed src&#x2F;app&#x2F;app.module.ts\n```diff\n@@ -4,6 +4,9 @@\n ┊ 4┊ 4┊import { AppComponent } from './app.component';\n ┊ 5┊ 5┊import { HttpClientModule } from '@angular/common/http';\n ┊ 6┊ 6┊import { GraphQLModule } from './graphql.module';\n+┊  ┊ 7┊import {ChatsListerModule} from './chats-lister/chats-lister.module';\n+┊  ┊ 8┊import {RouterModule, Routes} from '@angular/router';\n+┊  ┊ 9┊const routes: Routes = [];\n ┊ 7┊10┊\n ┊ 8┊11┊@NgModule({\n ┊ 9┊12┊  declarations: [\n```\n```diff\n@@ -13,6 +16,10 @@\n ┊13┊16┊    BrowserModule,\n ┊14┊17┊    HttpClientModule,\n ┊15┊18┊    GraphQLModule,\n+┊  ┊19┊    // Routing\n+┊  ┊20┊    RouterModule.forRoot(routes),\n+┊  ┊21┊    // Feature modules\n+┊  ┊22┊    ChatsListerModule,\n ┊16┊23┊  ],\n ┊17┊24┊  providers: [],\n ┊18┊25┊  bootstrap: [AppComponent]\n```\n\n[}]: #\n\nIf you will try to run the frontend you will notice that several messages seems like duplicated, why does it happen?\n\nSince we use NoSQL-like structure in our backend, messages are stored as an array inside each chat so their incremental identifiers are not unique across different chats. We need to normalize them in a way that takes into account both the message id and the chat id:\n\n[{]: <helper> (diffStep \"1.4\" module=\"client\")\n\n#### [Step 1.4: Better normalize messages](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/4209360)\n\n##### Changed src&#x2F;app&#x2F;graphql.module.ts\n```diff\n@@ -1,14 +1,21 @@\n ┊ 1┊ 1┊import { NgModule} from '@angular/core';\n ┊ 2┊ 2┊import { ApolloModule, APOLLO_OPTIONS } from 'apollo-angular';\n ┊ 3┊ 3┊import { HttpLinkModule, HttpLink } from 'apollo-angular-link-http';\n-┊ 4┊  ┊import { InMemoryCache } from 'apollo-cache-inmemory';\n+┊  ┊ 4┊import { InMemoryCache, defaultDataIdFromObject } from 'apollo-cache-inmemory';\n ┊ 5┊ 5┊\n ┊ 6┊ 6┊const uri = 'http://localhost:3000/graphql';\n ┊ 7┊ 7┊\n ┊ 8┊ 8┊export function createApollo(httpLink: HttpLink) {\n ┊ 9┊ 9┊  return {\n ┊10┊10┊    link: httpLink.create({uri}),\n-┊11┊  ┊    cache: new InMemoryCache(),\n+┊  ┊11┊    cache: new InMemoryCache({\n+┊  ┊12┊      dataIdFromObject: (object: any) => {\n+┊  ┊13┊        switch (object.__typename) {\n+┊  ┊14┊          case 'Message': return `${object.chat.id}:${object.id}`; // use `chatId` prefix and `messageId` as the primary key\n+┊  ┊15┊          default: return defaultDataIdFromObject(object); // fall back to default handling\n+┊  ┊16┊        }\n+┊  ┊17┊      }\n+┊  ┊18┊    }),\n ┊12┊19┊  };\n ┊13┊20┊}\n```\n\n[}]: #\n\nThat way our application will work even if the backend is a NoSQL. What's even more interesting is that our application will keep working as well even when we will switch our backend to PostgreSQL."
          },
          {
            "manualTitle": "Step 6: graphql-code-generator",
            "stepRevision": "b39f987d0944ef79a533fa88893c3a79b814a84f",
            "manualView": "## Code Generation\n\nGraphQL entities are defined as static and typed, which means they can be analyzed and use as a base for generating everything.\n\nThere are many tools related to that topic, but we're going to focus on The **GraphQL Coge Generator**.\n\nThe GraphQL Coge Generator can generate any code for any language  —  including type definitions, data models, query builder, resolvers, ORM code, complete full stack platforms.\n\nThe tool is based on the concept of templates. It has few official templates to solve most required features. The GraphQL Code Gen allows to create your own custom codegen templates in 10 minutes, that fit exactly your needs.\n\nWe will use TypeScript template to generate typings.\n\n### Generating types for server-side code\n\nFirst, let's install `graphql-code-generator` with the TypeScript template and add it to the run scripts:\n\n    yarn add graphql-code-generator graphql-codegen-typescript-template\n\n[{]: <helper> (diffStep \"2.1\" module=\"server\")\n\n#### [Step 2.1: Install graphql-code-generator](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/b8214fd)\n\n##### Changed package.json\n```diff\n@@ -4,7 +4,8 @@\n ┊ 4┊ 4┊  \"private\": true,\n ┊ 5┊ 5┊  \"scripts\": {\n ┊ 6┊ 6┊    \"start\": \"npm run build:live\",\n-┊ 7┊  ┊    \"build:live\": \"nodemon --exec ./node_modules/.bin/ts-node -- ./index.ts\"\n+┊  ┊ 7┊    \"build:live\": \"nodemon --exec ./node_modules/.bin/ts-node -- ./index.ts\",\n+┊  ┊ 8┊    \"generator\": \"gql-gen -r ts-node/register —schema schema/typeDefs.ts --template ts --out ./types.d.ts\"\n ┊ 8┊ 9┊  },\n ┊ 9┊10┊  \"devDependencies\": {\n ┊10┊11┊    \"@types/body-parser\": \"1.17.0\",\n```\n```diff\n@@ -22,6 +23,7 @@\n ┊22┊23┊    \"cors\": \"2.8.4\",\n ┊23┊24┊    \"express\": \"4.16.3\",\n ┊24┊25┊    \"graphql\": \"14.0.2\",\n+┊  ┊26┊    \"graphql-code-generator\": \"0.12.6\",\n ┊25┊27┊    \"moment\": \"2.22.1\"\n ┊26┊28┊  }\n ┊27┊29┊}\n```\n\n[}]: #\n\nFew things here:\n\n- `--require ts-node/register` - makes the ts-node compile TypeScript files\n- `--schema` - points to a file that exports the GraphQL Schema object or a string (it also accepts an url)\n- `--template` - tells about the template we want to use\n- `--out` - the location of a generated file\n\nNow let's run the generator:\n\n    yarn generator\n\nPlease note that the server doesn't have to be running in background because we import schema through a file.\n\nNext, let's use the generated types:\n\n[{]: <helper> (diffStep \"2.3\" module=\"server\")\n\n#### [Step 2.3: Use our types](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/ef59ecf)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,5 +1,6 @@\n ┊1┊1┊import { IResolvers } from 'apollo-server-express';\n ┊2┊2┊import { Chat, db, Message, Recipient, User } from \"../db\";\n+┊ ┊3┊import { ChatQueryArgs } from \"../types\";\n ┊3┊4┊\n ┊4┊5┊let users = db.users;\n ┊5┊6┊let chats = db.chats;\n```\n```diff\n@@ -10,7 +11,7 @@\n ┊10┊11┊    // Show all users for the moment.\n ┊11┊12┊    users: (): User[] => users.filter(user => user.id !== currentUser),\n ┊12┊13┊    chats: (): Chat[] => chats.filter(chat => chat.listingMemberIds.includes(currentUser)),\n-┊13┊  ┊    chat: (obj: any, {chatId}): Chat | null => chats.find(chat => chat.id === chatId) || null,\n+┊  ┊14┊    chat: (obj: any, {chatId}: ChatQueryArgs): Chat | null => chats.find(chat => chat.id === Number(chatId)) || null,\n ┊14┊15┊  },\n ┊15┊16┊  Chat: {\n ┊16┊17┊    name: (chat: Chat): string => chat.name ? chat.name : users\n```\n\n[}]: #\n\nDon't worry, they will be much more useful when we will write our first mutation.\n\n### Generating types for client-side code\n\nLet's do the same on the client:\n\n    yarn add graphql-code-generator graphql-codegen-typescript-template\n\nPlease note that in this case, the server must be started before running the generator.\n\n[{]: <helper> (diffStep \"2.1\" module=\"client\")\n\n#### [Step 2.1: Install graphql-code-generator](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/a97dbe5)\n\n##### Changed package.json\n```diff\n@@ -7,7 +7,8 @@\n ┊ 7┊ 7┊    \"build\": \"ng build\",\n ┊ 8┊ 8┊    \"test\": \"ng test\",\n ┊ 9┊ 9┊    \"lint\": \"ng lint\",\n-┊10┊  ┊    \"e2e\": \"ng e2e\"\n+┊  ┊10┊    \"e2e\": \"ng e2e\",\n+┊  ┊11┊    \"generator\": \"gql-gen --schema http://localhost:3000/graphql --template graphql-codegen-typescript-template --out ./src/graphql.ts ./src/graphql/**/*.ts\"\n ┊11┊12┊  },\n ┊12┊13┊  \"private\": true,\n ┊13┊14┊  \"dependencies\": {\n```\n```diff\n@@ -45,6 +46,7 @@\n ┊45┊46┊    \"@types/jasminewd2\": \"2.0.3\",\n ┊46┊47┊    \"@types/node\": \"8.9.5\",\n ┊47┊48┊    \"codelyzer\": \"4.2.1\",\n+┊  ┊49┊    \"graphql-code-generator\": \"0.12.6\",\n ┊48┊50┊    \"jasmine-core\": \"2.99.1\",\n ┊49┊51┊    \"jasmine-spec-reporter\": \"4.2.1\",\n ┊50┊52┊    \"karma\": \"1.7.1\",\n```\n\n[}]: #\n\nWe saw how to use them on the server but let's see how easy it is to take advantage of them in Apollo.\n\nFirst thing you should know is most of the methods of Apollo service accepts generic types.\n\n#### What are Generic Types\n\nA major part of software engineering is building components that not only have well-defined and consistent APIs, but are also reusable. Components that are capable of working on the data of today as well as the data of tomorrow will give you the most flexible capabilities for building up large software systems.\n\nWe like to work on an code samples so let's do some functional programming and create the `map` method that accepts a transform function and return a new result.\n\nWithout generics, we would have to use a specific type or `any`:\n\n```typescript\nfunction map(mapFn: (value: any) => any) {\n  return function(source: any): any {\n    return mapFn(source);\n  };\n}\n```\n\nImagine, we want to use `map` function to pick user's id from an object:\n\n```typescript\ninterface User {\n  id: number;\n}\nconst me = {\n  id: 1,\n};\n\nconst pickUserId = map(user => user.id);\n\nconsole.log(pickUserId(me)); // outputs: 1\n```\n\nGreat, it works, we get the expected result but it could be done way better.\n\nWhat is the main issue here?\nIt accepts an object of any type and get `any` in return. It's not very useful because we know it return a `number` and receive a `User` but TypeScript doesn't know that and later on, in other part of the code, we end up with no information about the result.\n\nThat's where Generic Types jumps in!\n\nWith generics, it could look like this:\n\n```typescript\nfunction map<T, R>(mapFn: (value: T) => R) {\n  return function(source: T): R {\n    return mapFn(source);\n  };\n}\n```\n\nThere's... a lot! So let's break it:\n\n- `map<T, R>` - the map function accepts two generic types\n- `(mapFn: (value: T) => R)` - the only argument is a function that accepts an object of type `T` and returns value of type `R`\n- `function (source: T): R => {...}` - it's a higher order function that accepts a source of type `T` and transforms to be `R`.\n\nBack to our example, now with generic types:\n\n```typescript\ninterface User {\n  id: number;\n}\nconst me = {\n  id: 1,\n};\n\nconst pickUserId = map<User, number>(user => user.id);\n\nconsole.log(pickUserId(me)); // outputs: 1\n```\n\nOur `map` and `pickUserId` function are strongly typed now so when you try to provide an object that has no `id` field or the field is a `string` you'll receive a proper information from TypeScript (and your IDE).\n\n#### Make client-side code strongly typed\n\nWith all that knowledge let's use how to use those generated typed with `Apollo` service:\n\n[{]: <helper> (diffStep \"2.3\" module=\"client\")\n\n#### [Step 2.3: Use the generated types](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/afdf40c)\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chat-item&#x2F;chat-item.component.ts\n```diff\n@@ -1,4 +1,5 @@\n ┊1┊1┊import {Component, Input} from '@angular/core';\n+┊ ┊2┊import {GetChats} from '../../../../graphql';\n ┊2┊3┊\n ┊3┊4┊@Component({\n ┊4┊5┊  selector: 'app-chat-item',\n```\n```diff\n@@ -17,5 +18,5 @@\n ┊17┊18┊export class ChatItemComponent {\n ┊18┊19┊  // tslint:disable-next-line:no-input-rename\n ┊19┊20┊  @Input('item')\n-┊20┊  ┊  chat: any;\n+┊  ┊21┊  chat: GetChats.Chats;\n ┊21┊22┊}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chats-list&#x2F;chats-list.component.ts\n```diff\n@@ -1,4 +1,5 @@\n ┊1┊1┊import {Component, Input} from '@angular/core';\n+┊ ┊2┊import {GetChats} from '../../../../graphql';\n ┊2┊3┊\n ┊3┊4┊@Component({\n ┊4┊5┊  selector: 'app-chats-list',\n```\n```diff\n@@ -14,7 +15,7 @@\n ┊14┊15┊export class ChatsListComponent {\n ┊15┊16┊  // tslint:disable-next-line:no-input-rename\n ┊16┊17┊  @Input('items')\n-┊17┊  ┊  chats: any[];\n+┊  ┊18┊  chats: GetChats.Chats[];\n ┊18┊19┊\n ┊19┊20┊  constructor() {}\n ┊20┊21┊}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.ts\n```diff\n@@ -1,6 +1,7 @@\n ┊1┊1┊import {Component, OnInit} from '@angular/core';\n ┊2┊2┊import {ChatsService} from '../../../services/chats.service';\n ┊3┊3┊import {Observable} from 'rxjs';\n+┊ ┊4┊import {GetChats} from '../../../../graphql';\n ┊4┊5┊\n ┊5┊6┊@Component({\n ┊6┊7┊  template: `\n```\n```diff\n@@ -35,7 +36,7 @@\n ┊35┊36┊  styleUrls: ['./chats.component.scss'],\n ┊36┊37┊})\n ┊37┊38┊export class ChatsComponent implements OnInit {\n-┊38┊  ┊  chats$: Observable<any[]>;\n+┊  ┊39┊  chats$: Observable<GetChats.Chats[]>;\n ┊39┊40┊\n ┊40┊41┊  constructor(private chatsService: ChatsService) {\n ┊41┊42┊  }\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -2,6 +2,7 @@\n ┊2┊2┊import {Apollo} from 'apollo-angular';\n ┊3┊3┊import {Injectable} from '@angular/core';\n ┊4┊4┊import {getChatsQuery} from '../../graphql/getChats.query';\n+┊ ┊5┊import {GetChats} from '../../graphql';\n ┊5┊6┊\n ┊6┊7┊@Injectable()\n ┊7┊8┊export class ChatsService {\n```\n```diff\n@@ -10,7 +11,7 @@\n ┊10┊11┊  constructor(private apollo: Apollo) {}\n ┊11┊12┊\n ┊12┊13┊  getChats() {\n-┊13┊  ┊    const query = this.apollo.watchQuery<any>({\n+┊  ┊14┊    const query = this.apollo.watchQuery<GetChats.Query>({\n ┊14┊15┊      query: getChatsQuery,\n ┊15┊16┊      variables: {\n ┊16┊17┊        amount: this.messagesAmount,\n```\n\n[}]: #\n\nAs you can probably tell by now, methods like `watchQuery` and `mutate` (and others) accepts two generic types, first one describes the result and the second one the variables.\n\n```typescript\nexport class ChatService {\n  constructor(private apollo: Apollo) {}\n\n  getChat(chatId: string, amount: number): GetChat.Chat {\n    return this.apollo\n      .watchQuery<GetChat.Query, GetChat.Variables>({\n        query: getChatQuery,\n        variables: {\n          chatId,\n          amount,\n        },\n      })\n      .pipe(map(result => result.data.chat));\n  }\n}\n```\n\nFew things here.\n\n- An object of `GetChat.Query` shape lives under the `result.data` because `watchQuery` returns an object of type `ApolloQueryResult<T>` where `T` is our `GetChat.Query`.\n\n```typescript\nexport type ApolloQueryResult<T> = {\n  data: T;\n  // ... other fields\n};\n```\n\nYou get the same result with Mutation or Subscription.\n\n- Thanks to the second argument and `GetChat.Variables` we as well as TypeScript (and an IDE) know that `chatId` is a string and `amount` accepts only a number. Whenever we try to pass a value of different kind an Error will pop out.\n\n### Take full advantage of Codegen and generate ready to use Services!\n\nI've got a fantasctic news, you don't have to manually provide those generated types to each type Apollo service is used. Because GraphQL Documents are statically analyzable, we prepared a codegen template specific for Apollo Angular users.\n\nFirst, let's install `graphql-codegen-apollo-angular` with the Apollo Angular templatea and update the template param of `generator` script\n\n    yarn add graphql-code-generator graphql-codegen-typescript-template\n\n[{]: <helper> (diffStep \"2.4\" file=\"package.json\" module=\"client\")\n\n#### [Step 2.4: Use auto-generated GQL services](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/c0eddd1)\n\n##### Changed package.json\n```diff\n@@ -8,7 +8,7 @@\n ┊ 8┊ 8┊    \"test\": \"ng test\",\n ┊ 9┊ 9┊    \"lint\": \"ng lint\",\n ┊10┊10┊    \"e2e\": \"ng e2e\",\n-┊11┊  ┊    \"generator\": \"gql-gen --schema http://localhost:3000/graphql --template graphql-codegen-typescript-template --out ./src/graphql.ts ./src/graphql/**/*.ts\"\n+┊  ┊11┊    \"generator\": \"gql-gen --schema http://localhost:3000/graphql --template graphql-codegen-apollo-angular-template --out ./src/graphql.ts ./src/graphql/**/*.ts\"\n ┊12┊12┊  },\n ┊13┊13┊  \"private\": true,\n ┊14┊14┊  \"dependencies\": {\n```\n```diff\n@@ -48,6 +48,7 @@\n ┊48┊48┊    \"codelyzer\": \"4.2.1\",\n ┊49┊49┊    \"graphql-code-generator\": \"0.12.6\",\n ┊50┊50┊    \"graphql-codegen-typescript-template\": \"0.12.6\",\n+┊  ┊51┊    \"graphql-codegen-apollo-angular-template\": \"0.12.6\",\n ┊51┊52┊    \"jasmine-core\": \"2.99.1\",\n ┊52┊53┊    \"jasmine-spec-reporter\": \"4.2.1\",\n ┊53┊54┊    \"karma\": \"1.7.1\",\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,21 +1,18 @@\n ┊ 1┊ 1┊import {map} from 'rxjs/operators';\n-┊ 2┊  ┊import {Apollo} from 'apollo-angular';\n ┊ 3┊ 2┊import {Injectable} from '@angular/core';\n-┊ 4┊  ┊import {getChatsQuery} from '../../graphql/getChats.query';\n-┊ 5┊  ┊import {GetChats} from '../../graphql';\n+┊  ┊ 3┊import {GetChatsGQL} from '../../graphql';\n ┊ 6┊ 4┊\n ┊ 7┊ 5┊@Injectable()\n ┊ 8┊ 6┊export class ChatsService {\n ┊ 9┊ 7┊  messagesAmount = 3;\n ┊10┊ 8┊\n-┊11┊  ┊  constructor(private apollo: Apollo) {}\n+┊  ┊ 9┊  constructor(\n+┊  ┊10┊    private getChatsGQL: GetChatsGQL\n+┊  ┊11┊  ) {}\n ┊12┊12┊\n ┊13┊13┊  getChats() {\n-┊14┊  ┊    const query = this.apollo.watchQuery<GetChats.Query>({\n-┊15┊  ┊      query: getChatsQuery,\n-┊16┊  ┊      variables: {\n-┊17┊  ┊        amount: this.messagesAmount,\n-┊18┊  ┊      },\n+┊  ┊14┊    const query = this.getChatsGQL.watch({\n+┊  ┊15┊      amount: this.messagesAmount,\n ┊19┊16┊    });\n ┊20┊17┊    const chats$ = query.valueChanges.pipe(\n ┊21┊18┊      map((result) => result.data.chats)\n```\n\n##### Changed src&#x2F;graphql.ts\n```diff\n@@ -28,6 +28,8 @@\n ┊28┊28┊  ): R | Result | Promise<R | Result>;\n ┊29┊29┊};\n ┊30┊30┊\n+┊  ┊31┊export type Date = any;\n+┊  ┊32┊\n ┊31┊33┊export interface Query {\n ┊32┊34┊  users?: User[] | null;\n ┊33┊35┊  chats?: Chat[] | null;\n```\n```diff\n@@ -42,17 +44,18 @@\n ┊42┊44┊}\n ┊43┊45┊\n ┊44┊46┊export interface Chat {\n-┊45┊  ┊  id: string /** May be a chat or a group */;\n-┊46┊  ┊  name?: string | null /** Computed for chats */;\n-┊47┊  ┊  picture?: string | null /** Computed for chats */;\n-┊48┊  ┊  allTimeMembers: User[] /** All members, current and past ones. */;\n-┊49┊  ┊  listingMembers: User[] /** Whoever gets the chat listed. For groups includes past members who still didn't delete the group. */;\n-┊50┊  ┊  actualGroupMembers: User[] /** Actual members of the group (they are not the only ones who get the group listed). Null for chats. */;\n-┊51┊  ┊  admins?: User[] | null /** Null for chats */;\n-┊52┊  ┊  owner?: User | null /** If null the group is read-only. Null for chats. */;\n+┊  ┊47┊  id: string;\n+┊  ┊48┊  name?: string | null;\n+┊  ┊49┊  picture?: string | null;\n+┊  ┊50┊  allTimeMembers: User[];\n+┊  ┊51┊  listingMembers: User[];\n+┊  ┊52┊  actualGroupMembers: User[];\n+┊  ┊53┊  admins?: User[] | null;\n+┊  ┊54┊  owner?: User | null;\n ┊53┊55┊  messages: (Message | null)[];\n-┊54┊  ┊  unreadMessages: number /** Computed property */;\n-┊55┊  ┊  isGroup: boolean /** Computed property */;\n+┊  ┊56┊  messageFeed?: MessageFeed | null;\n+┊  ┊57┊  unreadMessages: number;\n+┊  ┊58┊  isGroup: boolean;\n ┊56┊59┊}\n ┊57┊60┊\n ┊58┊61┊export interface Message {\n```\n```diff\n@@ -60,25 +63,107 @@\n ┊ 60┊ 63┊  sender: User;\n ┊ 61┊ 64┊  chat: Chat;\n ┊ 62┊ 65┊  content: string;\n-┊ 63┊   ┊  createdAt: string;\n-┊ 64┊   ┊  type: number /** FIXME: should return MessageType */;\n-┊ 65┊   ┊  recipients: Recipient[] /** Whoever received the message */;\n-┊ 66┊   ┊  holders: User[] /** Whoever still holds a copy of the message. Cannot be null because the message gets deleted otherwise */;\n-┊ 67┊   ┊  ownership: boolean /** Computed property */;\n+┊   ┊ 66┊  createdAt: Date;\n+┊   ┊ 67┊  type: number;\n+┊   ┊ 68┊  recipients: Recipient[];\n+┊   ┊ 69┊  holders: User[];\n+┊   ┊ 70┊  ownership: boolean;\n ┊ 68┊ 71┊}\n ┊ 69┊ 72┊\n ┊ 70┊ 73┊export interface Recipient {\n ┊ 71┊ 74┊  user: User;\n ┊ 72┊ 75┊  message: Message;\n ┊ 73┊ 76┊  chat: Chat;\n-┊ 74┊   ┊  receivedAt?: string | null;\n-┊ 75┊   ┊  readAt?: string | null;\n+┊   ┊ 77┊  receivedAt?: Date | null;\n+┊   ┊ 78┊  readAt?: Date | null;\n+┊   ┊ 79┊}\n+┊   ┊ 80┊\n+┊   ┊ 81┊export interface MessageFeed {\n+┊   ┊ 82┊  hasNextPage: boolean;\n+┊   ┊ 83┊  cursor?: string | null;\n+┊   ┊ 84┊  messages: (Message | null)[];\n+┊   ┊ 85┊}\n+┊   ┊ 86┊\n+┊   ┊ 87┊export interface Mutation {\n+┊   ┊ 88┊  addChat?: Chat | null;\n+┊   ┊ 89┊  addGroup?: Chat | null;\n+┊   ┊ 90┊  removeChat?: string | null;\n+┊   ┊ 91┊  addMessage?: Message | null;\n+┊   ┊ 92┊  removeMessages?: (string | null)[] | null;\n+┊   ┊ 93┊  addMembers?: (string | null)[] | null;\n+┊   ┊ 94┊  removeMembers?: (string | null)[] | null;\n+┊   ┊ 95┊  addAdmins?: (string | null)[] | null;\n+┊   ┊ 96┊  removeAdmins?: (string | null)[] | null;\n+┊   ┊ 97┊  setGroupName?: string | null;\n+┊   ┊ 98┊  setGroupPicture?: string | null;\n+┊   ┊ 99┊  markAsReceived?: boolean | null;\n+┊   ┊100┊  markAsRead?: boolean | null;\n+┊   ┊101┊}\n+┊   ┊102┊\n+┊   ┊103┊export interface Subscription {\n+┊   ┊104┊  messageAdded?: Message | null;\n+┊   ┊105┊  chatAdded?: Chat | null;\n ┊ 76┊106┊}\n ┊ 77┊107┊export interface ChatQueryArgs {\n ┊ 78┊108┊  chatId: string;\n ┊ 79┊109┊}\n ┊ 80┊110┊export interface MessagesChatArgs {\n ┊ 81┊111┊  amount?: number | null;\n+┊   ┊112┊  before?: string | null;\n+┊   ┊113┊}\n+┊   ┊114┊export interface MessageFeedChatArgs {\n+┊   ┊115┊  amount?: number | null;\n+┊   ┊116┊  before?: string | null;\n+┊   ┊117┊}\n+┊   ┊118┊export interface AddChatMutationArgs {\n+┊   ┊119┊  recipientId: string;\n+┊   ┊120┊}\n+┊   ┊121┊export interface AddGroupMutationArgs {\n+┊   ┊122┊  recipientIds: string[];\n+┊   ┊123┊  groupName: string;\n+┊   ┊124┊}\n+┊   ┊125┊export interface RemoveChatMutationArgs {\n+┊   ┊126┊  chatId: string;\n+┊   ┊127┊}\n+┊   ┊128┊export interface AddMessageMutationArgs {\n+┊   ┊129┊  chatId: string;\n+┊   ┊130┊  content: string;\n+┊   ┊131┊}\n+┊   ┊132┊export interface RemoveMessagesMutationArgs {\n+┊   ┊133┊  chatId: string;\n+┊   ┊134┊  messageIds?: (string | null)[] | null;\n+┊   ┊135┊  all?: boolean | null;\n+┊   ┊136┊}\n+┊   ┊137┊export interface AddMembersMutationArgs {\n+┊   ┊138┊  groupId: string;\n+┊   ┊139┊  userIds: string[];\n+┊   ┊140┊}\n+┊   ┊141┊export interface RemoveMembersMutationArgs {\n+┊   ┊142┊  groupId: string;\n+┊   ┊143┊  userIds: string[];\n+┊   ┊144┊}\n+┊   ┊145┊export interface AddAdminsMutationArgs {\n+┊   ┊146┊  groupId: string;\n+┊   ┊147┊  userIds: string[];\n+┊   ┊148┊}\n+┊   ┊149┊export interface RemoveAdminsMutationArgs {\n+┊   ┊150┊  groupId: string;\n+┊   ┊151┊  userIds: string[];\n+┊   ┊152┊}\n+┊   ┊153┊export interface SetGroupNameMutationArgs {\n+┊   ┊154┊  groupId: string;\n+┊   ┊155┊}\n+┊   ┊156┊export interface SetGroupPictureMutationArgs {\n+┊   ┊157┊  groupId: string;\n+┊   ┊158┊}\n+┊   ┊159┊export interface MarkAsReceivedMutationArgs {\n+┊   ┊160┊  chatId: string;\n+┊   ┊161┊}\n+┊   ┊162┊export interface MarkAsReadMutationArgs {\n+┊   ┊163┊  chatId: string;\n+┊   ┊164┊}\n+┊   ┊165┊export interface MessageAddedSubscriptionArgs {\n+┊   ┊166┊  chatId?: string | null;\n ┊ 82┊167┊}\n ┊ 83┊168┊\n ┊ 84┊169┊export enum MessageType {\n```\n```diff\n@@ -146,41 +231,18 @@\n ┊146┊231┊\n ┊147┊232┊export namespace ChatResolvers {\n ┊148┊233┊  export interface Resolvers<Context = any> {\n-┊149┊   ┊    id?: IdResolver<string, any, Context> /** May be a chat or a group */;\n-┊150┊   ┊    name?: NameResolver<string | null, any, Context> /** Computed for chats */;\n-┊151┊   ┊    picture?: PictureResolver<\n-┊152┊   ┊      string | null,\n-┊153┊   ┊      any,\n-┊154┊   ┊      Context\n-┊155┊   ┊    > /** Computed for chats */;\n-┊156┊   ┊    allTimeMembers?: AllTimeMembersResolver<\n-┊157┊   ┊      User[],\n-┊158┊   ┊      any,\n-┊159┊   ┊      Context\n-┊160┊   ┊    > /** All members, current and past ones. */;\n-┊161┊   ┊    listingMembers?: ListingMembersResolver<\n-┊162┊   ┊      User[],\n-┊163┊   ┊      any,\n-┊164┊   ┊      Context\n-┊165┊   ┊    > /** Whoever gets the chat listed. For groups includes past members who still didn't delete the group. */;\n-┊166┊   ┊    actualGroupMembers?: ActualGroupMembersResolver<\n-┊167┊   ┊      User[],\n-┊168┊   ┊      any,\n-┊169┊   ┊      Context\n-┊170┊   ┊    > /** Actual members of the group (they are not the only ones who get the group listed). Null for chats. */;\n-┊171┊   ┊    admins?: AdminsResolver<User[] | null, any, Context> /** Null for chats */;\n-┊172┊   ┊    owner?: OwnerResolver<\n-┊173┊   ┊      User | null,\n-┊174┊   ┊      any,\n-┊175┊   ┊      Context\n-┊176┊   ┊    > /** If null the group is read-only. Null for chats. */;\n+┊   ┊234┊    id?: IdResolver<string, any, Context>;\n+┊   ┊235┊    name?: NameResolver<string | null, any, Context>;\n+┊   ┊236┊    picture?: PictureResolver<string | null, any, Context>;\n+┊   ┊237┊    allTimeMembers?: AllTimeMembersResolver<User[], any, Context>;\n+┊   ┊238┊    listingMembers?: ListingMembersResolver<User[], any, Context>;\n+┊   ┊239┊    actualGroupMembers?: ActualGroupMembersResolver<User[], any, Context>;\n+┊   ┊240┊    admins?: AdminsResolver<User[] | null, any, Context>;\n+┊   ┊241┊    owner?: OwnerResolver<User | null, any, Context>;\n ┊177┊242┊    messages?: MessagesResolver<(Message | null)[], any, Context>;\n-┊178┊   ┊    unreadMessages?: UnreadMessagesResolver<\n-┊179┊   ┊      number,\n-┊180┊   ┊      any,\n-┊181┊   ┊      Context\n-┊182┊   ┊    > /** Computed property */;\n-┊183┊   ┊    isGroup?: IsGroupResolver<boolean, any, Context> /** Computed property */;\n+┊   ┊243┊    messageFeed?: MessageFeedResolver<MessageFeed | null, any, Context>;\n+┊   ┊244┊    unreadMessages?: UnreadMessagesResolver<number, any, Context>;\n+┊   ┊245┊    isGroup?: IsGroupResolver<boolean, any, Context>;\n ┊184┊246┊  }\n ┊185┊247┊\n ┊186┊248┊  export type IdResolver<R = string, Parent = any, Context = any> = Resolver<\n```\n```diff\n@@ -230,6 +292,17 @@\n ┊230┊292┊  > = Resolver<R, Parent, Context, MessagesArgs>;\n ┊231┊293┊  export interface MessagesArgs {\n ┊232┊294┊    amount?: number | null;\n+┊   ┊295┊    before?: string | null;\n+┊   ┊296┊  }\n+┊   ┊297┊\n+┊   ┊298┊  export type MessageFeedResolver<\n+┊   ┊299┊    R = MessageFeed | null,\n+┊   ┊300┊    Parent = any,\n+┊   ┊301┊    Context = any\n+┊   ┊302┊  > = Resolver<R, Parent, Context, MessageFeedArgs>;\n+┊   ┊303┊  export interface MessageFeedArgs {\n+┊   ┊304┊    amount?: number | null;\n+┊   ┊305┊    before?: string | null;\n ┊233┊306┊  }\n ┊234┊307┊\n ┊235┊308┊  export type UnreadMessagesResolver<\n```\n```diff\n@@ -250,27 +323,11 @@\n ┊250┊323┊    sender?: SenderResolver<User, any, Context>;\n ┊251┊324┊    chat?: ChatResolver<Chat, any, Context>;\n ┊252┊325┊    content?: ContentResolver<string, any, Context>;\n-┊253┊   ┊    createdAt?: CreatedAtResolver<string, any, Context>;\n-┊254┊   ┊    type?: TypeResolver<\n-┊255┊   ┊      number,\n-┊256┊   ┊      any,\n-┊257┊   ┊      Context\n-┊258┊   ┊    > /** FIXME: should return MessageType */;\n-┊259┊   ┊    recipients?: RecipientsResolver<\n-┊260┊   ┊      Recipient[],\n-┊261┊   ┊      any,\n-┊262┊   ┊      Context\n-┊263┊   ┊    > /** Whoever received the message */;\n-┊264┊   ┊    holders?: HoldersResolver<\n-┊265┊   ┊      User[],\n-┊266┊   ┊      any,\n-┊267┊   ┊      Context\n-┊268┊   ┊    > /** Whoever still holds a copy of the message. Cannot be null because the message gets deleted otherwise */;\n-┊269┊   ┊    ownership?: OwnershipResolver<\n-┊270┊   ┊      boolean,\n-┊271┊   ┊      any,\n-┊272┊   ┊      Context\n-┊273┊   ┊    > /** Computed property */;\n+┊   ┊326┊    createdAt?: CreatedAtResolver<Date, any, Context>;\n+┊   ┊327┊    type?: TypeResolver<number, any, Context>;\n+┊   ┊328┊    recipients?: RecipientsResolver<Recipient[], any, Context>;\n+┊   ┊329┊    holders?: HoldersResolver<User[], any, Context>;\n+┊   ┊330┊    ownership?: OwnershipResolver<boolean, any, Context>;\n ┊274┊331┊  }\n ┊275┊332┊\n ┊276┊333┊  export type IdResolver<R = string, Parent = any, Context = any> = Resolver<\n```\n```diff\n@@ -294,7 +351,7 @@\n ┊294┊351┊    Context = any\n ┊295┊352┊  > = Resolver<R, Parent, Context>;\n ┊296┊353┊  export type CreatedAtResolver<\n-┊297┊   ┊    R = string,\n+┊   ┊354┊    R = Date,\n ┊298┊355┊    Parent = any,\n ┊299┊356┊    Context = any\n ┊300┊357┊  > = Resolver<R, Parent, Context>;\n```\n```diff\n@@ -325,8 +382,8 @@\n ┊325┊382┊    user?: UserResolver<User, any, Context>;\n ┊326┊383┊    message?: MessageResolver<Message, any, Context>;\n ┊327┊384┊    chat?: ChatResolver<Chat, any, Context>;\n-┊328┊   ┊    receivedAt?: ReceivedAtResolver<string | null, any, Context>;\n-┊329┊   ┊    readAt?: ReadAtResolver<string | null, any, Context>;\n+┊   ┊385┊    receivedAt?: ReceivedAtResolver<Date | null, any, Context>;\n+┊   ┊386┊    readAt?: ReadAtResolver<Date | null, any, Context>;\n ┊330┊387┊  }\n ┊331┊388┊\n ┊332┊389┊  export type UserResolver<R = User, Parent = any, Context = any> = Resolver<\n```\n```diff\n@@ -345,14 +402,211 @@\n ┊345┊402┊    Context\n ┊346┊403┊  >;\n ┊347┊404┊  export type ReceivedAtResolver<\n-┊348┊   ┊    R = string | null,\n+┊   ┊405┊    R = Date | null,\n ┊349┊406┊    Parent = any,\n ┊350┊407┊    Context = any\n ┊351┊408┊  > = Resolver<R, Parent, Context>;\n ┊352┊409┊  export type ReadAtResolver<\n+┊   ┊410┊    R = Date | null,\n+┊   ┊411┊    Parent = any,\n+┊   ┊412┊    Context = any\n+┊   ┊413┊  > = Resolver<R, Parent, Context>;\n+┊   ┊414┊}\n+┊   ┊415┊\n+┊   ┊416┊export namespace MessageFeedResolvers {\n+┊   ┊417┊  export interface Resolvers<Context = any> {\n+┊   ┊418┊    hasNextPage?: HasNextPageResolver<boolean, any, Context>;\n+┊   ┊419┊    cursor?: CursorResolver<string | null, any, Context>;\n+┊   ┊420┊    messages?: MessagesResolver<(Message | null)[], any, Context>;\n+┊   ┊421┊  }\n+┊   ┊422┊\n+┊   ┊423┊  export type HasNextPageResolver<\n+┊   ┊424┊    R = boolean,\n+┊   ┊425┊    Parent = any,\n+┊   ┊426┊    Context = any\n+┊   ┊427┊  > = Resolver<R, Parent, Context>;\n+┊   ┊428┊  export type CursorResolver<\n+┊   ┊429┊    R = string | null,\n+┊   ┊430┊    Parent = any,\n+┊   ┊431┊    Context = any\n+┊   ┊432┊  > = Resolver<R, Parent, Context>;\n+┊   ┊433┊  export type MessagesResolver<\n+┊   ┊434┊    R = (Message | null)[],\n+┊   ┊435┊    Parent = any,\n+┊   ┊436┊    Context = any\n+┊   ┊437┊  > = Resolver<R, Parent, Context>;\n+┊   ┊438┊}\n+┊   ┊439┊\n+┊   ┊440┊export namespace MutationResolvers {\n+┊   ┊441┊  export interface Resolvers<Context = any> {\n+┊   ┊442┊    addChat?: AddChatResolver<Chat | null, any, Context>;\n+┊   ┊443┊    addGroup?: AddGroupResolver<Chat | null, any, Context>;\n+┊   ┊444┊    removeChat?: RemoveChatResolver<string | null, any, Context>;\n+┊   ┊445┊    addMessage?: AddMessageResolver<Message | null, any, Context>;\n+┊   ┊446┊    removeMessages?: RemoveMessagesResolver<\n+┊   ┊447┊      (string | null)[] | null,\n+┊   ┊448┊      any,\n+┊   ┊449┊      Context\n+┊   ┊450┊    >;\n+┊   ┊451┊    addMembers?: AddMembersResolver<(string | null)[] | null, any, Context>;\n+┊   ┊452┊    removeMembers?: RemoveMembersResolver<\n+┊   ┊453┊      (string | null)[] | null,\n+┊   ┊454┊      any,\n+┊   ┊455┊      Context\n+┊   ┊456┊    >;\n+┊   ┊457┊    addAdmins?: AddAdminsResolver<(string | null)[] | null, any, Context>;\n+┊   ┊458┊    removeAdmins?: RemoveAdminsResolver<(string | null)[] | null, any, Context>;\n+┊   ┊459┊    setGroupName?: SetGroupNameResolver<string | null, any, Context>;\n+┊   ┊460┊    setGroupPicture?: SetGroupPictureResolver<string | null, any, Context>;\n+┊   ┊461┊    markAsReceived?: MarkAsReceivedResolver<boolean | null, any, Context>;\n+┊   ┊462┊    markAsRead?: MarkAsReadResolver<boolean | null, any, Context>;\n+┊   ┊463┊  }\n+┊   ┊464┊\n+┊   ┊465┊  export type AddChatResolver<\n+┊   ┊466┊    R = Chat | null,\n+┊   ┊467┊    Parent = any,\n+┊   ┊468┊    Context = any\n+┊   ┊469┊  > = Resolver<R, Parent, Context, AddChatArgs>;\n+┊   ┊470┊  export interface AddChatArgs {\n+┊   ┊471┊    recipientId: string;\n+┊   ┊472┊  }\n+┊   ┊473┊\n+┊   ┊474┊  export type AddGroupResolver<\n+┊   ┊475┊    R = Chat | null,\n+┊   ┊476┊    Parent = any,\n+┊   ┊477┊    Context = any\n+┊   ┊478┊  > = Resolver<R, Parent, Context, AddGroupArgs>;\n+┊   ┊479┊  export interface AddGroupArgs {\n+┊   ┊480┊    recipientIds: string[];\n+┊   ┊481┊    groupName: string;\n+┊   ┊482┊  }\n+┊   ┊483┊\n+┊   ┊484┊  export type RemoveChatResolver<\n+┊   ┊485┊    R = string | null,\n+┊   ┊486┊    Parent = any,\n+┊   ┊487┊    Context = any\n+┊   ┊488┊  > = Resolver<R, Parent, Context, RemoveChatArgs>;\n+┊   ┊489┊  export interface RemoveChatArgs {\n+┊   ┊490┊    chatId: string;\n+┊   ┊491┊  }\n+┊   ┊492┊\n+┊   ┊493┊  export type AddMessageResolver<\n+┊   ┊494┊    R = Message | null,\n+┊   ┊495┊    Parent = any,\n+┊   ┊496┊    Context = any\n+┊   ┊497┊  > = Resolver<R, Parent, Context, AddMessageArgs>;\n+┊   ┊498┊  export interface AddMessageArgs {\n+┊   ┊499┊    chatId: string;\n+┊   ┊500┊    content: string;\n+┊   ┊501┊  }\n+┊   ┊502┊\n+┊   ┊503┊  export type RemoveMessagesResolver<\n+┊   ┊504┊    R = (string | null)[] | null,\n+┊   ┊505┊    Parent = any,\n+┊   ┊506┊    Context = any\n+┊   ┊507┊  > = Resolver<R, Parent, Context, RemoveMessagesArgs>;\n+┊   ┊508┊  export interface RemoveMessagesArgs {\n+┊   ┊509┊    chatId: string;\n+┊   ┊510┊    messageIds?: (string | null)[] | null;\n+┊   ┊511┊    all?: boolean | null;\n+┊   ┊512┊  }\n+┊   ┊513┊\n+┊   ┊514┊  export type AddMembersResolver<\n+┊   ┊515┊    R = (string | null)[] | null,\n+┊   ┊516┊    Parent = any,\n+┊   ┊517┊    Context = any\n+┊   ┊518┊  > = Resolver<R, Parent, Context, AddMembersArgs>;\n+┊   ┊519┊  export interface AddMembersArgs {\n+┊   ┊520┊    groupId: string;\n+┊   ┊521┊    userIds: string[];\n+┊   ┊522┊  }\n+┊   ┊523┊\n+┊   ┊524┊  export type RemoveMembersResolver<\n+┊   ┊525┊    R = (string | null)[] | null,\n+┊   ┊526┊    Parent = any,\n+┊   ┊527┊    Context = any\n+┊   ┊528┊  > = Resolver<R, Parent, Context, RemoveMembersArgs>;\n+┊   ┊529┊  export interface RemoveMembersArgs {\n+┊   ┊530┊    groupId: string;\n+┊   ┊531┊    userIds: string[];\n+┊   ┊532┊  }\n+┊   ┊533┊\n+┊   ┊534┊  export type AddAdminsResolver<\n+┊   ┊535┊    R = (string | null)[] | null,\n+┊   ┊536┊    Parent = any,\n+┊   ┊537┊    Context = any\n+┊   ┊538┊  > = Resolver<R, Parent, Context, AddAdminsArgs>;\n+┊   ┊539┊  export interface AddAdminsArgs {\n+┊   ┊540┊    groupId: string;\n+┊   ┊541┊    userIds: string[];\n+┊   ┊542┊  }\n+┊   ┊543┊\n+┊   ┊544┊  export type RemoveAdminsResolver<\n+┊   ┊545┊    R = (string | null)[] | null,\n+┊   ┊546┊    Parent = any,\n+┊   ┊547┊    Context = any\n+┊   ┊548┊  > = Resolver<R, Parent, Context, RemoveAdminsArgs>;\n+┊   ┊549┊  export interface RemoveAdminsArgs {\n+┊   ┊550┊    groupId: string;\n+┊   ┊551┊    userIds: string[];\n+┊   ┊552┊  }\n+┊   ┊553┊\n+┊   ┊554┊  export type SetGroupNameResolver<\n+┊   ┊555┊    R = string | null,\n+┊   ┊556┊    Parent = any,\n+┊   ┊557┊    Context = any\n+┊   ┊558┊  > = Resolver<R, Parent, Context, SetGroupNameArgs>;\n+┊   ┊559┊  export interface SetGroupNameArgs {\n+┊   ┊560┊    groupId: string;\n+┊   ┊561┊  }\n+┊   ┊562┊\n+┊   ┊563┊  export type SetGroupPictureResolver<\n ┊353┊564┊    R = string | null,\n ┊354┊565┊    Parent = any,\n ┊355┊566┊    Context = any\n+┊   ┊567┊  > = Resolver<R, Parent, Context, SetGroupPictureArgs>;\n+┊   ┊568┊  export interface SetGroupPictureArgs {\n+┊   ┊569┊    groupId: string;\n+┊   ┊570┊  }\n+┊   ┊571┊\n+┊   ┊572┊  export type MarkAsReceivedResolver<\n+┊   ┊573┊    R = boolean | null,\n+┊   ┊574┊    Parent = any,\n+┊   ┊575┊    Context = any\n+┊   ┊576┊  > = Resolver<R, Parent, Context, MarkAsReceivedArgs>;\n+┊   ┊577┊  export interface MarkAsReceivedArgs {\n+┊   ┊578┊    chatId: string;\n+┊   ┊579┊  }\n+┊   ┊580┊\n+┊   ┊581┊  export type MarkAsReadResolver<\n+┊   ┊582┊    R = boolean | null,\n+┊   ┊583┊    Parent = any,\n+┊   ┊584┊    Context = any\n+┊   ┊585┊  > = Resolver<R, Parent, Context, MarkAsReadArgs>;\n+┊   ┊586┊  export interface MarkAsReadArgs {\n+┊   ┊587┊    chatId: string;\n+┊   ┊588┊  }\n+┊   ┊589┊}\n+┊   ┊590┊\n+┊   ┊591┊export namespace SubscriptionResolvers {\n+┊   ┊592┊  export interface Resolvers<Context = any> {\n+┊   ┊593┊    messageAdded?: MessageAddedResolver<Message | null, any, Context>;\n+┊   ┊594┊    chatAdded?: ChatAddedResolver<Chat | null, any, Context>;\n+┊   ┊595┊  }\n+┊   ┊596┊\n+┊   ┊597┊  export type MessageAddedResolver<\n+┊   ┊598┊    R = Message | null,\n+┊   ┊599┊    Parent = any,\n+┊   ┊600┊    Context = any\n+┊   ┊601┊  > = Resolver<R, Parent, Context, MessageAddedArgs>;\n+┊   ┊602┊  export interface MessageAddedArgs {\n+┊   ┊603┊    chatId?: string | null;\n+┊   ┊604┊  }\n+┊   ┊605┊\n+┊   ┊606┊  export type ChatAddedResolver<\n+┊   ┊607┊    R = Chat | null,\n+┊   ┊608┊    Parent = any,\n+┊   ┊609┊    Context = any\n ┊356┊610┊  > = Resolver<R, Parent, Context>;\n ┊357┊611┊}\n ┊358┊612┊\n```\n```diff\n@@ -398,7 +652,7 @@\n ┊398┊652┊    chat: Chat;\n ┊399┊653┊    sender: Sender;\n ┊400┊654┊    content: string;\n-┊401┊   ┊    createdAt: string;\n+┊   ┊655┊    createdAt: Date;\n ┊402┊656┊    type: number;\n ┊403┊657┊    recipients: Recipients[];\n ┊404┊658┊    ownership: boolean;\n```\n```diff\n@@ -420,8 +674,8 @@\n ┊420┊674┊    user: User;\n ┊421┊675┊    message: Message;\n ┊422┊676┊    chat: __Chat;\n-┊423┊   ┊    receivedAt?: string | null;\n-┊424┊   ┊    readAt?: string | null;\n+┊   ┊677┊    receivedAt?: Date | null;\n+┊   ┊678┊    readAt?: Date | null;\n ┊425┊679┊  };\n ┊426┊680┊\n ┊427┊681┊  export type User = {\n```\n```diff\n@@ -445,3 +699,77 @@\n ┊445┊699┊    id: string;\n ┊446┊700┊  };\n ┊447┊701┊}\n+┊   ┊702┊\n+┊   ┊703┊import { Injectable } from \"@angular/core\";\n+┊   ┊704┊\n+┊   ┊705┊import * as Apollo from \"apollo-angular\";\n+┊   ┊706┊\n+┊   ┊707┊import gql from \"graphql-tag\";\n+┊   ┊708┊\n+┊   ┊709┊const ChatWithoutMessagesFragment = gql`\n+┊   ┊710┊  fragment ChatWithoutMessages on Chat {\n+┊   ┊711┊    id\n+┊   ┊712┊    name\n+┊   ┊713┊    picture\n+┊   ┊714┊    allTimeMembers {\n+┊   ┊715┊      id\n+┊   ┊716┊    }\n+┊   ┊717┊    unreadMessages\n+┊   ┊718┊    isGroup\n+┊   ┊719┊  }\n+┊   ┊720┊`;\n+┊   ┊721┊\n+┊   ┊722┊const MessageFragment = gql`\n+┊   ┊723┊  fragment Message on Message {\n+┊   ┊724┊    id\n+┊   ┊725┊    chat {\n+┊   ┊726┊      id\n+┊   ┊727┊    }\n+┊   ┊728┊    sender {\n+┊   ┊729┊      id\n+┊   ┊730┊      name\n+┊   ┊731┊    }\n+┊   ┊732┊    content\n+┊   ┊733┊    createdAt\n+┊   ┊734┊    type\n+┊   ┊735┊    recipients {\n+┊   ┊736┊      user {\n+┊   ┊737┊        id\n+┊   ┊738┊      }\n+┊   ┊739┊      message {\n+┊   ┊740┊        id\n+┊   ┊741┊        chat {\n+┊   ┊742┊          id\n+┊   ┊743┊        }\n+┊   ┊744┊      }\n+┊   ┊745┊      chat {\n+┊   ┊746┊        id\n+┊   ┊747┊      }\n+┊   ┊748┊      receivedAt\n+┊   ┊749┊      readAt\n+┊   ┊750┊    }\n+┊   ┊751┊    ownership\n+┊   ┊752┊  }\n+┊   ┊753┊`;\n+┊   ┊754┊\n+┊   ┊755┊@Injectable({\n+┊   ┊756┊  providedIn: \"root\"\n+┊   ┊757┊})\n+┊   ┊758┊export class GetChatsGQL extends Apollo.Query<\n+┊   ┊759┊  GetChats.Query,\n+┊   ┊760┊  GetChats.Variables\n+┊   ┊761┊> {\n+┊   ┊762┊  document: any = gql`\n+┊   ┊763┊    query GetChats($amount: Int) {\n+┊   ┊764┊      chats {\n+┊   ┊765┊        ...ChatWithoutMessages\n+┊   ┊766┊        messages(amount: $amount) {\n+┊   ┊767┊          ...Message\n+┊   ┊768┊        }\n+┊   ┊769┊      }\n+┊   ┊770┊    }\n+┊   ┊771┊\n+┊   ┊772┊    ${ChatWithoutMessagesFragment}\n+┊   ┊773┊    ${MessageFragment}\n+┊   ┊774┊  `;\n+┊   ┊775┊}\n```\n\n[}]: #\n\nThe Apollo Angular template generates a ready to use in your component, strongly typed Angular services, for every defined query, mutation or subscription.\n\nIt's possible thanks to the new API of Apollo Angular. More on that in [\"Query, Mutation, Subscription services\"](http://apollographql.com/docs/angular/basics/services.html?_ga=2.227615197.1327014552.1538988114-793224955.1532981447) chapter of the documentation.\n\nGiven an example:\n\n```graphql\nquery GetChats($amount: Int) {\n  chats {\n    ...ChatWithoutMessages\n    messages(amount: $amount) {\n      ...Message\n    }\n  }\n}\n```\n\nThe Apollo Angular template, after you run `yarn generate`, outputs a service called `GetChatsGQL`:\n\n```typescript\nimport { GetChatsGQL, GetChats } from '../graphql';\n\nexport class AppComponent {\n  constructor(private getChatsGQL: GetChatsGQL) {}\n\n  getChats(): GetChats.Chats[] {\n    return this.getChatsGQL\n      .watch({\n        amount: 10,\n      })\n      .valueChanges.pipe(map(result => result.data.chats));\n  }\n}\n```\n\n> Remember, every operation should has an unique name.\n\nIt might look a bit different then what you have already learnt but we promise, the API is even easier.\n\nBut first, let's dive into how those services look like under the hood.\n\n```typescript\nimport { Query } from 'apollo-angular';\n\n@Injectable({\n  providedIn: 'root',\n})\nexport class GetChatsGQL extends Query<GetChats.Query, GetChats.Variables> {\n  document = gql`\n    here goes the document\n  `;\n}\n```\n\nOkay, seems easy but what is the `Query` class, you might ask!\n\nApollo Angular exposes three classes for three kinds of the GraphQL operation: `Query`, `Mutation` and `Subscription`. Each of them has a different API.\n\n- `Query` has `fetch` and `watch`. First one behave like `Apollo.query()`, second one like `Apollo.watchQuery()`\n- `Mutation` has `mutate`\n- `Subscription` has `subscribe`\n\nBecause the `document` is already defined in a class, they all accept two arguments (Subscription has third one). First argument defines variables, second shapes the options. Thats why we used `this.getChatsGQL.watch({ amount: 10 })`.\n\nLet's stop talking about the API itself and see what benefits it brings us:\n\n- **Less code to write** - no need to create a network call, no need to create Typescript typings, no need to create a dedicated Angular service\n- **Strongly typed out of the box — all** types are being generated, no need to write any Typescript definitions and struggle to keep them updated\n- _More pleasent API_ to work with\n- **Full developer experience of tools and IDEs**  —  development time, autocomplete and error checking, not only across your frontend app but also with your API teams!\n- **Tree-shakable** thanks to Angular 6\n\nMost IDEs with the GraphQL support (built-in or thanks to extensions) fully handles `.graphql` files and helps you with features like auto-completion, validation but they strugle with `gql` tag. To fully enjoy GraphQL we highly recommend to use static `.graphql` files.\n\nWith all that knowledge, let's use GQL services in our application:\n\n[{]: <helper> (diffStep \"2.4\" files=\"src/app/services/chats.service.ts\" module=\"client\")\n\n#### [Step 2.4: Use auto-generated GQL services](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/c0eddd1)\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,21 +1,18 @@\n ┊ 1┊ 1┊import {map} from 'rxjs/operators';\n-┊ 2┊  ┊import {Apollo} from 'apollo-angular';\n ┊ 3┊ 2┊import {Injectable} from '@angular/core';\n-┊ 4┊  ┊import {getChatsQuery} from '../../graphql/getChats.query';\n-┊ 5┊  ┊import {GetChats} from '../../graphql';\n+┊  ┊ 3┊import {GetChatsGQL} from '../../graphql';\n ┊ 6┊ 4┊\n ┊ 7┊ 5┊@Injectable()\n ┊ 8┊ 6┊export class ChatsService {\n ┊ 9┊ 7┊  messagesAmount = 3;\n ┊10┊ 8┊\n-┊11┊  ┊  constructor(private apollo: Apollo) {}\n+┊  ┊ 9┊  constructor(\n+┊  ┊10┊    private getChatsGQL: GetChatsGQL\n+┊  ┊11┊  ) {}\n ┊12┊12┊\n ┊13┊13┊  getChats() {\n-┊14┊  ┊    const query = this.apollo.watchQuery<GetChats.Query>({\n-┊15┊  ┊      query: getChatsQuery,\n-┊16┊  ┊      variables: {\n-┊17┊  ┊        amount: this.messagesAmount,\n-┊18┊  ┊      },\n+┊  ┊14┊    const query = this.getChatsGQL.watch({\n+┊  ┊15┊      amount: this.messagesAmount,\n ┊19┊16┊    });\n ┊20┊17┊    const chats$ = query.valueChanges.pipe(\n ┊21┊18┊      map((result) => result.data.chats)\n```\n\n[}]: #"
          },
          {
            "manualTitle": "Step 7: Testing",
            "stepRevision": "1faa6c13bf9f48f94f7b027bea9c8277612be7ec",
            "manualView": "## Client\n\nTesting is a very important part of each application and for the sake of showing different testing techniques we are going to show how to test a presentational component, a container component and a service.\n\nFirst let's start by importing `hammerjs` for the Material Gestures inside the test script.\n\n[{]: <helper> (diffStep \"3.1\" files=\"src/test.ts\" module=\"client\")\n\n#### [Step 3.1: Testing](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/b76d15b)\n\n##### Changed src&#x2F;test.ts\n```diff\n@@ -7,6 +7,9 @@\n ┊ 7┊ 7┊  platformBrowserDynamicTesting\n ┊ 8┊ 8┊} from '@angular/platform-browser-dynamic/testing';\n ┊ 9┊ 9┊\n+┊  ┊10┊// Material gestures\n+┊  ┊11┊import 'hammerjs';\n+┊  ┊12┊\n ┊10┊13┊declare const require: any;\n ┊11┊14┊\n ┊12┊15┊// First, initialize the Angular testing environment.\n```\n\n[}]: #\n\n### Testing a Presentional Component\n\nLet's start with the simplest one: the presentational component.\nWe are not going to inject any service and we don't need to access our backend, so things are quite simple: we just need to pass our Chat object as an Input, detect the changes and use the query selector to match the UI content to the one we passed as input:\n\n[{]: <helper> (diffStep \"3.1\" files=\"src/app/chats-lister/components/chat-item/chat-item.component.spec.ts\" module=\"client\")\n\n#### [Step 3.1: Testing](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/b76d15b)\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chat-item&#x2F;chat-item.component.spec.ts\n```diff\n@@ -0,0 +1,107 @@\n+┊   ┊  1┊import { async, ComponentFixture, TestBed } from '@angular/core/testing';\n+┊   ┊  2┊\n+┊   ┊  3┊import { ChatItemComponent } from './chat-item.component';\n+┊   ┊  4┊import {DebugElement} from '@angular/core';\n+┊   ┊  5┊import {By} from '@angular/platform-browser';\n+┊   ┊  6┊import {TruncateModule} from 'ng2-truncate';\n+┊   ┊  7┊\n+┊   ┊  8┊describe('ChatItemComponent', () => {\n+┊   ┊  9┊  let component: ChatItemComponent;\n+┊   ┊ 10┊  let fixture: ComponentFixture<ChatItemComponent>;\n+┊   ┊ 11┊  let el: DebugElement;\n+┊   ┊ 12┊\n+┊   ┊ 13┊  const chat: any = {\n+┊   ┊ 14┊    id: '1',\n+┊   ┊ 15┊    __typename: 'Chat',\n+┊   ┊ 16┊    name: 'Niccolo\\' Belli',\n+┊   ┊ 17┊    picture: null,\n+┊   ┊ 18┊    allTimeMembers: [\n+┊   ┊ 19┊      {\n+┊   ┊ 20┊        id: '1',\n+┊   ┊ 21┊        __typename: 'User',\n+┊   ┊ 22┊      },\n+┊   ┊ 23┊      {\n+┊   ┊ 24┊        id: '2',\n+┊   ┊ 25┊        __typename: 'User',\n+┊   ┊ 26┊      }\n+┊   ┊ 27┊    ],\n+┊   ┊ 28┊    unreadMessages: 0,\n+┊   ┊ 29┊    isGroup: false,\n+┊   ┊ 30┊    messages: [\n+┊   ┊ 31┊      {\n+┊   ┊ 32┊        id: '1',\n+┊   ┊ 33┊        chat: {\n+┊   ┊ 34┊          id: '1',\n+┊   ┊ 35┊          __typename: 'Chat',\n+┊   ┊ 36┊        },\n+┊   ┊ 37┊        __typename: 'Message',\n+┊   ┊ 38┊        sender: {\n+┊   ┊ 39┊          id: '1',\n+┊   ┊ 40┊          __typename: 'User',\n+┊   ┊ 41┊          name: 'Niccolo\\' Belli',\n+┊   ┊ 42┊        },\n+┊   ┊ 43┊        content: 'Hello! How are you? A lot happened since last time',\n+┊   ┊ 44┊        createdAt: '1513435525',\n+┊   ┊ 45┊        type: 1,\n+┊   ┊ 46┊        recipients: [\n+┊   ┊ 47┊          {\n+┊   ┊ 48┊            user: {\n+┊   ┊ 49┊              id: '2',\n+┊   ┊ 50┊              __typename: 'User',\n+┊   ┊ 51┊            },\n+┊   ┊ 52┊            message: {\n+┊   ┊ 53┊              id: '1',\n+┊   ┊ 54┊              __typename: 'Message',\n+┊   ┊ 55┊              chat: {\n+┊   ┊ 56┊                id: '1',\n+┊   ┊ 57┊                __typename: 'Chat',\n+┊   ┊ 58┊              },\n+┊   ┊ 59┊            },\n+┊   ┊ 60┊            __typename: 'Recipient',\n+┊   ┊ 61┊            chat: {\n+┊   ┊ 62┊              id: '1',\n+┊   ┊ 63┊              __typename: 'Chat',\n+┊   ┊ 64┊            },\n+┊   ┊ 65┊            receivedAt: null,\n+┊   ┊ 66┊            readAt: null,\n+┊   ┊ 67┊          }\n+┊   ┊ 68┊        ],\n+┊   ┊ 69┊        ownership: true,\n+┊   ┊ 70┊      }\n+┊   ┊ 71┊    ],\n+┊   ┊ 72┊  };\n+┊   ┊ 73┊\n+┊   ┊ 74┊  beforeEach(async(() => {\n+┊   ┊ 75┊    TestBed.configureTestingModule({\n+┊   ┊ 76┊      declarations: [ ChatItemComponent ],\n+┊   ┊ 77┊      imports: [TruncateModule]\n+┊   ┊ 78┊    })\n+┊   ┊ 79┊    .compileComponents();\n+┊   ┊ 80┊  }));\n+┊   ┊ 81┊\n+┊   ┊ 82┊  beforeEach(() => {\n+┊   ┊ 83┊    fixture = TestBed.createComponent(ChatItemComponent);\n+┊   ┊ 84┊    component = fixture.componentInstance;\n+┊   ┊ 85┊    component.chat = chat;\n+┊   ┊ 86┊    fixture.detectChanges();\n+┊   ┊ 87┊    el = fixture.debugElement;\n+┊   ┊ 88┊  });\n+┊   ┊ 89┊\n+┊   ┊ 90┊  it('should create', () => {\n+┊   ┊ 91┊    expect(component).toBeTruthy();\n+┊   ┊ 92┊  });\n+┊   ┊ 93┊\n+┊   ┊ 94┊  it('should contain the chat name', () => {\n+┊   ┊ 95┊    expect(el.query(By.css('.chat-recipient > div:first-child')).nativeElement.textContent).toContain(chat.name);\n+┊   ┊ 96┊  });\n+┊   ┊ 97┊\n+┊   ┊ 98┊  it('should contain the first couple of characters of the message content', () => {\n+┊   ┊ 99┊    expect(el.query(By.css('.chat-content')).nativeElement.textContent)\n+┊   ┊100┊      .toContain(chat.messages[chat.messages.length - 1].content.slice(0, 20));\n+┊   ┊101┊  });\n+┊   ┊102┊\n+┊   ┊103┊  it('should not contain the latest characters of the message content', () => {\n+┊   ┊104┊    expect(el.query(By.css('.chat-content')).nativeElement.textContent)\n+┊   ┊105┊      .not.toContain(chat.messages[chat.messages.length - 1].content.slice(20));\n+┊   ┊106┊  });\n+┊   ┊107┊});\n```\n\n[}]: #\n\n### Testing a Service\n\nTesting a service is a bit more complicated because we will need to mock our backend in order to get fake results instead of having to fire up the backend each time.\n\nWe could simply simply mock the HTTP calls, which is a well known practice in the REST API world. Since we are using HTTP to retrieve the data, it would work as well with our Apollo Client setup.\n\n#### Testing with Apollo Angular\n\nBecause Apollo Angular provides its own testing utilities, let's bring them in!\n\nAlthough `apollo-angular` has a lot going on under the hood, the library provides multiple tools for testing that simplify those abstractions, and allows complete focus on the component logic.\n\nThe `apollo-angular/testing` module exports a `ApolloTestingModule` module and `ApolloTestingController` service which simplifies the testing of Angular components by mocking calls to the GraphQL endpoint. This allows the tests to be run in isolation and provides consistent results on every run by removing the dependence on remote data.\n\nBy using this `ApolloTestingController` service, it’s possible to specify the exact results that should be returned for a certain query.\n\nWorth mentioning, `ApolloTestingModule` comes with a default cache but you can use your own with `APOLLO_TESTING_CACHE` token.\n\nLet's show everything on an example:\n\n[{]: <helper> (diffStep \"3.1\" files=\"src/app/services/chats.service.spec.ts\" module=\"client\")\n\n#### [Step 3.1: Testing](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/b76d15b)\n\n##### Added src&#x2F;app&#x2F;services&#x2F;chats.service.spec.ts\n```diff\n@@ -0,0 +1,352 @@\n+┊   ┊  1┊import { TestBed, inject } from '@angular/core/testing';\n+┊   ┊  2┊\n+┊   ┊  3┊import { Apollo } from 'apollo-angular';\n+┊   ┊  4┊import {\n+┊   ┊  5┊  ApolloTestingModule,\n+┊   ┊  6┊  ApolloTestingController,\n+┊   ┊  7┊  APOLLO_TESTING_CACHE,\n+┊   ┊  8┊} from 'apollo-angular/testing';\n+┊   ┊  9┊import { InMemoryCache } from 'apollo-cache-inmemory';\n+┊   ┊ 10┊\n+┊   ┊ 11┊import { GetChats } from '../../graphql';\n+┊   ┊ 12┊import { dataIdFromObject } from '../graphql.module';\n+┊   ┊ 13┊import { ChatsService } from './chats.service';\n+┊   ┊ 14┊\n+┊   ┊ 15┊describe('ChatsService', () => {\n+┊   ┊ 16┊  let controller: ApolloTestingController;\n+┊   ┊ 17┊  let apollo: Apollo;\n+┊   ┊ 18┊\n+┊   ┊ 19┊  const chats: GetChats.Chats[] = [\n+┊   ┊ 20┊    {\n+┊   ┊ 21┊      id: '1',\n+┊   ┊ 22┊      __typename: 'Chat',\n+┊   ┊ 23┊      name: 'Avery Stewart',\n+┊   ┊ 24┊      picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n+┊   ┊ 25┊      allTimeMembers: [\n+┊   ┊ 26┊        {\n+┊   ┊ 27┊          id: '1',\n+┊   ┊ 28┊          __typename: 'User',\n+┊   ┊ 29┊        },\n+┊   ┊ 30┊        {\n+┊   ┊ 31┊          id: '3',\n+┊   ┊ 32┊          __typename: 'User',\n+┊   ┊ 33┊        },\n+┊   ┊ 34┊      ],\n+┊   ┊ 35┊      unreadMessages: 1,\n+┊   ┊ 36┊      isGroup: false,\n+┊   ┊ 37┊      messages: [\n+┊   ┊ 38┊        {\n+┊   ┊ 39┊          id: '1',\n+┊   ┊ 40┊          chat: {\n+┊   ┊ 41┊            id: '1',\n+┊   ┊ 42┊            __typename: 'Chat',\n+┊   ┊ 43┊          },\n+┊   ┊ 44┊          __typename: 'Message',\n+┊   ┊ 45┊          sender: {\n+┊   ┊ 46┊            id: '3',\n+┊   ┊ 47┊            __typename: 'User',\n+┊   ┊ 48┊            name: 'Avery Stewart',\n+┊   ┊ 49┊          },\n+┊   ┊ 50┊          content: 'Yep!',\n+┊   ┊ 51┊          createdAt: '1514035700',\n+┊   ┊ 52┊          type: 0,\n+┊   ┊ 53┊          recipients: [\n+┊   ┊ 54┊            {\n+┊   ┊ 55┊              user: {\n+┊   ┊ 56┊                id: '1',\n+┊   ┊ 57┊                __typename: 'User',\n+┊   ┊ 58┊              },\n+┊   ┊ 59┊              message: {\n+┊   ┊ 60┊                id: '1',\n+┊   ┊ 61┊                __typename: 'Message',\n+┊   ┊ 62┊                chat: {\n+┊   ┊ 63┊                  id: '1',\n+┊   ┊ 64┊                  __typename: 'Chat',\n+┊   ┊ 65┊                },\n+┊   ┊ 66┊              },\n+┊   ┊ 67┊              __typename: 'Recipient',\n+┊   ┊ 68┊              chat: {\n+┊   ┊ 69┊                id: '1',\n+┊   ┊ 70┊                __typename: 'Chat',\n+┊   ┊ 71┊              },\n+┊   ┊ 72┊              receivedAt: null,\n+┊   ┊ 73┊              readAt: null,\n+┊   ┊ 74┊            },\n+┊   ┊ 75┊          ],\n+┊   ┊ 76┊          ownership: false,\n+┊   ┊ 77┊        },\n+┊   ┊ 78┊      ],\n+┊   ┊ 79┊    },\n+┊   ┊ 80┊    {\n+┊   ┊ 81┊      id: '2',\n+┊   ┊ 82┊      __typename: 'Chat',\n+┊   ┊ 83┊      name: 'Katie Peterson',\n+┊   ┊ 84┊      picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n+┊   ┊ 85┊      allTimeMembers: [\n+┊   ┊ 86┊        {\n+┊   ┊ 87┊          id: '1',\n+┊   ┊ 88┊          __typename: 'User',\n+┊   ┊ 89┊        },\n+┊   ┊ 90┊        {\n+┊   ┊ 91┊          id: '4',\n+┊   ┊ 92┊          __typename: 'User',\n+┊   ┊ 93┊        },\n+┊   ┊ 94┊      ],\n+┊   ┊ 95┊      unreadMessages: 0,\n+┊   ┊ 96┊      isGroup: false,\n+┊   ┊ 97┊      messages: [\n+┊   ┊ 98┊        {\n+┊   ┊ 99┊          id: '1',\n+┊   ┊100┊          chat: {\n+┊   ┊101┊            id: '2',\n+┊   ┊102┊            __typename: 'Chat',\n+┊   ┊103┊          },\n+┊   ┊104┊          __typename: 'Message',\n+┊   ┊105┊          sender: {\n+┊   ┊106┊            id: '1',\n+┊   ┊107┊            __typename: 'User',\n+┊   ┊108┊            name: 'Ethan Gonzalez',\n+┊   ┊109┊          },\n+┊   ┊110┊          content: `Hey, it's me`,\n+┊   ┊111┊          createdAt: '1514031800',\n+┊   ┊112┊          type: 0,\n+┊   ┊113┊          recipients: [\n+┊   ┊114┊            {\n+┊   ┊115┊              user: {\n+┊   ┊116┊                id: '4',\n+┊   ┊117┊                __typename: 'User',\n+┊   ┊118┊              },\n+┊   ┊119┊              message: {\n+┊   ┊120┊                id: '1',\n+┊   ┊121┊                __typename: 'Message',\n+┊   ┊122┊                chat: {\n+┊   ┊123┊                  id: '2',\n+┊   ┊124┊                  __typename: 'Chat',\n+┊   ┊125┊                },\n+┊   ┊126┊              },\n+┊   ┊127┊              __typename: 'Recipient',\n+┊   ┊128┊              chat: {\n+┊   ┊129┊                id: '2',\n+┊   ┊130┊                __typename: 'Chat',\n+┊   ┊131┊              },\n+┊   ┊132┊              receivedAt: null,\n+┊   ┊133┊              readAt: null,\n+┊   ┊134┊            },\n+┊   ┊135┊          ],\n+┊   ┊136┊          ownership: true,\n+┊   ┊137┊        },\n+┊   ┊138┊      ],\n+┊   ┊139┊    },\n+┊   ┊140┊    {\n+┊   ┊141┊      id: '3',\n+┊   ┊142┊      __typename: 'Chat',\n+┊   ┊143┊      name: 'Ray Edwards',\n+┊   ┊144┊      picture: 'https://randomuser.me/api/portraits/thumb/men/3.jpg',\n+┊   ┊145┊      allTimeMembers: [\n+┊   ┊146┊        {\n+┊   ┊147┊          id: '1',\n+┊   ┊148┊          __typename: 'User',\n+┊   ┊149┊        },\n+┊   ┊150┊        {\n+┊   ┊151┊          id: '5',\n+┊   ┊152┊          __typename: 'User',\n+┊   ┊153┊        },\n+┊   ┊154┊      ],\n+┊   ┊155┊      unreadMessages: 0,\n+┊   ┊156┊      isGroup: false,\n+┊   ┊157┊      messages: [\n+┊   ┊158┊        {\n+┊   ┊159┊          id: '1',\n+┊   ┊160┊          __typename: 'Message',\n+┊   ┊161┊          chat: {\n+┊   ┊162┊            id: '3',\n+┊   ┊163┊            __typename: 'Chat',\n+┊   ┊164┊          },\n+┊   ┊165┊          sender: {\n+┊   ┊166┊            id: '1',\n+┊   ┊167┊            __typename: 'User',\n+┊   ┊168┊            name: 'Ethan Gonzalez',\n+┊   ┊169┊          },\n+┊   ┊170┊          content: 'You still there?',\n+┊   ┊171┊          createdAt: '1514010200',\n+┊   ┊172┊          type: 0,\n+┊   ┊173┊          recipients: [\n+┊   ┊174┊            {\n+┊   ┊175┊              user: {\n+┊   ┊176┊                id: '5',\n+┊   ┊177┊                __typename: 'User',\n+┊   ┊178┊              },\n+┊   ┊179┊              message: {\n+┊   ┊180┊                id: '1',\n+┊   ┊181┊                __typename: 'Message',\n+┊   ┊182┊                chat: {\n+┊   ┊183┊                  id: '3',\n+┊   ┊184┊                  __typename: 'Chat',\n+┊   ┊185┊                },\n+┊   ┊186┊              },\n+┊   ┊187┊              __typename: 'Recipient',\n+┊   ┊188┊              chat: {\n+┊   ┊189┊                id: '3',\n+┊   ┊190┊                __typename: 'Chat',\n+┊   ┊191┊              },\n+┊   ┊192┊              receivedAt: null,\n+┊   ┊193┊              readAt: null,\n+┊   ┊194┊            },\n+┊   ┊195┊          ],\n+┊   ┊196┊          ownership: true,\n+┊   ┊197┊        },\n+┊   ┊198┊      ],\n+┊   ┊199┊    },\n+┊   ┊200┊    {\n+┊   ┊201┊      id: '6',\n+┊   ┊202┊      __typename: 'Chat',\n+┊   ┊203┊      name: 'Niccolò Belli',\n+┊   ┊204┊      picture: 'https://randomuser.me/api/portraits/thumb/men/4.jpg',\n+┊   ┊205┊      allTimeMembers: [\n+┊   ┊206┊        {\n+┊   ┊207┊          id: '1',\n+┊   ┊208┊          __typename: 'User',\n+┊   ┊209┊        },\n+┊   ┊210┊        {\n+┊   ┊211┊          id: '6',\n+┊   ┊212┊          __typename: 'User',\n+┊   ┊213┊        },\n+┊   ┊214┊      ],\n+┊   ┊215┊      unreadMessages: 0,\n+┊   ┊216┊      messages: [],\n+┊   ┊217┊      isGroup: false,\n+┊   ┊218┊    },\n+┊   ┊219┊    {\n+┊   ┊220┊      id: '8',\n+┊   ┊221┊      __typename: 'Chat',\n+┊   ┊222┊      name: 'A user 0 group',\n+┊   ┊223┊      picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n+┊   ┊224┊      allTimeMembers: [\n+┊   ┊225┊        {\n+┊   ┊226┊          id: '1',\n+┊   ┊227┊          __typename: 'User',\n+┊   ┊228┊        },\n+┊   ┊229┊        {\n+┊   ┊230┊          id: '3',\n+┊   ┊231┊          __typename: 'User',\n+┊   ┊232┊        },\n+┊   ┊233┊        {\n+┊   ┊234┊          id: '4',\n+┊   ┊235┊          __typename: 'User',\n+┊   ┊236┊        },\n+┊   ┊237┊        {\n+┊   ┊238┊          id: '6',\n+┊   ┊239┊          __typename: 'User',\n+┊   ┊240┊        },\n+┊   ┊241┊      ],\n+┊   ┊242┊      unreadMessages: 1,\n+┊   ┊243┊      isGroup: true,\n+┊   ┊244┊      messages: [\n+┊   ┊245┊        {\n+┊   ┊246┊          id: '1',\n+┊   ┊247┊          __typename: 'Message',\n+┊   ┊248┊          chat: {\n+┊   ┊249┊            id: '8',\n+┊   ┊250┊            __typename: 'Chat',\n+┊   ┊251┊          },\n+┊   ┊252┊          sender: {\n+┊   ┊253┊            id: '4',\n+┊   ┊254┊            __typename: 'User',\n+┊   ┊255┊            name: 'Katie Peterson',\n+┊   ┊256┊          },\n+┊   ┊257┊          content: 'Awesome!',\n+┊   ┊258┊          createdAt: '1512830000',\n+┊   ┊259┊          type: 0,\n+┊   ┊260┊          recipients: [\n+┊   ┊261┊            {\n+┊   ┊262┊              user: {\n+┊   ┊263┊                id: '1',\n+┊   ┊264┊                __typename: 'User',\n+┊   ┊265┊              },\n+┊   ┊266┊              message: {\n+┊   ┊267┊                id: '1',\n+┊   ┊268┊                __typename: 'Message',\n+┊   ┊269┊                chat: {\n+┊   ┊270┊                  id: '8',\n+┊   ┊271┊                  __typename: 'Chat',\n+┊   ┊272┊                },\n+┊   ┊273┊              },\n+┊   ┊274┊              __typename: 'Recipient',\n+┊   ┊275┊              chat: {\n+┊   ┊276┊                id: '8',\n+┊   ┊277┊                __typename: 'Chat',\n+┊   ┊278┊              },\n+┊   ┊279┊              receivedAt: null,\n+┊   ┊280┊              readAt: null,\n+┊   ┊281┊            },\n+┊   ┊282┊            {\n+┊   ┊283┊              user: {\n+┊   ┊284┊                id: '6',\n+┊   ┊285┊                __typename: 'User',\n+┊   ┊286┊              },\n+┊   ┊287┊              message: {\n+┊   ┊288┊                id: '1',\n+┊   ┊289┊                __typename: 'Message',\n+┊   ┊290┊                chat: {\n+┊   ┊291┊                  id: '8',\n+┊   ┊292┊                  __typename: 'Chat',\n+┊   ┊293┊                },\n+┊   ┊294┊              },\n+┊   ┊295┊              __typename: 'Recipient',\n+┊   ┊296┊              chat: {\n+┊   ┊297┊                id: '8',\n+┊   ┊298┊                __typename: 'Chat',\n+┊   ┊299┊              },\n+┊   ┊300┊              receivedAt: null,\n+┊   ┊301┊              readAt: null,\n+┊   ┊302┊            },\n+┊   ┊303┊          ],\n+┊   ┊304┊          ownership: false,\n+┊   ┊305┊        },\n+┊   ┊306┊      ],\n+┊   ┊307┊    },\n+┊   ┊308┊  ];\n+┊   ┊309┊\n+┊   ┊310┊  beforeEach(() => {\n+┊   ┊311┊    TestBed.configureTestingModule({\n+┊   ┊312┊      imports: [ApolloTestingModule],\n+┊   ┊313┊      providers: [\n+┊   ┊314┊        ChatsService,\n+┊   ┊315┊        {\n+┊   ┊316┊          provide: APOLLO_TESTING_CACHE,\n+┊   ┊317┊          useFactory() {\n+┊   ┊318┊            return new InMemoryCache({\n+┊   ┊319┊              dataIdFromObject,\n+┊   ┊320┊            });\n+┊   ┊321┊          },\n+┊   ┊322┊        },\n+┊   ┊323┊      ],\n+┊   ┊324┊    });\n+┊   ┊325┊\n+┊   ┊326┊    controller = TestBed.get(ApolloTestingController);\n+┊   ┊327┊    apollo = TestBed.get(Apollo);\n+┊   ┊328┊  });\n+┊   ┊329┊\n+┊   ┊330┊  it('should be created', inject([ChatsService], (service: ChatsService) => {\n+┊   ┊331┊    expect(service).toBeTruthy();\n+┊   ┊332┊  }));\n+┊   ┊333┊\n+┊   ┊334┊  it('should get chats', inject([ChatsService], (service: ChatsService) => {\n+┊   ┊335┊    service.getChats().chats$.subscribe(_chats => {\n+┊   ┊336┊      expect(_chats.length).toEqual(chats.length);\n+┊   ┊337┊      for (let i = 0; i < _chats.length; i++) {\n+┊   ┊338┊        expect(_chats[i]).toEqual(chats[i]);\n+┊   ┊339┊      }\n+┊   ┊340┊    });\n+┊   ┊341┊\n+┊   ┊342┊    const req = controller.expectOne('GetChats', 'GetChats operation');\n+┊   ┊343┊\n+┊   ┊344┊    req.flush({\n+┊   ┊345┊      data: {\n+┊   ┊346┊        chats,\n+┊   ┊347┊      },\n+┊   ┊348┊    });\n+┊   ┊349┊\n+┊   ┊350┊    controller.verify();\n+┊   ┊351┊  }));\n+┊   ┊352┊});\n```\n\n[}]: #\n\nAs you can see, the API of `ApolloTestingController` is pretty similar to the `HttpTestingController`.\n\nThere are four methods you should know.\n\n**`expectOne()`**\nImportant thing, it accepts two arguments. First is different for different use cases, the second one stays always the same, it’s a string with a description of your assertion. In case of failing assertion, the error is thrown with an error message including the given description.\n\nLet's explore all those possible cases `expectOne` accepts:\n\n- you can match an operation by its name, simply by passing a string as a first argument.\n- by passing the whole Operation object the expectOne method compares: operation’s name, variables, document and extensions.\n- the first argument can also be a function that provides an Operation object and expect a boolean in return\n- or passing a GraphQL Document\n\n**`exceptNone()`**\nIt accepts the same arguments as expectOne but it's a negation of it.\n\n**`match()`**\nSearch for operations that match the given parameters, without any expectations.\n\n**`verify()`**\nVerify that no unmatched operations are outstanding. If any operations are outstanding, fail with an error message indicating which operations were not handled.\n\nIf you want to learn more about testing, we got you covered, please visit [\"Testing Apollo in Angular\" chapter](https://www.apollographql.com/docs/angular/guides/testing.html) in Apollo documentation.\n\n### Testing a Container Component\n\nIn the last example we are going to test a container component, which makes use of several services and multiple other components:\n\n[{]: <helper> (diffStep \"3.1\" files=\"src/app/chats-lister/containers/chats/chats.component.spec.ts\" module=\"client\")\n\n#### [Step 3.1: Testing](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/b76d15b)\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.spec.ts\n```diff\n@@ -0,0 +1,392 @@\n+┊   ┊  1┊import { async, ComponentFixture, TestBed } from '@angular/core/testing';\n+┊   ┊  2┊import { DebugElement, NO_ERRORS_SCHEMA } from '@angular/core';\n+┊   ┊  3┊import { TruncateModule } from 'ng2-truncate';\n+┊   ┊  4┊import {\n+┊   ┊  5┊  MatButtonModule,\n+┊   ┊  6┊  MatIconModule,\n+┊   ┊  7┊  MatListModule,\n+┊   ┊  8┊  MatMenuModule,\n+┊   ┊  9┊} from '@angular/material';\n+┊   ┊ 10┊import { Apollo } from 'apollo-angular';\n+┊   ┊ 11┊import {\n+┊   ┊ 12┊  ApolloTestingModule,\n+┊   ┊ 13┊  ApolloTestingController,\n+┊   ┊ 14┊  APOLLO_TESTING_CACHE,\n+┊   ┊ 15┊} from 'apollo-angular/testing';\n+┊   ┊ 16┊import { InMemoryCache } from 'apollo-cache-inmemory';\n+┊   ┊ 17┊import { By } from '@angular/platform-browser';\n+┊   ┊ 18┊import { RouterTestingModule } from '@angular/router/testing';\n+┊   ┊ 19┊\n+┊   ┊ 20┊import { GetChats } from '../../../../graphql';\n+┊   ┊ 21┊import { dataIdFromObject } from '../../../graphql.module';\n+┊   ┊ 22┊import { ChatsComponent } from './chats.component';\n+┊   ┊ 23┊import { ChatsListComponent } from '../../components/chats-list/chats-list.component';\n+┊   ┊ 24┊import { ChatItemComponent } from '../../components/chat-item/chat-item.component';\n+┊   ┊ 25┊import { ChatsService } from '../../../services/chats.service';\n+┊   ┊ 26┊\n+┊   ┊ 27┊describe('ChatsComponent', () => {\n+┊   ┊ 28┊  let component: ChatsComponent;\n+┊   ┊ 29┊  let fixture: ComponentFixture<ChatsComponent>;\n+┊   ┊ 30┊  let el: DebugElement;\n+┊   ┊ 31┊\n+┊   ┊ 32┊  let controller: ApolloTestingController;\n+┊   ┊ 33┊  let apollo: Apollo;\n+┊   ┊ 34┊\n+┊   ┊ 35┊  const chats: GetChats.Chats[] = [\n+┊   ┊ 36┊    {\n+┊   ┊ 37┊      id: '1',\n+┊   ┊ 38┊      __typename: 'Chat',\n+┊   ┊ 39┊      name: 'Avery Stewart',\n+┊   ┊ 40┊      picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n+┊   ┊ 41┊      allTimeMembers: [\n+┊   ┊ 42┊        {\n+┊   ┊ 43┊          id: '1',\n+┊   ┊ 44┊          __typename: 'User',\n+┊   ┊ 45┊        },\n+┊   ┊ 46┊        {\n+┊   ┊ 47┊          id: '3',\n+┊   ┊ 48┊          __typename: 'User',\n+┊   ┊ 49┊        },\n+┊   ┊ 50┊      ],\n+┊   ┊ 51┊      unreadMessages: 1,\n+┊   ┊ 52┊      isGroup: false,\n+┊   ┊ 53┊      messages: [\n+┊   ┊ 54┊        {\n+┊   ┊ 55┊          id: '1',\n+┊   ┊ 56┊          chat: {\n+┊   ┊ 57┊            id: '1',\n+┊   ┊ 58┊            __typename: 'Chat',\n+┊   ┊ 59┊          },\n+┊   ┊ 60┊          __typename: 'Message',\n+┊   ┊ 61┊          sender: {\n+┊   ┊ 62┊            id: '3',\n+┊   ┊ 63┊            __typename: 'User',\n+┊   ┊ 64┊            name: 'Avery Stewart',\n+┊   ┊ 65┊          },\n+┊   ┊ 66┊          content: 'Yep!',\n+┊   ┊ 67┊          createdAt: '1514035700',\n+┊   ┊ 68┊          type: 0,\n+┊   ┊ 69┊          recipients: [\n+┊   ┊ 70┊            {\n+┊   ┊ 71┊              user: {\n+┊   ┊ 72┊                id: '1',\n+┊   ┊ 73┊                __typename: 'User',\n+┊   ┊ 74┊              },\n+┊   ┊ 75┊              message: {\n+┊   ┊ 76┊                id: '1',\n+┊   ┊ 77┊                __typename: 'Message',\n+┊   ┊ 78┊                chat: {\n+┊   ┊ 79┊                  id: '1',\n+┊   ┊ 80┊                  __typename: 'Chat',\n+┊   ┊ 81┊                },\n+┊   ┊ 82┊              },\n+┊   ┊ 83┊              __typename: 'Recipient',\n+┊   ┊ 84┊              chat: {\n+┊   ┊ 85┊                id: '1',\n+┊   ┊ 86┊                __typename: 'Chat',\n+┊   ┊ 87┊              },\n+┊   ┊ 88┊              receivedAt: null,\n+┊   ┊ 89┊              readAt: null,\n+┊   ┊ 90┊            },\n+┊   ┊ 91┊          ],\n+┊   ┊ 92┊          ownership: false,\n+┊   ┊ 93┊        },\n+┊   ┊ 94┊      ],\n+┊   ┊ 95┊    },\n+┊   ┊ 96┊    {\n+┊   ┊ 97┊      id: '2',\n+┊   ┊ 98┊      __typename: 'Chat',\n+┊   ┊ 99┊      name: 'Katie Peterson',\n+┊   ┊100┊      picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n+┊   ┊101┊      allTimeMembers: [\n+┊   ┊102┊        {\n+┊   ┊103┊          id: '1',\n+┊   ┊104┊          __typename: 'User',\n+┊   ┊105┊        },\n+┊   ┊106┊        {\n+┊   ┊107┊          id: '4',\n+┊   ┊108┊          __typename: 'User',\n+┊   ┊109┊        },\n+┊   ┊110┊      ],\n+┊   ┊111┊      unreadMessages: 0,\n+┊   ┊112┊      isGroup: false,\n+┊   ┊113┊      messages: [\n+┊   ┊114┊        {\n+┊   ┊115┊          id: '1',\n+┊   ┊116┊          chat: {\n+┊   ┊117┊            id: '2',\n+┊   ┊118┊            __typename: 'Chat',\n+┊   ┊119┊          },\n+┊   ┊120┊          __typename: 'Message',\n+┊   ┊121┊          sender: {\n+┊   ┊122┊            id: '1',\n+┊   ┊123┊            __typename: 'User',\n+┊   ┊124┊            name: 'Ethan Gonzalez',\n+┊   ┊125┊          },\n+┊   ┊126┊          content: `Hey, it's me`,\n+┊   ┊127┊          createdAt: '1514031800',\n+┊   ┊128┊          type: 0,\n+┊   ┊129┊          recipients: [\n+┊   ┊130┊            {\n+┊   ┊131┊              user: {\n+┊   ┊132┊                id: '4',\n+┊   ┊133┊                __typename: 'User',\n+┊   ┊134┊              },\n+┊   ┊135┊              message: {\n+┊   ┊136┊                id: '1',\n+┊   ┊137┊                __typename: 'Message',\n+┊   ┊138┊                chat: {\n+┊   ┊139┊                  id: '2',\n+┊   ┊140┊                  __typename: 'Chat',\n+┊   ┊141┊                },\n+┊   ┊142┊              },\n+┊   ┊143┊              __typename: 'Recipient',\n+┊   ┊144┊              chat: {\n+┊   ┊145┊                id: '2',\n+┊   ┊146┊                __typename: 'Chat',\n+┊   ┊147┊              },\n+┊   ┊148┊              receivedAt: null,\n+┊   ┊149┊              readAt: null,\n+┊   ┊150┊            },\n+┊   ┊151┊          ],\n+┊   ┊152┊          ownership: true,\n+┊   ┊153┊        },\n+┊   ┊154┊      ],\n+┊   ┊155┊    },\n+┊   ┊156┊    {\n+┊   ┊157┊      id: '3',\n+┊   ┊158┊      __typename: 'Chat',\n+┊   ┊159┊      name: 'Ray Edwards',\n+┊   ┊160┊      picture: 'https://randomuser.me/api/portraits/thumb/men/3.jpg',\n+┊   ┊161┊      allTimeMembers: [\n+┊   ┊162┊        {\n+┊   ┊163┊          id: '1',\n+┊   ┊164┊          __typename: 'User',\n+┊   ┊165┊        },\n+┊   ┊166┊        {\n+┊   ┊167┊          id: '5',\n+┊   ┊168┊          __typename: 'User',\n+┊   ┊169┊        },\n+┊   ┊170┊      ],\n+┊   ┊171┊      unreadMessages: 0,\n+┊   ┊172┊      isGroup: false,\n+┊   ┊173┊      messages: [\n+┊   ┊174┊        {\n+┊   ┊175┊          id: '1',\n+┊   ┊176┊          __typename: 'Message',\n+┊   ┊177┊          chat: {\n+┊   ┊178┊            id: '3',\n+┊   ┊179┊            __typename: 'Chat',\n+┊   ┊180┊          },\n+┊   ┊181┊          sender: {\n+┊   ┊182┊            id: '1',\n+┊   ┊183┊            __typename: 'User',\n+┊   ┊184┊            name: 'Ethan Gonzalez',\n+┊   ┊185┊          },\n+┊   ┊186┊          content: 'You still there?',\n+┊   ┊187┊          createdAt: '1514010200',\n+┊   ┊188┊          type: 0,\n+┊   ┊189┊          recipients: [\n+┊   ┊190┊            {\n+┊   ┊191┊              user: {\n+┊   ┊192┊                id: '5',\n+┊   ┊193┊                __typename: 'User',\n+┊   ┊194┊              },\n+┊   ┊195┊              message: {\n+┊   ┊196┊                id: '1',\n+┊   ┊197┊                __typename: 'Message',\n+┊   ┊198┊                chat: {\n+┊   ┊199┊                  id: '3',\n+┊   ┊200┊                  __typename: 'Chat',\n+┊   ┊201┊                },\n+┊   ┊202┊              },\n+┊   ┊203┊              __typename: 'Recipient',\n+┊   ┊204┊              chat: {\n+┊   ┊205┊                id: '3',\n+┊   ┊206┊                __typename: 'Chat',\n+┊   ┊207┊              },\n+┊   ┊208┊              receivedAt: null,\n+┊   ┊209┊              readAt: null,\n+┊   ┊210┊            },\n+┊   ┊211┊          ],\n+┊   ┊212┊          ownership: true,\n+┊   ┊213┊        },\n+┊   ┊214┊      ],\n+┊   ┊215┊    },\n+┊   ┊216┊    {\n+┊   ┊217┊      id: '6',\n+┊   ┊218┊      __typename: 'Chat',\n+┊   ┊219┊      name: 'Niccolò Belli',\n+┊   ┊220┊      picture: 'https://randomuser.me/api/portraits/thumb/men/4.jpg',\n+┊   ┊221┊      allTimeMembers: [\n+┊   ┊222┊        {\n+┊   ┊223┊          id: '1',\n+┊   ┊224┊          __typename: 'User',\n+┊   ┊225┊        },\n+┊   ┊226┊        {\n+┊   ┊227┊          id: '6',\n+┊   ┊228┊          __typename: 'User',\n+┊   ┊229┊        },\n+┊   ┊230┊      ],\n+┊   ┊231┊      unreadMessages: 0,\n+┊   ┊232┊      messages: [],\n+┊   ┊233┊      isGroup: false,\n+┊   ┊234┊    },\n+┊   ┊235┊    {\n+┊   ┊236┊      id: '8',\n+┊   ┊237┊      __typename: 'Chat',\n+┊   ┊238┊      name: 'A user 0 group',\n+┊   ┊239┊      picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n+┊   ┊240┊      allTimeMembers: [\n+┊   ┊241┊        {\n+┊   ┊242┊          id: '1',\n+┊   ┊243┊          __typename: 'User',\n+┊   ┊244┊        },\n+┊   ┊245┊        {\n+┊   ┊246┊          id: '3',\n+┊   ┊247┊          __typename: 'User',\n+┊   ┊248┊        },\n+┊   ┊249┊        {\n+┊   ┊250┊          id: '4',\n+┊   ┊251┊          __typename: 'User',\n+┊   ┊252┊        },\n+┊   ┊253┊        {\n+┊   ┊254┊          id: '6',\n+┊   ┊255┊          __typename: 'User',\n+┊   ┊256┊        },\n+┊   ┊257┊      ],\n+┊   ┊258┊      unreadMessages: 1,\n+┊   ┊259┊      isGroup: true,\n+┊   ┊260┊      messages: [\n+┊   ┊261┊        {\n+┊   ┊262┊          id: '1',\n+┊   ┊263┊          __typename: 'Message',\n+┊   ┊264┊          chat: {\n+┊   ┊265┊            id: '8',\n+┊   ┊266┊            __typename: 'Chat',\n+┊   ┊267┊          },\n+┊   ┊268┊          sender: {\n+┊   ┊269┊            id: '4',\n+┊   ┊270┊            __typename: 'User',\n+┊   ┊271┊            name: 'Katie Peterson',\n+┊   ┊272┊          },\n+┊   ┊273┊          content: 'Awesome!',\n+┊   ┊274┊          createdAt: '1512830000',\n+┊   ┊275┊          type: 0,\n+┊   ┊276┊          recipients: [\n+┊   ┊277┊            {\n+┊   ┊278┊              user: {\n+┊   ┊279┊                id: '1',\n+┊   ┊280┊                __typename: 'User',\n+┊   ┊281┊              },\n+┊   ┊282┊              message: {\n+┊   ┊283┊                id: '1',\n+┊   ┊284┊                __typename: 'Message',\n+┊   ┊285┊                chat: {\n+┊   ┊286┊                  id: '8',\n+┊   ┊287┊                  __typename: 'Chat',\n+┊   ┊288┊                },\n+┊   ┊289┊              },\n+┊   ┊290┊              __typename: 'Recipient',\n+┊   ┊291┊              chat: {\n+┊   ┊292┊                id: '8',\n+┊   ┊293┊                __typename: 'Chat',\n+┊   ┊294┊              },\n+┊   ┊295┊              receivedAt: null,\n+┊   ┊296┊              readAt: null,\n+┊   ┊297┊            },\n+┊   ┊298┊            {\n+┊   ┊299┊              user: {\n+┊   ┊300┊                id: '6',\n+┊   ┊301┊                __typename: 'User',\n+┊   ┊302┊              },\n+┊   ┊303┊              message: {\n+┊   ┊304┊                id: '1',\n+┊   ┊305┊                __typename: 'Message',\n+┊   ┊306┊                chat: {\n+┊   ┊307┊                  id: '8',\n+┊   ┊308┊                  __typename: 'Chat',\n+┊   ┊309┊                },\n+┊   ┊310┊              },\n+┊   ┊311┊              __typename: 'Recipient',\n+┊   ┊312┊              chat: {\n+┊   ┊313┊                id: '8',\n+┊   ┊314┊                __typename: 'Chat',\n+┊   ┊315┊              },\n+┊   ┊316┊              receivedAt: null,\n+┊   ┊317┊              readAt: null,\n+┊   ┊318┊            },\n+┊   ┊319┊          ],\n+┊   ┊320┊          ownership: false,\n+┊   ┊321┊        },\n+┊   ┊322┊      ],\n+┊   ┊323┊    },\n+┊   ┊324┊  ];\n+┊   ┊325┊\n+┊   ┊326┊  beforeEach(async(() => {\n+┊   ┊327┊    TestBed.configureTestingModule({\n+┊   ┊328┊      declarations: [ChatsComponent, ChatsListComponent, ChatItemComponent],\n+┊   ┊329┊      imports: [\n+┊   ┊330┊        MatMenuModule,\n+┊   ┊331┊        MatIconModule,\n+┊   ┊332┊        MatButtonModule,\n+┊   ┊333┊        MatListModule,\n+┊   ┊334┊        TruncateModule,\n+┊   ┊335┊        ApolloTestingModule,\n+┊   ┊336┊        RouterTestingModule,\n+┊   ┊337┊      ],\n+┊   ┊338┊      providers: [\n+┊   ┊339┊        ChatsService,\n+┊   ┊340┊        {\n+┊   ┊341┊          provide: APOLLO_TESTING_CACHE,\n+┊   ┊342┊          useFactory() {\n+┊   ┊343┊            return new InMemoryCache({ dataIdFromObject });\n+┊   ┊344┊          },\n+┊   ┊345┊        },\n+┊   ┊346┊      ],\n+┊   ┊347┊      schemas: [NO_ERRORS_SCHEMA],\n+┊   ┊348┊    }).compileComponents();\n+┊   ┊349┊\n+┊   ┊350┊    controller = TestBed.get(ApolloTestingController);\n+┊   ┊351┊    apollo = TestBed.get(Apollo);\n+┊   ┊352┊  }));\n+┊   ┊353┊\n+┊   ┊354┊  beforeEach(() => {\n+┊   ┊355┊    fixture = TestBed.createComponent(ChatsComponent);\n+┊   ┊356┊    component = fixture.componentInstance;\n+┊   ┊357┊    fixture.detectChanges();\n+┊   ┊358┊\n+┊   ┊359┊    const req = controller.expectOne('GetChats', 'GetChats operation');\n+┊   ┊360┊\n+┊   ┊361┊    req.flush({\n+┊   ┊362┊      data: {\n+┊   ┊363┊        chats,\n+┊   ┊364┊      },\n+┊   ┊365┊    });\n+┊   ┊366┊  });\n+┊   ┊367┊\n+┊   ┊368┊  it('should create', () => {\n+┊   ┊369┊    expect(component).toBeTruthy();\n+┊   ┊370┊  });\n+┊   ┊371┊\n+┊   ┊372┊  it('should display the chats', () => {\n+┊   ┊373┊    fixture.whenStable().then(() => {\n+┊   ┊374┊      fixture.detectChanges();\n+┊   ┊375┊      el = fixture.debugElement;\n+┊   ┊376┊      for (let i = 0; i < chats.length; i++) {\n+┊   ┊377┊        expect(\n+┊   ┊378┊          el.query(\n+┊   ┊379┊            By.css(\n+┊   ┊380┊              `app-chats-list > mat-list > mat-list-item:nth-child(${i +\n+┊   ┊381┊                1}) > div > app-chat-item > div > div > div`,\n+┊   ┊382┊            ),\n+┊   ┊383┊          ).nativeElement.textContent,\n+┊   ┊384┊        ).toContain(chats[i].name);\n+┊   ┊385┊      }\n+┊   ┊386┊    });\n+┊   ┊387┊  });\n+┊   ┊388┊\n+┊   ┊389┊  afterAll(() => {\n+┊   ┊390┊    controller.verify();\n+┊   ┊391┊  });\n+┊   ┊392┊});\n```\n\n[}]: #"
          },
          {
            "manualTitle": "Step 8: Chat viewer",
            "stepRevision": "026cf4f16276d61fd0e962c466c76806bb4f397c",
            "manualView": "![chat](https://user-images.githubusercontent.com/7648874/49270290-92877e80-f4a3-11e8-8984-d3ee920838ed.png)\n\nAt this point we have a module which lists all of our chats, but we still need to show a particular chat.\nWe're going to implement in in this chapter.\n\n### ChatViewer module\n\nFirst, let's create a `ChatViewer` module:\n\n[{]: <helper> (diffStep \"4.1\" files=\"src/app/app.module.ts, src/app/chat-viewer/chat-viewer.module.ts\" module=\"client\")\n\n#### [Step 4.1: Chat Viewer](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/257159a)\n\n##### Changed src&#x2F;app&#x2F;app.module.ts\n```diff\n@@ -6,6 +6,7 @@\n ┊ 6┊ 6┊import { GraphQLModule } from './graphql.module';\n ┊ 7┊ 7┊import {ChatsListerModule} from './chats-lister/chats-lister.module';\n ┊ 8┊ 8┊import {RouterModule, Routes} from '@angular/router';\n+┊  ┊ 9┊import {ChatViewerModule} from './chat-viewer/chat-viewer.module';\n ┊ 9┊10┊const routes: Routes = [];\n ┊10┊11┊\n ┊11┊12┊@NgModule({\n```\n```diff\n@@ -20,6 +21,7 @@\n ┊20┊21┊    RouterModule.forRoot(routes),\n ┊21┊22┊    // Feature modules\n ┊22┊23┊    ChatsListerModule,\n+┊  ┊24┊    ChatViewerModule,\n ┊23┊25┊  ],\n ┊24┊26┊  providers: [],\n ┊25┊27┊  bootstrap: [AppComponent]\n```\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;chat-viewer.module.ts\n```diff\n@@ -0,0 +1,53 @@\n+┊  ┊ 1┊import { BrowserModule } from '@angular/platform-browser';\n+┊  ┊ 2┊import { NgModule } from '@angular/core';\n+┊  ┊ 3┊\n+┊  ┊ 4┊import {BrowserAnimationsModule} from '@angular/platform-browser/animations';\n+┊  ┊ 5┊import {MatButtonModule, MatGridListModule, MatIconModule, MatListModule, MatMenuModule, MatToolbarModule} from '@angular/material';\n+┊  ┊ 6┊import {RouterModule, Routes} from '@angular/router';\n+┊  ┊ 7┊import {FormsModule} from '@angular/forms';\n+┊  ┊ 8┊import {ChatsService} from '../services/chats.service';\n+┊  ┊ 9┊import {ChatComponent} from './containers/chat/chat.component';\n+┊  ┊10┊import {MessagesListComponent} from './components/messages-list/messages-list.component';\n+┊  ┊11┊import {MessageItemComponent} from './components/message-item/message-item.component';\n+┊  ┊12┊import {NewMessageComponent} from './components/new-message/new-message.component';\n+┊  ┊13┊import {SharedModule} from '../shared/shared.module';\n+┊  ┊14┊\n+┊  ┊15┊const routes: Routes = [\n+┊  ┊16┊  {\n+┊  ┊17┊    path: 'chat', children: [\n+┊  ┊18┊      {path: ':id', component: ChatComponent},\n+┊  ┊19┊    ],\n+┊  ┊20┊  },\n+┊  ┊21┊];\n+┊  ┊22┊\n+┊  ┊23┊@NgModule({\n+┊  ┊24┊  declarations: [\n+┊  ┊25┊    ChatComponent,\n+┊  ┊26┊    MessagesListComponent,\n+┊  ┊27┊    MessageItemComponent,\n+┊  ┊28┊    NewMessageComponent,\n+┊  ┊29┊  ],\n+┊  ┊30┊  imports: [\n+┊  ┊31┊    BrowserModule,\n+┊  ┊32┊    // Material\n+┊  ┊33┊    MatToolbarModule,\n+┊  ┊34┊    MatMenuModule,\n+┊  ┊35┊    MatIconModule,\n+┊  ┊36┊    MatButtonModule,\n+┊  ┊37┊    MatListModule,\n+┊  ┊38┊    MatGridListModule,\n+┊  ┊39┊    // Animations\n+┊  ┊40┊    BrowserAnimationsModule,\n+┊  ┊41┊    // Routing\n+┊  ┊42┊    RouterModule.forChild(routes),\n+┊  ┊43┊    // Forms\n+┊  ┊44┊    FormsModule,\n+┊  ┊45┊    // Feature modules\n+┊  ┊46┊    SharedModule,\n+┊  ┊47┊  ],\n+┊  ┊48┊  providers: [\n+┊  ┊49┊    ChatsService,\n+┊  ┊50┊  ],\n+┊  ┊51┊})\n+┊  ┊52┊export class ChatViewerModule {\n+┊  ┊53┊}\n```\n\n[}]: #\n\nAs you can see, it has already everything that we might need.\n\n### GetChat operation\n\nComponents need data, so we create the `GetChat` operation and run `yarn generator`:\n\n[{]: <helper> (diffStep \"4.1\" files=\"src/graphql/getChat.query.ts\" module=\"client\")\n\n#### [Step 4.1: Chat Viewer](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/257159a)\n\n##### Added src&#x2F;graphql&#x2F;getChat.query.ts\n```diff\n@@ -0,0 +1,17 @@\n+┊  ┊ 1┊import gql from 'graphql-tag';\n+┊  ┊ 2┊import {fragments} from './fragment';\n+┊  ┊ 3┊\n+┊  ┊ 4┊// We use the gql tag to parse our query string into a query document\n+┊  ┊ 5┊export const getChatQuery = gql`\n+┊  ┊ 6┊  query GetChat($chatId: ID!) {\n+┊  ┊ 7┊    chat(chatId: $chatId) {\n+┊  ┊ 8┊      ...ChatWithoutMessages\n+┊  ┊ 9┊      messages {\n+┊  ┊10┊        ...Message\n+┊  ┊11┊      }\n+┊  ┊12┊    }\n+┊  ┊13┊  }\n+┊  ┊14┊\n+┊  ┊15┊  ${fragments['chatWithoutMessages']}\n+┊  ┊16┊  ${fragments['message']}\n+┊  ┊17┊`;\n```\n\n[}]: #\n\nThe query can be now implemented in `ChatsService`:\n\n[{]: <helper> (diffStep \"4.1\" files=\"src/app/services/chats.service.ts\" module=\"client\")\n\n#### [Step 4.1: Chat Viewer](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/257159a)\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,13 +1,14 @@\n ┊ 1┊ 1┊import {map} from 'rxjs/operators';\n ┊ 2┊ 2┊import {Injectable} from '@angular/core';\n-┊ 3┊  ┊import {GetChatsGQL} from '../../graphql';\n+┊  ┊ 3┊import {GetChatsGQL, GetChatGQL} from '../../graphql';\n ┊ 4┊ 4┊\n ┊ 5┊ 5┊@Injectable()\n ┊ 6┊ 6┊export class ChatsService {\n ┊ 7┊ 7┊  messagesAmount = 3;\n ┊ 8┊ 8┊\n ┊ 9┊ 9┊  constructor(\n-┊10┊  ┊    private getChatsGQL: GetChatsGQL\n+┊  ┊10┊    private getChatsGQL: GetChatsGQL,\n+┊  ┊11┊    private getChatGQL: GetChatGQL\n ┊11┊12┊  ) {}\n ┊12┊13┊\n ┊13┊14┊  getChats() {\n```\n```diff\n@@ -20,4 +21,16 @@\n ┊20┊21┊\n ┊21┊22┊    return {query, chats$};\n ┊22┊23┊  }\n+┊  ┊24┊\n+┊  ┊25┊  getChat(chatId: string) {\n+┊  ┊26┊    const query = this.getChatGQL.watch({\n+┊  ┊27┊      chatId: chatId,\n+┊  ┊28┊    });\n+┊  ┊29┊\n+┊  ┊30┊    const chat$ = query.valueChanges.pipe(\n+┊  ┊31┊      map((result) => result.data.chat)\n+┊  ┊32┊    );\n+┊  ┊33┊\n+┊  ┊34┊    return {query, chat$};\n+┊  ┊35┊  }\n ┊23┊36┊}\n```\n\n[}]: #\n\nGreat!\n\n### Chat view\n\nNow we've got data but a user can't still access the chat view.\nThere is one place where we're able to pick the chat, it's the list:\n\n[{]: <helper> (diffStep \"4.1\" files=\"src/app/chats-lister/components/chat-item/chat-item.component.ts, src/app/chats-lister/components/chats-list/chats-list.component.ts, src/app/chats-lister/containers/chats/chats.component.ts\" module=\"client\")\n\n#### [Step 4.1: Chat Viewer](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/257159a)\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chat-item&#x2F;chat-item.component.ts\n```diff\n@@ -1,14 +1,14 @@\n-┊ 1┊  ┊import {Component, Input} from '@angular/core';\n+┊  ┊ 1┊import {Component, EventEmitter, Input, Output} from '@angular/core';\n ┊ 2┊ 2┊import {GetChats} from '../../../../graphql';\n ┊ 3┊ 3┊\n ┊ 4┊ 4┊@Component({\n ┊ 5┊ 5┊  selector: 'app-chat-item',\n ┊ 6┊ 6┊  template: `\n-┊ 7┊  ┊    <div class=\"chat-row\">\n+┊  ┊ 7┊    <div class=\"chat-row\" (click)=\"selectChat()\">\n ┊ 8┊ 8┊      <img class=\"chat-pic\" [src]=\"chat.picture || 'assets/default-profile-pic.jpg'\">\n ┊ 9┊ 9┊      <div class=\"chat-info\">\n ┊10┊10┊        <div class=\"chat-name\">{{ chat.name }}</div>\n-┊11┊  ┊        <div class=\"chat-last-message\">{{ chat.messages?[chat.messages?.length - 1]?.content }}</div>\n+┊  ┊11┊        <div class=\"chat-last-message\">{{ chat.messages[chat.messages.length - 1]?.content }}</div>\n ┊12┊12┊        <div class=\"chat-timestamp\">00:00</div>\n ┊13┊13┊      </div>\n ┊14┊14┊    </div>\n```\n```diff\n@@ -19,4 +19,11 @@\n ┊19┊19┊  // tslint:disable-next-line:no-input-rename\n ┊20┊20┊  @Input('item')\n ┊21┊21┊  chat: GetChats.Chats;\n+┊  ┊22┊\n+┊  ┊23┊  @Output()\n+┊  ┊24┊  select = new EventEmitter<string>();\n+┊  ┊25┊\n+┊  ┊26┊  selectChat() {\n+┊  ┊27┊    this.select.emit(this.chat.id);\n+┊  ┊28┊  }\n ┊22┊29┊}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chats-list&#x2F;chats-list.component.ts\n```diff\n@@ -1,4 +1,4 @@\n-┊1┊ ┊import {Component, Input} from '@angular/core';\n+┊ ┊1┊import {Component, EventEmitter, Input, Output} from '@angular/core';\n ┊2┊2┊import {GetChats} from '../../../../graphql';\n ┊3┊3┊\n ┊4┊4┊@Component({\n```\n```diff\n@@ -6,7 +6,7 @@\n ┊ 6┊ 6┊  template: `\n ┊ 7┊ 7┊    <mat-list>\n ┊ 8┊ 8┊      <mat-list-item *ngFor=\"let chat of chats\">\n-┊ 9┊  ┊        <app-chat-item [item]=\"chat\"></app-chat-item>\n+┊  ┊ 9┊        <app-chat-item [item]=\"chat\" (select)=\"selectChat($event)\"></app-chat-item>\n ┊10┊10┊      </mat-list-item>\n ┊11┊11┊    </mat-list>\n ┊12┊12┊  `,\n```\n```diff\n@@ -17,5 +17,12 @@\n ┊17┊17┊  @Input('items')\n ┊18┊18┊  chats: GetChats.Chats[];\n ┊19┊19┊\n+┊  ┊20┊  @Output()\n+┊  ┊21┊  select = new EventEmitter<string>();\n+┊  ┊22┊\n ┊20┊23┊  constructor() {}\n+┊  ┊24┊\n+┊  ┊25┊  selectChat(id: string) {\n+┊  ┊26┊    this.select.emit(id);\n+┊  ┊27┊  }\n ┊21┊28┊}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.ts\n```diff\n@@ -2,6 +2,7 @@\n ┊2┊2┊import {ChatsService} from '../../../services/chats.service';\n ┊3┊3┊import {Observable} from 'rxjs';\n ┊4┊4┊import {GetChats} from '../../../../graphql';\n+┊ ┊5┊import {Router} from '@angular/router';\n ┊5┊6┊\n ┊6┊7┊@Component({\n ┊7┊8┊  template: `\n```\n```diff\n@@ -27,7 +28,7 @@\n ┊27┊28┊      </button>\n ┊28┊29┊    </mat-menu>\n ┊29┊30┊\n-┊30┊  ┊    <app-chats-list [items]=\"chats$ | async\"></app-chats-list>\n+┊  ┊31┊    <app-chats-list [items]=\"chats$ | async\" (select)=\"goToChat($event)\"></app-chats-list>\n ┊31┊32┊\n ┊32┊33┊    <button class=\"chat-button\" mat-fab color=\"secondary\">\n ┊33┊34┊      <mat-icon aria-label=\"Icon-button with a + icon\">chat</mat-icon>\n```\n```diff\n@@ -38,10 +39,15 @@\n ┊38┊39┊export class ChatsComponent implements OnInit {\n ┊39┊40┊  chats$: Observable<GetChats.Chats[]>;\n ┊40┊41┊\n-┊41┊  ┊  constructor(private chatsService: ChatsService) {\n+┊  ┊42┊  constructor(private chatsService: ChatsService,\n+┊  ┊43┊              private router: Router) {\n ┊42┊44┊  }\n ┊43┊45┊\n ┊44┊46┊  ngOnInit() {\n ┊45┊47┊    this.chats$ = this.chatsService.getChats().chats$;\n ┊46┊48┊  }\n+┊  ┊49┊\n+┊  ┊50┊  goToChat(chatId: string) {\n+┊  ┊51┊    this.router.navigate(['/chat', chatId]);\n+┊  ┊52┊  }\n ┊47┊53┊}\n```\n\n[}]: #\n\nTime for a next step, an actual implementation of the chat view.\n\n[{]: <helper> (diffStep \"4.1\" files=\"src/app/chat-viewer/containers/chat/chat.component.ts, src/app/chat-viewer/containers/chat/chat.component.scss\" module=\"client\")\n\n#### [Step 4.1: Chat Viewer](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/257159a)\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.scss\n```diff\n@@ -0,0 +1,33 @@\n+┊  ┊ 1┊app-toolbar {\n+┊  ┊ 2┊  .navigation {\n+┊  ┊ 3┊    padding: 0;\n+┊  ┊ 4┊    display: inherit;\n+┊  ┊ 5┊    margin-right: -40px;\n+┊  ┊ 6┊  }\n+┊  ┊ 7┊\n+┊  ┊ 8┊  .title {\n+┊  ┊ 9┊    line-height: 8vh;\n+┊  ┊10┊  }\n+┊  ┊11┊\n+┊  ┊12┊  .profile-pic {\n+┊  ┊13┊    height: calc(100% - 10px);\n+┊  ┊14┊    width: auto;\n+┊  ┊15┊    padding: 5px;\n+┊  ┊16┊    border-radius: 50%;\n+┊  ┊17┊  }\n+┊  ┊18┊}\n+┊  ┊19┊\n+┊  ┊20┊.container {\n+┊  ┊21┊  display: flex;\n+┊  ┊22┊  flex-flow: column;\n+┊  ┊23┊  justify-content: space-between;\n+┊  ┊24┊  height: calc(100vh - 8vh);\n+┊  ┊25┊  background-image: url(/assets/chat-background.jpg);\n+┊  ┊26┊  background-color: #E0DAD6;\n+┊  ┊27┊  background-repeat: no-repeat;\n+┊  ┊28┊  background-size: cover;\n+┊  ┊29┊\n+┊  ┊30┊  app-confirm-selection {\n+┊  ┊31┊    bottom: 10vh;\n+┊  ┊32┊  }\n+┊  ┊33┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.ts\n```diff\n@@ -0,0 +1,46 @@\n+┊  ┊ 1┊import {Component, OnInit} from '@angular/core';\n+┊  ┊ 2┊import {ActivatedRoute, Router} from '@angular/router';\n+┊  ┊ 3┊import {ChatsService} from '../../../services/chats.service';\n+┊  ┊ 4┊\n+┊  ┊ 5┊@Component({\n+┊  ┊ 6┊  template: `\n+┊  ┊ 7┊    <app-toolbar>\n+┊  ┊ 8┊      <button class=\"navigation\" mat-button (click)=\"goToChats()\">\n+┊  ┊ 9┊        <mat-icon aria-label=\"Icon-button with an arrow back icon\">arrow_back</mat-icon>\n+┊  ┊10┊      </button>\n+┊  ┊11┊      <img class=\"profile-pic\" src=\"assets/default-profile-pic.jpg\">\n+┊  ┊12┊      <div class=\"title\">{{ name }}</div>\n+┊  ┊13┊    </app-toolbar>\n+┊  ┊14┊    <div class=\"container\">\n+┊  ┊15┊      <app-messages-list [items]=\"messages\" [isGroup]=\"isGroup\"></app-messages-list>\n+┊  ┊16┊      <app-new-message></app-new-message>\n+┊  ┊17┊    </div>\n+┊  ┊18┊  `,\n+┊  ┊19┊  styleUrls: ['./chat.component.scss']\n+┊  ┊20┊})\n+┊  ┊21┊export class ChatComponent implements OnInit {\n+┊  ┊22┊  chatId: string;\n+┊  ┊23┊  messages: any[];\n+┊  ┊24┊  name: string;\n+┊  ┊25┊  isGroup: boolean;\n+┊  ┊26┊\n+┊  ┊27┊  constructor(private route: ActivatedRoute,\n+┊  ┊28┊              private router: Router,\n+┊  ┊29┊              private chatsService: ChatsService) {\n+┊  ┊30┊  }\n+┊  ┊31┊\n+┊  ┊32┊  ngOnInit() {\n+┊  ┊33┊    this.route.params.subscribe(({id: chatId}) => {\n+┊  ┊34┊      this.chatId = chatId;\n+┊  ┊35┊      this.chatsService.getChat(chatId).chat$.subscribe(chat => {\n+┊  ┊36┊        this.messages = chat.messages;\n+┊  ┊37┊        this.name = chat.name;\n+┊  ┊38┊        this.isGroup = chat.isGroup;\n+┊  ┊39┊      });\n+┊  ┊40┊    });\n+┊  ┊41┊  }\n+┊  ┊42┊\n+┊  ┊43┊  goToChats() {\n+┊  ┊44┊    this.router.navigate(['/chats']);\n+┊  ┊45┊  }\n+┊  ┊46┊}\n```\n\n[}]: #\n\nThe `ChatComponent` component contains:\n\n - Toolbar with chat's name and a \"go back\" button\n - List of messages sorted from oldest to newest\n - Space to submit a new message\n\n### List of messages\n\nFirst we'll download and a couple of images which will help us create a \"bubble\" effect for received messages:\n\n    $ wget https://raw.githubusercontent.com/Urigo/whatsapp-client-angularcli-material/c75c2416b1990da3588015f76b8338764f44d6ec/src/assets/chat-background.jpg -P src/assets\n    $ wget https://raw.githubusercontent.com/Urigo/whatsapp-client-angularcli-material/https://raw.githubusercontent.com/Urigo/whatsapp-client-angularcli-material/c75c2416b1990da3588015f76b8338764f44d6ec/src/assets/chat-background.jpg/src/assets/message-mine.png -P src/assets\n    $ wget https://raw.githubusercontent.com/Urigo/whatsapp-client-angularcli-material/https://raw.githubusercontent.com/Urigo/whatsapp-client-angularcli-material/c75c2416b1990da3588015f76b8338764f44d6ec/src/assets/chat-background.jpg/src/assets/message-other.png -P src/assets\n\nWe'll now split the list of messages to the host:\n\n[{]: <helper> (diffStep \"4.1\" files=\"src/app/chat-viewer/components/messages-list/messages-list.component.ts, src/app/chat-viewer/components/messages-list/messages-list.component.scss\" module=\"client\")\n\n#### [Step 4.1: Chat Viewer](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/257159a)\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;components&#x2F;messages-list&#x2F;messages-list.component.scss\n```diff\n@@ -0,0 +1,14 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊  height: 100%;\n+┊  ┊ 4┊}\n+┊  ┊ 5┊\n+┊  ┊ 6┊::ng-deep .mat-list-item-content {\n+┊  ┊ 7┊  display: block !important;\n+┊  ┊ 8┊}\n+┊  ┊ 9┊\n+┊  ┊10┊/*\n+┊  ┊11┊:host::-webkit-scrollbar {\n+┊  ┊12┊  display: none;\n+┊  ┊13┊}\n+┊  ┊14┊*/🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;components&#x2F;messages-list&#x2F;messages-list.component.ts\n```diff\n@@ -0,0 +1,23 @@\n+┊  ┊ 1┊import {Component, Input} from '@angular/core';\n+┊  ┊ 2┊\n+┊  ┊ 3┊@Component({\n+┊  ┊ 4┊  selector: 'app-messages-list',\n+┊  ┊ 5┊  template: `\n+┊  ┊ 6┊    <mat-list>\n+┊  ┊ 7┊      <mat-list-item *ngFor=\"let message of messages\">\n+┊  ┊ 8┊        <app-message-item [item]=\"message\" [isGroup]=\"isGroup\"></app-message-item>\n+┊  ┊ 9┊      </mat-list-item>\n+┊  ┊10┊    </mat-list>\n+┊  ┊11┊  `,\n+┊  ┊12┊  styleUrls: ['messages-list.component.scss'],\n+┊  ┊13┊})\n+┊  ┊14┊export class MessagesListComponent {\n+┊  ┊15┊  // tslint:disable-next-line:no-input-rename\n+┊  ┊16┊  @Input('items')\n+┊  ┊17┊  messages: any[];\n+┊  ┊18┊\n+┊  ┊19┊  @Input()\n+┊  ┊20┊  isGroup: boolean;\n+┊  ┊21┊\n+┊  ┊22┊  constructor() {}\n+┊  ┊23┊}\n```\n\n[}]: #\n\nand a reused component for each message:\n\n[{]: <helper> (diffStep \"4.1\" files=\"src/app/chat-viewer/components/message-item/message-item.component.ts, src/app/chat-viewer/components/message-item/message-item.component.scss\" module=\"client\")\n\n#### [Step 4.1: Chat Viewer](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/257159a)\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;components&#x2F;message-item&#x2F;message-item.component.scss\n```diff\n@@ -0,0 +1,66 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  margin-bottom: 9px;\n+┊  ┊ 3┊\n+┊  ┊ 4┊  &::after {\n+┊  ┊ 5┊    content: \"\";\n+┊  ┊ 6┊    display: table;\n+┊  ┊ 7┊    clear: both;\n+┊  ┊ 8┊  }\n+┊  ┊ 9┊}\n+┊  ┊10┊\n+┊  ┊11┊.message {\n+┊  ┊12┊  display: inline-block;\n+┊  ┊13┊  position: relative;\n+┊  ┊14┊  max-width: 100%;\n+┊  ┊15┊  border-radius: 7px;\n+┊  ┊16┊  box-shadow: 0 1px 2px rgba(0, 0, 0, .15);\n+┊  ┊17┊\n+┊  ┊18┊  &.message-mine {\n+┊  ┊19┊    float: right;\n+┊  ┊20┊    background-color: #DCF8C6;\n+┊  ┊21┊\n+┊  ┊22┊    &::before {\n+┊  ┊23┊      right: -11px;\n+┊  ┊24┊      background-image: url(/assets/message-mine.png)\n+┊  ┊25┊    }\n+┊  ┊26┊  }\n+┊  ┊27┊\n+┊  ┊28┊  &.message-other {\n+┊  ┊29┊    float: left;\n+┊  ┊30┊    background-color: #FFF;\n+┊  ┊31┊\n+┊  ┊32┊    &::before {\n+┊  ┊33┊      left: -11px;\n+┊  ┊34┊      background-image: url(/assets/message-other.png)\n+┊  ┊35┊    }\n+┊  ┊36┊  }\n+┊  ┊37┊\n+┊  ┊38┊  &.message-other::before, &.message-mine::before {\n+┊  ┊39┊    content: \"\";\n+┊  ┊40┊    position: absolute;\n+┊  ┊41┊    bottom: 3px;\n+┊  ┊42┊    width: 12px;\n+┊  ┊43┊    height: 19px;\n+┊  ┊44┊    background-position: 50% 50%;\n+┊  ┊45┊    background-repeat: no-repeat;\n+┊  ┊46┊    background-size: contain;\n+┊  ┊47┊  }\n+┊  ┊48┊\n+┊  ┊49┊  .message-content {\n+┊  ┊50┊    padding: 5px 7px;\n+┊  ┊51┊    word-wrap: break-word;\n+┊  ┊52┊\n+┊  ┊53┊    &::after {\n+┊  ┊54┊      content: \" \\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\";\n+┊  ┊55┊      display: inline;\n+┊  ┊56┊    }\n+┊  ┊57┊  }\n+┊  ┊58┊\n+┊  ┊59┊  .message-timestamp {\n+┊  ┊60┊    position: absolute;\n+┊  ┊61┊    bottom: 2px;\n+┊  ┊62┊    right: 7px;\n+┊  ┊63┊    color: gray;\n+┊  ┊64┊    font-size: 12px;\n+┊  ┊65┊  }\n+┊  ┊66┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;components&#x2F;message-item&#x2F;message-item.component.ts\n```diff\n@@ -0,0 +1,22 @@\n+┊  ┊ 1┊import {Component, Input} from '@angular/core';\n+┊  ┊ 2┊\n+┊  ┊ 3┊@Component({\n+┊  ┊ 4┊  selector: 'app-message-item',\n+┊  ┊ 5┊  template: `\n+┊  ┊ 6┊    <div class=\"message\"\n+┊  ┊ 7┊         [ngClass]=\"message.ownership ? 'message-mine' : 'message-other'\">\n+┊  ┊ 8┊      <div *ngIf=\"isGroup && !message.ownership\" class=\"message-sender\">{{ message.sender.name }}</div>\n+┊  ┊ 9┊      <div class=\"message-content\">{{ message.content }}</div>\n+┊  ┊10┊      <span class=\"message-timestamp\">00:00</span>\n+┊  ┊11┊    </div>\n+┊  ┊12┊  `,\n+┊  ┊13┊  styleUrls: ['message-item.component.scss'],\n+┊  ┊14┊})\n+┊  ┊15┊export class MessageItemComponent {\n+┊  ┊16┊  // tslint:disable-next-line:no-input-rename\n+┊  ┊17┊  @Input('item')\n+┊  ┊18┊  message: any;\n+┊  ┊19┊\n+┊  ┊20┊  @Input()\n+┊  ┊21┊  isGroup: boolean;\n+┊  ┊22┊}\n```\n\n[}]: #\n\nAs you see, we could easily decide which message comes from which user based on the `ownership` property.\n\n### Submit a new message\n\nThe app shows the conversation and now we're going to focus on the last part, actually emitting a new message!\n\n[{]: <helper> (diffStep \"4.1\" files=\"src/app/chat-viewer/components/new-message/new-message.component.scss, src/app/chat-viewer/components/new-message/new-message.component.ts\" module=\"client\")\n\n#### [Step 4.1: Chat Viewer](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/257159a)\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;components&#x2F;new-message&#x2F;new-message.component.scss\n```diff\n@@ -0,0 +1,32 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: flex;\n+┊  ┊ 3┊  height: 50px;\n+┊  ┊ 4┊  padding: 5px;\n+┊  ┊ 5┊}\n+┊  ┊ 6┊\n+┊  ┊ 7┊input {\n+┊  ┊ 8┊  width: 100%;\n+┊  ┊ 9┊  border: none;\n+┊  ┊10┊  border-radius: 999px;\n+┊  ┊11┊  padding: 10px;\n+┊  ┊12┊  padding-left: 20px;\n+┊  ┊13┊  padding-right: 20px;\n+┊  ┊14┊  font-size: 15px;\n+┊  ┊15┊  outline: none;\n+┊  ┊16┊  box-shadow: 0 1px silver;\n+┊  ┊17┊  font-size: 18px;\n+┊  ┊18┊  line-height: 45px;\n+┊  ┊19┊}\n+┊  ┊20┊\n+┊  ┊21┊button {\n+┊  ┊22┊  min-width: 45px;\n+┊  ┊23┊  width: 45px;\n+┊  ┊24┊  border-radius: 999px;\n+┊  ┊25┊  background-color: var(--primary);\n+┊  ┊26┊  margin-left: 5px;\n+┊  ┊27┊  color: white;\n+┊  ┊28┊\n+┊  ┊29┊  mat-icon {\n+┊  ┊30┊    margin-left: -3px;\n+┊  ┊31┊  }\n+┊  ┊32┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;components&#x2F;new-message&#x2F;new-message.component.ts\n```diff\n@@ -0,0 +1,34 @@\n+┊  ┊ 1┊import {Component, EventEmitter, Input, Output} from '@angular/core';\n+┊  ┊ 2┊\n+┊  ┊ 3┊@Component({\n+┊  ┊ 4┊  selector: 'app-new-message',\n+┊  ┊ 5┊  template: `\n+┊  ┊ 6┊    <input type=\"text\" placeholder=\"Type a message\" [(ngModel)]=\"message\" (keyup)=\"onInputKeyup($event)\"/>\n+┊  ┊ 7┊    <button mat-button (click)=\"emitMessage()\" [disabled]=\"disabled\">\n+┊  ┊ 8┊      <mat-icon aria-label=\"Icon-button with a send icon\">send</mat-icon>\n+┊  ┊ 9┊    </button>\n+┊  ┊10┊  `,\n+┊  ┊11┊  styleUrls: ['new-message.component.scss'],\n+┊  ┊12┊})\n+┊  ┊13┊export class NewMessageComponent {\n+┊  ┊14┊  @Input()\n+┊  ┊15┊  disabled: boolean;\n+┊  ┊16┊\n+┊  ┊17┊  @Output()\n+┊  ┊18┊  newMessage = new EventEmitter<string>();\n+┊  ┊19┊\n+┊  ┊20┊  message = '';\n+┊  ┊21┊\n+┊  ┊22┊  onInputKeyup({ keyCode }: KeyboardEvent) {\n+┊  ┊23┊    if (keyCode === 13) {\n+┊  ┊24┊      this.emitMessage();\n+┊  ┊25┊    }\n+┊  ┊26┊  }\n+┊  ┊27┊\n+┊  ┊28┊  emitMessage() {\n+┊  ┊29┊    if (this.message && !this.disabled) {\n+┊  ┊30┊      this.newMessage.emit(this.message);\n+┊  ┊31┊      this.message = '';\n+┊  ┊32┊    }\n+┊  ┊33┊  }\n+┊  ┊34┊}\n```\n\n[}]: #\n\nIt's not yet fully functional, we receive the message in the `ChatComponent` but we still need to send it to the server. We'll cover that in next few steps!"
          },
          {
            "manualTitle": "Step 9: Mutations",
            "stepRevision": "fcbc9a30cfdd7004eabc050189a94dad094e2ed7",
            "manualView": "In addition to fetching data using queries, Apollo also helps you handle GraphQL mutations. In GraphQL, mutations are identical to queries in syntax, the only difference being that you use the keyword mutation instead of query to indicate that the root fields on this query are going to be performing writes to the backend.\nGraphQL mutations represent two things in one query string:\n\n1. The mutation field name with arguments, which represents the actual operation to be done on the server.\n2. The fields you want back from the result of the mutation to update the client.\n\nWhen we use mutations in Apollo, the result is typically integrated into the cache automatically based on the id of the result, which in turn updates the UI automatically, so we often don't need to explicitly handle the results. In order for the client to correctly do this, we need to ensure we select the necessary fields in the result. One good strategy can be to simply ask for any fields that might have been affected by the mutation. Alternatively, you can use fragments to share the fields between a query and a mutation that updates that query.\n\n## Server\n\nFinally we're going to create our mutations in the server:\n\n[{]: <helper> (diffStep \"3.1\" module=\"server\")\n\n#### [Step 3.1: Add mutations](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/db205b7)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,6 +1,7 @@\n ┊1┊1┊import { IResolvers } from 'apollo-server-express';\n-┊2┊ ┊import { Chat, db, Message, Recipient, User } from \"../db\";\n+┊ ┊2┊import { Chat, db, Message, MessageType, Recipient, User } from \"../db\";\n ┊3┊3┊import { ChatQueryArgs } from \"../types\";\n+┊ ┊4┊import * as moment from \"moment\";\n ┊4┊5┊\n ┊5┊6┊let users = db.users;\n ┊6┊7┊let chats = db.chats;\n```\n```diff\n@@ -13,6 +14,276 @@\n ┊ 13┊ 14┊    chats: (): Chat[] => chats.filter(chat => chat.listingMemberIds.includes(currentUser)),\n ┊ 14┊ 15┊    chat: (obj: any, {chatId}: ChatQueryArgs): Chat | null => chats.find(chat => chat.id === Number(chatId)) || null,\n ┊ 15┊ 16┊  },\n+┊   ┊ 17┊  Mutation: {\n+┊   ┊ 18┊    addChat: (obj: any, {recipientId}: any): Chat => {\n+┊   ┊ 19┊      if (!users.find(user => user.id === recipientId)) {\n+┊   ┊ 20┊        throw new Error(`Recipient ${recipientId} doesn't exist.`);\n+┊   ┊ 21┊      }\n+┊   ┊ 22┊\n+┊   ┊ 23┊      const chat = chats.find(chat => !chat.name && chat.allTimeMemberIds.includes(currentUser) && chat.allTimeMemberIds.includes(recipientId));\n+┊   ┊ 24┊      if (chat) {\n+┊   ┊ 25┊        // Chat already exists. Both users are already in the allTimeMemberIds array\n+┊   ┊ 26┊        const chatId = chat.id;\n+┊   ┊ 27┊        if (!chat.listingMemberIds.includes(currentUser)) {\n+┊   ┊ 28┊          // The chat isn't listed for the current user. Add him to the memberIds\n+┊   ┊ 29┊          chat.listingMemberIds.push(currentUser);\n+┊   ┊ 30┊          chats.find(chat => chat.id === chatId)!.listingMemberIds.push(currentUser);\n+┊   ┊ 31┊          return chat;\n+┊   ┊ 32┊        } else {\n+┊   ┊ 33┊          throw new Error(`Chat already exists.`);\n+┊   ┊ 34┊        }\n+┊   ┊ 35┊      } else {\n+┊   ┊ 36┊        // Create the chat\n+┊   ┊ 37┊        const id = (chats.length && chats[chats.length - 1].id + 1) || 1;\n+┊   ┊ 38┊        const chat: Chat = {\n+┊   ┊ 39┊          id,\n+┊   ┊ 40┊          name: null,\n+┊   ┊ 41┊          picture: null,\n+┊   ┊ 42┊          adminIds: null,\n+┊   ┊ 43┊          ownerId: null,\n+┊   ┊ 44┊          allTimeMemberIds: [currentUser, recipientId],\n+┊   ┊ 45┊          // Chat will not be listed to the other user until the first message gets written\n+┊   ┊ 46┊          listingMemberIds: [currentUser],\n+┊   ┊ 47┊          actualGroupMemberIds: null,\n+┊   ┊ 48┊          messages: [],\n+┊   ┊ 49┊        };\n+┊   ┊ 50┊        chats.push(chat);\n+┊   ┊ 51┊        return chat;\n+┊   ┊ 52┊      }\n+┊   ┊ 53┊    },\n+┊   ┊ 54┊    addGroup: (obj: any, {recipientIds, groupName}: any): Chat => {\n+┊   ┊ 55┊      recipientIds.forEach((recipientId: any) => {\n+┊   ┊ 56┊        if (!users.find(user => user.id === recipientId)) {\n+┊   ┊ 57┊          throw new Error(`Recipient ${recipientId} doesn't exist.`);\n+┊   ┊ 58┊        }\n+┊   ┊ 59┊      });\n+┊   ┊ 60┊\n+┊   ┊ 61┊      const id = (chats.length && chats[chats.length - 1].id + 1) || 1;\n+┊   ┊ 62┊      const chat: Chat = {\n+┊   ┊ 63┊        id,\n+┊   ┊ 64┊        name: groupName,\n+┊   ┊ 65┊        picture: null,\n+┊   ┊ 66┊        adminIds: [currentUser],\n+┊   ┊ 67┊        ownerId: currentUser,\n+┊   ┊ 68┊        allTimeMemberIds: [currentUser, ...recipientIds],\n+┊   ┊ 69┊        listingMemberIds: [currentUser, ...recipientIds],\n+┊   ┊ 70┊        actualGroupMemberIds: [currentUser, ...recipientIds],\n+┊   ┊ 71┊        messages: [],\n+┊   ┊ 72┊      };\n+┊   ┊ 73┊      chats.push(chat);\n+┊   ┊ 74┊      return chat;\n+┊   ┊ 75┊    },\n+┊   ┊ 76┊    removeChat: (obj: any, {chatId}: any): number => {\n+┊   ┊ 77┊      const chat = chats.find(chat => chat.id === chatId);\n+┊   ┊ 78┊\n+┊   ┊ 79┊      if (!chat) {\n+┊   ┊ 80┊        throw new Error(`The chat ${chatId} doesn't exist.`);\n+┊   ┊ 81┊      }\n+┊   ┊ 82┊\n+┊   ┊ 83┊      if (!chat.name) {\n+┊   ┊ 84┊        // Chat\n+┊   ┊ 85┊        if (!chat.listingMemberIds.includes(currentUser)) {\n+┊   ┊ 86┊          throw new Error(`The user is not a member of the chat ${chatId}.`);\n+┊   ┊ 87┊        }\n+┊   ┊ 88┊\n+┊   ┊ 89┊        // Instead of chaining map and filter we can loop once using reduce\n+┊   ┊ 90┊        const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n+┊   ┊ 91┊          // Remove the current user from the message holders\n+┊   ┊ 92┊          message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser);\n+┊   ┊ 93┊\n+┊   ┊ 94┊          if (message.holderIds.length !== 0) {\n+┊   ┊ 95┊            filtered.push(message);\n+┊   ┊ 96┊          } // else discard the message\n+┊   ┊ 97┊\n+┊   ┊ 98┊          return filtered;\n+┊   ┊ 99┊        }, []);\n+┊   ┊100┊\n+┊   ┊101┊        // Remove the current user from who gets the chat listed. The chat will no longer appear in his list\n+┊   ┊102┊        const listingMemberIds = chat.listingMemberIds.filter(listingId => listingId !== currentUser);\n+┊   ┊103┊\n+┊   ┊104┊        // Check how many members are left\n+┊   ┊105┊        if (listingMemberIds.length === 0) {\n+┊   ┊106┊          // Delete the chat\n+┊   ┊107┊          chats = chats.filter(chat => chat.id !== chatId);\n+┊   ┊108┊        } else {\n+┊   ┊109┊          // Update the chat\n+┊   ┊110┊          chats = chats.map(chat => {\n+┊   ┊111┊            if (chat.id === chatId) {\n+┊   ┊112┊              chat = {...chat, listingMemberIds, messages};\n+┊   ┊113┊            }\n+┊   ┊114┊            return chat;\n+┊   ┊115┊          });\n+┊   ┊116┊        }\n+┊   ┊117┊        return chatId;\n+┊   ┊118┊      } else {\n+┊   ┊119┊        // Group\n+┊   ┊120┊        if (chat.ownerId !== currentUser) {\n+┊   ┊121┊          throw new Error(`Group ${chatId} is not owned by the user.`);\n+┊   ┊122┊        }\n+┊   ┊123┊\n+┊   ┊124┊        // Instead of chaining map and filter we can loop once using reduce\n+┊   ┊125┊        const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n+┊   ┊126┊          // Remove the current user from the message holders\n+┊   ┊127┊          message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser);\n+┊   ┊128┊\n+┊   ┊129┊          if (message.holderIds.length !== 0) {\n+┊   ┊130┊            filtered.push(message);\n+┊   ┊131┊          } // else discard the message\n+┊   ┊132┊\n+┊   ┊133┊          return filtered;\n+┊   ┊134┊        }, []);\n+┊   ┊135┊\n+┊   ┊136┊        // Remove the current user from who gets the group listed. The group will no longer appear in his list\n+┊   ┊137┊        const listingMemberIds = chat.listingMemberIds.filter(listingId => listingId !== currentUser);\n+┊   ┊138┊\n+┊   ┊139┊        // Check how many members (including previous ones who can still access old messages) are left\n+┊   ┊140┊        if (listingMemberIds.length === 0) {\n+┊   ┊141┊          // Remove the group\n+┊   ┊142┊          chats = chats.filter(chat => chat.id !== chatId);\n+┊   ┊143┊        } else {\n+┊   ┊144┊          // Update the group\n+┊   ┊145┊\n+┊   ┊146┊          // Remove the current user from the chat members. He is no longer a member of the group\n+┊   ┊147┊          const actualGroupMemberIds = chat.actualGroupMemberIds!.filter(memberId => memberId !== currentUser);\n+┊   ┊148┊          // Remove the current user from the chat admins\n+┊   ┊149┊          const adminIds = chat.adminIds!.filter(memberId => memberId !== currentUser);\n+┊   ┊150┊          // Set the owner id to be null. A null owner means the group is read-only\n+┊   ┊151┊          let ownerId: number | null = null;\n+┊   ┊152┊\n+┊   ┊153┊          // Check if there is any admin left\n+┊   ┊154┊          if (adminIds!.length) {\n+┊   ┊155┊            // Pick an admin as the new owner. The group is no longer read-only\n+┊   ┊156┊            ownerId = chat.adminIds![0];\n+┊   ┊157┊          }\n+┊   ┊158┊\n+┊   ┊159┊          chats = chats.map(chat => {\n+┊   ┊160┊            if (chat.id === chatId) {\n+┊   ┊161┊              chat = {...chat, messages, listingMemberIds, actualGroupMemberIds, adminIds, ownerId};\n+┊   ┊162┊            }\n+┊   ┊163┊            return chat;\n+┊   ┊164┊          });\n+┊   ┊165┊        }\n+┊   ┊166┊        return chatId;\n+┊   ┊167┊      }\n+┊   ┊168┊    },\n+┊   ┊169┊    addMessage: (obj: any, {chatId, content}: any): Message => {\n+┊   ┊170┊      if (content === null || content === '') {\n+┊   ┊171┊        throw new Error(`Cannot add empty or null messages.`);\n+┊   ┊172┊      }\n+┊   ┊173┊\n+┊   ┊174┊      let chat = chats.find(chat => chat.id === chatId);\n+┊   ┊175┊\n+┊   ┊176┊      if (!chat) {\n+┊   ┊177┊        throw new Error(`Cannot find chat ${chatId}.`);\n+┊   ┊178┊      }\n+┊   ┊179┊\n+┊   ┊180┊      let holderIds = chat.listingMemberIds;\n+┊   ┊181┊\n+┊   ┊182┊      if (!chat.name) {\n+┊   ┊183┊        // Chat\n+┊   ┊184┊        if (!chat.listingMemberIds.find(listingId => listingId === currentUser)) {\n+┊   ┊185┊          throw new Error(`The chat ${chatId} must be listed for the current user before adding a message.`);\n+┊   ┊186┊        }\n+┊   ┊187┊\n+┊   ┊188┊        const recipientId = chat.allTimeMemberIds.filter(userId => userId !== currentUser)[0];\n+┊   ┊189┊\n+┊   ┊190┊        if (!chat.listingMemberIds.find(listingId => listingId === recipientId)) {\n+┊   ┊191┊          // Chat is not listed for the recipient. Add him to the listingMemberIds\n+┊   ┊192┊          const listingMemberIds = chat.listingMemberIds.concat(recipientId);\n+┊   ┊193┊\n+┊   ┊194┊          chats = chats.map(chat => {\n+┊   ┊195┊            if (chat.id === chatId) {\n+┊   ┊196┊              chat = {...chat, listingMemberIds};\n+┊   ┊197┊            }\n+┊   ┊198┊            return chat;\n+┊   ┊199┊          });\n+┊   ┊200┊\n+┊   ┊201┊          holderIds = listingMemberIds;\n+┊   ┊202┊        }\n+┊   ┊203┊      } else {\n+┊   ┊204┊        // Group\n+┊   ┊205┊        if (!chat.actualGroupMemberIds!.find(memberId => memberId === currentUser)) {\n+┊   ┊206┊          throw new Error(`The user is not a member of the group ${chatId}. Cannot add message.`);\n+┊   ┊207┊        }\n+┊   ┊208┊\n+┊   ┊209┊        holderIds = chat.actualGroupMemberIds!;\n+┊   ┊210┊      }\n+┊   ┊211┊\n+┊   ┊212┊      const id = (chat.messages.length && chat.messages[chat.messages.length - 1].id + 1) || 1;\n+┊   ┊213┊\n+┊   ┊214┊      let recipients: Recipient[] = [];\n+┊   ┊215┊\n+┊   ┊216┊      holderIds.forEach(holderId => {\n+┊   ┊217┊        if (holderId !== currentUser) {\n+┊   ┊218┊          recipients.push({\n+┊   ┊219┊            userId: holderId,\n+┊   ┊220┊            messageId: id,\n+┊   ┊221┊            chatId: chatId,\n+┊   ┊222┊            receivedAt: null,\n+┊   ┊223┊            readAt: null,\n+┊   ┊224┊          });\n+┊   ┊225┊        }\n+┊   ┊226┊      });\n+┊   ┊227┊\n+┊   ┊228┊      const message: Message = {\n+┊   ┊229┊        id,\n+┊   ┊230┊        chatId,\n+┊   ┊231┊        senderId: currentUser,\n+┊   ┊232┊        content,\n+┊   ┊233┊        createdAt: moment().unix(),\n+┊   ┊234┊        type: MessageType.TEXT,\n+┊   ┊235┊        recipients,\n+┊   ┊236┊        holderIds,\n+┊   ┊237┊      };\n+┊   ┊238┊\n+┊   ┊239┊      chats = chats.map(chat => {\n+┊   ┊240┊        if (chat.id === chatId) {\n+┊   ┊241┊          chat = {...chat, messages: chat.messages.concat(message)}\n+┊   ┊242┊        }\n+┊   ┊243┊        return chat;\n+┊   ┊244┊      });\n+┊   ┊245┊\n+┊   ┊246┊      return message;\n+┊   ┊247┊    },\n+┊   ┊248┊    removeMessages: (obj: any, {chatId, messageIds, all}: any): number[] => {\n+┊   ┊249┊      const chat = chats.find(chat => chat.id === chatId);\n+┊   ┊250┊\n+┊   ┊251┊      if (!chat) {\n+┊   ┊252┊        throw new Error(`Cannot find chat ${chatId}.`);\n+┊   ┊253┊      }\n+┊   ┊254┊\n+┊   ┊255┊      if (!chat.listingMemberIds.find(listingId => listingId === currentUser)) {\n+┊   ┊256┊        throw new Error(`The chat/group ${chatId} is not listed for the current user, so there is nothing to delete.`);\n+┊   ┊257┊      }\n+┊   ┊258┊\n+┊   ┊259┊      if (all && messageIds) {\n+┊   ┊260┊        throw new Error(`Cannot specify both 'all' and 'messageIds'.`);\n+┊   ┊261┊      }\n+┊   ┊262┊\n+┊   ┊263┊      let deletedIds: number[] = [];\n+┊   ┊264┊      chats = chats.map(chat => {\n+┊   ┊265┊        if (chat.id === chatId) {\n+┊   ┊266┊          // Instead of chaining map and filter we can loop once using reduce\n+┊   ┊267┊          const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n+┊   ┊268┊            if (all || messageIds!.includes(message.id)) {\n+┊   ┊269┊              deletedIds.push(message.id);\n+┊   ┊270┊              // Remove the current user from the message holders\n+┊   ┊271┊              message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser);\n+┊   ┊272┊            }\n+┊   ┊273┊\n+┊   ┊274┊            if (message.holderIds.length !== 0) {\n+┊   ┊275┊              filtered.push(message);\n+┊   ┊276┊            } // else discard the message\n+┊   ┊277┊\n+┊   ┊278┊            return filtered;\n+┊   ┊279┊          }, []);\n+┊   ┊280┊          chat = {...chat, messages};\n+┊   ┊281┊        }\n+┊   ┊282┊        return chat;\n+┊   ┊283┊      });\n+┊   ┊284┊      return deletedIds;\n+┊   ┊285┊    },\n+┊   ┊286┊  },\n ┊ 16┊287┊  Chat: {\n ┊ 17┊288┊    name: (chat: Chat): string => chat.name ? chat.name : users\n ┊ 18┊289┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser))!.name,\n```\n\n##### Changed schema&#x2F;typeDefs.ts\n```diff\n@@ -65,4 +65,20 @@\n ┊65┊65┊    picture: String\n ┊66┊66┊    phone: String\n ┊67┊67┊  }\n+┊  ┊68┊\n+┊  ┊69┊  type Mutation {\n+┊  ┊70┊    addChat(recipientId: ID!): Chat\n+┊  ┊71┊    addGroup(recipientIds: [ID!]!, groupName: String!): Chat\n+┊  ┊72┊    removeChat(chatId: ID!): ID\n+┊  ┊73┊    addMessage(chatId: ID!, content: String!): Message\n+┊  ┊74┊    removeMessages(chatId: ID!, messageIds: [ID], all: Boolean): [ID]\n+┊  ┊75┊    addMembers(groupId: ID!, userIds: [ID!]!): [ID]\n+┊  ┊76┊    removeMembers(groupId: ID!, userIds: [ID!]!): [ID]\n+┊  ┊77┊    addAdmins(groupId: ID!, userIds: [ID!]!): [ID]\n+┊  ┊78┊    removeAdmins(groupId: ID!, userIds: [ID!]!): [ID]\n+┊  ┊79┊    setGroupName(groupId: ID!): String\n+┊  ┊80┊    setGroupPicture(groupId: ID!): String\n+┊  ┊81┊    markAsReceived(chatId: ID!): Boolean\n+┊  ┊82┊    markAsRead(chatId: ID!): Boolean\n+┊  ┊83┊  }\n ┊68┊84┊`;\n```\n\n[}]: #\n\nLet me briefly explain what's going on here.\nFor each chat/group we store the `allTimeMemberIds`, `listingMemberIds` and `actualGroupMemberIds` properties in our NoSQL-like fake db.\nWhat's the difference between `allTimeMemberIds` and `listingMemberIds`? When a chat gets created only the user who created it will be able too see it, the chat will be displayed to the other user only once the first messaged gets sent. `allTimeMemberIds` is an array which always contain both the users, while `listingMemberIds` contains only the users which get the chat listed (initially the creator, later both users). `actualGroupMemberIds` is only used for groups.\nGroups, instead, get listed by all members immediately since the creation. So initially both `allTimeMemberIds`, `listingMemberIds` and `actualGroupMemberIds` are similar. Later users can leave the group or get deleted (so they will be removed from `actualGroupMemberIds`) but they will still be able to list the group in read-only mode, thus remaining in the `listingMemberIds`. Once they remove the group they will also be remove from the `listingMemberIds` array.\nThat's why we have to check for several different conditions before adding/deleting messages: it could be necessary to add the other peer to the `listingMemberIds` (for example if we are writing the first message of a chat) or it could be necessary to physically remove the messages instead of simply removing the current user from the `holderIds`. `holderIds` is a field in each message which states which user will currently display that specific message. In fact each user can delete a specific message without affecting what the others will see. Once there will be no more users in the `holderIds` array it will be safe to delete the message.\nEach message has also a `recipients` array containing the receiving date and the viewing date of that particular message for all the other users. That's necessary to implement the single, double and blue ticks used by the real Whatsapp.\n\nIt may seem a bit overwhelming at first, but you should keep in mind that the real Whatsapp has tons of features and also takes advantage of a local database to store messages, so it's easier for them to implement features like per-user messages: their source of truth is not the server because once downloaded the messages are kept in the client itself, so deleting messages doesn't affect anyone else. On the contrary our source of truth is the server, so our approach is more similar to Telegram instead. This is a better approach in my opinion because it allows us to show the messages for the same user on multiple clients, instead of having to rely on questionable approaches like Whatsapp Web.\nAlso we already implemented our mutations to take care of future use cases (like reading notifications) which we still didn't implement.\n\nI said we were going to take greater advantage of `graphql-code-generator` once we started writing our first mutation and I'm going to show you why. Let's run the generator first:\n\n    yarn generator\n\nThen let's use the generated types:\n\n[{]: <helper> (diffStep \"3.3\" module=\"server\")\n\n#### [Step 3.3: Use generated types](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/b7b1be3)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,6 +1,9 @@\n ┊1┊1┊import { IResolvers } from 'apollo-server-express';\n ┊2┊2┊import { Chat, db, Message, MessageType, Recipient, User } from \"../db\";\n-┊3┊ ┊import { ChatQueryArgs } from \"../types\";\n+┊ ┊3┊import {\n+┊ ┊4┊  AddChatMutationArgs, AddGroupMutationArgs, AddMessageMutationArgs, ChatQueryArgs,\n+┊ ┊5┊  RemoveChatMutationArgs, RemoveMessagesMutationArgs\n+┊ ┊6┊} from \"../types\";\n ┊4┊7┊import * as moment from \"moment\";\n ┊5┊8┊\n ┊6┊9┊let users = db.users;\n```\n```diff\n@@ -15,12 +18,12 @@\n ┊15┊18┊    chat: (obj: any, {chatId}: ChatQueryArgs): Chat | null => chats.find(chat => chat.id === Number(chatId)) || null,\n ┊16┊19┊  },\n ┊17┊20┊  Mutation: {\n-┊18┊  ┊    addChat: (obj: any, {recipientId}: any): Chat => {\n-┊19┊  ┊      if (!users.find(user => user.id === recipientId)) {\n+┊  ┊21┊    addChat: (obj: any, {recipientId}: AddChatMutationArgs): Chat => {\n+┊  ┊22┊      if (!users.find(user => user.id === Number(recipientId))) {\n ┊20┊23┊        throw new Error(`Recipient ${recipientId} doesn't exist.`);\n ┊21┊24┊      }\n ┊22┊25┊\n-┊23┊  ┊      const chat = chats.find(chat => !chat.name && chat.allTimeMemberIds.includes(currentUser) && chat.allTimeMemberIds.includes(recipientId));\n+┊  ┊26┊      const chat = chats.find(chat => !chat.name && chat.allTimeMemberIds.includes(currentUser) && chat.allTimeMemberIds.includes(Number(recipientId)));\n ┊24┊27┊      if (chat) {\n ┊25┊28┊        // Chat already exists. Both users are already in the allTimeMemberIds array\n ┊26┊29┊        const chatId = chat.id;\n```\n```diff\n@@ -41,7 +44,7 @@\n ┊41┊44┊          picture: null,\n ┊42┊45┊          adminIds: null,\n ┊43┊46┊          ownerId: null,\n-┊44┊  ┊          allTimeMemberIds: [currentUser, recipientId],\n+┊  ┊47┊          allTimeMemberIds: [currentUser, Number(recipientId)],\n ┊45┊48┊          // Chat will not be listed to the other user until the first message gets written\n ┊46┊49┊          listingMemberIds: [currentUser],\n ┊47┊50┊          actualGroupMemberIds: null,\n```\n```diff\n@@ -51,9 +54,9 @@\n ┊51┊54┊        return chat;\n ┊52┊55┊      }\n ┊53┊56┊    },\n-┊54┊  ┊    addGroup: (obj: any, {recipientIds, groupName}: any): Chat => {\n-┊55┊  ┊      recipientIds.forEach((recipientId: any) => {\n-┊56┊  ┊        if (!users.find(user => user.id === recipientId)) {\n+┊  ┊57┊    addGroup: (obj: any, {recipientIds, groupName}: AddGroupMutationArgs): Chat => {\n+┊  ┊58┊      recipientIds.forEach(recipientId => {\n+┊  ┊59┊        if (!users.find(user => user.id === Number(recipientId))) {\n ┊57┊60┊          throw new Error(`Recipient ${recipientId} doesn't exist.`);\n ┊58┊61┊        }\n ┊59┊62┊      });\n```\n```diff\n@@ -65,16 +68,16 @@\n ┊65┊68┊        picture: null,\n ┊66┊69┊        adminIds: [currentUser],\n ┊67┊70┊        ownerId: currentUser,\n-┊68┊  ┊        allTimeMemberIds: [currentUser, ...recipientIds],\n-┊69┊  ┊        listingMemberIds: [currentUser, ...recipientIds],\n-┊70┊  ┊        actualGroupMemberIds: [currentUser, ...recipientIds],\n+┊  ┊71┊        allTimeMemberIds: [currentUser, ...recipientIds.map(id => Number(id))],\n+┊  ┊72┊        listingMemberIds: [currentUser, ...recipientIds.map(id => Number(id))],\n+┊  ┊73┊        actualGroupMemberIds: [currentUser, ...recipientIds.map(id => Number(id))],\n ┊71┊74┊        messages: [],\n ┊72┊75┊      };\n ┊73┊76┊      chats.push(chat);\n ┊74┊77┊      return chat;\n ┊75┊78┊    },\n-┊76┊  ┊    removeChat: (obj: any, {chatId}: any): number => {\n-┊77┊  ┊      const chat = chats.find(chat => chat.id === chatId);\n+┊  ┊79┊    removeChat: (obj: any, {chatId}: RemoveChatMutationArgs): number => {\n+┊  ┊80┊      const chat = chats.find(chat => chat.id === Number(chatId));\n ┊78┊81┊\n ┊79┊82┊      if (!chat) {\n ┊80┊83┊        throw new Error(`The chat ${chatId} doesn't exist.`);\n```\n```diff\n@@ -104,17 +107,17 @@\n ┊104┊107┊        // Check how many members are left\n ┊105┊108┊        if (listingMemberIds.length === 0) {\n ┊106┊109┊          // Delete the chat\n-┊107┊   ┊          chats = chats.filter(chat => chat.id !== chatId);\n+┊   ┊110┊          chats = chats.filter(chat => chat.id !== Number(chatId));\n ┊108┊111┊        } else {\n ┊109┊112┊          // Update the chat\n ┊110┊113┊          chats = chats.map(chat => {\n-┊111┊   ┊            if (chat.id === chatId) {\n+┊   ┊114┊            if (chat.id === Number(chatId)) {\n ┊112┊115┊              chat = {...chat, listingMemberIds, messages};\n ┊113┊116┊            }\n ┊114┊117┊            return chat;\n ┊115┊118┊          });\n ┊116┊119┊        }\n-┊117┊   ┊        return chatId;\n+┊   ┊120┊        return Number(chatId);\n ┊118┊121┊      } else {\n ┊119┊122┊        // Group\n ┊120┊123┊        if (chat.ownerId !== currentUser) {\n```\n```diff\n@@ -139,7 +142,7 @@\n ┊139┊142┊        // Check how many members (including previous ones who can still access old messages) are left\n ┊140┊143┊        if (listingMemberIds.length === 0) {\n ┊141┊144┊          // Remove the group\n-┊142┊   ┊          chats = chats.filter(chat => chat.id !== chatId);\n+┊   ┊145┊          chats = chats.filter(chat => chat.id !== Number(chatId));\n ┊143┊146┊        } else {\n ┊144┊147┊          // Update the group\n ┊145┊148┊\n```\n```diff\n@@ -157,21 +160,21 @@\n ┊157┊160┊          }\n ┊158┊161┊\n ┊159┊162┊          chats = chats.map(chat => {\n-┊160┊   ┊            if (chat.id === chatId) {\n+┊   ┊163┊            if (chat.id === Number(chatId)) {\n ┊161┊164┊              chat = {...chat, messages, listingMemberIds, actualGroupMemberIds, adminIds, ownerId};\n ┊162┊165┊            }\n ┊163┊166┊            return chat;\n ┊164┊167┊          });\n ┊165┊168┊        }\n-┊166┊   ┊        return chatId;\n+┊   ┊169┊        return Number(chatId);\n ┊167┊170┊      }\n ┊168┊171┊    },\n-┊169┊   ┊    addMessage: (obj: any, {chatId, content}: any): Message => {\n+┊   ┊172┊    addMessage: (obj: any, {chatId, content}: AddMessageMutationArgs): Message => {\n ┊170┊173┊      if (content === null || content === '') {\n ┊171┊174┊        throw new Error(`Cannot add empty or null messages.`);\n ┊172┊175┊      }\n ┊173┊176┊\n-┊174┊   ┊      let chat = chats.find(chat => chat.id === chatId);\n+┊   ┊177┊      let chat = chats.find(chat => chat.id === Number(chatId));\n ┊175┊178┊\n ┊176┊179┊      if (!chat) {\n ┊177┊180┊        throw new Error(`Cannot find chat ${chatId}.`);\n```\n```diff\n@@ -192,7 +195,7 @@\n ┊192┊195┊          const listingMemberIds = chat.listingMemberIds.concat(recipientId);\n ┊193┊196┊\n ┊194┊197┊          chats = chats.map(chat => {\n-┊195┊   ┊            if (chat.id === chatId) {\n+┊   ┊198┊            if (chat.id === Number(chatId)) {\n ┊196┊199┊              chat = {...chat, listingMemberIds};\n ┊197┊200┊            }\n ┊198┊201┊            return chat;\n```\n```diff\n@@ -218,7 +221,7 @@\n ┊218┊221┊          recipients.push({\n ┊219┊222┊            userId: holderId,\n ┊220┊223┊            messageId: id,\n-┊221┊   ┊            chatId: chatId,\n+┊   ┊224┊            chatId: Number(chatId),\n ┊222┊225┊            receivedAt: null,\n ┊223┊226┊            readAt: null,\n ┊224┊227┊          });\n```\n```diff\n@@ -227,7 +230,7 @@\n ┊227┊230┊\n ┊228┊231┊      const message: Message = {\n ┊229┊232┊        id,\n-┊230┊   ┊        chatId,\n+┊   ┊233┊        chatId: Number(chatId),\n ┊231┊234┊        senderId: currentUser,\n ┊232┊235┊        content,\n ┊233┊236┊        createdAt: moment().unix(),\n```\n```diff\n@@ -237,7 +240,7 @@\n ┊237┊240┊      };\n ┊238┊241┊\n ┊239┊242┊      chats = chats.map(chat => {\n-┊240┊   ┊        if (chat.id === chatId) {\n+┊   ┊243┊        if (chat.id === Number(chatId)) {\n ┊241┊244┊          chat = {...chat, messages: chat.messages.concat(message)}\n ┊242┊245┊        }\n ┊243┊246┊        return chat;\n```\n```diff\n@@ -245,8 +248,8 @@\n ┊245┊248┊\n ┊246┊249┊      return message;\n ┊247┊250┊    },\n-┊248┊   ┊    removeMessages: (obj: any, {chatId, messageIds, all}: any): number[] => {\n-┊249┊   ┊      const chat = chats.find(chat => chat.id === chatId);\n+┊   ┊251┊    removeMessages: (obj: any, {chatId, messageIds, all}: RemoveMessagesMutationArgs): number[] => {\n+┊   ┊252┊      const chat = chats.find(chat => chat.id === Number(chatId));\n ┊250┊253┊\n ┊251┊254┊      if (!chat) {\n ┊252┊255┊        throw new Error(`Cannot find chat ${chatId}.`);\n```\n```diff\n@@ -262,10 +265,10 @@\n ┊262┊265┊\n ┊263┊266┊      let deletedIds: number[] = [];\n ┊264┊267┊      chats = chats.map(chat => {\n-┊265┊   ┊        if (chat.id === chatId) {\n+┊   ┊268┊        if (chat.id === Number(chatId)) {\n ┊266┊269┊          // Instead of chaining map and filter we can loop once using reduce\n ┊267┊270┊          const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n-┊268┊   ┊            if (all || messageIds!.includes(message.id)) {\n+┊   ┊271┊            if (all || messageIds!.includes(String(message.id))) {\n ┊269┊272┊              deletedIds.push(message.id);\n ┊270┊273┊              // Remove the current user from the message holders\n ┊271┊274┊              message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser);\n```\n\n[}]: #\n\n## Client\n\nFor the client I'll only show you how to make use of the addMessage mutation in this chapters. The other mutations will require much more boilerplate so I left them for their own chapter.\n\nLet's start by wiring the addMessage mutation. We're going to write the GraphQL query and then use the generator to generate the types:\n\n[{]: <helper> (diffStep \"5.1\" files=\"^\\(?!src/types.d.ts$\\).*\" module=\"client\")\n\n#### [Step 5.1: Create addMessage mutation and generate types](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/706d62e)\n\n##### Changed src&#x2F;graphql.ts\n```diff\n@@ -600,6 +600,20 @@\n ┊600┊600┊  > = Resolver<R, Parent, Context>;\n ┊601┊601┊}\n ┊602┊602┊\n+┊   ┊603┊export namespace AddMessage {\n+┊   ┊604┊  export type Variables = {\n+┊   ┊605┊    chatId: string;\n+┊   ┊606┊    content: string;\n+┊   ┊607┊  };\n+┊   ┊608┊\n+┊   ┊609┊  export type Mutation = {\n+┊   ┊610┊    __typename?: \"Mutation\";\n+┊   ┊611┊    addMessage?: AddMessage | null;\n+┊   ┊612┊  };\n+┊   ┊613┊\n+┊   ┊614┊  export type AddMessage = Message.Fragment;\n+┊   ┊615┊}\n+┊   ┊616┊\n ┊603┊617┊export namespace GetChat {\n ┊604┊618┊  export type Variables = {\n ┊605┊619┊    chatId: string;\n```\n```diff\n@@ -760,6 +774,23 @@\n ┊760┊774┊  }\n ┊761┊775┊`;\n ┊762┊776┊\n+┊   ┊777┊@Injectable({\n+┊   ┊778┊  providedIn: \"root\"\n+┊   ┊779┊})\n+┊   ┊780┊export class AddMessageGQL extends Apollo.Mutation<\n+┊   ┊781┊  AddMessage.Mutation,\n+┊   ┊782┊  AddMessage.Variables\n+┊   ┊783┊> {\n+┊   ┊784┊  document: any = gql`\n+┊   ┊785┊    mutation AddMessage($chatId: ID!, $content: String!) {\n+┊   ┊786┊      addMessage(chatId: $chatId, content: $content) {\n+┊   ┊787┊        ...Message\n+┊   ┊788┊      }\n+┊   ┊789┊    }\n+┊   ┊790┊\n+┊   ┊791┊    ${MessageFragment}\n+┊   ┊792┊  `;\n+┊   ┊793┊}\n ┊763┊794┊@Injectable({\n ┊764┊795┊  providedIn: \"root\"\n ┊765┊796┊})\n```\n\n##### Added src&#x2F;graphql&#x2F;addMessage.mutation.ts\n```diff\n@@ -0,0 +1,13 @@\n+┊  ┊ 1┊import gql from 'graphql-tag';\n+┊  ┊ 2┊import {fragments} from './fragment';\n+┊  ┊ 3┊\n+┊  ┊ 4┊// We use the gql tag to parse our query string into a query document\n+┊  ┊ 5┊export const addMessageMutation = gql`\n+┊  ┊ 6┊  mutation AddMessage($chatId: ID!, $content: String!) {\n+┊  ┊ 7┊    addMessage(chatId: $chatId, content: $content) {\n+┊  ┊ 8┊      ...Message\n+┊  ┊ 9┊    }\n+┊  ┊10┊  }\n+┊  ┊11┊\n+┊  ┊12┊  ${fragments['message']}\n+┊  ┊13┊`;\n```\n\n[}]: #\n\nRun the generator:\n\n    yarn generator\n\nNow let's use the just-created query:\n\n[{]: <helper> (diffStep \"5.2\" module=\"client\")\n\n#### [Step 5.2: Modify chat component and service](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/ad6a5da)\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.ts\n```diff\n@@ -14,7 +14,7 @@\n ┊14┊14┊    </app-toolbar>\n ┊15┊15┊    <div class=\"container\">\n ┊16┊16┊      <app-messages-list [items]=\"messages\" [isGroup]=\"isGroup\"></app-messages-list>\n-┊17┊  ┊      <app-new-message></app-new-message>\n+┊  ┊17┊      <app-new-message (newMessage)=\"addMessage($event)\"></app-new-message>\n ┊18┊18┊    </div>\n ┊19┊19┊  `,\n ┊20┊20┊  styleUrls: ['./chat.component.scss']\n```\n```diff\n@@ -44,4 +44,8 @@\n ┊44┊44┊  goToChats() {\n ┊45┊45┊    this.router.navigate(['/chats']);\n ┊46┊46┊  }\n+┊  ┊47┊\n+┊  ┊48┊  addMessage(content: string) {\n+┊  ┊49┊    this.chatsService.addMessage(this.chatId, content).subscribe();\n+┊  ┊50┊  }\n ┊47┊51┊}\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,6 +1,6 @@\n ┊1┊1┊import {map} from 'rxjs/operators';\n ┊2┊2┊import {Injectable} from '@angular/core';\n-┊3┊ ┊import {GetChatsGQL, GetChatGQL} from '../../graphql';\n+┊ ┊3┊import {GetChatsGQL, GetChatGQL, AddMessageGQL} from '../../graphql';\n ┊4┊4┊\n ┊5┊5┊@Injectable()\n ┊6┊6┊export class ChatsService {\n```\n```diff\n@@ -8,7 +8,8 @@\n ┊ 8┊ 8┊\n ┊ 9┊ 9┊  constructor(\n ┊10┊10┊    private getChatsGQL: GetChatsGQL,\n-┊11┊  ┊    private getChatGQL: GetChatGQL\n+┊  ┊11┊    private getChatGQL: GetChatGQL,\n+┊  ┊12┊    private addMessageGQL: AddMessageGQL\n ┊12┊13┊  ) {}\n ┊13┊14┊\n ┊14┊15┊  getChats() {\n```\n```diff\n@@ -33,4 +34,11 @@\n ┊33┊34┊\n ┊34┊35┊    return {query, chat$};\n ┊35┊36┊  }\n+┊  ┊37┊\n+┊  ┊38┊  addMessage(chatId: string, content: string) {\n+┊  ┊39┊    return this.addMessageGQL.mutate({\n+┊  ┊40┊      chatId,\n+┊  ┊41┊      content,\n+┊  ┊42┊    });\n+┊  ┊43┊  }\n ┊36┊44┊}\n```\n\n[}]: #\n\nIt's that simple! You would be tempted to say that it doesn't work, but you should try to refresh the page first ;)"
          },
          {
            "manualTitle": "Step 10: Updating the store",
            "stepRevision": "04749f21bfdeecb76145491e1d4d373102ad8969",
            "manualView": "## Client\n\nDid you notice that after creating a new message you'll have to refresh the page in order to see it?\n\nHow to fix that?\n\nApollo performs two important core tasks which we covered in one of previous steps: executing queries and mutations, and caching the results.\n\nThanks to Apollo's store design, it's possible for the results of a query or mutation to update your UI in all the right places. In many cases it's possible for that to happen automatically, whereas in others you need to help the client out a little in doing so.\n\nThere are couple of APIs to update the cache after mutation:\n\n- `refetchQueries` - is the most straightforward way of updating the cache. You request queries to be executed once again.\n- `update` - super flexible and allows you to make changes to the store based on mutation. Works well with Optimistic UI which we will cover later.\n- `updateQueries` - It works similar to the previous option but the API may be deprecated in the future and we recommend to stay with `update`.\n\nIf you thought about re-querying the server you would be wrong! The best solution is to use the response provided by the server to update our Apollo local cache.\n\nOf course that we're going to use the `update` API!\n\n### Updating the store\n\nAs you can see, the `update` option is a function that has two arguments:\n\n- `DataProxy` which we named `store`\n- mutation's result\n\nThe `DataProxy` seems very interesting! It's a middleman between you and the cache.\n\n#### How to update fragments\n\nIn pretty much every case, that middleman would allow to write and read data. Take for example the JavaScript `Map` object.\n\nIt has a `get` and `set` methods and both works based on a `key`.\n\nIn Apollo, we do have that key, it's something that was covered in the 5th step, remember? An object of type `Message` with an `id` would be stored in the cache as `Message:<id>`.\n\nLet's call that small object a fragment, for simplicity.\n\nWhat are our _get_ and _set_ methods in Apollo's DataProxy? Simple, `readFragment` and `writeFragment`.\n\nI think it's time to work on a simple example. Scenario: every message can be liked and we keep the sum of likes under the `likes` field.\n\nHow to give a like?\n\n```typescript\nconst store: DataProxy = ...;\nconst messageId = 256;\n\nconst fragment = gql`\n  fragment M on Message {\n    likes\n  }\n`;\nconst fragmentId = `Message:${messageId}`;\n\nconst message = store.readFragment({\n  fragment,\n  id: fragmentId\n});\n\nstore.writeFragment({\n  fragment,\n  id: fragmentId,\n  data: {\n    likes: message.likes + 1\n  }\n});\n```\n\nWhat just happened?!\n\nAt first, it might seem weird to talk to the store like that but you will see that it makes a lot of sense!\n\n - `messageId` - defined the actual id of our message\n - `fragment` - it's a document that tells Apollo what fields we want to read and write\n - `fragmentId` - an unique key under which the fragment is stored (we covered that in 5th step)\n - `readFragment` - reads the fragment in the store and returns the result in exact same shape as requested\n - `writeFragment` - accepts same properties as `readFragment` but also the `data` property\n\n### How to update queries\n\nSimilar as in case of fragments, we update queries with `readQuery` and `writeQuery`.\n\nWe won't cover the same thing again but let's just look at the API based on our WhatsApp clone example:\n\n[{]: <helper> (diffStep \"6.1\" module=\"client\")\n\n#### [Step 6.1: Update the store](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/cb01e16)\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,6 +1,13 @@\n ┊ 1┊ 1┊import {map} from 'rxjs/operators';\n ┊ 2┊ 2┊import {Injectable} from '@angular/core';\n-┊ 3┊  ┊import {GetChatsGQL, GetChatGQL, AddMessageGQL} from '../../graphql';\n+┊  ┊ 3┊import {\n+┊  ┊ 4┊  GetChatsGQL,\n+┊  ┊ 5┊  GetChatGQL,\n+┊  ┊ 6┊  AddMessageGQL,\n+┊  ┊ 7┊  AddMessage,\n+┊  ┊ 8┊  GetChats,\n+┊  ┊ 9┊  GetChat\n+┊  ┊10┊} from '../../graphql';\n ┊ 4┊11┊\n ┊ 5┊12┊@Injectable()\n ┊ 6┊13┊export class ChatsService {\n```\n```diff\n@@ -39,6 +46,50 @@\n ┊39┊46┊    return this.addMessageGQL.mutate({\n ┊40┊47┊      chatId,\n ┊41┊48┊      content,\n+┊  ┊49┊    }, {\n+┊  ┊50┊      update: (store, { data: { addMessage } }: {data: AddMessage.Mutation}) => {\n+┊  ┊51┊        // Update the messages cache\n+┊  ┊52┊        {\n+┊  ┊53┊          // Read the data from our cache for this query.\n+┊  ┊54┊          const {chat} = store.readQuery<GetChat.Query, GetChat.Variables>({\n+┊  ┊55┊            query: this.getChatGQL.document,\n+┊  ┊56┊            variables: {\n+┊  ┊57┊              chatId,\n+┊  ┊58┊            }\n+┊  ┊59┊          });\n+┊  ┊60┊          // Add our message from the mutation to the end.\n+┊  ┊61┊          chat.messages.push(addMessage);\n+┊  ┊62┊          // Write our data back to the cache.\n+┊  ┊63┊          store.writeQuery({\n+┊  ┊64┊            query: this.getChatGQL.document,\n+┊  ┊65┊            data: {\n+┊  ┊66┊              chat\n+┊  ┊67┊            }\n+┊  ┊68┊          });\n+┊  ┊69┊        }\n+┊  ┊70┊        // Update last message cache\n+┊  ┊71┊        {\n+┊  ┊72┊          // Read the data from our cache for this query.\n+┊  ┊73┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n+┊  ┊74┊            query: this.getChatsGQL.document,\n+┊  ┊75┊            variables: {\n+┊  ┊76┊              amount: this.messagesAmount,\n+┊  ┊77┊            },\n+┊  ┊78┊          });\n+┊  ┊79┊          // Add our comment from the mutation to the end.\n+┊  ┊80┊          chats.find(chat => chat.id === chatId).messages.push(addMessage);\n+┊  ┊81┊          // Write our data back to the cache.\n+┊  ┊82┊          store.writeQuery<GetChats.Query, GetChats.Variables>({\n+┊  ┊83┊            query: this.getChatsGQL.document,\n+┊  ┊84┊            variables: {\n+┊  ┊85┊              amount: this.messagesAmount,\n+┊  ┊86┊            },\n+┊  ┊87┊            data: {\n+┊  ┊88┊              chats,\n+┊  ┊89┊            },\n+┊  ┊90┊          });\n+┊  ┊91┊        }\n+┊  ┊92┊      }\n ┊42┊93┊    });\n ┊43┊94┊  }\n ┊44┊95┊}\n```\n\n[}]: #\n\nAs you can see we used the `document` property of a generated GQL service. It contains the actual query that is used in every `watch` or `fetch` calls of the GQL service. It's a part of the open API.\n\n### Keep on mind\n\nIt's very important to know few things:\n\n- update function have to run synchronously\n- the query should always match the query you want to update (even order of fields or variables matters)\n- by updating a query you also update every normalized data it has (we called them fragments in few secions above)\n\nWhen Apollo runs the `update` function? In two cases, rigth after the mutation happens but only if it has an optimistic response defined, and also once we get the response from the server.\n\n> Optimistic Resposne is something we will cover in next steps but so you know, Apollo allows to optimistically update the store with a temporary data that is being replaced right after we get the response from the server.\n\nBut why the update function has to run synchornously? It's by design and not so interesting. We won't cover it in-depth here but in short, when Apollo runs the function it switches the store with the new, empty one, to record every change that's made by the function to later merge it with the original store. If you still have questions, please let us know so we can cover that thing in-depth as a blog post or even a separate chapter in that tutorial.\n\n### Summary\n\nNow you won't need to reload the page in order to see the new message. What's even more interesting is that the message you wrote would also be shown as the last message in the chats list, just hit the back button in the top-left corner to find out!\n\nThis is because we updated our store for both the `GetChat` and the `GetChats` query."
          },
          {
            "manualTitle": "Step 11: Messages and chats removal",
            "stepRevision": "d924471909e13cc56a0bf23311554f1e7413130f",
            "manualView": "## Client\n\nSince we're now familiar with the way mutations work, it's time to add messages and chats removal to our list of features!\nSince the most annoying part is going to be dealing with the user interface (because a multiple selection started by a press event is involved), I created an Angular directive to ease the process.\n\nLet's start by adding `ngx-selectable-list`:\n\n    yarn add ngx-selectable-list\n\n[{]: <helper> (diffStep \"7.1\" module=\"client\")\n\n#### [Step 7.1: Add SelectableListModule](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/5ef06d0)\n\n##### Changed package.json\n```diff\n@@ -34,7 +34,8 @@\n ┊34┊34┊    \"graphql-tag\": \"2.10.0\",\n ┊35┊35┊    \"graphql\": \"14.0.2\",\n ┊36┊36┊    \"hammerjs\": \"2.0.8\",\n-┊37┊  ┊    \"ng2-truncate\": \"1.3.17\"\n+┊  ┊37┊    \"ng2-truncate\": \"1.3.17\",\n+┊  ┊38┊    \"ngx-selectable-list\": \"1.2.1\"\n ┊38┊39┊  },\n ┊39┊40┊  \"devDependencies\": {\n ┊40┊41┊    \"@angular-devkit/build-angular\": \"0.9.0-rc.2\",\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;chats-lister.module.ts\n```diff\n@@ -11,6 +11,7 @@\n ┊11┊11┊import {ChatsListComponent} from './components/chats-list/chats-list.component';\n ┊12┊12┊import {TruncateModule} from 'ng2-truncate';\n ┊13┊13┊import {SharedModule} from '../shared/shared.module';\n+┊  ┊14┊import {NgxSelectableListModule} from 'ngx-selectable-list';\n ┊14┊15┊\n ┊15┊16┊const routes: Routes = [\n ┊16┊17┊  {path: '', redirectTo: 'chats', pathMatch: 'full'},\n```\n```diff\n@@ -40,6 +41,7 @@\n ┊40┊41┊    TruncateModule,\n ┊41┊42┊    // Feature modules\n ┊42┊43┊    SharedModule,\n+┊  ┊44┊    NgxSelectableListModule,\n ┊43┊45┊  ],\n ┊44┊46┊  providers: [\n ┊45┊47┊    ChatsService,\n```\n\n[}]: #\n\nBecause we're going to use the `libSelectableList` directive, we can replace Outputs and EventEmitters with it:\n\n[{]: <helper> (diffStep \"7.2\" files=\"src/app/chats-lister/components/chat-item/chat-item.component.ts, src/app/chats-lister/components/chats-list/chats-list.component.ts, src/app/chat-viewer/components/messages-list/messages-list.component.ts\" module=\"client\")\n\n#### [Step 7.2: Remove messages and chats](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/18cfa7c)\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;components&#x2F;messages-list&#x2F;messages-list.component.ts\n```diff\n@@ -1,14 +1,17 @@\n ┊ 1┊ 1┊import {Component, Input} from '@angular/core';\n ┊ 2┊ 2┊import {GetChat} from '../../../../graphql';\n+┊  ┊ 3┊import {SelectableListDirective} from 'ngx-selectable-list';\n ┊ 3┊ 4┊\n ┊ 4┊ 5┊@Component({\n ┊ 5┊ 6┊  selector: 'app-messages-list',\n ┊ 6┊ 7┊  template: `\n ┊ 7┊ 8┊    <mat-list>\n ┊ 8┊ 9┊      <mat-list-item *ngFor=\"let message of messages\">\n-┊ 9┊  ┊        <app-message-item [item]=\"message\" [isGroup]=\"isGroup\"></app-message-item>\n+┊  ┊10┊        <app-message-item [item]=\"message\" [isGroup]=\"isGroup\"\n+┊  ┊11┊                          libSelectableItem></app-message-item>\n ┊10┊12┊      </mat-list-item>\n ┊11┊13┊    </mat-list>\n+┊  ┊14┊    <ng-content *ngIf=\"selectableListDirective.selecting\"></ng-content>\n ┊12┊15┊  `,\n ┊13┊16┊  styleUrls: ['messages-list.component.scss'],\n ┊14┊17┊})\n```\n```diff\n@@ -20,5 +23,5 @@\n ┊20┊23┊  @Input()\n ┊21┊24┊  isGroup: boolean;\n ┊22┊25┊\n-┊23┊  ┊  constructor() {}\n+┊  ┊26┊  constructor(public selectableListDirective: SelectableListDirective) {}\n ┊24┊27┊}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chat-item&#x2F;chat-item.component.ts\n```diff\n@@ -4,7 +4,7 @@\n ┊ 4┊ 4┊@Component({\n ┊ 5┊ 5┊  selector: 'app-chat-item',\n ┊ 6┊ 6┊  template: `\n-┊ 7┊  ┊    <div class=\"chat-row\" (click)=\"selectChat()\">\n+┊  ┊ 7┊    <div class=\"chat-row\">\n ┊ 8┊ 8┊      <img class=\"chat-pic\" [src]=\"chat.picture || 'assets/default-profile-pic.jpg'\">\n ┊ 9┊ 9┊      <div class=\"chat-info\">\n ┊10┊10┊        <div class=\"chat-name\">{{ chat.name }}</div>\n```\n```diff\n@@ -19,11 +19,4 @@\n ┊19┊19┊  // tslint:disable-next-line:no-input-rename\n ┊20┊20┊  @Input('item')\n ┊21┊21┊  chat: GetChats.Chats;\n-┊22┊  ┊\n-┊23┊  ┊  @Output()\n-┊24┊  ┊  select = new EventEmitter<string>();\n-┊25┊  ┊\n-┊26┊  ┊  selectChat() {\n-┊27┊  ┊    this.select.emit(this.chat.id);\n-┊28┊  ┊  }\n ┊29┊22┊}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chats-list&#x2F;chats-list.component.ts\n```diff\n@@ -1,14 +1,17 @@\n-┊ 1┊  ┊import {Component, EventEmitter, Input, Output} from '@angular/core';\n+┊  ┊ 1┊import {Component, Input} from '@angular/core';\n ┊ 2┊ 2┊import {GetChats} from '../../../../graphql';\n+┊  ┊ 3┊import {SelectableListDirective} from 'ngx-selectable-list';\n ┊ 3┊ 4┊\n ┊ 4┊ 5┊@Component({\n ┊ 5┊ 6┊  selector: 'app-chats-list',\n ┊ 6┊ 7┊  template: `\n ┊ 7┊ 8┊    <mat-list>\n ┊ 8┊ 9┊      <mat-list-item *ngFor=\"let chat of chats\">\n-┊ 9┊  ┊        <app-chat-item [item]=\"chat\" (select)=\"selectChat($event)\"></app-chat-item>\n+┊  ┊10┊        <app-chat-item [item]=\"chat\"\n+┊  ┊11┊                       libSelectableItem></app-chat-item>\n ┊10┊12┊      </mat-list-item>\n ┊11┊13┊    </mat-list>\n+┊  ┊14┊    <ng-content *ngIf=\"selectableListDirective.selecting\"></ng-content>\n ┊12┊15┊  `,\n ┊13┊16┊  styleUrls: ['chats-list.component.scss'],\n ┊14┊17┊})\n```\n```diff\n@@ -17,12 +20,5 @@\n ┊17┊20┊  @Input('items')\n ┊18┊21┊  chats: GetChats.Chats[];\n ┊19┊22┊\n-┊20┊  ┊  @Output()\n-┊21┊  ┊  select = new EventEmitter<string>();\n-┊22┊  ┊\n-┊23┊  ┊  constructor() {}\n-┊24┊  ┊\n-┊25┊  ┊  selectChat(id: string) {\n-┊26┊  ┊    this.select.emit(id);\n-┊27┊  ┊  }\n+┊  ┊23┊  constructor(public selectableListDirective: SelectableListDirective) {}\n ┊28┊24┊}\n```\n\n[}]: #\n\nDon't forget to add the `NgxSelectableListModule` to `ChatViewer` and `ChatLister` modules.\n\nWe also created a `ConfirmSelectionComponent` to use for content projection, since our selectable list directive will be able to listen to its events.\n\n[{]: <helper> (diffStep \"7.2\" files=\"src/app/shared/components/confirm-selection/confirm-selection.component.scss, src/app/shared/components/confirm-selection/confirm-selection.component.ts, src/app/shared/shared.module.ts\" module=\"client\")\n\n#### [Step 7.2: Remove messages and chats](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/18cfa7c)\n\n##### Added src&#x2F;app&#x2F;shared&#x2F;components&#x2F;confirm-selection&#x2F;confirm-selection.component.scss\n```diff\n@@ -0,0 +1,6 @@\n+┊ ┊1┊:host {\n+┊ ┊2┊  display: block;\n+┊ ┊3┊  position: absolute;\n+┊ ┊4┊  bottom: 5vw;\n+┊ ┊5┊  right: 5vw;\n+┊ ┊6┊}\n```\n\n##### Added src&#x2F;app&#x2F;shared&#x2F;components&#x2F;confirm-selection&#x2F;confirm-selection.component.ts\n```diff\n@@ -0,0 +1,21 @@\n+┊  ┊ 1┊import {Component, EventEmitter, Input, Output} from '@angular/core';\n+┊  ┊ 2┊\n+┊  ┊ 3┊@Component({\n+┊  ┊ 4┊  selector: 'app-confirm-selection',\n+┊  ┊ 5┊  template: `\n+┊  ┊ 6┊    <button mat-fab color=\"primary\" (click)=\"handleClick()\">\n+┊  ┊ 7┊      <mat-icon aria-label=\"Icon-button\">{{ icon }}</mat-icon>\n+┊  ┊ 8┊    </button>\n+┊  ┊ 9┊  `,\n+┊  ┊10┊  styleUrls: ['./confirm-selection.component.scss'],\n+┊  ┊11┊})\n+┊  ┊12┊export class ConfirmSelectionComponent {\n+┊  ┊13┊  @Input()\n+┊  ┊14┊  icon = 'delete';\n+┊  ┊15┊  @Output()\n+┊  ┊16┊  emitClick = new EventEmitter<null>();\n+┊  ┊17┊\n+┊  ┊18┊  handleClick() {\n+┊  ┊19┊    this.emitClick.emit();\n+┊  ┊20┊  }\n+┊  ┊21┊}\n```\n\n##### Changed src&#x2F;app&#x2F;shared&#x2F;shared.module.ts\n```diff\n@@ -1,19 +1,23 @@\n ┊ 1┊ 1┊import {BrowserModule} from '@angular/platform-browser';\n ┊ 2┊ 2┊import {NgModule} from '@angular/core';\n ┊ 3┊ 3┊\n-┊ 4┊  ┊import {MatToolbarModule} from '@angular/material';\n+┊  ┊ 4┊import {MatButtonModule, MatIconModule, MatToolbarModule} from '@angular/material';\n ┊ 5┊ 5┊import {ToolbarComponent} from './components/toolbar/toolbar.component';\n ┊ 6┊ 6┊import {FormsModule} from '@angular/forms';\n ┊ 7┊ 7┊import {BrowserAnimationsModule} from '@angular/platform-browser/animations';\n+┊  ┊ 8┊import {ConfirmSelectionComponent} from './components/confirm-selection/confirm-selection.component';\n ┊ 8┊ 9┊\n ┊ 9┊10┊@NgModule({\n ┊10┊11┊  declarations: [\n ┊11┊12┊    ToolbarComponent,\n+┊  ┊13┊    ConfirmSelectionComponent,\n ┊12┊14┊  ],\n ┊13┊15┊  imports: [\n ┊14┊16┊    BrowserModule,\n ┊15┊17┊    // Material\n ┊16┊18┊    MatToolbarModule,\n+┊  ┊19┊    MatIconModule,\n+┊  ┊20┊    MatButtonModule,\n ┊17┊21┊    // Animations\n ┊18┊22┊    BrowserAnimationsModule,\n ┊19┊23┊    // Forms\n```\n```diff\n@@ -22,6 +26,7 @@\n ┊22┊26┊  providers: [],\n ┊23┊27┊  exports: [\n ┊24┊28┊    ToolbarComponent,\n+┊  ┊29┊    ConfirmSelectionComponent,\n ┊25┊30┊  ],\n ┊26┊31┊})\n ┊27┊32┊export class SharedModule {\n```\n\n[}]: #\n\nGreat, let's finish the component part by adding the connection between our container components and the `ChatsService`. We're going to use `removeMessages` and `removeChat` methods.\n\n[{]: <helper> (diffStep \"7.2\" files=\"src/app/chat-viewer/containers/chat/chat.component.ts, src/app/chat-viewer/containers/chat/chat.component.spec.ts, src/app/chats-lister/containers/chats/chats.component.ts, src/app/chats-lister/containers/chats/chats.component.spec.ts\" module=\"client\")\n\n#### [Step 7.2: Remove messages and chats](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/18cfa7c)\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.spec.ts\n```diff\n@@ -20,6 +20,7 @@\n ┊20┊20┊  APOLLO_TESTING_CACHE,\n ┊21┊21┊} from 'apollo-angular/testing';\n ┊22┊22┊import { InMemoryCache } from 'apollo-cache-inmemory';\n+┊  ┊23┊import { NgxSelectableListModule } from 'ngx-selectable-list';\n ┊23┊24┊\n ┊24┊25┊import { dataIdFromObject } from '../../../graphql.module';\n ┊25┊26┊import { ChatComponent } from './chat.component';\n```\n```diff\n@@ -116,6 +117,7 @@\n ┊116┊117┊        SharedModule,\n ┊117┊118┊        ApolloTestingModule,\n ┊118┊119┊        RouterTestingModule,\n+┊   ┊120┊        NgxSelectableListModule,\n ┊119┊121┊      ],\n ┊120┊122┊      providers: [\n ┊121┊123┊        ChatsService,\n```\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.ts\n```diff\n@@ -13,7 +13,10 @@\n ┊13┊13┊      <div class=\"title\">{{ name }}</div>\n ┊14┊14┊    </app-toolbar>\n ┊15┊15┊    <div class=\"container\">\n-┊16┊  ┊      <app-messages-list [items]=\"messages\" [isGroup]=\"isGroup\"></app-messages-list>\n+┊  ┊16┊      <app-messages-list [items]=\"messages\" [isGroup]=\"isGroup\"\n+┊  ┊17┊                         libSelectableList=\"multiple_press\" (multiple)=\"deleteMessages($event)\">\n+┊  ┊18┊        <app-confirm-selection #confirmSelection></app-confirm-selection>\n+┊  ┊19┊      </app-messages-list>\n ┊17┊20┊      <app-new-message (newMessage)=\"addMessage($event)\"></app-new-message>\n ┊18┊21┊    </div>\n ┊19┊22┊  `,\n```\n```diff\n@@ -48,4 +51,8 @@\n ┊48┊51┊  addMessage(content: string) {\n ┊49┊52┊    this.chatsService.addMessage(this.chatId, content).subscribe();\n ┊50┊53┊  }\n+┊  ┊54┊\n+┊  ┊55┊  deleteMessages(messageIds: string[]) {\n+┊  ┊56┊    this.chatsService.removeMessages(this.chatId, this.messages, messageIds).subscribe();\n+┊  ┊57┊  }\n ┊51┊58┊}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.spec.ts\n```diff\n@@ -16,6 +16,7 @@\n ┊16┊16┊import { InMemoryCache } from 'apollo-cache-inmemory';\n ┊17┊17┊import { By } from '@angular/platform-browser';\n ┊18┊18┊import { RouterTestingModule } from '@angular/router/testing';\n+┊  ┊19┊import { NgxSelectableListModule } from 'ngx-selectable-list';\n ┊19┊20┊\n ┊20┊21┊import { GetChats } from '../../../../graphql';\n ┊21┊22┊import { dataIdFromObject } from '../../../graphql.module';\n```\n```diff\n@@ -334,6 +335,7 @@\n ┊334┊335┊        TruncateModule,\n ┊335┊336┊        ApolloTestingModule,\n ┊336┊337┊        RouterTestingModule,\n+┊   ┊338┊        NgxSelectableListModule,\n ┊337┊339┊      ],\n ┊338┊340┊      providers: [\n ┊339┊341┊        ChatsService,\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.ts\n```diff\n@@ -28,9 +28,13 @@\n ┊28┊28┊      </button>\n ┊29┊29┊    </mat-menu>\n ┊30┊30┊\n-┊31┊  ┊    <app-chats-list [items]=\"chats$ | async\" (select)=\"goToChat($event)\"></app-chats-list>\n+┊  ┊31┊    <app-chats-list [items]=\"chats$ | async\"\n+┊  ┊32┊                    libSelectableList=\"both\"\n+┊  ┊33┊                    (single)=\"goToChat($event)\" (multiple)=\"deleteChats($event)\" (isSelecting)=\"isSelecting = $event\">\n+┊  ┊34┊      <app-confirm-selection #confirmSelection></app-confirm-selection>\n+┊  ┊35┊    </app-chats-list>\n ┊32┊36┊\n-┊33┊  ┊    <button class=\"chat-button\" mat-fab color=\"secondary\">\n+┊  ┊37┊    <button *ngIf=\"!isSelecting\" class=\"chat-button\" mat-fab color=\"secondary\">\n ┊34┊38┊      <mat-icon aria-label=\"Icon-button with a + icon\">chat</mat-icon>\n ┊35┊39┊    </button>\n ┊36┊40┊  `,\n```\n```diff\n@@ -38,6 +42,7 @@\n ┊38┊42┊})\n ┊39┊43┊export class ChatsComponent implements OnInit {\n ┊40┊44┊  chats$: Observable<GetChats.Chats[]>;\n+┊  ┊45┊  isSelecting = false;\n ┊41┊46┊\n ┊42┊47┊  constructor(private chatsService: ChatsService,\n ┊43┊48┊              private router: Router) {\n```\n```diff\n@@ -50,4 +55,10 @@\n ┊50┊55┊  goToChat(chatId: string) {\n ┊51┊56┊    this.router.navigate(['/chat', chatId]);\n ┊52┊57┊  }\n+┊  ┊58┊\n+┊  ┊59┊  deleteChats(chatIds: string[]) {\n+┊  ┊60┊    chatIds.forEach(chatId => {\n+┊  ┊61┊      this.chatsService.removeChat(chatId).subscribe();\n+┊  ┊62┊    });\n+┊  ┊63┊  }\n ┊53┊64┊}\n```\n\n[}]: #\n\n### Connecting actions with the server\n\nThe UI part is pretty much complete but we still need to implement two methods in the `ChatsService`. We're going to create mutations to remove a chat, selected messages or all of them.\n\n[{]: <helper> (diffStep \"7.2\" files=\"src/graphql/removeChat.mutation.ts, src/graphql/removeMessages.mutation.ts, src/graphql/removeAllMessages.mutation.ts\" module=\"client\")\n\n#### [Step 7.2: Remove messages and chats](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/18cfa7c)\n\n##### Added src&#x2F;graphql&#x2F;removeAllMessages.mutation.ts\n```diff\n@@ -0,0 +1,8 @@\n+┊ ┊1┊import gql from 'graphql-tag';\n+┊ ┊2┊\n+┊ ┊3┊// We use the gql tag to parse our query string into a query document\n+┊ ┊4┊export const removeAllMessagesMutation = gql`\n+┊ ┊5┊  mutation RemoveAllMessages($chatId: ID!, $all: Boolean) {\n+┊ ┊6┊    removeMessages(chatId: $chatId, all: $all)\n+┊ ┊7┊  }\n+┊ ┊8┊`;\n```\n\n##### Added src&#x2F;graphql&#x2F;removeChat.mutation.ts\n```diff\n@@ -0,0 +1,8 @@\n+┊ ┊1┊import gql from 'graphql-tag';\n+┊ ┊2┊\n+┊ ┊3┊// We use the gql tag to parse our query string into a query document\n+┊ ┊4┊export const removeChatMutation = gql`\n+┊ ┊5┊  mutation RemoveChat($chatId: ID!) {\n+┊ ┊6┊    removeChat(chatId: $chatId)\n+┊ ┊7┊  }\n+┊ ┊8┊`;\n```\n\n##### Added src&#x2F;graphql&#x2F;removeMessages.mutation.ts\n```diff\n@@ -0,0 +1,8 @@\n+┊ ┊1┊import gql from 'graphql-tag';\n+┊ ┊2┊\n+┊ ┊3┊// We use the gql tag to parse our query string into a query document\n+┊ ┊4┊export const removeMessagesMutation = gql`\n+┊ ┊5┊  mutation RemoveMessages($chatId: ID!, $messageIds: [ID]) {\n+┊ ┊6┊    removeMessages(chatId: $chatId, messageIds: $messageIds)\n+┊ ┊7┊  }\n+┊ ┊8┊`;\n```\n\n[}]: #\n\nOnce again, we run the GraphQL Code Generator to get the GQL services:\n\n    yarn generator\n\nNow we can import those services, create `removeChat` and `removeMessages` methods in which we call a mutation.\n\n[{]: <helper> (diffStep \"7.2\" files=\"src/app/services/chats.service.ts\" module=\"client\")\n\n#### [Step 7.2: Remove messages and chats](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/18cfa7c)\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -4,10 +4,16 @@\n ┊ 4┊ 4┊  GetChatsGQL,\n ┊ 5┊ 5┊  GetChatGQL,\n ┊ 6┊ 6┊  AddMessageGQL,\n+┊  ┊ 7┊  RemoveChatGQL,\n+┊  ┊ 8┊  RemoveMessagesGQL,\n+┊  ┊ 9┊  RemoveAllMessagesGQL,\n ┊ 7┊10┊  AddMessage,\n ┊ 8┊11┊  GetChats,\n-┊ 9┊  ┊  GetChat\n+┊  ┊12┊  GetChat,\n+┊  ┊13┊  RemoveMessages,\n+┊  ┊14┊  RemoveAllMessages,\n ┊10┊15┊} from '../../graphql';\n+┊  ┊16┊import { DataProxy } from 'apollo-cache';\n ┊11┊17┊\n ┊12┊18┊@Injectable()\n ┊13┊19┊export class ChatsService {\n```\n```diff\n@@ -16,7 +22,10 @@\n ┊16┊22┊  constructor(\n ┊17┊23┊    private getChatsGQL: GetChatsGQL,\n ┊18┊24┊    private getChatGQL: GetChatGQL,\n-┊19┊  ┊    private addMessageGQL: AddMessageGQL\n+┊  ┊25┊    private addMessageGQL: AddMessageGQL,\n+┊  ┊26┊    private removeChatGQL: RemoveChatGQL,\n+┊  ┊27┊    private removeMessagesGQL: RemoveMessagesGQL,\n+┊  ┊28┊    private removeAllMessagesGQL: RemoveAllMessagesGQL,\n ┊20┊29┊  ) {}\n ┊21┊30┊\n ┊22┊31┊  getChats() {\n```\n```diff\n@@ -92,4 +101,112 @@\n ┊ 92┊101┊      }\n ┊ 93┊102┊    });\n ┊ 94┊103┊  }\n+┊   ┊104┊\n+┊   ┊105┊  removeChat(chatId: string) {\n+┊   ┊106┊    return this.removeChatGQL.mutate(\n+┊   ┊107┊      {\n+┊   ┊108┊        chatId,\n+┊   ┊109┊      }, {\n+┊   ┊110┊        update: (store, { data: { removeChat } }) => {\n+┊   ┊111┊          // Read the data from our cache for this query.\n+┊   ┊112┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊113┊            query: this.getChatsGQL.document,\n+┊   ┊114┊            variables: {\n+┊   ┊115┊              amount: this.messagesAmount,\n+┊   ┊116┊            },\n+┊   ┊117┊          });\n+┊   ┊118┊          // Remove the chat (mutable)\n+┊   ┊119┊          for (const index of chats.keys()) {\n+┊   ┊120┊            if (chats[index].id === removeChat) {\n+┊   ┊121┊              chats.splice(index, 1);\n+┊   ┊122┊            }\n+┊   ┊123┊          }\n+┊   ┊124┊          // Write our data back to the cache.\n+┊   ┊125┊          store.writeQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊126┊            query: this.getChatsGQL.document,\n+┊   ┊127┊            variables: {\n+┊   ┊128┊              amount: this.messagesAmount,\n+┊   ┊129┊            },\n+┊   ┊130┊            data: {\n+┊   ┊131┊              chats,\n+┊   ┊132┊            },\n+┊   ┊133┊          });\n+┊   ┊134┊        },\n+┊   ┊135┊      }\n+┊   ┊136┊    );\n+┊   ┊137┊  }\n+┊   ┊138┊\n+┊   ┊139┊  removeMessages(chatId: string, messages: GetChat.Messages[], messageIdsOrAll: string[] | boolean) {\n+┊   ┊140┊    let ids: string[] = [];\n+┊   ┊141┊\n+┊   ┊142┊    const options = {\n+┊   ┊143┊      update: (store: DataProxy, { data: { removeMessages } }: {data: RemoveMessages.Mutation | RemoveAllMessages.Mutation}) => {\n+┊   ┊144┊        // Update the messages cache\n+┊   ┊145┊        {\n+┊   ┊146┊          // Read the data from our cache for this query.\n+┊   ┊147┊          const {chat} = store.readQuery<GetChat.Query, GetChat.Variables>({\n+┊   ┊148┊            query: this.getChatGQL.document,\n+┊   ┊149┊            variables: {\n+┊   ┊150┊              chatId,\n+┊   ┊151┊            }\n+┊   ┊152┊          });\n+┊   ┊153┊          // Remove the messages (mutable)\n+┊   ┊154┊          removeMessages.forEach(messageId => {\n+┊   ┊155┊            for (const index of chat.messages.keys()) {\n+┊   ┊156┊              if (chat.messages[index].id === messageId) {\n+┊   ┊157┊                chat.messages.splice(index, 1);\n+┊   ┊158┊              }\n+┊   ┊159┊            }\n+┊   ┊160┊          });\n+┊   ┊161┊          // Write our data back to the cache.\n+┊   ┊162┊          store.writeQuery<GetChat.Query, GetChat.Variables>({\n+┊   ┊163┊            query: this.getChatGQL.document,\n+┊   ┊164┊            data: {\n+┊   ┊165┊              chat\n+┊   ┊166┊            }\n+┊   ┊167┊          });\n+┊   ┊168┊        }\n+┊   ┊169┊        // Update last message cache\n+┊   ┊170┊        {\n+┊   ┊171┊          // Read the data from our cache for this query.\n+┊   ┊172┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊173┊            query: this.getChatsGQL.document,\n+┊   ┊174┊            variables: {\n+┊   ┊175┊              amount: this.messagesAmount,\n+┊   ┊176┊            },\n+┊   ┊177┊          });\n+┊   ┊178┊          // Fix last message\n+┊   ┊179┊          chats.find(chat => chat.id === chatId).messages = messages\n+┊   ┊180┊            .filter(message => !ids.includes(message.id))\n+┊   ┊181┊            .sort((a, b) => Number(b.createdAt) - Number(a.createdAt)) || [];\n+┊   ┊182┊          // Write our data back to the cache.\n+┊   ┊183┊          store.writeQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊184┊            query: this.getChatsGQL.document,\n+┊   ┊185┊            variables: {\n+┊   ┊186┊              amount: this.messagesAmount,\n+┊   ┊187┊            },\n+┊   ┊188┊            data: {\n+┊   ┊189┊              chats,\n+┊   ┊190┊            },\n+┊   ┊191┊          });\n+┊   ┊192┊        }\n+┊   ┊193┊      }\n+┊   ┊194┊    };\n+┊   ┊195┊\n+┊   ┊196┊    if (typeof messageIdsOrAll === 'boolean') {\n+┊   ┊197┊      ids = messages.map(message => message.id);\n+┊   ┊198┊\n+┊   ┊199┊      return this.removeAllMessagesGQL.mutate({\n+┊   ┊200┊        chatId,\n+┊   ┊201┊        all: messageIdsOrAll\n+┊   ┊202┊      }, options);\n+┊   ┊203┊    } else {\n+┊   ┊204┊      ids = messageIdsOrAll;\n+┊   ┊205┊\n+┊   ┊206┊      return this.removeMessagesGQL.mutate({\n+┊   ┊207┊        chatId,\n+┊   ┊208┊        messageIds: messageIdsOrAll,\n+┊   ┊209┊      }, options);\n+┊   ┊210┊    }\n+┊   ┊211┊  }\n ┊ 95┊212┊}\n```\n\n[}]: #\n\nIt might seem like a lot but we simply just updating the store there.\n\n### Summary\n\nThe selectable list directive supports much more different use cases, for info please read the documentation.\n\nAs you can see `ngx-selectable-list` takes care of most of the boilerplate, giving us the freedom to concentrate on the actual code."
          },
          {
            "manualTitle": "Step 12: Chats creation",
            "stepRevision": "ee69029ee3985a5b2d46874694315646d04e5cd0",
            "manualView": "![new-chat](https://user-images.githubusercontent.com/7648874/49270347-ea25ea00-f4a3-11e8-98ac-f67de8bfd8d5.png)\n\n![new-group](https://user-images.githubusercontent.com/7648874/49270350-ec884400-f4a3-11e8-8baa-b6bba0f7f539.png)\n\nWe still cannot create new chats or groups, so let's implement it.\n\nWe're going to create a `ChatsCreation` module, with a `NewChat` and a `NewGroup` containers, along with several presentational components.\n\nWe're going to make use of the selectable list directive once again, to ease selecting the users when we're creating a new group.\nYou should also notice that we are looking for existing chats before creating a new one: if it already exists we're simply redirecting to that chat instead of creating a new one (the server wouldn't allow that anyway and it will simply\nreturn the chat id).\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/graphql/\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n##### Added src&#x2F;graphql&#x2F;addChat.mutation.ts\n```diff\n@@ -0,0 +1,17 @@\n+┊  ┊ 1┊import gql from 'graphql-tag';\n+┊  ┊ 2┊import {fragments} from './fragment';\n+┊  ┊ 3┊\n+┊  ┊ 4┊// We use the gql tag to parse our query string into a query document\n+┊  ┊ 5┊export const addChatMutation = gql`\n+┊  ┊ 6┊  mutation AddChat($recipientId: ID!) {\n+┊  ┊ 7┊    addChat(recipientId: $recipientId) {\n+┊  ┊ 8┊      ...ChatWithoutMessages\n+┊  ┊ 9┊      messages {\n+┊  ┊10┊        ...Message\n+┊  ┊11┊      }\n+┊  ┊12┊    }\n+┊  ┊13┊  }\n+┊  ┊14┊\n+┊  ┊15┊  ${fragments['chatWithoutMessages']}\n+┊  ┊16┊  ${fragments['message']}\n+┊  ┊17┊`;\n```\n\n##### Added src&#x2F;graphql&#x2F;addGroup.mutation.ts\n```diff\n@@ -0,0 +1,17 @@\n+┊  ┊ 1┊import gql from 'graphql-tag';\n+┊  ┊ 2┊import {fragments} from './fragment';\n+┊  ┊ 3┊\n+┊  ┊ 4┊// We use the gql tag to parse our query string into a query document\n+┊  ┊ 5┊export const addGroupMutation = gql`\n+┊  ┊ 6┊  mutation AddGroup($recipientIds: [ID!]!, $groupName: String!) {\n+┊  ┊ 7┊    addGroup(recipientIds: $recipientIds, groupName: $groupName) {\n+┊  ┊ 8┊      ...ChatWithoutMessages\n+┊  ┊ 9┊      messages {\n+┊  ┊10┊        ...Message\n+┊  ┊11┊      }\n+┊  ┊12┊    }\n+┊  ┊13┊  }\n+┊  ┊14┊\n+┊  ┊15┊  ${fragments['chatWithoutMessages']}\n+┊  ┊16┊  ${fragments['message']}\n+┊  ┊17┊`;\n```\n\n##### Added src&#x2F;graphql&#x2F;getUsers.query.ts\n```diff\n@@ -0,0 +1,12 @@\n+┊  ┊ 1┊import gql from 'graphql-tag';\n+┊  ┊ 2┊\n+┊  ┊ 3┊// We use the gql tag to parse our query string into a query document\n+┊  ┊ 4┊export const getUsersQuery = gql`\n+┊  ┊ 5┊  query GetUsers {\n+┊  ┊ 6┊    users {\n+┊  ┊ 7┊      id,\n+┊  ┊ 8┊      name,\n+┊  ┊ 9┊      picture,\n+┊  ┊10┊    }\n+┊  ┊11┊  }\n+┊  ┊12┊`;\n```\n\n[}]: #\n\nAfter creating the mutations we should run the generator to create the corresponding types and services:\n\n    yarn generator\n\nLet's jump straight into `ChatsService` and add few new methods:\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/app/services/chats.service.ts\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,5 +1,7 @@\n ┊1┊1┊import {map} from 'rxjs/operators';\n ┊2┊2┊import {Injectable} from '@angular/core';\n+┊ ┊3┊import {Observable} from 'rxjs';\n+┊ ┊4┊import {QueryRef} from 'apollo-angular';\n ┊3┊5┊import {\n ┊4┊6┊  GetChatsGQL,\n ┊5┊7┊  GetChatGQL,\n```\n```diff\n@@ -7,6 +9,9 @@\n ┊ 7┊ 9┊  RemoveChatGQL,\n ┊ 8┊10┊  RemoveMessagesGQL,\n ┊ 9┊11┊  RemoveAllMessagesGQL,\n+┊  ┊12┊  GetUsersGQL,\n+┊  ┊13┊  AddChatGQL,\n+┊  ┊14┊  AddGroupGQL,\n ┊10┊15┊  AddMessage,\n ┊11┊16┊  GetChats,\n ┊12┊17┊  GetChat,\n```\n```diff\n@@ -15,9 +20,14 @@\n ┊15┊20┊} from '../../graphql';\n ┊16┊21┊import { DataProxy } from 'apollo-cache';\n ┊17┊22┊\n+┊  ┊23┊const currentUserId = '1';\n+┊  ┊24┊\n ┊18┊25┊@Injectable()\n ┊19┊26┊export class ChatsService {\n ┊20┊27┊  messagesAmount = 3;\n+┊  ┊28┊  getChatsWq: QueryRef<GetChats.Query, GetChats.Variables>;\n+┊  ┊29┊  chats$: Observable<GetChats.Chats[]>;\n+┊  ┊30┊  chats: GetChats.Chats[];\n ┊21┊31┊\n ┊22┊32┊  constructor(\n ┊23┊33┊    private getChatsGQL: GetChatsGQL,\n```\n```diff\n@@ -26,17 +36,21 @@\n ┊26┊36┊    private removeChatGQL: RemoveChatGQL,\n ┊27┊37┊    private removeMessagesGQL: RemoveMessagesGQL,\n ┊28┊38┊    private removeAllMessagesGQL: RemoveAllMessagesGQL,\n-┊29┊  ┊  ) {}\n-┊30┊  ┊\n-┊31┊  ┊  getChats() {\n-┊32┊  ┊    const query = this.getChatsGQL.watch({\n+┊  ┊39┊    private getUsersGQL: GetUsersGQL,\n+┊  ┊40┊    private addChatGQL: AddChatGQL,\n+┊  ┊41┊    private addGroupGQL: AddGroupGQL\n+┊  ┊42┊  ) {\n+┊  ┊43┊    this.getChatsWq = this.getChatsGQL.watch({\n ┊33┊44┊      amount: this.messagesAmount,\n ┊34┊45┊    });\n-┊35┊  ┊    const chats$ = query.valueChanges.pipe(\n+┊  ┊46┊    this.chats$ = this.getChatsWq.valueChanges.pipe(\n ┊36┊47┊      map((result) => result.data.chats)\n ┊37┊48┊    );\n+┊  ┊49┊    this.chats$.subscribe(chats => this.chats = chats);\n+┊  ┊50┊  }\n ┊38┊51┊\n-┊39┊  ┊    return {query, chats$};\n+┊  ┊52┊  getChats() {\n+┊  ┊53┊    return {query: this.getChatsWq, chats$: this.chats$};\n ┊40┊54┊  }\n ┊41┊55┊\n ┊42┊56┊  getChat(chatId: string) {\n```\n```diff\n@@ -209,4 +223,83 @@\n ┊209┊223┊      }, options);\n ┊210┊224┊    }\n ┊211┊225┊  }\n+┊   ┊226┊\n+┊   ┊227┊  getUsers() {\n+┊   ┊228┊    const query = this.getUsersGQL.watch();\n+┊   ┊229┊    const users$ = query.valueChanges.pipe(\n+┊   ┊230┊      map((result) => result.data.users)\n+┊   ┊231┊    );\n+┊   ┊232┊\n+┊   ┊233┊    return {query, users$};\n+┊   ┊234┊  }\n+┊   ┊235┊\n+┊   ┊236┊  // Checks if the chat is listed for the current user and returns the id\n+┊   ┊237┊  getChatId(recipientId: string) {\n+┊   ┊238┊    const _chat = this.chats.find(chat => {\n+┊   ┊239┊      return !chat.isGroup && !!chat.allTimeMembers.find(user => user.id === currentUserId) &&\n+┊   ┊240┊        !!chat.allTimeMembers.find(user => user.id === recipientId);\n+┊   ┊241┊    });\n+┊   ┊242┊    return _chat ? _chat.id : false;\n+┊   ┊243┊  }\n+┊   ┊244┊\n+┊   ┊245┊  addChat(recipientId: string) {\n+┊   ┊246┊    return this.addChatGQL.mutate(\n+┊   ┊247┊      {\n+┊   ┊248┊        recipientId,\n+┊   ┊249┊      }, {\n+┊   ┊250┊        update: (store, { data: { addChat } }) => {\n+┊   ┊251┊          // Read the data from our cache for this query.\n+┊   ┊252┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊253┊            query: this.getChatsGQL.document,\n+┊   ┊254┊            variables: {\n+┊   ┊255┊              amount: this.messagesAmount,\n+┊   ┊256┊            },\n+┊   ┊257┊          });\n+┊   ┊258┊          // Add our comment from the mutation to the end.\n+┊   ┊259┊          chats.push(addChat);\n+┊   ┊260┊          // Write our data back to the cache.\n+┊   ┊261┊          store.writeQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊262┊            query: this.getChatsGQL.document,\n+┊   ┊263┊            variables: {\n+┊   ┊264┊              amount: this.messagesAmount,\n+┊   ┊265┊            },\n+┊   ┊266┊            data: {\n+┊   ┊267┊              chats,\n+┊   ┊268┊            },\n+┊   ┊269┊          });\n+┊   ┊270┊        },\n+┊   ┊271┊      }\n+┊   ┊272┊    );\n+┊   ┊273┊  }\n+┊   ┊274┊\n+┊   ┊275┊  addGroup(recipientIds: string[], groupName: string) {\n+┊   ┊276┊    return this.addGroupGQL.mutate(\n+┊   ┊277┊      {\n+┊   ┊278┊        recipientIds,\n+┊   ┊279┊        groupName,\n+┊   ┊280┊      }, {\n+┊   ┊281┊        update: (store, { data: { addGroup } }) => {\n+┊   ┊282┊          // Read the data from our cache for this query.\n+┊   ┊283┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊284┊            query: this.getChatsGQL.document,\n+┊   ┊285┊            variables: {\n+┊   ┊286┊              amount: this.messagesAmount,\n+┊   ┊287┊            },\n+┊   ┊288┊          });\n+┊   ┊289┊          // Add our comment from the mutation to the end.\n+┊   ┊290┊          chats.push(addGroup);\n+┊   ┊291┊          // Write our data back to the cache.\n+┊   ┊292┊          store.writeQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊293┊            query: this.getChatsGQL.document,\n+┊   ┊294┊            variables: {\n+┊   ┊295┊              amount: this.messagesAmount,\n+┊   ┊296┊            },\n+┊   ┊297┊            data: {\n+┊   ┊298┊              chats,\n+┊   ┊299┊            },\n+┊   ┊300┊          });\n+┊   ┊301┊        },\n+┊   ┊302┊      }\n+┊   ┊303┊    );\n+┊   ┊304┊  }\n ┊212┊305┊}\n```\n\n[}]: #\n\nOkay, now since we got the GraphQL part ready, we're going to focus on the component.\n\nFirst, we will download the default group-chat picture:\n\n    $ wget https://raw.githubusercontent.com/DAB0mB/whatsapp-client-angularcli-material/c75c2416b1990da3588015f76b8338764f44d6ec/src/assets/default-group-pic.jpg -P src/assets\n\nAnd update the relevant chat components to use it when necessary:\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/app/chat-viewer/containers/chat/chat.component.ts, src/app/chats-lister/components/chat-item/chat-item.component.ts\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n\n\n[}]: #\n\nThen we will create a space to add a new group:\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/app/chats-creation/containers/new-group/new-group.component.ts, src/app/chats-creation/containers/new-group/new-group.component.scss\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-group&#x2F;new-group.component.scss\n\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-group&#x2F;new-group.component.ts\n```diff\n@@ -0,0 +1,60 @@\n+┊  ┊ 1┊import {Component, OnInit} from '@angular/core';\n+┊  ┊ 2┊import {Location} from '@angular/common';\n+┊  ┊ 3┊import {Router} from '@angular/router';\n+┊  ┊ 4┊import {AddGroup, GetUsers} from '../../../../graphql';\n+┊  ┊ 5┊import {ChatsService} from '../../../services/chats.service';\n+┊  ┊ 6┊\n+┊  ┊ 7┊@Component({\n+┊  ┊ 8┊  template: `\n+┊  ┊ 9┊    <app-toolbar>\n+┊  ┊10┊      <button class=\"navigation\" mat-button (click)=\"goBack()\">\n+┊  ┊11┊        <mat-icon aria-label=\"Icon-button with an arrow back icon\">arrow_back</mat-icon>\n+┊  ┊12┊      </button>\n+┊  ┊13┊      <div class=\"title\">New group</div>\n+┊  ┊14┊    </app-toolbar>\n+┊  ┊15┊\n+┊  ┊16┊    <app-users-list *ngIf=\"!recipientIds.length\" [items]=\"users\"\n+┊  ┊17┊                    libSelectableList=\"multiple_tap\" (multiple)=\"selectUsers($event)\">\n+┊  ┊18┊      <app-confirm-selection #confirmSelection icon=\"arrow_forward\"></app-confirm-selection>\n+┊  ┊19┊    </app-users-list>\n+┊  ┊20┊    <app-new-group-details *ngIf=\"recipientIds.length\" [users]=\"getSelectedUsers()\"\n+┊  ┊21┊                           (groupDetails)=\"addGroup($event)\"></app-new-group-details>\n+┊  ┊22┊  `,\n+┊  ┊23┊  styleUrls: ['new-group.component.scss'],\n+┊  ┊24┊})\n+┊  ┊25┊export class NewGroupComponent implements OnInit {\n+┊  ┊26┊  users: GetUsers.Users[];\n+┊  ┊27┊  recipientIds: string[] = [];\n+┊  ┊28┊\n+┊  ┊29┊  constructor(private router: Router,\n+┊  ┊30┊              private location: Location,\n+┊  ┊31┊              private chatsService: ChatsService) {}\n+┊  ┊32┊\n+┊  ┊33┊  ngOnInit () {\n+┊  ┊34┊    this.chatsService.getUsers().users$.subscribe(users => this.users = users);\n+┊  ┊35┊  }\n+┊  ┊36┊\n+┊  ┊37┊  goBack() {\n+┊  ┊38┊    if (this.recipientIds.length) {\n+┊  ┊39┊      this.recipientIds = [];\n+┊  ┊40┊    } else {\n+┊  ┊41┊      this.location.back();\n+┊  ┊42┊    }\n+┊  ┊43┊  }\n+┊  ┊44┊\n+┊  ┊45┊  selectUsers(recipientIds: string[]) {\n+┊  ┊46┊    this.recipientIds = recipientIds;\n+┊  ┊47┊  }\n+┊  ┊48┊\n+┊  ┊49┊  getSelectedUsers() {\n+┊  ┊50┊    return this.users.filter(user => this.recipientIds.includes(user.id));\n+┊  ┊51┊  }\n+┊  ┊52┊\n+┊  ┊53┊  addGroup(groupName: string) {\n+┊  ┊54┊    if (groupName && this.recipientIds.length) {\n+┊  ┊55┊      this.chatsService.addGroup(this.recipientIds, groupName).subscribe(({data: {addGroup: {id}}}: { data: AddGroup.Mutation }) => {\n+┊  ┊56┊        this.router.navigate(['/chat', id]);\n+┊  ┊57┊      });\n+┊  ┊58┊    }\n+┊  ┊59┊  }\n+┊  ┊60┊}\n```\n\n[}]: #\n\nAnd after, a new chat view:\n\nsrc/app/chats-creation/containers/new-chat/new-chat.component.scss, src/app/chats-creation/containers/new-chat/new-chat.component.ts\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/app/app.module.ts, src/app/chats-creation, src/app/services\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n##### Changed src&#x2F;app&#x2F;app.module.ts\n```diff\n@@ -7,6 +7,7 @@\n ┊ 7┊ 7┊import {ChatsListerModule} from './chats-lister/chats-lister.module';\n ┊ 8┊ 8┊import {RouterModule, Routes} from '@angular/router';\n ┊ 9┊ 9┊import {ChatViewerModule} from './chat-viewer/chat-viewer.module';\n+┊  ┊10┊import {ChatsCreationModule} from './chats-creation/chats-creation.module';\n ┊10┊11┊const routes: Routes = [];\n ┊11┊12┊\n ┊12┊13┊@NgModule({\n```\n```diff\n@@ -22,6 +23,7 @@\n ┊22┊23┊    // Feature modules\n ┊23┊24┊    ChatsListerModule,\n ┊24┊25┊    ChatViewerModule,\n+┊  ┊26┊    ChatsCreationModule,\n ┊25┊27┊  ],\n ┊26┊28┊  providers: [],\n ┊27┊29┊  bootstrap: [AppComponent]\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;chats-creation.module.ts\n```diff\n@@ -0,0 +1,60 @@\n+┊  ┊ 1┊import { BrowserModule } from '@angular/platform-browser';\n+┊  ┊ 2┊import { NgModule } from '@angular/core';\n+┊  ┊ 3┊\n+┊  ┊ 4┊import {BrowserAnimationsModule} from '@angular/platform-browser/animations';\n+┊  ┊ 5┊import {\n+┊  ┊ 6┊  MatButtonModule, MatFormFieldModule, MatGridListModule, MatIconModule, MatInputModule, MatListModule, MatMenuModule,\n+┊  ┊ 7┊  MatToolbarModule\n+┊  ┊ 8┊} from '@angular/material';\n+┊  ┊ 9┊import {RouterModule, Routes} from '@angular/router';\n+┊  ┊10┊import {FormsModule} from '@angular/forms';\n+┊  ┊11┊import {ChatsService} from '../services/chats.service';\n+┊  ┊12┊import {UserItemComponent} from './components/user-item/user-item.component';\n+┊  ┊13┊import {UsersListComponent} from './components/users-list/users-list.component';\n+┊  ┊14┊import {NewGroupComponent} from './containers/new-group/new-group.component';\n+┊  ┊15┊import {NewChatComponent} from './containers/new-chat/new-chat.component';\n+┊  ┊16┊import {NewGroupDetailsComponent} from './components/new-group-details/new-group-details.component';\n+┊  ┊17┊import {SharedModule} from '../shared/shared.module';\n+┊  ┊18┊import {NgxSelectableListModule} from 'ngx-selectable-list';\n+┊  ┊19┊\n+┊  ┊20┊const routes: Routes = [\n+┊  ┊21┊  {path: 'new-chat', component: NewChatComponent},\n+┊  ┊22┊  {path: 'new-group', component: NewGroupComponent},\n+┊  ┊23┊];\n+┊  ┊24┊\n+┊  ┊25┊@NgModule({\n+┊  ┊26┊  declarations: [\n+┊  ┊27┊    NewChatComponent,\n+┊  ┊28┊    UsersListComponent,\n+┊  ┊29┊    NewGroupComponent,\n+┊  ┊30┊    UserItemComponent,\n+┊  ┊31┊    NewGroupDetailsComponent,\n+┊  ┊32┊  ],\n+┊  ┊33┊  imports: [\n+┊  ┊34┊    BrowserModule,\n+┊  ┊35┊    // Animations (for Material)\n+┊  ┊36┊    BrowserAnimationsModule,\n+┊  ┊37┊    // Material\n+┊  ┊38┊    MatToolbarModule,\n+┊  ┊39┊    MatMenuModule,\n+┊  ┊40┊    MatIconModule,\n+┊  ┊41┊    MatButtonModule,\n+┊  ┊42┊    MatListModule,\n+┊  ┊43┊    MatGridListModule,\n+┊  ┊44┊    MatInputModule,\n+┊  ┊45┊    MatFormFieldModule,\n+┊  ┊46┊    MatGridListModule,\n+┊  ┊47┊    // Routing\n+┊  ┊48┊    RouterModule.forChild(routes),\n+┊  ┊49┊    // Forms\n+┊  ┊50┊    FormsModule,\n+┊  ┊51┊    // Feature modules\n+┊  ┊52┊    NgxSelectableListModule,\n+┊  ┊53┊    SharedModule,\n+┊  ┊54┊  ],\n+┊  ┊55┊  providers: [\n+┊  ┊56┊    ChatsService,\n+┊  ┊57┊  ],\n+┊  ┊58┊})\n+┊  ┊59┊export class ChatsCreationModule {\n+┊  ┊60┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;new-group-details&#x2F;new-group-details.component.scss\n```diff\n@@ -0,0 +1,25 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊}\n+┊  ┊ 4┊\n+┊  ┊ 5┊div {\n+┊  ┊ 6┊  padding: 16px;\n+┊  ┊ 7┊  mat-form-field {\n+┊  ┊ 8┊    width: 100%;\n+┊  ┊ 9┊  }\n+┊  ┊10┊}\n+┊  ┊11┊\n+┊  ┊12┊.new-group {\n+┊  ┊13┊  position: absolute;\n+┊  ┊14┊  bottom: 5vw;\n+┊  ┊15┊  right: 5vw;\n+┊  ┊16┊}\n+┊  ┊17┊\n+┊  ┊18┊.users {\n+┊  ┊19┊  display: flex;\n+┊  ┊20┊  flex-flow: row wrap;\n+┊  ┊21┊  img {\n+┊  ┊22┊    flex: 0 1 8vh;\n+┊  ┊23┊    height: 8vh;\n+┊  ┊24┊  }\n+┊  ┊25┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;new-group-details&#x2F;new-group-details.component.ts\n```diff\n@@ -0,0 +1,34 @@\n+┊  ┊ 1┊import {Component, EventEmitter, Input, Output} from '@angular/core';\n+┊  ┊ 2┊import {GetUsers} from '../../../../graphql';\n+┊  ┊ 3┊\n+┊  ┊ 4┊@Component({\n+┊  ┊ 5┊  selector: 'app-new-group-details',\n+┊  ┊ 6┊  template: `\n+┊  ┊ 7┊    <div>\n+┊  ┊ 8┊      <mat-form-field>\n+┊  ┊ 9┊        <input matInput placeholder=\"Group name\" [(ngModel)]=\"groupName\">\n+┊  ┊10┊      </mat-form-field>\n+┊  ┊11┊    </div>\n+┊  ┊12┊    <button [disabled]=\"!groupName\" class=\"new-group\" mat-fab color=\"primary\" (click)=\"emitGroupDetails()\">\n+┊  ┊13┊      <mat-icon aria-label=\"Icon-button with a + icon\">arrow_forward</mat-icon>\n+┊  ┊14┊    </button>\n+┊  ┊15┊    <div>Members</div>\n+┊  ┊16┊    <div class=\"users\">\n+┊  ┊17┊      <img *ngFor=\"let user of users;\" [src]=\"user.picture\"/>\n+┊  ┊18┊    </div>\n+┊  ┊19┊  `,\n+┊  ┊20┊  styleUrls: ['new-group-details.component.scss'],\n+┊  ┊21┊})\n+┊  ┊22┊export class NewGroupDetailsComponent {\n+┊  ┊23┊  groupName: string;\n+┊  ┊24┊  @Input()\n+┊  ┊25┊  users: GetUsers.Users[];\n+┊  ┊26┊  @Output()\n+┊  ┊27┊  groupDetails = new EventEmitter<string>();\n+┊  ┊28┊\n+┊  ┊29┊  emitGroupDetails() {\n+┊  ┊30┊    if (this.groupDetails) {\n+┊  ┊31┊      this.groupDetails.emit(this.groupName);\n+┊  ┊32┊    }\n+┊  ┊33┊  }\n+┊  ┊34┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;user-item&#x2F;user-item.component.scss\n```diff\n@@ -0,0 +1,32 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊  width: 100%;\n+┊  ┊ 4┊  height: 100%;\n+┊  ┊ 5┊}\n+┊  ┊ 6┊\n+┊  ┊ 7┊button {\n+┊  ┊ 8┊  margin: 10px;\n+┊  ┊ 9┊  height: 50px;\n+┊  ┊10┊  padding: 1px 6px;\n+┊  ┊11┊  line-height: 50px;\n+┊  ┊12┊  border: none;\n+┊  ┊13┊  margin: 0;\n+┊  ┊14┊\n+┊  ┊15┊  img {\n+┊  ┊16┊    float: left;\n+┊  ┊17┊    margin-right: 10px;\n+┊  ┊18┊    height: 50px;\n+┊  ┊19┊    width: 50px;\n+┊  ┊20┊    text-align: center;\n+┊  ┊21┊    line-height: inherit;\n+┊  ┊22┊    border-radius: 50%;\n+┊  ┊23┊  }\n+┊  ┊24┊\n+┊  ┊25┊  div {\n+┊  ┊26┊    float: left;\n+┊  ┊27┊    line-height: inherit;\n+┊  ┊28┊    font-family: Roboto, \"Helvetica Neue\", sans-serif;\n+┊  ┊29┊    font-weight: bold;\n+┊  ┊30┊    font-size: 16px;\n+┊  ┊31┊  }\n+┊  ┊32┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;user-item&#x2F;user-item.component.ts\n```diff\n@@ -0,0 +1,18 @@\n+┊  ┊ 1┊import {Component, Input} from '@angular/core';\n+┊  ┊ 2┊import {GetUsers} from '../../../../graphql';\n+┊  ┊ 3┊\n+┊  ┊ 4┊@Component({\n+┊  ┊ 5┊  selector: 'app-user-item',\n+┊  ┊ 6┊  template: `\n+┊  ┊ 7┊    <button mat-menu-item>\n+┊  ┊ 8┊      <img [src]=\"user.picture || 'assets/default-profile-pic.jpg'\">\n+┊  ┊ 9┊      <div>{{ user.name }}</div>\n+┊  ┊10┊    </button>\n+┊  ┊11┊  `,\n+┊  ┊12┊  styleUrls: ['user-item.component.scss']\n+┊  ┊13┊})\n+┊  ┊14┊export class UserItemComponent {\n+┊  ┊15┊  // tslint:disable-next-line:no-input-rename\n+┊  ┊16┊  @Input('item')\n+┊  ┊17┊  user: GetUsers.Users;\n+┊  ┊18┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;users-list&#x2F;users-list.component.scss\n```diff\n@@ -0,0 +1,13 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊}\n+┊  ┊ 4┊\n+┊  ┊ 5┊:host ::ng-deep mat-list-item:first-child div:first-child {\n+┊  ┊ 6┊  padding: 0 !important;\n+┊  ┊ 7┊  margin: 5px;\n+┊  ┊ 8┊  margin-top: 20px;\n+┊  ┊ 9┊}\n+┊  ┊10┊\n+┊  ┊11┊mat-list {\n+┊  ┊12┊  padding: 0;\n+┊  ┊13┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;users-list&#x2F;users-list.component.ts\n```diff\n@@ -0,0 +1,24 @@\n+┊  ┊ 1┊import {Component, Input} from '@angular/core';\n+┊  ┊ 2┊import {GetUsers} from '../../../../graphql';\n+┊  ┊ 3┊import {SelectableListDirective} from 'ngx-selectable-list';\n+┊  ┊ 4┊\n+┊  ┊ 5┊@Component({\n+┊  ┊ 6┊  selector: 'app-users-list',\n+┊  ┊ 7┊  template: `\n+┊  ┊ 8┊    <mat-list>\n+┊  ┊ 9┊      <mat-list-item *ngFor=\"let user of users\">\n+┊  ┊10┊        <app-user-item [item]=\"user\"\n+┊  ┊11┊                       libSelectableItem></app-user-item>\n+┊  ┊12┊      </mat-list-item>\n+┊  ┊13┊    </mat-list>\n+┊  ┊14┊    <ng-content *ngIf=\"selectableListDirective.selecting\"></ng-content>\n+┊  ┊15┊  `,\n+┊  ┊16┊  styleUrls: ['users-list.component.scss'],\n+┊  ┊17┊})\n+┊  ┊18┊export class UsersListComponent {\n+┊  ┊19┊  // tslint:disable-next-line:no-input-rename\n+┊  ┊20┊  @Input('items')\n+┊  ┊21┊  users: GetUsers.Users[];\n+┊  ┊22┊\n+┊  ┊23┊  constructor(public selectableListDirective: SelectableListDirective) {}\n+┊  ┊24┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-chat&#x2F;new-chat.component.scss\n```diff\n@@ -0,0 +1,23 @@\n+┊  ┊ 1┊.new-group {\n+┊  ┊ 2┊  margin: 10px;\n+┊  ┊ 3┊  height: 50px;\n+┊  ┊ 4┊  line-height: 50px;\n+┊  ┊ 5┊  margin-top: 20px;\n+┊  ┊ 6┊\n+┊  ┊ 7┊  mat-icon {\n+┊  ┊ 8┊    float: left;\n+┊  ┊ 9┊    margin-right: 10px;\n+┊  ┊10┊    height: 50px;\n+┊  ┊11┊    width: 50px;\n+┊  ┊12┊    text-align: center;\n+┊  ┊13┊    line-height: inherit;\n+┊  ┊14┊    border-radius: 50%;\n+┊  ┊15┊  }\n+┊  ┊16┊\n+┊  ┊17┊  div {\n+┊  ┊18┊    float: left;\n+┊  ┊19┊    line-height: inherit;\n+┊  ┊20┊    font-family: Roboto, \"Helvetica Neue\", sans-serif;\n+┊  ┊21┊    font-weight: bold;\n+┊  ┊22┊  }\n+┊  ┊23┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-chat&#x2F;new-chat.component.ts\n```diff\n@@ -0,0 +1,55 @@\n+┊  ┊ 1┊import {Component, OnInit} from '@angular/core';\n+┊  ┊ 2┊import {Location} from '@angular/common';\n+┊  ┊ 3┊import {Router} from '@angular/router';\n+┊  ┊ 4┊import {AddChat, GetUsers} from '../../../../graphql';\n+┊  ┊ 5┊import {ChatsService} from '../../../services/chats.service';\n+┊  ┊ 6┊\n+┊  ┊ 7┊@Component({\n+┊  ┊ 8┊  template: `\n+┊  ┊ 9┊    <app-toolbar>\n+┊  ┊10┊      <button class=\"navigation\" mat-button (click)=\"goBack()\">\n+┊  ┊11┊        <mat-icon aria-label=\"Icon-button with an arrow back icon\">arrow_back</mat-icon>\n+┊  ┊12┊      </button>\n+┊  ┊13┊      <div class=\"title\">New chat</div>\n+┊  ┊14┊    </app-toolbar>\n+┊  ┊15┊    <div class=\"new-group\" (click)=\"goToNewGroup()\">\n+┊  ┊16┊      <mat-icon color=\"secondary\" aria-label=\"Icon-button with a group add icon\">group_add</mat-icon>\n+┊  ┊17┊      <div>New group</div>\n+┊  ┊18┊    </div>\n+┊  ┊19┊    <app-users-list [items]=\"users\"\n+┊  ┊20┊                    libSelectableList=\"single\" (single)=\"addChat($event)\">\n+┊  ┊21┊    </app-users-list>\n+┊  ┊22┊  `,\n+┊  ┊23┊  styleUrls: ['new-chat.component.scss'],\n+┊  ┊24┊})\n+┊  ┊25┊export class NewChatComponent implements OnInit {\n+┊  ┊26┊  users: GetUsers.Users[];\n+┊  ┊27┊\n+┊  ┊28┊  constructor(private router: Router,\n+┊  ┊29┊              private location: Location,\n+┊  ┊30┊              private chatsService: ChatsService) {}\n+┊  ┊31┊\n+┊  ┊32┊  ngOnInit () {\n+┊  ┊33┊    this.chatsService.getUsers().users$.subscribe(users => this.users = users);\n+┊  ┊34┊  }\n+┊  ┊35┊\n+┊  ┊36┊  goBack() {\n+┊  ┊37┊    this.location.back();\n+┊  ┊38┊  }\n+┊  ┊39┊\n+┊  ┊40┊  goToNewGroup() {\n+┊  ┊41┊    this.router.navigate(['/new-group']);\n+┊  ┊42┊  }\n+┊  ┊43┊\n+┊  ┊44┊  addChat(recipientId: string) {\n+┊  ┊45┊    const chatId = this.chatsService.getChatId(recipientId);\n+┊  ┊46┊    if (chatId) {\n+┊  ┊47┊      // Chat is already listed for the current user\n+┊  ┊48┊      this.router.navigate(['/chat', chatId]);\n+┊  ┊49┊    } else {\n+┊  ┊50┊      this.chatsService.addChat(recipientId).subscribe(({data: {addChat: {id}}}: { data: AddChat.Mutation }) => {\n+┊  ┊51┊        this.router.navigate(['/chat', id]);\n+┊  ┊52┊      });\n+┊  ┊53┊    }\n+┊  ┊54┊  }\n+┊  ┊55┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-group&#x2F;new-group.component.scss\n\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-group&#x2F;new-group.component.ts\n```diff\n@@ -0,0 +1,60 @@\n+┊  ┊ 1┊import {Component, OnInit} from '@angular/core';\n+┊  ┊ 2┊import {Location} from '@angular/common';\n+┊  ┊ 3┊import {Router} from '@angular/router';\n+┊  ┊ 4┊import {AddGroup, GetUsers} from '../../../../graphql';\n+┊  ┊ 5┊import {ChatsService} from '../../../services/chats.service';\n+┊  ┊ 6┊\n+┊  ┊ 7┊@Component({\n+┊  ┊ 8┊  template: `\n+┊  ┊ 9┊    <app-toolbar>\n+┊  ┊10┊      <button class=\"navigation\" mat-button (click)=\"goBack()\">\n+┊  ┊11┊        <mat-icon aria-label=\"Icon-button with an arrow back icon\">arrow_back</mat-icon>\n+┊  ┊12┊      </button>\n+┊  ┊13┊      <div class=\"title\">New group</div>\n+┊  ┊14┊    </app-toolbar>\n+┊  ┊15┊\n+┊  ┊16┊    <app-users-list *ngIf=\"!recipientIds.length\" [items]=\"users\"\n+┊  ┊17┊                    libSelectableList=\"multiple_tap\" (multiple)=\"selectUsers($event)\">\n+┊  ┊18┊      <app-confirm-selection #confirmSelection icon=\"arrow_forward\"></app-confirm-selection>\n+┊  ┊19┊    </app-users-list>\n+┊  ┊20┊    <app-new-group-details *ngIf=\"recipientIds.length\" [users]=\"getSelectedUsers()\"\n+┊  ┊21┊                           (groupDetails)=\"addGroup($event)\"></app-new-group-details>\n+┊  ┊22┊  `,\n+┊  ┊23┊  styleUrls: ['new-group.component.scss'],\n+┊  ┊24┊})\n+┊  ┊25┊export class NewGroupComponent implements OnInit {\n+┊  ┊26┊  users: GetUsers.Users[];\n+┊  ┊27┊  recipientIds: string[] = [];\n+┊  ┊28┊\n+┊  ┊29┊  constructor(private router: Router,\n+┊  ┊30┊              private location: Location,\n+┊  ┊31┊              private chatsService: ChatsService) {}\n+┊  ┊32┊\n+┊  ┊33┊  ngOnInit () {\n+┊  ┊34┊    this.chatsService.getUsers().users$.subscribe(users => this.users = users);\n+┊  ┊35┊  }\n+┊  ┊36┊\n+┊  ┊37┊  goBack() {\n+┊  ┊38┊    if (this.recipientIds.length) {\n+┊  ┊39┊      this.recipientIds = [];\n+┊  ┊40┊    } else {\n+┊  ┊41┊      this.location.back();\n+┊  ┊42┊    }\n+┊  ┊43┊  }\n+┊  ┊44┊\n+┊  ┊45┊  selectUsers(recipientIds: string[]) {\n+┊  ┊46┊    this.recipientIds = recipientIds;\n+┊  ┊47┊  }\n+┊  ┊48┊\n+┊  ┊49┊  getSelectedUsers() {\n+┊  ┊50┊    return this.users.filter(user => this.recipientIds.includes(user.id));\n+┊  ┊51┊  }\n+┊  ┊52┊\n+┊  ┊53┊  addGroup(groupName: string) {\n+┊  ┊54┊    if (groupName && this.recipientIds.length) {\n+┊  ┊55┊      this.chatsService.addGroup(this.recipientIds, groupName).subscribe(({data: {addGroup: {id}}}: { data: AddGroup.Mutation }) => {\n+┊  ┊56┊        this.router.navigate(['/chat', id]);\n+┊  ┊57┊      });\n+┊  ┊58┊    }\n+┊  ┊59┊  }\n+┊  ┊60┊}\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,5 +1,7 @@\n ┊1┊1┊import {map} from 'rxjs/operators';\n ┊2┊2┊import {Injectable} from '@angular/core';\n+┊ ┊3┊import {Observable} from 'rxjs';\n+┊ ┊4┊import {QueryRef} from 'apollo-angular';\n ┊3┊5┊import {\n ┊4┊6┊  GetChatsGQL,\n ┊5┊7┊  GetChatGQL,\n```\n```diff\n@@ -7,6 +9,9 @@\n ┊ 7┊ 9┊  RemoveChatGQL,\n ┊ 8┊10┊  RemoveMessagesGQL,\n ┊ 9┊11┊  RemoveAllMessagesGQL,\n+┊  ┊12┊  GetUsersGQL,\n+┊  ┊13┊  AddChatGQL,\n+┊  ┊14┊  AddGroupGQL,\n ┊10┊15┊  AddMessage,\n ┊11┊16┊  GetChats,\n ┊12┊17┊  GetChat,\n```\n```diff\n@@ -15,9 +20,14 @@\n ┊15┊20┊} from '../../graphql';\n ┊16┊21┊import { DataProxy } from 'apollo-cache';\n ┊17┊22┊\n+┊  ┊23┊const currentUserId = '1';\n+┊  ┊24┊\n ┊18┊25┊@Injectable()\n ┊19┊26┊export class ChatsService {\n ┊20┊27┊  messagesAmount = 3;\n+┊  ┊28┊  getChatsWq: QueryRef<GetChats.Query, GetChats.Variables>;\n+┊  ┊29┊  chats$: Observable<GetChats.Chats[]>;\n+┊  ┊30┊  chats: GetChats.Chats[];\n ┊21┊31┊\n ┊22┊32┊  constructor(\n ┊23┊33┊    private getChatsGQL: GetChatsGQL,\n```\n```diff\n@@ -26,17 +36,21 @@\n ┊26┊36┊    private removeChatGQL: RemoveChatGQL,\n ┊27┊37┊    private removeMessagesGQL: RemoveMessagesGQL,\n ┊28┊38┊    private removeAllMessagesGQL: RemoveAllMessagesGQL,\n-┊29┊  ┊  ) {}\n-┊30┊  ┊\n-┊31┊  ┊  getChats() {\n-┊32┊  ┊    const query = this.getChatsGQL.watch({\n+┊  ┊39┊    private getUsersGQL: GetUsersGQL,\n+┊  ┊40┊    private addChatGQL: AddChatGQL,\n+┊  ┊41┊    private addGroupGQL: AddGroupGQL\n+┊  ┊42┊  ) {\n+┊  ┊43┊    this.getChatsWq = this.getChatsGQL.watch({\n ┊33┊44┊      amount: this.messagesAmount,\n ┊34┊45┊    });\n-┊35┊  ┊    const chats$ = query.valueChanges.pipe(\n+┊  ┊46┊    this.chats$ = this.getChatsWq.valueChanges.pipe(\n ┊36┊47┊      map((result) => result.data.chats)\n ┊37┊48┊    );\n+┊  ┊49┊    this.chats$.subscribe(chats => this.chats = chats);\n+┊  ┊50┊  }\n ┊38┊51┊\n-┊39┊  ┊    return {query, chats$};\n+┊  ┊52┊  getChats() {\n+┊  ┊53┊    return {query: this.getChatsWq, chats$: this.chats$};\n ┊40┊54┊  }\n ┊41┊55┊\n ┊42┊56┊  getChat(chatId: string) {\n```\n```diff\n@@ -209,4 +223,83 @@\n ┊209┊223┊      }, options);\n ┊210┊224┊    }\n ┊211┊225┊  }\n+┊   ┊226┊\n+┊   ┊227┊  getUsers() {\n+┊   ┊228┊    const query = this.getUsersGQL.watch();\n+┊   ┊229┊    const users$ = query.valueChanges.pipe(\n+┊   ┊230┊      map((result) => result.data.users)\n+┊   ┊231┊    );\n+┊   ┊232┊\n+┊   ┊233┊    return {query, users$};\n+┊   ┊234┊  }\n+┊   ┊235┊\n+┊   ┊236┊  // Checks if the chat is listed for the current user and returns the id\n+┊   ┊237┊  getChatId(recipientId: string) {\n+┊   ┊238┊    const _chat = this.chats.find(chat => {\n+┊   ┊239┊      return !chat.isGroup && !!chat.allTimeMembers.find(user => user.id === currentUserId) &&\n+┊   ┊240┊        !!chat.allTimeMembers.find(user => user.id === recipientId);\n+┊   ┊241┊    });\n+┊   ┊242┊    return _chat ? _chat.id : false;\n+┊   ┊243┊  }\n+┊   ┊244┊\n+┊   ┊245┊  addChat(recipientId: string) {\n+┊   ┊246┊    return this.addChatGQL.mutate(\n+┊   ┊247┊      {\n+┊   ┊248┊        recipientId,\n+┊   ┊249┊      }, {\n+┊   ┊250┊        update: (store, { data: { addChat } }) => {\n+┊   ┊251┊          // Read the data from our cache for this query.\n+┊   ┊252┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊253┊            query: this.getChatsGQL.document,\n+┊   ┊254┊            variables: {\n+┊   ┊255┊              amount: this.messagesAmount,\n+┊   ┊256┊            },\n+┊   ┊257┊          });\n+┊   ┊258┊          // Add our comment from the mutation to the end.\n+┊   ┊259┊          chats.push(addChat);\n+┊   ┊260┊          // Write our data back to the cache.\n+┊   ┊261┊          store.writeQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊262┊            query: this.getChatsGQL.document,\n+┊   ┊263┊            variables: {\n+┊   ┊264┊              amount: this.messagesAmount,\n+┊   ┊265┊            },\n+┊   ┊266┊            data: {\n+┊   ┊267┊              chats,\n+┊   ┊268┊            },\n+┊   ┊269┊          });\n+┊   ┊270┊        },\n+┊   ┊271┊      }\n+┊   ┊272┊    );\n+┊   ┊273┊  }\n+┊   ┊274┊\n+┊   ┊275┊  addGroup(recipientIds: string[], groupName: string) {\n+┊   ┊276┊    return this.addGroupGQL.mutate(\n+┊   ┊277┊      {\n+┊   ┊278┊        recipientIds,\n+┊   ┊279┊        groupName,\n+┊   ┊280┊      }, {\n+┊   ┊281┊        update: (store, { data: { addGroup } }) => {\n+┊   ┊282┊          // Read the data from our cache for this query.\n+┊   ┊283┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊284┊            query: this.getChatsGQL.document,\n+┊   ┊285┊            variables: {\n+┊   ┊286┊              amount: this.messagesAmount,\n+┊   ┊287┊            },\n+┊   ┊288┊          });\n+┊   ┊289┊          // Add our comment from the mutation to the end.\n+┊   ┊290┊          chats.push(addGroup);\n+┊   ┊291┊          // Write our data back to the cache.\n+┊   ┊292┊          store.writeQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊293┊            query: this.getChatsGQL.document,\n+┊   ┊294┊            variables: {\n+┊   ┊295┊              amount: this.messagesAmount,\n+┊   ┊296┊            },\n+┊   ┊297┊            data: {\n+┊   ┊298┊              chats,\n+┊   ┊299┊            },\n+┊   ┊300┊          });\n+┊   ┊301┊        },\n+┊   ┊302┊      }\n+┊   ┊303┊    );\n+┊   ┊304┊  }\n ┊212┊305┊}\n```\n\n[}]: #\n\nThey're both missing few components:\n\n**UsersList**\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/app/chats-creation/components/users-list/users-list.component.ts, src/app/chats-creation/components/users-list/users-list.component.scss\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;users-list&#x2F;users-list.component.scss\n```diff\n@@ -0,0 +1,13 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊}\n+┊  ┊ 4┊\n+┊  ┊ 5┊:host ::ng-deep mat-list-item:first-child div:first-child {\n+┊  ┊ 6┊  padding: 0 !important;\n+┊  ┊ 7┊  margin: 5px;\n+┊  ┊ 8┊  margin-top: 20px;\n+┊  ┊ 9┊}\n+┊  ┊10┊\n+┊  ┊11┊mat-list {\n+┊  ┊12┊  padding: 0;\n+┊  ┊13┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;users-list&#x2F;users-list.component.ts\n```diff\n@@ -0,0 +1,24 @@\n+┊  ┊ 1┊import {Component, Input} from '@angular/core';\n+┊  ┊ 2┊import {GetUsers} from '../../../../graphql';\n+┊  ┊ 3┊import {SelectableListDirective} from 'ngx-selectable-list';\n+┊  ┊ 4┊\n+┊  ┊ 5┊@Component({\n+┊  ┊ 6┊  selector: 'app-users-list',\n+┊  ┊ 7┊  template: `\n+┊  ┊ 8┊    <mat-list>\n+┊  ┊ 9┊      <mat-list-item *ngFor=\"let user of users\">\n+┊  ┊10┊        <app-user-item [item]=\"user\"\n+┊  ┊11┊                       libSelectableItem></app-user-item>\n+┊  ┊12┊      </mat-list-item>\n+┊  ┊13┊    </mat-list>\n+┊  ┊14┊    <ng-content *ngIf=\"selectableListDirective.selecting\"></ng-content>\n+┊  ┊15┊  `,\n+┊  ┊16┊  styleUrls: ['users-list.component.scss'],\n+┊  ┊17┊})\n+┊  ┊18┊export class UsersListComponent {\n+┊  ┊19┊  // tslint:disable-next-line:no-input-rename\n+┊  ┊20┊  @Input('items')\n+┊  ┊21┊  users: GetUsers.Users[];\n+┊  ┊22┊\n+┊  ┊23┊  constructor(public selectableListDirective: SelectableListDirective) {}\n+┊  ┊24┊}\n```\n\n[}]: #\n\n**UserItem**\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/app/chats-creation/components/user-item/user-item.component.ts, src/app/chats-creation/components/user-item/user-item.component.scss\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;user-item&#x2F;user-item.component.scss\n```diff\n@@ -0,0 +1,32 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊  width: 100%;\n+┊  ┊ 4┊  height: 100%;\n+┊  ┊ 5┊}\n+┊  ┊ 6┊\n+┊  ┊ 7┊button {\n+┊  ┊ 8┊  margin: 10px;\n+┊  ┊ 9┊  height: 50px;\n+┊  ┊10┊  padding: 1px 6px;\n+┊  ┊11┊  line-height: 50px;\n+┊  ┊12┊  border: none;\n+┊  ┊13┊  margin: 0;\n+┊  ┊14┊\n+┊  ┊15┊  img {\n+┊  ┊16┊    float: left;\n+┊  ┊17┊    margin-right: 10px;\n+┊  ┊18┊    height: 50px;\n+┊  ┊19┊    width: 50px;\n+┊  ┊20┊    text-align: center;\n+┊  ┊21┊    line-height: inherit;\n+┊  ┊22┊    border-radius: 50%;\n+┊  ┊23┊  }\n+┊  ┊24┊\n+┊  ┊25┊  div {\n+┊  ┊26┊    float: left;\n+┊  ┊27┊    line-height: inherit;\n+┊  ┊28┊    font-family: Roboto, \"Helvetica Neue\", sans-serif;\n+┊  ┊29┊    font-weight: bold;\n+┊  ┊30┊    font-size: 16px;\n+┊  ┊31┊  }\n+┊  ┊32┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;user-item&#x2F;user-item.component.ts\n```diff\n@@ -0,0 +1,18 @@\n+┊  ┊ 1┊import {Component, Input} from '@angular/core';\n+┊  ┊ 2┊import {GetUsers} from '../../../../graphql';\n+┊  ┊ 3┊\n+┊  ┊ 4┊@Component({\n+┊  ┊ 5┊  selector: 'app-user-item',\n+┊  ┊ 6┊  template: `\n+┊  ┊ 7┊    <button mat-menu-item>\n+┊  ┊ 8┊      <img [src]=\"user.picture || 'assets/default-profile-pic.jpg'\">\n+┊  ┊ 9┊      <div>{{ user.name }}</div>\n+┊  ┊10┊    </button>\n+┊  ┊11┊  `,\n+┊  ┊12┊  styleUrls: ['user-item.component.scss']\n+┊  ┊13┊})\n+┊  ┊14┊export class UserItemComponent {\n+┊  ┊15┊  // tslint:disable-next-line:no-input-rename\n+┊  ┊16┊  @Input('item')\n+┊  ┊17┊  user: GetUsers.Users;\n+┊  ┊18┊}\n```\n\n[}]: #\n\n**NewGroupDetails**\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/app/chats-creation/components/new-group-details/new-group-details.component.ts, src/app/chats-creation/components/new-group-details/new-group-details.component.scss\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;new-group-details&#x2F;new-group-details.component.scss\n```diff\n@@ -0,0 +1,25 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊}\n+┊  ┊ 4┊\n+┊  ┊ 5┊div {\n+┊  ┊ 6┊  padding: 16px;\n+┊  ┊ 7┊  mat-form-field {\n+┊  ┊ 8┊    width: 100%;\n+┊  ┊ 9┊  }\n+┊  ┊10┊}\n+┊  ┊11┊\n+┊  ┊12┊.new-group {\n+┊  ┊13┊  position: absolute;\n+┊  ┊14┊  bottom: 5vw;\n+┊  ┊15┊  right: 5vw;\n+┊  ┊16┊}\n+┊  ┊17┊\n+┊  ┊18┊.users {\n+┊  ┊19┊  display: flex;\n+┊  ┊20┊  flex-flow: row wrap;\n+┊  ┊21┊  img {\n+┊  ┊22┊    flex: 0 1 8vh;\n+┊  ┊23┊    height: 8vh;\n+┊  ┊24┊  }\n+┊  ┊25┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;new-group-details&#x2F;new-group-details.component.ts\n```diff\n@@ -0,0 +1,34 @@\n+┊  ┊ 1┊import {Component, EventEmitter, Input, Output} from '@angular/core';\n+┊  ┊ 2┊import {GetUsers} from '../../../../graphql';\n+┊  ┊ 3┊\n+┊  ┊ 4┊@Component({\n+┊  ┊ 5┊  selector: 'app-new-group-details',\n+┊  ┊ 6┊  template: `\n+┊  ┊ 7┊    <div>\n+┊  ┊ 8┊      <mat-form-field>\n+┊  ┊ 9┊        <input matInput placeholder=\"Group name\" [(ngModel)]=\"groupName\">\n+┊  ┊10┊      </mat-form-field>\n+┊  ┊11┊    </div>\n+┊  ┊12┊    <button [disabled]=\"!groupName\" class=\"new-group\" mat-fab color=\"primary\" (click)=\"emitGroupDetails()\">\n+┊  ┊13┊      <mat-icon aria-label=\"Icon-button with a + icon\">arrow_forward</mat-icon>\n+┊  ┊14┊    </button>\n+┊  ┊15┊    <div>Members</div>\n+┊  ┊16┊    <div class=\"users\">\n+┊  ┊17┊      <img *ngFor=\"let user of users;\" [src]=\"user.picture\"/>\n+┊  ┊18┊    </div>\n+┊  ┊19┊  `,\n+┊  ┊20┊  styleUrls: ['new-group-details.component.scss'],\n+┊  ┊21┊})\n+┊  ┊22┊export class NewGroupDetailsComponent {\n+┊  ┊23┊  groupName: string;\n+┊  ┊24┊  @Input()\n+┊  ┊25┊  users: GetUsers.Users[];\n+┊  ┊26┊  @Output()\n+┊  ┊27┊  groupDetails = new EventEmitter<string>();\n+┊  ┊28┊\n+┊  ┊29┊  emitGroupDetails() {\n+┊  ┊30┊    if (this.groupDetails) {\n+┊  ┊31┊      this.groupDetails.emit(this.groupName);\n+┊  ┊32┊    }\n+┊  ┊33┊  }\n+┊  ┊34┊}\n```\n\n[}]: #\n\nWith all that, we can now link NewChat component with Chat container:\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/app/chats-lister/containers/chats/chats.component.ts, src/app/chat-viewer/containers/chat/chat.component.spec.ts\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.spec.ts\n```diff\n@@ -143,7 +143,9 @@\n ┊143┊143┊    component = fixture.componentInstance;\n ┊144┊144┊    fixture.detectChanges();\n ┊145┊145┊\n-┊146┊   ┊    const req = controller.expectOne('GetChat', 'call to api');\n+┊   ┊146┊    controller.expectOne('GetChats', 'call to getChats api');\n+┊   ┊147┊\n+┊   ┊148┊    const req = controller.expectOne('GetChat', 'call to getChat api');\n ┊147┊149┊\n ┊148┊150┊    req.flush({\n ┊149┊151┊      data: {\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.ts\n```diff\n@@ -34,7 +34,7 @@\n ┊34┊34┊      <app-confirm-selection #confirmSelection></app-confirm-selection>\n ┊35┊35┊    </app-chats-list>\n ┊36┊36┊\n-┊37┊  ┊    <button *ngIf=\"!isSelecting\" class=\"chat-button\" mat-fab color=\"secondary\">\n+┊  ┊37┊    <button *ngIf=\"!isSelecting\" class=\"chat-button\" mat-fab color=\"secondary\" (click)=\"goToNewChat()\">\n ┊38┊38┊      <mat-icon aria-label=\"Icon-button with a + icon\">chat</mat-icon>\n ┊39┊39┊    </button>\n ┊40┊40┊  `,\n```\n```diff\n@@ -56,6 +56,10 @@\n ┊56┊56┊    this.router.navigate(['/chat', chatId]);\n ┊57┊57┊  }\n ┊58┊58┊\n+┊  ┊59┊  goToNewChat() {\n+┊  ┊60┊    this.router.navigate(['/new-chat']);\n+┊  ┊61┊  }\n+┊  ┊62┊\n ┊59┊63┊  deleteChats(chatIds: string[]) {\n ┊60┊64┊    chatIds.forEach(chatId => {\n ┊61┊65┊      this.chatsService.removeChat(chatId).subscribe();\n```\n\n[}]: #\n\nNow let's wrap it all together within the `ChatsCreation` module:\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/app/chats-creation/chats-creation.module.ts, src/app/app.module.ts\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n##### Changed src&#x2F;app&#x2F;app.module.ts\n```diff\n@@ -7,6 +7,7 @@\n ┊ 7┊ 7┊import {ChatsListerModule} from './chats-lister/chats-lister.module';\n ┊ 8┊ 8┊import {RouterModule, Routes} from '@angular/router';\n ┊ 9┊ 9┊import {ChatViewerModule} from './chat-viewer/chat-viewer.module';\n+┊  ┊10┊import {ChatsCreationModule} from './chats-creation/chats-creation.module';\n ┊10┊11┊const routes: Routes = [];\n ┊11┊12┊\n ┊12┊13┊@NgModule({\n```\n```diff\n@@ -22,6 +23,7 @@\n ┊22┊23┊    // Feature modules\n ┊23┊24┊    ChatsListerModule,\n ┊24┊25┊    ChatViewerModule,\n+┊  ┊26┊    ChatsCreationModule,\n ┊25┊27┊  ],\n ┊26┊28┊  providers: [],\n ┊27┊29┊  bootstrap: [AppComponent]\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;chats-creation.module.ts\n```diff\n@@ -0,0 +1,60 @@\n+┊  ┊ 1┊import { BrowserModule } from '@angular/platform-browser';\n+┊  ┊ 2┊import { NgModule } from '@angular/core';\n+┊  ┊ 3┊\n+┊  ┊ 4┊import {BrowserAnimationsModule} from '@angular/platform-browser/animations';\n+┊  ┊ 5┊import {\n+┊  ┊ 6┊  MatButtonModule, MatFormFieldModule, MatGridListModule, MatIconModule, MatInputModule, MatListModule, MatMenuModule,\n+┊  ┊ 7┊  MatToolbarModule\n+┊  ┊ 8┊} from '@angular/material';\n+┊  ┊ 9┊import {RouterModule, Routes} from '@angular/router';\n+┊  ┊10┊import {FormsModule} from '@angular/forms';\n+┊  ┊11┊import {ChatsService} from '../services/chats.service';\n+┊  ┊12┊import {UserItemComponent} from './components/user-item/user-item.component';\n+┊  ┊13┊import {UsersListComponent} from './components/users-list/users-list.component';\n+┊  ┊14┊import {NewGroupComponent} from './containers/new-group/new-group.component';\n+┊  ┊15┊import {NewChatComponent} from './containers/new-chat/new-chat.component';\n+┊  ┊16┊import {NewGroupDetailsComponent} from './components/new-group-details/new-group-details.component';\n+┊  ┊17┊import {SharedModule} from '../shared/shared.module';\n+┊  ┊18┊import {NgxSelectableListModule} from 'ngx-selectable-list';\n+┊  ┊19┊\n+┊  ┊20┊const routes: Routes = [\n+┊  ┊21┊  {path: 'new-chat', component: NewChatComponent},\n+┊  ┊22┊  {path: 'new-group', component: NewGroupComponent},\n+┊  ┊23┊];\n+┊  ┊24┊\n+┊  ┊25┊@NgModule({\n+┊  ┊26┊  declarations: [\n+┊  ┊27┊    NewChatComponent,\n+┊  ┊28┊    UsersListComponent,\n+┊  ┊29┊    NewGroupComponent,\n+┊  ┊30┊    UserItemComponent,\n+┊  ┊31┊    NewGroupDetailsComponent,\n+┊  ┊32┊  ],\n+┊  ┊33┊  imports: [\n+┊  ┊34┊    BrowserModule,\n+┊  ┊35┊    // Animations (for Material)\n+┊  ┊36┊    BrowserAnimationsModule,\n+┊  ┊37┊    // Material\n+┊  ┊38┊    MatToolbarModule,\n+┊  ┊39┊    MatMenuModule,\n+┊  ┊40┊    MatIconModule,\n+┊  ┊41┊    MatButtonModule,\n+┊  ┊42┊    MatListModule,\n+┊  ┊43┊    MatGridListModule,\n+┊  ┊44┊    MatInputModule,\n+┊  ┊45┊    MatFormFieldModule,\n+┊  ┊46┊    MatGridListModule,\n+┊  ┊47┊    // Routing\n+┊  ┊48┊    RouterModule.forChild(routes),\n+┊  ┊49┊    // Forms\n+┊  ┊50┊    FormsModule,\n+┊  ┊51┊    // Feature modules\n+┊  ┊52┊    NgxSelectableListModule,\n+┊  ┊53┊    SharedModule,\n+┊  ┊54┊  ],\n+┊  ┊55┊  providers: [\n+┊  ┊56┊    ChatsService,\n+┊  ┊57┊  ],\n+┊  ┊58┊})\n+┊  ┊59┊export class ChatsCreationModule {\n+┊  ┊60┊}\n```\n\n[}]: #"
          },
          {
            "manualTitle": "Step 13: Zero latency on slow 3g networks",
            "stepRevision": "810cc1ec3030d51cec02928dfb862b0b3ed6df90",
            "manualView": "## Client\n\nNow let's start our client in production mode:\n\n    yarn start --prod\n\nNow open the **Chrome Developers Tools** and, in the **Network tab**, select `Slow 3G Network` and `Disable cache`.\nThen refresh the page and look at the `DOMContentLoaded` time and at the transferred size. You'll notice that our bundle size is quite small and so the loads time.\n\nNow let's click on a specific chat. It will take some time to load the data and then add a new message.\nOnce again it will take some time to load the data.\nWe could also create a new chat and the result would be the same.\nThe whole app doesn't feel as snappier as the real Whatsapp on a slow 3G Network.\n\n\"That's normal, it's a web application with a remote db while Whatsapp is a native app with a local database...\"\nThat's just an excuse, because we can do as good as Whatsapp thanks to Apollo!\n\nLet's install `moment`, we will soon need it:\n\n    yarn add moment\n\nStart by making our UI optimistic. We can predict most of the response we will get from our server, except for a few things like `id` of newly created messages. But since we don't really need that id, we can simply generate a fake one\nwhich will be later overridden once we get the response from the server:\n\n[{]: <helper> (diffStep \"9.1\" files=\"^\\(?!package.json$\\).*\" module=\"client\")\n\n#### [Step 9.1: Optimistic updates](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/39432fa)\n\n##### Changed src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-chat&#x2F;new-chat.component.ts\n```diff\n@@ -47,7 +47,7 @@\n ┊47┊47┊      // Chat is already listed for the current user\n ┊48┊48┊      this.router.navigate(['/chat', chatId]);\n ┊49┊49┊    } else {\n-┊50┊  ┊      this.chatsService.addChat(recipientId).subscribe(({data: {addChat: {id}}}: { data: AddChat.Mutation }) => {\n+┊  ┊50┊      this.chatsService.addChat(recipientId, this.users).subscribe(({data: {addChat: {id}}}: { data: AddChat.Mutation }) => {\n ┊51┊51┊        this.router.navigate(['/chat', id]);\n ┊52┊52┊      });\n ┊53┊53┊    }\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -2,6 +2,7 @@\n ┊2┊2┊import {Injectable} from '@angular/core';\n ┊3┊3┊import {Observable} from 'rxjs';\n ┊4┊4┊import {QueryRef} from 'apollo-angular';\n+┊ ┊5┊import * as moment from 'moment';\n ┊5┊6┊import {\n ┊6┊7┊  GetChatsGQL,\n ┊7┊8┊  GetChatGQL,\n```\n```diff\n@@ -17,10 +18,12 @@\n ┊17┊18┊  GetChat,\n ┊18┊19┊  RemoveMessages,\n ┊19┊20┊  RemoveAllMessages,\n+┊  ┊21┊  GetUsers,\n ┊20┊22┊} from '../../graphql';\n ┊21┊23┊import { DataProxy } from 'apollo-cache';\n ┊22┊24┊\n ┊23┊25┊const currentUserId = '1';\n+┊  ┊26┊const currentUserName = 'Ethan Gonzalez';\n ┊24┊27┊\n ┊25┊28┊@Injectable()\n ┊26┊29┊export class ChatsService {\n```\n```diff\n@@ -49,6 +52,10 @@\n ┊49┊52┊    this.chats$.subscribe(chats => this.chats = chats);\n ┊50┊53┊  }\n ┊51┊54┊\n+┊  ┊55┊  static getRandomId() {\n+┊  ┊56┊    return String(Math.round(Math.random() * 1000000000000));\n+┊  ┊57┊  }\n+┊  ┊58┊\n ┊52┊59┊  getChats() {\n ┊53┊60┊    return {query: this.getChatsWq, chats$: this.chats$};\n ┊54┊61┊  }\n```\n```diff\n@@ -70,6 +77,24 @@\n ┊ 70┊ 77┊      chatId,\n ┊ 71┊ 78┊      content,\n ┊ 72┊ 79┊    }, {\n+┊   ┊ 80┊      optimisticResponse: {\n+┊   ┊ 81┊        __typename: 'Mutation',\n+┊   ┊ 82┊        addMessage: {\n+┊   ┊ 83┊          id: ChatsService.getRandomId(),\n+┊   ┊ 84┊          __typename: 'Message',\n+┊   ┊ 85┊          senderId: currentUserId,\n+┊   ┊ 86┊          sender: {\n+┊   ┊ 87┊            id: currentUserId,\n+┊   ┊ 88┊            __typename: 'User',\n+┊   ┊ 89┊            name: currentUserName,\n+┊   ┊ 90┊          },\n+┊   ┊ 91┊          content,\n+┊   ┊ 92┊          createdAt: moment().unix(),\n+┊   ┊ 93┊          type: 0,\n+┊   ┊ 94┊          recipients: [],\n+┊   ┊ 95┊          ownership: true,\n+┊   ┊ 96┊        },\n+┊   ┊ 97┊      },\n ┊ 73┊ 98┊      update: (store, { data: { addMessage } }: {data: AddMessage.Mutation}) => {\n ┊ 74┊ 99┊        // Update the messages cache\n ┊ 75┊100┊        {\n```\n```diff\n@@ -121,6 +146,10 @@\n ┊121┊146┊      {\n ┊122┊147┊        chatId,\n ┊123┊148┊      }, {\n+┊   ┊149┊        optimisticResponse: {\n+┊   ┊150┊          __typename: 'Mutation',\n+┊   ┊151┊          removeChat: chatId,\n+┊   ┊152┊        },\n ┊124┊153┊        update: (store, { data: { removeChat } }) => {\n ┊125┊154┊          // Read the data from our cache for this query.\n ┊126┊155┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n```\n```diff\n@@ -154,6 +183,10 @@\n ┊154┊183┊    let ids: string[] = [];\n ┊155┊184┊\n ┊156┊185┊    const options = {\n+┊   ┊186┊      optimisticResponse: () => ({\n+┊   ┊187┊        __typename: 'Mutation',\n+┊   ┊188┊        removeMessages: ids,\n+┊   ┊189┊      }),\n ┊157┊190┊      update: (store: DataProxy, { data: { removeMessages } }: {data: RemoveMessages.Mutation | RemoveAllMessages.Mutation}) => {\n ┊158┊191┊        // Update the messages cache\n ┊159┊192┊        {\n```\n```diff\n@@ -242,11 +275,33 @@\n ┊242┊275┊    return _chat ? _chat.id : false;\n ┊243┊276┊  }\n ┊244┊277┊\n-┊245┊   ┊  addChat(recipientId: string) {\n+┊   ┊278┊  addChat(recipientId: string, users: GetUsers.Users[]) {\n ┊246┊279┊    return this.addChatGQL.mutate(\n ┊247┊280┊      {\n ┊248┊281┊        recipientId,\n ┊249┊282┊      }, {\n+┊   ┊283┊        optimisticResponse: {\n+┊   ┊284┊          __typename: 'Mutation',\n+┊   ┊285┊          addChat: {\n+┊   ┊286┊            id: ChatsService.getRandomId(),\n+┊   ┊287┊            __typename: 'Chat',\n+┊   ┊288┊            name: users.find(user => user.id === recipientId).name,\n+┊   ┊289┊            picture: users.find(user => user.id === recipientId).picture,\n+┊   ┊290┊            allTimeMembers: [\n+┊   ┊291┊              {\n+┊   ┊292┊                id: currentUserId,\n+┊   ┊293┊                __typename: 'User',\n+┊   ┊294┊              },\n+┊   ┊295┊              {\n+┊   ┊296┊                id: recipientId,\n+┊   ┊297┊                __typename: 'User',\n+┊   ┊298┊              }\n+┊   ┊299┊            ],\n+┊   ┊300┊            unreadMessages: 0,\n+┊   ┊301┊            messages: [],\n+┊   ┊302┊            isGroup: false,\n+┊   ┊303┊          },\n+┊   ┊304┊        },\n ┊250┊305┊        update: (store, { data: { addChat } }) => {\n ┊251┊306┊          // Read the data from our cache for this query.\n ┊252┊307┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n```\n```diff\n@@ -278,6 +333,26 @@\n ┊278┊333┊        recipientIds,\n ┊279┊334┊        groupName,\n ┊280┊335┊      }, {\n+┊   ┊336┊        optimisticResponse: {\n+┊   ┊337┊          __typename: 'Mutation',\n+┊   ┊338┊          addGroup: {\n+┊   ┊339┊            id: ChatsService.getRandomId(),\n+┊   ┊340┊            __typename: 'Chat',\n+┊   ┊341┊            name: groupName,\n+┊   ┊342┊            picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n+┊   ┊343┊            userIds: [currentUserId, recipientIds],\n+┊   ┊344┊            allTimeMembers: [\n+┊   ┊345┊              {\n+┊   ┊346┊                id: currentUserId,\n+┊   ┊347┊                __typename: 'User',\n+┊   ┊348┊              },\n+┊   ┊349┊              ...recipientIds.map(id => ({id, __typename: 'User'})),\n+┊   ┊350┊            ],\n+┊   ┊351┊            unreadMessages: 0,\n+┊   ┊352┊            messages: [],\n+┊   ┊353┊            isGroup: true,\n+┊   ┊354┊          },\n+┊   ┊355┊        },\n ┊281┊356┊        update: (store, { data: { addGroup } }) => {\n ┊282┊357┊          // Read the data from our cache for this query.\n ┊283┊358┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n```\n\n[}]: #\n\nWhen we open a specific chat we can also preload some data from our chats list cache while waiting for the server response. We will initially be able to show only the chat name, the last message or the last few messages and a few more informations instead of the whole content from the server, but that would be more than enough to entertain the user while waiting for the server response:\n\n[{]: <helper> (diffStep \"9.2\" module=\"client\")\n\n#### [Step 9.2: Get chat data from chats cache while waiting for server response](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/632468a)\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,6 +1,6 @@\n-┊1┊ ┊import {map} from 'rxjs/operators';\n+┊ ┊1┊import {concat, map} from 'rxjs/operators';\n ┊2┊2┊import {Injectable} from '@angular/core';\n-┊3┊ ┊import {Observable} from 'rxjs';\n+┊ ┊3┊import {Observable, AsyncSubject, of} from 'rxjs';\n ┊4┊4┊import {QueryRef} from 'apollo-angular';\n ┊5┊5┊import * as moment from 'moment';\n ┊6┊6┊import {\n```\n```diff\n@@ -31,6 +31,7 @@\n ┊31┊31┊  getChatsWq: QueryRef<GetChats.Query, GetChats.Variables>;\n ┊32┊32┊  chats$: Observable<GetChats.Chats[]>;\n ┊33┊33┊  chats: GetChats.Chats[];\n+┊  ┊34┊  getChatWqSubject: AsyncSubject<QueryRef<GetChat.Query>>;\n ┊34┊35┊\n ┊35┊36┊  constructor(\n ┊36┊37┊    private getChatsGQL: GetChatsGQL,\n```\n```diff\n@@ -61,15 +62,34 @@\n ┊61┊62┊  }\n ┊62┊63┊\n ┊63┊64┊  getChat(chatId: string) {\n+┊  ┊65┊    const _chat = this.chats && this.chats.find(chat => chat.id === chatId) || {\n+┊  ┊66┊      id: chatId,\n+┊  ┊67┊      name: '',\n+┊  ┊68┊      picture: null,\n+┊  ┊69┊      allTimeMembers: [],\n+┊  ┊70┊      unreadMessages: 0,\n+┊  ┊71┊      isGroup: false,\n+┊  ┊72┊      messages: [],\n+┊  ┊73┊    };\n+┊  ┊74┊    const chat$FromCache = of<GetChat.Chat>(_chat);\n+┊  ┊75┊\n ┊64┊76┊    const query = this.getChatGQL.watch({\n ┊65┊77┊      chatId: chatId,\n ┊66┊78┊    });\n ┊67┊79┊\n-┊68┊  ┊    const chat$ = query.valueChanges.pipe(\n-┊69┊  ┊      map((result) => result.data.chat)\n+┊  ┊80┊    const chat$ = chat$FromCache.pipe(\n+┊  ┊81┊      concat(\n+┊  ┊82┊        query.valueChanges.pipe(\n+┊  ┊83┊          map((result) => result.data.chat)\n+┊  ┊84┊        )\n+┊  ┊85┊      )\n ┊70┊86┊    );\n ┊71┊87┊\n-┊72┊  ┊    return {query, chat$};\n+┊  ┊88┊    this.getChatWqSubject = new AsyncSubject();\n+┊  ┊89┊    this.getChatWqSubject.next(query);\n+┊  ┊90┊    this.getChatWqSubject.complete();\n+┊  ┊91┊\n+┊  ┊92┊    return {query$: this.getChatWqSubject.asObservable(), chat$};\n ┊73┊93┊  }\n ┊74┊94┊\n ┊75┊95┊  addMessage(chatId: string, content: string) {\n```\n\n[}]: #\n\nNow let's deal with the most difficult part, chats creation.\n\nWe cannot predict the `id` of the new chat and so we cannot navigate to the chat page because it contains the chat id in the url. We could simply navigate to the \"optimistic\" id, but then the user wouldn't be able to reach that url if he refreshes the page or bookmarks it. That's a problem we care about.\n\nHow to solve it? We're going to create a landing page and we will later override the url once we get the response from the server!\n\n[{]: <helper> (diffStep \"9.3\" module=\"client\")\n\n#### [Step 9.3: Landing page for new chats/groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/87b9f5d)\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.spec.ts\n```diff\n@@ -129,7 +129,10 @@\n ┊129┊129┊        },\n ┊130┊130┊        {\n ┊131┊131┊          provide: ActivatedRoute,\n-┊132┊   ┊          useValue: { params: of({ id: chat.id }) },\n+┊   ┊132┊          useValue: {\n+┊   ┊133┊            params: of({ id: chat.id }),\n+┊   ┊134┊            queryParams: of({}),\n+┊   ┊135┊          },\n ┊133┊136┊        },\n ┊134┊137┊      ],\n ┊135┊138┊      schemas: [NO_ERRORS_SCHEMA],\n```\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.ts\n```diff\n@@ -2,6 +2,8 @@\n ┊2┊2┊import {ActivatedRoute, Router} from '@angular/router';\n ┊3┊3┊import {ChatsService} from '../../../services/chats.service';\n ┊4┊4┊import {GetChat} from '../../../../graphql';\n+┊ ┊5┊import {combineLatest} from 'rxjs';\n+┊ ┊6┊import {Location} from '@angular/common';\n ┊5┊7┊\n ┊6┊8┊@Component({\n ┊7┊9┊  template: `\n```\n```diff\n@@ -27,21 +29,40 @@\n ┊27┊29┊  messages: GetChat.Messages[];\n ┊28┊30┊  name: string;\n ┊29┊31┊  isGroup: boolean;\n+┊  ┊32┊  optimisticUI: boolean;\n ┊30┊33┊\n ┊31┊34┊  constructor(private route: ActivatedRoute,\n ┊32┊35┊              private router: Router,\n+┊  ┊36┊              private location: Location,\n ┊33┊37┊              private chatsService: ChatsService) {\n ┊34┊38┊  }\n ┊35┊39┊\n ┊36┊40┊  ngOnInit() {\n-┊37┊  ┊    this.route.params.subscribe(({id: chatId}) => {\n-┊38┊  ┊      this.chatId = chatId;\n-┊39┊  ┊      this.chatsService.getChat(chatId).chat$.subscribe(chat => {\n-┊40┊  ┊        this.messages = chat.messages;\n-┊41┊  ┊        this.name = chat.name;\n-┊42┊  ┊        this.isGroup = chat.isGroup;\n+┊  ┊41┊    combineLatest(this.route.params, this.route.queryParams,\n+┊  ┊42┊      (params: { id: string }, queryParams: { oui?: boolean }) => ({params, queryParams}))\n+┊  ┊43┊      .subscribe(({params: {id: chatId}, queryParams: {oui}}) => {\n+┊  ┊44┊        this.chatId = chatId;\n+┊  ┊45┊\n+┊  ┊46┊        this.optimisticUI = oui;\n+┊  ┊47┊\n+┊  ┊48┊        if (this.optimisticUI) {\n+┊  ┊49┊          // We are using fake IDs generated by the Optimistic UI\n+┊  ┊50┊          this.chatsService.addChat$.subscribe(({data: {addChat, addGroup}}) => {\n+┊  ┊51┊            this.chatId = addChat ? addChat.id : addGroup.id;\n+┊  ┊52┊            console.log(`Switching from the Optimistic UI id ${chatId} to ${this.chatId}`);\n+┊  ┊53┊            // Rewrite the URL\n+┊  ┊54┊            this.location.go(`chat/${this.chatId}`);\n+┊  ┊55┊            // Optimistic UI no more\n+┊  ┊56┊            this.optimisticUI = false;\n+┊  ┊57┊          });\n+┊  ┊58┊        }\n+┊  ┊59┊\n+┊  ┊60┊        this.chatsService.getChat(chatId, this.optimisticUI).chat$.subscribe(chat => {\n+┊  ┊61┊          this.messages = chat.messages;\n+┊  ┊62┊          this.name = chat.name;\n+┊  ┊63┊          this.isGroup = chat.isGroup;\n+┊  ┊64┊        });\n ┊43┊65┊      });\n-┊44┊  ┊    });\n ┊45┊66┊  }\n ┊46┊67┊\n ┊47┊68┊  goToChats() {\n```\n\n##### Changed src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-chat&#x2F;new-chat.component.ts\n```diff\n@@ -47,9 +47,10 @@\n ┊47┊47┊      // Chat is already listed for the current user\n ┊48┊48┊      this.router.navigate(['/chat', chatId]);\n ┊49┊49┊    } else {\n-┊50┊  ┊      this.chatsService.addChat(recipientId, this.users).subscribe(({data: {addChat: {id}}}: { data: AddChat.Mutation }) => {\n-┊51┊  ┊        this.router.navigate(['/chat', id]);\n-┊52┊  ┊      });\n+┊  ┊50┊      // Generate id for Optimistic UI\n+┊  ┊51┊      const ouiId = ChatsService.getRandomId();\n+┊  ┊52┊      this.chatsService.addChat(recipientId, this.users, ouiId).subscribe();\n+┊  ┊53┊      this.router.navigate(['/chat', ouiId], {queryParams: {oui: true}, skipLocationChange: true});\n ┊53┊54┊    }\n ┊54┊55┊  }\n ┊55┊56┊}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-group&#x2F;new-group.component.ts\n```diff\n@@ -52,9 +52,9 @@\n ┊52┊52┊\n ┊53┊53┊  addGroup(groupName: string) {\n ┊54┊54┊    if (groupName && this.recipientIds.length) {\n-┊55┊  ┊      this.chatsService.addGroup(this.recipientIds, groupName).subscribe(({data: {addGroup: {id}}}: { data: AddGroup.Mutation }) => {\n-┊56┊  ┊        this.router.navigate(['/chat', id]);\n-┊57┊  ┊      });\n+┊  ┊55┊      const ouiId = ChatsService.getRandomId();\n+┊  ┊56┊      this.chatsService.addGroup(this.recipientIds, groupName, ouiId).subscribe();\n+┊  ┊57┊      this.router.navigate(['/chat', ouiId], {queryParams: {oui: true}, skipLocationChange: true});\n ┊58┊58┊    }\n ┊59┊59┊  }\n ┊60┊60┊}\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,4 +1,4 @@\n-┊1┊ ┊import {concat, map} from 'rxjs/operators';\n+┊ ┊1┊import {concat, map, share, switchMap} from 'rxjs/operators';\n ┊2┊2┊import {Injectable} from '@angular/core';\n ┊3┊3┊import {Observable, AsyncSubject, of} from 'rxjs';\n ┊4┊4┊import {QueryRef} from 'apollo-angular';\n```\n```diff\n@@ -19,8 +19,11 @@\n ┊19┊19┊  RemoveMessages,\n ┊20┊20┊  RemoveAllMessages,\n ┊21┊21┊  GetUsers,\n+┊  ┊22┊  AddChat,\n+┊  ┊23┊  AddGroup,\n ┊22┊24┊} from '../../graphql';\n ┊23┊25┊import { DataProxy } from 'apollo-cache';\n+┊  ┊26┊import { FetchResult } from 'apollo-link';\n ┊24┊27┊\n ┊25┊28┊const currentUserId = '1';\n ┊26┊29┊const currentUserName = 'Ethan Gonzalez';\n```\n```diff\n@@ -32,6 +35,7 @@\n ┊32┊35┊  chats$: Observable<GetChats.Chats[]>;\n ┊33┊36┊  chats: GetChats.Chats[];\n ┊34┊37┊  getChatWqSubject: AsyncSubject<QueryRef<GetChat.Query>>;\n+┊  ┊38┊  addChat$: Observable<FetchResult<AddChat.Mutation | AddGroup.Mutation>>;\n ┊35┊39┊\n ┊36┊40┊  constructor(\n ┊37┊41┊    private getChatsGQL: GetChatsGQL,\n```\n```diff\n@@ -61,7 +65,7 @@\n ┊61┊65┊    return {query: this.getChatsWq, chats$: this.chats$};\n ┊62┊66┊  }\n ┊63┊67┊\n-┊64┊  ┊  getChat(chatId: string) {\n+┊  ┊68┊  getChat(chatId: string, oui?: boolean) {\n ┊65┊69┊    const _chat = this.chats && this.chats.find(chat => chat.id === chatId) || {\n ┊66┊70┊      id: chatId,\n ┊67┊71┊      name: '',\n```\n```diff\n@@ -73,21 +77,43 @@\n ┊ 73┊ 77┊    };\n ┊ 74┊ 78┊    const chat$FromCache = of<GetChat.Chat>(_chat);\n ┊ 75┊ 79┊\n-┊ 76┊   ┊    const query = this.getChatGQL.watch({\n-┊ 77┊   ┊      chatId: chatId,\n-┊ 78┊   ┊    });\n-┊ 79┊   ┊\n-┊ 80┊   ┊    const chat$ = chat$FromCache.pipe(\n-┊ 81┊   ┊      concat(\n-┊ 82┊   ┊        query.valueChanges.pipe(\n-┊ 83┊   ┊          map((result) => result.data.chat)\n-┊ 84┊   ┊        )\n-┊ 85┊   ┊      )\n-┊ 86┊   ┊    );\n+┊   ┊ 80┊    const getApolloWatchQuery = (id: string) => {\n+┊   ┊ 81┊      return this.getChatGQL.watch({\n+┊   ┊ 82┊        chatId: id,\n+┊   ┊ 83┊      });\n+┊   ┊ 84┊    };\n ┊ 87┊ 85┊\n+┊   ┊ 86┊    let chat$: Observable<GetChat.Chat>;\n ┊ 88┊ 87┊    this.getChatWqSubject = new AsyncSubject();\n-┊ 89┊   ┊    this.getChatWqSubject.next(query);\n-┊ 90┊   ┊    this.getChatWqSubject.complete();\n+┊   ┊ 88┊\n+┊   ┊ 89┊    if (oui) {\n+┊   ┊ 90┊      chat$ = chat$FromCache.pipe(\n+┊   ┊ 91┊        concat(this.addChat$.pipe(\n+┊   ┊ 92┊          switchMap(({ data: { addChat, addGroup } }) => {\n+┊   ┊ 93┊            const query = getApolloWatchQuery(addChat ? addChat.id : addGroup.id);\n+┊   ┊ 94┊\n+┊   ┊ 95┊            this.getChatWqSubject.next(query);\n+┊   ┊ 96┊            this.getChatWqSubject.complete();\n+┊   ┊ 97┊\n+┊   ┊ 98┊            return query.valueChanges.pipe(\n+┊   ┊ 99┊              map((result) => result.data.chat)\n+┊   ┊100┊            );\n+┊   ┊101┊          }))\n+┊   ┊102┊        ));\n+┊   ┊103┊    } else {\n+┊   ┊104┊      const query = getApolloWatchQuery(chatId);\n+┊   ┊105┊\n+┊   ┊106┊      this.getChatWqSubject.next(query);\n+┊   ┊107┊      this.getChatWqSubject.complete();\n+┊   ┊108┊\n+┊   ┊109┊      chat$ = chat$FromCache.pipe(\n+┊   ┊110┊        concat(\n+┊   ┊111┊          query.valueChanges.pipe(\n+┊   ┊112┊            map((result) => result.data.chat)\n+┊   ┊113┊          )\n+┊   ┊114┊        )\n+┊   ┊115┊      );\n+┊   ┊116┊    }\n ┊ 91┊117┊\n ┊ 92┊118┊    return {query$: this.getChatWqSubject.asObservable(), chat$};\n ┊ 93┊119┊  }\n```\n```diff\n@@ -295,15 +321,15 @@\n ┊295┊321┊    return _chat ? _chat.id : false;\n ┊296┊322┊  }\n ┊297┊323┊\n-┊298┊   ┊  addChat(recipientId: string, users: GetUsers.Users[]) {\n-┊299┊   ┊    return this.addChatGQL.mutate(\n+┊   ┊324┊  addChat(recipientId: string, users: GetUsers.Users[], ouiId: string) {\n+┊   ┊325┊    this.addChat$ = this.addChatGQL.mutate(\n ┊300┊326┊      {\n ┊301┊327┊        recipientId,\n ┊302┊328┊      }, {\n ┊303┊329┊        optimisticResponse: {\n ┊304┊330┊          __typename: 'Mutation',\n ┊305┊331┊          addChat: {\n-┊306┊   ┊            id: ChatsService.getRandomId(),\n+┊   ┊332┊            id: ouiId,\n ┊307┊333┊            __typename: 'Chat',\n ┊308┊334┊            name: users.find(user => user.id === recipientId).name,\n ┊309┊335┊            picture: users.find(user => user.id === recipientId).picture,\n```\n```diff\n@@ -344,11 +370,12 @@\n ┊344┊370┊          });\n ┊345┊371┊        },\n ┊346┊372┊      }\n-┊347┊   ┊    );\n+┊   ┊373┊    ).pipe(share());\n+┊   ┊374┊    return this.addChat$;\n ┊348┊375┊  }\n ┊349┊376┊\n-┊350┊   ┊  addGroup(recipientIds: string[], groupName: string) {\n-┊351┊   ┊    return this.addGroupGQL.mutate(\n+┊   ┊377┊  addGroup(recipientIds: string[], groupName: string, ouiId: string) {\n+┊   ┊378┊    this.addChat$ = this.addGroupGQL.mutate(\n ┊352┊379┊      {\n ┊353┊380┊        recipientIds,\n ┊354┊381┊        groupName,\n```\n```diff\n@@ -356,7 +383,7 @@\n ┊356┊383┊        optimisticResponse: {\n ┊357┊384┊          __typename: 'Mutation',\n ┊358┊385┊          addGroup: {\n-┊359┊   ┊            id: ChatsService.getRandomId(),\n+┊   ┊386┊            id: ouiId,\n ┊360┊387┊            __typename: 'Chat',\n ┊361┊388┊            name: groupName,\n ┊362┊389┊            picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n```\n```diff\n@@ -395,6 +422,7 @@\n ┊395┊422┊          });\n ┊396┊423┊        },\n ┊397┊424┊      }\n-┊398┊   ┊    );\n+┊   ┊425┊    ).pipe(share());\n+┊   ┊426┊    return this.addChat$;\n ┊399┊427┊  }\n ┊400┊428┊}\n```\n\n[}]: #\n\nPoof, now our Whatsapp clone feels no more like a clone it has the same native feel."
          },
          {
            "manualTitle": "Step 14: Authentication",
            "stepRevision": "3bbd4a531535c2e7e356cdf86f77e6f301264e21",
            "manualView": "![login](https://user-images.githubusercontent.com/7648874/49270369-06c22200-f4a4-11e8-83e5-cef2400989a6.jpg)\n\n## Authentication on server\n\nAuthentication is an hot topic in the GraphQL world and there are some projects which aim at authenticating through GraphQL.\nSince often you will be required to use a specific auth framework (because of a feature you need or because of an existing authorization infrastructure) I will show you how to use a classic REST API framework within your GraphQL application.\nThis approach is completely fine and in line with the official GraphQL best practices.\nWe will use `Passport` for the authentication and `BasicAuth` as the auth mechanism:\n\n    yarn add bcrypt-nodejs passport passport-http\n    yarn add -D @types/bcrypt-nodejs @types/passport @types/passport-http\n\n`BasicAuth` basically involves to send username e password in an Authorization Header together with each request and is fully supported by any browser (meaning that we will be able to use `Graphiql` simply by proving username and password in the login window provided by the browser itself).\nIt's the most simple auth mechanism but it's completely fine for our needs. Later we could decide to use something more complicated like `JWT`, but it's outside of the scope of this tutorial.\n\n[{]: <helper> (diffStep \"4.1\" files=\"index.ts\" module=\"server\")\n\n#### [Step 4.1: Authentication](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/2ee3fa9)\n\n##### Changed index.ts\n```diff\n@@ -3,6 +3,47 @@\n ┊ 3┊ 3┊import * as cors from 'cors';\n ┊ 4┊ 4┊import * as express from 'express';\n ┊ 5┊ 5┊import { ApolloServer } from \"apollo-server-express\";\n+┊  ┊ 6┊import * as passport from \"passport\";\n+┊  ┊ 7┊import * as basicStrategy from 'passport-http';\n+┊  ┊ 8┊import * as bcrypt from 'bcrypt-nodejs';\n+┊  ┊ 9┊import { db, User } from \"./db\";\n+┊  ┊10┊\n+┊  ┊11┊let users = db.users;\n+┊  ┊12┊\n+┊  ┊13┊function generateHash(password: string) {\n+┊  ┊14┊  return bcrypt.hashSync(password, bcrypt.genSaltSync(8));\n+┊  ┊15┊}\n+┊  ┊16┊\n+┊  ┊17┊function validPassword(password: string, localPassword: string) {\n+┊  ┊18┊  return bcrypt.compareSync(password, localPassword);\n+┊  ┊19┊}\n+┊  ┊20┊\n+┊  ┊21┊passport.use('basic-signin', new basicStrategy.BasicStrategy(\n+┊  ┊22┊  function (username: string, password: string, done: any) {\n+┊  ┊23┊    const user = users.find(user => user.username == username);\n+┊  ┊24┊    if (user && validPassword(password, user.password)) {\n+┊  ┊25┊      return done(null, user);\n+┊  ┊26┊    }\n+┊  ┊27┊    return done(null, false);\n+┊  ┊28┊  }\n+┊  ┊29┊));\n+┊  ┊30┊\n+┊  ┊31┊passport.use('basic-signup', new basicStrategy.BasicStrategy({passReqToCallback: true},\n+┊  ┊32┊  function (req: any, username: any, password: any, done: any) {\n+┊  ┊33┊    const userExists = !!users.find(user => user.username === username);\n+┊  ┊34┊    if (!userExists && password && req.body.name) {\n+┊  ┊35┊      const user: User = {\n+┊  ┊36┊        id: (users.length && users[users.length - 1].id + 1) || 1,\n+┊  ┊37┊        username,\n+┊  ┊38┊        password: generateHash(password),\n+┊  ┊39┊        name: req.body.name,\n+┊  ┊40┊      };\n+┊  ┊41┊      users.push(user);\n+┊  ┊42┊      return done(null, user);\n+┊  ┊43┊    }\n+┊  ┊44┊    return done(null, false);\n+┊  ┊45┊  }\n+┊  ┊46┊));\n ┊ 6┊47┊\n ┊ 7┊48┊const PORT = 3000;\n ┊ 8┊49┊\n```\n```diff\n@@ -10,9 +51,27 @@\n ┊10┊51┊\n ┊11┊52┊app.use(cors());\n ┊12┊53┊app.use(bodyParser.json());\n+┊  ┊54┊app.use(passport.initialize());\n+┊  ┊55┊\n+┊  ┊56┊app.post('/signup',\n+┊  ┊57┊  passport.authenticate('basic-signup', {session: false}),\n+┊  ┊58┊  function (req: any, res) {\n+┊  ┊59┊    res.json(req.user);\n+┊  ┊60┊  });\n+┊  ┊61┊\n+┊  ┊62┊app.use(passport.authenticate('basic-signin', {session: false}));\n+┊  ┊63┊\n+┊  ┊64┊app.post('/signin', function (req: any, res) {\n+┊  ┊65┊  res.json(req.user);\n+┊  ┊66┊});\n ┊13┊67┊\n ┊14┊68┊const apollo = new ApolloServer({\n-┊15┊  ┊  schema\n+┊  ┊69┊  schema,\n+┊  ┊70┊  context(received: any) {\n+┊  ┊71┊    return {\n+┊  ┊72┊      user: received.req!['user'],\n+┊  ┊73┊    }\n+┊  ┊74┊  },\n ┊16┊75┊});\n ┊17┊76┊\n ┊18┊77┊apollo.applyMiddleware({\n```\n\n[}]: #\n\nWe are going to store hashes instead of plain passwords, that's why we're using `bcrypt-nodejs`.\nWith `passport.use('basic-signin')` and `passport.use('basic-signup')` we define how the auth framework deals with our database (well, our JSON file for the moment).\n`app.post('/signup')` is the endpoint for creating new accounts, so we left it out of the authentication middleware (`app.use(passport.authenticate('basic-signin')`).\nWhat's of particular interest is that we're passing the user object to the GraphQL context.\n\n[{]: <helper> (diffStep \"4.1\" files=\"schema/resolvers.ts\" module=\"server\")\n\n#### [Step 4.1: Authentication](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/2ee3fa9)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -8,29 +8,28 @@\n ┊ 8┊ 8┊\n ┊ 9┊ 9┊let users = db.users;\n ┊10┊10┊let chats = db.chats;\n-┊11┊  ┊const currentUser = 1;\n ┊12┊11┊\n ┊13┊12┊export const resolvers: IResolvers = {\n ┊14┊13┊  Query: {\n ┊15┊14┊    // Show all users for the moment.\n-┊16┊  ┊    users: (): User[] => users.filter(user => user.id !== currentUser),\n-┊17┊  ┊    chats: (): Chat[] => chats.filter(chat => chat.listingMemberIds.includes(currentUser)),\n+┊  ┊15┊    users: (obj: any, args: any, {user: currentUser}: {user: User}): User[] => users.filter(user => user.id !== currentUser.id),\n+┊  ┊16┊    chats: (obj: any, args: any, {user: currentUser}: {user: User}): Chat[] => chats.filter(chat => chat.listingMemberIds.includes(currentUser.id)),\n ┊18┊17┊    chat: (obj: any, {chatId}: ChatQueryArgs): Chat | null => chats.find(chat => chat.id === Number(chatId)) || null,\n ┊19┊18┊  },\n ┊20┊19┊  Mutation: {\n-┊21┊  ┊    addChat: (obj: any, {recipientId}: AddChatMutationArgs): Chat => {\n+┊  ┊20┊    addChat: (obj: any, {recipientId}: AddChatMutationArgs, {user: currentUser}: {user: User}): Chat => {\n ┊22┊21┊      if (!users.find(user => user.id === Number(recipientId))) {\n ┊23┊22┊        throw new Error(`Recipient ${recipientId} doesn't exist.`);\n ┊24┊23┊      }\n ┊25┊24┊\n-┊26┊  ┊      const chat = chats.find(chat => !chat.name && chat.allTimeMemberIds.includes(currentUser) && chat.allTimeMemberIds.includes(Number(recipientId)));\n+┊  ┊25┊      const chat = chats.find(chat => !chat.name && chat.allTimeMemberIds.includes(currentUser.id) && chat.allTimeMemberIds.includes(Number(recipientId)));\n ┊27┊26┊      if (chat) {\n ┊28┊27┊        // Chat already exists. Both users are already in the allTimeMemberIds array\n ┊29┊28┊        const chatId = chat.id;\n-┊30┊  ┊        if (!chat.listingMemberIds.includes(currentUser)) {\n+┊  ┊29┊        if (!chat.listingMemberIds.includes(currentUser.id)) {\n ┊31┊30┊          // The chat isn't listed for the current user. Add him to the memberIds\n-┊32┊  ┊          chat.listingMemberIds.push(currentUser);\n-┊33┊  ┊          chats.find(chat => chat.id === chatId)!.listingMemberIds.push(currentUser);\n+┊  ┊31┊          chat.listingMemberIds.push(currentUser.id);\n+┊  ┊32┊          chats.find(chat => chat.id === chatId)!.listingMemberIds.push(currentUser.id);\n ┊34┊33┊          return chat;\n ┊35┊34┊        } else {\n ┊36┊35┊          throw new Error(`Chat already exists.`);\n```\n```diff\n@@ -44,9 +43,9 @@\n ┊44┊43┊          picture: null,\n ┊45┊44┊          adminIds: null,\n ┊46┊45┊          ownerId: null,\n-┊47┊  ┊          allTimeMemberIds: [currentUser, Number(recipientId)],\n+┊  ┊46┊          allTimeMemberIds: [currentUser.id, Number(recipientId)],\n ┊48┊47┊          // Chat will not be listed to the other user until the first message gets written\n-┊49┊  ┊          listingMemberIds: [currentUser],\n+┊  ┊48┊          listingMemberIds: [currentUser.id],\n ┊50┊49┊          actualGroupMemberIds: null,\n ┊51┊50┊          messages: [],\n ┊52┊51┊        };\n```\n```diff\n@@ -54,7 +53,7 @@\n ┊54┊53┊        return chat;\n ┊55┊54┊      }\n ┊56┊55┊    },\n-┊57┊  ┊    addGroup: (obj: any, {recipientIds, groupName}: AddGroupMutationArgs): Chat => {\n+┊  ┊56┊    addGroup: (obj: any, {recipientIds, groupName}: AddGroupMutationArgs, {user: currentUser}: {user: User}): Chat => {\n ┊58┊57┊      recipientIds.forEach(recipientId => {\n ┊59┊58┊        if (!users.find(user => user.id === Number(recipientId))) {\n ┊60┊59┊          throw new Error(`Recipient ${recipientId} doesn't exist.`);\n```\n```diff\n@@ -66,17 +65,17 @@\n ┊66┊65┊        id,\n ┊67┊66┊        name: groupName,\n ┊68┊67┊        picture: null,\n-┊69┊  ┊        adminIds: [currentUser],\n-┊70┊  ┊        ownerId: currentUser,\n-┊71┊  ┊        allTimeMemberIds: [currentUser, ...recipientIds.map(id => Number(id))],\n-┊72┊  ┊        listingMemberIds: [currentUser, ...recipientIds.map(id => Number(id))],\n-┊73┊  ┊        actualGroupMemberIds: [currentUser, ...recipientIds.map(id => Number(id))],\n+┊  ┊68┊        adminIds: [currentUser.id],\n+┊  ┊69┊        ownerId: currentUser.id,\n+┊  ┊70┊        allTimeMemberIds: [currentUser.id, ...recipientIds.map(id => Number(id))],\n+┊  ┊71┊        listingMemberIds: [currentUser.id, ...recipientIds.map(id => Number(id))],\n+┊  ┊72┊        actualGroupMemberIds: [currentUser.id, ...recipientIds.map(id => Number(id))],\n ┊74┊73┊        messages: [],\n ┊75┊74┊      };\n ┊76┊75┊      chats.push(chat);\n ┊77┊76┊      return chat;\n ┊78┊77┊    },\n-┊79┊  ┊    removeChat: (obj: any, {chatId}: RemoveChatMutationArgs): number => {\n+┊  ┊78┊    removeChat: (obj: any, {chatId}: RemoveChatMutationArgs, {user: currentUser}: {user: User}): number => {\n ┊80┊79┊      const chat = chats.find(chat => chat.id === Number(chatId));\n ┊81┊80┊\n ┊82┊81┊      if (!chat) {\n```\n```diff\n@@ -85,14 +84,14 @@\n ┊85┊84┊\n ┊86┊85┊      if (!chat.name) {\n ┊87┊86┊        // Chat\n-┊88┊  ┊        if (!chat.listingMemberIds.includes(currentUser)) {\n+┊  ┊87┊        if (!chat.listingMemberIds.includes(currentUser.id)) {\n ┊89┊88┊          throw new Error(`The user is not a member of the chat ${chatId}.`);\n ┊90┊89┊        }\n ┊91┊90┊\n ┊92┊91┊        // Instead of chaining map and filter we can loop once using reduce\n ┊93┊92┊        const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n ┊94┊93┊          // Remove the current user from the message holders\n-┊95┊  ┊          message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser);\n+┊  ┊94┊          message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser.id);\n ┊96┊95┊\n ┊97┊96┊          if (message.holderIds.length !== 0) {\n ┊98┊97┊            filtered.push(message);\n```\n```diff\n@@ -102,7 +101,7 @@\n ┊102┊101┊        }, []);\n ┊103┊102┊\n ┊104┊103┊        // Remove the current user from who gets the chat listed. The chat will no longer appear in his list\n-┊105┊   ┊        const listingMemberIds = chat.listingMemberIds.filter(listingId => listingId !== currentUser);\n+┊   ┊104┊        const listingMemberIds = chat.listingMemberIds.filter(listingId => listingId !== currentUser.id);\n ┊106┊105┊\n ┊107┊106┊        // Check how many members are left\n ┊108┊107┊        if (listingMemberIds.length === 0) {\n```\n```diff\n@@ -120,14 +119,14 @@\n ┊120┊119┊        return Number(chatId);\n ┊121┊120┊      } else {\n ┊122┊121┊        // Group\n-┊123┊   ┊        if (chat.ownerId !== currentUser) {\n+┊   ┊122┊        if (chat.ownerId !== currentUser.id) {\n ┊124┊123┊          throw new Error(`Group ${chatId} is not owned by the user.`);\n ┊125┊124┊        }\n ┊126┊125┊\n ┊127┊126┊        // Instead of chaining map and filter we can loop once using reduce\n ┊128┊127┊        const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n ┊129┊128┊          // Remove the current user from the message holders\n-┊130┊   ┊          message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser);\n+┊   ┊129┊          message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser.id);\n ┊131┊130┊\n ┊132┊131┊          if (message.holderIds.length !== 0) {\n ┊133┊132┊            filtered.push(message);\n```\n```diff\n@@ -137,7 +136,7 @@\n ┊137┊136┊        }, []);\n ┊138┊137┊\n ┊139┊138┊        // Remove the current user from who gets the group listed. The group will no longer appear in his list\n-┊140┊   ┊        const listingMemberIds = chat.listingMemberIds.filter(listingId => listingId !== currentUser);\n+┊   ┊139┊        const listingMemberIds = chat.listingMemberIds.filter(listingId => listingId !== currentUser.id);\n ┊141┊140┊\n ┊142┊141┊        // Check how many members (including previous ones who can still access old messages) are left\n ┊143┊142┊        if (listingMemberIds.length === 0) {\n```\n```diff\n@@ -147,9 +146,9 @@\n ┊147┊146┊          // Update the group\n ┊148┊147┊\n ┊149┊148┊          // Remove the current user from the chat members. He is no longer a member of the group\n-┊150┊   ┊          const actualGroupMemberIds = chat.actualGroupMemberIds!.filter(memberId => memberId !== currentUser);\n+┊   ┊149┊          const actualGroupMemberIds = chat.actualGroupMemberIds!.filter(memberId => memberId !== currentUser.id);\n ┊151┊150┊          // Remove the current user from the chat admins\n-┊152┊   ┊          const adminIds = chat.adminIds!.filter(memberId => memberId !== currentUser);\n+┊   ┊151┊          const adminIds = chat.adminIds!.filter(memberId => memberId !== currentUser.id);\n ┊153┊152┊          // Set the owner id to be null. A null owner means the group is read-only\n ┊154┊153┊          let ownerId: number | null = null;\n ┊155┊154┊\n```\n```diff\n@@ -169,7 +168,7 @@\n ┊169┊168┊        return Number(chatId);\n ┊170┊169┊      }\n ┊171┊170┊    },\n-┊172┊   ┊    addMessage: (obj: any, {chatId, content}: AddMessageMutationArgs): Message => {\n+┊   ┊171┊    addMessage: (obj: any, {chatId, content}: AddMessageMutationArgs, {user: currentUser}: {user: User}): Message => {\n ┊173┊172┊      if (content === null || content === '') {\n ┊174┊173┊        throw new Error(`Cannot add empty or null messages.`);\n ┊175┊174┊      }\n```\n```diff\n@@ -184,11 +183,11 @@\n ┊184┊183┊\n ┊185┊184┊      if (!chat.name) {\n ┊186┊185┊        // Chat\n-┊187┊   ┊        if (!chat.listingMemberIds.find(listingId => listingId === currentUser)) {\n+┊   ┊186┊        if (!chat.listingMemberIds.find(listingId => listingId === currentUser.id)) {\n ┊188┊187┊          throw new Error(`The chat ${chatId} must be listed for the current user before adding a message.`);\n ┊189┊188┊        }\n ┊190┊189┊\n-┊191┊   ┊        const recipientId = chat.allTimeMemberIds.filter(userId => userId !== currentUser)[0];\n+┊   ┊190┊        const recipientId = chat.allTimeMemberIds.filter(userId => userId !== currentUser.id)[0];\n ┊192┊191┊\n ┊193┊192┊        if (!chat.listingMemberIds.find(listingId => listingId === recipientId)) {\n ┊194┊193┊          // Chat is not listed for the recipient. Add him to the listingMemberIds\n```\n```diff\n@@ -205,7 +204,7 @@\n ┊205┊204┊        }\n ┊206┊205┊      } else {\n ┊207┊206┊        // Group\n-┊208┊   ┊        if (!chat.actualGroupMemberIds!.find(memberId => memberId === currentUser)) {\n+┊   ┊207┊        if (!chat.actualGroupMemberIds!.find(memberId => memberId === currentUser.id)) {\n ┊209┊208┊          throw new Error(`The user is not a member of the group ${chatId}. Cannot add message.`);\n ┊210┊209┊        }\n ┊211┊210┊\n```\n```diff\n@@ -217,7 +216,7 @@\n ┊217┊216┊      let recipients: Recipient[] = [];\n ┊218┊217┊\n ┊219┊218┊      holderIds.forEach(holderId => {\n-┊220┊   ┊        if (holderId !== currentUser) {\n+┊   ┊219┊        if (holderId !== currentUser.id) {\n ┊221┊220┊          recipients.push({\n ┊222┊221┊            userId: holderId,\n ┊223┊222┊            messageId: id,\n```\n```diff\n@@ -231,7 +230,7 @@\n ┊231┊230┊      const message: Message = {\n ┊232┊231┊        id,\n ┊233┊232┊        chatId: Number(chatId),\n-┊234┊   ┊        senderId: currentUser,\n+┊   ┊233┊        senderId: currentUser.id,\n ┊235┊234┊        content,\n ┊236┊235┊        createdAt: moment().unix(),\n ┊237┊236┊        type: MessageType.TEXT,\n```\n```diff\n@@ -248,14 +247,14 @@\n ┊248┊247┊\n ┊249┊248┊      return message;\n ┊250┊249┊    },\n-┊251┊   ┊    removeMessages: (obj: any, {chatId, messageIds, all}: RemoveMessagesMutationArgs): number[] => {\n+┊   ┊250┊    removeMessages: (obj: any, {chatId, messageIds, all}: RemoveMessagesMutationArgs, {user: currentUser}: {user: User}): number[] => {\n ┊252┊251┊      const chat = chats.find(chat => chat.id === Number(chatId));\n ┊253┊252┊\n ┊254┊253┊      if (!chat) {\n ┊255┊254┊        throw new Error(`Cannot find chat ${chatId}.`);\n ┊256┊255┊      }\n ┊257┊256┊\n-┊258┊   ┊      if (!chat.listingMemberIds.find(listingId => listingId === currentUser)) {\n+┊   ┊257┊      if (!chat.listingMemberIds.find(listingId => listingId === currentUser.id)) {\n ┊259┊258┊        throw new Error(`The chat/group ${chatId} is not listed for the current user, so there is nothing to delete.`);\n ┊260┊259┊      }\n ┊261┊260┊\n```\n```diff\n@@ -271,7 +270,7 @@\n ┊271┊270┊            if (all || messageIds!.includes(String(message.id))) {\n ┊272┊271┊              deletedIds.push(message.id);\n ┊273┊272┊              // Remove the current user from the message holders\n-┊274┊   ┊              message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser);\n+┊   ┊273┊              message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser.id);\n ┊275┊274┊            }\n ┊276┊275┊\n ┊277┊276┊            if (message.holderIds.length !== 0) {\n```\n```diff\n@@ -288,24 +287,24 @@\n ┊288┊287┊    },\n ┊289┊288┊  },\n ┊290┊289┊  Chat: {\n-┊291┊   ┊    name: (chat: Chat): string => chat.name ? chat.name : users\n-┊292┊   ┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser))!.name,\n-┊293┊   ┊    picture: (chat: Chat) => chat.name ? chat.picture : users\n-┊294┊   ┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser))!.picture,\n+┊   ┊290┊    name: (chat: Chat, args: any, {user: currentUser}: {user: User}): string => chat.name ? chat.name : users\n+┊   ┊291┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser.id))!.name,\n+┊   ┊292┊    picture: (chat: Chat, args: any, {user: currentUser}: {user: User}) => chat.name ? chat.picture : users\n+┊   ┊293┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser.id))!.picture,\n ┊295┊294┊    allTimeMembers: (chat: Chat): User[] => users.filter(user => chat.allTimeMemberIds.includes(user.id)),\n ┊296┊295┊    listingMembers: (chat: Chat): User[] => users.filter(user => chat.listingMemberIds.includes(user.id)),\n ┊297┊296┊    actualGroupMembers: (chat: Chat): User[] => users.filter(user => chat.actualGroupMemberIds && chat.actualGroupMemberIds.includes(user.id)),\n ┊298┊297┊    admins: (chat: Chat): User[] => users.filter(user => chat.adminIds && chat.adminIds.includes(user.id)),\n ┊299┊298┊    owner: (chat: Chat): User | null => users.find(user => chat.ownerId === user.id) || null,\n-┊300┊   ┊    messages: (chat: Chat, {amount = 0}: {amount: number}): Message[] => {\n+┊   ┊299┊    messages: (chat: Chat, {amount = 0}: {amount: number}, {user: currentUser}: {user: User}): Message[] => {\n ┊301┊300┊      const messages = chat.messages\n-┊302┊   ┊      .filter(message => message.holderIds.includes(currentUser))\n+┊   ┊301┊      .filter(message => message.holderIds.includes(currentUser.id))\n ┊303┊302┊      .sort((a, b) => b.createdAt - a.createdAt) || <Message[]>[];\n ┊304┊303┊      return (amount ? messages.slice(0, amount) : messages).reverse();\n ┊305┊304┊    },\n-┊306┊   ┊    unreadMessages: (chat: Chat): number => chat.messages\n-┊307┊   ┊      .filter(message => message.holderIds.includes(currentUser) &&\n-┊308┊   ┊        message.recipients.find(recipient => recipient.userId === currentUser && !recipient.readAt))\n+┊   ┊305┊    unreadMessages: (chat: Chat, args: any, {user: currentUser}: {user: User}): number => chat.messages\n+┊   ┊306┊      .filter(message => message.holderIds.includes(currentUser.id) &&\n+┊   ┊307┊        message.recipients.find(recipient => recipient.userId === currentUser.id && !recipient.readAt))\n ┊309┊308┊      .length,\n ┊310┊309┊    isGroup: (chat: Chat): boolean => !!chat.name,\n ┊311┊310┊  },\n```\n```diff\n@@ -313,7 +312,7 @@\n ┊313┊312┊    chat: (message: Message): Chat | null => chats.find(chat => message.chatId === chat.id) || null,\n ┊314┊313┊    sender: (message: Message): User | null => users.find(user => user.id === message.senderId) || null,\n ┊315┊314┊    holders: (message: Message): User[] => users.filter(user => message.holderIds.includes(user.id)),\n-┊316┊   ┊    ownership: (message: Message): boolean => message.senderId === currentUser,\n+┊   ┊315┊    ownership: (message: Message, args: any, {user: currentUser}: {user: User}): boolean => message.senderId === currentUser.id,\n ┊317┊316┊  },\n ┊318┊317┊  Recipient: {\n ┊319┊318┊    user: (recipient: Recipient): User | null => users.find(user => recipient.userId === user.id) || null,\n```\n\n[}]: #\n\nIn the resolvers we're basically making use of the user object taken from the context.\n\n## Authentication on client\n\nLet's start installing `@angular/flex-layout`, because we will use it later:\n\n    yarn add @angular/flex-layout\n\n\nFirst of all we need to create an `HTTP Interceptor`, which will intercept every HTTP request and will add authentication headers.\nFor the moment we still don't have those headers, but we are going to store them in the `LocalStorage` later.\nWe are also creating an `AuthGuard`, which we will use to stop the user from reaching unauthorized Routes.\n\nThe `AuthGuard` will simply look for the presence of the `Authentication` Header, but will not guarantee that the header is authentic.\nThis is no problem, because client side AuthGuards are not safe by design and the real authentication will be done server side anyway.\nAuthGuards are here just to redirect the user to the Login page.\n\nThe service we are going to create will contain some auth methods we are going to use across the app.\n\n[{]: <helper> (diffStep \"10.1\" files=\"src/app/login/services\" module=\"client\")\n\n#### [Step 10.1: Authentication](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/34faf60)\n\n##### Added src&#x2F;app&#x2F;login&#x2F;services&#x2F;auth.guard.ts\n```diff\n@@ -0,0 +1,18 @@\n+┊  ┊ 1┊import {Injectable} from '@angular/core';\n+┊  ┊ 2┊import {CanActivate, Router} from '@angular/router';\n+┊  ┊ 3┊import {LoginService} from './login.service';\n+┊  ┊ 4┊\n+┊  ┊ 5┊@Injectable()\n+┊  ┊ 6┊export class AuthGuard implements CanActivate {\n+┊  ┊ 7┊  constructor(private router: Router,\n+┊  ┊ 8┊              private loginService: LoginService) {}\n+┊  ┊ 9┊\n+┊  ┊10┊  canActivate() {\n+┊  ┊11┊    if (this.loginService.getAuthHeader()) {\n+┊  ┊12┊      return true;\n+┊  ┊13┊    } else {\n+┊  ┊14┊      this.router.navigate(['/login']);\n+┊  ┊15┊      return false;\n+┊  ┊16┊    }\n+┊  ┊17┊  }\n+┊  ┊18┊}\n```\n\n##### Added src&#x2F;app&#x2F;login&#x2F;services&#x2F;auth.interceptor.ts\n```diff\n@@ -0,0 +1,20 @@\n+┊  ┊ 1┊import {Injectable} from '@angular/core';\n+┊  ┊ 2┊import {HttpEvent, HttpHandler, HttpInterceptor, HttpRequest} from '@angular/common/http';\n+┊  ┊ 3┊import {Observable} from 'rxjs';\n+┊  ┊ 4┊import {LoginService} from './login.service';\n+┊  ┊ 5┊\n+┊  ┊ 6┊@Injectable()\n+┊  ┊ 7┊export class AuthInterceptor implements HttpInterceptor {\n+┊  ┊ 8┊  constructor(private loginService: LoginService) {}\n+┊  ┊ 9┊  intercept(request: HttpRequest<any>, next: HttpHandler): Observable<HttpEvent<any>> {\n+┊  ┊10┊    const auth = this.loginService.getAuthHeader();\n+┊  ┊11┊    if (auth) {\n+┊  ┊12┊      request = request.clone({\n+┊  ┊13┊        setHeaders: {\n+┊  ┊14┊          Authorization: auth,\n+┊  ┊15┊        }\n+┊  ┊16┊      });\n+┊  ┊17┊    }\n+┊  ┊18┊    return next.handle(request);\n+┊  ┊19┊  }\n+┊  ┊20┊}\n```\n\n##### Added src&#x2F;app&#x2F;login&#x2F;services&#x2F;login.service.ts\n```diff\n@@ -0,0 +1,24 @@\n+┊  ┊ 1┊import { Injectable } from '@angular/core';\n+┊  ┊ 2┊import {User} from '../../../graphql';\n+┊  ┊ 3┊\n+┊  ┊ 4┊@Injectable()\n+┊  ┊ 5┊export class LoginService {\n+┊  ┊ 6┊\n+┊  ┊ 7┊  constructor() { }\n+┊  ┊ 8┊\n+┊  ┊ 9┊  storeAuthHeader(auth: string) {\n+┊  ┊10┊    localStorage.setItem('Authorization', auth);\n+┊  ┊11┊  }\n+┊  ┊12┊\n+┊  ┊13┊  getAuthHeader(): string {\n+┊  ┊14┊    return localStorage.getItem('Authorization');\n+┊  ┊15┊  }\n+┊  ┊16┊\n+┊  ┊17┊  storeUser(user: User) {\n+┊  ┊18┊    localStorage.setItem('user', JSON.stringify(user));\n+┊  ┊19┊  }\n+┊  ┊20┊\n+┊  ┊21┊  getUser(): User {\n+┊  ┊22┊    return JSON.parse(localStorage.getItem('user'));\n+┊  ┊23┊  }\n+┊  ┊24┊}\n```\n\n[}]: #\n\nNow it's time to create a `SignIn`/`SignUp` component. Since we use Passport in the server we are going to make REST calls for the authentication, instead of using GraphQL.\nSince we use `Basic Auth` we will simply combine the username and the password together to create the authentication header.\nWe will also store the response from the server, which will contain the user information like the ID, etc. which we are going to need later.\n\nFirst we we will download a WhatsApp picture that will be used in the login component:\n\n    $ wget https://user-images.githubusercontent.com/7648874/49260078-e7f96680-f476-11e8-8711-06bc6490858a.png -P src/assets\n\nAnd then we will proceed to creating the component itself and everything around it:\n\n[{]: <helper> (diffStep \"10.1\" files=\"src/app/login/containers, src/app/login/login.module.ts\" module=\"client\")\n\n#### [Step 10.1: Authentication](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/34faf60)\n\n##### Added src&#x2F;app&#x2F;login&#x2F;containers&#x2F;login.component.scss\n```diff\n@@ -0,0 +1,18 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊}\n+┊  ┊ 4┊\n+┊  ┊ 5┊form:first-of-type {\n+┊  ┊ 6┊  margin-top: 24px;\n+┊  ┊ 7┊  margin-bottom: 48px;\n+┊  ┊ 8┊}\n+┊  ┊ 9┊\n+┊  ┊10┊label {\n+┊  ┊11┊  display: block;\n+┊  ┊12┊  margin-top: 4px;\n+┊  ┊13┊  margin-bottom: 4px;\n+┊  ┊14┊}\n+┊  ┊15┊\n+┊  ┊16┊.error {\n+┊  ┊17┊  color: red;\n+┊  ┊18┊}\n```\n\n##### Added src&#x2F;app&#x2F;login&#x2F;containers&#x2F;login.component.ts\n```diff\n@@ -0,0 +1,133 @@\n+┊   ┊  1┊import {Component} from '@angular/core';\n+┊   ┊  2┊import {HttpClient} from '@angular/common/http';\n+┊   ┊  3┊import {FormBuilder, Validators} from '@angular/forms';\n+┊   ┊  4┊// import {matchOtherValidator} from '@moebius/ng-validators';\n+┊   ┊  5┊import {Router} from '@angular/router';\n+┊   ┊  6┊import {User} from '../../../graphql';\n+┊   ┊  7┊import {LoginService} from '../services/login.service';\n+┊   ┊  8┊\n+┊   ┊  9┊@Component({\n+┊   ┊ 10┊  selector: 'app-login',\n+┊   ┊ 11┊  template: `\n+┊   ┊ 12┊    <form (ngSubmit)=\"signIn()\" [formGroup]=\"signInForm\" novalidate>\n+┊   ┊ 13┊      <fieldset fxLayout=\"column\" fxLayoutGap=\"17px\">\n+┊   ┊ 14┊        <legend>Sign in</legend>\n+┊   ┊ 15┊        <div>\n+┊   ┊ 16┊          <label>Username</label>\n+┊   ┊ 17┊          <input formControlName=\"username\" autocomplete=\"username\" type=\"text\">\n+┊   ┊ 18┊        </div>\n+┊   ┊ 19┊        <div class=\"error\" *ngIf=\"signInForm.get('username').hasError('required') && signInForm.get('username').touched\">\n+┊   ┊ 20┊          Username is required\n+┊   ┊ 21┊        </div>\n+┊   ┊ 22┊\n+┊   ┊ 23┊        <div>\n+┊   ┊ 24┊          <label>Password</label>\n+┊   ┊ 25┊          <input formControlName=\"password\" autocomplete=\"current-password\" type=\"password\">\n+┊   ┊ 26┊        </div>\n+┊   ┊ 27┊        <div class=\"error\" *ngIf=\"signInForm.get('password').hasError('required') && signInForm.get('password').touched\">\n+┊   ┊ 28┊          Password is required\n+┊   ┊ 29┊        </div>\n+┊   ┊ 30┊\n+┊   ┊ 31┊        <button type=\"submit\" [disabled]=\"signInForm.invalid\">Sign in</button>\n+┊   ┊ 32┊      </fieldset>\n+┊   ┊ 33┊    </form>\n+┊   ┊ 34┊\n+┊   ┊ 35┊    <form (ngSubmit)=\"signUp()\" [formGroup]=\"signUpForm\" novalidate>\n+┊   ┊ 36┊      <fieldset fxLayout=\"column\" fxLayoutGap=\"17px\">\n+┊   ┊ 37┊        <legend>Sign up</legend>\n+┊   ┊ 38┊        <div>\n+┊   ┊ 39┊          <label>Name</label>\n+┊   ┊ 40┊          <input formControlName=\"name\" type=\"text\">\n+┊   ┊ 41┊        </div>\n+┊   ┊ 42┊\n+┊   ┊ 43┊        <div>\n+┊   ┊ 44┊          <label>Username</label>\n+┊   ┊ 45┊          <input formControlName=\"username\" autocomplete=\"username\" type=\"text\">\n+┊   ┊ 46┊        </div>\n+┊   ┊ 47┊        <div class=\"error\" *ngIf=\"signUpForm.get('username').hasError('required') && signUpForm.get('username').touched\">\n+┊   ┊ 48┊          Username is required\n+┊   ┊ 49┊        </div>\n+┊   ┊ 50┊\n+┊   ┊ 51┊        <div>\n+┊   ┊ 52┊          <label>Password</label>\n+┊   ┊ 53┊          <input formControlName=\"newPassword\" autocomplete=\"new-password\" type=\"password\">\n+┊   ┊ 54┊        </div>\n+┊   ┊ 55┊        <div class=\"error\" *ngIf=\"signUpForm.get('newPassword').hasError('required') && signUpForm.get('newPassword').touched\">\n+┊   ┊ 56┊          Password is required\n+┊   ┊ 57┊        </div>\n+┊   ┊ 58┊\n+┊   ┊ 59┊        <div>\n+┊   ┊ 60┊          <label>Password</label>\n+┊   ┊ 61┊          <input formControlName=\"confirmPassword\" type=\"password\">\n+┊   ┊ 62┊        </div>\n+┊   ┊ 63┊        <div class=\"error\" *ngIf=\"signUpForm.get('confirmPassword').hasError('required') && signUpForm.get('confirmPassword').touched\">\n+┊   ┊ 64┊          Passwords must match\n+┊   ┊ 65┊        </div>\n+┊   ┊ 66┊\n+┊   ┊ 67┊        <button type=\"submit\" [disabled]=\"signUpForm.invalid\">Sign up</button>\n+┊   ┊ 68┊      </fieldset>\n+┊   ┊ 69┊    </form>\n+┊   ┊ 70┊  `,\n+┊   ┊ 71┊  styleUrls: ['./login.component.scss'],\n+┊   ┊ 72┊})\n+┊   ┊ 73┊export class LoginComponent {\n+┊   ┊ 74┊  signInForm = this.fb.group({\n+┊   ┊ 75┊    username: [null, [\n+┊   ┊ 76┊      Validators.required,\n+┊   ┊ 77┊    ]],\n+┊   ┊ 78┊    password: [null, [\n+┊   ┊ 79┊      Validators.required,\n+┊   ┊ 80┊    ]],\n+┊   ┊ 81┊  });\n+┊   ┊ 82┊\n+┊   ┊ 83┊  signUpForm = this.fb.group({\n+┊   ┊ 84┊    name: [null, [\n+┊   ┊ 85┊      Validators.required,\n+┊   ┊ 86┊    ]],\n+┊   ┊ 87┊    username: [null, [\n+┊   ┊ 88┊      Validators.required,\n+┊   ┊ 89┊    ]],\n+┊   ┊ 90┊    newPassword: [null, [\n+┊   ┊ 91┊      Validators.required,\n+┊   ┊ 92┊    ]],\n+┊   ┊ 93┊    confirmPassword: [null, [\n+┊   ┊ 94┊      Validators.required,\n+┊   ┊ 95┊      // matchOtherValidator('newPassword'),\n+┊   ┊ 96┊    ]],\n+┊   ┊ 97┊  });\n+┊   ┊ 98┊\n+┊   ┊ 99┊  constructor(private http: HttpClient,\n+┊   ┊100┊              private fb: FormBuilder,\n+┊   ┊101┊              private router: Router,\n+┊   ┊102┊              private loginService: LoginService) {}\n+┊   ┊103┊\n+┊   ┊104┊  signIn() {\n+┊   ┊105┊    const {username, password} = this.signInForm.value;\n+┊   ┊106┊    const auth = `Basic ${btoa(`${username}:${password}`)}`;\n+┊   ┊107┊    this.http.post('http://localhost:3000/signin', null, {\n+┊   ┊108┊      headers: {\n+┊   ┊109┊        Authorization: auth,\n+┊   ┊110┊      }\n+┊   ┊111┊    }).subscribe((user: User) => {\n+┊   ┊112┊      this.loginService.storeAuthHeader(auth);\n+┊   ┊113┊      this.loginService.storeUser(user);\n+┊   ┊114┊      this.router.navigate(['/chats']);\n+┊   ┊115┊    }, err => console.error(err));\n+┊   ┊116┊  }\n+┊   ┊117┊\n+┊   ┊118┊  signUp() {\n+┊   ┊119┊    const {username, newPassword: password, name} = this.signInForm.value;\n+┊   ┊120┊    const auth = `Basic ${btoa(`${username}:${password}`)}`;\n+┊   ┊121┊    this.http.post('http://localhost:3000/signup', {\n+┊   ┊122┊      name,\n+┊   ┊123┊    }, {\n+┊   ┊124┊      headers: {\n+┊   ┊125┊        Authorization: auth,\n+┊   ┊126┊      }\n+┊   ┊127┊    }).subscribe((user: User) => {\n+┊   ┊128┊      this.loginService.storeAuthHeader(auth);\n+┊   ┊129┊      this.loginService.storeUser(user);\n+┊   ┊130┊      this.router.navigate(['/chats']);\n+┊   ┊131┊    }, err => console.error(err));\n+┊   ┊132┊  }\n+┊   ┊133┊}\n```\n\n##### Added src&#x2F;app&#x2F;login&#x2F;login.module.ts\n```diff\n@@ -0,0 +1,52 @@\n+┊  ┊ 1┊import {RouterModule, Routes} from '@angular/router';\n+┊  ┊ 2┊import {NgModule} from '@angular/core';\n+┊  ┊ 3┊import {TruncateModule} from 'ng2-truncate';\n+┊  ┊ 4┊import {MatButtonModule, MatIconModule, MatListModule, MatMenuModule} from '@angular/material';\n+┊  ┊ 5┊import {SharedModule} from '../shared/shared.module';\n+┊  ┊ 6┊import {BrowserModule} from '@angular/platform-browser';\n+┊  ┊ 7┊import {FormsModule, ReactiveFormsModule} from '@angular/forms';\n+┊  ┊ 8┊import {BrowserAnimationsModule} from '@angular/platform-browser/animations';\n+┊  ┊ 9┊import {LoginComponent} from './containers/login.component';\n+┊  ┊10┊import {FlexLayoutModule} from '@angular/flex-layout';\n+┊  ┊11┊import {AuthInterceptor} from './services/auth.interceptor';\n+┊  ┊12┊import {AuthGuard} from './services/auth.guard';\n+┊  ┊13┊import {LoginService} from './services/login.service';\n+┊  ┊14┊\n+┊  ┊15┊\n+┊  ┊16┊const routes: Routes = [\n+┊  ┊17┊  {path: 'login', component: LoginComponent},\n+┊  ┊18┊];\n+┊  ┊19┊\n+┊  ┊20┊@NgModule({\n+┊  ┊21┊  declarations: [\n+┊  ┊22┊    LoginComponent,\n+┊  ┊23┊  ],\n+┊  ┊24┊  imports: [\n+┊  ┊25┊    BrowserModule,\n+┊  ┊26┊    // Material\n+┊  ┊27┊    MatMenuModule,\n+┊  ┊28┊    MatIconModule,\n+┊  ┊29┊    MatButtonModule,\n+┊  ┊30┊    MatListModule,\n+┊  ┊31┊    // Animations\n+┊  ┊32┊    BrowserAnimationsModule,\n+┊  ┊33┊    // Flex layout\n+┊  ┊34┊    FlexLayoutModule,\n+┊  ┊35┊    // Routing\n+┊  ┊36┊    RouterModule.forChild(routes),\n+┊  ┊37┊    // Forms\n+┊  ┊38┊    FormsModule,\n+┊  ┊39┊    ReactiveFormsModule,\n+┊  ┊40┊    // Truncate Pipe\n+┊  ┊41┊    TruncateModule,\n+┊  ┊42┊    // Feature modules\n+┊  ┊43┊    SharedModule,\n+┊  ┊44┊  ],\n+┊  ┊45┊  providers: [\n+┊  ┊46┊    LoginService,\n+┊  ┊47┊    AuthInterceptor,\n+┊  ┊48┊    AuthGuard,\n+┊  ┊49┊  ],\n+┊  ┊50┊})\n+┊  ┊51┊export class LoginModule {\n+┊  ┊52┊}\n```\n\n[}]: #\n\nNow it's time use the Interceptor we just created:\n\n[{]: <helper> (diffStep \"10.1\" files=\"src/app/app.module.ts\" module=\"client\")\n\n#### [Step 10.1: Authentication](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/34faf60)\n\n##### Changed src&#x2F;app&#x2F;app.module.ts\n```diff\n@@ -2,12 +2,14 @@\n ┊ 2┊ 2┊import { NgModule } from '@angular/core';\n ┊ 3┊ 3┊\n ┊ 4┊ 4┊import { AppComponent } from './app.component';\n-┊ 5┊  ┊import { HttpClientModule } from '@angular/common/http';\n+┊  ┊ 5┊import { HttpClientModule, HTTP_INTERCEPTORS } from '@angular/common/http';\n ┊ 6┊ 6┊import { GraphQLModule } from './graphql.module';\n ┊ 7┊ 7┊import {ChatsListerModule} from './chats-lister/chats-lister.module';\n ┊ 8┊ 8┊import {RouterModule, Routes} from '@angular/router';\n ┊ 9┊ 9┊import {ChatViewerModule} from './chat-viewer/chat-viewer.module';\n ┊10┊10┊import {ChatsCreationModule} from './chats-creation/chats-creation.module';\n+┊  ┊11┊import {LoginModule} from './login/login.module';\n+┊  ┊12┊import {AuthInterceptor} from './login/services/auth.interceptor';\n ┊11┊13┊const routes: Routes = [];\n ┊12┊14┊\n ┊13┊15┊@NgModule({\n```\n```diff\n@@ -24,8 +26,15 @@\n ┊24┊26┊    ChatsListerModule,\n ┊25┊27┊    ChatViewerModule,\n ┊26┊28┊    ChatsCreationModule,\n+┊  ┊29┊    LoginModule,\n+┊  ┊30┊  ],\n+┊  ┊31┊  providers: [\n+┊  ┊32┊    {\n+┊  ┊33┊      provide: HTTP_INTERCEPTORS,\n+┊  ┊34┊      useClass: AuthInterceptor,\n+┊  ┊35┊      multi: true,\n+┊  ┊36┊    },\n ┊27┊37┊  ],\n-┊28┊  ┊  providers: [],\n ┊29┊38┊  bootstrap: [AppComponent]\n ┊30┊39┊})\n ┊31┊40┊export class AppModule {}\n```\n\n[}]: #\n\nAs well as the `AuthGuard`:\n\n[{]: <helper> (diffStep \"10.1\" files=\"src/app/chat-viewer/chat-viewer.module.ts, src/app/chats-creation/chats-creation.module.ts, src/app/chats-lister/chats-lister.module.ts\" module=\"client\")\n\n#### [Step 10.1: Authentication](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/34faf60)\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;chat-viewer.module.ts\n```diff\n@@ -12,11 +12,12 @@\n ┊12┊12┊import {NewMessageComponent} from './components/new-message/new-message.component';\n ┊13┊13┊import {SharedModule} from '../shared/shared.module';\n ┊14┊14┊import {NgxSelectableListModule} from 'ngx-selectable-list';\n+┊  ┊15┊import {AuthGuard} from '../login/services/auth.guard';\n ┊15┊16┊\n ┊16┊17┊const routes: Routes = [\n ┊17┊18┊  {\n ┊18┊19┊    path: 'chat', children: [\n-┊19┊  ┊      {path: ':id', component: ChatComponent},\n+┊  ┊20┊      {path: ':id', canActivate: [AuthGuard], component: ChatComponent},\n ┊20┊21┊    ],\n ┊21┊22┊  },\n ┊22┊23┊];\n```\n\n##### Changed src&#x2F;app&#x2F;chats-creation&#x2F;chats-creation.module.ts\n```diff\n@@ -16,10 +16,11 @@\n ┊16┊16┊import {NewGroupDetailsComponent} from './components/new-group-details/new-group-details.component';\n ┊17┊17┊import {SharedModule} from '../shared/shared.module';\n ┊18┊18┊import {NgxSelectableListModule} from 'ngx-selectable-list';\n+┊  ┊19┊import {AuthGuard} from '../login/services/auth.guard';\n ┊19┊20┊\n ┊20┊21┊const routes: Routes = [\n-┊21┊  ┊  {path: 'new-chat', component: NewChatComponent},\n-┊22┊  ┊  {path: 'new-group', component: NewGroupComponent},\n+┊  ┊22┊  {path: 'new-chat', canActivate: [AuthGuard], component: NewChatComponent},\n+┊  ┊23┊  {path: 'new-group', canActivate: [AuthGuard], component: NewGroupComponent},\n ┊23┊24┊];\n ┊24┊25┊\n ┊25┊26┊@NgModule({\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;chats-lister.module.ts\n```diff\n@@ -12,10 +12,11 @@\n ┊12┊12┊import {TruncateModule} from 'ng2-truncate';\n ┊13┊13┊import {SharedModule} from '../shared/shared.module';\n ┊14┊14┊import {NgxSelectableListModule} from 'ngx-selectable-list';\n+┊  ┊15┊import {AuthGuard} from '../login/services/auth.guard';\n ┊15┊16┊\n ┊16┊17┊const routes: Routes = [\n ┊17┊18┊  {path: '', redirectTo: 'chats', pathMatch: 'full'},\n-┊18┊  ┊  {path: 'chats', component: ChatsComponent},\n+┊  ┊19┊  {path: 'chats', canActivate: [AuthGuard], component: ChatsComponent},\n ┊19┊20┊];\n ┊20┊21┊\n ┊21┊22┊@NgModule({\n```\n\n[}]: #\n\nLast but not the least we need to fix our main service in order to not use the hardcoded user anymore. Instead we will use our Login service to read the user info from the `LocalStorage`.\n\n[{]: <helper> (diffStep \"10.1\" files=\"src/app/services/chats.service.ts\" module=\"client\")\n\n#### [Step 10.1: Authentication](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/34faf60)\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -24,6 +24,7 @@\n ┊24┊24┊} from '../../graphql';\n ┊25┊25┊import { DataProxy } from 'apollo-cache';\n ┊26┊26┊import { FetchResult } from 'apollo-link';\n+┊  ┊27┊import {LoginService} from '../login/services/login.service';\n ┊27┊28┊\n ┊28┊29┊const currentUserId = '1';\n ┊29┊30┊const currentUserName = 'Ethan Gonzalez';\n```\n```diff\n@@ -46,7 +47,8 @@\n ┊46┊47┊    private removeAllMessagesGQL: RemoveAllMessagesGQL,\n ┊47┊48┊    private getUsersGQL: GetUsersGQL,\n ┊48┊49┊    private addChatGQL: AddChatGQL,\n-┊49┊  ┊    private addGroupGQL: AddGroupGQL\n+┊  ┊50┊    private addGroupGQL: AddGroupGQL,\n+┊  ┊51┊    private loginService: LoginService\n ┊50┊52┊  ) {\n ┊51┊53┊    this.getChatsWq = this.getChatsGQL.watch({\n ┊52┊54┊      amount: this.messagesAmount,\n```\n```diff\n@@ -128,11 +130,11 @@\n ┊128┊130┊        addMessage: {\n ┊129┊131┊          id: ChatsService.getRandomId(),\n ┊130┊132┊          __typename: 'Message',\n-┊131┊   ┊          senderId: currentUserId,\n+┊   ┊133┊          senderId: this.loginService.getUser().id,\n ┊132┊134┊          sender: {\n-┊133┊   ┊            id: currentUserId,\n+┊   ┊135┊            id: this.loginService.getUser().id,\n ┊134┊136┊            __typename: 'User',\n-┊135┊   ┊            name: currentUserName,\n+┊   ┊137┊            name: this.loginService.getUser().name,\n ┊136┊138┊          },\n ┊137┊139┊          content,\n ┊138┊140┊          createdAt: moment().unix(),\n```\n```diff\n@@ -315,7 +317,7 @@\n ┊315┊317┊  // Checks if the chat is listed for the current user and returns the id\n ┊316┊318┊  getChatId(recipientId: string) {\n ┊317┊319┊    const _chat = this.chats.find(chat => {\n-┊318┊   ┊      return !chat.isGroup && !!chat.allTimeMembers.find(user => user.id === currentUserId) &&\n+┊   ┊320┊      return !chat.isGroup && !!chat.allTimeMembers.find(user => user.id === this.loginService.getUser().id) &&\n ┊319┊321┊        !!chat.allTimeMembers.find(user => user.id === recipientId);\n ┊320┊322┊    });\n ┊321┊323┊    return _chat ? _chat.id : false;\n```\n```diff\n@@ -335,7 +337,7 @@\n ┊335┊337┊            picture: users.find(user => user.id === recipientId).picture,\n ┊336┊338┊            allTimeMembers: [\n ┊337┊339┊              {\n-┊338┊   ┊                id: currentUserId,\n+┊   ┊340┊                id: this.loginService.getUser().id,\n ┊339┊341┊                __typename: 'User',\n ┊340┊342┊              },\n ┊341┊343┊              {\n```\n```diff\n@@ -387,10 +389,10 @@\n ┊387┊389┊            __typename: 'Chat',\n ┊388┊390┊            name: groupName,\n ┊389┊391┊            picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n-┊390┊   ┊            userIds: [currentUserId, recipientIds],\n+┊   ┊392┊            userIds: [this.loginService.getUser().id, recipientIds],\n ┊391┊393┊            allTimeMembers: [\n ┊392┊394┊              {\n-┊393┊   ┊                id: currentUserId,\n+┊   ┊395┊                id: this.loginService.getUser().id,\n ┊394┊396┊                __typename: 'User',\n ┊395┊397┊              },\n ┊396┊398┊              ...recipientIds.map(id => ({id, __typename: 'User'})),\n```\n\n[}]: #\n\nWe also need to fix our tests:\n\n[{]: <helper> (diffStep \"10.1\" files=\"src/app/chat-viewer/containers/chat/chat.component.spec.ts, src/app/chats-lister/containers/chats/chats.component.spec.ts, src/app/services/chats.service.spec.ts\" module=\"client\")\n\n#### [Step 10.1: Authentication](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/34faf60)\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.spec.ts\n```diff\n@@ -29,6 +29,7 @@\n ┊29┊29┊import { NewMessageComponent } from '../../components/new-message/new-message.component';\n ┊30┊30┊import { MessagesListComponent } from '../../components/messages-list/messages-list.component';\n ┊31┊31┊import { MessageItemComponent } from '../../components/message-item/message-item.component';\n+┊  ┊32┊import { LoginService } from '../../../login/services/login.service';\n ┊32┊33┊\n ┊33┊34┊describe('ChatComponent', () => {\n ┊34┊35┊  let component: ChatComponent;\n```\n```diff\n@@ -134,6 +135,7 @@\n ┊134┊135┊            queryParams: of({}),\n ┊135┊136┊          },\n ┊136┊137┊        },\n+┊   ┊138┊        LoginService,\n ┊137┊139┊      ],\n ┊138┊140┊      schemas: [NO_ERRORS_SCHEMA],\n ┊139┊141┊    }).compileComponents();\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.spec.ts\n```diff\n@@ -24,6 +24,7 @@\n ┊24┊24┊import { ChatsListComponent } from '../../components/chats-list/chats-list.component';\n ┊25┊25┊import { ChatItemComponent } from '../../components/chat-item/chat-item.component';\n ┊26┊26┊import { ChatsService } from '../../../services/chats.service';\n+┊  ┊27┊import { LoginService } from '../../../login/services/login.service';\n ┊27┊28┊\n ┊28┊29┊describe('ChatsComponent', () => {\n ┊29┊30┊  let component: ChatsComponent;\n```\n```diff\n@@ -345,6 +346,7 @@\n ┊345┊346┊            return new InMemoryCache({ dataIdFromObject });\n ┊346┊347┊          },\n ┊347┊348┊        },\n+┊   ┊349┊        LoginService,\n ┊348┊350┊      ],\n ┊349┊351┊      schemas: [NO_ERRORS_SCHEMA],\n ┊350┊352┊    }).compileComponents();\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.spec.ts\n```diff\n@@ -11,6 +11,7 @@\n ┊11┊11┊import { GetChats } from '../../graphql';\n ┊12┊12┊import { dataIdFromObject } from '../graphql.module';\n ┊13┊13┊import { ChatsService } from './chats.service';\n+┊  ┊14┊import {LoginService} from '../login/services/login.service';\n ┊14┊15┊\n ┊15┊16┊describe('ChatsService', () => {\n ┊16┊17┊  let controller: ApolloTestingController;\n```\n```diff\n@@ -312,6 +313,7 @@\n ┊312┊313┊      imports: [ApolloTestingModule],\n ┊313┊314┊      providers: [\n ┊314┊315┊        ChatsService,\n+┊   ┊316┊        LoginService,\n ┊315┊317┊        {\n ┊316┊318┊          provide: APOLLO_TESTING_CACHE,\n ┊317┊319┊          useFactory() {\n```\n\n[}]: #\n\n\n### GraphQL Server behind a firewall\n\nThere's still one thing remaining. Our GraphQL Code Generator setup is broken now. That's because every made request to the server has to have proper rights and currently the codegen's request introspection query is not authenticated. In short, we need to attach an `Authorization` header.\n\nWe're going to implement the following scenario:\n\n1. User runs `yarn generator`\n1. He is asked for a _username_ and a _password_\n1. Our script generates an _Authorization_ header\n1. GraphQL Code Generator get the GraphQL Schema of our server and outputs the types\n\nTo achieve the goal, we need to change the way we interact with the codegen.\nRight now we use GraphQL Code Generator's CLI but the tool allows to use it programatically. So one issue solved.\n\nWhat about getting user's name and password part? We will use in-terminal prompt so user can type those. There's a package for that:\n\n    yarn add -D prompt\n\nNext, create a `src/codegen.ts` file and write our script there:\n\n[{]: <helper> (diffStep \"10.1\" files=\"src/codegen.ts\" module=\"client\")\n\n#### [Step 10.1: Authentication](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/34faf60)\n\n##### Added src&#x2F;codegen.ts\n```diff\n@@ -0,0 +1,46 @@\n+┊  ┊ 1┊import * as prompt from 'prompt';\n+┊  ┊ 2┊import { generate } from 'graphql-code-generator';\n+┊  ┊ 3┊\n+┊  ┊ 4┊interface Credentials {\n+┊  ┊ 5┊  username: string;\n+┊  ┊ 6┊  password: string;\n+┊  ┊ 7┊}\n+┊  ┊ 8┊\n+┊  ┊ 9┊async function getCredentials(): Promise<Credentials> {\n+┊  ┊10┊  return new Promise<Credentials>(resolve => {\n+┊  ┊11┊    prompt.start();\n+┊  ┊12┊    prompt.get(['username', 'password'], (_err, result) => {\n+┊  ┊13┊      resolve({\n+┊  ┊14┊        username: result.username,\n+┊  ┊15┊        password: result.password,\n+┊  ┊16┊      });\n+┊  ┊17┊    });\n+┊  ┊18┊  });\n+┊  ┊19┊}\n+┊  ┊20┊\n+┊  ┊21┊function generateHeaders({ username, password }: Credentials): string[] {\n+┊  ┊22┊  const Authorization = `Basic ${Buffer.from(\n+┊  ┊23┊    `${username}:${password}`,\n+┊  ┊24┊  ).toString('base64')}`;\n+┊  ┊25┊\n+┊  ┊26┊  return [`Authorization: ${Authorization}`];\n+┊  ┊27┊}\n+┊  ┊28┊\n+┊  ┊29┊async function main() {\n+┊  ┊30┊  const credentials = await getCredentials();\n+┊  ┊31┊  const headers = generateHeaders(credentials);\n+┊  ┊32┊\n+┊  ┊33┊  await generate(\n+┊  ┊34┊    {\n+┊  ┊35┊      schema: 'http://localhost:3000/graphql',\n+┊  ┊36┊      template: 'graphql-codegen-apollo-angular-template',\n+┊  ┊37┊      out: './src/graphql.ts',\n+┊  ┊38┊      args: ['./src/graphql/**/*.ts'],\n+┊  ┊39┊      header: headers,\n+┊  ┊40┊      overwrite: true,\n+┊  ┊41┊    },\n+┊  ┊42┊    true,\n+┊  ┊43┊  );\n+┊  ┊44┊}\n+┊  ┊45┊\n+┊  ┊46┊main();\n```\n\n[}]: #\n\nLet's take a closer look what we did there:\n\n- We asks user for a _username_ and a _password_ with `prompt`\n- Based on that we generate a header\n- We put the header in `generate` function\n- there's a `true` value as the second argument, it tells codegen to write the output to a file\n\nWith all of that, whenever we run `yarn generator`, we access the GraphQL server as an authenticated user."
          },
          {
            "manualTitle": "Step 15: Subscriptions",
            "stepRevision": "4468c9c93fec39b398667d2eed81c40e4ae89eb7",
            "manualView": "## Server\n\nIn order to use WebSockets we don't need to install any package, it comes for free with Apollo Server 2.0.\n\nOur GraphQL server will use WebSockets only for subscriptions, while using HTTP for everything else. That means that we will have to add subscriptions on a specific path.\nWe're using `connectionParams` for the authentication over WebSockets, that means that we won't be using the `Passport` framework at all. Instead we will use the `onConnect` hook to manually validate the parameters provided by the user to either validate the WebSocket connection or throw an error.\nWe will also return the user object we retrieved from the db, to let the resolvers know who is the current user.\n\n[{]: <helper> (diffStep \"5.1\" files=\"index.ts\" module=\"server\")\n\n#### [Step 5.1: Subscriptions](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/729c8f0)\n\n##### Changed index.ts\n```diff\n@@ -7,9 +7,12 @@\n ┊ 7┊ 7┊import * as basicStrategy from 'passport-http';\n ┊ 8┊ 8┊import * as bcrypt from 'bcrypt-nodejs';\n ┊ 9┊ 9┊import { db, User } from \"./db\";\n+┊  ┊10┊import { createServer } from \"http\";\n ┊10┊11┊\n ┊11┊12┊let users = db.users;\n ┊12┊13┊\n+┊  ┊14┊console.log(users);\n+┊  ┊15┊\n ┊13┊16┊function generateHash(password: string) {\n ┊14┊17┊  return bcrypt.hashSync(password, bcrypt.genSaltSync(8));\n ┊15┊18┊}\n```\n```diff\n@@ -69,9 +72,30 @@\n ┊ 69┊ 72┊  schema,\n ┊ 70┊ 73┊  context(received: any) {\n ┊ 71┊ 74┊    return {\n-┊ 72┊   ┊      user: received.req!['user'],\n+┊   ┊ 75┊      user: received.connection ? received.connection.context.user : received.req!['user'],\n ┊ 73┊ 76┊    }\n ┊ 74┊ 77┊  },\n+┊   ┊ 78┊  subscriptions: {\n+┊   ┊ 79┊    onConnect: (connectionParams: any, webSocket: any) => {\n+┊   ┊ 80┊      if (connectionParams.authToken) {\n+┊   ┊ 81┊        // create a buffer and tell it the data coming in is base64\n+┊   ┊ 82┊        const buf = new Buffer(connectionParams.authToken.split(' ')[1], 'base64');\n+┊   ┊ 83┊        // read it back out as a string\n+┊   ┊ 84┊        const [username, password]: string[] = buf.toString().split(':');\n+┊   ┊ 85┊        if (username && password) {\n+┊   ┊ 86┊          const user = users.find(user => user.username == username);\n+┊   ┊ 87┊\n+┊   ┊ 88┊          if (user && validPassword(password, user.password)) {\n+┊   ┊ 89┊            // Set context for the WebSocket\n+┊   ┊ 90┊            return {user};\n+┊   ┊ 91┊          } else {\n+┊   ┊ 92┊            throw new Error('Wrong credentials!');\n+┊   ┊ 93┊          }\n+┊   ┊ 94┊        }\n+┊   ┊ 95┊      }\n+┊   ┊ 96┊      throw new Error('Missing auth token!');\n+┊   ┊ 97┊    }\n+┊   ┊ 98┊  }\n ┊ 75┊ 99┊});\n ┊ 76┊100┊\n ┊ 77┊101┊apollo.applyMiddleware({\n```\n```diff\n@@ -79,4 +103,11 @@\n ┊ 79┊103┊  path: '/graphql'\n ┊ 80┊104┊});\n ┊ 81┊105┊\n-┊ 82┊   ┊app.listen(PORT);\n+┊   ┊106┊// Wrap the Express server\n+┊   ┊107┊const ws = createServer(app);\n+┊   ┊108┊\n+┊   ┊109┊apollo.installSubscriptionHandlers(ws);\n+┊   ┊110┊\n+┊   ┊111┊ws.listen(PORT, () => {\n+┊   ┊112┊  console.log(`Apollo Server is now running on http://localhost:${PORT}`);\n+┊   ┊113┊});\n```\n\n[}]: #\n\nWe will use the `PubSub` implementation from `apollo-server-express`, and publish the data using with Apollo Server.\n\nThe process of setting up a GraphQL subscriptions server consist of the following steps:\n\n1. Declaring subscriptions in the GraphQL schema\n2. Setup a PubSub instance that our server will publish new events to\n3. Hook together `PubSub` event and GraphQL subscription.\n4. Setting up `ApolloServer`\n\n[{]: <helper> (diffStep \"5.1\" files=\"schema/typeDefs.ts\" module=\"server\")\n\n#### [Step 5.1: Subscriptions](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/729c8f0)\n\n##### Changed schema&#x2F;typeDefs.ts\n```diff\n@@ -5,6 +5,11 @@\n ┊ 5┊ 5┊    chat(chatId: ID!): Chat\n ┊ 6┊ 6┊  }\n ┊ 7┊ 7┊\n+┊  ┊ 8┊  type Subscription {\n+┊  ┊ 9┊    messageAdded(chatId: ID): Message\n+┊  ┊10┊    chatAdded: Chat\n+┊  ┊11┊  }\n+┊  ┊12┊\n ┊ 8┊13┊  enum MessageType {\n ┊ 9┊14┊    LOCATION\n ┊10┊15┊    TEXT\n```\n\n[}]: #\n\nWe created two subscriptions: one to notify for new chats and one to notify for new messages.\n\n[{]: <helper> (diffStep \"5.1\" files=\"schema/resolvers.ts\" module=\"server\")\n\n#### [Step 5.1: Subscriptions](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/729c8f0)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,7 +1,7 @@\n-┊1┊ ┊import { IResolvers } from 'apollo-server-express';\n+┊ ┊1┊import { PubSub, withFilter, IResolvers } from 'apollo-server-express';\n ┊2┊2┊import { Chat, db, Message, MessageType, Recipient, User } from \"../db\";\n ┊3┊3┊import {\n-┊4┊ ┊  AddChatMutationArgs, AddGroupMutationArgs, AddMessageMutationArgs, ChatQueryArgs,\n+┊ ┊4┊  AddChatMutationArgs, AddGroupMutationArgs, AddMessageMutationArgs, ChatQueryArgs, MessageAddedSubscriptionArgs,\n ┊5┊5┊  RemoveChatMutationArgs, RemoveMessagesMutationArgs\n ┊6┊6┊} from \"../types\";\n ┊7┊7┊import * as moment from \"moment\";\n```\n```diff\n@@ -9,6 +9,8 @@\n ┊ 9┊ 9┊let users = db.users;\n ┊10┊10┊let chats = db.chats;\n ┊11┊11┊\n+┊  ┊12┊export const pubsub = new PubSub();\n+┊  ┊13┊\n ┊12┊14┊export const resolvers: IResolvers = {\n ┊13┊15┊  Query: {\n ┊14┊16┊    // Show all users for the moment.\n```\n```diff\n@@ -50,6 +52,7 @@\n ┊50┊52┊          messages: [],\n ┊51┊53┊        };\n ┊52┊54┊        chats.push(chat);\n+┊  ┊55┊\n ┊53┊56┊        return chat;\n ┊54┊57┊      }\n ┊55┊58┊    },\n```\n```diff\n@@ -73,6 +76,12 @@\n ┊73┊76┊        messages: [],\n ┊74┊77┊      };\n ┊75┊78┊      chats.push(chat);\n+┊  ┊79┊\n+┊  ┊80┊      pubsub.publish('chatAdded', {\n+┊  ┊81┊        creatorId: currentUser.id,\n+┊  ┊82┊        chatAdded: chat,\n+┊  ┊83┊      });\n+┊  ┊84┊\n ┊76┊85┊      return chat;\n ┊77┊86┊    },\n ┊78┊87┊    removeChat: (obj: any, {chatId}: RemoveChatMutationArgs, {user: currentUser}: {user: User}): number => {\n```\n```diff\n@@ -201,6 +210,11 @@\n ┊201┊210┊          });\n ┊202┊211┊\n ┊203┊212┊          holderIds = listingMemberIds;\n+┊   ┊213┊\n+┊   ┊214┊          pubsub.publish('chatAdded', {\n+┊   ┊215┊            creatorId: currentUser.id,\n+┊   ┊216┊            chatAdded: chat,\n+┊   ┊217┊          });\n ┊204┊218┊        }\n ┊205┊219┊      } else {\n ┊206┊220┊        // Group\n```\n```diff\n@@ -245,6 +259,10 @@\n ┊245┊259┊        return chat;\n ┊246┊260┊      });\n ┊247┊261┊\n+┊   ┊262┊      pubsub.publish('messageAdded', {\n+┊   ┊263┊        messageAdded: message,\n+┊   ┊264┊      });\n+┊   ┊265┊\n ┊248┊266┊      return message;\n ┊249┊267┊    },\n ┊250┊268┊    removeMessages: (obj: any, {chatId, messageIds, all}: RemoveMessagesMutationArgs, {user: currentUser}: {user: User}): number[] => {\n```\n```diff\n@@ -286,6 +304,21 @@\n ┊286┊304┊      return deletedIds;\n ┊287┊305┊    },\n ┊288┊306┊  },\n+┊   ┊307┊  Subscription: {\n+┊   ┊308┊    messageAdded: {\n+┊   ┊309┊      subscribe: withFilter(() => pubsub.asyncIterator('messageAdded'),\n+┊   ┊310┊        ({messageAdded}: {messageAdded: Message & {chat: {id: number}}}, {chatId}: MessageAddedSubscriptionArgs, {user: currentUser}: { user: User }) => {\n+┊   ┊311┊          return (!chatId || messageAdded.chat.id === Number(chatId)) &&\n+┊   ┊312┊            !!messageAdded.recipients.find((recipient: Recipient) => recipient.userId === currentUser.id);\n+┊   ┊313┊        }),\n+┊   ┊314┊    },\n+┊   ┊315┊    chatAdded: {\n+┊   ┊316┊      subscribe: withFilter(() => pubsub.asyncIterator('chatAdded'),\n+┊   ┊317┊        ({creatorId, chatAdded}: {creatorId: string, chatAdded: Chat}, variables: any, {user: currentUser}: { user: User }) => {\n+┊   ┊318┊          return Number(creatorId) !== currentUser.id && !chatAdded.listingMemberIds.includes(currentUser.id);\n+┊   ┊319┊        }),\n+┊   ┊320┊    }\n+┊   ┊321┊  },\n ┊289┊322┊  Chat: {\n ┊290┊323┊    name: (chat: Chat, args: any, {user: currentUser}: {user: User}): string => chat.name ? chat.name : users\n ┊291┊324┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser.id))!.name,\n```\n\n[}]: #\n\nWe will publish a message to the `messageAdded` subscription every time that a user sends a message, then we will filter them according to the current user (we don't want to send someone else's messages).\nThe `chatAdded` subscription is similar: we will publish each time that a group gets created, but not when chats get created. This is because when a user creates a chat the chat doesn't appear to the other peer until he writes the first message. That's why we also publish when new messages get added (we first look if the other peer already gets the chat listed).\n\n## Client\n\nIn order to use WebSockets we will need to install a couple of dependencies:\n\n    yarn add apollo-link-ws apollo-utilities subscriptions-transport-ws\n\nFirst let's create the queries for the GraphQL Subscriptions:\n\n[{]: <helper> (diffStep \"11.1\" files=\"src/graphql\" module=\"client\")\n\n#### [Step 11.1: Subscriptions](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/8219b49)\n\n##### Changed src&#x2F;graphql.ts\n```diff\n@@ -651,6 +651,22 @@\n ┊651┊651┊  export type AddMessage = Message.Fragment;\n ┊652┊652┊}\n ┊653┊653┊\n+┊   ┊654┊export namespace ChatAdded {\n+┊   ┊655┊  export type Variables = {};\n+┊   ┊656┊\n+┊   ┊657┊  export type Subscription = {\n+┊   ┊658┊    __typename?: \"Subscription\";\n+┊   ┊659┊    chatAdded?: ChatAdded | null;\n+┊   ┊660┊  };\n+┊   ┊661┊\n+┊   ┊662┊  export type ChatAdded = {\n+┊   ┊663┊    __typename?: \"Chat\";\n+┊   ┊664┊    messages: (Messages | null)[];\n+┊   ┊665┊  } & ChatWithoutMessages.Fragment;\n+┊   ┊666┊\n+┊   ┊667┊  export type Messages = Message.Fragment;\n+┊   ┊668┊}\n+┊   ┊669┊\n ┊654┊670┊export namespace GetChat {\n ┊655┊671┊  export type Variables = {\n ┊656┊672┊    chatId: string;\n```\n```diff\n@@ -703,6 +719,27 @@\n ┊703┊719┊  };\n ┊704┊720┊}\n ┊705┊721┊\n+┊   ┊722┊export namespace MessageAdded {\n+┊   ┊723┊  export type Variables = {\n+┊   ┊724┊    chatId?: string | null;\n+┊   ┊725┊  };\n+┊   ┊726┊\n+┊   ┊727┊  export type Subscription = {\n+┊   ┊728┊    __typename?: \"Subscription\";\n+┊   ┊729┊    messageAdded?: MessageAdded | null;\n+┊   ┊730┊  };\n+┊   ┊731┊\n+┊   ┊732┊  export type MessageAdded = {\n+┊   ┊733┊    __typename?: \"Message\";\n+┊   ┊734┊    chat: Chat;\n+┊   ┊735┊  } & Message.Fragment;\n+┊   ┊736┊\n+┊   ┊737┊  export type Chat = {\n+┊   ┊738┊    __typename?: \"Chat\";\n+┊   ┊739┊    id: string;\n+┊   ┊740┊  };\n+┊   ┊741┊}\n+┊   ┊742┊\n ┊706┊743┊export namespace RemoveAllMessages {\n ┊707┊744┊  export type Variables = {\n ┊708┊745┊    chatId: string;\n```\n```diff\n@@ -924,6 +961,27 @@\n ┊924┊961┊@Injectable({\n ┊925┊962┊  providedIn: \"root\"\n ┊926┊963┊})\n+┊   ┊964┊export class ChatAddedGQL extends Apollo.Subscription<\n+┊   ┊965┊  ChatAdded.Subscription,\n+┊   ┊966┊  ChatAdded.Variables\n+┊   ┊967┊> {\n+┊   ┊968┊  document: any = gql`\n+┊   ┊969┊    subscription chatAdded {\n+┊   ┊970┊      chatAdded {\n+┊   ┊971┊        ...ChatWithoutMessages\n+┊   ┊972┊        messages {\n+┊   ┊973┊          ...Message\n+┊   ┊974┊        }\n+┊   ┊975┊      }\n+┊   ┊976┊    }\n+┊   ┊977┊\n+┊   ┊978┊    ${ChatWithoutMessagesFragment}\n+┊   ┊979┊    ${MessageFragment}\n+┊   ┊980┊  `;\n+┊   ┊981┊}\n+┊   ┊982┊@Injectable({\n+┊   ┊983┊  providedIn: \"root\"\n+┊   ┊984┊})\n ┊927┊985┊export class GetChatGQL extends Apollo.Query<GetChat.Query, GetChat.Variables> {\n ┊928┊986┊  document: any = gql`\n ┊929┊987┊    query GetChat($chatId: ID!) {\n```\n```diff\n@@ -980,6 +1038,26 @@\n ┊ 980┊1038┊@Injectable({\n ┊ 981┊1039┊  providedIn: \"root\"\n ┊ 982┊1040┊})\n+┊    ┊1041┊export class MessageAddedGQL extends Apollo.Subscription<\n+┊    ┊1042┊  MessageAdded.Subscription,\n+┊    ┊1043┊  MessageAdded.Variables\n+┊    ┊1044┊> {\n+┊    ┊1045┊  document: any = gql`\n+┊    ┊1046┊    subscription messageAdded($chatId: ID) {\n+┊    ┊1047┊      messageAdded(chatId: $chatId) {\n+┊    ┊1048┊        ...Message\n+┊    ┊1049┊        chat {\n+┊    ┊1050┊          id\n+┊    ┊1051┊        }\n+┊    ┊1052┊      }\n+┊    ┊1053┊    }\n+┊    ┊1054┊\n+┊    ┊1055┊    ${MessageFragment}\n+┊    ┊1056┊  `;\n+┊    ┊1057┊}\n+┊    ┊1058┊@Injectable({\n+┊    ┊1059┊  providedIn: \"root\"\n+┊    ┊1060┊})\n ┊ 983┊1061┊export class RemoveAllMessagesGQL extends Apollo.Mutation<\n ┊ 984┊1062┊  RemoveAllMessages.Mutation,\n ┊ 985┊1063┊  RemoveAllMessages.Variables\n```\n\n##### Added src&#x2F;graphql&#x2F;chatAdded.subscription.ts\n```diff\n@@ -0,0 +1,17 @@\n+┊  ┊ 1┊import gql from 'graphql-tag';\n+┊  ┊ 2┊import {fragments} from './fragment';\n+┊  ┊ 3┊\n+┊  ┊ 4┊// We use the gql tag to parse our query string into a query document\n+┊  ┊ 5┊export const chatAddedSubscription = gql`\n+┊  ┊ 6┊  subscription chatAdded {\n+┊  ┊ 7┊    chatAdded {\n+┊  ┊ 8┊      ...ChatWithoutMessages\n+┊  ┊ 9┊      messages {\n+┊  ┊10┊        ...Message\n+┊  ┊11┊      }\n+┊  ┊12┊    }\n+┊  ┊13┊  }\n+┊  ┊14┊\n+┊  ┊15┊  ${fragments['chatWithoutMessages']}\n+┊  ┊16┊  ${fragments['message']}\n+┊  ┊17┊`;\n```\n\n##### Added src&#x2F;graphql&#x2F;messageAdded.subscription.ts\n```diff\n@@ -0,0 +1,16 @@\n+┊  ┊ 1┊import gql from 'graphql-tag';\n+┊  ┊ 2┊import {fragments} from './fragment';\n+┊  ┊ 3┊\n+┊  ┊ 4┊// We use the gql tag to parse our query string into a query document\n+┊  ┊ 5┊export const messageAddedSubscription = gql`\n+┊  ┊ 6┊  subscription messageAdded($chatId: ID) {\n+┊  ┊ 7┊    messageAdded(chatId: $chatId) {\n+┊  ┊ 8┊      ...Message\n+┊  ┊ 9┊      chat {\n+┊  ┊10┊        id,\n+┊  ┊11┊      },\n+┊  ┊12┊    }\n+┊  ┊13┊  }\n+┊  ┊14┊\n+┊  ┊15┊  ${fragments['message']}\n+┊  ┊16┊`;\n```\n\n[}]: #\n\nThen we need to run `graphql-code-generator` to generate the types:\n\n    yarn generator\n\nNow we can update the chats service to update the getChats query every time that we receive a new chat from the subscription.\nWith GraphQL subscriptions your client will be alerted on push from the server and you should choose the pattern that fits your application the most:\n\n- Use it as a notification and run any logic you want when it fires, for example alerting the user or refetching data\n- Use the data sent along with the notification and merge it directly into the store (existing queries are automatically notified)\n\nWith subscribeToMore, you can easily do the latter. We will manipulate the store to add the newly created chat.\n\nWe will do to do the same for the newMessage subscription, but this time we will have to update two different queries in the store: getChats and getChat.\n\n[{]: <helper> (diffStep \"11.1\" files=\"src/app/services/chats.service.ts\" module=\"client\")\n\n#### [Step 11.1: Subscriptions](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/8219b49)\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,7 +1,7 @@\n ┊1┊1┊import {concat, map, share, switchMap} from 'rxjs/operators';\n ┊2┊2┊import {Injectable} from '@angular/core';\n ┊3┊3┊import {Observable, AsyncSubject, of} from 'rxjs';\n-┊4┊ ┊import {QueryRef} from 'apollo-angular';\n+┊ ┊4┊import {Apollo, QueryRef} from 'apollo-angular';\n ┊5┊5┊import * as moment from 'moment';\n ┊6┊6┊import {\n ┊7┊7┊  GetChatsGQL,\n```\n```diff\n@@ -13,6 +13,8 @@\n ┊13┊13┊  GetUsersGQL,\n ┊14┊14┊  AddChatGQL,\n ┊15┊15┊  AddGroupGQL,\n+┊  ┊16┊  ChatAddedGQL,\n+┊  ┊17┊  MessageAddedGQL,\n ┊16┊18┊  AddMessage,\n ┊17┊19┊  GetChats,\n ┊18┊20┊  GetChat,\n```\n```diff\n@@ -21,6 +23,7 @@\n ┊21┊23┊  GetUsers,\n ┊22┊24┊  AddChat,\n ┊23┊25┊  AddGroup,\n+┊  ┊26┊  MessageAdded,\n ┊24┊27┊} from '../../graphql';\n ┊25┊28┊import { DataProxy } from 'apollo-cache';\n ┊26┊29┊import { FetchResult } from 'apollo-link';\n```\n```diff\n@@ -48,11 +51,69 @@\n ┊ 48┊ 51┊    private getUsersGQL: GetUsersGQL,\n ┊ 49┊ 52┊    private addChatGQL: AddChatGQL,\n ┊ 50┊ 53┊    private addGroupGQL: AddGroupGQL,\n+┊   ┊ 54┊    private chatAddedGQL: ChatAddedGQL,\n+┊   ┊ 55┊    private messageAddedGQL: MessageAddedGQL,\n+┊   ┊ 56┊    private apollo: Apollo,\n ┊ 51┊ 57┊    private loginService: LoginService\n ┊ 52┊ 58┊  ) {\n ┊ 53┊ 59┊    this.getChatsWq = this.getChatsGQL.watch({\n ┊ 54┊ 60┊      amount: this.messagesAmount,\n ┊ 55┊ 61┊    });\n+┊   ┊ 62┊\n+┊   ┊ 63┊    this.getChatsWq.subscribeToMore({\n+┊   ┊ 64┊      document: this.chatAddedGQL.document,\n+┊   ┊ 65┊      updateQuery: (prev: GetChats.Query, { subscriptionData }) => {\n+┊   ┊ 66┊        if (!subscriptionData.data) {\n+┊   ┊ 67┊          return prev;\n+┊   ┊ 68┊        }\n+┊   ┊ 69┊\n+┊   ┊ 70┊        const newChat: GetChats.Chats = subscriptionData.data.chatAdded;\n+┊   ┊ 71┊\n+┊   ┊ 72┊        return Object.assign({}, prev, {\n+┊   ┊ 73┊          chats: [...prev.chats, newChat]\n+┊   ┊ 74┊        });\n+┊   ┊ 75┊      }\n+┊   ┊ 76┊    });\n+┊   ┊ 77┊\n+┊   ┊ 78┊    this.getChatsWq.subscribeToMore({\n+┊   ┊ 79┊      document: this.messageAddedGQL.document,\n+┊   ┊ 80┊      updateQuery: (prev: GetChats.Query, { subscriptionData }) => {\n+┊   ┊ 81┊        if (!subscriptionData.data) {\n+┊   ┊ 82┊          return prev;\n+┊   ┊ 83┊        }\n+┊   ┊ 84┊\n+┊   ┊ 85┊        const newMessage: MessageAdded.MessageAdded = subscriptionData.data.messageAdded;\n+┊   ┊ 86┊\n+┊   ┊ 87┊        // We need to update the cache for both Chat and Chats. The following updates the cache for Chat.\n+┊   ┊ 88┊        try {\n+┊   ┊ 89┊          // Read the data from our cache for this query.\n+┊   ┊ 90┊          const {chat}: GetChat.Query = this.apollo.getClient().readQuery({\n+┊   ┊ 91┊            query: this.getChatGQL.document,\n+┊   ┊ 92┊            variables: {\n+┊   ┊ 93┊              chatId: newMessage.chat.id,\n+┊   ┊ 94┊            }\n+┊   ┊ 95┊          });\n+┊   ┊ 96┊\n+┊   ┊ 97┊          // Add our message from the mutation to the end.\n+┊   ┊ 98┊          chat.messages.push(newMessage);\n+┊   ┊ 99┊          // Write our data back to the cache.\n+┊   ┊100┊          this.apollo.getClient().writeQuery({\n+┊   ┊101┊            query: this.getChatGQL.document,\n+┊   ┊102┊            data: {\n+┊   ┊103┊              chat\n+┊   ┊104┊            }\n+┊   ┊105┊          });\n+┊   ┊106┊        } catch {\n+┊   ┊107┊          console.error('The chat we received an update for does not exist in the store');\n+┊   ┊108┊        }\n+┊   ┊109┊\n+┊   ┊110┊        return Object.assign({}, prev, {\n+┊   ┊111┊          chats: [...prev.chats.map(_chat =>\n+┊   ┊112┊            _chat.id === newMessage.chat.id ? {..._chat, messages: [..._chat.messages, newMessage]} : _chat)]\n+┊   ┊113┊        });\n+┊   ┊114┊      }\n+┊   ┊115┊    });\n+┊   ┊116┊\n ┊ 56┊117┊    this.chats$ = this.getChatsWq.valueChanges.pipe(\n ┊ 57┊118┊      map((result) => result.data.chats)\n ┊ 58┊119┊    );\n```\n```diff\n@@ -130,6 +191,10 @@\n ┊130┊191┊        addMessage: {\n ┊131┊192┊          id: ChatsService.getRandomId(),\n ┊132┊193┊          __typename: 'Message',\n+┊   ┊194┊          chat: {\n+┊   ┊195┊            id: chatId,\n+┊   ┊196┊            __typename: 'Chat',\n+┊   ┊197┊          },\n ┊133┊198┊          senderId: this.loginService.getUser().id,\n ┊134┊199┊          sender: {\n ┊135┊200┊            id: this.loginService.getUser().id,\n```\n\n[}]: #\n\nWe can finally configure the WebSocket in the GraphQL Module. Please notice that the WebSocket has its own authentication instead of using the `HttpInterceptor`, in fact we use `connectionParams` to send the authorization.\nAll queries will go through HTTP except the Subscriptions, which will use the WebSocket.\n\n[{]: <helper> (diffStep \"11.1\" files=\"src/app/graphql.module.ts\" module=\"client\")\n\n#### [Step 11.1: Subscriptions](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/8219b49)\n\n##### Changed src&#x2F;app&#x2F;graphql.module.ts\n```diff\n@@ -2,6 +2,11 @@\n ┊ 2┊ 2┊import { ApolloModule, APOLLO_OPTIONS } from 'apollo-angular';\n ┊ 3┊ 3┊import { HttpLinkModule, HttpLink } from 'apollo-angular-link-http';\n ┊ 4┊ 4┊import { InMemoryCache, defaultDataIdFromObject } from 'apollo-cache-inmemory';\n+┊  ┊ 5┊import {getMainDefinition} from 'apollo-utilities';\n+┊  ┊ 6┊import {OperationDefinitionNode} from 'graphql';\n+┊  ┊ 7┊import {split} from 'apollo-link';\n+┊  ┊ 8┊import {WebSocketLink} from 'apollo-link-ws';\n+┊  ┊ 9┊import {LoginService} from './login/services/login.service';\n ┊ 5┊10┊\n ┊ 6┊11┊const uri = 'http://localhost:3000/graphql';\n ┊ 7┊12┊\n```\n```diff\n@@ -14,9 +19,28 @@\n ┊14┊19┊  }\n ┊15┊20┊};\n ┊16┊21┊\n-┊17┊  ┊export function createApollo(httpLink: HttpLink) {\n+┊  ┊22┊export function createApollo(httpLink: HttpLink, loginService: LoginService) {\n+┊  ┊23┊  const subscriptionLink = new WebSocketLink({\n+┊  ┊24┊    uri: uri.replace('http', 'ws'),\n+┊  ┊25┊    options: {\n+┊  ┊26┊      reconnect: true,\n+┊  ┊27┊      connectionParams: () => ({\n+┊  ┊28┊        authToken: loginService.getAuthHeader() || null\n+┊  ┊29┊      })\n+┊  ┊30┊    }\n+┊  ┊31┊  });\n+┊  ┊32┊\n+┊  ┊33┊  const link = split(\n+┊  ┊34┊    ({ query }) => {\n+┊  ┊35┊      const { kind, operation } = getMainDefinition(query) as OperationDefinitionNode;\n+┊  ┊36┊      return kind === 'OperationDefinition' && operation === 'subscription';\n+┊  ┊37┊    },\n+┊  ┊38┊    subscriptionLink,\n+┊  ┊39┊    httpLink.create({uri})\n+┊  ┊40┊  );\n+┊  ┊41┊\n ┊18┊42┊  return {\n-┊19┊  ┊    link: httpLink.create({ uri }),\n+┊  ┊43┊    link,\n ┊20┊44┊    cache: new InMemoryCache({\n ┊21┊45┊      dataIdFromObject,\n ┊22┊46┊    }),\n```\n```diff\n@@ -29,7 +53,7 @@\n ┊29┊53┊    {\n ┊30┊54┊      provide: APOLLO_OPTIONS,\n ┊31┊55┊      useFactory: createApollo,\n-┊32┊  ┊      deps: [HttpLink],\n+┊  ┊56┊      deps: [HttpLink, LoginService],\n ┊33┊57┊    },\n ┊34┊58┊  ],\n ┊35┊59┊})\n```\n\n[}]: #\n\nWe used `split` of ApolloLink to decide which path should a request get, through WebSocket or HTTP. We decided to push subscriptions over the WebSocket and the rest normally, just like before.\n\nFinally, let's fix the tests:\n\n[{]: <helper> (diffStep \"11.1\" files=\"src/app/chat-viewer/containers/chat/chat.component.spec.ts, src/app/chats-lister/containers/chats/chats.component.spec.ts, src/app/services/chats.service.spec.ts\" module=\"client\")\n\n#### [Step 11.1: Subscriptions](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/8219b49)\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.spec.ts\n```diff\n@@ -148,6 +148,8 @@\n ┊148┊148┊    component = fixture.componentInstance;\n ┊149┊149┊    fixture.detectChanges();\n ┊150┊150┊\n+┊   ┊151┊    controller.expectOne('chatAdded', 'call to chatAdded api');\n+┊   ┊152┊    controller.expectOne('messageAdded', 'call to messageAdded api');\n ┊151┊153┊    controller.expectOne('GetChats', 'call to getChats api');\n ┊152┊154┊\n ┊153┊155┊    const req = controller.expectOne('GetChat', 'call to getChat api');\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.spec.ts\n```diff\n@@ -360,8 +360,10 @@\n ┊360┊360┊    component = fixture.componentInstance;\n ┊361┊361┊    fixture.detectChanges();\n ┊362┊362┊\n-┊363┊   ┊    const req = controller.expectOne('GetChats', 'GetChats operation');\n+┊   ┊363┊    controller.expectOne('chatAdded', 'call to chatAdded api');\n+┊   ┊364┊    controller.expectOne('messageAdded', 'call to messageAdded api');\n ┊364┊365┊\n+┊   ┊366┊    const req = controller.expectOne('GetChats', 'GetChats operation');\n ┊365┊367┊    req.flush({\n ┊366┊368┊      data: {\n ┊367┊369┊        chats,\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.spec.ts\n```diff\n@@ -11,7 +11,7 @@\n ┊11┊11┊import { GetChats } from '../../graphql';\n ┊12┊12┊import { dataIdFromObject } from '../graphql.module';\n ┊13┊13┊import { ChatsService } from './chats.service';\n-┊14┊  ┊import {LoginService} from '../login/services/login.service';\n+┊  ┊14┊import { LoginService } from '../login/services/login.service';\n ┊15┊15┊\n ┊16┊16┊describe('ChatsService', () => {\n ┊17┊17┊  let controller: ApolloTestingController;\n```\n```diff\n@@ -341,6 +341,9 @@\n ┊341┊341┊      }\n ┊342┊342┊    });\n ┊343┊343┊\n+┊   ┊344┊    controller.expectOne('chatAdded', 'call to chatAdded api');\n+┊   ┊345┊    controller.expectOne('messageAdded', 'call to messageAdded api');\n+┊   ┊346┊\n ┊344┊347┊    const req = controller.expectOne('GetChats', 'GetChats operation');\n ┊345┊348┊\n ┊346┊349┊    req.flush({\n```\n\n[}]: #"
          },
          {
            "manualTitle": "Step 16: TypeORM with PostgreSQL",
            "stepRevision": "8686ed12d75fe225a178dd89175a3e594df424c9",
            "manualView": "## Server\n\nFirst of all you will have to install PostgreSQL on your operating system. Since there so many options (different Linux distributions, MacOS X, Windows...) I will assume that you already know how to install a software in your OS and take that part for granted.\n\nThen you will have to install a couple of packages:\n\n    yarn add pg reflect-metadata typeorm\n    yarn add -D @types/pg\n\nWe aren't going to use plain SQL, instead we will use an Object-relational mapping framework (ORM) called `TypeORM`.\n`TypeORM` takes advantage of Typescript classes and type declarations in order to infer the db structure.\n\nWe will need to enable support for experimental decorators, emit type metadata for decorators and disable strict property initialization:\n\n[{]: <helper> (diffStep \"6.1\" files=\"tsconfig.json\" module=\"server\")\n\n#### [Step 6.1: TypeORM with PostgreSQL](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/00c4cab)\n\n##### Changed tsconfig.json\n```diff\n@@ -22,11 +22,11 @@\n ┊22┊22┊    // \"isolatedModules\": true,               /* Transpile each file as a separate module (similar to 'ts.transpileModule'). */\n ┊23┊23┊\n ┊24┊24┊    /* Strict Type-Checking Options */\n-┊25┊  ┊    \"strict\": true,                            /* Enable all strict type-checking options. */\n+┊  ┊25┊    \"strict\": true,                           /* Enable all strict type-checking options. */\n ┊26┊26┊    // \"noImplicitAny\": true,                 /* Raise error on expressions and declarations with an implied 'any' type. */\n ┊27┊27┊    // \"strictNullChecks\": true,              /* Enable strict null checks. */\n ┊28┊28┊    // See https://github.com/DefinitelyTyped/DefinitelyTyped/issues/21359\n-┊29┊  ┊    \"strictFunctionTypes\": false              /* Enable strict checking of function types. */\n+┊  ┊29┊    \"strictFunctionTypes\": false,             /* Enable strict checking of function types. */\n ┊30┊30┊    // \"noImplicitThis\": true,                /* Raise error on 'this' expressions with an implied 'any' type. */\n ┊31┊31┊    // \"alwaysStrict\": true,                  /* Parse in strict mode and emit \"use strict\" for each source file. */\n ┊32┊32┊\n```\n```diff\n@@ -53,7 +53,8 @@\n ┊53┊53┊    // \"inlineSources\": true,                 /* Emit the source alongside the sourcemaps within a single file; requires '--inlineSourceMap' or '--sourceMap' to be set. */\n ┊54┊54┊\n ┊55┊55┊    /* Experimental Options */\n-┊56┊  ┊    // \"experimentalDecorators\": true,        /* Enables experimental support for ES7 decorators. */\n-┊57┊  ┊    // \"emitDecoratorMetadata\": true,         /* Enables experimental support for emitting type metadata for decorators. */\n+┊  ┊56┊    \"experimentalDecorators\": true,           /* Enables experimental support for ES7 decorators. */\n+┊  ┊57┊    \"emitDecoratorMetadata\": true,            /* Enables experimental support for emitting type metadata for decorators. */\n+┊  ┊58┊    \"strictPropertyInitialization\": false\n ┊58┊59┊  }\n ┊59┊60┊}🚫↵\n```\n\n[}]: #\n\nThe next step is to create Entities. An Entity is a class that maps to a database table. You can create a entity by defining a new class and mark it with @Entity():\n\n[{]: <helper> (diffStep \"6.1\" files=\"entity\" module=\"server\")\n\n#### [Step 6.1: TypeORM with PostgreSQL](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/00c4cab)\n\n##### Added entity&#x2F;Chat.ts\n```diff\n@@ -0,0 +1,79 @@\n+┊  ┊ 1┊import { Entity, Column, PrimaryGeneratedColumn, OneToMany, JoinTable, ManyToMany, ManyToOne } from \"typeorm\";\n+┊  ┊ 2┊import { Message } from \"./Message\";\n+┊  ┊ 3┊import { User } from \"./User\";\n+┊  ┊ 4┊import { Recipient } from \"./Recipient\";\n+┊  ┊ 5┊\n+┊  ┊ 6┊interface ChatConstructor {\n+┊  ┊ 7┊  name?: string;\n+┊  ┊ 8┊  picture?: string;\n+┊  ┊ 9┊  allTimeMembers?: User[];\n+┊  ┊10┊  listingMembers?: User[];\n+┊  ┊11┊  actualGroupMembers?: User[];\n+┊  ┊12┊  admins?: User[];\n+┊  ┊13┊  owner?: User;\n+┊  ┊14┊  messages?: Message[];\n+┊  ┊15┊}\n+┊  ┊16┊\n+┊  ┊17┊@Entity()\n+┊  ┊18┊export class Chat {\n+┊  ┊19┊  @PrimaryGeneratedColumn()\n+┊  ┊20┊  id: number;\n+┊  ┊21┊\n+┊  ┊22┊  @Column({nullable: true})\n+┊  ┊23┊  name: string;\n+┊  ┊24┊\n+┊  ┊25┊  @Column({nullable: true})\n+┊  ┊26┊  picture: string;\n+┊  ┊27┊\n+┊  ┊28┊  @ManyToMany(type => User, user => user.allTimeMemberChats, {cascade: [\"insert\", \"update\"], eager: false})\n+┊  ┊29┊  @JoinTable()\n+┊  ┊30┊  allTimeMembers: User[];\n+┊  ┊31┊\n+┊  ┊32┊  @ManyToMany(type => User, user => user.listingMemberChats, {cascade: [\"insert\", \"update\"], eager: false})\n+┊  ┊33┊  @JoinTable()\n+┊  ┊34┊  listingMembers: User[];\n+┊  ┊35┊\n+┊  ┊36┊  @ManyToMany(type => User, user => user.actualGroupMemberChats, {cascade: [\"insert\", \"update\"], eager: false})\n+┊  ┊37┊  @JoinTable()\n+┊  ┊38┊  actualGroupMembers?: User[];\n+┊  ┊39┊\n+┊  ┊40┊  @ManyToMany(type => User, user => user.adminChats, {cascade: [\"insert\", \"update\"], eager: false})\n+┊  ┊41┊  @JoinTable()\n+┊  ┊42┊  admins?: User[];\n+┊  ┊43┊\n+┊  ┊44┊  @ManyToOne(type => User, user => user.ownerChats, {cascade: [\"insert\", \"update\"], eager: false})\n+┊  ┊45┊  owner?: User | null;\n+┊  ┊46┊\n+┊  ┊47┊  @OneToMany(type => Message, message => message.chat, {cascade: [\"insert\", \"update\"], eager: true})\n+┊  ┊48┊  messages: Message[];\n+┊  ┊49┊\n+┊  ┊50┊  @OneToMany(type => Recipient, recipient => recipient.chat)\n+┊  ┊51┊  recipients: Recipient[];\n+┊  ┊52┊\n+┊  ┊53┊  constructor({name, picture, allTimeMembers, listingMembers, actualGroupMembers, admins, owner, messages}: ChatConstructor = {}) {\n+┊  ┊54┊    if (name) {\n+┊  ┊55┊      this.name = name;\n+┊  ┊56┊    }\n+┊  ┊57┊    if (picture) {\n+┊  ┊58┊      this.picture = picture;\n+┊  ┊59┊    }\n+┊  ┊60┊    if (allTimeMembers) {\n+┊  ┊61┊      this.allTimeMembers = allTimeMembers;\n+┊  ┊62┊    }\n+┊  ┊63┊    if (listingMembers) {\n+┊  ┊64┊      this.listingMembers = listingMembers;\n+┊  ┊65┊    }\n+┊  ┊66┊    if (actualGroupMembers) {\n+┊  ┊67┊      this.actualGroupMembers = actualGroupMembers;\n+┊  ┊68┊    }\n+┊  ┊69┊    if (admins) {\n+┊  ┊70┊      this.admins = admins;\n+┊  ┊71┊    }\n+┊  ┊72┊    if (owner) {\n+┊  ┊73┊      this.owner = owner;\n+┊  ┊74┊    }\n+┊  ┊75┊    if (messages) {\n+┊  ┊76┊      this.messages = messages;\n+┊  ┊77┊    }\n+┊  ┊78┊  }\n+┊  ┊79┊}\n```\n\n##### Added entity&#x2F;Message.ts\n```diff\n@@ -0,0 +1,70 @@\n+┊  ┊ 1┊import {\n+┊  ┊ 2┊  Entity, Column, PrimaryGeneratedColumn, OneToMany, ManyToOne, ManyToMany, JoinTable, CreateDateColumn\n+┊  ┊ 3┊} from \"typeorm\";\n+┊  ┊ 4┊import { Chat } from \"./Chat\";\n+┊  ┊ 5┊import { User } from \"./User\";\n+┊  ┊ 6┊import { Recipient } from \"./Recipient\";\n+┊  ┊ 7┊import { MessageType } from \"../db\";\n+┊  ┊ 8┊\n+┊  ┊ 9┊interface MessageConstructor {\n+┊  ┊10┊  sender?: User;\n+┊  ┊11┊  content?: string;\n+┊  ┊12┊  createdAt?: Date,\n+┊  ┊13┊  type?: MessageType;\n+┊  ┊14┊  recipients?: Recipient[];\n+┊  ┊15┊  holders?: User[];\n+┊  ┊16┊  chat?: Chat;\n+┊  ┊17┊}\n+┊  ┊18┊\n+┊  ┊19┊@Entity()\n+┊  ┊20┊export class Message {\n+┊  ┊21┊  @PrimaryGeneratedColumn()\n+┊  ┊22┊  id: number;\n+┊  ┊23┊\n+┊  ┊24┊  @ManyToOne(type => User, user => user.senderMessages, {eager: true})\n+┊  ┊25┊  sender: User;\n+┊  ┊26┊\n+┊  ┊27┊  @Column()\n+┊  ┊28┊  content: string;\n+┊  ┊29┊\n+┊  ┊30┊  @CreateDateColumn({nullable: true})\n+┊  ┊31┊  createdAt: Date;\n+┊  ┊32┊\n+┊  ┊33┊  @Column()\n+┊  ┊34┊  type: number;\n+┊  ┊35┊\n+┊  ┊36┊  @OneToMany(type => Recipient, recipient => recipient.message, {cascade: [\"insert\", \"update\"], eager: true})\n+┊  ┊37┊  recipients: Recipient[];\n+┊  ┊38┊\n+┊  ┊39┊  @ManyToMany(type => User, user => user.holderMessages, {cascade: [\"insert\", \"update\"], eager: true})\n+┊  ┊40┊  @JoinTable()\n+┊  ┊41┊  holders: User[];\n+┊  ┊42┊\n+┊  ┊43┊  @ManyToOne(type => Chat, chat => chat.messages)\n+┊  ┊44┊  chat: Chat;\n+┊  ┊45┊\n+┊  ┊46┊  constructor({sender, content, createdAt, type, recipients, holders, chat}: MessageConstructor = {}) {\n+┊  ┊47┊    if (sender) {\n+┊  ┊48┊      this.sender = sender;\n+┊  ┊49┊    }\n+┊  ┊50┊    if (content) {\n+┊  ┊51┊      this.content = content;\n+┊  ┊52┊    }\n+┊  ┊53┊    if (createdAt) {\n+┊  ┊54┊      this.createdAt = createdAt;\n+┊  ┊55┊    }\n+┊  ┊56┊    if (type) {\n+┊  ┊57┊      this.type = type;\n+┊  ┊58┊    }\n+┊  ┊59┊    if (recipients) {\n+┊  ┊60┊      recipients.forEach(recipient => recipient.message = this);\n+┊  ┊61┊      this.recipients = recipients;\n+┊  ┊62┊    }\n+┊  ┊63┊    if (holders) {\n+┊  ┊64┊      this.holders = holders;\n+┊  ┊65┊    }\n+┊  ┊66┊    if (chat) {\n+┊  ┊67┊      this.chat = chat;\n+┊  ┊68┊    }\n+┊  ┊69┊  }\n+┊  ┊70┊}\n```\n\n##### Added entity&#x2F;Recipient.ts\n```diff\n@@ -0,0 +1,44 @@\n+┊  ┊ 1┊import { Entity, ManyToOne, Column } from \"typeorm\";\n+┊  ┊ 2┊import { Message } from \"./Message\";\n+┊  ┊ 3┊import { User } from \"./User\";\n+┊  ┊ 4┊import { Chat } from \"./Chat\";\n+┊  ┊ 5┊\n+┊  ┊ 6┊interface RecipientConstructor {\n+┊  ┊ 7┊  user?: User;\n+┊  ┊ 8┊  message?: Message;\n+┊  ┊ 9┊  receivedAt?: Date;\n+┊  ┊10┊  readAt?: Date;\n+┊  ┊11┊}\n+┊  ┊12┊\n+┊  ┊13┊@Entity()\n+┊  ┊14┊export class Recipient {\n+┊  ┊15┊  @ManyToOne(type => User, user => user.recipients, { primary: true })\n+┊  ┊16┊  user: User;\n+┊  ┊17┊\n+┊  ┊18┊  @ManyToOne(type => Message, message => message.recipients, { primary: true })\n+┊  ┊19┊  message: Message;\n+┊  ┊20┊\n+┊  ┊21┊  @ManyToOne(type => Chat, chat => chat.recipients)\n+┊  ┊22┊  chat: Chat;\n+┊  ┊23┊\n+┊  ┊24┊  @Column({nullable: true})\n+┊  ┊25┊  receivedAt: Date;\n+┊  ┊26┊\n+┊  ┊27┊  @Column({nullable: true})\n+┊  ┊28┊  readAt: Date;\n+┊  ┊29┊\n+┊  ┊30┊  constructor({user, message, receivedAt, readAt}: RecipientConstructor = {}) {\n+┊  ┊31┊    if (user) {\n+┊  ┊32┊      this.user = user;\n+┊  ┊33┊    }\n+┊  ┊34┊    if (message) {\n+┊  ┊35┊      this.message = message;\n+┊  ┊36┊    }\n+┊  ┊37┊    if (receivedAt) {\n+┊  ┊38┊      this.receivedAt = receivedAt;\n+┊  ┊39┊    }\n+┊  ┊40┊    if (readAt) {\n+┊  ┊41┊      this.readAt = readAt;\n+┊  ┊42┊    }\n+┊  ┊43┊  }\n+┊  ┊44┊}\n```\n\n##### Added entity&#x2F;User.ts\n```diff\n@@ -0,0 +1,75 @@\n+┊  ┊ 1┊import { Entity, Column, PrimaryGeneratedColumn, ManyToMany, OneToMany } from \"typeorm\";\n+┊  ┊ 2┊import { Chat } from \"./Chat\";\n+┊  ┊ 3┊import { Message } from \"./Message\";\n+┊  ┊ 4┊import { Recipient } from \"./Recipient\";\n+┊  ┊ 5┊\n+┊  ┊ 6┊interface UserConstructor {\n+┊  ┊ 7┊  username?: string;\n+┊  ┊ 8┊  password?: string;\n+┊  ┊ 9┊  name?: string;\n+┊  ┊10┊  picture?: string;\n+┊  ┊11┊  phone?: string;\n+┊  ┊12┊}\n+┊  ┊13┊\n+┊  ┊14┊@Entity()\n+┊  ┊15┊export class User {\n+┊  ┊16┊  @PrimaryGeneratedColumn()\n+┊  ┊17┊  id: number;\n+┊  ┊18┊\n+┊  ┊19┊  @Column()\n+┊  ┊20┊  username: string;\n+┊  ┊21┊\n+┊  ┊22┊  @Column()\n+┊  ┊23┊  password: string;\n+┊  ┊24┊\n+┊  ┊25┊  @Column()\n+┊  ┊26┊  name: string;\n+┊  ┊27┊\n+┊  ┊28┊  @Column({nullable: true})\n+┊  ┊29┊  picture: string;\n+┊  ┊30┊\n+┊  ┊31┊  @Column({nullable: true})\n+┊  ┊32┊  phone?: string;\n+┊  ┊33┊\n+┊  ┊34┊  @ManyToMany(type => Chat, chat => chat.allTimeMembers)\n+┊  ┊35┊  allTimeMemberChats: Chat[];\n+┊  ┊36┊\n+┊  ┊37┊  @ManyToMany(type => Chat, chat => chat.listingMembers)\n+┊  ┊38┊  listingMemberChats: Chat[];\n+┊  ┊39┊\n+┊  ┊40┊  @ManyToMany(type => Chat, chat => chat.actualGroupMembers)\n+┊  ┊41┊  actualGroupMemberChats: Chat[];\n+┊  ┊42┊\n+┊  ┊43┊  @ManyToMany(type => Chat, chat => chat.admins)\n+┊  ┊44┊  adminChats: Chat[];\n+┊  ┊45┊\n+┊  ┊46┊  @ManyToMany(type => Message, message => message.holders)\n+┊  ┊47┊  holderMessages: Message[];\n+┊  ┊48┊\n+┊  ┊49┊  @OneToMany(type => Chat, chat => chat.owner)\n+┊  ┊50┊  ownerChats: Chat[];\n+┊  ┊51┊\n+┊  ┊52┊  @OneToMany(type => Message, message => message.sender)\n+┊  ┊53┊  senderMessages: Message[];\n+┊  ┊54┊\n+┊  ┊55┊  @OneToMany(type => Recipient, recipient => recipient.user)\n+┊  ┊56┊  recipients: Recipient[];\n+┊  ┊57┊\n+┊  ┊58┊  constructor({username, password, name, picture, phone}: UserConstructor = {}) {\n+┊  ┊59┊    if (username) {\n+┊  ┊60┊      this.username = username;\n+┊  ┊61┊    }\n+┊  ┊62┊    if (password) {\n+┊  ┊63┊      this.password = password;\n+┊  ┊64┊    }\n+┊  ┊65┊    if (name) {\n+┊  ┊66┊      this.name = name;\n+┊  ┊67┊    }\n+┊  ┊68┊    if (picture) {\n+┊  ┊69┊      this.picture = picture;\n+┊  ┊70┊    }\n+┊  ┊71┊    if (phone) {\n+┊  ┊72┊      this.phone = phone;\n+┊  ┊73┊    }\n+┊  ┊74┊  }\n+┊  ┊75┊}\n```\n\n[}]: #\n\nBasic entities consist of columns and relations. Each entity MUST have a primary column.\n\nEach entity must be registered in your connection options:\n\n[{]: <helper> (diffStep \"6.1\" files=\"ormconfig.json\" module=\"server\")\n\n#### [Step 6.1: TypeORM with PostgreSQL](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/00c4cab)\n\n##### Added ormconfig.json\n```diff\n@@ -0,0 +1,24 @@\n+┊  ┊ 1┊{\n+┊  ┊ 2┊   \"type\": \"postgres\",\n+┊  ┊ 3┊   \"host\": \"localhost\",\n+┊  ┊ 4┊   \"port\": 5432,\n+┊  ┊ 5┊   \"username\": \"test\",\n+┊  ┊ 6┊   \"password\": \"\",\n+┊  ┊ 7┊   \"database\": \"test\",\n+┊  ┊ 8┊   \"synchronize\": true,\n+┊  ┊ 9┊   \"logging\": false,\n+┊  ┊10┊   \"entities\": [\n+┊  ┊11┊      \"entity/**/*.ts\"\n+┊  ┊12┊   ],\n+┊  ┊13┊   \"migrations\": [\n+┊  ┊14┊      \"migration/**/*.ts\"\n+┊  ┊15┊   ],\n+┊  ┊16┊   \"subscribers\": [\n+┊  ┊17┊      \"subscriber/**/*.ts\"\n+┊  ┊18┊   ],\n+┊  ┊19┊   \"cli\": {\n+┊  ┊20┊      \"entitiesDir\": \"entity\",\n+┊  ┊21┊      \"migrationsDir\": \"migration\",\n+┊  ┊22┊      \"subscribersDir\": \"subscriber\"\n+┊  ┊23┊   }\n+┊  ┊24┊}🚫↵\n```\n\n[}]: #\n\nSince database table consist of columns your entities must consist of columns too. Each entity class property you marked with @Column will be mapped to a database table column.\nEach entity must have at least one primary column. There are several types of primary columns, but in our case `@PrimaryGeneratedColumn()` creates a primary column which value will be automatically generated with an auto-increment value.\n`@CreateDateColumn` is a special column that is automatically set to the entity's insertion date. You don't need set this column - it will be automatically set.\nFor the Recipient Entity we use a composite primary key that consists of two foreign keys.\n\nThe next thing to do is to create a connection with the database before firing up the web server:\n\n[{]: <helper> (diffStep \"6.1\" files=\"index.ts\" module=\"server\")\n\n#### [Step 6.1: TypeORM with PostgreSQL](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/00c4cab)\n\n##### Changed index.ts\n```diff\n@@ -1,3 +1,5 @@\n+┊ ┊1┊// For TypeORM\n+┊ ┊2┊import \"reflect-metadata\";\n ┊1┊3┊import { schema } from \"./schema\";\n ┊2┊4┊import * as bodyParser from \"body-parser\";\n ┊3┊5┊import * as cors from 'cors';\n```\n```diff\n@@ -6,12 +8,10 @@\n ┊ 6┊ 8┊import * as passport from \"passport\";\n ┊ 7┊ 9┊import * as basicStrategy from 'passport-http';\n ┊ 8┊10┊import * as bcrypt from 'bcrypt-nodejs';\n-┊ 9┊  ┊import { db, User } from \"./db\";\n ┊10┊11┊import { createServer } from \"http\";\n-┊11┊  ┊\n-┊12┊  ┊let users = db.users;\n-┊13┊  ┊\n-┊14┊  ┊console.log(users);\n+┊  ┊12┊import { createConnection } from \"typeorm\";\n+┊  ┊13┊import { User } from \"./entity/User\";\n+┊  ┊14┊import { addSampleData } from \"./db\";\n ┊15┊15┊\n ┊16┊16┊function generateHash(password: string) {\n ┊17┊17┊  return bcrypt.hashSync(password, bcrypt.genSaltSync(8));\n```\n```diff\n@@ -21,93 +21,96 @@\n ┊ 21┊ 21┊  return bcrypt.compareSync(password, localPassword);\n ┊ 22┊ 22┊}\n ┊ 23┊ 23┊\n-┊ 24┊   ┊passport.use('basic-signin', new basicStrategy.BasicStrategy(\n-┊ 25┊   ┊  function (username: string, password: string, done: any) {\n-┊ 26┊   ┊    const user = users.find(user => user.username == username);\n-┊ 27┊   ┊    if (user && validPassword(password, user.password)) {\n-┊ 28┊   ┊      return done(null, user);\n+┊   ┊ 24┊createConnection().then(async connection => {\n+┊   ┊ 25┊  await addSampleData(connection);\n+┊   ┊ 26┊\n+┊   ┊ 27┊  passport.use('basic-signin', new basicStrategy.BasicStrategy(\n+┊   ┊ 28┊    async function (username: string, password: string, done: any) {\n+┊   ┊ 29┊      const user = await connection.getRepository(User).findOne({where: { username }});\n+┊   ┊ 30┊      if (user && validPassword(password, user.password)) {\n+┊   ┊ 31┊        return done(null, user);\n+┊   ┊ 32┊      }\n+┊   ┊ 33┊      return done(null, false);\n ┊ 29┊ 34┊    }\n-┊ 30┊   ┊    return done(null, false);\n-┊ 31┊   ┊  }\n-┊ 32┊   ┊));\n-┊ 33┊   ┊\n-┊ 34┊   ┊passport.use('basic-signup', new basicStrategy.BasicStrategy({passReqToCallback: true},\n-┊ 35┊   ┊  function (req: any, username: any, password: any, done: any) {\n-┊ 36┊   ┊    const userExists = !!users.find(user => user.username === username);\n-┊ 37┊   ┊    if (!userExists && password && req.body.name) {\n-┊ 38┊   ┊      const user: User = {\n-┊ 39┊   ┊        id: (users.length && users[users.length - 1].id + 1) || 1,\n-┊ 40┊   ┊        username,\n-┊ 41┊   ┊        password: generateHash(password),\n-┊ 42┊   ┊        name: req.body.name,\n-┊ 43┊   ┊      };\n-┊ 44┊   ┊      users.push(user);\n-┊ 45┊   ┊      return done(null, user);\n+┊   ┊ 35┊  ));\n+┊   ┊ 36┊\n+┊   ┊ 37┊  passport.use('basic-signup', new basicStrategy.BasicStrategy({passReqToCallback: true},\n+┊   ┊ 38┊    async function (req: any, username: string, password: string, done: any) {\n+┊   ┊ 39┊      const userExists = !!(await connection.getRepository(User).findOne({where: { username }}));\n+┊   ┊ 40┊      if (!userExists && password && req.body.name) {\n+┊   ┊ 41┊        const user = await connection.manager.save(new User({\n+┊   ┊ 42┊          username,\n+┊   ┊ 43┊          password: generateHash(password),\n+┊   ┊ 44┊          name: req.body.name,\n+┊   ┊ 45┊        }));\n+┊   ┊ 46┊        return done(null, user);\n+┊   ┊ 47┊      }\n+┊   ┊ 48┊      return done(null, false);\n ┊ 46┊ 49┊    }\n-┊ 47┊   ┊    return done(null, false);\n-┊ 48┊   ┊  }\n-┊ 49┊   ┊));\n+┊   ┊ 50┊  ));\n ┊ 50┊ 51┊\n-┊ 51┊   ┊const PORT = 3000;\n+┊   ┊ 52┊  const PORT = 3000;\n ┊ 52┊ 53┊\n-┊ 53┊   ┊const app = express();\n+┊   ┊ 54┊  const app = express();\n ┊ 54┊ 55┊\n-┊ 55┊   ┊app.use(cors());\n-┊ 56┊   ┊app.use(bodyParser.json());\n-┊ 57┊   ┊app.use(passport.initialize());\n+┊   ┊ 56┊  app.use(cors());\n+┊   ┊ 57┊  app.use(bodyParser.json());\n+┊   ┊ 58┊  app.use(passport.initialize());\n ┊ 58┊ 59┊\n-┊ 59┊   ┊app.post('/signup',\n-┊ 60┊   ┊  passport.authenticate('basic-signup', {session: false}),\n-┊ 61┊   ┊  function (req: any, res) {\n-┊ 62┊   ┊    res.json(req.user);\n-┊ 63┊   ┊  });\n+┊   ┊ 60┊  app.post('/signup',\n+┊   ┊ 61┊    passport.authenticate('basic-signup', {session: false}),\n+┊   ┊ 62┊    function (req: any, res) {\n+┊   ┊ 63┊      res.json(req.user);\n+┊   ┊ 64┊    });\n ┊ 64┊ 65┊\n-┊ 65┊   ┊app.use(passport.authenticate('basic-signin', {session: false}));\n+┊   ┊ 66┊  app.use(passport.authenticate('basic-signin', {session: false}));\n ┊ 66┊ 67┊\n-┊ 67┊   ┊app.post('/signin', function (req: any, res) {\n-┊ 68┊   ┊  res.json(req.user);\n-┊ 69┊   ┊});\n+┊   ┊ 68┊  app.post('/signin', function (req, res) {\n+┊   ┊ 69┊    res.json(req.user);\n+┊   ┊ 70┊  });\n ┊ 70┊ 71┊\n-┊ 71┊   ┊const apollo = new ApolloServer({\n-┊ 72┊   ┊  schema,\n-┊ 73┊   ┊  context(received: any) {\n-┊ 74┊   ┊    return {\n-┊ 75┊   ┊      user: received.connection ? received.connection.context.user : received.req!['user'],\n-┊ 76┊   ┊    }\n-┊ 77┊   ┊  },\n-┊ 78┊   ┊  subscriptions: {\n-┊ 79┊   ┊    onConnect: (connectionParams: any, webSocket: any) => {\n-┊ 80┊   ┊      if (connectionParams.authToken) {\n-┊ 81┊   ┊        // create a buffer and tell it the data coming in is base64\n-┊ 82┊   ┊        const buf = new Buffer(connectionParams.authToken.split(' ')[1], 'base64');\n-┊ 83┊   ┊        // read it back out as a string\n-┊ 84┊   ┊        const [username, password]: string[] = buf.toString().split(':');\n-┊ 85┊   ┊        if (username && password) {\n-┊ 86┊   ┊          const user = users.find(user => user.username == username);\n-┊ 87┊   ┊\n-┊ 88┊   ┊          if (user && validPassword(password, user.password)) {\n-┊ 89┊   ┊            // Set context for the WebSocket\n-┊ 90┊   ┊            return {user};\n-┊ 91┊   ┊          } else {\n-┊ 92┊   ┊            throw new Error('Wrong credentials!');\n+┊   ┊ 72┊  const apollo = new ApolloServer({\n+┊   ┊ 73┊    schema,\n+┊   ┊ 74┊    context(received: any) {\n+┊   ┊ 75┊      return {\n+┊   ┊ 76┊        user: received.connection ? received.connection.context.user : received.req!['user'],\n+┊   ┊ 77┊        connection,\n+┊   ┊ 78┊      }\n+┊   ┊ 79┊    },\n+┊   ┊ 80┊    subscriptions: {\n+┊   ┊ 81┊      onConnect: async (connectionParams: any, webSocket: any) => {\n+┊   ┊ 82┊        if (connectionParams.authToken) {\n+┊   ┊ 83┊          // Create a buffer and tell it the data coming in is base64\n+┊   ┊ 84┊          const buf = new Buffer(connectionParams.authToken.split(' ')[1], 'base64');\n+┊   ┊ 85┊          // Read it back out as a string\n+┊   ┊ 86┊          const [username, password]: string[] = buf.toString().split(':');\n+┊   ┊ 87┊          if (username && password) {\n+┊   ┊ 88┊            const user = await connection.getRepository(User).findOne({where: { username }});\n+┊   ┊ 89┊\n+┊   ┊ 90┊            if (user && validPassword(password, user.password)) {\n+┊   ┊ 91┊              // Set context for the WebSocket\n+┊   ┊ 92┊              return {user};\n+┊   ┊ 93┊            } else {\n+┊   ┊ 94┊              throw new Error('Wrong credentials!');\n+┊   ┊ 95┊            }\n ┊ 93┊ 96┊          }\n ┊ 94┊ 97┊        }\n+┊   ┊ 98┊        throw new Error('Missing auth token!');\n ┊ 95┊ 99┊      }\n-┊ 96┊   ┊      throw new Error('Missing auth token!');\n ┊ 97┊100┊    }\n-┊ 98┊   ┊  }\n-┊ 99┊   ┊});\n+┊   ┊101┊  });\n ┊100┊102┊\n-┊101┊   ┊apollo.applyMiddleware({\n-┊102┊   ┊  app,\n-┊103┊   ┊  path: '/graphql'\n-┊104┊   ┊});\n+┊   ┊103┊  apollo.applyMiddleware({\n+┊   ┊104┊    app,\n+┊   ┊105┊    path: '/graphql'\n+┊   ┊106┊  });\n ┊105┊107┊\n-┊106┊   ┊// Wrap the Express server\n-┊107┊   ┊const ws = createServer(app);\n+┊   ┊108┊  // Wrap the Express server\n+┊   ┊109┊  const ws = createServer(app);\n ┊108┊110┊\n-┊109┊   ┊apollo.installSubscriptionHandlers(ws);\n+┊   ┊111┊  apollo.installSubscriptionHandlers(ws);\n ┊110┊112┊\n-┊111┊   ┊ws.listen(PORT, () => {\n-┊112┊   ┊  console.log(`Apollo Server is now running on http://localhost:${PORT}`);\n+┊   ┊113┊  ws.listen(PORT, () => {\n+┊   ┊114┊    console.log(`Apollo Server is now running on http://localhost:${PORT}`);\n+┊   ┊115┊  });\n ┊113┊116┊});\n```\n\n[}]: #\n\nWe will also remove our fake db and replace it with some real data:\n\n[{]: <helper> (diffStep \"6.1\" files=\"db.ts\" module=\"server\")\n\n#### [Step 6.1: TypeORM with PostgreSQL](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/00c4cab)\n\n##### Changed db.ts\n```diff\n@@ -1,4 +1,11 @@\n+┊  ┊ 1┊// For TypeORM\n+┊  ┊ 2┊import \"reflect-metadata\";\n+┊  ┊ 3┊import { Chat } from \"./entity/Chat\";\n+┊  ┊ 4┊import { Recipient } from \"./entity/Recipient\";\n ┊ 1┊ 5┊import * as moment from 'moment';\n+┊  ┊ 6┊import { Message } from \"./entity/Message\";\n+┊  ┊ 7┊import { User } from \"./entity/User\";\n+┊  ┊ 8┊import { Connection } from \"typeorm\";\n ┊ 2┊ 9┊\n ┊ 3┊10┊export enum MessageType {\n ┊ 4┊11┊  PICTURE,\n```\n```diff\n@@ -6,433 +13,280 @@\n ┊  6┊ 13┊  LOCATION,\n ┊  7┊ 14┊}\n ┊  8┊ 15┊\n-┊  9┊   ┊export interface User {\n-┊ 10┊   ┊  id: number,\n-┊ 11┊   ┊  username: string,\n-┊ 12┊   ┊  password: string,\n-┊ 13┊   ┊  name: string,\n-┊ 14┊   ┊  picture?: string | null,\n-┊ 15┊   ┊  phone?: string | null,\n-┊ 16┊   ┊}\n-┊ 17┊   ┊\n-┊ 18┊   ┊export interface Chat {\n-┊ 19┊   ┊  id: number,\n-┊ 20┊   ┊  name?: string | null,\n-┊ 21┊   ┊  picture?: string | null,\n-┊ 22┊   ┊  // All members, current and past ones.\n-┊ 23┊   ┊  allTimeMemberIds: number[],\n-┊ 24┊   ┊  // Whoever gets the chat listed. For groups includes past members who still didn't delete the group.\n-┊ 25┊   ┊  listingMemberIds: number[],\n-┊ 26┊   ┊  // Actual members of the group (they are not the only ones who get the group listed). Null for chats.\n-┊ 27┊   ┊  actualGroupMemberIds?: number[] | null,\n-┊ 28┊   ┊  adminIds?: number[] | null,\n-┊ 29┊   ┊  ownerId?: number | null,\n-┊ 30┊   ┊  messages: Message[],\n-┊ 31┊   ┊}\n-┊ 32┊   ┊\n-┊ 33┊   ┊export interface Message {\n-┊ 34┊   ┊  id: number,\n-┊ 35┊   ┊  chatId: number,\n-┊ 36┊   ┊  senderId: number,\n-┊ 37┊   ┊  content: string,\n-┊ 38┊   ┊  createdAt: number,\n-┊ 39┊   ┊  type: MessageType,\n-┊ 40┊   ┊  recipients: Recipient[],\n-┊ 41┊   ┊  holderIds: number[],\n-┊ 42┊   ┊}\n-┊ 43┊   ┊\n-┊ 44┊   ┊export interface Recipient {\n-┊ 45┊   ┊  userId: number,\n-┊ 46┊   ┊  messageId: number,\n-┊ 47┊   ┊  chatId: number,\n-┊ 48┊   ┊  receivedAt: number | null,\n-┊ 49┊   ┊  readAt: number | null,\n-┊ 50┊   ┊}\n-┊ 51┊   ┊\n-┊ 52┊   ┊const users: User[] = [\n-┊ 53┊   ┊  {\n-┊ 54┊   ┊    id: 1,\n+┊   ┊ 16┊export async function addSampleData(connection: Connection) {\n+┊   ┊ 17┊  const user1 = new User({\n ┊ 55┊ 18┊    username: 'ethan',\n ┊ 56┊ 19┊    password: '$2a$08$NO9tkFLCoSqX1c5wk3s7z.JfxaVMKA.m7zUDdDwEquo4rvzimQeJm', // 111\n ┊ 57┊ 20┊    name: 'Ethan Gonzalez',\n ┊ 58┊ 21┊    picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n ┊ 59┊ 22┊    phone: '+391234567890',\n-┊ 60┊   ┊  },\n-┊ 61┊   ┊  {\n-┊ 62┊   ┊    id: 2,\n+┊   ┊ 23┊  });\n+┊   ┊ 24┊  await connection.manager.save(user1);\n+┊   ┊ 25┊\n+┊   ┊ 26┊  const user2 = new User({\n ┊ 63┊ 27┊    username: 'bryan',\n ┊ 64┊ 28┊    password: '$2a$08$xE4FuCi/ifxjL2S8CzKAmuKLwv18ktksSN.F3XYEnpmcKtpbpeZgO', // 222\n ┊ 65┊ 29┊    name: 'Bryan Wallace',\n ┊ 66┊ 30┊    picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n ┊ 67┊ 31┊    phone: '+391234567891',\n-┊ 68┊   ┊  },\n-┊ 69┊   ┊  {\n-┊ 70┊   ┊    id: 3,\n+┊   ┊ 32┊  });\n+┊   ┊ 33┊  await connection.manager.save(user2);\n+┊   ┊ 34┊\n+┊   ┊ 35┊  const user3 = new User({\n ┊ 71┊ 36┊    username: 'avery',\n ┊ 72┊ 37┊    password: '$2a$08$UHgH7J8G6z1mGQn2qx2kdeWv0jvgHItyAsL9hpEUI3KJmhVW5Q1d.', // 333\n ┊ 73┊ 38┊    name: 'Avery Stewart',\n ┊ 74┊ 39┊    picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n ┊ 75┊ 40┊    phone: '+391234567892',\n-┊ 76┊   ┊  },\n-┊ 77┊   ┊  {\n-┊ 78┊   ┊    id: 4,\n+┊   ┊ 41┊  });\n+┊   ┊ 42┊  await connection.manager.save(user3);\n+┊   ┊ 43┊\n+┊   ┊ 44┊  const user4 = new User({\n ┊ 79┊ 45┊    username: 'katie',\n ┊ 80┊ 46┊    password: '$2a$08$wR1k5Q3T9FC7fUgB7Gdb9Os/GV7dGBBf4PLlWT7HERMFhmFDt47xi', // 444\n ┊ 81┊ 47┊    name: 'Katie Peterson',\n ┊ 82┊ 48┊    picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n ┊ 83┊ 49┊    phone: '+391234567893',\n-┊ 84┊   ┊  },\n-┊ 85┊   ┊  {\n-┊ 86┊   ┊    id: 5,\n+┊   ┊ 50┊  });\n+┊   ┊ 51┊  await connection.manager.save(user4);\n+┊   ┊ 52┊\n+┊   ┊ 53┊  const user5 = new User({\n ┊ 87┊ 54┊    username: 'ray',\n ┊ 88┊ 55┊    password: '$2a$08$6.mbXqsDX82ZZ7q5d8Osb..JrGSsNp4R3IKj7mxgF6YGT0OmMw242', // 555\n ┊ 89┊ 56┊    name: 'Ray Edwards',\n ┊ 90┊ 57┊    picture: 'https://randomuser.me/api/portraits/thumb/men/3.jpg',\n ┊ 91┊ 58┊    phone: '+391234567894',\n-┊ 92┊   ┊  },\n-┊ 93┊   ┊  {\n-┊ 94┊   ┊    id: 6,\n+┊   ┊ 59┊  });\n+┊   ┊ 60┊  await connection.manager.save(user5);\n+┊   ┊ 61┊\n+┊   ┊ 62┊  const user6 = new User({\n ┊ 95┊ 63┊    username: 'niko',\n ┊ 96┊ 64┊    password: '$2a$08$fL5lZR.Rwf9FWWe8XwwlceiPBBim8n9aFtaem.INQhiKT4.Ux3Uq.', // 666\n ┊ 97┊ 65┊    name: 'Niccolò Belli',\n ┊ 98┊ 66┊    picture: 'https://randomuser.me/api/portraits/thumb/men/4.jpg',\n ┊ 99┊ 67┊    phone: '+391234567895',\n-┊100┊   ┊  },\n-┊101┊   ┊  {\n-┊102┊   ┊    id: 7,\n+┊   ┊ 68┊  });\n+┊   ┊ 69┊  await connection.manager.save(user6);\n+┊   ┊ 70┊\n+┊   ┊ 71┊  const user7 = new User({\n ┊103┊ 72┊    username: 'mario',\n ┊104┊ 73┊    password: '$2a$08$nDHDmWcVxDnH5DDT3HMMC.psqcnu6wBiOgkmJUy9IH..qxa3R6YrO', // 777\n ┊105┊ 74┊    name: 'Mario Rossi',\n ┊106┊ 75┊    picture: 'https://randomuser.me/api/portraits/thumb/men/5.jpg',\n ┊107┊ 76┊    phone: '+391234567896',\n-┊108┊   ┊  },\n-┊109┊   ┊];\n+┊   ┊ 77┊  });\n+┊   ┊ 78┊  await connection.manager.save(user7);\n+┊   ┊ 79┊\n+┊   ┊ 80┊\n ┊110┊ 81┊\n-┊111┊   ┊const chats: Chat[] = [\n-┊112┊   ┊  {\n-┊113┊   ┊    id: 1,\n-┊114┊   ┊    name: null,\n-┊115┊   ┊    picture: null,\n-┊116┊   ┊    allTimeMemberIds: [1, 3],\n-┊117┊   ┊    listingMemberIds: [1, 3],\n-┊118┊   ┊    adminIds: null,\n-┊119┊   ┊    ownerId: null,\n+┊   ┊ 82┊\n+┊   ┊ 83┊  await connection.manager.save(new Chat({\n+┊   ┊ 84┊    allTimeMembers: [user1, user3],\n+┊   ┊ 85┊    listingMembers: [user1, user3],\n ┊120┊ 86┊    messages: [\n-┊121┊   ┊      {\n-┊122┊   ┊        id: 1,\n-┊123┊   ┊        chatId: 1,\n-┊124┊   ┊        senderId: 1,\n+┊   ┊ 87┊      new Message({\n+┊   ┊ 88┊        sender: user1,\n ┊125┊ 89┊        content: 'You on your way?',\n-┊126┊   ┊        createdAt: moment().subtract(1, 'hours').unix(),\n+┊   ┊ 90┊        createdAt: moment().subtract(1, 'hours').toDate(),\n ┊127┊ 91┊        type: MessageType.TEXT,\n+┊   ┊ 92┊        holders: [user1, user3],\n ┊128┊ 93┊        recipients: [\n-┊129┊   ┊          {\n-┊130┊   ┊            userId: 3,\n-┊131┊   ┊            messageId: 1,\n-┊132┊   ┊            chatId: 1,\n-┊133┊   ┊            receivedAt: null,\n-┊134┊   ┊            readAt: null,\n-┊135┊   ┊          },\n+┊   ┊ 94┊          new Recipient({\n+┊   ┊ 95┊            user: user3,\n+┊   ┊ 96┊          }),\n ┊136┊ 97┊        ],\n-┊137┊   ┊        holderIds: [1, 3],\n-┊138┊   ┊      },\n-┊139┊   ┊      {\n-┊140┊   ┊        id: 2,\n-┊141┊   ┊        chatId: 1,\n-┊142┊   ┊        senderId: 3,\n+┊   ┊ 98┊      }),\n+┊   ┊ 99┊      new Message({\n+┊   ┊100┊        sender: user3,\n ┊143┊101┊        content: 'Yep!',\n-┊144┊   ┊        createdAt: moment().subtract(1, 'hours').add(5, 'minutes').unix(),\n+┊   ┊102┊        createdAt: moment().subtract(1, 'hours').add(5, 'minutes').toDate(),\n ┊145┊103┊        type: MessageType.TEXT,\n+┊   ┊104┊        holders: [user1, user3],\n ┊146┊105┊        recipients: [\n-┊147┊   ┊          {\n-┊148┊   ┊            userId: 1,\n-┊149┊   ┊            messageId: 2,\n-┊150┊   ┊            chatId: 1,\n-┊151┊   ┊            receivedAt: null,\n-┊152┊   ┊            readAt: null,\n-┊153┊   ┊          },\n+┊   ┊106┊          new Recipient({\n+┊   ┊107┊            user: user1,\n+┊   ┊108┊          }),\n ┊154┊109┊        ],\n-┊155┊   ┊        holderIds: [3, 1],\n-┊156┊   ┊      },\n+┊   ┊110┊      }),\n ┊157┊111┊    ],\n-┊158┊   ┊  },\n-┊159┊   ┊  {\n-┊160┊   ┊    id: 2,\n-┊161┊   ┊    name: null,\n-┊162┊   ┊    picture: null,\n-┊163┊   ┊    allTimeMemberIds: [1, 4],\n-┊164┊   ┊    listingMemberIds: [1, 4],\n-┊165┊   ┊    adminIds: null,\n-┊166┊   ┊    ownerId: null,\n+┊   ┊112┊  }));\n+┊   ┊113┊\n+┊   ┊114┊  await connection.manager.save(new Chat({\n+┊   ┊115┊    allTimeMembers: [user1, user4],\n+┊   ┊116┊    listingMembers: [user1, user4],\n ┊167┊117┊    messages: [\n-┊168┊   ┊      {\n-┊169┊   ┊        id: 1,\n-┊170┊   ┊        chatId: 2,\n-┊171┊   ┊        senderId: 1,\n+┊   ┊118┊      new Message({\n+┊   ┊119┊        sender: user1,\n ┊172┊120┊        content: 'Hey, it\\'s me',\n-┊173┊   ┊        createdAt: moment().subtract(2, 'hours').unix(),\n+┊   ┊121┊        createdAt: moment().subtract(2, 'hours').toDate(),\n ┊174┊122┊        type: MessageType.TEXT,\n+┊   ┊123┊        holders: [user1, user4],\n ┊175┊124┊        recipients: [\n-┊176┊   ┊          {\n-┊177┊   ┊            userId: 4,\n-┊178┊   ┊            messageId: 1,\n-┊179┊   ┊            chatId: 2,\n-┊180┊   ┊            receivedAt: null,\n-┊181┊   ┊            readAt: null,\n-┊182┊   ┊          },\n+┊   ┊125┊          new Recipient({\n+┊   ┊126┊            user: user4,\n+┊   ┊127┊          }),\n ┊183┊128┊        ],\n-┊184┊   ┊        holderIds: [1, 4],\n-┊185┊   ┊      },\n+┊   ┊129┊      }),\n ┊186┊130┊    ],\n-┊187┊   ┊  },\n-┊188┊   ┊  {\n-┊189┊   ┊    id: 3,\n-┊190┊   ┊    name: null,\n-┊191┊   ┊    picture: null,\n-┊192┊   ┊    allTimeMemberIds: [1, 5],\n-┊193┊   ┊    listingMemberIds: [1, 5],\n-┊194┊   ┊    adminIds: null,\n-┊195┊   ┊    ownerId: null,\n+┊   ┊131┊  }));\n+┊   ┊132┊\n+┊   ┊133┊  await connection.manager.save(new Chat({\n+┊   ┊134┊    allTimeMembers: [user1, user5],\n+┊   ┊135┊    listingMembers: [user1, user5],\n ┊196┊136┊    messages: [\n-┊197┊   ┊      {\n-┊198┊   ┊        id: 1,\n-┊199┊   ┊        chatId: 3,\n-┊200┊   ┊        senderId: 1,\n+┊   ┊137┊      new Message({\n+┊   ┊138┊        sender: user1,\n ┊201┊139┊        content: 'I should buy a boat',\n-┊202┊   ┊        createdAt: moment().subtract(1, 'days').unix(),\n+┊   ┊140┊        createdAt: moment().subtract(1, 'days').toDate(),\n ┊203┊141┊        type: MessageType.TEXT,\n+┊   ┊142┊        holders: [user1, user5],\n ┊204┊143┊        recipients: [\n-┊205┊   ┊          {\n-┊206┊   ┊            userId: 5,\n-┊207┊   ┊            messageId: 1,\n-┊208┊   ┊            chatId: 3,\n-┊209┊   ┊            receivedAt: null,\n-┊210┊   ┊            readAt: null,\n-┊211┊   ┊          },\n+┊   ┊144┊          new Recipient({\n+┊   ┊145┊            user: user5,\n+┊   ┊146┊          }),\n ┊212┊147┊        ],\n-┊213┊   ┊        holderIds: [1, 5],\n-┊214┊   ┊      },\n-┊215┊   ┊      {\n-┊216┊   ┊        id: 2,\n-┊217┊   ┊        chatId: 3,\n-┊218┊   ┊        senderId: 1,\n+┊   ┊148┊      }),\n+┊   ┊149┊      new Message({\n+┊   ┊150┊        sender: user1,\n ┊219┊151┊        content: 'You still there?',\n-┊220┊   ┊        createdAt: moment().subtract(1, 'days').add(16, 'hours').unix(),\n+┊   ┊152┊        createdAt: moment().subtract(1, 'days').add(16, 'hours').toDate(),\n ┊221┊153┊        type: MessageType.TEXT,\n+┊   ┊154┊        holders: [user1, user5],\n ┊222┊155┊        recipients: [\n-┊223┊   ┊          {\n-┊224┊   ┊            userId: 5,\n-┊225┊   ┊            messageId: 2,\n-┊226┊   ┊            chatId: 3,\n-┊227┊   ┊            receivedAt: null,\n-┊228┊   ┊            readAt: null,\n-┊229┊   ┊          },\n+┊   ┊156┊          new Recipient({\n+┊   ┊157┊            user: user5,\n+┊   ┊158┊          }),\n ┊230┊159┊        ],\n-┊231┊   ┊        holderIds: [1, 5],\n-┊232┊   ┊      },\n+┊   ┊160┊      }),\n ┊233┊161┊    ],\n-┊234┊   ┊  },\n-┊235┊   ┊  {\n-┊236┊   ┊    id: 4,\n-┊237┊   ┊    name: null,\n-┊238┊   ┊    picture: null,\n-┊239┊   ┊    allTimeMemberIds: [3, 4],\n-┊240┊   ┊    listingMemberIds: [3, 4],\n-┊241┊   ┊    adminIds: null,\n-┊242┊   ┊    ownerId: null,\n+┊   ┊162┊  }));\n+┊   ┊163┊\n+┊   ┊164┊  await connection.manager.save(new Chat({\n+┊   ┊165┊    allTimeMembers: [user3, user4],\n+┊   ┊166┊    listingMembers: [user3, user4],\n ┊243┊167┊    messages: [\n-┊244┊   ┊      {\n-┊245┊   ┊        id: 1,\n-┊246┊   ┊        chatId: 4,\n-┊247┊   ┊        senderId: 3,\n+┊   ┊168┊      new Message({\n+┊   ┊169┊        sender: user3,\n ┊248┊170┊        content: 'Look at my mukluks!',\n-┊249┊   ┊        createdAt: moment().subtract(4, 'days').unix(),\n+┊   ┊171┊        createdAt: moment().subtract(4, 'days').toDate(),\n ┊250┊172┊        type: MessageType.TEXT,\n+┊   ┊173┊        holders: [user3, user4],\n ┊251┊174┊        recipients: [\n-┊252┊   ┊          {\n-┊253┊   ┊            userId: 4,\n-┊254┊   ┊            messageId: 1,\n-┊255┊   ┊            chatId: 4,\n-┊256┊   ┊            receivedAt: null,\n-┊257┊   ┊            readAt: null,\n-┊258┊   ┊          },\n+┊   ┊175┊          new Recipient({\n+┊   ┊176┊            user: user4,\n+┊   ┊177┊          }),\n ┊259┊178┊        ],\n-┊260┊   ┊        holderIds: [3, 4],\n-┊261┊   ┊      },\n+┊   ┊179┊      }),\n ┊262┊180┊    ],\n-┊263┊   ┊  },\n-┊264┊   ┊  {\n-┊265┊   ┊    id: 5,\n-┊266┊   ┊    name: null,\n-┊267┊   ┊    picture: null,\n-┊268┊   ┊    allTimeMemberIds: [2, 5],\n-┊269┊   ┊    listingMemberIds: [2, 5],\n-┊270┊   ┊    adminIds: null,\n-┊271┊   ┊    ownerId: null,\n+┊   ┊181┊  }));\n+┊   ┊182┊\n+┊   ┊183┊  await connection.manager.save(new Chat({\n+┊   ┊184┊    allTimeMembers: [user2, user5],\n+┊   ┊185┊    listingMembers: [user2, user5],\n ┊272┊186┊    messages: [\n-┊273┊   ┊      {\n-┊274┊   ┊        id: 1,\n-┊275┊   ┊        chatId: 5,\n-┊276┊   ┊        senderId: 2,\n+┊   ┊187┊      new Message({\n+┊   ┊188┊        sender: user2,\n ┊277┊189┊        content: 'This is wicked good ice cream.',\n-┊278┊   ┊        createdAt: moment().subtract(2, 'weeks').unix(),\n+┊   ┊190┊        createdAt: moment().subtract(2, 'weeks').toDate(),\n ┊279┊191┊        type: MessageType.TEXT,\n+┊   ┊192┊        holders: [user2, user5],\n ┊280┊193┊        recipients: [\n-┊281┊   ┊          {\n-┊282┊   ┊            userId: 5,\n-┊283┊   ┊            messageId: 1,\n-┊284┊   ┊            chatId: 5,\n-┊285┊   ┊            receivedAt: null,\n-┊286┊   ┊            readAt: null,\n-┊287┊   ┊          },\n+┊   ┊194┊          new Recipient({\n+┊   ┊195┊            user: user5,\n+┊   ┊196┊          }),\n ┊288┊197┊        ],\n-┊289┊   ┊        holderIds: [2, 5],\n-┊290┊   ┊      },\n-┊291┊   ┊      {\n-┊292┊   ┊        id: 2,\n-┊293┊   ┊        chatId: 6,\n-┊294┊   ┊        senderId: 5,\n+┊   ┊198┊      }),\n+┊   ┊199┊      new Message({\n+┊   ┊200┊        sender: user5,\n ┊295┊201┊        content: 'Love it!',\n-┊296┊   ┊        createdAt: moment().subtract(2, 'weeks').add(10, 'minutes').unix(),\n+┊   ┊202┊        createdAt: moment().subtract(2, 'weeks').add(10, 'minutes').toDate(),\n ┊297┊203┊        type: MessageType.TEXT,\n+┊   ┊204┊        holders: [user2, user5],\n ┊298┊205┊        recipients: [\n-┊299┊   ┊          {\n-┊300┊   ┊            userId: 2,\n-┊301┊   ┊            messageId: 2,\n-┊302┊   ┊            chatId: 5,\n-┊303┊   ┊            receivedAt: null,\n-┊304┊   ┊            readAt: null,\n-┊305┊   ┊          },\n+┊   ┊206┊          new Recipient({\n+┊   ┊207┊            user: user2,\n+┊   ┊208┊          }),\n ┊306┊209┊        ],\n-┊307┊   ┊        holderIds: [5, 2],\n-┊308┊   ┊      },\n+┊   ┊210┊      }),\n ┊309┊211┊    ],\n-┊310┊   ┊  },\n-┊311┊   ┊  {\n-┊312┊   ┊    id: 6,\n-┊313┊   ┊    name: null,\n-┊314┊   ┊    picture: null,\n-┊315┊   ┊    allTimeMemberIds: [1, 6],\n-┊316┊   ┊    listingMemberIds: [1],\n-┊317┊   ┊    adminIds: null,\n-┊318┊   ┊    ownerId: null,\n-┊319┊   ┊    messages: [],\n-┊320┊   ┊  },\n-┊321┊   ┊  {\n-┊322┊   ┊    id: 7,\n-┊323┊   ┊    name: null,\n-┊324┊   ┊    picture: null,\n-┊325┊   ┊    allTimeMemberIds: [2, 1],\n-┊326┊   ┊    listingMemberIds: [2],\n-┊327┊   ┊    adminIds: null,\n-┊328┊   ┊    ownerId: null,\n-┊329┊   ┊    messages: [],\n-┊330┊   ┊  },\n-┊331┊   ┊  {\n-┊332┊   ┊    id: 8,\n-┊333┊   ┊    name: 'A user 0 group',\n+┊   ┊212┊  }));\n+┊   ┊213┊\n+┊   ┊214┊  await connection.manager.save(new Chat({\n+┊   ┊215┊    allTimeMembers: [user1, user6],\n+┊   ┊216┊    listingMembers: [user1],\n+┊   ┊217┊  }));\n+┊   ┊218┊\n+┊   ┊219┊  await connection.manager.save(new Chat({\n+┊   ┊220┊    allTimeMembers: [user2, user1],\n+┊   ┊221┊    listingMembers: [user2],\n+┊   ┊222┊  }));\n+┊   ┊223┊\n+┊   ┊224┊  await connection.manager.save(new Chat({\n+┊   ┊225┊    name: 'Ethan\\'s group',\n ┊334┊226┊    picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n-┊335┊   ┊    allTimeMemberIds: [1, 3, 4, 6],\n-┊336┊   ┊    listingMemberIds: [1, 3, 4, 6],\n-┊337┊   ┊    actualGroupMemberIds: [1, 4, 6],\n-┊338┊   ┊    adminIds: [1, 6],\n-┊339┊   ┊    ownerId: 1,\n+┊   ┊227┊    allTimeMembers: [user1, user3, user4, user6],\n+┊   ┊228┊    listingMembers: [user1, user3, user4, user6],\n+┊   ┊229┊    actualGroupMembers: [user1, user4, user6],\n+┊   ┊230┊    admins: [user1, user6],\n+┊   ┊231┊    owner: user1,\n ┊340┊232┊    messages: [\n-┊341┊   ┊      {\n-┊342┊   ┊        id: 1,\n-┊343┊   ┊        chatId: 8,\n-┊344┊   ┊        senderId: 1,\n+┊   ┊233┊      new Message({\n+┊   ┊234┊        sender: user1,\n ┊345┊235┊        content: 'I made a group',\n-┊346┊   ┊        createdAt: moment().subtract(2, 'weeks').unix(),\n+┊   ┊236┊        createdAt: moment().subtract(2, 'weeks').toDate(),\n ┊347┊237┊        type: MessageType.TEXT,\n+┊   ┊238┊        holders: [user1, user3, user4, user6],\n ┊348┊239┊        recipients: [\n-┊349┊   ┊          {\n-┊350┊   ┊            userId: 3,\n-┊351┊   ┊            messageId: 1,\n-┊352┊   ┊            chatId: 8,\n-┊353┊   ┊            receivedAt: null,\n-┊354┊   ┊            readAt: null,\n-┊355┊   ┊          },\n-┊356┊   ┊          {\n-┊357┊   ┊            userId: 4,\n-┊358┊   ┊            messageId: 1,\n-┊359┊   ┊            chatId: 8,\n-┊360┊   ┊            receivedAt: moment().subtract(2, 'weeks').add(1, 'minutes').unix(),\n-┊361┊   ┊            readAt: moment().subtract(2, 'weeks').add(5, 'minutes').unix(),\n-┊362┊   ┊          },\n-┊363┊   ┊          {\n-┊364┊   ┊            userId: 6,\n-┊365┊   ┊            messageId: 1,\n-┊366┊   ┊            chatId: 8,\n-┊367┊   ┊            receivedAt: null,\n-┊368┊   ┊            readAt: null,\n-┊369┊   ┊          },\n+┊   ┊240┊          new Recipient({\n+┊   ┊241┊            user: user3,\n+┊   ┊242┊          }),\n+┊   ┊243┊          new Recipient({\n+┊   ┊244┊            user: user4,\n+┊   ┊245┊          }),\n+┊   ┊246┊          new Recipient({\n+┊   ┊247┊            user: user6,\n+┊   ┊248┊          }),\n ┊370┊249┊        ],\n-┊371┊   ┊        holderIds: [1, 3, 4, 6],\n-┊372┊   ┊      },\n-┊373┊   ┊      {\n-┊374┊   ┊        id: 2,\n-┊375┊   ┊        chatId: 8,\n-┊376┊   ┊        senderId: 1,\n-┊377┊   ┊        content: 'Ops, user 3 was not supposed to be here',\n-┊378┊   ┊        createdAt: moment().subtract(2, 'weeks').add(2, 'minutes').unix(),\n+┊   ┊250┊      }),\n+┊   ┊251┊      new Message({\n+┊   ┊252┊        sender: user1,\n+┊   ┊253┊        content: 'Ops, Avery was not supposed to be here',\n+┊   ┊254┊        createdAt: moment().subtract(2, 'weeks').add(2, 'minutes').toDate(),\n ┊379┊255┊        type: MessageType.TEXT,\n+┊   ┊256┊        holders: [user1, user4, user6],\n ┊380┊257┊        recipients: [\n-┊381┊   ┊          {\n-┊382┊   ┊            userId: 4,\n-┊383┊   ┊            messageId: 2,\n-┊384┊   ┊            chatId: 8,\n-┊385┊   ┊            receivedAt: moment().subtract(2, 'weeks').add(3, 'minutes').unix(),\n-┊386┊   ┊            readAt: moment().subtract(2, 'weeks').add(5, 'minutes').unix(),\n-┊387┊   ┊          },\n-┊388┊   ┊          {\n-┊389┊   ┊            userId: 6,\n-┊390┊   ┊            messageId: 2,\n-┊391┊   ┊            chatId: 8,\n-┊392┊   ┊            receivedAt: null,\n-┊393┊   ┊            readAt: null,\n-┊394┊   ┊          },\n+┊   ┊258┊          new Recipient({\n+┊   ┊259┊            user: user4,\n+┊   ┊260┊          }),\n+┊   ┊261┊          new Recipient({\n+┊   ┊262┊            user: user6,\n+┊   ┊263┊          }),\n ┊395┊264┊        ],\n-┊396┊   ┊        holderIds: [1, 4, 6],\n-┊397┊   ┊      },\n-┊398┊   ┊      {\n-┊399┊   ┊        id: 3,\n-┊400┊   ┊        chatId: 8,\n-┊401┊   ┊        senderId: 4,\n+┊   ┊265┊      }),\n+┊   ┊266┊      new Message({\n+┊   ┊267┊        sender: user4,\n ┊402┊268┊        content: 'Awesome!',\n-┊403┊   ┊        createdAt: moment().subtract(2, 'weeks').add(10, 'minutes').unix(),\n+┊   ┊269┊        createdAt: moment().subtract(2, 'weeks').add(10, 'minutes').toDate(),\n ┊404┊270┊        type: MessageType.TEXT,\n+┊   ┊271┊        holders: [user1, user4, user6],\n ┊405┊272┊        recipients: [\n-┊406┊   ┊          {\n-┊407┊   ┊            userId: 1,\n-┊408┊   ┊            messageId: 3,\n-┊409┊   ┊            chatId: 8,\n-┊410┊   ┊            receivedAt: null,\n-┊411┊   ┊            readAt: null,\n-┊412┊   ┊          },\n-┊413┊   ┊          {\n-┊414┊   ┊            userId: 6,\n-┊415┊   ┊            messageId: 3,\n-┊416┊   ┊            chatId: 8,\n-┊417┊   ┊            receivedAt: null,\n-┊418┊   ┊            readAt: null,\n-┊419┊   ┊          },\n+┊   ┊273┊          new Recipient({\n+┊   ┊274┊            user: user1,\n+┊   ┊275┊          }),\n+┊   ┊276┊          new Recipient({\n+┊   ┊277┊            user: user6,\n+┊   ┊278┊          }),\n ┊420┊279┊        ],\n-┊421┊   ┊        holderIds: [1, 4, 6],\n-┊422┊   ┊      },\n+┊   ┊280┊      }),\n ┊423┊281┊    ],\n-┊424┊   ┊  },\n-┊425┊   ┊  {\n-┊426┊   ┊    id: 9,\n-┊427┊   ┊    name: 'A user 5 group',\n-┊428┊   ┊    picture: null,\n-┊429┊   ┊    allTimeMemberIds: [6, 3],\n-┊430┊   ┊    listingMemberIds: [6, 3],\n-┊431┊   ┊    actualGroupMemberIds: [6, 3],\n-┊432┊   ┊    adminIds: [6],\n-┊433┊   ┊    ownerId: 6,\n-┊434┊   ┊    messages: [],\n-┊435┊   ┊  },\n-┊436┊   ┊];\n+┊   ┊282┊  }));\n ┊437┊283┊\n-┊438┊   ┊export const db = {users, chats};\n+┊   ┊284┊  await connection.manager.save(new Chat({\n+┊   ┊285┊    name: 'Ray\\'s group',\n+┊   ┊286┊    allTimeMembers: [user3, user6],\n+┊   ┊287┊    listingMembers: [user3, user6],\n+┊   ┊288┊    actualGroupMembers: [user3, user6],\n+┊   ┊289┊    admins: [user6],\n+┊   ┊290┊    owner: user6,\n+┊   ┊291┊  }));\n+┊   ┊292┊}\n```\n\n[}]: #\n\nIt's time to deal with resolvers:\n\n[{]: <helper> (diffStep \"6.1\" files=\"schema/resolvers.ts\" module=\"server\")\n\n#### [Step 6.1: TypeORM with PostgreSQL](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/00c4cab)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,91 +1,127 @@\n ┊  1┊  1┊import { PubSub, withFilter, IResolvers } from 'apollo-server-express';\n-┊  2┊   ┊import { Chat, db, Message, MessageType, Recipient, User } from \"../db\";\n+┊   ┊  2┊import { MessageType } from \"../db\";\n ┊  3┊  3┊import {\n ┊  4┊  4┊  AddChatMutationArgs, AddGroupMutationArgs, AddMessageMutationArgs, ChatQueryArgs, MessageAddedSubscriptionArgs,\n ┊  5┊  5┊  RemoveChatMutationArgs, RemoveMessagesMutationArgs\n ┊  6┊  6┊} from \"../types\";\n ┊  7┊  7┊import * as moment from \"moment\";\n-┊  8┊   ┊\n-┊  9┊   ┊let users = db.users;\n-┊ 10┊   ┊let chats = db.chats;\n+┊   ┊  8┊import { User } from \"../entity/User\";\n+┊   ┊  9┊import { Chat } from \"../entity/Chat\";\n+┊   ┊ 10┊import { Message } from \"../entity/Message\";\n+┊   ┊ 11┊import { Recipient } from \"../entity/Recipient\";\n+┊   ┊ 12┊import { Connection } from \"typeorm\";\n ┊ 11┊ 13┊\n ┊ 12┊ 14┊export const pubsub = new PubSub();\n ┊ 13┊ 15┊\n ┊ 14┊ 16┊export const resolvers: IResolvers = {\n ┊ 15┊ 17┊  Query: {\n ┊ 16┊ 18┊    // Show all users for the moment.\n-┊ 17┊   ┊    users: (obj: any, args: any, {user: currentUser}: {user: User}): User[] => users.filter(user => user.id !== currentUser.id),\n-┊ 18┊   ┊    chats: (obj: any, args: any, {user: currentUser}: {user: User}): Chat[] => chats.filter(chat => chat.listingMemberIds.includes(currentUser.id)),\n-┊ 19┊   ┊    chat: (obj: any, {chatId}: ChatQueryArgs): Chat | null => chats.find(chat => chat.id === Number(chatId)) || null,\n+┊   ┊ 19┊    users: async (obj: any, args: any, {user: currentUser, connection}: { user: User, connection: Connection }): Promise<User[]> => {\n+┊   ┊ 20┊      return await connection\n+┊   ┊ 21┊        .createQueryBuilder(User, \"user\")\n+┊   ┊ 22┊        .where('user.id != :id', {id: currentUser.id})\n+┊   ┊ 23┊        .getMany();\n+┊   ┊ 24┊    },\n+┊   ┊ 25┊    chats: async (obj: any, args: any, {user: currentUser, connection}: { user: User, connection: Connection }): Promise<any[]> => {\n+┊   ┊ 26┊      return await connection\n+┊   ┊ 27┊        .createQueryBuilder(Chat, \"chat\")\n+┊   ┊ 28┊        .leftJoin('chat.listingMembers', 'listingMembers')\n+┊   ┊ 29┊        .where('listingMembers.id = :id', {id: currentUser.id})\n+┊   ┊ 30┊        .getMany();\n+┊   ┊ 31┊    },\n+┊   ┊ 32┊    chat: async (obj: any, {chatId}: ChatQueryArgs, {connection}: { user: User, connection: Connection }): Promise<any> => {\n+┊   ┊ 33┊      return await connection\n+┊   ┊ 34┊        .createQueryBuilder(Chat, \"chat\")\n+┊   ┊ 35┊        .whereInIds(chatId)\n+┊   ┊ 36┊        .getOne();\n+┊   ┊ 37┊    },\n ┊ 20┊ 38┊  },\n ┊ 21┊ 39┊  Mutation: {\n-┊ 22┊   ┊    addChat: (obj: any, {recipientId}: AddChatMutationArgs, {user: currentUser}: {user: User}): Chat => {\n-┊ 23┊   ┊      if (!users.find(user => user.id === Number(recipientId))) {\n+┊   ┊ 40┊    addChat: async (obj: any, {recipientId}: AddChatMutationArgs, {user: currentUser, connection}: { user: User, connection: Connection }): Promise<Chat | null> => {\n+┊   ┊ 41┊      const recipient = await connection\n+┊   ┊ 42┊        .createQueryBuilder(User, \"user\")\n+┊   ┊ 43┊        .whereInIds(recipientId)\n+┊   ┊ 44┊        .getOne();\n+┊   ┊ 45┊\n+┊   ┊ 46┊      if (!recipient) {\n ┊ 24┊ 47┊        throw new Error(`Recipient ${recipientId} doesn't exist.`);\n ┊ 25┊ 48┊      }\n ┊ 26┊ 49┊\n-┊ 27┊   ┊      const chat = chats.find(chat => !chat.name && chat.allTimeMemberIds.includes(currentUser.id) && chat.allTimeMemberIds.includes(Number(recipientId)));\n+┊   ┊ 50┊      let chat = await connection\n+┊   ┊ 51┊        .createQueryBuilder(Chat, \"chat\")\n+┊   ┊ 52┊        .where('chat.name IS NULL')\n+┊   ┊ 53┊        .innerJoin('chat.allTimeMembers', 'allTimeMembers1', 'allTimeMembers1.id = :currentUserId', {currentUserId: currentUser.id})\n+┊   ┊ 54┊        .innerJoin('chat.allTimeMembers', 'allTimeMembers2', 'allTimeMembers2.id = :recipientId', {recipientId})\n+┊   ┊ 55┊        .innerJoinAndSelect('chat.listingMembers', 'listingMembers')\n+┊   ┊ 56┊        .getOne();\n+┊   ┊ 57┊\n ┊ 28┊ 58┊      if (chat) {\n-┊ 29┊   ┊        // Chat already exists. Both users are already in the allTimeMemberIds array\n-┊ 30┊   ┊        const chatId = chat.id;\n-┊ 31┊   ┊        if (!chat.listingMemberIds.includes(currentUser.id)) {\n+┊   ┊ 59┊        // Chat already exists. Both users are already in the userIds array\n+┊   ┊ 60┊        const listingMembers = await connection\n+┊   ┊ 61┊          .createQueryBuilder(User, \"user\")\n+┊   ┊ 62┊          .innerJoin('user.listingMemberChats', 'listingMemberChats', 'listingMemberChats.id = :chatId', {chatId: chat.id})\n+┊   ┊ 63┊          .getMany();\n+┊   ┊ 64┊\n+┊   ┊ 65┊        if (!listingMembers.find(user => user.id === currentUser.id)) {\n ┊ 32┊ 66┊          // The chat isn't listed for the current user. Add him to the memberIds\n-┊ 33┊   ┊          chat.listingMemberIds.push(currentUser.id);\n-┊ 34┊   ┊          chats.find(chat => chat.id === chatId)!.listingMemberIds.push(currentUser.id);\n-┊ 35┊   ┊          return chat;\n+┊   ┊ 67┊          chat.listingMembers.push(currentUser);\n+┊   ┊ 68┊          chat = await connection.getRepository(Chat).save(chat);\n+┊   ┊ 69┊\n+┊   ┊ 70┊          return chat || null;\n ┊ 36┊ 71┊        } else {\n ┊ 37┊ 72┊          throw new Error(`Chat already exists.`);\n ┊ 38┊ 73┊        }\n ┊ 39┊ 74┊      } else {\n ┊ 40┊ 75┊        // Create the chat\n-┊ 41┊   ┊        const id = (chats.length && chats[chats.length - 1].id + 1) || 1;\n-┊ 42┊   ┊        const chat: Chat = {\n-┊ 43┊   ┊          id,\n-┊ 44┊   ┊          name: null,\n-┊ 45┊   ┊          picture: null,\n-┊ 46┊   ┊          adminIds: null,\n-┊ 47┊   ┊          ownerId: null,\n-┊ 48┊   ┊          allTimeMemberIds: [currentUser.id, Number(recipientId)],\n+┊   ┊ 76┊        chat = await connection.getRepository(Chat).save(new Chat({\n+┊   ┊ 77┊          allTimeMembers: [currentUser, recipient],\n ┊ 49┊ 78┊          // Chat will not be listed to the other user until the first message gets written\n-┊ 50┊   ┊          listingMemberIds: [currentUser.id],\n-┊ 51┊   ┊          actualGroupMemberIds: null,\n-┊ 52┊   ┊          messages: [],\n-┊ 53┊   ┊        };\n-┊ 54┊   ┊        chats.push(chat);\n+┊   ┊ 79┊          listingMembers: [currentUser],\n+┊   ┊ 80┊        }));\n ┊ 55┊ 81┊\n-┊ 56┊   ┊        return chat;\n+┊   ┊ 82┊        return chat || null;\n ┊ 57┊ 83┊      }\n ┊ 58┊ 84┊    },\n-┊ 59┊   ┊    addGroup: (obj: any, {recipientIds, groupName}: AddGroupMutationArgs, {user: currentUser}: {user: User}): Chat => {\n-┊ 60┊   ┊      recipientIds.forEach(recipientId => {\n-┊ 61┊   ┊        if (!users.find(user => user.id === Number(recipientId))) {\n+┊   ┊ 85┊    addGroup: async (obj: any, {recipientIds, groupName}: AddGroupMutationArgs, {user: currentUser, connection}: { user: User, connection: Connection }): Promise<Chat | null> => {\n+┊   ┊ 86┊      let recipients: User[] = [];\n+┊   ┊ 87┊      for (let recipientId of recipientIds) {\n+┊   ┊ 88┊        const recipient = await connection\n+┊   ┊ 89┊          .createQueryBuilder(User, \"user\")\n+┊   ┊ 90┊          .whereInIds(recipientId)\n+┊   ┊ 91┊          .getOne();\n+┊   ┊ 92┊        if (!recipient) {\n ┊ 62┊ 93┊          throw new Error(`Recipient ${recipientId} doesn't exist.`);\n ┊ 63┊ 94┊        }\n-┊ 64┊   ┊      });\n+┊   ┊ 95┊        recipients.push(recipient);\n+┊   ┊ 96┊      }\n ┊ 65┊ 97┊\n-┊ 66┊   ┊      const id = (chats.length && chats[chats.length - 1].id + 1) || 1;\n-┊ 67┊   ┊      const chat: Chat = {\n-┊ 68┊   ┊        id,\n+┊   ┊ 98┊      const chat = await connection.getRepository(Chat).save(new Chat({\n ┊ 69┊ 99┊        name: groupName,\n-┊ 70┊   ┊        picture: null,\n-┊ 71┊   ┊        adminIds: [currentUser.id],\n-┊ 72┊   ┊        ownerId: currentUser.id,\n-┊ 73┊   ┊        allTimeMemberIds: [currentUser.id, ...recipientIds.map(id => Number(id))],\n-┊ 74┊   ┊        listingMemberIds: [currentUser.id, ...recipientIds.map(id => Number(id))],\n-┊ 75┊   ┊        actualGroupMemberIds: [currentUser.id, ...recipientIds.map(id => Number(id))],\n-┊ 76┊   ┊        messages: [],\n-┊ 77┊   ┊      };\n-┊ 78┊   ┊      chats.push(chat);\n+┊   ┊100┊        admins: [currentUser],\n+┊   ┊101┊        owner: currentUser,\n+┊   ┊102┊        allTimeMembers: [...recipients, currentUser],\n+┊   ┊103┊        listingMembers: [...recipients, currentUser],\n+┊   ┊104┊        actualGroupMembers: [...recipients, currentUser],\n+┊   ┊105┊      }));\n ┊ 79┊106┊\n ┊ 80┊107┊      pubsub.publish('chatAdded', {\n ┊ 81┊108┊        creatorId: currentUser.id,\n ┊ 82┊109┊        chatAdded: chat,\n ┊ 83┊110┊      });\n ┊ 84┊111┊\n-┊ 85┊   ┊      return chat;\n+┊   ┊112┊      return chat || null;\n ┊ 86┊113┊    },\n-┊ 87┊   ┊    removeChat: (obj: any, {chatId}: RemoveChatMutationArgs, {user: currentUser}: {user: User}): number => {\n-┊ 88┊   ┊      const chat = chats.find(chat => chat.id === Number(chatId));\n+┊   ┊114┊    removeChat: async (obj: any, {chatId}: RemoveChatMutationArgs, {user: currentUser, connection}: { user: User, connection: Connection }) => {\n+┊   ┊115┊      const chat = await connection\n+┊   ┊116┊        .createQueryBuilder(Chat, \"chat\")\n+┊   ┊117┊        .whereInIds(Number(chatId))\n+┊   ┊118┊        .innerJoinAndSelect('chat.listingMembers', 'listingMembers')\n+┊   ┊119┊        .leftJoinAndSelect('chat.actualGroupMembers', 'actualGroupMembers')\n+┊   ┊120┊        .leftJoinAndSelect('chat.admins', 'admins')\n+┊   ┊121┊        .leftJoinAndSelect('chat.owner', 'owner')\n+┊   ┊122┊        .leftJoinAndSelect('chat.messages', 'messages')\n+┊   ┊123┊        .leftJoinAndSelect('messages.holders', 'holders')\n+┊   ┊124┊        .getOne();\n ┊ 89┊125┊\n ┊ 90┊126┊      if (!chat) {\n ┊ 91┊127┊        throw new Error(`The chat ${chatId} doesn't exist.`);\n```\n```diff\n@@ -93,186 +129,188 @@\n ┊ 93┊129┊\n ┊ 94┊130┊      if (!chat.name) {\n ┊ 95┊131┊        // Chat\n-┊ 96┊   ┊        if (!chat.listingMemberIds.includes(currentUser.id)) {\n-┊ 97┊   ┊          throw new Error(`The user is not a member of the chat ${chatId}.`);\n+┊   ┊132┊        if (!chat.listingMembers.find(user => user.id === currentUser.id)) {\n+┊   ┊133┊          throw new Error(`The user is not a listing member of the chat ${chatId}.`);\n ┊ 98┊134┊        }\n ┊ 99┊135┊\n ┊100┊136┊        // Instead of chaining map and filter we can loop once using reduce\n-┊101┊   ┊        const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n-┊102┊   ┊          // Remove the current user from the message holders\n-┊103┊   ┊          message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser.id);\n+┊   ┊137┊        chat.messages = await chat.messages.reduce<Promise<Message[]>>(async (filtered$, message) => {\n+┊   ┊138┊          const filtered = await filtered$;\n ┊104┊139┊\n-┊105┊   ┊          if (message.holderIds.length !== 0) {\n+┊   ┊140┊          message.holders = message.holders.filter(user => user.id !== currentUser.id);\n+┊   ┊141┊\n+┊   ┊142┊          if (message.holders.length !== 0) {\n+┊   ┊143┊            // Remove the current user from the message holders\n+┊   ┊144┊            await connection.getRepository(Message).save(message);\n ┊106┊145┊            filtered.push(message);\n-┊107┊   ┊          } // else discard the message\n+┊   ┊146┊          } else {\n+┊   ┊147┊            // Simply remove the message\n+┊   ┊148┊            const recipients = await connection\n+┊   ┊149┊              .createQueryBuilder(Recipient, \"recipient\")\n+┊   ┊150┊              .innerJoinAndSelect('recipient.message', 'message', 'message.id = :messageId', {messageId: message.id})\n+┊   ┊151┊              .innerJoinAndSelect('recipient.user', 'user')\n+┊   ┊152┊              .getMany();\n+┊   ┊153┊            for (let recipient of recipients) {\n+┊   ┊154┊              await connection.getRepository(Recipient).remove(recipient);\n+┊   ┊155┊            }\n+┊   ┊156┊            await connection.getRepository(Message).remove(message);\n+┊   ┊157┊          }\n ┊108┊158┊\n ┊109┊159┊          return filtered;\n-┊110┊   ┊        }, []);\n+┊   ┊160┊        }, Promise.resolve([]));\n ┊111┊161┊\n ┊112┊162┊        // Remove the current user from who gets the chat listed. The chat will no longer appear in his list\n-┊113┊   ┊        const listingMemberIds = chat.listingMemberIds.filter(listingId => listingId !== currentUser.id);\n+┊   ┊163┊        chat.listingMembers = chat.listingMembers.filter(user => user.id !== currentUser.id);\n ┊114┊164┊\n ┊115┊165┊        // Check how many members are left\n-┊116┊   ┊        if (listingMemberIds.length === 0) {\n+┊   ┊166┊        if (chat.listingMembers.length === 0) {\n ┊117┊167┊          // Delete the chat\n-┊118┊   ┊          chats = chats.filter(chat => chat.id !== Number(chatId));\n+┊   ┊168┊          await connection.getRepository(Chat).remove(chat);\n ┊119┊169┊        } else {\n ┊120┊170┊          // Update the chat\n-┊121┊   ┊          chats = chats.map(chat => {\n-┊122┊   ┊            if (chat.id === Number(chatId)) {\n-┊123┊   ┊              chat = {...chat, listingMemberIds, messages};\n-┊124┊   ┊            }\n-┊125┊   ┊            return chat;\n-┊126┊   ┊          });\n+┊   ┊171┊          await connection.getRepository(Chat).save(chat);\n ┊127┊172┊        }\n-┊128┊   ┊        return Number(chatId);\n+┊   ┊173┊        return chatId;\n ┊129┊174┊      } else {\n ┊130┊175┊        // Group\n-┊131┊   ┊        if (chat.ownerId !== currentUser.id) {\n-┊132┊   ┊          throw new Error(`Group ${chatId} is not owned by the user.`);\n-┊133┊   ┊        }\n ┊134┊176┊\n ┊135┊177┊        // Instead of chaining map and filter we can loop once using reduce\n-┊136┊   ┊        const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n-┊137┊   ┊          // Remove the current user from the message holders\n-┊138┊   ┊          message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser.id);\n+┊   ┊178┊        chat.messages = await chat.messages.reduce<Promise<Message[]>>(async (filtered$, message) => {\n+┊   ┊179┊          const filtered = await filtered$;\n+┊   ┊180┊\n+┊   ┊181┊          message.holders = message.holders.filter(user => user.id !== currentUser.id);\n ┊139┊182┊\n-┊140┊   ┊          if (message.holderIds.length !== 0) {\n+┊   ┊183┊          if (message.holders.length !== 0) {\n+┊   ┊184┊            // Remove the current user from the message holders\n+┊   ┊185┊            await connection.getRepository(Message).save(message);\n ┊141┊186┊            filtered.push(message);\n-┊142┊   ┊          } // else discard the message\n+┊   ┊187┊          } else {\n+┊   ┊188┊            // Simply remove the message\n+┊   ┊189┊            const recipients = await connection\n+┊   ┊190┊              .createQueryBuilder(Recipient, \"recipient\")\n+┊   ┊191┊              .innerJoinAndSelect('recipient.message', 'message', 'message.id = :messageId', {messageId: message.id})\n+┊   ┊192┊              .innerJoinAndSelect('recipient.user', 'user')\n+┊   ┊193┊              .getMany();\n+┊   ┊194┊            for (let recipient of recipients) {\n+┊   ┊195┊              await connection.getRepository(Recipient).remove(recipient);\n+┊   ┊196┊            }\n+┊   ┊197┊            await connection.getRepository(Message).remove(message);\n+┊   ┊198┊          }\n ┊143┊199┊\n ┊144┊200┊          return filtered;\n-┊145┊   ┊        }, []);\n+┊   ┊201┊        }, Promise.resolve([]));\n ┊146┊202┊\n ┊147┊203┊        // Remove the current user from who gets the group listed. The group will no longer appear in his list\n-┊148┊   ┊        const listingMemberIds = chat.listingMemberIds.filter(listingId => listingId !== currentUser.id);\n+┊   ┊204┊        chat.listingMembers = chat.listingMembers.filter(user => user.id !== currentUser.id);\n ┊149┊205┊\n ┊150┊206┊        // Check how many members (including previous ones who can still access old messages) are left\n-┊151┊   ┊        if (listingMemberIds.length === 0) {\n+┊   ┊207┊        if (chat.listingMembers.length === 0) {\n ┊152┊208┊          // Remove the group\n-┊153┊   ┊          chats = chats.filter(chat => chat.id !== Number(chatId));\n+┊   ┊209┊          await connection.getRepository(Chat).remove(chat);\n ┊154┊210┊        } else {\n ┊155┊211┊          // Update the group\n ┊156┊212┊\n ┊157┊213┊          // Remove the current user from the chat members. He is no longer a member of the group\n-┊158┊   ┊          const actualGroupMemberIds = chat.actualGroupMemberIds!.filter(memberId => memberId !== currentUser.id);\n+┊   ┊214┊          chat.actualGroupMembers = chat.actualGroupMembers && chat.actualGroupMembers.filter(user => user.id !== currentUser.id);\n ┊159┊215┊          // Remove the current user from the chat admins\n-┊160┊   ┊          const adminIds = chat.adminIds!.filter(memberId => memberId !== currentUser.id);\n-┊161┊   ┊          // Set the owner id to be null. A null owner means the group is read-only\n-┊162┊   ┊          let ownerId: number | null = null;\n-┊163┊   ┊\n-┊164┊   ┊          // Check if there is any admin left\n-┊165┊   ┊          if (adminIds!.length) {\n-┊166┊   ┊            // Pick an admin as the new owner. The group is no longer read-only\n-┊167┊   ┊            ownerId = chat.adminIds![0];\n-┊168┊   ┊          }\n+┊   ┊216┊          chat.admins = chat.admins && chat.admins.filter(user => user.id !== currentUser.id);\n+┊   ┊217┊          // If there are no more admins left the group goes read only\n+┊   ┊218┊          chat.owner = chat.admins && chat.admins[0] || null; // A null owner means the group is read-only\n ┊169┊219┊\n-┊170┊   ┊          chats = chats.map(chat => {\n-┊171┊   ┊            if (chat.id === Number(chatId)) {\n-┊172┊   ┊              chat = {...chat, messages, listingMemberIds, actualGroupMemberIds, adminIds, ownerId};\n-┊173┊   ┊            }\n-┊174┊   ┊            return chat;\n-┊175┊   ┊          });\n+┊   ┊220┊          await connection.getRepository(Chat).save(chat);\n ┊176┊221┊        }\n-┊177┊   ┊        return Number(chatId);\n+┊   ┊222┊        return chatId;\n ┊178┊223┊      }\n ┊179┊224┊    },\n-┊180┊   ┊    addMessage: (obj: any, {chatId, content}: AddMessageMutationArgs, {user: currentUser}: {user: User}): Message => {\n+┊   ┊225┊    addMessage: async (obj: any, {chatId, content}: AddMessageMutationArgs, {user: currentUser, connection}: { user: User, connection: Connection }): Promise<Message | null> => {\n ┊181┊226┊      if (content === null || content === '') {\n ┊182┊227┊        throw new Error(`Cannot add empty or null messages.`);\n ┊183┊228┊      }\n ┊184┊229┊\n-┊185┊   ┊      let chat = chats.find(chat => chat.id === Number(chatId));\n+┊   ┊230┊      let chat = await connection\n+┊   ┊231┊        .createQueryBuilder(Chat, \"chat\")\n+┊   ┊232┊        .whereInIds(chatId)\n+┊   ┊233┊        .innerJoinAndSelect('chat.allTimeMembers', 'allTimeMembers')\n+┊   ┊234┊        .innerJoinAndSelect('chat.listingMembers', 'listingMembers')\n+┊   ┊235┊        .leftJoinAndSelect('chat.actualGroupMembers', 'actualGroupMembers')\n+┊   ┊236┊        .getOne();\n ┊186┊237┊\n ┊187┊238┊      if (!chat) {\n ┊188┊239┊        throw new Error(`Cannot find chat ${chatId}.`);\n ┊189┊240┊      }\n ┊190┊241┊\n-┊191┊   ┊      let holderIds = chat.listingMemberIds;\n+┊   ┊242┊      let holders: User[];\n ┊192┊243┊\n ┊193┊244┊      if (!chat.name) {\n ┊194┊245┊        // Chat\n-┊195┊   ┊        if (!chat.listingMemberIds.find(listingId => listingId === currentUser.id)) {\n+┊   ┊246┊        if (!chat.listingMembers.map(user => user.id).includes(currentUser.id)) {\n ┊196┊247┊          throw new Error(`The chat ${chatId} must be listed for the current user before adding a message.`);\n ┊197┊248┊        }\n ┊198┊249┊\n-┊199┊   ┊        const recipientId = chat.allTimeMemberIds.filter(userId => userId !== currentUser.id)[0];\n+┊   ┊250┊        const recipientUser = chat.allTimeMembers.find(user => user.id !== currentUser.id);\n ┊200┊251┊\n-┊201┊   ┊        if (!chat.listingMemberIds.find(listingId => listingId === recipientId)) {\n-┊202┊   ┊          // Chat is not listed for the recipient. Add him to the listingMemberIds\n-┊203┊   ┊          const listingMemberIds = chat.listingMemberIds.concat(recipientId);\n+┊   ┊252┊        if (!recipientUser) {\n+┊   ┊253┊          throw new Error(`Cannot find recipient user.`);\n+┊   ┊254┊        }\n ┊204┊255┊\n-┊205┊   ┊          chats = chats.map(chat => {\n-┊206┊   ┊            if (chat.id === Number(chatId)) {\n-┊207┊   ┊              chat = {...chat, listingMemberIds};\n-┊208┊   ┊            }\n-┊209┊   ┊            return chat;\n-┊210┊   ┊          });\n+┊   ┊256┊        if (!chat.listingMembers.find(user => user.id === recipientUser.id)) {\n+┊   ┊257┊          // Chat is not listed for the recipient. Add him to the listingIds\n+┊   ┊258┊          chat.listingMembers.push(recipientUser);\n ┊211┊259┊\n-┊212┊   ┊          holderIds = listingMemberIds;\n+┊   ┊260┊          await connection.getRepository(Chat).save(chat);\n ┊213┊261┊\n ┊214┊262┊          pubsub.publish('chatAdded', {\n ┊215┊263┊            creatorId: currentUser.id,\n ┊216┊264┊            chatAdded: chat,\n ┊217┊265┊          });\n ┊218┊266┊        }\n+┊   ┊267┊\n+┊   ┊268┊        holders = chat.listingMembers;\n ┊219┊269┊      } else {\n ┊220┊270┊        // Group\n-┊221┊   ┊        if (!chat.actualGroupMemberIds!.find(memberId => memberId === currentUser.id)) {\n+┊   ┊271┊        if (!chat.actualGroupMembers || !chat.actualGroupMembers.find(user => user.id === currentUser.id)) {\n ┊222┊272┊          throw new Error(`The user is not a member of the group ${chatId}. Cannot add message.`);\n ┊223┊273┊        }\n ┊224┊274┊\n-┊225┊   ┊        holderIds = chat.actualGroupMemberIds!;\n+┊   ┊275┊        holders = chat.actualGroupMembers;\n ┊226┊276┊      }\n ┊227┊277┊\n-┊228┊   ┊      const id = (chat.messages.length && chat.messages[chat.messages.length - 1].id + 1) || 1;\n-┊229┊   ┊\n-┊230┊   ┊      let recipients: Recipient[] = [];\n-┊231┊   ┊\n-┊232┊   ┊      holderIds.forEach(holderId => {\n-┊233┊   ┊        if (holderId !== currentUser.id) {\n-┊234┊   ┊          recipients.push({\n-┊235┊   ┊            userId: holderId,\n-┊236┊   ┊            messageId: id,\n-┊237┊   ┊            chatId: Number(chatId),\n-┊238┊   ┊            receivedAt: null,\n-┊239┊   ┊            readAt: null,\n-┊240┊   ┊          });\n-┊241┊   ┊        }\n-┊242┊   ┊      });\n-┊243┊   ┊\n-┊244┊   ┊      const message: Message = {\n-┊245┊   ┊        id,\n-┊246┊   ┊        chatId: Number(chatId),\n-┊247┊   ┊        senderId: currentUser.id,\n+┊   ┊278┊      const message = await connection.getRepository(Message).save(new Message({\n+┊   ┊279┊        chat: chat,\n+┊   ┊280┊        sender: currentUser,\n ┊248┊281┊        content,\n-┊249┊   ┊        createdAt: moment().unix(),\n ┊250┊282┊        type: MessageType.TEXT,\n-┊251┊   ┊        recipients,\n-┊252┊   ┊        holderIds,\n-┊253┊   ┊      };\n-┊254┊   ┊\n-┊255┊   ┊      chats = chats.map(chat => {\n-┊256┊   ┊        if (chat.id === Number(chatId)) {\n-┊257┊   ┊          chat = {...chat, messages: chat.messages.concat(message)}\n-┊258┊   ┊        }\n-┊259┊   ┊        return chat;\n-┊260┊   ┊      });\n+┊   ┊283┊        holders,\n+┊   ┊284┊        recipients: holders.reduce<Recipient[]>((filtered, user) => {\n+┊   ┊285┊          if (user.id !== currentUser.id) {\n+┊   ┊286┊            filtered.push(new Recipient({\n+┊   ┊287┊              user,\n+┊   ┊288┊            }));\n+┊   ┊289┊          }\n+┊   ┊290┊          return filtered;\n+┊   ┊291┊        }, []),\n+┊   ┊292┊      }));\n ┊261┊293┊\n ┊262┊294┊      pubsub.publish('messageAdded', {\n ┊263┊295┊        messageAdded: message,\n ┊264┊296┊      });\n ┊265┊297┊\n-┊266┊   ┊      return message;\n+┊   ┊298┊      return message || null;\n ┊267┊299┊    },\n-┊268┊   ┊    removeMessages: (obj: any, {chatId, messageIds, all}: RemoveMessagesMutationArgs, {user: currentUser}: {user: User}): number[] => {\n-┊269┊   ┊      const chat = chats.find(chat => chat.id === Number(chatId));\n+┊   ┊300┊    removeMessages: async (obj: any, {chatId, messageIds, all}: RemoveMessagesMutationArgs, {user: currentUser, connection}: { user: User, connection: Connection }) => {\n+┊   ┊301┊      const chat = await connection\n+┊   ┊302┊        .createQueryBuilder(Chat, \"chat\")\n+┊   ┊303┊        .whereInIds(chatId)\n+┊   ┊304┊        .innerJoinAndSelect('chat.listingMembers', 'listingMembers')\n+┊   ┊305┊        .innerJoinAndSelect('chat.messages', 'messages')\n+┊   ┊306┊        .innerJoinAndSelect('messages.holders', 'holders')\n+┊   ┊307┊        .getOne();\n ┊270┊308┊\n ┊271┊309┊      if (!chat) {\n ┊272┊310┊        throw new Error(`Cannot find chat ${chatId}.`);\n ┊273┊311┊      }\n ┊274┊312┊\n-┊275┊   ┊      if (!chat.listingMemberIds.find(listingId => listingId === currentUser.id)) {\n+┊   ┊313┊      if (!chat.listingMembers.find(user => user.id === currentUser.id)) {\n ┊276┊314┊        throw new Error(`The chat/group ${chatId} is not listed for the current user, so there is nothing to delete.`);\n ┊277┊315┊      }\n ┊278┊316┊\n```\n```diff\n@@ -280,79 +318,166 @@\n ┊280┊318┊        throw new Error(`Cannot specify both 'all' and 'messageIds'.`);\n ┊281┊319┊      }\n ┊282┊320┊\n+┊   ┊321┊      if (!all && !(messageIds && messageIds.length)) {\n+┊   ┊322┊        throw new Error(`'all' and 'messageIds' cannot be both null`);\n+┊   ┊323┊      }\n+┊   ┊324┊\n ┊283┊325┊      let deletedIds: number[] = [];\n-┊284┊   ┊      chats = chats.map(chat => {\n-┊285┊   ┊        if (chat.id === Number(chatId)) {\n-┊286┊   ┊          // Instead of chaining map and filter we can loop once using reduce\n-┊287┊   ┊          const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n-┊288┊   ┊            if (all || messageIds!.includes(String(message.id))) {\n-┊289┊   ┊              deletedIds.push(message.id);\n-┊290┊   ┊              // Remove the current user from the message holders\n-┊291┊   ┊              message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser.id);\n-┊292┊   ┊            }\n+┊   ┊326┊      // Instead of chaining map and filter we can loop once using reduce\n+┊   ┊327┊      chat.messages = await chat.messages.reduce<Promise<Message[]>>(async (filtered$, message) => {\n+┊   ┊328┊        const filtered = await filtered$;\n ┊293┊329┊\n-┊294┊   ┊            if (message.holderIds.length !== 0) {\n-┊295┊   ┊              filtered.push(message);\n-┊296┊   ┊            } // else discard the message\n+┊   ┊330┊        if (all || messageIds!.includes(String(message.id))) {\n+┊   ┊331┊          deletedIds.push(message.id);\n+┊   ┊332┊          // Remove the current user from the message holders\n+┊   ┊333┊          message.holders = message.holders.filter(user => user.id !== currentUser.id);\n ┊297┊334┊\n-┊298┊   ┊            return filtered;\n-┊299┊   ┊          }, []);\n-┊300┊   ┊          chat = {...chat, messages};\n ┊301┊335┊        }\n-┊302┊   ┊        return chat;\n-┊303┊   ┊      });\n+┊   ┊336┊\n+┊   ┊337┊        if (message.holders.length !== 0) {\n+┊   ┊338┊          // Remove the current user from the message holders\n+┊   ┊339┊          await connection.getRepository(Message).save(message);\n+┊   ┊340┊          filtered.push(message);\n+┊   ┊341┊        } else {\n+┊   ┊342┊          // Simply remove the message\n+┊   ┊343┊          const recipients = await connection\n+┊   ┊344┊            .createQueryBuilder(Recipient, \"recipient\")\n+┊   ┊345┊            .innerJoinAndSelect('recipient.message', 'message', 'message.id = :messageId', {messageId: message.id})\n+┊   ┊346┊            .innerJoinAndSelect('recipient.user', 'user')\n+┊   ┊347┊            .getMany();\n+┊   ┊348┊          for (let recipient of recipients) {\n+┊   ┊349┊            await connection.getRepository(Recipient).remove(recipient);\n+┊   ┊350┊          }\n+┊   ┊351┊          await connection.getRepository(Message).remove(message);\n+┊   ┊352┊        }\n+┊   ┊353┊\n+┊   ┊354┊        return filtered;\n+┊   ┊355┊      }, Promise.resolve([]));\n+┊   ┊356┊\n+┊   ┊357┊      await connection.getRepository(Chat).save(chat);\n+┊   ┊358┊\n ┊304┊359┊      return deletedIds;\n ┊305┊360┊    },\n ┊306┊361┊  },\n ┊307┊362┊  Subscription: {\n ┊308┊363┊    messageAdded: {\n ┊309┊364┊      subscribe: withFilter(() => pubsub.asyncIterator('messageAdded'),\n-┊310┊   ┊        ({messageAdded}: {messageAdded: Message & {chat: {id: number}}}, {chatId}: MessageAddedSubscriptionArgs, {user: currentUser}: { user: User }) => {\n+┊   ┊365┊        ({messageAdded}: {messageAdded: Message}, {chatId}: MessageAddedSubscriptionArgs, {user: currentUser}: { user: User }) => {\n ┊311┊366┊          return (!chatId || messageAdded.chat.id === Number(chatId)) &&\n-┊312┊   ┊            !!messageAdded.recipients.find((recipient: Recipient) => recipient.userId === currentUser.id);\n+┊   ┊367┊            !!messageAdded.recipients.find((recipient: Recipient) => recipient.user.id === currentUser.id);\n ┊313┊368┊        }),\n ┊314┊369┊    },\n ┊315┊370┊    chatAdded: {\n ┊316┊371┊      subscribe: withFilter(() => pubsub.asyncIterator('chatAdded'),\n-┊317┊   ┊        ({creatorId, chatAdded}: {creatorId: string, chatAdded: Chat}, variables: any, {user: currentUser}: { user: User }) => {\n-┊318┊   ┊          return Number(creatorId) !== currentUser.id && !chatAdded.listingMemberIds.includes(currentUser.id);\n+┊   ┊372┊        ({creatorId, chatAdded}: {creatorId: string, chatAdded: Chat}, variables, {user: currentUser}: { user: User }) => {\n+┊   ┊373┊          return Number(creatorId) !== currentUser.id &&\n+┊   ┊374┊            !!chatAdded.listingMembers.find((user: User) => user.id === currentUser.id);\n ┊319┊375┊        }),\n ┊320┊376┊    }\n ┊321┊377┊  },\n ┊322┊378┊  Chat: {\n-┊323┊   ┊    name: (chat: Chat, args: any, {user: currentUser}: {user: User}): string => chat.name ? chat.name : users\n-┊324┊   ┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser.id))!.name,\n-┊325┊   ┊    picture: (chat: Chat, args: any, {user: currentUser}: {user: User}) => chat.name ? chat.picture : users\n-┊326┊   ┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser.id))!.picture,\n-┊327┊   ┊    allTimeMembers: (chat: Chat): User[] => users.filter(user => chat.allTimeMemberIds.includes(user.id)),\n-┊328┊   ┊    listingMembers: (chat: Chat): User[] => users.filter(user => chat.listingMemberIds.includes(user.id)),\n-┊329┊   ┊    actualGroupMembers: (chat: Chat): User[] => users.filter(user => chat.actualGroupMemberIds && chat.actualGroupMemberIds.includes(user.id)),\n-┊330┊   ┊    admins: (chat: Chat): User[] => users.filter(user => chat.adminIds && chat.adminIds.includes(user.id)),\n-┊331┊   ┊    owner: (chat: Chat): User | null => users.find(user => chat.ownerId === user.id) || null,\n-┊332┊   ┊    messages: (chat: Chat, {amount = 0}: {amount: number}, {user: currentUser}: {user: User}): Message[] => {\n-┊333┊   ┊      const messages = chat.messages\n-┊334┊   ┊      .filter(message => message.holderIds.includes(currentUser.id))\n-┊335┊   ┊      .sort((a, b) => b.createdAt - a.createdAt) || <Message[]>[];\n-┊336┊   ┊      return (amount ? messages.slice(0, amount) : messages).reverse();\n+┊   ┊379┊    name: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<string | null> => {\n+┊   ┊380┊      if (chat.name) {\n+┊   ┊381┊        return chat.name;\n+┊   ┊382┊      }\n+┊   ┊383┊      const user = await connection\n+┊   ┊384┊        .createQueryBuilder(User, \"user\")\n+┊   ┊385┊        .where('user.id != :userId', {userId: currentUser.id})\n+┊   ┊386┊        .innerJoin('user.allTimeMemberChats', 'allTimeMemberChats', 'allTimeMemberChats.id = :chatId', {chatId: chat.id})\n+┊   ┊387┊        .getOne();\n+┊   ┊388┊      return user && user.name || null;\n+┊   ┊389┊    },\n+┊   ┊390┊    picture: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<string | null> => {\n+┊   ┊391┊      if (chat.name) {\n+┊   ┊392┊        return chat.picture;\n+┊   ┊393┊      }\n+┊   ┊394┊      const user = await connection\n+┊   ┊395┊        .createQueryBuilder(User, \"user\")\n+┊   ┊396┊        .where('user.id != :userId', {userId: currentUser.id})\n+┊   ┊397┊        .innerJoin('user.allTimeMemberChats', 'allTimeMemberChats', 'allTimeMemberChats.id = :chatId', {chatId: chat.id})\n+┊   ┊398┊        .getOne();\n+┊   ┊399┊      return user ? user.picture : null;\n+┊   ┊400┊    },\n+┊   ┊401┊    allTimeMembers: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User[]> => {\n+┊   ┊402┊      return await connection\n+┊   ┊403┊        .createQueryBuilder(User, \"user\")\n+┊   ┊404┊        .innerJoin('user.allTimeMemberChats', 'allTimeMemberChats', 'allTimeMemberChats.id = :chatId', {chatId: chat.id})\n+┊   ┊405┊        .getMany();\n+┊   ┊406┊    },\n+┊   ┊407┊    listingMembers: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User[]> => {\n+┊   ┊408┊      return await connection\n+┊   ┊409┊        .createQueryBuilder(User, \"user\")\n+┊   ┊410┊        .innerJoin('user.listingMemberChats', 'listingMemberChats', 'listingMemberChats.id = :chatId', {chatId: chat.id})\n+┊   ┊411┊        .getMany();\n+┊   ┊412┊    },\n+┊   ┊413┊    actualGroupMembers: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User[]> => {\n+┊   ┊414┊      return await connection\n+┊   ┊415┊        .createQueryBuilder(User, \"user\")\n+┊   ┊416┊        .innerJoin('user.actualGroupMemberChats', 'actualGroupMemberChats', 'actualGroupMemberChats.id = :chatId', {chatId: chat.id})\n+┊   ┊417┊        .getMany();\n+┊   ┊418┊    },\n+┊   ┊419┊    admins: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User[]> => {\n+┊   ┊420┊      return await connection\n+┊   ┊421┊        .createQueryBuilder(User, \"user\")\n+┊   ┊422┊        .innerJoin('user.adminChats', 'adminChats', 'adminChats.id = :chatId', {chatId: chat.id})\n+┊   ┊423┊        .getMany();\n ┊337┊424┊    },\n-┊338┊   ┊    unreadMessages: (chat: Chat, args: any, {user: currentUser}: {user: User}): number => chat.messages\n-┊339┊   ┊      .filter(message => message.holderIds.includes(currentUser.id) &&\n-┊340┊   ┊        message.recipients.find(recipient => recipient.userId === currentUser.id && !recipient.readAt))\n-┊341┊   ┊      .length,\n-┊342┊   ┊    isGroup: (chat: Chat): boolean => !!chat.name,\n+┊   ┊425┊    owner: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User | null> => {\n+┊   ┊426┊      return await connection\n+┊   ┊427┊        .createQueryBuilder(User, \"user\")\n+┊   ┊428┊        .innerJoin('user.ownerChats', 'ownerChats', 'ownerChats.id = :chatId', {chatId: chat.id})\n+┊   ┊429┊        .getOne() || null;\n+┊   ┊430┊    },\n+┊   ┊431┊    messages: async (chat: Chat, {amount = 0}: {amount: number}, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<Message[]> => {\n+┊   ┊432┊      const query = connection\n+┊   ┊433┊        .createQueryBuilder(Message, \"message\")\n+┊   ┊434┊        .innerJoin('message.chat', 'chat', 'chat.id = :chatId', {chatId: chat.id})\n+┊   ┊435┊        .innerJoin('message.holders', 'holders', 'holders.id = :userId', {userId: currentUser.id})\n+┊   ┊436┊        .orderBy({\"message.createdAt\": \"DESC\"});\n+┊   ┊437┊      return (amount ? await query.take(amount).getMany() : await query.getMany()).reverse();\n+┊   ┊438┊    },\n+┊   ┊439┊    unreadMessages: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<number> => {\n+┊   ┊440┊      return await connection\n+┊   ┊441┊        .createQueryBuilder(Message, \"message\")\n+┊   ┊442┊        .innerJoin('message.chat', 'chat', 'chat.id = :chatId', {chatId: chat.id})\n+┊   ┊443┊        .innerJoin('message.recipients', 'recipients', 'recipients.user.id = :userId AND recipients.readAt IS NULL', {userId: currentUser.id})\n+┊   ┊444┊        .getCount();\n+┊   ┊445┊    },\n+┊   ┊446┊    isGroup: (chat: Chat) => !!chat.name,\n ┊343┊447┊  },\n ┊344┊448┊  Message: {\n-┊345┊   ┊    chat: (message: Message): Chat | null => chats.find(chat => message.chatId === chat.id) || null,\n-┊346┊   ┊    sender: (message: Message): User | null => users.find(user => user.id === message.senderId) || null,\n-┊347┊   ┊    holders: (message: Message): User[] => users.filter(user => message.holderIds.includes(user.id)),\n-┊348┊   ┊    ownership: (message: Message, args: any, {user: currentUser}: {user: User}): boolean => message.senderId === currentUser.id,\n-┊349┊   ┊  },\n-┊350┊   ┊  Recipient: {\n-┊351┊   ┊    user: (recipient: Recipient): User | null => users.find(user => recipient.userId === user.id) || null,\n-┊352┊   ┊    message: (recipient: Recipient): Message | null => {\n-┊353┊   ┊      const chat = chats.find(chat => recipient.chatId === chat.id);\n-┊354┊   ┊      return chat ? chat.messages.find(message => recipient.messageId === message.id) || null : null;\n+┊   ┊449┊    sender: async (message: Message, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User | null> => {\n+┊   ┊450┊      return (await connection\n+┊   ┊451┊        .createQueryBuilder(User, \"user\")\n+┊   ┊452┊        .innerJoin('user.senderMessages', 'senderMessages', 'senderMessages.id = :messageId', {messageId: message.id})\n+┊   ┊453┊        .getOne()) || null;\n+┊   ┊454┊    },\n+┊   ┊455┊    ownership: async (message: Message, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<boolean> => {\n+┊   ┊456┊      return !!(await connection\n+┊   ┊457┊        .createQueryBuilder(User, \"user\")\n+┊   ┊458┊        .whereInIds(currentUser.id)\n+┊   ┊459┊        .innerJoin('user.senderMessages', 'senderMessages', 'senderMessages.id = :messageId', {messageId: message.id})\n+┊   ┊460┊        .getCount());\n+┊   ┊461┊    },\n+┊   ┊462┊    recipients: async (message: Message, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<Recipient[]> => {\n+┊   ┊463┊      return await connection\n+┊   ┊464┊        .createQueryBuilder(Recipient, \"recipient\")\n+┊   ┊465┊        .innerJoinAndSelect('recipient.message', 'message', 'message.id = :messageId', {messageId: message.id})\n+┊   ┊466┊        .innerJoinAndSelect('recipient.user', 'user')\n+┊   ┊467┊        .innerJoinAndSelect('recipient.chat', 'chat')\n+┊   ┊468┊        .getMany();\n+┊   ┊469┊    },\n+┊   ┊470┊    holders: async (message: Message, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User[]> => {\n+┊   ┊471┊      return await connection\n+┊   ┊472┊        .createQueryBuilder(User, \"user\")\n+┊   ┊473┊        .innerJoin('user.holderMessages', 'holderMessages', 'holderMessages.id = :messageId', {messageId: message.id})\n+┊   ┊474┊        .getMany();\n+┊   ┊475┊    },\n+┊   ┊476┊    chat: async (message: Message, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<Chat | null> => {\n+┊   ┊477┊      return (await connection\n+┊   ┊478┊        .createQueryBuilder(Chat, \"chat\")\n+┊   ┊479┊        .innerJoin('chat.messages', 'messages', 'messages.id = :messageId', {messageId: message.id})\n+┊   ┊480┊        .getOne()) || null;\n ┊355┊481┊    },\n-┊356┊   ┊    chat: (recipient: Recipient): Chat | null => chats.find(chat => recipient.chatId === chat.id) || null,\n ┊357┊482┊  },\n ┊358┊483┊};\n```\n\n[}]: #\n\n`QueryBuilder` is one of the most powerful features of `TypeORM` - it allows you to build SQL queries using elegant and convenient syntax, execute them and get automatically transformed entities.\n\nYou can find more informations on `TypeORM` on http://typeorm.io\n\nThe best part is that you won't have to do anything on the client, everything will be completely transparent to it, even if migrated from NoSQL-like db structure to a relational one!\nOf course, you could remove the custom normalization for the messages because now they have their own table and they are no longer embedded (so they have unique IDs), but we could leave it as well in order to be free to use any kind of backend."
          }
        ]
      },
      {
        "releaseVersion": "1.2.0",
        "releaseDate": "2018-10-11 09:43:33 +0200",
        "tagName": "master@1.2.0",
        "tagRevision": "cef7cc84a88228537fc3673dfb660ebd4a78fec2",
        "historyRevision": "0590068306f7cc4975f036f1d4373700d39c66d2",
        "changesDiff": "diff --git a/.tortilla/manuals/templates/step10.tmpl b/.tortilla/manuals/templates/step10.tmpl\nindex e87fd4d..fb5aff4 100644\n--- a/.tortilla/manuals/templates/step10.tmpl\n+++ b/.tortilla/manuals/templates/step10.tmpl\n@@ -1,13 +1,109 @@\n ## Client\n\n Did you notice that after creating a new message you'll have to refresh the page in order to see it?\n-How to fix that? If you thought about re-querying the server you would be wrong! The best solution is to use the response provided by the server to update our Apollo local cache.\n\n-Apollo performs two important core tasks: Executing queries and mutations, and caching the results.\n+How to fix that?\n\n-Thanks to Apollo’s store design, it’s possible for the results of a query or mutation to update your UI in all the right places. In many cases it’s possible for that to happen automatically, whereas in others you need to help the client out a little in doing so:\n+Apollo performs two important core tasks which we covered in one of previous steps: executing queries and mutations, and caching the results.\n+\n+Thanks to Apollo's store design, it's possible for the results of a query or mutation to update your UI in all the right places. In many cases it's possible for that to happen automatically, whereas in others you need to help the client out a little in doing so.\n+\n+There are couple of APIs to update the cache after mutation:\n+\n+- `refetchQueries` - is the most straightforward way of updating the cache. You request queries to be executed once again.\n+- `update` - super flexible and allows you to make changes to the store based on mutation. Works well with Optimistic UI which we will cover later.\n+- `updateQueries` - It works similar to the previous option but the API may be deprecated in the future and we recommend to stay with `update`.\n+\n+If you thought about re-querying the server you would be wrong! The best solution is to use the response provided by the server to update our Apollo local cache.\n+\n+Of course that we're going to use the `update` API!\n+\n+### Updating the store\n+\n+As you can see, the `update` option is a function that has two arguments:\n+\n+- `DataProxy` which we named `store`\n+- mutation's result\n+\n+The `DataProxy` seems very interesting! It's a middleman between you and the cache.\n+\n+#### How to update fragments\n+\n+In pretty much every case, that middleman would allow to write and read data. Take for example the JavaScript `Map` object.\n+\n+It has a `get` and `set` methods and both works based on a `key`.\n+\n+In Apollo, we do have that key, it's something that was covered in the 5th step, remember? An object of type `Message` with an `id` would be stored in the cache as `Message:<id>`.\n+\n+Let's call that small object a fragment, for simplicity.\n+\n+What are our _get_ and _set_ methods in Apollo's DataProxy? Simple, `readFragment` and `writeFragment`.\n+\n+I think it's time to work on a simple example. Scenario: every message can be liked and we keep the sum of likes under the `likes` field.\n+\n+How to give a like?\n+\n+```typescript\n+const store: DataProxy = ...;\n+const messageId = 256;\n+\n+const fragment = gql`\n+  fragment M on Message {\n+    likes\n+  }\n+`;\n+const fragmentId = `Message:${messageId}`;\n+\n+const message = store.readFragment({\n+  fragment,\n+  id: fragmentId\n+});\n+\n+store.writeFragment({\n+  fragment,\n+  id: fragmentId,\n+  data: {\n+    likes: message.likes + 1\n+  }\n+});\n+```\n+\n+What just happened?!\n+\n+At first, it might seem weird to talk to the store like that but you will see that it makes a lot of sense!\n+\n+ - `messageId` - defined the actual id of our message\n+ - `fragment` - it's a document that tells Apollo what fields we want to read and write\n+ - `fragmentId` - an unique key under which the fragment is stored (we covered that in 5th step)\n+ - `readFragment` - reads the fragment in the store and returns the result in exact same shape as requested\n+ - `writeFragment` - accepts same properties as `readFragment` but also the `data` property\n+\n+### How to update queries\n+\n+Similar as in case of fragments, we update queries with `readQuery` and `writeQuery`.\n+\n+We won't cover the same thing again but let's just look at the API based on our WhatsApp clone example:\n\n {{{ diffStep \"6.1\" module=\"client\" }}}\n\n+As you can see we used the `document` property of a generated GQL service. It contains the actual query that is used in every `watch` or `fetch` calls of the GQL service. It's a part of the open API.\n+\n+### Keep on mind\n+\n+It's very important to know few things:\n+\n+- update function have to run synchronously\n+- the query should always match the query you want to update (even order of fields or variables matters)\n+- by updating a query you also update every normalized data it has (we called them fragments in few secions above)\n+\n+When Apollo runs the `update` function? In two cases, rigth after the mutation happens but only if it has an optimistic response defined, and also once we get the response from the server.\n+\n+> Optimistic Resposne is something we will cover in next steps but so you know, Apollo allows to optimistically update the store with a temporary data that is being replaced right after we get the response from the server.\n+\n+But why the update function has to run synchornously? It's by design and not so interesting. We won't cover it in-depth here but in short, when Apollo runs the function it switches the store with the new, empty one, to record every change that's made by the function to later merge it with the original store. If you still have questions, please let us know so we can cover that thing in-depth as a blog post or even a separate chapter in that tutorial.\n+\n+### Summary\n+\n Now you won't need to reload the page in order to see the new message. What's even more interesting is that the message you wrote would also be shown as the last message in the chats list, just hit the back button in the top-left corner to find out!\n-This is because we updated our store for both the `GetChat` and the `GetChats` query.\n\\ No newline at end of file\n+\n+This is because we updated our store for both the `GetChat` and the `GetChats` query.\ndiff --git a/.tortilla/manuals/templates/step11.tmpl b/.tortilla/manuals/templates/step11.tmpl\nindex fd33d28..aeff7ff 100644\n--- a/.tortilla/manuals/templates/step11.tmpl\n+++ b/.tortilla/manuals/templates/step11.tmpl\n@@ -2,29 +2,45 @@\n\n Since we're now familiar with the way mutations work, it's time to add messages and chats removal to our list of features!\n Since the most annoying part is going to be dealing with the user interface (because a multiple selection started by a press event is involved), I created an Angular directive to ease the process.\n-Let's start by installing it:\n\n-    $ npm install ngx-selectable-list\n+Let's start by adding `ngx-selectable-list`:\n\n-Now let's import it:\n+    yarn add ngx-selectable-list\n\n-{{{ diffStep \"7.1\" module=\"client\" files=\"^(?!package.json$).*\" }}}\n+{{{ diffStep \"7.1\" module=\"client\" }}}\n\n-Let's create the mutations:\n+Because we're going to use the `libSelectableList` directive, we can replace Outputs and EventEmitters with it:\n\n-{{{ diffStep \"7.2\" module=\"client\" files=\"src/graphql\" }}}\n+{{{ diffStep \"7.2\" module=\"client\" files=\"src/app/chats-lister/components/chat-item/chat-item.component.ts, src/app/chats-lister/components/chats-list/chats-list.component.ts, src/app/chat-viewer/components/messages-list/messages-list.component.ts\" }}}\n\n-Now let's update our service:\n+Don't forget to add the `NgxSelectableListModule` to `ChatViewer` and `ChatLister` modules.\n\n-{{{ diffStep \"7.2\" module=\"client\" files=\"chats.service.ts\" }}}\n+We also created a `ConfirmSelectionComponent` to use for content projection, since our selectable list directive will be able to listen to its events.\n\n-As you can see every time that we remove a message we also have to update the last message in the chats list.\n+{{{ diffStep \"7.2\" module=\"client\" files=\"src/app/shared/components/confirm-selection/confirm-selection.component.scss, src/app/shared/components/confirm-selection/confirm-selection.component.ts, src/app/shared/shared.module.ts\" }}}\n\n-Finally we can wire everything up into our components:\n+Great, let's finish the component part by adding the connection between our container components and the `ChatsService`. We're going to use `removeMessages` and `removeChat` methods.\n\n-{{{ diffStep \"7.2\" module=\"client\" files=\"src/app/chat-viewer, src/app/chats-lister, src/app/shared\" }}}\n+{{{ diffStep \"7.2\" module=\"client\" files=\"src/app/chat-viewer/containers/chat/chat.component.ts, src/app/chat-viewer/containers/chat/chat.component.spec.ts, src/app/chats-lister/containers/chats/chats.component.ts, src/app/chats-lister/containers/chats/chats.component.spec.ts\"}}}\n+\n+### Connecting actions with the server\n+\n+The UI part is pretty much complete but we still need to implement two methods in the `ChatsService`. We're going to create mutations to remove a chat, selected messages or all of them.\n+\n+{{{ diffStep \"7.2\" module=\"client\" files=\"src/graphql/removeChat.mutation.ts, src/graphql/removeMessages.mutation.ts, src/graphql/removeAllMessages.mutation.ts\" }}}\n+\n+Once again, we run the GraphQL Code Generator to get the GQL services:\n+\n+    yarn generator\n+\n+Now we can import those services, create `removeChat` and `removeMessages` methods in which we call a mutation.\n+\n+{{{ diffStep \"7.2\" module=\"client\" files=\"src/app/services/chats.service.ts\" }}}\n+\n+It might seem like a lot but we simply just updating the store there.\n+\n+### Summary\n\n-We also created a `ConfirmSelectionComponent` to use for content projection, since our selectable list directive will be able to listen to its events.\n The selectable list directive supports much more different use cases, for info please read the documentation.\n\n As you can see `ngx-selectable-list` takes care of most of the boilerplate, giving us the freedom to concentrate on the actual code.\n\\ No newline at end of file\ndiff --git a/.tortilla/manuals/templates/step12.tmpl b/.tortilla/manuals/templates/step12.tmpl\nindex 896a39e..89e1449 100644\n--- a/.tortilla/manuals/templates/step12.tmpl\n+++ b/.tortilla/manuals/templates/step12.tmpl\n@@ -1,17 +1,51 @@\n We still cannot create new chats or groups, so let's implement it.\n+\n We're going to create a `ChatsCreation` module, with a `NewChat` and a `NewGroup` containers, along with several presentational components.\n+\n We're going to make use of the selectable list directive once again, to ease selecting the users when we're creating a new group.\n You should also notice that we are looking for existing chats before creating a new one: if it already exists we're are simply redirecting to that chat instead of creating a new one (the server wouldn't allow that anyway and it will simply\n return the chat id).\n\n-{{{ diffStep \"8.1\" module=\"client\" files=\"src/graphql\" }}}\n+{{{ diffStep \"8.1\" module=\"client\" files=\"src/graphql/\" }}}\n+\n+After creating the mutations we should run the generator to create the corresponding types and services:\n+\n+    yarn generator\n+\n+Let's jump straight into `ChatsService` and add few new methods:\n+\n+{{{ diffStep \"8.1\" module=\"client\" files=\"src/app/services/chats.service.ts\" }}}\n+\n+Okay, now since we got the GraphQL part ready, we're going to focus on the component.\n+\n+First, space to add a new group:\n+\n+{{{ diffStep \"8.1\" module=\"client\" files=\"src/app/chats-creation/containers/new-group/new-group.component.ts, src/app/chats-creation/containers/new-group/new-group.component.scss\" }}}\n\n-After creating the mutations we should run the generator to create the corresponding types:\n+Next, a new chat view:\n\n-    npm run generator\n+src/app/chats-creation/containers/new-chat/new-chat.component.scss, src/app/chats-creation/containers/new-chat/new-chat.component.ts\n\n {{{ diffStep \"8.1\" module=\"client\" files=\"src/app/app.module.ts, src/app/chats-creation, src/app/services\" }}}\n\n-Finally we should update our tests:\n+They're both missing few components:\n+\n+**UsersList**\n+\n+{{{ diffStep \"8.1\" module=\"client\" files=\"src/app/chats-creation/components/users-list/users-list.component.ts, src/app/chats-creation/components/users-list/users-list.component.scss\" }}}\n+\n+**UserItem**\n+\n+{{{ diffStep \"8.1\" module=\"client\" files=\"src/app/chats-creation/components/user-item/user-item.component.ts, src/app/chats-creation/components/user-item/user-item.component.scss\" }}}\n+\n+**NewGroupDetails**\n+\n+{{{ diffStep \"8.1\" module=\"client\" files=\"src/app/chats-creation/components/new-group-details/new-group-details.component.ts, src/app/chats-creation/components/new-group-details/new-group-details.component.scss\" }}}\n+\n+With all that, we can now link NewChat component with Chat container:\n+\n+{{{ diffStep \"8.1\" module=\"client\" files=\"src/app/chats-lister/containers/chats/chats.component.ts, src/app/chat-viewer/containers/chat/chat.component.spec.ts\" }}}\n+\n+Now let's wrap it all together within the `ChatsCreation` module:\n\n-{{{ diffStep \"8.1\" module=\"client\" files=\"src/app/chat-viewer/containers/chat/chat.component.spec.ts\" }}}\n+{{{ diffStep \"8.1\" module=\"client\" files=\"src/app/chats-creation/chats-creation.module.ts, src/app/app.module.ts\" }}}\ndiff --git a/.tortilla/manuals/templates/step13.tmpl b/.tortilla/manuals/templates/step13.tmpl\nindex 5708027..1f4e2c7 100644\n--- a/.tortilla/manuals/templates/step13.tmpl\n+++ b/.tortilla/manuals/templates/step13.tmpl\n@@ -2,20 +2,24 @@\n\n Now let's start our client in production mode:\n\n-    $ ng serve --prod\n+    yarn start --prod\n+\n+Now open the **Chrome Developers Tools** and, in the **Network tab**, select `Slow 3G Network` and `Disable cache`.\n+Then refresh the page and look at the `DOMContentLoaded` time and at the transferred size. You'll notice that our bundle size is quite small and so the loads time.\n+\n+Now let's click on a specific chat. It will take some time to load the data and then add a new message.\n+Once again it will take some time to load the data.\n+We could also create a new chat and the result would be the same.\n+The whole app doesn't feel as snappier as the real Whatsapp on a slow 3G Network.\n\n-Now open the Chrome Developers Tools and, in the Network tab, select 'Slow 3G Network' and 'Disable cache'.\n-Now refresh the page and look at the DOMContentLoaded time and at the transferred size. You'll notice that our bundle size is quite small and so the loads time.\n-Now let's click on a specific chat. It will take some time to load the data. Now let's add a new message. Once again it will take some time to load the data. We could also create a new chat and the result would be the same. The whole app doesn't\n-feel as snappier as the real Whatsapp on a slow 3G Network.\n \"That's normal, it's a web application with a remote db while Whatsapp is a native app with a local database...\"\n That's just an excuse, because we can do as good as Whatsapp thanks to Apollo!\n\n Let's install `moment`, we will soon need it:\n\n-    $ npm install moment\n+    yarn add moment\n\n-Let's start by making our UI optimistic. We can predict most of the response we will get from our server, except for a few things like `id` of newly created messages. But since we don't really need that id, we can simply generate a fake one\n+Start by making our UI optimistic. We can predict most of the response we will get from our server, except for a few things like `id` of newly created messages. But since we don't really need that id, we can simply generate a fake one\n which will be later overridden once we get the response from the server:\n\n {{{ diffStep \"9.1\" module=\"client\" files=\"^(?!package.json$).*\" }}}\n@@ -24,6 +28,12 @@ When we open a specific chat we can also preload some data from our chats list c\n\n {{{ diffStep \"9.2\" module=\"client\" }}}\n\n-Now let's deal with the most difficult part: what about chats creation? We cannot predict the `id` of the new chat and so we cannot navigate to the chat page because it contains the chat id in the url. We could simply navigate to the \"optimistic\" id, but then the user wouldn't be able to reach that url if he refreshes the page or bookmarks it. That's a problem we care about. How to solve it? We're going to create a landing page and we will later override the url once we get the response from the server!\n+Now let's deal with the most difficult part, chats creation.\n+\n+We cannot predict the `id` of the new chat and so we cannot navigate to the chat page because it contains the chat id in the url. We could simply navigate to the \"optimistic\" id, but then the user wouldn't be able to reach that url if he refreshes the page or bookmarks it. That's a problem we care about.\n+\n+How to solve it? We're going to create a landing page and we will later override the url once we get the response from the server!\n+\n+{{{ diffStep \"9.3\" module=\"client\" }}}\n\n-{{{ diffStep \"9.3\" module=\"client\" }}}\n\\ No newline at end of file\n+Poof, now our Whatsapp clone feels no more like a clone it has the same native feel.\n\\ No newline at end of file\ndiff --git a/.tortilla/manuals/templates/step14.tmpl b/.tortilla/manuals/templates/step14.tmpl\nindex 79efac8..43bf21b 100644\n--- a/.tortilla/manuals/templates/step14.tmpl\n+++ b/.tortilla/manuals/templates/step14.tmpl\n@@ -1,12 +1,12 @@\n-## Server\n+## Authentication on server\n\n Authentication is an hot topic in the GraphQL world and there are some projects which aim at authenticating through GraphQL.\n Since often you will be required to use a specific auth framework (because of a feature you need or because of an existing authorization infrastructure) I will show you how to use a classic REST API framework within your GraphQL application.\n This approach is completely fine and in line with the official GraphQL best practices.\n We will use `Passport` for the authentication and `BasicAuth` as the auth mechanism:\n\n-    npm install bcrypt-nodejs passport passport-http\n-    npm install --save-dev @types/bcrypt-nodejs @types/passport @types/passport-http\n+    yarn add bcrypt-nodejs passport passport-http\n+    yarn add -D @types/bcrypt-nodejs @types/passport @types/passport-http\n\n `BasicAuth` basically involves to send username e password in an Authorization Header together with each request and is fully supported by any browser (meaning that we will be able to use `Graphiql` simply by proving username and password in the login window provided by the browser itself).\n It's the most simple auth mechanism but it's completely fine for our needs. Later we could decide to use something more complicated like `JWT`, but it's outside of the scope of this tutorial.\n@@ -22,24 +22,27 @@ What's of particular interest is that we're passing the user object to the Graph\n\n In the resolvers we're basically making use of the user object taken from the context.\n\n-## Client\n+## Authentication on client\n\n Let's start installing `@angular/flex-layout`, because we will use it later:\n\n-    $ npm install @angular/flex-layout\n+    yarn add @angular/flex-layout\n\n-First of all we need to create an HTTP Interceptor, which will intercept every HTTP request and will add authentication headers.\n-For the moment we still don't have those headers, but we are going to store them in the LocalStorage later.\n-We are also creating an AuthGuard, which we will use to stop the user from reaching unauthorized Routes.\n-The AuthGuard will simply look for the presence of the Authentication Header, but will not guarantee that the header is authentic.\n+\n+First of all we need to create an `HTTP Interceptor`, which will intercept every HTTP request and will add authentication headers.\n+For the moment we still don't have those headers, but we are going to store them in the `LocalStorage` later.\n+We are also creating an `AuthGuard`, which we will use to stop the user from reaching unauthorized Routes.\n+\n+The `AuthGuard` will simply look for the presence of the `Authentication` Header, but will not guarantee that the header is authentic.\n This is no problem, because client side AuthGuards are not safe by design and the real authentication will be done server side anyway.\n AuthGuards are here just to redirect the user to the Login page.\n+\n The service we are going to create will contain some auth methods we are going to use across the app.\n\n {{{ diffStep \"10.1\" module=\"client\" files=\"src/app/login/services\" }}}\n\n-Now it's time to create a SignIn/SignUp component. Since we use Passport in the server we are going to make REST calls for the authentication, instead of using GraphQL.\n-Since we use Basic Auth we will simply combine the username and the password together to create the authentication header.\n+Now it's time to create a `SignIn`/`SignUp` component. Since we use Passport in the server we are going to make REST calls for the authentication, instead of using GraphQL.\n+Since we use `Basic Auth` we will simply combine the username and the password together to create the authentication header.\n We will also store the response from the server, which will contain the user information like the ID, etc. which we are going to need later.\n\n {{{ diffStep \"10.1\" module=\"client\" files=\"src/app/login/containers, src/app/login/login.module.ts\" }}}\n@@ -48,14 +51,46 @@ Now it's time use the Interceptor we just created:\n\n {{{ diffStep \"10.1\" module=\"client\" files=\"src/app/app.module.ts\" }}}\n\n-As well as the AuthGuard:\n+As well as the `AuthGuard`:\n\n {{{ diffStep \"10.1\" module=\"client\" files=\"src/app/chat-viewer/chat-viewer.module.ts, src/app/chats-creation/chats-creation.module.ts, src/app/chats-lister/chats-lister.module.ts\" }}}\n\n-Last but not the least we need to fix our main service in order to not use the hardcoded user anymore. Instead we will use our Login service to read the user info from the LocalStorage.\n+Last but not the least we need to fix our main service in order to not use the hardcoded user anymore. Instead we will use our Login service to read the user info from the `LocalStorage`.\n\n {{{ diffStep \"10.1\" module=\"client\" files=\"src/app/services/chats.service.ts\" }}}\n\n We also need to fix our tests:\n\n-{{{ diffStep \"10.1\" module=\"client\" files=\"src/app/chat-viewer/containers/chat/chat.component.spec.ts, src/app/chats-lister/containers/chats/chats.component.spec.ts, src/app/services/chats.service.spec.ts\" }}}\n\\ No newline at end of file\n+{{{ diffStep \"10.1\" module=\"client\" files=\"src/app/chat-viewer/containers/chat/chat.component.spec.ts, src/app/chats-lister/containers/chats/chats.component.spec.ts, src/app/services/chats.service.spec.ts\" }}}\n+\n+\n+### GraphQL Server behind a firewall\n+\n+There's still one thing remaining. Our GraphQL Code Generator setup is broken now. That's because every made request to the server has to have proper rights and currently the codegen's request introspection query is not authenticated. In short, we need to attach an `Authorization` header.\n+\n+We're going to implement the following scenario:\n+\n+1. User runs `yarn generator`\n+1. He is asked for a _username_ and a _password_\n+1. Our script generates an _Authorization_ header\n+1. GraphQL Code Generator get the GraphQL Schema of our server and outputs the types\n+\n+To achieve the goal, we need to change the way we interact with the codegen.\n+Right now we use GraphQL Code Generator's CLI but the tool allows to use it programatically. So one issue solved.\n+\n+What about getting user's name and password part? We will use in-terminal prompt so user can type those. There's a package for that:\n+\n+    yarn add -D prompt\n+\n+Next, create a `src/codegen.ts` file and write our script there:\n+\n+{{{ diffStep \"10.1\" module=\"client\" files=\"src/codegen.ts\" }}}\n+\n+Let's take a closer look what we did there:\n+\n+- We asks user for a _username_ and a _password_ with `prompt`\n+- Based on that we generate a header\n+- We put the header in `generate` function\n+- there's a `true` value as the second argument, it tells codegen to write the output to a file\n+\n+With all of that, whenever we run `yarn generator`, we access the GraphQL server as an authenticated user.\ndiff --git a/.tortilla/manuals/templates/step15.tmpl b/.tortilla/manuals/templates/step15.tmpl\nindex dd87acf..4c84456 100644\n--- a/.tortilla/manuals/templates/step15.tmpl\n+++ b/.tortilla/manuals/templates/step15.tmpl\n@@ -30,7 +30,7 @@ The `chatAdded` subscription is similar: we will publish each time that a group\n\n In order to use WebSockets we will need to install a couple of dependencies:\n\n-    $ npm install apollo-link-ws apollo-utilities subscriptions-transport-ws\n+    yarn add apollo-link-ws apollo-utilities subscriptions-transport-ws\n\n First let's create the queries for the GraphQL Subscriptions:\n\n@@ -38,7 +38,7 @@ First let's create the queries for the GraphQL Subscriptions:\n\n Then we need to run `graphql-code-generator` to generate the types:\n\n-    $ npm run generator\n+    yarn generator\n\n Now we can update the chats service to update the getChats query every time that we receive a new chat from the subscription.\n With GraphQL subscriptions your client will be alerted on push from the server and you should choose the pattern that fits your application the most:\n@@ -52,10 +52,12 @@ We will do to do the same for the newMessage subscription, but this time we will\n\n {{{ diffStep \"11.1\" module=\"client\" files=\"src/app/services/chats.service.ts\" }}}\n\n-We can finally configure the WebSocket in the app module. Please notice that the WebSocket has its own authentication instead of using the HttpInterceptor, in fact we use `connectionParams` to send the authorization.\n+We can finally configure the WebSocket in the GraphQL Module. Please notice that the WebSocket has its own authentication instead of using the `HttpInterceptor`, in fact we use `connectionParams` to send the authorization.\n All queries will go through HTTP except the Subscriptions, which will use the WebSocket.\n\n-{{{ diffStep \"11.1\" module=\"client\" files=\"src/app/app.module.ts\" }}}\n+{{{ diffStep \"11.1\" module=\"client\" files=\"src/app/graphql.module.ts\" }}}\n+\n+We used `split` of ApolloLink to decide which path should a request get, through WebSocket or HTTP. We decided to push subscriptions over the WebSocket and the rest normally, just like before.\n\n Finally, let's fix the tests:\n\ndiff --git a/.tortilla/manuals/templates/step16.tmpl b/.tortilla/manuals/templates/step16.tmpl\nindex f7c3935..6a7638c 100644\n--- a/.tortilla/manuals/templates/step16.tmpl\n+++ b/.tortilla/manuals/templates/step16.tmpl\n@@ -4,8 +4,8 @@ First of all you will have to install PostgreSQL on your operating system. Since\n\n Then you will have to install a couple of packages:\n\n-    npm install pg reflect-metadata typeorm\n-    npm install --save-dev @types/pg\n+    yarn add pg reflect-metadata typeorm\n+    yarn add -D @types/pg\n\n We aren't going to use plain SQL, instead we will use an Object-relational mapping framework (ORM) called `TypeORM`.\n `TypeORM` takes advantage of Typescript classes and type declarations in order to infer the db structure.\ndiff --git a/.tortilla/manuals/templates/step3.tmpl b/.tortilla/manuals/templates/step3.tmpl\nindex eb29a4a..a81ff7e 100644\n--- a/.tortilla/manuals/templates/step3.tmpl\n+++ b/.tortilla/manuals/templates/step3.tmpl\n@@ -2,26 +2,67 @@ Now we can start writing code!\n\n But like we said before, software is build in layers and instead of starting from nothing, we can use existing software with prepared structure.\n\n+## Tools\n+\n First let’s install some software that we need on our computer:\n\n+### Windows\n+\n+The following instructions are for computers with the Windows operating system.\n+\n+First let's start by installing node.js. You need to download an installer, by visiting:\n+\n+    https://nodejs.org/en/download/\n+\n+Same, with Yarn:\n+\n+    https://yarnpkg.com/en/docs/install#windows-stable\n+\n+\n+### Linux\n+\n The following instructions are for computers with the Arch Linux operating system, so your mileage may vary.\n\n-First let's start by installing npm and node.js, as simple as `# pacman -S nodejs npm`.\n+First let's start by installing npm and node.js, as simple as\n+\n+    # NodeJS\n+    pacman -S nodejs npm\n+\n+    # Yarn\n+    pacman -S yarn\n+\n+\n+### MacOS\n+\n+The following instructions are for computers with the MacOS operating system:\n+\n+    # NodeJS\n+    brew install node\n+\n+    # Yarn\n+    brew install yarn --without-node\n+\n+\n+## Packages\n\n Then we will need a way to install our npm global packages on a per-user basis, instead of relying on sudo: https://github.com/sindresorhus/guides/blob/master/npm-global-without-sudo.md\n\n-Now it's the right moment to install a couple of global packages we will need later on: `npm install -g @angular/cli node-sass tortilla typescript`\n+Now it's the right moment to install a couple of global packages we will need later on:\n+\n+    yarn global add @angular/cli node-sass tortilla typescript\n+\n\n ## IDE\n\n-Now it's time to choose our IDE. I suggest you Webstorm, but it's paid software with a kind-of perpetual EAP (Early Access Preview) available for free: https://blog.jetbrains.com/webstorm/category/eap/\n-If you decide to start using Webstorm keep in mind that sooner or later you'll have to start paying an annual subscription because EAPs are not always available.\n-To have a look at some of the Webstorm features you can have a look at those videos: https://www.jetbrains.com/webstorm/documentation/\n+Now it's time to choose our IDE. I suggest you VSCode, it's available for free: https://code.visualstudio.com/.\n+To have a look at some of the VSCode features you can have a look at the documentation: https://code.visualstudio.com/docs.\n\n-Another, completely free (as in freedom) alternative is VSCode: https://code.visualstudio.com/\n-For most things it's as good as Webstorm, for others (like type inference) it's even better. Unfortunately it lacks most of the Webstorm features.\n+VSCode team prepared an Interactive Playground where you can learn what the editor is cappable of and play with it. I highly recommend to check it out!\n\n-At the end the choice is yours.\n+    Toolbar: Help > Interactive Playground\n+\n+There are also many IDEs to recommend and at the end the choice is yours.\n\n ## Mobile\n+\n We will talk once again about scaffolding once we will introduce `Android` and `Cordova`.\ndiff --git a/.tortilla/manuals/templates/step5.tmpl b/.tortilla/manuals/templates/step5.tmpl\nindex 70fed19..9485eda 100644\n--- a/.tortilla/manuals/templates/step5.tmpl\n+++ b/.tortilla/manuals/templates/step5.tmpl\n@@ -3,8 +3,8 @@\n After the planning phase it's finally time to start writing some real code!\n We'll start with the server, so let's install a couple of packages first:\n\n-    $ npm install apollo-server-express body-parser cors express graphql\n-    $ npm install --save-dev @types/body-parser @types/cors @types/express @types/graphql\n+    yarn add apollo-server-express body-parser cors express graphql\n+    yarn add -D @types/body-parser @types/cors @types/express @types/graphql\n\n Express is a fast, unopinionated, minimalist web framework for node.\n Cross-Origin Resource Sharing (CORS) is a mechanism that uses additional HTTP headers to let a user agent gain permission to access selected resources from a server on a different origin (domain) than the site currently in use. A user agent makes a cross-origin HTTP request when it requests a resource from a different domain, protocol, or port than the one from which the current document originated.\n@@ -25,37 +25,41 @@ Time to create our index:\n\n Now we want to feed our graphql server with some data. Soon we will need `moment`, so let's install it:\n\n-    $ npm install moment\n+    yarn add moment\n\n Now we can create a fake db:\n\n {{{ diffStep \"1.2\" module=\"server\" files=\"db.ts\" }}}\n\n-Its' finally time to create our schema and our resolvers:\n+Its' finally time to create our schema\n\n-{{{ diffStep \"1.3\" module=\"server\" }}}\n+{{{ diffStep \"1.3\" module=\"server\" files=\"schema/typeDefs.ts\" }}}\n+\n+and our resolvers\n+\n+{{{ diffStep \"1.3\" module=\"server\" files=\"schema/resolvers.ts\" }}}\n\n Out basic server is already done and working. We still have no way to do any kind of mutation, but we already set up several queries to return a list of users or chats.\n In particular we can choose if we want to return all the chats (and how many messages we want to return for each chat) or if we want to return a single chat. We can also choose which and how many properties we want to return for each query.\n We can start the server by simply running:\n\n-    $ npm start\n+    yarn start\n\n ## Client\n\n Now we can concentrate on the client and bootstrap it using Angular-CLI.\n First you will need to install it globally with:\n\n-    $ npm install -g @angular/cli\n+    yarn global add @angular/cli\n\n Then we can create a new project from scratch:\n\n-    $ ng new client --style scss\n+    ng new client --style scss\n\n Time to install a couple of packages:\n\n-    $ ng add apollo-angular\n-    $ npm install --save-dev @types/graphql\n+    ng add apollo-angular\n+    yarn add -D @types/graphql\n\n Apollo's Schematics sets everything for us. The only thing missing is to fill the `url`.\n\n@@ -332,7 +336,7 @@ Since we have to turn Apollo's Observable to something that is compatible with R\n\n We will use Materials for the UI, so let's install it:\n\n-    $ npm install @angular/cdk @angular/material hammerjs ng2-truncate\n+    yarn add @angular/cdk @angular/material hammerjs ng2-truncate\n\n Let's configure Material:\n\ndiff --git a/.tortilla/manuals/templates/step6.tmpl b/.tortilla/manuals/templates/step6.tmpl\nindex 9e9d289..a9fdaf7 100644\n--- a/.tortilla/manuals/templates/step6.tmpl\n+++ b/.tortilla/manuals/templates/step6.tmpl\n@@ -1,44 +1,252 @@\n-## Server\n+## Code Generation\n\n-The GraphQL codegen library can generate any code for any language — including type definitions, data models, query builder, resolvers, ORM code, complete full stack platforms.\n-You can create your own custom GraphQL codegen templates in 10 minutes, that fit exactly your needs. We will use it to generate `Typescript` typings.\n+GraphQL entities are defined as static and typed, which means they can be analyzed and use as a base for generating everything.\n\n-First, let's install `graphql-code-generator`  in our server and add it to the run scripts:\n+There are many tools related to that topic, but we're going to focus on The **GraphQL Coge Generator**.\n\n-    $ npm install graphql-code-generator\n+The GraphQL Coge Generator can generate any code for any language  —  including type definitions, data models, query builder, resolvers, ORM code, complete full stack platforms.\n+\n+The tool is based on the concept of templates. It has few official templates to solve most required features. The GraphQL Code Gen allows to create your own custom codegen templates in 10 minutes, that fit exactly your needs.\n+\n+We will use TypeScript template to generate typings.\n+\n+### Generating types for server-side code\n+\n+First, let's install `graphql-code-generator` with the TypeScript template and add it to the run scripts:\n+\n+    yarn add graphql-code-generator graphql-codegen-typescript-template\n\n {{{ diffStep \"2.1\" module=\"server\" }}}\n\n-Now let's run the generator (the server must be running in the background):\n+Few things here:\n\n-    $ npm run generator\n+- `--require ts-node/register` - makes the ts-node compile TypeScript files\n+- `--schema` - points to a file that exports the GraphQL Schema object or a string (it also accepts an url)\n+- `--template` - tells about the template we want to use\n+- `--out` - the location of a generated file\n\n-Please note that the server must be started before running the generator.\n+Now let's run the generator:\n\n-Those are the types created with `npm run generator`:\n+    yarn generator\n\n-{{{ diffStep \"2.2\" module=\"server\" }}}\n+Please note that the server doesn't have to be running in background because we import schema through a file.\n\n-Now let's use them:\n+Next, let's use the generated types:\n\n {{{ diffStep \"2.3\" module=\"server\" }}}\n\n Don't worry, they will be much more useful when we will write our first mutation.\n\n-## Client\n+### Generating types for client-side code\n\n Let's do the same on the client:\n\n-    $ npm install graphql-code-generator\n+    yarn add graphql-code-generator graphql-codegen-typescript-template\n\n-Please note that the server must be started before running the generator.\n+Please note that in this case, the server must be started before running the generator.\n\n {{{ diffStep \"2.1\" module=\"client\" }}}\n\n-Those are our generated types:\n+We saw how to use them on the server but let's see how easy it is to take advantage of them in Apollo.\n+\n+First thing you should know is most of the methods of Apollo service accepts generic types.\n+\n+#### What are Generic Types\n+\n+A major part of software engineering is building components that not only have well-defined and consistent APIs, but are also reusable. Components that are capable of working on the data of today as well as the data of tomorrow will give you the most flexible capabilities for building up large software systems.\n+\n+We like to work on an code samples so let's do some functional programming and create the `map` method that accepts a transform function and return a new result.\n+\n+Without generics, we would have to use a specific type or `any`:\n+\n+```typescript\n+function map(mapFn: (value: any) => any) {\n+  return function(source: any): any {\n+    return mapFn(source);\n+  };\n+}\n+```\n+\n+Imagine, we want to use `map` function to pick user's id from an object:\n+\n+```typescript\n+interface User {\n+  id: number;\n+}\n+const me = {\n+  id: 1,\n+};\n+\n+const pickUserId = map(user => user.id);\n+\n+console.log(pickUserId(me)); // outputs: 1\n+```\n+\n+Great, it works, we get the expected result but it could be done way better.\n\n-{{{ diffStep \"2.2\" module=\"client\" }}}\n+What is the main issue here?\n+It accepts an object of any type and get `any` in return. It's not very useful because we know it return a `number` and receive a `User` but TypeScript doesn't know that and later on, in other part of the code, we end up with no information about the result.\n\n-Let's use them:\n+That's where Generic Types jumps in!\n+\n+With generics, it could look like this:\n+\n+```typescript\n+function map<T, R>(mapFn: (value: T) => R) {\n+  return function(source: T): R {\n+    return mapFn(source);\n+  };\n+}\n+```\n+\n+There's... a lot! So let's break it:\n+\n+- `map<T, R>` - the map function accepts two generic types\n+- `(mapFn: (value: T) => R)` - the only argument is a function that accepts an object of type `T` and returns value of type `R`\n+- `function (source: T): R => {...}` - it's a higher order function that accepts a source of type `T` and transforms to be `R`.\n+\n+Back to our example, now with generic types:\n+\n+```typescript\n+interface User {\n+  id: number;\n+}\n+const me = {\n+  id: 1,\n+};\n+\n+const pickUserId = map<User, number>(user => user.id);\n+\n+console.log(pickUserId(me)); // outputs: 1\n+```\n+\n+Our `map` and `pickUserId` function are strongly typed now so when you try to provide an object that has no `id` field or the field is a `string` you'll receive a proper information from TypeScript (and your IDE).\n+\n+#### Make client-side code strongly typed\n+\n+With all that knowledge let's use how to use those generated typed with `Apollo` service:\n\n {{{ diffStep \"2.3\" module=\"client\" }}}\n+\n+As you can probably tell by now, methods like `watchQuery` and `mutate` (and others) accepts two generic types, first one describes the result and the second one the variables.\n+\n+```typescript\n+export class ChatService {\n+  constructor(private apollo: Apollo) {}\n+\n+  getChat(chatId: string, amount: number): GetChat.Chat {\n+    return this.apollo\n+      .watchQuery<GetChat.Query, GetChat.Variables>({\n+        query: getChatQuery,\n+        variables: {\n+          chatId,\n+          amount,\n+        },\n+      })\n+      .pipe(map(result => result.data.chat));\n+  }\n+}\n+```\n+\n+Few things here.\n+\n+- An object of `GetChat.Query` shape lives under the `result.data` because `watchQuery` returns an object of type `ApolloQueryResult<T>` where `T` is our `GetChat.Query`.\n+\n+```typescript\n+export type ApolloQueryResult<T> = {\n+  data: T;\n+  // ... other fields\n+};\n+```\n+\n+You get the same result with Mutation or Subscription.\n+\n+- Thanks to the second argument and `GetChat.Variables` we as well as TypeScript (and an IDE) know that `chatId` is a string and `amount` accepts only a number. Whenever we try to pass a value of different kind an Error will pop out.\n+\n+### Take full advantage of Codegen and generate ready to use Services!\n+\n+I've got a fantasctic news, you don't have to manually provide those generated types to each type Apollo service is used. Because GraphQL Documents are statically analyzable, we prepared a codegen template specific for Apollo Angular users.\n+\n+First, let's install `graphql-codegen-apollo-angular` with the Apollo Angular templatea and update the template param of `generator` script\n+\n+    yarn add graphql-code-generator graphql-codegen-typescript-template\n+\n+{{{ diffStep \"2.4\" module=\"client\" file=\"package.json\" }}}\n+\n+The Apollo Angular template generates a ready to use in your component, strongly typed Angular services, for every defined query, mutation or subscription.\n+\n+It's possible thanks to the new API of Apollo Angular. More on that in [\"Query, Mutation, Subscription services\"](http://apollographql.com/docs/angular/basics/services.html?_ga=2.227615197.1327014552.1538988114-793224955.1532981447) chapter of the documentation.\n+\n+Given an example:\n+\n+```graphql\n+query GetChats($amount: Int) {\n+  chats {\n+    ...ChatWithoutMessages\n+    messages(amount: $amount) {\n+      ...Message\n+    }\n+  }\n+}\n+```\n+\n+The Apollo Angular template, after you run `yarn generate`, outputs a service called `GetChatsGQL`:\n+\n+```typescript\n+import { GetChatsGQL, GetChats } from '../graphql';\n+\n+export class AppComponent {\n+  constructor(private getChatsGQL: GetChatsGQL) {}\n+\n+  getChats(): GetChats.Chats[] {\n+    return this.getChatsGQL\n+      .watch({\n+        amount: 10,\n+      })\n+      .valueChanges.pipe(map(result => result.data.chats));\n+  }\n+}\n+```\n+\n+> Remember, every operation should has an unique name.\n+\n+It might look a bit different then what you have already learnt but we promise, the API is even easier.\n+\n+But first, let's dive into how those services look like under the hood.\n+\n+```typescript\n+import { Query } from 'apollo-angular';\n+\n+@Injectable({\n+  providedIn: 'root',\n+})\n+export class GetChatsGQL extends Query<GetChats.Query, GetChats.Variables> {\n+  document = gql`\n+    here goes the document\n+  `;\n+}\n+```\n+\n+Okay, seems easy but what is the `Query` class, you might ask!\n+\n+Apollo Angular exposes three classes for three kinds of the GraphQL operation: `Query`, `Mutation` and `Subscription`. Each of them has a different API.\n+\n+- `Query` has `fetch` and `watch`. First one behave like `Apollo.query()`, second one like `Apollo.watchQuery()`\n+- `Mutation` has `mutate`\n+- `Subscription` has `subscribe`\n+\n+Because the `document` is already defined in a class, they all accept two arguments (Subscription has third one). First argument defines variables, second shapes the options. Thats why we used `this.getChatsGQL.watch({ amount: 10 })`.\n+\n+Let's stop talking about the API itself and see what benefits it brings us:\n+\n+- **Less code to write** - no need to create a network call, no need to create Typescript typings, no need to create a dedicated Angular service\n+- **Strongly typed out of the box — all** types are being generated, no need to write any Typescript definitions and struggle to keep them updated\n+- _More pleasent API_ to work with\n+- **Full developer experience of tools and IDEs**  —  development time, autocomplete and error checking, not only across your frontend app but also with your API teams!\n+- **Tree-shakable** thanks to Angular 6\n+\n+Most IDEs with the GraphQL support (built-in or thanks to extensions) fully handles `.graphql` files and helps you with features like auto-completion, validation but they strugle with `gql` tag. To fully enjoy GraphQL we highly recommend to use static `.graphql` files.\n+\n+With all that knowledge, let's use GQL services in our application:\n+\n+{{{ diffStep \"2.4\" module=\"client\" files=\"src/app/services/chats.service.ts\" }}}\ndiff --git a/.tortilla/manuals/templates/step7.tmpl b/.tortilla/manuals/templates/step7.tmpl\nindex 4a58645..79518c8 100644\n--- a/.tortilla/manuals/templates/step7.tmpl\n+++ b/.tortilla/manuals/templates/step7.tmpl\n@@ -6,16 +6,62 @@ First let's start by importing `hammerjs` for the Material Gestures inside the t\n\n {{{ diffStep \"3.1\" module=\"client\" files=\"src/test.ts\" }}}\n\n+### Testing a Presentional Component\n+\n Let's start with the simplest one: the presentational component.\n We are not going to inject any service and we don't need to access our backend, so things are quite simple: we just need to pass our Chat object as an Input, detect the changes and use the query selector to match the UI content to the one we passed as input:\n\n {{{ diffStep \"3.1\" module=\"client\" files=\"src/app/chats-lister/components/chat-item/chat-item.component.spec.ts\" }}}\n\n+### Testing a Service\n+\n Testing a service is a bit more complicated because we will need to mock our backend in order to get fake results instead of having to fire up the backend each time.\n-We are going to simply mock the HTTP calls, which is a well known practice in the REST API world. Since we are using HTTP to retrieve the data, it will work as well with Apollo client:\n+\n+We could simply simply mock the HTTP calls, which is a well known practice in the REST API world. Since we are using HTTP to retrieve the data, it would work as well with our Apollo Client setup.\n+\n+#### Testing with Apollo Angular\n+\n+Because Apollo Angular provides its own testing utilities, let's bring them in!\n+\n+Although `apollo-angular` has a lot going on under the hood, the library provides multiple tools for testing that simplify those abstractions, and allows complete focus on the component logic.\n+\n+The `apollo-angular/testing` module exports a `ApolloTestingModule` module and `ApolloTestingController` service which simplifies the testing of Angular components by mocking calls to the GraphQL endpoint. This allows the tests to be run in isolation and provides consistent results on every run by removing the dependence on remote data.\n+\n+By using this `ApolloTestingController` service, it’s possible to specify the exact results that should be returned for a certain query.\n+\n+Worth mentioning, `ApolloTestingModule` comes with a default cache but you can use your own with `APOLLO_TESTING_CACHE` token.\n+\n+Let's show everything on an example:\n\n {{{ diffStep \"3.1\" module=\"client\" files=\"src/app/services/chats.service.spec.ts\" }}}\n\n+As you can see, the API of `ApolloTestingController` is pretty similar to the `HttpTestingController`.\n+\n+There are four methods you should know.\n+\n+**`expectOne()`**\n+Important thing, it accepts two arguments. First is different for different use cases, the second one stays always the same, it’s a string with a description of your assertion. In case of failing assertion, the error is thrown with an error message including the given description.\n+\n+Let's explore all those possible cases `expectOne` accepts:\n+\n+- you can match an operation by its name, simply by passing a string as a first argument.\n+- by passing the whole Operation object the expectOne method compares: operation’s name, variables, document and extensions.\n+- the first argument can also be a function that provides an Operation object and expect a boolean in return\n+- or passing a GraphQL Document\n+\n+**`exceptNone()`**\n+It accepts the same arguments as expectOne but it's a negation of it.\n+\n+**`match()`**\n+Search for operations that match the given parameters, without any expectations.\n+\n+**`verify()`**\n+Verify that no unmatched operations are outstanding. If any operations are outstanding, fail with an error message indicating which operations were not handled.\n+\n+If you want to learn more about testing, we got you covered, please visit [\"Testing Apollo in Angular\" chapter](https://www.apollographql.com/docs/angular/guides/testing.html) in Apollo documentation.\n+\n+### Testing a Container Component\n+\n In the last example we are going to test a container component, which makes use of several services and multiple other components:\n\n {{{ diffStep \"3.1\" module=\"client\" files=\"src/app/chats-lister/containers/chats/chats.component.spec.ts\" }}}\ndiff --git a/.tortilla/manuals/templates/step8.tmpl b/.tortilla/manuals/templates/step8.tmpl\nindex 7ddbd22..628619b 100644\n--- a/.tortilla/manuals/templates/step8.tmpl\n+++ b/.tortilla/manuals/templates/step8.tmpl\n@@ -1,16 +1,59 @@\n-We created a module which lists all of our chats, but we still need to show a particular chat.\n-Let's create the `chat-viewer` module! We're going to create a container component called `ChatComponent` and a couple of presentational components.\n+At this point we have a module which lists all of our chats, but we still need to show a particular chat.\n+We're going to implement in in this chapter.\n\n-{{{ diffStep \"4.1\" module=\"client\" }}}\n+### ChatViewer module\n\n-It's time to generate our types:\n+First, let's create a `ChatViewer` module:\n\n-    $ npm run generator\n+{{{ diffStep \"4.1\" module=\"client\" files=\"src/app/app.module.ts, src/app/chat-viewer/chat-viewer.module.ts\" }}}\n\n-And use them:\n+As you can see, it has already everything that we might need.\n\n-{{{ diffStep \"4.2\" module=\"client\" files=\"^(?!src/types.d.ts$).*\" }}}\n+### GetChat operation\n\n-We will also create some more tests for the newly created Chat container component:\n+Components need data, so we create the `GetChat` operation and run `yarn generator`:\n\n-{{{ diffStep \"4.3\" module=\"client\" }}}\n+{{{ diffStep \"4.1\" module=\"client\" files=\"src/graphql/getChat.query.ts\" }}}\n+\n+The query can be now implemented in `ChatsService`:\n+\n+{{{ diffStep \"4.1\" module=\"client\" files=\"src/app/services/chats.service.ts\" }}}\n+\n+Great!\n+\n+### Chat view\n+\n+Now we've got data but a user can't still access the chat view.\n+There is one place where we're able to pick the chat, it's the list:\n+\n+{{{ diffStep \"4.1\" module=\"client\" files=\"src/app/chats-lister/components/chat-item/chat-item.component.ts, src/app/chats-lister/components/chats-list/chats-list.component.ts, src/app/chats-lister/containers/chats/chats.component.ts\" }}}\n+\n+Time for a next step, an actual implementation of the chat view.\n+\n+{{{ diffStep \"4.1\" module=\"client\" files=\"src/app/chat-viewer/containers/chat/chat.component.ts, src/app/chat-viewer/containers/chat/chat.component.scss\" }}}\n+\n+The `ChatComponent` component contains:\n+\n+ - Toolbar with chat's name and a \"go back\" button\n+ - List of messages sorted from oldest to newest\n+ - Space to submit a new message\n+\n+### List of messages\n+\n+We now split the list of messages to the host:\n+\n+{{{ diffStep \"4.1\" module=\"client\" files=\"src/app/chat-viewer/components/messages-list/messages-list.component.ts, src/app/chat-viewer/components/messages-list/messages-list.component.scss\" }}}\n+\n+and a reused component for each message:\n+\n+{{{ diffStep \"4.1\" module=\"client\" files=\"src/app/chat-viewer/components/message-item/message-item.component.ts, src/app/chat-viewer/components/message-item/message-item.component.scss\" }}}\n+\n+As you see, we could easily decide which message comes from which user based on the `ownership` property.\n+\n+### Submit a new message\n+\n+The app shows the conversation and now we're going to focus on the last part, actually emitting a new message!\n+\n+{{{ diffStep \"4.1\" module=\"client\" files=\"src/app/chat-viewer/components/new-message/new-message.component.scss, src/app/chat-viewer/components/new-message/new-message.component.ts\" }}}\n+\n+It's not yet fully functional, we receive the message in the `ChatComponent` but we still need to send it to the server. We'll cover that in next few steps!\ndiff --git a/.tortilla/manuals/templates/step9.tmpl b/.tortilla/manuals/templates/step9.tmpl\nindex 5b24b0c..e660929 100644\n--- a/.tortilla/manuals/templates/step9.tmpl\n+++ b/.tortilla/manuals/templates/step9.tmpl\n@@ -24,7 +24,7 @@ Also we already implemented our mutations to take care of future use cases (like\n\n I said we were going to take greater advantage of `graphql-code-generator` once we started writing our first mutation and I'm going to show you why. Let's run the generator first:\n\n-    $ npm run generator\n+    yarn generator\n\n Then let's use the generated types:\n\n@@ -40,7 +40,7 @@ Let's start by wiring the addMessage mutation. We're going to write the GraphQL\n\n Run the generator:\n\n-    $ npm run generator\n+    yarn generator\n\n Now let's use the just-created query:\n\ndiff --git a/client/angular.json b/client/angular.json\nindex 3d9af93..73ef42c 100644\n--- a/client/angular.json\n+++ b/client/angular.json\n@@ -76,7 +76,7 @@\n             \"tsConfig\": \"src/tsconfig.spec.json\",\n             \"karmaConfig\": \"src/karma.conf.js\",\n             \"styles\": [\n-              \"styles.scss\"\n+              \"src/styles.scss\"\n             ],\n             \"scripts\": [],\n             \"assets\": [\n@@ -123,4 +123,4 @@\n     }\n   },\n   \"defaultProject\": \"whatsapp-client-angularcli-material\"\n-}\n\\ No newline at end of file\n+}\ndiff --git a/client/package.json b/client/package.json\nindex 7611682..b57abf7 100644\n--- a/client/package.json\n+++ b/client/package.json\n@@ -8,22 +8,22 @@\n     \"test\": \"ng test\",\n     \"lint\": \"ng lint\",\n     \"e2e\": \"ng e2e\",\n-    \"generator\": \"gql-gen --schema http://localhost:3000/graphql --template ts --out ./src/types.d.ts \\\"./src/graphql/**/*.ts\\\"\"\n+    \"generator\": \"ts-node src/codegen.ts\"\n   },\n   \"private\": true,\n   \"dependencies\": {\n-    \"@angular/animations\": \"6.1.9\",\n-    \"@angular/common\": \"6.1.9\",\n-    \"@angular/cdk\": \"6.4.7\",\n-    \"@angular/compiler\": \"6.1.9\",\n-    \"@angular/core\": \"6.1.9\",\n-    \"@angular/flex-layout\": \"6.0.0-beta.18\",\n-    \"@angular/forms\": \"6.1.9\",\n-    \"@angular/http\": \"6.1.9\",\n-    \"@angular/material\": \"6.4.7\",\n-    \"@angular/platform-browser\": \"6.1.9\",\n-    \"@angular/platform-browser-dynamic\": \"6.1.9\",\n-    \"@angular/router\": \"6.1.9\",\n+    \"@angular/animations\": \"7.0.0-rc.0\",\n+    \"@angular/common\": \"7.0.0-rc.0\",\n+    \"@angular/cdk\": \"7.0.0-rc.0\",\n+    \"@angular/compiler\": \"7.0.0-rc.0\",\n+    \"@angular/core\": \"7.0.0-rc.0\",\n+    \"@angular/flex-layout\": \"angular/flex-layout-builds#3a09d1d\",\n+    \"@angular/forms\": \"7.0.0-rc.0\",\n+    \"@angular/http\": \"7.0.0-rc.0\",\n+    \"@angular/material\": \"7.0.0-rc.0\",\n+    \"@angular/platform-browser\": \"7.0.0-rc.0\",\n+    \"@angular/platform-browser-dynamic\": \"7.0.0-rc.0\",\n+    \"@angular/router\": \"7.0.0-rc.0\",\n     \"apollo-angular\": \"1.4.1\",\n     \"core-js\": \"2.5.7\",\n     \"rxjs\": \"6.3.3\",\n@@ -43,17 +43,18 @@\n     \"subscriptions-transport-ws\": \"0.9.15\"\n   },\n   \"devDependencies\": {\n-    \"@angular-devkit/build-angular\": \"0.8.4\",\n-    \"@angular/cli\": \"6.2.4\",\n-    \"@angular/compiler-cli\": \"6.1.9\",\n+    \"@angular-devkit/build-angular\": \"0.9.0-rc.2\",\n+    \"@angular/cli\": \"7.0.0-rc.2\",\n+    \"@angular/compiler-cli\": \"7.0.0-rc.0\",\n+    \"@angular/language-service\": \"7.0.0-rc.0\",\n     \"@types/graphql\": \"14.0.1\",\n-    \"@angular/language-service\": \"6.1.9\",\n     \"@types/jasmine\": \"2.8.7\",\n     \"@types/jasminewd2\": \"2.0.3\",\n     \"@types/node\": \"8.9.5\",\n     \"codelyzer\": \"4.2.1\",\n-    \"graphql-code-generator\": \"0.9.1\",\n-    \"graphql-codegen-typescript-template\": \"0.9.1\",\n+    \"graphql-code-generator\": \"0.12.6\",\n+    \"graphql-codegen-typescript-template\": \"0.12.6\",\n+    \"graphql-codegen-apollo-angular-template\": \"0.12.6\",\n     \"jasmine-core\": \"2.99.1\",\n     \"jasmine-spec-reporter\": \"4.2.1\",\n     \"karma\": \"1.7.1\",\n@@ -61,9 +62,10 @@\n     \"karma-coverage-istanbul-reporter\": \"1.4.2\",\n     \"karma-jasmine\": \"1.1.2\",\n     \"karma-jasmine-html-reporter\": \"0.2.2\",\n+    \"prompt\": \"1.0.0\",\n     \"protractor\": \"5.3.1\",\n-    \"ts-node\": \"5.0.1\",\n+    \"ts-node\": \"7.0.1\",\n     \"tslint\": \"5.9.1\",\n-    \"typescript\": \"2.9.2\"\n+    \"typescript\": \"3.1.1\"\n   }\n }\ndiff --git a/client/src/app/chat-viewer/components/message-item/message-item.component.ts b/client/src/app/chat-viewer/components/message-item/message-item.component.ts\nindex c556072..9a9d401 100644\n--- a/client/src/app/chat-viewer/components/message-item/message-item.component.ts\n+++ b/client/src/app/chat-viewer/components/message-item/message-item.component.ts\n@@ -1,5 +1,5 @@\n import {Component, Input} from '@angular/core';\n-import {GetChat} from '../../../../types';\n+import {GetChat} from '../../../../graphql';\n\n @Component({\n   selector: 'app-message-item',\ndiff --git a/client/src/app/chat-viewer/components/messages-list/messages-list.component.ts b/client/src/app/chat-viewer/components/messages-list/messages-list.component.ts\nindex c6bc667..a1119fa 100644\n--- a/client/src/app/chat-viewer/components/messages-list/messages-list.component.ts\n+++ b/client/src/app/chat-viewer/components/messages-list/messages-list.component.ts\n@@ -1,5 +1,5 @@\n import {Component, Input} from '@angular/core';\n-import {GetChat} from '../../../../types';\n+import {GetChat} from '../../../../graphql';\n import {SelectableListDirective} from 'ngx-selectable-list';\n\n @Component({\ndiff --git a/client/src/app/chat-viewer/containers/chat/chat.component.spec.ts b/client/src/app/chat-viewer/containers/chat/chat.component.spec.ts\nindex 1bef7f3..fa65a13 100644\n--- a/client/src/app/chat-viewer/containers/chat/chat.component.spec.ts\n+++ b/client/src/app/chat-viewer/containers/chat/chat.component.spec.ts\n@@ -1,33 +1,42 @@\n import { async, ComponentFixture, TestBed } from '@angular/core/testing';\n\n+import { DebugElement, NO_ERRORS_SCHEMA } from '@angular/core';\n+import { RouterTestingModule } from '@angular/router/testing';\n+import { ActivatedRoute } from '@angular/router';\n+import { By } from '@angular/platform-browser';\n+import { FormsModule } from '@angular/forms';\n+import { of } from 'rxjs';\n+import {\n+  MatButtonModule,\n+  MatGridListModule,\n+  MatIconModule,\n+  MatListModule,\n+  MatMenuModule,\n+  MatToolbarModule,\n+} from '@angular/material';\n+import {\n+  ApolloTestingModule,\n+  ApolloTestingController,\n+  APOLLO_TESTING_CACHE,\n+} from 'apollo-angular/testing';\n+import { InMemoryCache } from 'apollo-cache-inmemory';\n+import { NgxSelectableListModule } from 'ngx-selectable-list';\n+\n+import { dataIdFromObject } from '../../../graphql.module';\n import { ChatComponent } from './chat.component';\n-import {DebugElement, NO_ERRORS_SCHEMA} from '@angular/core';\n-import {MatButtonModule, MatGridListModule, MatIconModule, MatListModule, MatMenuModule, MatToolbarModule} from '@angular/material';\n-import {ChatsService} from '../../../services/chats.service';\n-import {Apollo} from 'apollo-angular';\n-import {HttpClientTestingModule, HttpTestingController} from '@angular/common/http/testing';\n-import {HttpLink, HttpLinkModule, Options} from 'apollo-angular-link-http';\n-import {defaultDataIdFromObject, InMemoryCache} from 'apollo-cache-inmemory';\n-import {RouterTestingModule} from '@angular/router/testing';\n-import {ActivatedRoute} from '@angular/router';\n-import {of} from 'rxjs';\n-import {By} from '@angular/platform-browser';\n-import {FormsModule} from '@angular/forms';\n-import {SharedModule} from '../../../shared/shared.module';\n-import {NewMessageComponent} from '../../components/new-message/new-message.component';\n-import {MessagesListComponent} from '../../components/messages-list/messages-list.component';\n-import {MessageItemComponent} from '../../components/message-item/message-item.component';\n-import {NgxSelectableListModule} from 'ngx-selectable-list';\n-import {LoginService} from '../../../login/services/login.service';\n+import { ChatsService } from '../../../services/chats.service';\n+import { SharedModule } from '../../../shared/shared.module';\n+import { NewMessageComponent } from '../../components/new-message/new-message.component';\n+import { MessagesListComponent } from '../../components/messages-list/messages-list.component';\n+import { MessageItemComponent } from '../../components/message-item/message-item.component';\n+import { LoginService } from '../../../login/services/login.service';\n\n describe('ChatComponent', () => {\n   let component: ChatComponent;\n   let fixture: ComponentFixture<ChatComponent>;\n   let el: DebugElement;\n\n-  let httpMock: HttpTestingController;\n-  let httpLink: HttpLink;\n-  let apollo: Apollo;\n+  let controller: ApolloTestingController;\n\n   const chat: any = {\n     id: '1',\n@@ -42,7 +51,7 @@ describe('ChatComponent', () => {\n       {\n         id: '3',\n         __typename: 'User',\n-      }\n+      },\n     ],\n     unreadMessages: 1,\n     isGroup: false,\n@@ -57,7 +66,7 @@ describe('ChatComponent', () => {\n         sender: {\n           id: '3',\n           __typename: 'User',\n-          name: 'Avery Stewart'\n+          name: 'Avery Stewart',\n         },\n         content: 'Yep!',\n         createdAt: '1514035700',\n@@ -82,11 +91,11 @@ describe('ChatComponent', () => {\n               __typename: 'Chat',\n             },\n             receivedAt: null,\n-            readAt: null\n-          }\n+            readAt: null,\n+          },\n         ],\n-        ownership: false\n-      }\n+        ownership: false,\n+      },\n     ],\n   };\n\n@@ -107,56 +116,48 @@ describe('ChatComponent', () => {\n         MatGridListModule,\n         FormsModule,\n         SharedModule,\n-        HttpLinkModule,\n-        HttpClientTestingModule,\n+        ApolloTestingModule,\n         RouterTestingModule,\n         NgxSelectableListModule,\n       ],\n       providers: [\n         ChatsService,\n-        Apollo,\n+        {\n+          provide: APOLLO_TESTING_CACHE,\n+          useFactory() {\n+            return new InMemoryCache({ dataIdFromObject });\n+          },\n+        },\n         {\n           provide: ActivatedRoute,\n           useValue: {\n             params: of({ id: chat.id }),\n             queryParams: of({}),\n-          }\n+          },\n         },\n         LoginService,\n       ],\n-      schemas: [NO_ERRORS_SCHEMA]\n-    })\n-      .compileComponents();\n+      schemas: [NO_ERRORS_SCHEMA],\n+    }).compileComponents();\n\n-    httpMock = TestBed.get(HttpTestingController);\n-    httpLink = TestBed.get(HttpLink);\n-    apollo = TestBed.get(Apollo);\n-\n-    apollo.create({\n-      link: httpLink.create(<Options>{ uri: 'http://localhost:3000/graphql' }),\n-      cache: new InMemoryCache({\n-        dataIdFromObject: (object: any) => {\n-          switch (object.__typename) {\n-            case 'Message': return `${object.chat.id}:${object.id}`; // use `chatId` prefix and `messageId` as the primary key\n-            default: return defaultDataIdFromObject(object); // fall back to default handling\n-          }\n-        }\n-      }),\n-    });\n+    controller = TestBed.get(ApolloTestingController);\n   }));\n\n   beforeEach(() => {\n     fixture = TestBed.createComponent(ChatComponent);\n     component = fixture.componentInstance;\n     fixture.detectChanges();\n-    httpMock.expectOne(httpReq => httpReq.body.operationName === 'chatAdded', 'call to chatAdded api');\n-    httpMock.expectOne(httpReq => httpReq.body.operationName === 'messageAdded', 'call to messageAdded api');\n-    httpMock.expectOne(httpReq => httpReq.body.operationName === 'GetChats', 'call to getChats api');\n-    const req = httpMock.expectOne(httpReq => httpReq.body.operationName === 'GetChat', 'call to getChat api');\n+\n+    controller.expectOne('chatAdded', 'call to chatAdded api');\n+    controller.expectOne('messageAdded', 'call to messageAdded api');\n+    controller.expectOne('GetChats', 'call to getChats api');\n+\n+    const req = controller.expectOne('GetChat', 'call to getChat api');\n+\n     req.flush({\n       data: {\n-        chat\n-      }\n+        chat,\n+      },\n     });\n   });\n\n@@ -168,13 +169,22 @@ describe('ChatComponent', () => {\n     fixture.whenStable().then(() => {\n       fixture.detectChanges();\n       el = fixture.debugElement;\n-      expect(el.query(By.css(`app-toolbar > mat-toolbar > div > div`)).nativeElement.textContent).toContain(chat.name);\n+      expect(\n+        el.query(By.css(`app-toolbar > mat-toolbar > div > div`)).nativeElement\n+          .textContent,\n+      ).toContain(chat.name);\n       for (let i = 0; i < chat.messages.length; i++) {\n-        expect(el.query(By.css(`app-messages-list > mat-list > mat-list-item:nth-child(${i + 1}) > div > app-message-item > div`))\n-          .nativeElement.textContent).toContain(chat.messages[i].content);\n+        expect(\n+          el.query(\n+            By.css(\n+              `app-messages-list > mat-list > mat-list-item:nth-child(${i +\n+                1}) > div > app-message-item > div`,\n+            ),\n+          ).nativeElement.textContent,\n+        ).toContain(chat.messages[i].content);\n       }\n     });\n\n-    httpMock.verify();\n+    controller.verify();\n   });\n });\ndiff --git a/client/src/app/chat-viewer/containers/chat/chat.component.ts b/client/src/app/chat-viewer/containers/chat/chat.component.ts\nindex 9c48c14..7c83ea2 100644\n--- a/client/src/app/chat-viewer/containers/chat/chat.component.ts\n+++ b/client/src/app/chat-viewer/containers/chat/chat.component.ts\n@@ -1,7 +1,7 @@\n import {Component, OnInit} from '@angular/core';\n import {ActivatedRoute, Router} from '@angular/router';\n import {ChatsService} from '../../../services/chats.service';\n-import {GetChat} from '../../../../types';\n+import {GetChat} from '../../../../graphql';\n import {combineLatest} from 'rxjs';\n import {Location} from '@angular/common';\n import {QueryRef} from 'apollo-angular';\n@@ -75,7 +75,7 @@ export class ChatComponent implements OnInit {\n   }\n\n   addMessage(content: string) {\n-    // this.chatsService.addMessage(this.chatId, content).subscribe();\n+    this.chatsService.addMessage(this.chatId, content).subscribe();\n     this.chatsService.moreMessages(this.query, this.chatId);\n   }\n\ndiff --git a/client/src/app/chats-creation/components/new-group-details/new-group-details.component.ts b/client/src/app/chats-creation/components/new-group-details/new-group-details.component.ts\nindex dd6554c..0342057 100644\n--- a/client/src/app/chats-creation/components/new-group-details/new-group-details.component.ts\n+++ b/client/src/app/chats-creation/components/new-group-details/new-group-details.component.ts\n@@ -1,5 +1,5 @@\n import {Component, EventEmitter, Input, Output} from '@angular/core';\n-import {GetUsers} from '../../../../types';\n+import {GetUsers} from '../../../../graphql';\n\n @Component({\n   selector: 'app-new-group-details',\ndiff --git a/client/src/app/chats-creation/components/user-item/user-item.component.ts b/client/src/app/chats-creation/components/user-item/user-item.component.ts\nindex 75257e1..6a89cf6 100644\n--- a/client/src/app/chats-creation/components/user-item/user-item.component.ts\n+++ b/client/src/app/chats-creation/components/user-item/user-item.component.ts\n@@ -1,5 +1,5 @@\n import {Component, Input} from '@angular/core';\n-import {GetUsers} from '../../../../types';\n+import {GetUsers} from '../../../../graphql';\n\n @Component({\n   selector: 'app-user-item',\ndiff --git a/client/src/app/chats-creation/components/users-list/users-list.component.ts b/client/src/app/chats-creation/components/users-list/users-list.component.ts\nindex c01a8f8..fadcf36 100644\n--- a/client/src/app/chats-creation/components/users-list/users-list.component.ts\n+++ b/client/src/app/chats-creation/components/users-list/users-list.component.ts\n@@ -1,5 +1,5 @@\n import {Component, Input} from '@angular/core';\n-import {GetUsers} from '../../../../types';\n+import {GetUsers} from '../../../../graphql';\n import {SelectableListDirective} from 'ngx-selectable-list';\n\n @Component({\ndiff --git a/client/src/app/chats-creation/containers/new-chat/new-chat.component.ts b/client/src/app/chats-creation/containers/new-chat/new-chat.component.ts\nindex 1559ee1..44deb10 100644\n--- a/client/src/app/chats-creation/containers/new-chat/new-chat.component.ts\n+++ b/client/src/app/chats-creation/containers/new-chat/new-chat.component.ts\n@@ -1,7 +1,7 @@\n import {Component, OnInit} from '@angular/core';\n import {Location} from '@angular/common';\n import {Router} from '@angular/router';\n-import {AddChat, GetUsers} from '../../../../types';\n+import {AddChat, GetUsers} from '../../../../graphql';\n import {ChatsService} from '../../../services/chats.service';\n\n @Component({\ndiff --git a/client/src/app/chats-creation/containers/new-group/new-group.component.ts b/client/src/app/chats-creation/containers/new-group/new-group.component.ts\nindex 93586cd..925c802 100644\n--- a/client/src/app/chats-creation/containers/new-group/new-group.component.ts\n+++ b/client/src/app/chats-creation/containers/new-group/new-group.component.ts\n@@ -1,7 +1,7 @@\n import {Component, OnInit} from '@angular/core';\n import {Location} from '@angular/common';\n import {Router} from '@angular/router';\n-import {AddGroup, GetUsers} from '../../../../types';\n+import {AddGroup, GetUsers} from '../../../../graphql';\n import {ChatsService} from '../../../services/chats.service';\n\n @Component({\ndiff --git a/client/src/app/chats-lister/components/chat-item/chat-item.component.ts b/client/src/app/chats-lister/components/chat-item/chat-item.component.ts\nindex dae6050..d10268a 100644\n--- a/client/src/app/chats-lister/components/chat-item/chat-item.component.ts\n+++ b/client/src/app/chats-lister/components/chat-item/chat-item.component.ts\n@@ -1,5 +1,5 @@\n import {Component, EventEmitter, Input, Output} from '@angular/core';\n-import {GetChats} from '../../../../types';\n+import {GetChats} from '../../../../graphql';\n\n @Component({\n   selector: 'app-chat-item',\ndiff --git a/client/src/app/chats-lister/components/chats-list/chats-list.component.ts b/client/src/app/chats-lister/components/chats-list/chats-list.component.ts\nindex 0a13405..338bde7 100644\n--- a/client/src/app/chats-lister/components/chats-list/chats-list.component.ts\n+++ b/client/src/app/chats-lister/components/chats-list/chats-list.component.ts\n@@ -1,5 +1,5 @@\n import {Component, Input} from '@angular/core';\n-import {GetChats} from '../../../../types';\n+import {GetChats} from '../../../../graphql';\n import {SelectableListDirective} from 'ngx-selectable-list';\n\n @Component({\ndiff --git a/client/src/app/chats-lister/containers/chats/chats.component.spec.ts b/client/src/app/chats-lister/containers/chats/chats.component.spec.ts\nindex e7835d0..67c5051 100644\n--- a/client/src/app/chats-lister/containers/chats/chats.component.spec.ts\n+++ b/client/src/app/chats-lister/containers/chats/chats.component.spec.ts\n@@ -1,31 +1,40 @@\n import { async, ComponentFixture, TestBed } from '@angular/core/testing';\n+import { DebugElement, NO_ERRORS_SCHEMA } from '@angular/core';\n+import { TruncateModule } from 'ng2-truncate';\n+import {\n+  MatButtonModule,\n+  MatIconModule,\n+  MatListModule,\n+  MatMenuModule,\n+} from '@angular/material';\n+import { Apollo } from 'apollo-angular';\n+import {\n+  ApolloTestingModule,\n+  ApolloTestingController,\n+  APOLLO_TESTING_CACHE,\n+} from 'apollo-angular/testing';\n+import { InMemoryCache } from 'apollo-cache-inmemory';\n+import { By } from '@angular/platform-browser';\n+import { RouterTestingModule } from '@angular/router/testing';\n+import { NgxSelectableListModule } from 'ngx-selectable-list';\n\n+import { GetChats } from '../../../../graphql';\n+import { dataIdFromObject } from '../../../graphql.module';\n import { ChatsComponent } from './chats.component';\n-import {DebugElement, NO_ERRORS_SCHEMA} from '@angular/core';\n-import {ChatsListComponent} from '../../components/chats-list/chats-list.component';\n-import {ChatItemComponent} from '../../components/chat-item/chat-item.component';\n-import {TruncateModule} from 'ng2-truncate';\n-import {MatButtonModule, MatIconModule, MatListModule, MatMenuModule} from '@angular/material';\n-import {ChatsService} from '../../../services/chats.service';\n-import {Apollo} from 'apollo-angular';\n-import {HttpClientTestingModule, HttpTestingController} from '@angular/common/http/testing';\n-import {HttpLink, HttpLinkModule, Options} from 'apollo-angular-link-http';\n-import {defaultDataIdFromObject, InMemoryCache} from 'apollo-cache-inmemory';\n-import {By} from '@angular/platform-browser';\n-import {RouterTestingModule} from '@angular/router/testing';\n-import {NgxSelectableListModule} from 'ngx-selectable-list';\n-import {LoginService} from '../../../login/services/login.service';\n+import { ChatsListComponent } from '../../components/chats-list/chats-list.component';\n+import { ChatItemComponent } from '../../components/chat-item/chat-item.component';\n+import { ChatsService } from '../../../services/chats.service';\n+import { LoginService } from '../../../login/services/login.service';\n\n describe('ChatsComponent', () => {\n   let component: ChatsComponent;\n   let fixture: ComponentFixture<ChatsComponent>;\n   let el: DebugElement;\n\n-  let httpMock: HttpTestingController;\n-  let httpLink: HttpLink;\n+  let controller: ApolloTestingController;\n   let apollo: Apollo;\n\n-  const chats: any = [\n+  const chats: GetChats.Chats[] = [\n     {\n       id: '1',\n       __typename: 'Chat',\n@@ -39,7 +48,7 @@ describe('ChatsComponent', () => {\n         {\n           id: '3',\n           __typename: 'User',\n-        }\n+        },\n       ],\n       unreadMessages: 1,\n       isGroup: false,\n@@ -54,7 +63,7 @@ describe('ChatsComponent', () => {\n           sender: {\n             id: '3',\n             __typename: 'User',\n-            name: 'Avery Stewart'\n+            name: 'Avery Stewart',\n           },\n           content: 'Yep!',\n           createdAt: '1514035700',\n@@ -80,10 +89,10 @@ describe('ChatsComponent', () => {\n               },\n               receivedAt: null,\n               readAt: null,\n-            }\n+            },\n           ],\n           ownership: false,\n-        }\n+        },\n       ],\n     },\n     {\n@@ -99,7 +108,7 @@ describe('ChatsComponent', () => {\n         {\n           id: '4',\n           __typename: 'User',\n-        }\n+        },\n       ],\n       unreadMessages: 0,\n       isGroup: false,\n@@ -114,9 +123,9 @@ describe('ChatsComponent', () => {\n           sender: {\n             id: '1',\n             __typename: 'User',\n-            name: 'Ethan Gonzalez'\n+            name: 'Ethan Gonzalez',\n           },\n-          content: 'Hey, it\\'s me',\n+          content: `Hey, it's me`,\n           createdAt: '1514031800',\n           type: 0,\n           recipients: [\n@@ -140,10 +149,10 @@ describe('ChatsComponent', () => {\n               },\n               receivedAt: null,\n               readAt: null,\n-            }\n+            },\n           ],\n-          ownership: true\n-        }\n+          ownership: true,\n+        },\n       ],\n     },\n     {\n@@ -159,7 +168,7 @@ describe('ChatsComponent', () => {\n         {\n           id: '5',\n           __typename: 'User',\n-        }\n+        },\n       ],\n       unreadMessages: 0,\n       isGroup: false,\n@@ -174,7 +183,7 @@ describe('ChatsComponent', () => {\n           sender: {\n             id: '1',\n             __typename: 'User',\n-            name: 'Ethan Gonzalez'\n+            name: 'Ethan Gonzalez',\n           },\n           content: 'You still there?',\n           createdAt: '1514010200',\n@@ -199,11 +208,11 @@ describe('ChatsComponent', () => {\n                 __typename: 'Chat',\n               },\n               receivedAt: null,\n-              readAt: null\n-            }\n+              readAt: null,\n+            },\n           ],\n-          ownership: true\n-        }\n+          ownership: true,\n+        },\n       ],\n     },\n     {\n@@ -219,11 +228,11 @@ describe('ChatsComponent', () => {\n         {\n           id: '6',\n           __typename: 'User',\n-        }\n+        },\n       ],\n       unreadMessages: 0,\n       messages: [],\n-      isGroup: false\n+      isGroup: false,\n     },\n     {\n       id: '8',\n@@ -261,7 +270,7 @@ describe('ChatsComponent', () => {\n           sender: {\n             id: '4',\n             __typename: 'User',\n-            name: 'Katie Peterson'\n+            name: 'Katie Peterson',\n           },\n           content: 'Awesome!',\n           createdAt: '1512830000',\n@@ -286,7 +295,7 @@ describe('ChatsComponent', () => {\n                 __typename: 'Chat',\n               },\n               receivedAt: null,\n-              readAt: null\n+              readAt: null,\n             },\n             {\n               user: {\n@@ -307,70 +316,58 @@ describe('ChatsComponent', () => {\n                 __typename: 'Chat',\n               },\n               receivedAt: null,\n-              readAt: null\n-            }\n+              readAt: null,\n+            },\n           ],\n-          ownership: false\n-        }\n+          ownership: false,\n+        },\n       ],\n     },\n   ];\n\n   beforeEach(async(() => {\n     TestBed.configureTestingModule({\n-      declarations: [\n-        ChatsComponent,\n-        ChatsListComponent,\n-        ChatItemComponent\n-      ],\n+      declarations: [ChatsComponent, ChatsListComponent, ChatItemComponent],\n       imports: [\n         MatMenuModule,\n         MatIconModule,\n         MatButtonModule,\n         MatListModule,\n         TruncateModule,\n-        HttpLinkModule,\n-        HttpClientTestingModule,\n+        ApolloTestingModule,\n         RouterTestingModule,\n         NgxSelectableListModule,\n       ],\n       providers: [\n         ChatsService,\n-        Apollo,\n+        {\n+          provide: APOLLO_TESTING_CACHE,\n+          useFactory() {\n+            return new InMemoryCache({ dataIdFromObject });\n+          },\n+        },\n         LoginService,\n       ],\n-      schemas: [NO_ERRORS_SCHEMA]\n-    })\n-      .compileComponents();\n+      schemas: [NO_ERRORS_SCHEMA],\n+    }).compileComponents();\n\n-    httpMock = TestBed.get(HttpTestingController);\n-    httpLink = TestBed.get(HttpLink);\n+    controller = TestBed.get(ApolloTestingController);\n     apollo = TestBed.get(Apollo);\n-\n-    apollo.create({\n-      link: httpLink.create(<Options>{ uri: 'http://localhost:3000/graphql' }),\n-      cache: new InMemoryCache({\n-        dataIdFromObject: (object: any) => {\n-          switch (object.__typename) {\n-            case 'Message': return `${object.chat.id}:${object.id}`; // use `chatId` prefix and `messageId` as the primary key\n-            default: return defaultDataIdFromObject(object); // fall back to default handling\n-          }\n-        }\n-      }),\n-    });\n   }));\n\n   beforeEach(() => {\n     fixture = TestBed.createComponent(ChatsComponent);\n     component = fixture.componentInstance;\n     fixture.detectChanges();\n-    httpMock.expectOne(httpReq => httpReq.body.operationName === 'chatAdded', 'call to chatAdded api');\n-    httpMock.expectOne(httpReq => httpReq.body.operationName === 'messageAdded', 'call to messageAdded api');\n-    const req = httpMock.expectOne(httpReq => httpReq.body.operationName === 'GetChats', 'call to getChats api');\n+\n+    controller.expectOne('chatAdded', 'call to chatAdded api');\n+    controller.expectOne('messageAdded', 'call to messageAdded api');\n+\n+    const req = controller.expectOne('GetChats', 'GetChats operation');\n     req.flush({\n       data: {\n-        chats\n-      }\n+        chats,\n+      },\n     });\n   });\n\n@@ -383,11 +380,19 @@ describe('ChatsComponent', () => {\n       fixture.detectChanges();\n       el = fixture.debugElement;\n       for (let i = 0; i < chats.length; i++) {\n-        expect(el.query(By.css(`app-chats-list > mat-list > mat-list-item:nth-child(${i + 1}) > div > app-chat-item > div > div > div`))\n-          .nativeElement.textContent).toContain(chats[i].name);\n+        expect(\n+          el.query(\n+            By.css(\n+              `app-chats-list > mat-list > mat-list-item:nth-child(${i +\n+                1}) > div > app-chat-item > div > div > div`,\n+            ),\n+          ).nativeElement.textContent,\n+        ).toContain(chats[i].name);\n       }\n     });\n+  });\n\n-    httpMock.verify();\n+  afterAll(() => {\n+    controller.verify();\n   });\n });\ndiff --git a/client/src/app/chats-lister/containers/chats/chats.component.ts b/client/src/app/chats-lister/containers/chats/chats.component.ts\nindex 6f78b4a..da62ccb 100644\n--- a/client/src/app/chats-lister/containers/chats/chats.component.ts\n+++ b/client/src/app/chats-lister/containers/chats/chats.component.ts\n@@ -1,7 +1,7 @@\n import {Component, OnInit} from '@angular/core';\n import {ChatsService} from '../../../services/chats.service';\n import {Observable} from 'rxjs';\n-import {GetChats} from '../../../../types';\n+import {GetChats} from '../../../../graphql';\n import {Router} from '@angular/router';\n\n @Component({\ndiff --git a/client/src/app/graphql.module.ts b/client/src/app/graphql.module.ts\nindex d03e676..b87ed34 100644\n--- a/client/src/app/graphql.module.ts\n+++ b/client/src/app/graphql.module.ts\n@@ -1,4 +1,4 @@\n-import { NgModule} from '@angular/core';\n+import { NgModule } from '@angular/core';\n import { ApolloModule, APOLLO_OPTIONS } from 'apollo-angular';\n import { HttpLinkModule, HttpLink } from 'apollo-angular-link-http';\n import { InMemoryCache, defaultDataIdFromObject } from 'apollo-cache-inmemory';\n@@ -10,6 +10,15 @@ import {LoginService} from './login/services/login.service';\n\n const uri = 'http://localhost:3000/graphql';\n\n+export const dataIdFromObject = (object: any) => {\n+  switch (object.__typename) {\n+    case 'Message':\n+      return `${object.chat.id}:${object.id}`; // use `chatId` prefix and `messageId` as the primary key\n+    default:\n+      return defaultDataIdFromObject(object); // fall back to default handling\n+  }\n+};\n+\n export function createApollo(httpLink: HttpLink, loginService: LoginService) {\n   const subscriptionLink = new WebSocketLink({\n     uri: uri.replace('http', 'ws'),\n@@ -33,12 +42,7 @@ export function createApollo(httpLink: HttpLink, loginService: LoginService) {\n   return {\n     link,\n     cache: new InMemoryCache({\n-      dataIdFromObject: (object: any) => {\n-        switch (object.__typename) {\n-          case 'Message': return `${object.chat.id}:${object.id}`; // use `chatId` prefix and `messageId` as the primary key\n-          default: return defaultDataIdFromObject(object); // fall back to default handling\n-        }\n-      }\n+      dataIdFromObject,\n     }),\n   };\n }\ndiff --git a/client/src/app/login/containers/login.component.ts b/client/src/app/login/containers/login.component.ts\nindex 51f5582..4cac0d4 100644\n--- a/client/src/app/login/containers/login.component.ts\n+++ b/client/src/app/login/containers/login.component.ts\n@@ -3,7 +3,7 @@ import {HttpClient} from '@angular/common/http';\n import {FormBuilder, Validators} from '@angular/forms';\n // import {matchOtherValidator} from '@moebius/ng-validators';\n import {Router} from '@angular/router';\n-import {User} from '../../../types';\n+import {User} from '../../../graphql';\n import {LoginService} from '../services/login.service';\n\n @Component({\ndiff --git a/client/src/app/login/services/login.service.ts b/client/src/app/login/services/login.service.ts\nindex 1a4c3e3..ae8c04a 100644\n--- a/client/src/app/login/services/login.service.ts\n+++ b/client/src/app/login/services/login.service.ts\n@@ -1,5 +1,5 @@\n import { Injectable } from '@angular/core';\n-import {User} from '../../../types';\n+import {User} from '../../../graphql';\n\n @Injectable()\n export class LoginService {\ndiff --git a/client/src/app/services/chats.service.spec.ts b/client/src/app/services/chats.service.spec.ts\nindex c4b3754..1a7017c 100644\n--- a/client/src/app/services/chats.service.spec.ts\n+++ b/client/src/app/services/chats.service.spec.ts\n@@ -1,18 +1,23 @@\n import { TestBed, inject } from '@angular/core/testing';\n\n+import { Apollo } from 'apollo-angular';\n+import {\n+  ApolloTestingModule,\n+  ApolloTestingController,\n+  APOLLO_TESTING_CACHE,\n+} from 'apollo-angular/testing';\n+import { InMemoryCache } from 'apollo-cache-inmemory';\n+\n+import { GetChats } from '../../graphql';\n+import { dataIdFromObject } from '../graphql.module';\n import { ChatsService } from './chats.service';\n-import {Apollo} from 'apollo-angular';\n-import {HttpLink, HttpLinkModule, Options} from 'apollo-angular-link-http';\n-import {HttpClientTestingModule, HttpTestingController} from '@angular/common/http/testing';\n-import {defaultDataIdFromObject, InMemoryCache} from 'apollo-cache-inmemory';\n-import {LoginService} from '../login/services/login.service';\n+import { LoginService } from '../login/services/login.service';\n\n describe('ChatsService', () => {\n-  let httpMock: HttpTestingController;\n-  let httpLink: HttpLink;\n+  let controller: ApolloTestingController;\n   let apollo: Apollo;\n\n-  const chats: any = [\n+  const chats: GetChats.Chats[] = [\n     {\n       id: '1',\n       __typename: 'Chat',\n@@ -26,7 +31,7 @@ describe('ChatsService', () => {\n         {\n           id: '3',\n           __typename: 'User',\n-        }\n+        },\n       ],\n       unreadMessages: 1,\n       isGroup: false,\n@@ -41,7 +46,7 @@ describe('ChatsService', () => {\n           sender: {\n             id: '3',\n             __typename: 'User',\n-            name: 'Avery Stewart'\n+            name: 'Avery Stewart',\n           },\n           content: 'Yep!',\n           createdAt: '1514035700',\n@@ -67,10 +72,10 @@ describe('ChatsService', () => {\n               },\n               receivedAt: null,\n               readAt: null,\n-            }\n+            },\n           ],\n           ownership: false,\n-        }\n+        },\n       ],\n     },\n     {\n@@ -86,7 +91,7 @@ describe('ChatsService', () => {\n         {\n           id: '4',\n           __typename: 'User',\n-        }\n+        },\n       ],\n       unreadMessages: 0,\n       isGroup: false,\n@@ -101,9 +106,9 @@ describe('ChatsService', () => {\n           sender: {\n             id: '1',\n             __typename: 'User',\n-            name: 'Ethan Gonzalez'\n+            name: 'Ethan Gonzalez',\n           },\n-          content: 'Hey, it\\'s me',\n+          content: `Hey, it's me`,\n           createdAt: '1514031800',\n           type: 0,\n           recipients: [\n@@ -127,10 +132,10 @@ describe('ChatsService', () => {\n               },\n               receivedAt: null,\n               readAt: null,\n-            }\n+            },\n           ],\n-          ownership: true\n-        }\n+          ownership: true,\n+        },\n       ],\n     },\n     {\n@@ -146,7 +151,7 @@ describe('ChatsService', () => {\n         {\n           id: '5',\n           __typename: 'User',\n-        }\n+        },\n       ],\n       unreadMessages: 0,\n       isGroup: false,\n@@ -161,7 +166,7 @@ describe('ChatsService', () => {\n           sender: {\n             id: '1',\n             __typename: 'User',\n-            name: 'Ethan Gonzalez'\n+            name: 'Ethan Gonzalez',\n           },\n           content: 'You still there?',\n           createdAt: '1514010200',\n@@ -186,11 +191,11 @@ describe('ChatsService', () => {\n                 __typename: 'Chat',\n               },\n               receivedAt: null,\n-              readAt: null\n-            }\n+              readAt: null,\n+            },\n           ],\n-          ownership: true\n-        }\n+          ownership: true,\n+        },\n       ],\n     },\n     {\n@@ -206,11 +211,11 @@ describe('ChatsService', () => {\n         {\n           id: '6',\n           __typename: 'User',\n-        }\n+        },\n       ],\n       unreadMessages: 0,\n       messages: [],\n-      isGroup: false\n+      isGroup: false,\n     },\n     {\n       id: '8',\n@@ -248,7 +253,7 @@ describe('ChatsService', () => {\n           sender: {\n             id: '4',\n             __typename: 'User',\n-            name: 'Katie Peterson'\n+            name: 'Katie Peterson',\n           },\n           content: 'Awesome!',\n           createdAt: '1512830000',\n@@ -273,7 +278,7 @@ describe('ChatsService', () => {\n                 __typename: 'Chat',\n               },\n               receivedAt: null,\n-              readAt: null\n+              readAt: null,\n             },\n             {\n               user: {\n@@ -294,44 +299,34 @@ describe('ChatsService', () => {\n                 __typename: 'Chat',\n               },\n               receivedAt: null,\n-              readAt: null\n-            }\n+              readAt: null,\n+            },\n           ],\n-          ownership: false\n-        }\n+          ownership: false,\n+        },\n       ],\n     },\n   ];\n\n   beforeEach(() => {\n     TestBed.configureTestingModule({\n-      imports: [\n-        HttpLinkModule,\n-        // HttpClientModule,\n-        HttpClientTestingModule,\n-      ],\n+      imports: [ApolloTestingModule],\n       providers: [\n         ChatsService,\n-        Apollo,\n         LoginService,\n-      ]\n+        {\n+          provide: APOLLO_TESTING_CACHE,\n+          useFactory() {\n+            return new InMemoryCache({\n+              dataIdFromObject,\n+            });\n+          },\n+        },\n+      ],\n     });\n\n-    httpMock = TestBed.get(HttpTestingController);\n-    httpLink = TestBed.get(HttpLink);\n+    controller = TestBed.get(ApolloTestingController);\n     apollo = TestBed.get(Apollo);\n-\n-    apollo.create({\n-      link: httpLink.create(<Options>{ uri: 'http://localhost:3000/graphql' }),\n-      cache: new InMemoryCache({\n-        dataIdFromObject: (object: any) => {\n-          switch (object.__typename) {\n-            case 'Message': return `${object.chat.id}:${object.id}`; // use `chatId` prefix and `messageId` as the primary key\n-            default: return defaultDataIdFromObject(object); // fall back to default handling\n-          }\n-        }\n-      }),\n-    });\n   });\n\n   it('should be created', inject([ChatsService], (service: ChatsService) => {\n@@ -346,15 +341,17 @@ describe('ChatsService', () => {\n       }\n     });\n\n-    httpMock.expectOne(httpReq => httpReq.body.operationName === 'chatAdded', 'call to chatAdded api');\n-    httpMock.expectOne(httpReq => httpReq.body.operationName === 'messageAdded', 'call to messageAdded api');\n-    const req = httpMock.expectOne(httpReq => httpReq.body.operationName === 'GetChats', 'call to getChats api');\n-    expect(req.request.method).toBe('POST');\n+    controller.expectOne('chatAdded', 'call to chatAdded api');\n+    controller.expectOne('messageAdded', 'call to messageAdded api');\n+\n+    const req = controller.expectOne('GetChats', 'GetChats operation');\n+\n     req.flush({\n       data: {\n-        chats\n-      }\n+        chats,\n+      },\n     });\n-    httpMock.verify();\n+\n+    controller.verify();\n   }));\n });\ndiff --git a/client/src/app/services/chats.service.ts b/client/src/app/services/chats.service.ts\nindex 1c737bc..cdf9b66 100644\n--- a/client/src/app/services/chats.service.ts\n+++ b/client/src/app/services/chats.service.ts\n@@ -1,50 +1,66 @@\n-import {ApolloQueryResult, FetchMoreOptions, FetchMoreQueryOptions, MutationOptions, WatchQueryOptions} from 'apollo-client';\n import {concat, map, share, switchMap} from 'rxjs/operators';\n-import {Apollo, QueryRef} from 'apollo-angular';\n import {Injectable} from '@angular/core';\n-import {getChatsQuery} from '../../graphql/getChats.query';\n-import {\n-  AddChat, AddGroup, AddMessage, GetChat, GetChats, GetUsers, MessageAdded, MoreMessages, RemoveAllMessages, RemoveChat,\n-  RemoveMessages\n-} from '../../types';\n-import {getChatQuery} from '../../graphql/getChat.query';\n-import {addMessageMutation} from '../../graphql/addMessage.mutation';\n-import {removeChatMutation} from '../../graphql/removeChat.mutation';\n-import {DocumentNode} from 'graphql';\n-import {removeAllMessagesMutation} from '../../graphql/removeAllMessages.mutation';\n-import {removeMessagesMutation} from '../../graphql/removeMessages.mutation';\n-import {getUsersQuery} from '../../graphql/getUsers.query';\n import {Observable, AsyncSubject, of} from 'rxjs';\n-import {addChatMutation} from '../../graphql/addChat.mutation';\n-import {addGroupMutation} from '../../graphql/addGroup.mutation';\n-import * as moment from 'moment';\n-import {FetchResult} from 'apollo-link';\n+import {Apollo, QueryRef} from 'apollo-angular';\n+import {\n+  GetChatsGQL,\n+  GetChatGQL,\n+  AddMessageGQL,\n+  RemoveChatGQL,\n+  RemoveMessagesGQL,\n+  RemoveAllMessagesGQL,\n+  GetUsersGQL,\n+  AddChatGQL,\n+  AddGroupGQL,\n+  ChatAddedGQL,\n+  MessageAddedGQL,\n+  MoreMessagesGQL,\n+  AddMessage,\n+  GetChats,\n+  GetChat,\n+  RemoveMessages,\n+  RemoveAllMessages,\n+  GetUsers,\n+  AddChat,\n+  AddGroup,\n+  MessageAdded,\n+} from '../../graphql';\n+import { DataProxy } from 'apollo-cache';\n+import { FetchResult } from 'apollo-link';\n import {LoginService} from '../login/services/login.service';\n-import {chatAddedSubscription} from '../../graphql/chatAdded.subscription';\n-import {messageAddedSubscription} from '../../graphql/messageAdded.subscription';\n-import {moreMessagesQuery} from '../../graphql/moreMessages.query';\n\n @Injectable()\n export class ChatsService {\n   chatsMessagesAmount = 2;\n   chatMessagesAmount = 5;\n-  getChatsWq: QueryRef<GetChats.Query>;\n+  getChatsWq: QueryRef<GetChats.Query, GetChats.Variables>;\n   chats$: Observable<GetChats.Chats[]>;\n   chats: GetChats.Chats[];\n   getChatWqSubject: AsyncSubject<QueryRef<GetChat.Query>>;\n   addChat$: Observable<FetchResult<AddChat.Mutation | AddGroup.Mutation>>;\n\n-  constructor(private apollo: Apollo,\n-              private loginService: LoginService) {\n-    this.getChatsWq = this.apollo.watchQuery<GetChats.Query>(<WatchQueryOptions>{\n-      query: getChatsQuery,\n-      variables: {\n-        amount: this.chatsMessagesAmount,\n-      },\n+  constructor(\n+    private getChatsGQL: GetChatsGQL,\n+    private getChatGQL: GetChatGQL,\n+    private addMessageGQL: AddMessageGQL,\n+    private removeChatGQL: RemoveChatGQL,\n+    private removeMessagesGQL: RemoveMessagesGQL,\n+    private removeAllMessagesGQL: RemoveAllMessagesGQL,\n+    private getUsersGQL: GetUsersGQL,\n+    private addChatGQL: AddChatGQL,\n+    private addGroupGQL: AddGroupGQL,\n+    private chatAddedGQL: ChatAddedGQL,\n+    private messageAddedGQL: MessageAddedGQL,\n+    private moreMessagesGQL: MoreMessagesGQL,\n+    private apollo: Apollo,\n+    private loginService: LoginService\n+  ) {\n+    this.getChatsWq = this.getChatsGQL.watch({\n+      amount: this.chatsMessagesAmount,\n     });\n\n     this.getChatsWq.subscribeToMore({\n-      document: chatAddedSubscription,\n+      document: this.chatAddedGQL.document,\n       variables: {\n         amount: this.chatsMessagesAmount,\n       },\n@@ -62,7 +78,7 @@ export class ChatsService {\n     });\n\n     this.getChatsWq.subscribeToMore({\n-      document: messageAddedSubscription,\n+      document: this.messageAddedGQL.document,\n       updateQuery: (prev: GetChats.Query, { subscriptionData }) => {\n         if (!subscriptionData.data) {\n           return prev;\n@@ -74,7 +90,8 @@ export class ChatsService {\n         try {\n           // Read the data from our cache for this query.\n           const {chat}: GetChat.Query = this.apollo.getClient().readQuery({\n-            query: getChatQuery, variables: {\n+            query: this.getChatGQL.document,\n+            variables: {\n               chatId: newMessage.chat.id,\n               amount: this.chatMessagesAmount,\n             }\n@@ -84,9 +101,15 @@ export class ChatsService {\n           chat.messageFeed.messages.push(newMessage);\n           // Write our data back to the cache.\n           this.apollo.getClient().writeQuery({\n-            query: getChatQuery,\n-            variables: {chatId: newMessage.chat.id, amount: this.chatMessagesAmount},\n-            data: {chat} });\n+            query: this.getChatGQL.document,\n+            variables: {\n+              chatId: newMessage.chat.id,\n+              amount: this.chatMessagesAmount\n+            },\n+            data: {\n+              chat\n+            }\n+          });\n         } catch {\n           console.error('The chat we received an update for does not exist in the store');\n         }\n@@ -100,7 +123,7 @@ export class ChatsService {\n     });\n\n     this.chats$ = this.getChatsWq.valueChanges.pipe(\n-      map((result: ApolloQueryResult<GetChats.Query>) => result.data.chats)\n+      map((result) => result.data.chats)\n     );\n     this.chats$.subscribe(chats => this.chats = chats);\n   }\n@@ -130,12 +153,9 @@ export class ChatsService {\n     const chat$FromCache = of<GetChat.Chat>(_chat);\n\n     const getApolloWatchQuery = (id: string) => {\n-      return this.apollo.watchQuery<GetChat.Query>({\n-        query: getChatQuery,\n-        variables: {\n-          chatId: id,\n-          amount: this.chatMessagesAmount,\n-        }\n+      return this.getChatGQL.watch({\n+        chatId: id,\n+        amount: this.chatMessagesAmount,\n       });\n     };\n\n@@ -147,21 +167,28 @@ export class ChatsService {\n         concat(this.addChat$.pipe(\n           switchMap(({ data: { addChat, addGroup } }) => {\n             const query = getApolloWatchQuery(addChat ? addChat.id : addGroup.id);\n+\n             this.getChatWqSubject.next(query);\n             this.getChatWqSubject.complete();\n+\n             return query.valueChanges.pipe(\n-              map((result: ApolloQueryResult<GetChat.Query>) => result.data.chat)\n+              map((result) => result.data.chat)\n             );\n           }))\n         ));\n     } else {\n       const query = getApolloWatchQuery(chatId);\n+\n       this.getChatWqSubject.next(query);\n       this.getChatWqSubject.complete();\n+\n       chat$ = chat$FromCache.pipe(\n-        concat(query.valueChanges.pipe(\n-          map((result: ApolloQueryResult<GetChat.Query>) => result.data.chat)\n-        )));\n+        concat(\n+          query.valueChanges.pipe(\n+            map((result) => result.data.chat)\n+          )\n+        )\n+      );\n     }\n\n     return {query$: this.getChatWqSubject.asObservable(), chat$};\n@@ -171,13 +198,13 @@ export class ChatsService {\n     const {data: {chat: {messageFeed}}} = query.getLastResult();\n     if (messageFeed.hasNextPage) {\n       query.fetchMore({\n-        query: moreMessagesQuery,\n+        query: this.moreMessagesGQL.document,\n         variables: {\n           chatId,\n           amount: this.chatMessagesAmount,\n           before: messageFeed.cursor,\n         },\n-        updateQuery: (previousResult: GetChat.Query, { fetchMoreResult }) => {\n+        updateQuery: (previousResult, { fetchMoreResult }) => {\n           return {\n             chat: {\n               ...previousResult.chat,\n@@ -196,12 +223,10 @@ export class ChatsService {\n   }\n\n   addMessage(chatId: string, content: string) {\n-    return this.apollo.mutate(<MutationOptions>{\n-      mutation: addMessageMutation,\n-      variables: <AddMessage.Variables>{\n-        chatId,\n-        content,\n-      },\n+    return this.addMessageGQL.mutate({\n+      chatId,\n+      content,\n+    }, {\n       optimisticResponse: {\n         __typename: 'Mutation',\n         addMessage: {\n@@ -227,8 +252,9 @@ export class ChatsService {\n         // Update the messages cache\n         {\n           // Read the data from our cache for this query.\n-          const {chat}: GetChat.Query = store.readQuery({\n-            query: getChatQuery, variables: {\n+          const {chat} = store.readQuery<GetChat.Query, GetChat.Variables>({\n+            query: this.getChatGQL.document,\n+            variables: {\n               chatId,\n               amount: this.chatMessagesAmount,\n             }\n@@ -236,23 +262,32 @@ export class ChatsService {\n           // Add our message from the mutation to the end.\n           chat.messageFeed.messages.push(addMessage);\n           // Write our data back to the cache.\n-          store.writeQuery({ query: getChatQuery, variables: {chatId, amount: this.chatMessagesAmount}, data: {chat} });\n+          store.writeQuery({\n+            query: this.getChatGQL.document,\n+            variables: {\n+              chatId,\n+              amount: this.chatMessagesAmount\n+            },\n+            data: {\n+              chat\n+            }\n+          });\n         }\n         // Update last message cache\n         {\n           // Read the data from our cache for this query.\n-          const {chats}: GetChats.Query = store.readQuery({\n-            query: getChatsQuery,\n-            variables: <GetChats.Variables>{\n+          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n+            query: this.getChatsGQL.document,\n+            variables: {\n               amount: this.chatsMessagesAmount,\n             },\n           });\n           // Add our comment from the mutation to the end.\n           chats.find(chat => chat.id === chatId).messageFeed.messages.push(addMessage);\n           // Write our data back to the cache.\n-          store.writeQuery({\n-            query: getChatsQuery,\n-            variables: <GetChats.Variables>{\n+          store.writeQuery<GetChats.Query, GetChats.Variables>({\n+            query: this.getChatsGQL.document,\n+            variables: {\n               amount: this.chatsMessagesAmount,\n             },\n             data: {\n@@ -260,76 +295,63 @@ export class ChatsService {\n             },\n           });\n         }\n-      },\n+      }\n     });\n   }\n\n   removeChat(chatId: string) {\n-    return this.apollo.mutate({\n-      mutation: removeChatMutation,\n-      variables: <RemoveChat.Variables>{\n+    return this.removeChatGQL.mutate(\n+      {\n         chatId,\n-      },\n-      optimisticResponse: {\n-        __typename: 'Mutation',\n-        removeChat: chatId,\n-      },\n-      update: (store, { data: { removeChat } }) => {\n-        // Read the data from our cache for this query.\n-        const {chats}: GetChats.Query = store.readQuery({\n-          query: getChatsQuery,\n-          variables: <GetChats.Variables>{\n-            amount: this.chatsMessagesAmount,\n-          },\n-        });\n-        // Remove the chat (mutable)\n-        for (const index of chats.keys()) {\n-          if (chats[index].id === removeChat) {\n-            chats.splice(index, 1);\n+      }, {\n+        optimisticResponse: {\n+          __typename: 'Mutation',\n+          removeChat: chatId,\n+        },\n+        update: (store, { data: { removeChat } }) => {\n+          // Read the data from our cache for this query.\n+          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n+            query: this.getChatsGQL.document,\n+            variables: {\n+              amount: this.chatsMessagesAmount,\n+            },\n+          });\n+          // Remove the chat (mutable)\n+          for (const index of chats.keys()) {\n+            if (chats[index].id === removeChat) {\n+              chats.splice(index, 1);\n+            }\n           }\n-        }\n-        // Write our data back to the cache.\n-        store.writeQuery({\n-          query: getChatsQuery,\n-          variables: <GetChats.Variables>{\n-            amount: this.chatsMessagesAmount,\n-          },\n-          data: {\n-            chats,\n-          },\n-        });\n-      },\n-    });\n+          // Write our data back to the cache.\n+          store.writeQuery<GetChats.Query, GetChats.Variables>({\n+            query: this.getChatsGQL.document,\n+            variables: {\n+              amount: this.chatsMessagesAmount,\n+            },\n+            data: {\n+              chats,\n+            },\n+          });\n+        },\n+      }\n+    );\n   }\n\n   removeMessages(chatId: string, messages: GetChat.Messages[], messageIdsOrAll: string[] | boolean) {\n-    let variables: RemoveMessages.Variables | RemoveAllMessages.Variables;\n     let ids: string[] = [];\n-    let mutation: DocumentNode;\n\n-    if (typeof messageIdsOrAll === 'boolean') {\n-      variables = {chatId, all: messageIdsOrAll} as RemoveAllMessages.Variables;\n-      ids = messages.map(message => message.id);\n-      mutation = removeAllMessagesMutation;\n-    } else {\n-      variables = {chatId, messageIds: messageIdsOrAll} as RemoveMessages.Variables;\n-      ids = messageIdsOrAll;\n-      mutation = removeMessagesMutation;\n-    }\n-\n-    return this.apollo.mutate(<MutationOptions>{\n-      mutation,\n-      variables,\n-      optimisticResponse: {\n+    const options = {\n+      optimisticResponse: () => ({\n         __typename: 'Mutation',\n         removeMessages: ids,\n-      },\n-      update: (store, { data: { removeMessages } }: {data: RemoveMessages.Mutation | RemoveAllMessages.Mutation}) => {\n+      }),\n+      update: (store: DataProxy, { data: { removeMessages } }: {data: RemoveMessages.Mutation | RemoveAllMessages.Mutation}) => {\n         // Update the messages cache\n         {\n           // Read the data from our cache for this query.\n-          const {chat}: GetChat.Query = store.readQuery({\n-            query: getChatQuery, variables: {\n+          const {chat} = store.readQuery<GetChat.Query, GetChat.Variables>({\n+            query: this.getChatGQL.document,\n+            variables: {\n               chatId,\n               amount: this.chatMessagesAmount,\n             }\n@@ -343,14 +365,19 @@ export class ChatsService {\n             }\n           });\n           // Write our data back to the cache.\n-          store.writeQuery({ query: getChatQuery, variables: {chatId, amount: this.chatMessagesAmount}, data: {chat} });\n+          store.writeQuery<GetChat.Query, GetChat.Variables>({\n+            query: this.getChatGQL.document,\n+            data: {\n+              chat\n+            }\n+          });\n         }\n         // Update last message cache\n         {\n           // Read the data from our cache for this query.\n-          const {chats}: GetChats.Query = store.readQuery({\n-            query: getChatsQuery,\n-            variables: <GetChats.Variables>{\n+          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n+            query: this.getChatsGQL.document,\n+            variables: {\n               amount: this.chatsMessagesAmount,\n             },\n           });\n@@ -359,9 +386,9 @@ export class ChatsService {\n             .filter(message => !ids.includes(message.id))\n             .sort((a, b) => Number(b.createdAt) - Number(a.createdAt)) || [];\n           // Write our data back to the cache.\n-          store.writeQuery({\n-            query: getChatsQuery,\n-            variables: <GetChats.Variables>{\n+          store.writeQuery<GetChats.Query, GetChats.Variables>({\n+            query: this.getChatsGQL.document,\n+            variables: {\n               amount: this.chatsMessagesAmount,\n             },\n             data: {\n@@ -369,16 +396,30 @@ export class ChatsService {\n             },\n           });\n         }\n-      },\n-    });\n+      }\n+    };\n+\n+    if (typeof messageIdsOrAll === 'boolean') {\n+      ids = messages.map(message => message.id);\n+\n+      return this.removeAllMessagesGQL.mutate({\n+        chatId,\n+        all: messageIdsOrAll\n+      }, options);\n+    } else {\n+      ids = messageIdsOrAll;\n+\n+      return this.removeMessagesGQL.mutate({\n+        chatId,\n+        messageIds: messageIdsOrAll,\n+      }, options);\n+    }\n   }\n\n   getUsers() {\n-    const query = this.apollo.watchQuery<GetUsers.Query>(<WatchQueryOptions>{\n-      query: getUsersQuery,\n-    });\n+    const query = this.getUsersGQL.watch();\n     const users$ = query.valueChanges.pipe(\n-      map((result: ApolloQueryResult<GetUsers.Query>) => result.data.users)\n+      map((result) => result.data.users)\n     );\n\n     return {query, users$};\n@@ -394,117 +435,117 @@ export class ChatsService {\n   }\n\n   addChat(recipientId: string, users: GetUsers.Users[], ouiId: string) {\n-    this.addChat$ = this.apollo.mutate({\n-      mutation: addChatMutation,\n-      variables: <AddChat.Variables>{\n+    this.addChat$ = this.addChatGQL.mutate(\n+      {\n         recipientId,\n-      },\n-      optimisticResponse: {\n-        __typename: 'Mutation',\n-        addChat: {\n-          id: ouiId,\n-          __typename: 'Chat',\n-          name: users.find(user => user.id === recipientId).name,\n-          picture: users.find(user => user.id === recipientId).picture,\n-          allTimeMembers: [\n-            {\n-              id: this.loginService.getUser().id,\n-              __typename: 'User',\n+      }, {\n+        optimisticResponse: {\n+          __typename: 'Mutation',\n+          addChat: {\n+            id: ouiId,\n+            __typename: 'Chat',\n+            name: users.find(user => user.id === recipientId).name,\n+            picture: users.find(user => user.id === recipientId).picture,\n+            allTimeMembers: [\n+              {\n+                id: this.loginService.getUser().id,\n+                __typename: 'User',\n+              },\n+              {\n+                id: recipientId,\n+                __typename: 'User',\n+              }\n+            ],\n+            unreadMessages: 0,\n+            messageFeed: {\n+              __typename: 'MessageFeed',\n+              hasNextPage: false,\n+              cursor: null,\n+              messages: [],\n             },\n-            {\n-              id: recipientId,\n-              __typename: 'User',\n-            }\n-          ],\n-          unreadMessages: 0,\n-          messageFeed: {\n-            __typename: 'MessageFeed',\n-            hasNextPage: false,\n-            cursor: null,\n-            messages: [],\n+            isGroup: false,\n           },\n-          isGroup: false,\n         },\n-      },\n-      update: (store, { data: { addChat } }) => {\n-        // Read the data from our cache for this query.\n-        const {chats}: GetChats.Query = store.readQuery({\n-          query: getChatsQuery,\n-          variables: <GetChats.Variables>{\n-            amount: this.chatsMessagesAmount,\n-          },\n-        });\n-        // Add our comment from the mutation to the end.\n-        chats.push(addChat);\n-        // Write our data back to the cache.\n-        store.writeQuery({\n-          query: getChatsQuery,\n-          variables: <GetChats.Variables>{\n-            amount: this.chatsMessagesAmount,\n-          },\n-          data: {\n-            chats,\n-          },\n-        });\n-      },\n-    }).pipe(share());\n+        update: (store, { data: { addChat } }) => {\n+          // Read the data from our cache for this query.\n+          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n+            query: this.getChatsGQL.document,\n+            variables: {\n+              amount: this.chatsMessagesAmount,\n+            },\n+          });\n+          // Add our comment from the mutation to the end.\n+          chats.push(addChat);\n+          // Write our data back to the cache.\n+          store.writeQuery<GetChats.Query, GetChats.Variables>({\n+            query: this.getChatsGQL.document,\n+            variables: {\n+              amount: this.chatsMessagesAmount,\n+            },\n+            data: {\n+              chats,\n+            },\n+          });\n+        },\n+      }\n+    ).pipe(share());\n     return this.addChat$;\n   }\n\n   addGroup(recipientIds: string[], groupName: string, ouiId: string) {\n-    this.addChat$ = this.apollo.mutate({\n-      mutation: addGroupMutation,\n-      variables: <AddGroup.Variables>{\n+    this.addChat$ = this.addGroupGQL.mutate(\n+      {\n         recipientIds,\n         groupName,\n-      },\n-      optimisticResponse: {\n-        __typename: 'Mutation',\n-        addGroup: {\n-          id: ouiId,\n-          __typename: 'Chat',\n-          name: groupName,\n-          picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n-          userIds: [this.loginService.getUser().id, recipientIds],\n-          allTimeMembers: [\n-            {\n-              id: this.loginService.getUser().id,\n-              __typename: 'User',\n+      }, {\n+        optimisticResponse: {\n+          __typename: 'Mutation',\n+          addGroup: {\n+            id: ouiId,\n+            __typename: 'Chat',\n+            name: groupName,\n+            picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n+            userIds: [this.loginService.getUser().id, recipientIds],\n+            allTimeMembers: [\n+              {\n+                id: this.loginService.getUser().id,\n+                __typename: 'User',\n+              },\n+              ...recipientIds.map(id => ({id, __typename: 'User'})),\n+            ],\n+            unreadMessages: 0,\n+            messageFeed: {\n+              __typename: 'MessageFeed',\n+              hasNextPage: false,\n+              cursor: null,\n+              messages: [],\n             },\n-            ...recipientIds.map(id => ({id, __typename: 'User'})),\n-          ],\n-          unreadMessages: 0,\n-          messageFeed: {\n-            __typename: 'MessageFeed',\n-            hasNextPage: false,\n-            cursor: null,\n-            messages: [],\n+            isGroup: true,\n           },\n-          isGroup: true,\n         },\n-      },\n-      update: (store, { data: { addGroup } }) => {\n-        // Read the data from our cache for this query.\n-        const {chats}: GetChats.Query = store.readQuery({\n-          query: getChatsQuery,\n-          variables: <GetChats.Variables>{\n-            amount: this.chatsMessagesAmount,\n-          },\n-        });\n-        // Add our comment from the mutation to the end.\n-        chats.push(addGroup);\n-        // Write our data back to the cache.\n-        store.writeQuery({\n-          query: getChatsQuery,\n-          variables: <GetChats.Variables>{\n-            amount: this.chatsMessagesAmount,\n-          },\n-          data: {\n-            chats,\n-          },\n-        });\n-      },\n-    }).pipe(share());\n+        update: (store, { data: { addGroup } }) => {\n+          // Read the data from our cache for this query.\n+          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n+            query: this.getChatsGQL.document,\n+            variables: {\n+              amount: this.chatsMessagesAmount,\n+            },\n+          });\n+          // Add our comment from the mutation to the end.\n+          chats.push(addGroup);\n+          // Write our data back to the cache.\n+          store.writeQuery<GetChats.Query, GetChats.Variables>({\n+            query: this.getChatsGQL.document,\n+            variables: {\n+              amount: this.chatsMessagesAmount,\n+            },\n+            data: {\n+              chats,\n+            },\n+          });\n+        },\n+      }\n+    ).pipe(share());\n     return this.addChat$;\n   }\n }\ndiff --git a/client/src/codegen.ts b/client/src/codegen.ts\nnew file mode 100644\nindex 0000000..842c7b0\n--- /dev/null\n+++ b/client/src/codegen.ts\n@@ -0,0 +1,46 @@\n+import * as prompt from 'prompt';\n+import { generate } from 'graphql-code-generator';\n+\n+interface Credentials {\n+  username: string;\n+  password: string;\n+}\n+\n+async function getCredentials(): Promise<Credentials> {\n+  return new Promise<Credentials>(resolve => {\n+    prompt.start();\n+    prompt.get(['username', 'password'], (_err, result) => {\n+      resolve({\n+        username: result.username,\n+        password: result.password,\n+      });\n+    });\n+  });\n+}\n+\n+function generateHeaders({ username, password }: Credentials): string[] {\n+  const Authorization = `Basic ${Buffer.from(\n+    `${username}:${password}`,\n+  ).toString('base64')}`;\n+\n+  return [`Authorization: ${Authorization}`];\n+}\n+\n+async function main() {\n+  const credentials = await getCredentials();\n+  const headers = generateHeaders(credentials);\n+\n+  await generate(\n+    {\n+      schema: 'http://localhost:3000/graphql',\n+      template: 'graphql-codegen-apollo-angular-template',\n+      out: './src/graphql.ts',\n+      args: ['./src/graphql/**/*.ts'],\n+      header: headers,\n+      overwrite: true,\n+    },\n+    true,\n+  );\n+}\n+\n+main();\ndiff --git a/client/src/graphql.ts b/client/src/graphql.ts\nnew file mode 100644\nindex 0000000..de3fee8\n--- /dev/null\n+++ b/client/src/graphql.ts\n@@ -0,0 +1,1259 @@\n+/* tslint:disable */\n+import { GraphQLResolveInfo } from \"graphql\";\n+\n+export type Resolver<Result, Parent = any, Context = any, Args = any> = (\n+  parent: Parent,\n+  args: Args,\n+  context: Context,\n+  info: GraphQLResolveInfo\n+) => Promise<Result> | Result;\n+\n+export type SubscriptionResolver<\n+  Result,\n+  Parent = any,\n+  Context = any,\n+  Args = any\n+> = {\n+  subscribe<R = Result, P = Parent>(\n+    parent: P,\n+    args: Args,\n+    context: Context,\n+    info: GraphQLResolveInfo\n+  ): AsyncIterator<R | Result>;\n+  resolve?<R = Result, P = Parent>(\n+    parent: P,\n+    args: Args,\n+    context: Context,\n+    info: GraphQLResolveInfo\n+  ): R | Result | Promise<R | Result>;\n+};\n+\n+/** A date-time string at UTC, such as 2007-12-03T10:15:30Z, compliant with the `date-time` format outlined in section 5.6 of the RFC 3339 profile of the ISO 8601 standard for representation of dates and times using the Gregorian calendar. */\n+export type DateTime = any;\n+\n+export interface Query {\n+  users?: User[] | null;\n+  chats?: Chat[] | null;\n+  chat?: Chat | null;\n+}\n+\n+export interface User {\n+  id: string;\n+  name?: string | null;\n+  picture?: string | null;\n+  phone?: string | null;\n+}\n+\n+export interface Chat {\n+  id: string /** May be a chat or a group */;\n+  name?: string | null /** Computed for chats */;\n+  picture?: string | null /** Computed for chats */;\n+  allTimeMembers: User[] /** All members, current and past ones. */;\n+  listingMembers: User[] /** Whoever gets the chat listed. For groups includes past members who still didn't delete the group. */;\n+  actualGroupMembers: User[] /** Actual members of the group (they are not the only ones who get the group listed). Null for chats. */;\n+  admins?: User[] | null /** Null for chats */;\n+  owner?: User | null /** If null the group is read-only. Null for chats. */;\n+  messages: (Message | null)[];\n+  messageFeed?: MessageFeed | null /** Return messages in a a Feed Wrapper with cursor based pagination */;\n+  unreadMessages: number /** Computed property */;\n+  isGroup: boolean /** Computed property */;\n+}\n+\n+export interface Message {\n+  id: string;\n+  sender: User;\n+  chat: Chat;\n+  content: string;\n+  createdAt: DateTime;\n+  type: number /** FIXME: should return MessageType */;\n+  recipients: Recipient[] /** Whoever received the message */;\n+  holders: User[] /** Whoever still holds a copy of the message. Cannot be null because the message gets deleted otherwise */;\n+  ownership: boolean /** Computed property */;\n+}\n+\n+export interface Recipient {\n+  user: User;\n+  message: Message;\n+  chat: Chat;\n+  receivedAt?: DateTime | null;\n+  readAt?: DateTime | null;\n+}\n+\n+export interface MessageFeed {\n+  hasNextPage: boolean;\n+  cursor?: string | null;\n+  messages: (Message | null)[];\n+}\n+\n+export interface Mutation {\n+  addChat?: Chat | null;\n+  addGroup?: Chat | null;\n+  removeChat?: string | null;\n+  addMessage?: Message | null;\n+  removeMessages?: (string | null)[] | null;\n+  addMembers?: (string | null)[] | null;\n+  removeMembers?: (string | null)[] | null;\n+  addAdmins?: (string | null)[] | null;\n+  removeAdmins?: (string | null)[] | null;\n+  setGroupName?: string | null;\n+  setGroupPicture?: string | null;\n+  markAsReceived?: boolean | null;\n+  markAsRead?: boolean | null;\n+}\n+\n+export interface Subscription {\n+  messageAdded?: Message | null;\n+  chatAdded?: Chat | null;\n+}\n+export interface ChatQueryArgs {\n+  chatId: string;\n+}\n+export interface MessagesChatArgs {\n+  amount?: number | null;\n+  before?: string | null;\n+}\n+export interface MessageFeedChatArgs {\n+  amount?: number | null;\n+  before?: string | null;\n+}\n+export interface AddChatMutationArgs {\n+  recipientId: string;\n+}\n+export interface AddGroupMutationArgs {\n+  recipientIds: string[];\n+  groupName: string;\n+}\n+export interface RemoveChatMutationArgs {\n+  chatId: string;\n+}\n+export interface AddMessageMutationArgs {\n+  chatId: string;\n+  content: string;\n+}\n+export interface RemoveMessagesMutationArgs {\n+  chatId: string;\n+  messageIds?: (string | null)[] | null;\n+  all?: boolean | null;\n+}\n+export interface AddMembersMutationArgs {\n+  groupId: string;\n+  userIds: string[];\n+}\n+export interface RemoveMembersMutationArgs {\n+  groupId: string;\n+  userIds: string[];\n+}\n+export interface AddAdminsMutationArgs {\n+  groupId: string;\n+  userIds: string[];\n+}\n+export interface RemoveAdminsMutationArgs {\n+  groupId: string;\n+  userIds: string[];\n+}\n+export interface SetGroupNameMutationArgs {\n+  groupId: string;\n+}\n+export interface SetGroupPictureMutationArgs {\n+  groupId: string;\n+}\n+export interface MarkAsReceivedMutationArgs {\n+  chatId: string;\n+}\n+export interface MarkAsReadMutationArgs {\n+  chatId: string;\n+}\n+export interface MessageAddedSubscriptionArgs {\n+  chatId?: string | null;\n+}\n+\n+export enum MessageType {\n+  LOCATION = \"LOCATION\",\n+  TEXT = \"TEXT\",\n+  PICTURE = \"PICTURE\"\n+}\n+\n+export namespace QueryResolvers {\n+  export interface Resolvers<Context = any> {\n+    users?: UsersResolver<User[] | null, any, Context>;\n+    chats?: ChatsResolver<Chat[] | null, any, Context>;\n+    chat?: ChatResolver<Chat | null, any, Context>;\n+  }\n+\n+  export type UsersResolver<\n+    R = User[] | null,\n+    Parent = any,\n+    Context = any\n+  > = Resolver<R, Parent, Context>;\n+  export type ChatsResolver<\n+    R = Chat[] | null,\n+    Parent = any,\n+    Context = any\n+  > = Resolver<R, Parent, Context>;\n+  export type ChatResolver<\n+    R = Chat | null,\n+    Parent = any,\n+    Context = any\n+  > = Resolver<R, Parent, Context, ChatArgs>;\n+  export interface ChatArgs {\n+    chatId: string;\n+  }\n+}\n+\n+export namespace UserResolvers {\n+  export interface Resolvers<Context = any> {\n+    id?: IdResolver<string, any, Context>;\n+    name?: NameResolver<string | null, any, Context>;\n+    picture?: PictureResolver<string | null, any, Context>;\n+    phone?: PhoneResolver<string | null, any, Context>;\n+  }\n+\n+  export type IdResolver<R = string, Parent = any, Context = any> = Resolver<\n+    R,\n+    Parent,\n+    Context\n+  >;\n+  export type NameResolver<\n+    R = string | null,\n+    Parent = any,\n+    Context = any\n+  > = Resolver<R, Parent, Context>;\n+  export type PictureResolver<\n+    R = string | null,\n+    Parent = any,\n+    Context = any\n+  > = Resolver<R, Parent, Context>;\n+  export type PhoneResolver<\n+    R = string | null,\n+    Parent = any,\n+    Context = any\n+  > = Resolver<R, Parent, Context>;\n+}\n+\n+export namespace ChatResolvers {\n+  export interface Resolvers<Context = any> {\n+    id?: IdResolver<string, any, Context> /** May be a chat or a group */;\n+    name?: NameResolver<string | null, any, Context> /** Computed for chats */;\n+    picture?: PictureResolver<\n+      string | null,\n+      any,\n+      Context\n+    > /** Computed for chats */;\n+    allTimeMembers?: AllTimeMembersResolver<\n+      User[],\n+      any,\n+      Context\n+    > /** All members, current and past ones. */;\n+    listingMembers?: ListingMembersResolver<\n+      User[],\n+      any,\n+      Context\n+    > /** Whoever gets the chat listed. For groups includes past members who still didn't delete the group. */;\n+    actualGroupMembers?: ActualGroupMembersResolver<\n+      User[],\n+      any,\n+      Context\n+    > /** Actual members of the group (they are not the only ones who get the group listed). Null for chats. */;\n+    admins?: AdminsResolver<User[] | null, any, Context> /** Null for chats */;\n+    owner?: OwnerResolver<\n+      User | null,\n+      any,\n+      Context\n+    > /** If null the group is read-only. Null for chats. */;\n+    messages?: MessagesResolver<(Message | null)[], any, Context>;\n+    messageFeed?: MessageFeedResolver<\n+      MessageFeed | null,\n+      any,\n+      Context\n+    > /** Return messages in a a Feed Wrapper with cursor based pagination */;\n+    unreadMessages?: UnreadMessagesResolver<\n+      number,\n+      any,\n+      Context\n+    > /** Computed property */;\n+    isGroup?: IsGroupResolver<boolean, any, Context> /** Computed property */;\n+  }\n+\n+  export type IdResolver<R = string, Parent = any, Context = any> = Resolver<\n+    R,\n+    Parent,\n+    Context\n+  >;\n+  export type NameResolver<\n+    R = string | null,\n+    Parent = any,\n+    Context = any\n+  > = Resolver<R, Parent, Context>;\n+  export type PictureResolver<\n+    R = string | null,\n+    Parent = any,\n+    Context = any\n+  > = Resolver<R, Parent, Context>;\n+  export type AllTimeMembersResolver<\n+    R = User[],\n+    Parent = any,\n+    Context = any\n+  > = Resolver<R, Parent, Context>;\n+  export type ListingMembersResolver<\n+    R = User[],\n+    Parent = any,\n+    Context = any\n+  > = Resolver<R, Parent, Context>;\n+  export type ActualGroupMembersResolver<\n+    R = User[],\n+    Parent = any,\n+    Context = any\n+  > = Resolver<R, Parent, Context>;\n+  export type AdminsResolver<\n+    R = User[] | null,\n+    Parent = any,\n+    Context = any\n+  > = Resolver<R, Parent, Context>;\n+  export type OwnerResolver<\n+    R = User | null,\n+    Parent = any,\n+    Context = any\n+  > = Resolver<R, Parent, Context>;\n+  export type MessagesResolver<\n+    R = (Message | null)[],\n+    Parent = any,\n+    Context = any\n+  > = Resolver<R, Parent, Context, MessagesArgs>;\n+  export interface MessagesArgs {\n+    amount?: number | null;\n+    before?: string | null;\n+  }\n+\n+  export type MessageFeedResolver<\n+    R = MessageFeed | null,\n+    Parent = any,\n+    Context = any\n+  > = Resolver<R, Parent, Context, MessageFeedArgs>;\n+  export interface MessageFeedArgs {\n+    amount?: number | null;\n+    before?: string | null;\n+  }\n+\n+  export type UnreadMessagesResolver<\n+    R = number,\n+    Parent = any,\n+    Context = any\n+  > = Resolver<R, Parent, Context>;\n+  export type IsGroupResolver<\n+    R = boolean,\n+    Parent = any,\n+    Context = any\n+  > = Resolver<R, Parent, Context>;\n+}\n+\n+export namespace MessageResolvers {\n+  export interface Resolvers<Context = any> {\n+    id?: IdResolver<string, any, Context>;\n+    sender?: SenderResolver<User, any, Context>;\n+    chat?: ChatResolver<Chat, any, Context>;\n+    content?: ContentResolver<string, any, Context>;\n+    createdAt?: CreatedAtResolver<DateTime, any, Context>;\n+    type?: TypeResolver<\n+      number,\n+      any,\n+      Context\n+    > /** FIXME: should return MessageType */;\n+    recipients?: RecipientsResolver<\n+      Recipient[],\n+      any,\n+      Context\n+    > /** Whoever received the message */;\n+    holders?: HoldersResolver<\n+      User[],\n+      any,\n+      Context\n+    > /** Whoever still holds a copy of the message. Cannot be null because the message gets deleted otherwise */;\n+    ownership?: OwnershipResolver<\n+      boolean,\n+      any,\n+      Context\n+    > /** Computed property */;\n+  }\n+\n+  export type IdResolver<R = string, Parent = any, Context = any> = Resolver<\n+    R,\n+    Parent,\n+    Context\n+  >;\n+  export type SenderResolver<R = User, Parent = any, Context = any> = Resolver<\n+    R,\n+    Parent,\n+    Context\n+  >;\n+  export type ChatResolver<R = Chat, Parent = any, Context = any> = Resolver<\n+    R,\n+    Parent,\n+    Context\n+  >;\n+  export type ContentResolver<\n+    R = string,\n+    Parent = any,\n+    Context = any\n+  > = Resolver<R, Parent, Context>;\n+  export type CreatedAtResolver<\n+    R = DateTime,\n+    Parent = any,\n+    Context = any\n+  > = Resolver<R, Parent, Context>;\n+  export type TypeResolver<R = number, Parent = any, Context = any> = Resolver<\n+    R,\n+    Parent,\n+    Context\n+  >;\n+  export type RecipientsResolver<\n+    R = Recipient[],\n+    Parent = any,\n+    Context = any\n+  > = Resolver<R, Parent, Context>;\n+  export type HoldersResolver<\n+    R = User[],\n+    Parent = any,\n+    Context = any\n+  > = Resolver<R, Parent, Context>;\n+  export type OwnershipResolver<\n+    R = boolean,\n+    Parent = any,\n+    Context = any\n+  > = Resolver<R, Parent, Context>;\n+}\n+\n+export namespace RecipientResolvers {\n+  export interface Resolvers<Context = any> {\n+    user?: UserResolver<User, any, Context>;\n+    message?: MessageResolver<Message, any, Context>;\n+    chat?: ChatResolver<Chat, any, Context>;\n+    receivedAt?: ReceivedAtResolver<DateTime | null, any, Context>;\n+    readAt?: ReadAtResolver<DateTime | null, any, Context>;\n+  }\n+\n+  export type UserResolver<R = User, Parent = any, Context = any> = Resolver<\n+    R,\n+    Parent,\n+    Context\n+  >;\n+  export type MessageResolver<\n+    R = Message,\n+    Parent = any,\n+    Context = any\n+  > = Resolver<R, Parent, Context>;\n+  export type ChatResolver<R = Chat, Parent = any, Context = any> = Resolver<\n+    R,\n+    Parent,\n+    Context\n+  >;\n+  export type ReceivedAtResolver<\n+    R = DateTime | null,\n+    Parent = any,\n+    Context = any\n+  > = Resolver<R, Parent, Context>;\n+  export type ReadAtResolver<\n+    R = DateTime | null,\n+    Parent = any,\n+    Context = any\n+  > = Resolver<R, Parent, Context>;\n+}\n+\n+export namespace MessageFeedResolvers {\n+  export interface Resolvers<Context = any> {\n+    hasNextPage?: HasNextPageResolver<boolean, any, Context>;\n+    cursor?: CursorResolver<string | null, any, Context>;\n+    messages?: MessagesResolver<(Message | null)[], any, Context>;\n+  }\n+\n+  export type HasNextPageResolver<\n+    R = boolean,\n+    Parent = any,\n+    Context = any\n+  > = Resolver<R, Parent, Context>;\n+  export type CursorResolver<\n+    R = string | null,\n+    Parent = any,\n+    Context = any\n+  > = Resolver<R, Parent, Context>;\n+  export type MessagesResolver<\n+    R = (Message | null)[],\n+    Parent = any,\n+    Context = any\n+  > = Resolver<R, Parent, Context>;\n+}\n+\n+export namespace MutationResolvers {\n+  export interface Resolvers<Context = any> {\n+    addChat?: AddChatResolver<Chat | null, any, Context>;\n+    addGroup?: AddGroupResolver<Chat | null, any, Context>;\n+    removeChat?: RemoveChatResolver<string | null, any, Context>;\n+    addMessage?: AddMessageResolver<Message | null, any, Context>;\n+    removeMessages?: RemoveMessagesResolver<\n+      (string | null)[] | null,\n+      any,\n+      Context\n+    >;\n+    addMembers?: AddMembersResolver<(string | null)[] | null, any, Context>;\n+    removeMembers?: RemoveMembersResolver<\n+      (string | null)[] | null,\n+      any,\n+      Context\n+    >;\n+    addAdmins?: AddAdminsResolver<(string | null)[] | null, any, Context>;\n+    removeAdmins?: RemoveAdminsResolver<(string | null)[] | null, any, Context>;\n+    setGroupName?: SetGroupNameResolver<string | null, any, Context>;\n+    setGroupPicture?: SetGroupPictureResolver<string | null, any, Context>;\n+    markAsReceived?: MarkAsReceivedResolver<boolean | null, any, Context>;\n+    markAsRead?: MarkAsReadResolver<boolean | null, any, Context>;\n+  }\n+\n+  export type AddChatResolver<\n+    R = Chat | null,\n+    Parent = any,\n+    Context = any\n+  > = Resolver<R, Parent, Context, AddChatArgs>;\n+  export interface AddChatArgs {\n+    recipientId: string;\n+  }\n+\n+  export type AddGroupResolver<\n+    R = Chat | null,\n+    Parent = any,\n+    Context = any\n+  > = Resolver<R, Parent, Context, AddGroupArgs>;\n+  export interface AddGroupArgs {\n+    recipientIds: string[];\n+    groupName: string;\n+  }\n+\n+  export type RemoveChatResolver<\n+    R = string | null,\n+    Parent = any,\n+    Context = any\n+  > = Resolver<R, Parent, Context, RemoveChatArgs>;\n+  export interface RemoveChatArgs {\n+    chatId: string;\n+  }\n+\n+  export type AddMessageResolver<\n+    R = Message | null,\n+    Parent = any,\n+    Context = any\n+  > = Resolver<R, Parent, Context, AddMessageArgs>;\n+  export interface AddMessageArgs {\n+    chatId: string;\n+    content: string;\n+  }\n+\n+  export type RemoveMessagesResolver<\n+    R = (string | null)[] | null,\n+    Parent = any,\n+    Context = any\n+  > = Resolver<R, Parent, Context, RemoveMessagesArgs>;\n+  export interface RemoveMessagesArgs {\n+    chatId: string;\n+    messageIds?: (string | null)[] | null;\n+    all?: boolean | null;\n+  }\n+\n+  export type AddMembersResolver<\n+    R = (string | null)[] | null,\n+    Parent = any,\n+    Context = any\n+  > = Resolver<R, Parent, Context, AddMembersArgs>;\n+  export interface AddMembersArgs {\n+    groupId: string;\n+    userIds: string[];\n+  }\n+\n+  export type RemoveMembersResolver<\n+    R = (string | null)[] | null,\n+    Parent = any,\n+    Context = any\n+  > = Resolver<R, Parent, Context, RemoveMembersArgs>;\n+  export interface RemoveMembersArgs {\n+    groupId: string;\n+    userIds: string[];\n+  }\n+\n+  export type AddAdminsResolver<\n+    R = (string | null)[] | null,\n+    Parent = any,\n+    Context = any\n+  > = Resolver<R, Parent, Context, AddAdminsArgs>;\n+  export interface AddAdminsArgs {\n+    groupId: string;\n+    userIds: string[];\n+  }\n+\n+  export type RemoveAdminsResolver<\n+    R = (string | null)[] | null,\n+    Parent = any,\n+    Context = any\n+  > = Resolver<R, Parent, Context, RemoveAdminsArgs>;\n+  export interface RemoveAdminsArgs {\n+    groupId: string;\n+    userIds: string[];\n+  }\n+\n+  export type SetGroupNameResolver<\n+    R = string | null,\n+    Parent = any,\n+    Context = any\n+  > = Resolver<R, Parent, Context, SetGroupNameArgs>;\n+  export interface SetGroupNameArgs {\n+    groupId: string;\n+  }\n+\n+  export type SetGroupPictureResolver<\n+    R = string | null,\n+    Parent = any,\n+    Context = any\n+  > = Resolver<R, Parent, Context, SetGroupPictureArgs>;\n+  export interface SetGroupPictureArgs {\n+    groupId: string;\n+  }\n+\n+  export type MarkAsReceivedResolver<\n+    R = boolean | null,\n+    Parent = any,\n+    Context = any\n+  > = Resolver<R, Parent, Context, MarkAsReceivedArgs>;\n+  export interface MarkAsReceivedArgs {\n+    chatId: string;\n+  }\n+\n+  export type MarkAsReadResolver<\n+    R = boolean | null,\n+    Parent = any,\n+    Context = any\n+  > = Resolver<R, Parent, Context, MarkAsReadArgs>;\n+  export interface MarkAsReadArgs {\n+    chatId: string;\n+  }\n+}\n+\n+export namespace SubscriptionResolvers {\n+  export interface Resolvers<Context = any> {\n+    messageAdded?: MessageAddedResolver<Message | null, any, Context>;\n+    chatAdded?: ChatAddedResolver<Chat | null, any, Context>;\n+  }\n+\n+  export type MessageAddedResolver<\n+    R = Message | null,\n+    Parent = any,\n+    Context = any\n+  > = Resolver<R, Parent, Context, MessageAddedArgs>;\n+  export interface MessageAddedArgs {\n+    chatId?: string | null;\n+  }\n+\n+  export type ChatAddedResolver<\n+    R = Chat | null,\n+    Parent = any,\n+    Context = any\n+  > = Resolver<R, Parent, Context>;\n+}\n+\n+export namespace AddChat {\n+  export type Variables = {\n+    recipientId: string;\n+  };\n+\n+  export type Mutation = {\n+    __typename?: \"Mutation\";\n+    addChat?: AddChat | null;\n+  };\n+\n+  export type AddChat = {\n+    __typename?: \"Chat\";\n+    messageFeed?: MessageFeed | null;\n+  } & ChatWithoutMessages.Fragment;\n+\n+  export type MessageFeed = {\n+    __typename?: \"MessageFeed\";\n+    hasNextPage: boolean;\n+    cursor?: string | null;\n+    messages: (Messages | null)[];\n+  };\n+\n+  export type Messages = Message.Fragment;\n+}\n+\n+export namespace AddGroup {\n+  export type Variables = {\n+    recipientIds: string[];\n+    groupName: string;\n+  };\n+\n+  export type Mutation = {\n+    __typename?: \"Mutation\";\n+    addGroup?: AddGroup | null;\n+  };\n+\n+  export type AddGroup = {\n+    __typename?: \"Chat\";\n+    messageFeed?: MessageFeed | null;\n+  } & ChatWithoutMessages.Fragment;\n+\n+  export type MessageFeed = {\n+    __typename?: \"MessageFeed\";\n+    hasNextPage: boolean;\n+    cursor?: string | null;\n+    messages: (Messages | null)[];\n+  };\n+\n+  export type Messages = Message.Fragment;\n+}\n+\n+export namespace AddMessage {\n+  export type Variables = {\n+    chatId: string;\n+    content: string;\n+  };\n+\n+  export type Mutation = {\n+    __typename?: \"Mutation\";\n+    addMessage?: AddMessage | null;\n+  };\n+\n+  export type AddMessage = Message.Fragment;\n+}\n+\n+export namespace ChatAdded {\n+  export type Variables = {\n+    amount: number;\n+  };\n+\n+  export type Subscription = {\n+    __typename?: \"Subscription\";\n+    chatAdded?: ChatAdded | null;\n+  };\n+\n+  export type ChatAdded = {\n+    __typename?: \"Chat\";\n+    messageFeed?: MessageFeed | null;\n+  } & ChatWithoutMessages.Fragment;\n+\n+  export type MessageFeed = {\n+    __typename?: \"MessageFeed\";\n+    hasNextPage: boolean;\n+    cursor?: string | null;\n+    messages: (Messages | null)[];\n+  };\n+\n+  export type Messages = Message.Fragment;\n+}\n+\n+export namespace GetChat {\n+  export type Variables = {\n+    chatId: string;\n+    amount: number;\n+  };\n+\n+  export type Query = {\n+    __typename?: \"Query\";\n+    chat?: Chat | null;\n+  };\n+\n+  export type Chat = {\n+    __typename?: \"Chat\";\n+    messageFeed?: MessageFeed | null;\n+  } & ChatWithoutMessages.Fragment;\n+\n+  export type MessageFeed = {\n+    __typename?: \"MessageFeed\";\n+    hasNextPage: boolean;\n+    cursor?: string | null;\n+    messages: (Messages | null)[];\n+  };\n+\n+  export type Messages = Message.Fragment;\n+}\n+\n+export namespace GetChats {\n+  export type Variables = {\n+    amount: number;\n+  };\n+\n+  export type Query = {\n+    __typename?: \"Query\";\n+    chats?: Chats[] | null;\n+  };\n+\n+  export type Chats = {\n+    __typename?: \"Chat\";\n+    messageFeed?: MessageFeed | null;\n+  } & ChatWithoutMessages.Fragment;\n+\n+  export type MessageFeed = {\n+    __typename?: \"MessageFeed\";\n+    hasNextPage: boolean;\n+    cursor?: string | null;\n+    messages: (Messages | null)[];\n+  };\n+\n+  export type Messages = Message.Fragment;\n+}\n+\n+export namespace GetUsers {\n+  export type Variables = {};\n+\n+  export type Query = {\n+    __typename?: \"Query\";\n+    users?: Users[] | null;\n+  };\n+\n+  export type Users = {\n+    __typename?: \"User\";\n+    id: string;\n+    name?: string | null;\n+    picture?: string | null;\n+  };\n+}\n+\n+export namespace MessageAdded {\n+  export type Variables = {\n+    chatId?: string | null;\n+  };\n+\n+  export type Subscription = {\n+    __typename?: \"Subscription\";\n+    messageAdded?: MessageAdded | null;\n+  };\n+\n+  export type MessageAdded = {\n+    __typename?: \"Message\";\n+    chat: Chat;\n+  } & Message.Fragment;\n+\n+  export type Chat = {\n+    __typename?: \"Chat\";\n+    id: string;\n+  };\n+}\n+\n+export namespace MoreMessages {\n+  export type Variables = {\n+    chatId: string;\n+    amount: number;\n+    before: string;\n+  };\n+\n+  export type Query = {\n+    __typename?: \"Query\";\n+    chat?: Chat | null;\n+  };\n+\n+  export type Chat = {\n+    __typename?: \"Chat\";\n+    messageFeed?: MessageFeed | null;\n+  };\n+\n+  export type MessageFeed = {\n+    __typename?: \"MessageFeed\";\n+    hasNextPage: boolean;\n+    cursor?: string | null;\n+    messages: (Messages | null)[];\n+  };\n+\n+  export type Messages = Message.Fragment;\n+}\n+\n+export namespace RemoveAllMessages {\n+  export type Variables = {\n+    chatId: string;\n+    all?: boolean | null;\n+  };\n+\n+  export type Mutation = {\n+    __typename?: \"Mutation\";\n+    removeMessages?: (string | null)[] | null;\n+  };\n+}\n+\n+export namespace RemoveChat {\n+  export type Variables = {\n+    chatId: string;\n+  };\n+\n+  export type Mutation = {\n+    __typename?: \"Mutation\";\n+    removeChat?: string | null;\n+  };\n+}\n+\n+export namespace RemoveMessages {\n+  export type Variables = {\n+    chatId: string;\n+    messageIds?: (string | null)[] | null;\n+  };\n+\n+  export type Mutation = {\n+    __typename?: \"Mutation\";\n+    removeMessages?: (string | null)[] | null;\n+  };\n+}\n+\n+export namespace ChatWithoutMessages {\n+  export type Fragment = {\n+    __typename?: \"Chat\";\n+    id: string;\n+    name?: string | null;\n+    picture?: string | null;\n+    allTimeMembers: AllTimeMembers[];\n+    unreadMessages: number;\n+    isGroup: boolean;\n+  };\n+\n+  export type AllTimeMembers = {\n+    __typename?: \"User\";\n+    id: string;\n+  };\n+}\n+\n+export namespace Message {\n+  export type Fragment = {\n+    __typename?: \"Message\";\n+    id: string;\n+    chat: Chat;\n+    sender: Sender;\n+    content: string;\n+    createdAt: DateTime;\n+    type: number;\n+    recipients: Recipients[];\n+    ownership: boolean;\n+  };\n+\n+  export type Chat = {\n+    __typename?: \"Chat\";\n+    id: string;\n+  };\n+\n+  export type Sender = {\n+    __typename?: \"User\";\n+    id: string;\n+    name?: string | null;\n+  };\n+\n+  export type Recipients = {\n+    __typename?: \"Recipient\";\n+    user: User;\n+    message: Message;\n+    chat: __Chat;\n+    receivedAt?: DateTime | null;\n+    readAt?: DateTime | null;\n+  };\n+\n+  export type User = {\n+    __typename?: \"User\";\n+    id: string;\n+  };\n+\n+  export type Message = {\n+    __typename?: \"Message\";\n+    id: string;\n+    chat: _Chat;\n+  };\n+\n+  export type _Chat = {\n+    __typename?: \"Chat\";\n+    id: string;\n+  };\n+\n+  export type __Chat = {\n+    __typename?: \"Chat\";\n+    id: string;\n+  };\n+}\n+\n+import { Injectable } from \"@angular/core\";\n+\n+import * as Apollo from \"apollo-angular\";\n+\n+import gql from \"graphql-tag\";\n+\n+const ChatWithoutMessagesFragment = gql`\n+  fragment ChatWithoutMessages on Chat {\n+    id\n+    name\n+    picture\n+    allTimeMembers {\n+      id\n+    }\n+    unreadMessages\n+    isGroup\n+  }\n+`;\n+\n+const MessageFragment = gql`\n+  fragment Message on Message {\n+    id\n+    chat {\n+      id\n+    }\n+    sender {\n+      id\n+      name\n+    }\n+    content\n+    createdAt\n+    type\n+    recipients {\n+      user {\n+        id\n+      }\n+      message {\n+        id\n+        chat {\n+          id\n+        }\n+      }\n+      chat {\n+        id\n+      }\n+      receivedAt\n+      readAt\n+    }\n+    ownership\n+  }\n+`;\n+\n+@Injectable({\n+  providedIn: \"root\"\n+})\n+export class AddChatGQL extends Apollo.Mutation<\n+  AddChat.Mutation,\n+  AddChat.Variables\n+> {\n+  document: any = gql`\n+    mutation AddChat($recipientId: ID!) {\n+      addChat(recipientId: $recipientId) {\n+        ...ChatWithoutMessages\n+        messageFeed {\n+          hasNextPage\n+          cursor\n+          messages {\n+            ...Message\n+          }\n+        }\n+      }\n+    }\n+\n+    ${ChatWithoutMessagesFragment}\n+    ${MessageFragment}\n+  `;\n+}\n+@Injectable({\n+  providedIn: \"root\"\n+})\n+export class AddGroupGQL extends Apollo.Mutation<\n+  AddGroup.Mutation,\n+  AddGroup.Variables\n+> {\n+  document: any = gql`\n+    mutation AddGroup($recipientIds: [ID!]!, $groupName: String!) {\n+      addGroup(recipientIds: $recipientIds, groupName: $groupName) {\n+        ...ChatWithoutMessages\n+        messageFeed {\n+          hasNextPage\n+          cursor\n+          messages {\n+            ...Message\n+          }\n+        }\n+      }\n+    }\n+\n+    ${ChatWithoutMessagesFragment}\n+    ${MessageFragment}\n+  `;\n+}\n+@Injectable({\n+  providedIn: \"root\"\n+})\n+export class AddMessageGQL extends Apollo.Mutation<\n+  AddMessage.Mutation,\n+  AddMessage.Variables\n+> {\n+  document: any = gql`\n+    mutation AddMessage($chatId: ID!, $content: String!) {\n+      addMessage(chatId: $chatId, content: $content) {\n+        ...Message\n+      }\n+    }\n+\n+    ${MessageFragment}\n+  `;\n+}\n+@Injectable({\n+  providedIn: \"root\"\n+})\n+export class ChatAddedGQL extends Apollo.Subscription<\n+  ChatAdded.Subscription,\n+  ChatAdded.Variables\n+> {\n+  document: any = gql`\n+    subscription chatAdded($amount: Int!) {\n+      chatAdded {\n+        ...ChatWithoutMessages\n+        messageFeed(amount: $amount) {\n+          hasNextPage\n+          cursor\n+          messages {\n+            ...Message\n+          }\n+        }\n+      }\n+    }\n+\n+    ${ChatWithoutMessagesFragment}\n+    ${MessageFragment}\n+  `;\n+}\n+@Injectable({\n+  providedIn: \"root\"\n+})\n+export class GetChatGQL extends Apollo.Query<GetChat.Query, GetChat.Variables> {\n+  document: any = gql`\n+    query GetChat($chatId: ID!, $amount: Int!) {\n+      chat(chatId: $chatId) {\n+        ...ChatWithoutMessages\n+        messageFeed(amount: $amount) {\n+          hasNextPage\n+          cursor\n+          messages {\n+            ...Message\n+          }\n+        }\n+      }\n+    }\n+\n+    ${ChatWithoutMessagesFragment}\n+    ${MessageFragment}\n+  `;\n+}\n+@Injectable({\n+  providedIn: \"root\"\n+})\n+export class GetChatsGQL extends Apollo.Query<\n+  GetChats.Query,\n+  GetChats.Variables\n+> {\n+  document: any = gql`\n+    query GetChats($amount: Int!) {\n+      chats {\n+        ...ChatWithoutMessages\n+        messageFeed(amount: $amount) {\n+          hasNextPage\n+          cursor\n+          messages {\n+            ...Message\n+          }\n+        }\n+      }\n+    }\n+\n+    ${ChatWithoutMessagesFragment}\n+    ${MessageFragment}\n+  `;\n+}\n+@Injectable({\n+  providedIn: \"root\"\n+})\n+export class GetUsersGQL extends Apollo.Query<\n+  GetUsers.Query,\n+  GetUsers.Variables\n+> {\n+  document: any = gql`\n+    query GetUsers {\n+      users {\n+        id\n+        name\n+        picture\n+      }\n+    }\n+  `;\n+}\n+@Injectable({\n+  providedIn: \"root\"\n+})\n+export class MessageAddedGQL extends Apollo.Subscription<\n+  MessageAdded.Subscription,\n+  MessageAdded.Variables\n+> {\n+  document: any = gql`\n+    subscription messageAdded($chatId: ID) {\n+      messageAdded(chatId: $chatId) {\n+        ...Message\n+        chat {\n+          id\n+        }\n+      }\n+    }\n+\n+    ${MessageFragment}\n+  `;\n+}\n+@Injectable({\n+  providedIn: \"root\"\n+})\n+export class MoreMessagesGQL extends Apollo.Query<\n+  MoreMessages.Query,\n+  MoreMessages.Variables\n+> {\n+  document: any = gql`\n+    query MoreMessages($chatId: ID!, $amount: Int!, $before: String!) {\n+      chat(chatId: $chatId) {\n+        messageFeed(amount: $amount, before: $before) {\n+          hasNextPage\n+          cursor\n+          messages {\n+            ...Message\n+          }\n+        }\n+      }\n+    }\n+\n+    ${MessageFragment}\n+  `;\n+}\n+@Injectable({\n+  providedIn: \"root\"\n+})\n+export class RemoveAllMessagesGQL extends Apollo.Mutation<\n+  RemoveAllMessages.Mutation,\n+  RemoveAllMessages.Variables\n+> {\n+  document: any = gql`\n+    mutation RemoveAllMessages($chatId: ID!, $all: Boolean) {\n+      removeMessages(chatId: $chatId, all: $all)\n+    }\n+  `;\n+}\n+@Injectable({\n+  providedIn: \"root\"\n+})\n+export class RemoveChatGQL extends Apollo.Mutation<\n+  RemoveChat.Mutation,\n+  RemoveChat.Variables\n+> {\n+  document: any = gql`\n+    mutation RemoveChat($chatId: ID!) {\n+      removeChat(chatId: $chatId)\n+    }\n+  `;\n+}\n+@Injectable({\n+  providedIn: \"root\"\n+})\n+export class RemoveMessagesGQL extends Apollo.Mutation<\n+  RemoveMessages.Mutation,\n+  RemoveMessages.Variables\n+> {\n+  document: any = gql`\n+    mutation RemoveMessages($chatId: ID!, $messageIds: [ID]) {\n+      removeMessages(chatId: $chatId, messageIds: $messageIds)\n+    }\n+  `;\n+}\ndiff --git a/client/src/types.d.ts b/client/src/types.d.ts\ndeleted file mode 100644\nindex b4b3c22..0000000\n--- a/client/src/types.d.ts\n+++ /dev/null\n@@ -1,446 +0,0 @@\n-/* tslint:disable */\n-\n-/** A date-time string at UTC, such as 2007-12-03T10:15:30Z, compliant with the `date-time` format outlined in section 5.6 of the RFC 3339 profile of the ISO 8601 standard for representation of dates and times using the Gregorian calendar. */\n-export type DateTime = any;\n-\n-export interface Query {\n-  users?: User[] | null;\n-  chats?: Chat[] | null;\n-  chat?: Chat | null;\n-}\n-\n-export interface User {\n-  id: string;\n-  name?: string | null;\n-  picture?: string | null;\n-  phone?: string | null;\n-}\n-\n-export interface Chat {\n-  id: string /** May be a chat or a group */;\n-  name?: string | null /** Computed for chats */;\n-  picture?: string | null /** Computed for chats */;\n-  allTimeMembers: User[] /** All members, current and past ones. */;\n-  listingMembers: User[] /** Whoever gets the chat listed. For groups includes past members who still didn't delete the group. */;\n-  actualGroupMembers: User[] /** Actual members of the group (they are not the only ones who get the group listed). Null for chats. */;\n-  admins?: User[] | null /** Null for chats */;\n-  owner?: User | null /** If null the group is read-only. Null for chats. */;\n-  messages: (Message | null)[];\n-  messageFeed?: MessageFeed | null /** Return messages in a a Feed Wrapper with cursor based pagination */;\n-  unreadMessages: number /** Computed property */;\n-  isGroup: boolean /** Computed property */;\n-}\n-\n-export interface Message {\n-  id: string;\n-  sender: User;\n-  chat: Chat;\n-  content: string;\n-  createdAt: DateTime;\n-  type: number /** FIXME: should return MessageType */;\n-  recipients: Recipient[] /** Whoever received the message */;\n-  holders: User[] /** Whoever still holds a copy of the message. Cannot be null because the message gets deleted otherwise */;\n-  ownership: boolean /** Computed property */;\n-}\n-\n-export interface Recipient {\n-  user: User;\n-  message: Message;\n-  chat: Chat;\n-  receivedAt?: DateTime | null;\n-  readAt?: DateTime | null;\n-}\n-\n-export interface MessageFeed {\n-  hasNextPage: boolean;\n-  cursor?: string | null;\n-  messages: (Message | null)[];\n-}\n-\n-export interface Mutation {\n-  addChat?: Chat | null;\n-  addGroup?: Chat | null;\n-  removeChat?: string | null;\n-  addMessage?: Message | null;\n-  removeMessages?: (string | null)[] | null;\n-  addMembers?: (string | null)[] | null;\n-  removeMembers?: (string | null)[] | null;\n-  addAdmins?: (string | null)[] | null;\n-  removeAdmins?: (string | null)[] | null;\n-  setGroupName?: string | null;\n-  setGroupPicture?: string | null;\n-  markAsReceived?: boolean | null;\n-  markAsRead?: boolean | null;\n-}\n-\n-export interface Subscription {\n-  messageAdded?: Message | null;\n-  chatAdded?: Chat | null;\n-}\n-export interface ChatQueryArgs {\n-  chatId: string;\n-}\n-export interface MessagesChatArgs {\n-  amount?: number | null;\n-  before?: string | null;\n-}\n-export interface MessageFeedChatArgs {\n-  amount?: number | null;\n-  before?: string | null;\n-}\n-export interface AddChatMutationArgs {\n-  recipientId: string;\n-}\n-export interface AddGroupMutationArgs {\n-  recipientIds: string[];\n-  groupName: string;\n-}\n-export interface RemoveChatMutationArgs {\n-  chatId: string;\n-}\n-export interface AddMessageMutationArgs {\n-  chatId: string;\n-  content: string;\n-}\n-export interface RemoveMessagesMutationArgs {\n-  chatId: string;\n-  messageIds?: (string | null)[] | null;\n-  all?: boolean | null;\n-}\n-export interface AddMembersMutationArgs {\n-  groupId: string;\n-  userIds: string[];\n-}\n-export interface RemoveMembersMutationArgs {\n-  groupId: string;\n-  userIds: string[];\n-}\n-export interface AddAdminsMutationArgs {\n-  groupId: string;\n-  userIds: string[];\n-}\n-export interface RemoveAdminsMutationArgs {\n-  groupId: string;\n-  userIds: string[];\n-}\n-export interface SetGroupNameMutationArgs {\n-  groupId: string;\n-}\n-export interface SetGroupPictureMutationArgs {\n-  groupId: string;\n-}\n-export interface MarkAsReceivedMutationArgs {\n-  chatId: string;\n-}\n-export interface MarkAsReadMutationArgs {\n-  chatId: string;\n-}\n-export interface MessageAddedSubscriptionArgs {\n-  chatId?: string | null;\n-}\n-\n-export enum MessageType {\n-  LOCATION = \"LOCATION\",\n-  TEXT = \"TEXT\",\n-  PICTURE = \"PICTURE\"\n-}\n-export namespace AddChat {\n-  export type Variables = {\n-    recipientId: string;\n-  };\n-\n-  export type Mutation = {\n-    __typename?: \"Mutation\";\n-    addChat?: AddChat | null;\n-  };\n-\n-  export type AddChat = {\n-    __typename?: \"Chat\";\n-    messageFeed?: MessageFeed | null;\n-  } & ChatWithoutMessages.Fragment;\n-\n-  export type MessageFeed = {\n-    __typename?: \"MessageFeed\";\n-    hasNextPage: boolean;\n-    cursor?: string | null;\n-    messages: (Messages | null)[];\n-  };\n-\n-  export type Messages = Message.Fragment;\n-}\n-export namespace AddGroup {\n-  export type Variables = {\n-    recipientIds: string[];\n-    groupName: string;\n-  };\n-\n-  export type Mutation = {\n-    __typename?: \"Mutation\";\n-    addGroup?: AddGroup | null;\n-  };\n-\n-  export type AddGroup = {\n-    __typename?: \"Chat\";\n-    messageFeed?: MessageFeed | null;\n-  } & ChatWithoutMessages.Fragment;\n-\n-  export type MessageFeed = {\n-    __typename?: \"MessageFeed\";\n-    hasNextPage: boolean;\n-    cursor?: string | null;\n-    messages: (Messages | null)[];\n-  };\n-\n-  export type Messages = Message.Fragment;\n-}\n-export namespace AddMessage {\n-  export type Variables = {\n-    chatId: string;\n-    content: string;\n-  };\n-\n-  export type Mutation = {\n-    __typename?: \"Mutation\";\n-    addMessage?: AddMessage | null;\n-  };\n-\n-  export type AddMessage = Message.Fragment;\n-}\n-export namespace ChatAdded {\n-  export type Variables = {\n-    amount: number;\n-  };\n-\n-  export type Subscription = {\n-    __typename?: \"Subscription\";\n-    chatAdded?: ChatAdded | null;\n-  };\n-\n-  export type ChatAdded = {\n-    __typename?: \"Chat\";\n-    messageFeed?: MessageFeed | null;\n-  } & ChatWithoutMessages.Fragment;\n-\n-  export type MessageFeed = {\n-    __typename?: \"MessageFeed\";\n-    hasNextPage: boolean;\n-    cursor?: string | null;\n-    messages: (Messages | null)[];\n-  };\n-\n-  export type Messages = Message.Fragment;\n-}\n-export namespace GetChat {\n-  export type Variables = {\n-    chatId: string;\n-    amount: number;\n-  };\n-\n-  export type Query = {\n-    __typename?: \"Query\";\n-    chat?: Chat | null;\n-  };\n-\n-  export type Chat = {\n-    __typename?: \"Chat\";\n-    messageFeed?: MessageFeed | null;\n-  } & ChatWithoutMessages.Fragment;\n-\n-  export type MessageFeed = {\n-    __typename?: \"MessageFeed\";\n-    hasNextPage: boolean;\n-    cursor?: string | null;\n-    messages: (Messages | null)[];\n-  };\n-\n-  export type Messages = Message.Fragment;\n-}\n-export namespace GetChats {\n-  export type Variables = {\n-    amount: number;\n-  };\n-\n-  export type Query = {\n-    __typename?: \"Query\";\n-    chats?: Chats[] | null;\n-  };\n-\n-  export type Chats = {\n-    __typename?: \"Chat\";\n-    messageFeed?: MessageFeed | null;\n-  } & ChatWithoutMessages.Fragment;\n-\n-  export type MessageFeed = {\n-    __typename?: \"MessageFeed\";\n-    hasNextPage: boolean;\n-    cursor?: string | null;\n-    messages: (Messages | null)[];\n-  };\n-\n-  export type Messages = Message.Fragment;\n-}\n-export namespace GetUsers {\n-  export type Variables = {};\n-\n-  export type Query = {\n-    __typename?: \"Query\";\n-    users?: Users[] | null;\n-  };\n-\n-  export type Users = {\n-    __typename?: \"User\";\n-    id: string;\n-    name?: string | null;\n-    picture?: string | null;\n-  };\n-}\n-export namespace MessageAdded {\n-  export type Variables = {\n-    chatId?: string | null;\n-  };\n-\n-  export type Subscription = {\n-    __typename?: \"Subscription\";\n-    messageAdded?: MessageAdded | null;\n-  };\n-\n-  export type MessageAdded = {\n-    __typename?: \"Message\";\n-    chat: Chat;\n-  } & Message.Fragment;\n-\n-  export type Chat = {\n-    __typename?: \"Chat\";\n-    id: string;\n-  };\n-}\n-export namespace MoreMessages {\n-  export type Variables = {\n-    chatId: string;\n-    amount: number;\n-    before: string;\n-  };\n-\n-  export type Query = {\n-    __typename?: \"Query\";\n-    chat?: Chat | null;\n-  };\n-\n-  export type Chat = {\n-    __typename?: \"Chat\";\n-    messageFeed?: MessageFeed | null;\n-  };\n-\n-  export type MessageFeed = {\n-    __typename?: \"MessageFeed\";\n-    hasNextPage: boolean;\n-    cursor?: string | null;\n-    messages: (Messages | null)[];\n-  };\n-\n-  export type Messages = Message.Fragment;\n-}\n-export namespace RemoveAllMessages {\n-  export type Variables = {\n-    chatId: string;\n-    all?: boolean | null;\n-  };\n-\n-  export type Mutation = {\n-    __typename?: \"Mutation\";\n-    removeMessages?: (string | null)[] | null;\n-  };\n-}\n-export namespace RemoveChat {\n-  export type Variables = {\n-    chatId: string;\n-  };\n-\n-  export type Mutation = {\n-    __typename?: \"Mutation\";\n-    removeChat?: string | null;\n-  };\n-}\n-export namespace RemoveMessages {\n-  export type Variables = {\n-    chatId: string;\n-    messageIds?: (string | null)[] | null;\n-  };\n-\n-  export type Mutation = {\n-    __typename?: \"Mutation\";\n-    removeMessages?: (string | null)[] | null;\n-  };\n-}\n-\n-export namespace ChatWithoutMessages {\n-  export type Fragment = {\n-    __typename?: \"Chat\";\n-    id: string;\n-    name?: string | null;\n-    picture?: string | null;\n-    allTimeMembers: AllTimeMembers[];\n-    unreadMessages: number;\n-    isGroup: boolean;\n-  };\n-\n-  export type AllTimeMembers = {\n-    __typename?: \"User\";\n-    id: string;\n-  };\n-}\n-\n-export namespace Message {\n-  export type Fragment = {\n-    __typename?: \"Message\";\n-    id: string;\n-    chat: Chat;\n-    sender: Sender;\n-    content: string;\n-    createdAt: DateTime;\n-    type: number;\n-    recipients: Recipients[];\n-    ownership: boolean;\n-  };\n-\n-  export type Chat = {\n-    __typename?: \"Chat\";\n-    id: string;\n-  };\n-\n-  export type Sender = {\n-    __typename?: \"User\";\n-    id: string;\n-    name?: string | null;\n-  };\n-\n-  export type Recipients = {\n-    __typename?: \"Recipient\";\n-    user: User;\n-    message: Message;\n-    chat: __Chat;\n-    receivedAt?: DateTime | null;\n-    readAt?: DateTime | null;\n-  };\n-\n-  export type User = {\n-    __typename?: \"User\";\n-    id: string;\n-  };\n-\n-  export type Message = {\n-    __typename?: \"Message\";\n-    id: string;\n-    chat: _Chat;\n-  };\n-\n-  export type _Chat = {\n-    __typename?: \"Chat\";\n-    id: string;\n-  };\n-\n-  export type __Chat = {\n-    __typename?: \"Chat\";\n-    id: string;\n-  };\n-}\n",
        "manuals": [
          {
            "manualTitle": "A Whatsapp clone written with Angular, Material, Express, Postgresql and Apollo GraphQL.",
            "stepRevision": "56e3257d75fc18dd1850ba8a76ecdc46ad19f508",
            "manualView": "## Startup instructions\n\nThis project is made out of 2 sub-projects - the one is client and the other is server. We will go through the initialization for each of these individually. We will start with the server since the client is dependent on it.\n\n### Server\n\nFirst we need to clone the server project:\n\n    $ git clone git@github.com:Urigo/whatsapp-server-express.git\n\nThen we need to install the NPM dependencies:\n\n    $ npm install\n\nBefore starting the server make sure that postgresql is installed:\n\n    $ sudo apt-get update\n    $ sudo apt-get install postgresql postgresql-contrib\n\nSetup a user named \"test\" with no password by first switching into \"postgres\" account:\n\n    $ sudo -u postgres psql\n\nAnd running the following command:\n\n    postgres=# ALTER USER test WITH PASSWORD '';\n\nTry to run the server:\n\n    $ npm start\n\nIf logs show that connection refused, kill the process and set a random password for the \"test\" user (e.g. \"test\"):\n\n    postgres=# ALTER USER test WITH PASSWORD 'test';\n\nBe sure to set the password in the `ormconfig.json` as well:\n\n```js\n{\n  // ...\n  \"password\": \"test\",\n  // ...\n}\n```\n\nRun the start command again:\n\n    $ npm start\n\n### Client\n\n**Be sure to go through server initialization first**\n\nFirst we need to clone the server project:\n\n    $ git clone git@github.com:Urigo/whatsapp-client-angularcli-material.git\n\nThen we need to install the NPM dependencies:\n\n    $ npm install\n\nStart the app:\n\n    $ npm start"
          },
          {
            "manualTitle": "Step 1: Introduction",
            "stepRevision": "2437e47edf7c1f7530c8b6a38374120ad60b1287",
            "manualView": "# Step 1: How to build an app?\n\nSo you want to build an app!\nThe good news is, it’s not that difficult and after a while anyone can do it!\nAnother good news is that it’s a great skill to have, there is a lot of demand in the job market and you can get to be very creative. Also you can be part of basically any industry you can think of if you know how to program (Healthcare,\nbanking, education, defense, gaming, etc…).\n\nSoftware builds as layers on top of layers.  Every code you write is using code that others have written before already and you can just use it even without fully understanding it.\nThat’s what makes software advance so fast and makes the pace of progress increase as time goes by.\nAlso, most software today is written in an open and free way - everyone can share their code and use other people's code for free.  We even have a social network for that!  It’s called Github.\n\nOne way of learning how to build an app is to study software from the origins. How computers, operating systems and compilers work. It is very interesting but that also takes a long time.\nAnother way to learn how to create a new app is to start by first using all the code that has been already written out there and once we have a real world running app, go deeper to understand how it works from the inside.\n\nI’ll try to use the later approach because I think it is more fun and also it gives context when we will dive inside on how things work. Also it helps when we try to compare between different technologies that do the same thing (Angular vs.\nReact , etc…).\nThat’s because understanding the bigger picture is more important than knowing and remembering the details.\n\nYou noticed that the chapter started with a simple question.\nAll the lessons will start and include many of those questions.  Those are the questions you will need to Google.  The reason is that the most important skill a creator has today is to know how to search Google for the things they need. Most\nprogrammers, even the best ones, don’t remember anything, they just use Google for almost every line of code they write. So know that you don’t need to know it all, Google knows it all for you.\nThis tutorial might get outdated (it won't, hopefully!), but Google will always have the answers so it is more important to know to ask the right questions.\nIn my opinion the most important skill a programmer needs to have is patience and acceptance when something just doesn’t work, enjoy that feeling and start Googling around in order to learn new things and solve this new problem (this process of\nfeeling like you don’t know anything will happen 1000 times a day, also after 20 years of programming).\n\n## Planning the app: how to design an app?\n\nThe first and most important phase in the process is the beginning - designing the app, its parts, components and architecture, and how it all works together.\nFor this tutorial we will build a WhatsApp clone so we have the designs already prepared.\n\nThe process will looks like that:\n\n1. **Visually sketch the screens of the app**. We already know how WhatsApp looks so we’ll just copy it on pen and paper.\n2. **Break down to components**. The best way to describe the UI of apps is to break the UI into separate components and mix them up together. When breaking down to components we would need to think about the following steps:\n  * **Presentational components**: the small building blocks of the UI. For example input fields, images, text, buttons etc…\n  * **Layout**: how the components are positioned inside each other (talk about flex, grid and older layout types)\n  * **Styles**: colors, fonts etc… We might skip that part at the beginning because we can have a perfectly working app without it\n  * **Data dependencies**: the data that those components need - chats, messages, people etc… We will need to to do the following:\n    * Gather data for each component\n    * Attach all those dependencies into one schema\n    * Attach actions for each component\n    * Data updates: decide when the data should be updated in the view (ideally we shouldn’t have to say when but for technical and performance reasons it helps)\n3. **Routing flow**: Moving between screens, what are the different paths the user can navigate through our app\n\nOnce we will finish that process, you will have a big picture in your head (and on your paper) and implementing it with code will be much easier and more technical, meaning you won’t need to know a lot, just Google how to do each step...\n\nAnother interesting thing is, that implementing this same process can be done with a variety of different technologies, so this work will make sense whether you are using web with React or Angular, native apps, Windows UWP or any other\ntechnology for the UI and also relevant whether your data source is a Node, .NET or Ruby server with Mongo, Postgres or MySQL database (if all those words doesn’t mean anything for you, don’t worry, those are just different names to very similar\nideas and we will learn all of them later on and of course you can always just Google them).\n\nHead over to the next chapter to start planning."
          },
          {
            "manualTitle": "Step 2: Planning process",
            "stepRevision": "e59198836c58fead22e1226d1556f7f70003af47",
            "manualView": "## Visual sketch\nWell, not a lot to say about that: just draw your app on paper.\nDoesn’t matter if you don’t know how to draw, it’s just squares and circles.\n\n![alt text](../../assets/chats.png \"Chats\")\n![alt text](../../assets/chat.png \"Chat\")\n![alt text](../../assets/new_chat.png \"New chat\")\n![alt text](../../assets/new_group.png \"New group\")\n![alt text](../../assets/new_group_details.png \"New group details\")\n\n## Breaking down to components\n### -> Google Search\nThis part is a bit more tricky, but after a few examples you’ll get the hang of it.\n\nDraw boxes around every component and subcomponent in different colors and name each one.\nBut how do you know what should be its own component?\nJust follow the **single responsibility principle**, that is, a component should ideally only do one thing. If it ends up growing, it should be decomposed into smaller subcomponents.\n\n![alt text](../../assets/chats_components.png \"Chats components\")\n![alt text](../../assets/chat_components.png \"Chat components\")\n![alt text](../../assets/new_chat_components.png \"New chat components\")\n![alt text](../../assets/new_group_components.png \"New group components\")\n![alt text](../../assets/new_group_details_components.png \"New group details components\")\n\n  * Chats Component\n  * Header Component\n  * ChatsList Component\n  * ChatItem Component\n  * Chat Component\n  * MessagesList Component\n  * MessageItem Component\n  * NewMessage Component\n  * NewChat Component\n  * UsersList Component\n  * UserItem Component\n  * NewGroup Component\n  * NewGroupDetails Component\n\nNow let’s organize them in hierarchy:\n* Chats\n  * Header\n  * ChatsList\n    * ChatItem\n* Chat\n  * Header\n  * MessagesList\n    * MessageItem\n  * NewMessage\n* NewChat\n  * Header\n  * UsersList\n    * UserItem\n* NewGroup\n  * Header\n  * UsersList\n    * UserItem\n  * NewGroupDetails\n\n## Layout\n### -> Google Search\nNow let’s describe how the components are placed within each other.\nThere are infinite ways to explain how components sits inside of each other.\nAny approach has its benefits and limitations.\nWe are going to use one pattern that is pretty common, simple and also covers many types of UI structures.\nUsing that pattern we will keep us covered for a long while (until you would want to create a computer game or a graph. then you’ll need to expand your horizons).\nThis pattern is called flexbox.\n\nIn Flexbox we can separate the alignment in two ways:\nContainer (parent) component behaviour\nChild component behaviour inside the container\n\nWhen describing the parent, we have 3 main properties:\n* Flex-Flow: it's a shorthand for flex-direction and flex-wrap and lets you control the direction in which the items are displayed and whether or not they can wrap onto the next line. There are four possible settings, each of them in the wrap or\nnowrap variant:\n  * row `[wrap, nowrap]`\n  * row-reverse `[wrap, nowrap]`\n  * column `[wrap, nowrap]` - this is the normal way a group of divs would be displayed, so you might not use this often\n  * column-reverse `[wrap, nowrap]`\n* Justify-content: determines where a browser should place the flex items within the row. It works only if the flex items have set widths and if the total width of the items is less than the flex container. There are five possible settings:\n  * Flex-start - squash them to the left\n  * Center - Squash them to the center\n  * Flex-end - squash them to the right\n  * Space-around - squash them away from each other and the ends. Place as much space as possible between all elements\n  * Space-between - Squash the sides to the ends and place as much space between the rest of the elements as possible\n* alignItems: Same as justifyContent but on the secondary axis\n  * Flex-start - squash them to the left\n  * Center - Squash them to the center\n  * Flex-end - squash them to the right\n  * Space-around - squash them away from each other and the ends. Place as much space as possible between all elements\n  * Space-between - Squash the sides to the ends and place as much space between the rest of the elements as possible\n\nThe easiest way to explain that is by showing live examples:\n[awaiting for McFarland's permission to share his pictures]\n\n## Data dependencies\n### -> Google Search\nOur app needs to display data. Otherwise it will be just a nice moving set of pictures…\nSo let’s see what data each component needs and create a descriptions of all the data in our app.\n\nLet’s start with the chats list component:\n\n* Chats: Chats, Users, Messages\n  * Header\n  * ChatsList: Chats, Users, Messages\n    * ChatItem: Chats`[chatId]`, Users`[UserId]`, Message`[messageId]`\n\nWe need to have some basic information about the chats we are part of, like the chat id, the user id and the latest message content.\nThat means we will have to query for all the chats who we are part of, then look at the user IDs and query for those users to retrieve the name. Finally we need to query for the last message of each chat.\n\nNow let’s talk about the chat component (after clicking the single chat app).\nWe need a list of all the messages inside the chat, along with some info about the user or chat on the top corner:\n\n* Chat: Chat, User, Messages\n  * Header: User.name || Chat.name (Because we can have multiple participant could differ from the other person’s name)\n  * MessagesList: Messages\n    * MessageItem: Messages`[ID]`\n  * NewMessage\n\nThe NewChat and NewGroup components will need just some basic info about the user:\n\n* NewChat: Users\n  * Header\n  * UsersList: Users\n    * UserItem: Users`[ID]`\n\n* NewGroup: Users\n  * Header\n  * UsersList: Users\n    * UserItem: Users`[ID]`\n  * NewGroupDetails\n\n## Actions\n### -> Google Search\nBut components can also do thing beyond just displaying data.\nLet’s write all the actions each component can do.\n  * Chats list\n    * tap -> go to chat page\n    * press -> enable selection of multiple chats, confirming the selection will delete them\n  * Single Chat\n    * tap -> send the message\n    * press -> enable selection of multiple messages, confirming the selection will delete them\n  * New Chat\n    * tap -> create new chat or go to the NewGroup component\n  * New Group\n    * tap -> go to NewGroupDetails, then create the group\n\n## Communications\n### -> Google Search\nLet’s define when do we need to get the data from our data source.\nSounds easy but there are a few tricky pitfalls. (query and subscriptions).\nWe will start by simply requesting the data when we first start the component, later on we will tackle subscriptions.\n\n## UI flow\n### -> Google Search\nLet’s draw a diagram of how the user can navigate our app.\n  * Open the app ->\n    * Chats list ->\n      * Click on chat ->\n        * Specific chat page\n          * Click back ->\n            * Chat page\n    * Click on '+' ->\n      * NewChat page ->\n        * Click on user ->\n          * Chat page\n        * Click back ->\n          * Chats list\n        * Click on 'New Group' ->\n          * New Group page\n            * Multiple selection and subsequent confirmation ->\n              * NewGroupDetails page\n                * Insert name and click on confirm ->\n                  * Chat page\n              * Click back ->\n                * New Group page\n          * Click back ->\n            * New Group page\n\nNow let’s look at the whole diagram we created.\nThat basically describes all of our app.\nIf computers were smart enough to understand english and drawings, we would have an app by now.\nBut programming languages are very similar to regular languages so we now just need to translate this into any programming language, just choose a tool and start filling in the gaps.\n\nNext chapter will be about Scaffolding which will tell us the structure to put our code into.\nJust like our sketch has defined parts, we would do the same just with folders and files."
          },
          {
            "manualTitle": "Step 3: Scaffolding",
            "stepRevision": "5bed487598e50759764f608eb4ca3b347c4d6ac5",
            "manualView": "Now we can start writing code!\n\nBut like we said before, software is build in layers and instead of starting from nothing, we can use existing software with prepared structure.\n\n## Tools\n\nFirst let’s install some software that we need on our computer:\n\n### Windows\n\nThe following instructions are for computers with the Windows operating system.\n\nFirst let's start by installing node.js. You need to download an installer, by visiting:\n\n    https://nodejs.org/en/download/\n\nSame, with Yarn:\n\n    https://yarnpkg.com/en/docs/install#windows-stable\n\n\n### Linux\n\nThe following instructions are for computers with the Arch Linux operating system, so your mileage may vary.\n\nFirst let's start by installing npm and node.js, as simple as\n\n    # NodeJS\n    pacman -S nodejs npm\n\n    # Yarn\n    pacman -S yarn\n\n\n### MacOS\n\nThe following instructions are for computers with the MacOS operating system:\n\n    # NodeJS\n    brew install node\n\n    # Yarn\n    brew install yarn --without-node\n\n\n## Packages\n\nThen we will need a way to install our npm global packages on a per-user basis, instead of relying on sudo: https://github.com/sindresorhus/guides/blob/master/npm-global-without-sudo.md\n\nNow it's the right moment to install a couple of global packages we will need later on:\n\n    yarn global add @angular/cli node-sass tortilla typescript\n\n\n## IDE\n\nNow it's time to choose our IDE. I suggest you VSCode, it's available for free: https://code.visualstudio.com/.\nTo have a look at some of the VSCode features you can have a look at the documentation: https://code.visualstudio.com/docs.\n\nVSCode team prepared an Interactive Playground where you can learn what the editor is cappable of and play with it. I highly recommend to check it out!\n\n    Toolbar: Help > Interactive Playground\n\nThere are also many IDEs to recommend and at the end the choice is yours.\n\n## Mobile\n\nWe will talk once again about scaffolding once we will introduce `Android` and `Cordova`."
          },
          {
            "manualTitle": "Step 4: Debugging",
            "stepRevision": "55bc04cf5573341cce8cdfe5fea67fb603e3a74f",
            "manualView": "Before we start writing code, it is important that we learn how to check our code.\n\nThe computer runs through everything we write in split second but we can still pause the computer and go through step by step, check what actually happens when the computer runs our code instructions.\n\nThis phase is sometimes being skipped by developers but trust me, you never want to skip this phase and you should always be super comfortable in debugging your code on whatever environment it’s running on.\n\nThe easiest way to debug your Javascript application is right into your editor:\n  * https://code.visualstudio.com/docs/introvideos/debugging\n  * https://www.jetbrains.com/help/webstorm/debugging-javascript-in-chrome.html\n  * https://blog.jetbrains.com/webstorm/2017/01/debugging-angular-apps/\n\nLater on we will learn how to debug mobile applications."
          },
          {
            "manualTitle": "Step 5: Chats listing",
            "stepRevision": "665d3c8014800890c694d121848b3448cd6335ec",
            "manualView": "![chats-list](https://user-images.githubusercontent.com/7648874/49271096-36bef480-f4a7-11e8-87a9-c9f203f20f6a.png)\n\n## Server\n\nAfter the planning phase it's finally time to start writing some real code!\nWe'll start with the server, so let's install a couple of packages first:\n\n    yarn add apollo-server-express body-parser cors express graphql\n    yarn add -D @types/body-parser @types/cors @types/express @types/graphql\n\nExpress is a fast, unopinionated, minimalist web framework for node.\nCross-Origin Resource Sharing (CORS) is a mechanism that uses additional HTTP headers to let a user agent gain permission to access selected resources from a server on a different origin (domain) than the site currently in use. A user agent makes a cross-origin HTTP request when it requests a resource from a different domain, protocol, or port than the one from which the current document originated.\nWe will need CORS because Webpack's development server used in the client will make use of a different port than the Express server, thus configuring a different origin.\nGraphQL is a query language for APIs and a runtime for fulfilling those queries with your existing data. GraphQL provides a complete and understandable description of the data in your API, gives clients the power to ask for exactly what they need and nothing more, makes it easier to evolve APIs over time, and enables powerful developer tools.\nApollo Server is a community-maintained open-source GraphQL server. It works with pretty much all Node.js HTTP server frameworks. Apollo Server works with any GraphQL schema built with GraphQL.js or with a convenience library such as graphql-tools.\n\nThe GraphQL query language is basically about selecting fields on objects. Because the shape of a GraphQL query closely matches the result, you can predict what the query will return without knowing that much about the server. But it's useful to have an exact description of the data we can ask for - what fields can we select? What kinds of objects might they return? What fields are available on those sub-objects? That's where the schema comes in.\nEvery GraphQL service defines a set of types which completely describe the set of possible data you can query on that service. Then, when queries come in, they are validated and executed against that schema.\n\nFor the moment let's create some empty schemas and resolvers:\n\n[{]: <helper> (diffStep \"1.1\" files=\"schema/*\" module=\"server\")\n\n#### [Step 1.1: Create empty Apollo server](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/1ac723e)\n\n##### Added schema&#x2F;index.ts\n```diff\n@@ -0,0 +1,8 @@\n+┊ ┊1┊import { makeExecutableSchema } from 'apollo-server-express';\n+┊ ┊2┊import typeDefs from './typeDefs';\n+┊ ┊3┊import { resolvers } from './resolvers';\n+┊ ┊4┊\n+┊ ┊5┊export const schema = makeExecutableSchema({\n+┊ ┊6┊  typeDefs,\n+┊ ┊7┊  resolvers,\n+┊ ┊8┊});\n```\n\n##### Added schema&#x2F;resolvers.ts\n```diff\n@@ -0,0 +1,5 @@\n+┊ ┊1┊import { IResolvers } from 'apollo-server-express';\n+┊ ┊2┊\n+┊ ┊3┊export const resolvers: IResolvers = {\n+┊ ┊4┊  Query: {},\n+┊ ┊5┊};\n```\n\n##### Added schema&#x2F;typeDefs.ts\n```diff\n@@ -0,0 +1,2 @@\n+┊ ┊1┊export default `\n+┊ ┊2┊`;\n```\n\n[}]: #\n\nTime to create our index:\n\n[{]: <helper> (diffStep \"1.1\" files=\"^index.ts\" module=\"server\")\n\n#### [Step 1.1: Create empty Apollo server](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/1ac723e)\n\n##### Added index.ts\n```diff\n@@ -0,0 +1,23 @@\n+┊  ┊ 1┊import { schema } from \"./schema\";\n+┊  ┊ 2┊import * as bodyParser from \"body-parser\";\n+┊  ┊ 3┊import * as cors from 'cors';\n+┊  ┊ 4┊import * as express from 'express';\n+┊  ┊ 5┊import { ApolloServer } from \"apollo-server-express\";\n+┊  ┊ 6┊\n+┊  ┊ 7┊const PORT = 3000;\n+┊  ┊ 8┊\n+┊  ┊ 9┊const app = express();\n+┊  ┊10┊\n+┊  ┊11┊app.use(cors());\n+┊  ┊12┊app.use(bodyParser.json());\n+┊  ┊13┊\n+┊  ┊14┊const apollo = new ApolloServer({\n+┊  ┊15┊  schema\n+┊  ┊16┊});\n+┊  ┊17┊\n+┊  ┊18┊apollo.applyMiddleware({\n+┊  ┊19┊  app,\n+┊  ┊20┊  path: '/graphql'\n+┊  ┊21┊});\n+┊  ┊22┊\n+┊  ┊23┊app.listen(PORT);\n```\n\n[}]: #\n\nNow we want to feed our graphql server with some data. Soon we will need `moment`, so let's install it:\n\n    yarn add moment\n\nNow we can create a fake db:\n\n[{]: <helper> (diffStep \"1.2\" files=\"db.ts\" module=\"server\")\n\n#### [Step 1.2: Add fake db](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/a168978)\n\n##### Added db.ts\n```diff\n@@ -0,0 +1,438 @@\n+┊   ┊  1┊import * as moment from 'moment';\n+┊   ┊  2┊\n+┊   ┊  3┊export enum MessageType {\n+┊   ┊  4┊  PICTURE,\n+┊   ┊  5┊  TEXT,\n+┊   ┊  6┊  LOCATION,\n+┊   ┊  7┊}\n+┊   ┊  8┊\n+┊   ┊  9┊export interface User {\n+┊   ┊ 10┊  id: number,\n+┊   ┊ 11┊  username: string,\n+┊   ┊ 12┊  password: string,\n+┊   ┊ 13┊  name: string,\n+┊   ┊ 14┊  picture?: string | null,\n+┊   ┊ 15┊  phone?: string | null,\n+┊   ┊ 16┊}\n+┊   ┊ 17┊\n+┊   ┊ 18┊export interface Chat {\n+┊   ┊ 19┊  id: number,\n+┊   ┊ 20┊  name?: string | null,\n+┊   ┊ 21┊  picture?: string | null,\n+┊   ┊ 22┊  // All members, current and past ones.\n+┊   ┊ 23┊  allTimeMemberIds: number[],\n+┊   ┊ 24┊  // Whoever gets the chat listed. For groups includes past members who still didn't delete the group.\n+┊   ┊ 25┊  listingMemberIds: number[],\n+┊   ┊ 26┊  // Actual members of the group (they are not the only ones who get the group listed). Null for chats.\n+┊   ┊ 27┊  actualGroupMemberIds?: number[] | null,\n+┊   ┊ 28┊  adminIds?: number[] | null,\n+┊   ┊ 29┊  ownerId?: number | null,\n+┊   ┊ 30┊  messages: Message[],\n+┊   ┊ 31┊}\n+┊   ┊ 32┊\n+┊   ┊ 33┊export interface Message {\n+┊   ┊ 34┊  id: number,\n+┊   ┊ 35┊  chatId: number,\n+┊   ┊ 36┊  senderId: number,\n+┊   ┊ 37┊  content: string,\n+┊   ┊ 38┊  createdAt: number,\n+┊   ┊ 39┊  type: MessageType,\n+┊   ┊ 40┊  recipients: Recipient[],\n+┊   ┊ 41┊  holderIds: number[],\n+┊   ┊ 42┊}\n+┊   ┊ 43┊\n+┊   ┊ 44┊export interface Recipient {\n+┊   ┊ 45┊  userId: number,\n+┊   ┊ 46┊  messageId: number,\n+┊   ┊ 47┊  chatId: number,\n+┊   ┊ 48┊  receivedAt: number | null,\n+┊   ┊ 49┊  readAt: number | null,\n+┊   ┊ 50┊}\n+┊   ┊ 51┊\n+┊   ┊ 52┊const users: User[] = [\n+┊   ┊ 53┊  {\n+┊   ┊ 54┊    id: 1,\n+┊   ┊ 55┊    username: 'ethan',\n+┊   ┊ 56┊    password: '$2a$08$NO9tkFLCoSqX1c5wk3s7z.JfxaVMKA.m7zUDdDwEquo4rvzimQeJm', // 111\n+┊   ┊ 57┊    name: 'Ethan Gonzalez',\n+┊   ┊ 58┊    picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n+┊   ┊ 59┊    phone: '+391234567890',\n+┊   ┊ 60┊  },\n+┊   ┊ 61┊  {\n+┊   ┊ 62┊    id: 2,\n+┊   ┊ 63┊    username: 'bryan',\n+┊   ┊ 64┊    password: '$2a$08$xE4FuCi/ifxjL2S8CzKAmuKLwv18ktksSN.F3XYEnpmcKtpbpeZgO', // 222\n+┊   ┊ 65┊    name: 'Bryan Wallace',\n+┊   ┊ 66┊    picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n+┊   ┊ 67┊    phone: '+391234567891',\n+┊   ┊ 68┊  },\n+┊   ┊ 69┊  {\n+┊   ┊ 70┊    id: 3,\n+┊   ┊ 71┊    username: 'avery',\n+┊   ┊ 72┊    password: '$2a$08$UHgH7J8G6z1mGQn2qx2kdeWv0jvgHItyAsL9hpEUI3KJmhVW5Q1d.', // 333\n+┊   ┊ 73┊    name: 'Avery Stewart',\n+┊   ┊ 74┊    picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n+┊   ┊ 75┊    phone: '+391234567892',\n+┊   ┊ 76┊  },\n+┊   ┊ 77┊  {\n+┊   ┊ 78┊    id: 4,\n+┊   ┊ 79┊    username: 'katie',\n+┊   ┊ 80┊    password: '$2a$08$wR1k5Q3T9FC7fUgB7Gdb9Os/GV7dGBBf4PLlWT7HERMFhmFDt47xi', // 444\n+┊   ┊ 81┊    name: 'Katie Peterson',\n+┊   ┊ 82┊    picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n+┊   ┊ 83┊    phone: '+391234567893',\n+┊   ┊ 84┊  },\n+┊   ┊ 85┊  {\n+┊   ┊ 86┊    id: 5,\n+┊   ┊ 87┊    username: 'ray',\n+┊   ┊ 88┊    password: '$2a$08$6.mbXqsDX82ZZ7q5d8Osb..JrGSsNp4R3IKj7mxgF6YGT0OmMw242', // 555\n+┊   ┊ 89┊    name: 'Ray Edwards',\n+┊   ┊ 90┊    picture: 'https://randomuser.me/api/portraits/thumb/men/3.jpg',\n+┊   ┊ 91┊    phone: '+391234567894',\n+┊   ┊ 92┊  },\n+┊   ┊ 93┊  {\n+┊   ┊ 94┊    id: 6,\n+┊   ┊ 95┊    username: 'niko',\n+┊   ┊ 96┊    password: '$2a$08$fL5lZR.Rwf9FWWe8XwwlceiPBBim8n9aFtaem.INQhiKT4.Ux3Uq.', // 666\n+┊   ┊ 97┊    name: 'Niccolò Belli',\n+┊   ┊ 98┊    picture: 'https://randomuser.me/api/portraits/thumb/men/4.jpg',\n+┊   ┊ 99┊    phone: '+391234567895',\n+┊   ┊100┊  },\n+┊   ┊101┊  {\n+┊   ┊102┊    id: 7,\n+┊   ┊103┊    username: 'mario',\n+┊   ┊104┊    password: '$2a$08$nDHDmWcVxDnH5DDT3HMMC.psqcnu6wBiOgkmJUy9IH..qxa3R6YrO', // 777\n+┊   ┊105┊    name: 'Mario Rossi',\n+┊   ┊106┊    picture: 'https://randomuser.me/api/portraits/thumb/men/5.jpg',\n+┊   ┊107┊    phone: '+391234567896',\n+┊   ┊108┊  },\n+┊   ┊109┊];\n+┊   ┊110┊\n+┊   ┊111┊const chats: Chat[] = [\n+┊   ┊112┊  {\n+┊   ┊113┊    id: 1,\n+┊   ┊114┊    name: null,\n+┊   ┊115┊    picture: null,\n+┊   ┊116┊    allTimeMemberIds: [1, 3],\n+┊   ┊117┊    listingMemberIds: [1, 3],\n+┊   ┊118┊    adminIds: null,\n+┊   ┊119┊    ownerId: null,\n+┊   ┊120┊    messages: [\n+┊   ┊121┊      {\n+┊   ┊122┊        id: 1,\n+┊   ┊123┊        chatId: 1,\n+┊   ┊124┊        senderId: 1,\n+┊   ┊125┊        content: 'You on your way?',\n+┊   ┊126┊        createdAt: moment().subtract(1, 'hours').unix(),\n+┊   ┊127┊        type: MessageType.TEXT,\n+┊   ┊128┊        recipients: [\n+┊   ┊129┊          {\n+┊   ┊130┊            userId: 3,\n+┊   ┊131┊            messageId: 1,\n+┊   ┊132┊            chatId: 1,\n+┊   ┊133┊            receivedAt: null,\n+┊   ┊134┊            readAt: null,\n+┊   ┊135┊          },\n+┊   ┊136┊        ],\n+┊   ┊137┊        holderIds: [1, 3],\n+┊   ┊138┊      },\n+┊   ┊139┊      {\n+┊   ┊140┊        id: 2,\n+┊   ┊141┊        chatId: 1,\n+┊   ┊142┊        senderId: 3,\n+┊   ┊143┊        content: 'Yep!',\n+┊   ┊144┊        createdAt: moment().subtract(1, 'hours').add(5, 'minutes').unix(),\n+┊   ┊145┊        type: MessageType.TEXT,\n+┊   ┊146┊        recipients: [\n+┊   ┊147┊          {\n+┊   ┊148┊            userId: 1,\n+┊   ┊149┊            messageId: 2,\n+┊   ┊150┊            chatId: 1,\n+┊   ┊151┊            receivedAt: null,\n+┊   ┊152┊            readAt: null,\n+┊   ┊153┊          },\n+┊   ┊154┊        ],\n+┊   ┊155┊        holderIds: [3, 1],\n+┊   ┊156┊      },\n+┊   ┊157┊    ],\n+┊   ┊158┊  },\n+┊   ┊159┊  {\n+┊   ┊160┊    id: 2,\n+┊   ┊161┊    name: null,\n+┊   ┊162┊    picture: null,\n+┊   ┊163┊    allTimeMemberIds: [1, 4],\n+┊   ┊164┊    listingMemberIds: [1, 4],\n+┊   ┊165┊    adminIds: null,\n+┊   ┊166┊    ownerId: null,\n+┊   ┊167┊    messages: [\n+┊   ┊168┊      {\n+┊   ┊169┊        id: 1,\n+┊   ┊170┊        chatId: 2,\n+┊   ┊171┊        senderId: 1,\n+┊   ┊172┊        content: 'Hey, it\\'s me',\n+┊   ┊173┊        createdAt: moment().subtract(2, 'hours').unix(),\n+┊   ┊174┊        type: MessageType.TEXT,\n+┊   ┊175┊        recipients: [\n+┊   ┊176┊          {\n+┊   ┊177┊            userId: 4,\n+┊   ┊178┊            messageId: 1,\n+┊   ┊179┊            chatId: 2,\n+┊   ┊180┊            receivedAt: null,\n+┊   ┊181┊            readAt: null,\n+┊   ┊182┊          },\n+┊   ┊183┊        ],\n+┊   ┊184┊        holderIds: [1, 4],\n+┊   ┊185┊      },\n+┊   ┊186┊    ],\n+┊   ┊187┊  },\n+┊   ┊188┊  {\n+┊   ┊189┊    id: 3,\n+┊   ┊190┊    name: null,\n+┊   ┊191┊    picture: null,\n+┊   ┊192┊    allTimeMemberIds: [1, 5],\n+┊   ┊193┊    listingMemberIds: [1, 5],\n+┊   ┊194┊    adminIds: null,\n+┊   ┊195┊    ownerId: null,\n+┊   ┊196┊    messages: [\n+┊   ┊197┊      {\n+┊   ┊198┊        id: 1,\n+┊   ┊199┊        chatId: 3,\n+┊   ┊200┊        senderId: 1,\n+┊   ┊201┊        content: 'I should buy a boat',\n+┊   ┊202┊        createdAt: moment().subtract(1, 'days').unix(),\n+┊   ┊203┊        type: MessageType.TEXT,\n+┊   ┊204┊        recipients: [\n+┊   ┊205┊          {\n+┊   ┊206┊            userId: 5,\n+┊   ┊207┊            messageId: 1,\n+┊   ┊208┊            chatId: 3,\n+┊   ┊209┊            receivedAt: null,\n+┊   ┊210┊            readAt: null,\n+┊   ┊211┊          },\n+┊   ┊212┊        ],\n+┊   ┊213┊        holderIds: [1, 5],\n+┊   ┊214┊      },\n+┊   ┊215┊      {\n+┊   ┊216┊        id: 2,\n+┊   ┊217┊        chatId: 3,\n+┊   ┊218┊        senderId: 1,\n+┊   ┊219┊        content: 'You still there?',\n+┊   ┊220┊        createdAt: moment().subtract(1, 'days').add(16, 'hours').unix(),\n+┊   ┊221┊        type: MessageType.TEXT,\n+┊   ┊222┊        recipients: [\n+┊   ┊223┊          {\n+┊   ┊224┊            userId: 5,\n+┊   ┊225┊            messageId: 2,\n+┊   ┊226┊            chatId: 3,\n+┊   ┊227┊            receivedAt: null,\n+┊   ┊228┊            readAt: null,\n+┊   ┊229┊          },\n+┊   ┊230┊        ],\n+┊   ┊231┊        holderIds: [1, 5],\n+┊   ┊232┊      },\n+┊   ┊233┊    ],\n+┊   ┊234┊  },\n+┊   ┊235┊  {\n+┊   ┊236┊    id: 4,\n+┊   ┊237┊    name: null,\n+┊   ┊238┊    picture: null,\n+┊   ┊239┊    allTimeMemberIds: [3, 4],\n+┊   ┊240┊    listingMemberIds: [3, 4],\n+┊   ┊241┊    adminIds: null,\n+┊   ┊242┊    ownerId: null,\n+┊   ┊243┊    messages: [\n+┊   ┊244┊      {\n+┊   ┊245┊        id: 1,\n+┊   ┊246┊        chatId: 4,\n+┊   ┊247┊        senderId: 3,\n+┊   ┊248┊        content: 'Look at my mukluks!',\n+┊   ┊249┊        createdAt: moment().subtract(4, 'days').unix(),\n+┊   ┊250┊        type: MessageType.TEXT,\n+┊   ┊251┊        recipients: [\n+┊   ┊252┊          {\n+┊   ┊253┊            userId: 4,\n+┊   ┊254┊            messageId: 1,\n+┊   ┊255┊            chatId: 4,\n+┊   ┊256┊            receivedAt: null,\n+┊   ┊257┊            readAt: null,\n+┊   ┊258┊          },\n+┊   ┊259┊        ],\n+┊   ┊260┊        holderIds: [3, 4],\n+┊   ┊261┊      },\n+┊   ┊262┊    ],\n+┊   ┊263┊  },\n+┊   ┊264┊  {\n+┊   ┊265┊    id: 5,\n+┊   ┊266┊    name: null,\n+┊   ┊267┊    picture: null,\n+┊   ┊268┊    allTimeMemberIds: [2, 5],\n+┊   ┊269┊    listingMemberIds: [2, 5],\n+┊   ┊270┊    adminIds: null,\n+┊   ┊271┊    ownerId: null,\n+┊   ┊272┊    messages: [\n+┊   ┊273┊      {\n+┊   ┊274┊        id: 1,\n+┊   ┊275┊        chatId: 5,\n+┊   ┊276┊        senderId: 2,\n+┊   ┊277┊        content: 'This is wicked good ice cream.',\n+┊   ┊278┊        createdAt: moment().subtract(2, 'weeks').unix(),\n+┊   ┊279┊        type: MessageType.TEXT,\n+┊   ┊280┊        recipients: [\n+┊   ┊281┊          {\n+┊   ┊282┊            userId: 5,\n+┊   ┊283┊            messageId: 1,\n+┊   ┊284┊            chatId: 5,\n+┊   ┊285┊            receivedAt: null,\n+┊   ┊286┊            readAt: null,\n+┊   ┊287┊          },\n+┊   ┊288┊        ],\n+┊   ┊289┊        holderIds: [2, 5],\n+┊   ┊290┊      },\n+┊   ┊291┊      {\n+┊   ┊292┊        id: 2,\n+┊   ┊293┊        chatId: 6,\n+┊   ┊294┊        senderId: 5,\n+┊   ┊295┊        content: 'Love it!',\n+┊   ┊296┊        createdAt: moment().subtract(2, 'weeks').add(10, 'minutes').unix(),\n+┊   ┊297┊        type: MessageType.TEXT,\n+┊   ┊298┊        recipients: [\n+┊   ┊299┊          {\n+┊   ┊300┊            userId: 2,\n+┊   ┊301┊            messageId: 2,\n+┊   ┊302┊            chatId: 5,\n+┊   ┊303┊            receivedAt: null,\n+┊   ┊304┊            readAt: null,\n+┊   ┊305┊          },\n+┊   ┊306┊        ],\n+┊   ┊307┊        holderIds: [5, 2],\n+┊   ┊308┊      },\n+┊   ┊309┊    ],\n+┊   ┊310┊  },\n+┊   ┊311┊  {\n+┊   ┊312┊    id: 6,\n+┊   ┊313┊    name: null,\n+┊   ┊314┊    picture: null,\n+┊   ┊315┊    allTimeMemberIds: [1, 6],\n+┊   ┊316┊    listingMemberIds: [1],\n+┊   ┊317┊    adminIds: null,\n+┊   ┊318┊    ownerId: null,\n+┊   ┊319┊    messages: [],\n+┊   ┊320┊  },\n+┊   ┊321┊  {\n+┊   ┊322┊    id: 7,\n+┊   ┊323┊    name: null,\n+┊   ┊324┊    picture: null,\n+┊   ┊325┊    allTimeMemberIds: [2, 1],\n+┊   ┊326┊    listingMemberIds: [2],\n+┊   ┊327┊    adminIds: null,\n+┊   ┊328┊    ownerId: null,\n+┊   ┊329┊    messages: [],\n+┊   ┊330┊  },\n+┊   ┊331┊  {\n+┊   ┊332┊    id: 8,\n+┊   ┊333┊    name: 'A user 0 group',\n+┊   ┊334┊    picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n+┊   ┊335┊    allTimeMemberIds: [1, 3, 4, 6],\n+┊   ┊336┊    listingMemberIds: [1, 3, 4, 6],\n+┊   ┊337┊    actualGroupMemberIds: [1, 4, 6],\n+┊   ┊338┊    adminIds: [1, 6],\n+┊   ┊339┊    ownerId: 1,\n+┊   ┊340┊    messages: [\n+┊   ┊341┊      {\n+┊   ┊342┊        id: 1,\n+┊   ┊343┊        chatId: 8,\n+┊   ┊344┊        senderId: 1,\n+┊   ┊345┊        content: 'I made a group',\n+┊   ┊346┊        createdAt: moment().subtract(2, 'weeks').unix(),\n+┊   ┊347┊        type: MessageType.TEXT,\n+┊   ┊348┊        recipients: [\n+┊   ┊349┊          {\n+┊   ┊350┊            userId: 3,\n+┊   ┊351┊            messageId: 1,\n+┊   ┊352┊            chatId: 8,\n+┊   ┊353┊            receivedAt: null,\n+┊   ┊354┊            readAt: null,\n+┊   ┊355┊          },\n+┊   ┊356┊          {\n+┊   ┊357┊            userId: 4,\n+┊   ┊358┊            messageId: 1,\n+┊   ┊359┊            chatId: 8,\n+┊   ┊360┊            receivedAt: moment().subtract(2, 'weeks').add(1, 'minutes').unix(),\n+┊   ┊361┊            readAt: moment().subtract(2, 'weeks').add(5, 'minutes').unix(),\n+┊   ┊362┊          },\n+┊   ┊363┊          {\n+┊   ┊364┊            userId: 6,\n+┊   ┊365┊            messageId: 1,\n+┊   ┊366┊            chatId: 8,\n+┊   ┊367┊            receivedAt: null,\n+┊   ┊368┊            readAt: null,\n+┊   ┊369┊          },\n+┊   ┊370┊        ],\n+┊   ┊371┊        holderIds: [1, 3, 4, 6],\n+┊   ┊372┊      },\n+┊   ┊373┊      {\n+┊   ┊374┊        id: 2,\n+┊   ┊375┊        chatId: 8,\n+┊   ┊376┊        senderId: 1,\n+┊   ┊377┊        content: 'Ops, user 3 was not supposed to be here',\n+┊   ┊378┊        createdAt: moment().subtract(2, 'weeks').add(2, 'minutes').unix(),\n+┊   ┊379┊        type: MessageType.TEXT,\n+┊   ┊380┊        recipients: [\n+┊   ┊381┊          {\n+┊   ┊382┊            userId: 4,\n+┊   ┊383┊            messageId: 2,\n+┊   ┊384┊            chatId: 8,\n+┊   ┊385┊            receivedAt: moment().subtract(2, 'weeks').add(3, 'minutes').unix(),\n+┊   ┊386┊            readAt: moment().subtract(2, 'weeks').add(5, 'minutes').unix(),\n+┊   ┊387┊          },\n+┊   ┊388┊          {\n+┊   ┊389┊            userId: 6,\n+┊   ┊390┊            messageId: 2,\n+┊   ┊391┊            chatId: 8,\n+┊   ┊392┊            receivedAt: null,\n+┊   ┊393┊            readAt: null,\n+┊   ┊394┊          },\n+┊   ┊395┊        ],\n+┊   ┊396┊        holderIds: [1, 4, 6],\n+┊   ┊397┊      },\n+┊   ┊398┊      {\n+┊   ┊399┊        id: 3,\n+┊   ┊400┊        chatId: 8,\n+┊   ┊401┊        senderId: 4,\n+┊   ┊402┊        content: 'Awesome!',\n+┊   ┊403┊        createdAt: moment().subtract(2, 'weeks').add(10, 'minutes').unix(),\n+┊   ┊404┊        type: MessageType.TEXT,\n+┊   ┊405┊        recipients: [\n+┊   ┊406┊          {\n+┊   ┊407┊            userId: 1,\n+┊   ┊408┊            messageId: 3,\n+┊   ┊409┊            chatId: 8,\n+┊   ┊410┊            receivedAt: null,\n+┊   ┊411┊            readAt: null,\n+┊   ┊412┊          },\n+┊   ┊413┊          {\n+┊   ┊414┊            userId: 6,\n+┊   ┊415┊            messageId: 3,\n+┊   ┊416┊            chatId: 8,\n+┊   ┊417┊            receivedAt: null,\n+┊   ┊418┊            readAt: null,\n+┊   ┊419┊          },\n+┊   ┊420┊        ],\n+┊   ┊421┊        holderIds: [1, 4, 6],\n+┊   ┊422┊      },\n+┊   ┊423┊    ],\n+┊   ┊424┊  },\n+┊   ┊425┊  {\n+┊   ┊426┊    id: 9,\n+┊   ┊427┊    name: 'A user 5 group',\n+┊   ┊428┊    picture: null,\n+┊   ┊429┊    allTimeMemberIds: [6, 3],\n+┊   ┊430┊    listingMemberIds: [6, 3],\n+┊   ┊431┊    actualGroupMemberIds: [6, 3],\n+┊   ┊432┊    adminIds: [6],\n+┊   ┊433┊    ownerId: 6,\n+┊   ┊434┊    messages: [],\n+┊   ┊435┊  },\n+┊   ┊436┊];\n+┊   ┊437┊\n+┊   ┊438┊export const db = {users, chats};\n```\n\n[}]: #\n\nIts' finally time to create our schema\n\n[{]: <helper> (diffStep \"1.3\" files=\"schema/typeDefs.ts\" module=\"server\")\n\n#### [Step 1.3: Add resolvers and schema](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/a2cb658)\n\n##### Changed schema&#x2F;typeDefs.ts\n```diff\n@@ -1,2 +1,68 @@\n ┊ 1┊ 1┊export default `\n+┊  ┊ 2┊  type Query {\n+┊  ┊ 3┊    users: [User!]\n+┊  ┊ 4┊    chats: [Chat!]\n+┊  ┊ 5┊    chat(chatId: ID!): Chat\n+┊  ┊ 6┊  }\n+┊  ┊ 7┊\n+┊  ┊ 8┊  enum MessageType {\n+┊  ┊ 9┊    LOCATION\n+┊  ┊10┊    TEXT\n+┊  ┊11┊    PICTURE\n+┊  ┊12┊  }\n+┊  ┊13┊\n+┊  ┊14┊  type Chat {\n+┊  ┊15┊    #May be a chat or a group\n+┊  ┊16┊    id: ID!\n+┊  ┊17┊    #Computed for chats\n+┊  ┊18┊    name: String\n+┊  ┊19┊    #Computed for chats\n+┊  ┊20┊    picture: String\n+┊  ┊21┊    #All members, current and past ones.\n+┊  ┊22┊    allTimeMembers: [User!]!\n+┊  ┊23┊    #Whoever gets the chat listed. For groups includes past members who still didn't delete the group.\n+┊  ┊24┊    listingMembers: [User!]!\n+┊  ┊25┊    #Actual members of the group (they are not the only ones who get the group listed). Null for chats.\n+┊  ┊26┊    actualGroupMembers: [User!]!\n+┊  ┊27┊    #Null for chats\n+┊  ┊28┊    admins: [User!]\n+┊  ┊29┊    #If null the group is read-only. Null for chats.\n+┊  ┊30┊    owner: User\n+┊  ┊31┊    messages(amount: Int): [Message]!\n+┊  ┊32┊    #Computed property\n+┊  ┊33┊    unreadMessages: Int!\n+┊  ┊34┊    #Computed property\n+┊  ┊35┊    isGroup: Boolean!\n+┊  ┊36┊  }\n+┊  ┊37┊\n+┊  ┊38┊  type Message {\n+┊  ┊39┊    id: ID!\n+┊  ┊40┊    sender: User!\n+┊  ┊41┊    chat: Chat!\n+┊  ┊42┊    content: String!\n+┊  ┊43┊    createdAt: String!\n+┊  ┊44┊    #FIXME: should return MessageType\n+┊  ┊45┊    type: Int!\n+┊  ┊46┊    #Whoever received the message\n+┊  ┊47┊    recipients: [Recipient!]!\n+┊  ┊48┊    #Whoever still holds a copy of the message. Cannot be null because the message gets deleted otherwise\n+┊  ┊49┊    holders: [User!]!\n+┊  ┊50┊    #Computed property\n+┊  ┊51┊    ownership: Boolean!\n+┊  ┊52┊  }\n+┊  ┊53┊\n+┊  ┊54┊  type Recipient {\n+┊  ┊55┊    user: User!\n+┊  ┊56┊    message: Message!\n+┊  ┊57┊    chat: Chat!\n+┊  ┊58┊    receivedAt: String\n+┊  ┊59┊    readAt: String\n+┊  ┊60┊  }\n+┊  ┊61┊\n+┊  ┊62┊  type User {\n+┊  ┊63┊    id: ID!\n+┊  ┊64┊    name: String\n+┊  ┊65┊    picture: String\n+┊  ┊66┊    phone: String\n+┊  ┊67┊  }\n ┊ 2┊68┊`;\n```\n\n[}]: #\n\nand our resolvers\n\n[{]: <helper> (diffStep \"1.3\" files=\"schema/resolvers.ts\" module=\"server\")\n\n#### [Step 1.3: Add resolvers and schema](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/a2cb658)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,5 +1,51 @@\n ┊ 1┊ 1┊import { IResolvers } from 'apollo-server-express';\n+┊  ┊ 2┊import { Chat, db, Message, Recipient, User } from \"../db\";\n+┊  ┊ 3┊\n+┊  ┊ 4┊let users = db.users;\n+┊  ┊ 5┊let chats = db.chats;\n+┊  ┊ 6┊const currentUser = 1;\n ┊ 2┊ 7┊\n ┊ 3┊ 8┊export const resolvers: IResolvers = {\n-┊ 4┊  ┊  Query: {},\n+┊  ┊ 9┊  Query: {\n+┊  ┊10┊    // Show all users for the moment.\n+┊  ┊11┊    users: (): User[] => users.filter(user => user.id !== currentUser),\n+┊  ┊12┊    chats: (): Chat[] => chats.filter(chat => chat.listingMemberIds.includes(currentUser)),\n+┊  ┊13┊    chat: (obj: any, {chatId}): Chat | null => chats.find(chat => chat.id === chatId) || null,\n+┊  ┊14┊  },\n+┊  ┊15┊  Chat: {\n+┊  ┊16┊    name: (chat: Chat): string => chat.name ? chat.name : users\n+┊  ┊17┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser))!.name,\n+┊  ┊18┊    picture: (chat: Chat) => chat.name ? chat.picture : users\n+┊  ┊19┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser))!.picture,\n+┊  ┊20┊    allTimeMembers: (chat: Chat): User[] => users.filter(user => chat.allTimeMemberIds.includes(user.id)),\n+┊  ┊21┊    listingMembers: (chat: Chat): User[] => users.filter(user => chat.listingMemberIds.includes(user.id)),\n+┊  ┊22┊    actualGroupMembers: (chat: Chat): User[] => users.filter(user => chat.actualGroupMemberIds && chat.actualGroupMemberIds.includes(user.id)),\n+┊  ┊23┊    admins: (chat: Chat): User[] => users.filter(user => chat.adminIds && chat.adminIds.includes(user.id)),\n+┊  ┊24┊    owner: (chat: Chat): User | null => users.find(user => chat.ownerId === user.id) || null,\n+┊  ┊25┊    messages: (chat: Chat, {amount = 0}: {amount: number}): Message[] => {\n+┊  ┊26┊      const messages = chat.messages\n+┊  ┊27┊      .filter(message => message.holderIds.includes(currentUser))\n+┊  ┊28┊      .sort((a, b) => b.createdAt - a.createdAt) || <Message[]>[];\n+┊  ┊29┊      return (amount ? messages.slice(0, amount) : messages).reverse();\n+┊  ┊30┊    },\n+┊  ┊31┊    unreadMessages: (chat: Chat): number => chat.messages\n+┊  ┊32┊      .filter(message => message.holderIds.includes(currentUser) &&\n+┊  ┊33┊        message.recipients.find(recipient => recipient.userId === currentUser && !recipient.readAt))\n+┊  ┊34┊      .length,\n+┊  ┊35┊    isGroup: (chat: Chat): boolean => !!chat.name,\n+┊  ┊36┊  },\n+┊  ┊37┊  Message: {\n+┊  ┊38┊    chat: (message: Message): Chat | null => chats.find(chat => message.chatId === chat.id) || null,\n+┊  ┊39┊    sender: (message: Message): User | null => users.find(user => user.id === message.senderId) || null,\n+┊  ┊40┊    holders: (message: Message): User[] => users.filter(user => message.holderIds.includes(user.id)),\n+┊  ┊41┊    ownership: (message: Message): boolean => message.senderId === currentUser,\n+┊  ┊42┊  },\n+┊  ┊43┊  Recipient: {\n+┊  ┊44┊    user: (recipient: Recipient): User | null => users.find(user => recipient.userId === user.id) || null,\n+┊  ┊45┊    message: (recipient: Recipient): Message | null => {\n+┊  ┊46┊      const chat = chats.find(chat => recipient.chatId === chat.id);\n+┊  ┊47┊      return chat ? chat.messages.find(message => recipient.messageId === message.id) || null : null;\n+┊  ┊48┊    },\n+┊  ┊49┊    chat: (recipient: Recipient): Chat | null => chats.find(chat => recipient.chatId === chat.id) || null,\n+┊  ┊50┊  },\n ┊ 5┊51┊};\n```\n\n[}]: #\n\nOut basic server is already done and working. We still have no way to do any kind of mutation, but we already set up several queries to return a list of users or chats.\nIn particular we can choose if we want to return all the chats (and how many messages we want to return for each chat) or if we want to return a single chat. We can also choose which and how many properties we want to return for each query.\nWe can start the server by simply running:\n\n    yarn start\n\n## Client\n\nNow we can concentrate on the client and bootstrap it using Angular-CLI.\nFirst you will need to install it globally with:\n\n    yarn global add @angular/cli\n\nThen we can create a new project from scratch:\n\n    ng new client --style scss\n\nTime to install a couple of packages:\n\n    ng add apollo-angular\n    yarn add -D @types/graphql\n\nApollo's Schematics sets everything for us. The only thing missing is to fill the `url`.\n\n[{]: <helper> (diffStep \"1.1\" files=\"src/app/graphql.module.ts\" module=\"client\")\n\n#### [Step 1.1: Add angular-apollo to app module](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/3a40362)\n\n##### Added src&#x2F;app&#x2F;graphql.module.ts\n```diff\n@@ -0,0 +1,25 @@\n+┊  ┊ 1┊import { NgModule} from '@angular/core';\n+┊  ┊ 2┊import { ApolloModule, APOLLO_OPTIONS } from 'apollo-angular';\n+┊  ┊ 3┊import { HttpLinkModule, HttpLink } from 'apollo-angular-link-http';\n+┊  ┊ 4┊import { InMemoryCache } from 'apollo-cache-inmemory';\n+┊  ┊ 5┊\n+┊  ┊ 6┊const uri = 'http://localhost:3000/graphql';\n+┊  ┊ 7┊\n+┊  ┊ 8┊export function createApollo(httpLink: HttpLink) {\n+┊  ┊ 9┊  return {\n+┊  ┊10┊    link: httpLink.create({uri}),\n+┊  ┊11┊    cache: new InMemoryCache(),\n+┊  ┊12┊  };\n+┊  ┊13┊}\n+┊  ┊14┊\n+┊  ┊15┊@NgModule({\n+┊  ┊16┊  exports: [ApolloModule, HttpLinkModule],\n+┊  ┊17┊  providers: [\n+┊  ┊18┊    {\n+┊  ┊19┊      provide: APOLLO_OPTIONS,\n+┊  ┊20┊      useFactory: createApollo,\n+┊  ┊21┊      deps: [HttpLink],\n+┊  ┊22┊    },\n+┊  ┊23┊  ],\n+┊  ┊24┊})\n+┊  ┊25┊export class GraphQLModule {}\n```\n\n[}]: #\n\nLet's take a closer look what Schematics prepared for us.\n\nFirst, it created `graphql.module.ts` and used `ApolloModule` and `HttpLinkModule`.\n\n- `ApolloModule` is the center of using GraphQL in your app! It includes all needed services that allows to use ApolloClient’s features.\n- `HttpLinkModule` makes it easy to fetch data in Angular.\n\n`HttpLinkModule` is optional, you can replace it with any other Link.\nIts biggest advantage of all is that it uses Angular's `HttpClient` internally so it's possible to use it in `NativeScript` or in combination with any other `HttpClient` provider. By using `HttpLinkModule` you get Server-Side Rendering for free, without any additional work.\n\nNext, we got `APOLLO_OPTIONS` provided to Angular.\n\nWe're using the `InMemoryCache` cache, but there are several options like `Redux`, `Hermes` and even `ngrx`.\n\n- `apollo-cache-inmemory` is an official and recommended Apollo Cache.\n\n### Cache and Links\n\nThese are two main parts of Apollo Stack, both are pluggable and customizable.\n\n- **Cache** is responsible for storing data and keeping it consistent.\n- **Links** describe how to access the source of data (usually a GraphQL endpoint).\n\nLet's take a closer look on what cache means for Apollo, we're going to base it on the official `apollo-cache-inmemory`, one of many implementations.\n\nBut first, imagine, we write our own amazing Apollo Cache implementation.\n\n```graphql\nquery getMessages {\n  messages {\n    id\n    content\n    likes\n  }\n}\n```\n\nWhen we execute a query like one above what we get in return is an array of all messages of logged in user:\n\n```json\n{\n  \"data\": {\n    \"messages\": [\n      {\n        \"id\": 0,\n        \"content\": \"Hi\",\n        \"likes\": 0\n      },\n      {\n        \"id\": 1,\n        \"content\": \"Hello\",\n        \"likes\": 0\n      }\n    ]\n  }\n}\n```\n\nOur cache stores the result in exact shape as above.\n\nLater on we add more queries and one of them returns a list of messages from one conversation.\n\nNow, a short story. We've got two users, Niccolo and Dotan.\n\n1. Niccolo opens the app and Apollo fetches all of his messages (I know, it's stupid but stay with me)\n1. One message is to Dotan, Niccolo said \"Hi\" to him.\n1. Now Dotan opens the app and reacts to the message with a like.\n1. After few minutes Niccolo asks for messages from a conversation with Dotan.\n1. Apollo fetches those messages and there is one in which Niccolo says \"Hi\" and it's liked by Dotan.\n1. Now we have the same message twice, one has different state that the other, in one place there is no like, in other, we have +1.\n\nAs you see, our cache is not smart enough to figure out one query might be a subset of another.\nThat's because it doesn't get enough informations.\n\nLet's go back to InMemoryCache and see how it describes itself:\n\n> Thanks to InMemoryCache, it's possible for the results of a query or mutation to update the UI in all the right places. In many cases it's possible for that to happen automatically, whereas in others you need to help the client out a little in doing so.\n\nIt means it could solve the issue we have with duplicated messages with different state.\n\nIt's very important to understand one concept that InMemoryCache is heavily based on, it's called normalization.\n\nThe InMemoryCache splits the result into individual objects, creates a unique identifier for each of them and flattens everything up before saving it to the store.\nMight seem complicated at first, but as InMemoryCache, let's break everything into smaller parts.\n\nFirst, \"breaking the result into pieces\" part. The InMemoryCache tells ApolloClient to add `__typename` field to your query before passing it to the server. I used server for simplicity, it actually passes it to Apollo Links and they are responsible to make a HTTP request. Every Apollo Cache is able to transform a document, that's as a side note.\n\n```graphql\nquery getMessages {\n  messages {\n    id\n    content\n    likes\n    __typename\n  }\n}\n```\n\nThe `__typename` field tells about the type of the object. It's compatible with every GraphQL server as it's part of the specification.\n\n```graphql\ntype Message {\n  id: ID\n  content: String\n  likes: Int\n}\n\ntype Query {\n  messages: [Message]\n}\n```\n\nIn our case, `__typename` returns `Message`. So now InMemoryCache knows that a message is a Message. Computers are stupid, we have to tell them everything!\n\nNext, let's take a look at \"creates a unique identifier\" part.\n\nThe InMemoryCache iterates through every object and looks for the `__typename` and two fields, `id` and `_id` that usually are used as identifiers. Taking our example, it turns every Message object into `Message:1`, `Message:2`, `Message:3` and so on. You get the idea.\n\nIt's the default behaviour but you can change it as you wish:\n\n```typescript\nconst cache = new InMemoryCache({\n  dataIdFromObject(result) {\n    if (result.__typename) {\n      const id = result.uid || result.id || result._id;\n\n      if (id !== undefined) {\n        return `${result.__typename}:${id}`;\n      }\n    }\n    return null;\n  },\n});\n```\n\nGreat, we covered two out of three things InMemoryCache does. Now we're going to explore \"flattens everything up\".\n\nWe're able to understand the type of each individual object and it's unique identifier. It still has to be stored.\n\nWhat InMemoryCache does is it's saves every element on root level in a plain object where the key contains a unique identifier and the value has a body.\n\n```json\n{\n  \"Message:1\": {\n    \"id\": 1,\n    \"content\": \"Hi\",\n    \"likes\": 1,\n    \"__typename\": \"Message\"\n  },\n  \"Message:2\": {\n    \"id\": 2,\n    \"content\": \"Hello\",\n    \"likes\": 0,\n    \"__typename\": \"Message\"\n  },\n  \"ROOT_QUERY\": {\n    \"messages\": [\n      {\n        \"id\": \"Message:1\",\n        \"typename\": \"Message\"\n      },\n      {\n        \"id\": \"Message:2\",\n        \"typename\": \"Message\"\n      }\n    ]\n  }\n}\n```\n\nWait, `ROOT_QUERY`? Yes, it has to somehow store the actual result of every executed query so next time you ask for the same thing, it matches it with the query in store and resolves right away.\n\n> You should be aware that the InMemoryCache stringifies variables of a query too, which means the same queries but with different variables are stored separately. Even the order of those variables matters.\n\nAs you can see, each element in `ROOT_QUERY.message` is kind of a reference to a message record.\n\nLet's bring back our short story, a scenario.\nWhen Niccolo asks for all messages, the whole three part process is started, each message is saved to the store.\nWhen he asks for history of a conversation with Dotan, InMemoryCache starts the process again and if it sees that there is already a massage with the same unique identifier, it knows they both are the same so it merged them.\nThe InMemoryCache can tell what changed and emits the new object to the UI.\nThanks to that we no longer have the same message in two places where one has a like and other doesn't.\n\nUff, Apollo Cache part is done. Thanks for being with us that long, I hope you didn't get bored because there's a lot ahead of us.\n\nLet's talk Apollo Link.\n\nAs I mentioned it's kind of a network stack of Apollo. You execute a document with some metadata like variables or a context, Apollo Client receives it and passes it to the chain of Links.\n\nThe ApolloLink is based on an Observable (not RxJS) and if you know `RxJS` you're familiar with `pipe`. Each Link is basically a function that receives a requested operation and a function that runs the next Link. Just like a pipe!\n\n```typescript\nimport { ApolloLink } from 'apollo-link';\n\nconst log = new ApolloLink((operation, next) => {\n  console.log('Name', operation.operationName);\n  return next(operation);\n});\n```\n\nNow when we add it in `graphql.module.ts` we see the name of each requested operation.\n\nWe can even intercept the result.\n\n```typescript\nconst intercept = new ApolloLink((operation, next) => {\n    return forward(operation).map((data) => {\n        // data from a previous link\n        console.log('data', data);\n        return data;\n    });\n});\n```\n\nAs you can see below, by network we don't always mean making HTTP requests. It could be Http Link at the end of Links chain or WebSocket Link or even something that works on in-memory data.\n\n```typescript\nimport { ApolloLink, Observable } from 'apollo-link';\n\nconst inmemory = new ApolloLink(operation => {\n    return Observable(observer => {\n        // function that executes the operation and returns data\n        const result = resolveOperation(operation);\n\n        observer.next(result);\n        observer.complete();\n    });\n});\n```\n\nYou can find tons of helpful Links [on npm](https://www.npmjs.com/search?q=apollo-link-) and [on Apollo Link documentation](https://www.apollographql.com/docs/link/links/community.html).\n\nWe highly recommend to take a look at Angular related Links [on Apollo Angular documentation](https://www.apollographql.com/docs/angular/guides/tools-and-packages.html).\n\n### GQL Tag\n\nThe `gql` template tag is what you use to define GraphQL queries in your Apollo apps. It parses your GraphQL query into the `GraphQL.js AST format` which may then be consumed by Apollo methods. Whenever Apollo is asking for a GraphQL query you will always want to wrap it in a `gql` template tag.\n\nYou can embed a GraphQL document containing only fragments inside of another GraphQL document using template string interpolation. This allows you to use fragments defined in one part of your codebase inside of a query defined in a completely different file.\n\n[{]: <helper> (diffStep \"1.2\" file=\"src/graphql/fragment.ts\" module=\"client\")\n\n#### [Step 1.2: Add chats service](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/591a455)\n\n##### Added src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -0,0 +1,25 @@\n+┊  ┊ 1┊import {map} from 'rxjs/operators';\n+┊  ┊ 2┊import {Apollo} from 'apollo-angular';\n+┊  ┊ 3┊import {Injectable} from '@angular/core';\n+┊  ┊ 4┊import {getChatsQuery} from '../../graphql/getChats.query';\n+┊  ┊ 5┊\n+┊  ┊ 6┊@Injectable()\n+┊  ┊ 7┊export class ChatsService {\n+┊  ┊ 8┊  messagesAmount = 3;\n+┊  ┊ 9┊\n+┊  ┊10┊  constructor(private apollo: Apollo) {}\n+┊  ┊11┊\n+┊  ┊12┊  getChats() {\n+┊  ┊13┊    const query = this.apollo.watchQuery<any>({\n+┊  ┊14┊      query: getChatsQuery,\n+┊  ┊15┊      variables: {\n+┊  ┊16┊        amount: this.messagesAmount,\n+┊  ┊17┊      },\n+┊  ┊18┊    });\n+┊  ┊19┊    const chats$ = query.valueChanges.pipe(\n+┊  ┊20┊      map((result) => result.data.chats)\n+┊  ┊21┊    );\n+┊  ┊22┊\n+┊  ┊23┊    return {query, chats$};\n+┊  ┊24┊  }\n+┊  ┊25┊}\n```\n\n##### Added src&#x2F;graphql&#x2F;fragment.ts\n```diff\n@@ -0,0 +1,51 @@\n+┊  ┊ 1┊import gql from 'graphql-tag';\n+┊  ┊ 2┊import {DocumentNode} from 'graphql';\n+┊  ┊ 3┊\n+┊  ┊ 4┊export const fragments: {\n+┊  ┊ 5┊  [key: string]: DocumentNode\n+┊  ┊ 6┊} = {\n+┊  ┊ 7┊  chatWithoutMessages: gql`\n+┊  ┊ 8┊    fragment ChatWithoutMessages on Chat {\n+┊  ┊ 9┊      id\n+┊  ┊10┊      name\n+┊  ┊11┊      picture\n+┊  ┊12┊      allTimeMembers {\n+┊  ┊13┊        id\n+┊  ┊14┊      }\n+┊  ┊15┊      unreadMessages\n+┊  ┊16┊      isGroup\n+┊  ┊17┊    }\n+┊  ┊18┊  `,\n+┊  ┊19┊  message: gql`\n+┊  ┊20┊    fragment Message on Message {\n+┊  ┊21┊      id\n+┊  ┊22┊      chat {\n+┊  ┊23┊        id\n+┊  ┊24┊      }\n+┊  ┊25┊      sender {\n+┊  ┊26┊        id\n+┊  ┊27┊        name\n+┊  ┊28┊      }\n+┊  ┊29┊      content\n+┊  ┊30┊      createdAt\n+┊  ┊31┊      type\n+┊  ┊32┊      recipients {\n+┊  ┊33┊        user {\n+┊  ┊34┊          id\n+┊  ┊35┊        }\n+┊  ┊36┊        message {\n+┊  ┊37┊          id\n+┊  ┊38┊          chat {\n+┊  ┊39┊            id\n+┊  ┊40┊          }\n+┊  ┊41┊        }\n+┊  ┊42┊        chat {\n+┊  ┊43┊          id\n+┊  ┊44┊        }\n+┊  ┊45┊        receivedAt\n+┊  ┊46┊        readAt\n+┊  ┊47┊      }\n+┊  ┊48┊      ownership\n+┊  ┊49┊    }\n+┊  ┊50┊  `,\n+┊  ┊51┊};\n```\n\n##### Added src&#x2F;graphql&#x2F;getChats.query.ts\n```diff\n@@ -0,0 +1,17 @@\n+┊  ┊ 1┊import gql from 'graphql-tag';\n+┊  ┊ 2┊import {fragments} from './fragment';\n+┊  ┊ 3┊\n+┊  ┊ 4┊// We use the gql tag to parse our query string into a query document\n+┊  ┊ 5┊export const getChatsQuery = gql`\n+┊  ┊ 6┊  query GetChats($amount: Int) {\n+┊  ┊ 7┊    chats {\n+┊  ┊ 8┊      ...ChatWithoutMessages\n+┊  ┊ 9┊      messages(amount: $amount) {\n+┊  ┊10┊        ...Message\n+┊  ┊11┊      }\n+┊  ┊12┊    }\n+┊  ┊13┊  }\n+┊  ┊14┊\n+┊  ┊15┊  ${fragments['chatWithoutMessages']}\n+┊  ┊16┊  ${fragments['message']}\n+┊  ┊17┊`;\n```\n\n[}]: #\n\n### Use Apollo service\n\nLet's create a simple service to query the chats from our just created server:\n\n[{]: <helper> (diffStep \"1.2\" files=\"src/app/services\" module=\"client\")\n\n#### [Step 1.2: Add chats service](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/591a455)\n\n##### Added src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -0,0 +1,25 @@\n+┊  ┊ 1┊import {map} from 'rxjs/operators';\n+┊  ┊ 2┊import {Apollo} from 'apollo-angular';\n+┊  ┊ 3┊import {Injectable} from '@angular/core';\n+┊  ┊ 4┊import {getChatsQuery} from '../../graphql/getChats.query';\n+┊  ┊ 5┊\n+┊  ┊ 6┊@Injectable()\n+┊  ┊ 7┊export class ChatsService {\n+┊  ┊ 8┊  messagesAmount = 3;\n+┊  ┊ 9┊\n+┊  ┊10┊  constructor(private apollo: Apollo) {}\n+┊  ┊11┊\n+┊  ┊12┊  getChats() {\n+┊  ┊13┊    const query = this.apollo.watchQuery<any>({\n+┊  ┊14┊      query: getChatsQuery,\n+┊  ┊15┊      variables: {\n+┊  ┊16┊        amount: this.messagesAmount,\n+┊  ┊17┊      },\n+┊  ┊18┊    });\n+┊  ┊19┊    const chats$ = query.valueChanges.pipe(\n+┊  ┊20┊      map((result) => result.data.chats)\n+┊  ┊21┊    );\n+┊  ┊22┊\n+┊  ┊23┊    return {query, chats$};\n+┊  ┊24┊  }\n+┊  ┊25┊}\n```\n\n[}]: #\n\nWe just learned how to use Apollo to attach GraphQL query results to the Angular UI.\n\nThe `watchQuery` method returns a `QueryRef` object which has the `valueChanges` property that is an `Observable`.\n\nEvery fetched data is stored in Apollo Client’s cache, so if some other query fetches new information about the chats, this component will update to remain consistent.\n\nIt’s also possible to fetch data only once. You simply use `query` method instead of `watchQuery`. The query method of Apollo service returns an Observable too that also resolves with the same result as above.\n\n#### But what is a `QueryRef`?\n\nAs you know, `query` method returns an Observable that emits a result, just once, then the observable completes. `watchQuery` works a bit different. It fetches data then stays open and listens to the Cache for updates.\n\nSo why `watchQuery` can not simply expose an Observable and it serves `QueryRef` instead?\n\nBecause Apollo Angular is a bridge between Apollo Client (core library) and Angular framework it has to operate on RxJS based Observables. RxJS Observable has a simple API that cannot be easily extended and it's in general a bad practice.\n\nWhy we're talking about those things? Apollo Client exposes an Observable that has bunch of custom method on it. They are super useful and their purpose is to talk to Apollo through them.\n\nSince we have to turn Apollo's Observable to something that is compatible with RxJS we decided to expose an object that has all those methods and `valueChanges` property that is a regular RxJS Observable.\n\n#### Make our app pretty\n\nWe will use Materials for the UI, so let's install it:\n\n    yarn add @angular/cdk @angular/material hammerjs ng2-truncate\n\nLet's configure Material:\n\n[{]: <helper> (diffStep \"1.3\" files=\"src/index.ts, src/main.ts, src/styles.scss\" module=\"client\")\n\n#### [Step 1.3: List the chats](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/7d716ee)\n\n##### Changed src&#x2F;main.ts\n```diff\n@@ -4,6 +4,9 @@\n ┊ 4┊ 4┊import { AppModule } from './app/app.module';\n ┊ 5┊ 5┊import { environment } from './environments/environment';\n ┊ 6┊ 6┊\n+┊  ┊ 7┊// Material gestures\n+┊  ┊ 8┊import 'hammerjs';\n+┊  ┊ 9┊\n ┊ 7┊10┊if (environment.production) {\n ┊ 8┊11┊  enableProdMode();\n ┊ 9┊12┊}\n```\n\n##### Changed src&#x2F;styles.scss\n```diff\n@@ -1 +1,28 @@\n ┊ 1┊ 1┊/* You can add global styles to this file, and also import other style files */\n+┊  ┊ 2┊\n+┊  ┊ 3┊/* Meterial theme */\n+┊  ┊ 4┊@import \"~@angular/material/prebuilt-themes/indigo-pink.css\";\n+┊  ┊ 5┊\n+┊  ┊ 6┊:root {\n+┊  ┊ 7┊  --primary: #2c6157;\n+┊  ┊ 8┊  --secondary: #6fd056;\n+┊  ┊ 9┊}\n+┊  ┊10┊\n+┊  ┊11┊body {\n+┊  ┊12┊  margin: 0;\n+┊  ┊13┊}\n+┊  ┊14┊\n+┊  ┊15┊.mat-primary {\n+┊  ┊16┊  background-color: var(--primary) !important;\n+┊  ┊17┊  color: white;\n+┊  ┊18┊}\n+┊  ┊19┊\n+┊  ┊20┊.mat-secondary {\n+┊  ┊21┊  background-color: var(--secondary) !important;\n+┊  ┊22┊  color: white;\n+┊  ┊23┊}\n+┊  ┊24┊\n+┊  ┊25┊.mat-toolbar {\n+┊  ┊26┊  color: white;\n+┊  ┊27┊  background-color: var(--primary) !important;\n+┊  ┊28┊}\n```\n\n[}]: #\n\nWe're now creating a `shared` module where we will define our header component where we're going to project a different content from each component:\n\n[{]: <helper> (diffStep \"1.3\" files=\"src/app/shared/*\" module=\"client\")\n\n#### [Step 1.3: List the chats](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/7d716ee)\n\n##### Added src&#x2F;app&#x2F;shared&#x2F;components&#x2F;toolbar&#x2F;toolbar.component.scss\n```diff\n@@ -0,0 +1,15 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊  height: 8vh;\n+┊  ┊ 4┊}\n+┊  ┊ 5┊\n+┊  ┊ 6┊.mat-toolbar {\n+┊  ┊ 7┊  justify-content: space-between;\n+┊  ┊ 8┊  height: 100%;\n+┊  ┊ 9┊\n+┊  ┊10┊  .left-block {\n+┊  ┊11┊    display: flex;\n+┊  ┊12┊    height: 8vh;\n+┊  ┊13┊    line-height: 8vh;\n+┊  ┊14┊  }\n+┊  ┊15┊}\n```\n\n##### Added src&#x2F;app&#x2F;shared&#x2F;components&#x2F;toolbar&#x2F;toolbar.component.ts\n```diff\n@@ -0,0 +1,19 @@\n+┊  ┊ 1┊import {Component} from '@angular/core';\n+┊  ┊ 2┊\n+┊  ┊ 3┊@Component({\n+┊  ┊ 4┊  selector: 'app-toolbar',\n+┊  ┊ 5┊  template: `\n+┊  ┊ 6┊    <mat-toolbar>\n+┊  ┊ 7┊      <div class=\"left-block\">\n+┊  ┊ 8┊        <ng-content select=\".navigation\"></ng-content>\n+┊  ┊ 9┊        <ng-content select=\".profile-pic\"></ng-content>\n+┊  ┊10┊        <ng-content select=\".title\"></ng-content>\n+┊  ┊11┊      </div>\n+┊  ┊12┊      <ng-content select=\".menu\"></ng-content>\n+┊  ┊13┊    </mat-toolbar>\n+┊  ┊14┊  `,\n+┊  ┊15┊  styleUrls: ['./toolbar.component.scss']\n+┊  ┊16┊})\n+┊  ┊17┊export class ToolbarComponent {\n+┊  ┊18┊\n+┊  ┊19┊}\n```\n\n##### Added src&#x2F;app&#x2F;shared&#x2F;shared.module.ts\n```diff\n@@ -0,0 +1,28 @@\n+┊  ┊ 1┊import {BrowserModule} from '@angular/platform-browser';\n+┊  ┊ 2┊import {NgModule} from '@angular/core';\n+┊  ┊ 3┊\n+┊  ┊ 4┊import {MatToolbarModule} from '@angular/material';\n+┊  ┊ 5┊import {ToolbarComponent} from './components/toolbar/toolbar.component';\n+┊  ┊ 6┊import {FormsModule} from '@angular/forms';\n+┊  ┊ 7┊import {BrowserAnimationsModule} from '@angular/platform-browser/animations';\n+┊  ┊ 8┊\n+┊  ┊ 9┊@NgModule({\n+┊  ┊10┊  declarations: [\n+┊  ┊11┊    ToolbarComponent,\n+┊  ┊12┊  ],\n+┊  ┊13┊  imports: [\n+┊  ┊14┊    BrowserModule,\n+┊  ┊15┊    // Material\n+┊  ┊16┊    MatToolbarModule,\n+┊  ┊17┊    // Animations\n+┊  ┊18┊    BrowserAnimationsModule,\n+┊  ┊19┊    // Forms\n+┊  ┊20┊    FormsModule,\n+┊  ┊21┊  ],\n+┊  ┊22┊  providers: [],\n+┊  ┊23┊  exports: [\n+┊  ┊24┊    ToolbarComponent,\n+┊  ┊25┊  ],\n+┊  ┊26┊})\n+┊  ┊27┊export class SharedModule {\n+┊  ┊28┊}\n```\n\n[}]: #\n\nNow we want to create the `chats-lister` module, with a container component called `ChatsComponent` and a couple of presentational components. Each and every chat item would be presented with a default profile picture as a placeholder, so before we proceed we will have to download it to the `src/assets` directory:\n\n    $ wget https://raw.githubusercontent.com/DAB0mB/whatsapp-client-angularcli-material/c75c2416b1990da3588015f76b8338764f44d6ec/src/assets/default-profile-pic.jpg -P src/assets\n\nAnd now we can proceed to creating the relevant components and their style sheets:\n\n[{]: <helper> (diffStep \"1.3\" files=\"src/app/chats-lister/*\" module=\"client\")\n\n#### [Step 1.3: List the chats](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/7d716ee)\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;chats-lister.module.ts\n```diff\n@@ -0,0 +1,49 @@\n+┊  ┊ 1┊import { BrowserModule } from '@angular/platform-browser';\n+┊  ┊ 2┊import { NgModule } from '@angular/core';\n+┊  ┊ 3┊\n+┊  ┊ 4┊import {BrowserAnimationsModule} from '@angular/platform-browser/animations';\n+┊  ┊ 5┊import {MatButtonModule, MatIconModule, MatListModule, MatMenuModule} from '@angular/material';\n+┊  ┊ 6┊import {RouterModule, Routes} from '@angular/router';\n+┊  ┊ 7┊import {FormsModule} from '@angular/forms';\n+┊  ┊ 8┊import {ChatsService} from '../services/chats.service';\n+┊  ┊ 9┊import {ChatItemComponent} from './components/chat-item/chat-item.component';\n+┊  ┊10┊import {ChatsComponent} from './containers/chats/chats.component';\n+┊  ┊11┊import {ChatsListComponent} from './components/chats-list/chats-list.component';\n+┊  ┊12┊import {TruncateModule} from 'ng2-truncate';\n+┊  ┊13┊import {SharedModule} from '../shared/shared.module';\n+┊  ┊14┊\n+┊  ┊15┊const routes: Routes = [\n+┊  ┊16┊  {path: '', redirectTo: 'chats', pathMatch: 'full'},\n+┊  ┊17┊  {path: 'chats', component: ChatsComponent},\n+┊  ┊18┊];\n+┊  ┊19┊\n+┊  ┊20┊@NgModule({\n+┊  ┊21┊  declarations: [\n+┊  ┊22┊    ChatsComponent,\n+┊  ┊23┊    ChatsListComponent,\n+┊  ┊24┊    ChatItemComponent,\n+┊  ┊25┊  ],\n+┊  ┊26┊  imports: [\n+┊  ┊27┊    BrowserModule,\n+┊  ┊28┊    // Material\n+┊  ┊29┊    MatMenuModule,\n+┊  ┊30┊    MatIconModule,\n+┊  ┊31┊    MatButtonModule,\n+┊  ┊32┊    MatListModule,\n+┊  ┊33┊    // Animations\n+┊  ┊34┊    BrowserAnimationsModule,\n+┊  ┊35┊    // Routing\n+┊  ┊36┊    RouterModule.forChild(routes),\n+┊  ┊37┊    // Forms\n+┊  ┊38┊    FormsModule,\n+┊  ┊39┊    // Truncate Pipe\n+┊  ┊40┊    TruncateModule,\n+┊  ┊41┊    // Feature modules\n+┊  ┊42┊    SharedModule,\n+┊  ┊43┊  ],\n+┊  ┊44┊  providers: [\n+┊  ┊45┊    ChatsService,\n+┊  ┊46┊  ],\n+┊  ┊47┊})\n+┊  ┊48┊export class ChatsListerModule {\n+┊  ┊49┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chat-item&#x2F;chat-item.component.scss\n```diff\n@@ -0,0 +1,44 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊  width: 100%;\n+┊  ┊ 4┊}\n+┊  ┊ 5┊\n+┊  ┊ 6┊.chat-row {\n+┊  ┊ 7┊  margin: 10px 0 0 10px;\n+┊  ┊ 8┊  height: 60px;\n+┊  ┊ 9┊  display: flex;\n+┊  ┊10┊\n+┊  ┊11┊  .chat-pic {\n+┊  ┊12┊    height: 50px;\n+┊  ┊13┊    width: auto;\n+┊  ┊14┊    border-radius: 50%;\n+┊  ┊15┊  }\n+┊  ┊16┊\n+┊  ┊17┊  .chat-info {\n+┊  ┊18┊    width: calc(100% - 60px);\n+┊  ┊19┊    height: 100%;\n+┊  ┊20┊    margin-left: 10px;\n+┊  ┊21┊    border-bottom: .5px solid silver;\n+┊  ┊22┊    position: relative;\n+┊  ┊23┊\n+┊  ┊24┊    .chat-name {\n+┊  ┊25┊      margin-top: 5px;\n+┊  ┊26┊    }\n+┊  ┊27┊\n+┊  ┊28┊    .chat-last-message {\n+┊  ┊29┊      color: gray;\n+┊  ┊30┊      font-size: 15px;\n+┊  ┊31┊      margin-top: 5px;\n+┊  ┊32┊      text-overflow: ellipsis;\n+┊  ┊33┊      overflow: hidden;\n+┊  ┊34┊    }\n+┊  ┊35┊\n+┊  ┊36┊    .chat-timestamp {\n+┊  ┊37┊      position: absolute;\n+┊  ┊38┊      color: gray;\n+┊  ┊39┊      top: 5px;\n+┊  ┊40┊      right: 5px;\n+┊  ┊41┊      font-size: 13px;\n+┊  ┊42┊    }\n+┊  ┊43┊  }\n+┊  ┊44┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chat-item&#x2F;chat-item.component.ts\n```diff\n@@ -0,0 +1,21 @@\n+┊  ┊ 1┊import {Component, Input} from '@angular/core';\n+┊  ┊ 2┊\n+┊  ┊ 3┊@Component({\n+┊  ┊ 4┊  selector: 'app-chat-item',\n+┊  ┊ 5┊  template: `\n+┊  ┊ 6┊    <div class=\"chat-row\">\n+┊  ┊ 7┊      <img class=\"chat-pic\" [src]=\"chat.picture || 'assets/default-profile-pic.jpg'\">\n+┊  ┊ 8┊      <div class=\"chat-info\">\n+┊  ┊ 9┊        <div class=\"chat-name\">{{ chat.name }}</div>\n+┊  ┊10┊        <div class=\"chat-last-message\">{{ chat.messages?[chat.messages?.length - 1]?.content }}</div>\n+┊  ┊11┊        <div class=\"chat-timestamp\">00:00</div>\n+┊  ┊12┊      </div>\n+┊  ┊13┊    </div>\n+┊  ┊14┊  `,\n+┊  ┊15┊  styleUrls: ['chat-item.component.scss'],\n+┊  ┊16┊})\n+┊  ┊17┊export class ChatItemComponent {\n+┊  ┊18┊  // tslint:disable-next-line:no-input-rename\n+┊  ┊19┊  @Input('item')\n+┊  ┊20┊  chat: any;\n+┊  ┊21┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chats-list&#x2F;chats-list.component.scss\n```diff\n@@ -0,0 +1,8 @@\n+┊ ┊1┊:host {\n+┊ ┊2┊  display: block;\n+┊ ┊3┊}\n+┊ ┊4┊\n+┊ ┊5┊:host ::ng-deep .mat-list-item-content:first-child {\n+┊ ┊6┊  padding-left: 0 !important;\n+┊ ┊7┊  display: flow-root !important;\n+┊ ┊8┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chats-list&#x2F;chats-list.component.ts\n```diff\n@@ -0,0 +1,20 @@\n+┊  ┊ 1┊import {Component, Input} from '@angular/core';\n+┊  ┊ 2┊\n+┊  ┊ 3┊@Component({\n+┊  ┊ 4┊  selector: 'app-chats-list',\n+┊  ┊ 5┊  template: `\n+┊  ┊ 6┊    <mat-list>\n+┊  ┊ 7┊      <mat-list-item *ngFor=\"let chat of chats\">\n+┊  ┊ 8┊        <app-chat-item [item]=\"chat\"></app-chat-item>\n+┊  ┊ 9┊      </mat-list-item>\n+┊  ┊10┊    </mat-list>\n+┊  ┊11┊  `,\n+┊  ┊12┊  styleUrls: ['chats-list.component.scss'],\n+┊  ┊13┊})\n+┊  ┊14┊export class ChatsListComponent {\n+┊  ┊15┊  // tslint:disable-next-line:no-input-rename\n+┊  ┊16┊  @Input('items')\n+┊  ┊17┊  chats: any[];\n+┊  ┊18┊\n+┊  ┊19┊  constructor() {}\n+┊  ┊20┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.scss\n```diff\n@@ -0,0 +1,5 @@\n+┊ ┊1┊.chat-button {\n+┊ ┊2┊  position: absolute;\n+┊ ┊3┊  bottom: 5vw;\n+┊ ┊4┊  right: 5vw;\n+┊ ┊5┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.ts\n```diff\n@@ -0,0 +1,46 @@\n+┊  ┊ 1┊import {Component, OnInit} from '@angular/core';\n+┊  ┊ 2┊import {ChatsService} from '../../../services/chats.service';\n+┊  ┊ 3┊import {Observable} from 'rxjs';\n+┊  ┊ 4┊\n+┊  ┊ 5┊@Component({\n+┊  ┊ 6┊  template: `\n+┊  ┊ 7┊    <app-toolbar>\n+┊  ┊ 8┊      <div class=\"title\">Whatsapp Clone</div>\n+┊  ┊ 9┊      <button mat-icon-button [matMenuTriggerFor]=\"menu\" class=\"menu\">\n+┊  ┊10┊        <mat-icon>more_vert</mat-icon>\n+┊  ┊11┊      </button>\n+┊  ┊12┊    </app-toolbar>\n+┊  ┊13┊\n+┊  ┊14┊    <mat-menu #menu=\"matMenu\">\n+┊  ┊15┊      <button mat-menu-item>\n+┊  ┊16┊        <mat-icon>dialpad</mat-icon>\n+┊  ┊17┊        <span>Redial</span>\n+┊  ┊18┊      </button>\n+┊  ┊19┊      <button mat-menu-item disabled>\n+┊  ┊20┊        <mat-icon>voicemail</mat-icon>\n+┊  ┊21┊        <span>Check voicemail</span>\n+┊  ┊22┊      </button>\n+┊  ┊23┊      <button mat-menu-item>\n+┊  ┊24┊        <mat-icon>notifications_off</mat-icon>\n+┊  ┊25┊        <span>Disable alerts</span>\n+┊  ┊26┊      </button>\n+┊  ┊27┊    </mat-menu>\n+┊  ┊28┊\n+┊  ┊29┊    <app-chats-list [items]=\"chats$ | async\"></app-chats-list>\n+┊  ┊30┊\n+┊  ┊31┊    <button class=\"chat-button\" mat-fab color=\"secondary\">\n+┊  ┊32┊      <mat-icon aria-label=\"Icon-button with a + icon\">chat</mat-icon>\n+┊  ┊33┊    </button>\n+┊  ┊34┊  `,\n+┊  ┊35┊  styleUrls: ['./chats.component.scss'],\n+┊  ┊36┊})\n+┊  ┊37┊export class ChatsComponent implements OnInit {\n+┊  ┊38┊  chats$: Observable<any[]>;\n+┊  ┊39┊\n+┊  ┊40┊  constructor(private chatsService: ChatsService) {\n+┊  ┊41┊  }\n+┊  ┊42┊\n+┊  ┊43┊  ngOnInit() {\n+┊  ┊44┊    this.chats$ = this.chatsService.getChats().chats$;\n+┊  ┊45┊  }\n+┊  ┊46┊}\n```\n\n[}]: #\n\nFinally let's wire everything up to the main module:\n\n[{]: <helper> (diffStep \"1.3\" files=\"src/app/app.component.ts, src/app/app.module.ts\" module=\"client\")\n\n#### [Step 1.3: List the chats](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/7d716ee)\n\n##### Changed src&#x2F;app&#x2F;app.component.ts\n```diff\n@@ -2,7 +2,9 @@\n ┊ 2┊ 2┊\n ┊ 3┊ 3┊@Component({\n ┊ 4┊ 4┊  selector: 'app-root',\n-┊ 5┊  ┊  templateUrl: './app.component.html',\n+┊  ┊ 5┊  template: `\n+┊  ┊ 6┊    <router-outlet></router-outlet>\n+┊  ┊ 7┊  `,\n ┊ 6┊ 8┊  styleUrls: ['./app.component.scss']\n ┊ 7┊ 9┊})\n ┊ 8┊10┊export class AppComponent {\n```\n\n##### Changed src&#x2F;app&#x2F;app.module.ts\n```diff\n@@ -4,6 +4,9 @@\n ┊ 4┊ 4┊import { AppComponent } from './app.component';\n ┊ 5┊ 5┊import { HttpClientModule } from '@angular/common/http';\n ┊ 6┊ 6┊import { GraphQLModule } from './graphql.module';\n+┊  ┊ 7┊import {ChatsListerModule} from './chats-lister/chats-lister.module';\n+┊  ┊ 8┊import {RouterModule, Routes} from '@angular/router';\n+┊  ┊ 9┊const routes: Routes = [];\n ┊ 7┊10┊\n ┊ 8┊11┊@NgModule({\n ┊ 9┊12┊  declarations: [\n```\n```diff\n@@ -13,6 +16,10 @@\n ┊13┊16┊    BrowserModule,\n ┊14┊17┊    HttpClientModule,\n ┊15┊18┊    GraphQLModule,\n+┊  ┊19┊    // Routing\n+┊  ┊20┊    RouterModule.forRoot(routes),\n+┊  ┊21┊    // Feature modules\n+┊  ┊22┊    ChatsListerModule,\n ┊16┊23┊  ],\n ┊17┊24┊  providers: [],\n ┊18┊25┊  bootstrap: [AppComponent]\n```\n\n[}]: #\n\nIf you will try to run the frontend you will notice that several messages seems like duplicated, why does it happen?\n\nSince we use NoSQL-like structure in our backend, messages are stored as an array inside each chat so their incremental identifiers are not unique across different chats. We need to normalize them in a way that takes into account both the message id and the chat id:\n\n[{]: <helper> (diffStep \"1.4\" module=\"client\")\n\n#### [Step 1.4: Better normalize messages](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/4209360)\n\n##### Changed src&#x2F;app&#x2F;graphql.module.ts\n```diff\n@@ -1,14 +1,21 @@\n ┊ 1┊ 1┊import { NgModule} from '@angular/core';\n ┊ 2┊ 2┊import { ApolloModule, APOLLO_OPTIONS } from 'apollo-angular';\n ┊ 3┊ 3┊import { HttpLinkModule, HttpLink } from 'apollo-angular-link-http';\n-┊ 4┊  ┊import { InMemoryCache } from 'apollo-cache-inmemory';\n+┊  ┊ 4┊import { InMemoryCache, defaultDataIdFromObject } from 'apollo-cache-inmemory';\n ┊ 5┊ 5┊\n ┊ 6┊ 6┊const uri = 'http://localhost:3000/graphql';\n ┊ 7┊ 7┊\n ┊ 8┊ 8┊export function createApollo(httpLink: HttpLink) {\n ┊ 9┊ 9┊  return {\n ┊10┊10┊    link: httpLink.create({uri}),\n-┊11┊  ┊    cache: new InMemoryCache(),\n+┊  ┊11┊    cache: new InMemoryCache({\n+┊  ┊12┊      dataIdFromObject: (object: any) => {\n+┊  ┊13┊        switch (object.__typename) {\n+┊  ┊14┊          case 'Message': return `${object.chat.id}:${object.id}`; // use `chatId` prefix and `messageId` as the primary key\n+┊  ┊15┊          default: return defaultDataIdFromObject(object); // fall back to default handling\n+┊  ┊16┊        }\n+┊  ┊17┊      }\n+┊  ┊18┊    }),\n ┊12┊19┊  };\n ┊13┊20┊}\n```\n\n[}]: #\n\nThat way our application will work even if the backend is a NoSQL. What's even more interesting is that our application will keep working as well even when we will switch our backend to PostgreSQL."
          },
          {
            "manualTitle": "Step 6: graphql-code-generator",
            "stepRevision": "b39f987d0944ef79a533fa88893c3a79b814a84f",
            "manualView": "## Code Generation\n\nGraphQL entities are defined as static and typed, which means they can be analyzed and use as a base for generating everything.\n\nThere are many tools related to that topic, but we're going to focus on The **GraphQL Coge Generator**.\n\nThe GraphQL Coge Generator can generate any code for any language  —  including type definitions, data models, query builder, resolvers, ORM code, complete full stack platforms.\n\nThe tool is based on the concept of templates. It has few official templates to solve most required features. The GraphQL Code Gen allows to create your own custom codegen templates in 10 minutes, that fit exactly your needs.\n\nWe will use TypeScript template to generate typings.\n\n### Generating types for server-side code\n\nFirst, let's install `graphql-code-generator` with the TypeScript template and add it to the run scripts:\n\n    yarn add graphql-code-generator graphql-codegen-typescript-template\n\n[{]: <helper> (diffStep \"2.1\" module=\"server\")\n\n#### [Step 2.1: Install graphql-code-generator](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/b8214fd)\n\n##### Changed package.json\n```diff\n@@ -4,7 +4,8 @@\n ┊ 4┊ 4┊  \"private\": true,\n ┊ 5┊ 5┊  \"scripts\": {\n ┊ 6┊ 6┊    \"start\": \"npm run build:live\",\n-┊ 7┊  ┊    \"build:live\": \"nodemon --exec ./node_modules/.bin/ts-node -- ./index.ts\"\n+┊  ┊ 7┊    \"build:live\": \"nodemon --exec ./node_modules/.bin/ts-node -- ./index.ts\",\n+┊  ┊ 8┊    \"generator\": \"gql-gen -r ts-node/register —schema schema/typeDefs.ts --template ts --out ./types.d.ts\"\n ┊ 8┊ 9┊  },\n ┊ 9┊10┊  \"devDependencies\": {\n ┊10┊11┊    \"@types/body-parser\": \"1.17.0\",\n```\n```diff\n@@ -22,6 +23,7 @@\n ┊22┊23┊    \"cors\": \"2.8.4\",\n ┊23┊24┊    \"express\": \"4.16.3\",\n ┊24┊25┊    \"graphql\": \"14.0.2\",\n+┊  ┊26┊    \"graphql-code-generator\": \"0.12.6\",\n ┊25┊27┊    \"moment\": \"2.22.1\"\n ┊26┊28┊  }\n ┊27┊29┊}\n```\n\n[}]: #\n\nFew things here:\n\n- `--require ts-node/register` - makes the ts-node compile TypeScript files\n- `--schema` - points to a file that exports the GraphQL Schema object or a string (it also accepts an url)\n- `--template` - tells about the template we want to use\n- `--out` - the location of a generated file\n\nNow let's run the generator:\n\n    yarn generator\n\nPlease note that the server doesn't have to be running in background because we import schema through a file.\n\nNext, let's use the generated types:\n\n[{]: <helper> (diffStep \"2.3\" module=\"server\")\n\n#### [Step 2.3: Use our types](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/ef59ecf)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,5 +1,6 @@\n ┊1┊1┊import { IResolvers } from 'apollo-server-express';\n ┊2┊2┊import { Chat, db, Message, Recipient, User } from \"../db\";\n+┊ ┊3┊import { ChatQueryArgs } from \"../types\";\n ┊3┊4┊\n ┊4┊5┊let users = db.users;\n ┊5┊6┊let chats = db.chats;\n```\n```diff\n@@ -10,7 +11,7 @@\n ┊10┊11┊    // Show all users for the moment.\n ┊11┊12┊    users: (): User[] => users.filter(user => user.id !== currentUser),\n ┊12┊13┊    chats: (): Chat[] => chats.filter(chat => chat.listingMemberIds.includes(currentUser)),\n-┊13┊  ┊    chat: (obj: any, {chatId}): Chat | null => chats.find(chat => chat.id === chatId) || null,\n+┊  ┊14┊    chat: (obj: any, {chatId}: ChatQueryArgs): Chat | null => chats.find(chat => chat.id === Number(chatId)) || null,\n ┊14┊15┊  },\n ┊15┊16┊  Chat: {\n ┊16┊17┊    name: (chat: Chat): string => chat.name ? chat.name : users\n```\n\n[}]: #\n\nDon't worry, they will be much more useful when we will write our first mutation.\n\n### Generating types for client-side code\n\nLet's do the same on the client:\n\n    yarn add graphql-code-generator graphql-codegen-typescript-template\n\nPlease note that in this case, the server must be started before running the generator.\n\n[{]: <helper> (diffStep \"2.1\" module=\"client\")\n\n#### [Step 2.1: Install graphql-code-generator](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/a97dbe5)\n\n##### Changed package.json\n```diff\n@@ -7,7 +7,8 @@\n ┊ 7┊ 7┊    \"build\": \"ng build\",\n ┊ 8┊ 8┊    \"test\": \"ng test\",\n ┊ 9┊ 9┊    \"lint\": \"ng lint\",\n-┊10┊  ┊    \"e2e\": \"ng e2e\"\n+┊  ┊10┊    \"e2e\": \"ng e2e\",\n+┊  ┊11┊    \"generator\": \"gql-gen --schema http://localhost:3000/graphql --template graphql-codegen-typescript-template --out ./src/graphql.ts ./src/graphql/**/*.ts\"\n ┊11┊12┊  },\n ┊12┊13┊  \"private\": true,\n ┊13┊14┊  \"dependencies\": {\n```\n```diff\n@@ -45,6 +46,7 @@\n ┊45┊46┊    \"@types/jasminewd2\": \"2.0.3\",\n ┊46┊47┊    \"@types/node\": \"8.9.5\",\n ┊47┊48┊    \"codelyzer\": \"4.2.1\",\n+┊  ┊49┊    \"graphql-code-generator\": \"0.12.6\",\n ┊48┊50┊    \"jasmine-core\": \"2.99.1\",\n ┊49┊51┊    \"jasmine-spec-reporter\": \"4.2.1\",\n ┊50┊52┊    \"karma\": \"1.7.1\",\n```\n\n[}]: #\n\nWe saw how to use them on the server but let's see how easy it is to take advantage of them in Apollo.\n\nFirst thing you should know is most of the methods of Apollo service accepts generic types.\n\n#### What are Generic Types\n\nA major part of software engineering is building components that not only have well-defined and consistent APIs, but are also reusable. Components that are capable of working on the data of today as well as the data of tomorrow will give you the most flexible capabilities for building up large software systems.\n\nWe like to work on an code samples so let's do some functional programming and create the `map` method that accepts a transform function and return a new result.\n\nWithout generics, we would have to use a specific type or `any`:\n\n```typescript\nfunction map(mapFn: (value: any) => any) {\n  return function(source: any): any {\n    return mapFn(source);\n  };\n}\n```\n\nImagine, we want to use `map` function to pick user's id from an object:\n\n```typescript\ninterface User {\n  id: number;\n}\nconst me = {\n  id: 1,\n};\n\nconst pickUserId = map(user => user.id);\n\nconsole.log(pickUserId(me)); // outputs: 1\n```\n\nGreat, it works, we get the expected result but it could be done way better.\n\nWhat is the main issue here?\nIt accepts an object of any type and get `any` in return. It's not very useful because we know it return a `number` and receive a `User` but TypeScript doesn't know that and later on, in other part of the code, we end up with no information about the result.\n\nThat's where Generic Types jumps in!\n\nWith generics, it could look like this:\n\n```typescript\nfunction map<T, R>(mapFn: (value: T) => R) {\n  return function(source: T): R {\n    return mapFn(source);\n  };\n}\n```\n\nThere's... a lot! So let's break it:\n\n- `map<T, R>` - the map function accepts two generic types\n- `(mapFn: (value: T) => R)` - the only argument is a function that accepts an object of type `T` and returns value of type `R`\n- `function (source: T): R => {...}` - it's a higher order function that accepts a source of type `T` and transforms to be `R`.\n\nBack to our example, now with generic types:\n\n```typescript\ninterface User {\n  id: number;\n}\nconst me = {\n  id: 1,\n};\n\nconst pickUserId = map<User, number>(user => user.id);\n\nconsole.log(pickUserId(me)); // outputs: 1\n```\n\nOur `map` and `pickUserId` function are strongly typed now so when you try to provide an object that has no `id` field or the field is a `string` you'll receive a proper information from TypeScript (and your IDE).\n\n#### Make client-side code strongly typed\n\nWith all that knowledge let's use how to use those generated typed with `Apollo` service:\n\n[{]: <helper> (diffStep \"2.3\" module=\"client\")\n\n#### [Step 2.3: Use the generated types](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/afdf40c)\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chat-item&#x2F;chat-item.component.ts\n```diff\n@@ -1,4 +1,5 @@\n ┊1┊1┊import {Component, Input} from '@angular/core';\n+┊ ┊2┊import {GetChats} from '../../../../graphql';\n ┊2┊3┊\n ┊3┊4┊@Component({\n ┊4┊5┊  selector: 'app-chat-item',\n```\n```diff\n@@ -17,5 +18,5 @@\n ┊17┊18┊export class ChatItemComponent {\n ┊18┊19┊  // tslint:disable-next-line:no-input-rename\n ┊19┊20┊  @Input('item')\n-┊20┊  ┊  chat: any;\n+┊  ┊21┊  chat: GetChats.Chats;\n ┊21┊22┊}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chats-list&#x2F;chats-list.component.ts\n```diff\n@@ -1,4 +1,5 @@\n ┊1┊1┊import {Component, Input} from '@angular/core';\n+┊ ┊2┊import {GetChats} from '../../../../graphql';\n ┊2┊3┊\n ┊3┊4┊@Component({\n ┊4┊5┊  selector: 'app-chats-list',\n```\n```diff\n@@ -14,7 +15,7 @@\n ┊14┊15┊export class ChatsListComponent {\n ┊15┊16┊  // tslint:disable-next-line:no-input-rename\n ┊16┊17┊  @Input('items')\n-┊17┊  ┊  chats: any[];\n+┊  ┊18┊  chats: GetChats.Chats[];\n ┊18┊19┊\n ┊19┊20┊  constructor() {}\n ┊20┊21┊}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.ts\n```diff\n@@ -1,6 +1,7 @@\n ┊1┊1┊import {Component, OnInit} from '@angular/core';\n ┊2┊2┊import {ChatsService} from '../../../services/chats.service';\n ┊3┊3┊import {Observable} from 'rxjs';\n+┊ ┊4┊import {GetChats} from '../../../../graphql';\n ┊4┊5┊\n ┊5┊6┊@Component({\n ┊6┊7┊  template: `\n```\n```diff\n@@ -35,7 +36,7 @@\n ┊35┊36┊  styleUrls: ['./chats.component.scss'],\n ┊36┊37┊})\n ┊37┊38┊export class ChatsComponent implements OnInit {\n-┊38┊  ┊  chats$: Observable<any[]>;\n+┊  ┊39┊  chats$: Observable<GetChats.Chats[]>;\n ┊39┊40┊\n ┊40┊41┊  constructor(private chatsService: ChatsService) {\n ┊41┊42┊  }\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -2,6 +2,7 @@\n ┊2┊2┊import {Apollo} from 'apollo-angular';\n ┊3┊3┊import {Injectable} from '@angular/core';\n ┊4┊4┊import {getChatsQuery} from '../../graphql/getChats.query';\n+┊ ┊5┊import {GetChats} from '../../graphql';\n ┊5┊6┊\n ┊6┊7┊@Injectable()\n ┊7┊8┊export class ChatsService {\n```\n```diff\n@@ -10,7 +11,7 @@\n ┊10┊11┊  constructor(private apollo: Apollo) {}\n ┊11┊12┊\n ┊12┊13┊  getChats() {\n-┊13┊  ┊    const query = this.apollo.watchQuery<any>({\n+┊  ┊14┊    const query = this.apollo.watchQuery<GetChats.Query>({\n ┊14┊15┊      query: getChatsQuery,\n ┊15┊16┊      variables: {\n ┊16┊17┊        amount: this.messagesAmount,\n```\n\n[}]: #\n\nAs you can probably tell by now, methods like `watchQuery` and `mutate` (and others) accepts two generic types, first one describes the result and the second one the variables.\n\n```typescript\nexport class ChatService {\n  constructor(private apollo: Apollo) {}\n\n  getChat(chatId: string, amount: number): GetChat.Chat {\n    return this.apollo\n      .watchQuery<GetChat.Query, GetChat.Variables>({\n        query: getChatQuery,\n        variables: {\n          chatId,\n          amount,\n        },\n      })\n      .pipe(map(result => result.data.chat));\n  }\n}\n```\n\nFew things here.\n\n- An object of `GetChat.Query` shape lives under the `result.data` because `watchQuery` returns an object of type `ApolloQueryResult<T>` where `T` is our `GetChat.Query`.\n\n```typescript\nexport type ApolloQueryResult<T> = {\n  data: T;\n  // ... other fields\n};\n```\n\nYou get the same result with Mutation or Subscription.\n\n- Thanks to the second argument and `GetChat.Variables` we as well as TypeScript (and an IDE) know that `chatId` is a string and `amount` accepts only a number. Whenever we try to pass a value of different kind an Error will pop out.\n\n### Take full advantage of Codegen and generate ready to use Services!\n\nI've got a fantasctic news, you don't have to manually provide those generated types to each type Apollo service is used. Because GraphQL Documents are statically analyzable, we prepared a codegen template specific for Apollo Angular users.\n\nFirst, let's install `graphql-codegen-apollo-angular` with the Apollo Angular templatea and update the template param of `generator` script\n\n    yarn add graphql-code-generator graphql-codegen-typescript-template\n\n[{]: <helper> (diffStep \"2.4\" file=\"package.json\" module=\"client\")\n\n#### [Step 2.4: Use auto-generated GQL services](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/c0eddd1)\n\n##### Changed package.json\n```diff\n@@ -8,7 +8,7 @@\n ┊ 8┊ 8┊    \"test\": \"ng test\",\n ┊ 9┊ 9┊    \"lint\": \"ng lint\",\n ┊10┊10┊    \"e2e\": \"ng e2e\",\n-┊11┊  ┊    \"generator\": \"gql-gen --schema http://localhost:3000/graphql --template graphql-codegen-typescript-template --out ./src/graphql.ts ./src/graphql/**/*.ts\"\n+┊  ┊11┊    \"generator\": \"gql-gen --schema http://localhost:3000/graphql --template graphql-codegen-apollo-angular-template --out ./src/graphql.ts ./src/graphql/**/*.ts\"\n ┊12┊12┊  },\n ┊13┊13┊  \"private\": true,\n ┊14┊14┊  \"dependencies\": {\n```\n```diff\n@@ -48,6 +48,7 @@\n ┊48┊48┊    \"codelyzer\": \"4.2.1\",\n ┊49┊49┊    \"graphql-code-generator\": \"0.12.6\",\n ┊50┊50┊    \"graphql-codegen-typescript-template\": \"0.12.6\",\n+┊  ┊51┊    \"graphql-codegen-apollo-angular-template\": \"0.12.6\",\n ┊51┊52┊    \"jasmine-core\": \"2.99.1\",\n ┊52┊53┊    \"jasmine-spec-reporter\": \"4.2.1\",\n ┊53┊54┊    \"karma\": \"1.7.1\",\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,21 +1,18 @@\n ┊ 1┊ 1┊import {map} from 'rxjs/operators';\n-┊ 2┊  ┊import {Apollo} from 'apollo-angular';\n ┊ 3┊ 2┊import {Injectable} from '@angular/core';\n-┊ 4┊  ┊import {getChatsQuery} from '../../graphql/getChats.query';\n-┊ 5┊  ┊import {GetChats} from '../../graphql';\n+┊  ┊ 3┊import {GetChatsGQL} from '../../graphql';\n ┊ 6┊ 4┊\n ┊ 7┊ 5┊@Injectable()\n ┊ 8┊ 6┊export class ChatsService {\n ┊ 9┊ 7┊  messagesAmount = 3;\n ┊10┊ 8┊\n-┊11┊  ┊  constructor(private apollo: Apollo) {}\n+┊  ┊ 9┊  constructor(\n+┊  ┊10┊    private getChatsGQL: GetChatsGQL\n+┊  ┊11┊  ) {}\n ┊12┊12┊\n ┊13┊13┊  getChats() {\n-┊14┊  ┊    const query = this.apollo.watchQuery<GetChats.Query>({\n-┊15┊  ┊      query: getChatsQuery,\n-┊16┊  ┊      variables: {\n-┊17┊  ┊        amount: this.messagesAmount,\n-┊18┊  ┊      },\n+┊  ┊14┊    const query = this.getChatsGQL.watch({\n+┊  ┊15┊      amount: this.messagesAmount,\n ┊19┊16┊    });\n ┊20┊17┊    const chats$ = query.valueChanges.pipe(\n ┊21┊18┊      map((result) => result.data.chats)\n```\n\n##### Changed src&#x2F;graphql.ts\n```diff\n@@ -28,6 +28,8 @@\n ┊28┊28┊  ): R | Result | Promise<R | Result>;\n ┊29┊29┊};\n ┊30┊30┊\n+┊  ┊31┊export type Date = any;\n+┊  ┊32┊\n ┊31┊33┊export interface Query {\n ┊32┊34┊  users?: User[] | null;\n ┊33┊35┊  chats?: Chat[] | null;\n```\n```diff\n@@ -42,17 +44,18 @@\n ┊42┊44┊}\n ┊43┊45┊\n ┊44┊46┊export interface Chat {\n-┊45┊  ┊  id: string /** May be a chat or a group */;\n-┊46┊  ┊  name?: string | null /** Computed for chats */;\n-┊47┊  ┊  picture?: string | null /** Computed for chats */;\n-┊48┊  ┊  allTimeMembers: User[] /** All members, current and past ones. */;\n-┊49┊  ┊  listingMembers: User[] /** Whoever gets the chat listed. For groups includes past members who still didn't delete the group. */;\n-┊50┊  ┊  actualGroupMembers: User[] /** Actual members of the group (they are not the only ones who get the group listed). Null for chats. */;\n-┊51┊  ┊  admins?: User[] | null /** Null for chats */;\n-┊52┊  ┊  owner?: User | null /** If null the group is read-only. Null for chats. */;\n+┊  ┊47┊  id: string;\n+┊  ┊48┊  name?: string | null;\n+┊  ┊49┊  picture?: string | null;\n+┊  ┊50┊  allTimeMembers: User[];\n+┊  ┊51┊  listingMembers: User[];\n+┊  ┊52┊  actualGroupMembers: User[];\n+┊  ┊53┊  admins?: User[] | null;\n+┊  ┊54┊  owner?: User | null;\n ┊53┊55┊  messages: (Message | null)[];\n-┊54┊  ┊  unreadMessages: number /** Computed property */;\n-┊55┊  ┊  isGroup: boolean /** Computed property */;\n+┊  ┊56┊  messageFeed?: MessageFeed | null;\n+┊  ┊57┊  unreadMessages: number;\n+┊  ┊58┊  isGroup: boolean;\n ┊56┊59┊}\n ┊57┊60┊\n ┊58┊61┊export interface Message {\n```\n```diff\n@@ -60,25 +63,107 @@\n ┊ 60┊ 63┊  sender: User;\n ┊ 61┊ 64┊  chat: Chat;\n ┊ 62┊ 65┊  content: string;\n-┊ 63┊   ┊  createdAt: string;\n-┊ 64┊   ┊  type: number /** FIXME: should return MessageType */;\n-┊ 65┊   ┊  recipients: Recipient[] /** Whoever received the message */;\n-┊ 66┊   ┊  holders: User[] /** Whoever still holds a copy of the message. Cannot be null because the message gets deleted otherwise */;\n-┊ 67┊   ┊  ownership: boolean /** Computed property */;\n+┊   ┊ 66┊  createdAt: Date;\n+┊   ┊ 67┊  type: number;\n+┊   ┊ 68┊  recipients: Recipient[];\n+┊   ┊ 69┊  holders: User[];\n+┊   ┊ 70┊  ownership: boolean;\n ┊ 68┊ 71┊}\n ┊ 69┊ 72┊\n ┊ 70┊ 73┊export interface Recipient {\n ┊ 71┊ 74┊  user: User;\n ┊ 72┊ 75┊  message: Message;\n ┊ 73┊ 76┊  chat: Chat;\n-┊ 74┊   ┊  receivedAt?: string | null;\n-┊ 75┊   ┊  readAt?: string | null;\n+┊   ┊ 77┊  receivedAt?: Date | null;\n+┊   ┊ 78┊  readAt?: Date | null;\n+┊   ┊ 79┊}\n+┊   ┊ 80┊\n+┊   ┊ 81┊export interface MessageFeed {\n+┊   ┊ 82┊  hasNextPage: boolean;\n+┊   ┊ 83┊  cursor?: string | null;\n+┊   ┊ 84┊  messages: (Message | null)[];\n+┊   ┊ 85┊}\n+┊   ┊ 86┊\n+┊   ┊ 87┊export interface Mutation {\n+┊   ┊ 88┊  addChat?: Chat | null;\n+┊   ┊ 89┊  addGroup?: Chat | null;\n+┊   ┊ 90┊  removeChat?: string | null;\n+┊   ┊ 91┊  addMessage?: Message | null;\n+┊   ┊ 92┊  removeMessages?: (string | null)[] | null;\n+┊   ┊ 93┊  addMembers?: (string | null)[] | null;\n+┊   ┊ 94┊  removeMembers?: (string | null)[] | null;\n+┊   ┊ 95┊  addAdmins?: (string | null)[] | null;\n+┊   ┊ 96┊  removeAdmins?: (string | null)[] | null;\n+┊   ┊ 97┊  setGroupName?: string | null;\n+┊   ┊ 98┊  setGroupPicture?: string | null;\n+┊   ┊ 99┊  markAsReceived?: boolean | null;\n+┊   ┊100┊  markAsRead?: boolean | null;\n+┊   ┊101┊}\n+┊   ┊102┊\n+┊   ┊103┊export interface Subscription {\n+┊   ┊104┊  messageAdded?: Message | null;\n+┊   ┊105┊  chatAdded?: Chat | null;\n ┊ 76┊106┊}\n ┊ 77┊107┊export interface ChatQueryArgs {\n ┊ 78┊108┊  chatId: string;\n ┊ 79┊109┊}\n ┊ 80┊110┊export interface MessagesChatArgs {\n ┊ 81┊111┊  amount?: number | null;\n+┊   ┊112┊  before?: string | null;\n+┊   ┊113┊}\n+┊   ┊114┊export interface MessageFeedChatArgs {\n+┊   ┊115┊  amount?: number | null;\n+┊   ┊116┊  before?: string | null;\n+┊   ┊117┊}\n+┊   ┊118┊export interface AddChatMutationArgs {\n+┊   ┊119┊  recipientId: string;\n+┊   ┊120┊}\n+┊   ┊121┊export interface AddGroupMutationArgs {\n+┊   ┊122┊  recipientIds: string[];\n+┊   ┊123┊  groupName: string;\n+┊   ┊124┊}\n+┊   ┊125┊export interface RemoveChatMutationArgs {\n+┊   ┊126┊  chatId: string;\n+┊   ┊127┊}\n+┊   ┊128┊export interface AddMessageMutationArgs {\n+┊   ┊129┊  chatId: string;\n+┊   ┊130┊  content: string;\n+┊   ┊131┊}\n+┊   ┊132┊export interface RemoveMessagesMutationArgs {\n+┊   ┊133┊  chatId: string;\n+┊   ┊134┊  messageIds?: (string | null)[] | null;\n+┊   ┊135┊  all?: boolean | null;\n+┊   ┊136┊}\n+┊   ┊137┊export interface AddMembersMutationArgs {\n+┊   ┊138┊  groupId: string;\n+┊   ┊139┊  userIds: string[];\n+┊   ┊140┊}\n+┊   ┊141┊export interface RemoveMembersMutationArgs {\n+┊   ┊142┊  groupId: string;\n+┊   ┊143┊  userIds: string[];\n+┊   ┊144┊}\n+┊   ┊145┊export interface AddAdminsMutationArgs {\n+┊   ┊146┊  groupId: string;\n+┊   ┊147┊  userIds: string[];\n+┊   ┊148┊}\n+┊   ┊149┊export interface RemoveAdminsMutationArgs {\n+┊   ┊150┊  groupId: string;\n+┊   ┊151┊  userIds: string[];\n+┊   ┊152┊}\n+┊   ┊153┊export interface SetGroupNameMutationArgs {\n+┊   ┊154┊  groupId: string;\n+┊   ┊155┊}\n+┊   ┊156┊export interface SetGroupPictureMutationArgs {\n+┊   ┊157┊  groupId: string;\n+┊   ┊158┊}\n+┊   ┊159┊export interface MarkAsReceivedMutationArgs {\n+┊   ┊160┊  chatId: string;\n+┊   ┊161┊}\n+┊   ┊162┊export interface MarkAsReadMutationArgs {\n+┊   ┊163┊  chatId: string;\n+┊   ┊164┊}\n+┊   ┊165┊export interface MessageAddedSubscriptionArgs {\n+┊   ┊166┊  chatId?: string | null;\n ┊ 82┊167┊}\n ┊ 83┊168┊\n ┊ 84┊169┊export enum MessageType {\n```\n```diff\n@@ -146,41 +231,18 @@\n ┊146┊231┊\n ┊147┊232┊export namespace ChatResolvers {\n ┊148┊233┊  export interface Resolvers<Context = any> {\n-┊149┊   ┊    id?: IdResolver<string, any, Context> /** May be a chat or a group */;\n-┊150┊   ┊    name?: NameResolver<string | null, any, Context> /** Computed for chats */;\n-┊151┊   ┊    picture?: PictureResolver<\n-┊152┊   ┊      string | null,\n-┊153┊   ┊      any,\n-┊154┊   ┊      Context\n-┊155┊   ┊    > /** Computed for chats */;\n-┊156┊   ┊    allTimeMembers?: AllTimeMembersResolver<\n-┊157┊   ┊      User[],\n-┊158┊   ┊      any,\n-┊159┊   ┊      Context\n-┊160┊   ┊    > /** All members, current and past ones. */;\n-┊161┊   ┊    listingMembers?: ListingMembersResolver<\n-┊162┊   ┊      User[],\n-┊163┊   ┊      any,\n-┊164┊   ┊      Context\n-┊165┊   ┊    > /** Whoever gets the chat listed. For groups includes past members who still didn't delete the group. */;\n-┊166┊   ┊    actualGroupMembers?: ActualGroupMembersResolver<\n-┊167┊   ┊      User[],\n-┊168┊   ┊      any,\n-┊169┊   ┊      Context\n-┊170┊   ┊    > /** Actual members of the group (they are not the only ones who get the group listed). Null for chats. */;\n-┊171┊   ┊    admins?: AdminsResolver<User[] | null, any, Context> /** Null for chats */;\n-┊172┊   ┊    owner?: OwnerResolver<\n-┊173┊   ┊      User | null,\n-┊174┊   ┊      any,\n-┊175┊   ┊      Context\n-┊176┊   ┊    > /** If null the group is read-only. Null for chats. */;\n+┊   ┊234┊    id?: IdResolver<string, any, Context>;\n+┊   ┊235┊    name?: NameResolver<string | null, any, Context>;\n+┊   ┊236┊    picture?: PictureResolver<string | null, any, Context>;\n+┊   ┊237┊    allTimeMembers?: AllTimeMembersResolver<User[], any, Context>;\n+┊   ┊238┊    listingMembers?: ListingMembersResolver<User[], any, Context>;\n+┊   ┊239┊    actualGroupMembers?: ActualGroupMembersResolver<User[], any, Context>;\n+┊   ┊240┊    admins?: AdminsResolver<User[] | null, any, Context>;\n+┊   ┊241┊    owner?: OwnerResolver<User | null, any, Context>;\n ┊177┊242┊    messages?: MessagesResolver<(Message | null)[], any, Context>;\n-┊178┊   ┊    unreadMessages?: UnreadMessagesResolver<\n-┊179┊   ┊      number,\n-┊180┊   ┊      any,\n-┊181┊   ┊      Context\n-┊182┊   ┊    > /** Computed property */;\n-┊183┊   ┊    isGroup?: IsGroupResolver<boolean, any, Context> /** Computed property */;\n+┊   ┊243┊    messageFeed?: MessageFeedResolver<MessageFeed | null, any, Context>;\n+┊   ┊244┊    unreadMessages?: UnreadMessagesResolver<number, any, Context>;\n+┊   ┊245┊    isGroup?: IsGroupResolver<boolean, any, Context>;\n ┊184┊246┊  }\n ┊185┊247┊\n ┊186┊248┊  export type IdResolver<R = string, Parent = any, Context = any> = Resolver<\n```\n```diff\n@@ -230,6 +292,17 @@\n ┊230┊292┊  > = Resolver<R, Parent, Context, MessagesArgs>;\n ┊231┊293┊  export interface MessagesArgs {\n ┊232┊294┊    amount?: number | null;\n+┊   ┊295┊    before?: string | null;\n+┊   ┊296┊  }\n+┊   ┊297┊\n+┊   ┊298┊  export type MessageFeedResolver<\n+┊   ┊299┊    R = MessageFeed | null,\n+┊   ┊300┊    Parent = any,\n+┊   ┊301┊    Context = any\n+┊   ┊302┊  > = Resolver<R, Parent, Context, MessageFeedArgs>;\n+┊   ┊303┊  export interface MessageFeedArgs {\n+┊   ┊304┊    amount?: number | null;\n+┊   ┊305┊    before?: string | null;\n ┊233┊306┊  }\n ┊234┊307┊\n ┊235┊308┊  export type UnreadMessagesResolver<\n```\n```diff\n@@ -250,27 +323,11 @@\n ┊250┊323┊    sender?: SenderResolver<User, any, Context>;\n ┊251┊324┊    chat?: ChatResolver<Chat, any, Context>;\n ┊252┊325┊    content?: ContentResolver<string, any, Context>;\n-┊253┊   ┊    createdAt?: CreatedAtResolver<string, any, Context>;\n-┊254┊   ┊    type?: TypeResolver<\n-┊255┊   ┊      number,\n-┊256┊   ┊      any,\n-┊257┊   ┊      Context\n-┊258┊   ┊    > /** FIXME: should return MessageType */;\n-┊259┊   ┊    recipients?: RecipientsResolver<\n-┊260┊   ┊      Recipient[],\n-┊261┊   ┊      any,\n-┊262┊   ┊      Context\n-┊263┊   ┊    > /** Whoever received the message */;\n-┊264┊   ┊    holders?: HoldersResolver<\n-┊265┊   ┊      User[],\n-┊266┊   ┊      any,\n-┊267┊   ┊      Context\n-┊268┊   ┊    > /** Whoever still holds a copy of the message. Cannot be null because the message gets deleted otherwise */;\n-┊269┊   ┊    ownership?: OwnershipResolver<\n-┊270┊   ┊      boolean,\n-┊271┊   ┊      any,\n-┊272┊   ┊      Context\n-┊273┊   ┊    > /** Computed property */;\n+┊   ┊326┊    createdAt?: CreatedAtResolver<Date, any, Context>;\n+┊   ┊327┊    type?: TypeResolver<number, any, Context>;\n+┊   ┊328┊    recipients?: RecipientsResolver<Recipient[], any, Context>;\n+┊   ┊329┊    holders?: HoldersResolver<User[], any, Context>;\n+┊   ┊330┊    ownership?: OwnershipResolver<boolean, any, Context>;\n ┊274┊331┊  }\n ┊275┊332┊\n ┊276┊333┊  export type IdResolver<R = string, Parent = any, Context = any> = Resolver<\n```\n```diff\n@@ -294,7 +351,7 @@\n ┊294┊351┊    Context = any\n ┊295┊352┊  > = Resolver<R, Parent, Context>;\n ┊296┊353┊  export type CreatedAtResolver<\n-┊297┊   ┊    R = string,\n+┊   ┊354┊    R = Date,\n ┊298┊355┊    Parent = any,\n ┊299┊356┊    Context = any\n ┊300┊357┊  > = Resolver<R, Parent, Context>;\n```\n```diff\n@@ -325,8 +382,8 @@\n ┊325┊382┊    user?: UserResolver<User, any, Context>;\n ┊326┊383┊    message?: MessageResolver<Message, any, Context>;\n ┊327┊384┊    chat?: ChatResolver<Chat, any, Context>;\n-┊328┊   ┊    receivedAt?: ReceivedAtResolver<string | null, any, Context>;\n-┊329┊   ┊    readAt?: ReadAtResolver<string | null, any, Context>;\n+┊   ┊385┊    receivedAt?: ReceivedAtResolver<Date | null, any, Context>;\n+┊   ┊386┊    readAt?: ReadAtResolver<Date | null, any, Context>;\n ┊330┊387┊  }\n ┊331┊388┊\n ┊332┊389┊  export type UserResolver<R = User, Parent = any, Context = any> = Resolver<\n```\n```diff\n@@ -345,14 +402,211 @@\n ┊345┊402┊    Context\n ┊346┊403┊  >;\n ┊347┊404┊  export type ReceivedAtResolver<\n-┊348┊   ┊    R = string | null,\n+┊   ┊405┊    R = Date | null,\n ┊349┊406┊    Parent = any,\n ┊350┊407┊    Context = any\n ┊351┊408┊  > = Resolver<R, Parent, Context>;\n ┊352┊409┊  export type ReadAtResolver<\n+┊   ┊410┊    R = Date | null,\n+┊   ┊411┊    Parent = any,\n+┊   ┊412┊    Context = any\n+┊   ┊413┊  > = Resolver<R, Parent, Context>;\n+┊   ┊414┊}\n+┊   ┊415┊\n+┊   ┊416┊export namespace MessageFeedResolvers {\n+┊   ┊417┊  export interface Resolvers<Context = any> {\n+┊   ┊418┊    hasNextPage?: HasNextPageResolver<boolean, any, Context>;\n+┊   ┊419┊    cursor?: CursorResolver<string | null, any, Context>;\n+┊   ┊420┊    messages?: MessagesResolver<(Message | null)[], any, Context>;\n+┊   ┊421┊  }\n+┊   ┊422┊\n+┊   ┊423┊  export type HasNextPageResolver<\n+┊   ┊424┊    R = boolean,\n+┊   ┊425┊    Parent = any,\n+┊   ┊426┊    Context = any\n+┊   ┊427┊  > = Resolver<R, Parent, Context>;\n+┊   ┊428┊  export type CursorResolver<\n+┊   ┊429┊    R = string | null,\n+┊   ┊430┊    Parent = any,\n+┊   ┊431┊    Context = any\n+┊   ┊432┊  > = Resolver<R, Parent, Context>;\n+┊   ┊433┊  export type MessagesResolver<\n+┊   ┊434┊    R = (Message | null)[],\n+┊   ┊435┊    Parent = any,\n+┊   ┊436┊    Context = any\n+┊   ┊437┊  > = Resolver<R, Parent, Context>;\n+┊   ┊438┊}\n+┊   ┊439┊\n+┊   ┊440┊export namespace MutationResolvers {\n+┊   ┊441┊  export interface Resolvers<Context = any> {\n+┊   ┊442┊    addChat?: AddChatResolver<Chat | null, any, Context>;\n+┊   ┊443┊    addGroup?: AddGroupResolver<Chat | null, any, Context>;\n+┊   ┊444┊    removeChat?: RemoveChatResolver<string | null, any, Context>;\n+┊   ┊445┊    addMessage?: AddMessageResolver<Message | null, any, Context>;\n+┊   ┊446┊    removeMessages?: RemoveMessagesResolver<\n+┊   ┊447┊      (string | null)[] | null,\n+┊   ┊448┊      any,\n+┊   ┊449┊      Context\n+┊   ┊450┊    >;\n+┊   ┊451┊    addMembers?: AddMembersResolver<(string | null)[] | null, any, Context>;\n+┊   ┊452┊    removeMembers?: RemoveMembersResolver<\n+┊   ┊453┊      (string | null)[] | null,\n+┊   ┊454┊      any,\n+┊   ┊455┊      Context\n+┊   ┊456┊    >;\n+┊   ┊457┊    addAdmins?: AddAdminsResolver<(string | null)[] | null, any, Context>;\n+┊   ┊458┊    removeAdmins?: RemoveAdminsResolver<(string | null)[] | null, any, Context>;\n+┊   ┊459┊    setGroupName?: SetGroupNameResolver<string | null, any, Context>;\n+┊   ┊460┊    setGroupPicture?: SetGroupPictureResolver<string | null, any, Context>;\n+┊   ┊461┊    markAsReceived?: MarkAsReceivedResolver<boolean | null, any, Context>;\n+┊   ┊462┊    markAsRead?: MarkAsReadResolver<boolean | null, any, Context>;\n+┊   ┊463┊  }\n+┊   ┊464┊\n+┊   ┊465┊  export type AddChatResolver<\n+┊   ┊466┊    R = Chat | null,\n+┊   ┊467┊    Parent = any,\n+┊   ┊468┊    Context = any\n+┊   ┊469┊  > = Resolver<R, Parent, Context, AddChatArgs>;\n+┊   ┊470┊  export interface AddChatArgs {\n+┊   ┊471┊    recipientId: string;\n+┊   ┊472┊  }\n+┊   ┊473┊\n+┊   ┊474┊  export type AddGroupResolver<\n+┊   ┊475┊    R = Chat | null,\n+┊   ┊476┊    Parent = any,\n+┊   ┊477┊    Context = any\n+┊   ┊478┊  > = Resolver<R, Parent, Context, AddGroupArgs>;\n+┊   ┊479┊  export interface AddGroupArgs {\n+┊   ┊480┊    recipientIds: string[];\n+┊   ┊481┊    groupName: string;\n+┊   ┊482┊  }\n+┊   ┊483┊\n+┊   ┊484┊  export type RemoveChatResolver<\n+┊   ┊485┊    R = string | null,\n+┊   ┊486┊    Parent = any,\n+┊   ┊487┊    Context = any\n+┊   ┊488┊  > = Resolver<R, Parent, Context, RemoveChatArgs>;\n+┊   ┊489┊  export interface RemoveChatArgs {\n+┊   ┊490┊    chatId: string;\n+┊   ┊491┊  }\n+┊   ┊492┊\n+┊   ┊493┊  export type AddMessageResolver<\n+┊   ┊494┊    R = Message | null,\n+┊   ┊495┊    Parent = any,\n+┊   ┊496┊    Context = any\n+┊   ┊497┊  > = Resolver<R, Parent, Context, AddMessageArgs>;\n+┊   ┊498┊  export interface AddMessageArgs {\n+┊   ┊499┊    chatId: string;\n+┊   ┊500┊    content: string;\n+┊   ┊501┊  }\n+┊   ┊502┊\n+┊   ┊503┊  export type RemoveMessagesResolver<\n+┊   ┊504┊    R = (string | null)[] | null,\n+┊   ┊505┊    Parent = any,\n+┊   ┊506┊    Context = any\n+┊   ┊507┊  > = Resolver<R, Parent, Context, RemoveMessagesArgs>;\n+┊   ┊508┊  export interface RemoveMessagesArgs {\n+┊   ┊509┊    chatId: string;\n+┊   ┊510┊    messageIds?: (string | null)[] | null;\n+┊   ┊511┊    all?: boolean | null;\n+┊   ┊512┊  }\n+┊   ┊513┊\n+┊   ┊514┊  export type AddMembersResolver<\n+┊   ┊515┊    R = (string | null)[] | null,\n+┊   ┊516┊    Parent = any,\n+┊   ┊517┊    Context = any\n+┊   ┊518┊  > = Resolver<R, Parent, Context, AddMembersArgs>;\n+┊   ┊519┊  export interface AddMembersArgs {\n+┊   ┊520┊    groupId: string;\n+┊   ┊521┊    userIds: string[];\n+┊   ┊522┊  }\n+┊   ┊523┊\n+┊   ┊524┊  export type RemoveMembersResolver<\n+┊   ┊525┊    R = (string | null)[] | null,\n+┊   ┊526┊    Parent = any,\n+┊   ┊527┊    Context = any\n+┊   ┊528┊  > = Resolver<R, Parent, Context, RemoveMembersArgs>;\n+┊   ┊529┊  export interface RemoveMembersArgs {\n+┊   ┊530┊    groupId: string;\n+┊   ┊531┊    userIds: string[];\n+┊   ┊532┊  }\n+┊   ┊533┊\n+┊   ┊534┊  export type AddAdminsResolver<\n+┊   ┊535┊    R = (string | null)[] | null,\n+┊   ┊536┊    Parent = any,\n+┊   ┊537┊    Context = any\n+┊   ┊538┊  > = Resolver<R, Parent, Context, AddAdminsArgs>;\n+┊   ┊539┊  export interface AddAdminsArgs {\n+┊   ┊540┊    groupId: string;\n+┊   ┊541┊    userIds: string[];\n+┊   ┊542┊  }\n+┊   ┊543┊\n+┊   ┊544┊  export type RemoveAdminsResolver<\n+┊   ┊545┊    R = (string | null)[] | null,\n+┊   ┊546┊    Parent = any,\n+┊   ┊547┊    Context = any\n+┊   ┊548┊  > = Resolver<R, Parent, Context, RemoveAdminsArgs>;\n+┊   ┊549┊  export interface RemoveAdminsArgs {\n+┊   ┊550┊    groupId: string;\n+┊   ┊551┊    userIds: string[];\n+┊   ┊552┊  }\n+┊   ┊553┊\n+┊   ┊554┊  export type SetGroupNameResolver<\n+┊   ┊555┊    R = string | null,\n+┊   ┊556┊    Parent = any,\n+┊   ┊557┊    Context = any\n+┊   ┊558┊  > = Resolver<R, Parent, Context, SetGroupNameArgs>;\n+┊   ┊559┊  export interface SetGroupNameArgs {\n+┊   ┊560┊    groupId: string;\n+┊   ┊561┊  }\n+┊   ┊562┊\n+┊   ┊563┊  export type SetGroupPictureResolver<\n ┊353┊564┊    R = string | null,\n ┊354┊565┊    Parent = any,\n ┊355┊566┊    Context = any\n+┊   ┊567┊  > = Resolver<R, Parent, Context, SetGroupPictureArgs>;\n+┊   ┊568┊  export interface SetGroupPictureArgs {\n+┊   ┊569┊    groupId: string;\n+┊   ┊570┊  }\n+┊   ┊571┊\n+┊   ┊572┊  export type MarkAsReceivedResolver<\n+┊   ┊573┊    R = boolean | null,\n+┊   ┊574┊    Parent = any,\n+┊   ┊575┊    Context = any\n+┊   ┊576┊  > = Resolver<R, Parent, Context, MarkAsReceivedArgs>;\n+┊   ┊577┊  export interface MarkAsReceivedArgs {\n+┊   ┊578┊    chatId: string;\n+┊   ┊579┊  }\n+┊   ┊580┊\n+┊   ┊581┊  export type MarkAsReadResolver<\n+┊   ┊582┊    R = boolean | null,\n+┊   ┊583┊    Parent = any,\n+┊   ┊584┊    Context = any\n+┊   ┊585┊  > = Resolver<R, Parent, Context, MarkAsReadArgs>;\n+┊   ┊586┊  export interface MarkAsReadArgs {\n+┊   ┊587┊    chatId: string;\n+┊   ┊588┊  }\n+┊   ┊589┊}\n+┊   ┊590┊\n+┊   ┊591┊export namespace SubscriptionResolvers {\n+┊   ┊592┊  export interface Resolvers<Context = any> {\n+┊   ┊593┊    messageAdded?: MessageAddedResolver<Message | null, any, Context>;\n+┊   ┊594┊    chatAdded?: ChatAddedResolver<Chat | null, any, Context>;\n+┊   ┊595┊  }\n+┊   ┊596┊\n+┊   ┊597┊  export type MessageAddedResolver<\n+┊   ┊598┊    R = Message | null,\n+┊   ┊599┊    Parent = any,\n+┊   ┊600┊    Context = any\n+┊   ┊601┊  > = Resolver<R, Parent, Context, MessageAddedArgs>;\n+┊   ┊602┊  export interface MessageAddedArgs {\n+┊   ┊603┊    chatId?: string | null;\n+┊   ┊604┊  }\n+┊   ┊605┊\n+┊   ┊606┊  export type ChatAddedResolver<\n+┊   ┊607┊    R = Chat | null,\n+┊   ┊608┊    Parent = any,\n+┊   ┊609┊    Context = any\n ┊356┊610┊  > = Resolver<R, Parent, Context>;\n ┊357┊611┊}\n ┊358┊612┊\n```\n```diff\n@@ -398,7 +652,7 @@\n ┊398┊652┊    chat: Chat;\n ┊399┊653┊    sender: Sender;\n ┊400┊654┊    content: string;\n-┊401┊   ┊    createdAt: string;\n+┊   ┊655┊    createdAt: Date;\n ┊402┊656┊    type: number;\n ┊403┊657┊    recipients: Recipients[];\n ┊404┊658┊    ownership: boolean;\n```\n```diff\n@@ -420,8 +674,8 @@\n ┊420┊674┊    user: User;\n ┊421┊675┊    message: Message;\n ┊422┊676┊    chat: __Chat;\n-┊423┊   ┊    receivedAt?: string | null;\n-┊424┊   ┊    readAt?: string | null;\n+┊   ┊677┊    receivedAt?: Date | null;\n+┊   ┊678┊    readAt?: Date | null;\n ┊425┊679┊  };\n ┊426┊680┊\n ┊427┊681┊  export type User = {\n```\n```diff\n@@ -445,3 +699,77 @@\n ┊445┊699┊    id: string;\n ┊446┊700┊  };\n ┊447┊701┊}\n+┊   ┊702┊\n+┊   ┊703┊import { Injectable } from \"@angular/core\";\n+┊   ┊704┊\n+┊   ┊705┊import * as Apollo from \"apollo-angular\";\n+┊   ┊706┊\n+┊   ┊707┊import gql from \"graphql-tag\";\n+┊   ┊708┊\n+┊   ┊709┊const ChatWithoutMessagesFragment = gql`\n+┊   ┊710┊  fragment ChatWithoutMessages on Chat {\n+┊   ┊711┊    id\n+┊   ┊712┊    name\n+┊   ┊713┊    picture\n+┊   ┊714┊    allTimeMembers {\n+┊   ┊715┊      id\n+┊   ┊716┊    }\n+┊   ┊717┊    unreadMessages\n+┊   ┊718┊    isGroup\n+┊   ┊719┊  }\n+┊   ┊720┊`;\n+┊   ┊721┊\n+┊   ┊722┊const MessageFragment = gql`\n+┊   ┊723┊  fragment Message on Message {\n+┊   ┊724┊    id\n+┊   ┊725┊    chat {\n+┊   ┊726┊      id\n+┊   ┊727┊    }\n+┊   ┊728┊    sender {\n+┊   ┊729┊      id\n+┊   ┊730┊      name\n+┊   ┊731┊    }\n+┊   ┊732┊    content\n+┊   ┊733┊    createdAt\n+┊   ┊734┊    type\n+┊   ┊735┊    recipients {\n+┊   ┊736┊      user {\n+┊   ┊737┊        id\n+┊   ┊738┊      }\n+┊   ┊739┊      message {\n+┊   ┊740┊        id\n+┊   ┊741┊        chat {\n+┊   ┊742┊          id\n+┊   ┊743┊        }\n+┊   ┊744┊      }\n+┊   ┊745┊      chat {\n+┊   ┊746┊        id\n+┊   ┊747┊      }\n+┊   ┊748┊      receivedAt\n+┊   ┊749┊      readAt\n+┊   ┊750┊    }\n+┊   ┊751┊    ownership\n+┊   ┊752┊  }\n+┊   ┊753┊`;\n+┊   ┊754┊\n+┊   ┊755┊@Injectable({\n+┊   ┊756┊  providedIn: \"root\"\n+┊   ┊757┊})\n+┊   ┊758┊export class GetChatsGQL extends Apollo.Query<\n+┊   ┊759┊  GetChats.Query,\n+┊   ┊760┊  GetChats.Variables\n+┊   ┊761┊> {\n+┊   ┊762┊  document: any = gql`\n+┊   ┊763┊    query GetChats($amount: Int) {\n+┊   ┊764┊      chats {\n+┊   ┊765┊        ...ChatWithoutMessages\n+┊   ┊766┊        messages(amount: $amount) {\n+┊   ┊767┊          ...Message\n+┊   ┊768┊        }\n+┊   ┊769┊      }\n+┊   ┊770┊    }\n+┊   ┊771┊\n+┊   ┊772┊    ${ChatWithoutMessagesFragment}\n+┊   ┊773┊    ${MessageFragment}\n+┊   ┊774┊  `;\n+┊   ┊775┊}\n```\n\n[}]: #\n\nThe Apollo Angular template generates a ready to use in your component, strongly typed Angular services, for every defined query, mutation or subscription.\n\nIt's possible thanks to the new API of Apollo Angular. More on that in [\"Query, Mutation, Subscription services\"](http://apollographql.com/docs/angular/basics/services.html?_ga=2.227615197.1327014552.1538988114-793224955.1532981447) chapter of the documentation.\n\nGiven an example:\n\n```graphql\nquery GetChats($amount: Int) {\n  chats {\n    ...ChatWithoutMessages\n    messages(amount: $amount) {\n      ...Message\n    }\n  }\n}\n```\n\nThe Apollo Angular template, after you run `yarn generate`, outputs a service called `GetChatsGQL`:\n\n```typescript\nimport { GetChatsGQL, GetChats } from '../graphql';\n\nexport class AppComponent {\n  constructor(private getChatsGQL: GetChatsGQL) {}\n\n  getChats(): GetChats.Chats[] {\n    return this.getChatsGQL\n      .watch({\n        amount: 10,\n      })\n      .valueChanges.pipe(map(result => result.data.chats));\n  }\n}\n```\n\n> Remember, every operation should has an unique name.\n\nIt might look a bit different then what you have already learnt but we promise, the API is even easier.\n\nBut first, let's dive into how those services look like under the hood.\n\n```typescript\nimport { Query } from 'apollo-angular';\n\n@Injectable({\n  providedIn: 'root',\n})\nexport class GetChatsGQL extends Query<GetChats.Query, GetChats.Variables> {\n  document = gql`\n    here goes the document\n  `;\n}\n```\n\nOkay, seems easy but what is the `Query` class, you might ask!\n\nApollo Angular exposes three classes for three kinds of the GraphQL operation: `Query`, `Mutation` and `Subscription`. Each of them has a different API.\n\n- `Query` has `fetch` and `watch`. First one behave like `Apollo.query()`, second one like `Apollo.watchQuery()`\n- `Mutation` has `mutate`\n- `Subscription` has `subscribe`\n\nBecause the `document` is already defined in a class, they all accept two arguments (Subscription has third one). First argument defines variables, second shapes the options. Thats why we used `this.getChatsGQL.watch({ amount: 10 })`.\n\nLet's stop talking about the API itself and see what benefits it brings us:\n\n- **Less code to write** - no need to create a network call, no need to create Typescript typings, no need to create a dedicated Angular service\n- **Strongly typed out of the box — all** types are being generated, no need to write any Typescript definitions and struggle to keep them updated\n- _More pleasent API_ to work with\n- **Full developer experience of tools and IDEs**  —  development time, autocomplete and error checking, not only across your frontend app but also with your API teams!\n- **Tree-shakable** thanks to Angular 6\n\nMost IDEs with the GraphQL support (built-in or thanks to extensions) fully handles `.graphql` files and helps you with features like auto-completion, validation but they strugle with `gql` tag. To fully enjoy GraphQL we highly recommend to use static `.graphql` files.\n\nWith all that knowledge, let's use GQL services in our application:\n\n[{]: <helper> (diffStep \"2.4\" files=\"src/app/services/chats.service.ts\" module=\"client\")\n\n#### [Step 2.4: Use auto-generated GQL services](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/c0eddd1)\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,21 +1,18 @@\n ┊ 1┊ 1┊import {map} from 'rxjs/operators';\n-┊ 2┊  ┊import {Apollo} from 'apollo-angular';\n ┊ 3┊ 2┊import {Injectable} from '@angular/core';\n-┊ 4┊  ┊import {getChatsQuery} from '../../graphql/getChats.query';\n-┊ 5┊  ┊import {GetChats} from '../../graphql';\n+┊  ┊ 3┊import {GetChatsGQL} from '../../graphql';\n ┊ 6┊ 4┊\n ┊ 7┊ 5┊@Injectable()\n ┊ 8┊ 6┊export class ChatsService {\n ┊ 9┊ 7┊  messagesAmount = 3;\n ┊10┊ 8┊\n-┊11┊  ┊  constructor(private apollo: Apollo) {}\n+┊  ┊ 9┊  constructor(\n+┊  ┊10┊    private getChatsGQL: GetChatsGQL\n+┊  ┊11┊  ) {}\n ┊12┊12┊\n ┊13┊13┊  getChats() {\n-┊14┊  ┊    const query = this.apollo.watchQuery<GetChats.Query>({\n-┊15┊  ┊      query: getChatsQuery,\n-┊16┊  ┊      variables: {\n-┊17┊  ┊        amount: this.messagesAmount,\n-┊18┊  ┊      },\n+┊  ┊14┊    const query = this.getChatsGQL.watch({\n+┊  ┊15┊      amount: this.messagesAmount,\n ┊19┊16┊    });\n ┊20┊17┊    const chats$ = query.valueChanges.pipe(\n ┊21┊18┊      map((result) => result.data.chats)\n```\n\n[}]: #"
          },
          {
            "manualTitle": "Step 7: Testing",
            "stepRevision": "1faa6c13bf9f48f94f7b027bea9c8277612be7ec",
            "manualView": "## Client\n\nTesting is a very important part of each application and for the sake of showing different testing techniques we are going to show how to test a presentational component, a container component and a service.\n\nFirst let's start by importing `hammerjs` for the Material Gestures inside the test script.\n\n[{]: <helper> (diffStep \"3.1\" files=\"src/test.ts\" module=\"client\")\n\n#### [Step 3.1: Testing](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/b76d15b)\n\n##### Changed src&#x2F;test.ts\n```diff\n@@ -7,6 +7,9 @@\n ┊ 7┊ 7┊  platformBrowserDynamicTesting\n ┊ 8┊ 8┊} from '@angular/platform-browser-dynamic/testing';\n ┊ 9┊ 9┊\n+┊  ┊10┊// Material gestures\n+┊  ┊11┊import 'hammerjs';\n+┊  ┊12┊\n ┊10┊13┊declare const require: any;\n ┊11┊14┊\n ┊12┊15┊// First, initialize the Angular testing environment.\n```\n\n[}]: #\n\n### Testing a Presentional Component\n\nLet's start with the simplest one: the presentational component.\nWe are not going to inject any service and we don't need to access our backend, so things are quite simple: we just need to pass our Chat object as an Input, detect the changes and use the query selector to match the UI content to the one we passed as input:\n\n[{]: <helper> (diffStep \"3.1\" files=\"src/app/chats-lister/components/chat-item/chat-item.component.spec.ts\" module=\"client\")\n\n#### [Step 3.1: Testing](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/b76d15b)\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chat-item&#x2F;chat-item.component.spec.ts\n```diff\n@@ -0,0 +1,107 @@\n+┊   ┊  1┊import { async, ComponentFixture, TestBed } from '@angular/core/testing';\n+┊   ┊  2┊\n+┊   ┊  3┊import { ChatItemComponent } from './chat-item.component';\n+┊   ┊  4┊import {DebugElement} from '@angular/core';\n+┊   ┊  5┊import {By} from '@angular/platform-browser';\n+┊   ┊  6┊import {TruncateModule} from 'ng2-truncate';\n+┊   ┊  7┊\n+┊   ┊  8┊describe('ChatItemComponent', () => {\n+┊   ┊  9┊  let component: ChatItemComponent;\n+┊   ┊ 10┊  let fixture: ComponentFixture<ChatItemComponent>;\n+┊   ┊ 11┊  let el: DebugElement;\n+┊   ┊ 12┊\n+┊   ┊ 13┊  const chat: any = {\n+┊   ┊ 14┊    id: '1',\n+┊   ┊ 15┊    __typename: 'Chat',\n+┊   ┊ 16┊    name: 'Niccolo\\' Belli',\n+┊   ┊ 17┊    picture: null,\n+┊   ┊ 18┊    allTimeMembers: [\n+┊   ┊ 19┊      {\n+┊   ┊ 20┊        id: '1',\n+┊   ┊ 21┊        __typename: 'User',\n+┊   ┊ 22┊      },\n+┊   ┊ 23┊      {\n+┊   ┊ 24┊        id: '2',\n+┊   ┊ 25┊        __typename: 'User',\n+┊   ┊ 26┊      }\n+┊   ┊ 27┊    ],\n+┊   ┊ 28┊    unreadMessages: 0,\n+┊   ┊ 29┊    isGroup: false,\n+┊   ┊ 30┊    messages: [\n+┊   ┊ 31┊      {\n+┊   ┊ 32┊        id: '1',\n+┊   ┊ 33┊        chat: {\n+┊   ┊ 34┊          id: '1',\n+┊   ┊ 35┊          __typename: 'Chat',\n+┊   ┊ 36┊        },\n+┊   ┊ 37┊        __typename: 'Message',\n+┊   ┊ 38┊        sender: {\n+┊   ┊ 39┊          id: '1',\n+┊   ┊ 40┊          __typename: 'User',\n+┊   ┊ 41┊          name: 'Niccolo\\' Belli',\n+┊   ┊ 42┊        },\n+┊   ┊ 43┊        content: 'Hello! How are you? A lot happened since last time',\n+┊   ┊ 44┊        createdAt: '1513435525',\n+┊   ┊ 45┊        type: 1,\n+┊   ┊ 46┊        recipients: [\n+┊   ┊ 47┊          {\n+┊   ┊ 48┊            user: {\n+┊   ┊ 49┊              id: '2',\n+┊   ┊ 50┊              __typename: 'User',\n+┊   ┊ 51┊            },\n+┊   ┊ 52┊            message: {\n+┊   ┊ 53┊              id: '1',\n+┊   ┊ 54┊              __typename: 'Message',\n+┊   ┊ 55┊              chat: {\n+┊   ┊ 56┊                id: '1',\n+┊   ┊ 57┊                __typename: 'Chat',\n+┊   ┊ 58┊              },\n+┊   ┊ 59┊            },\n+┊   ┊ 60┊            __typename: 'Recipient',\n+┊   ┊ 61┊            chat: {\n+┊   ┊ 62┊              id: '1',\n+┊   ┊ 63┊              __typename: 'Chat',\n+┊   ┊ 64┊            },\n+┊   ┊ 65┊            receivedAt: null,\n+┊   ┊ 66┊            readAt: null,\n+┊   ┊ 67┊          }\n+┊   ┊ 68┊        ],\n+┊   ┊ 69┊        ownership: true,\n+┊   ┊ 70┊      }\n+┊   ┊ 71┊    ],\n+┊   ┊ 72┊  };\n+┊   ┊ 73┊\n+┊   ┊ 74┊  beforeEach(async(() => {\n+┊   ┊ 75┊    TestBed.configureTestingModule({\n+┊   ┊ 76┊      declarations: [ ChatItemComponent ],\n+┊   ┊ 77┊      imports: [TruncateModule]\n+┊   ┊ 78┊    })\n+┊   ┊ 79┊    .compileComponents();\n+┊   ┊ 80┊  }));\n+┊   ┊ 81┊\n+┊   ┊ 82┊  beforeEach(() => {\n+┊   ┊ 83┊    fixture = TestBed.createComponent(ChatItemComponent);\n+┊   ┊ 84┊    component = fixture.componentInstance;\n+┊   ┊ 85┊    component.chat = chat;\n+┊   ┊ 86┊    fixture.detectChanges();\n+┊   ┊ 87┊    el = fixture.debugElement;\n+┊   ┊ 88┊  });\n+┊   ┊ 89┊\n+┊   ┊ 90┊  it('should create', () => {\n+┊   ┊ 91┊    expect(component).toBeTruthy();\n+┊   ┊ 92┊  });\n+┊   ┊ 93┊\n+┊   ┊ 94┊  it('should contain the chat name', () => {\n+┊   ┊ 95┊    expect(el.query(By.css('.chat-recipient > div:first-child')).nativeElement.textContent).toContain(chat.name);\n+┊   ┊ 96┊  });\n+┊   ┊ 97┊\n+┊   ┊ 98┊  it('should contain the first couple of characters of the message content', () => {\n+┊   ┊ 99┊    expect(el.query(By.css('.chat-content')).nativeElement.textContent)\n+┊   ┊100┊      .toContain(chat.messages[chat.messages.length - 1].content.slice(0, 20));\n+┊   ┊101┊  });\n+┊   ┊102┊\n+┊   ┊103┊  it('should not contain the latest characters of the message content', () => {\n+┊   ┊104┊    expect(el.query(By.css('.chat-content')).nativeElement.textContent)\n+┊   ┊105┊      .not.toContain(chat.messages[chat.messages.length - 1].content.slice(20));\n+┊   ┊106┊  });\n+┊   ┊107┊});\n```\n\n[}]: #\n\n### Testing a Service\n\nTesting a service is a bit more complicated because we will need to mock our backend in order to get fake results instead of having to fire up the backend each time.\n\nWe could simply simply mock the HTTP calls, which is a well known practice in the REST API world. Since we are using HTTP to retrieve the data, it would work as well with our Apollo Client setup.\n\n#### Testing with Apollo Angular\n\nBecause Apollo Angular provides its own testing utilities, let's bring them in!\n\nAlthough `apollo-angular` has a lot going on under the hood, the library provides multiple tools for testing that simplify those abstractions, and allows complete focus on the component logic.\n\nThe `apollo-angular/testing` module exports a `ApolloTestingModule` module and `ApolloTestingController` service which simplifies the testing of Angular components by mocking calls to the GraphQL endpoint. This allows the tests to be run in isolation and provides consistent results on every run by removing the dependence on remote data.\n\nBy using this `ApolloTestingController` service, it’s possible to specify the exact results that should be returned for a certain query.\n\nWorth mentioning, `ApolloTestingModule` comes with a default cache but you can use your own with `APOLLO_TESTING_CACHE` token.\n\nLet's show everything on an example:\n\n[{]: <helper> (diffStep \"3.1\" files=\"src/app/services/chats.service.spec.ts\" module=\"client\")\n\n#### [Step 3.1: Testing](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/b76d15b)\n\n##### Added src&#x2F;app&#x2F;services&#x2F;chats.service.spec.ts\n```diff\n@@ -0,0 +1,352 @@\n+┊   ┊  1┊import { TestBed, inject } from '@angular/core/testing';\n+┊   ┊  2┊\n+┊   ┊  3┊import { Apollo } from 'apollo-angular';\n+┊   ┊  4┊import {\n+┊   ┊  5┊  ApolloTestingModule,\n+┊   ┊  6┊  ApolloTestingController,\n+┊   ┊  7┊  APOLLO_TESTING_CACHE,\n+┊   ┊  8┊} from 'apollo-angular/testing';\n+┊   ┊  9┊import { InMemoryCache } from 'apollo-cache-inmemory';\n+┊   ┊ 10┊\n+┊   ┊ 11┊import { GetChats } from '../../graphql';\n+┊   ┊ 12┊import { dataIdFromObject } from '../graphql.module';\n+┊   ┊ 13┊import { ChatsService } from './chats.service';\n+┊   ┊ 14┊\n+┊   ┊ 15┊describe('ChatsService', () => {\n+┊   ┊ 16┊  let controller: ApolloTestingController;\n+┊   ┊ 17┊  let apollo: Apollo;\n+┊   ┊ 18┊\n+┊   ┊ 19┊  const chats: GetChats.Chats[] = [\n+┊   ┊ 20┊    {\n+┊   ┊ 21┊      id: '1',\n+┊   ┊ 22┊      __typename: 'Chat',\n+┊   ┊ 23┊      name: 'Avery Stewart',\n+┊   ┊ 24┊      picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n+┊   ┊ 25┊      allTimeMembers: [\n+┊   ┊ 26┊        {\n+┊   ┊ 27┊          id: '1',\n+┊   ┊ 28┊          __typename: 'User',\n+┊   ┊ 29┊        },\n+┊   ┊ 30┊        {\n+┊   ┊ 31┊          id: '3',\n+┊   ┊ 32┊          __typename: 'User',\n+┊   ┊ 33┊        },\n+┊   ┊ 34┊      ],\n+┊   ┊ 35┊      unreadMessages: 1,\n+┊   ┊ 36┊      isGroup: false,\n+┊   ┊ 37┊      messages: [\n+┊   ┊ 38┊        {\n+┊   ┊ 39┊          id: '1',\n+┊   ┊ 40┊          chat: {\n+┊   ┊ 41┊            id: '1',\n+┊   ┊ 42┊            __typename: 'Chat',\n+┊   ┊ 43┊          },\n+┊   ┊ 44┊          __typename: 'Message',\n+┊   ┊ 45┊          sender: {\n+┊   ┊ 46┊            id: '3',\n+┊   ┊ 47┊            __typename: 'User',\n+┊   ┊ 48┊            name: 'Avery Stewart',\n+┊   ┊ 49┊          },\n+┊   ┊ 50┊          content: 'Yep!',\n+┊   ┊ 51┊          createdAt: '1514035700',\n+┊   ┊ 52┊          type: 0,\n+┊   ┊ 53┊          recipients: [\n+┊   ┊ 54┊            {\n+┊   ┊ 55┊              user: {\n+┊   ┊ 56┊                id: '1',\n+┊   ┊ 57┊                __typename: 'User',\n+┊   ┊ 58┊              },\n+┊   ┊ 59┊              message: {\n+┊   ┊ 60┊                id: '1',\n+┊   ┊ 61┊                __typename: 'Message',\n+┊   ┊ 62┊                chat: {\n+┊   ┊ 63┊                  id: '1',\n+┊   ┊ 64┊                  __typename: 'Chat',\n+┊   ┊ 65┊                },\n+┊   ┊ 66┊              },\n+┊   ┊ 67┊              __typename: 'Recipient',\n+┊   ┊ 68┊              chat: {\n+┊   ┊ 69┊                id: '1',\n+┊   ┊ 70┊                __typename: 'Chat',\n+┊   ┊ 71┊              },\n+┊   ┊ 72┊              receivedAt: null,\n+┊   ┊ 73┊              readAt: null,\n+┊   ┊ 74┊            },\n+┊   ┊ 75┊          ],\n+┊   ┊ 76┊          ownership: false,\n+┊   ┊ 77┊        },\n+┊   ┊ 78┊      ],\n+┊   ┊ 79┊    },\n+┊   ┊ 80┊    {\n+┊   ┊ 81┊      id: '2',\n+┊   ┊ 82┊      __typename: 'Chat',\n+┊   ┊ 83┊      name: 'Katie Peterson',\n+┊   ┊ 84┊      picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n+┊   ┊ 85┊      allTimeMembers: [\n+┊   ┊ 86┊        {\n+┊   ┊ 87┊          id: '1',\n+┊   ┊ 88┊          __typename: 'User',\n+┊   ┊ 89┊        },\n+┊   ┊ 90┊        {\n+┊   ┊ 91┊          id: '4',\n+┊   ┊ 92┊          __typename: 'User',\n+┊   ┊ 93┊        },\n+┊   ┊ 94┊      ],\n+┊   ┊ 95┊      unreadMessages: 0,\n+┊   ┊ 96┊      isGroup: false,\n+┊   ┊ 97┊      messages: [\n+┊   ┊ 98┊        {\n+┊   ┊ 99┊          id: '1',\n+┊   ┊100┊          chat: {\n+┊   ┊101┊            id: '2',\n+┊   ┊102┊            __typename: 'Chat',\n+┊   ┊103┊          },\n+┊   ┊104┊          __typename: 'Message',\n+┊   ┊105┊          sender: {\n+┊   ┊106┊            id: '1',\n+┊   ┊107┊            __typename: 'User',\n+┊   ┊108┊            name: 'Ethan Gonzalez',\n+┊   ┊109┊          },\n+┊   ┊110┊          content: `Hey, it's me`,\n+┊   ┊111┊          createdAt: '1514031800',\n+┊   ┊112┊          type: 0,\n+┊   ┊113┊          recipients: [\n+┊   ┊114┊            {\n+┊   ┊115┊              user: {\n+┊   ┊116┊                id: '4',\n+┊   ┊117┊                __typename: 'User',\n+┊   ┊118┊              },\n+┊   ┊119┊              message: {\n+┊   ┊120┊                id: '1',\n+┊   ┊121┊                __typename: 'Message',\n+┊   ┊122┊                chat: {\n+┊   ┊123┊                  id: '2',\n+┊   ┊124┊                  __typename: 'Chat',\n+┊   ┊125┊                },\n+┊   ┊126┊              },\n+┊   ┊127┊              __typename: 'Recipient',\n+┊   ┊128┊              chat: {\n+┊   ┊129┊                id: '2',\n+┊   ┊130┊                __typename: 'Chat',\n+┊   ┊131┊              },\n+┊   ┊132┊              receivedAt: null,\n+┊   ┊133┊              readAt: null,\n+┊   ┊134┊            },\n+┊   ┊135┊          ],\n+┊   ┊136┊          ownership: true,\n+┊   ┊137┊        },\n+┊   ┊138┊      ],\n+┊   ┊139┊    },\n+┊   ┊140┊    {\n+┊   ┊141┊      id: '3',\n+┊   ┊142┊      __typename: 'Chat',\n+┊   ┊143┊      name: 'Ray Edwards',\n+┊   ┊144┊      picture: 'https://randomuser.me/api/portraits/thumb/men/3.jpg',\n+┊   ┊145┊      allTimeMembers: [\n+┊   ┊146┊        {\n+┊   ┊147┊          id: '1',\n+┊   ┊148┊          __typename: 'User',\n+┊   ┊149┊        },\n+┊   ┊150┊        {\n+┊   ┊151┊          id: '5',\n+┊   ┊152┊          __typename: 'User',\n+┊   ┊153┊        },\n+┊   ┊154┊      ],\n+┊   ┊155┊      unreadMessages: 0,\n+┊   ┊156┊      isGroup: false,\n+┊   ┊157┊      messages: [\n+┊   ┊158┊        {\n+┊   ┊159┊          id: '1',\n+┊   ┊160┊          __typename: 'Message',\n+┊   ┊161┊          chat: {\n+┊   ┊162┊            id: '3',\n+┊   ┊163┊            __typename: 'Chat',\n+┊   ┊164┊          },\n+┊   ┊165┊          sender: {\n+┊   ┊166┊            id: '1',\n+┊   ┊167┊            __typename: 'User',\n+┊   ┊168┊            name: 'Ethan Gonzalez',\n+┊   ┊169┊          },\n+┊   ┊170┊          content: 'You still there?',\n+┊   ┊171┊          createdAt: '1514010200',\n+┊   ┊172┊          type: 0,\n+┊   ┊173┊          recipients: [\n+┊   ┊174┊            {\n+┊   ┊175┊              user: {\n+┊   ┊176┊                id: '5',\n+┊   ┊177┊                __typename: 'User',\n+┊   ┊178┊              },\n+┊   ┊179┊              message: {\n+┊   ┊180┊                id: '1',\n+┊   ┊181┊                __typename: 'Message',\n+┊   ┊182┊                chat: {\n+┊   ┊183┊                  id: '3',\n+┊   ┊184┊                  __typename: 'Chat',\n+┊   ┊185┊                },\n+┊   ┊186┊              },\n+┊   ┊187┊              __typename: 'Recipient',\n+┊   ┊188┊              chat: {\n+┊   ┊189┊                id: '3',\n+┊   ┊190┊                __typename: 'Chat',\n+┊   ┊191┊              },\n+┊   ┊192┊              receivedAt: null,\n+┊   ┊193┊              readAt: null,\n+┊   ┊194┊            },\n+┊   ┊195┊          ],\n+┊   ┊196┊          ownership: true,\n+┊   ┊197┊        },\n+┊   ┊198┊      ],\n+┊   ┊199┊    },\n+┊   ┊200┊    {\n+┊   ┊201┊      id: '6',\n+┊   ┊202┊      __typename: 'Chat',\n+┊   ┊203┊      name: 'Niccolò Belli',\n+┊   ┊204┊      picture: 'https://randomuser.me/api/portraits/thumb/men/4.jpg',\n+┊   ┊205┊      allTimeMembers: [\n+┊   ┊206┊        {\n+┊   ┊207┊          id: '1',\n+┊   ┊208┊          __typename: 'User',\n+┊   ┊209┊        },\n+┊   ┊210┊        {\n+┊   ┊211┊          id: '6',\n+┊   ┊212┊          __typename: 'User',\n+┊   ┊213┊        },\n+┊   ┊214┊      ],\n+┊   ┊215┊      unreadMessages: 0,\n+┊   ┊216┊      messages: [],\n+┊   ┊217┊      isGroup: false,\n+┊   ┊218┊    },\n+┊   ┊219┊    {\n+┊   ┊220┊      id: '8',\n+┊   ┊221┊      __typename: 'Chat',\n+┊   ┊222┊      name: 'A user 0 group',\n+┊   ┊223┊      picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n+┊   ┊224┊      allTimeMembers: [\n+┊   ┊225┊        {\n+┊   ┊226┊          id: '1',\n+┊   ┊227┊          __typename: 'User',\n+┊   ┊228┊        },\n+┊   ┊229┊        {\n+┊   ┊230┊          id: '3',\n+┊   ┊231┊          __typename: 'User',\n+┊   ┊232┊        },\n+┊   ┊233┊        {\n+┊   ┊234┊          id: '4',\n+┊   ┊235┊          __typename: 'User',\n+┊   ┊236┊        },\n+┊   ┊237┊        {\n+┊   ┊238┊          id: '6',\n+┊   ┊239┊          __typename: 'User',\n+┊   ┊240┊        },\n+┊   ┊241┊      ],\n+┊   ┊242┊      unreadMessages: 1,\n+┊   ┊243┊      isGroup: true,\n+┊   ┊244┊      messages: [\n+┊   ┊245┊        {\n+┊   ┊246┊          id: '1',\n+┊   ┊247┊          __typename: 'Message',\n+┊   ┊248┊          chat: {\n+┊   ┊249┊            id: '8',\n+┊   ┊250┊            __typename: 'Chat',\n+┊   ┊251┊          },\n+┊   ┊252┊          sender: {\n+┊   ┊253┊            id: '4',\n+┊   ┊254┊            __typename: 'User',\n+┊   ┊255┊            name: 'Katie Peterson',\n+┊   ┊256┊          },\n+┊   ┊257┊          content: 'Awesome!',\n+┊   ┊258┊          createdAt: '1512830000',\n+┊   ┊259┊          type: 0,\n+┊   ┊260┊          recipients: [\n+┊   ┊261┊            {\n+┊   ┊262┊              user: {\n+┊   ┊263┊                id: '1',\n+┊   ┊264┊                __typename: 'User',\n+┊   ┊265┊              },\n+┊   ┊266┊              message: {\n+┊   ┊267┊                id: '1',\n+┊   ┊268┊                __typename: 'Message',\n+┊   ┊269┊                chat: {\n+┊   ┊270┊                  id: '8',\n+┊   ┊271┊                  __typename: 'Chat',\n+┊   ┊272┊                },\n+┊   ┊273┊              },\n+┊   ┊274┊              __typename: 'Recipient',\n+┊   ┊275┊              chat: {\n+┊   ┊276┊                id: '8',\n+┊   ┊277┊                __typename: 'Chat',\n+┊   ┊278┊              },\n+┊   ┊279┊              receivedAt: null,\n+┊   ┊280┊              readAt: null,\n+┊   ┊281┊            },\n+┊   ┊282┊            {\n+┊   ┊283┊              user: {\n+┊   ┊284┊                id: '6',\n+┊   ┊285┊                __typename: 'User',\n+┊   ┊286┊              },\n+┊   ┊287┊              message: {\n+┊   ┊288┊                id: '1',\n+┊   ┊289┊                __typename: 'Message',\n+┊   ┊290┊                chat: {\n+┊   ┊291┊                  id: '8',\n+┊   ┊292┊                  __typename: 'Chat',\n+┊   ┊293┊                },\n+┊   ┊294┊              },\n+┊   ┊295┊              __typename: 'Recipient',\n+┊   ┊296┊              chat: {\n+┊   ┊297┊                id: '8',\n+┊   ┊298┊                __typename: 'Chat',\n+┊   ┊299┊              },\n+┊   ┊300┊              receivedAt: null,\n+┊   ┊301┊              readAt: null,\n+┊   ┊302┊            },\n+┊   ┊303┊          ],\n+┊   ┊304┊          ownership: false,\n+┊   ┊305┊        },\n+┊   ┊306┊      ],\n+┊   ┊307┊    },\n+┊   ┊308┊  ];\n+┊   ┊309┊\n+┊   ┊310┊  beforeEach(() => {\n+┊   ┊311┊    TestBed.configureTestingModule({\n+┊   ┊312┊      imports: [ApolloTestingModule],\n+┊   ┊313┊      providers: [\n+┊   ┊314┊        ChatsService,\n+┊   ┊315┊        {\n+┊   ┊316┊          provide: APOLLO_TESTING_CACHE,\n+┊   ┊317┊          useFactory() {\n+┊   ┊318┊            return new InMemoryCache({\n+┊   ┊319┊              dataIdFromObject,\n+┊   ┊320┊            });\n+┊   ┊321┊          },\n+┊   ┊322┊        },\n+┊   ┊323┊      ],\n+┊   ┊324┊    });\n+┊   ┊325┊\n+┊   ┊326┊    controller = TestBed.get(ApolloTestingController);\n+┊   ┊327┊    apollo = TestBed.get(Apollo);\n+┊   ┊328┊  });\n+┊   ┊329┊\n+┊   ┊330┊  it('should be created', inject([ChatsService], (service: ChatsService) => {\n+┊   ┊331┊    expect(service).toBeTruthy();\n+┊   ┊332┊  }));\n+┊   ┊333┊\n+┊   ┊334┊  it('should get chats', inject([ChatsService], (service: ChatsService) => {\n+┊   ┊335┊    service.getChats().chats$.subscribe(_chats => {\n+┊   ┊336┊      expect(_chats.length).toEqual(chats.length);\n+┊   ┊337┊      for (let i = 0; i < _chats.length; i++) {\n+┊   ┊338┊        expect(_chats[i]).toEqual(chats[i]);\n+┊   ┊339┊      }\n+┊   ┊340┊    });\n+┊   ┊341┊\n+┊   ┊342┊    const req = controller.expectOne('GetChats', 'GetChats operation');\n+┊   ┊343┊\n+┊   ┊344┊    req.flush({\n+┊   ┊345┊      data: {\n+┊   ┊346┊        chats,\n+┊   ┊347┊      },\n+┊   ┊348┊    });\n+┊   ┊349┊\n+┊   ┊350┊    controller.verify();\n+┊   ┊351┊  }));\n+┊   ┊352┊});\n```\n\n[}]: #\n\nAs you can see, the API of `ApolloTestingController` is pretty similar to the `HttpTestingController`.\n\nThere are four methods you should know.\n\n**`expectOne()`**\nImportant thing, it accepts two arguments. First is different for different use cases, the second one stays always the same, it’s a string with a description of your assertion. In case of failing assertion, the error is thrown with an error message including the given description.\n\nLet's explore all those possible cases `expectOne` accepts:\n\n- you can match an operation by its name, simply by passing a string as a first argument.\n- by passing the whole Operation object the expectOne method compares: operation’s name, variables, document and extensions.\n- the first argument can also be a function that provides an Operation object and expect a boolean in return\n- or passing a GraphQL Document\n\n**`exceptNone()`**\nIt accepts the same arguments as expectOne but it's a negation of it.\n\n**`match()`**\nSearch for operations that match the given parameters, without any expectations.\n\n**`verify()`**\nVerify that no unmatched operations are outstanding. If any operations are outstanding, fail with an error message indicating which operations were not handled.\n\nIf you want to learn more about testing, we got you covered, please visit [\"Testing Apollo in Angular\" chapter](https://www.apollographql.com/docs/angular/guides/testing.html) in Apollo documentation.\n\n### Testing a Container Component\n\nIn the last example we are going to test a container component, which makes use of several services and multiple other components:\n\n[{]: <helper> (diffStep \"3.1\" files=\"src/app/chats-lister/containers/chats/chats.component.spec.ts\" module=\"client\")\n\n#### [Step 3.1: Testing](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/b76d15b)\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.spec.ts\n```diff\n@@ -0,0 +1,392 @@\n+┊   ┊  1┊import { async, ComponentFixture, TestBed } from '@angular/core/testing';\n+┊   ┊  2┊import { DebugElement, NO_ERRORS_SCHEMA } from '@angular/core';\n+┊   ┊  3┊import { TruncateModule } from 'ng2-truncate';\n+┊   ┊  4┊import {\n+┊   ┊  5┊  MatButtonModule,\n+┊   ┊  6┊  MatIconModule,\n+┊   ┊  7┊  MatListModule,\n+┊   ┊  8┊  MatMenuModule,\n+┊   ┊  9┊} from '@angular/material';\n+┊   ┊ 10┊import { Apollo } from 'apollo-angular';\n+┊   ┊ 11┊import {\n+┊   ┊ 12┊  ApolloTestingModule,\n+┊   ┊ 13┊  ApolloTestingController,\n+┊   ┊ 14┊  APOLLO_TESTING_CACHE,\n+┊   ┊ 15┊} from 'apollo-angular/testing';\n+┊   ┊ 16┊import { InMemoryCache } from 'apollo-cache-inmemory';\n+┊   ┊ 17┊import { By } from '@angular/platform-browser';\n+┊   ┊ 18┊import { RouterTestingModule } from '@angular/router/testing';\n+┊   ┊ 19┊\n+┊   ┊ 20┊import { GetChats } from '../../../../graphql';\n+┊   ┊ 21┊import { dataIdFromObject } from '../../../graphql.module';\n+┊   ┊ 22┊import { ChatsComponent } from './chats.component';\n+┊   ┊ 23┊import { ChatsListComponent } from '../../components/chats-list/chats-list.component';\n+┊   ┊ 24┊import { ChatItemComponent } from '../../components/chat-item/chat-item.component';\n+┊   ┊ 25┊import { ChatsService } from '../../../services/chats.service';\n+┊   ┊ 26┊\n+┊   ┊ 27┊describe('ChatsComponent', () => {\n+┊   ┊ 28┊  let component: ChatsComponent;\n+┊   ┊ 29┊  let fixture: ComponentFixture<ChatsComponent>;\n+┊   ┊ 30┊  let el: DebugElement;\n+┊   ┊ 31┊\n+┊   ┊ 32┊  let controller: ApolloTestingController;\n+┊   ┊ 33┊  let apollo: Apollo;\n+┊   ┊ 34┊\n+┊   ┊ 35┊  const chats: GetChats.Chats[] = [\n+┊   ┊ 36┊    {\n+┊   ┊ 37┊      id: '1',\n+┊   ┊ 38┊      __typename: 'Chat',\n+┊   ┊ 39┊      name: 'Avery Stewart',\n+┊   ┊ 40┊      picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n+┊   ┊ 41┊      allTimeMembers: [\n+┊   ┊ 42┊        {\n+┊   ┊ 43┊          id: '1',\n+┊   ┊ 44┊          __typename: 'User',\n+┊   ┊ 45┊        },\n+┊   ┊ 46┊        {\n+┊   ┊ 47┊          id: '3',\n+┊   ┊ 48┊          __typename: 'User',\n+┊   ┊ 49┊        },\n+┊   ┊ 50┊      ],\n+┊   ┊ 51┊      unreadMessages: 1,\n+┊   ┊ 52┊      isGroup: false,\n+┊   ┊ 53┊      messages: [\n+┊   ┊ 54┊        {\n+┊   ┊ 55┊          id: '1',\n+┊   ┊ 56┊          chat: {\n+┊   ┊ 57┊            id: '1',\n+┊   ┊ 58┊            __typename: 'Chat',\n+┊   ┊ 59┊          },\n+┊   ┊ 60┊          __typename: 'Message',\n+┊   ┊ 61┊          sender: {\n+┊   ┊ 62┊            id: '3',\n+┊   ┊ 63┊            __typename: 'User',\n+┊   ┊ 64┊            name: 'Avery Stewart',\n+┊   ┊ 65┊          },\n+┊   ┊ 66┊          content: 'Yep!',\n+┊   ┊ 67┊          createdAt: '1514035700',\n+┊   ┊ 68┊          type: 0,\n+┊   ┊ 69┊          recipients: [\n+┊   ┊ 70┊            {\n+┊   ┊ 71┊              user: {\n+┊   ┊ 72┊                id: '1',\n+┊   ┊ 73┊                __typename: 'User',\n+┊   ┊ 74┊              },\n+┊   ┊ 75┊              message: {\n+┊   ┊ 76┊                id: '1',\n+┊   ┊ 77┊                __typename: 'Message',\n+┊   ┊ 78┊                chat: {\n+┊   ┊ 79┊                  id: '1',\n+┊   ┊ 80┊                  __typename: 'Chat',\n+┊   ┊ 81┊                },\n+┊   ┊ 82┊              },\n+┊   ┊ 83┊              __typename: 'Recipient',\n+┊   ┊ 84┊              chat: {\n+┊   ┊ 85┊                id: '1',\n+┊   ┊ 86┊                __typename: 'Chat',\n+┊   ┊ 87┊              },\n+┊   ┊ 88┊              receivedAt: null,\n+┊   ┊ 89┊              readAt: null,\n+┊   ┊ 90┊            },\n+┊   ┊ 91┊          ],\n+┊   ┊ 92┊          ownership: false,\n+┊   ┊ 93┊        },\n+┊   ┊ 94┊      ],\n+┊   ┊ 95┊    },\n+┊   ┊ 96┊    {\n+┊   ┊ 97┊      id: '2',\n+┊   ┊ 98┊      __typename: 'Chat',\n+┊   ┊ 99┊      name: 'Katie Peterson',\n+┊   ┊100┊      picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n+┊   ┊101┊      allTimeMembers: [\n+┊   ┊102┊        {\n+┊   ┊103┊          id: '1',\n+┊   ┊104┊          __typename: 'User',\n+┊   ┊105┊        },\n+┊   ┊106┊        {\n+┊   ┊107┊          id: '4',\n+┊   ┊108┊          __typename: 'User',\n+┊   ┊109┊        },\n+┊   ┊110┊      ],\n+┊   ┊111┊      unreadMessages: 0,\n+┊   ┊112┊      isGroup: false,\n+┊   ┊113┊      messages: [\n+┊   ┊114┊        {\n+┊   ┊115┊          id: '1',\n+┊   ┊116┊          chat: {\n+┊   ┊117┊            id: '2',\n+┊   ┊118┊            __typename: 'Chat',\n+┊   ┊119┊          },\n+┊   ┊120┊          __typename: 'Message',\n+┊   ┊121┊          sender: {\n+┊   ┊122┊            id: '1',\n+┊   ┊123┊            __typename: 'User',\n+┊   ┊124┊            name: 'Ethan Gonzalez',\n+┊   ┊125┊          },\n+┊   ┊126┊          content: `Hey, it's me`,\n+┊   ┊127┊          createdAt: '1514031800',\n+┊   ┊128┊          type: 0,\n+┊   ┊129┊          recipients: [\n+┊   ┊130┊            {\n+┊   ┊131┊              user: {\n+┊   ┊132┊                id: '4',\n+┊   ┊133┊                __typename: 'User',\n+┊   ┊134┊              },\n+┊   ┊135┊              message: {\n+┊   ┊136┊                id: '1',\n+┊   ┊137┊                __typename: 'Message',\n+┊   ┊138┊                chat: {\n+┊   ┊139┊                  id: '2',\n+┊   ┊140┊                  __typename: 'Chat',\n+┊   ┊141┊                },\n+┊   ┊142┊              },\n+┊   ┊143┊              __typename: 'Recipient',\n+┊   ┊144┊              chat: {\n+┊   ┊145┊                id: '2',\n+┊   ┊146┊                __typename: 'Chat',\n+┊   ┊147┊              },\n+┊   ┊148┊              receivedAt: null,\n+┊   ┊149┊              readAt: null,\n+┊   ┊150┊            },\n+┊   ┊151┊          ],\n+┊   ┊152┊          ownership: true,\n+┊   ┊153┊        },\n+┊   ┊154┊      ],\n+┊   ┊155┊    },\n+┊   ┊156┊    {\n+┊   ┊157┊      id: '3',\n+┊   ┊158┊      __typename: 'Chat',\n+┊   ┊159┊      name: 'Ray Edwards',\n+┊   ┊160┊      picture: 'https://randomuser.me/api/portraits/thumb/men/3.jpg',\n+┊   ┊161┊      allTimeMembers: [\n+┊   ┊162┊        {\n+┊   ┊163┊          id: '1',\n+┊   ┊164┊          __typename: 'User',\n+┊   ┊165┊        },\n+┊   ┊166┊        {\n+┊   ┊167┊          id: '5',\n+┊   ┊168┊          __typename: 'User',\n+┊   ┊169┊        },\n+┊   ┊170┊      ],\n+┊   ┊171┊      unreadMessages: 0,\n+┊   ┊172┊      isGroup: false,\n+┊   ┊173┊      messages: [\n+┊   ┊174┊        {\n+┊   ┊175┊          id: '1',\n+┊   ┊176┊          __typename: 'Message',\n+┊   ┊177┊          chat: {\n+┊   ┊178┊            id: '3',\n+┊   ┊179┊            __typename: 'Chat',\n+┊   ┊180┊          },\n+┊   ┊181┊          sender: {\n+┊   ┊182┊            id: '1',\n+┊   ┊183┊            __typename: 'User',\n+┊   ┊184┊            name: 'Ethan Gonzalez',\n+┊   ┊185┊          },\n+┊   ┊186┊          content: 'You still there?',\n+┊   ┊187┊          createdAt: '1514010200',\n+┊   ┊188┊          type: 0,\n+┊   ┊189┊          recipients: [\n+┊   ┊190┊            {\n+┊   ┊191┊              user: {\n+┊   ┊192┊                id: '5',\n+┊   ┊193┊                __typename: 'User',\n+┊   ┊194┊              },\n+┊   ┊195┊              message: {\n+┊   ┊196┊                id: '1',\n+┊   ┊197┊                __typename: 'Message',\n+┊   ┊198┊                chat: {\n+┊   ┊199┊                  id: '3',\n+┊   ┊200┊                  __typename: 'Chat',\n+┊   ┊201┊                },\n+┊   ┊202┊              },\n+┊   ┊203┊              __typename: 'Recipient',\n+┊   ┊204┊              chat: {\n+┊   ┊205┊                id: '3',\n+┊   ┊206┊                __typename: 'Chat',\n+┊   ┊207┊              },\n+┊   ┊208┊              receivedAt: null,\n+┊   ┊209┊              readAt: null,\n+┊   ┊210┊            },\n+┊   ┊211┊          ],\n+┊   ┊212┊          ownership: true,\n+┊   ┊213┊        },\n+┊   ┊214┊      ],\n+┊   ┊215┊    },\n+┊   ┊216┊    {\n+┊   ┊217┊      id: '6',\n+┊   ┊218┊      __typename: 'Chat',\n+┊   ┊219┊      name: 'Niccolò Belli',\n+┊   ┊220┊      picture: 'https://randomuser.me/api/portraits/thumb/men/4.jpg',\n+┊   ┊221┊      allTimeMembers: [\n+┊   ┊222┊        {\n+┊   ┊223┊          id: '1',\n+┊   ┊224┊          __typename: 'User',\n+┊   ┊225┊        },\n+┊   ┊226┊        {\n+┊   ┊227┊          id: '6',\n+┊   ┊228┊          __typename: 'User',\n+┊   ┊229┊        },\n+┊   ┊230┊      ],\n+┊   ┊231┊      unreadMessages: 0,\n+┊   ┊232┊      messages: [],\n+┊   ┊233┊      isGroup: false,\n+┊   ┊234┊    },\n+┊   ┊235┊    {\n+┊   ┊236┊      id: '8',\n+┊   ┊237┊      __typename: 'Chat',\n+┊   ┊238┊      name: 'A user 0 group',\n+┊   ┊239┊      picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n+┊   ┊240┊      allTimeMembers: [\n+┊   ┊241┊        {\n+┊   ┊242┊          id: '1',\n+┊   ┊243┊          __typename: 'User',\n+┊   ┊244┊        },\n+┊   ┊245┊        {\n+┊   ┊246┊          id: '3',\n+┊   ┊247┊          __typename: 'User',\n+┊   ┊248┊        },\n+┊   ┊249┊        {\n+┊   ┊250┊          id: '4',\n+┊   ┊251┊          __typename: 'User',\n+┊   ┊252┊        },\n+┊   ┊253┊        {\n+┊   ┊254┊          id: '6',\n+┊   ┊255┊          __typename: 'User',\n+┊   ┊256┊        },\n+┊   ┊257┊      ],\n+┊   ┊258┊      unreadMessages: 1,\n+┊   ┊259┊      isGroup: true,\n+┊   ┊260┊      messages: [\n+┊   ┊261┊        {\n+┊   ┊262┊          id: '1',\n+┊   ┊263┊          __typename: 'Message',\n+┊   ┊264┊          chat: {\n+┊   ┊265┊            id: '8',\n+┊   ┊266┊            __typename: 'Chat',\n+┊   ┊267┊          },\n+┊   ┊268┊          sender: {\n+┊   ┊269┊            id: '4',\n+┊   ┊270┊            __typename: 'User',\n+┊   ┊271┊            name: 'Katie Peterson',\n+┊   ┊272┊          },\n+┊   ┊273┊          content: 'Awesome!',\n+┊   ┊274┊          createdAt: '1512830000',\n+┊   ┊275┊          type: 0,\n+┊   ┊276┊          recipients: [\n+┊   ┊277┊            {\n+┊   ┊278┊              user: {\n+┊   ┊279┊                id: '1',\n+┊   ┊280┊                __typename: 'User',\n+┊   ┊281┊              },\n+┊   ┊282┊              message: {\n+┊   ┊283┊                id: '1',\n+┊   ┊284┊                __typename: 'Message',\n+┊   ┊285┊                chat: {\n+┊   ┊286┊                  id: '8',\n+┊   ┊287┊                  __typename: 'Chat',\n+┊   ┊288┊                },\n+┊   ┊289┊              },\n+┊   ┊290┊              __typename: 'Recipient',\n+┊   ┊291┊              chat: {\n+┊   ┊292┊                id: '8',\n+┊   ┊293┊                __typename: 'Chat',\n+┊   ┊294┊              },\n+┊   ┊295┊              receivedAt: null,\n+┊   ┊296┊              readAt: null,\n+┊   ┊297┊            },\n+┊   ┊298┊            {\n+┊   ┊299┊              user: {\n+┊   ┊300┊                id: '6',\n+┊   ┊301┊                __typename: 'User',\n+┊   ┊302┊              },\n+┊   ┊303┊              message: {\n+┊   ┊304┊                id: '1',\n+┊   ┊305┊                __typename: 'Message',\n+┊   ┊306┊                chat: {\n+┊   ┊307┊                  id: '8',\n+┊   ┊308┊                  __typename: 'Chat',\n+┊   ┊309┊                },\n+┊   ┊310┊              },\n+┊   ┊311┊              __typename: 'Recipient',\n+┊   ┊312┊              chat: {\n+┊   ┊313┊                id: '8',\n+┊   ┊314┊                __typename: 'Chat',\n+┊   ┊315┊              },\n+┊   ┊316┊              receivedAt: null,\n+┊   ┊317┊              readAt: null,\n+┊   ┊318┊            },\n+┊   ┊319┊          ],\n+┊   ┊320┊          ownership: false,\n+┊   ┊321┊        },\n+┊   ┊322┊      ],\n+┊   ┊323┊    },\n+┊   ┊324┊  ];\n+┊   ┊325┊\n+┊   ┊326┊  beforeEach(async(() => {\n+┊   ┊327┊    TestBed.configureTestingModule({\n+┊   ┊328┊      declarations: [ChatsComponent, ChatsListComponent, ChatItemComponent],\n+┊   ┊329┊      imports: [\n+┊   ┊330┊        MatMenuModule,\n+┊   ┊331┊        MatIconModule,\n+┊   ┊332┊        MatButtonModule,\n+┊   ┊333┊        MatListModule,\n+┊   ┊334┊        TruncateModule,\n+┊   ┊335┊        ApolloTestingModule,\n+┊   ┊336┊        RouterTestingModule,\n+┊   ┊337┊      ],\n+┊   ┊338┊      providers: [\n+┊   ┊339┊        ChatsService,\n+┊   ┊340┊        {\n+┊   ┊341┊          provide: APOLLO_TESTING_CACHE,\n+┊   ┊342┊          useFactory() {\n+┊   ┊343┊            return new InMemoryCache({ dataIdFromObject });\n+┊   ┊344┊          },\n+┊   ┊345┊        },\n+┊   ┊346┊      ],\n+┊   ┊347┊      schemas: [NO_ERRORS_SCHEMA],\n+┊   ┊348┊    }).compileComponents();\n+┊   ┊349┊\n+┊   ┊350┊    controller = TestBed.get(ApolloTestingController);\n+┊   ┊351┊    apollo = TestBed.get(Apollo);\n+┊   ┊352┊  }));\n+┊   ┊353┊\n+┊   ┊354┊  beforeEach(() => {\n+┊   ┊355┊    fixture = TestBed.createComponent(ChatsComponent);\n+┊   ┊356┊    component = fixture.componentInstance;\n+┊   ┊357┊    fixture.detectChanges();\n+┊   ┊358┊\n+┊   ┊359┊    const req = controller.expectOne('GetChats', 'GetChats operation');\n+┊   ┊360┊\n+┊   ┊361┊    req.flush({\n+┊   ┊362┊      data: {\n+┊   ┊363┊        chats,\n+┊   ┊364┊      },\n+┊   ┊365┊    });\n+┊   ┊366┊  });\n+┊   ┊367┊\n+┊   ┊368┊  it('should create', () => {\n+┊   ┊369┊    expect(component).toBeTruthy();\n+┊   ┊370┊  });\n+┊   ┊371┊\n+┊   ┊372┊  it('should display the chats', () => {\n+┊   ┊373┊    fixture.whenStable().then(() => {\n+┊   ┊374┊      fixture.detectChanges();\n+┊   ┊375┊      el = fixture.debugElement;\n+┊   ┊376┊      for (let i = 0; i < chats.length; i++) {\n+┊   ┊377┊        expect(\n+┊   ┊378┊          el.query(\n+┊   ┊379┊            By.css(\n+┊   ┊380┊              `app-chats-list > mat-list > mat-list-item:nth-child(${i +\n+┊   ┊381┊                1}) > div > app-chat-item > div > div > div`,\n+┊   ┊382┊            ),\n+┊   ┊383┊          ).nativeElement.textContent,\n+┊   ┊384┊        ).toContain(chats[i].name);\n+┊   ┊385┊      }\n+┊   ┊386┊    });\n+┊   ┊387┊  });\n+┊   ┊388┊\n+┊   ┊389┊  afterAll(() => {\n+┊   ┊390┊    controller.verify();\n+┊   ┊391┊  });\n+┊   ┊392┊});\n```\n\n[}]: #"
          },
          {
            "manualTitle": "Step 8: Chat viewer",
            "stepRevision": "026cf4f16276d61fd0e962c466c76806bb4f397c",
            "manualView": "![chat](https://user-images.githubusercontent.com/7648874/49270290-92877e80-f4a3-11e8-8984-d3ee920838ed.png)\n\nAt this point we have a module which lists all of our chats, but we still need to show a particular chat.\nWe're going to implement in in this chapter.\n\n### ChatViewer module\n\nFirst, let's create a `ChatViewer` module:\n\n[{]: <helper> (diffStep \"4.1\" files=\"src/app/app.module.ts, src/app/chat-viewer/chat-viewer.module.ts\" module=\"client\")\n\n#### [Step 4.1: Chat Viewer](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/257159a)\n\n##### Changed src&#x2F;app&#x2F;app.module.ts\n```diff\n@@ -6,6 +6,7 @@\n ┊ 6┊ 6┊import { GraphQLModule } from './graphql.module';\n ┊ 7┊ 7┊import {ChatsListerModule} from './chats-lister/chats-lister.module';\n ┊ 8┊ 8┊import {RouterModule, Routes} from '@angular/router';\n+┊  ┊ 9┊import {ChatViewerModule} from './chat-viewer/chat-viewer.module';\n ┊ 9┊10┊const routes: Routes = [];\n ┊10┊11┊\n ┊11┊12┊@NgModule({\n```\n```diff\n@@ -20,6 +21,7 @@\n ┊20┊21┊    RouterModule.forRoot(routes),\n ┊21┊22┊    // Feature modules\n ┊22┊23┊    ChatsListerModule,\n+┊  ┊24┊    ChatViewerModule,\n ┊23┊25┊  ],\n ┊24┊26┊  providers: [],\n ┊25┊27┊  bootstrap: [AppComponent]\n```\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;chat-viewer.module.ts\n```diff\n@@ -0,0 +1,53 @@\n+┊  ┊ 1┊import { BrowserModule } from '@angular/platform-browser';\n+┊  ┊ 2┊import { NgModule } from '@angular/core';\n+┊  ┊ 3┊\n+┊  ┊ 4┊import {BrowserAnimationsModule} from '@angular/platform-browser/animations';\n+┊  ┊ 5┊import {MatButtonModule, MatGridListModule, MatIconModule, MatListModule, MatMenuModule, MatToolbarModule} from '@angular/material';\n+┊  ┊ 6┊import {RouterModule, Routes} from '@angular/router';\n+┊  ┊ 7┊import {FormsModule} from '@angular/forms';\n+┊  ┊ 8┊import {ChatsService} from '../services/chats.service';\n+┊  ┊ 9┊import {ChatComponent} from './containers/chat/chat.component';\n+┊  ┊10┊import {MessagesListComponent} from './components/messages-list/messages-list.component';\n+┊  ┊11┊import {MessageItemComponent} from './components/message-item/message-item.component';\n+┊  ┊12┊import {NewMessageComponent} from './components/new-message/new-message.component';\n+┊  ┊13┊import {SharedModule} from '../shared/shared.module';\n+┊  ┊14┊\n+┊  ┊15┊const routes: Routes = [\n+┊  ┊16┊  {\n+┊  ┊17┊    path: 'chat', children: [\n+┊  ┊18┊      {path: ':id', component: ChatComponent},\n+┊  ┊19┊    ],\n+┊  ┊20┊  },\n+┊  ┊21┊];\n+┊  ┊22┊\n+┊  ┊23┊@NgModule({\n+┊  ┊24┊  declarations: [\n+┊  ┊25┊    ChatComponent,\n+┊  ┊26┊    MessagesListComponent,\n+┊  ┊27┊    MessageItemComponent,\n+┊  ┊28┊    NewMessageComponent,\n+┊  ┊29┊  ],\n+┊  ┊30┊  imports: [\n+┊  ┊31┊    BrowserModule,\n+┊  ┊32┊    // Material\n+┊  ┊33┊    MatToolbarModule,\n+┊  ┊34┊    MatMenuModule,\n+┊  ┊35┊    MatIconModule,\n+┊  ┊36┊    MatButtonModule,\n+┊  ┊37┊    MatListModule,\n+┊  ┊38┊    MatGridListModule,\n+┊  ┊39┊    // Animations\n+┊  ┊40┊    BrowserAnimationsModule,\n+┊  ┊41┊    // Routing\n+┊  ┊42┊    RouterModule.forChild(routes),\n+┊  ┊43┊    // Forms\n+┊  ┊44┊    FormsModule,\n+┊  ┊45┊    // Feature modules\n+┊  ┊46┊    SharedModule,\n+┊  ┊47┊  ],\n+┊  ┊48┊  providers: [\n+┊  ┊49┊    ChatsService,\n+┊  ┊50┊  ],\n+┊  ┊51┊})\n+┊  ┊52┊export class ChatViewerModule {\n+┊  ┊53┊}\n```\n\n[}]: #\n\nAs you can see, it has already everything that we might need.\n\n### GetChat operation\n\nComponents need data, so we create the `GetChat` operation and run `yarn generator`:\n\n[{]: <helper> (diffStep \"4.1\" files=\"src/graphql/getChat.query.ts\" module=\"client\")\n\n#### [Step 4.1: Chat Viewer](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/257159a)\n\n##### Added src&#x2F;graphql&#x2F;getChat.query.ts\n```diff\n@@ -0,0 +1,17 @@\n+┊  ┊ 1┊import gql from 'graphql-tag';\n+┊  ┊ 2┊import {fragments} from './fragment';\n+┊  ┊ 3┊\n+┊  ┊ 4┊// We use the gql tag to parse our query string into a query document\n+┊  ┊ 5┊export const getChatQuery = gql`\n+┊  ┊ 6┊  query GetChat($chatId: ID!) {\n+┊  ┊ 7┊    chat(chatId: $chatId) {\n+┊  ┊ 8┊      ...ChatWithoutMessages\n+┊  ┊ 9┊      messages {\n+┊  ┊10┊        ...Message\n+┊  ┊11┊      }\n+┊  ┊12┊    }\n+┊  ┊13┊  }\n+┊  ┊14┊\n+┊  ┊15┊  ${fragments['chatWithoutMessages']}\n+┊  ┊16┊  ${fragments['message']}\n+┊  ┊17┊`;\n```\n\n[}]: #\n\nThe query can be now implemented in `ChatsService`:\n\n[{]: <helper> (diffStep \"4.1\" files=\"src/app/services/chats.service.ts\" module=\"client\")\n\n#### [Step 4.1: Chat Viewer](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/257159a)\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,13 +1,14 @@\n ┊ 1┊ 1┊import {map} from 'rxjs/operators';\n ┊ 2┊ 2┊import {Injectable} from '@angular/core';\n-┊ 3┊  ┊import {GetChatsGQL} from '../../graphql';\n+┊  ┊ 3┊import {GetChatsGQL, GetChatGQL} from '../../graphql';\n ┊ 4┊ 4┊\n ┊ 5┊ 5┊@Injectable()\n ┊ 6┊ 6┊export class ChatsService {\n ┊ 7┊ 7┊  messagesAmount = 3;\n ┊ 8┊ 8┊\n ┊ 9┊ 9┊  constructor(\n-┊10┊  ┊    private getChatsGQL: GetChatsGQL\n+┊  ┊10┊    private getChatsGQL: GetChatsGQL,\n+┊  ┊11┊    private getChatGQL: GetChatGQL\n ┊11┊12┊  ) {}\n ┊12┊13┊\n ┊13┊14┊  getChats() {\n```\n```diff\n@@ -20,4 +21,16 @@\n ┊20┊21┊\n ┊21┊22┊    return {query, chats$};\n ┊22┊23┊  }\n+┊  ┊24┊\n+┊  ┊25┊  getChat(chatId: string) {\n+┊  ┊26┊    const query = this.getChatGQL.watch({\n+┊  ┊27┊      chatId: chatId,\n+┊  ┊28┊    });\n+┊  ┊29┊\n+┊  ┊30┊    const chat$ = query.valueChanges.pipe(\n+┊  ┊31┊      map((result) => result.data.chat)\n+┊  ┊32┊    );\n+┊  ┊33┊\n+┊  ┊34┊    return {query, chat$};\n+┊  ┊35┊  }\n ┊23┊36┊}\n```\n\n[}]: #\n\nGreat!\n\n### Chat view\n\nNow we've got data but a user can't still access the chat view.\nThere is one place where we're able to pick the chat, it's the list:\n\n[{]: <helper> (diffStep \"4.1\" files=\"src/app/chats-lister/components/chat-item/chat-item.component.ts, src/app/chats-lister/components/chats-list/chats-list.component.ts, src/app/chats-lister/containers/chats/chats.component.ts\" module=\"client\")\n\n#### [Step 4.1: Chat Viewer](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/257159a)\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chat-item&#x2F;chat-item.component.ts\n```diff\n@@ -1,14 +1,14 @@\n-┊ 1┊  ┊import {Component, Input} from '@angular/core';\n+┊  ┊ 1┊import {Component, EventEmitter, Input, Output} from '@angular/core';\n ┊ 2┊ 2┊import {GetChats} from '../../../../graphql';\n ┊ 3┊ 3┊\n ┊ 4┊ 4┊@Component({\n ┊ 5┊ 5┊  selector: 'app-chat-item',\n ┊ 6┊ 6┊  template: `\n-┊ 7┊  ┊    <div class=\"chat-row\">\n+┊  ┊ 7┊    <div class=\"chat-row\" (click)=\"selectChat()\">\n ┊ 8┊ 8┊      <img class=\"chat-pic\" [src]=\"chat.picture || 'assets/default-profile-pic.jpg'\">\n ┊ 9┊ 9┊      <div class=\"chat-info\">\n ┊10┊10┊        <div class=\"chat-name\">{{ chat.name }}</div>\n-┊11┊  ┊        <div class=\"chat-last-message\">{{ chat.messages?[chat.messages?.length - 1]?.content }}</div>\n+┊  ┊11┊        <div class=\"chat-last-message\">{{ chat.messages[chat.messages.length - 1]?.content }}</div>\n ┊12┊12┊        <div class=\"chat-timestamp\">00:00</div>\n ┊13┊13┊      </div>\n ┊14┊14┊    </div>\n```\n```diff\n@@ -19,4 +19,11 @@\n ┊19┊19┊  // tslint:disable-next-line:no-input-rename\n ┊20┊20┊  @Input('item')\n ┊21┊21┊  chat: GetChats.Chats;\n+┊  ┊22┊\n+┊  ┊23┊  @Output()\n+┊  ┊24┊  select = new EventEmitter<string>();\n+┊  ┊25┊\n+┊  ┊26┊  selectChat() {\n+┊  ┊27┊    this.select.emit(this.chat.id);\n+┊  ┊28┊  }\n ┊22┊29┊}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chats-list&#x2F;chats-list.component.ts\n```diff\n@@ -1,4 +1,4 @@\n-┊1┊ ┊import {Component, Input} from '@angular/core';\n+┊ ┊1┊import {Component, EventEmitter, Input, Output} from '@angular/core';\n ┊2┊2┊import {GetChats} from '../../../../graphql';\n ┊3┊3┊\n ┊4┊4┊@Component({\n```\n```diff\n@@ -6,7 +6,7 @@\n ┊ 6┊ 6┊  template: `\n ┊ 7┊ 7┊    <mat-list>\n ┊ 8┊ 8┊      <mat-list-item *ngFor=\"let chat of chats\">\n-┊ 9┊  ┊        <app-chat-item [item]=\"chat\"></app-chat-item>\n+┊  ┊ 9┊        <app-chat-item [item]=\"chat\" (select)=\"selectChat($event)\"></app-chat-item>\n ┊10┊10┊      </mat-list-item>\n ┊11┊11┊    </mat-list>\n ┊12┊12┊  `,\n```\n```diff\n@@ -17,5 +17,12 @@\n ┊17┊17┊  @Input('items')\n ┊18┊18┊  chats: GetChats.Chats[];\n ┊19┊19┊\n+┊  ┊20┊  @Output()\n+┊  ┊21┊  select = new EventEmitter<string>();\n+┊  ┊22┊\n ┊20┊23┊  constructor() {}\n+┊  ┊24┊\n+┊  ┊25┊  selectChat(id: string) {\n+┊  ┊26┊    this.select.emit(id);\n+┊  ┊27┊  }\n ┊21┊28┊}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.ts\n```diff\n@@ -2,6 +2,7 @@\n ┊2┊2┊import {ChatsService} from '../../../services/chats.service';\n ┊3┊3┊import {Observable} from 'rxjs';\n ┊4┊4┊import {GetChats} from '../../../../graphql';\n+┊ ┊5┊import {Router} from '@angular/router';\n ┊5┊6┊\n ┊6┊7┊@Component({\n ┊7┊8┊  template: `\n```\n```diff\n@@ -27,7 +28,7 @@\n ┊27┊28┊      </button>\n ┊28┊29┊    </mat-menu>\n ┊29┊30┊\n-┊30┊  ┊    <app-chats-list [items]=\"chats$ | async\"></app-chats-list>\n+┊  ┊31┊    <app-chats-list [items]=\"chats$ | async\" (select)=\"goToChat($event)\"></app-chats-list>\n ┊31┊32┊\n ┊32┊33┊    <button class=\"chat-button\" mat-fab color=\"secondary\">\n ┊33┊34┊      <mat-icon aria-label=\"Icon-button with a + icon\">chat</mat-icon>\n```\n```diff\n@@ -38,10 +39,15 @@\n ┊38┊39┊export class ChatsComponent implements OnInit {\n ┊39┊40┊  chats$: Observable<GetChats.Chats[]>;\n ┊40┊41┊\n-┊41┊  ┊  constructor(private chatsService: ChatsService) {\n+┊  ┊42┊  constructor(private chatsService: ChatsService,\n+┊  ┊43┊              private router: Router) {\n ┊42┊44┊  }\n ┊43┊45┊\n ┊44┊46┊  ngOnInit() {\n ┊45┊47┊    this.chats$ = this.chatsService.getChats().chats$;\n ┊46┊48┊  }\n+┊  ┊49┊\n+┊  ┊50┊  goToChat(chatId: string) {\n+┊  ┊51┊    this.router.navigate(['/chat', chatId]);\n+┊  ┊52┊  }\n ┊47┊53┊}\n```\n\n[}]: #\n\nTime for a next step, an actual implementation of the chat view.\n\n[{]: <helper> (diffStep \"4.1\" files=\"src/app/chat-viewer/containers/chat/chat.component.ts, src/app/chat-viewer/containers/chat/chat.component.scss\" module=\"client\")\n\n#### [Step 4.1: Chat Viewer](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/257159a)\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.scss\n```diff\n@@ -0,0 +1,33 @@\n+┊  ┊ 1┊app-toolbar {\n+┊  ┊ 2┊  .navigation {\n+┊  ┊ 3┊    padding: 0;\n+┊  ┊ 4┊    display: inherit;\n+┊  ┊ 5┊    margin-right: -40px;\n+┊  ┊ 6┊  }\n+┊  ┊ 7┊\n+┊  ┊ 8┊  .title {\n+┊  ┊ 9┊    line-height: 8vh;\n+┊  ┊10┊  }\n+┊  ┊11┊\n+┊  ┊12┊  .profile-pic {\n+┊  ┊13┊    height: calc(100% - 10px);\n+┊  ┊14┊    width: auto;\n+┊  ┊15┊    padding: 5px;\n+┊  ┊16┊    border-radius: 50%;\n+┊  ┊17┊  }\n+┊  ┊18┊}\n+┊  ┊19┊\n+┊  ┊20┊.container {\n+┊  ┊21┊  display: flex;\n+┊  ┊22┊  flex-flow: column;\n+┊  ┊23┊  justify-content: space-between;\n+┊  ┊24┊  height: calc(100vh - 8vh);\n+┊  ┊25┊  background-image: url(/assets/chat-background.jpg);\n+┊  ┊26┊  background-color: #E0DAD6;\n+┊  ┊27┊  background-repeat: no-repeat;\n+┊  ┊28┊  background-size: cover;\n+┊  ┊29┊\n+┊  ┊30┊  app-confirm-selection {\n+┊  ┊31┊    bottom: 10vh;\n+┊  ┊32┊  }\n+┊  ┊33┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.ts\n```diff\n@@ -0,0 +1,46 @@\n+┊  ┊ 1┊import {Component, OnInit} from '@angular/core';\n+┊  ┊ 2┊import {ActivatedRoute, Router} from '@angular/router';\n+┊  ┊ 3┊import {ChatsService} from '../../../services/chats.service';\n+┊  ┊ 4┊\n+┊  ┊ 5┊@Component({\n+┊  ┊ 6┊  template: `\n+┊  ┊ 7┊    <app-toolbar>\n+┊  ┊ 8┊      <button class=\"navigation\" mat-button (click)=\"goToChats()\">\n+┊  ┊ 9┊        <mat-icon aria-label=\"Icon-button with an arrow back icon\">arrow_back</mat-icon>\n+┊  ┊10┊      </button>\n+┊  ┊11┊      <img class=\"profile-pic\" src=\"assets/default-profile-pic.jpg\">\n+┊  ┊12┊      <div class=\"title\">{{ name }}</div>\n+┊  ┊13┊    </app-toolbar>\n+┊  ┊14┊    <div class=\"container\">\n+┊  ┊15┊      <app-messages-list [items]=\"messages\" [isGroup]=\"isGroup\"></app-messages-list>\n+┊  ┊16┊      <app-new-message></app-new-message>\n+┊  ┊17┊    </div>\n+┊  ┊18┊  `,\n+┊  ┊19┊  styleUrls: ['./chat.component.scss']\n+┊  ┊20┊})\n+┊  ┊21┊export class ChatComponent implements OnInit {\n+┊  ┊22┊  chatId: string;\n+┊  ┊23┊  messages: any[];\n+┊  ┊24┊  name: string;\n+┊  ┊25┊  isGroup: boolean;\n+┊  ┊26┊\n+┊  ┊27┊  constructor(private route: ActivatedRoute,\n+┊  ┊28┊              private router: Router,\n+┊  ┊29┊              private chatsService: ChatsService) {\n+┊  ┊30┊  }\n+┊  ┊31┊\n+┊  ┊32┊  ngOnInit() {\n+┊  ┊33┊    this.route.params.subscribe(({id: chatId}) => {\n+┊  ┊34┊      this.chatId = chatId;\n+┊  ┊35┊      this.chatsService.getChat(chatId).chat$.subscribe(chat => {\n+┊  ┊36┊        this.messages = chat.messages;\n+┊  ┊37┊        this.name = chat.name;\n+┊  ┊38┊        this.isGroup = chat.isGroup;\n+┊  ┊39┊      });\n+┊  ┊40┊    });\n+┊  ┊41┊  }\n+┊  ┊42┊\n+┊  ┊43┊  goToChats() {\n+┊  ┊44┊    this.router.navigate(['/chats']);\n+┊  ┊45┊  }\n+┊  ┊46┊}\n```\n\n[}]: #\n\nThe `ChatComponent` component contains:\n\n - Toolbar with chat's name and a \"go back\" button\n - List of messages sorted from oldest to newest\n - Space to submit a new message\n\n### List of messages\n\nFirst we'll download and a couple of images which will help us create a \"bubble\" effect for received messages:\n\n    $ wget https://raw.githubusercontent.com/Urigo/whatsapp-client-angularcli-material/c75c2416b1990da3588015f76b8338764f44d6ec/src/assets/chat-background.jpg -P src/assets\n    $ wget https://raw.githubusercontent.com/Urigo/whatsapp-client-angularcli-material/https://raw.githubusercontent.com/Urigo/whatsapp-client-angularcli-material/c75c2416b1990da3588015f76b8338764f44d6ec/src/assets/chat-background.jpg/src/assets/message-mine.png -P src/assets\n    $ wget https://raw.githubusercontent.com/Urigo/whatsapp-client-angularcli-material/https://raw.githubusercontent.com/Urigo/whatsapp-client-angularcli-material/c75c2416b1990da3588015f76b8338764f44d6ec/src/assets/chat-background.jpg/src/assets/message-other.png -P src/assets\n\nWe'll now split the list of messages to the host:\n\n[{]: <helper> (diffStep \"4.1\" files=\"src/app/chat-viewer/components/messages-list/messages-list.component.ts, src/app/chat-viewer/components/messages-list/messages-list.component.scss\" module=\"client\")\n\n#### [Step 4.1: Chat Viewer](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/257159a)\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;components&#x2F;messages-list&#x2F;messages-list.component.scss\n```diff\n@@ -0,0 +1,14 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊  height: 100%;\n+┊  ┊ 4┊}\n+┊  ┊ 5┊\n+┊  ┊ 6┊::ng-deep .mat-list-item-content {\n+┊  ┊ 7┊  display: block !important;\n+┊  ┊ 8┊}\n+┊  ┊ 9┊\n+┊  ┊10┊/*\n+┊  ┊11┊:host::-webkit-scrollbar {\n+┊  ┊12┊  display: none;\n+┊  ┊13┊}\n+┊  ┊14┊*/🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;components&#x2F;messages-list&#x2F;messages-list.component.ts\n```diff\n@@ -0,0 +1,23 @@\n+┊  ┊ 1┊import {Component, Input} from '@angular/core';\n+┊  ┊ 2┊\n+┊  ┊ 3┊@Component({\n+┊  ┊ 4┊  selector: 'app-messages-list',\n+┊  ┊ 5┊  template: `\n+┊  ┊ 6┊    <mat-list>\n+┊  ┊ 7┊      <mat-list-item *ngFor=\"let message of messages\">\n+┊  ┊ 8┊        <app-message-item [item]=\"message\" [isGroup]=\"isGroup\"></app-message-item>\n+┊  ┊ 9┊      </mat-list-item>\n+┊  ┊10┊    </mat-list>\n+┊  ┊11┊  `,\n+┊  ┊12┊  styleUrls: ['messages-list.component.scss'],\n+┊  ┊13┊})\n+┊  ┊14┊export class MessagesListComponent {\n+┊  ┊15┊  // tslint:disable-next-line:no-input-rename\n+┊  ┊16┊  @Input('items')\n+┊  ┊17┊  messages: any[];\n+┊  ┊18┊\n+┊  ┊19┊  @Input()\n+┊  ┊20┊  isGroup: boolean;\n+┊  ┊21┊\n+┊  ┊22┊  constructor() {}\n+┊  ┊23┊}\n```\n\n[}]: #\n\nand a reused component for each message:\n\n[{]: <helper> (diffStep \"4.1\" files=\"src/app/chat-viewer/components/message-item/message-item.component.ts, src/app/chat-viewer/components/message-item/message-item.component.scss\" module=\"client\")\n\n#### [Step 4.1: Chat Viewer](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/257159a)\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;components&#x2F;message-item&#x2F;message-item.component.scss\n```diff\n@@ -0,0 +1,66 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  margin-bottom: 9px;\n+┊  ┊ 3┊\n+┊  ┊ 4┊  &::after {\n+┊  ┊ 5┊    content: \"\";\n+┊  ┊ 6┊    display: table;\n+┊  ┊ 7┊    clear: both;\n+┊  ┊ 8┊  }\n+┊  ┊ 9┊}\n+┊  ┊10┊\n+┊  ┊11┊.message {\n+┊  ┊12┊  display: inline-block;\n+┊  ┊13┊  position: relative;\n+┊  ┊14┊  max-width: 100%;\n+┊  ┊15┊  border-radius: 7px;\n+┊  ┊16┊  box-shadow: 0 1px 2px rgba(0, 0, 0, .15);\n+┊  ┊17┊\n+┊  ┊18┊  &.message-mine {\n+┊  ┊19┊    float: right;\n+┊  ┊20┊    background-color: #DCF8C6;\n+┊  ┊21┊\n+┊  ┊22┊    &::before {\n+┊  ┊23┊      right: -11px;\n+┊  ┊24┊      background-image: url(/assets/message-mine.png)\n+┊  ┊25┊    }\n+┊  ┊26┊  }\n+┊  ┊27┊\n+┊  ┊28┊  &.message-other {\n+┊  ┊29┊    float: left;\n+┊  ┊30┊    background-color: #FFF;\n+┊  ┊31┊\n+┊  ┊32┊    &::before {\n+┊  ┊33┊      left: -11px;\n+┊  ┊34┊      background-image: url(/assets/message-other.png)\n+┊  ┊35┊    }\n+┊  ┊36┊  }\n+┊  ┊37┊\n+┊  ┊38┊  &.message-other::before, &.message-mine::before {\n+┊  ┊39┊    content: \"\";\n+┊  ┊40┊    position: absolute;\n+┊  ┊41┊    bottom: 3px;\n+┊  ┊42┊    width: 12px;\n+┊  ┊43┊    height: 19px;\n+┊  ┊44┊    background-position: 50% 50%;\n+┊  ┊45┊    background-repeat: no-repeat;\n+┊  ┊46┊    background-size: contain;\n+┊  ┊47┊  }\n+┊  ┊48┊\n+┊  ┊49┊  .message-content {\n+┊  ┊50┊    padding: 5px 7px;\n+┊  ┊51┊    word-wrap: break-word;\n+┊  ┊52┊\n+┊  ┊53┊    &::after {\n+┊  ┊54┊      content: \" \\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\";\n+┊  ┊55┊      display: inline;\n+┊  ┊56┊    }\n+┊  ┊57┊  }\n+┊  ┊58┊\n+┊  ┊59┊  .message-timestamp {\n+┊  ┊60┊    position: absolute;\n+┊  ┊61┊    bottom: 2px;\n+┊  ┊62┊    right: 7px;\n+┊  ┊63┊    color: gray;\n+┊  ┊64┊    font-size: 12px;\n+┊  ┊65┊  }\n+┊  ┊66┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;components&#x2F;message-item&#x2F;message-item.component.ts\n```diff\n@@ -0,0 +1,22 @@\n+┊  ┊ 1┊import {Component, Input} from '@angular/core';\n+┊  ┊ 2┊\n+┊  ┊ 3┊@Component({\n+┊  ┊ 4┊  selector: 'app-message-item',\n+┊  ┊ 5┊  template: `\n+┊  ┊ 6┊    <div class=\"message\"\n+┊  ┊ 7┊         [ngClass]=\"message.ownership ? 'message-mine' : 'message-other'\">\n+┊  ┊ 8┊      <div *ngIf=\"isGroup && !message.ownership\" class=\"message-sender\">{{ message.sender.name }}</div>\n+┊  ┊ 9┊      <div class=\"message-content\">{{ message.content }}</div>\n+┊  ┊10┊      <span class=\"message-timestamp\">00:00</span>\n+┊  ┊11┊    </div>\n+┊  ┊12┊  `,\n+┊  ┊13┊  styleUrls: ['message-item.component.scss'],\n+┊  ┊14┊})\n+┊  ┊15┊export class MessageItemComponent {\n+┊  ┊16┊  // tslint:disable-next-line:no-input-rename\n+┊  ┊17┊  @Input('item')\n+┊  ┊18┊  message: any;\n+┊  ┊19┊\n+┊  ┊20┊  @Input()\n+┊  ┊21┊  isGroup: boolean;\n+┊  ┊22┊}\n```\n\n[}]: #\n\nAs you see, we could easily decide which message comes from which user based on the `ownership` property.\n\n### Submit a new message\n\nThe app shows the conversation and now we're going to focus on the last part, actually emitting a new message!\n\n[{]: <helper> (diffStep \"4.1\" files=\"src/app/chat-viewer/components/new-message/new-message.component.scss, src/app/chat-viewer/components/new-message/new-message.component.ts\" module=\"client\")\n\n#### [Step 4.1: Chat Viewer](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/257159a)\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;components&#x2F;new-message&#x2F;new-message.component.scss\n```diff\n@@ -0,0 +1,32 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: flex;\n+┊  ┊ 3┊  height: 50px;\n+┊  ┊ 4┊  padding: 5px;\n+┊  ┊ 5┊}\n+┊  ┊ 6┊\n+┊  ┊ 7┊input {\n+┊  ┊ 8┊  width: 100%;\n+┊  ┊ 9┊  border: none;\n+┊  ┊10┊  border-radius: 999px;\n+┊  ┊11┊  padding: 10px;\n+┊  ┊12┊  padding-left: 20px;\n+┊  ┊13┊  padding-right: 20px;\n+┊  ┊14┊  font-size: 15px;\n+┊  ┊15┊  outline: none;\n+┊  ┊16┊  box-shadow: 0 1px silver;\n+┊  ┊17┊  font-size: 18px;\n+┊  ┊18┊  line-height: 45px;\n+┊  ┊19┊}\n+┊  ┊20┊\n+┊  ┊21┊button {\n+┊  ┊22┊  min-width: 45px;\n+┊  ┊23┊  width: 45px;\n+┊  ┊24┊  border-radius: 999px;\n+┊  ┊25┊  background-color: var(--primary);\n+┊  ┊26┊  margin-left: 5px;\n+┊  ┊27┊  color: white;\n+┊  ┊28┊\n+┊  ┊29┊  mat-icon {\n+┊  ┊30┊    margin-left: -3px;\n+┊  ┊31┊  }\n+┊  ┊32┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;components&#x2F;new-message&#x2F;new-message.component.ts\n```diff\n@@ -0,0 +1,34 @@\n+┊  ┊ 1┊import {Component, EventEmitter, Input, Output} from '@angular/core';\n+┊  ┊ 2┊\n+┊  ┊ 3┊@Component({\n+┊  ┊ 4┊  selector: 'app-new-message',\n+┊  ┊ 5┊  template: `\n+┊  ┊ 6┊    <input type=\"text\" placeholder=\"Type a message\" [(ngModel)]=\"message\" (keyup)=\"onInputKeyup($event)\"/>\n+┊  ┊ 7┊    <button mat-button (click)=\"emitMessage()\" [disabled]=\"disabled\">\n+┊  ┊ 8┊      <mat-icon aria-label=\"Icon-button with a send icon\">send</mat-icon>\n+┊  ┊ 9┊    </button>\n+┊  ┊10┊  `,\n+┊  ┊11┊  styleUrls: ['new-message.component.scss'],\n+┊  ┊12┊})\n+┊  ┊13┊export class NewMessageComponent {\n+┊  ┊14┊  @Input()\n+┊  ┊15┊  disabled: boolean;\n+┊  ┊16┊\n+┊  ┊17┊  @Output()\n+┊  ┊18┊  newMessage = new EventEmitter<string>();\n+┊  ┊19┊\n+┊  ┊20┊  message = '';\n+┊  ┊21┊\n+┊  ┊22┊  onInputKeyup({ keyCode }: KeyboardEvent) {\n+┊  ┊23┊    if (keyCode === 13) {\n+┊  ┊24┊      this.emitMessage();\n+┊  ┊25┊    }\n+┊  ┊26┊  }\n+┊  ┊27┊\n+┊  ┊28┊  emitMessage() {\n+┊  ┊29┊    if (this.message && !this.disabled) {\n+┊  ┊30┊      this.newMessage.emit(this.message);\n+┊  ┊31┊      this.message = '';\n+┊  ┊32┊    }\n+┊  ┊33┊  }\n+┊  ┊34┊}\n```\n\n[}]: #\n\nIt's not yet fully functional, we receive the message in the `ChatComponent` but we still need to send it to the server. We'll cover that in next few steps!"
          },
          {
            "manualTitle": "Step 9: Mutations",
            "stepRevision": "fcbc9a30cfdd7004eabc050189a94dad094e2ed7",
            "manualView": "In addition to fetching data using queries, Apollo also helps you handle GraphQL mutations. In GraphQL, mutations are identical to queries in syntax, the only difference being that you use the keyword mutation instead of query to indicate that the root fields on this query are going to be performing writes to the backend.\nGraphQL mutations represent two things in one query string:\n\n1. The mutation field name with arguments, which represents the actual operation to be done on the server.\n2. The fields you want back from the result of the mutation to update the client.\n\nWhen we use mutations in Apollo, the result is typically integrated into the cache automatically based on the id of the result, which in turn updates the UI automatically, so we often don't need to explicitly handle the results. In order for the client to correctly do this, we need to ensure we select the necessary fields in the result. One good strategy can be to simply ask for any fields that might have been affected by the mutation. Alternatively, you can use fragments to share the fields between a query and a mutation that updates that query.\n\n## Server\n\nFinally we're going to create our mutations in the server:\n\n[{]: <helper> (diffStep \"3.1\" module=\"server\")\n\n#### [Step 3.1: Add mutations](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/db205b7)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,6 +1,7 @@\n ┊1┊1┊import { IResolvers } from 'apollo-server-express';\n-┊2┊ ┊import { Chat, db, Message, Recipient, User } from \"../db\";\n+┊ ┊2┊import { Chat, db, Message, MessageType, Recipient, User } from \"../db\";\n ┊3┊3┊import { ChatQueryArgs } from \"../types\";\n+┊ ┊4┊import * as moment from \"moment\";\n ┊4┊5┊\n ┊5┊6┊let users = db.users;\n ┊6┊7┊let chats = db.chats;\n```\n```diff\n@@ -13,6 +14,276 @@\n ┊ 13┊ 14┊    chats: (): Chat[] => chats.filter(chat => chat.listingMemberIds.includes(currentUser)),\n ┊ 14┊ 15┊    chat: (obj: any, {chatId}: ChatQueryArgs): Chat | null => chats.find(chat => chat.id === Number(chatId)) || null,\n ┊ 15┊ 16┊  },\n+┊   ┊ 17┊  Mutation: {\n+┊   ┊ 18┊    addChat: (obj: any, {recipientId}: any): Chat => {\n+┊   ┊ 19┊      if (!users.find(user => user.id === recipientId)) {\n+┊   ┊ 20┊        throw new Error(`Recipient ${recipientId} doesn't exist.`);\n+┊   ┊ 21┊      }\n+┊   ┊ 22┊\n+┊   ┊ 23┊      const chat = chats.find(chat => !chat.name && chat.allTimeMemberIds.includes(currentUser) && chat.allTimeMemberIds.includes(recipientId));\n+┊   ┊ 24┊      if (chat) {\n+┊   ┊ 25┊        // Chat already exists. Both users are already in the allTimeMemberIds array\n+┊   ┊ 26┊        const chatId = chat.id;\n+┊   ┊ 27┊        if (!chat.listingMemberIds.includes(currentUser)) {\n+┊   ┊ 28┊          // The chat isn't listed for the current user. Add him to the memberIds\n+┊   ┊ 29┊          chat.listingMemberIds.push(currentUser);\n+┊   ┊ 30┊          chats.find(chat => chat.id === chatId)!.listingMemberIds.push(currentUser);\n+┊   ┊ 31┊          return chat;\n+┊   ┊ 32┊        } else {\n+┊   ┊ 33┊          throw new Error(`Chat already exists.`);\n+┊   ┊ 34┊        }\n+┊   ┊ 35┊      } else {\n+┊   ┊ 36┊        // Create the chat\n+┊   ┊ 37┊        const id = (chats.length && chats[chats.length - 1].id + 1) || 1;\n+┊   ┊ 38┊        const chat: Chat = {\n+┊   ┊ 39┊          id,\n+┊   ┊ 40┊          name: null,\n+┊   ┊ 41┊          picture: null,\n+┊   ┊ 42┊          adminIds: null,\n+┊   ┊ 43┊          ownerId: null,\n+┊   ┊ 44┊          allTimeMemberIds: [currentUser, recipientId],\n+┊   ┊ 45┊          // Chat will not be listed to the other user until the first message gets written\n+┊   ┊ 46┊          listingMemberIds: [currentUser],\n+┊   ┊ 47┊          actualGroupMemberIds: null,\n+┊   ┊ 48┊          messages: [],\n+┊   ┊ 49┊        };\n+┊   ┊ 50┊        chats.push(chat);\n+┊   ┊ 51┊        return chat;\n+┊   ┊ 52┊      }\n+┊   ┊ 53┊    },\n+┊   ┊ 54┊    addGroup: (obj: any, {recipientIds, groupName}: any): Chat => {\n+┊   ┊ 55┊      recipientIds.forEach((recipientId: any) => {\n+┊   ┊ 56┊        if (!users.find(user => user.id === recipientId)) {\n+┊   ┊ 57┊          throw new Error(`Recipient ${recipientId} doesn't exist.`);\n+┊   ┊ 58┊        }\n+┊   ┊ 59┊      });\n+┊   ┊ 60┊\n+┊   ┊ 61┊      const id = (chats.length && chats[chats.length - 1].id + 1) || 1;\n+┊   ┊ 62┊      const chat: Chat = {\n+┊   ┊ 63┊        id,\n+┊   ┊ 64┊        name: groupName,\n+┊   ┊ 65┊        picture: null,\n+┊   ┊ 66┊        adminIds: [currentUser],\n+┊   ┊ 67┊        ownerId: currentUser,\n+┊   ┊ 68┊        allTimeMemberIds: [currentUser, ...recipientIds],\n+┊   ┊ 69┊        listingMemberIds: [currentUser, ...recipientIds],\n+┊   ┊ 70┊        actualGroupMemberIds: [currentUser, ...recipientIds],\n+┊   ┊ 71┊        messages: [],\n+┊   ┊ 72┊      };\n+┊   ┊ 73┊      chats.push(chat);\n+┊   ┊ 74┊      return chat;\n+┊   ┊ 75┊    },\n+┊   ┊ 76┊    removeChat: (obj: any, {chatId}: any): number => {\n+┊   ┊ 77┊      const chat = chats.find(chat => chat.id === chatId);\n+┊   ┊ 78┊\n+┊   ┊ 79┊      if (!chat) {\n+┊   ┊ 80┊        throw new Error(`The chat ${chatId} doesn't exist.`);\n+┊   ┊ 81┊      }\n+┊   ┊ 82┊\n+┊   ┊ 83┊      if (!chat.name) {\n+┊   ┊ 84┊        // Chat\n+┊   ┊ 85┊        if (!chat.listingMemberIds.includes(currentUser)) {\n+┊   ┊ 86┊          throw new Error(`The user is not a member of the chat ${chatId}.`);\n+┊   ┊ 87┊        }\n+┊   ┊ 88┊\n+┊   ┊ 89┊        // Instead of chaining map and filter we can loop once using reduce\n+┊   ┊ 90┊        const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n+┊   ┊ 91┊          // Remove the current user from the message holders\n+┊   ┊ 92┊          message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser);\n+┊   ┊ 93┊\n+┊   ┊ 94┊          if (message.holderIds.length !== 0) {\n+┊   ┊ 95┊            filtered.push(message);\n+┊   ┊ 96┊          } // else discard the message\n+┊   ┊ 97┊\n+┊   ┊ 98┊          return filtered;\n+┊   ┊ 99┊        }, []);\n+┊   ┊100┊\n+┊   ┊101┊        // Remove the current user from who gets the chat listed. The chat will no longer appear in his list\n+┊   ┊102┊        const listingMemberIds = chat.listingMemberIds.filter(listingId => listingId !== currentUser);\n+┊   ┊103┊\n+┊   ┊104┊        // Check how many members are left\n+┊   ┊105┊        if (listingMemberIds.length === 0) {\n+┊   ┊106┊          // Delete the chat\n+┊   ┊107┊          chats = chats.filter(chat => chat.id !== chatId);\n+┊   ┊108┊        } else {\n+┊   ┊109┊          // Update the chat\n+┊   ┊110┊          chats = chats.map(chat => {\n+┊   ┊111┊            if (chat.id === chatId) {\n+┊   ┊112┊              chat = {...chat, listingMemberIds, messages};\n+┊   ┊113┊            }\n+┊   ┊114┊            return chat;\n+┊   ┊115┊          });\n+┊   ┊116┊        }\n+┊   ┊117┊        return chatId;\n+┊   ┊118┊      } else {\n+┊   ┊119┊        // Group\n+┊   ┊120┊        if (chat.ownerId !== currentUser) {\n+┊   ┊121┊          throw new Error(`Group ${chatId} is not owned by the user.`);\n+┊   ┊122┊        }\n+┊   ┊123┊\n+┊   ┊124┊        // Instead of chaining map and filter we can loop once using reduce\n+┊   ┊125┊        const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n+┊   ┊126┊          // Remove the current user from the message holders\n+┊   ┊127┊          message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser);\n+┊   ┊128┊\n+┊   ┊129┊          if (message.holderIds.length !== 0) {\n+┊   ┊130┊            filtered.push(message);\n+┊   ┊131┊          } // else discard the message\n+┊   ┊132┊\n+┊   ┊133┊          return filtered;\n+┊   ┊134┊        }, []);\n+┊   ┊135┊\n+┊   ┊136┊        // Remove the current user from who gets the group listed. The group will no longer appear in his list\n+┊   ┊137┊        const listingMemberIds = chat.listingMemberIds.filter(listingId => listingId !== currentUser);\n+┊   ┊138┊\n+┊   ┊139┊        // Check how many members (including previous ones who can still access old messages) are left\n+┊   ┊140┊        if (listingMemberIds.length === 0) {\n+┊   ┊141┊          // Remove the group\n+┊   ┊142┊          chats = chats.filter(chat => chat.id !== chatId);\n+┊   ┊143┊        } else {\n+┊   ┊144┊          // Update the group\n+┊   ┊145┊\n+┊   ┊146┊          // Remove the current user from the chat members. He is no longer a member of the group\n+┊   ┊147┊          const actualGroupMemberIds = chat.actualGroupMemberIds!.filter(memberId => memberId !== currentUser);\n+┊   ┊148┊          // Remove the current user from the chat admins\n+┊   ┊149┊          const adminIds = chat.adminIds!.filter(memberId => memberId !== currentUser);\n+┊   ┊150┊          // Set the owner id to be null. A null owner means the group is read-only\n+┊   ┊151┊          let ownerId: number | null = null;\n+┊   ┊152┊\n+┊   ┊153┊          // Check if there is any admin left\n+┊   ┊154┊          if (adminIds!.length) {\n+┊   ┊155┊            // Pick an admin as the new owner. The group is no longer read-only\n+┊   ┊156┊            ownerId = chat.adminIds![0];\n+┊   ┊157┊          }\n+┊   ┊158┊\n+┊   ┊159┊          chats = chats.map(chat => {\n+┊   ┊160┊            if (chat.id === chatId) {\n+┊   ┊161┊              chat = {...chat, messages, listingMemberIds, actualGroupMemberIds, adminIds, ownerId};\n+┊   ┊162┊            }\n+┊   ┊163┊            return chat;\n+┊   ┊164┊          });\n+┊   ┊165┊        }\n+┊   ┊166┊        return chatId;\n+┊   ┊167┊      }\n+┊   ┊168┊    },\n+┊   ┊169┊    addMessage: (obj: any, {chatId, content}: any): Message => {\n+┊   ┊170┊      if (content === null || content === '') {\n+┊   ┊171┊        throw new Error(`Cannot add empty or null messages.`);\n+┊   ┊172┊      }\n+┊   ┊173┊\n+┊   ┊174┊      let chat = chats.find(chat => chat.id === chatId);\n+┊   ┊175┊\n+┊   ┊176┊      if (!chat) {\n+┊   ┊177┊        throw new Error(`Cannot find chat ${chatId}.`);\n+┊   ┊178┊      }\n+┊   ┊179┊\n+┊   ┊180┊      let holderIds = chat.listingMemberIds;\n+┊   ┊181┊\n+┊   ┊182┊      if (!chat.name) {\n+┊   ┊183┊        // Chat\n+┊   ┊184┊        if (!chat.listingMemberIds.find(listingId => listingId === currentUser)) {\n+┊   ┊185┊          throw new Error(`The chat ${chatId} must be listed for the current user before adding a message.`);\n+┊   ┊186┊        }\n+┊   ┊187┊\n+┊   ┊188┊        const recipientId = chat.allTimeMemberIds.filter(userId => userId !== currentUser)[0];\n+┊   ┊189┊\n+┊   ┊190┊        if (!chat.listingMemberIds.find(listingId => listingId === recipientId)) {\n+┊   ┊191┊          // Chat is not listed for the recipient. Add him to the listingMemberIds\n+┊   ┊192┊          const listingMemberIds = chat.listingMemberIds.concat(recipientId);\n+┊   ┊193┊\n+┊   ┊194┊          chats = chats.map(chat => {\n+┊   ┊195┊            if (chat.id === chatId) {\n+┊   ┊196┊              chat = {...chat, listingMemberIds};\n+┊   ┊197┊            }\n+┊   ┊198┊            return chat;\n+┊   ┊199┊          });\n+┊   ┊200┊\n+┊   ┊201┊          holderIds = listingMemberIds;\n+┊   ┊202┊        }\n+┊   ┊203┊      } else {\n+┊   ┊204┊        // Group\n+┊   ┊205┊        if (!chat.actualGroupMemberIds!.find(memberId => memberId === currentUser)) {\n+┊   ┊206┊          throw new Error(`The user is not a member of the group ${chatId}. Cannot add message.`);\n+┊   ┊207┊        }\n+┊   ┊208┊\n+┊   ┊209┊        holderIds = chat.actualGroupMemberIds!;\n+┊   ┊210┊      }\n+┊   ┊211┊\n+┊   ┊212┊      const id = (chat.messages.length && chat.messages[chat.messages.length - 1].id + 1) || 1;\n+┊   ┊213┊\n+┊   ┊214┊      let recipients: Recipient[] = [];\n+┊   ┊215┊\n+┊   ┊216┊      holderIds.forEach(holderId => {\n+┊   ┊217┊        if (holderId !== currentUser) {\n+┊   ┊218┊          recipients.push({\n+┊   ┊219┊            userId: holderId,\n+┊   ┊220┊            messageId: id,\n+┊   ┊221┊            chatId: chatId,\n+┊   ┊222┊            receivedAt: null,\n+┊   ┊223┊            readAt: null,\n+┊   ┊224┊          });\n+┊   ┊225┊        }\n+┊   ┊226┊      });\n+┊   ┊227┊\n+┊   ┊228┊      const message: Message = {\n+┊   ┊229┊        id,\n+┊   ┊230┊        chatId,\n+┊   ┊231┊        senderId: currentUser,\n+┊   ┊232┊        content,\n+┊   ┊233┊        createdAt: moment().unix(),\n+┊   ┊234┊        type: MessageType.TEXT,\n+┊   ┊235┊        recipients,\n+┊   ┊236┊        holderIds,\n+┊   ┊237┊      };\n+┊   ┊238┊\n+┊   ┊239┊      chats = chats.map(chat => {\n+┊   ┊240┊        if (chat.id === chatId) {\n+┊   ┊241┊          chat = {...chat, messages: chat.messages.concat(message)}\n+┊   ┊242┊        }\n+┊   ┊243┊        return chat;\n+┊   ┊244┊      });\n+┊   ┊245┊\n+┊   ┊246┊      return message;\n+┊   ┊247┊    },\n+┊   ┊248┊    removeMessages: (obj: any, {chatId, messageIds, all}: any): number[] => {\n+┊   ┊249┊      const chat = chats.find(chat => chat.id === chatId);\n+┊   ┊250┊\n+┊   ┊251┊      if (!chat) {\n+┊   ┊252┊        throw new Error(`Cannot find chat ${chatId}.`);\n+┊   ┊253┊      }\n+┊   ┊254┊\n+┊   ┊255┊      if (!chat.listingMemberIds.find(listingId => listingId === currentUser)) {\n+┊   ┊256┊        throw new Error(`The chat/group ${chatId} is not listed for the current user, so there is nothing to delete.`);\n+┊   ┊257┊      }\n+┊   ┊258┊\n+┊   ┊259┊      if (all && messageIds) {\n+┊   ┊260┊        throw new Error(`Cannot specify both 'all' and 'messageIds'.`);\n+┊   ┊261┊      }\n+┊   ┊262┊\n+┊   ┊263┊      let deletedIds: number[] = [];\n+┊   ┊264┊      chats = chats.map(chat => {\n+┊   ┊265┊        if (chat.id === chatId) {\n+┊   ┊266┊          // Instead of chaining map and filter we can loop once using reduce\n+┊   ┊267┊          const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n+┊   ┊268┊            if (all || messageIds!.includes(message.id)) {\n+┊   ┊269┊              deletedIds.push(message.id);\n+┊   ┊270┊              // Remove the current user from the message holders\n+┊   ┊271┊              message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser);\n+┊   ┊272┊            }\n+┊   ┊273┊\n+┊   ┊274┊            if (message.holderIds.length !== 0) {\n+┊   ┊275┊              filtered.push(message);\n+┊   ┊276┊            } // else discard the message\n+┊   ┊277┊\n+┊   ┊278┊            return filtered;\n+┊   ┊279┊          }, []);\n+┊   ┊280┊          chat = {...chat, messages};\n+┊   ┊281┊        }\n+┊   ┊282┊        return chat;\n+┊   ┊283┊      });\n+┊   ┊284┊      return deletedIds;\n+┊   ┊285┊    },\n+┊   ┊286┊  },\n ┊ 16┊287┊  Chat: {\n ┊ 17┊288┊    name: (chat: Chat): string => chat.name ? chat.name : users\n ┊ 18┊289┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser))!.name,\n```\n\n##### Changed schema&#x2F;typeDefs.ts\n```diff\n@@ -65,4 +65,20 @@\n ┊65┊65┊    picture: String\n ┊66┊66┊    phone: String\n ┊67┊67┊  }\n+┊  ┊68┊\n+┊  ┊69┊  type Mutation {\n+┊  ┊70┊    addChat(recipientId: ID!): Chat\n+┊  ┊71┊    addGroup(recipientIds: [ID!]!, groupName: String!): Chat\n+┊  ┊72┊    removeChat(chatId: ID!): ID\n+┊  ┊73┊    addMessage(chatId: ID!, content: String!): Message\n+┊  ┊74┊    removeMessages(chatId: ID!, messageIds: [ID], all: Boolean): [ID]\n+┊  ┊75┊    addMembers(groupId: ID!, userIds: [ID!]!): [ID]\n+┊  ┊76┊    removeMembers(groupId: ID!, userIds: [ID!]!): [ID]\n+┊  ┊77┊    addAdmins(groupId: ID!, userIds: [ID!]!): [ID]\n+┊  ┊78┊    removeAdmins(groupId: ID!, userIds: [ID!]!): [ID]\n+┊  ┊79┊    setGroupName(groupId: ID!): String\n+┊  ┊80┊    setGroupPicture(groupId: ID!): String\n+┊  ┊81┊    markAsReceived(chatId: ID!): Boolean\n+┊  ┊82┊    markAsRead(chatId: ID!): Boolean\n+┊  ┊83┊  }\n ┊68┊84┊`;\n```\n\n[}]: #\n\nLet me briefly explain what's going on here.\nFor each chat/group we store the `allTimeMemberIds`, `listingMemberIds` and `actualGroupMemberIds` properties in our NoSQL-like fake db.\nWhat's the difference between `allTimeMemberIds` and `listingMemberIds`? When a chat gets created only the user who created it will be able too see it, the chat will be displayed to the other user only once the first messaged gets sent. `allTimeMemberIds` is an array which always contain both the users, while `listingMemberIds` contains only the users which get the chat listed (initially the creator, later both users). `actualGroupMemberIds` is only used for groups.\nGroups, instead, get listed by all members immediately since the creation. So initially both `allTimeMemberIds`, `listingMemberIds` and `actualGroupMemberIds` are similar. Later users can leave the group or get deleted (so they will be removed from `actualGroupMemberIds`) but they will still be able to list the group in read-only mode, thus remaining in the `listingMemberIds`. Once they remove the group they will also be remove from the `listingMemberIds` array.\nThat's why we have to check for several different conditions before adding/deleting messages: it could be necessary to add the other peer to the `listingMemberIds` (for example if we are writing the first message of a chat) or it could be necessary to physically remove the messages instead of simply removing the current user from the `holderIds`. `holderIds` is a field in each message which states which user will currently display that specific message. In fact each user can delete a specific message without affecting what the others will see. Once there will be no more users in the `holderIds` array it will be safe to delete the message.\nEach message has also a `recipients` array containing the receiving date and the viewing date of that particular message for all the other users. That's necessary to implement the single, double and blue ticks used by the real Whatsapp.\n\nIt may seem a bit overwhelming at first, but you should keep in mind that the real Whatsapp has tons of features and also takes advantage of a local database to store messages, so it's easier for them to implement features like per-user messages: their source of truth is not the server because once downloaded the messages are kept in the client itself, so deleting messages doesn't affect anyone else. On the contrary our source of truth is the server, so our approach is more similar to Telegram instead. This is a better approach in my opinion because it allows us to show the messages for the same user on multiple clients, instead of having to rely on questionable approaches like Whatsapp Web.\nAlso we already implemented our mutations to take care of future use cases (like reading notifications) which we still didn't implement.\n\nI said we were going to take greater advantage of `graphql-code-generator` once we started writing our first mutation and I'm going to show you why. Let's run the generator first:\n\n    yarn generator\n\nThen let's use the generated types:\n\n[{]: <helper> (diffStep \"3.3\" module=\"server\")\n\n#### [Step 3.3: Use generated types](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/b7b1be3)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,6 +1,9 @@\n ┊1┊1┊import { IResolvers } from 'apollo-server-express';\n ┊2┊2┊import { Chat, db, Message, MessageType, Recipient, User } from \"../db\";\n-┊3┊ ┊import { ChatQueryArgs } from \"../types\";\n+┊ ┊3┊import {\n+┊ ┊4┊  AddChatMutationArgs, AddGroupMutationArgs, AddMessageMutationArgs, ChatQueryArgs,\n+┊ ┊5┊  RemoveChatMutationArgs, RemoveMessagesMutationArgs\n+┊ ┊6┊} from \"../types\";\n ┊4┊7┊import * as moment from \"moment\";\n ┊5┊8┊\n ┊6┊9┊let users = db.users;\n```\n```diff\n@@ -15,12 +18,12 @@\n ┊15┊18┊    chat: (obj: any, {chatId}: ChatQueryArgs): Chat | null => chats.find(chat => chat.id === Number(chatId)) || null,\n ┊16┊19┊  },\n ┊17┊20┊  Mutation: {\n-┊18┊  ┊    addChat: (obj: any, {recipientId}: any): Chat => {\n-┊19┊  ┊      if (!users.find(user => user.id === recipientId)) {\n+┊  ┊21┊    addChat: (obj: any, {recipientId}: AddChatMutationArgs): Chat => {\n+┊  ┊22┊      if (!users.find(user => user.id === Number(recipientId))) {\n ┊20┊23┊        throw new Error(`Recipient ${recipientId} doesn't exist.`);\n ┊21┊24┊      }\n ┊22┊25┊\n-┊23┊  ┊      const chat = chats.find(chat => !chat.name && chat.allTimeMemberIds.includes(currentUser) && chat.allTimeMemberIds.includes(recipientId));\n+┊  ┊26┊      const chat = chats.find(chat => !chat.name && chat.allTimeMemberIds.includes(currentUser) && chat.allTimeMemberIds.includes(Number(recipientId)));\n ┊24┊27┊      if (chat) {\n ┊25┊28┊        // Chat already exists. Both users are already in the allTimeMemberIds array\n ┊26┊29┊        const chatId = chat.id;\n```\n```diff\n@@ -41,7 +44,7 @@\n ┊41┊44┊          picture: null,\n ┊42┊45┊          adminIds: null,\n ┊43┊46┊          ownerId: null,\n-┊44┊  ┊          allTimeMemberIds: [currentUser, recipientId],\n+┊  ┊47┊          allTimeMemberIds: [currentUser, Number(recipientId)],\n ┊45┊48┊          // Chat will not be listed to the other user until the first message gets written\n ┊46┊49┊          listingMemberIds: [currentUser],\n ┊47┊50┊          actualGroupMemberIds: null,\n```\n```diff\n@@ -51,9 +54,9 @@\n ┊51┊54┊        return chat;\n ┊52┊55┊      }\n ┊53┊56┊    },\n-┊54┊  ┊    addGroup: (obj: any, {recipientIds, groupName}: any): Chat => {\n-┊55┊  ┊      recipientIds.forEach((recipientId: any) => {\n-┊56┊  ┊        if (!users.find(user => user.id === recipientId)) {\n+┊  ┊57┊    addGroup: (obj: any, {recipientIds, groupName}: AddGroupMutationArgs): Chat => {\n+┊  ┊58┊      recipientIds.forEach(recipientId => {\n+┊  ┊59┊        if (!users.find(user => user.id === Number(recipientId))) {\n ┊57┊60┊          throw new Error(`Recipient ${recipientId} doesn't exist.`);\n ┊58┊61┊        }\n ┊59┊62┊      });\n```\n```diff\n@@ -65,16 +68,16 @@\n ┊65┊68┊        picture: null,\n ┊66┊69┊        adminIds: [currentUser],\n ┊67┊70┊        ownerId: currentUser,\n-┊68┊  ┊        allTimeMemberIds: [currentUser, ...recipientIds],\n-┊69┊  ┊        listingMemberIds: [currentUser, ...recipientIds],\n-┊70┊  ┊        actualGroupMemberIds: [currentUser, ...recipientIds],\n+┊  ┊71┊        allTimeMemberIds: [currentUser, ...recipientIds.map(id => Number(id))],\n+┊  ┊72┊        listingMemberIds: [currentUser, ...recipientIds.map(id => Number(id))],\n+┊  ┊73┊        actualGroupMemberIds: [currentUser, ...recipientIds.map(id => Number(id))],\n ┊71┊74┊        messages: [],\n ┊72┊75┊      };\n ┊73┊76┊      chats.push(chat);\n ┊74┊77┊      return chat;\n ┊75┊78┊    },\n-┊76┊  ┊    removeChat: (obj: any, {chatId}: any): number => {\n-┊77┊  ┊      const chat = chats.find(chat => chat.id === chatId);\n+┊  ┊79┊    removeChat: (obj: any, {chatId}: RemoveChatMutationArgs): number => {\n+┊  ┊80┊      const chat = chats.find(chat => chat.id === Number(chatId));\n ┊78┊81┊\n ┊79┊82┊      if (!chat) {\n ┊80┊83┊        throw new Error(`The chat ${chatId} doesn't exist.`);\n```\n```diff\n@@ -104,17 +107,17 @@\n ┊104┊107┊        // Check how many members are left\n ┊105┊108┊        if (listingMemberIds.length === 0) {\n ┊106┊109┊          // Delete the chat\n-┊107┊   ┊          chats = chats.filter(chat => chat.id !== chatId);\n+┊   ┊110┊          chats = chats.filter(chat => chat.id !== Number(chatId));\n ┊108┊111┊        } else {\n ┊109┊112┊          // Update the chat\n ┊110┊113┊          chats = chats.map(chat => {\n-┊111┊   ┊            if (chat.id === chatId) {\n+┊   ┊114┊            if (chat.id === Number(chatId)) {\n ┊112┊115┊              chat = {...chat, listingMemberIds, messages};\n ┊113┊116┊            }\n ┊114┊117┊            return chat;\n ┊115┊118┊          });\n ┊116┊119┊        }\n-┊117┊   ┊        return chatId;\n+┊   ┊120┊        return Number(chatId);\n ┊118┊121┊      } else {\n ┊119┊122┊        // Group\n ┊120┊123┊        if (chat.ownerId !== currentUser) {\n```\n```diff\n@@ -139,7 +142,7 @@\n ┊139┊142┊        // Check how many members (including previous ones who can still access old messages) are left\n ┊140┊143┊        if (listingMemberIds.length === 0) {\n ┊141┊144┊          // Remove the group\n-┊142┊   ┊          chats = chats.filter(chat => chat.id !== chatId);\n+┊   ┊145┊          chats = chats.filter(chat => chat.id !== Number(chatId));\n ┊143┊146┊        } else {\n ┊144┊147┊          // Update the group\n ┊145┊148┊\n```\n```diff\n@@ -157,21 +160,21 @@\n ┊157┊160┊          }\n ┊158┊161┊\n ┊159┊162┊          chats = chats.map(chat => {\n-┊160┊   ┊            if (chat.id === chatId) {\n+┊   ┊163┊            if (chat.id === Number(chatId)) {\n ┊161┊164┊              chat = {...chat, messages, listingMemberIds, actualGroupMemberIds, adminIds, ownerId};\n ┊162┊165┊            }\n ┊163┊166┊            return chat;\n ┊164┊167┊          });\n ┊165┊168┊        }\n-┊166┊   ┊        return chatId;\n+┊   ┊169┊        return Number(chatId);\n ┊167┊170┊      }\n ┊168┊171┊    },\n-┊169┊   ┊    addMessage: (obj: any, {chatId, content}: any): Message => {\n+┊   ┊172┊    addMessage: (obj: any, {chatId, content}: AddMessageMutationArgs): Message => {\n ┊170┊173┊      if (content === null || content === '') {\n ┊171┊174┊        throw new Error(`Cannot add empty or null messages.`);\n ┊172┊175┊      }\n ┊173┊176┊\n-┊174┊   ┊      let chat = chats.find(chat => chat.id === chatId);\n+┊   ┊177┊      let chat = chats.find(chat => chat.id === Number(chatId));\n ┊175┊178┊\n ┊176┊179┊      if (!chat) {\n ┊177┊180┊        throw new Error(`Cannot find chat ${chatId}.`);\n```\n```diff\n@@ -192,7 +195,7 @@\n ┊192┊195┊          const listingMemberIds = chat.listingMemberIds.concat(recipientId);\n ┊193┊196┊\n ┊194┊197┊          chats = chats.map(chat => {\n-┊195┊   ┊            if (chat.id === chatId) {\n+┊   ┊198┊            if (chat.id === Number(chatId)) {\n ┊196┊199┊              chat = {...chat, listingMemberIds};\n ┊197┊200┊            }\n ┊198┊201┊            return chat;\n```\n```diff\n@@ -218,7 +221,7 @@\n ┊218┊221┊          recipients.push({\n ┊219┊222┊            userId: holderId,\n ┊220┊223┊            messageId: id,\n-┊221┊   ┊            chatId: chatId,\n+┊   ┊224┊            chatId: Number(chatId),\n ┊222┊225┊            receivedAt: null,\n ┊223┊226┊            readAt: null,\n ┊224┊227┊          });\n```\n```diff\n@@ -227,7 +230,7 @@\n ┊227┊230┊\n ┊228┊231┊      const message: Message = {\n ┊229┊232┊        id,\n-┊230┊   ┊        chatId,\n+┊   ┊233┊        chatId: Number(chatId),\n ┊231┊234┊        senderId: currentUser,\n ┊232┊235┊        content,\n ┊233┊236┊        createdAt: moment().unix(),\n```\n```diff\n@@ -237,7 +240,7 @@\n ┊237┊240┊      };\n ┊238┊241┊\n ┊239┊242┊      chats = chats.map(chat => {\n-┊240┊   ┊        if (chat.id === chatId) {\n+┊   ┊243┊        if (chat.id === Number(chatId)) {\n ┊241┊244┊          chat = {...chat, messages: chat.messages.concat(message)}\n ┊242┊245┊        }\n ┊243┊246┊        return chat;\n```\n```diff\n@@ -245,8 +248,8 @@\n ┊245┊248┊\n ┊246┊249┊      return message;\n ┊247┊250┊    },\n-┊248┊   ┊    removeMessages: (obj: any, {chatId, messageIds, all}: any): number[] => {\n-┊249┊   ┊      const chat = chats.find(chat => chat.id === chatId);\n+┊   ┊251┊    removeMessages: (obj: any, {chatId, messageIds, all}: RemoveMessagesMutationArgs): number[] => {\n+┊   ┊252┊      const chat = chats.find(chat => chat.id === Number(chatId));\n ┊250┊253┊\n ┊251┊254┊      if (!chat) {\n ┊252┊255┊        throw new Error(`Cannot find chat ${chatId}.`);\n```\n```diff\n@@ -262,10 +265,10 @@\n ┊262┊265┊\n ┊263┊266┊      let deletedIds: number[] = [];\n ┊264┊267┊      chats = chats.map(chat => {\n-┊265┊   ┊        if (chat.id === chatId) {\n+┊   ┊268┊        if (chat.id === Number(chatId)) {\n ┊266┊269┊          // Instead of chaining map and filter we can loop once using reduce\n ┊267┊270┊          const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n-┊268┊   ┊            if (all || messageIds!.includes(message.id)) {\n+┊   ┊271┊            if (all || messageIds!.includes(String(message.id))) {\n ┊269┊272┊              deletedIds.push(message.id);\n ┊270┊273┊              // Remove the current user from the message holders\n ┊271┊274┊              message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser);\n```\n\n[}]: #\n\n## Client\n\nFor the client I'll only show you how to make use of the addMessage mutation in this chapters. The other mutations will require much more boilerplate so I left them for their own chapter.\n\nLet's start by wiring the addMessage mutation. We're going to write the GraphQL query and then use the generator to generate the types:\n\n[{]: <helper> (diffStep \"5.1\" files=\"^\\(?!src/types.d.ts$\\).*\" module=\"client\")\n\n#### [Step 5.1: Create addMessage mutation and generate types](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/706d62e)\n\n##### Changed src&#x2F;graphql.ts\n```diff\n@@ -600,6 +600,20 @@\n ┊600┊600┊  > = Resolver<R, Parent, Context>;\n ┊601┊601┊}\n ┊602┊602┊\n+┊   ┊603┊export namespace AddMessage {\n+┊   ┊604┊  export type Variables = {\n+┊   ┊605┊    chatId: string;\n+┊   ┊606┊    content: string;\n+┊   ┊607┊  };\n+┊   ┊608┊\n+┊   ┊609┊  export type Mutation = {\n+┊   ┊610┊    __typename?: \"Mutation\";\n+┊   ┊611┊    addMessage?: AddMessage | null;\n+┊   ┊612┊  };\n+┊   ┊613┊\n+┊   ┊614┊  export type AddMessage = Message.Fragment;\n+┊   ┊615┊}\n+┊   ┊616┊\n ┊603┊617┊export namespace GetChat {\n ┊604┊618┊  export type Variables = {\n ┊605┊619┊    chatId: string;\n```\n```diff\n@@ -760,6 +774,23 @@\n ┊760┊774┊  }\n ┊761┊775┊`;\n ┊762┊776┊\n+┊   ┊777┊@Injectable({\n+┊   ┊778┊  providedIn: \"root\"\n+┊   ┊779┊})\n+┊   ┊780┊export class AddMessageGQL extends Apollo.Mutation<\n+┊   ┊781┊  AddMessage.Mutation,\n+┊   ┊782┊  AddMessage.Variables\n+┊   ┊783┊> {\n+┊   ┊784┊  document: any = gql`\n+┊   ┊785┊    mutation AddMessage($chatId: ID!, $content: String!) {\n+┊   ┊786┊      addMessage(chatId: $chatId, content: $content) {\n+┊   ┊787┊        ...Message\n+┊   ┊788┊      }\n+┊   ┊789┊    }\n+┊   ┊790┊\n+┊   ┊791┊    ${MessageFragment}\n+┊   ┊792┊  `;\n+┊   ┊793┊}\n ┊763┊794┊@Injectable({\n ┊764┊795┊  providedIn: \"root\"\n ┊765┊796┊})\n```\n\n##### Added src&#x2F;graphql&#x2F;addMessage.mutation.ts\n```diff\n@@ -0,0 +1,13 @@\n+┊  ┊ 1┊import gql from 'graphql-tag';\n+┊  ┊ 2┊import {fragments} from './fragment';\n+┊  ┊ 3┊\n+┊  ┊ 4┊// We use the gql tag to parse our query string into a query document\n+┊  ┊ 5┊export const addMessageMutation = gql`\n+┊  ┊ 6┊  mutation AddMessage($chatId: ID!, $content: String!) {\n+┊  ┊ 7┊    addMessage(chatId: $chatId, content: $content) {\n+┊  ┊ 8┊      ...Message\n+┊  ┊ 9┊    }\n+┊  ┊10┊  }\n+┊  ┊11┊\n+┊  ┊12┊  ${fragments['message']}\n+┊  ┊13┊`;\n```\n\n[}]: #\n\nRun the generator:\n\n    yarn generator\n\nNow let's use the just-created query:\n\n[{]: <helper> (diffStep \"5.2\" module=\"client\")\n\n#### [Step 5.2: Modify chat component and service](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/ad6a5da)\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.ts\n```diff\n@@ -14,7 +14,7 @@\n ┊14┊14┊    </app-toolbar>\n ┊15┊15┊    <div class=\"container\">\n ┊16┊16┊      <app-messages-list [items]=\"messages\" [isGroup]=\"isGroup\"></app-messages-list>\n-┊17┊  ┊      <app-new-message></app-new-message>\n+┊  ┊17┊      <app-new-message (newMessage)=\"addMessage($event)\"></app-new-message>\n ┊18┊18┊    </div>\n ┊19┊19┊  `,\n ┊20┊20┊  styleUrls: ['./chat.component.scss']\n```\n```diff\n@@ -44,4 +44,8 @@\n ┊44┊44┊  goToChats() {\n ┊45┊45┊    this.router.navigate(['/chats']);\n ┊46┊46┊  }\n+┊  ┊47┊\n+┊  ┊48┊  addMessage(content: string) {\n+┊  ┊49┊    this.chatsService.addMessage(this.chatId, content).subscribe();\n+┊  ┊50┊  }\n ┊47┊51┊}\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,6 +1,6 @@\n ┊1┊1┊import {map} from 'rxjs/operators';\n ┊2┊2┊import {Injectable} from '@angular/core';\n-┊3┊ ┊import {GetChatsGQL, GetChatGQL} from '../../graphql';\n+┊ ┊3┊import {GetChatsGQL, GetChatGQL, AddMessageGQL} from '../../graphql';\n ┊4┊4┊\n ┊5┊5┊@Injectable()\n ┊6┊6┊export class ChatsService {\n```\n```diff\n@@ -8,7 +8,8 @@\n ┊ 8┊ 8┊\n ┊ 9┊ 9┊  constructor(\n ┊10┊10┊    private getChatsGQL: GetChatsGQL,\n-┊11┊  ┊    private getChatGQL: GetChatGQL\n+┊  ┊11┊    private getChatGQL: GetChatGQL,\n+┊  ┊12┊    private addMessageGQL: AddMessageGQL\n ┊12┊13┊  ) {}\n ┊13┊14┊\n ┊14┊15┊  getChats() {\n```\n```diff\n@@ -33,4 +34,11 @@\n ┊33┊34┊\n ┊34┊35┊    return {query, chat$};\n ┊35┊36┊  }\n+┊  ┊37┊\n+┊  ┊38┊  addMessage(chatId: string, content: string) {\n+┊  ┊39┊    return this.addMessageGQL.mutate({\n+┊  ┊40┊      chatId,\n+┊  ┊41┊      content,\n+┊  ┊42┊    });\n+┊  ┊43┊  }\n ┊36┊44┊}\n```\n\n[}]: #\n\nIt's that simple! You would be tempted to say that it doesn't work, but you should try to refresh the page first ;)"
          },
          {
            "manualTitle": "Step 10: Updating the store",
            "stepRevision": "04749f21bfdeecb76145491e1d4d373102ad8969",
            "manualView": "## Client\n\nDid you notice that after creating a new message you'll have to refresh the page in order to see it?\n\nHow to fix that?\n\nApollo performs two important core tasks which we covered in one of previous steps: executing queries and mutations, and caching the results.\n\nThanks to Apollo's store design, it's possible for the results of a query or mutation to update your UI in all the right places. In many cases it's possible for that to happen automatically, whereas in others you need to help the client out a little in doing so.\n\nThere are couple of APIs to update the cache after mutation:\n\n- `refetchQueries` - is the most straightforward way of updating the cache. You request queries to be executed once again.\n- `update` - super flexible and allows you to make changes to the store based on mutation. Works well with Optimistic UI which we will cover later.\n- `updateQueries` - It works similar to the previous option but the API may be deprecated in the future and we recommend to stay with `update`.\n\nIf you thought about re-querying the server you would be wrong! The best solution is to use the response provided by the server to update our Apollo local cache.\n\nOf course that we're going to use the `update` API!\n\n### Updating the store\n\nAs you can see, the `update` option is a function that has two arguments:\n\n- `DataProxy` which we named `store`\n- mutation's result\n\nThe `DataProxy` seems very interesting! It's a middleman between you and the cache.\n\n#### How to update fragments\n\nIn pretty much every case, that middleman would allow to write and read data. Take for example the JavaScript `Map` object.\n\nIt has a `get` and `set` methods and both works based on a `key`.\n\nIn Apollo, we do have that key, it's something that was covered in the 5th step, remember? An object of type `Message` with an `id` would be stored in the cache as `Message:<id>`.\n\nLet's call that small object a fragment, for simplicity.\n\nWhat are our _get_ and _set_ methods in Apollo's DataProxy? Simple, `readFragment` and `writeFragment`.\n\nI think it's time to work on a simple example. Scenario: every message can be liked and we keep the sum of likes under the `likes` field.\n\nHow to give a like?\n\n```typescript\nconst store: DataProxy = ...;\nconst messageId = 256;\n\nconst fragment = gql`\n  fragment M on Message {\n    likes\n  }\n`;\nconst fragmentId = `Message:${messageId}`;\n\nconst message = store.readFragment({\n  fragment,\n  id: fragmentId\n});\n\nstore.writeFragment({\n  fragment,\n  id: fragmentId,\n  data: {\n    likes: message.likes + 1\n  }\n});\n```\n\nWhat just happened?!\n\nAt first, it might seem weird to talk to the store like that but you will see that it makes a lot of sense!\n\n - `messageId` - defined the actual id of our message\n - `fragment` - it's a document that tells Apollo what fields we want to read and write\n - `fragmentId` - an unique key under which the fragment is stored (we covered that in 5th step)\n - `readFragment` - reads the fragment in the store and returns the result in exact same shape as requested\n - `writeFragment` - accepts same properties as `readFragment` but also the `data` property\n\n### How to update queries\n\nSimilar as in case of fragments, we update queries with `readQuery` and `writeQuery`.\n\nWe won't cover the same thing again but let's just look at the API based on our WhatsApp clone example:\n\n[{]: <helper> (diffStep \"6.1\" module=\"client\")\n\n#### [Step 6.1: Update the store](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/cb01e16)\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,6 +1,13 @@\n ┊ 1┊ 1┊import {map} from 'rxjs/operators';\n ┊ 2┊ 2┊import {Injectable} from '@angular/core';\n-┊ 3┊  ┊import {GetChatsGQL, GetChatGQL, AddMessageGQL} from '../../graphql';\n+┊  ┊ 3┊import {\n+┊  ┊ 4┊  GetChatsGQL,\n+┊  ┊ 5┊  GetChatGQL,\n+┊  ┊ 6┊  AddMessageGQL,\n+┊  ┊ 7┊  AddMessage,\n+┊  ┊ 8┊  GetChats,\n+┊  ┊ 9┊  GetChat\n+┊  ┊10┊} from '../../graphql';\n ┊ 4┊11┊\n ┊ 5┊12┊@Injectable()\n ┊ 6┊13┊export class ChatsService {\n```\n```diff\n@@ -39,6 +46,50 @@\n ┊39┊46┊    return this.addMessageGQL.mutate({\n ┊40┊47┊      chatId,\n ┊41┊48┊      content,\n+┊  ┊49┊    }, {\n+┊  ┊50┊      update: (store, { data: { addMessage } }: {data: AddMessage.Mutation}) => {\n+┊  ┊51┊        // Update the messages cache\n+┊  ┊52┊        {\n+┊  ┊53┊          // Read the data from our cache for this query.\n+┊  ┊54┊          const {chat} = store.readQuery<GetChat.Query, GetChat.Variables>({\n+┊  ┊55┊            query: this.getChatGQL.document,\n+┊  ┊56┊            variables: {\n+┊  ┊57┊              chatId,\n+┊  ┊58┊            }\n+┊  ┊59┊          });\n+┊  ┊60┊          // Add our message from the mutation to the end.\n+┊  ┊61┊          chat.messages.push(addMessage);\n+┊  ┊62┊          // Write our data back to the cache.\n+┊  ┊63┊          store.writeQuery({\n+┊  ┊64┊            query: this.getChatGQL.document,\n+┊  ┊65┊            data: {\n+┊  ┊66┊              chat\n+┊  ┊67┊            }\n+┊  ┊68┊          });\n+┊  ┊69┊        }\n+┊  ┊70┊        // Update last message cache\n+┊  ┊71┊        {\n+┊  ┊72┊          // Read the data from our cache for this query.\n+┊  ┊73┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n+┊  ┊74┊            query: this.getChatsGQL.document,\n+┊  ┊75┊            variables: {\n+┊  ┊76┊              amount: this.messagesAmount,\n+┊  ┊77┊            },\n+┊  ┊78┊          });\n+┊  ┊79┊          // Add our comment from the mutation to the end.\n+┊  ┊80┊          chats.find(chat => chat.id === chatId).messages.push(addMessage);\n+┊  ┊81┊          // Write our data back to the cache.\n+┊  ┊82┊          store.writeQuery<GetChats.Query, GetChats.Variables>({\n+┊  ┊83┊            query: this.getChatsGQL.document,\n+┊  ┊84┊            variables: {\n+┊  ┊85┊              amount: this.messagesAmount,\n+┊  ┊86┊            },\n+┊  ┊87┊            data: {\n+┊  ┊88┊              chats,\n+┊  ┊89┊            },\n+┊  ┊90┊          });\n+┊  ┊91┊        }\n+┊  ┊92┊      }\n ┊42┊93┊    });\n ┊43┊94┊  }\n ┊44┊95┊}\n```\n\n[}]: #\n\nAs you can see we used the `document` property of a generated GQL service. It contains the actual query that is used in every `watch` or `fetch` calls of the GQL service. It's a part of the open API.\n\n### Keep on mind\n\nIt's very important to know few things:\n\n- update function have to run synchronously\n- the query should always match the query you want to update (even order of fields or variables matters)\n- by updating a query you also update every normalized data it has (we called them fragments in few secions above)\n\nWhen Apollo runs the `update` function? In two cases, rigth after the mutation happens but only if it has an optimistic response defined, and also once we get the response from the server.\n\n> Optimistic Resposne is something we will cover in next steps but so you know, Apollo allows to optimistically update the store with a temporary data that is being replaced right after we get the response from the server.\n\nBut why the update function has to run synchornously? It's by design and not so interesting. We won't cover it in-depth here but in short, when Apollo runs the function it switches the store with the new, empty one, to record every change that's made by the function to later merge it with the original store. If you still have questions, please let us know so we can cover that thing in-depth as a blog post or even a separate chapter in that tutorial.\n\n### Summary\n\nNow you won't need to reload the page in order to see the new message. What's even more interesting is that the message you wrote would also be shown as the last message in the chats list, just hit the back button in the top-left corner to find out!\n\nThis is because we updated our store for both the `GetChat` and the `GetChats` query."
          },
          {
            "manualTitle": "Step 11: Messages and chats removal",
            "stepRevision": "d924471909e13cc56a0bf23311554f1e7413130f",
            "manualView": "## Client\n\nSince we're now familiar with the way mutations work, it's time to add messages and chats removal to our list of features!\nSince the most annoying part is going to be dealing with the user interface (because a multiple selection started by a press event is involved), I created an Angular directive to ease the process.\n\nLet's start by adding `ngx-selectable-list`:\n\n    yarn add ngx-selectable-list\n\n[{]: <helper> (diffStep \"7.1\" module=\"client\")\n\n#### [Step 7.1: Add SelectableListModule](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/5ef06d0)\n\n##### Changed package.json\n```diff\n@@ -34,7 +34,8 @@\n ┊34┊34┊    \"graphql-tag\": \"2.10.0\",\n ┊35┊35┊    \"graphql\": \"14.0.2\",\n ┊36┊36┊    \"hammerjs\": \"2.0.8\",\n-┊37┊  ┊    \"ng2-truncate\": \"1.3.17\"\n+┊  ┊37┊    \"ng2-truncate\": \"1.3.17\",\n+┊  ┊38┊    \"ngx-selectable-list\": \"1.2.1\"\n ┊38┊39┊  },\n ┊39┊40┊  \"devDependencies\": {\n ┊40┊41┊    \"@angular-devkit/build-angular\": \"0.9.0-rc.2\",\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;chats-lister.module.ts\n```diff\n@@ -11,6 +11,7 @@\n ┊11┊11┊import {ChatsListComponent} from './components/chats-list/chats-list.component';\n ┊12┊12┊import {TruncateModule} from 'ng2-truncate';\n ┊13┊13┊import {SharedModule} from '../shared/shared.module';\n+┊  ┊14┊import {NgxSelectableListModule} from 'ngx-selectable-list';\n ┊14┊15┊\n ┊15┊16┊const routes: Routes = [\n ┊16┊17┊  {path: '', redirectTo: 'chats', pathMatch: 'full'},\n```\n```diff\n@@ -40,6 +41,7 @@\n ┊40┊41┊    TruncateModule,\n ┊41┊42┊    // Feature modules\n ┊42┊43┊    SharedModule,\n+┊  ┊44┊    NgxSelectableListModule,\n ┊43┊45┊  ],\n ┊44┊46┊  providers: [\n ┊45┊47┊    ChatsService,\n```\n\n[}]: #\n\nBecause we're going to use the `libSelectableList` directive, we can replace Outputs and EventEmitters with it:\n\n[{]: <helper> (diffStep \"7.2\" files=\"src/app/chats-lister/components/chat-item/chat-item.component.ts, src/app/chats-lister/components/chats-list/chats-list.component.ts, src/app/chat-viewer/components/messages-list/messages-list.component.ts\" module=\"client\")\n\n#### [Step 7.2: Remove messages and chats](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/18cfa7c)\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;components&#x2F;messages-list&#x2F;messages-list.component.ts\n```diff\n@@ -1,14 +1,17 @@\n ┊ 1┊ 1┊import {Component, Input} from '@angular/core';\n ┊ 2┊ 2┊import {GetChat} from '../../../../graphql';\n+┊  ┊ 3┊import {SelectableListDirective} from 'ngx-selectable-list';\n ┊ 3┊ 4┊\n ┊ 4┊ 5┊@Component({\n ┊ 5┊ 6┊  selector: 'app-messages-list',\n ┊ 6┊ 7┊  template: `\n ┊ 7┊ 8┊    <mat-list>\n ┊ 8┊ 9┊      <mat-list-item *ngFor=\"let message of messages\">\n-┊ 9┊  ┊        <app-message-item [item]=\"message\" [isGroup]=\"isGroup\"></app-message-item>\n+┊  ┊10┊        <app-message-item [item]=\"message\" [isGroup]=\"isGroup\"\n+┊  ┊11┊                          libSelectableItem></app-message-item>\n ┊10┊12┊      </mat-list-item>\n ┊11┊13┊    </mat-list>\n+┊  ┊14┊    <ng-content *ngIf=\"selectableListDirective.selecting\"></ng-content>\n ┊12┊15┊  `,\n ┊13┊16┊  styleUrls: ['messages-list.component.scss'],\n ┊14┊17┊})\n```\n```diff\n@@ -20,5 +23,5 @@\n ┊20┊23┊  @Input()\n ┊21┊24┊  isGroup: boolean;\n ┊22┊25┊\n-┊23┊  ┊  constructor() {}\n+┊  ┊26┊  constructor(public selectableListDirective: SelectableListDirective) {}\n ┊24┊27┊}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chat-item&#x2F;chat-item.component.ts\n```diff\n@@ -4,7 +4,7 @@\n ┊ 4┊ 4┊@Component({\n ┊ 5┊ 5┊  selector: 'app-chat-item',\n ┊ 6┊ 6┊  template: `\n-┊ 7┊  ┊    <div class=\"chat-row\" (click)=\"selectChat()\">\n+┊  ┊ 7┊    <div class=\"chat-row\">\n ┊ 8┊ 8┊      <img class=\"chat-pic\" [src]=\"chat.picture || 'assets/default-profile-pic.jpg'\">\n ┊ 9┊ 9┊      <div class=\"chat-info\">\n ┊10┊10┊        <div class=\"chat-name\">{{ chat.name }}</div>\n```\n```diff\n@@ -19,11 +19,4 @@\n ┊19┊19┊  // tslint:disable-next-line:no-input-rename\n ┊20┊20┊  @Input('item')\n ┊21┊21┊  chat: GetChats.Chats;\n-┊22┊  ┊\n-┊23┊  ┊  @Output()\n-┊24┊  ┊  select = new EventEmitter<string>();\n-┊25┊  ┊\n-┊26┊  ┊  selectChat() {\n-┊27┊  ┊    this.select.emit(this.chat.id);\n-┊28┊  ┊  }\n ┊29┊22┊}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chats-list&#x2F;chats-list.component.ts\n```diff\n@@ -1,14 +1,17 @@\n-┊ 1┊  ┊import {Component, EventEmitter, Input, Output} from '@angular/core';\n+┊  ┊ 1┊import {Component, Input} from '@angular/core';\n ┊ 2┊ 2┊import {GetChats} from '../../../../graphql';\n+┊  ┊ 3┊import {SelectableListDirective} from 'ngx-selectable-list';\n ┊ 3┊ 4┊\n ┊ 4┊ 5┊@Component({\n ┊ 5┊ 6┊  selector: 'app-chats-list',\n ┊ 6┊ 7┊  template: `\n ┊ 7┊ 8┊    <mat-list>\n ┊ 8┊ 9┊      <mat-list-item *ngFor=\"let chat of chats\">\n-┊ 9┊  ┊        <app-chat-item [item]=\"chat\" (select)=\"selectChat($event)\"></app-chat-item>\n+┊  ┊10┊        <app-chat-item [item]=\"chat\"\n+┊  ┊11┊                       libSelectableItem></app-chat-item>\n ┊10┊12┊      </mat-list-item>\n ┊11┊13┊    </mat-list>\n+┊  ┊14┊    <ng-content *ngIf=\"selectableListDirective.selecting\"></ng-content>\n ┊12┊15┊  `,\n ┊13┊16┊  styleUrls: ['chats-list.component.scss'],\n ┊14┊17┊})\n```\n```diff\n@@ -17,12 +20,5 @@\n ┊17┊20┊  @Input('items')\n ┊18┊21┊  chats: GetChats.Chats[];\n ┊19┊22┊\n-┊20┊  ┊  @Output()\n-┊21┊  ┊  select = new EventEmitter<string>();\n-┊22┊  ┊\n-┊23┊  ┊  constructor() {}\n-┊24┊  ┊\n-┊25┊  ┊  selectChat(id: string) {\n-┊26┊  ┊    this.select.emit(id);\n-┊27┊  ┊  }\n+┊  ┊23┊  constructor(public selectableListDirective: SelectableListDirective) {}\n ┊28┊24┊}\n```\n\n[}]: #\n\nDon't forget to add the `NgxSelectableListModule` to `ChatViewer` and `ChatLister` modules.\n\nWe also created a `ConfirmSelectionComponent` to use for content projection, since our selectable list directive will be able to listen to its events.\n\n[{]: <helper> (diffStep \"7.2\" files=\"src/app/shared/components/confirm-selection/confirm-selection.component.scss, src/app/shared/components/confirm-selection/confirm-selection.component.ts, src/app/shared/shared.module.ts\" module=\"client\")\n\n#### [Step 7.2: Remove messages and chats](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/18cfa7c)\n\n##### Added src&#x2F;app&#x2F;shared&#x2F;components&#x2F;confirm-selection&#x2F;confirm-selection.component.scss\n```diff\n@@ -0,0 +1,6 @@\n+┊ ┊1┊:host {\n+┊ ┊2┊  display: block;\n+┊ ┊3┊  position: absolute;\n+┊ ┊4┊  bottom: 5vw;\n+┊ ┊5┊  right: 5vw;\n+┊ ┊6┊}\n```\n\n##### Added src&#x2F;app&#x2F;shared&#x2F;components&#x2F;confirm-selection&#x2F;confirm-selection.component.ts\n```diff\n@@ -0,0 +1,21 @@\n+┊  ┊ 1┊import {Component, EventEmitter, Input, Output} from '@angular/core';\n+┊  ┊ 2┊\n+┊  ┊ 3┊@Component({\n+┊  ┊ 4┊  selector: 'app-confirm-selection',\n+┊  ┊ 5┊  template: `\n+┊  ┊ 6┊    <button mat-fab color=\"primary\" (click)=\"handleClick()\">\n+┊  ┊ 7┊      <mat-icon aria-label=\"Icon-button\">{{ icon }}</mat-icon>\n+┊  ┊ 8┊    </button>\n+┊  ┊ 9┊  `,\n+┊  ┊10┊  styleUrls: ['./confirm-selection.component.scss'],\n+┊  ┊11┊})\n+┊  ┊12┊export class ConfirmSelectionComponent {\n+┊  ┊13┊  @Input()\n+┊  ┊14┊  icon = 'delete';\n+┊  ┊15┊  @Output()\n+┊  ┊16┊  emitClick = new EventEmitter<null>();\n+┊  ┊17┊\n+┊  ┊18┊  handleClick() {\n+┊  ┊19┊    this.emitClick.emit();\n+┊  ┊20┊  }\n+┊  ┊21┊}\n```\n\n##### Changed src&#x2F;app&#x2F;shared&#x2F;shared.module.ts\n```diff\n@@ -1,19 +1,23 @@\n ┊ 1┊ 1┊import {BrowserModule} from '@angular/platform-browser';\n ┊ 2┊ 2┊import {NgModule} from '@angular/core';\n ┊ 3┊ 3┊\n-┊ 4┊  ┊import {MatToolbarModule} from '@angular/material';\n+┊  ┊ 4┊import {MatButtonModule, MatIconModule, MatToolbarModule} from '@angular/material';\n ┊ 5┊ 5┊import {ToolbarComponent} from './components/toolbar/toolbar.component';\n ┊ 6┊ 6┊import {FormsModule} from '@angular/forms';\n ┊ 7┊ 7┊import {BrowserAnimationsModule} from '@angular/platform-browser/animations';\n+┊  ┊ 8┊import {ConfirmSelectionComponent} from './components/confirm-selection/confirm-selection.component';\n ┊ 8┊ 9┊\n ┊ 9┊10┊@NgModule({\n ┊10┊11┊  declarations: [\n ┊11┊12┊    ToolbarComponent,\n+┊  ┊13┊    ConfirmSelectionComponent,\n ┊12┊14┊  ],\n ┊13┊15┊  imports: [\n ┊14┊16┊    BrowserModule,\n ┊15┊17┊    // Material\n ┊16┊18┊    MatToolbarModule,\n+┊  ┊19┊    MatIconModule,\n+┊  ┊20┊    MatButtonModule,\n ┊17┊21┊    // Animations\n ┊18┊22┊    BrowserAnimationsModule,\n ┊19┊23┊    // Forms\n```\n```diff\n@@ -22,6 +26,7 @@\n ┊22┊26┊  providers: [],\n ┊23┊27┊  exports: [\n ┊24┊28┊    ToolbarComponent,\n+┊  ┊29┊    ConfirmSelectionComponent,\n ┊25┊30┊  ],\n ┊26┊31┊})\n ┊27┊32┊export class SharedModule {\n```\n\n[}]: #\n\nGreat, let's finish the component part by adding the connection between our container components and the `ChatsService`. We're going to use `removeMessages` and `removeChat` methods.\n\n[{]: <helper> (diffStep \"7.2\" files=\"src/app/chat-viewer/containers/chat/chat.component.ts, src/app/chat-viewer/containers/chat/chat.component.spec.ts, src/app/chats-lister/containers/chats/chats.component.ts, src/app/chats-lister/containers/chats/chats.component.spec.ts\" module=\"client\")\n\n#### [Step 7.2: Remove messages and chats](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/18cfa7c)\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.spec.ts\n```diff\n@@ -20,6 +20,7 @@\n ┊20┊20┊  APOLLO_TESTING_CACHE,\n ┊21┊21┊} from 'apollo-angular/testing';\n ┊22┊22┊import { InMemoryCache } from 'apollo-cache-inmemory';\n+┊  ┊23┊import { NgxSelectableListModule } from 'ngx-selectable-list';\n ┊23┊24┊\n ┊24┊25┊import { dataIdFromObject } from '../../../graphql.module';\n ┊25┊26┊import { ChatComponent } from './chat.component';\n```\n```diff\n@@ -116,6 +117,7 @@\n ┊116┊117┊        SharedModule,\n ┊117┊118┊        ApolloTestingModule,\n ┊118┊119┊        RouterTestingModule,\n+┊   ┊120┊        NgxSelectableListModule,\n ┊119┊121┊      ],\n ┊120┊122┊      providers: [\n ┊121┊123┊        ChatsService,\n```\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.ts\n```diff\n@@ -13,7 +13,10 @@\n ┊13┊13┊      <div class=\"title\">{{ name }}</div>\n ┊14┊14┊    </app-toolbar>\n ┊15┊15┊    <div class=\"container\">\n-┊16┊  ┊      <app-messages-list [items]=\"messages\" [isGroup]=\"isGroup\"></app-messages-list>\n+┊  ┊16┊      <app-messages-list [items]=\"messages\" [isGroup]=\"isGroup\"\n+┊  ┊17┊                         libSelectableList=\"multiple_press\" (multiple)=\"deleteMessages($event)\">\n+┊  ┊18┊        <app-confirm-selection #confirmSelection></app-confirm-selection>\n+┊  ┊19┊      </app-messages-list>\n ┊17┊20┊      <app-new-message (newMessage)=\"addMessage($event)\"></app-new-message>\n ┊18┊21┊    </div>\n ┊19┊22┊  `,\n```\n```diff\n@@ -48,4 +51,8 @@\n ┊48┊51┊  addMessage(content: string) {\n ┊49┊52┊    this.chatsService.addMessage(this.chatId, content).subscribe();\n ┊50┊53┊  }\n+┊  ┊54┊\n+┊  ┊55┊  deleteMessages(messageIds: string[]) {\n+┊  ┊56┊    this.chatsService.removeMessages(this.chatId, this.messages, messageIds).subscribe();\n+┊  ┊57┊  }\n ┊51┊58┊}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.spec.ts\n```diff\n@@ -16,6 +16,7 @@\n ┊16┊16┊import { InMemoryCache } from 'apollo-cache-inmemory';\n ┊17┊17┊import { By } from '@angular/platform-browser';\n ┊18┊18┊import { RouterTestingModule } from '@angular/router/testing';\n+┊  ┊19┊import { NgxSelectableListModule } from 'ngx-selectable-list';\n ┊19┊20┊\n ┊20┊21┊import { GetChats } from '../../../../graphql';\n ┊21┊22┊import { dataIdFromObject } from '../../../graphql.module';\n```\n```diff\n@@ -334,6 +335,7 @@\n ┊334┊335┊        TruncateModule,\n ┊335┊336┊        ApolloTestingModule,\n ┊336┊337┊        RouterTestingModule,\n+┊   ┊338┊        NgxSelectableListModule,\n ┊337┊339┊      ],\n ┊338┊340┊      providers: [\n ┊339┊341┊        ChatsService,\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.ts\n```diff\n@@ -28,9 +28,13 @@\n ┊28┊28┊      </button>\n ┊29┊29┊    </mat-menu>\n ┊30┊30┊\n-┊31┊  ┊    <app-chats-list [items]=\"chats$ | async\" (select)=\"goToChat($event)\"></app-chats-list>\n+┊  ┊31┊    <app-chats-list [items]=\"chats$ | async\"\n+┊  ┊32┊                    libSelectableList=\"both\"\n+┊  ┊33┊                    (single)=\"goToChat($event)\" (multiple)=\"deleteChats($event)\" (isSelecting)=\"isSelecting = $event\">\n+┊  ┊34┊      <app-confirm-selection #confirmSelection></app-confirm-selection>\n+┊  ┊35┊    </app-chats-list>\n ┊32┊36┊\n-┊33┊  ┊    <button class=\"chat-button\" mat-fab color=\"secondary\">\n+┊  ┊37┊    <button *ngIf=\"!isSelecting\" class=\"chat-button\" mat-fab color=\"secondary\">\n ┊34┊38┊      <mat-icon aria-label=\"Icon-button with a + icon\">chat</mat-icon>\n ┊35┊39┊    </button>\n ┊36┊40┊  `,\n```\n```diff\n@@ -38,6 +42,7 @@\n ┊38┊42┊})\n ┊39┊43┊export class ChatsComponent implements OnInit {\n ┊40┊44┊  chats$: Observable<GetChats.Chats[]>;\n+┊  ┊45┊  isSelecting = false;\n ┊41┊46┊\n ┊42┊47┊  constructor(private chatsService: ChatsService,\n ┊43┊48┊              private router: Router) {\n```\n```diff\n@@ -50,4 +55,10 @@\n ┊50┊55┊  goToChat(chatId: string) {\n ┊51┊56┊    this.router.navigate(['/chat', chatId]);\n ┊52┊57┊  }\n+┊  ┊58┊\n+┊  ┊59┊  deleteChats(chatIds: string[]) {\n+┊  ┊60┊    chatIds.forEach(chatId => {\n+┊  ┊61┊      this.chatsService.removeChat(chatId).subscribe();\n+┊  ┊62┊    });\n+┊  ┊63┊  }\n ┊53┊64┊}\n```\n\n[}]: #\n\n### Connecting actions with the server\n\nThe UI part is pretty much complete but we still need to implement two methods in the `ChatsService`. We're going to create mutations to remove a chat, selected messages or all of them.\n\n[{]: <helper> (diffStep \"7.2\" files=\"src/graphql/removeChat.mutation.ts, src/graphql/removeMessages.mutation.ts, src/graphql/removeAllMessages.mutation.ts\" module=\"client\")\n\n#### [Step 7.2: Remove messages and chats](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/18cfa7c)\n\n##### Added src&#x2F;graphql&#x2F;removeAllMessages.mutation.ts\n```diff\n@@ -0,0 +1,8 @@\n+┊ ┊1┊import gql from 'graphql-tag';\n+┊ ┊2┊\n+┊ ┊3┊// We use the gql tag to parse our query string into a query document\n+┊ ┊4┊export const removeAllMessagesMutation = gql`\n+┊ ┊5┊  mutation RemoveAllMessages($chatId: ID!, $all: Boolean) {\n+┊ ┊6┊    removeMessages(chatId: $chatId, all: $all)\n+┊ ┊7┊  }\n+┊ ┊8┊`;\n```\n\n##### Added src&#x2F;graphql&#x2F;removeChat.mutation.ts\n```diff\n@@ -0,0 +1,8 @@\n+┊ ┊1┊import gql from 'graphql-tag';\n+┊ ┊2┊\n+┊ ┊3┊// We use the gql tag to parse our query string into a query document\n+┊ ┊4┊export const removeChatMutation = gql`\n+┊ ┊5┊  mutation RemoveChat($chatId: ID!) {\n+┊ ┊6┊    removeChat(chatId: $chatId)\n+┊ ┊7┊  }\n+┊ ┊8┊`;\n```\n\n##### Added src&#x2F;graphql&#x2F;removeMessages.mutation.ts\n```diff\n@@ -0,0 +1,8 @@\n+┊ ┊1┊import gql from 'graphql-tag';\n+┊ ┊2┊\n+┊ ┊3┊// We use the gql tag to parse our query string into a query document\n+┊ ┊4┊export const removeMessagesMutation = gql`\n+┊ ┊5┊  mutation RemoveMessages($chatId: ID!, $messageIds: [ID]) {\n+┊ ┊6┊    removeMessages(chatId: $chatId, messageIds: $messageIds)\n+┊ ┊7┊  }\n+┊ ┊8┊`;\n```\n\n[}]: #\n\nOnce again, we run the GraphQL Code Generator to get the GQL services:\n\n    yarn generator\n\nNow we can import those services, create `removeChat` and `removeMessages` methods in which we call a mutation.\n\n[{]: <helper> (diffStep \"7.2\" files=\"src/app/services/chats.service.ts\" module=\"client\")\n\n#### [Step 7.2: Remove messages and chats](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/18cfa7c)\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -4,10 +4,16 @@\n ┊ 4┊ 4┊  GetChatsGQL,\n ┊ 5┊ 5┊  GetChatGQL,\n ┊ 6┊ 6┊  AddMessageGQL,\n+┊  ┊ 7┊  RemoveChatGQL,\n+┊  ┊ 8┊  RemoveMessagesGQL,\n+┊  ┊ 9┊  RemoveAllMessagesGQL,\n ┊ 7┊10┊  AddMessage,\n ┊ 8┊11┊  GetChats,\n-┊ 9┊  ┊  GetChat\n+┊  ┊12┊  GetChat,\n+┊  ┊13┊  RemoveMessages,\n+┊  ┊14┊  RemoveAllMessages,\n ┊10┊15┊} from '../../graphql';\n+┊  ┊16┊import { DataProxy } from 'apollo-cache';\n ┊11┊17┊\n ┊12┊18┊@Injectable()\n ┊13┊19┊export class ChatsService {\n```\n```diff\n@@ -16,7 +22,10 @@\n ┊16┊22┊  constructor(\n ┊17┊23┊    private getChatsGQL: GetChatsGQL,\n ┊18┊24┊    private getChatGQL: GetChatGQL,\n-┊19┊  ┊    private addMessageGQL: AddMessageGQL\n+┊  ┊25┊    private addMessageGQL: AddMessageGQL,\n+┊  ┊26┊    private removeChatGQL: RemoveChatGQL,\n+┊  ┊27┊    private removeMessagesGQL: RemoveMessagesGQL,\n+┊  ┊28┊    private removeAllMessagesGQL: RemoveAllMessagesGQL,\n ┊20┊29┊  ) {}\n ┊21┊30┊\n ┊22┊31┊  getChats() {\n```\n```diff\n@@ -92,4 +101,112 @@\n ┊ 92┊101┊      }\n ┊ 93┊102┊    });\n ┊ 94┊103┊  }\n+┊   ┊104┊\n+┊   ┊105┊  removeChat(chatId: string) {\n+┊   ┊106┊    return this.removeChatGQL.mutate(\n+┊   ┊107┊      {\n+┊   ┊108┊        chatId,\n+┊   ┊109┊      }, {\n+┊   ┊110┊        update: (store, { data: { removeChat } }) => {\n+┊   ┊111┊          // Read the data from our cache for this query.\n+┊   ┊112┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊113┊            query: this.getChatsGQL.document,\n+┊   ┊114┊            variables: {\n+┊   ┊115┊              amount: this.messagesAmount,\n+┊   ┊116┊            },\n+┊   ┊117┊          });\n+┊   ┊118┊          // Remove the chat (mutable)\n+┊   ┊119┊          for (const index of chats.keys()) {\n+┊   ┊120┊            if (chats[index].id === removeChat) {\n+┊   ┊121┊              chats.splice(index, 1);\n+┊   ┊122┊            }\n+┊   ┊123┊          }\n+┊   ┊124┊          // Write our data back to the cache.\n+┊   ┊125┊          store.writeQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊126┊            query: this.getChatsGQL.document,\n+┊   ┊127┊            variables: {\n+┊   ┊128┊              amount: this.messagesAmount,\n+┊   ┊129┊            },\n+┊   ┊130┊            data: {\n+┊   ┊131┊              chats,\n+┊   ┊132┊            },\n+┊   ┊133┊          });\n+┊   ┊134┊        },\n+┊   ┊135┊      }\n+┊   ┊136┊    );\n+┊   ┊137┊  }\n+┊   ┊138┊\n+┊   ┊139┊  removeMessages(chatId: string, messages: GetChat.Messages[], messageIdsOrAll: string[] | boolean) {\n+┊   ┊140┊    let ids: string[] = [];\n+┊   ┊141┊\n+┊   ┊142┊    const options = {\n+┊   ┊143┊      update: (store: DataProxy, { data: { removeMessages } }: {data: RemoveMessages.Mutation | RemoveAllMessages.Mutation}) => {\n+┊   ┊144┊        // Update the messages cache\n+┊   ┊145┊        {\n+┊   ┊146┊          // Read the data from our cache for this query.\n+┊   ┊147┊          const {chat} = store.readQuery<GetChat.Query, GetChat.Variables>({\n+┊   ┊148┊            query: this.getChatGQL.document,\n+┊   ┊149┊            variables: {\n+┊   ┊150┊              chatId,\n+┊   ┊151┊            }\n+┊   ┊152┊          });\n+┊   ┊153┊          // Remove the messages (mutable)\n+┊   ┊154┊          removeMessages.forEach(messageId => {\n+┊   ┊155┊            for (const index of chat.messages.keys()) {\n+┊   ┊156┊              if (chat.messages[index].id === messageId) {\n+┊   ┊157┊                chat.messages.splice(index, 1);\n+┊   ┊158┊              }\n+┊   ┊159┊            }\n+┊   ┊160┊          });\n+┊   ┊161┊          // Write our data back to the cache.\n+┊   ┊162┊          store.writeQuery<GetChat.Query, GetChat.Variables>({\n+┊   ┊163┊            query: this.getChatGQL.document,\n+┊   ┊164┊            data: {\n+┊   ┊165┊              chat\n+┊   ┊166┊            }\n+┊   ┊167┊          });\n+┊   ┊168┊        }\n+┊   ┊169┊        // Update last message cache\n+┊   ┊170┊        {\n+┊   ┊171┊          // Read the data from our cache for this query.\n+┊   ┊172┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊173┊            query: this.getChatsGQL.document,\n+┊   ┊174┊            variables: {\n+┊   ┊175┊              amount: this.messagesAmount,\n+┊   ┊176┊            },\n+┊   ┊177┊          });\n+┊   ┊178┊          // Fix last message\n+┊   ┊179┊          chats.find(chat => chat.id === chatId).messages = messages\n+┊   ┊180┊            .filter(message => !ids.includes(message.id))\n+┊   ┊181┊            .sort((a, b) => Number(b.createdAt) - Number(a.createdAt)) || [];\n+┊   ┊182┊          // Write our data back to the cache.\n+┊   ┊183┊          store.writeQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊184┊            query: this.getChatsGQL.document,\n+┊   ┊185┊            variables: {\n+┊   ┊186┊              amount: this.messagesAmount,\n+┊   ┊187┊            },\n+┊   ┊188┊            data: {\n+┊   ┊189┊              chats,\n+┊   ┊190┊            },\n+┊   ┊191┊          });\n+┊   ┊192┊        }\n+┊   ┊193┊      }\n+┊   ┊194┊    };\n+┊   ┊195┊\n+┊   ┊196┊    if (typeof messageIdsOrAll === 'boolean') {\n+┊   ┊197┊      ids = messages.map(message => message.id);\n+┊   ┊198┊\n+┊   ┊199┊      return this.removeAllMessagesGQL.mutate({\n+┊   ┊200┊        chatId,\n+┊   ┊201┊        all: messageIdsOrAll\n+┊   ┊202┊      }, options);\n+┊   ┊203┊    } else {\n+┊   ┊204┊      ids = messageIdsOrAll;\n+┊   ┊205┊\n+┊   ┊206┊      return this.removeMessagesGQL.mutate({\n+┊   ┊207┊        chatId,\n+┊   ┊208┊        messageIds: messageIdsOrAll,\n+┊   ┊209┊      }, options);\n+┊   ┊210┊    }\n+┊   ┊211┊  }\n ┊ 95┊212┊}\n```\n\n[}]: #\n\nIt might seem like a lot but we simply just updating the store there.\n\n### Summary\n\nThe selectable list directive supports much more different use cases, for info please read the documentation.\n\nAs you can see `ngx-selectable-list` takes care of most of the boilerplate, giving us the freedom to concentrate on the actual code."
          },
          {
            "manualTitle": "Step 12: Chats creation",
            "stepRevision": "ee69029ee3985a5b2d46874694315646d04e5cd0",
            "manualView": "![new-chat](https://user-images.githubusercontent.com/7648874/49270347-ea25ea00-f4a3-11e8-98ac-f67de8bfd8d5.png)\n\n![new-group](https://user-images.githubusercontent.com/7648874/49270350-ec884400-f4a3-11e8-8baa-b6bba0f7f539.png)\n\nWe still cannot create new chats or groups, so let's implement it.\n\nWe're going to create a `ChatsCreation` module, with a `NewChat` and a `NewGroup` containers, along with several presentational components.\n\nWe're going to make use of the selectable list directive once again, to ease selecting the users when we're creating a new group.\nYou should also notice that we are looking for existing chats before creating a new one: if it already exists we're simply redirecting to that chat instead of creating a new one (the server wouldn't allow that anyway and it will simply\nreturn the chat id).\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/graphql/\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n##### Added src&#x2F;graphql&#x2F;addChat.mutation.ts\n```diff\n@@ -0,0 +1,17 @@\n+┊  ┊ 1┊import gql from 'graphql-tag';\n+┊  ┊ 2┊import {fragments} from './fragment';\n+┊  ┊ 3┊\n+┊  ┊ 4┊// We use the gql tag to parse our query string into a query document\n+┊  ┊ 5┊export const addChatMutation = gql`\n+┊  ┊ 6┊  mutation AddChat($recipientId: ID!) {\n+┊  ┊ 7┊    addChat(recipientId: $recipientId) {\n+┊  ┊ 8┊      ...ChatWithoutMessages\n+┊  ┊ 9┊      messages {\n+┊  ┊10┊        ...Message\n+┊  ┊11┊      }\n+┊  ┊12┊    }\n+┊  ┊13┊  }\n+┊  ┊14┊\n+┊  ┊15┊  ${fragments['chatWithoutMessages']}\n+┊  ┊16┊  ${fragments['message']}\n+┊  ┊17┊`;\n```\n\n##### Added src&#x2F;graphql&#x2F;addGroup.mutation.ts\n```diff\n@@ -0,0 +1,17 @@\n+┊  ┊ 1┊import gql from 'graphql-tag';\n+┊  ┊ 2┊import {fragments} from './fragment';\n+┊  ┊ 3┊\n+┊  ┊ 4┊// We use the gql tag to parse our query string into a query document\n+┊  ┊ 5┊export const addGroupMutation = gql`\n+┊  ┊ 6┊  mutation AddGroup($recipientIds: [ID!]!, $groupName: String!) {\n+┊  ┊ 7┊    addGroup(recipientIds: $recipientIds, groupName: $groupName) {\n+┊  ┊ 8┊      ...ChatWithoutMessages\n+┊  ┊ 9┊      messages {\n+┊  ┊10┊        ...Message\n+┊  ┊11┊      }\n+┊  ┊12┊    }\n+┊  ┊13┊  }\n+┊  ┊14┊\n+┊  ┊15┊  ${fragments['chatWithoutMessages']}\n+┊  ┊16┊  ${fragments['message']}\n+┊  ┊17┊`;\n```\n\n##### Added src&#x2F;graphql&#x2F;getUsers.query.ts\n```diff\n@@ -0,0 +1,12 @@\n+┊  ┊ 1┊import gql from 'graphql-tag';\n+┊  ┊ 2┊\n+┊  ┊ 3┊// We use the gql tag to parse our query string into a query document\n+┊  ┊ 4┊export const getUsersQuery = gql`\n+┊  ┊ 5┊  query GetUsers {\n+┊  ┊ 6┊    users {\n+┊  ┊ 7┊      id,\n+┊  ┊ 8┊      name,\n+┊  ┊ 9┊      picture,\n+┊  ┊10┊    }\n+┊  ┊11┊  }\n+┊  ┊12┊`;\n```\n\n[}]: #\n\nAfter creating the mutations we should run the generator to create the corresponding types and services:\n\n    yarn generator\n\nLet's jump straight into `ChatsService` and add few new methods:\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/app/services/chats.service.ts\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,5 +1,7 @@\n ┊1┊1┊import {map} from 'rxjs/operators';\n ┊2┊2┊import {Injectable} from '@angular/core';\n+┊ ┊3┊import {Observable} from 'rxjs';\n+┊ ┊4┊import {QueryRef} from 'apollo-angular';\n ┊3┊5┊import {\n ┊4┊6┊  GetChatsGQL,\n ┊5┊7┊  GetChatGQL,\n```\n```diff\n@@ -7,6 +9,9 @@\n ┊ 7┊ 9┊  RemoveChatGQL,\n ┊ 8┊10┊  RemoveMessagesGQL,\n ┊ 9┊11┊  RemoveAllMessagesGQL,\n+┊  ┊12┊  GetUsersGQL,\n+┊  ┊13┊  AddChatGQL,\n+┊  ┊14┊  AddGroupGQL,\n ┊10┊15┊  AddMessage,\n ┊11┊16┊  GetChats,\n ┊12┊17┊  GetChat,\n```\n```diff\n@@ -15,9 +20,14 @@\n ┊15┊20┊} from '../../graphql';\n ┊16┊21┊import { DataProxy } from 'apollo-cache';\n ┊17┊22┊\n+┊  ┊23┊const currentUserId = '1';\n+┊  ┊24┊\n ┊18┊25┊@Injectable()\n ┊19┊26┊export class ChatsService {\n ┊20┊27┊  messagesAmount = 3;\n+┊  ┊28┊  getChatsWq: QueryRef<GetChats.Query, GetChats.Variables>;\n+┊  ┊29┊  chats$: Observable<GetChats.Chats[]>;\n+┊  ┊30┊  chats: GetChats.Chats[];\n ┊21┊31┊\n ┊22┊32┊  constructor(\n ┊23┊33┊    private getChatsGQL: GetChatsGQL,\n```\n```diff\n@@ -26,17 +36,21 @@\n ┊26┊36┊    private removeChatGQL: RemoveChatGQL,\n ┊27┊37┊    private removeMessagesGQL: RemoveMessagesGQL,\n ┊28┊38┊    private removeAllMessagesGQL: RemoveAllMessagesGQL,\n-┊29┊  ┊  ) {}\n-┊30┊  ┊\n-┊31┊  ┊  getChats() {\n-┊32┊  ┊    const query = this.getChatsGQL.watch({\n+┊  ┊39┊    private getUsersGQL: GetUsersGQL,\n+┊  ┊40┊    private addChatGQL: AddChatGQL,\n+┊  ┊41┊    private addGroupGQL: AddGroupGQL\n+┊  ┊42┊  ) {\n+┊  ┊43┊    this.getChatsWq = this.getChatsGQL.watch({\n ┊33┊44┊      amount: this.messagesAmount,\n ┊34┊45┊    });\n-┊35┊  ┊    const chats$ = query.valueChanges.pipe(\n+┊  ┊46┊    this.chats$ = this.getChatsWq.valueChanges.pipe(\n ┊36┊47┊      map((result) => result.data.chats)\n ┊37┊48┊    );\n+┊  ┊49┊    this.chats$.subscribe(chats => this.chats = chats);\n+┊  ┊50┊  }\n ┊38┊51┊\n-┊39┊  ┊    return {query, chats$};\n+┊  ┊52┊  getChats() {\n+┊  ┊53┊    return {query: this.getChatsWq, chats$: this.chats$};\n ┊40┊54┊  }\n ┊41┊55┊\n ┊42┊56┊  getChat(chatId: string) {\n```\n```diff\n@@ -209,4 +223,83 @@\n ┊209┊223┊      }, options);\n ┊210┊224┊    }\n ┊211┊225┊  }\n+┊   ┊226┊\n+┊   ┊227┊  getUsers() {\n+┊   ┊228┊    const query = this.getUsersGQL.watch();\n+┊   ┊229┊    const users$ = query.valueChanges.pipe(\n+┊   ┊230┊      map((result) => result.data.users)\n+┊   ┊231┊    );\n+┊   ┊232┊\n+┊   ┊233┊    return {query, users$};\n+┊   ┊234┊  }\n+┊   ┊235┊\n+┊   ┊236┊  // Checks if the chat is listed for the current user and returns the id\n+┊   ┊237┊  getChatId(recipientId: string) {\n+┊   ┊238┊    const _chat = this.chats.find(chat => {\n+┊   ┊239┊      return !chat.isGroup && !!chat.allTimeMembers.find(user => user.id === currentUserId) &&\n+┊   ┊240┊        !!chat.allTimeMembers.find(user => user.id === recipientId);\n+┊   ┊241┊    });\n+┊   ┊242┊    return _chat ? _chat.id : false;\n+┊   ┊243┊  }\n+┊   ┊244┊\n+┊   ┊245┊  addChat(recipientId: string) {\n+┊   ┊246┊    return this.addChatGQL.mutate(\n+┊   ┊247┊      {\n+┊   ┊248┊        recipientId,\n+┊   ┊249┊      }, {\n+┊   ┊250┊        update: (store, { data: { addChat } }) => {\n+┊   ┊251┊          // Read the data from our cache for this query.\n+┊   ┊252┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊253┊            query: this.getChatsGQL.document,\n+┊   ┊254┊            variables: {\n+┊   ┊255┊              amount: this.messagesAmount,\n+┊   ┊256┊            },\n+┊   ┊257┊          });\n+┊   ┊258┊          // Add our comment from the mutation to the end.\n+┊   ┊259┊          chats.push(addChat);\n+┊   ┊260┊          // Write our data back to the cache.\n+┊   ┊261┊          store.writeQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊262┊            query: this.getChatsGQL.document,\n+┊   ┊263┊            variables: {\n+┊   ┊264┊              amount: this.messagesAmount,\n+┊   ┊265┊            },\n+┊   ┊266┊            data: {\n+┊   ┊267┊              chats,\n+┊   ┊268┊            },\n+┊   ┊269┊          });\n+┊   ┊270┊        },\n+┊   ┊271┊      }\n+┊   ┊272┊    );\n+┊   ┊273┊  }\n+┊   ┊274┊\n+┊   ┊275┊  addGroup(recipientIds: string[], groupName: string) {\n+┊   ┊276┊    return this.addGroupGQL.mutate(\n+┊   ┊277┊      {\n+┊   ┊278┊        recipientIds,\n+┊   ┊279┊        groupName,\n+┊   ┊280┊      }, {\n+┊   ┊281┊        update: (store, { data: { addGroup } }) => {\n+┊   ┊282┊          // Read the data from our cache for this query.\n+┊   ┊283┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊284┊            query: this.getChatsGQL.document,\n+┊   ┊285┊            variables: {\n+┊   ┊286┊              amount: this.messagesAmount,\n+┊   ┊287┊            },\n+┊   ┊288┊          });\n+┊   ┊289┊          // Add our comment from the mutation to the end.\n+┊   ┊290┊          chats.push(addGroup);\n+┊   ┊291┊          // Write our data back to the cache.\n+┊   ┊292┊          store.writeQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊293┊            query: this.getChatsGQL.document,\n+┊   ┊294┊            variables: {\n+┊   ┊295┊              amount: this.messagesAmount,\n+┊   ┊296┊            },\n+┊   ┊297┊            data: {\n+┊   ┊298┊              chats,\n+┊   ┊299┊            },\n+┊   ┊300┊          });\n+┊   ┊301┊        },\n+┊   ┊302┊      }\n+┊   ┊303┊    );\n+┊   ┊304┊  }\n ┊212┊305┊}\n```\n\n[}]: #\n\nOkay, now since we got the GraphQL part ready, we're going to focus on the component.\n\nFirst, we will download the default group-chat picture:\n\n    $ wget https://raw.githubusercontent.com/DAB0mB/whatsapp-client-angularcli-material/c75c2416b1990da3588015f76b8338764f44d6ec/src/assets/default-group-pic.jpg -P src/assets\n\nAnd update the relevant chat components to use it when necessary:\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/app/chat-viewer/containers/chat/chat.component.ts, src/app/chats-lister/components/chat-item/chat-item.component.ts\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n\n\n[}]: #\n\nThen we will create a space to add a new group:\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/app/chats-creation/containers/new-group/new-group.component.ts, src/app/chats-creation/containers/new-group/new-group.component.scss\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-group&#x2F;new-group.component.scss\n\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-group&#x2F;new-group.component.ts\n```diff\n@@ -0,0 +1,60 @@\n+┊  ┊ 1┊import {Component, OnInit} from '@angular/core';\n+┊  ┊ 2┊import {Location} from '@angular/common';\n+┊  ┊ 3┊import {Router} from '@angular/router';\n+┊  ┊ 4┊import {AddGroup, GetUsers} from '../../../../graphql';\n+┊  ┊ 5┊import {ChatsService} from '../../../services/chats.service';\n+┊  ┊ 6┊\n+┊  ┊ 7┊@Component({\n+┊  ┊ 8┊  template: `\n+┊  ┊ 9┊    <app-toolbar>\n+┊  ┊10┊      <button class=\"navigation\" mat-button (click)=\"goBack()\">\n+┊  ┊11┊        <mat-icon aria-label=\"Icon-button with an arrow back icon\">arrow_back</mat-icon>\n+┊  ┊12┊      </button>\n+┊  ┊13┊      <div class=\"title\">New group</div>\n+┊  ┊14┊    </app-toolbar>\n+┊  ┊15┊\n+┊  ┊16┊    <app-users-list *ngIf=\"!recipientIds.length\" [items]=\"users\"\n+┊  ┊17┊                    libSelectableList=\"multiple_tap\" (multiple)=\"selectUsers($event)\">\n+┊  ┊18┊      <app-confirm-selection #confirmSelection icon=\"arrow_forward\"></app-confirm-selection>\n+┊  ┊19┊    </app-users-list>\n+┊  ┊20┊    <app-new-group-details *ngIf=\"recipientIds.length\" [users]=\"getSelectedUsers()\"\n+┊  ┊21┊                           (groupDetails)=\"addGroup($event)\"></app-new-group-details>\n+┊  ┊22┊  `,\n+┊  ┊23┊  styleUrls: ['new-group.component.scss'],\n+┊  ┊24┊})\n+┊  ┊25┊export class NewGroupComponent implements OnInit {\n+┊  ┊26┊  users: GetUsers.Users[];\n+┊  ┊27┊  recipientIds: string[] = [];\n+┊  ┊28┊\n+┊  ┊29┊  constructor(private router: Router,\n+┊  ┊30┊              private location: Location,\n+┊  ┊31┊              private chatsService: ChatsService) {}\n+┊  ┊32┊\n+┊  ┊33┊  ngOnInit () {\n+┊  ┊34┊    this.chatsService.getUsers().users$.subscribe(users => this.users = users);\n+┊  ┊35┊  }\n+┊  ┊36┊\n+┊  ┊37┊  goBack() {\n+┊  ┊38┊    if (this.recipientIds.length) {\n+┊  ┊39┊      this.recipientIds = [];\n+┊  ┊40┊    } else {\n+┊  ┊41┊      this.location.back();\n+┊  ┊42┊    }\n+┊  ┊43┊  }\n+┊  ┊44┊\n+┊  ┊45┊  selectUsers(recipientIds: string[]) {\n+┊  ┊46┊    this.recipientIds = recipientIds;\n+┊  ┊47┊  }\n+┊  ┊48┊\n+┊  ┊49┊  getSelectedUsers() {\n+┊  ┊50┊    return this.users.filter(user => this.recipientIds.includes(user.id));\n+┊  ┊51┊  }\n+┊  ┊52┊\n+┊  ┊53┊  addGroup(groupName: string) {\n+┊  ┊54┊    if (groupName && this.recipientIds.length) {\n+┊  ┊55┊      this.chatsService.addGroup(this.recipientIds, groupName).subscribe(({data: {addGroup: {id}}}: { data: AddGroup.Mutation }) => {\n+┊  ┊56┊        this.router.navigate(['/chat', id]);\n+┊  ┊57┊      });\n+┊  ┊58┊    }\n+┊  ┊59┊  }\n+┊  ┊60┊}\n```\n\n[}]: #\n\nAnd after, a new chat view:\n\nsrc/app/chats-creation/containers/new-chat/new-chat.component.scss, src/app/chats-creation/containers/new-chat/new-chat.component.ts\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/app/app.module.ts, src/app/chats-creation, src/app/services\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n##### Changed src&#x2F;app&#x2F;app.module.ts\n```diff\n@@ -7,6 +7,7 @@\n ┊ 7┊ 7┊import {ChatsListerModule} from './chats-lister/chats-lister.module';\n ┊ 8┊ 8┊import {RouterModule, Routes} from '@angular/router';\n ┊ 9┊ 9┊import {ChatViewerModule} from './chat-viewer/chat-viewer.module';\n+┊  ┊10┊import {ChatsCreationModule} from './chats-creation/chats-creation.module';\n ┊10┊11┊const routes: Routes = [];\n ┊11┊12┊\n ┊12┊13┊@NgModule({\n```\n```diff\n@@ -22,6 +23,7 @@\n ┊22┊23┊    // Feature modules\n ┊23┊24┊    ChatsListerModule,\n ┊24┊25┊    ChatViewerModule,\n+┊  ┊26┊    ChatsCreationModule,\n ┊25┊27┊  ],\n ┊26┊28┊  providers: [],\n ┊27┊29┊  bootstrap: [AppComponent]\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;chats-creation.module.ts\n```diff\n@@ -0,0 +1,60 @@\n+┊  ┊ 1┊import { BrowserModule } from '@angular/platform-browser';\n+┊  ┊ 2┊import { NgModule } from '@angular/core';\n+┊  ┊ 3┊\n+┊  ┊ 4┊import {BrowserAnimationsModule} from '@angular/platform-browser/animations';\n+┊  ┊ 5┊import {\n+┊  ┊ 6┊  MatButtonModule, MatFormFieldModule, MatGridListModule, MatIconModule, MatInputModule, MatListModule, MatMenuModule,\n+┊  ┊ 7┊  MatToolbarModule\n+┊  ┊ 8┊} from '@angular/material';\n+┊  ┊ 9┊import {RouterModule, Routes} from '@angular/router';\n+┊  ┊10┊import {FormsModule} from '@angular/forms';\n+┊  ┊11┊import {ChatsService} from '../services/chats.service';\n+┊  ┊12┊import {UserItemComponent} from './components/user-item/user-item.component';\n+┊  ┊13┊import {UsersListComponent} from './components/users-list/users-list.component';\n+┊  ┊14┊import {NewGroupComponent} from './containers/new-group/new-group.component';\n+┊  ┊15┊import {NewChatComponent} from './containers/new-chat/new-chat.component';\n+┊  ┊16┊import {NewGroupDetailsComponent} from './components/new-group-details/new-group-details.component';\n+┊  ┊17┊import {SharedModule} from '../shared/shared.module';\n+┊  ┊18┊import {NgxSelectableListModule} from 'ngx-selectable-list';\n+┊  ┊19┊\n+┊  ┊20┊const routes: Routes = [\n+┊  ┊21┊  {path: 'new-chat', component: NewChatComponent},\n+┊  ┊22┊  {path: 'new-group', component: NewGroupComponent},\n+┊  ┊23┊];\n+┊  ┊24┊\n+┊  ┊25┊@NgModule({\n+┊  ┊26┊  declarations: [\n+┊  ┊27┊    NewChatComponent,\n+┊  ┊28┊    UsersListComponent,\n+┊  ┊29┊    NewGroupComponent,\n+┊  ┊30┊    UserItemComponent,\n+┊  ┊31┊    NewGroupDetailsComponent,\n+┊  ┊32┊  ],\n+┊  ┊33┊  imports: [\n+┊  ┊34┊    BrowserModule,\n+┊  ┊35┊    // Animations (for Material)\n+┊  ┊36┊    BrowserAnimationsModule,\n+┊  ┊37┊    // Material\n+┊  ┊38┊    MatToolbarModule,\n+┊  ┊39┊    MatMenuModule,\n+┊  ┊40┊    MatIconModule,\n+┊  ┊41┊    MatButtonModule,\n+┊  ┊42┊    MatListModule,\n+┊  ┊43┊    MatGridListModule,\n+┊  ┊44┊    MatInputModule,\n+┊  ┊45┊    MatFormFieldModule,\n+┊  ┊46┊    MatGridListModule,\n+┊  ┊47┊    // Routing\n+┊  ┊48┊    RouterModule.forChild(routes),\n+┊  ┊49┊    // Forms\n+┊  ┊50┊    FormsModule,\n+┊  ┊51┊    // Feature modules\n+┊  ┊52┊    NgxSelectableListModule,\n+┊  ┊53┊    SharedModule,\n+┊  ┊54┊  ],\n+┊  ┊55┊  providers: [\n+┊  ┊56┊    ChatsService,\n+┊  ┊57┊  ],\n+┊  ┊58┊})\n+┊  ┊59┊export class ChatsCreationModule {\n+┊  ┊60┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;new-group-details&#x2F;new-group-details.component.scss\n```diff\n@@ -0,0 +1,25 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊}\n+┊  ┊ 4┊\n+┊  ┊ 5┊div {\n+┊  ┊ 6┊  padding: 16px;\n+┊  ┊ 7┊  mat-form-field {\n+┊  ┊ 8┊    width: 100%;\n+┊  ┊ 9┊  }\n+┊  ┊10┊}\n+┊  ┊11┊\n+┊  ┊12┊.new-group {\n+┊  ┊13┊  position: absolute;\n+┊  ┊14┊  bottom: 5vw;\n+┊  ┊15┊  right: 5vw;\n+┊  ┊16┊}\n+┊  ┊17┊\n+┊  ┊18┊.users {\n+┊  ┊19┊  display: flex;\n+┊  ┊20┊  flex-flow: row wrap;\n+┊  ┊21┊  img {\n+┊  ┊22┊    flex: 0 1 8vh;\n+┊  ┊23┊    height: 8vh;\n+┊  ┊24┊  }\n+┊  ┊25┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;new-group-details&#x2F;new-group-details.component.ts\n```diff\n@@ -0,0 +1,34 @@\n+┊  ┊ 1┊import {Component, EventEmitter, Input, Output} from '@angular/core';\n+┊  ┊ 2┊import {GetUsers} from '../../../../graphql';\n+┊  ┊ 3┊\n+┊  ┊ 4┊@Component({\n+┊  ┊ 5┊  selector: 'app-new-group-details',\n+┊  ┊ 6┊  template: `\n+┊  ┊ 7┊    <div>\n+┊  ┊ 8┊      <mat-form-field>\n+┊  ┊ 9┊        <input matInput placeholder=\"Group name\" [(ngModel)]=\"groupName\">\n+┊  ┊10┊      </mat-form-field>\n+┊  ┊11┊    </div>\n+┊  ┊12┊    <button [disabled]=\"!groupName\" class=\"new-group\" mat-fab color=\"primary\" (click)=\"emitGroupDetails()\">\n+┊  ┊13┊      <mat-icon aria-label=\"Icon-button with a + icon\">arrow_forward</mat-icon>\n+┊  ┊14┊    </button>\n+┊  ┊15┊    <div>Members</div>\n+┊  ┊16┊    <div class=\"users\">\n+┊  ┊17┊      <img *ngFor=\"let user of users;\" [src]=\"user.picture\"/>\n+┊  ┊18┊    </div>\n+┊  ┊19┊  `,\n+┊  ┊20┊  styleUrls: ['new-group-details.component.scss'],\n+┊  ┊21┊})\n+┊  ┊22┊export class NewGroupDetailsComponent {\n+┊  ┊23┊  groupName: string;\n+┊  ┊24┊  @Input()\n+┊  ┊25┊  users: GetUsers.Users[];\n+┊  ┊26┊  @Output()\n+┊  ┊27┊  groupDetails = new EventEmitter<string>();\n+┊  ┊28┊\n+┊  ┊29┊  emitGroupDetails() {\n+┊  ┊30┊    if (this.groupDetails) {\n+┊  ┊31┊      this.groupDetails.emit(this.groupName);\n+┊  ┊32┊    }\n+┊  ┊33┊  }\n+┊  ┊34┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;user-item&#x2F;user-item.component.scss\n```diff\n@@ -0,0 +1,32 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊  width: 100%;\n+┊  ┊ 4┊  height: 100%;\n+┊  ┊ 5┊}\n+┊  ┊ 6┊\n+┊  ┊ 7┊button {\n+┊  ┊ 8┊  margin: 10px;\n+┊  ┊ 9┊  height: 50px;\n+┊  ┊10┊  padding: 1px 6px;\n+┊  ┊11┊  line-height: 50px;\n+┊  ┊12┊  border: none;\n+┊  ┊13┊  margin: 0;\n+┊  ┊14┊\n+┊  ┊15┊  img {\n+┊  ┊16┊    float: left;\n+┊  ┊17┊    margin-right: 10px;\n+┊  ┊18┊    height: 50px;\n+┊  ┊19┊    width: 50px;\n+┊  ┊20┊    text-align: center;\n+┊  ┊21┊    line-height: inherit;\n+┊  ┊22┊    border-radius: 50%;\n+┊  ┊23┊  }\n+┊  ┊24┊\n+┊  ┊25┊  div {\n+┊  ┊26┊    float: left;\n+┊  ┊27┊    line-height: inherit;\n+┊  ┊28┊    font-family: Roboto, \"Helvetica Neue\", sans-serif;\n+┊  ┊29┊    font-weight: bold;\n+┊  ┊30┊    font-size: 16px;\n+┊  ┊31┊  }\n+┊  ┊32┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;user-item&#x2F;user-item.component.ts\n```diff\n@@ -0,0 +1,18 @@\n+┊  ┊ 1┊import {Component, Input} from '@angular/core';\n+┊  ┊ 2┊import {GetUsers} from '../../../../graphql';\n+┊  ┊ 3┊\n+┊  ┊ 4┊@Component({\n+┊  ┊ 5┊  selector: 'app-user-item',\n+┊  ┊ 6┊  template: `\n+┊  ┊ 7┊    <button mat-menu-item>\n+┊  ┊ 8┊      <img [src]=\"user.picture || 'assets/default-profile-pic.jpg'\">\n+┊  ┊ 9┊      <div>{{ user.name }}</div>\n+┊  ┊10┊    </button>\n+┊  ┊11┊  `,\n+┊  ┊12┊  styleUrls: ['user-item.component.scss']\n+┊  ┊13┊})\n+┊  ┊14┊export class UserItemComponent {\n+┊  ┊15┊  // tslint:disable-next-line:no-input-rename\n+┊  ┊16┊  @Input('item')\n+┊  ┊17┊  user: GetUsers.Users;\n+┊  ┊18┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;users-list&#x2F;users-list.component.scss\n```diff\n@@ -0,0 +1,13 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊}\n+┊  ┊ 4┊\n+┊  ┊ 5┊:host ::ng-deep mat-list-item:first-child div:first-child {\n+┊  ┊ 6┊  padding: 0 !important;\n+┊  ┊ 7┊  margin: 5px;\n+┊  ┊ 8┊  margin-top: 20px;\n+┊  ┊ 9┊}\n+┊  ┊10┊\n+┊  ┊11┊mat-list {\n+┊  ┊12┊  padding: 0;\n+┊  ┊13┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;users-list&#x2F;users-list.component.ts\n```diff\n@@ -0,0 +1,24 @@\n+┊  ┊ 1┊import {Component, Input} from '@angular/core';\n+┊  ┊ 2┊import {GetUsers} from '../../../../graphql';\n+┊  ┊ 3┊import {SelectableListDirective} from 'ngx-selectable-list';\n+┊  ┊ 4┊\n+┊  ┊ 5┊@Component({\n+┊  ┊ 6┊  selector: 'app-users-list',\n+┊  ┊ 7┊  template: `\n+┊  ┊ 8┊    <mat-list>\n+┊  ┊ 9┊      <mat-list-item *ngFor=\"let user of users\">\n+┊  ┊10┊        <app-user-item [item]=\"user\"\n+┊  ┊11┊                       libSelectableItem></app-user-item>\n+┊  ┊12┊      </mat-list-item>\n+┊  ┊13┊    </mat-list>\n+┊  ┊14┊    <ng-content *ngIf=\"selectableListDirective.selecting\"></ng-content>\n+┊  ┊15┊  `,\n+┊  ┊16┊  styleUrls: ['users-list.component.scss'],\n+┊  ┊17┊})\n+┊  ┊18┊export class UsersListComponent {\n+┊  ┊19┊  // tslint:disable-next-line:no-input-rename\n+┊  ┊20┊  @Input('items')\n+┊  ┊21┊  users: GetUsers.Users[];\n+┊  ┊22┊\n+┊  ┊23┊  constructor(public selectableListDirective: SelectableListDirective) {}\n+┊  ┊24┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-chat&#x2F;new-chat.component.scss\n```diff\n@@ -0,0 +1,23 @@\n+┊  ┊ 1┊.new-group {\n+┊  ┊ 2┊  margin: 10px;\n+┊  ┊ 3┊  height: 50px;\n+┊  ┊ 4┊  line-height: 50px;\n+┊  ┊ 5┊  margin-top: 20px;\n+┊  ┊ 6┊\n+┊  ┊ 7┊  mat-icon {\n+┊  ┊ 8┊    float: left;\n+┊  ┊ 9┊    margin-right: 10px;\n+┊  ┊10┊    height: 50px;\n+┊  ┊11┊    width: 50px;\n+┊  ┊12┊    text-align: center;\n+┊  ┊13┊    line-height: inherit;\n+┊  ┊14┊    border-radius: 50%;\n+┊  ┊15┊  }\n+┊  ┊16┊\n+┊  ┊17┊  div {\n+┊  ┊18┊    float: left;\n+┊  ┊19┊    line-height: inherit;\n+┊  ┊20┊    font-family: Roboto, \"Helvetica Neue\", sans-serif;\n+┊  ┊21┊    font-weight: bold;\n+┊  ┊22┊  }\n+┊  ┊23┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-chat&#x2F;new-chat.component.ts\n```diff\n@@ -0,0 +1,55 @@\n+┊  ┊ 1┊import {Component, OnInit} from '@angular/core';\n+┊  ┊ 2┊import {Location} from '@angular/common';\n+┊  ┊ 3┊import {Router} from '@angular/router';\n+┊  ┊ 4┊import {AddChat, GetUsers} from '../../../../graphql';\n+┊  ┊ 5┊import {ChatsService} from '../../../services/chats.service';\n+┊  ┊ 6┊\n+┊  ┊ 7┊@Component({\n+┊  ┊ 8┊  template: `\n+┊  ┊ 9┊    <app-toolbar>\n+┊  ┊10┊      <button class=\"navigation\" mat-button (click)=\"goBack()\">\n+┊  ┊11┊        <mat-icon aria-label=\"Icon-button with an arrow back icon\">arrow_back</mat-icon>\n+┊  ┊12┊      </button>\n+┊  ┊13┊      <div class=\"title\">New chat</div>\n+┊  ┊14┊    </app-toolbar>\n+┊  ┊15┊    <div class=\"new-group\" (click)=\"goToNewGroup()\">\n+┊  ┊16┊      <mat-icon color=\"secondary\" aria-label=\"Icon-button with a group add icon\">group_add</mat-icon>\n+┊  ┊17┊      <div>New group</div>\n+┊  ┊18┊    </div>\n+┊  ┊19┊    <app-users-list [items]=\"users\"\n+┊  ┊20┊                    libSelectableList=\"single\" (single)=\"addChat($event)\">\n+┊  ┊21┊    </app-users-list>\n+┊  ┊22┊  `,\n+┊  ┊23┊  styleUrls: ['new-chat.component.scss'],\n+┊  ┊24┊})\n+┊  ┊25┊export class NewChatComponent implements OnInit {\n+┊  ┊26┊  users: GetUsers.Users[];\n+┊  ┊27┊\n+┊  ┊28┊  constructor(private router: Router,\n+┊  ┊29┊              private location: Location,\n+┊  ┊30┊              private chatsService: ChatsService) {}\n+┊  ┊31┊\n+┊  ┊32┊  ngOnInit () {\n+┊  ┊33┊    this.chatsService.getUsers().users$.subscribe(users => this.users = users);\n+┊  ┊34┊  }\n+┊  ┊35┊\n+┊  ┊36┊  goBack() {\n+┊  ┊37┊    this.location.back();\n+┊  ┊38┊  }\n+┊  ┊39┊\n+┊  ┊40┊  goToNewGroup() {\n+┊  ┊41┊    this.router.navigate(['/new-group']);\n+┊  ┊42┊  }\n+┊  ┊43┊\n+┊  ┊44┊  addChat(recipientId: string) {\n+┊  ┊45┊    const chatId = this.chatsService.getChatId(recipientId);\n+┊  ┊46┊    if (chatId) {\n+┊  ┊47┊      // Chat is already listed for the current user\n+┊  ┊48┊      this.router.navigate(['/chat', chatId]);\n+┊  ┊49┊    } else {\n+┊  ┊50┊      this.chatsService.addChat(recipientId).subscribe(({data: {addChat: {id}}}: { data: AddChat.Mutation }) => {\n+┊  ┊51┊        this.router.navigate(['/chat', id]);\n+┊  ┊52┊      });\n+┊  ┊53┊    }\n+┊  ┊54┊  }\n+┊  ┊55┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-group&#x2F;new-group.component.scss\n\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-group&#x2F;new-group.component.ts\n```diff\n@@ -0,0 +1,60 @@\n+┊  ┊ 1┊import {Component, OnInit} from '@angular/core';\n+┊  ┊ 2┊import {Location} from '@angular/common';\n+┊  ┊ 3┊import {Router} from '@angular/router';\n+┊  ┊ 4┊import {AddGroup, GetUsers} from '../../../../graphql';\n+┊  ┊ 5┊import {ChatsService} from '../../../services/chats.service';\n+┊  ┊ 6┊\n+┊  ┊ 7┊@Component({\n+┊  ┊ 8┊  template: `\n+┊  ┊ 9┊    <app-toolbar>\n+┊  ┊10┊      <button class=\"navigation\" mat-button (click)=\"goBack()\">\n+┊  ┊11┊        <mat-icon aria-label=\"Icon-button with an arrow back icon\">arrow_back</mat-icon>\n+┊  ┊12┊      </button>\n+┊  ┊13┊      <div class=\"title\">New group</div>\n+┊  ┊14┊    </app-toolbar>\n+┊  ┊15┊\n+┊  ┊16┊    <app-users-list *ngIf=\"!recipientIds.length\" [items]=\"users\"\n+┊  ┊17┊                    libSelectableList=\"multiple_tap\" (multiple)=\"selectUsers($event)\">\n+┊  ┊18┊      <app-confirm-selection #confirmSelection icon=\"arrow_forward\"></app-confirm-selection>\n+┊  ┊19┊    </app-users-list>\n+┊  ┊20┊    <app-new-group-details *ngIf=\"recipientIds.length\" [users]=\"getSelectedUsers()\"\n+┊  ┊21┊                           (groupDetails)=\"addGroup($event)\"></app-new-group-details>\n+┊  ┊22┊  `,\n+┊  ┊23┊  styleUrls: ['new-group.component.scss'],\n+┊  ┊24┊})\n+┊  ┊25┊export class NewGroupComponent implements OnInit {\n+┊  ┊26┊  users: GetUsers.Users[];\n+┊  ┊27┊  recipientIds: string[] = [];\n+┊  ┊28┊\n+┊  ┊29┊  constructor(private router: Router,\n+┊  ┊30┊              private location: Location,\n+┊  ┊31┊              private chatsService: ChatsService) {}\n+┊  ┊32┊\n+┊  ┊33┊  ngOnInit () {\n+┊  ┊34┊    this.chatsService.getUsers().users$.subscribe(users => this.users = users);\n+┊  ┊35┊  }\n+┊  ┊36┊\n+┊  ┊37┊  goBack() {\n+┊  ┊38┊    if (this.recipientIds.length) {\n+┊  ┊39┊      this.recipientIds = [];\n+┊  ┊40┊    } else {\n+┊  ┊41┊      this.location.back();\n+┊  ┊42┊    }\n+┊  ┊43┊  }\n+┊  ┊44┊\n+┊  ┊45┊  selectUsers(recipientIds: string[]) {\n+┊  ┊46┊    this.recipientIds = recipientIds;\n+┊  ┊47┊  }\n+┊  ┊48┊\n+┊  ┊49┊  getSelectedUsers() {\n+┊  ┊50┊    return this.users.filter(user => this.recipientIds.includes(user.id));\n+┊  ┊51┊  }\n+┊  ┊52┊\n+┊  ┊53┊  addGroup(groupName: string) {\n+┊  ┊54┊    if (groupName && this.recipientIds.length) {\n+┊  ┊55┊      this.chatsService.addGroup(this.recipientIds, groupName).subscribe(({data: {addGroup: {id}}}: { data: AddGroup.Mutation }) => {\n+┊  ┊56┊        this.router.navigate(['/chat', id]);\n+┊  ┊57┊      });\n+┊  ┊58┊    }\n+┊  ┊59┊  }\n+┊  ┊60┊}\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,5 +1,7 @@\n ┊1┊1┊import {map} from 'rxjs/operators';\n ┊2┊2┊import {Injectable} from '@angular/core';\n+┊ ┊3┊import {Observable} from 'rxjs';\n+┊ ┊4┊import {QueryRef} from 'apollo-angular';\n ┊3┊5┊import {\n ┊4┊6┊  GetChatsGQL,\n ┊5┊7┊  GetChatGQL,\n```\n```diff\n@@ -7,6 +9,9 @@\n ┊ 7┊ 9┊  RemoveChatGQL,\n ┊ 8┊10┊  RemoveMessagesGQL,\n ┊ 9┊11┊  RemoveAllMessagesGQL,\n+┊  ┊12┊  GetUsersGQL,\n+┊  ┊13┊  AddChatGQL,\n+┊  ┊14┊  AddGroupGQL,\n ┊10┊15┊  AddMessage,\n ┊11┊16┊  GetChats,\n ┊12┊17┊  GetChat,\n```\n```diff\n@@ -15,9 +20,14 @@\n ┊15┊20┊} from '../../graphql';\n ┊16┊21┊import { DataProxy } from 'apollo-cache';\n ┊17┊22┊\n+┊  ┊23┊const currentUserId = '1';\n+┊  ┊24┊\n ┊18┊25┊@Injectable()\n ┊19┊26┊export class ChatsService {\n ┊20┊27┊  messagesAmount = 3;\n+┊  ┊28┊  getChatsWq: QueryRef<GetChats.Query, GetChats.Variables>;\n+┊  ┊29┊  chats$: Observable<GetChats.Chats[]>;\n+┊  ┊30┊  chats: GetChats.Chats[];\n ┊21┊31┊\n ┊22┊32┊  constructor(\n ┊23┊33┊    private getChatsGQL: GetChatsGQL,\n```\n```diff\n@@ -26,17 +36,21 @@\n ┊26┊36┊    private removeChatGQL: RemoveChatGQL,\n ┊27┊37┊    private removeMessagesGQL: RemoveMessagesGQL,\n ┊28┊38┊    private removeAllMessagesGQL: RemoveAllMessagesGQL,\n-┊29┊  ┊  ) {}\n-┊30┊  ┊\n-┊31┊  ┊  getChats() {\n-┊32┊  ┊    const query = this.getChatsGQL.watch({\n+┊  ┊39┊    private getUsersGQL: GetUsersGQL,\n+┊  ┊40┊    private addChatGQL: AddChatGQL,\n+┊  ┊41┊    private addGroupGQL: AddGroupGQL\n+┊  ┊42┊  ) {\n+┊  ┊43┊    this.getChatsWq = this.getChatsGQL.watch({\n ┊33┊44┊      amount: this.messagesAmount,\n ┊34┊45┊    });\n-┊35┊  ┊    const chats$ = query.valueChanges.pipe(\n+┊  ┊46┊    this.chats$ = this.getChatsWq.valueChanges.pipe(\n ┊36┊47┊      map((result) => result.data.chats)\n ┊37┊48┊    );\n+┊  ┊49┊    this.chats$.subscribe(chats => this.chats = chats);\n+┊  ┊50┊  }\n ┊38┊51┊\n-┊39┊  ┊    return {query, chats$};\n+┊  ┊52┊  getChats() {\n+┊  ┊53┊    return {query: this.getChatsWq, chats$: this.chats$};\n ┊40┊54┊  }\n ┊41┊55┊\n ┊42┊56┊  getChat(chatId: string) {\n```\n```diff\n@@ -209,4 +223,83 @@\n ┊209┊223┊      }, options);\n ┊210┊224┊    }\n ┊211┊225┊  }\n+┊   ┊226┊\n+┊   ┊227┊  getUsers() {\n+┊   ┊228┊    const query = this.getUsersGQL.watch();\n+┊   ┊229┊    const users$ = query.valueChanges.pipe(\n+┊   ┊230┊      map((result) => result.data.users)\n+┊   ┊231┊    );\n+┊   ┊232┊\n+┊   ┊233┊    return {query, users$};\n+┊   ┊234┊  }\n+┊   ┊235┊\n+┊   ┊236┊  // Checks if the chat is listed for the current user and returns the id\n+┊   ┊237┊  getChatId(recipientId: string) {\n+┊   ┊238┊    const _chat = this.chats.find(chat => {\n+┊   ┊239┊      return !chat.isGroup && !!chat.allTimeMembers.find(user => user.id === currentUserId) &&\n+┊   ┊240┊        !!chat.allTimeMembers.find(user => user.id === recipientId);\n+┊   ┊241┊    });\n+┊   ┊242┊    return _chat ? _chat.id : false;\n+┊   ┊243┊  }\n+┊   ┊244┊\n+┊   ┊245┊  addChat(recipientId: string) {\n+┊   ┊246┊    return this.addChatGQL.mutate(\n+┊   ┊247┊      {\n+┊   ┊248┊        recipientId,\n+┊   ┊249┊      }, {\n+┊   ┊250┊        update: (store, { data: { addChat } }) => {\n+┊   ┊251┊          // Read the data from our cache for this query.\n+┊   ┊252┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊253┊            query: this.getChatsGQL.document,\n+┊   ┊254┊            variables: {\n+┊   ┊255┊              amount: this.messagesAmount,\n+┊   ┊256┊            },\n+┊   ┊257┊          });\n+┊   ┊258┊          // Add our comment from the mutation to the end.\n+┊   ┊259┊          chats.push(addChat);\n+┊   ┊260┊          // Write our data back to the cache.\n+┊   ┊261┊          store.writeQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊262┊            query: this.getChatsGQL.document,\n+┊   ┊263┊            variables: {\n+┊   ┊264┊              amount: this.messagesAmount,\n+┊   ┊265┊            },\n+┊   ┊266┊            data: {\n+┊   ┊267┊              chats,\n+┊   ┊268┊            },\n+┊   ┊269┊          });\n+┊   ┊270┊        },\n+┊   ┊271┊      }\n+┊   ┊272┊    );\n+┊   ┊273┊  }\n+┊   ┊274┊\n+┊   ┊275┊  addGroup(recipientIds: string[], groupName: string) {\n+┊   ┊276┊    return this.addGroupGQL.mutate(\n+┊   ┊277┊      {\n+┊   ┊278┊        recipientIds,\n+┊   ┊279┊        groupName,\n+┊   ┊280┊      }, {\n+┊   ┊281┊        update: (store, { data: { addGroup } }) => {\n+┊   ┊282┊          // Read the data from our cache for this query.\n+┊   ┊283┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊284┊            query: this.getChatsGQL.document,\n+┊   ┊285┊            variables: {\n+┊   ┊286┊              amount: this.messagesAmount,\n+┊   ┊287┊            },\n+┊   ┊288┊          });\n+┊   ┊289┊          // Add our comment from the mutation to the end.\n+┊   ┊290┊          chats.push(addGroup);\n+┊   ┊291┊          // Write our data back to the cache.\n+┊   ┊292┊          store.writeQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊293┊            query: this.getChatsGQL.document,\n+┊   ┊294┊            variables: {\n+┊   ┊295┊              amount: this.messagesAmount,\n+┊   ┊296┊            },\n+┊   ┊297┊            data: {\n+┊   ┊298┊              chats,\n+┊   ┊299┊            },\n+┊   ┊300┊          });\n+┊   ┊301┊        },\n+┊   ┊302┊      }\n+┊   ┊303┊    );\n+┊   ┊304┊  }\n ┊212┊305┊}\n```\n\n[}]: #\n\nThey're both missing few components:\n\n**UsersList**\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/app/chats-creation/components/users-list/users-list.component.ts, src/app/chats-creation/components/users-list/users-list.component.scss\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;users-list&#x2F;users-list.component.scss\n```diff\n@@ -0,0 +1,13 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊}\n+┊  ┊ 4┊\n+┊  ┊ 5┊:host ::ng-deep mat-list-item:first-child div:first-child {\n+┊  ┊ 6┊  padding: 0 !important;\n+┊  ┊ 7┊  margin: 5px;\n+┊  ┊ 8┊  margin-top: 20px;\n+┊  ┊ 9┊}\n+┊  ┊10┊\n+┊  ┊11┊mat-list {\n+┊  ┊12┊  padding: 0;\n+┊  ┊13┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;users-list&#x2F;users-list.component.ts\n```diff\n@@ -0,0 +1,24 @@\n+┊  ┊ 1┊import {Component, Input} from '@angular/core';\n+┊  ┊ 2┊import {GetUsers} from '../../../../graphql';\n+┊  ┊ 3┊import {SelectableListDirective} from 'ngx-selectable-list';\n+┊  ┊ 4┊\n+┊  ┊ 5┊@Component({\n+┊  ┊ 6┊  selector: 'app-users-list',\n+┊  ┊ 7┊  template: `\n+┊  ┊ 8┊    <mat-list>\n+┊  ┊ 9┊      <mat-list-item *ngFor=\"let user of users\">\n+┊  ┊10┊        <app-user-item [item]=\"user\"\n+┊  ┊11┊                       libSelectableItem></app-user-item>\n+┊  ┊12┊      </mat-list-item>\n+┊  ┊13┊    </mat-list>\n+┊  ┊14┊    <ng-content *ngIf=\"selectableListDirective.selecting\"></ng-content>\n+┊  ┊15┊  `,\n+┊  ┊16┊  styleUrls: ['users-list.component.scss'],\n+┊  ┊17┊})\n+┊  ┊18┊export class UsersListComponent {\n+┊  ┊19┊  // tslint:disable-next-line:no-input-rename\n+┊  ┊20┊  @Input('items')\n+┊  ┊21┊  users: GetUsers.Users[];\n+┊  ┊22┊\n+┊  ┊23┊  constructor(public selectableListDirective: SelectableListDirective) {}\n+┊  ┊24┊}\n```\n\n[}]: #\n\n**UserItem**\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/app/chats-creation/components/user-item/user-item.component.ts, src/app/chats-creation/components/user-item/user-item.component.scss\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;user-item&#x2F;user-item.component.scss\n```diff\n@@ -0,0 +1,32 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊  width: 100%;\n+┊  ┊ 4┊  height: 100%;\n+┊  ┊ 5┊}\n+┊  ┊ 6┊\n+┊  ┊ 7┊button {\n+┊  ┊ 8┊  margin: 10px;\n+┊  ┊ 9┊  height: 50px;\n+┊  ┊10┊  padding: 1px 6px;\n+┊  ┊11┊  line-height: 50px;\n+┊  ┊12┊  border: none;\n+┊  ┊13┊  margin: 0;\n+┊  ┊14┊\n+┊  ┊15┊  img {\n+┊  ┊16┊    float: left;\n+┊  ┊17┊    margin-right: 10px;\n+┊  ┊18┊    height: 50px;\n+┊  ┊19┊    width: 50px;\n+┊  ┊20┊    text-align: center;\n+┊  ┊21┊    line-height: inherit;\n+┊  ┊22┊    border-radius: 50%;\n+┊  ┊23┊  }\n+┊  ┊24┊\n+┊  ┊25┊  div {\n+┊  ┊26┊    float: left;\n+┊  ┊27┊    line-height: inherit;\n+┊  ┊28┊    font-family: Roboto, \"Helvetica Neue\", sans-serif;\n+┊  ┊29┊    font-weight: bold;\n+┊  ┊30┊    font-size: 16px;\n+┊  ┊31┊  }\n+┊  ┊32┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;user-item&#x2F;user-item.component.ts\n```diff\n@@ -0,0 +1,18 @@\n+┊  ┊ 1┊import {Component, Input} from '@angular/core';\n+┊  ┊ 2┊import {GetUsers} from '../../../../graphql';\n+┊  ┊ 3┊\n+┊  ┊ 4┊@Component({\n+┊  ┊ 5┊  selector: 'app-user-item',\n+┊  ┊ 6┊  template: `\n+┊  ┊ 7┊    <button mat-menu-item>\n+┊  ┊ 8┊      <img [src]=\"user.picture || 'assets/default-profile-pic.jpg'\">\n+┊  ┊ 9┊      <div>{{ user.name }}</div>\n+┊  ┊10┊    </button>\n+┊  ┊11┊  `,\n+┊  ┊12┊  styleUrls: ['user-item.component.scss']\n+┊  ┊13┊})\n+┊  ┊14┊export class UserItemComponent {\n+┊  ┊15┊  // tslint:disable-next-line:no-input-rename\n+┊  ┊16┊  @Input('item')\n+┊  ┊17┊  user: GetUsers.Users;\n+┊  ┊18┊}\n```\n\n[}]: #\n\n**NewGroupDetails**\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/app/chats-creation/components/new-group-details/new-group-details.component.ts, src/app/chats-creation/components/new-group-details/new-group-details.component.scss\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;new-group-details&#x2F;new-group-details.component.scss\n```diff\n@@ -0,0 +1,25 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊}\n+┊  ┊ 4┊\n+┊  ┊ 5┊div {\n+┊  ┊ 6┊  padding: 16px;\n+┊  ┊ 7┊  mat-form-field {\n+┊  ┊ 8┊    width: 100%;\n+┊  ┊ 9┊  }\n+┊  ┊10┊}\n+┊  ┊11┊\n+┊  ┊12┊.new-group {\n+┊  ┊13┊  position: absolute;\n+┊  ┊14┊  bottom: 5vw;\n+┊  ┊15┊  right: 5vw;\n+┊  ┊16┊}\n+┊  ┊17┊\n+┊  ┊18┊.users {\n+┊  ┊19┊  display: flex;\n+┊  ┊20┊  flex-flow: row wrap;\n+┊  ┊21┊  img {\n+┊  ┊22┊    flex: 0 1 8vh;\n+┊  ┊23┊    height: 8vh;\n+┊  ┊24┊  }\n+┊  ┊25┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;new-group-details&#x2F;new-group-details.component.ts\n```diff\n@@ -0,0 +1,34 @@\n+┊  ┊ 1┊import {Component, EventEmitter, Input, Output} from '@angular/core';\n+┊  ┊ 2┊import {GetUsers} from '../../../../graphql';\n+┊  ┊ 3┊\n+┊  ┊ 4┊@Component({\n+┊  ┊ 5┊  selector: 'app-new-group-details',\n+┊  ┊ 6┊  template: `\n+┊  ┊ 7┊    <div>\n+┊  ┊ 8┊      <mat-form-field>\n+┊  ┊ 9┊        <input matInput placeholder=\"Group name\" [(ngModel)]=\"groupName\">\n+┊  ┊10┊      </mat-form-field>\n+┊  ┊11┊    </div>\n+┊  ┊12┊    <button [disabled]=\"!groupName\" class=\"new-group\" mat-fab color=\"primary\" (click)=\"emitGroupDetails()\">\n+┊  ┊13┊      <mat-icon aria-label=\"Icon-button with a + icon\">arrow_forward</mat-icon>\n+┊  ┊14┊    </button>\n+┊  ┊15┊    <div>Members</div>\n+┊  ┊16┊    <div class=\"users\">\n+┊  ┊17┊      <img *ngFor=\"let user of users;\" [src]=\"user.picture\"/>\n+┊  ┊18┊    </div>\n+┊  ┊19┊  `,\n+┊  ┊20┊  styleUrls: ['new-group-details.component.scss'],\n+┊  ┊21┊})\n+┊  ┊22┊export class NewGroupDetailsComponent {\n+┊  ┊23┊  groupName: string;\n+┊  ┊24┊  @Input()\n+┊  ┊25┊  users: GetUsers.Users[];\n+┊  ┊26┊  @Output()\n+┊  ┊27┊  groupDetails = new EventEmitter<string>();\n+┊  ┊28┊\n+┊  ┊29┊  emitGroupDetails() {\n+┊  ┊30┊    if (this.groupDetails) {\n+┊  ┊31┊      this.groupDetails.emit(this.groupName);\n+┊  ┊32┊    }\n+┊  ┊33┊  }\n+┊  ┊34┊}\n```\n\n[}]: #\n\nWith all that, we can now link NewChat component with Chat container:\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/app/chats-lister/containers/chats/chats.component.ts, src/app/chat-viewer/containers/chat/chat.component.spec.ts\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.spec.ts\n```diff\n@@ -143,7 +143,9 @@\n ┊143┊143┊    component = fixture.componentInstance;\n ┊144┊144┊    fixture.detectChanges();\n ┊145┊145┊\n-┊146┊   ┊    const req = controller.expectOne('GetChat', 'call to api');\n+┊   ┊146┊    controller.expectOne('GetChats', 'call to getChats api');\n+┊   ┊147┊\n+┊   ┊148┊    const req = controller.expectOne('GetChat', 'call to getChat api');\n ┊147┊149┊\n ┊148┊150┊    req.flush({\n ┊149┊151┊      data: {\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.ts\n```diff\n@@ -34,7 +34,7 @@\n ┊34┊34┊      <app-confirm-selection #confirmSelection></app-confirm-selection>\n ┊35┊35┊    </app-chats-list>\n ┊36┊36┊\n-┊37┊  ┊    <button *ngIf=\"!isSelecting\" class=\"chat-button\" mat-fab color=\"secondary\">\n+┊  ┊37┊    <button *ngIf=\"!isSelecting\" class=\"chat-button\" mat-fab color=\"secondary\" (click)=\"goToNewChat()\">\n ┊38┊38┊      <mat-icon aria-label=\"Icon-button with a + icon\">chat</mat-icon>\n ┊39┊39┊    </button>\n ┊40┊40┊  `,\n```\n```diff\n@@ -56,6 +56,10 @@\n ┊56┊56┊    this.router.navigate(['/chat', chatId]);\n ┊57┊57┊  }\n ┊58┊58┊\n+┊  ┊59┊  goToNewChat() {\n+┊  ┊60┊    this.router.navigate(['/new-chat']);\n+┊  ┊61┊  }\n+┊  ┊62┊\n ┊59┊63┊  deleteChats(chatIds: string[]) {\n ┊60┊64┊    chatIds.forEach(chatId => {\n ┊61┊65┊      this.chatsService.removeChat(chatId).subscribe();\n```\n\n[}]: #\n\nNow let's wrap it all together within the `ChatsCreation` module:\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/app/chats-creation/chats-creation.module.ts, src/app/app.module.ts\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n##### Changed src&#x2F;app&#x2F;app.module.ts\n```diff\n@@ -7,6 +7,7 @@\n ┊ 7┊ 7┊import {ChatsListerModule} from './chats-lister/chats-lister.module';\n ┊ 8┊ 8┊import {RouterModule, Routes} from '@angular/router';\n ┊ 9┊ 9┊import {ChatViewerModule} from './chat-viewer/chat-viewer.module';\n+┊  ┊10┊import {ChatsCreationModule} from './chats-creation/chats-creation.module';\n ┊10┊11┊const routes: Routes = [];\n ┊11┊12┊\n ┊12┊13┊@NgModule({\n```\n```diff\n@@ -22,6 +23,7 @@\n ┊22┊23┊    // Feature modules\n ┊23┊24┊    ChatsListerModule,\n ┊24┊25┊    ChatViewerModule,\n+┊  ┊26┊    ChatsCreationModule,\n ┊25┊27┊  ],\n ┊26┊28┊  providers: [],\n ┊27┊29┊  bootstrap: [AppComponent]\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;chats-creation.module.ts\n```diff\n@@ -0,0 +1,60 @@\n+┊  ┊ 1┊import { BrowserModule } from '@angular/platform-browser';\n+┊  ┊ 2┊import { NgModule } from '@angular/core';\n+┊  ┊ 3┊\n+┊  ┊ 4┊import {BrowserAnimationsModule} from '@angular/platform-browser/animations';\n+┊  ┊ 5┊import {\n+┊  ┊ 6┊  MatButtonModule, MatFormFieldModule, MatGridListModule, MatIconModule, MatInputModule, MatListModule, MatMenuModule,\n+┊  ┊ 7┊  MatToolbarModule\n+┊  ┊ 8┊} from '@angular/material';\n+┊  ┊ 9┊import {RouterModule, Routes} from '@angular/router';\n+┊  ┊10┊import {FormsModule} from '@angular/forms';\n+┊  ┊11┊import {ChatsService} from '../services/chats.service';\n+┊  ┊12┊import {UserItemComponent} from './components/user-item/user-item.component';\n+┊  ┊13┊import {UsersListComponent} from './components/users-list/users-list.component';\n+┊  ┊14┊import {NewGroupComponent} from './containers/new-group/new-group.component';\n+┊  ┊15┊import {NewChatComponent} from './containers/new-chat/new-chat.component';\n+┊  ┊16┊import {NewGroupDetailsComponent} from './components/new-group-details/new-group-details.component';\n+┊  ┊17┊import {SharedModule} from '../shared/shared.module';\n+┊  ┊18┊import {NgxSelectableListModule} from 'ngx-selectable-list';\n+┊  ┊19┊\n+┊  ┊20┊const routes: Routes = [\n+┊  ┊21┊  {path: 'new-chat', component: NewChatComponent},\n+┊  ┊22┊  {path: 'new-group', component: NewGroupComponent},\n+┊  ┊23┊];\n+┊  ┊24┊\n+┊  ┊25┊@NgModule({\n+┊  ┊26┊  declarations: [\n+┊  ┊27┊    NewChatComponent,\n+┊  ┊28┊    UsersListComponent,\n+┊  ┊29┊    NewGroupComponent,\n+┊  ┊30┊    UserItemComponent,\n+┊  ┊31┊    NewGroupDetailsComponent,\n+┊  ┊32┊  ],\n+┊  ┊33┊  imports: [\n+┊  ┊34┊    BrowserModule,\n+┊  ┊35┊    // Animations (for Material)\n+┊  ┊36┊    BrowserAnimationsModule,\n+┊  ┊37┊    // Material\n+┊  ┊38┊    MatToolbarModule,\n+┊  ┊39┊    MatMenuModule,\n+┊  ┊40┊    MatIconModule,\n+┊  ┊41┊    MatButtonModule,\n+┊  ┊42┊    MatListModule,\n+┊  ┊43┊    MatGridListModule,\n+┊  ┊44┊    MatInputModule,\n+┊  ┊45┊    MatFormFieldModule,\n+┊  ┊46┊    MatGridListModule,\n+┊  ┊47┊    // Routing\n+┊  ┊48┊    RouterModule.forChild(routes),\n+┊  ┊49┊    // Forms\n+┊  ┊50┊    FormsModule,\n+┊  ┊51┊    // Feature modules\n+┊  ┊52┊    NgxSelectableListModule,\n+┊  ┊53┊    SharedModule,\n+┊  ┊54┊  ],\n+┊  ┊55┊  providers: [\n+┊  ┊56┊    ChatsService,\n+┊  ┊57┊  ],\n+┊  ┊58┊})\n+┊  ┊59┊export class ChatsCreationModule {\n+┊  ┊60┊}\n```\n\n[}]: #"
          },
          {
            "manualTitle": "Step 13: Zero latency on slow 3g networks",
            "stepRevision": "810cc1ec3030d51cec02928dfb862b0b3ed6df90",
            "manualView": "## Client\n\nNow let's start our client in production mode:\n\n    yarn start --prod\n\nNow open the **Chrome Developers Tools** and, in the **Network tab**, select `Slow 3G Network` and `Disable cache`.\nThen refresh the page and look at the `DOMContentLoaded` time and at the transferred size. You'll notice that our bundle size is quite small and so the loads time.\n\nNow let's click on a specific chat. It will take some time to load the data and then add a new message.\nOnce again it will take some time to load the data.\nWe could also create a new chat and the result would be the same.\nThe whole app doesn't feel as snappier as the real Whatsapp on a slow 3G Network.\n\n\"That's normal, it's a web application with a remote db while Whatsapp is a native app with a local database...\"\nThat's just an excuse, because we can do as good as Whatsapp thanks to Apollo!\n\nLet's install `moment`, we will soon need it:\n\n    yarn add moment\n\nStart by making our UI optimistic. We can predict most of the response we will get from our server, except for a few things like `id` of newly created messages. But since we don't really need that id, we can simply generate a fake one\nwhich will be later overridden once we get the response from the server:\n\n[{]: <helper> (diffStep \"9.1\" files=\"^\\(?!package.json$\\).*\" module=\"client\")\n\n#### [Step 9.1: Optimistic updates](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/39432fa)\n\n##### Changed src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-chat&#x2F;new-chat.component.ts\n```diff\n@@ -47,7 +47,7 @@\n ┊47┊47┊      // Chat is already listed for the current user\n ┊48┊48┊      this.router.navigate(['/chat', chatId]);\n ┊49┊49┊    } else {\n-┊50┊  ┊      this.chatsService.addChat(recipientId).subscribe(({data: {addChat: {id}}}: { data: AddChat.Mutation }) => {\n+┊  ┊50┊      this.chatsService.addChat(recipientId, this.users).subscribe(({data: {addChat: {id}}}: { data: AddChat.Mutation }) => {\n ┊51┊51┊        this.router.navigate(['/chat', id]);\n ┊52┊52┊      });\n ┊53┊53┊    }\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -2,6 +2,7 @@\n ┊2┊2┊import {Injectable} from '@angular/core';\n ┊3┊3┊import {Observable} from 'rxjs';\n ┊4┊4┊import {QueryRef} from 'apollo-angular';\n+┊ ┊5┊import * as moment from 'moment';\n ┊5┊6┊import {\n ┊6┊7┊  GetChatsGQL,\n ┊7┊8┊  GetChatGQL,\n```\n```diff\n@@ -17,10 +18,12 @@\n ┊17┊18┊  GetChat,\n ┊18┊19┊  RemoveMessages,\n ┊19┊20┊  RemoveAllMessages,\n+┊  ┊21┊  GetUsers,\n ┊20┊22┊} from '../../graphql';\n ┊21┊23┊import { DataProxy } from 'apollo-cache';\n ┊22┊24┊\n ┊23┊25┊const currentUserId = '1';\n+┊  ┊26┊const currentUserName = 'Ethan Gonzalez';\n ┊24┊27┊\n ┊25┊28┊@Injectable()\n ┊26┊29┊export class ChatsService {\n```\n```diff\n@@ -49,6 +52,10 @@\n ┊49┊52┊    this.chats$.subscribe(chats => this.chats = chats);\n ┊50┊53┊  }\n ┊51┊54┊\n+┊  ┊55┊  static getRandomId() {\n+┊  ┊56┊    return String(Math.round(Math.random() * 1000000000000));\n+┊  ┊57┊  }\n+┊  ┊58┊\n ┊52┊59┊  getChats() {\n ┊53┊60┊    return {query: this.getChatsWq, chats$: this.chats$};\n ┊54┊61┊  }\n```\n```diff\n@@ -70,6 +77,24 @@\n ┊ 70┊ 77┊      chatId,\n ┊ 71┊ 78┊      content,\n ┊ 72┊ 79┊    }, {\n+┊   ┊ 80┊      optimisticResponse: {\n+┊   ┊ 81┊        __typename: 'Mutation',\n+┊   ┊ 82┊        addMessage: {\n+┊   ┊ 83┊          id: ChatsService.getRandomId(),\n+┊   ┊ 84┊          __typename: 'Message',\n+┊   ┊ 85┊          senderId: currentUserId,\n+┊   ┊ 86┊          sender: {\n+┊   ┊ 87┊            id: currentUserId,\n+┊   ┊ 88┊            __typename: 'User',\n+┊   ┊ 89┊            name: currentUserName,\n+┊   ┊ 90┊          },\n+┊   ┊ 91┊          content,\n+┊   ┊ 92┊          createdAt: moment().unix(),\n+┊   ┊ 93┊          type: 0,\n+┊   ┊ 94┊          recipients: [],\n+┊   ┊ 95┊          ownership: true,\n+┊   ┊ 96┊        },\n+┊   ┊ 97┊      },\n ┊ 73┊ 98┊      update: (store, { data: { addMessage } }: {data: AddMessage.Mutation}) => {\n ┊ 74┊ 99┊        // Update the messages cache\n ┊ 75┊100┊        {\n```\n```diff\n@@ -121,6 +146,10 @@\n ┊121┊146┊      {\n ┊122┊147┊        chatId,\n ┊123┊148┊      }, {\n+┊   ┊149┊        optimisticResponse: {\n+┊   ┊150┊          __typename: 'Mutation',\n+┊   ┊151┊          removeChat: chatId,\n+┊   ┊152┊        },\n ┊124┊153┊        update: (store, { data: { removeChat } }) => {\n ┊125┊154┊          // Read the data from our cache for this query.\n ┊126┊155┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n```\n```diff\n@@ -154,6 +183,10 @@\n ┊154┊183┊    let ids: string[] = [];\n ┊155┊184┊\n ┊156┊185┊    const options = {\n+┊   ┊186┊      optimisticResponse: () => ({\n+┊   ┊187┊        __typename: 'Mutation',\n+┊   ┊188┊        removeMessages: ids,\n+┊   ┊189┊      }),\n ┊157┊190┊      update: (store: DataProxy, { data: { removeMessages } }: {data: RemoveMessages.Mutation | RemoveAllMessages.Mutation}) => {\n ┊158┊191┊        // Update the messages cache\n ┊159┊192┊        {\n```\n```diff\n@@ -242,11 +275,33 @@\n ┊242┊275┊    return _chat ? _chat.id : false;\n ┊243┊276┊  }\n ┊244┊277┊\n-┊245┊   ┊  addChat(recipientId: string) {\n+┊   ┊278┊  addChat(recipientId: string, users: GetUsers.Users[]) {\n ┊246┊279┊    return this.addChatGQL.mutate(\n ┊247┊280┊      {\n ┊248┊281┊        recipientId,\n ┊249┊282┊      }, {\n+┊   ┊283┊        optimisticResponse: {\n+┊   ┊284┊          __typename: 'Mutation',\n+┊   ┊285┊          addChat: {\n+┊   ┊286┊            id: ChatsService.getRandomId(),\n+┊   ┊287┊            __typename: 'Chat',\n+┊   ┊288┊            name: users.find(user => user.id === recipientId).name,\n+┊   ┊289┊            picture: users.find(user => user.id === recipientId).picture,\n+┊   ┊290┊            allTimeMembers: [\n+┊   ┊291┊              {\n+┊   ┊292┊                id: currentUserId,\n+┊   ┊293┊                __typename: 'User',\n+┊   ┊294┊              },\n+┊   ┊295┊              {\n+┊   ┊296┊                id: recipientId,\n+┊   ┊297┊                __typename: 'User',\n+┊   ┊298┊              }\n+┊   ┊299┊            ],\n+┊   ┊300┊            unreadMessages: 0,\n+┊   ┊301┊            messages: [],\n+┊   ┊302┊            isGroup: false,\n+┊   ┊303┊          },\n+┊   ┊304┊        },\n ┊250┊305┊        update: (store, { data: { addChat } }) => {\n ┊251┊306┊          // Read the data from our cache for this query.\n ┊252┊307┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n```\n```diff\n@@ -278,6 +333,26 @@\n ┊278┊333┊        recipientIds,\n ┊279┊334┊        groupName,\n ┊280┊335┊      }, {\n+┊   ┊336┊        optimisticResponse: {\n+┊   ┊337┊          __typename: 'Mutation',\n+┊   ┊338┊          addGroup: {\n+┊   ┊339┊            id: ChatsService.getRandomId(),\n+┊   ┊340┊            __typename: 'Chat',\n+┊   ┊341┊            name: groupName,\n+┊   ┊342┊            picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n+┊   ┊343┊            userIds: [currentUserId, recipientIds],\n+┊   ┊344┊            allTimeMembers: [\n+┊   ┊345┊              {\n+┊   ┊346┊                id: currentUserId,\n+┊   ┊347┊                __typename: 'User',\n+┊   ┊348┊              },\n+┊   ┊349┊              ...recipientIds.map(id => ({id, __typename: 'User'})),\n+┊   ┊350┊            ],\n+┊   ┊351┊            unreadMessages: 0,\n+┊   ┊352┊            messages: [],\n+┊   ┊353┊            isGroup: true,\n+┊   ┊354┊          },\n+┊   ┊355┊        },\n ┊281┊356┊        update: (store, { data: { addGroup } }) => {\n ┊282┊357┊          // Read the data from our cache for this query.\n ┊283┊358┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n```\n\n[}]: #\n\nWhen we open a specific chat we can also preload some data from our chats list cache while waiting for the server response. We will initially be able to show only the chat name, the last message or the last few messages and a few more informations instead of the whole content from the server, but that would be more than enough to entertain the user while waiting for the server response:\n\n[{]: <helper> (diffStep \"9.2\" module=\"client\")\n\n#### [Step 9.2: Get chat data from chats cache while waiting for server response](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/632468a)\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,6 +1,6 @@\n-┊1┊ ┊import {map} from 'rxjs/operators';\n+┊ ┊1┊import {concat, map} from 'rxjs/operators';\n ┊2┊2┊import {Injectable} from '@angular/core';\n-┊3┊ ┊import {Observable} from 'rxjs';\n+┊ ┊3┊import {Observable, AsyncSubject, of} from 'rxjs';\n ┊4┊4┊import {QueryRef} from 'apollo-angular';\n ┊5┊5┊import * as moment from 'moment';\n ┊6┊6┊import {\n```\n```diff\n@@ -31,6 +31,7 @@\n ┊31┊31┊  getChatsWq: QueryRef<GetChats.Query, GetChats.Variables>;\n ┊32┊32┊  chats$: Observable<GetChats.Chats[]>;\n ┊33┊33┊  chats: GetChats.Chats[];\n+┊  ┊34┊  getChatWqSubject: AsyncSubject<QueryRef<GetChat.Query>>;\n ┊34┊35┊\n ┊35┊36┊  constructor(\n ┊36┊37┊    private getChatsGQL: GetChatsGQL,\n```\n```diff\n@@ -61,15 +62,34 @@\n ┊61┊62┊  }\n ┊62┊63┊\n ┊63┊64┊  getChat(chatId: string) {\n+┊  ┊65┊    const _chat = this.chats && this.chats.find(chat => chat.id === chatId) || {\n+┊  ┊66┊      id: chatId,\n+┊  ┊67┊      name: '',\n+┊  ┊68┊      picture: null,\n+┊  ┊69┊      allTimeMembers: [],\n+┊  ┊70┊      unreadMessages: 0,\n+┊  ┊71┊      isGroup: false,\n+┊  ┊72┊      messages: [],\n+┊  ┊73┊    };\n+┊  ┊74┊    const chat$FromCache = of<GetChat.Chat>(_chat);\n+┊  ┊75┊\n ┊64┊76┊    const query = this.getChatGQL.watch({\n ┊65┊77┊      chatId: chatId,\n ┊66┊78┊    });\n ┊67┊79┊\n-┊68┊  ┊    const chat$ = query.valueChanges.pipe(\n-┊69┊  ┊      map((result) => result.data.chat)\n+┊  ┊80┊    const chat$ = chat$FromCache.pipe(\n+┊  ┊81┊      concat(\n+┊  ┊82┊        query.valueChanges.pipe(\n+┊  ┊83┊          map((result) => result.data.chat)\n+┊  ┊84┊        )\n+┊  ┊85┊      )\n ┊70┊86┊    );\n ┊71┊87┊\n-┊72┊  ┊    return {query, chat$};\n+┊  ┊88┊    this.getChatWqSubject = new AsyncSubject();\n+┊  ┊89┊    this.getChatWqSubject.next(query);\n+┊  ┊90┊    this.getChatWqSubject.complete();\n+┊  ┊91┊\n+┊  ┊92┊    return {query$: this.getChatWqSubject.asObservable(), chat$};\n ┊73┊93┊  }\n ┊74┊94┊\n ┊75┊95┊  addMessage(chatId: string, content: string) {\n```\n\n[}]: #\n\nNow let's deal with the most difficult part, chats creation.\n\nWe cannot predict the `id` of the new chat and so we cannot navigate to the chat page because it contains the chat id in the url. We could simply navigate to the \"optimistic\" id, but then the user wouldn't be able to reach that url if he refreshes the page or bookmarks it. That's a problem we care about.\n\nHow to solve it? We're going to create a landing page and we will later override the url once we get the response from the server!\n\n[{]: <helper> (diffStep \"9.3\" module=\"client\")\n\n#### [Step 9.3: Landing page for new chats/groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/87b9f5d)\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.spec.ts\n```diff\n@@ -129,7 +129,10 @@\n ┊129┊129┊        },\n ┊130┊130┊        {\n ┊131┊131┊          provide: ActivatedRoute,\n-┊132┊   ┊          useValue: { params: of({ id: chat.id }) },\n+┊   ┊132┊          useValue: {\n+┊   ┊133┊            params: of({ id: chat.id }),\n+┊   ┊134┊            queryParams: of({}),\n+┊   ┊135┊          },\n ┊133┊136┊        },\n ┊134┊137┊      ],\n ┊135┊138┊      schemas: [NO_ERRORS_SCHEMA],\n```\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.ts\n```diff\n@@ -2,6 +2,8 @@\n ┊2┊2┊import {ActivatedRoute, Router} from '@angular/router';\n ┊3┊3┊import {ChatsService} from '../../../services/chats.service';\n ┊4┊4┊import {GetChat} from '../../../../graphql';\n+┊ ┊5┊import {combineLatest} from 'rxjs';\n+┊ ┊6┊import {Location} from '@angular/common';\n ┊5┊7┊\n ┊6┊8┊@Component({\n ┊7┊9┊  template: `\n```\n```diff\n@@ -27,21 +29,40 @@\n ┊27┊29┊  messages: GetChat.Messages[];\n ┊28┊30┊  name: string;\n ┊29┊31┊  isGroup: boolean;\n+┊  ┊32┊  optimisticUI: boolean;\n ┊30┊33┊\n ┊31┊34┊  constructor(private route: ActivatedRoute,\n ┊32┊35┊              private router: Router,\n+┊  ┊36┊              private location: Location,\n ┊33┊37┊              private chatsService: ChatsService) {\n ┊34┊38┊  }\n ┊35┊39┊\n ┊36┊40┊  ngOnInit() {\n-┊37┊  ┊    this.route.params.subscribe(({id: chatId}) => {\n-┊38┊  ┊      this.chatId = chatId;\n-┊39┊  ┊      this.chatsService.getChat(chatId).chat$.subscribe(chat => {\n-┊40┊  ┊        this.messages = chat.messages;\n-┊41┊  ┊        this.name = chat.name;\n-┊42┊  ┊        this.isGroup = chat.isGroup;\n+┊  ┊41┊    combineLatest(this.route.params, this.route.queryParams,\n+┊  ┊42┊      (params: { id: string }, queryParams: { oui?: boolean }) => ({params, queryParams}))\n+┊  ┊43┊      .subscribe(({params: {id: chatId}, queryParams: {oui}}) => {\n+┊  ┊44┊        this.chatId = chatId;\n+┊  ┊45┊\n+┊  ┊46┊        this.optimisticUI = oui;\n+┊  ┊47┊\n+┊  ┊48┊        if (this.optimisticUI) {\n+┊  ┊49┊          // We are using fake IDs generated by the Optimistic UI\n+┊  ┊50┊          this.chatsService.addChat$.subscribe(({data: {addChat, addGroup}}) => {\n+┊  ┊51┊            this.chatId = addChat ? addChat.id : addGroup.id;\n+┊  ┊52┊            console.log(`Switching from the Optimistic UI id ${chatId} to ${this.chatId}`);\n+┊  ┊53┊            // Rewrite the URL\n+┊  ┊54┊            this.location.go(`chat/${this.chatId}`);\n+┊  ┊55┊            // Optimistic UI no more\n+┊  ┊56┊            this.optimisticUI = false;\n+┊  ┊57┊          });\n+┊  ┊58┊        }\n+┊  ┊59┊\n+┊  ┊60┊        this.chatsService.getChat(chatId, this.optimisticUI).chat$.subscribe(chat => {\n+┊  ┊61┊          this.messages = chat.messages;\n+┊  ┊62┊          this.name = chat.name;\n+┊  ┊63┊          this.isGroup = chat.isGroup;\n+┊  ┊64┊        });\n ┊43┊65┊      });\n-┊44┊  ┊    });\n ┊45┊66┊  }\n ┊46┊67┊\n ┊47┊68┊  goToChats() {\n```\n\n##### Changed src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-chat&#x2F;new-chat.component.ts\n```diff\n@@ -47,9 +47,10 @@\n ┊47┊47┊      // Chat is already listed for the current user\n ┊48┊48┊      this.router.navigate(['/chat', chatId]);\n ┊49┊49┊    } else {\n-┊50┊  ┊      this.chatsService.addChat(recipientId, this.users).subscribe(({data: {addChat: {id}}}: { data: AddChat.Mutation }) => {\n-┊51┊  ┊        this.router.navigate(['/chat', id]);\n-┊52┊  ┊      });\n+┊  ┊50┊      // Generate id for Optimistic UI\n+┊  ┊51┊      const ouiId = ChatsService.getRandomId();\n+┊  ┊52┊      this.chatsService.addChat(recipientId, this.users, ouiId).subscribe();\n+┊  ┊53┊      this.router.navigate(['/chat', ouiId], {queryParams: {oui: true}, skipLocationChange: true});\n ┊53┊54┊    }\n ┊54┊55┊  }\n ┊55┊56┊}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-group&#x2F;new-group.component.ts\n```diff\n@@ -52,9 +52,9 @@\n ┊52┊52┊\n ┊53┊53┊  addGroup(groupName: string) {\n ┊54┊54┊    if (groupName && this.recipientIds.length) {\n-┊55┊  ┊      this.chatsService.addGroup(this.recipientIds, groupName).subscribe(({data: {addGroup: {id}}}: { data: AddGroup.Mutation }) => {\n-┊56┊  ┊        this.router.navigate(['/chat', id]);\n-┊57┊  ┊      });\n+┊  ┊55┊      const ouiId = ChatsService.getRandomId();\n+┊  ┊56┊      this.chatsService.addGroup(this.recipientIds, groupName, ouiId).subscribe();\n+┊  ┊57┊      this.router.navigate(['/chat', ouiId], {queryParams: {oui: true}, skipLocationChange: true});\n ┊58┊58┊    }\n ┊59┊59┊  }\n ┊60┊60┊}\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,4 +1,4 @@\n-┊1┊ ┊import {concat, map} from 'rxjs/operators';\n+┊ ┊1┊import {concat, map, share, switchMap} from 'rxjs/operators';\n ┊2┊2┊import {Injectable} from '@angular/core';\n ┊3┊3┊import {Observable, AsyncSubject, of} from 'rxjs';\n ┊4┊4┊import {QueryRef} from 'apollo-angular';\n```\n```diff\n@@ -19,8 +19,11 @@\n ┊19┊19┊  RemoveMessages,\n ┊20┊20┊  RemoveAllMessages,\n ┊21┊21┊  GetUsers,\n+┊  ┊22┊  AddChat,\n+┊  ┊23┊  AddGroup,\n ┊22┊24┊} from '../../graphql';\n ┊23┊25┊import { DataProxy } from 'apollo-cache';\n+┊  ┊26┊import { FetchResult } from 'apollo-link';\n ┊24┊27┊\n ┊25┊28┊const currentUserId = '1';\n ┊26┊29┊const currentUserName = 'Ethan Gonzalez';\n```\n```diff\n@@ -32,6 +35,7 @@\n ┊32┊35┊  chats$: Observable<GetChats.Chats[]>;\n ┊33┊36┊  chats: GetChats.Chats[];\n ┊34┊37┊  getChatWqSubject: AsyncSubject<QueryRef<GetChat.Query>>;\n+┊  ┊38┊  addChat$: Observable<FetchResult<AddChat.Mutation | AddGroup.Mutation>>;\n ┊35┊39┊\n ┊36┊40┊  constructor(\n ┊37┊41┊    private getChatsGQL: GetChatsGQL,\n```\n```diff\n@@ -61,7 +65,7 @@\n ┊61┊65┊    return {query: this.getChatsWq, chats$: this.chats$};\n ┊62┊66┊  }\n ┊63┊67┊\n-┊64┊  ┊  getChat(chatId: string) {\n+┊  ┊68┊  getChat(chatId: string, oui?: boolean) {\n ┊65┊69┊    const _chat = this.chats && this.chats.find(chat => chat.id === chatId) || {\n ┊66┊70┊      id: chatId,\n ┊67┊71┊      name: '',\n```\n```diff\n@@ -73,21 +77,43 @@\n ┊ 73┊ 77┊    };\n ┊ 74┊ 78┊    const chat$FromCache = of<GetChat.Chat>(_chat);\n ┊ 75┊ 79┊\n-┊ 76┊   ┊    const query = this.getChatGQL.watch({\n-┊ 77┊   ┊      chatId: chatId,\n-┊ 78┊   ┊    });\n-┊ 79┊   ┊\n-┊ 80┊   ┊    const chat$ = chat$FromCache.pipe(\n-┊ 81┊   ┊      concat(\n-┊ 82┊   ┊        query.valueChanges.pipe(\n-┊ 83┊   ┊          map((result) => result.data.chat)\n-┊ 84┊   ┊        )\n-┊ 85┊   ┊      )\n-┊ 86┊   ┊    );\n+┊   ┊ 80┊    const getApolloWatchQuery = (id: string) => {\n+┊   ┊ 81┊      return this.getChatGQL.watch({\n+┊   ┊ 82┊        chatId: id,\n+┊   ┊ 83┊      });\n+┊   ┊ 84┊    };\n ┊ 87┊ 85┊\n+┊   ┊ 86┊    let chat$: Observable<GetChat.Chat>;\n ┊ 88┊ 87┊    this.getChatWqSubject = new AsyncSubject();\n-┊ 89┊   ┊    this.getChatWqSubject.next(query);\n-┊ 90┊   ┊    this.getChatWqSubject.complete();\n+┊   ┊ 88┊\n+┊   ┊ 89┊    if (oui) {\n+┊   ┊ 90┊      chat$ = chat$FromCache.pipe(\n+┊   ┊ 91┊        concat(this.addChat$.pipe(\n+┊   ┊ 92┊          switchMap(({ data: { addChat, addGroup } }) => {\n+┊   ┊ 93┊            const query = getApolloWatchQuery(addChat ? addChat.id : addGroup.id);\n+┊   ┊ 94┊\n+┊   ┊ 95┊            this.getChatWqSubject.next(query);\n+┊   ┊ 96┊            this.getChatWqSubject.complete();\n+┊   ┊ 97┊\n+┊   ┊ 98┊            return query.valueChanges.pipe(\n+┊   ┊ 99┊              map((result) => result.data.chat)\n+┊   ┊100┊            );\n+┊   ┊101┊          }))\n+┊   ┊102┊        ));\n+┊   ┊103┊    } else {\n+┊   ┊104┊      const query = getApolloWatchQuery(chatId);\n+┊   ┊105┊\n+┊   ┊106┊      this.getChatWqSubject.next(query);\n+┊   ┊107┊      this.getChatWqSubject.complete();\n+┊   ┊108┊\n+┊   ┊109┊      chat$ = chat$FromCache.pipe(\n+┊   ┊110┊        concat(\n+┊   ┊111┊          query.valueChanges.pipe(\n+┊   ┊112┊            map((result) => result.data.chat)\n+┊   ┊113┊          )\n+┊   ┊114┊        )\n+┊   ┊115┊      );\n+┊   ┊116┊    }\n ┊ 91┊117┊\n ┊ 92┊118┊    return {query$: this.getChatWqSubject.asObservable(), chat$};\n ┊ 93┊119┊  }\n```\n```diff\n@@ -295,15 +321,15 @@\n ┊295┊321┊    return _chat ? _chat.id : false;\n ┊296┊322┊  }\n ┊297┊323┊\n-┊298┊   ┊  addChat(recipientId: string, users: GetUsers.Users[]) {\n-┊299┊   ┊    return this.addChatGQL.mutate(\n+┊   ┊324┊  addChat(recipientId: string, users: GetUsers.Users[], ouiId: string) {\n+┊   ┊325┊    this.addChat$ = this.addChatGQL.mutate(\n ┊300┊326┊      {\n ┊301┊327┊        recipientId,\n ┊302┊328┊      }, {\n ┊303┊329┊        optimisticResponse: {\n ┊304┊330┊          __typename: 'Mutation',\n ┊305┊331┊          addChat: {\n-┊306┊   ┊            id: ChatsService.getRandomId(),\n+┊   ┊332┊            id: ouiId,\n ┊307┊333┊            __typename: 'Chat',\n ┊308┊334┊            name: users.find(user => user.id === recipientId).name,\n ┊309┊335┊            picture: users.find(user => user.id === recipientId).picture,\n```\n```diff\n@@ -344,11 +370,12 @@\n ┊344┊370┊          });\n ┊345┊371┊        },\n ┊346┊372┊      }\n-┊347┊   ┊    );\n+┊   ┊373┊    ).pipe(share());\n+┊   ┊374┊    return this.addChat$;\n ┊348┊375┊  }\n ┊349┊376┊\n-┊350┊   ┊  addGroup(recipientIds: string[], groupName: string) {\n-┊351┊   ┊    return this.addGroupGQL.mutate(\n+┊   ┊377┊  addGroup(recipientIds: string[], groupName: string, ouiId: string) {\n+┊   ┊378┊    this.addChat$ = this.addGroupGQL.mutate(\n ┊352┊379┊      {\n ┊353┊380┊        recipientIds,\n ┊354┊381┊        groupName,\n```\n```diff\n@@ -356,7 +383,7 @@\n ┊356┊383┊        optimisticResponse: {\n ┊357┊384┊          __typename: 'Mutation',\n ┊358┊385┊          addGroup: {\n-┊359┊   ┊            id: ChatsService.getRandomId(),\n+┊   ┊386┊            id: ouiId,\n ┊360┊387┊            __typename: 'Chat',\n ┊361┊388┊            name: groupName,\n ┊362┊389┊            picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n```\n```diff\n@@ -395,6 +422,7 @@\n ┊395┊422┊          });\n ┊396┊423┊        },\n ┊397┊424┊      }\n-┊398┊   ┊    );\n+┊   ┊425┊    ).pipe(share());\n+┊   ┊426┊    return this.addChat$;\n ┊399┊427┊  }\n ┊400┊428┊}\n```\n\n[}]: #\n\nPoof, now our Whatsapp clone feels no more like a clone it has the same native feel."
          },
          {
            "manualTitle": "Step 14: Authentication",
            "stepRevision": "3bbd4a531535c2e7e356cdf86f77e6f301264e21",
            "manualView": "![login](https://user-images.githubusercontent.com/7648874/49270369-06c22200-f4a4-11e8-83e5-cef2400989a6.jpg)\n\n## Authentication on server\n\nAuthentication is an hot topic in the GraphQL world and there are some projects which aim at authenticating through GraphQL.\nSince often you will be required to use a specific auth framework (because of a feature you need or because of an existing authorization infrastructure) I will show you how to use a classic REST API framework within your GraphQL application.\nThis approach is completely fine and in line with the official GraphQL best practices.\nWe will use `Passport` for the authentication and `BasicAuth` as the auth mechanism:\n\n    yarn add bcrypt-nodejs passport passport-http\n    yarn add -D @types/bcrypt-nodejs @types/passport @types/passport-http\n\n`BasicAuth` basically involves to send username e password in an Authorization Header together with each request and is fully supported by any browser (meaning that we will be able to use `Graphiql` simply by proving username and password in the login window provided by the browser itself).\nIt's the most simple auth mechanism but it's completely fine for our needs. Later we could decide to use something more complicated like `JWT`, but it's outside of the scope of this tutorial.\n\n[{]: <helper> (diffStep \"4.1\" files=\"index.ts\" module=\"server\")\n\n#### [Step 4.1: Authentication](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/2ee3fa9)\n\n##### Changed index.ts\n```diff\n@@ -3,6 +3,47 @@\n ┊ 3┊ 3┊import * as cors from 'cors';\n ┊ 4┊ 4┊import * as express from 'express';\n ┊ 5┊ 5┊import { ApolloServer } from \"apollo-server-express\";\n+┊  ┊ 6┊import * as passport from \"passport\";\n+┊  ┊ 7┊import * as basicStrategy from 'passport-http';\n+┊  ┊ 8┊import * as bcrypt from 'bcrypt-nodejs';\n+┊  ┊ 9┊import { db, User } from \"./db\";\n+┊  ┊10┊\n+┊  ┊11┊let users = db.users;\n+┊  ┊12┊\n+┊  ┊13┊function generateHash(password: string) {\n+┊  ┊14┊  return bcrypt.hashSync(password, bcrypt.genSaltSync(8));\n+┊  ┊15┊}\n+┊  ┊16┊\n+┊  ┊17┊function validPassword(password: string, localPassword: string) {\n+┊  ┊18┊  return bcrypt.compareSync(password, localPassword);\n+┊  ┊19┊}\n+┊  ┊20┊\n+┊  ┊21┊passport.use('basic-signin', new basicStrategy.BasicStrategy(\n+┊  ┊22┊  function (username: string, password: string, done: any) {\n+┊  ┊23┊    const user = users.find(user => user.username == username);\n+┊  ┊24┊    if (user && validPassword(password, user.password)) {\n+┊  ┊25┊      return done(null, user);\n+┊  ┊26┊    }\n+┊  ┊27┊    return done(null, false);\n+┊  ┊28┊  }\n+┊  ┊29┊));\n+┊  ┊30┊\n+┊  ┊31┊passport.use('basic-signup', new basicStrategy.BasicStrategy({passReqToCallback: true},\n+┊  ┊32┊  function (req: any, username: any, password: any, done: any) {\n+┊  ┊33┊    const userExists = !!users.find(user => user.username === username);\n+┊  ┊34┊    if (!userExists && password && req.body.name) {\n+┊  ┊35┊      const user: User = {\n+┊  ┊36┊        id: (users.length && users[users.length - 1].id + 1) || 1,\n+┊  ┊37┊        username,\n+┊  ┊38┊        password: generateHash(password),\n+┊  ┊39┊        name: req.body.name,\n+┊  ┊40┊      };\n+┊  ┊41┊      users.push(user);\n+┊  ┊42┊      return done(null, user);\n+┊  ┊43┊    }\n+┊  ┊44┊    return done(null, false);\n+┊  ┊45┊  }\n+┊  ┊46┊));\n ┊ 6┊47┊\n ┊ 7┊48┊const PORT = 3000;\n ┊ 8┊49┊\n```\n```diff\n@@ -10,9 +51,27 @@\n ┊10┊51┊\n ┊11┊52┊app.use(cors());\n ┊12┊53┊app.use(bodyParser.json());\n+┊  ┊54┊app.use(passport.initialize());\n+┊  ┊55┊\n+┊  ┊56┊app.post('/signup',\n+┊  ┊57┊  passport.authenticate('basic-signup', {session: false}),\n+┊  ┊58┊  function (req: any, res) {\n+┊  ┊59┊    res.json(req.user);\n+┊  ┊60┊  });\n+┊  ┊61┊\n+┊  ┊62┊app.use(passport.authenticate('basic-signin', {session: false}));\n+┊  ┊63┊\n+┊  ┊64┊app.post('/signin', function (req: any, res) {\n+┊  ┊65┊  res.json(req.user);\n+┊  ┊66┊});\n ┊13┊67┊\n ┊14┊68┊const apollo = new ApolloServer({\n-┊15┊  ┊  schema\n+┊  ┊69┊  schema,\n+┊  ┊70┊  context(received: any) {\n+┊  ┊71┊    return {\n+┊  ┊72┊      user: received.req!['user'],\n+┊  ┊73┊    }\n+┊  ┊74┊  },\n ┊16┊75┊});\n ┊17┊76┊\n ┊18┊77┊apollo.applyMiddleware({\n```\n\n[}]: #\n\nWe are going to store hashes instead of plain passwords, that's why we're using `bcrypt-nodejs`.\nWith `passport.use('basic-signin')` and `passport.use('basic-signup')` we define how the auth framework deals with our database (well, our JSON file for the moment).\n`app.post('/signup')` is the endpoint for creating new accounts, so we left it out of the authentication middleware (`app.use(passport.authenticate('basic-signin')`).\nWhat's of particular interest is that we're passing the user object to the GraphQL context.\n\n[{]: <helper> (diffStep \"4.1\" files=\"schema/resolvers.ts\" module=\"server\")\n\n#### [Step 4.1: Authentication](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/2ee3fa9)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -8,29 +8,28 @@\n ┊ 8┊ 8┊\n ┊ 9┊ 9┊let users = db.users;\n ┊10┊10┊let chats = db.chats;\n-┊11┊  ┊const currentUser = 1;\n ┊12┊11┊\n ┊13┊12┊export const resolvers: IResolvers = {\n ┊14┊13┊  Query: {\n ┊15┊14┊    // Show all users for the moment.\n-┊16┊  ┊    users: (): User[] => users.filter(user => user.id !== currentUser),\n-┊17┊  ┊    chats: (): Chat[] => chats.filter(chat => chat.listingMemberIds.includes(currentUser)),\n+┊  ┊15┊    users: (obj: any, args: any, {user: currentUser}: {user: User}): User[] => users.filter(user => user.id !== currentUser.id),\n+┊  ┊16┊    chats: (obj: any, args: any, {user: currentUser}: {user: User}): Chat[] => chats.filter(chat => chat.listingMemberIds.includes(currentUser.id)),\n ┊18┊17┊    chat: (obj: any, {chatId}: ChatQueryArgs): Chat | null => chats.find(chat => chat.id === Number(chatId)) || null,\n ┊19┊18┊  },\n ┊20┊19┊  Mutation: {\n-┊21┊  ┊    addChat: (obj: any, {recipientId}: AddChatMutationArgs): Chat => {\n+┊  ┊20┊    addChat: (obj: any, {recipientId}: AddChatMutationArgs, {user: currentUser}: {user: User}): Chat => {\n ┊22┊21┊      if (!users.find(user => user.id === Number(recipientId))) {\n ┊23┊22┊        throw new Error(`Recipient ${recipientId} doesn't exist.`);\n ┊24┊23┊      }\n ┊25┊24┊\n-┊26┊  ┊      const chat = chats.find(chat => !chat.name && chat.allTimeMemberIds.includes(currentUser) && chat.allTimeMemberIds.includes(Number(recipientId)));\n+┊  ┊25┊      const chat = chats.find(chat => !chat.name && chat.allTimeMemberIds.includes(currentUser.id) && chat.allTimeMemberIds.includes(Number(recipientId)));\n ┊27┊26┊      if (chat) {\n ┊28┊27┊        // Chat already exists. Both users are already in the allTimeMemberIds array\n ┊29┊28┊        const chatId = chat.id;\n-┊30┊  ┊        if (!chat.listingMemberIds.includes(currentUser)) {\n+┊  ┊29┊        if (!chat.listingMemberIds.includes(currentUser.id)) {\n ┊31┊30┊          // The chat isn't listed for the current user. Add him to the memberIds\n-┊32┊  ┊          chat.listingMemberIds.push(currentUser);\n-┊33┊  ┊          chats.find(chat => chat.id === chatId)!.listingMemberIds.push(currentUser);\n+┊  ┊31┊          chat.listingMemberIds.push(currentUser.id);\n+┊  ┊32┊          chats.find(chat => chat.id === chatId)!.listingMemberIds.push(currentUser.id);\n ┊34┊33┊          return chat;\n ┊35┊34┊        } else {\n ┊36┊35┊          throw new Error(`Chat already exists.`);\n```\n```diff\n@@ -44,9 +43,9 @@\n ┊44┊43┊          picture: null,\n ┊45┊44┊          adminIds: null,\n ┊46┊45┊          ownerId: null,\n-┊47┊  ┊          allTimeMemberIds: [currentUser, Number(recipientId)],\n+┊  ┊46┊          allTimeMemberIds: [currentUser.id, Number(recipientId)],\n ┊48┊47┊          // Chat will not be listed to the other user until the first message gets written\n-┊49┊  ┊          listingMemberIds: [currentUser],\n+┊  ┊48┊          listingMemberIds: [currentUser.id],\n ┊50┊49┊          actualGroupMemberIds: null,\n ┊51┊50┊          messages: [],\n ┊52┊51┊        };\n```\n```diff\n@@ -54,7 +53,7 @@\n ┊54┊53┊        return chat;\n ┊55┊54┊      }\n ┊56┊55┊    },\n-┊57┊  ┊    addGroup: (obj: any, {recipientIds, groupName}: AddGroupMutationArgs): Chat => {\n+┊  ┊56┊    addGroup: (obj: any, {recipientIds, groupName}: AddGroupMutationArgs, {user: currentUser}: {user: User}): Chat => {\n ┊58┊57┊      recipientIds.forEach(recipientId => {\n ┊59┊58┊        if (!users.find(user => user.id === Number(recipientId))) {\n ┊60┊59┊          throw new Error(`Recipient ${recipientId} doesn't exist.`);\n```\n```diff\n@@ -66,17 +65,17 @@\n ┊66┊65┊        id,\n ┊67┊66┊        name: groupName,\n ┊68┊67┊        picture: null,\n-┊69┊  ┊        adminIds: [currentUser],\n-┊70┊  ┊        ownerId: currentUser,\n-┊71┊  ┊        allTimeMemberIds: [currentUser, ...recipientIds.map(id => Number(id))],\n-┊72┊  ┊        listingMemberIds: [currentUser, ...recipientIds.map(id => Number(id))],\n-┊73┊  ┊        actualGroupMemberIds: [currentUser, ...recipientIds.map(id => Number(id))],\n+┊  ┊68┊        adminIds: [currentUser.id],\n+┊  ┊69┊        ownerId: currentUser.id,\n+┊  ┊70┊        allTimeMemberIds: [currentUser.id, ...recipientIds.map(id => Number(id))],\n+┊  ┊71┊        listingMemberIds: [currentUser.id, ...recipientIds.map(id => Number(id))],\n+┊  ┊72┊        actualGroupMemberIds: [currentUser.id, ...recipientIds.map(id => Number(id))],\n ┊74┊73┊        messages: [],\n ┊75┊74┊      };\n ┊76┊75┊      chats.push(chat);\n ┊77┊76┊      return chat;\n ┊78┊77┊    },\n-┊79┊  ┊    removeChat: (obj: any, {chatId}: RemoveChatMutationArgs): number => {\n+┊  ┊78┊    removeChat: (obj: any, {chatId}: RemoveChatMutationArgs, {user: currentUser}: {user: User}): number => {\n ┊80┊79┊      const chat = chats.find(chat => chat.id === Number(chatId));\n ┊81┊80┊\n ┊82┊81┊      if (!chat) {\n```\n```diff\n@@ -85,14 +84,14 @@\n ┊85┊84┊\n ┊86┊85┊      if (!chat.name) {\n ┊87┊86┊        // Chat\n-┊88┊  ┊        if (!chat.listingMemberIds.includes(currentUser)) {\n+┊  ┊87┊        if (!chat.listingMemberIds.includes(currentUser.id)) {\n ┊89┊88┊          throw new Error(`The user is not a member of the chat ${chatId}.`);\n ┊90┊89┊        }\n ┊91┊90┊\n ┊92┊91┊        // Instead of chaining map and filter we can loop once using reduce\n ┊93┊92┊        const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n ┊94┊93┊          // Remove the current user from the message holders\n-┊95┊  ┊          message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser);\n+┊  ┊94┊          message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser.id);\n ┊96┊95┊\n ┊97┊96┊          if (message.holderIds.length !== 0) {\n ┊98┊97┊            filtered.push(message);\n```\n```diff\n@@ -102,7 +101,7 @@\n ┊102┊101┊        }, []);\n ┊103┊102┊\n ┊104┊103┊        // Remove the current user from who gets the chat listed. The chat will no longer appear in his list\n-┊105┊   ┊        const listingMemberIds = chat.listingMemberIds.filter(listingId => listingId !== currentUser);\n+┊   ┊104┊        const listingMemberIds = chat.listingMemberIds.filter(listingId => listingId !== currentUser.id);\n ┊106┊105┊\n ┊107┊106┊        // Check how many members are left\n ┊108┊107┊        if (listingMemberIds.length === 0) {\n```\n```diff\n@@ -120,14 +119,14 @@\n ┊120┊119┊        return Number(chatId);\n ┊121┊120┊      } else {\n ┊122┊121┊        // Group\n-┊123┊   ┊        if (chat.ownerId !== currentUser) {\n+┊   ┊122┊        if (chat.ownerId !== currentUser.id) {\n ┊124┊123┊          throw new Error(`Group ${chatId} is not owned by the user.`);\n ┊125┊124┊        }\n ┊126┊125┊\n ┊127┊126┊        // Instead of chaining map and filter we can loop once using reduce\n ┊128┊127┊        const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n ┊129┊128┊          // Remove the current user from the message holders\n-┊130┊   ┊          message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser);\n+┊   ┊129┊          message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser.id);\n ┊131┊130┊\n ┊132┊131┊          if (message.holderIds.length !== 0) {\n ┊133┊132┊            filtered.push(message);\n```\n```diff\n@@ -137,7 +136,7 @@\n ┊137┊136┊        }, []);\n ┊138┊137┊\n ┊139┊138┊        // Remove the current user from who gets the group listed. The group will no longer appear in his list\n-┊140┊   ┊        const listingMemberIds = chat.listingMemberIds.filter(listingId => listingId !== currentUser);\n+┊   ┊139┊        const listingMemberIds = chat.listingMemberIds.filter(listingId => listingId !== currentUser.id);\n ┊141┊140┊\n ┊142┊141┊        // Check how many members (including previous ones who can still access old messages) are left\n ┊143┊142┊        if (listingMemberIds.length === 0) {\n```\n```diff\n@@ -147,9 +146,9 @@\n ┊147┊146┊          // Update the group\n ┊148┊147┊\n ┊149┊148┊          // Remove the current user from the chat members. He is no longer a member of the group\n-┊150┊   ┊          const actualGroupMemberIds = chat.actualGroupMemberIds!.filter(memberId => memberId !== currentUser);\n+┊   ┊149┊          const actualGroupMemberIds = chat.actualGroupMemberIds!.filter(memberId => memberId !== currentUser.id);\n ┊151┊150┊          // Remove the current user from the chat admins\n-┊152┊   ┊          const adminIds = chat.adminIds!.filter(memberId => memberId !== currentUser);\n+┊   ┊151┊          const adminIds = chat.adminIds!.filter(memberId => memberId !== currentUser.id);\n ┊153┊152┊          // Set the owner id to be null. A null owner means the group is read-only\n ┊154┊153┊          let ownerId: number | null = null;\n ┊155┊154┊\n```\n```diff\n@@ -169,7 +168,7 @@\n ┊169┊168┊        return Number(chatId);\n ┊170┊169┊      }\n ┊171┊170┊    },\n-┊172┊   ┊    addMessage: (obj: any, {chatId, content}: AddMessageMutationArgs): Message => {\n+┊   ┊171┊    addMessage: (obj: any, {chatId, content}: AddMessageMutationArgs, {user: currentUser}: {user: User}): Message => {\n ┊173┊172┊      if (content === null || content === '') {\n ┊174┊173┊        throw new Error(`Cannot add empty or null messages.`);\n ┊175┊174┊      }\n```\n```diff\n@@ -184,11 +183,11 @@\n ┊184┊183┊\n ┊185┊184┊      if (!chat.name) {\n ┊186┊185┊        // Chat\n-┊187┊   ┊        if (!chat.listingMemberIds.find(listingId => listingId === currentUser)) {\n+┊   ┊186┊        if (!chat.listingMemberIds.find(listingId => listingId === currentUser.id)) {\n ┊188┊187┊          throw new Error(`The chat ${chatId} must be listed for the current user before adding a message.`);\n ┊189┊188┊        }\n ┊190┊189┊\n-┊191┊   ┊        const recipientId = chat.allTimeMemberIds.filter(userId => userId !== currentUser)[0];\n+┊   ┊190┊        const recipientId = chat.allTimeMemberIds.filter(userId => userId !== currentUser.id)[0];\n ┊192┊191┊\n ┊193┊192┊        if (!chat.listingMemberIds.find(listingId => listingId === recipientId)) {\n ┊194┊193┊          // Chat is not listed for the recipient. Add him to the listingMemberIds\n```\n```diff\n@@ -205,7 +204,7 @@\n ┊205┊204┊        }\n ┊206┊205┊      } else {\n ┊207┊206┊        // Group\n-┊208┊   ┊        if (!chat.actualGroupMemberIds!.find(memberId => memberId === currentUser)) {\n+┊   ┊207┊        if (!chat.actualGroupMemberIds!.find(memberId => memberId === currentUser.id)) {\n ┊209┊208┊          throw new Error(`The user is not a member of the group ${chatId}. Cannot add message.`);\n ┊210┊209┊        }\n ┊211┊210┊\n```\n```diff\n@@ -217,7 +216,7 @@\n ┊217┊216┊      let recipients: Recipient[] = [];\n ┊218┊217┊\n ┊219┊218┊      holderIds.forEach(holderId => {\n-┊220┊   ┊        if (holderId !== currentUser) {\n+┊   ┊219┊        if (holderId !== currentUser.id) {\n ┊221┊220┊          recipients.push({\n ┊222┊221┊            userId: holderId,\n ┊223┊222┊            messageId: id,\n```\n```diff\n@@ -231,7 +230,7 @@\n ┊231┊230┊      const message: Message = {\n ┊232┊231┊        id,\n ┊233┊232┊        chatId: Number(chatId),\n-┊234┊   ┊        senderId: currentUser,\n+┊   ┊233┊        senderId: currentUser.id,\n ┊235┊234┊        content,\n ┊236┊235┊        createdAt: moment().unix(),\n ┊237┊236┊        type: MessageType.TEXT,\n```\n```diff\n@@ -248,14 +247,14 @@\n ┊248┊247┊\n ┊249┊248┊      return message;\n ┊250┊249┊    },\n-┊251┊   ┊    removeMessages: (obj: any, {chatId, messageIds, all}: RemoveMessagesMutationArgs): number[] => {\n+┊   ┊250┊    removeMessages: (obj: any, {chatId, messageIds, all}: RemoveMessagesMutationArgs, {user: currentUser}: {user: User}): number[] => {\n ┊252┊251┊      const chat = chats.find(chat => chat.id === Number(chatId));\n ┊253┊252┊\n ┊254┊253┊      if (!chat) {\n ┊255┊254┊        throw new Error(`Cannot find chat ${chatId}.`);\n ┊256┊255┊      }\n ┊257┊256┊\n-┊258┊   ┊      if (!chat.listingMemberIds.find(listingId => listingId === currentUser)) {\n+┊   ┊257┊      if (!chat.listingMemberIds.find(listingId => listingId === currentUser.id)) {\n ┊259┊258┊        throw new Error(`The chat/group ${chatId} is not listed for the current user, so there is nothing to delete.`);\n ┊260┊259┊      }\n ┊261┊260┊\n```\n```diff\n@@ -271,7 +270,7 @@\n ┊271┊270┊            if (all || messageIds!.includes(String(message.id))) {\n ┊272┊271┊              deletedIds.push(message.id);\n ┊273┊272┊              // Remove the current user from the message holders\n-┊274┊   ┊              message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser);\n+┊   ┊273┊              message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser.id);\n ┊275┊274┊            }\n ┊276┊275┊\n ┊277┊276┊            if (message.holderIds.length !== 0) {\n```\n```diff\n@@ -288,24 +287,24 @@\n ┊288┊287┊    },\n ┊289┊288┊  },\n ┊290┊289┊  Chat: {\n-┊291┊   ┊    name: (chat: Chat): string => chat.name ? chat.name : users\n-┊292┊   ┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser))!.name,\n-┊293┊   ┊    picture: (chat: Chat) => chat.name ? chat.picture : users\n-┊294┊   ┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser))!.picture,\n+┊   ┊290┊    name: (chat: Chat, args: any, {user: currentUser}: {user: User}): string => chat.name ? chat.name : users\n+┊   ┊291┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser.id))!.name,\n+┊   ┊292┊    picture: (chat: Chat, args: any, {user: currentUser}: {user: User}) => chat.name ? chat.picture : users\n+┊   ┊293┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser.id))!.picture,\n ┊295┊294┊    allTimeMembers: (chat: Chat): User[] => users.filter(user => chat.allTimeMemberIds.includes(user.id)),\n ┊296┊295┊    listingMembers: (chat: Chat): User[] => users.filter(user => chat.listingMemberIds.includes(user.id)),\n ┊297┊296┊    actualGroupMembers: (chat: Chat): User[] => users.filter(user => chat.actualGroupMemberIds && chat.actualGroupMemberIds.includes(user.id)),\n ┊298┊297┊    admins: (chat: Chat): User[] => users.filter(user => chat.adminIds && chat.adminIds.includes(user.id)),\n ┊299┊298┊    owner: (chat: Chat): User | null => users.find(user => chat.ownerId === user.id) || null,\n-┊300┊   ┊    messages: (chat: Chat, {amount = 0}: {amount: number}): Message[] => {\n+┊   ┊299┊    messages: (chat: Chat, {amount = 0}: {amount: number}, {user: currentUser}: {user: User}): Message[] => {\n ┊301┊300┊      const messages = chat.messages\n-┊302┊   ┊      .filter(message => message.holderIds.includes(currentUser))\n+┊   ┊301┊      .filter(message => message.holderIds.includes(currentUser.id))\n ┊303┊302┊      .sort((a, b) => b.createdAt - a.createdAt) || <Message[]>[];\n ┊304┊303┊      return (amount ? messages.slice(0, amount) : messages).reverse();\n ┊305┊304┊    },\n-┊306┊   ┊    unreadMessages: (chat: Chat): number => chat.messages\n-┊307┊   ┊      .filter(message => message.holderIds.includes(currentUser) &&\n-┊308┊   ┊        message.recipients.find(recipient => recipient.userId === currentUser && !recipient.readAt))\n+┊   ┊305┊    unreadMessages: (chat: Chat, args: any, {user: currentUser}: {user: User}): number => chat.messages\n+┊   ┊306┊      .filter(message => message.holderIds.includes(currentUser.id) &&\n+┊   ┊307┊        message.recipients.find(recipient => recipient.userId === currentUser.id && !recipient.readAt))\n ┊309┊308┊      .length,\n ┊310┊309┊    isGroup: (chat: Chat): boolean => !!chat.name,\n ┊311┊310┊  },\n```\n```diff\n@@ -313,7 +312,7 @@\n ┊313┊312┊    chat: (message: Message): Chat | null => chats.find(chat => message.chatId === chat.id) || null,\n ┊314┊313┊    sender: (message: Message): User | null => users.find(user => user.id === message.senderId) || null,\n ┊315┊314┊    holders: (message: Message): User[] => users.filter(user => message.holderIds.includes(user.id)),\n-┊316┊   ┊    ownership: (message: Message): boolean => message.senderId === currentUser,\n+┊   ┊315┊    ownership: (message: Message, args: any, {user: currentUser}: {user: User}): boolean => message.senderId === currentUser.id,\n ┊317┊316┊  },\n ┊318┊317┊  Recipient: {\n ┊319┊318┊    user: (recipient: Recipient): User | null => users.find(user => recipient.userId === user.id) || null,\n```\n\n[}]: #\n\nIn the resolvers we're basically making use of the user object taken from the context.\n\n## Authentication on client\n\nLet's start installing `@angular/flex-layout`, because we will use it later:\n\n    yarn add @angular/flex-layout\n\n\nFirst of all we need to create an `HTTP Interceptor`, which will intercept every HTTP request and will add authentication headers.\nFor the moment we still don't have those headers, but we are going to store them in the `LocalStorage` later.\nWe are also creating an `AuthGuard`, which we will use to stop the user from reaching unauthorized Routes.\n\nThe `AuthGuard` will simply look for the presence of the `Authentication` Header, but will not guarantee that the header is authentic.\nThis is no problem, because client side AuthGuards are not safe by design and the real authentication will be done server side anyway.\nAuthGuards are here just to redirect the user to the Login page.\n\nThe service we are going to create will contain some auth methods we are going to use across the app.\n\n[{]: <helper> (diffStep \"10.1\" files=\"src/app/login/services\" module=\"client\")\n\n#### [Step 10.1: Authentication](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/34faf60)\n\n##### Added src&#x2F;app&#x2F;login&#x2F;services&#x2F;auth.guard.ts\n```diff\n@@ -0,0 +1,18 @@\n+┊  ┊ 1┊import {Injectable} from '@angular/core';\n+┊  ┊ 2┊import {CanActivate, Router} from '@angular/router';\n+┊  ┊ 3┊import {LoginService} from './login.service';\n+┊  ┊ 4┊\n+┊  ┊ 5┊@Injectable()\n+┊  ┊ 6┊export class AuthGuard implements CanActivate {\n+┊  ┊ 7┊  constructor(private router: Router,\n+┊  ┊ 8┊              private loginService: LoginService) {}\n+┊  ┊ 9┊\n+┊  ┊10┊  canActivate() {\n+┊  ┊11┊    if (this.loginService.getAuthHeader()) {\n+┊  ┊12┊      return true;\n+┊  ┊13┊    } else {\n+┊  ┊14┊      this.router.navigate(['/login']);\n+┊  ┊15┊      return false;\n+┊  ┊16┊    }\n+┊  ┊17┊  }\n+┊  ┊18┊}\n```\n\n##### Added src&#x2F;app&#x2F;login&#x2F;services&#x2F;auth.interceptor.ts\n```diff\n@@ -0,0 +1,20 @@\n+┊  ┊ 1┊import {Injectable} from '@angular/core';\n+┊  ┊ 2┊import {HttpEvent, HttpHandler, HttpInterceptor, HttpRequest} from '@angular/common/http';\n+┊  ┊ 3┊import {Observable} from 'rxjs';\n+┊  ┊ 4┊import {LoginService} from './login.service';\n+┊  ┊ 5┊\n+┊  ┊ 6┊@Injectable()\n+┊  ┊ 7┊export class AuthInterceptor implements HttpInterceptor {\n+┊  ┊ 8┊  constructor(private loginService: LoginService) {}\n+┊  ┊ 9┊  intercept(request: HttpRequest<any>, next: HttpHandler): Observable<HttpEvent<any>> {\n+┊  ┊10┊    const auth = this.loginService.getAuthHeader();\n+┊  ┊11┊    if (auth) {\n+┊  ┊12┊      request = request.clone({\n+┊  ┊13┊        setHeaders: {\n+┊  ┊14┊          Authorization: auth,\n+┊  ┊15┊        }\n+┊  ┊16┊      });\n+┊  ┊17┊    }\n+┊  ┊18┊    return next.handle(request);\n+┊  ┊19┊  }\n+┊  ┊20┊}\n```\n\n##### Added src&#x2F;app&#x2F;login&#x2F;services&#x2F;login.service.ts\n```diff\n@@ -0,0 +1,24 @@\n+┊  ┊ 1┊import { Injectable } from '@angular/core';\n+┊  ┊ 2┊import {User} from '../../../graphql';\n+┊  ┊ 3┊\n+┊  ┊ 4┊@Injectable()\n+┊  ┊ 5┊export class LoginService {\n+┊  ┊ 6┊\n+┊  ┊ 7┊  constructor() { }\n+┊  ┊ 8┊\n+┊  ┊ 9┊  storeAuthHeader(auth: string) {\n+┊  ┊10┊    localStorage.setItem('Authorization', auth);\n+┊  ┊11┊  }\n+┊  ┊12┊\n+┊  ┊13┊  getAuthHeader(): string {\n+┊  ┊14┊    return localStorage.getItem('Authorization');\n+┊  ┊15┊  }\n+┊  ┊16┊\n+┊  ┊17┊  storeUser(user: User) {\n+┊  ┊18┊    localStorage.setItem('user', JSON.stringify(user));\n+┊  ┊19┊  }\n+┊  ┊20┊\n+┊  ┊21┊  getUser(): User {\n+┊  ┊22┊    return JSON.parse(localStorage.getItem('user'));\n+┊  ┊23┊  }\n+┊  ┊24┊}\n```\n\n[}]: #\n\nNow it's time to create a `SignIn`/`SignUp` component. Since we use Passport in the server we are going to make REST calls for the authentication, instead of using GraphQL.\nSince we use `Basic Auth` we will simply combine the username and the password together to create the authentication header.\nWe will also store the response from the server, which will contain the user information like the ID, etc. which we are going to need later.\n\nFirst we we will download a WhatsApp picture that will be used in the login component:\n\n    $ wget https://user-images.githubusercontent.com/7648874/49260078-e7f96680-f476-11e8-8711-06bc6490858a.png -P src/assets\n\nAnd then we will proceed to creating the component itself and everything around it:\n\n[{]: <helper> (diffStep \"10.1\" files=\"src/app/login/containers, src/app/login/login.module.ts\" module=\"client\")\n\n#### [Step 10.1: Authentication](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/34faf60)\n\n##### Added src&#x2F;app&#x2F;login&#x2F;containers&#x2F;login.component.scss\n```diff\n@@ -0,0 +1,18 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊}\n+┊  ┊ 4┊\n+┊  ┊ 5┊form:first-of-type {\n+┊  ┊ 6┊  margin-top: 24px;\n+┊  ┊ 7┊  margin-bottom: 48px;\n+┊  ┊ 8┊}\n+┊  ┊ 9┊\n+┊  ┊10┊label {\n+┊  ┊11┊  display: block;\n+┊  ┊12┊  margin-top: 4px;\n+┊  ┊13┊  margin-bottom: 4px;\n+┊  ┊14┊}\n+┊  ┊15┊\n+┊  ┊16┊.error {\n+┊  ┊17┊  color: red;\n+┊  ┊18┊}\n```\n\n##### Added src&#x2F;app&#x2F;login&#x2F;containers&#x2F;login.component.ts\n```diff\n@@ -0,0 +1,133 @@\n+┊   ┊  1┊import {Component} from '@angular/core';\n+┊   ┊  2┊import {HttpClient} from '@angular/common/http';\n+┊   ┊  3┊import {FormBuilder, Validators} from '@angular/forms';\n+┊   ┊  4┊// import {matchOtherValidator} from '@moebius/ng-validators';\n+┊   ┊  5┊import {Router} from '@angular/router';\n+┊   ┊  6┊import {User} from '../../../graphql';\n+┊   ┊  7┊import {LoginService} from '../services/login.service';\n+┊   ┊  8┊\n+┊   ┊  9┊@Component({\n+┊   ┊ 10┊  selector: 'app-login',\n+┊   ┊ 11┊  template: `\n+┊   ┊ 12┊    <form (ngSubmit)=\"signIn()\" [formGroup]=\"signInForm\" novalidate>\n+┊   ┊ 13┊      <fieldset fxLayout=\"column\" fxLayoutGap=\"17px\">\n+┊   ┊ 14┊        <legend>Sign in</legend>\n+┊   ┊ 15┊        <div>\n+┊   ┊ 16┊          <label>Username</label>\n+┊   ┊ 17┊          <input formControlName=\"username\" autocomplete=\"username\" type=\"text\">\n+┊   ┊ 18┊        </div>\n+┊   ┊ 19┊        <div class=\"error\" *ngIf=\"signInForm.get('username').hasError('required') && signInForm.get('username').touched\">\n+┊   ┊ 20┊          Username is required\n+┊   ┊ 21┊        </div>\n+┊   ┊ 22┊\n+┊   ┊ 23┊        <div>\n+┊   ┊ 24┊          <label>Password</label>\n+┊   ┊ 25┊          <input formControlName=\"password\" autocomplete=\"current-password\" type=\"password\">\n+┊   ┊ 26┊        </div>\n+┊   ┊ 27┊        <div class=\"error\" *ngIf=\"signInForm.get('password').hasError('required') && signInForm.get('password').touched\">\n+┊   ┊ 28┊          Password is required\n+┊   ┊ 29┊        </div>\n+┊   ┊ 30┊\n+┊   ┊ 31┊        <button type=\"submit\" [disabled]=\"signInForm.invalid\">Sign in</button>\n+┊   ┊ 32┊      </fieldset>\n+┊   ┊ 33┊    </form>\n+┊   ┊ 34┊\n+┊   ┊ 35┊    <form (ngSubmit)=\"signUp()\" [formGroup]=\"signUpForm\" novalidate>\n+┊   ┊ 36┊      <fieldset fxLayout=\"column\" fxLayoutGap=\"17px\">\n+┊   ┊ 37┊        <legend>Sign up</legend>\n+┊   ┊ 38┊        <div>\n+┊   ┊ 39┊          <label>Name</label>\n+┊   ┊ 40┊          <input formControlName=\"name\" type=\"text\">\n+┊   ┊ 41┊        </div>\n+┊   ┊ 42┊\n+┊   ┊ 43┊        <div>\n+┊   ┊ 44┊          <label>Username</label>\n+┊   ┊ 45┊          <input formControlName=\"username\" autocomplete=\"username\" type=\"text\">\n+┊   ┊ 46┊        </div>\n+┊   ┊ 47┊        <div class=\"error\" *ngIf=\"signUpForm.get('username').hasError('required') && signUpForm.get('username').touched\">\n+┊   ┊ 48┊          Username is required\n+┊   ┊ 49┊        </div>\n+┊   ┊ 50┊\n+┊   ┊ 51┊        <div>\n+┊   ┊ 52┊          <label>Password</label>\n+┊   ┊ 53┊          <input formControlName=\"newPassword\" autocomplete=\"new-password\" type=\"password\">\n+┊   ┊ 54┊        </div>\n+┊   ┊ 55┊        <div class=\"error\" *ngIf=\"signUpForm.get('newPassword').hasError('required') && signUpForm.get('newPassword').touched\">\n+┊   ┊ 56┊          Password is required\n+┊   ┊ 57┊        </div>\n+┊   ┊ 58┊\n+┊   ┊ 59┊        <div>\n+┊   ┊ 60┊          <label>Password</label>\n+┊   ┊ 61┊          <input formControlName=\"confirmPassword\" type=\"password\">\n+┊   ┊ 62┊        </div>\n+┊   ┊ 63┊        <div class=\"error\" *ngIf=\"signUpForm.get('confirmPassword').hasError('required') && signUpForm.get('confirmPassword').touched\">\n+┊   ┊ 64┊          Passwords must match\n+┊   ┊ 65┊        </div>\n+┊   ┊ 66┊\n+┊   ┊ 67┊        <button type=\"submit\" [disabled]=\"signUpForm.invalid\">Sign up</button>\n+┊   ┊ 68┊      </fieldset>\n+┊   ┊ 69┊    </form>\n+┊   ┊ 70┊  `,\n+┊   ┊ 71┊  styleUrls: ['./login.component.scss'],\n+┊   ┊ 72┊})\n+┊   ┊ 73┊export class LoginComponent {\n+┊   ┊ 74┊  signInForm = this.fb.group({\n+┊   ┊ 75┊    username: [null, [\n+┊   ┊ 76┊      Validators.required,\n+┊   ┊ 77┊    ]],\n+┊   ┊ 78┊    password: [null, [\n+┊   ┊ 79┊      Validators.required,\n+┊   ┊ 80┊    ]],\n+┊   ┊ 81┊  });\n+┊   ┊ 82┊\n+┊   ┊ 83┊  signUpForm = this.fb.group({\n+┊   ┊ 84┊    name: [null, [\n+┊   ┊ 85┊      Validators.required,\n+┊   ┊ 86┊    ]],\n+┊   ┊ 87┊    username: [null, [\n+┊   ┊ 88┊      Validators.required,\n+┊   ┊ 89┊    ]],\n+┊   ┊ 90┊    newPassword: [null, [\n+┊   ┊ 91┊      Validators.required,\n+┊   ┊ 92┊    ]],\n+┊   ┊ 93┊    confirmPassword: [null, [\n+┊   ┊ 94┊      Validators.required,\n+┊   ┊ 95┊      // matchOtherValidator('newPassword'),\n+┊   ┊ 96┊    ]],\n+┊   ┊ 97┊  });\n+┊   ┊ 98┊\n+┊   ┊ 99┊  constructor(private http: HttpClient,\n+┊   ┊100┊              private fb: FormBuilder,\n+┊   ┊101┊              private router: Router,\n+┊   ┊102┊              private loginService: LoginService) {}\n+┊   ┊103┊\n+┊   ┊104┊  signIn() {\n+┊   ┊105┊    const {username, password} = this.signInForm.value;\n+┊   ┊106┊    const auth = `Basic ${btoa(`${username}:${password}`)}`;\n+┊   ┊107┊    this.http.post('http://localhost:3000/signin', null, {\n+┊   ┊108┊      headers: {\n+┊   ┊109┊        Authorization: auth,\n+┊   ┊110┊      }\n+┊   ┊111┊    }).subscribe((user: User) => {\n+┊   ┊112┊      this.loginService.storeAuthHeader(auth);\n+┊   ┊113┊      this.loginService.storeUser(user);\n+┊   ┊114┊      this.router.navigate(['/chats']);\n+┊   ┊115┊    }, err => console.error(err));\n+┊   ┊116┊  }\n+┊   ┊117┊\n+┊   ┊118┊  signUp() {\n+┊   ┊119┊    const {username, newPassword: password, name} = this.signInForm.value;\n+┊   ┊120┊    const auth = `Basic ${btoa(`${username}:${password}`)}`;\n+┊   ┊121┊    this.http.post('http://localhost:3000/signup', {\n+┊   ┊122┊      name,\n+┊   ┊123┊    }, {\n+┊   ┊124┊      headers: {\n+┊   ┊125┊        Authorization: auth,\n+┊   ┊126┊      }\n+┊   ┊127┊    }).subscribe((user: User) => {\n+┊   ┊128┊      this.loginService.storeAuthHeader(auth);\n+┊   ┊129┊      this.loginService.storeUser(user);\n+┊   ┊130┊      this.router.navigate(['/chats']);\n+┊   ┊131┊    }, err => console.error(err));\n+┊   ┊132┊  }\n+┊   ┊133┊}\n```\n\n##### Added src&#x2F;app&#x2F;login&#x2F;login.module.ts\n```diff\n@@ -0,0 +1,52 @@\n+┊  ┊ 1┊import {RouterModule, Routes} from '@angular/router';\n+┊  ┊ 2┊import {NgModule} from '@angular/core';\n+┊  ┊ 3┊import {TruncateModule} from 'ng2-truncate';\n+┊  ┊ 4┊import {MatButtonModule, MatIconModule, MatListModule, MatMenuModule} from '@angular/material';\n+┊  ┊ 5┊import {SharedModule} from '../shared/shared.module';\n+┊  ┊ 6┊import {BrowserModule} from '@angular/platform-browser';\n+┊  ┊ 7┊import {FormsModule, ReactiveFormsModule} from '@angular/forms';\n+┊  ┊ 8┊import {BrowserAnimationsModule} from '@angular/platform-browser/animations';\n+┊  ┊ 9┊import {LoginComponent} from './containers/login.component';\n+┊  ┊10┊import {FlexLayoutModule} from '@angular/flex-layout';\n+┊  ┊11┊import {AuthInterceptor} from './services/auth.interceptor';\n+┊  ┊12┊import {AuthGuard} from './services/auth.guard';\n+┊  ┊13┊import {LoginService} from './services/login.service';\n+┊  ┊14┊\n+┊  ┊15┊\n+┊  ┊16┊const routes: Routes = [\n+┊  ┊17┊  {path: 'login', component: LoginComponent},\n+┊  ┊18┊];\n+┊  ┊19┊\n+┊  ┊20┊@NgModule({\n+┊  ┊21┊  declarations: [\n+┊  ┊22┊    LoginComponent,\n+┊  ┊23┊  ],\n+┊  ┊24┊  imports: [\n+┊  ┊25┊    BrowserModule,\n+┊  ┊26┊    // Material\n+┊  ┊27┊    MatMenuModule,\n+┊  ┊28┊    MatIconModule,\n+┊  ┊29┊    MatButtonModule,\n+┊  ┊30┊    MatListModule,\n+┊  ┊31┊    // Animations\n+┊  ┊32┊    BrowserAnimationsModule,\n+┊  ┊33┊    // Flex layout\n+┊  ┊34┊    FlexLayoutModule,\n+┊  ┊35┊    // Routing\n+┊  ┊36┊    RouterModule.forChild(routes),\n+┊  ┊37┊    // Forms\n+┊  ┊38┊    FormsModule,\n+┊  ┊39┊    ReactiveFormsModule,\n+┊  ┊40┊    // Truncate Pipe\n+┊  ┊41┊    TruncateModule,\n+┊  ┊42┊    // Feature modules\n+┊  ┊43┊    SharedModule,\n+┊  ┊44┊  ],\n+┊  ┊45┊  providers: [\n+┊  ┊46┊    LoginService,\n+┊  ┊47┊    AuthInterceptor,\n+┊  ┊48┊    AuthGuard,\n+┊  ┊49┊  ],\n+┊  ┊50┊})\n+┊  ┊51┊export class LoginModule {\n+┊  ┊52┊}\n```\n\n[}]: #\n\nNow it's time use the Interceptor we just created:\n\n[{]: <helper> (diffStep \"10.1\" files=\"src/app/app.module.ts\" module=\"client\")\n\n#### [Step 10.1: Authentication](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/34faf60)\n\n##### Changed src&#x2F;app&#x2F;app.module.ts\n```diff\n@@ -2,12 +2,14 @@\n ┊ 2┊ 2┊import { NgModule } from '@angular/core';\n ┊ 3┊ 3┊\n ┊ 4┊ 4┊import { AppComponent } from './app.component';\n-┊ 5┊  ┊import { HttpClientModule } from '@angular/common/http';\n+┊  ┊ 5┊import { HttpClientModule, HTTP_INTERCEPTORS } from '@angular/common/http';\n ┊ 6┊ 6┊import { GraphQLModule } from './graphql.module';\n ┊ 7┊ 7┊import {ChatsListerModule} from './chats-lister/chats-lister.module';\n ┊ 8┊ 8┊import {RouterModule, Routes} from '@angular/router';\n ┊ 9┊ 9┊import {ChatViewerModule} from './chat-viewer/chat-viewer.module';\n ┊10┊10┊import {ChatsCreationModule} from './chats-creation/chats-creation.module';\n+┊  ┊11┊import {LoginModule} from './login/login.module';\n+┊  ┊12┊import {AuthInterceptor} from './login/services/auth.interceptor';\n ┊11┊13┊const routes: Routes = [];\n ┊12┊14┊\n ┊13┊15┊@NgModule({\n```\n```diff\n@@ -24,8 +26,15 @@\n ┊24┊26┊    ChatsListerModule,\n ┊25┊27┊    ChatViewerModule,\n ┊26┊28┊    ChatsCreationModule,\n+┊  ┊29┊    LoginModule,\n+┊  ┊30┊  ],\n+┊  ┊31┊  providers: [\n+┊  ┊32┊    {\n+┊  ┊33┊      provide: HTTP_INTERCEPTORS,\n+┊  ┊34┊      useClass: AuthInterceptor,\n+┊  ┊35┊      multi: true,\n+┊  ┊36┊    },\n ┊27┊37┊  ],\n-┊28┊  ┊  providers: [],\n ┊29┊38┊  bootstrap: [AppComponent]\n ┊30┊39┊})\n ┊31┊40┊export class AppModule {}\n```\n\n[}]: #\n\nAs well as the `AuthGuard`:\n\n[{]: <helper> (diffStep \"10.1\" files=\"src/app/chat-viewer/chat-viewer.module.ts, src/app/chats-creation/chats-creation.module.ts, src/app/chats-lister/chats-lister.module.ts\" module=\"client\")\n\n#### [Step 10.1: Authentication](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/34faf60)\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;chat-viewer.module.ts\n```diff\n@@ -12,11 +12,12 @@\n ┊12┊12┊import {NewMessageComponent} from './components/new-message/new-message.component';\n ┊13┊13┊import {SharedModule} from '../shared/shared.module';\n ┊14┊14┊import {NgxSelectableListModule} from 'ngx-selectable-list';\n+┊  ┊15┊import {AuthGuard} from '../login/services/auth.guard';\n ┊15┊16┊\n ┊16┊17┊const routes: Routes = [\n ┊17┊18┊  {\n ┊18┊19┊    path: 'chat', children: [\n-┊19┊  ┊      {path: ':id', component: ChatComponent},\n+┊  ┊20┊      {path: ':id', canActivate: [AuthGuard], component: ChatComponent},\n ┊20┊21┊    ],\n ┊21┊22┊  },\n ┊22┊23┊];\n```\n\n##### Changed src&#x2F;app&#x2F;chats-creation&#x2F;chats-creation.module.ts\n```diff\n@@ -16,10 +16,11 @@\n ┊16┊16┊import {NewGroupDetailsComponent} from './components/new-group-details/new-group-details.component';\n ┊17┊17┊import {SharedModule} from '../shared/shared.module';\n ┊18┊18┊import {NgxSelectableListModule} from 'ngx-selectable-list';\n+┊  ┊19┊import {AuthGuard} from '../login/services/auth.guard';\n ┊19┊20┊\n ┊20┊21┊const routes: Routes = [\n-┊21┊  ┊  {path: 'new-chat', component: NewChatComponent},\n-┊22┊  ┊  {path: 'new-group', component: NewGroupComponent},\n+┊  ┊22┊  {path: 'new-chat', canActivate: [AuthGuard], component: NewChatComponent},\n+┊  ┊23┊  {path: 'new-group', canActivate: [AuthGuard], component: NewGroupComponent},\n ┊23┊24┊];\n ┊24┊25┊\n ┊25┊26┊@NgModule({\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;chats-lister.module.ts\n```diff\n@@ -12,10 +12,11 @@\n ┊12┊12┊import {TruncateModule} from 'ng2-truncate';\n ┊13┊13┊import {SharedModule} from '../shared/shared.module';\n ┊14┊14┊import {NgxSelectableListModule} from 'ngx-selectable-list';\n+┊  ┊15┊import {AuthGuard} from '../login/services/auth.guard';\n ┊15┊16┊\n ┊16┊17┊const routes: Routes = [\n ┊17┊18┊  {path: '', redirectTo: 'chats', pathMatch: 'full'},\n-┊18┊  ┊  {path: 'chats', component: ChatsComponent},\n+┊  ┊19┊  {path: 'chats', canActivate: [AuthGuard], component: ChatsComponent},\n ┊19┊20┊];\n ┊20┊21┊\n ┊21┊22┊@NgModule({\n```\n\n[}]: #\n\nLast but not the least we need to fix our main service in order to not use the hardcoded user anymore. Instead we will use our Login service to read the user info from the `LocalStorage`.\n\n[{]: <helper> (diffStep \"10.1\" files=\"src/app/services/chats.service.ts\" module=\"client\")\n\n#### [Step 10.1: Authentication](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/34faf60)\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -24,6 +24,7 @@\n ┊24┊24┊} from '../../graphql';\n ┊25┊25┊import { DataProxy } from 'apollo-cache';\n ┊26┊26┊import { FetchResult } from 'apollo-link';\n+┊  ┊27┊import {LoginService} from '../login/services/login.service';\n ┊27┊28┊\n ┊28┊29┊const currentUserId = '1';\n ┊29┊30┊const currentUserName = 'Ethan Gonzalez';\n```\n```diff\n@@ -46,7 +47,8 @@\n ┊46┊47┊    private removeAllMessagesGQL: RemoveAllMessagesGQL,\n ┊47┊48┊    private getUsersGQL: GetUsersGQL,\n ┊48┊49┊    private addChatGQL: AddChatGQL,\n-┊49┊  ┊    private addGroupGQL: AddGroupGQL\n+┊  ┊50┊    private addGroupGQL: AddGroupGQL,\n+┊  ┊51┊    private loginService: LoginService\n ┊50┊52┊  ) {\n ┊51┊53┊    this.getChatsWq = this.getChatsGQL.watch({\n ┊52┊54┊      amount: this.messagesAmount,\n```\n```diff\n@@ -128,11 +130,11 @@\n ┊128┊130┊        addMessage: {\n ┊129┊131┊          id: ChatsService.getRandomId(),\n ┊130┊132┊          __typename: 'Message',\n-┊131┊   ┊          senderId: currentUserId,\n+┊   ┊133┊          senderId: this.loginService.getUser().id,\n ┊132┊134┊          sender: {\n-┊133┊   ┊            id: currentUserId,\n+┊   ┊135┊            id: this.loginService.getUser().id,\n ┊134┊136┊            __typename: 'User',\n-┊135┊   ┊            name: currentUserName,\n+┊   ┊137┊            name: this.loginService.getUser().name,\n ┊136┊138┊          },\n ┊137┊139┊          content,\n ┊138┊140┊          createdAt: moment().unix(),\n```\n```diff\n@@ -315,7 +317,7 @@\n ┊315┊317┊  // Checks if the chat is listed for the current user and returns the id\n ┊316┊318┊  getChatId(recipientId: string) {\n ┊317┊319┊    const _chat = this.chats.find(chat => {\n-┊318┊   ┊      return !chat.isGroup && !!chat.allTimeMembers.find(user => user.id === currentUserId) &&\n+┊   ┊320┊      return !chat.isGroup && !!chat.allTimeMembers.find(user => user.id === this.loginService.getUser().id) &&\n ┊319┊321┊        !!chat.allTimeMembers.find(user => user.id === recipientId);\n ┊320┊322┊    });\n ┊321┊323┊    return _chat ? _chat.id : false;\n```\n```diff\n@@ -335,7 +337,7 @@\n ┊335┊337┊            picture: users.find(user => user.id === recipientId).picture,\n ┊336┊338┊            allTimeMembers: [\n ┊337┊339┊              {\n-┊338┊   ┊                id: currentUserId,\n+┊   ┊340┊                id: this.loginService.getUser().id,\n ┊339┊341┊                __typename: 'User',\n ┊340┊342┊              },\n ┊341┊343┊              {\n```\n```diff\n@@ -387,10 +389,10 @@\n ┊387┊389┊            __typename: 'Chat',\n ┊388┊390┊            name: groupName,\n ┊389┊391┊            picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n-┊390┊   ┊            userIds: [currentUserId, recipientIds],\n+┊   ┊392┊            userIds: [this.loginService.getUser().id, recipientIds],\n ┊391┊393┊            allTimeMembers: [\n ┊392┊394┊              {\n-┊393┊   ┊                id: currentUserId,\n+┊   ┊395┊                id: this.loginService.getUser().id,\n ┊394┊396┊                __typename: 'User',\n ┊395┊397┊              },\n ┊396┊398┊              ...recipientIds.map(id => ({id, __typename: 'User'})),\n```\n\n[}]: #\n\nWe also need to fix our tests:\n\n[{]: <helper> (diffStep \"10.1\" files=\"src/app/chat-viewer/containers/chat/chat.component.spec.ts, src/app/chats-lister/containers/chats/chats.component.spec.ts, src/app/services/chats.service.spec.ts\" module=\"client\")\n\n#### [Step 10.1: Authentication](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/34faf60)\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.spec.ts\n```diff\n@@ -29,6 +29,7 @@\n ┊29┊29┊import { NewMessageComponent } from '../../components/new-message/new-message.component';\n ┊30┊30┊import { MessagesListComponent } from '../../components/messages-list/messages-list.component';\n ┊31┊31┊import { MessageItemComponent } from '../../components/message-item/message-item.component';\n+┊  ┊32┊import { LoginService } from '../../../login/services/login.service';\n ┊32┊33┊\n ┊33┊34┊describe('ChatComponent', () => {\n ┊34┊35┊  let component: ChatComponent;\n```\n```diff\n@@ -134,6 +135,7 @@\n ┊134┊135┊            queryParams: of({}),\n ┊135┊136┊          },\n ┊136┊137┊        },\n+┊   ┊138┊        LoginService,\n ┊137┊139┊      ],\n ┊138┊140┊      schemas: [NO_ERRORS_SCHEMA],\n ┊139┊141┊    }).compileComponents();\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.spec.ts\n```diff\n@@ -24,6 +24,7 @@\n ┊24┊24┊import { ChatsListComponent } from '../../components/chats-list/chats-list.component';\n ┊25┊25┊import { ChatItemComponent } from '../../components/chat-item/chat-item.component';\n ┊26┊26┊import { ChatsService } from '../../../services/chats.service';\n+┊  ┊27┊import { LoginService } from '../../../login/services/login.service';\n ┊27┊28┊\n ┊28┊29┊describe('ChatsComponent', () => {\n ┊29┊30┊  let component: ChatsComponent;\n```\n```diff\n@@ -345,6 +346,7 @@\n ┊345┊346┊            return new InMemoryCache({ dataIdFromObject });\n ┊346┊347┊          },\n ┊347┊348┊        },\n+┊   ┊349┊        LoginService,\n ┊348┊350┊      ],\n ┊349┊351┊      schemas: [NO_ERRORS_SCHEMA],\n ┊350┊352┊    }).compileComponents();\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.spec.ts\n```diff\n@@ -11,6 +11,7 @@\n ┊11┊11┊import { GetChats } from '../../graphql';\n ┊12┊12┊import { dataIdFromObject } from '../graphql.module';\n ┊13┊13┊import { ChatsService } from './chats.service';\n+┊  ┊14┊import {LoginService} from '../login/services/login.service';\n ┊14┊15┊\n ┊15┊16┊describe('ChatsService', () => {\n ┊16┊17┊  let controller: ApolloTestingController;\n```\n```diff\n@@ -312,6 +313,7 @@\n ┊312┊313┊      imports: [ApolloTestingModule],\n ┊313┊314┊      providers: [\n ┊314┊315┊        ChatsService,\n+┊   ┊316┊        LoginService,\n ┊315┊317┊        {\n ┊316┊318┊          provide: APOLLO_TESTING_CACHE,\n ┊317┊319┊          useFactory() {\n```\n\n[}]: #\n\n\n### GraphQL Server behind a firewall\n\nThere's still one thing remaining. Our GraphQL Code Generator setup is broken now. That's because every made request to the server has to have proper rights and currently the codegen's request introspection query is not authenticated. In short, we need to attach an `Authorization` header.\n\nWe're going to implement the following scenario:\n\n1. User runs `yarn generator`\n1. He is asked for a _username_ and a _password_\n1. Our script generates an _Authorization_ header\n1. GraphQL Code Generator get the GraphQL Schema of our server and outputs the types\n\nTo achieve the goal, we need to change the way we interact with the codegen.\nRight now we use GraphQL Code Generator's CLI but the tool allows to use it programatically. So one issue solved.\n\nWhat about getting user's name and password part? We will use in-terminal prompt so user can type those. There's a package for that:\n\n    yarn add -D prompt\n\nNext, create a `src/codegen.ts` file and write our script there:\n\n[{]: <helper> (diffStep \"10.1\" files=\"src/codegen.ts\" module=\"client\")\n\n#### [Step 10.1: Authentication](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/34faf60)\n\n##### Added src&#x2F;codegen.ts\n```diff\n@@ -0,0 +1,46 @@\n+┊  ┊ 1┊import * as prompt from 'prompt';\n+┊  ┊ 2┊import { generate } from 'graphql-code-generator';\n+┊  ┊ 3┊\n+┊  ┊ 4┊interface Credentials {\n+┊  ┊ 5┊  username: string;\n+┊  ┊ 6┊  password: string;\n+┊  ┊ 7┊}\n+┊  ┊ 8┊\n+┊  ┊ 9┊async function getCredentials(): Promise<Credentials> {\n+┊  ┊10┊  return new Promise<Credentials>(resolve => {\n+┊  ┊11┊    prompt.start();\n+┊  ┊12┊    prompt.get(['username', 'password'], (_err, result) => {\n+┊  ┊13┊      resolve({\n+┊  ┊14┊        username: result.username,\n+┊  ┊15┊        password: result.password,\n+┊  ┊16┊      });\n+┊  ┊17┊    });\n+┊  ┊18┊  });\n+┊  ┊19┊}\n+┊  ┊20┊\n+┊  ┊21┊function generateHeaders({ username, password }: Credentials): string[] {\n+┊  ┊22┊  const Authorization = `Basic ${Buffer.from(\n+┊  ┊23┊    `${username}:${password}`,\n+┊  ┊24┊  ).toString('base64')}`;\n+┊  ┊25┊\n+┊  ┊26┊  return [`Authorization: ${Authorization}`];\n+┊  ┊27┊}\n+┊  ┊28┊\n+┊  ┊29┊async function main() {\n+┊  ┊30┊  const credentials = await getCredentials();\n+┊  ┊31┊  const headers = generateHeaders(credentials);\n+┊  ┊32┊\n+┊  ┊33┊  await generate(\n+┊  ┊34┊    {\n+┊  ┊35┊      schema: 'http://localhost:3000/graphql',\n+┊  ┊36┊      template: 'graphql-codegen-apollo-angular-template',\n+┊  ┊37┊      out: './src/graphql.ts',\n+┊  ┊38┊      args: ['./src/graphql/**/*.ts'],\n+┊  ┊39┊      header: headers,\n+┊  ┊40┊      overwrite: true,\n+┊  ┊41┊    },\n+┊  ┊42┊    true,\n+┊  ┊43┊  );\n+┊  ┊44┊}\n+┊  ┊45┊\n+┊  ┊46┊main();\n```\n\n[}]: #\n\nLet's take a closer look what we did there:\n\n- We asks user for a _username_ and a _password_ with `prompt`\n- Based on that we generate a header\n- We put the header in `generate` function\n- there's a `true` value as the second argument, it tells codegen to write the output to a file\n\nWith all of that, whenever we run `yarn generator`, we access the GraphQL server as an authenticated user."
          },
          {
            "manualTitle": "Step 15: Subscriptions",
            "stepRevision": "4468c9c93fec39b398667d2eed81c40e4ae89eb7",
            "manualView": "## Server\n\nIn order to use WebSockets we don't need to install any package, it comes for free with Apollo Server 2.0.\n\nOur GraphQL server will use WebSockets only for subscriptions, while using HTTP for everything else. That means that we will have to add subscriptions on a specific path.\nWe're using `connectionParams` for the authentication over WebSockets, that means that we won't be using the `Passport` framework at all. Instead we will use the `onConnect` hook to manually validate the parameters provided by the user to either validate the WebSocket connection or throw an error.\nWe will also return the user object we retrieved from the db, to let the resolvers know who is the current user.\n\n[{]: <helper> (diffStep \"5.1\" files=\"index.ts\" module=\"server\")\n\n#### [Step 5.1: Subscriptions](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/729c8f0)\n\n##### Changed index.ts\n```diff\n@@ -7,9 +7,12 @@\n ┊ 7┊ 7┊import * as basicStrategy from 'passport-http';\n ┊ 8┊ 8┊import * as bcrypt from 'bcrypt-nodejs';\n ┊ 9┊ 9┊import { db, User } from \"./db\";\n+┊  ┊10┊import { createServer } from \"http\";\n ┊10┊11┊\n ┊11┊12┊let users = db.users;\n ┊12┊13┊\n+┊  ┊14┊console.log(users);\n+┊  ┊15┊\n ┊13┊16┊function generateHash(password: string) {\n ┊14┊17┊  return bcrypt.hashSync(password, bcrypt.genSaltSync(8));\n ┊15┊18┊}\n```\n```diff\n@@ -69,9 +72,30 @@\n ┊ 69┊ 72┊  schema,\n ┊ 70┊ 73┊  context(received: any) {\n ┊ 71┊ 74┊    return {\n-┊ 72┊   ┊      user: received.req!['user'],\n+┊   ┊ 75┊      user: received.connection ? received.connection.context.user : received.req!['user'],\n ┊ 73┊ 76┊    }\n ┊ 74┊ 77┊  },\n+┊   ┊ 78┊  subscriptions: {\n+┊   ┊ 79┊    onConnect: (connectionParams: any, webSocket: any) => {\n+┊   ┊ 80┊      if (connectionParams.authToken) {\n+┊   ┊ 81┊        // create a buffer and tell it the data coming in is base64\n+┊   ┊ 82┊        const buf = new Buffer(connectionParams.authToken.split(' ')[1], 'base64');\n+┊   ┊ 83┊        // read it back out as a string\n+┊   ┊ 84┊        const [username, password]: string[] = buf.toString().split(':');\n+┊   ┊ 85┊        if (username && password) {\n+┊   ┊ 86┊          const user = users.find(user => user.username == username);\n+┊   ┊ 87┊\n+┊   ┊ 88┊          if (user && validPassword(password, user.password)) {\n+┊   ┊ 89┊            // Set context for the WebSocket\n+┊   ┊ 90┊            return {user};\n+┊   ┊ 91┊          } else {\n+┊   ┊ 92┊            throw new Error('Wrong credentials!');\n+┊   ┊ 93┊          }\n+┊   ┊ 94┊        }\n+┊   ┊ 95┊      }\n+┊   ┊ 96┊      throw new Error('Missing auth token!');\n+┊   ┊ 97┊    }\n+┊   ┊ 98┊  }\n ┊ 75┊ 99┊});\n ┊ 76┊100┊\n ┊ 77┊101┊apollo.applyMiddleware({\n```\n```diff\n@@ -79,4 +103,11 @@\n ┊ 79┊103┊  path: '/graphql'\n ┊ 80┊104┊});\n ┊ 81┊105┊\n-┊ 82┊   ┊app.listen(PORT);\n+┊   ┊106┊// Wrap the Express server\n+┊   ┊107┊const ws = createServer(app);\n+┊   ┊108┊\n+┊   ┊109┊apollo.installSubscriptionHandlers(ws);\n+┊   ┊110┊\n+┊   ┊111┊ws.listen(PORT, () => {\n+┊   ┊112┊  console.log(`Apollo Server is now running on http://localhost:${PORT}`);\n+┊   ┊113┊});\n```\n\n[}]: #\n\nWe will use the `PubSub` implementation from `apollo-server-express`, and publish the data using with Apollo Server.\n\nThe process of setting up a GraphQL subscriptions server consist of the following steps:\n\n1. Declaring subscriptions in the GraphQL schema\n2. Setup a PubSub instance that our server will publish new events to\n3. Hook together `PubSub` event and GraphQL subscription.\n4. Setting up `ApolloServer`\n\n[{]: <helper> (diffStep \"5.1\" files=\"schema/typeDefs.ts\" module=\"server\")\n\n#### [Step 5.1: Subscriptions](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/729c8f0)\n\n##### Changed schema&#x2F;typeDefs.ts\n```diff\n@@ -5,6 +5,11 @@\n ┊ 5┊ 5┊    chat(chatId: ID!): Chat\n ┊ 6┊ 6┊  }\n ┊ 7┊ 7┊\n+┊  ┊ 8┊  type Subscription {\n+┊  ┊ 9┊    messageAdded(chatId: ID): Message\n+┊  ┊10┊    chatAdded: Chat\n+┊  ┊11┊  }\n+┊  ┊12┊\n ┊ 8┊13┊  enum MessageType {\n ┊ 9┊14┊    LOCATION\n ┊10┊15┊    TEXT\n```\n\n[}]: #\n\nWe created two subscriptions: one to notify for new chats and one to notify for new messages.\n\n[{]: <helper> (diffStep \"5.1\" files=\"schema/resolvers.ts\" module=\"server\")\n\n#### [Step 5.1: Subscriptions](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/729c8f0)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,7 +1,7 @@\n-┊1┊ ┊import { IResolvers } from 'apollo-server-express';\n+┊ ┊1┊import { PubSub, withFilter, IResolvers } from 'apollo-server-express';\n ┊2┊2┊import { Chat, db, Message, MessageType, Recipient, User } from \"../db\";\n ┊3┊3┊import {\n-┊4┊ ┊  AddChatMutationArgs, AddGroupMutationArgs, AddMessageMutationArgs, ChatQueryArgs,\n+┊ ┊4┊  AddChatMutationArgs, AddGroupMutationArgs, AddMessageMutationArgs, ChatQueryArgs, MessageAddedSubscriptionArgs,\n ┊5┊5┊  RemoveChatMutationArgs, RemoveMessagesMutationArgs\n ┊6┊6┊} from \"../types\";\n ┊7┊7┊import * as moment from \"moment\";\n```\n```diff\n@@ -9,6 +9,8 @@\n ┊ 9┊ 9┊let users = db.users;\n ┊10┊10┊let chats = db.chats;\n ┊11┊11┊\n+┊  ┊12┊export const pubsub = new PubSub();\n+┊  ┊13┊\n ┊12┊14┊export const resolvers: IResolvers = {\n ┊13┊15┊  Query: {\n ┊14┊16┊    // Show all users for the moment.\n```\n```diff\n@@ -50,6 +52,7 @@\n ┊50┊52┊          messages: [],\n ┊51┊53┊        };\n ┊52┊54┊        chats.push(chat);\n+┊  ┊55┊\n ┊53┊56┊        return chat;\n ┊54┊57┊      }\n ┊55┊58┊    },\n```\n```diff\n@@ -73,6 +76,12 @@\n ┊73┊76┊        messages: [],\n ┊74┊77┊      };\n ┊75┊78┊      chats.push(chat);\n+┊  ┊79┊\n+┊  ┊80┊      pubsub.publish('chatAdded', {\n+┊  ┊81┊        creatorId: currentUser.id,\n+┊  ┊82┊        chatAdded: chat,\n+┊  ┊83┊      });\n+┊  ┊84┊\n ┊76┊85┊      return chat;\n ┊77┊86┊    },\n ┊78┊87┊    removeChat: (obj: any, {chatId}: RemoveChatMutationArgs, {user: currentUser}: {user: User}): number => {\n```\n```diff\n@@ -201,6 +210,11 @@\n ┊201┊210┊          });\n ┊202┊211┊\n ┊203┊212┊          holderIds = listingMemberIds;\n+┊   ┊213┊\n+┊   ┊214┊          pubsub.publish('chatAdded', {\n+┊   ┊215┊            creatorId: currentUser.id,\n+┊   ┊216┊            chatAdded: chat,\n+┊   ┊217┊          });\n ┊204┊218┊        }\n ┊205┊219┊      } else {\n ┊206┊220┊        // Group\n```\n```diff\n@@ -245,6 +259,10 @@\n ┊245┊259┊        return chat;\n ┊246┊260┊      });\n ┊247┊261┊\n+┊   ┊262┊      pubsub.publish('messageAdded', {\n+┊   ┊263┊        messageAdded: message,\n+┊   ┊264┊      });\n+┊   ┊265┊\n ┊248┊266┊      return message;\n ┊249┊267┊    },\n ┊250┊268┊    removeMessages: (obj: any, {chatId, messageIds, all}: RemoveMessagesMutationArgs, {user: currentUser}: {user: User}): number[] => {\n```\n```diff\n@@ -286,6 +304,21 @@\n ┊286┊304┊      return deletedIds;\n ┊287┊305┊    },\n ┊288┊306┊  },\n+┊   ┊307┊  Subscription: {\n+┊   ┊308┊    messageAdded: {\n+┊   ┊309┊      subscribe: withFilter(() => pubsub.asyncIterator('messageAdded'),\n+┊   ┊310┊        ({messageAdded}: {messageAdded: Message & {chat: {id: number}}}, {chatId}: MessageAddedSubscriptionArgs, {user: currentUser}: { user: User }) => {\n+┊   ┊311┊          return (!chatId || messageAdded.chat.id === Number(chatId)) &&\n+┊   ┊312┊            !!messageAdded.recipients.find((recipient: Recipient) => recipient.userId === currentUser.id);\n+┊   ┊313┊        }),\n+┊   ┊314┊    },\n+┊   ┊315┊    chatAdded: {\n+┊   ┊316┊      subscribe: withFilter(() => pubsub.asyncIterator('chatAdded'),\n+┊   ┊317┊        ({creatorId, chatAdded}: {creatorId: string, chatAdded: Chat}, variables: any, {user: currentUser}: { user: User }) => {\n+┊   ┊318┊          return Number(creatorId) !== currentUser.id && !chatAdded.listingMemberIds.includes(currentUser.id);\n+┊   ┊319┊        }),\n+┊   ┊320┊    }\n+┊   ┊321┊  },\n ┊289┊322┊  Chat: {\n ┊290┊323┊    name: (chat: Chat, args: any, {user: currentUser}: {user: User}): string => chat.name ? chat.name : users\n ┊291┊324┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser.id))!.name,\n```\n\n[}]: #\n\nWe will publish a message to the `messageAdded` subscription every time that a user sends a message, then we will filter them according to the current user (we don't want to send someone else's messages).\nThe `chatAdded` subscription is similar: we will publish each time that a group gets created, but not when chats get created. This is because when a user creates a chat the chat doesn't appear to the other peer until he writes the first message. That's why we also publish when new messages get added (we first look if the other peer already gets the chat listed).\n\n## Client\n\nIn order to use WebSockets we will need to install a couple of dependencies:\n\n    yarn add apollo-link-ws apollo-utilities subscriptions-transport-ws\n\nFirst let's create the queries for the GraphQL Subscriptions:\n\n[{]: <helper> (diffStep \"11.1\" files=\"src/graphql\" module=\"client\")\n\n#### [Step 11.1: Subscriptions](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/8219b49)\n\n##### Changed src&#x2F;graphql.ts\n```diff\n@@ -651,6 +651,22 @@\n ┊651┊651┊  export type AddMessage = Message.Fragment;\n ┊652┊652┊}\n ┊653┊653┊\n+┊   ┊654┊export namespace ChatAdded {\n+┊   ┊655┊  export type Variables = {};\n+┊   ┊656┊\n+┊   ┊657┊  export type Subscription = {\n+┊   ┊658┊    __typename?: \"Subscription\";\n+┊   ┊659┊    chatAdded?: ChatAdded | null;\n+┊   ┊660┊  };\n+┊   ┊661┊\n+┊   ┊662┊  export type ChatAdded = {\n+┊   ┊663┊    __typename?: \"Chat\";\n+┊   ┊664┊    messages: (Messages | null)[];\n+┊   ┊665┊  } & ChatWithoutMessages.Fragment;\n+┊   ┊666┊\n+┊   ┊667┊  export type Messages = Message.Fragment;\n+┊   ┊668┊}\n+┊   ┊669┊\n ┊654┊670┊export namespace GetChat {\n ┊655┊671┊  export type Variables = {\n ┊656┊672┊    chatId: string;\n```\n```diff\n@@ -703,6 +719,27 @@\n ┊703┊719┊  };\n ┊704┊720┊}\n ┊705┊721┊\n+┊   ┊722┊export namespace MessageAdded {\n+┊   ┊723┊  export type Variables = {\n+┊   ┊724┊    chatId?: string | null;\n+┊   ┊725┊  };\n+┊   ┊726┊\n+┊   ┊727┊  export type Subscription = {\n+┊   ┊728┊    __typename?: \"Subscription\";\n+┊   ┊729┊    messageAdded?: MessageAdded | null;\n+┊   ┊730┊  };\n+┊   ┊731┊\n+┊   ┊732┊  export type MessageAdded = {\n+┊   ┊733┊    __typename?: \"Message\";\n+┊   ┊734┊    chat: Chat;\n+┊   ┊735┊  } & Message.Fragment;\n+┊   ┊736┊\n+┊   ┊737┊  export type Chat = {\n+┊   ┊738┊    __typename?: \"Chat\";\n+┊   ┊739┊    id: string;\n+┊   ┊740┊  };\n+┊   ┊741┊}\n+┊   ┊742┊\n ┊706┊743┊export namespace RemoveAllMessages {\n ┊707┊744┊  export type Variables = {\n ┊708┊745┊    chatId: string;\n```\n```diff\n@@ -924,6 +961,27 @@\n ┊924┊961┊@Injectable({\n ┊925┊962┊  providedIn: \"root\"\n ┊926┊963┊})\n+┊   ┊964┊export class ChatAddedGQL extends Apollo.Subscription<\n+┊   ┊965┊  ChatAdded.Subscription,\n+┊   ┊966┊  ChatAdded.Variables\n+┊   ┊967┊> {\n+┊   ┊968┊  document: any = gql`\n+┊   ┊969┊    subscription chatAdded {\n+┊   ┊970┊      chatAdded {\n+┊   ┊971┊        ...ChatWithoutMessages\n+┊   ┊972┊        messages {\n+┊   ┊973┊          ...Message\n+┊   ┊974┊        }\n+┊   ┊975┊      }\n+┊   ┊976┊    }\n+┊   ┊977┊\n+┊   ┊978┊    ${ChatWithoutMessagesFragment}\n+┊   ┊979┊    ${MessageFragment}\n+┊   ┊980┊  `;\n+┊   ┊981┊}\n+┊   ┊982┊@Injectable({\n+┊   ┊983┊  providedIn: \"root\"\n+┊   ┊984┊})\n ┊927┊985┊export class GetChatGQL extends Apollo.Query<GetChat.Query, GetChat.Variables> {\n ┊928┊986┊  document: any = gql`\n ┊929┊987┊    query GetChat($chatId: ID!) {\n```\n```diff\n@@ -980,6 +1038,26 @@\n ┊ 980┊1038┊@Injectable({\n ┊ 981┊1039┊  providedIn: \"root\"\n ┊ 982┊1040┊})\n+┊    ┊1041┊export class MessageAddedGQL extends Apollo.Subscription<\n+┊    ┊1042┊  MessageAdded.Subscription,\n+┊    ┊1043┊  MessageAdded.Variables\n+┊    ┊1044┊> {\n+┊    ┊1045┊  document: any = gql`\n+┊    ┊1046┊    subscription messageAdded($chatId: ID) {\n+┊    ┊1047┊      messageAdded(chatId: $chatId) {\n+┊    ┊1048┊        ...Message\n+┊    ┊1049┊        chat {\n+┊    ┊1050┊          id\n+┊    ┊1051┊        }\n+┊    ┊1052┊      }\n+┊    ┊1053┊    }\n+┊    ┊1054┊\n+┊    ┊1055┊    ${MessageFragment}\n+┊    ┊1056┊  `;\n+┊    ┊1057┊}\n+┊    ┊1058┊@Injectable({\n+┊    ┊1059┊  providedIn: \"root\"\n+┊    ┊1060┊})\n ┊ 983┊1061┊export class RemoveAllMessagesGQL extends Apollo.Mutation<\n ┊ 984┊1062┊  RemoveAllMessages.Mutation,\n ┊ 985┊1063┊  RemoveAllMessages.Variables\n```\n\n##### Added src&#x2F;graphql&#x2F;chatAdded.subscription.ts\n```diff\n@@ -0,0 +1,17 @@\n+┊  ┊ 1┊import gql from 'graphql-tag';\n+┊  ┊ 2┊import {fragments} from './fragment';\n+┊  ┊ 3┊\n+┊  ┊ 4┊// We use the gql tag to parse our query string into a query document\n+┊  ┊ 5┊export const chatAddedSubscription = gql`\n+┊  ┊ 6┊  subscription chatAdded {\n+┊  ┊ 7┊    chatAdded {\n+┊  ┊ 8┊      ...ChatWithoutMessages\n+┊  ┊ 9┊      messages {\n+┊  ┊10┊        ...Message\n+┊  ┊11┊      }\n+┊  ┊12┊    }\n+┊  ┊13┊  }\n+┊  ┊14┊\n+┊  ┊15┊  ${fragments['chatWithoutMessages']}\n+┊  ┊16┊  ${fragments['message']}\n+┊  ┊17┊`;\n```\n\n##### Added src&#x2F;graphql&#x2F;messageAdded.subscription.ts\n```diff\n@@ -0,0 +1,16 @@\n+┊  ┊ 1┊import gql from 'graphql-tag';\n+┊  ┊ 2┊import {fragments} from './fragment';\n+┊  ┊ 3┊\n+┊  ┊ 4┊// We use the gql tag to parse our query string into a query document\n+┊  ┊ 5┊export const messageAddedSubscription = gql`\n+┊  ┊ 6┊  subscription messageAdded($chatId: ID) {\n+┊  ┊ 7┊    messageAdded(chatId: $chatId) {\n+┊  ┊ 8┊      ...Message\n+┊  ┊ 9┊      chat {\n+┊  ┊10┊        id,\n+┊  ┊11┊      },\n+┊  ┊12┊    }\n+┊  ┊13┊  }\n+┊  ┊14┊\n+┊  ┊15┊  ${fragments['message']}\n+┊  ┊16┊`;\n```\n\n[}]: #\n\nThen we need to run `graphql-code-generator` to generate the types:\n\n    yarn generator\n\nNow we can update the chats service to update the getChats query every time that we receive a new chat from the subscription.\nWith GraphQL subscriptions your client will be alerted on push from the server and you should choose the pattern that fits your application the most:\n\n- Use it as a notification and run any logic you want when it fires, for example alerting the user or refetching data\n- Use the data sent along with the notification and merge it directly into the store (existing queries are automatically notified)\n\nWith subscribeToMore, you can easily do the latter. We will manipulate the store to add the newly created chat.\n\nWe will do to do the same for the newMessage subscription, but this time we will have to update two different queries in the store: getChats and getChat.\n\n[{]: <helper> (diffStep \"11.1\" files=\"src/app/services/chats.service.ts\" module=\"client\")\n\n#### [Step 11.1: Subscriptions](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/8219b49)\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,7 +1,7 @@\n ┊1┊1┊import {concat, map, share, switchMap} from 'rxjs/operators';\n ┊2┊2┊import {Injectable} from '@angular/core';\n ┊3┊3┊import {Observable, AsyncSubject, of} from 'rxjs';\n-┊4┊ ┊import {QueryRef} from 'apollo-angular';\n+┊ ┊4┊import {Apollo, QueryRef} from 'apollo-angular';\n ┊5┊5┊import * as moment from 'moment';\n ┊6┊6┊import {\n ┊7┊7┊  GetChatsGQL,\n```\n```diff\n@@ -13,6 +13,8 @@\n ┊13┊13┊  GetUsersGQL,\n ┊14┊14┊  AddChatGQL,\n ┊15┊15┊  AddGroupGQL,\n+┊  ┊16┊  ChatAddedGQL,\n+┊  ┊17┊  MessageAddedGQL,\n ┊16┊18┊  AddMessage,\n ┊17┊19┊  GetChats,\n ┊18┊20┊  GetChat,\n```\n```diff\n@@ -21,6 +23,7 @@\n ┊21┊23┊  GetUsers,\n ┊22┊24┊  AddChat,\n ┊23┊25┊  AddGroup,\n+┊  ┊26┊  MessageAdded,\n ┊24┊27┊} from '../../graphql';\n ┊25┊28┊import { DataProxy } from 'apollo-cache';\n ┊26┊29┊import { FetchResult } from 'apollo-link';\n```\n```diff\n@@ -48,11 +51,69 @@\n ┊ 48┊ 51┊    private getUsersGQL: GetUsersGQL,\n ┊ 49┊ 52┊    private addChatGQL: AddChatGQL,\n ┊ 50┊ 53┊    private addGroupGQL: AddGroupGQL,\n+┊   ┊ 54┊    private chatAddedGQL: ChatAddedGQL,\n+┊   ┊ 55┊    private messageAddedGQL: MessageAddedGQL,\n+┊   ┊ 56┊    private apollo: Apollo,\n ┊ 51┊ 57┊    private loginService: LoginService\n ┊ 52┊ 58┊  ) {\n ┊ 53┊ 59┊    this.getChatsWq = this.getChatsGQL.watch({\n ┊ 54┊ 60┊      amount: this.messagesAmount,\n ┊ 55┊ 61┊    });\n+┊   ┊ 62┊\n+┊   ┊ 63┊    this.getChatsWq.subscribeToMore({\n+┊   ┊ 64┊      document: this.chatAddedGQL.document,\n+┊   ┊ 65┊      updateQuery: (prev: GetChats.Query, { subscriptionData }) => {\n+┊   ┊ 66┊        if (!subscriptionData.data) {\n+┊   ┊ 67┊          return prev;\n+┊   ┊ 68┊        }\n+┊   ┊ 69┊\n+┊   ┊ 70┊        const newChat: GetChats.Chats = subscriptionData.data.chatAdded;\n+┊   ┊ 71┊\n+┊   ┊ 72┊        return Object.assign({}, prev, {\n+┊   ┊ 73┊          chats: [...prev.chats, newChat]\n+┊   ┊ 74┊        });\n+┊   ┊ 75┊      }\n+┊   ┊ 76┊    });\n+┊   ┊ 77┊\n+┊   ┊ 78┊    this.getChatsWq.subscribeToMore({\n+┊   ┊ 79┊      document: this.messageAddedGQL.document,\n+┊   ┊ 80┊      updateQuery: (prev: GetChats.Query, { subscriptionData }) => {\n+┊   ┊ 81┊        if (!subscriptionData.data) {\n+┊   ┊ 82┊          return prev;\n+┊   ┊ 83┊        }\n+┊   ┊ 84┊\n+┊   ┊ 85┊        const newMessage: MessageAdded.MessageAdded = subscriptionData.data.messageAdded;\n+┊   ┊ 86┊\n+┊   ┊ 87┊        // We need to update the cache for both Chat and Chats. The following updates the cache for Chat.\n+┊   ┊ 88┊        try {\n+┊   ┊ 89┊          // Read the data from our cache for this query.\n+┊   ┊ 90┊          const {chat}: GetChat.Query = this.apollo.getClient().readQuery({\n+┊   ┊ 91┊            query: this.getChatGQL.document,\n+┊   ┊ 92┊            variables: {\n+┊   ┊ 93┊              chatId: newMessage.chat.id,\n+┊   ┊ 94┊            }\n+┊   ┊ 95┊          });\n+┊   ┊ 96┊\n+┊   ┊ 97┊          // Add our message from the mutation to the end.\n+┊   ┊ 98┊          chat.messages.push(newMessage);\n+┊   ┊ 99┊          // Write our data back to the cache.\n+┊   ┊100┊          this.apollo.getClient().writeQuery({\n+┊   ┊101┊            query: this.getChatGQL.document,\n+┊   ┊102┊            data: {\n+┊   ┊103┊              chat\n+┊   ┊104┊            }\n+┊   ┊105┊          });\n+┊   ┊106┊        } catch {\n+┊   ┊107┊          console.error('The chat we received an update for does not exist in the store');\n+┊   ┊108┊        }\n+┊   ┊109┊\n+┊   ┊110┊        return Object.assign({}, prev, {\n+┊   ┊111┊          chats: [...prev.chats.map(_chat =>\n+┊   ┊112┊            _chat.id === newMessage.chat.id ? {..._chat, messages: [..._chat.messages, newMessage]} : _chat)]\n+┊   ┊113┊        });\n+┊   ┊114┊      }\n+┊   ┊115┊    });\n+┊   ┊116┊\n ┊ 56┊117┊    this.chats$ = this.getChatsWq.valueChanges.pipe(\n ┊ 57┊118┊      map((result) => result.data.chats)\n ┊ 58┊119┊    );\n```\n```diff\n@@ -130,6 +191,10 @@\n ┊130┊191┊        addMessage: {\n ┊131┊192┊          id: ChatsService.getRandomId(),\n ┊132┊193┊          __typename: 'Message',\n+┊   ┊194┊          chat: {\n+┊   ┊195┊            id: chatId,\n+┊   ┊196┊            __typename: 'Chat',\n+┊   ┊197┊          },\n ┊133┊198┊          senderId: this.loginService.getUser().id,\n ┊134┊199┊          sender: {\n ┊135┊200┊            id: this.loginService.getUser().id,\n```\n\n[}]: #\n\nWe can finally configure the WebSocket in the GraphQL Module. Please notice that the WebSocket has its own authentication instead of using the `HttpInterceptor`, in fact we use `connectionParams` to send the authorization.\nAll queries will go through HTTP except the Subscriptions, which will use the WebSocket.\n\n[{]: <helper> (diffStep \"11.1\" files=\"src/app/graphql.module.ts\" module=\"client\")\n\n#### [Step 11.1: Subscriptions](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/8219b49)\n\n##### Changed src&#x2F;app&#x2F;graphql.module.ts\n```diff\n@@ -2,6 +2,11 @@\n ┊ 2┊ 2┊import { ApolloModule, APOLLO_OPTIONS } from 'apollo-angular';\n ┊ 3┊ 3┊import { HttpLinkModule, HttpLink } from 'apollo-angular-link-http';\n ┊ 4┊ 4┊import { InMemoryCache, defaultDataIdFromObject } from 'apollo-cache-inmemory';\n+┊  ┊ 5┊import {getMainDefinition} from 'apollo-utilities';\n+┊  ┊ 6┊import {OperationDefinitionNode} from 'graphql';\n+┊  ┊ 7┊import {split} from 'apollo-link';\n+┊  ┊ 8┊import {WebSocketLink} from 'apollo-link-ws';\n+┊  ┊ 9┊import {LoginService} from './login/services/login.service';\n ┊ 5┊10┊\n ┊ 6┊11┊const uri = 'http://localhost:3000/graphql';\n ┊ 7┊12┊\n```\n```diff\n@@ -14,9 +19,28 @@\n ┊14┊19┊  }\n ┊15┊20┊};\n ┊16┊21┊\n-┊17┊  ┊export function createApollo(httpLink: HttpLink) {\n+┊  ┊22┊export function createApollo(httpLink: HttpLink, loginService: LoginService) {\n+┊  ┊23┊  const subscriptionLink = new WebSocketLink({\n+┊  ┊24┊    uri: uri.replace('http', 'ws'),\n+┊  ┊25┊    options: {\n+┊  ┊26┊      reconnect: true,\n+┊  ┊27┊      connectionParams: () => ({\n+┊  ┊28┊        authToken: loginService.getAuthHeader() || null\n+┊  ┊29┊      })\n+┊  ┊30┊    }\n+┊  ┊31┊  });\n+┊  ┊32┊\n+┊  ┊33┊  const link = split(\n+┊  ┊34┊    ({ query }) => {\n+┊  ┊35┊      const { kind, operation } = getMainDefinition(query) as OperationDefinitionNode;\n+┊  ┊36┊      return kind === 'OperationDefinition' && operation === 'subscription';\n+┊  ┊37┊    },\n+┊  ┊38┊    subscriptionLink,\n+┊  ┊39┊    httpLink.create({uri})\n+┊  ┊40┊  );\n+┊  ┊41┊\n ┊18┊42┊  return {\n-┊19┊  ┊    link: httpLink.create({ uri }),\n+┊  ┊43┊    link,\n ┊20┊44┊    cache: new InMemoryCache({\n ┊21┊45┊      dataIdFromObject,\n ┊22┊46┊    }),\n```\n```diff\n@@ -29,7 +53,7 @@\n ┊29┊53┊    {\n ┊30┊54┊      provide: APOLLO_OPTIONS,\n ┊31┊55┊      useFactory: createApollo,\n-┊32┊  ┊      deps: [HttpLink],\n+┊  ┊56┊      deps: [HttpLink, LoginService],\n ┊33┊57┊    },\n ┊34┊58┊  ],\n ┊35┊59┊})\n```\n\n[}]: #\n\nWe used `split` of ApolloLink to decide which path should a request get, through WebSocket or HTTP. We decided to push subscriptions over the WebSocket and the rest normally, just like before.\n\nFinally, let's fix the tests:\n\n[{]: <helper> (diffStep \"11.1\" files=\"src/app/chat-viewer/containers/chat/chat.component.spec.ts, src/app/chats-lister/containers/chats/chats.component.spec.ts, src/app/services/chats.service.spec.ts\" module=\"client\")\n\n#### [Step 11.1: Subscriptions](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/8219b49)\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.spec.ts\n```diff\n@@ -148,6 +148,8 @@\n ┊148┊148┊    component = fixture.componentInstance;\n ┊149┊149┊    fixture.detectChanges();\n ┊150┊150┊\n+┊   ┊151┊    controller.expectOne('chatAdded', 'call to chatAdded api');\n+┊   ┊152┊    controller.expectOne('messageAdded', 'call to messageAdded api');\n ┊151┊153┊    controller.expectOne('GetChats', 'call to getChats api');\n ┊152┊154┊\n ┊153┊155┊    const req = controller.expectOne('GetChat', 'call to getChat api');\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.spec.ts\n```diff\n@@ -360,8 +360,10 @@\n ┊360┊360┊    component = fixture.componentInstance;\n ┊361┊361┊    fixture.detectChanges();\n ┊362┊362┊\n-┊363┊   ┊    const req = controller.expectOne('GetChats', 'GetChats operation');\n+┊   ┊363┊    controller.expectOne('chatAdded', 'call to chatAdded api');\n+┊   ┊364┊    controller.expectOne('messageAdded', 'call to messageAdded api');\n ┊364┊365┊\n+┊   ┊366┊    const req = controller.expectOne('GetChats', 'GetChats operation');\n ┊365┊367┊    req.flush({\n ┊366┊368┊      data: {\n ┊367┊369┊        chats,\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.spec.ts\n```diff\n@@ -11,7 +11,7 @@\n ┊11┊11┊import { GetChats } from '../../graphql';\n ┊12┊12┊import { dataIdFromObject } from '../graphql.module';\n ┊13┊13┊import { ChatsService } from './chats.service';\n-┊14┊  ┊import {LoginService} from '../login/services/login.service';\n+┊  ┊14┊import { LoginService } from '../login/services/login.service';\n ┊15┊15┊\n ┊16┊16┊describe('ChatsService', () => {\n ┊17┊17┊  let controller: ApolloTestingController;\n```\n```diff\n@@ -341,6 +341,9 @@\n ┊341┊341┊      }\n ┊342┊342┊    });\n ┊343┊343┊\n+┊   ┊344┊    controller.expectOne('chatAdded', 'call to chatAdded api');\n+┊   ┊345┊    controller.expectOne('messageAdded', 'call to messageAdded api');\n+┊   ┊346┊\n ┊344┊347┊    const req = controller.expectOne('GetChats', 'GetChats operation');\n ┊345┊348┊\n ┊346┊349┊    req.flush({\n```\n\n[}]: #"
          },
          {
            "manualTitle": "Step 16: TypeORM with PostgreSQL",
            "stepRevision": "8686ed12d75fe225a178dd89175a3e594df424c9",
            "manualView": "## Server\n\nFirst of all you will have to install PostgreSQL on your operating system. Since there so many options (different Linux distributions, MacOS X, Windows...) I will assume that you already know how to install a software in your OS and take that part for granted.\n\nThen you will have to install a couple of packages:\n\n    yarn add pg reflect-metadata typeorm\n    yarn add -D @types/pg\n\nWe aren't going to use plain SQL, instead we will use an Object-relational mapping framework (ORM) called `TypeORM`.\n`TypeORM` takes advantage of Typescript classes and type declarations in order to infer the db structure.\n\nWe will need to enable support for experimental decorators, emit type metadata for decorators and disable strict property initialization:\n\n[{]: <helper> (diffStep \"6.1\" files=\"tsconfig.json\" module=\"server\")\n\n#### [Step 6.1: TypeORM with PostgreSQL](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/00c4cab)\n\n##### Changed tsconfig.json\n```diff\n@@ -22,11 +22,11 @@\n ┊22┊22┊    // \"isolatedModules\": true,               /* Transpile each file as a separate module (similar to 'ts.transpileModule'). */\n ┊23┊23┊\n ┊24┊24┊    /* Strict Type-Checking Options */\n-┊25┊  ┊    \"strict\": true,                            /* Enable all strict type-checking options. */\n+┊  ┊25┊    \"strict\": true,                           /* Enable all strict type-checking options. */\n ┊26┊26┊    // \"noImplicitAny\": true,                 /* Raise error on expressions and declarations with an implied 'any' type. */\n ┊27┊27┊    // \"strictNullChecks\": true,              /* Enable strict null checks. */\n ┊28┊28┊    // See https://github.com/DefinitelyTyped/DefinitelyTyped/issues/21359\n-┊29┊  ┊    \"strictFunctionTypes\": false              /* Enable strict checking of function types. */\n+┊  ┊29┊    \"strictFunctionTypes\": false,             /* Enable strict checking of function types. */\n ┊30┊30┊    // \"noImplicitThis\": true,                /* Raise error on 'this' expressions with an implied 'any' type. */\n ┊31┊31┊    // \"alwaysStrict\": true,                  /* Parse in strict mode and emit \"use strict\" for each source file. */\n ┊32┊32┊\n```\n```diff\n@@ -53,7 +53,8 @@\n ┊53┊53┊    // \"inlineSources\": true,                 /* Emit the source alongside the sourcemaps within a single file; requires '--inlineSourceMap' or '--sourceMap' to be set. */\n ┊54┊54┊\n ┊55┊55┊    /* Experimental Options */\n-┊56┊  ┊    // \"experimentalDecorators\": true,        /* Enables experimental support for ES7 decorators. */\n-┊57┊  ┊    // \"emitDecoratorMetadata\": true,         /* Enables experimental support for emitting type metadata for decorators. */\n+┊  ┊56┊    \"experimentalDecorators\": true,           /* Enables experimental support for ES7 decorators. */\n+┊  ┊57┊    \"emitDecoratorMetadata\": true,            /* Enables experimental support for emitting type metadata for decorators. */\n+┊  ┊58┊    \"strictPropertyInitialization\": false\n ┊58┊59┊  }\n ┊59┊60┊}🚫↵\n```\n\n[}]: #\n\nThe next step is to create Entities. An Entity is a class that maps to a database table. You can create a entity by defining a new class and mark it with @Entity():\n\n[{]: <helper> (diffStep \"6.1\" files=\"entity\" module=\"server\")\n\n#### [Step 6.1: TypeORM with PostgreSQL](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/00c4cab)\n\n##### Added entity&#x2F;Chat.ts\n```diff\n@@ -0,0 +1,79 @@\n+┊  ┊ 1┊import { Entity, Column, PrimaryGeneratedColumn, OneToMany, JoinTable, ManyToMany, ManyToOne } from \"typeorm\";\n+┊  ┊ 2┊import { Message } from \"./Message\";\n+┊  ┊ 3┊import { User } from \"./User\";\n+┊  ┊ 4┊import { Recipient } from \"./Recipient\";\n+┊  ┊ 5┊\n+┊  ┊ 6┊interface ChatConstructor {\n+┊  ┊ 7┊  name?: string;\n+┊  ┊ 8┊  picture?: string;\n+┊  ┊ 9┊  allTimeMembers?: User[];\n+┊  ┊10┊  listingMembers?: User[];\n+┊  ┊11┊  actualGroupMembers?: User[];\n+┊  ┊12┊  admins?: User[];\n+┊  ┊13┊  owner?: User;\n+┊  ┊14┊  messages?: Message[];\n+┊  ┊15┊}\n+┊  ┊16┊\n+┊  ┊17┊@Entity()\n+┊  ┊18┊export class Chat {\n+┊  ┊19┊  @PrimaryGeneratedColumn()\n+┊  ┊20┊  id: number;\n+┊  ┊21┊\n+┊  ┊22┊  @Column({nullable: true})\n+┊  ┊23┊  name: string;\n+┊  ┊24┊\n+┊  ┊25┊  @Column({nullable: true})\n+┊  ┊26┊  picture: string;\n+┊  ┊27┊\n+┊  ┊28┊  @ManyToMany(type => User, user => user.allTimeMemberChats, {cascade: [\"insert\", \"update\"], eager: false})\n+┊  ┊29┊  @JoinTable()\n+┊  ┊30┊  allTimeMembers: User[];\n+┊  ┊31┊\n+┊  ┊32┊  @ManyToMany(type => User, user => user.listingMemberChats, {cascade: [\"insert\", \"update\"], eager: false})\n+┊  ┊33┊  @JoinTable()\n+┊  ┊34┊  listingMembers: User[];\n+┊  ┊35┊\n+┊  ┊36┊  @ManyToMany(type => User, user => user.actualGroupMemberChats, {cascade: [\"insert\", \"update\"], eager: false})\n+┊  ┊37┊  @JoinTable()\n+┊  ┊38┊  actualGroupMembers?: User[];\n+┊  ┊39┊\n+┊  ┊40┊  @ManyToMany(type => User, user => user.adminChats, {cascade: [\"insert\", \"update\"], eager: false})\n+┊  ┊41┊  @JoinTable()\n+┊  ┊42┊  admins?: User[];\n+┊  ┊43┊\n+┊  ┊44┊  @ManyToOne(type => User, user => user.ownerChats, {cascade: [\"insert\", \"update\"], eager: false})\n+┊  ┊45┊  owner?: User | null;\n+┊  ┊46┊\n+┊  ┊47┊  @OneToMany(type => Message, message => message.chat, {cascade: [\"insert\", \"update\"], eager: true})\n+┊  ┊48┊  messages: Message[];\n+┊  ┊49┊\n+┊  ┊50┊  @OneToMany(type => Recipient, recipient => recipient.chat)\n+┊  ┊51┊  recipients: Recipient[];\n+┊  ┊52┊\n+┊  ┊53┊  constructor({name, picture, allTimeMembers, listingMembers, actualGroupMembers, admins, owner, messages}: ChatConstructor = {}) {\n+┊  ┊54┊    if (name) {\n+┊  ┊55┊      this.name = name;\n+┊  ┊56┊    }\n+┊  ┊57┊    if (picture) {\n+┊  ┊58┊      this.picture = picture;\n+┊  ┊59┊    }\n+┊  ┊60┊    if (allTimeMembers) {\n+┊  ┊61┊      this.allTimeMembers = allTimeMembers;\n+┊  ┊62┊    }\n+┊  ┊63┊    if (listingMembers) {\n+┊  ┊64┊      this.listingMembers = listingMembers;\n+┊  ┊65┊    }\n+┊  ┊66┊    if (actualGroupMembers) {\n+┊  ┊67┊      this.actualGroupMembers = actualGroupMembers;\n+┊  ┊68┊    }\n+┊  ┊69┊    if (admins) {\n+┊  ┊70┊      this.admins = admins;\n+┊  ┊71┊    }\n+┊  ┊72┊    if (owner) {\n+┊  ┊73┊      this.owner = owner;\n+┊  ┊74┊    }\n+┊  ┊75┊    if (messages) {\n+┊  ┊76┊      this.messages = messages;\n+┊  ┊77┊    }\n+┊  ┊78┊  }\n+┊  ┊79┊}\n```\n\n##### Added entity&#x2F;Message.ts\n```diff\n@@ -0,0 +1,70 @@\n+┊  ┊ 1┊import {\n+┊  ┊ 2┊  Entity, Column, PrimaryGeneratedColumn, OneToMany, ManyToOne, ManyToMany, JoinTable, CreateDateColumn\n+┊  ┊ 3┊} from \"typeorm\";\n+┊  ┊ 4┊import { Chat } from \"./Chat\";\n+┊  ┊ 5┊import { User } from \"./User\";\n+┊  ┊ 6┊import { Recipient } from \"./Recipient\";\n+┊  ┊ 7┊import { MessageType } from \"../db\";\n+┊  ┊ 8┊\n+┊  ┊ 9┊interface MessageConstructor {\n+┊  ┊10┊  sender?: User;\n+┊  ┊11┊  content?: string;\n+┊  ┊12┊  createdAt?: Date,\n+┊  ┊13┊  type?: MessageType;\n+┊  ┊14┊  recipients?: Recipient[];\n+┊  ┊15┊  holders?: User[];\n+┊  ┊16┊  chat?: Chat;\n+┊  ┊17┊}\n+┊  ┊18┊\n+┊  ┊19┊@Entity()\n+┊  ┊20┊export class Message {\n+┊  ┊21┊  @PrimaryGeneratedColumn()\n+┊  ┊22┊  id: number;\n+┊  ┊23┊\n+┊  ┊24┊  @ManyToOne(type => User, user => user.senderMessages, {eager: true})\n+┊  ┊25┊  sender: User;\n+┊  ┊26┊\n+┊  ┊27┊  @Column()\n+┊  ┊28┊  content: string;\n+┊  ┊29┊\n+┊  ┊30┊  @CreateDateColumn({nullable: true})\n+┊  ┊31┊  createdAt: Date;\n+┊  ┊32┊\n+┊  ┊33┊  @Column()\n+┊  ┊34┊  type: number;\n+┊  ┊35┊\n+┊  ┊36┊  @OneToMany(type => Recipient, recipient => recipient.message, {cascade: [\"insert\", \"update\"], eager: true})\n+┊  ┊37┊  recipients: Recipient[];\n+┊  ┊38┊\n+┊  ┊39┊  @ManyToMany(type => User, user => user.holderMessages, {cascade: [\"insert\", \"update\"], eager: true})\n+┊  ┊40┊  @JoinTable()\n+┊  ┊41┊  holders: User[];\n+┊  ┊42┊\n+┊  ┊43┊  @ManyToOne(type => Chat, chat => chat.messages)\n+┊  ┊44┊  chat: Chat;\n+┊  ┊45┊\n+┊  ┊46┊  constructor({sender, content, createdAt, type, recipients, holders, chat}: MessageConstructor = {}) {\n+┊  ┊47┊    if (sender) {\n+┊  ┊48┊      this.sender = sender;\n+┊  ┊49┊    }\n+┊  ┊50┊    if (content) {\n+┊  ┊51┊      this.content = content;\n+┊  ┊52┊    }\n+┊  ┊53┊    if (createdAt) {\n+┊  ┊54┊      this.createdAt = createdAt;\n+┊  ┊55┊    }\n+┊  ┊56┊    if (type) {\n+┊  ┊57┊      this.type = type;\n+┊  ┊58┊    }\n+┊  ┊59┊    if (recipients) {\n+┊  ┊60┊      recipients.forEach(recipient => recipient.message = this);\n+┊  ┊61┊      this.recipients = recipients;\n+┊  ┊62┊    }\n+┊  ┊63┊    if (holders) {\n+┊  ┊64┊      this.holders = holders;\n+┊  ┊65┊    }\n+┊  ┊66┊    if (chat) {\n+┊  ┊67┊      this.chat = chat;\n+┊  ┊68┊    }\n+┊  ┊69┊  }\n+┊  ┊70┊}\n```\n\n##### Added entity&#x2F;Recipient.ts\n```diff\n@@ -0,0 +1,44 @@\n+┊  ┊ 1┊import { Entity, ManyToOne, Column } from \"typeorm\";\n+┊  ┊ 2┊import { Message } from \"./Message\";\n+┊  ┊ 3┊import { User } from \"./User\";\n+┊  ┊ 4┊import { Chat } from \"./Chat\";\n+┊  ┊ 5┊\n+┊  ┊ 6┊interface RecipientConstructor {\n+┊  ┊ 7┊  user?: User;\n+┊  ┊ 8┊  message?: Message;\n+┊  ┊ 9┊  receivedAt?: Date;\n+┊  ┊10┊  readAt?: Date;\n+┊  ┊11┊}\n+┊  ┊12┊\n+┊  ┊13┊@Entity()\n+┊  ┊14┊export class Recipient {\n+┊  ┊15┊  @ManyToOne(type => User, user => user.recipients, { primary: true })\n+┊  ┊16┊  user: User;\n+┊  ┊17┊\n+┊  ┊18┊  @ManyToOne(type => Message, message => message.recipients, { primary: true })\n+┊  ┊19┊  message: Message;\n+┊  ┊20┊\n+┊  ┊21┊  @ManyToOne(type => Chat, chat => chat.recipients)\n+┊  ┊22┊  chat: Chat;\n+┊  ┊23┊\n+┊  ┊24┊  @Column({nullable: true})\n+┊  ┊25┊  receivedAt: Date;\n+┊  ┊26┊\n+┊  ┊27┊  @Column({nullable: true})\n+┊  ┊28┊  readAt: Date;\n+┊  ┊29┊\n+┊  ┊30┊  constructor({user, message, receivedAt, readAt}: RecipientConstructor = {}) {\n+┊  ┊31┊    if (user) {\n+┊  ┊32┊      this.user = user;\n+┊  ┊33┊    }\n+┊  ┊34┊    if (message) {\n+┊  ┊35┊      this.message = message;\n+┊  ┊36┊    }\n+┊  ┊37┊    if (receivedAt) {\n+┊  ┊38┊      this.receivedAt = receivedAt;\n+┊  ┊39┊    }\n+┊  ┊40┊    if (readAt) {\n+┊  ┊41┊      this.readAt = readAt;\n+┊  ┊42┊    }\n+┊  ┊43┊  }\n+┊  ┊44┊}\n```\n\n##### Added entity&#x2F;User.ts\n```diff\n@@ -0,0 +1,75 @@\n+┊  ┊ 1┊import { Entity, Column, PrimaryGeneratedColumn, ManyToMany, OneToMany } from \"typeorm\";\n+┊  ┊ 2┊import { Chat } from \"./Chat\";\n+┊  ┊ 3┊import { Message } from \"./Message\";\n+┊  ┊ 4┊import { Recipient } from \"./Recipient\";\n+┊  ┊ 5┊\n+┊  ┊ 6┊interface UserConstructor {\n+┊  ┊ 7┊  username?: string;\n+┊  ┊ 8┊  password?: string;\n+┊  ┊ 9┊  name?: string;\n+┊  ┊10┊  picture?: string;\n+┊  ┊11┊  phone?: string;\n+┊  ┊12┊}\n+┊  ┊13┊\n+┊  ┊14┊@Entity()\n+┊  ┊15┊export class User {\n+┊  ┊16┊  @PrimaryGeneratedColumn()\n+┊  ┊17┊  id: number;\n+┊  ┊18┊\n+┊  ┊19┊  @Column()\n+┊  ┊20┊  username: string;\n+┊  ┊21┊\n+┊  ┊22┊  @Column()\n+┊  ┊23┊  password: string;\n+┊  ┊24┊\n+┊  ┊25┊  @Column()\n+┊  ┊26┊  name: string;\n+┊  ┊27┊\n+┊  ┊28┊  @Column({nullable: true})\n+┊  ┊29┊  picture: string;\n+┊  ┊30┊\n+┊  ┊31┊  @Column({nullable: true})\n+┊  ┊32┊  phone?: string;\n+┊  ┊33┊\n+┊  ┊34┊  @ManyToMany(type => Chat, chat => chat.allTimeMembers)\n+┊  ┊35┊  allTimeMemberChats: Chat[];\n+┊  ┊36┊\n+┊  ┊37┊  @ManyToMany(type => Chat, chat => chat.listingMembers)\n+┊  ┊38┊  listingMemberChats: Chat[];\n+┊  ┊39┊\n+┊  ┊40┊  @ManyToMany(type => Chat, chat => chat.actualGroupMembers)\n+┊  ┊41┊  actualGroupMemberChats: Chat[];\n+┊  ┊42┊\n+┊  ┊43┊  @ManyToMany(type => Chat, chat => chat.admins)\n+┊  ┊44┊  adminChats: Chat[];\n+┊  ┊45┊\n+┊  ┊46┊  @ManyToMany(type => Message, message => message.holders)\n+┊  ┊47┊  holderMessages: Message[];\n+┊  ┊48┊\n+┊  ┊49┊  @OneToMany(type => Chat, chat => chat.owner)\n+┊  ┊50┊  ownerChats: Chat[];\n+┊  ┊51┊\n+┊  ┊52┊  @OneToMany(type => Message, message => message.sender)\n+┊  ┊53┊  senderMessages: Message[];\n+┊  ┊54┊\n+┊  ┊55┊  @OneToMany(type => Recipient, recipient => recipient.user)\n+┊  ┊56┊  recipients: Recipient[];\n+┊  ┊57┊\n+┊  ┊58┊  constructor({username, password, name, picture, phone}: UserConstructor = {}) {\n+┊  ┊59┊    if (username) {\n+┊  ┊60┊      this.username = username;\n+┊  ┊61┊    }\n+┊  ┊62┊    if (password) {\n+┊  ┊63┊      this.password = password;\n+┊  ┊64┊    }\n+┊  ┊65┊    if (name) {\n+┊  ┊66┊      this.name = name;\n+┊  ┊67┊    }\n+┊  ┊68┊    if (picture) {\n+┊  ┊69┊      this.picture = picture;\n+┊  ┊70┊    }\n+┊  ┊71┊    if (phone) {\n+┊  ┊72┊      this.phone = phone;\n+┊  ┊73┊    }\n+┊  ┊74┊  }\n+┊  ┊75┊}\n```\n\n[}]: #\n\nBasic entities consist of columns and relations. Each entity MUST have a primary column.\n\nEach entity must be registered in your connection options:\n\n[{]: <helper> (diffStep \"6.1\" files=\"ormconfig.json\" module=\"server\")\n\n#### [Step 6.1: TypeORM with PostgreSQL](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/00c4cab)\n\n##### Added ormconfig.json\n```diff\n@@ -0,0 +1,24 @@\n+┊  ┊ 1┊{\n+┊  ┊ 2┊   \"type\": \"postgres\",\n+┊  ┊ 3┊   \"host\": \"localhost\",\n+┊  ┊ 4┊   \"port\": 5432,\n+┊  ┊ 5┊   \"username\": \"test\",\n+┊  ┊ 6┊   \"password\": \"\",\n+┊  ┊ 7┊   \"database\": \"test\",\n+┊  ┊ 8┊   \"synchronize\": true,\n+┊  ┊ 9┊   \"logging\": false,\n+┊  ┊10┊   \"entities\": [\n+┊  ┊11┊      \"entity/**/*.ts\"\n+┊  ┊12┊   ],\n+┊  ┊13┊   \"migrations\": [\n+┊  ┊14┊      \"migration/**/*.ts\"\n+┊  ┊15┊   ],\n+┊  ┊16┊   \"subscribers\": [\n+┊  ┊17┊      \"subscriber/**/*.ts\"\n+┊  ┊18┊   ],\n+┊  ┊19┊   \"cli\": {\n+┊  ┊20┊      \"entitiesDir\": \"entity\",\n+┊  ┊21┊      \"migrationsDir\": \"migration\",\n+┊  ┊22┊      \"subscribersDir\": \"subscriber\"\n+┊  ┊23┊   }\n+┊  ┊24┊}🚫↵\n```\n\n[}]: #\n\nSince database table consist of columns your entities must consist of columns too. Each entity class property you marked with @Column will be mapped to a database table column.\nEach entity must have at least one primary column. There are several types of primary columns, but in our case `@PrimaryGeneratedColumn()` creates a primary column which value will be automatically generated with an auto-increment value.\n`@CreateDateColumn` is a special column that is automatically set to the entity's insertion date. You don't need set this column - it will be automatically set.\nFor the Recipient Entity we use a composite primary key that consists of two foreign keys.\n\nThe next thing to do is to create a connection with the database before firing up the web server:\n\n[{]: <helper> (diffStep \"6.1\" files=\"index.ts\" module=\"server\")\n\n#### [Step 6.1: TypeORM with PostgreSQL](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/00c4cab)\n\n##### Changed index.ts\n```diff\n@@ -1,3 +1,5 @@\n+┊ ┊1┊// For TypeORM\n+┊ ┊2┊import \"reflect-metadata\";\n ┊1┊3┊import { schema } from \"./schema\";\n ┊2┊4┊import * as bodyParser from \"body-parser\";\n ┊3┊5┊import * as cors from 'cors';\n```\n```diff\n@@ -6,12 +8,10 @@\n ┊ 6┊ 8┊import * as passport from \"passport\";\n ┊ 7┊ 9┊import * as basicStrategy from 'passport-http';\n ┊ 8┊10┊import * as bcrypt from 'bcrypt-nodejs';\n-┊ 9┊  ┊import { db, User } from \"./db\";\n ┊10┊11┊import { createServer } from \"http\";\n-┊11┊  ┊\n-┊12┊  ┊let users = db.users;\n-┊13┊  ┊\n-┊14┊  ┊console.log(users);\n+┊  ┊12┊import { createConnection } from \"typeorm\";\n+┊  ┊13┊import { User } from \"./entity/User\";\n+┊  ┊14┊import { addSampleData } from \"./db\";\n ┊15┊15┊\n ┊16┊16┊function generateHash(password: string) {\n ┊17┊17┊  return bcrypt.hashSync(password, bcrypt.genSaltSync(8));\n```\n```diff\n@@ -21,93 +21,96 @@\n ┊ 21┊ 21┊  return bcrypt.compareSync(password, localPassword);\n ┊ 22┊ 22┊}\n ┊ 23┊ 23┊\n-┊ 24┊   ┊passport.use('basic-signin', new basicStrategy.BasicStrategy(\n-┊ 25┊   ┊  function (username: string, password: string, done: any) {\n-┊ 26┊   ┊    const user = users.find(user => user.username == username);\n-┊ 27┊   ┊    if (user && validPassword(password, user.password)) {\n-┊ 28┊   ┊      return done(null, user);\n+┊   ┊ 24┊createConnection().then(async connection => {\n+┊   ┊ 25┊  await addSampleData(connection);\n+┊   ┊ 26┊\n+┊   ┊ 27┊  passport.use('basic-signin', new basicStrategy.BasicStrategy(\n+┊   ┊ 28┊    async function (username: string, password: string, done: any) {\n+┊   ┊ 29┊      const user = await connection.getRepository(User).findOne({where: { username }});\n+┊   ┊ 30┊      if (user && validPassword(password, user.password)) {\n+┊   ┊ 31┊        return done(null, user);\n+┊   ┊ 32┊      }\n+┊   ┊ 33┊      return done(null, false);\n ┊ 29┊ 34┊    }\n-┊ 30┊   ┊    return done(null, false);\n-┊ 31┊   ┊  }\n-┊ 32┊   ┊));\n-┊ 33┊   ┊\n-┊ 34┊   ┊passport.use('basic-signup', new basicStrategy.BasicStrategy({passReqToCallback: true},\n-┊ 35┊   ┊  function (req: any, username: any, password: any, done: any) {\n-┊ 36┊   ┊    const userExists = !!users.find(user => user.username === username);\n-┊ 37┊   ┊    if (!userExists && password && req.body.name) {\n-┊ 38┊   ┊      const user: User = {\n-┊ 39┊   ┊        id: (users.length && users[users.length - 1].id + 1) || 1,\n-┊ 40┊   ┊        username,\n-┊ 41┊   ┊        password: generateHash(password),\n-┊ 42┊   ┊        name: req.body.name,\n-┊ 43┊   ┊      };\n-┊ 44┊   ┊      users.push(user);\n-┊ 45┊   ┊      return done(null, user);\n+┊   ┊ 35┊  ));\n+┊   ┊ 36┊\n+┊   ┊ 37┊  passport.use('basic-signup', new basicStrategy.BasicStrategy({passReqToCallback: true},\n+┊   ┊ 38┊    async function (req: any, username: string, password: string, done: any) {\n+┊   ┊ 39┊      const userExists = !!(await connection.getRepository(User).findOne({where: { username }}));\n+┊   ┊ 40┊      if (!userExists && password && req.body.name) {\n+┊   ┊ 41┊        const user = await connection.manager.save(new User({\n+┊   ┊ 42┊          username,\n+┊   ┊ 43┊          password: generateHash(password),\n+┊   ┊ 44┊          name: req.body.name,\n+┊   ┊ 45┊        }));\n+┊   ┊ 46┊        return done(null, user);\n+┊   ┊ 47┊      }\n+┊   ┊ 48┊      return done(null, false);\n ┊ 46┊ 49┊    }\n-┊ 47┊   ┊    return done(null, false);\n-┊ 48┊   ┊  }\n-┊ 49┊   ┊));\n+┊   ┊ 50┊  ));\n ┊ 50┊ 51┊\n-┊ 51┊   ┊const PORT = 3000;\n+┊   ┊ 52┊  const PORT = 3000;\n ┊ 52┊ 53┊\n-┊ 53┊   ┊const app = express();\n+┊   ┊ 54┊  const app = express();\n ┊ 54┊ 55┊\n-┊ 55┊   ┊app.use(cors());\n-┊ 56┊   ┊app.use(bodyParser.json());\n-┊ 57┊   ┊app.use(passport.initialize());\n+┊   ┊ 56┊  app.use(cors());\n+┊   ┊ 57┊  app.use(bodyParser.json());\n+┊   ┊ 58┊  app.use(passport.initialize());\n ┊ 58┊ 59┊\n-┊ 59┊   ┊app.post('/signup',\n-┊ 60┊   ┊  passport.authenticate('basic-signup', {session: false}),\n-┊ 61┊   ┊  function (req: any, res) {\n-┊ 62┊   ┊    res.json(req.user);\n-┊ 63┊   ┊  });\n+┊   ┊ 60┊  app.post('/signup',\n+┊   ┊ 61┊    passport.authenticate('basic-signup', {session: false}),\n+┊   ┊ 62┊    function (req: any, res) {\n+┊   ┊ 63┊      res.json(req.user);\n+┊   ┊ 64┊    });\n ┊ 64┊ 65┊\n-┊ 65┊   ┊app.use(passport.authenticate('basic-signin', {session: false}));\n+┊   ┊ 66┊  app.use(passport.authenticate('basic-signin', {session: false}));\n ┊ 66┊ 67┊\n-┊ 67┊   ┊app.post('/signin', function (req: any, res) {\n-┊ 68┊   ┊  res.json(req.user);\n-┊ 69┊   ┊});\n+┊   ┊ 68┊  app.post('/signin', function (req, res) {\n+┊   ┊ 69┊    res.json(req.user);\n+┊   ┊ 70┊  });\n ┊ 70┊ 71┊\n-┊ 71┊   ┊const apollo = new ApolloServer({\n-┊ 72┊   ┊  schema,\n-┊ 73┊   ┊  context(received: any) {\n-┊ 74┊   ┊    return {\n-┊ 75┊   ┊      user: received.connection ? received.connection.context.user : received.req!['user'],\n-┊ 76┊   ┊    }\n-┊ 77┊   ┊  },\n-┊ 78┊   ┊  subscriptions: {\n-┊ 79┊   ┊    onConnect: (connectionParams: any, webSocket: any) => {\n-┊ 80┊   ┊      if (connectionParams.authToken) {\n-┊ 81┊   ┊        // create a buffer and tell it the data coming in is base64\n-┊ 82┊   ┊        const buf = new Buffer(connectionParams.authToken.split(' ')[1], 'base64');\n-┊ 83┊   ┊        // read it back out as a string\n-┊ 84┊   ┊        const [username, password]: string[] = buf.toString().split(':');\n-┊ 85┊   ┊        if (username && password) {\n-┊ 86┊   ┊          const user = users.find(user => user.username == username);\n-┊ 87┊   ┊\n-┊ 88┊   ┊          if (user && validPassword(password, user.password)) {\n-┊ 89┊   ┊            // Set context for the WebSocket\n-┊ 90┊   ┊            return {user};\n-┊ 91┊   ┊          } else {\n-┊ 92┊   ┊            throw new Error('Wrong credentials!');\n+┊   ┊ 72┊  const apollo = new ApolloServer({\n+┊   ┊ 73┊    schema,\n+┊   ┊ 74┊    context(received: any) {\n+┊   ┊ 75┊      return {\n+┊   ┊ 76┊        user: received.connection ? received.connection.context.user : received.req!['user'],\n+┊   ┊ 77┊        connection,\n+┊   ┊ 78┊      }\n+┊   ┊ 79┊    },\n+┊   ┊ 80┊    subscriptions: {\n+┊   ┊ 81┊      onConnect: async (connectionParams: any, webSocket: any) => {\n+┊   ┊ 82┊        if (connectionParams.authToken) {\n+┊   ┊ 83┊          // Create a buffer and tell it the data coming in is base64\n+┊   ┊ 84┊          const buf = new Buffer(connectionParams.authToken.split(' ')[1], 'base64');\n+┊   ┊ 85┊          // Read it back out as a string\n+┊   ┊ 86┊          const [username, password]: string[] = buf.toString().split(':');\n+┊   ┊ 87┊          if (username && password) {\n+┊   ┊ 88┊            const user = await connection.getRepository(User).findOne({where: { username }});\n+┊   ┊ 89┊\n+┊   ┊ 90┊            if (user && validPassword(password, user.password)) {\n+┊   ┊ 91┊              // Set context for the WebSocket\n+┊   ┊ 92┊              return {user};\n+┊   ┊ 93┊            } else {\n+┊   ┊ 94┊              throw new Error('Wrong credentials!');\n+┊   ┊ 95┊            }\n ┊ 93┊ 96┊          }\n ┊ 94┊ 97┊        }\n+┊   ┊ 98┊        throw new Error('Missing auth token!');\n ┊ 95┊ 99┊      }\n-┊ 96┊   ┊      throw new Error('Missing auth token!');\n ┊ 97┊100┊    }\n-┊ 98┊   ┊  }\n-┊ 99┊   ┊});\n+┊   ┊101┊  });\n ┊100┊102┊\n-┊101┊   ┊apollo.applyMiddleware({\n-┊102┊   ┊  app,\n-┊103┊   ┊  path: '/graphql'\n-┊104┊   ┊});\n+┊   ┊103┊  apollo.applyMiddleware({\n+┊   ┊104┊    app,\n+┊   ┊105┊    path: '/graphql'\n+┊   ┊106┊  });\n ┊105┊107┊\n-┊106┊   ┊// Wrap the Express server\n-┊107┊   ┊const ws = createServer(app);\n+┊   ┊108┊  // Wrap the Express server\n+┊   ┊109┊  const ws = createServer(app);\n ┊108┊110┊\n-┊109┊   ┊apollo.installSubscriptionHandlers(ws);\n+┊   ┊111┊  apollo.installSubscriptionHandlers(ws);\n ┊110┊112┊\n-┊111┊   ┊ws.listen(PORT, () => {\n-┊112┊   ┊  console.log(`Apollo Server is now running on http://localhost:${PORT}`);\n+┊   ┊113┊  ws.listen(PORT, () => {\n+┊   ┊114┊    console.log(`Apollo Server is now running on http://localhost:${PORT}`);\n+┊   ┊115┊  });\n ┊113┊116┊});\n```\n\n[}]: #\n\nWe will also remove our fake db and replace it with some real data:\n\n[{]: <helper> (diffStep \"6.1\" files=\"db.ts\" module=\"server\")\n\n#### [Step 6.1: TypeORM with PostgreSQL](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/00c4cab)\n\n##### Changed db.ts\n```diff\n@@ -1,4 +1,11 @@\n+┊  ┊ 1┊// For TypeORM\n+┊  ┊ 2┊import \"reflect-metadata\";\n+┊  ┊ 3┊import { Chat } from \"./entity/Chat\";\n+┊  ┊ 4┊import { Recipient } from \"./entity/Recipient\";\n ┊ 1┊ 5┊import * as moment from 'moment';\n+┊  ┊ 6┊import { Message } from \"./entity/Message\";\n+┊  ┊ 7┊import { User } from \"./entity/User\";\n+┊  ┊ 8┊import { Connection } from \"typeorm\";\n ┊ 2┊ 9┊\n ┊ 3┊10┊export enum MessageType {\n ┊ 4┊11┊  PICTURE,\n```\n```diff\n@@ -6,433 +13,280 @@\n ┊  6┊ 13┊  LOCATION,\n ┊  7┊ 14┊}\n ┊  8┊ 15┊\n-┊  9┊   ┊export interface User {\n-┊ 10┊   ┊  id: number,\n-┊ 11┊   ┊  username: string,\n-┊ 12┊   ┊  password: string,\n-┊ 13┊   ┊  name: string,\n-┊ 14┊   ┊  picture?: string | null,\n-┊ 15┊   ┊  phone?: string | null,\n-┊ 16┊   ┊}\n-┊ 17┊   ┊\n-┊ 18┊   ┊export interface Chat {\n-┊ 19┊   ┊  id: number,\n-┊ 20┊   ┊  name?: string | null,\n-┊ 21┊   ┊  picture?: string | null,\n-┊ 22┊   ┊  // All members, current and past ones.\n-┊ 23┊   ┊  allTimeMemberIds: number[],\n-┊ 24┊   ┊  // Whoever gets the chat listed. For groups includes past members who still didn't delete the group.\n-┊ 25┊   ┊  listingMemberIds: number[],\n-┊ 26┊   ┊  // Actual members of the group (they are not the only ones who get the group listed). Null for chats.\n-┊ 27┊   ┊  actualGroupMemberIds?: number[] | null,\n-┊ 28┊   ┊  adminIds?: number[] | null,\n-┊ 29┊   ┊  ownerId?: number | null,\n-┊ 30┊   ┊  messages: Message[],\n-┊ 31┊   ┊}\n-┊ 32┊   ┊\n-┊ 33┊   ┊export interface Message {\n-┊ 34┊   ┊  id: number,\n-┊ 35┊   ┊  chatId: number,\n-┊ 36┊   ┊  senderId: number,\n-┊ 37┊   ┊  content: string,\n-┊ 38┊   ┊  createdAt: number,\n-┊ 39┊   ┊  type: MessageType,\n-┊ 40┊   ┊  recipients: Recipient[],\n-┊ 41┊   ┊  holderIds: number[],\n-┊ 42┊   ┊}\n-┊ 43┊   ┊\n-┊ 44┊   ┊export interface Recipient {\n-┊ 45┊   ┊  userId: number,\n-┊ 46┊   ┊  messageId: number,\n-┊ 47┊   ┊  chatId: number,\n-┊ 48┊   ┊  receivedAt: number | null,\n-┊ 49┊   ┊  readAt: number | null,\n-┊ 50┊   ┊}\n-┊ 51┊   ┊\n-┊ 52┊   ┊const users: User[] = [\n-┊ 53┊   ┊  {\n-┊ 54┊   ┊    id: 1,\n+┊   ┊ 16┊export async function addSampleData(connection: Connection) {\n+┊   ┊ 17┊  const user1 = new User({\n ┊ 55┊ 18┊    username: 'ethan',\n ┊ 56┊ 19┊    password: '$2a$08$NO9tkFLCoSqX1c5wk3s7z.JfxaVMKA.m7zUDdDwEquo4rvzimQeJm', // 111\n ┊ 57┊ 20┊    name: 'Ethan Gonzalez',\n ┊ 58┊ 21┊    picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n ┊ 59┊ 22┊    phone: '+391234567890',\n-┊ 60┊   ┊  },\n-┊ 61┊   ┊  {\n-┊ 62┊   ┊    id: 2,\n+┊   ┊ 23┊  });\n+┊   ┊ 24┊  await connection.manager.save(user1);\n+┊   ┊ 25┊\n+┊   ┊ 26┊  const user2 = new User({\n ┊ 63┊ 27┊    username: 'bryan',\n ┊ 64┊ 28┊    password: '$2a$08$xE4FuCi/ifxjL2S8CzKAmuKLwv18ktksSN.F3XYEnpmcKtpbpeZgO', // 222\n ┊ 65┊ 29┊    name: 'Bryan Wallace',\n ┊ 66┊ 30┊    picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n ┊ 67┊ 31┊    phone: '+391234567891',\n-┊ 68┊   ┊  },\n-┊ 69┊   ┊  {\n-┊ 70┊   ┊    id: 3,\n+┊   ┊ 32┊  });\n+┊   ┊ 33┊  await connection.manager.save(user2);\n+┊   ┊ 34┊\n+┊   ┊ 35┊  const user3 = new User({\n ┊ 71┊ 36┊    username: 'avery',\n ┊ 72┊ 37┊    password: '$2a$08$UHgH7J8G6z1mGQn2qx2kdeWv0jvgHItyAsL9hpEUI3KJmhVW5Q1d.', // 333\n ┊ 73┊ 38┊    name: 'Avery Stewart',\n ┊ 74┊ 39┊    picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n ┊ 75┊ 40┊    phone: '+391234567892',\n-┊ 76┊   ┊  },\n-┊ 77┊   ┊  {\n-┊ 78┊   ┊    id: 4,\n+┊   ┊ 41┊  });\n+┊   ┊ 42┊  await connection.manager.save(user3);\n+┊   ┊ 43┊\n+┊   ┊ 44┊  const user4 = new User({\n ┊ 79┊ 45┊    username: 'katie',\n ┊ 80┊ 46┊    password: '$2a$08$wR1k5Q3T9FC7fUgB7Gdb9Os/GV7dGBBf4PLlWT7HERMFhmFDt47xi', // 444\n ┊ 81┊ 47┊    name: 'Katie Peterson',\n ┊ 82┊ 48┊    picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n ┊ 83┊ 49┊    phone: '+391234567893',\n-┊ 84┊   ┊  },\n-┊ 85┊   ┊  {\n-┊ 86┊   ┊    id: 5,\n+┊   ┊ 50┊  });\n+┊   ┊ 51┊  await connection.manager.save(user4);\n+┊   ┊ 52┊\n+┊   ┊ 53┊  const user5 = new User({\n ┊ 87┊ 54┊    username: 'ray',\n ┊ 88┊ 55┊    password: '$2a$08$6.mbXqsDX82ZZ7q5d8Osb..JrGSsNp4R3IKj7mxgF6YGT0OmMw242', // 555\n ┊ 89┊ 56┊    name: 'Ray Edwards',\n ┊ 90┊ 57┊    picture: 'https://randomuser.me/api/portraits/thumb/men/3.jpg',\n ┊ 91┊ 58┊    phone: '+391234567894',\n-┊ 92┊   ┊  },\n-┊ 93┊   ┊  {\n-┊ 94┊   ┊    id: 6,\n+┊   ┊ 59┊  });\n+┊   ┊ 60┊  await connection.manager.save(user5);\n+┊   ┊ 61┊\n+┊   ┊ 62┊  const user6 = new User({\n ┊ 95┊ 63┊    username: 'niko',\n ┊ 96┊ 64┊    password: '$2a$08$fL5lZR.Rwf9FWWe8XwwlceiPBBim8n9aFtaem.INQhiKT4.Ux3Uq.', // 666\n ┊ 97┊ 65┊    name: 'Niccolò Belli',\n ┊ 98┊ 66┊    picture: 'https://randomuser.me/api/portraits/thumb/men/4.jpg',\n ┊ 99┊ 67┊    phone: '+391234567895',\n-┊100┊   ┊  },\n-┊101┊   ┊  {\n-┊102┊   ┊    id: 7,\n+┊   ┊ 68┊  });\n+┊   ┊ 69┊  await connection.manager.save(user6);\n+┊   ┊ 70┊\n+┊   ┊ 71┊  const user7 = new User({\n ┊103┊ 72┊    username: 'mario',\n ┊104┊ 73┊    password: '$2a$08$nDHDmWcVxDnH5DDT3HMMC.psqcnu6wBiOgkmJUy9IH..qxa3R6YrO', // 777\n ┊105┊ 74┊    name: 'Mario Rossi',\n ┊106┊ 75┊    picture: 'https://randomuser.me/api/portraits/thumb/men/5.jpg',\n ┊107┊ 76┊    phone: '+391234567896',\n-┊108┊   ┊  },\n-┊109┊   ┊];\n+┊   ┊ 77┊  });\n+┊   ┊ 78┊  await connection.manager.save(user7);\n+┊   ┊ 79┊\n+┊   ┊ 80┊\n ┊110┊ 81┊\n-┊111┊   ┊const chats: Chat[] = [\n-┊112┊   ┊  {\n-┊113┊   ┊    id: 1,\n-┊114┊   ┊    name: null,\n-┊115┊   ┊    picture: null,\n-┊116┊   ┊    allTimeMemberIds: [1, 3],\n-┊117┊   ┊    listingMemberIds: [1, 3],\n-┊118┊   ┊    adminIds: null,\n-┊119┊   ┊    ownerId: null,\n+┊   ┊ 82┊\n+┊   ┊ 83┊  await connection.manager.save(new Chat({\n+┊   ┊ 84┊    allTimeMembers: [user1, user3],\n+┊   ┊ 85┊    listingMembers: [user1, user3],\n ┊120┊ 86┊    messages: [\n-┊121┊   ┊      {\n-┊122┊   ┊        id: 1,\n-┊123┊   ┊        chatId: 1,\n-┊124┊   ┊        senderId: 1,\n+┊   ┊ 87┊      new Message({\n+┊   ┊ 88┊        sender: user1,\n ┊125┊ 89┊        content: 'You on your way?',\n-┊126┊   ┊        createdAt: moment().subtract(1, 'hours').unix(),\n+┊   ┊ 90┊        createdAt: moment().subtract(1, 'hours').toDate(),\n ┊127┊ 91┊        type: MessageType.TEXT,\n+┊   ┊ 92┊        holders: [user1, user3],\n ┊128┊ 93┊        recipients: [\n-┊129┊   ┊          {\n-┊130┊   ┊            userId: 3,\n-┊131┊   ┊            messageId: 1,\n-┊132┊   ┊            chatId: 1,\n-┊133┊   ┊            receivedAt: null,\n-┊134┊   ┊            readAt: null,\n-┊135┊   ┊          },\n+┊   ┊ 94┊          new Recipient({\n+┊   ┊ 95┊            user: user3,\n+┊   ┊ 96┊          }),\n ┊136┊ 97┊        ],\n-┊137┊   ┊        holderIds: [1, 3],\n-┊138┊   ┊      },\n-┊139┊   ┊      {\n-┊140┊   ┊        id: 2,\n-┊141┊   ┊        chatId: 1,\n-┊142┊   ┊        senderId: 3,\n+┊   ┊ 98┊      }),\n+┊   ┊ 99┊      new Message({\n+┊   ┊100┊        sender: user3,\n ┊143┊101┊        content: 'Yep!',\n-┊144┊   ┊        createdAt: moment().subtract(1, 'hours').add(5, 'minutes').unix(),\n+┊   ┊102┊        createdAt: moment().subtract(1, 'hours').add(5, 'minutes').toDate(),\n ┊145┊103┊        type: MessageType.TEXT,\n+┊   ┊104┊        holders: [user1, user3],\n ┊146┊105┊        recipients: [\n-┊147┊   ┊          {\n-┊148┊   ┊            userId: 1,\n-┊149┊   ┊            messageId: 2,\n-┊150┊   ┊            chatId: 1,\n-┊151┊   ┊            receivedAt: null,\n-┊152┊   ┊            readAt: null,\n-┊153┊   ┊          },\n+┊   ┊106┊          new Recipient({\n+┊   ┊107┊            user: user1,\n+┊   ┊108┊          }),\n ┊154┊109┊        ],\n-┊155┊   ┊        holderIds: [3, 1],\n-┊156┊   ┊      },\n+┊   ┊110┊      }),\n ┊157┊111┊    ],\n-┊158┊   ┊  },\n-┊159┊   ┊  {\n-┊160┊   ┊    id: 2,\n-┊161┊   ┊    name: null,\n-┊162┊   ┊    picture: null,\n-┊163┊   ┊    allTimeMemberIds: [1, 4],\n-┊164┊   ┊    listingMemberIds: [1, 4],\n-┊165┊   ┊    adminIds: null,\n-┊166┊   ┊    ownerId: null,\n+┊   ┊112┊  }));\n+┊   ┊113┊\n+┊   ┊114┊  await connection.manager.save(new Chat({\n+┊   ┊115┊    allTimeMembers: [user1, user4],\n+┊   ┊116┊    listingMembers: [user1, user4],\n ┊167┊117┊    messages: [\n-┊168┊   ┊      {\n-┊169┊   ┊        id: 1,\n-┊170┊   ┊        chatId: 2,\n-┊171┊   ┊        senderId: 1,\n+┊   ┊118┊      new Message({\n+┊   ┊119┊        sender: user1,\n ┊172┊120┊        content: 'Hey, it\\'s me',\n-┊173┊   ┊        createdAt: moment().subtract(2, 'hours').unix(),\n+┊   ┊121┊        createdAt: moment().subtract(2, 'hours').toDate(),\n ┊174┊122┊        type: MessageType.TEXT,\n+┊   ┊123┊        holders: [user1, user4],\n ┊175┊124┊        recipients: [\n-┊176┊   ┊          {\n-┊177┊   ┊            userId: 4,\n-┊178┊   ┊            messageId: 1,\n-┊179┊   ┊            chatId: 2,\n-┊180┊   ┊            receivedAt: null,\n-┊181┊   ┊            readAt: null,\n-┊182┊   ┊          },\n+┊   ┊125┊          new Recipient({\n+┊   ┊126┊            user: user4,\n+┊   ┊127┊          }),\n ┊183┊128┊        ],\n-┊184┊   ┊        holderIds: [1, 4],\n-┊185┊   ┊      },\n+┊   ┊129┊      }),\n ┊186┊130┊    ],\n-┊187┊   ┊  },\n-┊188┊   ┊  {\n-┊189┊   ┊    id: 3,\n-┊190┊   ┊    name: null,\n-┊191┊   ┊    picture: null,\n-┊192┊   ┊    allTimeMemberIds: [1, 5],\n-┊193┊   ┊    listingMemberIds: [1, 5],\n-┊194┊   ┊    adminIds: null,\n-┊195┊   ┊    ownerId: null,\n+┊   ┊131┊  }));\n+┊   ┊132┊\n+┊   ┊133┊  await connection.manager.save(new Chat({\n+┊   ┊134┊    allTimeMembers: [user1, user5],\n+┊   ┊135┊    listingMembers: [user1, user5],\n ┊196┊136┊    messages: [\n-┊197┊   ┊      {\n-┊198┊   ┊        id: 1,\n-┊199┊   ┊        chatId: 3,\n-┊200┊   ┊        senderId: 1,\n+┊   ┊137┊      new Message({\n+┊   ┊138┊        sender: user1,\n ┊201┊139┊        content: 'I should buy a boat',\n-┊202┊   ┊        createdAt: moment().subtract(1, 'days').unix(),\n+┊   ┊140┊        createdAt: moment().subtract(1, 'days').toDate(),\n ┊203┊141┊        type: MessageType.TEXT,\n+┊   ┊142┊        holders: [user1, user5],\n ┊204┊143┊        recipients: [\n-┊205┊   ┊          {\n-┊206┊   ┊            userId: 5,\n-┊207┊   ┊            messageId: 1,\n-┊208┊   ┊            chatId: 3,\n-┊209┊   ┊            receivedAt: null,\n-┊210┊   ┊            readAt: null,\n-┊211┊   ┊          },\n+┊   ┊144┊          new Recipient({\n+┊   ┊145┊            user: user5,\n+┊   ┊146┊          }),\n ┊212┊147┊        ],\n-┊213┊   ┊        holderIds: [1, 5],\n-┊214┊   ┊      },\n-┊215┊   ┊      {\n-┊216┊   ┊        id: 2,\n-┊217┊   ┊        chatId: 3,\n-┊218┊   ┊        senderId: 1,\n+┊   ┊148┊      }),\n+┊   ┊149┊      new Message({\n+┊   ┊150┊        sender: user1,\n ┊219┊151┊        content: 'You still there?',\n-┊220┊   ┊        createdAt: moment().subtract(1, 'days').add(16, 'hours').unix(),\n+┊   ┊152┊        createdAt: moment().subtract(1, 'days').add(16, 'hours').toDate(),\n ┊221┊153┊        type: MessageType.TEXT,\n+┊   ┊154┊        holders: [user1, user5],\n ┊222┊155┊        recipients: [\n-┊223┊   ┊          {\n-┊224┊   ┊            userId: 5,\n-┊225┊   ┊            messageId: 2,\n-┊226┊   ┊            chatId: 3,\n-┊227┊   ┊            receivedAt: null,\n-┊228┊   ┊            readAt: null,\n-┊229┊   ┊          },\n+┊   ┊156┊          new Recipient({\n+┊   ┊157┊            user: user5,\n+┊   ┊158┊          }),\n ┊230┊159┊        ],\n-┊231┊   ┊        holderIds: [1, 5],\n-┊232┊   ┊      },\n+┊   ┊160┊      }),\n ┊233┊161┊    ],\n-┊234┊   ┊  },\n-┊235┊   ┊  {\n-┊236┊   ┊    id: 4,\n-┊237┊   ┊    name: null,\n-┊238┊   ┊    picture: null,\n-┊239┊   ┊    allTimeMemberIds: [3, 4],\n-┊240┊   ┊    listingMemberIds: [3, 4],\n-┊241┊   ┊    adminIds: null,\n-┊242┊   ┊    ownerId: null,\n+┊   ┊162┊  }));\n+┊   ┊163┊\n+┊   ┊164┊  await connection.manager.save(new Chat({\n+┊   ┊165┊    allTimeMembers: [user3, user4],\n+┊   ┊166┊    listingMembers: [user3, user4],\n ┊243┊167┊    messages: [\n-┊244┊   ┊      {\n-┊245┊   ┊        id: 1,\n-┊246┊   ┊        chatId: 4,\n-┊247┊   ┊        senderId: 3,\n+┊   ┊168┊      new Message({\n+┊   ┊169┊        sender: user3,\n ┊248┊170┊        content: 'Look at my mukluks!',\n-┊249┊   ┊        createdAt: moment().subtract(4, 'days').unix(),\n+┊   ┊171┊        createdAt: moment().subtract(4, 'days').toDate(),\n ┊250┊172┊        type: MessageType.TEXT,\n+┊   ┊173┊        holders: [user3, user4],\n ┊251┊174┊        recipients: [\n-┊252┊   ┊          {\n-┊253┊   ┊            userId: 4,\n-┊254┊   ┊            messageId: 1,\n-┊255┊   ┊            chatId: 4,\n-┊256┊   ┊            receivedAt: null,\n-┊257┊   ┊            readAt: null,\n-┊258┊   ┊          },\n+┊   ┊175┊          new Recipient({\n+┊   ┊176┊            user: user4,\n+┊   ┊177┊          }),\n ┊259┊178┊        ],\n-┊260┊   ┊        holderIds: [3, 4],\n-┊261┊   ┊      },\n+┊   ┊179┊      }),\n ┊262┊180┊    ],\n-┊263┊   ┊  },\n-┊264┊   ┊  {\n-┊265┊   ┊    id: 5,\n-┊266┊   ┊    name: null,\n-┊267┊   ┊    picture: null,\n-┊268┊   ┊    allTimeMemberIds: [2, 5],\n-┊269┊   ┊    listingMemberIds: [2, 5],\n-┊270┊   ┊    adminIds: null,\n-┊271┊   ┊    ownerId: null,\n+┊   ┊181┊  }));\n+┊   ┊182┊\n+┊   ┊183┊  await connection.manager.save(new Chat({\n+┊   ┊184┊    allTimeMembers: [user2, user5],\n+┊   ┊185┊    listingMembers: [user2, user5],\n ┊272┊186┊    messages: [\n-┊273┊   ┊      {\n-┊274┊   ┊        id: 1,\n-┊275┊   ┊        chatId: 5,\n-┊276┊   ┊        senderId: 2,\n+┊   ┊187┊      new Message({\n+┊   ┊188┊        sender: user2,\n ┊277┊189┊        content: 'This is wicked good ice cream.',\n-┊278┊   ┊        createdAt: moment().subtract(2, 'weeks').unix(),\n+┊   ┊190┊        createdAt: moment().subtract(2, 'weeks').toDate(),\n ┊279┊191┊        type: MessageType.TEXT,\n+┊   ┊192┊        holders: [user2, user5],\n ┊280┊193┊        recipients: [\n-┊281┊   ┊          {\n-┊282┊   ┊            userId: 5,\n-┊283┊   ┊            messageId: 1,\n-┊284┊   ┊            chatId: 5,\n-┊285┊   ┊            receivedAt: null,\n-┊286┊   ┊            readAt: null,\n-┊287┊   ┊          },\n+┊   ┊194┊          new Recipient({\n+┊   ┊195┊            user: user5,\n+┊   ┊196┊          }),\n ┊288┊197┊        ],\n-┊289┊   ┊        holderIds: [2, 5],\n-┊290┊   ┊      },\n-┊291┊   ┊      {\n-┊292┊   ┊        id: 2,\n-┊293┊   ┊        chatId: 6,\n-┊294┊   ┊        senderId: 5,\n+┊   ┊198┊      }),\n+┊   ┊199┊      new Message({\n+┊   ┊200┊        sender: user5,\n ┊295┊201┊        content: 'Love it!',\n-┊296┊   ┊        createdAt: moment().subtract(2, 'weeks').add(10, 'minutes').unix(),\n+┊   ┊202┊        createdAt: moment().subtract(2, 'weeks').add(10, 'minutes').toDate(),\n ┊297┊203┊        type: MessageType.TEXT,\n+┊   ┊204┊        holders: [user2, user5],\n ┊298┊205┊        recipients: [\n-┊299┊   ┊          {\n-┊300┊   ┊            userId: 2,\n-┊301┊   ┊            messageId: 2,\n-┊302┊   ┊            chatId: 5,\n-┊303┊   ┊            receivedAt: null,\n-┊304┊   ┊            readAt: null,\n-┊305┊   ┊          },\n+┊   ┊206┊          new Recipient({\n+┊   ┊207┊            user: user2,\n+┊   ┊208┊          }),\n ┊306┊209┊        ],\n-┊307┊   ┊        holderIds: [5, 2],\n-┊308┊   ┊      },\n+┊   ┊210┊      }),\n ┊309┊211┊    ],\n-┊310┊   ┊  },\n-┊311┊   ┊  {\n-┊312┊   ┊    id: 6,\n-┊313┊   ┊    name: null,\n-┊314┊   ┊    picture: null,\n-┊315┊   ┊    allTimeMemberIds: [1, 6],\n-┊316┊   ┊    listingMemberIds: [1],\n-┊317┊   ┊    adminIds: null,\n-┊318┊   ┊    ownerId: null,\n-┊319┊   ┊    messages: [],\n-┊320┊   ┊  },\n-┊321┊   ┊  {\n-┊322┊   ┊    id: 7,\n-┊323┊   ┊    name: null,\n-┊324┊   ┊    picture: null,\n-┊325┊   ┊    allTimeMemberIds: [2, 1],\n-┊326┊   ┊    listingMemberIds: [2],\n-┊327┊   ┊    adminIds: null,\n-┊328┊   ┊    ownerId: null,\n-┊329┊   ┊    messages: [],\n-┊330┊   ┊  },\n-┊331┊   ┊  {\n-┊332┊   ┊    id: 8,\n-┊333┊   ┊    name: 'A user 0 group',\n+┊   ┊212┊  }));\n+┊   ┊213┊\n+┊   ┊214┊  await connection.manager.save(new Chat({\n+┊   ┊215┊    allTimeMembers: [user1, user6],\n+┊   ┊216┊    listingMembers: [user1],\n+┊   ┊217┊  }));\n+┊   ┊218┊\n+┊   ┊219┊  await connection.manager.save(new Chat({\n+┊   ┊220┊    allTimeMembers: [user2, user1],\n+┊   ┊221┊    listingMembers: [user2],\n+┊   ┊222┊  }));\n+┊   ┊223┊\n+┊   ┊224┊  await connection.manager.save(new Chat({\n+┊   ┊225┊    name: 'Ethan\\'s group',\n ┊334┊226┊    picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n-┊335┊   ┊    allTimeMemberIds: [1, 3, 4, 6],\n-┊336┊   ┊    listingMemberIds: [1, 3, 4, 6],\n-┊337┊   ┊    actualGroupMemberIds: [1, 4, 6],\n-┊338┊   ┊    adminIds: [1, 6],\n-┊339┊   ┊    ownerId: 1,\n+┊   ┊227┊    allTimeMembers: [user1, user3, user4, user6],\n+┊   ┊228┊    listingMembers: [user1, user3, user4, user6],\n+┊   ┊229┊    actualGroupMembers: [user1, user4, user6],\n+┊   ┊230┊    admins: [user1, user6],\n+┊   ┊231┊    owner: user1,\n ┊340┊232┊    messages: [\n-┊341┊   ┊      {\n-┊342┊   ┊        id: 1,\n-┊343┊   ┊        chatId: 8,\n-┊344┊   ┊        senderId: 1,\n+┊   ┊233┊      new Message({\n+┊   ┊234┊        sender: user1,\n ┊345┊235┊        content: 'I made a group',\n-┊346┊   ┊        createdAt: moment().subtract(2, 'weeks').unix(),\n+┊   ┊236┊        createdAt: moment().subtract(2, 'weeks').toDate(),\n ┊347┊237┊        type: MessageType.TEXT,\n+┊   ┊238┊        holders: [user1, user3, user4, user6],\n ┊348┊239┊        recipients: [\n-┊349┊   ┊          {\n-┊350┊   ┊            userId: 3,\n-┊351┊   ┊            messageId: 1,\n-┊352┊   ┊            chatId: 8,\n-┊353┊   ┊            receivedAt: null,\n-┊354┊   ┊            readAt: null,\n-┊355┊   ┊          },\n-┊356┊   ┊          {\n-┊357┊   ┊            userId: 4,\n-┊358┊   ┊            messageId: 1,\n-┊359┊   ┊            chatId: 8,\n-┊360┊   ┊            receivedAt: moment().subtract(2, 'weeks').add(1, 'minutes').unix(),\n-┊361┊   ┊            readAt: moment().subtract(2, 'weeks').add(5, 'minutes').unix(),\n-┊362┊   ┊          },\n-┊363┊   ┊          {\n-┊364┊   ┊            userId: 6,\n-┊365┊   ┊            messageId: 1,\n-┊366┊   ┊            chatId: 8,\n-┊367┊   ┊            receivedAt: null,\n-┊368┊   ┊            readAt: null,\n-┊369┊   ┊          },\n+┊   ┊240┊          new Recipient({\n+┊   ┊241┊            user: user3,\n+┊   ┊242┊          }),\n+┊   ┊243┊          new Recipient({\n+┊   ┊244┊            user: user4,\n+┊   ┊245┊          }),\n+┊   ┊246┊          new Recipient({\n+┊   ┊247┊            user: user6,\n+┊   ┊248┊          }),\n ┊370┊249┊        ],\n-┊371┊   ┊        holderIds: [1, 3, 4, 6],\n-┊372┊   ┊      },\n-┊373┊   ┊      {\n-┊374┊   ┊        id: 2,\n-┊375┊   ┊        chatId: 8,\n-┊376┊   ┊        senderId: 1,\n-┊377┊   ┊        content: 'Ops, user 3 was not supposed to be here',\n-┊378┊   ┊        createdAt: moment().subtract(2, 'weeks').add(2, 'minutes').unix(),\n+┊   ┊250┊      }),\n+┊   ┊251┊      new Message({\n+┊   ┊252┊        sender: user1,\n+┊   ┊253┊        content: 'Ops, Avery was not supposed to be here',\n+┊   ┊254┊        createdAt: moment().subtract(2, 'weeks').add(2, 'minutes').toDate(),\n ┊379┊255┊        type: MessageType.TEXT,\n+┊   ┊256┊        holders: [user1, user4, user6],\n ┊380┊257┊        recipients: [\n-┊381┊   ┊          {\n-┊382┊   ┊            userId: 4,\n-┊383┊   ┊            messageId: 2,\n-┊384┊   ┊            chatId: 8,\n-┊385┊   ┊            receivedAt: moment().subtract(2, 'weeks').add(3, 'minutes').unix(),\n-┊386┊   ┊            readAt: moment().subtract(2, 'weeks').add(5, 'minutes').unix(),\n-┊387┊   ┊          },\n-┊388┊   ┊          {\n-┊389┊   ┊            userId: 6,\n-┊390┊   ┊            messageId: 2,\n-┊391┊   ┊            chatId: 8,\n-┊392┊   ┊            receivedAt: null,\n-┊393┊   ┊            readAt: null,\n-┊394┊   ┊          },\n+┊   ┊258┊          new Recipient({\n+┊   ┊259┊            user: user4,\n+┊   ┊260┊          }),\n+┊   ┊261┊          new Recipient({\n+┊   ┊262┊            user: user6,\n+┊   ┊263┊          }),\n ┊395┊264┊        ],\n-┊396┊   ┊        holderIds: [1, 4, 6],\n-┊397┊   ┊      },\n-┊398┊   ┊      {\n-┊399┊   ┊        id: 3,\n-┊400┊   ┊        chatId: 8,\n-┊401┊   ┊        senderId: 4,\n+┊   ┊265┊      }),\n+┊   ┊266┊      new Message({\n+┊   ┊267┊        sender: user4,\n ┊402┊268┊        content: 'Awesome!',\n-┊403┊   ┊        createdAt: moment().subtract(2, 'weeks').add(10, 'minutes').unix(),\n+┊   ┊269┊        createdAt: moment().subtract(2, 'weeks').add(10, 'minutes').toDate(),\n ┊404┊270┊        type: MessageType.TEXT,\n+┊   ┊271┊        holders: [user1, user4, user6],\n ┊405┊272┊        recipients: [\n-┊406┊   ┊          {\n-┊407┊   ┊            userId: 1,\n-┊408┊   ┊            messageId: 3,\n-┊409┊   ┊            chatId: 8,\n-┊410┊   ┊            receivedAt: null,\n-┊411┊   ┊            readAt: null,\n-┊412┊   ┊          },\n-┊413┊   ┊          {\n-┊414┊   ┊            userId: 6,\n-┊415┊   ┊            messageId: 3,\n-┊416┊   ┊            chatId: 8,\n-┊417┊   ┊            receivedAt: null,\n-┊418┊   ┊            readAt: null,\n-┊419┊   ┊          },\n+┊   ┊273┊          new Recipient({\n+┊   ┊274┊            user: user1,\n+┊   ┊275┊          }),\n+┊   ┊276┊          new Recipient({\n+┊   ┊277┊            user: user6,\n+┊   ┊278┊          }),\n ┊420┊279┊        ],\n-┊421┊   ┊        holderIds: [1, 4, 6],\n-┊422┊   ┊      },\n+┊   ┊280┊      }),\n ┊423┊281┊    ],\n-┊424┊   ┊  },\n-┊425┊   ┊  {\n-┊426┊   ┊    id: 9,\n-┊427┊   ┊    name: 'A user 5 group',\n-┊428┊   ┊    picture: null,\n-┊429┊   ┊    allTimeMemberIds: [6, 3],\n-┊430┊   ┊    listingMemberIds: [6, 3],\n-┊431┊   ┊    actualGroupMemberIds: [6, 3],\n-┊432┊   ┊    adminIds: [6],\n-┊433┊   ┊    ownerId: 6,\n-┊434┊   ┊    messages: [],\n-┊435┊   ┊  },\n-┊436┊   ┊];\n+┊   ┊282┊  }));\n ┊437┊283┊\n-┊438┊   ┊export const db = {users, chats};\n+┊   ┊284┊  await connection.manager.save(new Chat({\n+┊   ┊285┊    name: 'Ray\\'s group',\n+┊   ┊286┊    allTimeMembers: [user3, user6],\n+┊   ┊287┊    listingMembers: [user3, user6],\n+┊   ┊288┊    actualGroupMembers: [user3, user6],\n+┊   ┊289┊    admins: [user6],\n+┊   ┊290┊    owner: user6,\n+┊   ┊291┊  }));\n+┊   ┊292┊}\n```\n\n[}]: #\n\nIt's time to deal with resolvers:\n\n[{]: <helper> (diffStep \"6.1\" files=\"schema/resolvers.ts\" module=\"server\")\n\n#### [Step 6.1: TypeORM with PostgreSQL](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/00c4cab)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,91 +1,127 @@\n ┊  1┊  1┊import { PubSub, withFilter, IResolvers } from 'apollo-server-express';\n-┊  2┊   ┊import { Chat, db, Message, MessageType, Recipient, User } from \"../db\";\n+┊   ┊  2┊import { MessageType } from \"../db\";\n ┊  3┊  3┊import {\n ┊  4┊  4┊  AddChatMutationArgs, AddGroupMutationArgs, AddMessageMutationArgs, ChatQueryArgs, MessageAddedSubscriptionArgs,\n ┊  5┊  5┊  RemoveChatMutationArgs, RemoveMessagesMutationArgs\n ┊  6┊  6┊} from \"../types\";\n ┊  7┊  7┊import * as moment from \"moment\";\n-┊  8┊   ┊\n-┊  9┊   ┊let users = db.users;\n-┊ 10┊   ┊let chats = db.chats;\n+┊   ┊  8┊import { User } from \"../entity/User\";\n+┊   ┊  9┊import { Chat } from \"../entity/Chat\";\n+┊   ┊ 10┊import { Message } from \"../entity/Message\";\n+┊   ┊ 11┊import { Recipient } from \"../entity/Recipient\";\n+┊   ┊ 12┊import { Connection } from \"typeorm\";\n ┊ 11┊ 13┊\n ┊ 12┊ 14┊export const pubsub = new PubSub();\n ┊ 13┊ 15┊\n ┊ 14┊ 16┊export const resolvers: IResolvers = {\n ┊ 15┊ 17┊  Query: {\n ┊ 16┊ 18┊    // Show all users for the moment.\n-┊ 17┊   ┊    users: (obj: any, args: any, {user: currentUser}: {user: User}): User[] => users.filter(user => user.id !== currentUser.id),\n-┊ 18┊   ┊    chats: (obj: any, args: any, {user: currentUser}: {user: User}): Chat[] => chats.filter(chat => chat.listingMemberIds.includes(currentUser.id)),\n-┊ 19┊   ┊    chat: (obj: any, {chatId}: ChatQueryArgs): Chat | null => chats.find(chat => chat.id === Number(chatId)) || null,\n+┊   ┊ 19┊    users: async (obj: any, args: any, {user: currentUser, connection}: { user: User, connection: Connection }): Promise<User[]> => {\n+┊   ┊ 20┊      return await connection\n+┊   ┊ 21┊        .createQueryBuilder(User, \"user\")\n+┊   ┊ 22┊        .where('user.id != :id', {id: currentUser.id})\n+┊   ┊ 23┊        .getMany();\n+┊   ┊ 24┊    },\n+┊   ┊ 25┊    chats: async (obj: any, args: any, {user: currentUser, connection}: { user: User, connection: Connection }): Promise<any[]> => {\n+┊   ┊ 26┊      return await connection\n+┊   ┊ 27┊        .createQueryBuilder(Chat, \"chat\")\n+┊   ┊ 28┊        .leftJoin('chat.listingMembers', 'listingMembers')\n+┊   ┊ 29┊        .where('listingMembers.id = :id', {id: currentUser.id})\n+┊   ┊ 30┊        .getMany();\n+┊   ┊ 31┊    },\n+┊   ┊ 32┊    chat: async (obj: any, {chatId}: ChatQueryArgs, {connection}: { user: User, connection: Connection }): Promise<any> => {\n+┊   ┊ 33┊      return await connection\n+┊   ┊ 34┊        .createQueryBuilder(Chat, \"chat\")\n+┊   ┊ 35┊        .whereInIds(chatId)\n+┊   ┊ 36┊        .getOne();\n+┊   ┊ 37┊    },\n ┊ 20┊ 38┊  },\n ┊ 21┊ 39┊  Mutation: {\n-┊ 22┊   ┊    addChat: (obj: any, {recipientId}: AddChatMutationArgs, {user: currentUser}: {user: User}): Chat => {\n-┊ 23┊   ┊      if (!users.find(user => user.id === Number(recipientId))) {\n+┊   ┊ 40┊    addChat: async (obj: any, {recipientId}: AddChatMutationArgs, {user: currentUser, connection}: { user: User, connection: Connection }): Promise<Chat | null> => {\n+┊   ┊ 41┊      const recipient = await connection\n+┊   ┊ 42┊        .createQueryBuilder(User, \"user\")\n+┊   ┊ 43┊        .whereInIds(recipientId)\n+┊   ┊ 44┊        .getOne();\n+┊   ┊ 45┊\n+┊   ┊ 46┊      if (!recipient) {\n ┊ 24┊ 47┊        throw new Error(`Recipient ${recipientId} doesn't exist.`);\n ┊ 25┊ 48┊      }\n ┊ 26┊ 49┊\n-┊ 27┊   ┊      const chat = chats.find(chat => !chat.name && chat.allTimeMemberIds.includes(currentUser.id) && chat.allTimeMemberIds.includes(Number(recipientId)));\n+┊   ┊ 50┊      let chat = await connection\n+┊   ┊ 51┊        .createQueryBuilder(Chat, \"chat\")\n+┊   ┊ 52┊        .where('chat.name IS NULL')\n+┊   ┊ 53┊        .innerJoin('chat.allTimeMembers', 'allTimeMembers1', 'allTimeMembers1.id = :currentUserId', {currentUserId: currentUser.id})\n+┊   ┊ 54┊        .innerJoin('chat.allTimeMembers', 'allTimeMembers2', 'allTimeMembers2.id = :recipientId', {recipientId})\n+┊   ┊ 55┊        .innerJoinAndSelect('chat.listingMembers', 'listingMembers')\n+┊   ┊ 56┊        .getOne();\n+┊   ┊ 57┊\n ┊ 28┊ 58┊      if (chat) {\n-┊ 29┊   ┊        // Chat already exists. Both users are already in the allTimeMemberIds array\n-┊ 30┊   ┊        const chatId = chat.id;\n-┊ 31┊   ┊        if (!chat.listingMemberIds.includes(currentUser.id)) {\n+┊   ┊ 59┊        // Chat already exists. Both users are already in the userIds array\n+┊   ┊ 60┊        const listingMembers = await connection\n+┊   ┊ 61┊          .createQueryBuilder(User, \"user\")\n+┊   ┊ 62┊          .innerJoin('user.listingMemberChats', 'listingMemberChats', 'listingMemberChats.id = :chatId', {chatId: chat.id})\n+┊   ┊ 63┊          .getMany();\n+┊   ┊ 64┊\n+┊   ┊ 65┊        if (!listingMembers.find(user => user.id === currentUser.id)) {\n ┊ 32┊ 66┊          // The chat isn't listed for the current user. Add him to the memberIds\n-┊ 33┊   ┊          chat.listingMemberIds.push(currentUser.id);\n-┊ 34┊   ┊          chats.find(chat => chat.id === chatId)!.listingMemberIds.push(currentUser.id);\n-┊ 35┊   ┊          return chat;\n+┊   ┊ 67┊          chat.listingMembers.push(currentUser);\n+┊   ┊ 68┊          chat = await connection.getRepository(Chat).save(chat);\n+┊   ┊ 69┊\n+┊   ┊ 70┊          return chat || null;\n ┊ 36┊ 71┊        } else {\n ┊ 37┊ 72┊          throw new Error(`Chat already exists.`);\n ┊ 38┊ 73┊        }\n ┊ 39┊ 74┊      } else {\n ┊ 40┊ 75┊        // Create the chat\n-┊ 41┊   ┊        const id = (chats.length && chats[chats.length - 1].id + 1) || 1;\n-┊ 42┊   ┊        const chat: Chat = {\n-┊ 43┊   ┊          id,\n-┊ 44┊   ┊          name: null,\n-┊ 45┊   ┊          picture: null,\n-┊ 46┊   ┊          adminIds: null,\n-┊ 47┊   ┊          ownerId: null,\n-┊ 48┊   ┊          allTimeMemberIds: [currentUser.id, Number(recipientId)],\n+┊   ┊ 76┊        chat = await connection.getRepository(Chat).save(new Chat({\n+┊   ┊ 77┊          allTimeMembers: [currentUser, recipient],\n ┊ 49┊ 78┊          // Chat will not be listed to the other user until the first message gets written\n-┊ 50┊   ┊          listingMemberIds: [currentUser.id],\n-┊ 51┊   ┊          actualGroupMemberIds: null,\n-┊ 52┊   ┊          messages: [],\n-┊ 53┊   ┊        };\n-┊ 54┊   ┊        chats.push(chat);\n+┊   ┊ 79┊          listingMembers: [currentUser],\n+┊   ┊ 80┊        }));\n ┊ 55┊ 81┊\n-┊ 56┊   ┊        return chat;\n+┊   ┊ 82┊        return chat || null;\n ┊ 57┊ 83┊      }\n ┊ 58┊ 84┊    },\n-┊ 59┊   ┊    addGroup: (obj: any, {recipientIds, groupName}: AddGroupMutationArgs, {user: currentUser}: {user: User}): Chat => {\n-┊ 60┊   ┊      recipientIds.forEach(recipientId => {\n-┊ 61┊   ┊        if (!users.find(user => user.id === Number(recipientId))) {\n+┊   ┊ 85┊    addGroup: async (obj: any, {recipientIds, groupName}: AddGroupMutationArgs, {user: currentUser, connection}: { user: User, connection: Connection }): Promise<Chat | null> => {\n+┊   ┊ 86┊      let recipients: User[] = [];\n+┊   ┊ 87┊      for (let recipientId of recipientIds) {\n+┊   ┊ 88┊        const recipient = await connection\n+┊   ┊ 89┊          .createQueryBuilder(User, \"user\")\n+┊   ┊ 90┊          .whereInIds(recipientId)\n+┊   ┊ 91┊          .getOne();\n+┊   ┊ 92┊        if (!recipient) {\n ┊ 62┊ 93┊          throw new Error(`Recipient ${recipientId} doesn't exist.`);\n ┊ 63┊ 94┊        }\n-┊ 64┊   ┊      });\n+┊   ┊ 95┊        recipients.push(recipient);\n+┊   ┊ 96┊      }\n ┊ 65┊ 97┊\n-┊ 66┊   ┊      const id = (chats.length && chats[chats.length - 1].id + 1) || 1;\n-┊ 67┊   ┊      const chat: Chat = {\n-┊ 68┊   ┊        id,\n+┊   ┊ 98┊      const chat = await connection.getRepository(Chat).save(new Chat({\n ┊ 69┊ 99┊        name: groupName,\n-┊ 70┊   ┊        picture: null,\n-┊ 71┊   ┊        adminIds: [currentUser.id],\n-┊ 72┊   ┊        ownerId: currentUser.id,\n-┊ 73┊   ┊        allTimeMemberIds: [currentUser.id, ...recipientIds.map(id => Number(id))],\n-┊ 74┊   ┊        listingMemberIds: [currentUser.id, ...recipientIds.map(id => Number(id))],\n-┊ 75┊   ┊        actualGroupMemberIds: [currentUser.id, ...recipientIds.map(id => Number(id))],\n-┊ 76┊   ┊        messages: [],\n-┊ 77┊   ┊      };\n-┊ 78┊   ┊      chats.push(chat);\n+┊   ┊100┊        admins: [currentUser],\n+┊   ┊101┊        owner: currentUser,\n+┊   ┊102┊        allTimeMembers: [...recipients, currentUser],\n+┊   ┊103┊        listingMembers: [...recipients, currentUser],\n+┊   ┊104┊        actualGroupMembers: [...recipients, currentUser],\n+┊   ┊105┊      }));\n ┊ 79┊106┊\n ┊ 80┊107┊      pubsub.publish('chatAdded', {\n ┊ 81┊108┊        creatorId: currentUser.id,\n ┊ 82┊109┊        chatAdded: chat,\n ┊ 83┊110┊      });\n ┊ 84┊111┊\n-┊ 85┊   ┊      return chat;\n+┊   ┊112┊      return chat || null;\n ┊ 86┊113┊    },\n-┊ 87┊   ┊    removeChat: (obj: any, {chatId}: RemoveChatMutationArgs, {user: currentUser}: {user: User}): number => {\n-┊ 88┊   ┊      const chat = chats.find(chat => chat.id === Number(chatId));\n+┊   ┊114┊    removeChat: async (obj: any, {chatId}: RemoveChatMutationArgs, {user: currentUser, connection}: { user: User, connection: Connection }) => {\n+┊   ┊115┊      const chat = await connection\n+┊   ┊116┊        .createQueryBuilder(Chat, \"chat\")\n+┊   ┊117┊        .whereInIds(Number(chatId))\n+┊   ┊118┊        .innerJoinAndSelect('chat.listingMembers', 'listingMembers')\n+┊   ┊119┊        .leftJoinAndSelect('chat.actualGroupMembers', 'actualGroupMembers')\n+┊   ┊120┊        .leftJoinAndSelect('chat.admins', 'admins')\n+┊   ┊121┊        .leftJoinAndSelect('chat.owner', 'owner')\n+┊   ┊122┊        .leftJoinAndSelect('chat.messages', 'messages')\n+┊   ┊123┊        .leftJoinAndSelect('messages.holders', 'holders')\n+┊   ┊124┊        .getOne();\n ┊ 89┊125┊\n ┊ 90┊126┊      if (!chat) {\n ┊ 91┊127┊        throw new Error(`The chat ${chatId} doesn't exist.`);\n```\n```diff\n@@ -93,186 +129,188 @@\n ┊ 93┊129┊\n ┊ 94┊130┊      if (!chat.name) {\n ┊ 95┊131┊        // Chat\n-┊ 96┊   ┊        if (!chat.listingMemberIds.includes(currentUser.id)) {\n-┊ 97┊   ┊          throw new Error(`The user is not a member of the chat ${chatId}.`);\n+┊   ┊132┊        if (!chat.listingMembers.find(user => user.id === currentUser.id)) {\n+┊   ┊133┊          throw new Error(`The user is not a listing member of the chat ${chatId}.`);\n ┊ 98┊134┊        }\n ┊ 99┊135┊\n ┊100┊136┊        // Instead of chaining map and filter we can loop once using reduce\n-┊101┊   ┊        const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n-┊102┊   ┊          // Remove the current user from the message holders\n-┊103┊   ┊          message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser.id);\n+┊   ┊137┊        chat.messages = await chat.messages.reduce<Promise<Message[]>>(async (filtered$, message) => {\n+┊   ┊138┊          const filtered = await filtered$;\n ┊104┊139┊\n-┊105┊   ┊          if (message.holderIds.length !== 0) {\n+┊   ┊140┊          message.holders = message.holders.filter(user => user.id !== currentUser.id);\n+┊   ┊141┊\n+┊   ┊142┊          if (message.holders.length !== 0) {\n+┊   ┊143┊            // Remove the current user from the message holders\n+┊   ┊144┊            await connection.getRepository(Message).save(message);\n ┊106┊145┊            filtered.push(message);\n-┊107┊   ┊          } // else discard the message\n+┊   ┊146┊          } else {\n+┊   ┊147┊            // Simply remove the message\n+┊   ┊148┊            const recipients = await connection\n+┊   ┊149┊              .createQueryBuilder(Recipient, \"recipient\")\n+┊   ┊150┊              .innerJoinAndSelect('recipient.message', 'message', 'message.id = :messageId', {messageId: message.id})\n+┊   ┊151┊              .innerJoinAndSelect('recipient.user', 'user')\n+┊   ┊152┊              .getMany();\n+┊   ┊153┊            for (let recipient of recipients) {\n+┊   ┊154┊              await connection.getRepository(Recipient).remove(recipient);\n+┊   ┊155┊            }\n+┊   ┊156┊            await connection.getRepository(Message).remove(message);\n+┊   ┊157┊          }\n ┊108┊158┊\n ┊109┊159┊          return filtered;\n-┊110┊   ┊        }, []);\n+┊   ┊160┊        }, Promise.resolve([]));\n ┊111┊161┊\n ┊112┊162┊        // Remove the current user from who gets the chat listed. The chat will no longer appear in his list\n-┊113┊   ┊        const listingMemberIds = chat.listingMemberIds.filter(listingId => listingId !== currentUser.id);\n+┊   ┊163┊        chat.listingMembers = chat.listingMembers.filter(user => user.id !== currentUser.id);\n ┊114┊164┊\n ┊115┊165┊        // Check how many members are left\n-┊116┊   ┊        if (listingMemberIds.length === 0) {\n+┊   ┊166┊        if (chat.listingMembers.length === 0) {\n ┊117┊167┊          // Delete the chat\n-┊118┊   ┊          chats = chats.filter(chat => chat.id !== Number(chatId));\n+┊   ┊168┊          await connection.getRepository(Chat).remove(chat);\n ┊119┊169┊        } else {\n ┊120┊170┊          // Update the chat\n-┊121┊   ┊          chats = chats.map(chat => {\n-┊122┊   ┊            if (chat.id === Number(chatId)) {\n-┊123┊   ┊              chat = {...chat, listingMemberIds, messages};\n-┊124┊   ┊            }\n-┊125┊   ┊            return chat;\n-┊126┊   ┊          });\n+┊   ┊171┊          await connection.getRepository(Chat).save(chat);\n ┊127┊172┊        }\n-┊128┊   ┊        return Number(chatId);\n+┊   ┊173┊        return chatId;\n ┊129┊174┊      } else {\n ┊130┊175┊        // Group\n-┊131┊   ┊        if (chat.ownerId !== currentUser.id) {\n-┊132┊   ┊          throw new Error(`Group ${chatId} is not owned by the user.`);\n-┊133┊   ┊        }\n ┊134┊176┊\n ┊135┊177┊        // Instead of chaining map and filter we can loop once using reduce\n-┊136┊   ┊        const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n-┊137┊   ┊          // Remove the current user from the message holders\n-┊138┊   ┊          message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser.id);\n+┊   ┊178┊        chat.messages = await chat.messages.reduce<Promise<Message[]>>(async (filtered$, message) => {\n+┊   ┊179┊          const filtered = await filtered$;\n+┊   ┊180┊\n+┊   ┊181┊          message.holders = message.holders.filter(user => user.id !== currentUser.id);\n ┊139┊182┊\n-┊140┊   ┊          if (message.holderIds.length !== 0) {\n+┊   ┊183┊          if (message.holders.length !== 0) {\n+┊   ┊184┊            // Remove the current user from the message holders\n+┊   ┊185┊            await connection.getRepository(Message).save(message);\n ┊141┊186┊            filtered.push(message);\n-┊142┊   ┊          } // else discard the message\n+┊   ┊187┊          } else {\n+┊   ┊188┊            // Simply remove the message\n+┊   ┊189┊            const recipients = await connection\n+┊   ┊190┊              .createQueryBuilder(Recipient, \"recipient\")\n+┊   ┊191┊              .innerJoinAndSelect('recipient.message', 'message', 'message.id = :messageId', {messageId: message.id})\n+┊   ┊192┊              .innerJoinAndSelect('recipient.user', 'user')\n+┊   ┊193┊              .getMany();\n+┊   ┊194┊            for (let recipient of recipients) {\n+┊   ┊195┊              await connection.getRepository(Recipient).remove(recipient);\n+┊   ┊196┊            }\n+┊   ┊197┊            await connection.getRepository(Message).remove(message);\n+┊   ┊198┊          }\n ┊143┊199┊\n ┊144┊200┊          return filtered;\n-┊145┊   ┊        }, []);\n+┊   ┊201┊        }, Promise.resolve([]));\n ┊146┊202┊\n ┊147┊203┊        // Remove the current user from who gets the group listed. The group will no longer appear in his list\n-┊148┊   ┊        const listingMemberIds = chat.listingMemberIds.filter(listingId => listingId !== currentUser.id);\n+┊   ┊204┊        chat.listingMembers = chat.listingMembers.filter(user => user.id !== currentUser.id);\n ┊149┊205┊\n ┊150┊206┊        // Check how many members (including previous ones who can still access old messages) are left\n-┊151┊   ┊        if (listingMemberIds.length === 0) {\n+┊   ┊207┊        if (chat.listingMembers.length === 0) {\n ┊152┊208┊          // Remove the group\n-┊153┊   ┊          chats = chats.filter(chat => chat.id !== Number(chatId));\n+┊   ┊209┊          await connection.getRepository(Chat).remove(chat);\n ┊154┊210┊        } else {\n ┊155┊211┊          // Update the group\n ┊156┊212┊\n ┊157┊213┊          // Remove the current user from the chat members. He is no longer a member of the group\n-┊158┊   ┊          const actualGroupMemberIds = chat.actualGroupMemberIds!.filter(memberId => memberId !== currentUser.id);\n+┊   ┊214┊          chat.actualGroupMembers = chat.actualGroupMembers && chat.actualGroupMembers.filter(user => user.id !== currentUser.id);\n ┊159┊215┊          // Remove the current user from the chat admins\n-┊160┊   ┊          const adminIds = chat.adminIds!.filter(memberId => memberId !== currentUser.id);\n-┊161┊   ┊          // Set the owner id to be null. A null owner means the group is read-only\n-┊162┊   ┊          let ownerId: number | null = null;\n-┊163┊   ┊\n-┊164┊   ┊          // Check if there is any admin left\n-┊165┊   ┊          if (adminIds!.length) {\n-┊166┊   ┊            // Pick an admin as the new owner. The group is no longer read-only\n-┊167┊   ┊            ownerId = chat.adminIds![0];\n-┊168┊   ┊          }\n+┊   ┊216┊          chat.admins = chat.admins && chat.admins.filter(user => user.id !== currentUser.id);\n+┊   ┊217┊          // If there are no more admins left the group goes read only\n+┊   ┊218┊          chat.owner = chat.admins && chat.admins[0] || null; // A null owner means the group is read-only\n ┊169┊219┊\n-┊170┊   ┊          chats = chats.map(chat => {\n-┊171┊   ┊            if (chat.id === Number(chatId)) {\n-┊172┊   ┊              chat = {...chat, messages, listingMemberIds, actualGroupMemberIds, adminIds, ownerId};\n-┊173┊   ┊            }\n-┊174┊   ┊            return chat;\n-┊175┊   ┊          });\n+┊   ┊220┊          await connection.getRepository(Chat).save(chat);\n ┊176┊221┊        }\n-┊177┊   ┊        return Number(chatId);\n+┊   ┊222┊        return chatId;\n ┊178┊223┊      }\n ┊179┊224┊    },\n-┊180┊   ┊    addMessage: (obj: any, {chatId, content}: AddMessageMutationArgs, {user: currentUser}: {user: User}): Message => {\n+┊   ┊225┊    addMessage: async (obj: any, {chatId, content}: AddMessageMutationArgs, {user: currentUser, connection}: { user: User, connection: Connection }): Promise<Message | null> => {\n ┊181┊226┊      if (content === null || content === '') {\n ┊182┊227┊        throw new Error(`Cannot add empty or null messages.`);\n ┊183┊228┊      }\n ┊184┊229┊\n-┊185┊   ┊      let chat = chats.find(chat => chat.id === Number(chatId));\n+┊   ┊230┊      let chat = await connection\n+┊   ┊231┊        .createQueryBuilder(Chat, \"chat\")\n+┊   ┊232┊        .whereInIds(chatId)\n+┊   ┊233┊        .innerJoinAndSelect('chat.allTimeMembers', 'allTimeMembers')\n+┊   ┊234┊        .innerJoinAndSelect('chat.listingMembers', 'listingMembers')\n+┊   ┊235┊        .leftJoinAndSelect('chat.actualGroupMembers', 'actualGroupMembers')\n+┊   ┊236┊        .getOne();\n ┊186┊237┊\n ┊187┊238┊      if (!chat) {\n ┊188┊239┊        throw new Error(`Cannot find chat ${chatId}.`);\n ┊189┊240┊      }\n ┊190┊241┊\n-┊191┊   ┊      let holderIds = chat.listingMemberIds;\n+┊   ┊242┊      let holders: User[];\n ┊192┊243┊\n ┊193┊244┊      if (!chat.name) {\n ┊194┊245┊        // Chat\n-┊195┊   ┊        if (!chat.listingMemberIds.find(listingId => listingId === currentUser.id)) {\n+┊   ┊246┊        if (!chat.listingMembers.map(user => user.id).includes(currentUser.id)) {\n ┊196┊247┊          throw new Error(`The chat ${chatId} must be listed for the current user before adding a message.`);\n ┊197┊248┊        }\n ┊198┊249┊\n-┊199┊   ┊        const recipientId = chat.allTimeMemberIds.filter(userId => userId !== currentUser.id)[0];\n+┊   ┊250┊        const recipientUser = chat.allTimeMembers.find(user => user.id !== currentUser.id);\n ┊200┊251┊\n-┊201┊   ┊        if (!chat.listingMemberIds.find(listingId => listingId === recipientId)) {\n-┊202┊   ┊          // Chat is not listed for the recipient. Add him to the listingMemberIds\n-┊203┊   ┊          const listingMemberIds = chat.listingMemberIds.concat(recipientId);\n+┊   ┊252┊        if (!recipientUser) {\n+┊   ┊253┊          throw new Error(`Cannot find recipient user.`);\n+┊   ┊254┊        }\n ┊204┊255┊\n-┊205┊   ┊          chats = chats.map(chat => {\n-┊206┊   ┊            if (chat.id === Number(chatId)) {\n-┊207┊   ┊              chat = {...chat, listingMemberIds};\n-┊208┊   ┊            }\n-┊209┊   ┊            return chat;\n-┊210┊   ┊          });\n+┊   ┊256┊        if (!chat.listingMembers.find(user => user.id === recipientUser.id)) {\n+┊   ┊257┊          // Chat is not listed for the recipient. Add him to the listingIds\n+┊   ┊258┊          chat.listingMembers.push(recipientUser);\n ┊211┊259┊\n-┊212┊   ┊          holderIds = listingMemberIds;\n+┊   ┊260┊          await connection.getRepository(Chat).save(chat);\n ┊213┊261┊\n ┊214┊262┊          pubsub.publish('chatAdded', {\n ┊215┊263┊            creatorId: currentUser.id,\n ┊216┊264┊            chatAdded: chat,\n ┊217┊265┊          });\n ┊218┊266┊        }\n+┊   ┊267┊\n+┊   ┊268┊        holders = chat.listingMembers;\n ┊219┊269┊      } else {\n ┊220┊270┊        // Group\n-┊221┊   ┊        if (!chat.actualGroupMemberIds!.find(memberId => memberId === currentUser.id)) {\n+┊   ┊271┊        if (!chat.actualGroupMembers || !chat.actualGroupMembers.find(user => user.id === currentUser.id)) {\n ┊222┊272┊          throw new Error(`The user is not a member of the group ${chatId}. Cannot add message.`);\n ┊223┊273┊        }\n ┊224┊274┊\n-┊225┊   ┊        holderIds = chat.actualGroupMemberIds!;\n+┊   ┊275┊        holders = chat.actualGroupMembers;\n ┊226┊276┊      }\n ┊227┊277┊\n-┊228┊   ┊      const id = (chat.messages.length && chat.messages[chat.messages.length - 1].id + 1) || 1;\n-┊229┊   ┊\n-┊230┊   ┊      let recipients: Recipient[] = [];\n-┊231┊   ┊\n-┊232┊   ┊      holderIds.forEach(holderId => {\n-┊233┊   ┊        if (holderId !== currentUser.id) {\n-┊234┊   ┊          recipients.push({\n-┊235┊   ┊            userId: holderId,\n-┊236┊   ┊            messageId: id,\n-┊237┊   ┊            chatId: Number(chatId),\n-┊238┊   ┊            receivedAt: null,\n-┊239┊   ┊            readAt: null,\n-┊240┊   ┊          });\n-┊241┊   ┊        }\n-┊242┊   ┊      });\n-┊243┊   ┊\n-┊244┊   ┊      const message: Message = {\n-┊245┊   ┊        id,\n-┊246┊   ┊        chatId: Number(chatId),\n-┊247┊   ┊        senderId: currentUser.id,\n+┊   ┊278┊      const message = await connection.getRepository(Message).save(new Message({\n+┊   ┊279┊        chat: chat,\n+┊   ┊280┊        sender: currentUser,\n ┊248┊281┊        content,\n-┊249┊   ┊        createdAt: moment().unix(),\n ┊250┊282┊        type: MessageType.TEXT,\n-┊251┊   ┊        recipients,\n-┊252┊   ┊        holderIds,\n-┊253┊   ┊      };\n-┊254┊   ┊\n-┊255┊   ┊      chats = chats.map(chat => {\n-┊256┊   ┊        if (chat.id === Number(chatId)) {\n-┊257┊   ┊          chat = {...chat, messages: chat.messages.concat(message)}\n-┊258┊   ┊        }\n-┊259┊   ┊        return chat;\n-┊260┊   ┊      });\n+┊   ┊283┊        holders,\n+┊   ┊284┊        recipients: holders.reduce<Recipient[]>((filtered, user) => {\n+┊   ┊285┊          if (user.id !== currentUser.id) {\n+┊   ┊286┊            filtered.push(new Recipient({\n+┊   ┊287┊              user,\n+┊   ┊288┊            }));\n+┊   ┊289┊          }\n+┊   ┊290┊          return filtered;\n+┊   ┊291┊        }, []),\n+┊   ┊292┊      }));\n ┊261┊293┊\n ┊262┊294┊      pubsub.publish('messageAdded', {\n ┊263┊295┊        messageAdded: message,\n ┊264┊296┊      });\n ┊265┊297┊\n-┊266┊   ┊      return message;\n+┊   ┊298┊      return message || null;\n ┊267┊299┊    },\n-┊268┊   ┊    removeMessages: (obj: any, {chatId, messageIds, all}: RemoveMessagesMutationArgs, {user: currentUser}: {user: User}): number[] => {\n-┊269┊   ┊      const chat = chats.find(chat => chat.id === Number(chatId));\n+┊   ┊300┊    removeMessages: async (obj: any, {chatId, messageIds, all}: RemoveMessagesMutationArgs, {user: currentUser, connection}: { user: User, connection: Connection }) => {\n+┊   ┊301┊      const chat = await connection\n+┊   ┊302┊        .createQueryBuilder(Chat, \"chat\")\n+┊   ┊303┊        .whereInIds(chatId)\n+┊   ┊304┊        .innerJoinAndSelect('chat.listingMembers', 'listingMembers')\n+┊   ┊305┊        .innerJoinAndSelect('chat.messages', 'messages')\n+┊   ┊306┊        .innerJoinAndSelect('messages.holders', 'holders')\n+┊   ┊307┊        .getOne();\n ┊270┊308┊\n ┊271┊309┊      if (!chat) {\n ┊272┊310┊        throw new Error(`Cannot find chat ${chatId}.`);\n ┊273┊311┊      }\n ┊274┊312┊\n-┊275┊   ┊      if (!chat.listingMemberIds.find(listingId => listingId === currentUser.id)) {\n+┊   ┊313┊      if (!chat.listingMembers.find(user => user.id === currentUser.id)) {\n ┊276┊314┊        throw new Error(`The chat/group ${chatId} is not listed for the current user, so there is nothing to delete.`);\n ┊277┊315┊      }\n ┊278┊316┊\n```\n```diff\n@@ -280,79 +318,166 @@\n ┊280┊318┊        throw new Error(`Cannot specify both 'all' and 'messageIds'.`);\n ┊281┊319┊      }\n ┊282┊320┊\n+┊   ┊321┊      if (!all && !(messageIds && messageIds.length)) {\n+┊   ┊322┊        throw new Error(`'all' and 'messageIds' cannot be both null`);\n+┊   ┊323┊      }\n+┊   ┊324┊\n ┊283┊325┊      let deletedIds: number[] = [];\n-┊284┊   ┊      chats = chats.map(chat => {\n-┊285┊   ┊        if (chat.id === Number(chatId)) {\n-┊286┊   ┊          // Instead of chaining map and filter we can loop once using reduce\n-┊287┊   ┊          const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n-┊288┊   ┊            if (all || messageIds!.includes(String(message.id))) {\n-┊289┊   ┊              deletedIds.push(message.id);\n-┊290┊   ┊              // Remove the current user from the message holders\n-┊291┊   ┊              message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser.id);\n-┊292┊   ┊            }\n+┊   ┊326┊      // Instead of chaining map and filter we can loop once using reduce\n+┊   ┊327┊      chat.messages = await chat.messages.reduce<Promise<Message[]>>(async (filtered$, message) => {\n+┊   ┊328┊        const filtered = await filtered$;\n ┊293┊329┊\n-┊294┊   ┊            if (message.holderIds.length !== 0) {\n-┊295┊   ┊              filtered.push(message);\n-┊296┊   ┊            } // else discard the message\n+┊   ┊330┊        if (all || messageIds!.includes(String(message.id))) {\n+┊   ┊331┊          deletedIds.push(message.id);\n+┊   ┊332┊          // Remove the current user from the message holders\n+┊   ┊333┊          message.holders = message.holders.filter(user => user.id !== currentUser.id);\n ┊297┊334┊\n-┊298┊   ┊            return filtered;\n-┊299┊   ┊          }, []);\n-┊300┊   ┊          chat = {...chat, messages};\n ┊301┊335┊        }\n-┊302┊   ┊        return chat;\n-┊303┊   ┊      });\n+┊   ┊336┊\n+┊   ┊337┊        if (message.holders.length !== 0) {\n+┊   ┊338┊          // Remove the current user from the message holders\n+┊   ┊339┊          await connection.getRepository(Message).save(message);\n+┊   ┊340┊          filtered.push(message);\n+┊   ┊341┊        } else {\n+┊   ┊342┊          // Simply remove the message\n+┊   ┊343┊          const recipients = await connection\n+┊   ┊344┊            .createQueryBuilder(Recipient, \"recipient\")\n+┊   ┊345┊            .innerJoinAndSelect('recipient.message', 'message', 'message.id = :messageId', {messageId: message.id})\n+┊   ┊346┊            .innerJoinAndSelect('recipient.user', 'user')\n+┊   ┊347┊            .getMany();\n+┊   ┊348┊          for (let recipient of recipients) {\n+┊   ┊349┊            await connection.getRepository(Recipient).remove(recipient);\n+┊   ┊350┊          }\n+┊   ┊351┊          await connection.getRepository(Message).remove(message);\n+┊   ┊352┊        }\n+┊   ┊353┊\n+┊   ┊354┊        return filtered;\n+┊   ┊355┊      }, Promise.resolve([]));\n+┊   ┊356┊\n+┊   ┊357┊      await connection.getRepository(Chat).save(chat);\n+┊   ┊358┊\n ┊304┊359┊      return deletedIds;\n ┊305┊360┊    },\n ┊306┊361┊  },\n ┊307┊362┊  Subscription: {\n ┊308┊363┊    messageAdded: {\n ┊309┊364┊      subscribe: withFilter(() => pubsub.asyncIterator('messageAdded'),\n-┊310┊   ┊        ({messageAdded}: {messageAdded: Message & {chat: {id: number}}}, {chatId}: MessageAddedSubscriptionArgs, {user: currentUser}: { user: User }) => {\n+┊   ┊365┊        ({messageAdded}: {messageAdded: Message}, {chatId}: MessageAddedSubscriptionArgs, {user: currentUser}: { user: User }) => {\n ┊311┊366┊          return (!chatId || messageAdded.chat.id === Number(chatId)) &&\n-┊312┊   ┊            !!messageAdded.recipients.find((recipient: Recipient) => recipient.userId === currentUser.id);\n+┊   ┊367┊            !!messageAdded.recipients.find((recipient: Recipient) => recipient.user.id === currentUser.id);\n ┊313┊368┊        }),\n ┊314┊369┊    },\n ┊315┊370┊    chatAdded: {\n ┊316┊371┊      subscribe: withFilter(() => pubsub.asyncIterator('chatAdded'),\n-┊317┊   ┊        ({creatorId, chatAdded}: {creatorId: string, chatAdded: Chat}, variables: any, {user: currentUser}: { user: User }) => {\n-┊318┊   ┊          return Number(creatorId) !== currentUser.id && !chatAdded.listingMemberIds.includes(currentUser.id);\n+┊   ┊372┊        ({creatorId, chatAdded}: {creatorId: string, chatAdded: Chat}, variables, {user: currentUser}: { user: User }) => {\n+┊   ┊373┊          return Number(creatorId) !== currentUser.id &&\n+┊   ┊374┊            !!chatAdded.listingMembers.find((user: User) => user.id === currentUser.id);\n ┊319┊375┊        }),\n ┊320┊376┊    }\n ┊321┊377┊  },\n ┊322┊378┊  Chat: {\n-┊323┊   ┊    name: (chat: Chat, args: any, {user: currentUser}: {user: User}): string => chat.name ? chat.name : users\n-┊324┊   ┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser.id))!.name,\n-┊325┊   ┊    picture: (chat: Chat, args: any, {user: currentUser}: {user: User}) => chat.name ? chat.picture : users\n-┊326┊   ┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser.id))!.picture,\n-┊327┊   ┊    allTimeMembers: (chat: Chat): User[] => users.filter(user => chat.allTimeMemberIds.includes(user.id)),\n-┊328┊   ┊    listingMembers: (chat: Chat): User[] => users.filter(user => chat.listingMemberIds.includes(user.id)),\n-┊329┊   ┊    actualGroupMembers: (chat: Chat): User[] => users.filter(user => chat.actualGroupMemberIds && chat.actualGroupMemberIds.includes(user.id)),\n-┊330┊   ┊    admins: (chat: Chat): User[] => users.filter(user => chat.adminIds && chat.adminIds.includes(user.id)),\n-┊331┊   ┊    owner: (chat: Chat): User | null => users.find(user => chat.ownerId === user.id) || null,\n-┊332┊   ┊    messages: (chat: Chat, {amount = 0}: {amount: number}, {user: currentUser}: {user: User}): Message[] => {\n-┊333┊   ┊      const messages = chat.messages\n-┊334┊   ┊      .filter(message => message.holderIds.includes(currentUser.id))\n-┊335┊   ┊      .sort((a, b) => b.createdAt - a.createdAt) || <Message[]>[];\n-┊336┊   ┊      return (amount ? messages.slice(0, amount) : messages).reverse();\n+┊   ┊379┊    name: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<string | null> => {\n+┊   ┊380┊      if (chat.name) {\n+┊   ┊381┊        return chat.name;\n+┊   ┊382┊      }\n+┊   ┊383┊      const user = await connection\n+┊   ┊384┊        .createQueryBuilder(User, \"user\")\n+┊   ┊385┊        .where('user.id != :userId', {userId: currentUser.id})\n+┊   ┊386┊        .innerJoin('user.allTimeMemberChats', 'allTimeMemberChats', 'allTimeMemberChats.id = :chatId', {chatId: chat.id})\n+┊   ┊387┊        .getOne();\n+┊   ┊388┊      return user && user.name || null;\n+┊   ┊389┊    },\n+┊   ┊390┊    picture: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<string | null> => {\n+┊   ┊391┊      if (chat.name) {\n+┊   ┊392┊        return chat.picture;\n+┊   ┊393┊      }\n+┊   ┊394┊      const user = await connection\n+┊   ┊395┊        .createQueryBuilder(User, \"user\")\n+┊   ┊396┊        .where('user.id != :userId', {userId: currentUser.id})\n+┊   ┊397┊        .innerJoin('user.allTimeMemberChats', 'allTimeMemberChats', 'allTimeMemberChats.id = :chatId', {chatId: chat.id})\n+┊   ┊398┊        .getOne();\n+┊   ┊399┊      return user ? user.picture : null;\n+┊   ┊400┊    },\n+┊   ┊401┊    allTimeMembers: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User[]> => {\n+┊   ┊402┊      return await connection\n+┊   ┊403┊        .createQueryBuilder(User, \"user\")\n+┊   ┊404┊        .innerJoin('user.allTimeMemberChats', 'allTimeMemberChats', 'allTimeMemberChats.id = :chatId', {chatId: chat.id})\n+┊   ┊405┊        .getMany();\n+┊   ┊406┊    },\n+┊   ┊407┊    listingMembers: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User[]> => {\n+┊   ┊408┊      return await connection\n+┊   ┊409┊        .createQueryBuilder(User, \"user\")\n+┊   ┊410┊        .innerJoin('user.listingMemberChats', 'listingMemberChats', 'listingMemberChats.id = :chatId', {chatId: chat.id})\n+┊   ┊411┊        .getMany();\n+┊   ┊412┊    },\n+┊   ┊413┊    actualGroupMembers: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User[]> => {\n+┊   ┊414┊      return await connection\n+┊   ┊415┊        .createQueryBuilder(User, \"user\")\n+┊   ┊416┊        .innerJoin('user.actualGroupMemberChats', 'actualGroupMemberChats', 'actualGroupMemberChats.id = :chatId', {chatId: chat.id})\n+┊   ┊417┊        .getMany();\n+┊   ┊418┊    },\n+┊   ┊419┊    admins: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User[]> => {\n+┊   ┊420┊      return await connection\n+┊   ┊421┊        .createQueryBuilder(User, \"user\")\n+┊   ┊422┊        .innerJoin('user.adminChats', 'adminChats', 'adminChats.id = :chatId', {chatId: chat.id})\n+┊   ┊423┊        .getMany();\n ┊337┊424┊    },\n-┊338┊   ┊    unreadMessages: (chat: Chat, args: any, {user: currentUser}: {user: User}): number => chat.messages\n-┊339┊   ┊      .filter(message => message.holderIds.includes(currentUser.id) &&\n-┊340┊   ┊        message.recipients.find(recipient => recipient.userId === currentUser.id && !recipient.readAt))\n-┊341┊   ┊      .length,\n-┊342┊   ┊    isGroup: (chat: Chat): boolean => !!chat.name,\n+┊   ┊425┊    owner: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User | null> => {\n+┊   ┊426┊      return await connection\n+┊   ┊427┊        .createQueryBuilder(User, \"user\")\n+┊   ┊428┊        .innerJoin('user.ownerChats', 'ownerChats', 'ownerChats.id = :chatId', {chatId: chat.id})\n+┊   ┊429┊        .getOne() || null;\n+┊   ┊430┊    },\n+┊   ┊431┊    messages: async (chat: Chat, {amount = 0}: {amount: number}, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<Message[]> => {\n+┊   ┊432┊      const query = connection\n+┊   ┊433┊        .createQueryBuilder(Message, \"message\")\n+┊   ┊434┊        .innerJoin('message.chat', 'chat', 'chat.id = :chatId', {chatId: chat.id})\n+┊   ┊435┊        .innerJoin('message.holders', 'holders', 'holders.id = :userId', {userId: currentUser.id})\n+┊   ┊436┊        .orderBy({\"message.createdAt\": \"DESC\"});\n+┊   ┊437┊      return (amount ? await query.take(amount).getMany() : await query.getMany()).reverse();\n+┊   ┊438┊    },\n+┊   ┊439┊    unreadMessages: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<number> => {\n+┊   ┊440┊      return await connection\n+┊   ┊441┊        .createQueryBuilder(Message, \"message\")\n+┊   ┊442┊        .innerJoin('message.chat', 'chat', 'chat.id = :chatId', {chatId: chat.id})\n+┊   ┊443┊        .innerJoin('message.recipients', 'recipients', 'recipients.user.id = :userId AND recipients.readAt IS NULL', {userId: currentUser.id})\n+┊   ┊444┊        .getCount();\n+┊   ┊445┊    },\n+┊   ┊446┊    isGroup: (chat: Chat) => !!chat.name,\n ┊343┊447┊  },\n ┊344┊448┊  Message: {\n-┊345┊   ┊    chat: (message: Message): Chat | null => chats.find(chat => message.chatId === chat.id) || null,\n-┊346┊   ┊    sender: (message: Message): User | null => users.find(user => user.id === message.senderId) || null,\n-┊347┊   ┊    holders: (message: Message): User[] => users.filter(user => message.holderIds.includes(user.id)),\n-┊348┊   ┊    ownership: (message: Message, args: any, {user: currentUser}: {user: User}): boolean => message.senderId === currentUser.id,\n-┊349┊   ┊  },\n-┊350┊   ┊  Recipient: {\n-┊351┊   ┊    user: (recipient: Recipient): User | null => users.find(user => recipient.userId === user.id) || null,\n-┊352┊   ┊    message: (recipient: Recipient): Message | null => {\n-┊353┊   ┊      const chat = chats.find(chat => recipient.chatId === chat.id);\n-┊354┊   ┊      return chat ? chat.messages.find(message => recipient.messageId === message.id) || null : null;\n+┊   ┊449┊    sender: async (message: Message, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User | null> => {\n+┊   ┊450┊      return (await connection\n+┊   ┊451┊        .createQueryBuilder(User, \"user\")\n+┊   ┊452┊        .innerJoin('user.senderMessages', 'senderMessages', 'senderMessages.id = :messageId', {messageId: message.id})\n+┊   ┊453┊        .getOne()) || null;\n+┊   ┊454┊    },\n+┊   ┊455┊    ownership: async (message: Message, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<boolean> => {\n+┊   ┊456┊      return !!(await connection\n+┊   ┊457┊        .createQueryBuilder(User, \"user\")\n+┊   ┊458┊        .whereInIds(currentUser.id)\n+┊   ┊459┊        .innerJoin('user.senderMessages', 'senderMessages', 'senderMessages.id = :messageId', {messageId: message.id})\n+┊   ┊460┊        .getCount());\n+┊   ┊461┊    },\n+┊   ┊462┊    recipients: async (message: Message, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<Recipient[]> => {\n+┊   ┊463┊      return await connection\n+┊   ┊464┊        .createQueryBuilder(Recipient, \"recipient\")\n+┊   ┊465┊        .innerJoinAndSelect('recipient.message', 'message', 'message.id = :messageId', {messageId: message.id})\n+┊   ┊466┊        .innerJoinAndSelect('recipient.user', 'user')\n+┊   ┊467┊        .innerJoinAndSelect('recipient.chat', 'chat')\n+┊   ┊468┊        .getMany();\n+┊   ┊469┊    },\n+┊   ┊470┊    holders: async (message: Message, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User[]> => {\n+┊   ┊471┊      return await connection\n+┊   ┊472┊        .createQueryBuilder(User, \"user\")\n+┊   ┊473┊        .innerJoin('user.holderMessages', 'holderMessages', 'holderMessages.id = :messageId', {messageId: message.id})\n+┊   ┊474┊        .getMany();\n+┊   ┊475┊    },\n+┊   ┊476┊    chat: async (message: Message, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<Chat | null> => {\n+┊   ┊477┊      return (await connection\n+┊   ┊478┊        .createQueryBuilder(Chat, \"chat\")\n+┊   ┊479┊        .innerJoin('chat.messages', 'messages', 'messages.id = :messageId', {messageId: message.id})\n+┊   ┊480┊        .getOne()) || null;\n ┊355┊481┊    },\n-┊356┊   ┊    chat: (recipient: Recipient): Chat | null => chats.find(chat => recipient.chatId === chat.id) || null,\n ┊357┊482┊  },\n ┊358┊483┊};\n```\n\n[}]: #\n\n`QueryBuilder` is one of the most powerful features of `TypeORM` - it allows you to build SQL queries using elegant and convenient syntax, execute them and get automatically transformed entities.\n\nYou can find more informations on `TypeORM` on http://typeorm.io\n\nThe best part is that you won't have to do anything on the client, everything will be completely transparent to it, even if migrated from NoSQL-like db structure to a relational one!\nOf course, you could remove the custom normalization for the messages because now they have their own table and they are no longer embedded (so they have unique IDs), but we could leave it as well in order to be free to use any kind of backend."
          }
        ]
      },
      {
        "releaseVersion": "1.1.0",
        "releaseDate": "2018-10-05 11:34:13 +0200",
        "tagName": "master@1.1.0",
        "tagRevision": "8f3d00eeea7d86d2a03cc895a6db04c623001d11",
        "historyRevision": "255bc73b527566c079ec6fab27ab8b3e187cbaa1",
        "changesDiff": "diff --git a/.tortilla/manuals/templates/root.tmpl b/.tortilla/manuals/templates/root.tmpl\nindex 37c481e..dcd53f6 100644\n--- a/.tortilla/manuals/templates/root.tmpl\n+++ b/.tortilla/manuals/templates/root.tmpl\n@@ -1 +1,64 @@\n-A newly created Tortilla project. For more information, see https://github.com/Urigo/tortilla.\n\\ No newline at end of file\n+## Startup instructions\n+\n+This project is made out of 2 sub-projects - the one is client and the other is server. We will go through the initialization for each of these individually. We will start with the server since the client is dependent on it.\n+\n+### Server\n+\n+First we need to clone the server project:\n+\n+    $ git clone git@github.com:Urigo/whatsapp-server-express.git\n+\n+Then we need to install the NPM dependencies:\n+\n+    $ npm install\n+\n+Before starting the server make sure that postgresql is installed:\n+\n+    $ sudo apt-get update\n+    $ sudo apt-get install postgresql postgresql-contrib\n+\n+Setup a user named \"test\" with no password by first switching into \"postgres\" account:\n+\n+    $ sudo -u postgres psql\n+\n+And running the following command:\n+\n+    postgres=# ALTER USER test WITH PASSWORD '';\n+\n+Try to run the server:\n+\n+    $ npm start\n+\n+If logs show that connection refused, kill the process and set a random password for the \"test\" user (e.g. \"test\"):\n+\n+    postgres=# ALTER USER test WITH PASSWORD 'test';\n+\n+Be sure to set the password in the `ormconfig.json` as well:\n+\n+```js\n+{\n+  // ...\n+  \"password\": \"test\",\n+  // ...\n+}\n+```\n+\n+Run the start command again:\n+\n+    $ npm start\n+\n+### Client\n+\n+**Be sure to go through server initialization first**\n+\n+First we need to clone the server project:\n+\n+    $ git clone git@github.com:Urigo/whatsapp-client-angularcli-material.git\n+\n+Then we need to install the NPM dependencies:\n+\n+    $ npm install\n+\n+Start the app:\n+\n+    $ npm start\ndiff --git a/.tortilla/manuals/templates/step15.tmpl b/.tortilla/manuals/templates/step15.tmpl\nindex 80b910a..dd87acf 100644\n--- a/.tortilla/manuals/templates/step15.tmpl\n+++ b/.tortilla/manuals/templates/step15.tmpl\n@@ -1,8 +1,6 @@\n ## Server\n\n-In order to use WebSockets we will need to install a couple of packages:\n-\n-    npm install graphql-subscriptions subscriptions-transport-ws\n+In order to use WebSockets we don't need to install any package, it comes for free with Apollo Server 2.0.\n\n Our GraphQL server will use WebSockets only for subscriptions, while using HTTP for everything else. That means that we will have to add subscriptions on a specific path.\n We're using `connectionParams` for the authentication over WebSockets, that means that we won't be using the `Passport` framework at all. Instead we will use the `onConnect` hook to manually validate the parameters provided by the user to either validate the WebSocket connection or throw an error.\n@@ -10,14 +8,14 @@ We will also return the user object we retrieved from the db, to let the resolve\n\n {{{ diffStep \"5.1\" module=\"server\" files=\"index.ts\" }}}\n\n-We will use the `PubSub` implementation from `graphql-subscriptions`, and we will connect it to `subscribe` executor of `graphql`, and publish the data using `subscriptions-transport-ws` (a WebSocket server and client library for GraphQL that can be used directly in a JavaScript app or wired up to a fully-featured GraphQL client like Apollo).\n+We will use the `PubSub` implementation from `apollo-server-express`, and publish the data using with Apollo Server.\n\n The process of setting up a GraphQL subscriptions server consist of the following steps:\n\n 1. Declaring subscriptions in the GraphQL schema\n 2. Setup a PubSub instance that our server will publish new events to\n 3. Hook together `PubSub` event and GraphQL subscription.\n-4. Setting up `SubscriptionsServer`, a transport between the server and the clients\n+4. Setting up `ApolloServer`\n\n {{{ diffStep \"5.1\" module=\"server\" files=\"schema/typeDefs.ts\" }}}\n\ndiff --git a/.tortilla/manuals/templates/step4.tmpl b/.tortilla/manuals/templates/step4.tmpl\nindex ba63323..81205c1 100644\n--- a/.tortilla/manuals/templates/step4.tmpl\n+++ b/.tortilla/manuals/templates/step4.tmpl\n@@ -5,6 +5,7 @@ The computer runs through everything we write in split second but we can still p\n This phase is sometimes being skipped by developers but trust me, you never want to skip this phase and you should always be super comfortable in debugging your code on whatever environment it’s running on.\n\n The easiest way to debug your Javascript application is right into your editor:\n+  * https://code.visualstudio.com/docs/introvideos/debugging\n   * https://www.jetbrains.com/help/webstorm/debugging-javascript-in-chrome.html\n   * https://blog.jetbrains.com/webstorm/2017/01/debugging-angular-apps/\n\ndiff --git a/.tortilla/manuals/templates/step5.tmpl b/.tortilla/manuals/templates/step5.tmpl\nindex 0c7558f..70fed19 100644\n--- a/.tortilla/manuals/templates/step5.tmpl\n+++ b/.tortilla/manuals/templates/step5.tmpl\n@@ -3,7 +3,7 @@\n After the planning phase it's finally time to start writing some real code!\n We'll start with the server, so let's install a couple of packages first:\n\n-    $ npm install apollo-server-express body-parser cors express graphql graphql-tools\n+    $ npm install apollo-server-express body-parser cors express graphql\n     $ npm install --save-dev @types/body-parser @types/cors @types/express @types/graphql\n\n Express is a fast, unopinionated, minimalist web framework for node.\n@@ -43,8 +43,8 @@ We can start the server by simply running:\n\n ## Client\n\n-Now we can concentrate on the client and bootstrap it using angular-cli.\n-First you will need to install angular-cli globally with:\n+Now we can concentrate on the client and bootstrap it using Angular-CLI.\n+First you will need to install it globally with:\n\n     $ npm install -g @angular/cli\n\n@@ -54,52 +54,281 @@ Then we can create a new project from scratch:\n\n Time to install a couple of packages:\n\n-    $ npm install apollo-angular apollo-angular-link-http apollo-cache-inmemory apollo-client apollo-link graphql graphql-tag\n+    $ ng add apollo-angular\n     $ npm install --save-dev @types/graphql\n\n-We will also need to add `esnext.asynciterable` to the libs:\n+Apollo's Schematics sets everything for us. The only thing missing is to fill the `url`.\n\n-{{{ diffStep \"1.1\" module=\"client\" files=\"tsconfig.json\" }}}\n+{{{ diffStep \"1.1\" module=\"client\" files=\"src/app/graphql.module.ts\" }}}\n\n-We also added the `downlevelIteration` option which is required to make sure that everything will be transpiled to ES5.\n+Let's take a closer look what Schematics prepared for us.\n\n-To get started using Apollo with Angular, we need to import two NgModules, `ApolloModule` and `HttpLinkModule`.\n+First, it created `graphql.module.ts` and used `ApolloModule` and `HttpLinkModule`.\n\n - `ApolloModule` is the center of using GraphQL in your app! It includes all needed services that allows to use ApolloClient’s features.\n - `HttpLinkModule` makes it easy to fetch data in Angular.\n\n `HttpLinkModule` is optional, you can replace it with any other Link.\n-Its biggest advantage of all is that it uses `HttpClient` internally so it’s possible to use it in `NativeScript` or in combination with any other `HttpClient` provider. By using `HttpLinkModule` you get Server-Side Rendering for free, without any additional work.\n+Its biggest advantage of all is that it uses Angular's `HttpClient` internally so it's possible to use it in `NativeScript` or in combination with any other `HttpClient` provider. By using `HttpLinkModule` you get Server-Side Rendering for free, without any additional work.\n\n-To get started, inject `Apollo` and `HttpLink` services and then create a client:\n+Next, we got `APOLLO_OPTIONS` provided to Angular.\n\n-{{{ diffStep \"1.1\" module=\"client\" files=\"app.module.ts\" }}}\n+We're using the `InMemoryCache` cache, but there are several options like `Redux`, `Hermes` and even `ngrx`.\n\n-We're using the `InMemory` cache, but there are several options like `Redux`, `Hermes`, `ngrx`...\n+- `apollo-cache-inmemory` is an official and recommended Apollo Cache.\n+\n+### Cache and Links\n+\n+These are two main parts of Apollo Stack, both are pluggable and customizable.\n+\n+- **Cache** is responsible for storing data and keeping it consistent.\n+- **Links** describe how to access the source of data (usually a GraphQL endpoint).\n+\n+Let's take a closer look on what cache means for Apollo, we're going to base it on the official `apollo-cache-inmemory`, one of many implementations.\n+\n+But first, imagine, we write our own amazing Apollo Cache implementation.\n+\n+```graphql\n+query getMessages {\n+  messages {\n+    id\n+    content\n+    likes\n+  }\n+}\n+```\n+\n+When we execute a query like one above what we get in return is an array of all messages of logged in user:\n+\n+```json\n+{\n+  \"data\": {\n+    \"messages\": [\n+      {\n+        \"id\": 0,\n+        \"content\": \"Hi\",\n+        \"likes\": 0\n+      },\n+      {\n+        \"id\": 1,\n+        \"content\": \"Hello\",\n+        \"likes\": 0\n+      }\n+    ]\n+  }\n+}\n+```\n+\n+Our cache stores the result in exact shape as above.\n+\n+Later on we add more queries and one of them returns a list of messages from one conversation.\n+\n+Now, a short story. We've got two users, Niccolo and Dotan.\n+\n+1. Niccolo opens the app and Apollo fetches all of his messages (I know, it's stupid but stay with me)\n+1. One message is to Dotan, Niccolo said \"Hi\" to him.\n+1. Now Dotan opens the app and reacts to the message with a like.\n+1. After few minutes Niccolo asks for messages from a conversation with Dotan.\n+1. Apollo fetches those messages and there is one in which Niccolo says \"Hi\" and it's liked by Dotan.\n+1. Now we have the same message twice, one has different state that the other, in one place there is no like, in other, we have +1.\n+\n+As you see, our cache is not smart enough to figure out one query might be a subset of another.\n+That's because it doesn't get enough informations.\n+\n+Let's go back to InMemoryCache and see how it describes itself:\n+\n+> Thanks to InMemoryCache, it's possible for the results of a query or mutation to update the UI in all the right places. In many cases it's possible for that to happen automatically, whereas in others you need to help the client out a little in doing so.\n+\n+It means it could solve the issue we have with duplicated messages with different state.\n+\n+It's very important to understand one concept that InMemoryCache is heavily based on, it's called normalization.\n+\n+The InMemoryCache splits the result into individual objects, creates a unique identifier for each of them and flattens everything up before saving it to the store.\n+Might seem complicated at first, but as InMemoryCache, let's break everything into smaller parts.\n+\n+First, \"breaking the result into pieces\" part. The InMemoryCache tells ApolloClient to add `__typename` field to your query before passing it to the server. I used server for simplicity, it actually passes it to Apollo Links and they are responsible to make a HTTP request. Every Apollo Cache is able to transform a document, that's as a side note.\n+\n+```graphql\n+query getMessages {\n+  messages {\n+    id\n+    content\n+    likes\n+    __typename\n+  }\n+}\n+```\n+\n+The `__typename` field tells about the type of the object. It's compatible with every GraphQL server as it's part of the specification.\n+\n+```graphql\n+type Message {\n+  id: ID\n+  content: String\n+  likes: Int\n+}\n+\n+type Query {\n+  messages: [Message]\n+}\n+```\n+\n+In our case, `__typename` returns `Message`. So now InMemoryCache knows that a message is a Message. Computers are stupid, we have to tell them everything!\n+\n+Next, let's take a look at \"creates a unique identifier\" part.\n+\n+The InMemoryCache iterates through every object and looks for the `__typename` and two fields, `id` and `_id` that usually are used as identifiers. Taking our example, it turns every Message object into `Message:1`, `Message:2`, `Message:3` and so on. You get the idea.\n+\n+It's the default behaviour but you can change it as you wish:\n+\n+```typescript\n+const cache = new InMemoryCache({\n+  dataIdFromObject(result) {\n+    if (result.__typename) {\n+      const id = result.uid || result.id || result._id;\n+\n+      if (id !== undefined) {\n+        return `${result.__typename}:${id}`;\n+      }\n+    }\n+    return null;\n+  },\n+});\n+```\n+\n+Great, we covered two out of three things InMemoryCache does. Now we're going to explore \"flattens everything up\".\n+\n+We're able to understand the type of each individual object and it's unique identifier. It still has to be stored.\n+\n+What InMemoryCache does is it's saves every element on root level in a plain object where the key contains a unique identifier and the value has a body.\n+\n+```json\n+{\n+  \"Message:1\": {\n+    \"id\": 1,\n+    \"content\": \"Hi\",\n+    \"likes\": 1,\n+    \"__typename\": \"Message\"\n+  },\n+  \"Message:2\": {\n+    \"id\": 2,\n+    \"content\": \"Hello\",\n+    \"likes\": 0,\n+    \"__typename\": \"Message\"\n+  },\n+  \"ROOT_QUERY\": {\n+    \"messages\": [\n+      {\n+        \"id\": \"Message:1\",\n+        \"typename\": \"Message\"\n+      },\n+      {\n+        \"id\": \"Message:2\",\n+        \"typename\": \"Message\"\n+      }\n+    ]\n+  }\n+}\n+```\n+\n+Wait, `ROOT_QUERY`? Yes, it has to somehow store the actual result of every executed query so next time you ask for the same thing, it matches it with the query in store and resolves right away.\n+\n+> You should be aware that the InMemoryCache stringifies variables of a query too, which means the same queries but with different variables are stored separately. Even the order of those variables matters.\n+\n+As you can see, each element in `ROOT_QUERY.message` is kind of a reference to a message record.\n+\n+Let's bring back our short story, a scenario.\n+When Niccolo asks for all messages, the whole three part process is started, each message is saved to the store.\n+When he asks for history of a conversation with Dotan, InMemoryCache starts the process again and if it sees that there is already a massage with the same unique identifier, it knows they both are the same so it merged them.\n+The InMemoryCache can tell what changed and emits the new object to the UI.\n+Thanks to that we no longer have the same message in two places where one has a like and other doesn't.\n+\n+Uff, Apollo Cache part is done. Thanks for being with us that long, I hope you didn't get bored because there's a lot ahead of us.\n+\n+Let's talk Apollo Link.\n+\n+As I mentioned it's kind of a network stack of Apollo. You execute a document with some metadata like variables or a context, Apollo Client receives it and passes it to the chain of Links.\n+\n+The ApolloLink is based on an Observable (not RxJS) and if you know `RxJS` you're familiar with `pipe`. Each Link is basically a function that receives a requested operation and a function that runs the next Link. Just like a pipe!\n+\n+```typescript\n+import { ApolloLink } from 'apollo-link';\n+\n+const log = new ApolloLink((operation, next) => {\n+  console.log('Name', operation.operationName);\n+  return next(operation);\n+});\n+```\n+\n+Now when we add it in `graphql.module.ts` we see the name of each requested operation.\n+\n+We can even intercept the result.\n+\n+```typescript\n+const intercept = new ApolloLink((operation, next) => {\n+    return forward(operation).map((data) => {\n+        // data from a previous link\n+        console.log('data', data);\n+        return data;\n+    });\n+});\n+```\n+\n+As you can see below, by network we don't always mean making HTTP requests. It could be Http Link at the end of Links chain or WebSocket Link or even something that works on in-memory data.\n+\n+```typescript\n+import { ApolloLink, Observable } from 'apollo-link';\n+\n+const inmemory = new ApolloLink(operation => {\n+    return Observable(observer => {\n+        // function that executes the operation and returns data\n+        const result = resolveOperation(operation);\n+\n+        observer.next(result);\n+        observer.complete();\n+    });\n+});\n+```\n+\n+You can find tons of helpful Links [on npm](https://www.npmjs.com/search?q=apollo-link-) and [on Apollo Link documentation](https://www.apollographql.com/docs/link/links/community.html).\n+\n+We highly recommend to take a look at Angular related Links [on Apollo Angular documentation](https://www.apollographql.com/docs/angular/guides/tools-and-packages.html).\n+\n+### GQL Tag\n\n The `gql` template tag is what you use to define GraphQL queries in your Apollo apps. It parses your GraphQL query into the `GraphQL.js AST format` which may then be consumed by Apollo methods. Whenever Apollo is asking for a GraphQL query you will always want to wrap it in a `gql` template tag.\n\n You can embed a GraphQL document containing only fragments inside of another GraphQL document using template string interpolation. This allows you to use fragments defined in one part of your codebase inside of a query defined in a completely different file.\n\n-{{{ diffStep \"1.2\" module=\"client\" files=\"src/graphql\" }}}\n+{{{ diffStep \"1.2\" module=\"client\" file=\"src/graphql/fragment.ts\" }}}\n+\n+### Use Apollo service\n\n Let's create a simple service to query the chats from our just created server:\n\n {{{ diffStep \"1.2\" module=\"client\" files=\"src/app/services\" }}}\n\n-We just learned how to use Apollo to attach GraphQL query results to the Angular UI. The `watchQuery` method returns a `QueryRef` object which has the `valueChanges` property that is an Observable.\n-That information is stored in Apollo Client’s global cache, so if some other query fetches new information about the chats, this component will update to remain consistent.\n-It’s also possible to fetch data only once. The query method of Apollo service returns an Observable that also resolves with the same result as above.\n+We just learned how to use Apollo to attach GraphQL query results to the Angular UI.\n+\n+The `watchQuery` method returns a `QueryRef` object which has the `valueChanges` property that is an `Observable`.\n+\n+Every fetched data is stored in Apollo Client’s cache, so if some other query fetches new information about the chats, this component will update to remain consistent.\n+\n+It’s also possible to fetch data only once. You simply use `query` method instead of `watchQuery`. The query method of Apollo service returns an Observable too that also resolves with the same result as above.\n\n #### But what is a `QueryRef`?\n\n-As you know, `Apollo.query` method returns an Observable that emits a result, just once, but `Apollo.watchQuery` also does the same except it passes multiple results.\n-So why `Apollo.watchQuery` can not expose an Observable?\n+As you know, `query` method returns an Observable that emits a result, just once, then the observable completes. `watchQuery` works a bit different. It fetches data then stays open and listens to the Cache for updates.\n+\n+So why `watchQuery` can not simply expose an Observable and it serves `QueryRef` instead?\n+\n+Because Apollo Angular is a bridge between Apollo Client (core library) and Angular framework it has to operate on RxJS based Observables. RxJS Observable has a simple API that cannot be easily extended and it's in general a bad practice.\n+\n+Why we're talking about those things? Apollo Client exposes an Observable that has bunch of custom method on it. They are super useful and their purpose is to talk to Apollo through them.\n\n-In `ApolloClient.watchQuery` returns an Observable, but not a standard one, it contains many useful methods (like `refetch()`) to manipulate the watched query.\n-A normal Observable, has only one method, `subscribe()`.\n+Since we have to turn Apollo's Observable to something that is compatible with RxJS we decided to expose an object that has all those methods and `valueChanges` property that is a regular RxJS Observable.\n\n-The API of `QueryRef` is very simple. It has the same methods as the Apollo’s Observable we talked about. To subscribe to query results you have to access `valueChanges` property which exposes a clean RxJS Observable.\n+#### Make our app pretty\n\n We will use Materials for the UI, so let's install it:\n\n@@ -123,8 +352,6 @@ Finally let's wire everything up to the main module:\n\n If you will try to run the frontend you will notice that several messages seems like duplicated, why does it happen?\n\n-`apollo-cache-inmemory` is the default cache implementation for Apollo Client 2.0. `InMemoryCache` is a normalized data store that supports all of Apollo Client 1.0's features without the dependency on Redux.\n-The `InMemoryCache` normalizes your data before saving it to the store by splitting the result into individual objects, creating a unique identifier for each object, and storing those objects in a flattened data structure. By default, `InMemoryCache` will attempt to use the commonly found primary keys of `id` and `_id` for the unique identifier if they exist along with `__typename` on an object.\n Since we use NoSQL-like structure in our backend, messages are stored as an array inside each chat so their incremental identifiers are not unique across different chats. We need to normalize them in a way that takes into account both the message id and the chat id:\n\n {{{ diffStep \"1.4\" module=\"client\" }}}\ndiff --git a/client/package.json b/client/package.json\nindex b2da7ed..7611682 100644\n--- a/client/package.json\n+++ b/client/package.json\n@@ -12,42 +12,42 @@\n   },\n   \"private\": true,\n   \"dependencies\": {\n-    \"@angular/animations\": \"6.0.0\",\n-    \"@angular/cdk\": \"6.0.1\",\n-    \"@angular/common\": \"6.0.0\",\n-    \"@angular/compiler\": \"6.0.0\",\n-    \"@angular/core\": \"6.0.0\",\n-    \"@angular/flex-layout\": \"6.0.0-beta.15\",\n-    \"@angular/forms\": \"6.0.0\",\n-    \"@angular/http\": \"6.0.0\",\n-    \"@angular/material\": \"6.0.1\",\n-    \"@angular/platform-browser\": \"6.0.0\",\n-    \"@angular/platform-browser-dynamic\": \"6.0.0\",\n-    \"@angular/router\": \"6.0.0\",\n-    \"apollo-angular\": \"1.1.0-rc.0\",\n-    \"apollo-angular-link-http\": \"1.1.0-rc.0\",\n-    \"apollo-cache-inmemory\": \"1.2.1\",\n-    \"apollo-client\": \"2.3.1\",\n-    \"apollo-link\": \"1.2.2\",\n-    \"apollo-link-ws\": \"1.0.8\",\n-    \"apollo-utilities\": \"1.0.12\",\n-    \"core-js\": \"2.5.6\",\n-    \"graphql\": \"0.13.2\",\n-    \"graphql-tag\": \"2.9.2\",\n+    \"@angular/animations\": \"6.1.9\",\n+    \"@angular/common\": \"6.1.9\",\n+    \"@angular/cdk\": \"6.4.7\",\n+    \"@angular/compiler\": \"6.1.9\",\n+    \"@angular/core\": \"6.1.9\",\n+    \"@angular/flex-layout\": \"6.0.0-beta.18\",\n+    \"@angular/forms\": \"6.1.9\",\n+    \"@angular/http\": \"6.1.9\",\n+    \"@angular/material\": \"6.4.7\",\n+    \"@angular/platform-browser\": \"6.1.9\",\n+    \"@angular/platform-browser-dynamic\": \"6.1.9\",\n+    \"@angular/router\": \"6.1.9\",\n+    \"apollo-angular\": \"1.4.1\",\n+    \"core-js\": \"2.5.7\",\n+    \"rxjs\": \"6.3.3\",\n+    \"zone.js\": \"0.8.26\",\n+    \"apollo-angular-link-http\": \"1.3.1\",\n+    \"apollo-link\": \"1.2.3\",\n+    \"apollo-link-ws\": \"1.0.9\",\n+    \"apollo-utilities\": \"1.0.21\",\n+    \"apollo-client\": \"2.4.2\",\n+    \"apollo-cache-inmemory\": \"1.3.2\",\n+    \"graphql-tag\": \"2.10.0\",\n+    \"graphql\": \"14.0.2\",\n     \"hammerjs\": \"2.0.8\",\n     \"moment\": \"2.22.1\",\n     \"ng2-truncate\": \"1.3.17\",\n-    \"ngx-selectable-list\": \"^1.2.1\",\n-    \"rxjs\": \"6.1.0\",\n-    \"subscriptions-transport-ws\": \"0.9.9\",\n-    \"zone.js\": \"0.8.26\"\n+    \"ngx-selectable-list\": \"1.2.1\",\n+    \"subscriptions-transport-ws\": \"0.9.15\"\n   },\n   \"devDependencies\": {\n-    \"@angular-devkit/build-angular\": \"0.6.0\",\n-    \"@angular/cli\": \"6.0.0\",\n-    \"@angular/compiler-cli\": \"6.0.0\",\n-    \"@angular/language-service\": \"6.0.0\",\n-    \"@types/graphql\": \"0.13.0\",\n+    \"@angular-devkit/build-angular\": \"0.8.4\",\n+    \"@angular/cli\": \"6.2.4\",\n+    \"@angular/compiler-cli\": \"6.1.9\",\n+    \"@types/graphql\": \"14.0.1\",\n+    \"@angular/language-service\": \"6.1.9\",\n     \"@types/jasmine\": \"2.8.7\",\n     \"@types/jasminewd2\": \"2.0.3\",\n     \"@types/node\": \"8.9.5\",\n@@ -64,6 +64,6 @@\n     \"protractor\": \"5.3.1\",\n     \"ts-node\": \"5.0.1\",\n     \"tslint\": \"5.9.1\",\n-    \"typescript\": \"2.7.2\"\n+    \"typescript\": \"2.9.2\"\n   }\n }\ndiff --git a/client/src/app/app.module.ts b/client/src/app/app.module.ts\nindex 356b000..2dfd310 100644\n--- a/client/src/app/app.module.ts\n+++ b/client/src/app/app.module.ts\n@@ -2,21 +2,14 @@ import { BrowserModule } from '@angular/platform-browser';\n import { NgModule } from '@angular/core';\n\n import { AppComponent } from './app.component';\n-import {HTTP_INTERCEPTORS, HttpClientModule} from '@angular/common/http';\n-import {HttpLink, HttpLinkModule, Options} from 'apollo-angular-link-http';\n-import {Apollo, ApolloModule} from 'apollo-angular';\n-import {defaultDataIdFromObject, InMemoryCache} from 'apollo-cache-inmemory';\n+import { HttpClientModule, HTTP_INTERCEPTORS } from '@angular/common/http';\n+import { GraphQLModule } from './graphql.module';\n import {ChatsListerModule} from './chats-lister/chats-lister.module';\n import {RouterModule, Routes} from '@angular/router';\n import {ChatViewerModule} from './chat-viewer/chat-viewer.module';\n import {ChatsCreationModule} from './chats-creation/chats-creation.module';\n import {LoginModule} from './login/login.module';\n import {AuthInterceptor} from './login/services/auth.interceptor';\n-import {getMainDefinition} from 'apollo-utilities';\n-import {OperationDefinitionNode} from 'graphql';\n-import {split} from 'apollo-link';\n-import {WebSocketLink} from 'apollo-link-ws';\n-import {LoginService} from './login/services/login.service';\n const routes: Routes = [];\n\n @NgModule({\n@@ -25,10 +18,8 @@ const routes: Routes = [];\n   ],\n   imports: [\n     BrowserModule,\n-    // Apollo\n-    ApolloModule,\n-    HttpLinkModule,\n     HttpClientModule,\n+    GraphQLModule,\n     // Routing\n     RouterModule.forRoot(routes),\n     // Feature modules\n@@ -46,42 +37,4 @@ const routes: Routes = [];\n   ],\n   bootstrap: [AppComponent]\n })\n-export class AppModule {\n-  constructor(\n-    apollo: Apollo,\n-    httpLink: HttpLink,\n-    loginService: LoginService,\n-  ) {\n-    const subscriptionLink = new WebSocketLink({\n-      uri:\n-        'ws://localhost:3000/subscriptions',\n-      options: {\n-        reconnect: true,\n-        connectionParams: () => ({\n-          authToken: loginService.getAuthHeader() || null\n-        })\n-      }\n-    });\n-\n-    const link = split(\n-      ({ query }) => {\n-        const { kind, operation } = <OperationDefinitionNode>getMainDefinition(<any>query);\n-        return kind === 'OperationDefinition' && operation === 'subscription';\n-      },\n-      subscriptionLink,\n-      httpLink.create(<Options>{uri: 'http://localhost:3000/graphql'})\n-    );\n-\n-    apollo.create({\n-      link,\n-      cache: new InMemoryCache({\n-        dataIdFromObject: (object: any) => {\n-          switch (object.__typename) {\n-            case 'Message': return `${object.chat.id}:${object.id}`; // use `chatId` prefix and `messageId` as the primary key\n-            default: return defaultDataIdFromObject(object); // fall back to default handling\n-          }\n-        }\n-      }),\n-    });\n-  }\n-}\n+export class AppModule {}\ndiff --git a/client/src/app/graphql.module.ts b/client/src/app/graphql.module.ts\nnew file mode 100644\nindex 0000000..d03e676\n--- /dev/null\n+++ b/client/src/app/graphql.module.ts\n@@ -0,0 +1,56 @@\n+import { NgModule} from '@angular/core';\n+import { ApolloModule, APOLLO_OPTIONS } from 'apollo-angular';\n+import { HttpLinkModule, HttpLink } from 'apollo-angular-link-http';\n+import { InMemoryCache, defaultDataIdFromObject } from 'apollo-cache-inmemory';\n+import {getMainDefinition} from 'apollo-utilities';\n+import {OperationDefinitionNode} from 'graphql';\n+import {split} from 'apollo-link';\n+import {WebSocketLink} from 'apollo-link-ws';\n+import {LoginService} from './login/services/login.service';\n+\n+const uri = 'http://localhost:3000/graphql';\n+\n+export function createApollo(httpLink: HttpLink, loginService: LoginService) {\n+  const subscriptionLink = new WebSocketLink({\n+    uri: uri.replace('http', 'ws'),\n+    options: {\n+      reconnect: true,\n+      connectionParams: () => ({\n+        authToken: loginService.getAuthHeader() || null\n+      })\n+    }\n+  });\n+\n+  const link = split(\n+    ({ query }) => {\n+      const { kind, operation } = getMainDefinition(query) as OperationDefinitionNode;\n+      return kind === 'OperationDefinition' && operation === 'subscription';\n+    },\n+    subscriptionLink,\n+    httpLink.create({uri})\n+  );\n+\n+  return {\n+    link,\n+    cache: new InMemoryCache({\n+      dataIdFromObject: (object: any) => {\n+        switch (object.__typename) {\n+          case 'Message': return `${object.chat.id}:${object.id}`; // use `chatId` prefix and `messageId` as the primary key\n+          default: return defaultDataIdFromObject(object); // fall back to default handling\n+        }\n+      }\n+    }),\n+  };\n+}\n+\n+@NgModule({\n+  exports: [ApolloModule, HttpLinkModule],\n+  providers: [\n+    {\n+      provide: APOLLO_OPTIONS,\n+      useFactory: createApollo,\n+      deps: [HttpLink, LoginService],\n+    },\n+  ],\n+})\n+export class GraphQLModule {}\ndiff --git a/server/index.ts b/server/index.ts\nindex 85fd2d3..5867d22 100644\n--- a/server/index.ts\n+++ b/server/index.ts\n@@ -4,13 +4,11 @@ import { schema } from \"./schema\";\n import * as bodyParser from \"body-parser\";\n import * as cors from 'cors';\n import * as express from 'express';\n-import { graphiqlExpress, graphqlExpress } from \"apollo-server-express\";\n+import { ApolloServer } from \"apollo-server-express\";\n import * as passport from \"passport\";\n import * as basicStrategy from 'passport-http';\n import * as bcrypt from 'bcrypt-nodejs';\n import { createServer } from \"http\";\n-import { SubscriptionServer } from \"subscriptions-transport-ws\";\n-import { execute, subscribe } from \"graphql\";\n import { createConnection } from \"typeorm\";\n import { User } from \"./entity/User\";\n import { addSampleData } from \"./db\";\n@@ -27,7 +25,7 @@ createConnection().then(async connection => {\n   //await addSampleData(connection);\n\n   passport.use('basic-signin', new basicStrategy.BasicStrategy(\n-    async function (username, password, done) {\n+    async function (username: string, password: string, done: any) {\n       const user = await connection.getRepository(User).findOne({where: { username }});\n       if (user && validPassword(password, user.password)) {\n         return done(null, user);\n@@ -37,7 +35,7 @@ createConnection().then(async connection => {\n   ));\n\n   passport.use('basic-signup', new basicStrategy.BasicStrategy({passReqToCallback: true},\n-    async function (req: any, username: any, password: any, done: any) {\n+    async function (req: any, username: string, password: string, done: any) {\n       const userExists = !!(await connection.getRepository(User).findOne({where: { username }}));\n       if (!userExists && password && req.body.name) {\n         const user = await connection.manager.save(new User({\n@@ -61,7 +59,7 @@ createConnection().then(async connection => {\n\n   app.post('/signup',\n     passport.authenticate('basic-signup', {session: false}),\n-    function (req, res) {\n+    function (req: any, res) {\n       if (req.user && req.user.id) {\n         // We want to return id as string\n         req.user.id = String(req.user.id);\n@@ -79,24 +77,15 @@ createConnection().then(async connection => {\n     res.json(req.user);\n   });\n\n-  app.use('/graphql', graphqlExpress(req => ({\n-    schema: schema,\n-    context: {\n-      user: req!['user'],\n-      connection,\n+  const apollo = new ApolloServer({\n+    schema,\n+    context(received: any) {\n+      return {\n+        user: received.connection ? received.connection.context.user : received.req!['user'],\n+        connection,\n+      }\n     },\n-  })));\n-\n-  app.use('/graphiql', graphiqlExpress({\n-    endpointURL: '/graphql',\n-  }));\n-\n-// Wrap the Express server\n-  const ws = createServer(app);\n-  ws.listen(PORT, () => {\n-    console.log(`Apollo Server is now running on http://localhost:${PORT}`);\n-    // Set up the WebSocket for handling GraphQL subscriptions\n-    new SubscriptionServer({\n+    subscriptions: {\n       onConnect: async (connectionParams: any, webSocket: any) => {\n         if (connectionParams.authToken) {\n           // Create a buffer and tell it the data coming in is base64\n@@ -108,20 +97,28 @@ createConnection().then(async connection => {\n\n             if (user && validPassword(password, user.password)) {\n               // Set context for the WebSocket\n-              return {user, connection};\n+              return {user};\n             } else {\n               throw new Error('Wrong credentials!');\n             }\n           }\n         }\n         throw new Error('Missing auth token!');\n-      },\n-      execute,\n-      subscribe,\n-      schema\n-    }, {\n-      server: ws,\n-      path: '/subscriptions',\n-    });\n+      }\n+    }\n+  });\n+\n+  apollo.applyMiddleware({\n+    app,\n+    path: '/graphql'\n+  });\n+\n+  // Wrap the Express server\n+  const ws = createServer(app);\n+\n+  apollo.installSubscriptionHandlers(ws);\n+\n+  ws.listen(PORT, () => {\n+    console.log(`Apollo Server is now running on http://localhost:${PORT}`);\n   });\n });\ndiff --git a/server/package.json b/server/package.json\nindex 1c38026..5db870d 100644\n--- a/server/package.json\n+++ b/server/package.json\n@@ -5,42 +5,38 @@\n   \"scripts\": {\n     \"start\": \"npm run build:live\",\n     \"build:live\": \"nodemon --exec ./node_modules/.bin/ts-node -- ./index.ts\",\n-    \"generator\": \"gql-gen --schema http://localhost:3000/graphql --template ts --out ./types.d.ts\"\n+    \"generator\": \"gql-gen -r ts-node/register —schema schema/typeDefs.ts --template ts --out ./types.d.ts\"\n   },\n   \"devDependencies\": {\n     \"@types/bcrypt-nodejs\": \"0.0.30\",\n     \"@types/body-parser\": \"1.17.0\",\n     \"@types/cors\": \"2.8.4\",\n-    \"@types/express\": \"4.11.1\",\n-    \"@types/graphql\": \"0.13.0\",\n+    \"@types/express\": \"4.16.0\",\n+    \"@types/graphql\": \"14.0.1\",\n     \"@types/graphql-iso-date\": \"3.3.0\",\n-    \"@types/node\": \"10.0.6\",\n+    \"@types/node\": \"10.11.3\",\n     \"@types/passport\": \"0.4.5\",\n     \"@types/passport-http\": \"0.3.6\",\n     \"@types/pg\": \"7.4.8\",\n-    \"@types/ws\": \"5.1.1\",\n-    \"nodemon\": \"1.17.4\",\n-    \"ts-node\": \"6.0.3\",\n-    \"typescript\": \"2.8.3\"\n+    \"nodemon\": \"1.18.4\",\n+    \"ts-node\": \"7.0.1\",\n+    \"typescript\": \"3.1.1\"\n   },\n   \"dependencies\": {\n-    \"apollo-server-express\": \"1.3.6\",\n+    \"apollo-server-express\": \"2.1.0\",\n     \"bcrypt-nodejs\": \"0.0.3\",\n     \"body-parser\": \"1.18.2\",\n     \"cors\": \"2.8.4\",\n     \"express\": \"4.16.3\",\n-    \"graphql\": \"0.13.2\",\n-    \"graphql-code-generator\": \"0.9.1\",\n-    \"graphql-codegen-typescript-template\": \"0.9.1\",\n+    \"graphql\": \"14.0.2\",\n+    \"graphql-code-generator\": \"0.12.6\",\n+    \"graphql-codegen-typescript-template\": \"0.12.6\",\n     \"graphql-iso-date\": \"3.5.0\",\n-    \"graphql-subscriptions\": \"0.5.8\",\n-    \"graphql-tools\": \"3.0.1\",\n     \"moment\": \"2.22.1\",\n     \"passport\": \"0.4.0\",\n     \"passport-http\": \"0.3.0\",\n     \"pg\": \"7.4.3\",\n     \"reflect-metadata\": \"0.1.12\",\n-    \"subscriptions-transport-ws\": \"0.9.9\",\n     \"typeorm\": \"0.2.5\"\n   }\n }\ndiff --git a/server/schema/index.ts b/server/schema/index.ts\nindex cedee02..a04c9af 100644\n--- a/server/schema/index.ts\n+++ b/server/schema/index.ts\n@@ -1,10 +1,8 @@\n-import { makeExecutableSchema } from 'graphql-tools';\n-import { typeDefs } from \"./typeDefs\";\n-import { resolvers } from \"./resolvers\";\n-import { IExecutableSchemaDefinition } from \"graphql-tools/dist/Interfaces\";\n-import { GraphQLSchema } from \"graphql\";\n+import { makeExecutableSchema } from 'apollo-server-express';\n+import typeDefs from './typeDefs';\n+import { resolvers } from './resolvers';\n\n-export const schema: GraphQLSchema = makeExecutableSchema(<IExecutableSchemaDefinition>{\n+export const schema = makeExecutableSchema({\n   typeDefs,\n   resolvers,\n-});\n\\ No newline at end of file\n+});\ndiff --git a/server/schema/resolvers.ts b/server/schema/resolvers.ts\nindex 077dc35..4453d1b 100644\n--- a/server/schema/resolvers.ts\n+++ b/server/schema/resolvers.ts\n@@ -1,11 +1,10 @@\n+import { PubSub, withFilter, IResolvers } from 'apollo-server-express';\n import { MessageType } from \"../db\";\n-import { IResolvers } from \"graphql-tools/dist/Interfaces\";\n import {\n   AddChatMutationArgs, AddGroupMutationArgs, AddMessageMutationArgs, ChatQueryArgs, MessageAddedSubscriptionArgs,\n   MessageFeedChatArgs, MessagesChatArgs, RemoveChatMutationArgs, RemoveMessagesMutationArgs\n } from \"../types\";\n import * as moment from \"moment\";\n-import { PubSub, withFilter } from \"graphql-subscriptions\";\n import { User } from \"../entity/User\";\n import { Chat } from \"../entity/Chat\";\n import { Message } from \"../entity/Message\";\ndiff --git a/server/schema/typeDefs.ts b/server/schema/typeDefs.ts\nindex 9753c74..ffaafe3 100644\n--- a/server/schema/typeDefs.ts\n+++ b/server/schema/typeDefs.ts\n@@ -1,6 +1,4 @@\n-import { ITypeDefinitions } from \"graphql-tools/dist/Interfaces\";\n-\n-export const typeDefs: ITypeDefinitions = `\n+export default `\n   scalar Date\n\n   type Query {\n",
        "manuals": [
          {
            "manualTitle": "A Whatsapp clone written with Angular, Material, Express, Postgresql and Apollo GraphQL.",
            "stepRevision": "56e3257d75fc18dd1850ba8a76ecdc46ad19f508",
            "manualView": "## Startup instructions\n\nThis project is made out of 2 sub-projects - the one is client and the other is server. We will go through the initialization for each of these individually. We will start with the server since the client is dependent on it.\n\n### Server\n\nFirst we need to clone the server project:\n\n    $ git clone git@github.com:Urigo/whatsapp-server-express.git\n\nThen we need to install the NPM dependencies:\n\n    $ npm install\n\nBefore starting the server make sure that postgresql is installed:\n\n    $ sudo apt-get update\n    $ sudo apt-get install postgresql postgresql-contrib\n\nSetup a user named \"test\" with no password by first switching into \"postgres\" account:\n\n    $ sudo -u postgres psql\n\nAnd running the following command:\n\n    postgres=# ALTER USER test WITH PASSWORD '';\n\nTry to run the server:\n\n    $ npm start\n\nIf logs show that connection refused, kill the process and set a random password for the \"test\" user (e.g. \"test\"):\n\n    postgres=# ALTER USER test WITH PASSWORD 'test';\n\nBe sure to set the password in the `ormconfig.json` as well:\n\n```js\n{\n  // ...\n  \"password\": \"test\",\n  // ...\n}\n```\n\nRun the start command again:\n\n    $ npm start\n\n### Client\n\n**Be sure to go through server initialization first**\n\nFirst we need to clone the server project:\n\n    $ git clone git@github.com:Urigo/whatsapp-client-angularcli-material.git\n\nThen we need to install the NPM dependencies:\n\n    $ npm install\n\nStart the app:\n\n    $ npm start"
          },
          {
            "manualTitle": "Step 1: Introduction",
            "stepRevision": "2437e47edf7c1f7530c8b6a38374120ad60b1287",
            "manualView": "# Step 1: How to build an app?\n\nSo you want to build an app!\nThe good news is, it’s not that difficult and after a while anyone can do it!\nAnother good news is that it’s a great skill to have, there is a lot of demand in the job market and you can get to be very creative. Also you can be part of basically any industry you can think of if you know how to program (Healthcare,\nbanking, education, defense, gaming, etc…).\n\nSoftware builds as layers on top of layers.  Every code you write is using code that others have written before already and you can just use it even without fully understanding it.\nThat’s what makes software advance so fast and makes the pace of progress increase as time goes by.\nAlso, most software today is written in an open and free way - everyone can share their code and use other people's code for free.  We even have a social network for that!  It’s called Github.\n\nOne way of learning how to build an app is to study software from the origins. How computers, operating systems and compilers work. It is very interesting but that also takes a long time.\nAnother way to learn how to create a new app is to start by first using all the code that has been already written out there and once we have a real world running app, go deeper to understand how it works from the inside.\n\nI’ll try to use the later approach because I think it is more fun and also it gives context when we will dive inside on how things work. Also it helps when we try to compare between different technologies that do the same thing (Angular vs.\nReact , etc…).\nThat’s because understanding the bigger picture is more important than knowing and remembering the details.\n\nYou noticed that the chapter started with a simple question.\nAll the lessons will start and include many of those questions.  Those are the questions you will need to Google.  The reason is that the most important skill a creator has today is to know how to search Google for the things they need. Most\nprogrammers, even the best ones, don’t remember anything, they just use Google for almost every line of code they write. So know that you don’t need to know it all, Google knows it all for you.\nThis tutorial might get outdated (it won't, hopefully!), but Google will always have the answers so it is more important to know to ask the right questions.\nIn my opinion the most important skill a programmer needs to have is patience and acceptance when something just doesn’t work, enjoy that feeling and start Googling around in order to learn new things and solve this new problem (this process of\nfeeling like you don’t know anything will happen 1000 times a day, also after 20 years of programming).\n\n## Planning the app: how to design an app?\n\nThe first and most important phase in the process is the beginning - designing the app, its parts, components and architecture, and how it all works together.\nFor this tutorial we will build a WhatsApp clone so we have the designs already prepared.\n\nThe process will looks like that:\n\n1. **Visually sketch the screens of the app**. We already know how WhatsApp looks so we’ll just copy it on pen and paper.\n2. **Break down to components**. The best way to describe the UI of apps is to break the UI into separate components and mix them up together. When breaking down to components we would need to think about the following steps:\n  * **Presentational components**: the small building blocks of the UI. For example input fields, images, text, buttons etc…\n  * **Layout**: how the components are positioned inside each other (talk about flex, grid and older layout types)\n  * **Styles**: colors, fonts etc… We might skip that part at the beginning because we can have a perfectly working app without it\n  * **Data dependencies**: the data that those components need - chats, messages, people etc… We will need to to do the following:\n    * Gather data for each component\n    * Attach all those dependencies into one schema\n    * Attach actions for each component\n    * Data updates: decide when the data should be updated in the view (ideally we shouldn’t have to say when but for technical and performance reasons it helps)\n3. **Routing flow**: Moving between screens, what are the different paths the user can navigate through our app\n\nOnce we will finish that process, you will have a big picture in your head (and on your paper) and implementing it with code will be much easier and more technical, meaning you won’t need to know a lot, just Google how to do each step...\n\nAnother interesting thing is, that implementing this same process can be done with a variety of different technologies, so this work will make sense whether you are using web with React or Angular, native apps, Windows UWP or any other\ntechnology for the UI and also relevant whether your data source is a Node, .NET or Ruby server with Mongo, Postgres or MySQL database (if all those words doesn’t mean anything for you, don’t worry, those are just different names to very similar\nideas and we will learn all of them later on and of course you can always just Google them).\n\nHead over to the next chapter to start planning."
          },
          {
            "manualTitle": "Step 2: Planning process",
            "stepRevision": "e59198836c58fead22e1226d1556f7f70003af47",
            "manualView": "## Visual sketch\nWell, not a lot to say about that: just draw your app on paper.\nDoesn’t matter if you don’t know how to draw, it’s just squares and circles.\n\n![alt text](../../assets/chats.png \"Chats\")\n![alt text](../../assets/chat.png \"Chat\")\n![alt text](../../assets/new_chat.png \"New chat\")\n![alt text](../../assets/new_group.png \"New group\")\n![alt text](../../assets/new_group_details.png \"New group details\")\n\n## Breaking down to components\n### -> Google Search\nThis part is a bit more tricky, but after a few examples you’ll get the hang of it.\n\nDraw boxes around every component and subcomponent in different colors and name each one.\nBut how do you know what should be its own component?\nJust follow the **single responsibility principle**, that is, a component should ideally only do one thing. If it ends up growing, it should be decomposed into smaller subcomponents.\n\n![alt text](../../assets/chats_components.png \"Chats components\")\n![alt text](../../assets/chat_components.png \"Chat components\")\n![alt text](../../assets/new_chat_components.png \"New chat components\")\n![alt text](../../assets/new_group_components.png \"New group components\")\n![alt text](../../assets/new_group_details_components.png \"New group details components\")\n\n  * Chats Component\n  * Header Component\n  * ChatsList Component\n  * ChatItem Component\n  * Chat Component\n  * MessagesList Component\n  * MessageItem Component\n  * NewMessage Component\n  * NewChat Component\n  * UsersList Component\n  * UserItem Component\n  * NewGroup Component\n  * NewGroupDetails Component\n\nNow let’s organize them in hierarchy:\n* Chats\n  * Header\n  * ChatsList\n    * ChatItem\n* Chat\n  * Header\n  * MessagesList\n    * MessageItem\n  * NewMessage\n* NewChat\n  * Header\n  * UsersList\n    * UserItem\n* NewGroup\n  * Header\n  * UsersList\n    * UserItem\n  * NewGroupDetails\n\n## Layout\n### -> Google Search\nNow let’s describe how the components are placed within each other.\nThere are infinite ways to explain how components sits inside of each other.\nAny approach has its benefits and limitations.\nWe are going to use one pattern that is pretty common, simple and also covers many types of UI structures.\nUsing that pattern we will keep us covered for a long while (until you would want to create a computer game or a graph. then you’ll need to expand your horizons).\nThis pattern is called flexbox.\n\nIn Flexbox we can separate the alignment in two ways:\nContainer (parent) component behaviour\nChild component behaviour inside the container\n\nWhen describing the parent, we have 3 main properties:\n* Flex-Flow: it's a shorthand for flex-direction and flex-wrap and lets you control the direction in which the items are displayed and whether or not they can wrap onto the next line. There are four possible settings, each of them in the wrap or\nnowrap variant:\n  * row `[wrap, nowrap]`\n  * row-reverse `[wrap, nowrap]`\n  * column `[wrap, nowrap]` - this is the normal way a group of divs would be displayed, so you might not use this often\n  * column-reverse `[wrap, nowrap]`\n* Justify-content: determines where a browser should place the flex items within the row. It works only if the flex items have set widths and if the total width of the items is less than the flex container. There are five possible settings:\n  * Flex-start - squash them to the left\n  * Center - Squash them to the center\n  * Flex-end - squash them to the right\n  * Space-around - squash them away from each other and the ends. Place as much space as possible between all elements\n  * Space-between - Squash the sides to the ends and place as much space between the rest of the elements as possible\n* alignItems: Same as justifyContent but on the secondary axis\n  * Flex-start - squash them to the left\n  * Center - Squash them to the center\n  * Flex-end - squash them to the right\n  * Space-around - squash them away from each other and the ends. Place as much space as possible between all elements\n  * Space-between - Squash the sides to the ends and place as much space between the rest of the elements as possible\n\nThe easiest way to explain that is by showing live examples:\n[awaiting for McFarland's permission to share his pictures]\n\n## Data dependencies\n### -> Google Search\nOur app needs to display data. Otherwise it will be just a nice moving set of pictures…\nSo let’s see what data each component needs and create a descriptions of all the data in our app.\n\nLet’s start with the chats list component:\n\n* Chats: Chats, Users, Messages\n  * Header\n  * ChatsList: Chats, Users, Messages\n    * ChatItem: Chats`[chatId]`, Users`[UserId]`, Message`[messageId]`\n\nWe need to have some basic information about the chats we are part of, like the chat id, the user id and the latest message content.\nThat means we will have to query for all the chats who we are part of, then look at the user IDs and query for those users to retrieve the name. Finally we need to query for the last message of each chat.\n\nNow let’s talk about the chat component (after clicking the single chat app).\nWe need a list of all the messages inside the chat, along with some info about the user or chat on the top corner:\n\n* Chat: Chat, User, Messages\n  * Header: User.name || Chat.name (Because we can have multiple participant could differ from the other person’s name)\n  * MessagesList: Messages\n    * MessageItem: Messages`[ID]`\n  * NewMessage\n\nThe NewChat and NewGroup components will need just some basic info about the user:\n\n* NewChat: Users\n  * Header\n  * UsersList: Users\n    * UserItem: Users`[ID]`\n\n* NewGroup: Users\n  * Header\n  * UsersList: Users\n    * UserItem: Users`[ID]`\n  * NewGroupDetails\n\n## Actions\n### -> Google Search\nBut components can also do thing beyond just displaying data.\nLet’s write all the actions each component can do.\n  * Chats list\n    * tap -> go to chat page\n    * press -> enable selection of multiple chats, confirming the selection will delete them\n  * Single Chat\n    * tap -> send the message\n    * press -> enable selection of multiple messages, confirming the selection will delete them\n  * New Chat\n    * tap -> create new chat or go to the NewGroup component\n  * New Group\n    * tap -> go to NewGroupDetails, then create the group\n\n## Communications\n### -> Google Search\nLet’s define when do we need to get the data from our data source.\nSounds easy but there are a few tricky pitfalls. (query and subscriptions).\nWe will start by simply requesting the data when we first start the component, later on we will tackle subscriptions.\n\n## UI flow\n### -> Google Search\nLet’s draw a diagram of how the user can navigate our app.\n  * Open the app ->\n    * Chats list ->\n      * Click on chat ->\n        * Specific chat page\n          * Click back ->\n            * Chat page\n    * Click on '+' ->\n      * NewChat page ->\n        * Click on user ->\n          * Chat page\n        * Click back ->\n          * Chats list\n        * Click on 'New Group' ->\n          * New Group page\n            * Multiple selection and subsequent confirmation ->\n              * NewGroupDetails page\n                * Insert name and click on confirm ->\n                  * Chat page\n              * Click back ->\n                * New Group page\n          * Click back ->\n            * New Group page\n\nNow let’s look at the whole diagram we created.\nThat basically describes all of our app.\nIf computers were smart enough to understand english and drawings, we would have an app by now.\nBut programming languages are very similar to regular languages so we now just need to translate this into any programming language, just choose a tool and start filling in the gaps.\n\nNext chapter will be about Scaffolding which will tell us the structure to put our code into.\nJust like our sketch has defined parts, we would do the same just with folders and files."
          },
          {
            "manualTitle": "Step 3: Scaffolding",
            "stepRevision": "5bed487598e50759764f608eb4ca3b347c4d6ac5",
            "manualView": "Now we can start writing code!\n\nBut like we said before, software is build in layers and instead of starting from nothing, we can use existing software with prepared structure.\n\n## Tools\n\nFirst let’s install some software that we need on our computer:\n\n### Windows\n\nThe following instructions are for computers with the Windows operating system.\n\nFirst let's start by installing node.js. You need to download an installer, by visiting:\n\n    https://nodejs.org/en/download/\n\nSame, with Yarn:\n\n    https://yarnpkg.com/en/docs/install#windows-stable\n\n\n### Linux\n\nThe following instructions are for computers with the Arch Linux operating system, so your mileage may vary.\n\nFirst let's start by installing npm and node.js, as simple as\n\n    # NodeJS\n    pacman -S nodejs npm\n\n    # Yarn\n    pacman -S yarn\n\n\n### MacOS\n\nThe following instructions are for computers with the MacOS operating system:\n\n    # NodeJS\n    brew install node\n\n    # Yarn\n    brew install yarn --without-node\n\n\n## Packages\n\nThen we will need a way to install our npm global packages on a per-user basis, instead of relying on sudo: https://github.com/sindresorhus/guides/blob/master/npm-global-without-sudo.md\n\nNow it's the right moment to install a couple of global packages we will need later on:\n\n    yarn global add @angular/cli node-sass tortilla typescript\n\n\n## IDE\n\nNow it's time to choose our IDE. I suggest you VSCode, it's available for free: https://code.visualstudio.com/.\nTo have a look at some of the VSCode features you can have a look at the documentation: https://code.visualstudio.com/docs.\n\nVSCode team prepared an Interactive Playground where you can learn what the editor is cappable of and play with it. I highly recommend to check it out!\n\n    Toolbar: Help > Interactive Playground\n\nThere are also many IDEs to recommend and at the end the choice is yours.\n\n## Mobile\n\nWe will talk once again about scaffolding once we will introduce `Android` and `Cordova`."
          },
          {
            "manualTitle": "Step 4: Debugging",
            "stepRevision": "55bc04cf5573341cce8cdfe5fea67fb603e3a74f",
            "manualView": "Before we start writing code, it is important that we learn how to check our code.\n\nThe computer runs through everything we write in split second but we can still pause the computer and go through step by step, check what actually happens when the computer runs our code instructions.\n\nThis phase is sometimes being skipped by developers but trust me, you never want to skip this phase and you should always be super comfortable in debugging your code on whatever environment it’s running on.\n\nThe easiest way to debug your Javascript application is right into your editor:\n  * https://code.visualstudio.com/docs/introvideos/debugging\n  * https://www.jetbrains.com/help/webstorm/debugging-javascript-in-chrome.html\n  * https://blog.jetbrains.com/webstorm/2017/01/debugging-angular-apps/\n\nLater on we will learn how to debug mobile applications."
          },
          {
            "manualTitle": "Step 5: Chats listing",
            "stepRevision": "665d3c8014800890c694d121848b3448cd6335ec",
            "manualView": "![chats-list](https://user-images.githubusercontent.com/7648874/49271096-36bef480-f4a7-11e8-87a9-c9f203f20f6a.png)\n\n## Server\n\nAfter the planning phase it's finally time to start writing some real code!\nWe'll start with the server, so let's install a couple of packages first:\n\n    yarn add apollo-server-express body-parser cors express graphql\n    yarn add -D @types/body-parser @types/cors @types/express @types/graphql\n\nExpress is a fast, unopinionated, minimalist web framework for node.\nCross-Origin Resource Sharing (CORS) is a mechanism that uses additional HTTP headers to let a user agent gain permission to access selected resources from a server on a different origin (domain) than the site currently in use. A user agent makes a cross-origin HTTP request when it requests a resource from a different domain, protocol, or port than the one from which the current document originated.\nWe will need CORS because Webpack's development server used in the client will make use of a different port than the Express server, thus configuring a different origin.\nGraphQL is a query language for APIs and a runtime for fulfilling those queries with your existing data. GraphQL provides a complete and understandable description of the data in your API, gives clients the power to ask for exactly what they need and nothing more, makes it easier to evolve APIs over time, and enables powerful developer tools.\nApollo Server is a community-maintained open-source GraphQL server. It works with pretty much all Node.js HTTP server frameworks. Apollo Server works with any GraphQL schema built with GraphQL.js or with a convenience library such as graphql-tools.\n\nThe GraphQL query language is basically about selecting fields on objects. Because the shape of a GraphQL query closely matches the result, you can predict what the query will return without knowing that much about the server. But it's useful to have an exact description of the data we can ask for - what fields can we select? What kinds of objects might they return? What fields are available on those sub-objects? That's where the schema comes in.\nEvery GraphQL service defines a set of types which completely describe the set of possible data you can query on that service. Then, when queries come in, they are validated and executed against that schema.\n\nFor the moment let's create some empty schemas and resolvers:\n\n[{]: <helper> (diffStep \"1.1\" files=\"schema/*\" module=\"server\")\n\n#### [Step 1.1: Create empty Apollo server](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/1ac723e)\n\n##### Added schema&#x2F;index.ts\n```diff\n@@ -0,0 +1,8 @@\n+┊ ┊1┊import { makeExecutableSchema } from 'apollo-server-express';\n+┊ ┊2┊import typeDefs from './typeDefs';\n+┊ ┊3┊import { resolvers } from './resolvers';\n+┊ ┊4┊\n+┊ ┊5┊export const schema = makeExecutableSchema({\n+┊ ┊6┊  typeDefs,\n+┊ ┊7┊  resolvers,\n+┊ ┊8┊});\n```\n\n##### Added schema&#x2F;resolvers.ts\n```diff\n@@ -0,0 +1,5 @@\n+┊ ┊1┊import { IResolvers } from 'apollo-server-express';\n+┊ ┊2┊\n+┊ ┊3┊export const resolvers: IResolvers = {\n+┊ ┊4┊  Query: {},\n+┊ ┊5┊};\n```\n\n##### Added schema&#x2F;typeDefs.ts\n```diff\n@@ -0,0 +1,2 @@\n+┊ ┊1┊export default `\n+┊ ┊2┊`;\n```\n\n[}]: #\n\nTime to create our index:\n\n[{]: <helper> (diffStep \"1.1\" files=\"^index.ts\" module=\"server\")\n\n#### [Step 1.1: Create empty Apollo server](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/1ac723e)\n\n##### Added index.ts\n```diff\n@@ -0,0 +1,23 @@\n+┊  ┊ 1┊import { schema } from \"./schema\";\n+┊  ┊ 2┊import * as bodyParser from \"body-parser\";\n+┊  ┊ 3┊import * as cors from 'cors';\n+┊  ┊ 4┊import * as express from 'express';\n+┊  ┊ 5┊import { ApolloServer } from \"apollo-server-express\";\n+┊  ┊ 6┊\n+┊  ┊ 7┊const PORT = 3000;\n+┊  ┊ 8┊\n+┊  ┊ 9┊const app = express();\n+┊  ┊10┊\n+┊  ┊11┊app.use(cors());\n+┊  ┊12┊app.use(bodyParser.json());\n+┊  ┊13┊\n+┊  ┊14┊const apollo = new ApolloServer({\n+┊  ┊15┊  schema\n+┊  ┊16┊});\n+┊  ┊17┊\n+┊  ┊18┊apollo.applyMiddleware({\n+┊  ┊19┊  app,\n+┊  ┊20┊  path: '/graphql'\n+┊  ┊21┊});\n+┊  ┊22┊\n+┊  ┊23┊app.listen(PORT);\n```\n\n[}]: #\n\nNow we want to feed our graphql server with some data. Soon we will need `moment`, so let's install it:\n\n    yarn add moment\n\nNow we can create a fake db:\n\n[{]: <helper> (diffStep \"1.2\" files=\"db.ts\" module=\"server\")\n\n#### [Step 1.2: Add fake db](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/a168978)\n\n##### Added db.ts\n```diff\n@@ -0,0 +1,438 @@\n+┊   ┊  1┊import * as moment from 'moment';\n+┊   ┊  2┊\n+┊   ┊  3┊export enum MessageType {\n+┊   ┊  4┊  PICTURE,\n+┊   ┊  5┊  TEXT,\n+┊   ┊  6┊  LOCATION,\n+┊   ┊  7┊}\n+┊   ┊  8┊\n+┊   ┊  9┊export interface User {\n+┊   ┊ 10┊  id: number,\n+┊   ┊ 11┊  username: string,\n+┊   ┊ 12┊  password: string,\n+┊   ┊ 13┊  name: string,\n+┊   ┊ 14┊  picture?: string | null,\n+┊   ┊ 15┊  phone?: string | null,\n+┊   ┊ 16┊}\n+┊   ┊ 17┊\n+┊   ┊ 18┊export interface Chat {\n+┊   ┊ 19┊  id: number,\n+┊   ┊ 20┊  name?: string | null,\n+┊   ┊ 21┊  picture?: string | null,\n+┊   ┊ 22┊  // All members, current and past ones.\n+┊   ┊ 23┊  allTimeMemberIds: number[],\n+┊   ┊ 24┊  // Whoever gets the chat listed. For groups includes past members who still didn't delete the group.\n+┊   ┊ 25┊  listingMemberIds: number[],\n+┊   ┊ 26┊  // Actual members of the group (they are not the only ones who get the group listed). Null for chats.\n+┊   ┊ 27┊  actualGroupMemberIds?: number[] | null,\n+┊   ┊ 28┊  adminIds?: number[] | null,\n+┊   ┊ 29┊  ownerId?: number | null,\n+┊   ┊ 30┊  messages: Message[],\n+┊   ┊ 31┊}\n+┊   ┊ 32┊\n+┊   ┊ 33┊export interface Message {\n+┊   ┊ 34┊  id: number,\n+┊   ┊ 35┊  chatId: number,\n+┊   ┊ 36┊  senderId: number,\n+┊   ┊ 37┊  content: string,\n+┊   ┊ 38┊  createdAt: number,\n+┊   ┊ 39┊  type: MessageType,\n+┊   ┊ 40┊  recipients: Recipient[],\n+┊   ┊ 41┊  holderIds: number[],\n+┊   ┊ 42┊}\n+┊   ┊ 43┊\n+┊   ┊ 44┊export interface Recipient {\n+┊   ┊ 45┊  userId: number,\n+┊   ┊ 46┊  messageId: number,\n+┊   ┊ 47┊  chatId: number,\n+┊   ┊ 48┊  receivedAt: number | null,\n+┊   ┊ 49┊  readAt: number | null,\n+┊   ┊ 50┊}\n+┊   ┊ 51┊\n+┊   ┊ 52┊const users: User[] = [\n+┊   ┊ 53┊  {\n+┊   ┊ 54┊    id: 1,\n+┊   ┊ 55┊    username: 'ethan',\n+┊   ┊ 56┊    password: '$2a$08$NO9tkFLCoSqX1c5wk3s7z.JfxaVMKA.m7zUDdDwEquo4rvzimQeJm', // 111\n+┊   ┊ 57┊    name: 'Ethan Gonzalez',\n+┊   ┊ 58┊    picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n+┊   ┊ 59┊    phone: '+391234567890',\n+┊   ┊ 60┊  },\n+┊   ┊ 61┊  {\n+┊   ┊ 62┊    id: 2,\n+┊   ┊ 63┊    username: 'bryan',\n+┊   ┊ 64┊    password: '$2a$08$xE4FuCi/ifxjL2S8CzKAmuKLwv18ktksSN.F3XYEnpmcKtpbpeZgO', // 222\n+┊   ┊ 65┊    name: 'Bryan Wallace',\n+┊   ┊ 66┊    picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n+┊   ┊ 67┊    phone: '+391234567891',\n+┊   ┊ 68┊  },\n+┊   ┊ 69┊  {\n+┊   ┊ 70┊    id: 3,\n+┊   ┊ 71┊    username: 'avery',\n+┊   ┊ 72┊    password: '$2a$08$UHgH7J8G6z1mGQn2qx2kdeWv0jvgHItyAsL9hpEUI3KJmhVW5Q1d.', // 333\n+┊   ┊ 73┊    name: 'Avery Stewart',\n+┊   ┊ 74┊    picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n+┊   ┊ 75┊    phone: '+391234567892',\n+┊   ┊ 76┊  },\n+┊   ┊ 77┊  {\n+┊   ┊ 78┊    id: 4,\n+┊   ┊ 79┊    username: 'katie',\n+┊   ┊ 80┊    password: '$2a$08$wR1k5Q3T9FC7fUgB7Gdb9Os/GV7dGBBf4PLlWT7HERMFhmFDt47xi', // 444\n+┊   ┊ 81┊    name: 'Katie Peterson',\n+┊   ┊ 82┊    picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n+┊   ┊ 83┊    phone: '+391234567893',\n+┊   ┊ 84┊  },\n+┊   ┊ 85┊  {\n+┊   ┊ 86┊    id: 5,\n+┊   ┊ 87┊    username: 'ray',\n+┊   ┊ 88┊    password: '$2a$08$6.mbXqsDX82ZZ7q5d8Osb..JrGSsNp4R3IKj7mxgF6YGT0OmMw242', // 555\n+┊   ┊ 89┊    name: 'Ray Edwards',\n+┊   ┊ 90┊    picture: 'https://randomuser.me/api/portraits/thumb/men/3.jpg',\n+┊   ┊ 91┊    phone: '+391234567894',\n+┊   ┊ 92┊  },\n+┊   ┊ 93┊  {\n+┊   ┊ 94┊    id: 6,\n+┊   ┊ 95┊    username: 'niko',\n+┊   ┊ 96┊    password: '$2a$08$fL5lZR.Rwf9FWWe8XwwlceiPBBim8n9aFtaem.INQhiKT4.Ux3Uq.', // 666\n+┊   ┊ 97┊    name: 'Niccolò Belli',\n+┊   ┊ 98┊    picture: 'https://randomuser.me/api/portraits/thumb/men/4.jpg',\n+┊   ┊ 99┊    phone: '+391234567895',\n+┊   ┊100┊  },\n+┊   ┊101┊  {\n+┊   ┊102┊    id: 7,\n+┊   ┊103┊    username: 'mario',\n+┊   ┊104┊    password: '$2a$08$nDHDmWcVxDnH5DDT3HMMC.psqcnu6wBiOgkmJUy9IH..qxa3R6YrO', // 777\n+┊   ┊105┊    name: 'Mario Rossi',\n+┊   ┊106┊    picture: 'https://randomuser.me/api/portraits/thumb/men/5.jpg',\n+┊   ┊107┊    phone: '+391234567896',\n+┊   ┊108┊  },\n+┊   ┊109┊];\n+┊   ┊110┊\n+┊   ┊111┊const chats: Chat[] = [\n+┊   ┊112┊  {\n+┊   ┊113┊    id: 1,\n+┊   ┊114┊    name: null,\n+┊   ┊115┊    picture: null,\n+┊   ┊116┊    allTimeMemberIds: [1, 3],\n+┊   ┊117┊    listingMemberIds: [1, 3],\n+┊   ┊118┊    adminIds: null,\n+┊   ┊119┊    ownerId: null,\n+┊   ┊120┊    messages: [\n+┊   ┊121┊      {\n+┊   ┊122┊        id: 1,\n+┊   ┊123┊        chatId: 1,\n+┊   ┊124┊        senderId: 1,\n+┊   ┊125┊        content: 'You on your way?',\n+┊   ┊126┊        createdAt: moment().subtract(1, 'hours').unix(),\n+┊   ┊127┊        type: MessageType.TEXT,\n+┊   ┊128┊        recipients: [\n+┊   ┊129┊          {\n+┊   ┊130┊            userId: 3,\n+┊   ┊131┊            messageId: 1,\n+┊   ┊132┊            chatId: 1,\n+┊   ┊133┊            receivedAt: null,\n+┊   ┊134┊            readAt: null,\n+┊   ┊135┊          },\n+┊   ┊136┊        ],\n+┊   ┊137┊        holderIds: [1, 3],\n+┊   ┊138┊      },\n+┊   ┊139┊      {\n+┊   ┊140┊        id: 2,\n+┊   ┊141┊        chatId: 1,\n+┊   ┊142┊        senderId: 3,\n+┊   ┊143┊        content: 'Yep!',\n+┊   ┊144┊        createdAt: moment().subtract(1, 'hours').add(5, 'minutes').unix(),\n+┊   ┊145┊        type: MessageType.TEXT,\n+┊   ┊146┊        recipients: [\n+┊   ┊147┊          {\n+┊   ┊148┊            userId: 1,\n+┊   ┊149┊            messageId: 2,\n+┊   ┊150┊            chatId: 1,\n+┊   ┊151┊            receivedAt: null,\n+┊   ┊152┊            readAt: null,\n+┊   ┊153┊          },\n+┊   ┊154┊        ],\n+┊   ┊155┊        holderIds: [3, 1],\n+┊   ┊156┊      },\n+┊   ┊157┊    ],\n+┊   ┊158┊  },\n+┊   ┊159┊  {\n+┊   ┊160┊    id: 2,\n+┊   ┊161┊    name: null,\n+┊   ┊162┊    picture: null,\n+┊   ┊163┊    allTimeMemberIds: [1, 4],\n+┊   ┊164┊    listingMemberIds: [1, 4],\n+┊   ┊165┊    adminIds: null,\n+┊   ┊166┊    ownerId: null,\n+┊   ┊167┊    messages: [\n+┊   ┊168┊      {\n+┊   ┊169┊        id: 1,\n+┊   ┊170┊        chatId: 2,\n+┊   ┊171┊        senderId: 1,\n+┊   ┊172┊        content: 'Hey, it\\'s me',\n+┊   ┊173┊        createdAt: moment().subtract(2, 'hours').unix(),\n+┊   ┊174┊        type: MessageType.TEXT,\n+┊   ┊175┊        recipients: [\n+┊   ┊176┊          {\n+┊   ┊177┊            userId: 4,\n+┊   ┊178┊            messageId: 1,\n+┊   ┊179┊            chatId: 2,\n+┊   ┊180┊            receivedAt: null,\n+┊   ┊181┊            readAt: null,\n+┊   ┊182┊          },\n+┊   ┊183┊        ],\n+┊   ┊184┊        holderIds: [1, 4],\n+┊   ┊185┊      },\n+┊   ┊186┊    ],\n+┊   ┊187┊  },\n+┊   ┊188┊  {\n+┊   ┊189┊    id: 3,\n+┊   ┊190┊    name: null,\n+┊   ┊191┊    picture: null,\n+┊   ┊192┊    allTimeMemberIds: [1, 5],\n+┊   ┊193┊    listingMemberIds: [1, 5],\n+┊   ┊194┊    adminIds: null,\n+┊   ┊195┊    ownerId: null,\n+┊   ┊196┊    messages: [\n+┊   ┊197┊      {\n+┊   ┊198┊        id: 1,\n+┊   ┊199┊        chatId: 3,\n+┊   ┊200┊        senderId: 1,\n+┊   ┊201┊        content: 'I should buy a boat',\n+┊   ┊202┊        createdAt: moment().subtract(1, 'days').unix(),\n+┊   ┊203┊        type: MessageType.TEXT,\n+┊   ┊204┊        recipients: [\n+┊   ┊205┊          {\n+┊   ┊206┊            userId: 5,\n+┊   ┊207┊            messageId: 1,\n+┊   ┊208┊            chatId: 3,\n+┊   ┊209┊            receivedAt: null,\n+┊   ┊210┊            readAt: null,\n+┊   ┊211┊          },\n+┊   ┊212┊        ],\n+┊   ┊213┊        holderIds: [1, 5],\n+┊   ┊214┊      },\n+┊   ┊215┊      {\n+┊   ┊216┊        id: 2,\n+┊   ┊217┊        chatId: 3,\n+┊   ┊218┊        senderId: 1,\n+┊   ┊219┊        content: 'You still there?',\n+┊   ┊220┊        createdAt: moment().subtract(1, 'days').add(16, 'hours').unix(),\n+┊   ┊221┊        type: MessageType.TEXT,\n+┊   ┊222┊        recipients: [\n+┊   ┊223┊          {\n+┊   ┊224┊            userId: 5,\n+┊   ┊225┊            messageId: 2,\n+┊   ┊226┊            chatId: 3,\n+┊   ┊227┊            receivedAt: null,\n+┊   ┊228┊            readAt: null,\n+┊   ┊229┊          },\n+┊   ┊230┊        ],\n+┊   ┊231┊        holderIds: [1, 5],\n+┊   ┊232┊      },\n+┊   ┊233┊    ],\n+┊   ┊234┊  },\n+┊   ┊235┊  {\n+┊   ┊236┊    id: 4,\n+┊   ┊237┊    name: null,\n+┊   ┊238┊    picture: null,\n+┊   ┊239┊    allTimeMemberIds: [3, 4],\n+┊   ┊240┊    listingMemberIds: [3, 4],\n+┊   ┊241┊    adminIds: null,\n+┊   ┊242┊    ownerId: null,\n+┊   ┊243┊    messages: [\n+┊   ┊244┊      {\n+┊   ┊245┊        id: 1,\n+┊   ┊246┊        chatId: 4,\n+┊   ┊247┊        senderId: 3,\n+┊   ┊248┊        content: 'Look at my mukluks!',\n+┊   ┊249┊        createdAt: moment().subtract(4, 'days').unix(),\n+┊   ┊250┊        type: MessageType.TEXT,\n+┊   ┊251┊        recipients: [\n+┊   ┊252┊          {\n+┊   ┊253┊            userId: 4,\n+┊   ┊254┊            messageId: 1,\n+┊   ┊255┊            chatId: 4,\n+┊   ┊256┊            receivedAt: null,\n+┊   ┊257┊            readAt: null,\n+┊   ┊258┊          },\n+┊   ┊259┊        ],\n+┊   ┊260┊        holderIds: [3, 4],\n+┊   ┊261┊      },\n+┊   ┊262┊    ],\n+┊   ┊263┊  },\n+┊   ┊264┊  {\n+┊   ┊265┊    id: 5,\n+┊   ┊266┊    name: null,\n+┊   ┊267┊    picture: null,\n+┊   ┊268┊    allTimeMemberIds: [2, 5],\n+┊   ┊269┊    listingMemberIds: [2, 5],\n+┊   ┊270┊    adminIds: null,\n+┊   ┊271┊    ownerId: null,\n+┊   ┊272┊    messages: [\n+┊   ┊273┊      {\n+┊   ┊274┊        id: 1,\n+┊   ┊275┊        chatId: 5,\n+┊   ┊276┊        senderId: 2,\n+┊   ┊277┊        content: 'This is wicked good ice cream.',\n+┊   ┊278┊        createdAt: moment().subtract(2, 'weeks').unix(),\n+┊   ┊279┊        type: MessageType.TEXT,\n+┊   ┊280┊        recipients: [\n+┊   ┊281┊          {\n+┊   ┊282┊            userId: 5,\n+┊   ┊283┊            messageId: 1,\n+┊   ┊284┊            chatId: 5,\n+┊   ┊285┊            receivedAt: null,\n+┊   ┊286┊            readAt: null,\n+┊   ┊287┊          },\n+┊   ┊288┊        ],\n+┊   ┊289┊        holderIds: [2, 5],\n+┊   ┊290┊      },\n+┊   ┊291┊      {\n+┊   ┊292┊        id: 2,\n+┊   ┊293┊        chatId: 6,\n+┊   ┊294┊        senderId: 5,\n+┊   ┊295┊        content: 'Love it!',\n+┊   ┊296┊        createdAt: moment().subtract(2, 'weeks').add(10, 'minutes').unix(),\n+┊   ┊297┊        type: MessageType.TEXT,\n+┊   ┊298┊        recipients: [\n+┊   ┊299┊          {\n+┊   ┊300┊            userId: 2,\n+┊   ┊301┊            messageId: 2,\n+┊   ┊302┊            chatId: 5,\n+┊   ┊303┊            receivedAt: null,\n+┊   ┊304┊            readAt: null,\n+┊   ┊305┊          },\n+┊   ┊306┊        ],\n+┊   ┊307┊        holderIds: [5, 2],\n+┊   ┊308┊      },\n+┊   ┊309┊    ],\n+┊   ┊310┊  },\n+┊   ┊311┊  {\n+┊   ┊312┊    id: 6,\n+┊   ┊313┊    name: null,\n+┊   ┊314┊    picture: null,\n+┊   ┊315┊    allTimeMemberIds: [1, 6],\n+┊   ┊316┊    listingMemberIds: [1],\n+┊   ┊317┊    adminIds: null,\n+┊   ┊318┊    ownerId: null,\n+┊   ┊319┊    messages: [],\n+┊   ┊320┊  },\n+┊   ┊321┊  {\n+┊   ┊322┊    id: 7,\n+┊   ┊323┊    name: null,\n+┊   ┊324┊    picture: null,\n+┊   ┊325┊    allTimeMemberIds: [2, 1],\n+┊   ┊326┊    listingMemberIds: [2],\n+┊   ┊327┊    adminIds: null,\n+┊   ┊328┊    ownerId: null,\n+┊   ┊329┊    messages: [],\n+┊   ┊330┊  },\n+┊   ┊331┊  {\n+┊   ┊332┊    id: 8,\n+┊   ┊333┊    name: 'A user 0 group',\n+┊   ┊334┊    picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n+┊   ┊335┊    allTimeMemberIds: [1, 3, 4, 6],\n+┊   ┊336┊    listingMemberIds: [1, 3, 4, 6],\n+┊   ┊337┊    actualGroupMemberIds: [1, 4, 6],\n+┊   ┊338┊    adminIds: [1, 6],\n+┊   ┊339┊    ownerId: 1,\n+┊   ┊340┊    messages: [\n+┊   ┊341┊      {\n+┊   ┊342┊        id: 1,\n+┊   ┊343┊        chatId: 8,\n+┊   ┊344┊        senderId: 1,\n+┊   ┊345┊        content: 'I made a group',\n+┊   ┊346┊        createdAt: moment().subtract(2, 'weeks').unix(),\n+┊   ┊347┊        type: MessageType.TEXT,\n+┊   ┊348┊        recipients: [\n+┊   ┊349┊          {\n+┊   ┊350┊            userId: 3,\n+┊   ┊351┊            messageId: 1,\n+┊   ┊352┊            chatId: 8,\n+┊   ┊353┊            receivedAt: null,\n+┊   ┊354┊            readAt: null,\n+┊   ┊355┊          },\n+┊   ┊356┊          {\n+┊   ┊357┊            userId: 4,\n+┊   ┊358┊            messageId: 1,\n+┊   ┊359┊            chatId: 8,\n+┊   ┊360┊            receivedAt: moment().subtract(2, 'weeks').add(1, 'minutes').unix(),\n+┊   ┊361┊            readAt: moment().subtract(2, 'weeks').add(5, 'minutes').unix(),\n+┊   ┊362┊          },\n+┊   ┊363┊          {\n+┊   ┊364┊            userId: 6,\n+┊   ┊365┊            messageId: 1,\n+┊   ┊366┊            chatId: 8,\n+┊   ┊367┊            receivedAt: null,\n+┊   ┊368┊            readAt: null,\n+┊   ┊369┊          },\n+┊   ┊370┊        ],\n+┊   ┊371┊        holderIds: [1, 3, 4, 6],\n+┊   ┊372┊      },\n+┊   ┊373┊      {\n+┊   ┊374┊        id: 2,\n+┊   ┊375┊        chatId: 8,\n+┊   ┊376┊        senderId: 1,\n+┊   ┊377┊        content: 'Ops, user 3 was not supposed to be here',\n+┊   ┊378┊        createdAt: moment().subtract(2, 'weeks').add(2, 'minutes').unix(),\n+┊   ┊379┊        type: MessageType.TEXT,\n+┊   ┊380┊        recipients: [\n+┊   ┊381┊          {\n+┊   ┊382┊            userId: 4,\n+┊   ┊383┊            messageId: 2,\n+┊   ┊384┊            chatId: 8,\n+┊   ┊385┊            receivedAt: moment().subtract(2, 'weeks').add(3, 'minutes').unix(),\n+┊   ┊386┊            readAt: moment().subtract(2, 'weeks').add(5, 'minutes').unix(),\n+┊   ┊387┊          },\n+┊   ┊388┊          {\n+┊   ┊389┊            userId: 6,\n+┊   ┊390┊            messageId: 2,\n+┊   ┊391┊            chatId: 8,\n+┊   ┊392┊            receivedAt: null,\n+┊   ┊393┊            readAt: null,\n+┊   ┊394┊          },\n+┊   ┊395┊        ],\n+┊   ┊396┊        holderIds: [1, 4, 6],\n+┊   ┊397┊      },\n+┊   ┊398┊      {\n+┊   ┊399┊        id: 3,\n+┊   ┊400┊        chatId: 8,\n+┊   ┊401┊        senderId: 4,\n+┊   ┊402┊        content: 'Awesome!',\n+┊   ┊403┊        createdAt: moment().subtract(2, 'weeks').add(10, 'minutes').unix(),\n+┊   ┊404┊        type: MessageType.TEXT,\n+┊   ┊405┊        recipients: [\n+┊   ┊406┊          {\n+┊   ┊407┊            userId: 1,\n+┊   ┊408┊            messageId: 3,\n+┊   ┊409┊            chatId: 8,\n+┊   ┊410┊            receivedAt: null,\n+┊   ┊411┊            readAt: null,\n+┊   ┊412┊          },\n+┊   ┊413┊          {\n+┊   ┊414┊            userId: 6,\n+┊   ┊415┊            messageId: 3,\n+┊   ┊416┊            chatId: 8,\n+┊   ┊417┊            receivedAt: null,\n+┊   ┊418┊            readAt: null,\n+┊   ┊419┊          },\n+┊   ┊420┊        ],\n+┊   ┊421┊        holderIds: [1, 4, 6],\n+┊   ┊422┊      },\n+┊   ┊423┊    ],\n+┊   ┊424┊  },\n+┊   ┊425┊  {\n+┊   ┊426┊    id: 9,\n+┊   ┊427┊    name: 'A user 5 group',\n+┊   ┊428┊    picture: null,\n+┊   ┊429┊    allTimeMemberIds: [6, 3],\n+┊   ┊430┊    listingMemberIds: [6, 3],\n+┊   ┊431┊    actualGroupMemberIds: [6, 3],\n+┊   ┊432┊    adminIds: [6],\n+┊   ┊433┊    ownerId: 6,\n+┊   ┊434┊    messages: [],\n+┊   ┊435┊  },\n+┊   ┊436┊];\n+┊   ┊437┊\n+┊   ┊438┊export const db = {users, chats};\n```\n\n[}]: #\n\nIts' finally time to create our schema\n\n[{]: <helper> (diffStep \"1.3\" files=\"schema/typeDefs.ts\" module=\"server\")\n\n#### [Step 1.3: Add resolvers and schema](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/a2cb658)\n\n##### Changed schema&#x2F;typeDefs.ts\n```diff\n@@ -1,2 +1,68 @@\n ┊ 1┊ 1┊export default `\n+┊  ┊ 2┊  type Query {\n+┊  ┊ 3┊    users: [User!]\n+┊  ┊ 4┊    chats: [Chat!]\n+┊  ┊ 5┊    chat(chatId: ID!): Chat\n+┊  ┊ 6┊  }\n+┊  ┊ 7┊\n+┊  ┊ 8┊  enum MessageType {\n+┊  ┊ 9┊    LOCATION\n+┊  ┊10┊    TEXT\n+┊  ┊11┊    PICTURE\n+┊  ┊12┊  }\n+┊  ┊13┊\n+┊  ┊14┊  type Chat {\n+┊  ┊15┊    #May be a chat or a group\n+┊  ┊16┊    id: ID!\n+┊  ┊17┊    #Computed for chats\n+┊  ┊18┊    name: String\n+┊  ┊19┊    #Computed for chats\n+┊  ┊20┊    picture: String\n+┊  ┊21┊    #All members, current and past ones.\n+┊  ┊22┊    allTimeMembers: [User!]!\n+┊  ┊23┊    #Whoever gets the chat listed. For groups includes past members who still didn't delete the group.\n+┊  ┊24┊    listingMembers: [User!]!\n+┊  ┊25┊    #Actual members of the group (they are not the only ones who get the group listed). Null for chats.\n+┊  ┊26┊    actualGroupMembers: [User!]!\n+┊  ┊27┊    #Null for chats\n+┊  ┊28┊    admins: [User!]\n+┊  ┊29┊    #If null the group is read-only. Null for chats.\n+┊  ┊30┊    owner: User\n+┊  ┊31┊    messages(amount: Int): [Message]!\n+┊  ┊32┊    #Computed property\n+┊  ┊33┊    unreadMessages: Int!\n+┊  ┊34┊    #Computed property\n+┊  ┊35┊    isGroup: Boolean!\n+┊  ┊36┊  }\n+┊  ┊37┊\n+┊  ┊38┊  type Message {\n+┊  ┊39┊    id: ID!\n+┊  ┊40┊    sender: User!\n+┊  ┊41┊    chat: Chat!\n+┊  ┊42┊    content: String!\n+┊  ┊43┊    createdAt: String!\n+┊  ┊44┊    #FIXME: should return MessageType\n+┊  ┊45┊    type: Int!\n+┊  ┊46┊    #Whoever received the message\n+┊  ┊47┊    recipients: [Recipient!]!\n+┊  ┊48┊    #Whoever still holds a copy of the message. Cannot be null because the message gets deleted otherwise\n+┊  ┊49┊    holders: [User!]!\n+┊  ┊50┊    #Computed property\n+┊  ┊51┊    ownership: Boolean!\n+┊  ┊52┊  }\n+┊  ┊53┊\n+┊  ┊54┊  type Recipient {\n+┊  ┊55┊    user: User!\n+┊  ┊56┊    message: Message!\n+┊  ┊57┊    chat: Chat!\n+┊  ┊58┊    receivedAt: String\n+┊  ┊59┊    readAt: String\n+┊  ┊60┊  }\n+┊  ┊61┊\n+┊  ┊62┊  type User {\n+┊  ┊63┊    id: ID!\n+┊  ┊64┊    name: String\n+┊  ┊65┊    picture: String\n+┊  ┊66┊    phone: String\n+┊  ┊67┊  }\n ┊ 2┊68┊`;\n```\n\n[}]: #\n\nand our resolvers\n\n[{]: <helper> (diffStep \"1.3\" files=\"schema/resolvers.ts\" module=\"server\")\n\n#### [Step 1.3: Add resolvers and schema](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/a2cb658)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,5 +1,51 @@\n ┊ 1┊ 1┊import { IResolvers } from 'apollo-server-express';\n+┊  ┊ 2┊import { Chat, db, Message, Recipient, User } from \"../db\";\n+┊  ┊ 3┊\n+┊  ┊ 4┊let users = db.users;\n+┊  ┊ 5┊let chats = db.chats;\n+┊  ┊ 6┊const currentUser = 1;\n ┊ 2┊ 7┊\n ┊ 3┊ 8┊export const resolvers: IResolvers = {\n-┊ 4┊  ┊  Query: {},\n+┊  ┊ 9┊  Query: {\n+┊  ┊10┊    // Show all users for the moment.\n+┊  ┊11┊    users: (): User[] => users.filter(user => user.id !== currentUser),\n+┊  ┊12┊    chats: (): Chat[] => chats.filter(chat => chat.listingMemberIds.includes(currentUser)),\n+┊  ┊13┊    chat: (obj: any, {chatId}): Chat | null => chats.find(chat => chat.id === chatId) || null,\n+┊  ┊14┊  },\n+┊  ┊15┊  Chat: {\n+┊  ┊16┊    name: (chat: Chat): string => chat.name ? chat.name : users\n+┊  ┊17┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser))!.name,\n+┊  ┊18┊    picture: (chat: Chat) => chat.name ? chat.picture : users\n+┊  ┊19┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser))!.picture,\n+┊  ┊20┊    allTimeMembers: (chat: Chat): User[] => users.filter(user => chat.allTimeMemberIds.includes(user.id)),\n+┊  ┊21┊    listingMembers: (chat: Chat): User[] => users.filter(user => chat.listingMemberIds.includes(user.id)),\n+┊  ┊22┊    actualGroupMembers: (chat: Chat): User[] => users.filter(user => chat.actualGroupMemberIds && chat.actualGroupMemberIds.includes(user.id)),\n+┊  ┊23┊    admins: (chat: Chat): User[] => users.filter(user => chat.adminIds && chat.adminIds.includes(user.id)),\n+┊  ┊24┊    owner: (chat: Chat): User | null => users.find(user => chat.ownerId === user.id) || null,\n+┊  ┊25┊    messages: (chat: Chat, {amount = 0}: {amount: number}): Message[] => {\n+┊  ┊26┊      const messages = chat.messages\n+┊  ┊27┊      .filter(message => message.holderIds.includes(currentUser))\n+┊  ┊28┊      .sort((a, b) => b.createdAt - a.createdAt) || <Message[]>[];\n+┊  ┊29┊      return (amount ? messages.slice(0, amount) : messages).reverse();\n+┊  ┊30┊    },\n+┊  ┊31┊    unreadMessages: (chat: Chat): number => chat.messages\n+┊  ┊32┊      .filter(message => message.holderIds.includes(currentUser) &&\n+┊  ┊33┊        message.recipients.find(recipient => recipient.userId === currentUser && !recipient.readAt))\n+┊  ┊34┊      .length,\n+┊  ┊35┊    isGroup: (chat: Chat): boolean => !!chat.name,\n+┊  ┊36┊  },\n+┊  ┊37┊  Message: {\n+┊  ┊38┊    chat: (message: Message): Chat | null => chats.find(chat => message.chatId === chat.id) || null,\n+┊  ┊39┊    sender: (message: Message): User | null => users.find(user => user.id === message.senderId) || null,\n+┊  ┊40┊    holders: (message: Message): User[] => users.filter(user => message.holderIds.includes(user.id)),\n+┊  ┊41┊    ownership: (message: Message): boolean => message.senderId === currentUser,\n+┊  ┊42┊  },\n+┊  ┊43┊  Recipient: {\n+┊  ┊44┊    user: (recipient: Recipient): User | null => users.find(user => recipient.userId === user.id) || null,\n+┊  ┊45┊    message: (recipient: Recipient): Message | null => {\n+┊  ┊46┊      const chat = chats.find(chat => recipient.chatId === chat.id);\n+┊  ┊47┊      return chat ? chat.messages.find(message => recipient.messageId === message.id) || null : null;\n+┊  ┊48┊    },\n+┊  ┊49┊    chat: (recipient: Recipient): Chat | null => chats.find(chat => recipient.chatId === chat.id) || null,\n+┊  ┊50┊  },\n ┊ 5┊51┊};\n```\n\n[}]: #\n\nOut basic server is already done and working. We still have no way to do any kind of mutation, but we already set up several queries to return a list of users or chats.\nIn particular we can choose if we want to return all the chats (and how many messages we want to return for each chat) or if we want to return a single chat. We can also choose which and how many properties we want to return for each query.\nWe can start the server by simply running:\n\n    yarn start\n\n## Client\n\nNow we can concentrate on the client and bootstrap it using Angular-CLI.\nFirst you will need to install it globally with:\n\n    yarn global add @angular/cli\n\nThen we can create a new project from scratch:\n\n    ng new client --style scss\n\nTime to install a couple of packages:\n\n    ng add apollo-angular\n    yarn add -D @types/graphql\n\nApollo's Schematics sets everything for us. The only thing missing is to fill the `url`.\n\n[{]: <helper> (diffStep \"1.1\" files=\"src/app/graphql.module.ts\" module=\"client\")\n\n#### [Step 1.1: Add angular-apollo to app module](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/3a40362)\n\n##### Added src&#x2F;app&#x2F;graphql.module.ts\n```diff\n@@ -0,0 +1,25 @@\n+┊  ┊ 1┊import { NgModule} from '@angular/core';\n+┊  ┊ 2┊import { ApolloModule, APOLLO_OPTIONS } from 'apollo-angular';\n+┊  ┊ 3┊import { HttpLinkModule, HttpLink } from 'apollo-angular-link-http';\n+┊  ┊ 4┊import { InMemoryCache } from 'apollo-cache-inmemory';\n+┊  ┊ 5┊\n+┊  ┊ 6┊const uri = 'http://localhost:3000/graphql';\n+┊  ┊ 7┊\n+┊  ┊ 8┊export function createApollo(httpLink: HttpLink) {\n+┊  ┊ 9┊  return {\n+┊  ┊10┊    link: httpLink.create({uri}),\n+┊  ┊11┊    cache: new InMemoryCache(),\n+┊  ┊12┊  };\n+┊  ┊13┊}\n+┊  ┊14┊\n+┊  ┊15┊@NgModule({\n+┊  ┊16┊  exports: [ApolloModule, HttpLinkModule],\n+┊  ┊17┊  providers: [\n+┊  ┊18┊    {\n+┊  ┊19┊      provide: APOLLO_OPTIONS,\n+┊  ┊20┊      useFactory: createApollo,\n+┊  ┊21┊      deps: [HttpLink],\n+┊  ┊22┊    },\n+┊  ┊23┊  ],\n+┊  ┊24┊})\n+┊  ┊25┊export class GraphQLModule {}\n```\n\n[}]: #\n\nLet's take a closer look what Schematics prepared for us.\n\nFirst, it created `graphql.module.ts` and used `ApolloModule` and `HttpLinkModule`.\n\n- `ApolloModule` is the center of using GraphQL in your app! It includes all needed services that allows to use ApolloClient’s features.\n- `HttpLinkModule` makes it easy to fetch data in Angular.\n\n`HttpLinkModule` is optional, you can replace it with any other Link.\nIts biggest advantage of all is that it uses Angular's `HttpClient` internally so it's possible to use it in `NativeScript` or in combination with any other `HttpClient` provider. By using `HttpLinkModule` you get Server-Side Rendering for free, without any additional work.\n\nNext, we got `APOLLO_OPTIONS` provided to Angular.\n\nWe're using the `InMemoryCache` cache, but there are several options like `Redux`, `Hermes` and even `ngrx`.\n\n- `apollo-cache-inmemory` is an official and recommended Apollo Cache.\n\n### Cache and Links\n\nThese are two main parts of Apollo Stack, both are pluggable and customizable.\n\n- **Cache** is responsible for storing data and keeping it consistent.\n- **Links** describe how to access the source of data (usually a GraphQL endpoint).\n\nLet's take a closer look on what cache means for Apollo, we're going to base it on the official `apollo-cache-inmemory`, one of many implementations.\n\nBut first, imagine, we write our own amazing Apollo Cache implementation.\n\n```graphql\nquery getMessages {\n  messages {\n    id\n    content\n    likes\n  }\n}\n```\n\nWhen we execute a query like one above what we get in return is an array of all messages of logged in user:\n\n```json\n{\n  \"data\": {\n    \"messages\": [\n      {\n        \"id\": 0,\n        \"content\": \"Hi\",\n        \"likes\": 0\n      },\n      {\n        \"id\": 1,\n        \"content\": \"Hello\",\n        \"likes\": 0\n      }\n    ]\n  }\n}\n```\n\nOur cache stores the result in exact shape as above.\n\nLater on we add more queries and one of them returns a list of messages from one conversation.\n\nNow, a short story. We've got two users, Niccolo and Dotan.\n\n1. Niccolo opens the app and Apollo fetches all of his messages (I know, it's stupid but stay with me)\n1. One message is to Dotan, Niccolo said \"Hi\" to him.\n1. Now Dotan opens the app and reacts to the message with a like.\n1. After few minutes Niccolo asks for messages from a conversation with Dotan.\n1. Apollo fetches those messages and there is one in which Niccolo says \"Hi\" and it's liked by Dotan.\n1. Now we have the same message twice, one has different state that the other, in one place there is no like, in other, we have +1.\n\nAs you see, our cache is not smart enough to figure out one query might be a subset of another.\nThat's because it doesn't get enough informations.\n\nLet's go back to InMemoryCache and see how it describes itself:\n\n> Thanks to InMemoryCache, it's possible for the results of a query or mutation to update the UI in all the right places. In many cases it's possible for that to happen automatically, whereas in others you need to help the client out a little in doing so.\n\nIt means it could solve the issue we have with duplicated messages with different state.\n\nIt's very important to understand one concept that InMemoryCache is heavily based on, it's called normalization.\n\nThe InMemoryCache splits the result into individual objects, creates a unique identifier for each of them and flattens everything up before saving it to the store.\nMight seem complicated at first, but as InMemoryCache, let's break everything into smaller parts.\n\nFirst, \"breaking the result into pieces\" part. The InMemoryCache tells ApolloClient to add `__typename` field to your query before passing it to the server. I used server for simplicity, it actually passes it to Apollo Links and they are responsible to make a HTTP request. Every Apollo Cache is able to transform a document, that's as a side note.\n\n```graphql\nquery getMessages {\n  messages {\n    id\n    content\n    likes\n    __typename\n  }\n}\n```\n\nThe `__typename` field tells about the type of the object. It's compatible with every GraphQL server as it's part of the specification.\n\n```graphql\ntype Message {\n  id: ID\n  content: String\n  likes: Int\n}\n\ntype Query {\n  messages: [Message]\n}\n```\n\nIn our case, `__typename` returns `Message`. So now InMemoryCache knows that a message is a Message. Computers are stupid, we have to tell them everything!\n\nNext, let's take a look at \"creates a unique identifier\" part.\n\nThe InMemoryCache iterates through every object and looks for the `__typename` and two fields, `id` and `_id` that usually are used as identifiers. Taking our example, it turns every Message object into `Message:1`, `Message:2`, `Message:3` and so on. You get the idea.\n\nIt's the default behaviour but you can change it as you wish:\n\n```typescript\nconst cache = new InMemoryCache({\n  dataIdFromObject(result) {\n    if (result.__typename) {\n      const id = result.uid || result.id || result._id;\n\n      if (id !== undefined) {\n        return `${result.__typename}:${id}`;\n      }\n    }\n    return null;\n  },\n});\n```\n\nGreat, we covered two out of three things InMemoryCache does. Now we're going to explore \"flattens everything up\".\n\nWe're able to understand the type of each individual object and it's unique identifier. It still has to be stored.\n\nWhat InMemoryCache does is it's saves every element on root level in a plain object where the key contains a unique identifier and the value has a body.\n\n```json\n{\n  \"Message:1\": {\n    \"id\": 1,\n    \"content\": \"Hi\",\n    \"likes\": 1,\n    \"__typename\": \"Message\"\n  },\n  \"Message:2\": {\n    \"id\": 2,\n    \"content\": \"Hello\",\n    \"likes\": 0,\n    \"__typename\": \"Message\"\n  },\n  \"ROOT_QUERY\": {\n    \"messages\": [\n      {\n        \"id\": \"Message:1\",\n        \"typename\": \"Message\"\n      },\n      {\n        \"id\": \"Message:2\",\n        \"typename\": \"Message\"\n      }\n    ]\n  }\n}\n```\n\nWait, `ROOT_QUERY`? Yes, it has to somehow store the actual result of every executed query so next time you ask for the same thing, it matches it with the query in store and resolves right away.\n\n> You should be aware that the InMemoryCache stringifies variables of a query too, which means the same queries but with different variables are stored separately. Even the order of those variables matters.\n\nAs you can see, each element in `ROOT_QUERY.message` is kind of a reference to a message record.\n\nLet's bring back our short story, a scenario.\nWhen Niccolo asks for all messages, the whole three part process is started, each message is saved to the store.\nWhen he asks for history of a conversation with Dotan, InMemoryCache starts the process again and if it sees that there is already a massage with the same unique identifier, it knows they both are the same so it merged them.\nThe InMemoryCache can tell what changed and emits the new object to the UI.\nThanks to that we no longer have the same message in two places where one has a like and other doesn't.\n\nUff, Apollo Cache part is done. Thanks for being with us that long, I hope you didn't get bored because there's a lot ahead of us.\n\nLet's talk Apollo Link.\n\nAs I mentioned it's kind of a network stack of Apollo. You execute a document with some metadata like variables or a context, Apollo Client receives it and passes it to the chain of Links.\n\nThe ApolloLink is based on an Observable (not RxJS) and if you know `RxJS` you're familiar with `pipe`. Each Link is basically a function that receives a requested operation and a function that runs the next Link. Just like a pipe!\n\n```typescript\nimport { ApolloLink } from 'apollo-link';\n\nconst log = new ApolloLink((operation, next) => {\n  console.log('Name', operation.operationName);\n  return next(operation);\n});\n```\n\nNow when we add it in `graphql.module.ts` we see the name of each requested operation.\n\nWe can even intercept the result.\n\n```typescript\nconst intercept = new ApolloLink((operation, next) => {\n    return forward(operation).map((data) => {\n        // data from a previous link\n        console.log('data', data);\n        return data;\n    });\n});\n```\n\nAs you can see below, by network we don't always mean making HTTP requests. It could be Http Link at the end of Links chain or WebSocket Link or even something that works on in-memory data.\n\n```typescript\nimport { ApolloLink, Observable } from 'apollo-link';\n\nconst inmemory = new ApolloLink(operation => {\n    return Observable(observer => {\n        // function that executes the operation and returns data\n        const result = resolveOperation(operation);\n\n        observer.next(result);\n        observer.complete();\n    });\n});\n```\n\nYou can find tons of helpful Links [on npm](https://www.npmjs.com/search?q=apollo-link-) and [on Apollo Link documentation](https://www.apollographql.com/docs/link/links/community.html).\n\nWe highly recommend to take a look at Angular related Links [on Apollo Angular documentation](https://www.apollographql.com/docs/angular/guides/tools-and-packages.html).\n\n### GQL Tag\n\nThe `gql` template tag is what you use to define GraphQL queries in your Apollo apps. It parses your GraphQL query into the `GraphQL.js AST format` which may then be consumed by Apollo methods. Whenever Apollo is asking for a GraphQL query you will always want to wrap it in a `gql` template tag.\n\nYou can embed a GraphQL document containing only fragments inside of another GraphQL document using template string interpolation. This allows you to use fragments defined in one part of your codebase inside of a query defined in a completely different file.\n\n[{]: <helper> (diffStep \"1.2\" file=\"src/graphql/fragment.ts\" module=\"client\")\n\n#### [Step 1.2: Add chats service](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/591a455)\n\n##### Added src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -0,0 +1,25 @@\n+┊  ┊ 1┊import {map} from 'rxjs/operators';\n+┊  ┊ 2┊import {Apollo} from 'apollo-angular';\n+┊  ┊ 3┊import {Injectable} from '@angular/core';\n+┊  ┊ 4┊import {getChatsQuery} from '../../graphql/getChats.query';\n+┊  ┊ 5┊\n+┊  ┊ 6┊@Injectable()\n+┊  ┊ 7┊export class ChatsService {\n+┊  ┊ 8┊  messagesAmount = 3;\n+┊  ┊ 9┊\n+┊  ┊10┊  constructor(private apollo: Apollo) {}\n+┊  ┊11┊\n+┊  ┊12┊  getChats() {\n+┊  ┊13┊    const query = this.apollo.watchQuery<any>({\n+┊  ┊14┊      query: getChatsQuery,\n+┊  ┊15┊      variables: {\n+┊  ┊16┊        amount: this.messagesAmount,\n+┊  ┊17┊      },\n+┊  ┊18┊    });\n+┊  ┊19┊    const chats$ = query.valueChanges.pipe(\n+┊  ┊20┊      map((result) => result.data.chats)\n+┊  ┊21┊    );\n+┊  ┊22┊\n+┊  ┊23┊    return {query, chats$};\n+┊  ┊24┊  }\n+┊  ┊25┊}\n```\n\n##### Added src&#x2F;graphql&#x2F;fragment.ts\n```diff\n@@ -0,0 +1,51 @@\n+┊  ┊ 1┊import gql from 'graphql-tag';\n+┊  ┊ 2┊import {DocumentNode} from 'graphql';\n+┊  ┊ 3┊\n+┊  ┊ 4┊export const fragments: {\n+┊  ┊ 5┊  [key: string]: DocumentNode\n+┊  ┊ 6┊} = {\n+┊  ┊ 7┊  chatWithoutMessages: gql`\n+┊  ┊ 8┊    fragment ChatWithoutMessages on Chat {\n+┊  ┊ 9┊      id\n+┊  ┊10┊      name\n+┊  ┊11┊      picture\n+┊  ┊12┊      allTimeMembers {\n+┊  ┊13┊        id\n+┊  ┊14┊      }\n+┊  ┊15┊      unreadMessages\n+┊  ┊16┊      isGroup\n+┊  ┊17┊    }\n+┊  ┊18┊  `,\n+┊  ┊19┊  message: gql`\n+┊  ┊20┊    fragment Message on Message {\n+┊  ┊21┊      id\n+┊  ┊22┊      chat {\n+┊  ┊23┊        id\n+┊  ┊24┊      }\n+┊  ┊25┊      sender {\n+┊  ┊26┊        id\n+┊  ┊27┊        name\n+┊  ┊28┊      }\n+┊  ┊29┊      content\n+┊  ┊30┊      createdAt\n+┊  ┊31┊      type\n+┊  ┊32┊      recipients {\n+┊  ┊33┊        user {\n+┊  ┊34┊          id\n+┊  ┊35┊        }\n+┊  ┊36┊        message {\n+┊  ┊37┊          id\n+┊  ┊38┊          chat {\n+┊  ┊39┊            id\n+┊  ┊40┊          }\n+┊  ┊41┊        }\n+┊  ┊42┊        chat {\n+┊  ┊43┊          id\n+┊  ┊44┊        }\n+┊  ┊45┊        receivedAt\n+┊  ┊46┊        readAt\n+┊  ┊47┊      }\n+┊  ┊48┊      ownership\n+┊  ┊49┊    }\n+┊  ┊50┊  `,\n+┊  ┊51┊};\n```\n\n##### Added src&#x2F;graphql&#x2F;getChats.query.ts\n```diff\n@@ -0,0 +1,17 @@\n+┊  ┊ 1┊import gql from 'graphql-tag';\n+┊  ┊ 2┊import {fragments} from './fragment';\n+┊  ┊ 3┊\n+┊  ┊ 4┊// We use the gql tag to parse our query string into a query document\n+┊  ┊ 5┊export const getChatsQuery = gql`\n+┊  ┊ 6┊  query GetChats($amount: Int) {\n+┊  ┊ 7┊    chats {\n+┊  ┊ 8┊      ...ChatWithoutMessages\n+┊  ┊ 9┊      messages(amount: $amount) {\n+┊  ┊10┊        ...Message\n+┊  ┊11┊      }\n+┊  ┊12┊    }\n+┊  ┊13┊  }\n+┊  ┊14┊\n+┊  ┊15┊  ${fragments['chatWithoutMessages']}\n+┊  ┊16┊  ${fragments['message']}\n+┊  ┊17┊`;\n```\n\n[}]: #\n\n### Use Apollo service\n\nLet's create a simple service to query the chats from our just created server:\n\n[{]: <helper> (diffStep \"1.2\" files=\"src/app/services\" module=\"client\")\n\n#### [Step 1.2: Add chats service](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/591a455)\n\n##### Added src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -0,0 +1,25 @@\n+┊  ┊ 1┊import {map} from 'rxjs/operators';\n+┊  ┊ 2┊import {Apollo} from 'apollo-angular';\n+┊  ┊ 3┊import {Injectable} from '@angular/core';\n+┊  ┊ 4┊import {getChatsQuery} from '../../graphql/getChats.query';\n+┊  ┊ 5┊\n+┊  ┊ 6┊@Injectable()\n+┊  ┊ 7┊export class ChatsService {\n+┊  ┊ 8┊  messagesAmount = 3;\n+┊  ┊ 9┊\n+┊  ┊10┊  constructor(private apollo: Apollo) {}\n+┊  ┊11┊\n+┊  ┊12┊  getChats() {\n+┊  ┊13┊    const query = this.apollo.watchQuery<any>({\n+┊  ┊14┊      query: getChatsQuery,\n+┊  ┊15┊      variables: {\n+┊  ┊16┊        amount: this.messagesAmount,\n+┊  ┊17┊      },\n+┊  ┊18┊    });\n+┊  ┊19┊    const chats$ = query.valueChanges.pipe(\n+┊  ┊20┊      map((result) => result.data.chats)\n+┊  ┊21┊    );\n+┊  ┊22┊\n+┊  ┊23┊    return {query, chats$};\n+┊  ┊24┊  }\n+┊  ┊25┊}\n```\n\n[}]: #\n\nWe just learned how to use Apollo to attach GraphQL query results to the Angular UI.\n\nThe `watchQuery` method returns a `QueryRef` object which has the `valueChanges` property that is an `Observable`.\n\nEvery fetched data is stored in Apollo Client’s cache, so if some other query fetches new information about the chats, this component will update to remain consistent.\n\nIt’s also possible to fetch data only once. You simply use `query` method instead of `watchQuery`. The query method of Apollo service returns an Observable too that also resolves with the same result as above.\n\n#### But what is a `QueryRef`?\n\nAs you know, `query` method returns an Observable that emits a result, just once, then the observable completes. `watchQuery` works a bit different. It fetches data then stays open and listens to the Cache for updates.\n\nSo why `watchQuery` can not simply expose an Observable and it serves `QueryRef` instead?\n\nBecause Apollo Angular is a bridge between Apollo Client (core library) and Angular framework it has to operate on RxJS based Observables. RxJS Observable has a simple API that cannot be easily extended and it's in general a bad practice.\n\nWhy we're talking about those things? Apollo Client exposes an Observable that has bunch of custom method on it. They are super useful and their purpose is to talk to Apollo through them.\n\nSince we have to turn Apollo's Observable to something that is compatible with RxJS we decided to expose an object that has all those methods and `valueChanges` property that is a regular RxJS Observable.\n\n#### Make our app pretty\n\nWe will use Materials for the UI, so let's install it:\n\n    yarn add @angular/cdk @angular/material hammerjs ng2-truncate\n\nLet's configure Material:\n\n[{]: <helper> (diffStep \"1.3\" files=\"src/index.ts, src/main.ts, src/styles.scss\" module=\"client\")\n\n#### [Step 1.3: List the chats](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/7d716ee)\n\n##### Changed src&#x2F;main.ts\n```diff\n@@ -4,6 +4,9 @@\n ┊ 4┊ 4┊import { AppModule } from './app/app.module';\n ┊ 5┊ 5┊import { environment } from './environments/environment';\n ┊ 6┊ 6┊\n+┊  ┊ 7┊// Material gestures\n+┊  ┊ 8┊import 'hammerjs';\n+┊  ┊ 9┊\n ┊ 7┊10┊if (environment.production) {\n ┊ 8┊11┊  enableProdMode();\n ┊ 9┊12┊}\n```\n\n##### Changed src&#x2F;styles.scss\n```diff\n@@ -1 +1,28 @@\n ┊ 1┊ 1┊/* You can add global styles to this file, and also import other style files */\n+┊  ┊ 2┊\n+┊  ┊ 3┊/* Meterial theme */\n+┊  ┊ 4┊@import \"~@angular/material/prebuilt-themes/indigo-pink.css\";\n+┊  ┊ 5┊\n+┊  ┊ 6┊:root {\n+┊  ┊ 7┊  --primary: #2c6157;\n+┊  ┊ 8┊  --secondary: #6fd056;\n+┊  ┊ 9┊}\n+┊  ┊10┊\n+┊  ┊11┊body {\n+┊  ┊12┊  margin: 0;\n+┊  ┊13┊}\n+┊  ┊14┊\n+┊  ┊15┊.mat-primary {\n+┊  ┊16┊  background-color: var(--primary) !important;\n+┊  ┊17┊  color: white;\n+┊  ┊18┊}\n+┊  ┊19┊\n+┊  ┊20┊.mat-secondary {\n+┊  ┊21┊  background-color: var(--secondary) !important;\n+┊  ┊22┊  color: white;\n+┊  ┊23┊}\n+┊  ┊24┊\n+┊  ┊25┊.mat-toolbar {\n+┊  ┊26┊  color: white;\n+┊  ┊27┊  background-color: var(--primary) !important;\n+┊  ┊28┊}\n```\n\n[}]: #\n\nWe're now creating a `shared` module where we will define our header component where we're going to project a different content from each component:\n\n[{]: <helper> (diffStep \"1.3\" files=\"src/app/shared/*\" module=\"client\")\n\n#### [Step 1.3: List the chats](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/7d716ee)\n\n##### Added src&#x2F;app&#x2F;shared&#x2F;components&#x2F;toolbar&#x2F;toolbar.component.scss\n```diff\n@@ -0,0 +1,15 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊  height: 8vh;\n+┊  ┊ 4┊}\n+┊  ┊ 5┊\n+┊  ┊ 6┊.mat-toolbar {\n+┊  ┊ 7┊  justify-content: space-between;\n+┊  ┊ 8┊  height: 100%;\n+┊  ┊ 9┊\n+┊  ┊10┊  .left-block {\n+┊  ┊11┊    display: flex;\n+┊  ┊12┊    height: 8vh;\n+┊  ┊13┊    line-height: 8vh;\n+┊  ┊14┊  }\n+┊  ┊15┊}\n```\n\n##### Added src&#x2F;app&#x2F;shared&#x2F;components&#x2F;toolbar&#x2F;toolbar.component.ts\n```diff\n@@ -0,0 +1,19 @@\n+┊  ┊ 1┊import {Component} from '@angular/core';\n+┊  ┊ 2┊\n+┊  ┊ 3┊@Component({\n+┊  ┊ 4┊  selector: 'app-toolbar',\n+┊  ┊ 5┊  template: `\n+┊  ┊ 6┊    <mat-toolbar>\n+┊  ┊ 7┊      <div class=\"left-block\">\n+┊  ┊ 8┊        <ng-content select=\".navigation\"></ng-content>\n+┊  ┊ 9┊        <ng-content select=\".profile-pic\"></ng-content>\n+┊  ┊10┊        <ng-content select=\".title\"></ng-content>\n+┊  ┊11┊      </div>\n+┊  ┊12┊      <ng-content select=\".menu\"></ng-content>\n+┊  ┊13┊    </mat-toolbar>\n+┊  ┊14┊  `,\n+┊  ┊15┊  styleUrls: ['./toolbar.component.scss']\n+┊  ┊16┊})\n+┊  ┊17┊export class ToolbarComponent {\n+┊  ┊18┊\n+┊  ┊19┊}\n```\n\n##### Added src&#x2F;app&#x2F;shared&#x2F;shared.module.ts\n```diff\n@@ -0,0 +1,28 @@\n+┊  ┊ 1┊import {BrowserModule} from '@angular/platform-browser';\n+┊  ┊ 2┊import {NgModule} from '@angular/core';\n+┊  ┊ 3┊\n+┊  ┊ 4┊import {MatToolbarModule} from '@angular/material';\n+┊  ┊ 5┊import {ToolbarComponent} from './components/toolbar/toolbar.component';\n+┊  ┊ 6┊import {FormsModule} from '@angular/forms';\n+┊  ┊ 7┊import {BrowserAnimationsModule} from '@angular/platform-browser/animations';\n+┊  ┊ 8┊\n+┊  ┊ 9┊@NgModule({\n+┊  ┊10┊  declarations: [\n+┊  ┊11┊    ToolbarComponent,\n+┊  ┊12┊  ],\n+┊  ┊13┊  imports: [\n+┊  ┊14┊    BrowserModule,\n+┊  ┊15┊    // Material\n+┊  ┊16┊    MatToolbarModule,\n+┊  ┊17┊    // Animations\n+┊  ┊18┊    BrowserAnimationsModule,\n+┊  ┊19┊    // Forms\n+┊  ┊20┊    FormsModule,\n+┊  ┊21┊  ],\n+┊  ┊22┊  providers: [],\n+┊  ┊23┊  exports: [\n+┊  ┊24┊    ToolbarComponent,\n+┊  ┊25┊  ],\n+┊  ┊26┊})\n+┊  ┊27┊export class SharedModule {\n+┊  ┊28┊}\n```\n\n[}]: #\n\nNow we want to create the `chats-lister` module, with a container component called `ChatsComponent` and a couple of presentational components. Each and every chat item would be presented with a default profile picture as a placeholder, so before we proceed we will have to download it to the `src/assets` directory:\n\n    $ wget https://raw.githubusercontent.com/DAB0mB/whatsapp-client-angularcli-material/c75c2416b1990da3588015f76b8338764f44d6ec/src/assets/default-profile-pic.jpg -P src/assets\n\nAnd now we can proceed to creating the relevant components and their style sheets:\n\n[{]: <helper> (diffStep \"1.3\" files=\"src/app/chats-lister/*\" module=\"client\")\n\n#### [Step 1.3: List the chats](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/7d716ee)\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;chats-lister.module.ts\n```diff\n@@ -0,0 +1,49 @@\n+┊  ┊ 1┊import { BrowserModule } from '@angular/platform-browser';\n+┊  ┊ 2┊import { NgModule } from '@angular/core';\n+┊  ┊ 3┊\n+┊  ┊ 4┊import {BrowserAnimationsModule} from '@angular/platform-browser/animations';\n+┊  ┊ 5┊import {MatButtonModule, MatIconModule, MatListModule, MatMenuModule} from '@angular/material';\n+┊  ┊ 6┊import {RouterModule, Routes} from '@angular/router';\n+┊  ┊ 7┊import {FormsModule} from '@angular/forms';\n+┊  ┊ 8┊import {ChatsService} from '../services/chats.service';\n+┊  ┊ 9┊import {ChatItemComponent} from './components/chat-item/chat-item.component';\n+┊  ┊10┊import {ChatsComponent} from './containers/chats/chats.component';\n+┊  ┊11┊import {ChatsListComponent} from './components/chats-list/chats-list.component';\n+┊  ┊12┊import {TruncateModule} from 'ng2-truncate';\n+┊  ┊13┊import {SharedModule} from '../shared/shared.module';\n+┊  ┊14┊\n+┊  ┊15┊const routes: Routes = [\n+┊  ┊16┊  {path: '', redirectTo: 'chats', pathMatch: 'full'},\n+┊  ┊17┊  {path: 'chats', component: ChatsComponent},\n+┊  ┊18┊];\n+┊  ┊19┊\n+┊  ┊20┊@NgModule({\n+┊  ┊21┊  declarations: [\n+┊  ┊22┊    ChatsComponent,\n+┊  ┊23┊    ChatsListComponent,\n+┊  ┊24┊    ChatItemComponent,\n+┊  ┊25┊  ],\n+┊  ┊26┊  imports: [\n+┊  ┊27┊    BrowserModule,\n+┊  ┊28┊    // Material\n+┊  ┊29┊    MatMenuModule,\n+┊  ┊30┊    MatIconModule,\n+┊  ┊31┊    MatButtonModule,\n+┊  ┊32┊    MatListModule,\n+┊  ┊33┊    // Animations\n+┊  ┊34┊    BrowserAnimationsModule,\n+┊  ┊35┊    // Routing\n+┊  ┊36┊    RouterModule.forChild(routes),\n+┊  ┊37┊    // Forms\n+┊  ┊38┊    FormsModule,\n+┊  ┊39┊    // Truncate Pipe\n+┊  ┊40┊    TruncateModule,\n+┊  ┊41┊    // Feature modules\n+┊  ┊42┊    SharedModule,\n+┊  ┊43┊  ],\n+┊  ┊44┊  providers: [\n+┊  ┊45┊    ChatsService,\n+┊  ┊46┊  ],\n+┊  ┊47┊})\n+┊  ┊48┊export class ChatsListerModule {\n+┊  ┊49┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chat-item&#x2F;chat-item.component.scss\n```diff\n@@ -0,0 +1,44 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊  width: 100%;\n+┊  ┊ 4┊}\n+┊  ┊ 5┊\n+┊  ┊ 6┊.chat-row {\n+┊  ┊ 7┊  margin: 10px 0 0 10px;\n+┊  ┊ 8┊  height: 60px;\n+┊  ┊ 9┊  display: flex;\n+┊  ┊10┊\n+┊  ┊11┊  .chat-pic {\n+┊  ┊12┊    height: 50px;\n+┊  ┊13┊    width: auto;\n+┊  ┊14┊    border-radius: 50%;\n+┊  ┊15┊  }\n+┊  ┊16┊\n+┊  ┊17┊  .chat-info {\n+┊  ┊18┊    width: calc(100% - 60px);\n+┊  ┊19┊    height: 100%;\n+┊  ┊20┊    margin-left: 10px;\n+┊  ┊21┊    border-bottom: .5px solid silver;\n+┊  ┊22┊    position: relative;\n+┊  ┊23┊\n+┊  ┊24┊    .chat-name {\n+┊  ┊25┊      margin-top: 5px;\n+┊  ┊26┊    }\n+┊  ┊27┊\n+┊  ┊28┊    .chat-last-message {\n+┊  ┊29┊      color: gray;\n+┊  ┊30┊      font-size: 15px;\n+┊  ┊31┊      margin-top: 5px;\n+┊  ┊32┊      text-overflow: ellipsis;\n+┊  ┊33┊      overflow: hidden;\n+┊  ┊34┊    }\n+┊  ┊35┊\n+┊  ┊36┊    .chat-timestamp {\n+┊  ┊37┊      position: absolute;\n+┊  ┊38┊      color: gray;\n+┊  ┊39┊      top: 5px;\n+┊  ┊40┊      right: 5px;\n+┊  ┊41┊      font-size: 13px;\n+┊  ┊42┊    }\n+┊  ┊43┊  }\n+┊  ┊44┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chat-item&#x2F;chat-item.component.ts\n```diff\n@@ -0,0 +1,21 @@\n+┊  ┊ 1┊import {Component, Input} from '@angular/core';\n+┊  ┊ 2┊\n+┊  ┊ 3┊@Component({\n+┊  ┊ 4┊  selector: 'app-chat-item',\n+┊  ┊ 5┊  template: `\n+┊  ┊ 6┊    <div class=\"chat-row\">\n+┊  ┊ 7┊      <img class=\"chat-pic\" [src]=\"chat.picture || 'assets/default-profile-pic.jpg'\">\n+┊  ┊ 8┊      <div class=\"chat-info\">\n+┊  ┊ 9┊        <div class=\"chat-name\">{{ chat.name }}</div>\n+┊  ┊10┊        <div class=\"chat-last-message\">{{ chat.messages?[chat.messages?.length - 1]?.content }}</div>\n+┊  ┊11┊        <div class=\"chat-timestamp\">00:00</div>\n+┊  ┊12┊      </div>\n+┊  ┊13┊    </div>\n+┊  ┊14┊  `,\n+┊  ┊15┊  styleUrls: ['chat-item.component.scss'],\n+┊  ┊16┊})\n+┊  ┊17┊export class ChatItemComponent {\n+┊  ┊18┊  // tslint:disable-next-line:no-input-rename\n+┊  ┊19┊  @Input('item')\n+┊  ┊20┊  chat: any;\n+┊  ┊21┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chats-list&#x2F;chats-list.component.scss\n```diff\n@@ -0,0 +1,8 @@\n+┊ ┊1┊:host {\n+┊ ┊2┊  display: block;\n+┊ ┊3┊}\n+┊ ┊4┊\n+┊ ┊5┊:host ::ng-deep .mat-list-item-content:first-child {\n+┊ ┊6┊  padding-left: 0 !important;\n+┊ ┊7┊  display: flow-root !important;\n+┊ ┊8┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chats-list&#x2F;chats-list.component.ts\n```diff\n@@ -0,0 +1,20 @@\n+┊  ┊ 1┊import {Component, Input} from '@angular/core';\n+┊  ┊ 2┊\n+┊  ┊ 3┊@Component({\n+┊  ┊ 4┊  selector: 'app-chats-list',\n+┊  ┊ 5┊  template: `\n+┊  ┊ 6┊    <mat-list>\n+┊  ┊ 7┊      <mat-list-item *ngFor=\"let chat of chats\">\n+┊  ┊ 8┊        <app-chat-item [item]=\"chat\"></app-chat-item>\n+┊  ┊ 9┊      </mat-list-item>\n+┊  ┊10┊    </mat-list>\n+┊  ┊11┊  `,\n+┊  ┊12┊  styleUrls: ['chats-list.component.scss'],\n+┊  ┊13┊})\n+┊  ┊14┊export class ChatsListComponent {\n+┊  ┊15┊  // tslint:disable-next-line:no-input-rename\n+┊  ┊16┊  @Input('items')\n+┊  ┊17┊  chats: any[];\n+┊  ┊18┊\n+┊  ┊19┊  constructor() {}\n+┊  ┊20┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.scss\n```diff\n@@ -0,0 +1,5 @@\n+┊ ┊1┊.chat-button {\n+┊ ┊2┊  position: absolute;\n+┊ ┊3┊  bottom: 5vw;\n+┊ ┊4┊  right: 5vw;\n+┊ ┊5┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.ts\n```diff\n@@ -0,0 +1,46 @@\n+┊  ┊ 1┊import {Component, OnInit} from '@angular/core';\n+┊  ┊ 2┊import {ChatsService} from '../../../services/chats.service';\n+┊  ┊ 3┊import {Observable} from 'rxjs';\n+┊  ┊ 4┊\n+┊  ┊ 5┊@Component({\n+┊  ┊ 6┊  template: `\n+┊  ┊ 7┊    <app-toolbar>\n+┊  ┊ 8┊      <div class=\"title\">Whatsapp Clone</div>\n+┊  ┊ 9┊      <button mat-icon-button [matMenuTriggerFor]=\"menu\" class=\"menu\">\n+┊  ┊10┊        <mat-icon>more_vert</mat-icon>\n+┊  ┊11┊      </button>\n+┊  ┊12┊    </app-toolbar>\n+┊  ┊13┊\n+┊  ┊14┊    <mat-menu #menu=\"matMenu\">\n+┊  ┊15┊      <button mat-menu-item>\n+┊  ┊16┊        <mat-icon>dialpad</mat-icon>\n+┊  ┊17┊        <span>Redial</span>\n+┊  ┊18┊      </button>\n+┊  ┊19┊      <button mat-menu-item disabled>\n+┊  ┊20┊        <mat-icon>voicemail</mat-icon>\n+┊  ┊21┊        <span>Check voicemail</span>\n+┊  ┊22┊      </button>\n+┊  ┊23┊      <button mat-menu-item>\n+┊  ┊24┊        <mat-icon>notifications_off</mat-icon>\n+┊  ┊25┊        <span>Disable alerts</span>\n+┊  ┊26┊      </button>\n+┊  ┊27┊    </mat-menu>\n+┊  ┊28┊\n+┊  ┊29┊    <app-chats-list [items]=\"chats$ | async\"></app-chats-list>\n+┊  ┊30┊\n+┊  ┊31┊    <button class=\"chat-button\" mat-fab color=\"secondary\">\n+┊  ┊32┊      <mat-icon aria-label=\"Icon-button with a + icon\">chat</mat-icon>\n+┊  ┊33┊    </button>\n+┊  ┊34┊  `,\n+┊  ┊35┊  styleUrls: ['./chats.component.scss'],\n+┊  ┊36┊})\n+┊  ┊37┊export class ChatsComponent implements OnInit {\n+┊  ┊38┊  chats$: Observable<any[]>;\n+┊  ┊39┊\n+┊  ┊40┊  constructor(private chatsService: ChatsService) {\n+┊  ┊41┊  }\n+┊  ┊42┊\n+┊  ┊43┊  ngOnInit() {\n+┊  ┊44┊    this.chats$ = this.chatsService.getChats().chats$;\n+┊  ┊45┊  }\n+┊  ┊46┊}\n```\n\n[}]: #\n\nFinally let's wire everything up to the main module:\n\n[{]: <helper> (diffStep \"1.3\" files=\"src/app/app.component.ts, src/app/app.module.ts\" module=\"client\")\n\n#### [Step 1.3: List the chats](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/7d716ee)\n\n##### Changed src&#x2F;app&#x2F;app.component.ts\n```diff\n@@ -2,7 +2,9 @@\n ┊ 2┊ 2┊\n ┊ 3┊ 3┊@Component({\n ┊ 4┊ 4┊  selector: 'app-root',\n-┊ 5┊  ┊  templateUrl: './app.component.html',\n+┊  ┊ 5┊  template: `\n+┊  ┊ 6┊    <router-outlet></router-outlet>\n+┊  ┊ 7┊  `,\n ┊ 6┊ 8┊  styleUrls: ['./app.component.scss']\n ┊ 7┊ 9┊})\n ┊ 8┊10┊export class AppComponent {\n```\n\n##### Changed src&#x2F;app&#x2F;app.module.ts\n```diff\n@@ -4,6 +4,9 @@\n ┊ 4┊ 4┊import { AppComponent } from './app.component';\n ┊ 5┊ 5┊import { HttpClientModule } from '@angular/common/http';\n ┊ 6┊ 6┊import { GraphQLModule } from './graphql.module';\n+┊  ┊ 7┊import {ChatsListerModule} from './chats-lister/chats-lister.module';\n+┊  ┊ 8┊import {RouterModule, Routes} from '@angular/router';\n+┊  ┊ 9┊const routes: Routes = [];\n ┊ 7┊10┊\n ┊ 8┊11┊@NgModule({\n ┊ 9┊12┊  declarations: [\n```\n```diff\n@@ -13,6 +16,10 @@\n ┊13┊16┊    BrowserModule,\n ┊14┊17┊    HttpClientModule,\n ┊15┊18┊    GraphQLModule,\n+┊  ┊19┊    // Routing\n+┊  ┊20┊    RouterModule.forRoot(routes),\n+┊  ┊21┊    // Feature modules\n+┊  ┊22┊    ChatsListerModule,\n ┊16┊23┊  ],\n ┊17┊24┊  providers: [],\n ┊18┊25┊  bootstrap: [AppComponent]\n```\n\n[}]: #\n\nIf you will try to run the frontend you will notice that several messages seems like duplicated, why does it happen?\n\nSince we use NoSQL-like structure in our backend, messages are stored as an array inside each chat so their incremental identifiers are not unique across different chats. We need to normalize them in a way that takes into account both the message id and the chat id:\n\n[{]: <helper> (diffStep \"1.4\" module=\"client\")\n\n#### [Step 1.4: Better normalize messages](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/4209360)\n\n##### Changed src&#x2F;app&#x2F;graphql.module.ts\n```diff\n@@ -1,14 +1,21 @@\n ┊ 1┊ 1┊import { NgModule} from '@angular/core';\n ┊ 2┊ 2┊import { ApolloModule, APOLLO_OPTIONS } from 'apollo-angular';\n ┊ 3┊ 3┊import { HttpLinkModule, HttpLink } from 'apollo-angular-link-http';\n-┊ 4┊  ┊import { InMemoryCache } from 'apollo-cache-inmemory';\n+┊  ┊ 4┊import { InMemoryCache, defaultDataIdFromObject } from 'apollo-cache-inmemory';\n ┊ 5┊ 5┊\n ┊ 6┊ 6┊const uri = 'http://localhost:3000/graphql';\n ┊ 7┊ 7┊\n ┊ 8┊ 8┊export function createApollo(httpLink: HttpLink) {\n ┊ 9┊ 9┊  return {\n ┊10┊10┊    link: httpLink.create({uri}),\n-┊11┊  ┊    cache: new InMemoryCache(),\n+┊  ┊11┊    cache: new InMemoryCache({\n+┊  ┊12┊      dataIdFromObject: (object: any) => {\n+┊  ┊13┊        switch (object.__typename) {\n+┊  ┊14┊          case 'Message': return `${object.chat.id}:${object.id}`; // use `chatId` prefix and `messageId` as the primary key\n+┊  ┊15┊          default: return defaultDataIdFromObject(object); // fall back to default handling\n+┊  ┊16┊        }\n+┊  ┊17┊      }\n+┊  ┊18┊    }),\n ┊12┊19┊  };\n ┊13┊20┊}\n```\n\n[}]: #\n\nThat way our application will work even if the backend is a NoSQL. What's even more interesting is that our application will keep working as well even when we will switch our backend to PostgreSQL."
          },
          {
            "manualTitle": "Step 6: graphql-code-generator",
            "stepRevision": "b39f987d0944ef79a533fa88893c3a79b814a84f",
            "manualView": "## Code Generation\n\nGraphQL entities are defined as static and typed, which means they can be analyzed and use as a base for generating everything.\n\nThere are many tools related to that topic, but we're going to focus on The **GraphQL Coge Generator**.\n\nThe GraphQL Coge Generator can generate any code for any language  —  including type definitions, data models, query builder, resolvers, ORM code, complete full stack platforms.\n\nThe tool is based on the concept of templates. It has few official templates to solve most required features. The GraphQL Code Gen allows to create your own custom codegen templates in 10 minutes, that fit exactly your needs.\n\nWe will use TypeScript template to generate typings.\n\n### Generating types for server-side code\n\nFirst, let's install `graphql-code-generator` with the TypeScript template and add it to the run scripts:\n\n    yarn add graphql-code-generator graphql-codegen-typescript-template\n\n[{]: <helper> (diffStep \"2.1\" module=\"server\")\n\n#### [Step 2.1: Install graphql-code-generator](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/b8214fd)\n\n##### Changed package.json\n```diff\n@@ -4,7 +4,8 @@\n ┊ 4┊ 4┊  \"private\": true,\n ┊ 5┊ 5┊  \"scripts\": {\n ┊ 6┊ 6┊    \"start\": \"npm run build:live\",\n-┊ 7┊  ┊    \"build:live\": \"nodemon --exec ./node_modules/.bin/ts-node -- ./index.ts\"\n+┊  ┊ 7┊    \"build:live\": \"nodemon --exec ./node_modules/.bin/ts-node -- ./index.ts\",\n+┊  ┊ 8┊    \"generator\": \"gql-gen -r ts-node/register —schema schema/typeDefs.ts --template ts --out ./types.d.ts\"\n ┊ 8┊ 9┊  },\n ┊ 9┊10┊  \"devDependencies\": {\n ┊10┊11┊    \"@types/body-parser\": \"1.17.0\",\n```\n```diff\n@@ -22,6 +23,7 @@\n ┊22┊23┊    \"cors\": \"2.8.4\",\n ┊23┊24┊    \"express\": \"4.16.3\",\n ┊24┊25┊    \"graphql\": \"14.0.2\",\n+┊  ┊26┊    \"graphql-code-generator\": \"0.12.6\",\n ┊25┊27┊    \"moment\": \"2.22.1\"\n ┊26┊28┊  }\n ┊27┊29┊}\n```\n\n[}]: #\n\nFew things here:\n\n- `--require ts-node/register` - makes the ts-node compile TypeScript files\n- `--schema` - points to a file that exports the GraphQL Schema object or a string (it also accepts an url)\n- `--template` - tells about the template we want to use\n- `--out` - the location of a generated file\n\nNow let's run the generator:\n\n    yarn generator\n\nPlease note that the server doesn't have to be running in background because we import schema through a file.\n\nNext, let's use the generated types:\n\n[{]: <helper> (diffStep \"2.3\" module=\"server\")\n\n#### [Step 2.3: Use our types](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/ef59ecf)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,5 +1,6 @@\n ┊1┊1┊import { IResolvers } from 'apollo-server-express';\n ┊2┊2┊import { Chat, db, Message, Recipient, User } from \"../db\";\n+┊ ┊3┊import { ChatQueryArgs } from \"../types\";\n ┊3┊4┊\n ┊4┊5┊let users = db.users;\n ┊5┊6┊let chats = db.chats;\n```\n```diff\n@@ -10,7 +11,7 @@\n ┊10┊11┊    // Show all users for the moment.\n ┊11┊12┊    users: (): User[] => users.filter(user => user.id !== currentUser),\n ┊12┊13┊    chats: (): Chat[] => chats.filter(chat => chat.listingMemberIds.includes(currentUser)),\n-┊13┊  ┊    chat: (obj: any, {chatId}): Chat | null => chats.find(chat => chat.id === chatId) || null,\n+┊  ┊14┊    chat: (obj: any, {chatId}: ChatQueryArgs): Chat | null => chats.find(chat => chat.id === Number(chatId)) || null,\n ┊14┊15┊  },\n ┊15┊16┊  Chat: {\n ┊16┊17┊    name: (chat: Chat): string => chat.name ? chat.name : users\n```\n\n[}]: #\n\nDon't worry, they will be much more useful when we will write our first mutation.\n\n### Generating types for client-side code\n\nLet's do the same on the client:\n\n    yarn add graphql-code-generator graphql-codegen-typescript-template\n\nPlease note that in this case, the server must be started before running the generator.\n\n[{]: <helper> (diffStep \"2.1\" module=\"client\")\n\n#### [Step 2.1: Install graphql-code-generator](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/a97dbe5)\n\n##### Changed package.json\n```diff\n@@ -7,7 +7,8 @@\n ┊ 7┊ 7┊    \"build\": \"ng build\",\n ┊ 8┊ 8┊    \"test\": \"ng test\",\n ┊ 9┊ 9┊    \"lint\": \"ng lint\",\n-┊10┊  ┊    \"e2e\": \"ng e2e\"\n+┊  ┊10┊    \"e2e\": \"ng e2e\",\n+┊  ┊11┊    \"generator\": \"gql-gen --schema http://localhost:3000/graphql --template graphql-codegen-typescript-template --out ./src/graphql.ts ./src/graphql/**/*.ts\"\n ┊11┊12┊  },\n ┊12┊13┊  \"private\": true,\n ┊13┊14┊  \"dependencies\": {\n```\n```diff\n@@ -45,6 +46,7 @@\n ┊45┊46┊    \"@types/jasminewd2\": \"2.0.3\",\n ┊46┊47┊    \"@types/node\": \"8.9.5\",\n ┊47┊48┊    \"codelyzer\": \"4.2.1\",\n+┊  ┊49┊    \"graphql-code-generator\": \"0.12.6\",\n ┊48┊50┊    \"jasmine-core\": \"2.99.1\",\n ┊49┊51┊    \"jasmine-spec-reporter\": \"4.2.1\",\n ┊50┊52┊    \"karma\": \"1.7.1\",\n```\n\n[}]: #\n\nWe saw how to use them on the server but let's see how easy it is to take advantage of them in Apollo.\n\nFirst thing you should know is most of the methods of Apollo service accepts generic types.\n\n#### What are Generic Types\n\nA major part of software engineering is building components that not only have well-defined and consistent APIs, but are also reusable. Components that are capable of working on the data of today as well as the data of tomorrow will give you the most flexible capabilities for building up large software systems.\n\nWe like to work on an code samples so let's do some functional programming and create the `map` method that accepts a transform function and return a new result.\n\nWithout generics, we would have to use a specific type or `any`:\n\n```typescript\nfunction map(mapFn: (value: any) => any) {\n  return function(source: any): any {\n    return mapFn(source);\n  };\n}\n```\n\nImagine, we want to use `map` function to pick user's id from an object:\n\n```typescript\ninterface User {\n  id: number;\n}\nconst me = {\n  id: 1,\n};\n\nconst pickUserId = map(user => user.id);\n\nconsole.log(pickUserId(me)); // outputs: 1\n```\n\nGreat, it works, we get the expected result but it could be done way better.\n\nWhat is the main issue here?\nIt accepts an object of any type and get `any` in return. It's not very useful because we know it return a `number` and receive a `User` but TypeScript doesn't know that and later on, in other part of the code, we end up with no information about the result.\n\nThat's where Generic Types jumps in!\n\nWith generics, it could look like this:\n\n```typescript\nfunction map<T, R>(mapFn: (value: T) => R) {\n  return function(source: T): R {\n    return mapFn(source);\n  };\n}\n```\n\nThere's... a lot! So let's break it:\n\n- `map<T, R>` - the map function accepts two generic types\n- `(mapFn: (value: T) => R)` - the only argument is a function that accepts an object of type `T` and returns value of type `R`\n- `function (source: T): R => {...}` - it's a higher order function that accepts a source of type `T` and transforms to be `R`.\n\nBack to our example, now with generic types:\n\n```typescript\ninterface User {\n  id: number;\n}\nconst me = {\n  id: 1,\n};\n\nconst pickUserId = map<User, number>(user => user.id);\n\nconsole.log(pickUserId(me)); // outputs: 1\n```\n\nOur `map` and `pickUserId` function are strongly typed now so when you try to provide an object that has no `id` field or the field is a `string` you'll receive a proper information from TypeScript (and your IDE).\n\n#### Make client-side code strongly typed\n\nWith all that knowledge let's use how to use those generated typed with `Apollo` service:\n\n[{]: <helper> (diffStep \"2.3\" module=\"client\")\n\n#### [Step 2.3: Use the generated types](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/afdf40c)\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chat-item&#x2F;chat-item.component.ts\n```diff\n@@ -1,4 +1,5 @@\n ┊1┊1┊import {Component, Input} from '@angular/core';\n+┊ ┊2┊import {GetChats} from '../../../../graphql';\n ┊2┊3┊\n ┊3┊4┊@Component({\n ┊4┊5┊  selector: 'app-chat-item',\n```\n```diff\n@@ -17,5 +18,5 @@\n ┊17┊18┊export class ChatItemComponent {\n ┊18┊19┊  // tslint:disable-next-line:no-input-rename\n ┊19┊20┊  @Input('item')\n-┊20┊  ┊  chat: any;\n+┊  ┊21┊  chat: GetChats.Chats;\n ┊21┊22┊}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chats-list&#x2F;chats-list.component.ts\n```diff\n@@ -1,4 +1,5 @@\n ┊1┊1┊import {Component, Input} from '@angular/core';\n+┊ ┊2┊import {GetChats} from '../../../../graphql';\n ┊2┊3┊\n ┊3┊4┊@Component({\n ┊4┊5┊  selector: 'app-chats-list',\n```\n```diff\n@@ -14,7 +15,7 @@\n ┊14┊15┊export class ChatsListComponent {\n ┊15┊16┊  // tslint:disable-next-line:no-input-rename\n ┊16┊17┊  @Input('items')\n-┊17┊  ┊  chats: any[];\n+┊  ┊18┊  chats: GetChats.Chats[];\n ┊18┊19┊\n ┊19┊20┊  constructor() {}\n ┊20┊21┊}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.ts\n```diff\n@@ -1,6 +1,7 @@\n ┊1┊1┊import {Component, OnInit} from '@angular/core';\n ┊2┊2┊import {ChatsService} from '../../../services/chats.service';\n ┊3┊3┊import {Observable} from 'rxjs';\n+┊ ┊4┊import {GetChats} from '../../../../graphql';\n ┊4┊5┊\n ┊5┊6┊@Component({\n ┊6┊7┊  template: `\n```\n```diff\n@@ -35,7 +36,7 @@\n ┊35┊36┊  styleUrls: ['./chats.component.scss'],\n ┊36┊37┊})\n ┊37┊38┊export class ChatsComponent implements OnInit {\n-┊38┊  ┊  chats$: Observable<any[]>;\n+┊  ┊39┊  chats$: Observable<GetChats.Chats[]>;\n ┊39┊40┊\n ┊40┊41┊  constructor(private chatsService: ChatsService) {\n ┊41┊42┊  }\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -2,6 +2,7 @@\n ┊2┊2┊import {Apollo} from 'apollo-angular';\n ┊3┊3┊import {Injectable} from '@angular/core';\n ┊4┊4┊import {getChatsQuery} from '../../graphql/getChats.query';\n+┊ ┊5┊import {GetChats} from '../../graphql';\n ┊5┊6┊\n ┊6┊7┊@Injectable()\n ┊7┊8┊export class ChatsService {\n```\n```diff\n@@ -10,7 +11,7 @@\n ┊10┊11┊  constructor(private apollo: Apollo) {}\n ┊11┊12┊\n ┊12┊13┊  getChats() {\n-┊13┊  ┊    const query = this.apollo.watchQuery<any>({\n+┊  ┊14┊    const query = this.apollo.watchQuery<GetChats.Query>({\n ┊14┊15┊      query: getChatsQuery,\n ┊15┊16┊      variables: {\n ┊16┊17┊        amount: this.messagesAmount,\n```\n\n[}]: #\n\nAs you can probably tell by now, methods like `watchQuery` and `mutate` (and others) accepts two generic types, first one describes the result and the second one the variables.\n\n```typescript\nexport class ChatService {\n  constructor(private apollo: Apollo) {}\n\n  getChat(chatId: string, amount: number): GetChat.Chat {\n    return this.apollo\n      .watchQuery<GetChat.Query, GetChat.Variables>({\n        query: getChatQuery,\n        variables: {\n          chatId,\n          amount,\n        },\n      })\n      .pipe(map(result => result.data.chat));\n  }\n}\n```\n\nFew things here.\n\n- An object of `GetChat.Query` shape lives under the `result.data` because `watchQuery` returns an object of type `ApolloQueryResult<T>` where `T` is our `GetChat.Query`.\n\n```typescript\nexport type ApolloQueryResult<T> = {\n  data: T;\n  // ... other fields\n};\n```\n\nYou get the same result with Mutation or Subscription.\n\n- Thanks to the second argument and `GetChat.Variables` we as well as TypeScript (and an IDE) know that `chatId` is a string and `amount` accepts only a number. Whenever we try to pass a value of different kind an Error will pop out.\n\n### Take full advantage of Codegen and generate ready to use Services!\n\nI've got a fantasctic news, you don't have to manually provide those generated types to each type Apollo service is used. Because GraphQL Documents are statically analyzable, we prepared a codegen template specific for Apollo Angular users.\n\nFirst, let's install `graphql-codegen-apollo-angular` with the Apollo Angular templatea and update the template param of `generator` script\n\n    yarn add graphql-code-generator graphql-codegen-typescript-template\n\n[{]: <helper> (diffStep \"2.4\" file=\"package.json\" module=\"client\")\n\n#### [Step 2.4: Use auto-generated GQL services](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/c0eddd1)\n\n##### Changed package.json\n```diff\n@@ -8,7 +8,7 @@\n ┊ 8┊ 8┊    \"test\": \"ng test\",\n ┊ 9┊ 9┊    \"lint\": \"ng lint\",\n ┊10┊10┊    \"e2e\": \"ng e2e\",\n-┊11┊  ┊    \"generator\": \"gql-gen --schema http://localhost:3000/graphql --template graphql-codegen-typescript-template --out ./src/graphql.ts ./src/graphql/**/*.ts\"\n+┊  ┊11┊    \"generator\": \"gql-gen --schema http://localhost:3000/graphql --template graphql-codegen-apollo-angular-template --out ./src/graphql.ts ./src/graphql/**/*.ts\"\n ┊12┊12┊  },\n ┊13┊13┊  \"private\": true,\n ┊14┊14┊  \"dependencies\": {\n```\n```diff\n@@ -48,6 +48,7 @@\n ┊48┊48┊    \"codelyzer\": \"4.2.1\",\n ┊49┊49┊    \"graphql-code-generator\": \"0.12.6\",\n ┊50┊50┊    \"graphql-codegen-typescript-template\": \"0.12.6\",\n+┊  ┊51┊    \"graphql-codegen-apollo-angular-template\": \"0.12.6\",\n ┊51┊52┊    \"jasmine-core\": \"2.99.1\",\n ┊52┊53┊    \"jasmine-spec-reporter\": \"4.2.1\",\n ┊53┊54┊    \"karma\": \"1.7.1\",\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,21 +1,18 @@\n ┊ 1┊ 1┊import {map} from 'rxjs/operators';\n-┊ 2┊  ┊import {Apollo} from 'apollo-angular';\n ┊ 3┊ 2┊import {Injectable} from '@angular/core';\n-┊ 4┊  ┊import {getChatsQuery} from '../../graphql/getChats.query';\n-┊ 5┊  ┊import {GetChats} from '../../graphql';\n+┊  ┊ 3┊import {GetChatsGQL} from '../../graphql';\n ┊ 6┊ 4┊\n ┊ 7┊ 5┊@Injectable()\n ┊ 8┊ 6┊export class ChatsService {\n ┊ 9┊ 7┊  messagesAmount = 3;\n ┊10┊ 8┊\n-┊11┊  ┊  constructor(private apollo: Apollo) {}\n+┊  ┊ 9┊  constructor(\n+┊  ┊10┊    private getChatsGQL: GetChatsGQL\n+┊  ┊11┊  ) {}\n ┊12┊12┊\n ┊13┊13┊  getChats() {\n-┊14┊  ┊    const query = this.apollo.watchQuery<GetChats.Query>({\n-┊15┊  ┊      query: getChatsQuery,\n-┊16┊  ┊      variables: {\n-┊17┊  ┊        amount: this.messagesAmount,\n-┊18┊  ┊      },\n+┊  ┊14┊    const query = this.getChatsGQL.watch({\n+┊  ┊15┊      amount: this.messagesAmount,\n ┊19┊16┊    });\n ┊20┊17┊    const chats$ = query.valueChanges.pipe(\n ┊21┊18┊      map((result) => result.data.chats)\n```\n\n##### Changed src&#x2F;graphql.ts\n```diff\n@@ -28,6 +28,8 @@\n ┊28┊28┊  ): R | Result | Promise<R | Result>;\n ┊29┊29┊};\n ┊30┊30┊\n+┊  ┊31┊export type Date = any;\n+┊  ┊32┊\n ┊31┊33┊export interface Query {\n ┊32┊34┊  users?: User[] | null;\n ┊33┊35┊  chats?: Chat[] | null;\n```\n```diff\n@@ -42,17 +44,18 @@\n ┊42┊44┊}\n ┊43┊45┊\n ┊44┊46┊export interface Chat {\n-┊45┊  ┊  id: string /** May be a chat or a group */;\n-┊46┊  ┊  name?: string | null /** Computed for chats */;\n-┊47┊  ┊  picture?: string | null /** Computed for chats */;\n-┊48┊  ┊  allTimeMembers: User[] /** All members, current and past ones. */;\n-┊49┊  ┊  listingMembers: User[] /** Whoever gets the chat listed. For groups includes past members who still didn't delete the group. */;\n-┊50┊  ┊  actualGroupMembers: User[] /** Actual members of the group (they are not the only ones who get the group listed). Null for chats. */;\n-┊51┊  ┊  admins?: User[] | null /** Null for chats */;\n-┊52┊  ┊  owner?: User | null /** If null the group is read-only. Null for chats. */;\n+┊  ┊47┊  id: string;\n+┊  ┊48┊  name?: string | null;\n+┊  ┊49┊  picture?: string | null;\n+┊  ┊50┊  allTimeMembers: User[];\n+┊  ┊51┊  listingMembers: User[];\n+┊  ┊52┊  actualGroupMembers: User[];\n+┊  ┊53┊  admins?: User[] | null;\n+┊  ┊54┊  owner?: User | null;\n ┊53┊55┊  messages: (Message | null)[];\n-┊54┊  ┊  unreadMessages: number /** Computed property */;\n-┊55┊  ┊  isGroup: boolean /** Computed property */;\n+┊  ┊56┊  messageFeed?: MessageFeed | null;\n+┊  ┊57┊  unreadMessages: number;\n+┊  ┊58┊  isGroup: boolean;\n ┊56┊59┊}\n ┊57┊60┊\n ┊58┊61┊export interface Message {\n```\n```diff\n@@ -60,25 +63,107 @@\n ┊ 60┊ 63┊  sender: User;\n ┊ 61┊ 64┊  chat: Chat;\n ┊ 62┊ 65┊  content: string;\n-┊ 63┊   ┊  createdAt: string;\n-┊ 64┊   ┊  type: number /** FIXME: should return MessageType */;\n-┊ 65┊   ┊  recipients: Recipient[] /** Whoever received the message */;\n-┊ 66┊   ┊  holders: User[] /** Whoever still holds a copy of the message. Cannot be null because the message gets deleted otherwise */;\n-┊ 67┊   ┊  ownership: boolean /** Computed property */;\n+┊   ┊ 66┊  createdAt: Date;\n+┊   ┊ 67┊  type: number;\n+┊   ┊ 68┊  recipients: Recipient[];\n+┊   ┊ 69┊  holders: User[];\n+┊   ┊ 70┊  ownership: boolean;\n ┊ 68┊ 71┊}\n ┊ 69┊ 72┊\n ┊ 70┊ 73┊export interface Recipient {\n ┊ 71┊ 74┊  user: User;\n ┊ 72┊ 75┊  message: Message;\n ┊ 73┊ 76┊  chat: Chat;\n-┊ 74┊   ┊  receivedAt?: string | null;\n-┊ 75┊   ┊  readAt?: string | null;\n+┊   ┊ 77┊  receivedAt?: Date | null;\n+┊   ┊ 78┊  readAt?: Date | null;\n+┊   ┊ 79┊}\n+┊   ┊ 80┊\n+┊   ┊ 81┊export interface MessageFeed {\n+┊   ┊ 82┊  hasNextPage: boolean;\n+┊   ┊ 83┊  cursor?: string | null;\n+┊   ┊ 84┊  messages: (Message | null)[];\n+┊   ┊ 85┊}\n+┊   ┊ 86┊\n+┊   ┊ 87┊export interface Mutation {\n+┊   ┊ 88┊  addChat?: Chat | null;\n+┊   ┊ 89┊  addGroup?: Chat | null;\n+┊   ┊ 90┊  removeChat?: string | null;\n+┊   ┊ 91┊  addMessage?: Message | null;\n+┊   ┊ 92┊  removeMessages?: (string | null)[] | null;\n+┊   ┊ 93┊  addMembers?: (string | null)[] | null;\n+┊   ┊ 94┊  removeMembers?: (string | null)[] | null;\n+┊   ┊ 95┊  addAdmins?: (string | null)[] | null;\n+┊   ┊ 96┊  removeAdmins?: (string | null)[] | null;\n+┊   ┊ 97┊  setGroupName?: string | null;\n+┊   ┊ 98┊  setGroupPicture?: string | null;\n+┊   ┊ 99┊  markAsReceived?: boolean | null;\n+┊   ┊100┊  markAsRead?: boolean | null;\n+┊   ┊101┊}\n+┊   ┊102┊\n+┊   ┊103┊export interface Subscription {\n+┊   ┊104┊  messageAdded?: Message | null;\n+┊   ┊105┊  chatAdded?: Chat | null;\n ┊ 76┊106┊}\n ┊ 77┊107┊export interface ChatQueryArgs {\n ┊ 78┊108┊  chatId: string;\n ┊ 79┊109┊}\n ┊ 80┊110┊export interface MessagesChatArgs {\n ┊ 81┊111┊  amount?: number | null;\n+┊   ┊112┊  before?: string | null;\n+┊   ┊113┊}\n+┊   ┊114┊export interface MessageFeedChatArgs {\n+┊   ┊115┊  amount?: number | null;\n+┊   ┊116┊  before?: string | null;\n+┊   ┊117┊}\n+┊   ┊118┊export interface AddChatMutationArgs {\n+┊   ┊119┊  recipientId: string;\n+┊   ┊120┊}\n+┊   ┊121┊export interface AddGroupMutationArgs {\n+┊   ┊122┊  recipientIds: string[];\n+┊   ┊123┊  groupName: string;\n+┊   ┊124┊}\n+┊   ┊125┊export interface RemoveChatMutationArgs {\n+┊   ┊126┊  chatId: string;\n+┊   ┊127┊}\n+┊   ┊128┊export interface AddMessageMutationArgs {\n+┊   ┊129┊  chatId: string;\n+┊   ┊130┊  content: string;\n+┊   ┊131┊}\n+┊   ┊132┊export interface RemoveMessagesMutationArgs {\n+┊   ┊133┊  chatId: string;\n+┊   ┊134┊  messageIds?: (string | null)[] | null;\n+┊   ┊135┊  all?: boolean | null;\n+┊   ┊136┊}\n+┊   ┊137┊export interface AddMembersMutationArgs {\n+┊   ┊138┊  groupId: string;\n+┊   ┊139┊  userIds: string[];\n+┊   ┊140┊}\n+┊   ┊141┊export interface RemoveMembersMutationArgs {\n+┊   ┊142┊  groupId: string;\n+┊   ┊143┊  userIds: string[];\n+┊   ┊144┊}\n+┊   ┊145┊export interface AddAdminsMutationArgs {\n+┊   ┊146┊  groupId: string;\n+┊   ┊147┊  userIds: string[];\n+┊   ┊148┊}\n+┊   ┊149┊export interface RemoveAdminsMutationArgs {\n+┊   ┊150┊  groupId: string;\n+┊   ┊151┊  userIds: string[];\n+┊   ┊152┊}\n+┊   ┊153┊export interface SetGroupNameMutationArgs {\n+┊   ┊154┊  groupId: string;\n+┊   ┊155┊}\n+┊   ┊156┊export interface SetGroupPictureMutationArgs {\n+┊   ┊157┊  groupId: string;\n+┊   ┊158┊}\n+┊   ┊159┊export interface MarkAsReceivedMutationArgs {\n+┊   ┊160┊  chatId: string;\n+┊   ┊161┊}\n+┊   ┊162┊export interface MarkAsReadMutationArgs {\n+┊   ┊163┊  chatId: string;\n+┊   ┊164┊}\n+┊   ┊165┊export interface MessageAddedSubscriptionArgs {\n+┊   ┊166┊  chatId?: string | null;\n ┊ 82┊167┊}\n ┊ 83┊168┊\n ┊ 84┊169┊export enum MessageType {\n```\n```diff\n@@ -146,41 +231,18 @@\n ┊146┊231┊\n ┊147┊232┊export namespace ChatResolvers {\n ┊148┊233┊  export interface Resolvers<Context = any> {\n-┊149┊   ┊    id?: IdResolver<string, any, Context> /** May be a chat or a group */;\n-┊150┊   ┊    name?: NameResolver<string | null, any, Context> /** Computed for chats */;\n-┊151┊   ┊    picture?: PictureResolver<\n-┊152┊   ┊      string | null,\n-┊153┊   ┊      any,\n-┊154┊   ┊      Context\n-┊155┊   ┊    > /** Computed for chats */;\n-┊156┊   ┊    allTimeMembers?: AllTimeMembersResolver<\n-┊157┊   ┊      User[],\n-┊158┊   ┊      any,\n-┊159┊   ┊      Context\n-┊160┊   ┊    > /** All members, current and past ones. */;\n-┊161┊   ┊    listingMembers?: ListingMembersResolver<\n-┊162┊   ┊      User[],\n-┊163┊   ┊      any,\n-┊164┊   ┊      Context\n-┊165┊   ┊    > /** Whoever gets the chat listed. For groups includes past members who still didn't delete the group. */;\n-┊166┊   ┊    actualGroupMembers?: ActualGroupMembersResolver<\n-┊167┊   ┊      User[],\n-┊168┊   ┊      any,\n-┊169┊   ┊      Context\n-┊170┊   ┊    > /** Actual members of the group (they are not the only ones who get the group listed). Null for chats. */;\n-┊171┊   ┊    admins?: AdminsResolver<User[] | null, any, Context> /** Null for chats */;\n-┊172┊   ┊    owner?: OwnerResolver<\n-┊173┊   ┊      User | null,\n-┊174┊   ┊      any,\n-┊175┊   ┊      Context\n-┊176┊   ┊    > /** If null the group is read-only. Null for chats. */;\n+┊   ┊234┊    id?: IdResolver<string, any, Context>;\n+┊   ┊235┊    name?: NameResolver<string | null, any, Context>;\n+┊   ┊236┊    picture?: PictureResolver<string | null, any, Context>;\n+┊   ┊237┊    allTimeMembers?: AllTimeMembersResolver<User[], any, Context>;\n+┊   ┊238┊    listingMembers?: ListingMembersResolver<User[], any, Context>;\n+┊   ┊239┊    actualGroupMembers?: ActualGroupMembersResolver<User[], any, Context>;\n+┊   ┊240┊    admins?: AdminsResolver<User[] | null, any, Context>;\n+┊   ┊241┊    owner?: OwnerResolver<User | null, any, Context>;\n ┊177┊242┊    messages?: MessagesResolver<(Message | null)[], any, Context>;\n-┊178┊   ┊    unreadMessages?: UnreadMessagesResolver<\n-┊179┊   ┊      number,\n-┊180┊   ┊      any,\n-┊181┊   ┊      Context\n-┊182┊   ┊    > /** Computed property */;\n-┊183┊   ┊    isGroup?: IsGroupResolver<boolean, any, Context> /** Computed property */;\n+┊   ┊243┊    messageFeed?: MessageFeedResolver<MessageFeed | null, any, Context>;\n+┊   ┊244┊    unreadMessages?: UnreadMessagesResolver<number, any, Context>;\n+┊   ┊245┊    isGroup?: IsGroupResolver<boolean, any, Context>;\n ┊184┊246┊  }\n ┊185┊247┊\n ┊186┊248┊  export type IdResolver<R = string, Parent = any, Context = any> = Resolver<\n```\n```diff\n@@ -230,6 +292,17 @@\n ┊230┊292┊  > = Resolver<R, Parent, Context, MessagesArgs>;\n ┊231┊293┊  export interface MessagesArgs {\n ┊232┊294┊    amount?: number | null;\n+┊   ┊295┊    before?: string | null;\n+┊   ┊296┊  }\n+┊   ┊297┊\n+┊   ┊298┊  export type MessageFeedResolver<\n+┊   ┊299┊    R = MessageFeed | null,\n+┊   ┊300┊    Parent = any,\n+┊   ┊301┊    Context = any\n+┊   ┊302┊  > = Resolver<R, Parent, Context, MessageFeedArgs>;\n+┊   ┊303┊  export interface MessageFeedArgs {\n+┊   ┊304┊    amount?: number | null;\n+┊   ┊305┊    before?: string | null;\n ┊233┊306┊  }\n ┊234┊307┊\n ┊235┊308┊  export type UnreadMessagesResolver<\n```\n```diff\n@@ -250,27 +323,11 @@\n ┊250┊323┊    sender?: SenderResolver<User, any, Context>;\n ┊251┊324┊    chat?: ChatResolver<Chat, any, Context>;\n ┊252┊325┊    content?: ContentResolver<string, any, Context>;\n-┊253┊   ┊    createdAt?: CreatedAtResolver<string, any, Context>;\n-┊254┊   ┊    type?: TypeResolver<\n-┊255┊   ┊      number,\n-┊256┊   ┊      any,\n-┊257┊   ┊      Context\n-┊258┊   ┊    > /** FIXME: should return MessageType */;\n-┊259┊   ┊    recipients?: RecipientsResolver<\n-┊260┊   ┊      Recipient[],\n-┊261┊   ┊      any,\n-┊262┊   ┊      Context\n-┊263┊   ┊    > /** Whoever received the message */;\n-┊264┊   ┊    holders?: HoldersResolver<\n-┊265┊   ┊      User[],\n-┊266┊   ┊      any,\n-┊267┊   ┊      Context\n-┊268┊   ┊    > /** Whoever still holds a copy of the message. Cannot be null because the message gets deleted otherwise */;\n-┊269┊   ┊    ownership?: OwnershipResolver<\n-┊270┊   ┊      boolean,\n-┊271┊   ┊      any,\n-┊272┊   ┊      Context\n-┊273┊   ┊    > /** Computed property */;\n+┊   ┊326┊    createdAt?: CreatedAtResolver<Date, any, Context>;\n+┊   ┊327┊    type?: TypeResolver<number, any, Context>;\n+┊   ┊328┊    recipients?: RecipientsResolver<Recipient[], any, Context>;\n+┊   ┊329┊    holders?: HoldersResolver<User[], any, Context>;\n+┊   ┊330┊    ownership?: OwnershipResolver<boolean, any, Context>;\n ┊274┊331┊  }\n ┊275┊332┊\n ┊276┊333┊  export type IdResolver<R = string, Parent = any, Context = any> = Resolver<\n```\n```diff\n@@ -294,7 +351,7 @@\n ┊294┊351┊    Context = any\n ┊295┊352┊  > = Resolver<R, Parent, Context>;\n ┊296┊353┊  export type CreatedAtResolver<\n-┊297┊   ┊    R = string,\n+┊   ┊354┊    R = Date,\n ┊298┊355┊    Parent = any,\n ┊299┊356┊    Context = any\n ┊300┊357┊  > = Resolver<R, Parent, Context>;\n```\n```diff\n@@ -325,8 +382,8 @@\n ┊325┊382┊    user?: UserResolver<User, any, Context>;\n ┊326┊383┊    message?: MessageResolver<Message, any, Context>;\n ┊327┊384┊    chat?: ChatResolver<Chat, any, Context>;\n-┊328┊   ┊    receivedAt?: ReceivedAtResolver<string | null, any, Context>;\n-┊329┊   ┊    readAt?: ReadAtResolver<string | null, any, Context>;\n+┊   ┊385┊    receivedAt?: ReceivedAtResolver<Date | null, any, Context>;\n+┊   ┊386┊    readAt?: ReadAtResolver<Date | null, any, Context>;\n ┊330┊387┊  }\n ┊331┊388┊\n ┊332┊389┊  export type UserResolver<R = User, Parent = any, Context = any> = Resolver<\n```\n```diff\n@@ -345,14 +402,211 @@\n ┊345┊402┊    Context\n ┊346┊403┊  >;\n ┊347┊404┊  export type ReceivedAtResolver<\n-┊348┊   ┊    R = string | null,\n+┊   ┊405┊    R = Date | null,\n ┊349┊406┊    Parent = any,\n ┊350┊407┊    Context = any\n ┊351┊408┊  > = Resolver<R, Parent, Context>;\n ┊352┊409┊  export type ReadAtResolver<\n+┊   ┊410┊    R = Date | null,\n+┊   ┊411┊    Parent = any,\n+┊   ┊412┊    Context = any\n+┊   ┊413┊  > = Resolver<R, Parent, Context>;\n+┊   ┊414┊}\n+┊   ┊415┊\n+┊   ┊416┊export namespace MessageFeedResolvers {\n+┊   ┊417┊  export interface Resolvers<Context = any> {\n+┊   ┊418┊    hasNextPage?: HasNextPageResolver<boolean, any, Context>;\n+┊   ┊419┊    cursor?: CursorResolver<string | null, any, Context>;\n+┊   ┊420┊    messages?: MessagesResolver<(Message | null)[], any, Context>;\n+┊   ┊421┊  }\n+┊   ┊422┊\n+┊   ┊423┊  export type HasNextPageResolver<\n+┊   ┊424┊    R = boolean,\n+┊   ┊425┊    Parent = any,\n+┊   ┊426┊    Context = any\n+┊   ┊427┊  > = Resolver<R, Parent, Context>;\n+┊   ┊428┊  export type CursorResolver<\n+┊   ┊429┊    R = string | null,\n+┊   ┊430┊    Parent = any,\n+┊   ┊431┊    Context = any\n+┊   ┊432┊  > = Resolver<R, Parent, Context>;\n+┊   ┊433┊  export type MessagesResolver<\n+┊   ┊434┊    R = (Message | null)[],\n+┊   ┊435┊    Parent = any,\n+┊   ┊436┊    Context = any\n+┊   ┊437┊  > = Resolver<R, Parent, Context>;\n+┊   ┊438┊}\n+┊   ┊439┊\n+┊   ┊440┊export namespace MutationResolvers {\n+┊   ┊441┊  export interface Resolvers<Context = any> {\n+┊   ┊442┊    addChat?: AddChatResolver<Chat | null, any, Context>;\n+┊   ┊443┊    addGroup?: AddGroupResolver<Chat | null, any, Context>;\n+┊   ┊444┊    removeChat?: RemoveChatResolver<string | null, any, Context>;\n+┊   ┊445┊    addMessage?: AddMessageResolver<Message | null, any, Context>;\n+┊   ┊446┊    removeMessages?: RemoveMessagesResolver<\n+┊   ┊447┊      (string | null)[] | null,\n+┊   ┊448┊      any,\n+┊   ┊449┊      Context\n+┊   ┊450┊    >;\n+┊   ┊451┊    addMembers?: AddMembersResolver<(string | null)[] | null, any, Context>;\n+┊   ┊452┊    removeMembers?: RemoveMembersResolver<\n+┊   ┊453┊      (string | null)[] | null,\n+┊   ┊454┊      any,\n+┊   ┊455┊      Context\n+┊   ┊456┊    >;\n+┊   ┊457┊    addAdmins?: AddAdminsResolver<(string | null)[] | null, any, Context>;\n+┊   ┊458┊    removeAdmins?: RemoveAdminsResolver<(string | null)[] | null, any, Context>;\n+┊   ┊459┊    setGroupName?: SetGroupNameResolver<string | null, any, Context>;\n+┊   ┊460┊    setGroupPicture?: SetGroupPictureResolver<string | null, any, Context>;\n+┊   ┊461┊    markAsReceived?: MarkAsReceivedResolver<boolean | null, any, Context>;\n+┊   ┊462┊    markAsRead?: MarkAsReadResolver<boolean | null, any, Context>;\n+┊   ┊463┊  }\n+┊   ┊464┊\n+┊   ┊465┊  export type AddChatResolver<\n+┊   ┊466┊    R = Chat | null,\n+┊   ┊467┊    Parent = any,\n+┊   ┊468┊    Context = any\n+┊   ┊469┊  > = Resolver<R, Parent, Context, AddChatArgs>;\n+┊   ┊470┊  export interface AddChatArgs {\n+┊   ┊471┊    recipientId: string;\n+┊   ┊472┊  }\n+┊   ┊473┊\n+┊   ┊474┊  export type AddGroupResolver<\n+┊   ┊475┊    R = Chat | null,\n+┊   ┊476┊    Parent = any,\n+┊   ┊477┊    Context = any\n+┊   ┊478┊  > = Resolver<R, Parent, Context, AddGroupArgs>;\n+┊   ┊479┊  export interface AddGroupArgs {\n+┊   ┊480┊    recipientIds: string[];\n+┊   ┊481┊    groupName: string;\n+┊   ┊482┊  }\n+┊   ┊483┊\n+┊   ┊484┊  export type RemoveChatResolver<\n+┊   ┊485┊    R = string | null,\n+┊   ┊486┊    Parent = any,\n+┊   ┊487┊    Context = any\n+┊   ┊488┊  > = Resolver<R, Parent, Context, RemoveChatArgs>;\n+┊   ┊489┊  export interface RemoveChatArgs {\n+┊   ┊490┊    chatId: string;\n+┊   ┊491┊  }\n+┊   ┊492┊\n+┊   ┊493┊  export type AddMessageResolver<\n+┊   ┊494┊    R = Message | null,\n+┊   ┊495┊    Parent = any,\n+┊   ┊496┊    Context = any\n+┊   ┊497┊  > = Resolver<R, Parent, Context, AddMessageArgs>;\n+┊   ┊498┊  export interface AddMessageArgs {\n+┊   ┊499┊    chatId: string;\n+┊   ┊500┊    content: string;\n+┊   ┊501┊  }\n+┊   ┊502┊\n+┊   ┊503┊  export type RemoveMessagesResolver<\n+┊   ┊504┊    R = (string | null)[] | null,\n+┊   ┊505┊    Parent = any,\n+┊   ┊506┊    Context = any\n+┊   ┊507┊  > = Resolver<R, Parent, Context, RemoveMessagesArgs>;\n+┊   ┊508┊  export interface RemoveMessagesArgs {\n+┊   ┊509┊    chatId: string;\n+┊   ┊510┊    messageIds?: (string | null)[] | null;\n+┊   ┊511┊    all?: boolean | null;\n+┊   ┊512┊  }\n+┊   ┊513┊\n+┊   ┊514┊  export type AddMembersResolver<\n+┊   ┊515┊    R = (string | null)[] | null,\n+┊   ┊516┊    Parent = any,\n+┊   ┊517┊    Context = any\n+┊   ┊518┊  > = Resolver<R, Parent, Context, AddMembersArgs>;\n+┊   ┊519┊  export interface AddMembersArgs {\n+┊   ┊520┊    groupId: string;\n+┊   ┊521┊    userIds: string[];\n+┊   ┊522┊  }\n+┊   ┊523┊\n+┊   ┊524┊  export type RemoveMembersResolver<\n+┊   ┊525┊    R = (string | null)[] | null,\n+┊   ┊526┊    Parent = any,\n+┊   ┊527┊    Context = any\n+┊   ┊528┊  > = Resolver<R, Parent, Context, RemoveMembersArgs>;\n+┊   ┊529┊  export interface RemoveMembersArgs {\n+┊   ┊530┊    groupId: string;\n+┊   ┊531┊    userIds: string[];\n+┊   ┊532┊  }\n+┊   ┊533┊\n+┊   ┊534┊  export type AddAdminsResolver<\n+┊   ┊535┊    R = (string | null)[] | null,\n+┊   ┊536┊    Parent = any,\n+┊   ┊537┊    Context = any\n+┊   ┊538┊  > = Resolver<R, Parent, Context, AddAdminsArgs>;\n+┊   ┊539┊  export interface AddAdminsArgs {\n+┊   ┊540┊    groupId: string;\n+┊   ┊541┊    userIds: string[];\n+┊   ┊542┊  }\n+┊   ┊543┊\n+┊   ┊544┊  export type RemoveAdminsResolver<\n+┊   ┊545┊    R = (string | null)[] | null,\n+┊   ┊546┊    Parent = any,\n+┊   ┊547┊    Context = any\n+┊   ┊548┊  > = Resolver<R, Parent, Context, RemoveAdminsArgs>;\n+┊   ┊549┊  export interface RemoveAdminsArgs {\n+┊   ┊550┊    groupId: string;\n+┊   ┊551┊    userIds: string[];\n+┊   ┊552┊  }\n+┊   ┊553┊\n+┊   ┊554┊  export type SetGroupNameResolver<\n+┊   ┊555┊    R = string | null,\n+┊   ┊556┊    Parent = any,\n+┊   ┊557┊    Context = any\n+┊   ┊558┊  > = Resolver<R, Parent, Context, SetGroupNameArgs>;\n+┊   ┊559┊  export interface SetGroupNameArgs {\n+┊   ┊560┊    groupId: string;\n+┊   ┊561┊  }\n+┊   ┊562┊\n+┊   ┊563┊  export type SetGroupPictureResolver<\n ┊353┊564┊    R = string | null,\n ┊354┊565┊    Parent = any,\n ┊355┊566┊    Context = any\n+┊   ┊567┊  > = Resolver<R, Parent, Context, SetGroupPictureArgs>;\n+┊   ┊568┊  export interface SetGroupPictureArgs {\n+┊   ┊569┊    groupId: string;\n+┊   ┊570┊  }\n+┊   ┊571┊\n+┊   ┊572┊  export type MarkAsReceivedResolver<\n+┊   ┊573┊    R = boolean | null,\n+┊   ┊574┊    Parent = any,\n+┊   ┊575┊    Context = any\n+┊   ┊576┊  > = Resolver<R, Parent, Context, MarkAsReceivedArgs>;\n+┊   ┊577┊  export interface MarkAsReceivedArgs {\n+┊   ┊578┊    chatId: string;\n+┊   ┊579┊  }\n+┊   ┊580┊\n+┊   ┊581┊  export type MarkAsReadResolver<\n+┊   ┊582┊    R = boolean | null,\n+┊   ┊583┊    Parent = any,\n+┊   ┊584┊    Context = any\n+┊   ┊585┊  > = Resolver<R, Parent, Context, MarkAsReadArgs>;\n+┊   ┊586┊  export interface MarkAsReadArgs {\n+┊   ┊587┊    chatId: string;\n+┊   ┊588┊  }\n+┊   ┊589┊}\n+┊   ┊590┊\n+┊   ┊591┊export namespace SubscriptionResolvers {\n+┊   ┊592┊  export interface Resolvers<Context = any> {\n+┊   ┊593┊    messageAdded?: MessageAddedResolver<Message | null, any, Context>;\n+┊   ┊594┊    chatAdded?: ChatAddedResolver<Chat | null, any, Context>;\n+┊   ┊595┊  }\n+┊   ┊596┊\n+┊   ┊597┊  export type MessageAddedResolver<\n+┊   ┊598┊    R = Message | null,\n+┊   ┊599┊    Parent = any,\n+┊   ┊600┊    Context = any\n+┊   ┊601┊  > = Resolver<R, Parent, Context, MessageAddedArgs>;\n+┊   ┊602┊  export interface MessageAddedArgs {\n+┊   ┊603┊    chatId?: string | null;\n+┊   ┊604┊  }\n+┊   ┊605┊\n+┊   ┊606┊  export type ChatAddedResolver<\n+┊   ┊607┊    R = Chat | null,\n+┊   ┊608┊    Parent = any,\n+┊   ┊609┊    Context = any\n ┊356┊610┊  > = Resolver<R, Parent, Context>;\n ┊357┊611┊}\n ┊358┊612┊\n```\n```diff\n@@ -398,7 +652,7 @@\n ┊398┊652┊    chat: Chat;\n ┊399┊653┊    sender: Sender;\n ┊400┊654┊    content: string;\n-┊401┊   ┊    createdAt: string;\n+┊   ┊655┊    createdAt: Date;\n ┊402┊656┊    type: number;\n ┊403┊657┊    recipients: Recipients[];\n ┊404┊658┊    ownership: boolean;\n```\n```diff\n@@ -420,8 +674,8 @@\n ┊420┊674┊    user: User;\n ┊421┊675┊    message: Message;\n ┊422┊676┊    chat: __Chat;\n-┊423┊   ┊    receivedAt?: string | null;\n-┊424┊   ┊    readAt?: string | null;\n+┊   ┊677┊    receivedAt?: Date | null;\n+┊   ┊678┊    readAt?: Date | null;\n ┊425┊679┊  };\n ┊426┊680┊\n ┊427┊681┊  export type User = {\n```\n```diff\n@@ -445,3 +699,77 @@\n ┊445┊699┊    id: string;\n ┊446┊700┊  };\n ┊447┊701┊}\n+┊   ┊702┊\n+┊   ┊703┊import { Injectable } from \"@angular/core\";\n+┊   ┊704┊\n+┊   ┊705┊import * as Apollo from \"apollo-angular\";\n+┊   ┊706┊\n+┊   ┊707┊import gql from \"graphql-tag\";\n+┊   ┊708┊\n+┊   ┊709┊const ChatWithoutMessagesFragment = gql`\n+┊   ┊710┊  fragment ChatWithoutMessages on Chat {\n+┊   ┊711┊    id\n+┊   ┊712┊    name\n+┊   ┊713┊    picture\n+┊   ┊714┊    allTimeMembers {\n+┊   ┊715┊      id\n+┊   ┊716┊    }\n+┊   ┊717┊    unreadMessages\n+┊   ┊718┊    isGroup\n+┊   ┊719┊  }\n+┊   ┊720┊`;\n+┊   ┊721┊\n+┊   ┊722┊const MessageFragment = gql`\n+┊   ┊723┊  fragment Message on Message {\n+┊   ┊724┊    id\n+┊   ┊725┊    chat {\n+┊   ┊726┊      id\n+┊   ┊727┊    }\n+┊   ┊728┊    sender {\n+┊   ┊729┊      id\n+┊   ┊730┊      name\n+┊   ┊731┊    }\n+┊   ┊732┊    content\n+┊   ┊733┊    createdAt\n+┊   ┊734┊    type\n+┊   ┊735┊    recipients {\n+┊   ┊736┊      user {\n+┊   ┊737┊        id\n+┊   ┊738┊      }\n+┊   ┊739┊      message {\n+┊   ┊740┊        id\n+┊   ┊741┊        chat {\n+┊   ┊742┊          id\n+┊   ┊743┊        }\n+┊   ┊744┊      }\n+┊   ┊745┊      chat {\n+┊   ┊746┊        id\n+┊   ┊747┊      }\n+┊   ┊748┊      receivedAt\n+┊   ┊749┊      readAt\n+┊   ┊750┊    }\n+┊   ┊751┊    ownership\n+┊   ┊752┊  }\n+┊   ┊753┊`;\n+┊   ┊754┊\n+┊   ┊755┊@Injectable({\n+┊   ┊756┊  providedIn: \"root\"\n+┊   ┊757┊})\n+┊   ┊758┊export class GetChatsGQL extends Apollo.Query<\n+┊   ┊759┊  GetChats.Query,\n+┊   ┊760┊  GetChats.Variables\n+┊   ┊761┊> {\n+┊   ┊762┊  document: any = gql`\n+┊   ┊763┊    query GetChats($amount: Int) {\n+┊   ┊764┊      chats {\n+┊   ┊765┊        ...ChatWithoutMessages\n+┊   ┊766┊        messages(amount: $amount) {\n+┊   ┊767┊          ...Message\n+┊   ┊768┊        }\n+┊   ┊769┊      }\n+┊   ┊770┊    }\n+┊   ┊771┊\n+┊   ┊772┊    ${ChatWithoutMessagesFragment}\n+┊   ┊773┊    ${MessageFragment}\n+┊   ┊774┊  `;\n+┊   ┊775┊}\n```\n\n[}]: #\n\nThe Apollo Angular template generates a ready to use in your component, strongly typed Angular services, for every defined query, mutation or subscription.\n\nIt's possible thanks to the new API of Apollo Angular. More on that in [\"Query, Mutation, Subscription services\"](http://apollographql.com/docs/angular/basics/services.html?_ga=2.227615197.1327014552.1538988114-793224955.1532981447) chapter of the documentation.\n\nGiven an example:\n\n```graphql\nquery GetChats($amount: Int) {\n  chats {\n    ...ChatWithoutMessages\n    messages(amount: $amount) {\n      ...Message\n    }\n  }\n}\n```\n\nThe Apollo Angular template, after you run `yarn generate`, outputs a service called `GetChatsGQL`:\n\n```typescript\nimport { GetChatsGQL, GetChats } from '../graphql';\n\nexport class AppComponent {\n  constructor(private getChatsGQL: GetChatsGQL) {}\n\n  getChats(): GetChats.Chats[] {\n    return this.getChatsGQL\n      .watch({\n        amount: 10,\n      })\n      .valueChanges.pipe(map(result => result.data.chats));\n  }\n}\n```\n\n> Remember, every operation should has an unique name.\n\nIt might look a bit different then what you have already learnt but we promise, the API is even easier.\n\nBut first, let's dive into how those services look like under the hood.\n\n```typescript\nimport { Query } from 'apollo-angular';\n\n@Injectable({\n  providedIn: 'root',\n})\nexport class GetChatsGQL extends Query<GetChats.Query, GetChats.Variables> {\n  document = gql`\n    here goes the document\n  `;\n}\n```\n\nOkay, seems easy but what is the `Query` class, you might ask!\n\nApollo Angular exposes three classes for three kinds of the GraphQL operation: `Query`, `Mutation` and `Subscription`. Each of them has a different API.\n\n- `Query` has `fetch` and `watch`. First one behave like `Apollo.query()`, second one like `Apollo.watchQuery()`\n- `Mutation` has `mutate`\n- `Subscription` has `subscribe`\n\nBecause the `document` is already defined in a class, they all accept two arguments (Subscription has third one). First argument defines variables, second shapes the options. Thats why we used `this.getChatsGQL.watch({ amount: 10 })`.\n\nLet's stop talking about the API itself and see what benefits it brings us:\n\n- **Less code to write** - no need to create a network call, no need to create Typescript typings, no need to create a dedicated Angular service\n- **Strongly typed out of the box — all** types are being generated, no need to write any Typescript definitions and struggle to keep them updated\n- _More pleasent API_ to work with\n- **Full developer experience of tools and IDEs**  —  development time, autocomplete and error checking, not only across your frontend app but also with your API teams!\n- **Tree-shakable** thanks to Angular 6\n\nMost IDEs with the GraphQL support (built-in or thanks to extensions) fully handles `.graphql` files and helps you with features like auto-completion, validation but they strugle with `gql` tag. To fully enjoy GraphQL we highly recommend to use static `.graphql` files.\n\nWith all that knowledge, let's use GQL services in our application:\n\n[{]: <helper> (diffStep \"2.4\" files=\"src/app/services/chats.service.ts\" module=\"client\")\n\n#### [Step 2.4: Use auto-generated GQL services](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/c0eddd1)\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,21 +1,18 @@\n ┊ 1┊ 1┊import {map} from 'rxjs/operators';\n-┊ 2┊  ┊import {Apollo} from 'apollo-angular';\n ┊ 3┊ 2┊import {Injectable} from '@angular/core';\n-┊ 4┊  ┊import {getChatsQuery} from '../../graphql/getChats.query';\n-┊ 5┊  ┊import {GetChats} from '../../graphql';\n+┊  ┊ 3┊import {GetChatsGQL} from '../../graphql';\n ┊ 6┊ 4┊\n ┊ 7┊ 5┊@Injectable()\n ┊ 8┊ 6┊export class ChatsService {\n ┊ 9┊ 7┊  messagesAmount = 3;\n ┊10┊ 8┊\n-┊11┊  ┊  constructor(private apollo: Apollo) {}\n+┊  ┊ 9┊  constructor(\n+┊  ┊10┊    private getChatsGQL: GetChatsGQL\n+┊  ┊11┊  ) {}\n ┊12┊12┊\n ┊13┊13┊  getChats() {\n-┊14┊  ┊    const query = this.apollo.watchQuery<GetChats.Query>({\n-┊15┊  ┊      query: getChatsQuery,\n-┊16┊  ┊      variables: {\n-┊17┊  ┊        amount: this.messagesAmount,\n-┊18┊  ┊      },\n+┊  ┊14┊    const query = this.getChatsGQL.watch({\n+┊  ┊15┊      amount: this.messagesAmount,\n ┊19┊16┊    });\n ┊20┊17┊    const chats$ = query.valueChanges.pipe(\n ┊21┊18┊      map((result) => result.data.chats)\n```\n\n[}]: #"
          },
          {
            "manualTitle": "Step 7: Testing",
            "stepRevision": "1faa6c13bf9f48f94f7b027bea9c8277612be7ec",
            "manualView": "## Client\n\nTesting is a very important part of each application and for the sake of showing different testing techniques we are going to show how to test a presentational component, a container component and a service.\n\nFirst let's start by importing `hammerjs` for the Material Gestures inside the test script.\n\n[{]: <helper> (diffStep \"3.1\" files=\"src/test.ts\" module=\"client\")\n\n#### [Step 3.1: Testing](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/b76d15b)\n\n##### Changed src&#x2F;test.ts\n```diff\n@@ -7,6 +7,9 @@\n ┊ 7┊ 7┊  platformBrowserDynamicTesting\n ┊ 8┊ 8┊} from '@angular/platform-browser-dynamic/testing';\n ┊ 9┊ 9┊\n+┊  ┊10┊// Material gestures\n+┊  ┊11┊import 'hammerjs';\n+┊  ┊12┊\n ┊10┊13┊declare const require: any;\n ┊11┊14┊\n ┊12┊15┊// First, initialize the Angular testing environment.\n```\n\n[}]: #\n\n### Testing a Presentional Component\n\nLet's start with the simplest one: the presentational component.\nWe are not going to inject any service and we don't need to access our backend, so things are quite simple: we just need to pass our Chat object as an Input, detect the changes and use the query selector to match the UI content to the one we passed as input:\n\n[{]: <helper> (diffStep \"3.1\" files=\"src/app/chats-lister/components/chat-item/chat-item.component.spec.ts\" module=\"client\")\n\n#### [Step 3.1: Testing](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/b76d15b)\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chat-item&#x2F;chat-item.component.spec.ts\n```diff\n@@ -0,0 +1,107 @@\n+┊   ┊  1┊import { async, ComponentFixture, TestBed } from '@angular/core/testing';\n+┊   ┊  2┊\n+┊   ┊  3┊import { ChatItemComponent } from './chat-item.component';\n+┊   ┊  4┊import {DebugElement} from '@angular/core';\n+┊   ┊  5┊import {By} from '@angular/platform-browser';\n+┊   ┊  6┊import {TruncateModule} from 'ng2-truncate';\n+┊   ┊  7┊\n+┊   ┊  8┊describe('ChatItemComponent', () => {\n+┊   ┊  9┊  let component: ChatItemComponent;\n+┊   ┊ 10┊  let fixture: ComponentFixture<ChatItemComponent>;\n+┊   ┊ 11┊  let el: DebugElement;\n+┊   ┊ 12┊\n+┊   ┊ 13┊  const chat: any = {\n+┊   ┊ 14┊    id: '1',\n+┊   ┊ 15┊    __typename: 'Chat',\n+┊   ┊ 16┊    name: 'Niccolo\\' Belli',\n+┊   ┊ 17┊    picture: null,\n+┊   ┊ 18┊    allTimeMembers: [\n+┊   ┊ 19┊      {\n+┊   ┊ 20┊        id: '1',\n+┊   ┊ 21┊        __typename: 'User',\n+┊   ┊ 22┊      },\n+┊   ┊ 23┊      {\n+┊   ┊ 24┊        id: '2',\n+┊   ┊ 25┊        __typename: 'User',\n+┊   ┊ 26┊      }\n+┊   ┊ 27┊    ],\n+┊   ┊ 28┊    unreadMessages: 0,\n+┊   ┊ 29┊    isGroup: false,\n+┊   ┊ 30┊    messages: [\n+┊   ┊ 31┊      {\n+┊   ┊ 32┊        id: '1',\n+┊   ┊ 33┊        chat: {\n+┊   ┊ 34┊          id: '1',\n+┊   ┊ 35┊          __typename: 'Chat',\n+┊   ┊ 36┊        },\n+┊   ┊ 37┊        __typename: 'Message',\n+┊   ┊ 38┊        sender: {\n+┊   ┊ 39┊          id: '1',\n+┊   ┊ 40┊          __typename: 'User',\n+┊   ┊ 41┊          name: 'Niccolo\\' Belli',\n+┊   ┊ 42┊        },\n+┊   ┊ 43┊        content: 'Hello! How are you? A lot happened since last time',\n+┊   ┊ 44┊        createdAt: '1513435525',\n+┊   ┊ 45┊        type: 1,\n+┊   ┊ 46┊        recipients: [\n+┊   ┊ 47┊          {\n+┊   ┊ 48┊            user: {\n+┊   ┊ 49┊              id: '2',\n+┊   ┊ 50┊              __typename: 'User',\n+┊   ┊ 51┊            },\n+┊   ┊ 52┊            message: {\n+┊   ┊ 53┊              id: '1',\n+┊   ┊ 54┊              __typename: 'Message',\n+┊   ┊ 55┊              chat: {\n+┊   ┊ 56┊                id: '1',\n+┊   ┊ 57┊                __typename: 'Chat',\n+┊   ┊ 58┊              },\n+┊   ┊ 59┊            },\n+┊   ┊ 60┊            __typename: 'Recipient',\n+┊   ┊ 61┊            chat: {\n+┊   ┊ 62┊              id: '1',\n+┊   ┊ 63┊              __typename: 'Chat',\n+┊   ┊ 64┊            },\n+┊   ┊ 65┊            receivedAt: null,\n+┊   ┊ 66┊            readAt: null,\n+┊   ┊ 67┊          }\n+┊   ┊ 68┊        ],\n+┊   ┊ 69┊        ownership: true,\n+┊   ┊ 70┊      }\n+┊   ┊ 71┊    ],\n+┊   ┊ 72┊  };\n+┊   ┊ 73┊\n+┊   ┊ 74┊  beforeEach(async(() => {\n+┊   ┊ 75┊    TestBed.configureTestingModule({\n+┊   ┊ 76┊      declarations: [ ChatItemComponent ],\n+┊   ┊ 77┊      imports: [TruncateModule]\n+┊   ┊ 78┊    })\n+┊   ┊ 79┊    .compileComponents();\n+┊   ┊ 80┊  }));\n+┊   ┊ 81┊\n+┊   ┊ 82┊  beforeEach(() => {\n+┊   ┊ 83┊    fixture = TestBed.createComponent(ChatItemComponent);\n+┊   ┊ 84┊    component = fixture.componentInstance;\n+┊   ┊ 85┊    component.chat = chat;\n+┊   ┊ 86┊    fixture.detectChanges();\n+┊   ┊ 87┊    el = fixture.debugElement;\n+┊   ┊ 88┊  });\n+┊   ┊ 89┊\n+┊   ┊ 90┊  it('should create', () => {\n+┊   ┊ 91┊    expect(component).toBeTruthy();\n+┊   ┊ 92┊  });\n+┊   ┊ 93┊\n+┊   ┊ 94┊  it('should contain the chat name', () => {\n+┊   ┊ 95┊    expect(el.query(By.css('.chat-recipient > div:first-child')).nativeElement.textContent).toContain(chat.name);\n+┊   ┊ 96┊  });\n+┊   ┊ 97┊\n+┊   ┊ 98┊  it('should contain the first couple of characters of the message content', () => {\n+┊   ┊ 99┊    expect(el.query(By.css('.chat-content')).nativeElement.textContent)\n+┊   ┊100┊      .toContain(chat.messages[chat.messages.length - 1].content.slice(0, 20));\n+┊   ┊101┊  });\n+┊   ┊102┊\n+┊   ┊103┊  it('should not contain the latest characters of the message content', () => {\n+┊   ┊104┊    expect(el.query(By.css('.chat-content')).nativeElement.textContent)\n+┊   ┊105┊      .not.toContain(chat.messages[chat.messages.length - 1].content.slice(20));\n+┊   ┊106┊  });\n+┊   ┊107┊});\n```\n\n[}]: #\n\n### Testing a Service\n\nTesting a service is a bit more complicated because we will need to mock our backend in order to get fake results instead of having to fire up the backend each time.\n\nWe could simply simply mock the HTTP calls, which is a well known practice in the REST API world. Since we are using HTTP to retrieve the data, it would work as well with our Apollo Client setup.\n\n#### Testing with Apollo Angular\n\nBecause Apollo Angular provides its own testing utilities, let's bring them in!\n\nAlthough `apollo-angular` has a lot going on under the hood, the library provides multiple tools for testing that simplify those abstractions, and allows complete focus on the component logic.\n\nThe `apollo-angular/testing` module exports a `ApolloTestingModule` module and `ApolloTestingController` service which simplifies the testing of Angular components by mocking calls to the GraphQL endpoint. This allows the tests to be run in isolation and provides consistent results on every run by removing the dependence on remote data.\n\nBy using this `ApolloTestingController` service, it’s possible to specify the exact results that should be returned for a certain query.\n\nWorth mentioning, `ApolloTestingModule` comes with a default cache but you can use your own with `APOLLO_TESTING_CACHE` token.\n\nLet's show everything on an example:\n\n[{]: <helper> (diffStep \"3.1\" files=\"src/app/services/chats.service.spec.ts\" module=\"client\")\n\n#### [Step 3.1: Testing](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/b76d15b)\n\n##### Added src&#x2F;app&#x2F;services&#x2F;chats.service.spec.ts\n```diff\n@@ -0,0 +1,352 @@\n+┊   ┊  1┊import { TestBed, inject } from '@angular/core/testing';\n+┊   ┊  2┊\n+┊   ┊  3┊import { Apollo } from 'apollo-angular';\n+┊   ┊  4┊import {\n+┊   ┊  5┊  ApolloTestingModule,\n+┊   ┊  6┊  ApolloTestingController,\n+┊   ┊  7┊  APOLLO_TESTING_CACHE,\n+┊   ┊  8┊} from 'apollo-angular/testing';\n+┊   ┊  9┊import { InMemoryCache } from 'apollo-cache-inmemory';\n+┊   ┊ 10┊\n+┊   ┊ 11┊import { GetChats } from '../../graphql';\n+┊   ┊ 12┊import { dataIdFromObject } from '../graphql.module';\n+┊   ┊ 13┊import { ChatsService } from './chats.service';\n+┊   ┊ 14┊\n+┊   ┊ 15┊describe('ChatsService', () => {\n+┊   ┊ 16┊  let controller: ApolloTestingController;\n+┊   ┊ 17┊  let apollo: Apollo;\n+┊   ┊ 18┊\n+┊   ┊ 19┊  const chats: GetChats.Chats[] = [\n+┊   ┊ 20┊    {\n+┊   ┊ 21┊      id: '1',\n+┊   ┊ 22┊      __typename: 'Chat',\n+┊   ┊ 23┊      name: 'Avery Stewart',\n+┊   ┊ 24┊      picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n+┊   ┊ 25┊      allTimeMembers: [\n+┊   ┊ 26┊        {\n+┊   ┊ 27┊          id: '1',\n+┊   ┊ 28┊          __typename: 'User',\n+┊   ┊ 29┊        },\n+┊   ┊ 30┊        {\n+┊   ┊ 31┊          id: '3',\n+┊   ┊ 32┊          __typename: 'User',\n+┊   ┊ 33┊        },\n+┊   ┊ 34┊      ],\n+┊   ┊ 35┊      unreadMessages: 1,\n+┊   ┊ 36┊      isGroup: false,\n+┊   ┊ 37┊      messages: [\n+┊   ┊ 38┊        {\n+┊   ┊ 39┊          id: '1',\n+┊   ┊ 40┊          chat: {\n+┊   ┊ 41┊            id: '1',\n+┊   ┊ 42┊            __typename: 'Chat',\n+┊   ┊ 43┊          },\n+┊   ┊ 44┊          __typename: 'Message',\n+┊   ┊ 45┊          sender: {\n+┊   ┊ 46┊            id: '3',\n+┊   ┊ 47┊            __typename: 'User',\n+┊   ┊ 48┊            name: 'Avery Stewart',\n+┊   ┊ 49┊          },\n+┊   ┊ 50┊          content: 'Yep!',\n+┊   ┊ 51┊          createdAt: '1514035700',\n+┊   ┊ 52┊          type: 0,\n+┊   ┊ 53┊          recipients: [\n+┊   ┊ 54┊            {\n+┊   ┊ 55┊              user: {\n+┊   ┊ 56┊                id: '1',\n+┊   ┊ 57┊                __typename: 'User',\n+┊   ┊ 58┊              },\n+┊   ┊ 59┊              message: {\n+┊   ┊ 60┊                id: '1',\n+┊   ┊ 61┊                __typename: 'Message',\n+┊   ┊ 62┊                chat: {\n+┊   ┊ 63┊                  id: '1',\n+┊   ┊ 64┊                  __typename: 'Chat',\n+┊   ┊ 65┊                },\n+┊   ┊ 66┊              },\n+┊   ┊ 67┊              __typename: 'Recipient',\n+┊   ┊ 68┊              chat: {\n+┊   ┊ 69┊                id: '1',\n+┊   ┊ 70┊                __typename: 'Chat',\n+┊   ┊ 71┊              },\n+┊   ┊ 72┊              receivedAt: null,\n+┊   ┊ 73┊              readAt: null,\n+┊   ┊ 74┊            },\n+┊   ┊ 75┊          ],\n+┊   ┊ 76┊          ownership: false,\n+┊   ┊ 77┊        },\n+┊   ┊ 78┊      ],\n+┊   ┊ 79┊    },\n+┊   ┊ 80┊    {\n+┊   ┊ 81┊      id: '2',\n+┊   ┊ 82┊      __typename: 'Chat',\n+┊   ┊ 83┊      name: 'Katie Peterson',\n+┊   ┊ 84┊      picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n+┊   ┊ 85┊      allTimeMembers: [\n+┊   ┊ 86┊        {\n+┊   ┊ 87┊          id: '1',\n+┊   ┊ 88┊          __typename: 'User',\n+┊   ┊ 89┊        },\n+┊   ┊ 90┊        {\n+┊   ┊ 91┊          id: '4',\n+┊   ┊ 92┊          __typename: 'User',\n+┊   ┊ 93┊        },\n+┊   ┊ 94┊      ],\n+┊   ┊ 95┊      unreadMessages: 0,\n+┊   ┊ 96┊      isGroup: false,\n+┊   ┊ 97┊      messages: [\n+┊   ┊ 98┊        {\n+┊   ┊ 99┊          id: '1',\n+┊   ┊100┊          chat: {\n+┊   ┊101┊            id: '2',\n+┊   ┊102┊            __typename: 'Chat',\n+┊   ┊103┊          },\n+┊   ┊104┊          __typename: 'Message',\n+┊   ┊105┊          sender: {\n+┊   ┊106┊            id: '1',\n+┊   ┊107┊            __typename: 'User',\n+┊   ┊108┊            name: 'Ethan Gonzalez',\n+┊   ┊109┊          },\n+┊   ┊110┊          content: `Hey, it's me`,\n+┊   ┊111┊          createdAt: '1514031800',\n+┊   ┊112┊          type: 0,\n+┊   ┊113┊          recipients: [\n+┊   ┊114┊            {\n+┊   ┊115┊              user: {\n+┊   ┊116┊                id: '4',\n+┊   ┊117┊                __typename: 'User',\n+┊   ┊118┊              },\n+┊   ┊119┊              message: {\n+┊   ┊120┊                id: '1',\n+┊   ┊121┊                __typename: 'Message',\n+┊   ┊122┊                chat: {\n+┊   ┊123┊                  id: '2',\n+┊   ┊124┊                  __typename: 'Chat',\n+┊   ┊125┊                },\n+┊   ┊126┊              },\n+┊   ┊127┊              __typename: 'Recipient',\n+┊   ┊128┊              chat: {\n+┊   ┊129┊                id: '2',\n+┊   ┊130┊                __typename: 'Chat',\n+┊   ┊131┊              },\n+┊   ┊132┊              receivedAt: null,\n+┊   ┊133┊              readAt: null,\n+┊   ┊134┊            },\n+┊   ┊135┊          ],\n+┊   ┊136┊          ownership: true,\n+┊   ┊137┊        },\n+┊   ┊138┊      ],\n+┊   ┊139┊    },\n+┊   ┊140┊    {\n+┊   ┊141┊      id: '3',\n+┊   ┊142┊      __typename: 'Chat',\n+┊   ┊143┊      name: 'Ray Edwards',\n+┊   ┊144┊      picture: 'https://randomuser.me/api/portraits/thumb/men/3.jpg',\n+┊   ┊145┊      allTimeMembers: [\n+┊   ┊146┊        {\n+┊   ┊147┊          id: '1',\n+┊   ┊148┊          __typename: 'User',\n+┊   ┊149┊        },\n+┊   ┊150┊        {\n+┊   ┊151┊          id: '5',\n+┊   ┊152┊          __typename: 'User',\n+┊   ┊153┊        },\n+┊   ┊154┊      ],\n+┊   ┊155┊      unreadMessages: 0,\n+┊   ┊156┊      isGroup: false,\n+┊   ┊157┊      messages: [\n+┊   ┊158┊        {\n+┊   ┊159┊          id: '1',\n+┊   ┊160┊          __typename: 'Message',\n+┊   ┊161┊          chat: {\n+┊   ┊162┊            id: '3',\n+┊   ┊163┊            __typename: 'Chat',\n+┊   ┊164┊          },\n+┊   ┊165┊          sender: {\n+┊   ┊166┊            id: '1',\n+┊   ┊167┊            __typename: 'User',\n+┊   ┊168┊            name: 'Ethan Gonzalez',\n+┊   ┊169┊          },\n+┊   ┊170┊          content: 'You still there?',\n+┊   ┊171┊          createdAt: '1514010200',\n+┊   ┊172┊          type: 0,\n+┊   ┊173┊          recipients: [\n+┊   ┊174┊            {\n+┊   ┊175┊              user: {\n+┊   ┊176┊                id: '5',\n+┊   ┊177┊                __typename: 'User',\n+┊   ┊178┊              },\n+┊   ┊179┊              message: {\n+┊   ┊180┊                id: '1',\n+┊   ┊181┊                __typename: 'Message',\n+┊   ┊182┊                chat: {\n+┊   ┊183┊                  id: '3',\n+┊   ┊184┊                  __typename: 'Chat',\n+┊   ┊185┊                },\n+┊   ┊186┊              },\n+┊   ┊187┊              __typename: 'Recipient',\n+┊   ┊188┊              chat: {\n+┊   ┊189┊                id: '3',\n+┊   ┊190┊                __typename: 'Chat',\n+┊   ┊191┊              },\n+┊   ┊192┊              receivedAt: null,\n+┊   ┊193┊              readAt: null,\n+┊   ┊194┊            },\n+┊   ┊195┊          ],\n+┊   ┊196┊          ownership: true,\n+┊   ┊197┊        },\n+┊   ┊198┊      ],\n+┊   ┊199┊    },\n+┊   ┊200┊    {\n+┊   ┊201┊      id: '6',\n+┊   ┊202┊      __typename: 'Chat',\n+┊   ┊203┊      name: 'Niccolò Belli',\n+┊   ┊204┊      picture: 'https://randomuser.me/api/portraits/thumb/men/4.jpg',\n+┊   ┊205┊      allTimeMembers: [\n+┊   ┊206┊        {\n+┊   ┊207┊          id: '1',\n+┊   ┊208┊          __typename: 'User',\n+┊   ┊209┊        },\n+┊   ┊210┊        {\n+┊   ┊211┊          id: '6',\n+┊   ┊212┊          __typename: 'User',\n+┊   ┊213┊        },\n+┊   ┊214┊      ],\n+┊   ┊215┊      unreadMessages: 0,\n+┊   ┊216┊      messages: [],\n+┊   ┊217┊      isGroup: false,\n+┊   ┊218┊    },\n+┊   ┊219┊    {\n+┊   ┊220┊      id: '8',\n+┊   ┊221┊      __typename: 'Chat',\n+┊   ┊222┊      name: 'A user 0 group',\n+┊   ┊223┊      picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n+┊   ┊224┊      allTimeMembers: [\n+┊   ┊225┊        {\n+┊   ┊226┊          id: '1',\n+┊   ┊227┊          __typename: 'User',\n+┊   ┊228┊        },\n+┊   ┊229┊        {\n+┊   ┊230┊          id: '3',\n+┊   ┊231┊          __typename: 'User',\n+┊   ┊232┊        },\n+┊   ┊233┊        {\n+┊   ┊234┊          id: '4',\n+┊   ┊235┊          __typename: 'User',\n+┊   ┊236┊        },\n+┊   ┊237┊        {\n+┊   ┊238┊          id: '6',\n+┊   ┊239┊          __typename: 'User',\n+┊   ┊240┊        },\n+┊   ┊241┊      ],\n+┊   ┊242┊      unreadMessages: 1,\n+┊   ┊243┊      isGroup: true,\n+┊   ┊244┊      messages: [\n+┊   ┊245┊        {\n+┊   ┊246┊          id: '1',\n+┊   ┊247┊          __typename: 'Message',\n+┊   ┊248┊          chat: {\n+┊   ┊249┊            id: '8',\n+┊   ┊250┊            __typename: 'Chat',\n+┊   ┊251┊          },\n+┊   ┊252┊          sender: {\n+┊   ┊253┊            id: '4',\n+┊   ┊254┊            __typename: 'User',\n+┊   ┊255┊            name: 'Katie Peterson',\n+┊   ┊256┊          },\n+┊   ┊257┊          content: 'Awesome!',\n+┊   ┊258┊          createdAt: '1512830000',\n+┊   ┊259┊          type: 0,\n+┊   ┊260┊          recipients: [\n+┊   ┊261┊            {\n+┊   ┊262┊              user: {\n+┊   ┊263┊                id: '1',\n+┊   ┊264┊                __typename: 'User',\n+┊   ┊265┊              },\n+┊   ┊266┊              message: {\n+┊   ┊267┊                id: '1',\n+┊   ┊268┊                __typename: 'Message',\n+┊   ┊269┊                chat: {\n+┊   ┊270┊                  id: '8',\n+┊   ┊271┊                  __typename: 'Chat',\n+┊   ┊272┊                },\n+┊   ┊273┊              },\n+┊   ┊274┊              __typename: 'Recipient',\n+┊   ┊275┊              chat: {\n+┊   ┊276┊                id: '8',\n+┊   ┊277┊                __typename: 'Chat',\n+┊   ┊278┊              },\n+┊   ┊279┊              receivedAt: null,\n+┊   ┊280┊              readAt: null,\n+┊   ┊281┊            },\n+┊   ┊282┊            {\n+┊   ┊283┊              user: {\n+┊   ┊284┊                id: '6',\n+┊   ┊285┊                __typename: 'User',\n+┊   ┊286┊              },\n+┊   ┊287┊              message: {\n+┊   ┊288┊                id: '1',\n+┊   ┊289┊                __typename: 'Message',\n+┊   ┊290┊                chat: {\n+┊   ┊291┊                  id: '8',\n+┊   ┊292┊                  __typename: 'Chat',\n+┊   ┊293┊                },\n+┊   ┊294┊              },\n+┊   ┊295┊              __typename: 'Recipient',\n+┊   ┊296┊              chat: {\n+┊   ┊297┊                id: '8',\n+┊   ┊298┊                __typename: 'Chat',\n+┊   ┊299┊              },\n+┊   ┊300┊              receivedAt: null,\n+┊   ┊301┊              readAt: null,\n+┊   ┊302┊            },\n+┊   ┊303┊          ],\n+┊   ┊304┊          ownership: false,\n+┊   ┊305┊        },\n+┊   ┊306┊      ],\n+┊   ┊307┊    },\n+┊   ┊308┊  ];\n+┊   ┊309┊\n+┊   ┊310┊  beforeEach(() => {\n+┊   ┊311┊    TestBed.configureTestingModule({\n+┊   ┊312┊      imports: [ApolloTestingModule],\n+┊   ┊313┊      providers: [\n+┊   ┊314┊        ChatsService,\n+┊   ┊315┊        {\n+┊   ┊316┊          provide: APOLLO_TESTING_CACHE,\n+┊   ┊317┊          useFactory() {\n+┊   ┊318┊            return new InMemoryCache({\n+┊   ┊319┊              dataIdFromObject,\n+┊   ┊320┊            });\n+┊   ┊321┊          },\n+┊   ┊322┊        },\n+┊   ┊323┊      ],\n+┊   ┊324┊    });\n+┊   ┊325┊\n+┊   ┊326┊    controller = TestBed.get(ApolloTestingController);\n+┊   ┊327┊    apollo = TestBed.get(Apollo);\n+┊   ┊328┊  });\n+┊   ┊329┊\n+┊   ┊330┊  it('should be created', inject([ChatsService], (service: ChatsService) => {\n+┊   ┊331┊    expect(service).toBeTruthy();\n+┊   ┊332┊  }));\n+┊   ┊333┊\n+┊   ┊334┊  it('should get chats', inject([ChatsService], (service: ChatsService) => {\n+┊   ┊335┊    service.getChats().chats$.subscribe(_chats => {\n+┊   ┊336┊      expect(_chats.length).toEqual(chats.length);\n+┊   ┊337┊      for (let i = 0; i < _chats.length; i++) {\n+┊   ┊338┊        expect(_chats[i]).toEqual(chats[i]);\n+┊   ┊339┊      }\n+┊   ┊340┊    });\n+┊   ┊341┊\n+┊   ┊342┊    const req = controller.expectOne('GetChats', 'GetChats operation');\n+┊   ┊343┊\n+┊   ┊344┊    req.flush({\n+┊   ┊345┊      data: {\n+┊   ┊346┊        chats,\n+┊   ┊347┊      },\n+┊   ┊348┊    });\n+┊   ┊349┊\n+┊   ┊350┊    controller.verify();\n+┊   ┊351┊  }));\n+┊   ┊352┊});\n```\n\n[}]: #\n\nAs you can see, the API of `ApolloTestingController` is pretty similar to the `HttpTestingController`.\n\nThere are four methods you should know.\n\n**`expectOne()`**\nImportant thing, it accepts two arguments. First is different for different use cases, the second one stays always the same, it’s a string with a description of your assertion. In case of failing assertion, the error is thrown with an error message including the given description.\n\nLet's explore all those possible cases `expectOne` accepts:\n\n- you can match an operation by its name, simply by passing a string as a first argument.\n- by passing the whole Operation object the expectOne method compares: operation’s name, variables, document and extensions.\n- the first argument can also be a function that provides an Operation object and expect a boolean in return\n- or passing a GraphQL Document\n\n**`exceptNone()`**\nIt accepts the same arguments as expectOne but it's a negation of it.\n\n**`match()`**\nSearch for operations that match the given parameters, without any expectations.\n\n**`verify()`**\nVerify that no unmatched operations are outstanding. If any operations are outstanding, fail with an error message indicating which operations were not handled.\n\nIf you want to learn more about testing, we got you covered, please visit [\"Testing Apollo in Angular\" chapter](https://www.apollographql.com/docs/angular/guides/testing.html) in Apollo documentation.\n\n### Testing a Container Component\n\nIn the last example we are going to test a container component, which makes use of several services and multiple other components:\n\n[{]: <helper> (diffStep \"3.1\" files=\"src/app/chats-lister/containers/chats/chats.component.spec.ts\" module=\"client\")\n\n#### [Step 3.1: Testing](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/b76d15b)\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.spec.ts\n```diff\n@@ -0,0 +1,392 @@\n+┊   ┊  1┊import { async, ComponentFixture, TestBed } from '@angular/core/testing';\n+┊   ┊  2┊import { DebugElement, NO_ERRORS_SCHEMA } from '@angular/core';\n+┊   ┊  3┊import { TruncateModule } from 'ng2-truncate';\n+┊   ┊  4┊import {\n+┊   ┊  5┊  MatButtonModule,\n+┊   ┊  6┊  MatIconModule,\n+┊   ┊  7┊  MatListModule,\n+┊   ┊  8┊  MatMenuModule,\n+┊   ┊  9┊} from '@angular/material';\n+┊   ┊ 10┊import { Apollo } from 'apollo-angular';\n+┊   ┊ 11┊import {\n+┊   ┊ 12┊  ApolloTestingModule,\n+┊   ┊ 13┊  ApolloTestingController,\n+┊   ┊ 14┊  APOLLO_TESTING_CACHE,\n+┊   ┊ 15┊} from 'apollo-angular/testing';\n+┊   ┊ 16┊import { InMemoryCache } from 'apollo-cache-inmemory';\n+┊   ┊ 17┊import { By } from '@angular/platform-browser';\n+┊   ┊ 18┊import { RouterTestingModule } from '@angular/router/testing';\n+┊   ┊ 19┊\n+┊   ┊ 20┊import { GetChats } from '../../../../graphql';\n+┊   ┊ 21┊import { dataIdFromObject } from '../../../graphql.module';\n+┊   ┊ 22┊import { ChatsComponent } from './chats.component';\n+┊   ┊ 23┊import { ChatsListComponent } from '../../components/chats-list/chats-list.component';\n+┊   ┊ 24┊import { ChatItemComponent } from '../../components/chat-item/chat-item.component';\n+┊   ┊ 25┊import { ChatsService } from '../../../services/chats.service';\n+┊   ┊ 26┊\n+┊   ┊ 27┊describe('ChatsComponent', () => {\n+┊   ┊ 28┊  let component: ChatsComponent;\n+┊   ┊ 29┊  let fixture: ComponentFixture<ChatsComponent>;\n+┊   ┊ 30┊  let el: DebugElement;\n+┊   ┊ 31┊\n+┊   ┊ 32┊  let controller: ApolloTestingController;\n+┊   ┊ 33┊  let apollo: Apollo;\n+┊   ┊ 34┊\n+┊   ┊ 35┊  const chats: GetChats.Chats[] = [\n+┊   ┊ 36┊    {\n+┊   ┊ 37┊      id: '1',\n+┊   ┊ 38┊      __typename: 'Chat',\n+┊   ┊ 39┊      name: 'Avery Stewart',\n+┊   ┊ 40┊      picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n+┊   ┊ 41┊      allTimeMembers: [\n+┊   ┊ 42┊        {\n+┊   ┊ 43┊          id: '1',\n+┊   ┊ 44┊          __typename: 'User',\n+┊   ┊ 45┊        },\n+┊   ┊ 46┊        {\n+┊   ┊ 47┊          id: '3',\n+┊   ┊ 48┊          __typename: 'User',\n+┊   ┊ 49┊        },\n+┊   ┊ 50┊      ],\n+┊   ┊ 51┊      unreadMessages: 1,\n+┊   ┊ 52┊      isGroup: false,\n+┊   ┊ 53┊      messages: [\n+┊   ┊ 54┊        {\n+┊   ┊ 55┊          id: '1',\n+┊   ┊ 56┊          chat: {\n+┊   ┊ 57┊            id: '1',\n+┊   ┊ 58┊            __typename: 'Chat',\n+┊   ┊ 59┊          },\n+┊   ┊ 60┊          __typename: 'Message',\n+┊   ┊ 61┊          sender: {\n+┊   ┊ 62┊            id: '3',\n+┊   ┊ 63┊            __typename: 'User',\n+┊   ┊ 64┊            name: 'Avery Stewart',\n+┊   ┊ 65┊          },\n+┊   ┊ 66┊          content: 'Yep!',\n+┊   ┊ 67┊          createdAt: '1514035700',\n+┊   ┊ 68┊          type: 0,\n+┊   ┊ 69┊          recipients: [\n+┊   ┊ 70┊            {\n+┊   ┊ 71┊              user: {\n+┊   ┊ 72┊                id: '1',\n+┊   ┊ 73┊                __typename: 'User',\n+┊   ┊ 74┊              },\n+┊   ┊ 75┊              message: {\n+┊   ┊ 76┊                id: '1',\n+┊   ┊ 77┊                __typename: 'Message',\n+┊   ┊ 78┊                chat: {\n+┊   ┊ 79┊                  id: '1',\n+┊   ┊ 80┊                  __typename: 'Chat',\n+┊   ┊ 81┊                },\n+┊   ┊ 82┊              },\n+┊   ┊ 83┊              __typename: 'Recipient',\n+┊   ┊ 84┊              chat: {\n+┊   ┊ 85┊                id: '1',\n+┊   ┊ 86┊                __typename: 'Chat',\n+┊   ┊ 87┊              },\n+┊   ┊ 88┊              receivedAt: null,\n+┊   ┊ 89┊              readAt: null,\n+┊   ┊ 90┊            },\n+┊   ┊ 91┊          ],\n+┊   ┊ 92┊          ownership: false,\n+┊   ┊ 93┊        },\n+┊   ┊ 94┊      ],\n+┊   ┊ 95┊    },\n+┊   ┊ 96┊    {\n+┊   ┊ 97┊      id: '2',\n+┊   ┊ 98┊      __typename: 'Chat',\n+┊   ┊ 99┊      name: 'Katie Peterson',\n+┊   ┊100┊      picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n+┊   ┊101┊      allTimeMembers: [\n+┊   ┊102┊        {\n+┊   ┊103┊          id: '1',\n+┊   ┊104┊          __typename: 'User',\n+┊   ┊105┊        },\n+┊   ┊106┊        {\n+┊   ┊107┊          id: '4',\n+┊   ┊108┊          __typename: 'User',\n+┊   ┊109┊        },\n+┊   ┊110┊      ],\n+┊   ┊111┊      unreadMessages: 0,\n+┊   ┊112┊      isGroup: false,\n+┊   ┊113┊      messages: [\n+┊   ┊114┊        {\n+┊   ┊115┊          id: '1',\n+┊   ┊116┊          chat: {\n+┊   ┊117┊            id: '2',\n+┊   ┊118┊            __typename: 'Chat',\n+┊   ┊119┊          },\n+┊   ┊120┊          __typename: 'Message',\n+┊   ┊121┊          sender: {\n+┊   ┊122┊            id: '1',\n+┊   ┊123┊            __typename: 'User',\n+┊   ┊124┊            name: 'Ethan Gonzalez',\n+┊   ┊125┊          },\n+┊   ┊126┊          content: `Hey, it's me`,\n+┊   ┊127┊          createdAt: '1514031800',\n+┊   ┊128┊          type: 0,\n+┊   ┊129┊          recipients: [\n+┊   ┊130┊            {\n+┊   ┊131┊              user: {\n+┊   ┊132┊                id: '4',\n+┊   ┊133┊                __typename: 'User',\n+┊   ┊134┊              },\n+┊   ┊135┊              message: {\n+┊   ┊136┊                id: '1',\n+┊   ┊137┊                __typename: 'Message',\n+┊   ┊138┊                chat: {\n+┊   ┊139┊                  id: '2',\n+┊   ┊140┊                  __typename: 'Chat',\n+┊   ┊141┊                },\n+┊   ┊142┊              },\n+┊   ┊143┊              __typename: 'Recipient',\n+┊   ┊144┊              chat: {\n+┊   ┊145┊                id: '2',\n+┊   ┊146┊                __typename: 'Chat',\n+┊   ┊147┊              },\n+┊   ┊148┊              receivedAt: null,\n+┊   ┊149┊              readAt: null,\n+┊   ┊150┊            },\n+┊   ┊151┊          ],\n+┊   ┊152┊          ownership: true,\n+┊   ┊153┊        },\n+┊   ┊154┊      ],\n+┊   ┊155┊    },\n+┊   ┊156┊    {\n+┊   ┊157┊      id: '3',\n+┊   ┊158┊      __typename: 'Chat',\n+┊   ┊159┊      name: 'Ray Edwards',\n+┊   ┊160┊      picture: 'https://randomuser.me/api/portraits/thumb/men/3.jpg',\n+┊   ┊161┊      allTimeMembers: [\n+┊   ┊162┊        {\n+┊   ┊163┊          id: '1',\n+┊   ┊164┊          __typename: 'User',\n+┊   ┊165┊        },\n+┊   ┊166┊        {\n+┊   ┊167┊          id: '5',\n+┊   ┊168┊          __typename: 'User',\n+┊   ┊169┊        },\n+┊   ┊170┊      ],\n+┊   ┊171┊      unreadMessages: 0,\n+┊   ┊172┊      isGroup: false,\n+┊   ┊173┊      messages: [\n+┊   ┊174┊        {\n+┊   ┊175┊          id: '1',\n+┊   ┊176┊          __typename: 'Message',\n+┊   ┊177┊          chat: {\n+┊   ┊178┊            id: '3',\n+┊   ┊179┊            __typename: 'Chat',\n+┊   ┊180┊          },\n+┊   ┊181┊          sender: {\n+┊   ┊182┊            id: '1',\n+┊   ┊183┊            __typename: 'User',\n+┊   ┊184┊            name: 'Ethan Gonzalez',\n+┊   ┊185┊          },\n+┊   ┊186┊          content: 'You still there?',\n+┊   ┊187┊          createdAt: '1514010200',\n+┊   ┊188┊          type: 0,\n+┊   ┊189┊          recipients: [\n+┊   ┊190┊            {\n+┊   ┊191┊              user: {\n+┊   ┊192┊                id: '5',\n+┊   ┊193┊                __typename: 'User',\n+┊   ┊194┊              },\n+┊   ┊195┊              message: {\n+┊   ┊196┊                id: '1',\n+┊   ┊197┊                __typename: 'Message',\n+┊   ┊198┊                chat: {\n+┊   ┊199┊                  id: '3',\n+┊   ┊200┊                  __typename: 'Chat',\n+┊   ┊201┊                },\n+┊   ┊202┊              },\n+┊   ┊203┊              __typename: 'Recipient',\n+┊   ┊204┊              chat: {\n+┊   ┊205┊                id: '3',\n+┊   ┊206┊                __typename: 'Chat',\n+┊   ┊207┊              },\n+┊   ┊208┊              receivedAt: null,\n+┊   ┊209┊              readAt: null,\n+┊   ┊210┊            },\n+┊   ┊211┊          ],\n+┊   ┊212┊          ownership: true,\n+┊   ┊213┊        },\n+┊   ┊214┊      ],\n+┊   ┊215┊    },\n+┊   ┊216┊    {\n+┊   ┊217┊      id: '6',\n+┊   ┊218┊      __typename: 'Chat',\n+┊   ┊219┊      name: 'Niccolò Belli',\n+┊   ┊220┊      picture: 'https://randomuser.me/api/portraits/thumb/men/4.jpg',\n+┊   ┊221┊      allTimeMembers: [\n+┊   ┊222┊        {\n+┊   ┊223┊          id: '1',\n+┊   ┊224┊          __typename: 'User',\n+┊   ┊225┊        },\n+┊   ┊226┊        {\n+┊   ┊227┊          id: '6',\n+┊   ┊228┊          __typename: 'User',\n+┊   ┊229┊        },\n+┊   ┊230┊      ],\n+┊   ┊231┊      unreadMessages: 0,\n+┊   ┊232┊      messages: [],\n+┊   ┊233┊      isGroup: false,\n+┊   ┊234┊    },\n+┊   ┊235┊    {\n+┊   ┊236┊      id: '8',\n+┊   ┊237┊      __typename: 'Chat',\n+┊   ┊238┊      name: 'A user 0 group',\n+┊   ┊239┊      picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n+┊   ┊240┊      allTimeMembers: [\n+┊   ┊241┊        {\n+┊   ┊242┊          id: '1',\n+┊   ┊243┊          __typename: 'User',\n+┊   ┊244┊        },\n+┊   ┊245┊        {\n+┊   ┊246┊          id: '3',\n+┊   ┊247┊          __typename: 'User',\n+┊   ┊248┊        },\n+┊   ┊249┊        {\n+┊   ┊250┊          id: '4',\n+┊   ┊251┊          __typename: 'User',\n+┊   ┊252┊        },\n+┊   ┊253┊        {\n+┊   ┊254┊          id: '6',\n+┊   ┊255┊          __typename: 'User',\n+┊   ┊256┊        },\n+┊   ┊257┊      ],\n+┊   ┊258┊      unreadMessages: 1,\n+┊   ┊259┊      isGroup: true,\n+┊   ┊260┊      messages: [\n+┊   ┊261┊        {\n+┊   ┊262┊          id: '1',\n+┊   ┊263┊          __typename: 'Message',\n+┊   ┊264┊          chat: {\n+┊   ┊265┊            id: '8',\n+┊   ┊266┊            __typename: 'Chat',\n+┊   ┊267┊          },\n+┊   ┊268┊          sender: {\n+┊   ┊269┊            id: '4',\n+┊   ┊270┊            __typename: 'User',\n+┊   ┊271┊            name: 'Katie Peterson',\n+┊   ┊272┊          },\n+┊   ┊273┊          content: 'Awesome!',\n+┊   ┊274┊          createdAt: '1512830000',\n+┊   ┊275┊          type: 0,\n+┊   ┊276┊          recipients: [\n+┊   ┊277┊            {\n+┊   ┊278┊              user: {\n+┊   ┊279┊                id: '1',\n+┊   ┊280┊                __typename: 'User',\n+┊   ┊281┊              },\n+┊   ┊282┊              message: {\n+┊   ┊283┊                id: '1',\n+┊   ┊284┊                __typename: 'Message',\n+┊   ┊285┊                chat: {\n+┊   ┊286┊                  id: '8',\n+┊   ┊287┊                  __typename: 'Chat',\n+┊   ┊288┊                },\n+┊   ┊289┊              },\n+┊   ┊290┊              __typename: 'Recipient',\n+┊   ┊291┊              chat: {\n+┊   ┊292┊                id: '8',\n+┊   ┊293┊                __typename: 'Chat',\n+┊   ┊294┊              },\n+┊   ┊295┊              receivedAt: null,\n+┊   ┊296┊              readAt: null,\n+┊   ┊297┊            },\n+┊   ┊298┊            {\n+┊   ┊299┊              user: {\n+┊   ┊300┊                id: '6',\n+┊   ┊301┊                __typename: 'User',\n+┊   ┊302┊              },\n+┊   ┊303┊              message: {\n+┊   ┊304┊                id: '1',\n+┊   ┊305┊                __typename: 'Message',\n+┊   ┊306┊                chat: {\n+┊   ┊307┊                  id: '8',\n+┊   ┊308┊                  __typename: 'Chat',\n+┊   ┊309┊                },\n+┊   ┊310┊              },\n+┊   ┊311┊              __typename: 'Recipient',\n+┊   ┊312┊              chat: {\n+┊   ┊313┊                id: '8',\n+┊   ┊314┊                __typename: 'Chat',\n+┊   ┊315┊              },\n+┊   ┊316┊              receivedAt: null,\n+┊   ┊317┊              readAt: null,\n+┊   ┊318┊            },\n+┊   ┊319┊          ],\n+┊   ┊320┊          ownership: false,\n+┊   ┊321┊        },\n+┊   ┊322┊      ],\n+┊   ┊323┊    },\n+┊   ┊324┊  ];\n+┊   ┊325┊\n+┊   ┊326┊  beforeEach(async(() => {\n+┊   ┊327┊    TestBed.configureTestingModule({\n+┊   ┊328┊      declarations: [ChatsComponent, ChatsListComponent, ChatItemComponent],\n+┊   ┊329┊      imports: [\n+┊   ┊330┊        MatMenuModule,\n+┊   ┊331┊        MatIconModule,\n+┊   ┊332┊        MatButtonModule,\n+┊   ┊333┊        MatListModule,\n+┊   ┊334┊        TruncateModule,\n+┊   ┊335┊        ApolloTestingModule,\n+┊   ┊336┊        RouterTestingModule,\n+┊   ┊337┊      ],\n+┊   ┊338┊      providers: [\n+┊   ┊339┊        ChatsService,\n+┊   ┊340┊        {\n+┊   ┊341┊          provide: APOLLO_TESTING_CACHE,\n+┊   ┊342┊          useFactory() {\n+┊   ┊343┊            return new InMemoryCache({ dataIdFromObject });\n+┊   ┊344┊          },\n+┊   ┊345┊        },\n+┊   ┊346┊      ],\n+┊   ┊347┊      schemas: [NO_ERRORS_SCHEMA],\n+┊   ┊348┊    }).compileComponents();\n+┊   ┊349┊\n+┊   ┊350┊    controller = TestBed.get(ApolloTestingController);\n+┊   ┊351┊    apollo = TestBed.get(Apollo);\n+┊   ┊352┊  }));\n+┊   ┊353┊\n+┊   ┊354┊  beforeEach(() => {\n+┊   ┊355┊    fixture = TestBed.createComponent(ChatsComponent);\n+┊   ┊356┊    component = fixture.componentInstance;\n+┊   ┊357┊    fixture.detectChanges();\n+┊   ┊358┊\n+┊   ┊359┊    const req = controller.expectOne('GetChats', 'GetChats operation');\n+┊   ┊360┊\n+┊   ┊361┊    req.flush({\n+┊   ┊362┊      data: {\n+┊   ┊363┊        chats,\n+┊   ┊364┊      },\n+┊   ┊365┊    });\n+┊   ┊366┊  });\n+┊   ┊367┊\n+┊   ┊368┊  it('should create', () => {\n+┊   ┊369┊    expect(component).toBeTruthy();\n+┊   ┊370┊  });\n+┊   ┊371┊\n+┊   ┊372┊  it('should display the chats', () => {\n+┊   ┊373┊    fixture.whenStable().then(() => {\n+┊   ┊374┊      fixture.detectChanges();\n+┊   ┊375┊      el = fixture.debugElement;\n+┊   ┊376┊      for (let i = 0; i < chats.length; i++) {\n+┊   ┊377┊        expect(\n+┊   ┊378┊          el.query(\n+┊   ┊379┊            By.css(\n+┊   ┊380┊              `app-chats-list > mat-list > mat-list-item:nth-child(${i +\n+┊   ┊381┊                1}) > div > app-chat-item > div > div > div`,\n+┊   ┊382┊            ),\n+┊   ┊383┊          ).nativeElement.textContent,\n+┊   ┊384┊        ).toContain(chats[i].name);\n+┊   ┊385┊      }\n+┊   ┊386┊    });\n+┊   ┊387┊  });\n+┊   ┊388┊\n+┊   ┊389┊  afterAll(() => {\n+┊   ┊390┊    controller.verify();\n+┊   ┊391┊  });\n+┊   ┊392┊});\n```\n\n[}]: #"
          },
          {
            "manualTitle": "Step 8: Chat viewer",
            "stepRevision": "026cf4f16276d61fd0e962c466c76806bb4f397c",
            "manualView": "![chat](https://user-images.githubusercontent.com/7648874/49270290-92877e80-f4a3-11e8-8984-d3ee920838ed.png)\n\nAt this point we have a module which lists all of our chats, but we still need to show a particular chat.\nWe're going to implement in in this chapter.\n\n### ChatViewer module\n\nFirst, let's create a `ChatViewer` module:\n\n[{]: <helper> (diffStep \"4.1\" files=\"src/app/app.module.ts, src/app/chat-viewer/chat-viewer.module.ts\" module=\"client\")\n\n#### [Step 4.1: Chat Viewer](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/257159a)\n\n##### Changed src&#x2F;app&#x2F;app.module.ts\n```diff\n@@ -6,6 +6,7 @@\n ┊ 6┊ 6┊import { GraphQLModule } from './graphql.module';\n ┊ 7┊ 7┊import {ChatsListerModule} from './chats-lister/chats-lister.module';\n ┊ 8┊ 8┊import {RouterModule, Routes} from '@angular/router';\n+┊  ┊ 9┊import {ChatViewerModule} from './chat-viewer/chat-viewer.module';\n ┊ 9┊10┊const routes: Routes = [];\n ┊10┊11┊\n ┊11┊12┊@NgModule({\n```\n```diff\n@@ -20,6 +21,7 @@\n ┊20┊21┊    RouterModule.forRoot(routes),\n ┊21┊22┊    // Feature modules\n ┊22┊23┊    ChatsListerModule,\n+┊  ┊24┊    ChatViewerModule,\n ┊23┊25┊  ],\n ┊24┊26┊  providers: [],\n ┊25┊27┊  bootstrap: [AppComponent]\n```\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;chat-viewer.module.ts\n```diff\n@@ -0,0 +1,53 @@\n+┊  ┊ 1┊import { BrowserModule } from '@angular/platform-browser';\n+┊  ┊ 2┊import { NgModule } from '@angular/core';\n+┊  ┊ 3┊\n+┊  ┊ 4┊import {BrowserAnimationsModule} from '@angular/platform-browser/animations';\n+┊  ┊ 5┊import {MatButtonModule, MatGridListModule, MatIconModule, MatListModule, MatMenuModule, MatToolbarModule} from '@angular/material';\n+┊  ┊ 6┊import {RouterModule, Routes} from '@angular/router';\n+┊  ┊ 7┊import {FormsModule} from '@angular/forms';\n+┊  ┊ 8┊import {ChatsService} from '../services/chats.service';\n+┊  ┊ 9┊import {ChatComponent} from './containers/chat/chat.component';\n+┊  ┊10┊import {MessagesListComponent} from './components/messages-list/messages-list.component';\n+┊  ┊11┊import {MessageItemComponent} from './components/message-item/message-item.component';\n+┊  ┊12┊import {NewMessageComponent} from './components/new-message/new-message.component';\n+┊  ┊13┊import {SharedModule} from '../shared/shared.module';\n+┊  ┊14┊\n+┊  ┊15┊const routes: Routes = [\n+┊  ┊16┊  {\n+┊  ┊17┊    path: 'chat', children: [\n+┊  ┊18┊      {path: ':id', component: ChatComponent},\n+┊  ┊19┊    ],\n+┊  ┊20┊  },\n+┊  ┊21┊];\n+┊  ┊22┊\n+┊  ┊23┊@NgModule({\n+┊  ┊24┊  declarations: [\n+┊  ┊25┊    ChatComponent,\n+┊  ┊26┊    MessagesListComponent,\n+┊  ┊27┊    MessageItemComponent,\n+┊  ┊28┊    NewMessageComponent,\n+┊  ┊29┊  ],\n+┊  ┊30┊  imports: [\n+┊  ┊31┊    BrowserModule,\n+┊  ┊32┊    // Material\n+┊  ┊33┊    MatToolbarModule,\n+┊  ┊34┊    MatMenuModule,\n+┊  ┊35┊    MatIconModule,\n+┊  ┊36┊    MatButtonModule,\n+┊  ┊37┊    MatListModule,\n+┊  ┊38┊    MatGridListModule,\n+┊  ┊39┊    // Animations\n+┊  ┊40┊    BrowserAnimationsModule,\n+┊  ┊41┊    // Routing\n+┊  ┊42┊    RouterModule.forChild(routes),\n+┊  ┊43┊    // Forms\n+┊  ┊44┊    FormsModule,\n+┊  ┊45┊    // Feature modules\n+┊  ┊46┊    SharedModule,\n+┊  ┊47┊  ],\n+┊  ┊48┊  providers: [\n+┊  ┊49┊    ChatsService,\n+┊  ┊50┊  ],\n+┊  ┊51┊})\n+┊  ┊52┊export class ChatViewerModule {\n+┊  ┊53┊}\n```\n\n[}]: #\n\nAs you can see, it has already everything that we might need.\n\n### GetChat operation\n\nComponents need data, so we create the `GetChat` operation and run `yarn generator`:\n\n[{]: <helper> (diffStep \"4.1\" files=\"src/graphql/getChat.query.ts\" module=\"client\")\n\n#### [Step 4.1: Chat Viewer](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/257159a)\n\n##### Added src&#x2F;graphql&#x2F;getChat.query.ts\n```diff\n@@ -0,0 +1,17 @@\n+┊  ┊ 1┊import gql from 'graphql-tag';\n+┊  ┊ 2┊import {fragments} from './fragment';\n+┊  ┊ 3┊\n+┊  ┊ 4┊// We use the gql tag to parse our query string into a query document\n+┊  ┊ 5┊export const getChatQuery = gql`\n+┊  ┊ 6┊  query GetChat($chatId: ID!) {\n+┊  ┊ 7┊    chat(chatId: $chatId) {\n+┊  ┊ 8┊      ...ChatWithoutMessages\n+┊  ┊ 9┊      messages {\n+┊  ┊10┊        ...Message\n+┊  ┊11┊      }\n+┊  ┊12┊    }\n+┊  ┊13┊  }\n+┊  ┊14┊\n+┊  ┊15┊  ${fragments['chatWithoutMessages']}\n+┊  ┊16┊  ${fragments['message']}\n+┊  ┊17┊`;\n```\n\n[}]: #\n\nThe query can be now implemented in `ChatsService`:\n\n[{]: <helper> (diffStep \"4.1\" files=\"src/app/services/chats.service.ts\" module=\"client\")\n\n#### [Step 4.1: Chat Viewer](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/257159a)\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,13 +1,14 @@\n ┊ 1┊ 1┊import {map} from 'rxjs/operators';\n ┊ 2┊ 2┊import {Injectable} from '@angular/core';\n-┊ 3┊  ┊import {GetChatsGQL} from '../../graphql';\n+┊  ┊ 3┊import {GetChatsGQL, GetChatGQL} from '../../graphql';\n ┊ 4┊ 4┊\n ┊ 5┊ 5┊@Injectable()\n ┊ 6┊ 6┊export class ChatsService {\n ┊ 7┊ 7┊  messagesAmount = 3;\n ┊ 8┊ 8┊\n ┊ 9┊ 9┊  constructor(\n-┊10┊  ┊    private getChatsGQL: GetChatsGQL\n+┊  ┊10┊    private getChatsGQL: GetChatsGQL,\n+┊  ┊11┊    private getChatGQL: GetChatGQL\n ┊11┊12┊  ) {}\n ┊12┊13┊\n ┊13┊14┊  getChats() {\n```\n```diff\n@@ -20,4 +21,16 @@\n ┊20┊21┊\n ┊21┊22┊    return {query, chats$};\n ┊22┊23┊  }\n+┊  ┊24┊\n+┊  ┊25┊  getChat(chatId: string) {\n+┊  ┊26┊    const query = this.getChatGQL.watch({\n+┊  ┊27┊      chatId: chatId,\n+┊  ┊28┊    });\n+┊  ┊29┊\n+┊  ┊30┊    const chat$ = query.valueChanges.pipe(\n+┊  ┊31┊      map((result) => result.data.chat)\n+┊  ┊32┊    );\n+┊  ┊33┊\n+┊  ┊34┊    return {query, chat$};\n+┊  ┊35┊  }\n ┊23┊36┊}\n```\n\n[}]: #\n\nGreat!\n\n### Chat view\n\nNow we've got data but a user can't still access the chat view.\nThere is one place where we're able to pick the chat, it's the list:\n\n[{]: <helper> (diffStep \"4.1\" files=\"src/app/chats-lister/components/chat-item/chat-item.component.ts, src/app/chats-lister/components/chats-list/chats-list.component.ts, src/app/chats-lister/containers/chats/chats.component.ts\" module=\"client\")\n\n#### [Step 4.1: Chat Viewer](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/257159a)\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chat-item&#x2F;chat-item.component.ts\n```diff\n@@ -1,14 +1,14 @@\n-┊ 1┊  ┊import {Component, Input} from '@angular/core';\n+┊  ┊ 1┊import {Component, EventEmitter, Input, Output} from '@angular/core';\n ┊ 2┊ 2┊import {GetChats} from '../../../../graphql';\n ┊ 3┊ 3┊\n ┊ 4┊ 4┊@Component({\n ┊ 5┊ 5┊  selector: 'app-chat-item',\n ┊ 6┊ 6┊  template: `\n-┊ 7┊  ┊    <div class=\"chat-row\">\n+┊  ┊ 7┊    <div class=\"chat-row\" (click)=\"selectChat()\">\n ┊ 8┊ 8┊      <img class=\"chat-pic\" [src]=\"chat.picture || 'assets/default-profile-pic.jpg'\">\n ┊ 9┊ 9┊      <div class=\"chat-info\">\n ┊10┊10┊        <div class=\"chat-name\">{{ chat.name }}</div>\n-┊11┊  ┊        <div class=\"chat-last-message\">{{ chat.messages?[chat.messages?.length - 1]?.content }}</div>\n+┊  ┊11┊        <div class=\"chat-last-message\">{{ chat.messages[chat.messages.length - 1]?.content }}</div>\n ┊12┊12┊        <div class=\"chat-timestamp\">00:00</div>\n ┊13┊13┊      </div>\n ┊14┊14┊    </div>\n```\n```diff\n@@ -19,4 +19,11 @@\n ┊19┊19┊  // tslint:disable-next-line:no-input-rename\n ┊20┊20┊  @Input('item')\n ┊21┊21┊  chat: GetChats.Chats;\n+┊  ┊22┊\n+┊  ┊23┊  @Output()\n+┊  ┊24┊  select = new EventEmitter<string>();\n+┊  ┊25┊\n+┊  ┊26┊  selectChat() {\n+┊  ┊27┊    this.select.emit(this.chat.id);\n+┊  ┊28┊  }\n ┊22┊29┊}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chats-list&#x2F;chats-list.component.ts\n```diff\n@@ -1,4 +1,4 @@\n-┊1┊ ┊import {Component, Input} from '@angular/core';\n+┊ ┊1┊import {Component, EventEmitter, Input, Output} from '@angular/core';\n ┊2┊2┊import {GetChats} from '../../../../graphql';\n ┊3┊3┊\n ┊4┊4┊@Component({\n```\n```diff\n@@ -6,7 +6,7 @@\n ┊ 6┊ 6┊  template: `\n ┊ 7┊ 7┊    <mat-list>\n ┊ 8┊ 8┊      <mat-list-item *ngFor=\"let chat of chats\">\n-┊ 9┊  ┊        <app-chat-item [item]=\"chat\"></app-chat-item>\n+┊  ┊ 9┊        <app-chat-item [item]=\"chat\" (select)=\"selectChat($event)\"></app-chat-item>\n ┊10┊10┊      </mat-list-item>\n ┊11┊11┊    </mat-list>\n ┊12┊12┊  `,\n```\n```diff\n@@ -17,5 +17,12 @@\n ┊17┊17┊  @Input('items')\n ┊18┊18┊  chats: GetChats.Chats[];\n ┊19┊19┊\n+┊  ┊20┊  @Output()\n+┊  ┊21┊  select = new EventEmitter<string>();\n+┊  ┊22┊\n ┊20┊23┊  constructor() {}\n+┊  ┊24┊\n+┊  ┊25┊  selectChat(id: string) {\n+┊  ┊26┊    this.select.emit(id);\n+┊  ┊27┊  }\n ┊21┊28┊}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.ts\n```diff\n@@ -2,6 +2,7 @@\n ┊2┊2┊import {ChatsService} from '../../../services/chats.service';\n ┊3┊3┊import {Observable} from 'rxjs';\n ┊4┊4┊import {GetChats} from '../../../../graphql';\n+┊ ┊5┊import {Router} from '@angular/router';\n ┊5┊6┊\n ┊6┊7┊@Component({\n ┊7┊8┊  template: `\n```\n```diff\n@@ -27,7 +28,7 @@\n ┊27┊28┊      </button>\n ┊28┊29┊    </mat-menu>\n ┊29┊30┊\n-┊30┊  ┊    <app-chats-list [items]=\"chats$ | async\"></app-chats-list>\n+┊  ┊31┊    <app-chats-list [items]=\"chats$ | async\" (select)=\"goToChat($event)\"></app-chats-list>\n ┊31┊32┊\n ┊32┊33┊    <button class=\"chat-button\" mat-fab color=\"secondary\">\n ┊33┊34┊      <mat-icon aria-label=\"Icon-button with a + icon\">chat</mat-icon>\n```\n```diff\n@@ -38,10 +39,15 @@\n ┊38┊39┊export class ChatsComponent implements OnInit {\n ┊39┊40┊  chats$: Observable<GetChats.Chats[]>;\n ┊40┊41┊\n-┊41┊  ┊  constructor(private chatsService: ChatsService) {\n+┊  ┊42┊  constructor(private chatsService: ChatsService,\n+┊  ┊43┊              private router: Router) {\n ┊42┊44┊  }\n ┊43┊45┊\n ┊44┊46┊  ngOnInit() {\n ┊45┊47┊    this.chats$ = this.chatsService.getChats().chats$;\n ┊46┊48┊  }\n+┊  ┊49┊\n+┊  ┊50┊  goToChat(chatId: string) {\n+┊  ┊51┊    this.router.navigate(['/chat', chatId]);\n+┊  ┊52┊  }\n ┊47┊53┊}\n```\n\n[}]: #\n\nTime for a next step, an actual implementation of the chat view.\n\n[{]: <helper> (diffStep \"4.1\" files=\"src/app/chat-viewer/containers/chat/chat.component.ts, src/app/chat-viewer/containers/chat/chat.component.scss\" module=\"client\")\n\n#### [Step 4.1: Chat Viewer](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/257159a)\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.scss\n```diff\n@@ -0,0 +1,33 @@\n+┊  ┊ 1┊app-toolbar {\n+┊  ┊ 2┊  .navigation {\n+┊  ┊ 3┊    padding: 0;\n+┊  ┊ 4┊    display: inherit;\n+┊  ┊ 5┊    margin-right: -40px;\n+┊  ┊ 6┊  }\n+┊  ┊ 7┊\n+┊  ┊ 8┊  .title {\n+┊  ┊ 9┊    line-height: 8vh;\n+┊  ┊10┊  }\n+┊  ┊11┊\n+┊  ┊12┊  .profile-pic {\n+┊  ┊13┊    height: calc(100% - 10px);\n+┊  ┊14┊    width: auto;\n+┊  ┊15┊    padding: 5px;\n+┊  ┊16┊    border-radius: 50%;\n+┊  ┊17┊  }\n+┊  ┊18┊}\n+┊  ┊19┊\n+┊  ┊20┊.container {\n+┊  ┊21┊  display: flex;\n+┊  ┊22┊  flex-flow: column;\n+┊  ┊23┊  justify-content: space-between;\n+┊  ┊24┊  height: calc(100vh - 8vh);\n+┊  ┊25┊  background-image: url(/assets/chat-background.jpg);\n+┊  ┊26┊  background-color: #E0DAD6;\n+┊  ┊27┊  background-repeat: no-repeat;\n+┊  ┊28┊  background-size: cover;\n+┊  ┊29┊\n+┊  ┊30┊  app-confirm-selection {\n+┊  ┊31┊    bottom: 10vh;\n+┊  ┊32┊  }\n+┊  ┊33┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.ts\n```diff\n@@ -0,0 +1,46 @@\n+┊  ┊ 1┊import {Component, OnInit} from '@angular/core';\n+┊  ┊ 2┊import {ActivatedRoute, Router} from '@angular/router';\n+┊  ┊ 3┊import {ChatsService} from '../../../services/chats.service';\n+┊  ┊ 4┊\n+┊  ┊ 5┊@Component({\n+┊  ┊ 6┊  template: `\n+┊  ┊ 7┊    <app-toolbar>\n+┊  ┊ 8┊      <button class=\"navigation\" mat-button (click)=\"goToChats()\">\n+┊  ┊ 9┊        <mat-icon aria-label=\"Icon-button with an arrow back icon\">arrow_back</mat-icon>\n+┊  ┊10┊      </button>\n+┊  ┊11┊      <img class=\"profile-pic\" src=\"assets/default-profile-pic.jpg\">\n+┊  ┊12┊      <div class=\"title\">{{ name }}</div>\n+┊  ┊13┊    </app-toolbar>\n+┊  ┊14┊    <div class=\"container\">\n+┊  ┊15┊      <app-messages-list [items]=\"messages\" [isGroup]=\"isGroup\"></app-messages-list>\n+┊  ┊16┊      <app-new-message></app-new-message>\n+┊  ┊17┊    </div>\n+┊  ┊18┊  `,\n+┊  ┊19┊  styleUrls: ['./chat.component.scss']\n+┊  ┊20┊})\n+┊  ┊21┊export class ChatComponent implements OnInit {\n+┊  ┊22┊  chatId: string;\n+┊  ┊23┊  messages: any[];\n+┊  ┊24┊  name: string;\n+┊  ┊25┊  isGroup: boolean;\n+┊  ┊26┊\n+┊  ┊27┊  constructor(private route: ActivatedRoute,\n+┊  ┊28┊              private router: Router,\n+┊  ┊29┊              private chatsService: ChatsService) {\n+┊  ┊30┊  }\n+┊  ┊31┊\n+┊  ┊32┊  ngOnInit() {\n+┊  ┊33┊    this.route.params.subscribe(({id: chatId}) => {\n+┊  ┊34┊      this.chatId = chatId;\n+┊  ┊35┊      this.chatsService.getChat(chatId).chat$.subscribe(chat => {\n+┊  ┊36┊        this.messages = chat.messages;\n+┊  ┊37┊        this.name = chat.name;\n+┊  ┊38┊        this.isGroup = chat.isGroup;\n+┊  ┊39┊      });\n+┊  ┊40┊    });\n+┊  ┊41┊  }\n+┊  ┊42┊\n+┊  ┊43┊  goToChats() {\n+┊  ┊44┊    this.router.navigate(['/chats']);\n+┊  ┊45┊  }\n+┊  ┊46┊}\n```\n\n[}]: #\n\nThe `ChatComponent` component contains:\n\n - Toolbar with chat's name and a \"go back\" button\n - List of messages sorted from oldest to newest\n - Space to submit a new message\n\n### List of messages\n\nFirst we'll download and a couple of images which will help us create a \"bubble\" effect for received messages:\n\n    $ wget https://raw.githubusercontent.com/Urigo/whatsapp-client-angularcli-material/c75c2416b1990da3588015f76b8338764f44d6ec/src/assets/chat-background.jpg -P src/assets\n    $ wget https://raw.githubusercontent.com/Urigo/whatsapp-client-angularcli-material/https://raw.githubusercontent.com/Urigo/whatsapp-client-angularcli-material/c75c2416b1990da3588015f76b8338764f44d6ec/src/assets/chat-background.jpg/src/assets/message-mine.png -P src/assets\n    $ wget https://raw.githubusercontent.com/Urigo/whatsapp-client-angularcli-material/https://raw.githubusercontent.com/Urigo/whatsapp-client-angularcli-material/c75c2416b1990da3588015f76b8338764f44d6ec/src/assets/chat-background.jpg/src/assets/message-other.png -P src/assets\n\nWe'll now split the list of messages to the host:\n\n[{]: <helper> (diffStep \"4.1\" files=\"src/app/chat-viewer/components/messages-list/messages-list.component.ts, src/app/chat-viewer/components/messages-list/messages-list.component.scss\" module=\"client\")\n\n#### [Step 4.1: Chat Viewer](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/257159a)\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;components&#x2F;messages-list&#x2F;messages-list.component.scss\n```diff\n@@ -0,0 +1,14 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊  height: 100%;\n+┊  ┊ 4┊}\n+┊  ┊ 5┊\n+┊  ┊ 6┊::ng-deep .mat-list-item-content {\n+┊  ┊ 7┊  display: block !important;\n+┊  ┊ 8┊}\n+┊  ┊ 9┊\n+┊  ┊10┊/*\n+┊  ┊11┊:host::-webkit-scrollbar {\n+┊  ┊12┊  display: none;\n+┊  ┊13┊}\n+┊  ┊14┊*/🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;components&#x2F;messages-list&#x2F;messages-list.component.ts\n```diff\n@@ -0,0 +1,23 @@\n+┊  ┊ 1┊import {Component, Input} from '@angular/core';\n+┊  ┊ 2┊\n+┊  ┊ 3┊@Component({\n+┊  ┊ 4┊  selector: 'app-messages-list',\n+┊  ┊ 5┊  template: `\n+┊  ┊ 6┊    <mat-list>\n+┊  ┊ 7┊      <mat-list-item *ngFor=\"let message of messages\">\n+┊  ┊ 8┊        <app-message-item [item]=\"message\" [isGroup]=\"isGroup\"></app-message-item>\n+┊  ┊ 9┊      </mat-list-item>\n+┊  ┊10┊    </mat-list>\n+┊  ┊11┊  `,\n+┊  ┊12┊  styleUrls: ['messages-list.component.scss'],\n+┊  ┊13┊})\n+┊  ┊14┊export class MessagesListComponent {\n+┊  ┊15┊  // tslint:disable-next-line:no-input-rename\n+┊  ┊16┊  @Input('items')\n+┊  ┊17┊  messages: any[];\n+┊  ┊18┊\n+┊  ┊19┊  @Input()\n+┊  ┊20┊  isGroup: boolean;\n+┊  ┊21┊\n+┊  ┊22┊  constructor() {}\n+┊  ┊23┊}\n```\n\n[}]: #\n\nand a reused component for each message:\n\n[{]: <helper> (diffStep \"4.1\" files=\"src/app/chat-viewer/components/message-item/message-item.component.ts, src/app/chat-viewer/components/message-item/message-item.component.scss\" module=\"client\")\n\n#### [Step 4.1: Chat Viewer](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/257159a)\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;components&#x2F;message-item&#x2F;message-item.component.scss\n```diff\n@@ -0,0 +1,66 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  margin-bottom: 9px;\n+┊  ┊ 3┊\n+┊  ┊ 4┊  &::after {\n+┊  ┊ 5┊    content: \"\";\n+┊  ┊ 6┊    display: table;\n+┊  ┊ 7┊    clear: both;\n+┊  ┊ 8┊  }\n+┊  ┊ 9┊}\n+┊  ┊10┊\n+┊  ┊11┊.message {\n+┊  ┊12┊  display: inline-block;\n+┊  ┊13┊  position: relative;\n+┊  ┊14┊  max-width: 100%;\n+┊  ┊15┊  border-radius: 7px;\n+┊  ┊16┊  box-shadow: 0 1px 2px rgba(0, 0, 0, .15);\n+┊  ┊17┊\n+┊  ┊18┊  &.message-mine {\n+┊  ┊19┊    float: right;\n+┊  ┊20┊    background-color: #DCF8C6;\n+┊  ┊21┊\n+┊  ┊22┊    &::before {\n+┊  ┊23┊      right: -11px;\n+┊  ┊24┊      background-image: url(/assets/message-mine.png)\n+┊  ┊25┊    }\n+┊  ┊26┊  }\n+┊  ┊27┊\n+┊  ┊28┊  &.message-other {\n+┊  ┊29┊    float: left;\n+┊  ┊30┊    background-color: #FFF;\n+┊  ┊31┊\n+┊  ┊32┊    &::before {\n+┊  ┊33┊      left: -11px;\n+┊  ┊34┊      background-image: url(/assets/message-other.png)\n+┊  ┊35┊    }\n+┊  ┊36┊  }\n+┊  ┊37┊\n+┊  ┊38┊  &.message-other::before, &.message-mine::before {\n+┊  ┊39┊    content: \"\";\n+┊  ┊40┊    position: absolute;\n+┊  ┊41┊    bottom: 3px;\n+┊  ┊42┊    width: 12px;\n+┊  ┊43┊    height: 19px;\n+┊  ┊44┊    background-position: 50% 50%;\n+┊  ┊45┊    background-repeat: no-repeat;\n+┊  ┊46┊    background-size: contain;\n+┊  ┊47┊  }\n+┊  ┊48┊\n+┊  ┊49┊  .message-content {\n+┊  ┊50┊    padding: 5px 7px;\n+┊  ┊51┊    word-wrap: break-word;\n+┊  ┊52┊\n+┊  ┊53┊    &::after {\n+┊  ┊54┊      content: \" \\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\";\n+┊  ┊55┊      display: inline;\n+┊  ┊56┊    }\n+┊  ┊57┊  }\n+┊  ┊58┊\n+┊  ┊59┊  .message-timestamp {\n+┊  ┊60┊    position: absolute;\n+┊  ┊61┊    bottom: 2px;\n+┊  ┊62┊    right: 7px;\n+┊  ┊63┊    color: gray;\n+┊  ┊64┊    font-size: 12px;\n+┊  ┊65┊  }\n+┊  ┊66┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;components&#x2F;message-item&#x2F;message-item.component.ts\n```diff\n@@ -0,0 +1,22 @@\n+┊  ┊ 1┊import {Component, Input} from '@angular/core';\n+┊  ┊ 2┊\n+┊  ┊ 3┊@Component({\n+┊  ┊ 4┊  selector: 'app-message-item',\n+┊  ┊ 5┊  template: `\n+┊  ┊ 6┊    <div class=\"message\"\n+┊  ┊ 7┊         [ngClass]=\"message.ownership ? 'message-mine' : 'message-other'\">\n+┊  ┊ 8┊      <div *ngIf=\"isGroup && !message.ownership\" class=\"message-sender\">{{ message.sender.name }}</div>\n+┊  ┊ 9┊      <div class=\"message-content\">{{ message.content }}</div>\n+┊  ┊10┊      <span class=\"message-timestamp\">00:00</span>\n+┊  ┊11┊    </div>\n+┊  ┊12┊  `,\n+┊  ┊13┊  styleUrls: ['message-item.component.scss'],\n+┊  ┊14┊})\n+┊  ┊15┊export class MessageItemComponent {\n+┊  ┊16┊  // tslint:disable-next-line:no-input-rename\n+┊  ┊17┊  @Input('item')\n+┊  ┊18┊  message: any;\n+┊  ┊19┊\n+┊  ┊20┊  @Input()\n+┊  ┊21┊  isGroup: boolean;\n+┊  ┊22┊}\n```\n\n[}]: #\n\nAs you see, we could easily decide which message comes from which user based on the `ownership` property.\n\n### Submit a new message\n\nThe app shows the conversation and now we're going to focus on the last part, actually emitting a new message!\n\n[{]: <helper> (diffStep \"4.1\" files=\"src/app/chat-viewer/components/new-message/new-message.component.scss, src/app/chat-viewer/components/new-message/new-message.component.ts\" module=\"client\")\n\n#### [Step 4.1: Chat Viewer](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/257159a)\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;components&#x2F;new-message&#x2F;new-message.component.scss\n```diff\n@@ -0,0 +1,32 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: flex;\n+┊  ┊ 3┊  height: 50px;\n+┊  ┊ 4┊  padding: 5px;\n+┊  ┊ 5┊}\n+┊  ┊ 6┊\n+┊  ┊ 7┊input {\n+┊  ┊ 8┊  width: 100%;\n+┊  ┊ 9┊  border: none;\n+┊  ┊10┊  border-radius: 999px;\n+┊  ┊11┊  padding: 10px;\n+┊  ┊12┊  padding-left: 20px;\n+┊  ┊13┊  padding-right: 20px;\n+┊  ┊14┊  font-size: 15px;\n+┊  ┊15┊  outline: none;\n+┊  ┊16┊  box-shadow: 0 1px silver;\n+┊  ┊17┊  font-size: 18px;\n+┊  ┊18┊  line-height: 45px;\n+┊  ┊19┊}\n+┊  ┊20┊\n+┊  ┊21┊button {\n+┊  ┊22┊  min-width: 45px;\n+┊  ┊23┊  width: 45px;\n+┊  ┊24┊  border-radius: 999px;\n+┊  ┊25┊  background-color: var(--primary);\n+┊  ┊26┊  margin-left: 5px;\n+┊  ┊27┊  color: white;\n+┊  ┊28┊\n+┊  ┊29┊  mat-icon {\n+┊  ┊30┊    margin-left: -3px;\n+┊  ┊31┊  }\n+┊  ┊32┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;components&#x2F;new-message&#x2F;new-message.component.ts\n```diff\n@@ -0,0 +1,34 @@\n+┊  ┊ 1┊import {Component, EventEmitter, Input, Output} from '@angular/core';\n+┊  ┊ 2┊\n+┊  ┊ 3┊@Component({\n+┊  ┊ 4┊  selector: 'app-new-message',\n+┊  ┊ 5┊  template: `\n+┊  ┊ 6┊    <input type=\"text\" placeholder=\"Type a message\" [(ngModel)]=\"message\" (keyup)=\"onInputKeyup($event)\"/>\n+┊  ┊ 7┊    <button mat-button (click)=\"emitMessage()\" [disabled]=\"disabled\">\n+┊  ┊ 8┊      <mat-icon aria-label=\"Icon-button with a send icon\">send</mat-icon>\n+┊  ┊ 9┊    </button>\n+┊  ┊10┊  `,\n+┊  ┊11┊  styleUrls: ['new-message.component.scss'],\n+┊  ┊12┊})\n+┊  ┊13┊export class NewMessageComponent {\n+┊  ┊14┊  @Input()\n+┊  ┊15┊  disabled: boolean;\n+┊  ┊16┊\n+┊  ┊17┊  @Output()\n+┊  ┊18┊  newMessage = new EventEmitter<string>();\n+┊  ┊19┊\n+┊  ┊20┊  message = '';\n+┊  ┊21┊\n+┊  ┊22┊  onInputKeyup({ keyCode }: KeyboardEvent) {\n+┊  ┊23┊    if (keyCode === 13) {\n+┊  ┊24┊      this.emitMessage();\n+┊  ┊25┊    }\n+┊  ┊26┊  }\n+┊  ┊27┊\n+┊  ┊28┊  emitMessage() {\n+┊  ┊29┊    if (this.message && !this.disabled) {\n+┊  ┊30┊      this.newMessage.emit(this.message);\n+┊  ┊31┊      this.message = '';\n+┊  ┊32┊    }\n+┊  ┊33┊  }\n+┊  ┊34┊}\n```\n\n[}]: #\n\nIt's not yet fully functional, we receive the message in the `ChatComponent` but we still need to send it to the server. We'll cover that in next few steps!"
          },
          {
            "manualTitle": "Step 9: Mutations",
            "stepRevision": "fcbc9a30cfdd7004eabc050189a94dad094e2ed7",
            "manualView": "In addition to fetching data using queries, Apollo also helps you handle GraphQL mutations. In GraphQL, mutations are identical to queries in syntax, the only difference being that you use the keyword mutation instead of query to indicate that the root fields on this query are going to be performing writes to the backend.\nGraphQL mutations represent two things in one query string:\n\n1. The mutation field name with arguments, which represents the actual operation to be done on the server.\n2. The fields you want back from the result of the mutation to update the client.\n\nWhen we use mutations in Apollo, the result is typically integrated into the cache automatically based on the id of the result, which in turn updates the UI automatically, so we often don't need to explicitly handle the results. In order for the client to correctly do this, we need to ensure we select the necessary fields in the result. One good strategy can be to simply ask for any fields that might have been affected by the mutation. Alternatively, you can use fragments to share the fields between a query and a mutation that updates that query.\n\n## Server\n\nFinally we're going to create our mutations in the server:\n\n[{]: <helper> (diffStep \"3.1\" module=\"server\")\n\n#### [Step 3.1: Add mutations](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/db205b7)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,6 +1,7 @@\n ┊1┊1┊import { IResolvers } from 'apollo-server-express';\n-┊2┊ ┊import { Chat, db, Message, Recipient, User } from \"../db\";\n+┊ ┊2┊import { Chat, db, Message, MessageType, Recipient, User } from \"../db\";\n ┊3┊3┊import { ChatQueryArgs } from \"../types\";\n+┊ ┊4┊import * as moment from \"moment\";\n ┊4┊5┊\n ┊5┊6┊let users = db.users;\n ┊6┊7┊let chats = db.chats;\n```\n```diff\n@@ -13,6 +14,276 @@\n ┊ 13┊ 14┊    chats: (): Chat[] => chats.filter(chat => chat.listingMemberIds.includes(currentUser)),\n ┊ 14┊ 15┊    chat: (obj: any, {chatId}: ChatQueryArgs): Chat | null => chats.find(chat => chat.id === Number(chatId)) || null,\n ┊ 15┊ 16┊  },\n+┊   ┊ 17┊  Mutation: {\n+┊   ┊ 18┊    addChat: (obj: any, {recipientId}: any): Chat => {\n+┊   ┊ 19┊      if (!users.find(user => user.id === recipientId)) {\n+┊   ┊ 20┊        throw new Error(`Recipient ${recipientId} doesn't exist.`);\n+┊   ┊ 21┊      }\n+┊   ┊ 22┊\n+┊   ┊ 23┊      const chat = chats.find(chat => !chat.name && chat.allTimeMemberIds.includes(currentUser) && chat.allTimeMemberIds.includes(recipientId));\n+┊   ┊ 24┊      if (chat) {\n+┊   ┊ 25┊        // Chat already exists. Both users are already in the allTimeMemberIds array\n+┊   ┊ 26┊        const chatId = chat.id;\n+┊   ┊ 27┊        if (!chat.listingMemberIds.includes(currentUser)) {\n+┊   ┊ 28┊          // The chat isn't listed for the current user. Add him to the memberIds\n+┊   ┊ 29┊          chat.listingMemberIds.push(currentUser);\n+┊   ┊ 30┊          chats.find(chat => chat.id === chatId)!.listingMemberIds.push(currentUser);\n+┊   ┊ 31┊          return chat;\n+┊   ┊ 32┊        } else {\n+┊   ┊ 33┊          throw new Error(`Chat already exists.`);\n+┊   ┊ 34┊        }\n+┊   ┊ 35┊      } else {\n+┊   ┊ 36┊        // Create the chat\n+┊   ┊ 37┊        const id = (chats.length && chats[chats.length - 1].id + 1) || 1;\n+┊   ┊ 38┊        const chat: Chat = {\n+┊   ┊ 39┊          id,\n+┊   ┊ 40┊          name: null,\n+┊   ┊ 41┊          picture: null,\n+┊   ┊ 42┊          adminIds: null,\n+┊   ┊ 43┊          ownerId: null,\n+┊   ┊ 44┊          allTimeMemberIds: [currentUser, recipientId],\n+┊   ┊ 45┊          // Chat will not be listed to the other user until the first message gets written\n+┊   ┊ 46┊          listingMemberIds: [currentUser],\n+┊   ┊ 47┊          actualGroupMemberIds: null,\n+┊   ┊ 48┊          messages: [],\n+┊   ┊ 49┊        };\n+┊   ┊ 50┊        chats.push(chat);\n+┊   ┊ 51┊        return chat;\n+┊   ┊ 52┊      }\n+┊   ┊ 53┊    },\n+┊   ┊ 54┊    addGroup: (obj: any, {recipientIds, groupName}: any): Chat => {\n+┊   ┊ 55┊      recipientIds.forEach((recipientId: any) => {\n+┊   ┊ 56┊        if (!users.find(user => user.id === recipientId)) {\n+┊   ┊ 57┊          throw new Error(`Recipient ${recipientId} doesn't exist.`);\n+┊   ┊ 58┊        }\n+┊   ┊ 59┊      });\n+┊   ┊ 60┊\n+┊   ┊ 61┊      const id = (chats.length && chats[chats.length - 1].id + 1) || 1;\n+┊   ┊ 62┊      const chat: Chat = {\n+┊   ┊ 63┊        id,\n+┊   ┊ 64┊        name: groupName,\n+┊   ┊ 65┊        picture: null,\n+┊   ┊ 66┊        adminIds: [currentUser],\n+┊   ┊ 67┊        ownerId: currentUser,\n+┊   ┊ 68┊        allTimeMemberIds: [currentUser, ...recipientIds],\n+┊   ┊ 69┊        listingMemberIds: [currentUser, ...recipientIds],\n+┊   ┊ 70┊        actualGroupMemberIds: [currentUser, ...recipientIds],\n+┊   ┊ 71┊        messages: [],\n+┊   ┊ 72┊      };\n+┊   ┊ 73┊      chats.push(chat);\n+┊   ┊ 74┊      return chat;\n+┊   ┊ 75┊    },\n+┊   ┊ 76┊    removeChat: (obj: any, {chatId}: any): number => {\n+┊   ┊ 77┊      const chat = chats.find(chat => chat.id === chatId);\n+┊   ┊ 78┊\n+┊   ┊ 79┊      if (!chat) {\n+┊   ┊ 80┊        throw new Error(`The chat ${chatId} doesn't exist.`);\n+┊   ┊ 81┊      }\n+┊   ┊ 82┊\n+┊   ┊ 83┊      if (!chat.name) {\n+┊   ┊ 84┊        // Chat\n+┊   ┊ 85┊        if (!chat.listingMemberIds.includes(currentUser)) {\n+┊   ┊ 86┊          throw new Error(`The user is not a member of the chat ${chatId}.`);\n+┊   ┊ 87┊        }\n+┊   ┊ 88┊\n+┊   ┊ 89┊        // Instead of chaining map and filter we can loop once using reduce\n+┊   ┊ 90┊        const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n+┊   ┊ 91┊          // Remove the current user from the message holders\n+┊   ┊ 92┊          message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser);\n+┊   ┊ 93┊\n+┊   ┊ 94┊          if (message.holderIds.length !== 0) {\n+┊   ┊ 95┊            filtered.push(message);\n+┊   ┊ 96┊          } // else discard the message\n+┊   ┊ 97┊\n+┊   ┊ 98┊          return filtered;\n+┊   ┊ 99┊        }, []);\n+┊   ┊100┊\n+┊   ┊101┊        // Remove the current user from who gets the chat listed. The chat will no longer appear in his list\n+┊   ┊102┊        const listingMemberIds = chat.listingMemberIds.filter(listingId => listingId !== currentUser);\n+┊   ┊103┊\n+┊   ┊104┊        // Check how many members are left\n+┊   ┊105┊        if (listingMemberIds.length === 0) {\n+┊   ┊106┊          // Delete the chat\n+┊   ┊107┊          chats = chats.filter(chat => chat.id !== chatId);\n+┊   ┊108┊        } else {\n+┊   ┊109┊          // Update the chat\n+┊   ┊110┊          chats = chats.map(chat => {\n+┊   ┊111┊            if (chat.id === chatId) {\n+┊   ┊112┊              chat = {...chat, listingMemberIds, messages};\n+┊   ┊113┊            }\n+┊   ┊114┊            return chat;\n+┊   ┊115┊          });\n+┊   ┊116┊        }\n+┊   ┊117┊        return chatId;\n+┊   ┊118┊      } else {\n+┊   ┊119┊        // Group\n+┊   ┊120┊        if (chat.ownerId !== currentUser) {\n+┊   ┊121┊          throw new Error(`Group ${chatId} is not owned by the user.`);\n+┊   ┊122┊        }\n+┊   ┊123┊\n+┊   ┊124┊        // Instead of chaining map and filter we can loop once using reduce\n+┊   ┊125┊        const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n+┊   ┊126┊          // Remove the current user from the message holders\n+┊   ┊127┊          message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser);\n+┊   ┊128┊\n+┊   ┊129┊          if (message.holderIds.length !== 0) {\n+┊   ┊130┊            filtered.push(message);\n+┊   ┊131┊          } // else discard the message\n+┊   ┊132┊\n+┊   ┊133┊          return filtered;\n+┊   ┊134┊        }, []);\n+┊   ┊135┊\n+┊   ┊136┊        // Remove the current user from who gets the group listed. The group will no longer appear in his list\n+┊   ┊137┊        const listingMemberIds = chat.listingMemberIds.filter(listingId => listingId !== currentUser);\n+┊   ┊138┊\n+┊   ┊139┊        // Check how many members (including previous ones who can still access old messages) are left\n+┊   ┊140┊        if (listingMemberIds.length === 0) {\n+┊   ┊141┊          // Remove the group\n+┊   ┊142┊          chats = chats.filter(chat => chat.id !== chatId);\n+┊   ┊143┊        } else {\n+┊   ┊144┊          // Update the group\n+┊   ┊145┊\n+┊   ┊146┊          // Remove the current user from the chat members. He is no longer a member of the group\n+┊   ┊147┊          const actualGroupMemberIds = chat.actualGroupMemberIds!.filter(memberId => memberId !== currentUser);\n+┊   ┊148┊          // Remove the current user from the chat admins\n+┊   ┊149┊          const adminIds = chat.adminIds!.filter(memberId => memberId !== currentUser);\n+┊   ┊150┊          // Set the owner id to be null. A null owner means the group is read-only\n+┊   ┊151┊          let ownerId: number | null = null;\n+┊   ┊152┊\n+┊   ┊153┊          // Check if there is any admin left\n+┊   ┊154┊          if (adminIds!.length) {\n+┊   ┊155┊            // Pick an admin as the new owner. The group is no longer read-only\n+┊   ┊156┊            ownerId = chat.adminIds![0];\n+┊   ┊157┊          }\n+┊   ┊158┊\n+┊   ┊159┊          chats = chats.map(chat => {\n+┊   ┊160┊            if (chat.id === chatId) {\n+┊   ┊161┊              chat = {...chat, messages, listingMemberIds, actualGroupMemberIds, adminIds, ownerId};\n+┊   ┊162┊            }\n+┊   ┊163┊            return chat;\n+┊   ┊164┊          });\n+┊   ┊165┊        }\n+┊   ┊166┊        return chatId;\n+┊   ┊167┊      }\n+┊   ┊168┊    },\n+┊   ┊169┊    addMessage: (obj: any, {chatId, content}: any): Message => {\n+┊   ┊170┊      if (content === null || content === '') {\n+┊   ┊171┊        throw new Error(`Cannot add empty or null messages.`);\n+┊   ┊172┊      }\n+┊   ┊173┊\n+┊   ┊174┊      let chat = chats.find(chat => chat.id === chatId);\n+┊   ┊175┊\n+┊   ┊176┊      if (!chat) {\n+┊   ┊177┊        throw new Error(`Cannot find chat ${chatId}.`);\n+┊   ┊178┊      }\n+┊   ┊179┊\n+┊   ┊180┊      let holderIds = chat.listingMemberIds;\n+┊   ┊181┊\n+┊   ┊182┊      if (!chat.name) {\n+┊   ┊183┊        // Chat\n+┊   ┊184┊        if (!chat.listingMemberIds.find(listingId => listingId === currentUser)) {\n+┊   ┊185┊          throw new Error(`The chat ${chatId} must be listed for the current user before adding a message.`);\n+┊   ┊186┊        }\n+┊   ┊187┊\n+┊   ┊188┊        const recipientId = chat.allTimeMemberIds.filter(userId => userId !== currentUser)[0];\n+┊   ┊189┊\n+┊   ┊190┊        if (!chat.listingMemberIds.find(listingId => listingId === recipientId)) {\n+┊   ┊191┊          // Chat is not listed for the recipient. Add him to the listingMemberIds\n+┊   ┊192┊          const listingMemberIds = chat.listingMemberIds.concat(recipientId);\n+┊   ┊193┊\n+┊   ┊194┊          chats = chats.map(chat => {\n+┊   ┊195┊            if (chat.id === chatId) {\n+┊   ┊196┊              chat = {...chat, listingMemberIds};\n+┊   ┊197┊            }\n+┊   ┊198┊            return chat;\n+┊   ┊199┊          });\n+┊   ┊200┊\n+┊   ┊201┊          holderIds = listingMemberIds;\n+┊   ┊202┊        }\n+┊   ┊203┊      } else {\n+┊   ┊204┊        // Group\n+┊   ┊205┊        if (!chat.actualGroupMemberIds!.find(memberId => memberId === currentUser)) {\n+┊   ┊206┊          throw new Error(`The user is not a member of the group ${chatId}. Cannot add message.`);\n+┊   ┊207┊        }\n+┊   ┊208┊\n+┊   ┊209┊        holderIds = chat.actualGroupMemberIds!;\n+┊   ┊210┊      }\n+┊   ┊211┊\n+┊   ┊212┊      const id = (chat.messages.length && chat.messages[chat.messages.length - 1].id + 1) || 1;\n+┊   ┊213┊\n+┊   ┊214┊      let recipients: Recipient[] = [];\n+┊   ┊215┊\n+┊   ┊216┊      holderIds.forEach(holderId => {\n+┊   ┊217┊        if (holderId !== currentUser) {\n+┊   ┊218┊          recipients.push({\n+┊   ┊219┊            userId: holderId,\n+┊   ┊220┊            messageId: id,\n+┊   ┊221┊            chatId: chatId,\n+┊   ┊222┊            receivedAt: null,\n+┊   ┊223┊            readAt: null,\n+┊   ┊224┊          });\n+┊   ┊225┊        }\n+┊   ┊226┊      });\n+┊   ┊227┊\n+┊   ┊228┊      const message: Message = {\n+┊   ┊229┊        id,\n+┊   ┊230┊        chatId,\n+┊   ┊231┊        senderId: currentUser,\n+┊   ┊232┊        content,\n+┊   ┊233┊        createdAt: moment().unix(),\n+┊   ┊234┊        type: MessageType.TEXT,\n+┊   ┊235┊        recipients,\n+┊   ┊236┊        holderIds,\n+┊   ┊237┊      };\n+┊   ┊238┊\n+┊   ┊239┊      chats = chats.map(chat => {\n+┊   ┊240┊        if (chat.id === chatId) {\n+┊   ┊241┊          chat = {...chat, messages: chat.messages.concat(message)}\n+┊   ┊242┊        }\n+┊   ┊243┊        return chat;\n+┊   ┊244┊      });\n+┊   ┊245┊\n+┊   ┊246┊      return message;\n+┊   ┊247┊    },\n+┊   ┊248┊    removeMessages: (obj: any, {chatId, messageIds, all}: any): number[] => {\n+┊   ┊249┊      const chat = chats.find(chat => chat.id === chatId);\n+┊   ┊250┊\n+┊   ┊251┊      if (!chat) {\n+┊   ┊252┊        throw new Error(`Cannot find chat ${chatId}.`);\n+┊   ┊253┊      }\n+┊   ┊254┊\n+┊   ┊255┊      if (!chat.listingMemberIds.find(listingId => listingId === currentUser)) {\n+┊   ┊256┊        throw new Error(`The chat/group ${chatId} is not listed for the current user, so there is nothing to delete.`);\n+┊   ┊257┊      }\n+┊   ┊258┊\n+┊   ┊259┊      if (all && messageIds) {\n+┊   ┊260┊        throw new Error(`Cannot specify both 'all' and 'messageIds'.`);\n+┊   ┊261┊      }\n+┊   ┊262┊\n+┊   ┊263┊      let deletedIds: number[] = [];\n+┊   ┊264┊      chats = chats.map(chat => {\n+┊   ┊265┊        if (chat.id === chatId) {\n+┊   ┊266┊          // Instead of chaining map and filter we can loop once using reduce\n+┊   ┊267┊          const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n+┊   ┊268┊            if (all || messageIds!.includes(message.id)) {\n+┊   ┊269┊              deletedIds.push(message.id);\n+┊   ┊270┊              // Remove the current user from the message holders\n+┊   ┊271┊              message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser);\n+┊   ┊272┊            }\n+┊   ┊273┊\n+┊   ┊274┊            if (message.holderIds.length !== 0) {\n+┊   ┊275┊              filtered.push(message);\n+┊   ┊276┊            } // else discard the message\n+┊   ┊277┊\n+┊   ┊278┊            return filtered;\n+┊   ┊279┊          }, []);\n+┊   ┊280┊          chat = {...chat, messages};\n+┊   ┊281┊        }\n+┊   ┊282┊        return chat;\n+┊   ┊283┊      });\n+┊   ┊284┊      return deletedIds;\n+┊   ┊285┊    },\n+┊   ┊286┊  },\n ┊ 16┊287┊  Chat: {\n ┊ 17┊288┊    name: (chat: Chat): string => chat.name ? chat.name : users\n ┊ 18┊289┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser))!.name,\n```\n\n##### Changed schema&#x2F;typeDefs.ts\n```diff\n@@ -65,4 +65,20 @@\n ┊65┊65┊    picture: String\n ┊66┊66┊    phone: String\n ┊67┊67┊  }\n+┊  ┊68┊\n+┊  ┊69┊  type Mutation {\n+┊  ┊70┊    addChat(recipientId: ID!): Chat\n+┊  ┊71┊    addGroup(recipientIds: [ID!]!, groupName: String!): Chat\n+┊  ┊72┊    removeChat(chatId: ID!): ID\n+┊  ┊73┊    addMessage(chatId: ID!, content: String!): Message\n+┊  ┊74┊    removeMessages(chatId: ID!, messageIds: [ID], all: Boolean): [ID]\n+┊  ┊75┊    addMembers(groupId: ID!, userIds: [ID!]!): [ID]\n+┊  ┊76┊    removeMembers(groupId: ID!, userIds: [ID!]!): [ID]\n+┊  ┊77┊    addAdmins(groupId: ID!, userIds: [ID!]!): [ID]\n+┊  ┊78┊    removeAdmins(groupId: ID!, userIds: [ID!]!): [ID]\n+┊  ┊79┊    setGroupName(groupId: ID!): String\n+┊  ┊80┊    setGroupPicture(groupId: ID!): String\n+┊  ┊81┊    markAsReceived(chatId: ID!): Boolean\n+┊  ┊82┊    markAsRead(chatId: ID!): Boolean\n+┊  ┊83┊  }\n ┊68┊84┊`;\n```\n\n[}]: #\n\nLet me briefly explain what's going on here.\nFor each chat/group we store the `allTimeMemberIds`, `listingMemberIds` and `actualGroupMemberIds` properties in our NoSQL-like fake db.\nWhat's the difference between `allTimeMemberIds` and `listingMemberIds`? When a chat gets created only the user who created it will be able too see it, the chat will be displayed to the other user only once the first messaged gets sent. `allTimeMemberIds` is an array which always contain both the users, while `listingMemberIds` contains only the users which get the chat listed (initially the creator, later both users). `actualGroupMemberIds` is only used for groups.\nGroups, instead, get listed by all members immediately since the creation. So initially both `allTimeMemberIds`, `listingMemberIds` and `actualGroupMemberIds` are similar. Later users can leave the group or get deleted (so they will be removed from `actualGroupMemberIds`) but they will still be able to list the group in read-only mode, thus remaining in the `listingMemberIds`. Once they remove the group they will also be remove from the `listingMemberIds` array.\nThat's why we have to check for several different conditions before adding/deleting messages: it could be necessary to add the other peer to the `listingMemberIds` (for example if we are writing the first message of a chat) or it could be necessary to physically remove the messages instead of simply removing the current user from the `holderIds`. `holderIds` is a field in each message which states which user will currently display that specific message. In fact each user can delete a specific message without affecting what the others will see. Once there will be no more users in the `holderIds` array it will be safe to delete the message.\nEach message has also a `recipients` array containing the receiving date and the viewing date of that particular message for all the other users. That's necessary to implement the single, double and blue ticks used by the real Whatsapp.\n\nIt may seem a bit overwhelming at first, but you should keep in mind that the real Whatsapp has tons of features and also takes advantage of a local database to store messages, so it's easier for them to implement features like per-user messages: their source of truth is not the server because once downloaded the messages are kept in the client itself, so deleting messages doesn't affect anyone else. On the contrary our source of truth is the server, so our approach is more similar to Telegram instead. This is a better approach in my opinion because it allows us to show the messages for the same user on multiple clients, instead of having to rely on questionable approaches like Whatsapp Web.\nAlso we already implemented our mutations to take care of future use cases (like reading notifications) which we still didn't implement.\n\nI said we were going to take greater advantage of `graphql-code-generator` once we started writing our first mutation and I'm going to show you why. Let's run the generator first:\n\n    yarn generator\n\nThen let's use the generated types:\n\n[{]: <helper> (diffStep \"3.3\" module=\"server\")\n\n#### [Step 3.3: Use generated types](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/b7b1be3)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,6 +1,9 @@\n ┊1┊1┊import { IResolvers } from 'apollo-server-express';\n ┊2┊2┊import { Chat, db, Message, MessageType, Recipient, User } from \"../db\";\n-┊3┊ ┊import { ChatQueryArgs } from \"../types\";\n+┊ ┊3┊import {\n+┊ ┊4┊  AddChatMutationArgs, AddGroupMutationArgs, AddMessageMutationArgs, ChatQueryArgs,\n+┊ ┊5┊  RemoveChatMutationArgs, RemoveMessagesMutationArgs\n+┊ ┊6┊} from \"../types\";\n ┊4┊7┊import * as moment from \"moment\";\n ┊5┊8┊\n ┊6┊9┊let users = db.users;\n```\n```diff\n@@ -15,12 +18,12 @@\n ┊15┊18┊    chat: (obj: any, {chatId}: ChatQueryArgs): Chat | null => chats.find(chat => chat.id === Number(chatId)) || null,\n ┊16┊19┊  },\n ┊17┊20┊  Mutation: {\n-┊18┊  ┊    addChat: (obj: any, {recipientId}: any): Chat => {\n-┊19┊  ┊      if (!users.find(user => user.id === recipientId)) {\n+┊  ┊21┊    addChat: (obj: any, {recipientId}: AddChatMutationArgs): Chat => {\n+┊  ┊22┊      if (!users.find(user => user.id === Number(recipientId))) {\n ┊20┊23┊        throw new Error(`Recipient ${recipientId} doesn't exist.`);\n ┊21┊24┊      }\n ┊22┊25┊\n-┊23┊  ┊      const chat = chats.find(chat => !chat.name && chat.allTimeMemberIds.includes(currentUser) && chat.allTimeMemberIds.includes(recipientId));\n+┊  ┊26┊      const chat = chats.find(chat => !chat.name && chat.allTimeMemberIds.includes(currentUser) && chat.allTimeMemberIds.includes(Number(recipientId)));\n ┊24┊27┊      if (chat) {\n ┊25┊28┊        // Chat already exists. Both users are already in the allTimeMemberIds array\n ┊26┊29┊        const chatId = chat.id;\n```\n```diff\n@@ -41,7 +44,7 @@\n ┊41┊44┊          picture: null,\n ┊42┊45┊          adminIds: null,\n ┊43┊46┊          ownerId: null,\n-┊44┊  ┊          allTimeMemberIds: [currentUser, recipientId],\n+┊  ┊47┊          allTimeMemberIds: [currentUser, Number(recipientId)],\n ┊45┊48┊          // Chat will not be listed to the other user until the first message gets written\n ┊46┊49┊          listingMemberIds: [currentUser],\n ┊47┊50┊          actualGroupMemberIds: null,\n```\n```diff\n@@ -51,9 +54,9 @@\n ┊51┊54┊        return chat;\n ┊52┊55┊      }\n ┊53┊56┊    },\n-┊54┊  ┊    addGroup: (obj: any, {recipientIds, groupName}: any): Chat => {\n-┊55┊  ┊      recipientIds.forEach((recipientId: any) => {\n-┊56┊  ┊        if (!users.find(user => user.id === recipientId)) {\n+┊  ┊57┊    addGroup: (obj: any, {recipientIds, groupName}: AddGroupMutationArgs): Chat => {\n+┊  ┊58┊      recipientIds.forEach(recipientId => {\n+┊  ┊59┊        if (!users.find(user => user.id === Number(recipientId))) {\n ┊57┊60┊          throw new Error(`Recipient ${recipientId} doesn't exist.`);\n ┊58┊61┊        }\n ┊59┊62┊      });\n```\n```diff\n@@ -65,16 +68,16 @@\n ┊65┊68┊        picture: null,\n ┊66┊69┊        adminIds: [currentUser],\n ┊67┊70┊        ownerId: currentUser,\n-┊68┊  ┊        allTimeMemberIds: [currentUser, ...recipientIds],\n-┊69┊  ┊        listingMemberIds: [currentUser, ...recipientIds],\n-┊70┊  ┊        actualGroupMemberIds: [currentUser, ...recipientIds],\n+┊  ┊71┊        allTimeMemberIds: [currentUser, ...recipientIds.map(id => Number(id))],\n+┊  ┊72┊        listingMemberIds: [currentUser, ...recipientIds.map(id => Number(id))],\n+┊  ┊73┊        actualGroupMemberIds: [currentUser, ...recipientIds.map(id => Number(id))],\n ┊71┊74┊        messages: [],\n ┊72┊75┊      };\n ┊73┊76┊      chats.push(chat);\n ┊74┊77┊      return chat;\n ┊75┊78┊    },\n-┊76┊  ┊    removeChat: (obj: any, {chatId}: any): number => {\n-┊77┊  ┊      const chat = chats.find(chat => chat.id === chatId);\n+┊  ┊79┊    removeChat: (obj: any, {chatId}: RemoveChatMutationArgs): number => {\n+┊  ┊80┊      const chat = chats.find(chat => chat.id === Number(chatId));\n ┊78┊81┊\n ┊79┊82┊      if (!chat) {\n ┊80┊83┊        throw new Error(`The chat ${chatId} doesn't exist.`);\n```\n```diff\n@@ -104,17 +107,17 @@\n ┊104┊107┊        // Check how many members are left\n ┊105┊108┊        if (listingMemberIds.length === 0) {\n ┊106┊109┊          // Delete the chat\n-┊107┊   ┊          chats = chats.filter(chat => chat.id !== chatId);\n+┊   ┊110┊          chats = chats.filter(chat => chat.id !== Number(chatId));\n ┊108┊111┊        } else {\n ┊109┊112┊          // Update the chat\n ┊110┊113┊          chats = chats.map(chat => {\n-┊111┊   ┊            if (chat.id === chatId) {\n+┊   ┊114┊            if (chat.id === Number(chatId)) {\n ┊112┊115┊              chat = {...chat, listingMemberIds, messages};\n ┊113┊116┊            }\n ┊114┊117┊            return chat;\n ┊115┊118┊          });\n ┊116┊119┊        }\n-┊117┊   ┊        return chatId;\n+┊   ┊120┊        return Number(chatId);\n ┊118┊121┊      } else {\n ┊119┊122┊        // Group\n ┊120┊123┊        if (chat.ownerId !== currentUser) {\n```\n```diff\n@@ -139,7 +142,7 @@\n ┊139┊142┊        // Check how many members (including previous ones who can still access old messages) are left\n ┊140┊143┊        if (listingMemberIds.length === 0) {\n ┊141┊144┊          // Remove the group\n-┊142┊   ┊          chats = chats.filter(chat => chat.id !== chatId);\n+┊   ┊145┊          chats = chats.filter(chat => chat.id !== Number(chatId));\n ┊143┊146┊        } else {\n ┊144┊147┊          // Update the group\n ┊145┊148┊\n```\n```diff\n@@ -157,21 +160,21 @@\n ┊157┊160┊          }\n ┊158┊161┊\n ┊159┊162┊          chats = chats.map(chat => {\n-┊160┊   ┊            if (chat.id === chatId) {\n+┊   ┊163┊            if (chat.id === Number(chatId)) {\n ┊161┊164┊              chat = {...chat, messages, listingMemberIds, actualGroupMemberIds, adminIds, ownerId};\n ┊162┊165┊            }\n ┊163┊166┊            return chat;\n ┊164┊167┊          });\n ┊165┊168┊        }\n-┊166┊   ┊        return chatId;\n+┊   ┊169┊        return Number(chatId);\n ┊167┊170┊      }\n ┊168┊171┊    },\n-┊169┊   ┊    addMessage: (obj: any, {chatId, content}: any): Message => {\n+┊   ┊172┊    addMessage: (obj: any, {chatId, content}: AddMessageMutationArgs): Message => {\n ┊170┊173┊      if (content === null || content === '') {\n ┊171┊174┊        throw new Error(`Cannot add empty or null messages.`);\n ┊172┊175┊      }\n ┊173┊176┊\n-┊174┊   ┊      let chat = chats.find(chat => chat.id === chatId);\n+┊   ┊177┊      let chat = chats.find(chat => chat.id === Number(chatId));\n ┊175┊178┊\n ┊176┊179┊      if (!chat) {\n ┊177┊180┊        throw new Error(`Cannot find chat ${chatId}.`);\n```\n```diff\n@@ -192,7 +195,7 @@\n ┊192┊195┊          const listingMemberIds = chat.listingMemberIds.concat(recipientId);\n ┊193┊196┊\n ┊194┊197┊          chats = chats.map(chat => {\n-┊195┊   ┊            if (chat.id === chatId) {\n+┊   ┊198┊            if (chat.id === Number(chatId)) {\n ┊196┊199┊              chat = {...chat, listingMemberIds};\n ┊197┊200┊            }\n ┊198┊201┊            return chat;\n```\n```diff\n@@ -218,7 +221,7 @@\n ┊218┊221┊          recipients.push({\n ┊219┊222┊            userId: holderId,\n ┊220┊223┊            messageId: id,\n-┊221┊   ┊            chatId: chatId,\n+┊   ┊224┊            chatId: Number(chatId),\n ┊222┊225┊            receivedAt: null,\n ┊223┊226┊            readAt: null,\n ┊224┊227┊          });\n```\n```diff\n@@ -227,7 +230,7 @@\n ┊227┊230┊\n ┊228┊231┊      const message: Message = {\n ┊229┊232┊        id,\n-┊230┊   ┊        chatId,\n+┊   ┊233┊        chatId: Number(chatId),\n ┊231┊234┊        senderId: currentUser,\n ┊232┊235┊        content,\n ┊233┊236┊        createdAt: moment().unix(),\n```\n```diff\n@@ -237,7 +240,7 @@\n ┊237┊240┊      };\n ┊238┊241┊\n ┊239┊242┊      chats = chats.map(chat => {\n-┊240┊   ┊        if (chat.id === chatId) {\n+┊   ┊243┊        if (chat.id === Number(chatId)) {\n ┊241┊244┊          chat = {...chat, messages: chat.messages.concat(message)}\n ┊242┊245┊        }\n ┊243┊246┊        return chat;\n```\n```diff\n@@ -245,8 +248,8 @@\n ┊245┊248┊\n ┊246┊249┊      return message;\n ┊247┊250┊    },\n-┊248┊   ┊    removeMessages: (obj: any, {chatId, messageIds, all}: any): number[] => {\n-┊249┊   ┊      const chat = chats.find(chat => chat.id === chatId);\n+┊   ┊251┊    removeMessages: (obj: any, {chatId, messageIds, all}: RemoveMessagesMutationArgs): number[] => {\n+┊   ┊252┊      const chat = chats.find(chat => chat.id === Number(chatId));\n ┊250┊253┊\n ┊251┊254┊      if (!chat) {\n ┊252┊255┊        throw new Error(`Cannot find chat ${chatId}.`);\n```\n```diff\n@@ -262,10 +265,10 @@\n ┊262┊265┊\n ┊263┊266┊      let deletedIds: number[] = [];\n ┊264┊267┊      chats = chats.map(chat => {\n-┊265┊   ┊        if (chat.id === chatId) {\n+┊   ┊268┊        if (chat.id === Number(chatId)) {\n ┊266┊269┊          // Instead of chaining map and filter we can loop once using reduce\n ┊267┊270┊          const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n-┊268┊   ┊            if (all || messageIds!.includes(message.id)) {\n+┊   ┊271┊            if (all || messageIds!.includes(String(message.id))) {\n ┊269┊272┊              deletedIds.push(message.id);\n ┊270┊273┊              // Remove the current user from the message holders\n ┊271┊274┊              message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser);\n```\n\n[}]: #\n\n## Client\n\nFor the client I'll only show you how to make use of the addMessage mutation in this chapters. The other mutations will require much more boilerplate so I left them for their own chapter.\n\nLet's start by wiring the addMessage mutation. We're going to write the GraphQL query and then use the generator to generate the types:\n\n[{]: <helper> (diffStep \"5.1\" files=\"^\\(?!src/types.d.ts$\\).*\" module=\"client\")\n\n#### [Step 5.1: Create addMessage mutation and generate types](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/706d62e)\n\n##### Changed src&#x2F;graphql.ts\n```diff\n@@ -600,6 +600,20 @@\n ┊600┊600┊  > = Resolver<R, Parent, Context>;\n ┊601┊601┊}\n ┊602┊602┊\n+┊   ┊603┊export namespace AddMessage {\n+┊   ┊604┊  export type Variables = {\n+┊   ┊605┊    chatId: string;\n+┊   ┊606┊    content: string;\n+┊   ┊607┊  };\n+┊   ┊608┊\n+┊   ┊609┊  export type Mutation = {\n+┊   ┊610┊    __typename?: \"Mutation\";\n+┊   ┊611┊    addMessage?: AddMessage | null;\n+┊   ┊612┊  };\n+┊   ┊613┊\n+┊   ┊614┊  export type AddMessage = Message.Fragment;\n+┊   ┊615┊}\n+┊   ┊616┊\n ┊603┊617┊export namespace GetChat {\n ┊604┊618┊  export type Variables = {\n ┊605┊619┊    chatId: string;\n```\n```diff\n@@ -760,6 +774,23 @@\n ┊760┊774┊  }\n ┊761┊775┊`;\n ┊762┊776┊\n+┊   ┊777┊@Injectable({\n+┊   ┊778┊  providedIn: \"root\"\n+┊   ┊779┊})\n+┊   ┊780┊export class AddMessageGQL extends Apollo.Mutation<\n+┊   ┊781┊  AddMessage.Mutation,\n+┊   ┊782┊  AddMessage.Variables\n+┊   ┊783┊> {\n+┊   ┊784┊  document: any = gql`\n+┊   ┊785┊    mutation AddMessage($chatId: ID!, $content: String!) {\n+┊   ┊786┊      addMessage(chatId: $chatId, content: $content) {\n+┊   ┊787┊        ...Message\n+┊   ┊788┊      }\n+┊   ┊789┊    }\n+┊   ┊790┊\n+┊   ┊791┊    ${MessageFragment}\n+┊   ┊792┊  `;\n+┊   ┊793┊}\n ┊763┊794┊@Injectable({\n ┊764┊795┊  providedIn: \"root\"\n ┊765┊796┊})\n```\n\n##### Added src&#x2F;graphql&#x2F;addMessage.mutation.ts\n```diff\n@@ -0,0 +1,13 @@\n+┊  ┊ 1┊import gql from 'graphql-tag';\n+┊  ┊ 2┊import {fragments} from './fragment';\n+┊  ┊ 3┊\n+┊  ┊ 4┊// We use the gql tag to parse our query string into a query document\n+┊  ┊ 5┊export const addMessageMutation = gql`\n+┊  ┊ 6┊  mutation AddMessage($chatId: ID!, $content: String!) {\n+┊  ┊ 7┊    addMessage(chatId: $chatId, content: $content) {\n+┊  ┊ 8┊      ...Message\n+┊  ┊ 9┊    }\n+┊  ┊10┊  }\n+┊  ┊11┊\n+┊  ┊12┊  ${fragments['message']}\n+┊  ┊13┊`;\n```\n\n[}]: #\n\nRun the generator:\n\n    yarn generator\n\nNow let's use the just-created query:\n\n[{]: <helper> (diffStep \"5.2\" module=\"client\")\n\n#### [Step 5.2: Modify chat component and service](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/ad6a5da)\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.ts\n```diff\n@@ -14,7 +14,7 @@\n ┊14┊14┊    </app-toolbar>\n ┊15┊15┊    <div class=\"container\">\n ┊16┊16┊      <app-messages-list [items]=\"messages\" [isGroup]=\"isGroup\"></app-messages-list>\n-┊17┊  ┊      <app-new-message></app-new-message>\n+┊  ┊17┊      <app-new-message (newMessage)=\"addMessage($event)\"></app-new-message>\n ┊18┊18┊    </div>\n ┊19┊19┊  `,\n ┊20┊20┊  styleUrls: ['./chat.component.scss']\n```\n```diff\n@@ -44,4 +44,8 @@\n ┊44┊44┊  goToChats() {\n ┊45┊45┊    this.router.navigate(['/chats']);\n ┊46┊46┊  }\n+┊  ┊47┊\n+┊  ┊48┊  addMessage(content: string) {\n+┊  ┊49┊    this.chatsService.addMessage(this.chatId, content).subscribe();\n+┊  ┊50┊  }\n ┊47┊51┊}\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,6 +1,6 @@\n ┊1┊1┊import {map} from 'rxjs/operators';\n ┊2┊2┊import {Injectable} from '@angular/core';\n-┊3┊ ┊import {GetChatsGQL, GetChatGQL} from '../../graphql';\n+┊ ┊3┊import {GetChatsGQL, GetChatGQL, AddMessageGQL} from '../../graphql';\n ┊4┊4┊\n ┊5┊5┊@Injectable()\n ┊6┊6┊export class ChatsService {\n```\n```diff\n@@ -8,7 +8,8 @@\n ┊ 8┊ 8┊\n ┊ 9┊ 9┊  constructor(\n ┊10┊10┊    private getChatsGQL: GetChatsGQL,\n-┊11┊  ┊    private getChatGQL: GetChatGQL\n+┊  ┊11┊    private getChatGQL: GetChatGQL,\n+┊  ┊12┊    private addMessageGQL: AddMessageGQL\n ┊12┊13┊  ) {}\n ┊13┊14┊\n ┊14┊15┊  getChats() {\n```\n```diff\n@@ -33,4 +34,11 @@\n ┊33┊34┊\n ┊34┊35┊    return {query, chat$};\n ┊35┊36┊  }\n+┊  ┊37┊\n+┊  ┊38┊  addMessage(chatId: string, content: string) {\n+┊  ┊39┊    return this.addMessageGQL.mutate({\n+┊  ┊40┊      chatId,\n+┊  ┊41┊      content,\n+┊  ┊42┊    });\n+┊  ┊43┊  }\n ┊36┊44┊}\n```\n\n[}]: #\n\nIt's that simple! You would be tempted to say that it doesn't work, but you should try to refresh the page first ;)"
          },
          {
            "manualTitle": "Step 10: Updating the store",
            "stepRevision": "04749f21bfdeecb76145491e1d4d373102ad8969",
            "manualView": "## Client\n\nDid you notice that after creating a new message you'll have to refresh the page in order to see it?\n\nHow to fix that?\n\nApollo performs two important core tasks which we covered in one of previous steps: executing queries and mutations, and caching the results.\n\nThanks to Apollo's store design, it's possible for the results of a query or mutation to update your UI in all the right places. In many cases it's possible for that to happen automatically, whereas in others you need to help the client out a little in doing so.\n\nThere are couple of APIs to update the cache after mutation:\n\n- `refetchQueries` - is the most straightforward way of updating the cache. You request queries to be executed once again.\n- `update` - super flexible and allows you to make changes to the store based on mutation. Works well with Optimistic UI which we will cover later.\n- `updateQueries` - It works similar to the previous option but the API may be deprecated in the future and we recommend to stay with `update`.\n\nIf you thought about re-querying the server you would be wrong! The best solution is to use the response provided by the server to update our Apollo local cache.\n\nOf course that we're going to use the `update` API!\n\n### Updating the store\n\nAs you can see, the `update` option is a function that has two arguments:\n\n- `DataProxy` which we named `store`\n- mutation's result\n\nThe `DataProxy` seems very interesting! It's a middleman between you and the cache.\n\n#### How to update fragments\n\nIn pretty much every case, that middleman would allow to write and read data. Take for example the JavaScript `Map` object.\n\nIt has a `get` and `set` methods and both works based on a `key`.\n\nIn Apollo, we do have that key, it's something that was covered in the 5th step, remember? An object of type `Message` with an `id` would be stored in the cache as `Message:<id>`.\n\nLet's call that small object a fragment, for simplicity.\n\nWhat are our _get_ and _set_ methods in Apollo's DataProxy? Simple, `readFragment` and `writeFragment`.\n\nI think it's time to work on a simple example. Scenario: every message can be liked and we keep the sum of likes under the `likes` field.\n\nHow to give a like?\n\n```typescript\nconst store: DataProxy = ...;\nconst messageId = 256;\n\nconst fragment = gql`\n  fragment M on Message {\n    likes\n  }\n`;\nconst fragmentId = `Message:${messageId}`;\n\nconst message = store.readFragment({\n  fragment,\n  id: fragmentId\n});\n\nstore.writeFragment({\n  fragment,\n  id: fragmentId,\n  data: {\n    likes: message.likes + 1\n  }\n});\n```\n\nWhat just happened?!\n\nAt first, it might seem weird to talk to the store like that but you will see that it makes a lot of sense!\n\n - `messageId` - defined the actual id of our message\n - `fragment` - it's a document that tells Apollo what fields we want to read and write\n - `fragmentId` - an unique key under which the fragment is stored (we covered that in 5th step)\n - `readFragment` - reads the fragment in the store and returns the result in exact same shape as requested\n - `writeFragment` - accepts same properties as `readFragment` but also the `data` property\n\n### How to update queries\n\nSimilar as in case of fragments, we update queries with `readQuery` and `writeQuery`.\n\nWe won't cover the same thing again but let's just look at the API based on our WhatsApp clone example:\n\n[{]: <helper> (diffStep \"6.1\" module=\"client\")\n\n#### [Step 6.1: Update the store](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/cb01e16)\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,6 +1,13 @@\n ┊ 1┊ 1┊import {map} from 'rxjs/operators';\n ┊ 2┊ 2┊import {Injectable} from '@angular/core';\n-┊ 3┊  ┊import {GetChatsGQL, GetChatGQL, AddMessageGQL} from '../../graphql';\n+┊  ┊ 3┊import {\n+┊  ┊ 4┊  GetChatsGQL,\n+┊  ┊ 5┊  GetChatGQL,\n+┊  ┊ 6┊  AddMessageGQL,\n+┊  ┊ 7┊  AddMessage,\n+┊  ┊ 8┊  GetChats,\n+┊  ┊ 9┊  GetChat\n+┊  ┊10┊} from '../../graphql';\n ┊ 4┊11┊\n ┊ 5┊12┊@Injectable()\n ┊ 6┊13┊export class ChatsService {\n```\n```diff\n@@ -39,6 +46,50 @@\n ┊39┊46┊    return this.addMessageGQL.mutate({\n ┊40┊47┊      chatId,\n ┊41┊48┊      content,\n+┊  ┊49┊    }, {\n+┊  ┊50┊      update: (store, { data: { addMessage } }: {data: AddMessage.Mutation}) => {\n+┊  ┊51┊        // Update the messages cache\n+┊  ┊52┊        {\n+┊  ┊53┊          // Read the data from our cache for this query.\n+┊  ┊54┊          const {chat} = store.readQuery<GetChat.Query, GetChat.Variables>({\n+┊  ┊55┊            query: this.getChatGQL.document,\n+┊  ┊56┊            variables: {\n+┊  ┊57┊              chatId,\n+┊  ┊58┊            }\n+┊  ┊59┊          });\n+┊  ┊60┊          // Add our message from the mutation to the end.\n+┊  ┊61┊          chat.messages.push(addMessage);\n+┊  ┊62┊          // Write our data back to the cache.\n+┊  ┊63┊          store.writeQuery({\n+┊  ┊64┊            query: this.getChatGQL.document,\n+┊  ┊65┊            data: {\n+┊  ┊66┊              chat\n+┊  ┊67┊            }\n+┊  ┊68┊          });\n+┊  ┊69┊        }\n+┊  ┊70┊        // Update last message cache\n+┊  ┊71┊        {\n+┊  ┊72┊          // Read the data from our cache for this query.\n+┊  ┊73┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n+┊  ┊74┊            query: this.getChatsGQL.document,\n+┊  ┊75┊            variables: {\n+┊  ┊76┊              amount: this.messagesAmount,\n+┊  ┊77┊            },\n+┊  ┊78┊          });\n+┊  ┊79┊          // Add our comment from the mutation to the end.\n+┊  ┊80┊          chats.find(chat => chat.id === chatId).messages.push(addMessage);\n+┊  ┊81┊          // Write our data back to the cache.\n+┊  ┊82┊          store.writeQuery<GetChats.Query, GetChats.Variables>({\n+┊  ┊83┊            query: this.getChatsGQL.document,\n+┊  ┊84┊            variables: {\n+┊  ┊85┊              amount: this.messagesAmount,\n+┊  ┊86┊            },\n+┊  ┊87┊            data: {\n+┊  ┊88┊              chats,\n+┊  ┊89┊            },\n+┊  ┊90┊          });\n+┊  ┊91┊        }\n+┊  ┊92┊      }\n ┊42┊93┊    });\n ┊43┊94┊  }\n ┊44┊95┊}\n```\n\n[}]: #\n\nAs you can see we used the `document` property of a generated GQL service. It contains the actual query that is used in every `watch` or `fetch` calls of the GQL service. It's a part of the open API.\n\n### Keep on mind\n\nIt's very important to know few things:\n\n- update function have to run synchronously\n- the query should always match the query you want to update (even order of fields or variables matters)\n- by updating a query you also update every normalized data it has (we called them fragments in few secions above)\n\nWhen Apollo runs the `update` function? In two cases, rigth after the mutation happens but only if it has an optimistic response defined, and also once we get the response from the server.\n\n> Optimistic Resposne is something we will cover in next steps but so you know, Apollo allows to optimistically update the store with a temporary data that is being replaced right after we get the response from the server.\n\nBut why the update function has to run synchornously? It's by design and not so interesting. We won't cover it in-depth here but in short, when Apollo runs the function it switches the store with the new, empty one, to record every change that's made by the function to later merge it with the original store. If you still have questions, please let us know so we can cover that thing in-depth as a blog post or even a separate chapter in that tutorial.\n\n### Summary\n\nNow you won't need to reload the page in order to see the new message. What's even more interesting is that the message you wrote would also be shown as the last message in the chats list, just hit the back button in the top-left corner to find out!\n\nThis is because we updated our store for both the `GetChat` and the `GetChats` query."
          },
          {
            "manualTitle": "Step 11: Messages and chats removal",
            "stepRevision": "d924471909e13cc56a0bf23311554f1e7413130f",
            "manualView": "## Client\n\nSince we're now familiar with the way mutations work, it's time to add messages and chats removal to our list of features!\nSince the most annoying part is going to be dealing with the user interface (because a multiple selection started by a press event is involved), I created an Angular directive to ease the process.\n\nLet's start by adding `ngx-selectable-list`:\n\n    yarn add ngx-selectable-list\n\n[{]: <helper> (diffStep \"7.1\" module=\"client\")\n\n#### [Step 7.1: Add SelectableListModule](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/5ef06d0)\n\n##### Changed package.json\n```diff\n@@ -34,7 +34,8 @@\n ┊34┊34┊    \"graphql-tag\": \"2.10.0\",\n ┊35┊35┊    \"graphql\": \"14.0.2\",\n ┊36┊36┊    \"hammerjs\": \"2.0.8\",\n-┊37┊  ┊    \"ng2-truncate\": \"1.3.17\"\n+┊  ┊37┊    \"ng2-truncate\": \"1.3.17\",\n+┊  ┊38┊    \"ngx-selectable-list\": \"1.2.1\"\n ┊38┊39┊  },\n ┊39┊40┊  \"devDependencies\": {\n ┊40┊41┊    \"@angular-devkit/build-angular\": \"0.9.0-rc.2\",\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;chats-lister.module.ts\n```diff\n@@ -11,6 +11,7 @@\n ┊11┊11┊import {ChatsListComponent} from './components/chats-list/chats-list.component';\n ┊12┊12┊import {TruncateModule} from 'ng2-truncate';\n ┊13┊13┊import {SharedModule} from '../shared/shared.module';\n+┊  ┊14┊import {NgxSelectableListModule} from 'ngx-selectable-list';\n ┊14┊15┊\n ┊15┊16┊const routes: Routes = [\n ┊16┊17┊  {path: '', redirectTo: 'chats', pathMatch: 'full'},\n```\n```diff\n@@ -40,6 +41,7 @@\n ┊40┊41┊    TruncateModule,\n ┊41┊42┊    // Feature modules\n ┊42┊43┊    SharedModule,\n+┊  ┊44┊    NgxSelectableListModule,\n ┊43┊45┊  ],\n ┊44┊46┊  providers: [\n ┊45┊47┊    ChatsService,\n```\n\n[}]: #\n\nBecause we're going to use the `libSelectableList` directive, we can replace Outputs and EventEmitters with it:\n\n[{]: <helper> (diffStep \"7.2\" files=\"src/app/chats-lister/components/chat-item/chat-item.component.ts, src/app/chats-lister/components/chats-list/chats-list.component.ts, src/app/chat-viewer/components/messages-list/messages-list.component.ts\" module=\"client\")\n\n#### [Step 7.2: Remove messages and chats](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/18cfa7c)\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;components&#x2F;messages-list&#x2F;messages-list.component.ts\n```diff\n@@ -1,14 +1,17 @@\n ┊ 1┊ 1┊import {Component, Input} from '@angular/core';\n ┊ 2┊ 2┊import {GetChat} from '../../../../graphql';\n+┊  ┊ 3┊import {SelectableListDirective} from 'ngx-selectable-list';\n ┊ 3┊ 4┊\n ┊ 4┊ 5┊@Component({\n ┊ 5┊ 6┊  selector: 'app-messages-list',\n ┊ 6┊ 7┊  template: `\n ┊ 7┊ 8┊    <mat-list>\n ┊ 8┊ 9┊      <mat-list-item *ngFor=\"let message of messages\">\n-┊ 9┊  ┊        <app-message-item [item]=\"message\" [isGroup]=\"isGroup\"></app-message-item>\n+┊  ┊10┊        <app-message-item [item]=\"message\" [isGroup]=\"isGroup\"\n+┊  ┊11┊                          libSelectableItem></app-message-item>\n ┊10┊12┊      </mat-list-item>\n ┊11┊13┊    </mat-list>\n+┊  ┊14┊    <ng-content *ngIf=\"selectableListDirective.selecting\"></ng-content>\n ┊12┊15┊  `,\n ┊13┊16┊  styleUrls: ['messages-list.component.scss'],\n ┊14┊17┊})\n```\n```diff\n@@ -20,5 +23,5 @@\n ┊20┊23┊  @Input()\n ┊21┊24┊  isGroup: boolean;\n ┊22┊25┊\n-┊23┊  ┊  constructor() {}\n+┊  ┊26┊  constructor(public selectableListDirective: SelectableListDirective) {}\n ┊24┊27┊}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chat-item&#x2F;chat-item.component.ts\n```diff\n@@ -4,7 +4,7 @@\n ┊ 4┊ 4┊@Component({\n ┊ 5┊ 5┊  selector: 'app-chat-item',\n ┊ 6┊ 6┊  template: `\n-┊ 7┊  ┊    <div class=\"chat-row\" (click)=\"selectChat()\">\n+┊  ┊ 7┊    <div class=\"chat-row\">\n ┊ 8┊ 8┊      <img class=\"chat-pic\" [src]=\"chat.picture || 'assets/default-profile-pic.jpg'\">\n ┊ 9┊ 9┊      <div class=\"chat-info\">\n ┊10┊10┊        <div class=\"chat-name\">{{ chat.name }}</div>\n```\n```diff\n@@ -19,11 +19,4 @@\n ┊19┊19┊  // tslint:disable-next-line:no-input-rename\n ┊20┊20┊  @Input('item')\n ┊21┊21┊  chat: GetChats.Chats;\n-┊22┊  ┊\n-┊23┊  ┊  @Output()\n-┊24┊  ┊  select = new EventEmitter<string>();\n-┊25┊  ┊\n-┊26┊  ┊  selectChat() {\n-┊27┊  ┊    this.select.emit(this.chat.id);\n-┊28┊  ┊  }\n ┊29┊22┊}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chats-list&#x2F;chats-list.component.ts\n```diff\n@@ -1,14 +1,17 @@\n-┊ 1┊  ┊import {Component, EventEmitter, Input, Output} from '@angular/core';\n+┊  ┊ 1┊import {Component, Input} from '@angular/core';\n ┊ 2┊ 2┊import {GetChats} from '../../../../graphql';\n+┊  ┊ 3┊import {SelectableListDirective} from 'ngx-selectable-list';\n ┊ 3┊ 4┊\n ┊ 4┊ 5┊@Component({\n ┊ 5┊ 6┊  selector: 'app-chats-list',\n ┊ 6┊ 7┊  template: `\n ┊ 7┊ 8┊    <mat-list>\n ┊ 8┊ 9┊      <mat-list-item *ngFor=\"let chat of chats\">\n-┊ 9┊  ┊        <app-chat-item [item]=\"chat\" (select)=\"selectChat($event)\"></app-chat-item>\n+┊  ┊10┊        <app-chat-item [item]=\"chat\"\n+┊  ┊11┊                       libSelectableItem></app-chat-item>\n ┊10┊12┊      </mat-list-item>\n ┊11┊13┊    </mat-list>\n+┊  ┊14┊    <ng-content *ngIf=\"selectableListDirective.selecting\"></ng-content>\n ┊12┊15┊  `,\n ┊13┊16┊  styleUrls: ['chats-list.component.scss'],\n ┊14┊17┊})\n```\n```diff\n@@ -17,12 +20,5 @@\n ┊17┊20┊  @Input('items')\n ┊18┊21┊  chats: GetChats.Chats[];\n ┊19┊22┊\n-┊20┊  ┊  @Output()\n-┊21┊  ┊  select = new EventEmitter<string>();\n-┊22┊  ┊\n-┊23┊  ┊  constructor() {}\n-┊24┊  ┊\n-┊25┊  ┊  selectChat(id: string) {\n-┊26┊  ┊    this.select.emit(id);\n-┊27┊  ┊  }\n+┊  ┊23┊  constructor(public selectableListDirective: SelectableListDirective) {}\n ┊28┊24┊}\n```\n\n[}]: #\n\nDon't forget to add the `NgxSelectableListModule` to `ChatViewer` and `ChatLister` modules.\n\nWe also created a `ConfirmSelectionComponent` to use for content projection, since our selectable list directive will be able to listen to its events.\n\n[{]: <helper> (diffStep \"7.2\" files=\"src/app/shared/components/confirm-selection/confirm-selection.component.scss, src/app/shared/components/confirm-selection/confirm-selection.component.ts, src/app/shared/shared.module.ts\" module=\"client\")\n\n#### [Step 7.2: Remove messages and chats](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/18cfa7c)\n\n##### Added src&#x2F;app&#x2F;shared&#x2F;components&#x2F;confirm-selection&#x2F;confirm-selection.component.scss\n```diff\n@@ -0,0 +1,6 @@\n+┊ ┊1┊:host {\n+┊ ┊2┊  display: block;\n+┊ ┊3┊  position: absolute;\n+┊ ┊4┊  bottom: 5vw;\n+┊ ┊5┊  right: 5vw;\n+┊ ┊6┊}\n```\n\n##### Added src&#x2F;app&#x2F;shared&#x2F;components&#x2F;confirm-selection&#x2F;confirm-selection.component.ts\n```diff\n@@ -0,0 +1,21 @@\n+┊  ┊ 1┊import {Component, EventEmitter, Input, Output} from '@angular/core';\n+┊  ┊ 2┊\n+┊  ┊ 3┊@Component({\n+┊  ┊ 4┊  selector: 'app-confirm-selection',\n+┊  ┊ 5┊  template: `\n+┊  ┊ 6┊    <button mat-fab color=\"primary\" (click)=\"handleClick()\">\n+┊  ┊ 7┊      <mat-icon aria-label=\"Icon-button\">{{ icon }}</mat-icon>\n+┊  ┊ 8┊    </button>\n+┊  ┊ 9┊  `,\n+┊  ┊10┊  styleUrls: ['./confirm-selection.component.scss'],\n+┊  ┊11┊})\n+┊  ┊12┊export class ConfirmSelectionComponent {\n+┊  ┊13┊  @Input()\n+┊  ┊14┊  icon = 'delete';\n+┊  ┊15┊  @Output()\n+┊  ┊16┊  emitClick = new EventEmitter<null>();\n+┊  ┊17┊\n+┊  ┊18┊  handleClick() {\n+┊  ┊19┊    this.emitClick.emit();\n+┊  ┊20┊  }\n+┊  ┊21┊}\n```\n\n##### Changed src&#x2F;app&#x2F;shared&#x2F;shared.module.ts\n```diff\n@@ -1,19 +1,23 @@\n ┊ 1┊ 1┊import {BrowserModule} from '@angular/platform-browser';\n ┊ 2┊ 2┊import {NgModule} from '@angular/core';\n ┊ 3┊ 3┊\n-┊ 4┊  ┊import {MatToolbarModule} from '@angular/material';\n+┊  ┊ 4┊import {MatButtonModule, MatIconModule, MatToolbarModule} from '@angular/material';\n ┊ 5┊ 5┊import {ToolbarComponent} from './components/toolbar/toolbar.component';\n ┊ 6┊ 6┊import {FormsModule} from '@angular/forms';\n ┊ 7┊ 7┊import {BrowserAnimationsModule} from '@angular/platform-browser/animations';\n+┊  ┊ 8┊import {ConfirmSelectionComponent} from './components/confirm-selection/confirm-selection.component';\n ┊ 8┊ 9┊\n ┊ 9┊10┊@NgModule({\n ┊10┊11┊  declarations: [\n ┊11┊12┊    ToolbarComponent,\n+┊  ┊13┊    ConfirmSelectionComponent,\n ┊12┊14┊  ],\n ┊13┊15┊  imports: [\n ┊14┊16┊    BrowserModule,\n ┊15┊17┊    // Material\n ┊16┊18┊    MatToolbarModule,\n+┊  ┊19┊    MatIconModule,\n+┊  ┊20┊    MatButtonModule,\n ┊17┊21┊    // Animations\n ┊18┊22┊    BrowserAnimationsModule,\n ┊19┊23┊    // Forms\n```\n```diff\n@@ -22,6 +26,7 @@\n ┊22┊26┊  providers: [],\n ┊23┊27┊  exports: [\n ┊24┊28┊    ToolbarComponent,\n+┊  ┊29┊    ConfirmSelectionComponent,\n ┊25┊30┊  ],\n ┊26┊31┊})\n ┊27┊32┊export class SharedModule {\n```\n\n[}]: #\n\nGreat, let's finish the component part by adding the connection between our container components and the `ChatsService`. We're going to use `removeMessages` and `removeChat` methods.\n\n[{]: <helper> (diffStep \"7.2\" files=\"src/app/chat-viewer/containers/chat/chat.component.ts, src/app/chat-viewer/containers/chat/chat.component.spec.ts, src/app/chats-lister/containers/chats/chats.component.ts, src/app/chats-lister/containers/chats/chats.component.spec.ts\" module=\"client\")\n\n#### [Step 7.2: Remove messages and chats](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/18cfa7c)\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.spec.ts\n```diff\n@@ -20,6 +20,7 @@\n ┊20┊20┊  APOLLO_TESTING_CACHE,\n ┊21┊21┊} from 'apollo-angular/testing';\n ┊22┊22┊import { InMemoryCache } from 'apollo-cache-inmemory';\n+┊  ┊23┊import { NgxSelectableListModule } from 'ngx-selectable-list';\n ┊23┊24┊\n ┊24┊25┊import { dataIdFromObject } from '../../../graphql.module';\n ┊25┊26┊import { ChatComponent } from './chat.component';\n```\n```diff\n@@ -116,6 +117,7 @@\n ┊116┊117┊        SharedModule,\n ┊117┊118┊        ApolloTestingModule,\n ┊118┊119┊        RouterTestingModule,\n+┊   ┊120┊        NgxSelectableListModule,\n ┊119┊121┊      ],\n ┊120┊122┊      providers: [\n ┊121┊123┊        ChatsService,\n```\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.ts\n```diff\n@@ -13,7 +13,10 @@\n ┊13┊13┊      <div class=\"title\">{{ name }}</div>\n ┊14┊14┊    </app-toolbar>\n ┊15┊15┊    <div class=\"container\">\n-┊16┊  ┊      <app-messages-list [items]=\"messages\" [isGroup]=\"isGroup\"></app-messages-list>\n+┊  ┊16┊      <app-messages-list [items]=\"messages\" [isGroup]=\"isGroup\"\n+┊  ┊17┊                         libSelectableList=\"multiple_press\" (multiple)=\"deleteMessages($event)\">\n+┊  ┊18┊        <app-confirm-selection #confirmSelection></app-confirm-selection>\n+┊  ┊19┊      </app-messages-list>\n ┊17┊20┊      <app-new-message (newMessage)=\"addMessage($event)\"></app-new-message>\n ┊18┊21┊    </div>\n ┊19┊22┊  `,\n```\n```diff\n@@ -48,4 +51,8 @@\n ┊48┊51┊  addMessage(content: string) {\n ┊49┊52┊    this.chatsService.addMessage(this.chatId, content).subscribe();\n ┊50┊53┊  }\n+┊  ┊54┊\n+┊  ┊55┊  deleteMessages(messageIds: string[]) {\n+┊  ┊56┊    this.chatsService.removeMessages(this.chatId, this.messages, messageIds).subscribe();\n+┊  ┊57┊  }\n ┊51┊58┊}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.spec.ts\n```diff\n@@ -16,6 +16,7 @@\n ┊16┊16┊import { InMemoryCache } from 'apollo-cache-inmemory';\n ┊17┊17┊import { By } from '@angular/platform-browser';\n ┊18┊18┊import { RouterTestingModule } from '@angular/router/testing';\n+┊  ┊19┊import { NgxSelectableListModule } from 'ngx-selectable-list';\n ┊19┊20┊\n ┊20┊21┊import { GetChats } from '../../../../graphql';\n ┊21┊22┊import { dataIdFromObject } from '../../../graphql.module';\n```\n```diff\n@@ -334,6 +335,7 @@\n ┊334┊335┊        TruncateModule,\n ┊335┊336┊        ApolloTestingModule,\n ┊336┊337┊        RouterTestingModule,\n+┊   ┊338┊        NgxSelectableListModule,\n ┊337┊339┊      ],\n ┊338┊340┊      providers: [\n ┊339┊341┊        ChatsService,\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.ts\n```diff\n@@ -28,9 +28,13 @@\n ┊28┊28┊      </button>\n ┊29┊29┊    </mat-menu>\n ┊30┊30┊\n-┊31┊  ┊    <app-chats-list [items]=\"chats$ | async\" (select)=\"goToChat($event)\"></app-chats-list>\n+┊  ┊31┊    <app-chats-list [items]=\"chats$ | async\"\n+┊  ┊32┊                    libSelectableList=\"both\"\n+┊  ┊33┊                    (single)=\"goToChat($event)\" (multiple)=\"deleteChats($event)\" (isSelecting)=\"isSelecting = $event\">\n+┊  ┊34┊      <app-confirm-selection #confirmSelection></app-confirm-selection>\n+┊  ┊35┊    </app-chats-list>\n ┊32┊36┊\n-┊33┊  ┊    <button class=\"chat-button\" mat-fab color=\"secondary\">\n+┊  ┊37┊    <button *ngIf=\"!isSelecting\" class=\"chat-button\" mat-fab color=\"secondary\">\n ┊34┊38┊      <mat-icon aria-label=\"Icon-button with a + icon\">chat</mat-icon>\n ┊35┊39┊    </button>\n ┊36┊40┊  `,\n```\n```diff\n@@ -38,6 +42,7 @@\n ┊38┊42┊})\n ┊39┊43┊export class ChatsComponent implements OnInit {\n ┊40┊44┊  chats$: Observable<GetChats.Chats[]>;\n+┊  ┊45┊  isSelecting = false;\n ┊41┊46┊\n ┊42┊47┊  constructor(private chatsService: ChatsService,\n ┊43┊48┊              private router: Router) {\n```\n```diff\n@@ -50,4 +55,10 @@\n ┊50┊55┊  goToChat(chatId: string) {\n ┊51┊56┊    this.router.navigate(['/chat', chatId]);\n ┊52┊57┊  }\n+┊  ┊58┊\n+┊  ┊59┊  deleteChats(chatIds: string[]) {\n+┊  ┊60┊    chatIds.forEach(chatId => {\n+┊  ┊61┊      this.chatsService.removeChat(chatId).subscribe();\n+┊  ┊62┊    });\n+┊  ┊63┊  }\n ┊53┊64┊}\n```\n\n[}]: #\n\n### Connecting actions with the server\n\nThe UI part is pretty much complete but we still need to implement two methods in the `ChatsService`. We're going to create mutations to remove a chat, selected messages or all of them.\n\n[{]: <helper> (diffStep \"7.2\" files=\"src/graphql/removeChat.mutation.ts, src/graphql/removeMessages.mutation.ts, src/graphql/removeAllMessages.mutation.ts\" module=\"client\")\n\n#### [Step 7.2: Remove messages and chats](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/18cfa7c)\n\n##### Added src&#x2F;graphql&#x2F;removeAllMessages.mutation.ts\n```diff\n@@ -0,0 +1,8 @@\n+┊ ┊1┊import gql from 'graphql-tag';\n+┊ ┊2┊\n+┊ ┊3┊// We use the gql tag to parse our query string into a query document\n+┊ ┊4┊export const removeAllMessagesMutation = gql`\n+┊ ┊5┊  mutation RemoveAllMessages($chatId: ID!, $all: Boolean) {\n+┊ ┊6┊    removeMessages(chatId: $chatId, all: $all)\n+┊ ┊7┊  }\n+┊ ┊8┊`;\n```\n\n##### Added src&#x2F;graphql&#x2F;removeChat.mutation.ts\n```diff\n@@ -0,0 +1,8 @@\n+┊ ┊1┊import gql from 'graphql-tag';\n+┊ ┊2┊\n+┊ ┊3┊// We use the gql tag to parse our query string into a query document\n+┊ ┊4┊export const removeChatMutation = gql`\n+┊ ┊5┊  mutation RemoveChat($chatId: ID!) {\n+┊ ┊6┊    removeChat(chatId: $chatId)\n+┊ ┊7┊  }\n+┊ ┊8┊`;\n```\n\n##### Added src&#x2F;graphql&#x2F;removeMessages.mutation.ts\n```diff\n@@ -0,0 +1,8 @@\n+┊ ┊1┊import gql from 'graphql-tag';\n+┊ ┊2┊\n+┊ ┊3┊// We use the gql tag to parse our query string into a query document\n+┊ ┊4┊export const removeMessagesMutation = gql`\n+┊ ┊5┊  mutation RemoveMessages($chatId: ID!, $messageIds: [ID]) {\n+┊ ┊6┊    removeMessages(chatId: $chatId, messageIds: $messageIds)\n+┊ ┊7┊  }\n+┊ ┊8┊`;\n```\n\n[}]: #\n\nOnce again, we run the GraphQL Code Generator to get the GQL services:\n\n    yarn generator\n\nNow we can import those services, create `removeChat` and `removeMessages` methods in which we call a mutation.\n\n[{]: <helper> (diffStep \"7.2\" files=\"src/app/services/chats.service.ts\" module=\"client\")\n\n#### [Step 7.2: Remove messages and chats](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/18cfa7c)\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -4,10 +4,16 @@\n ┊ 4┊ 4┊  GetChatsGQL,\n ┊ 5┊ 5┊  GetChatGQL,\n ┊ 6┊ 6┊  AddMessageGQL,\n+┊  ┊ 7┊  RemoveChatGQL,\n+┊  ┊ 8┊  RemoveMessagesGQL,\n+┊  ┊ 9┊  RemoveAllMessagesGQL,\n ┊ 7┊10┊  AddMessage,\n ┊ 8┊11┊  GetChats,\n-┊ 9┊  ┊  GetChat\n+┊  ┊12┊  GetChat,\n+┊  ┊13┊  RemoveMessages,\n+┊  ┊14┊  RemoveAllMessages,\n ┊10┊15┊} from '../../graphql';\n+┊  ┊16┊import { DataProxy } from 'apollo-cache';\n ┊11┊17┊\n ┊12┊18┊@Injectable()\n ┊13┊19┊export class ChatsService {\n```\n```diff\n@@ -16,7 +22,10 @@\n ┊16┊22┊  constructor(\n ┊17┊23┊    private getChatsGQL: GetChatsGQL,\n ┊18┊24┊    private getChatGQL: GetChatGQL,\n-┊19┊  ┊    private addMessageGQL: AddMessageGQL\n+┊  ┊25┊    private addMessageGQL: AddMessageGQL,\n+┊  ┊26┊    private removeChatGQL: RemoveChatGQL,\n+┊  ┊27┊    private removeMessagesGQL: RemoveMessagesGQL,\n+┊  ┊28┊    private removeAllMessagesGQL: RemoveAllMessagesGQL,\n ┊20┊29┊  ) {}\n ┊21┊30┊\n ┊22┊31┊  getChats() {\n```\n```diff\n@@ -92,4 +101,112 @@\n ┊ 92┊101┊      }\n ┊ 93┊102┊    });\n ┊ 94┊103┊  }\n+┊   ┊104┊\n+┊   ┊105┊  removeChat(chatId: string) {\n+┊   ┊106┊    return this.removeChatGQL.mutate(\n+┊   ┊107┊      {\n+┊   ┊108┊        chatId,\n+┊   ┊109┊      }, {\n+┊   ┊110┊        update: (store, { data: { removeChat } }) => {\n+┊   ┊111┊          // Read the data from our cache for this query.\n+┊   ┊112┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊113┊            query: this.getChatsGQL.document,\n+┊   ┊114┊            variables: {\n+┊   ┊115┊              amount: this.messagesAmount,\n+┊   ┊116┊            },\n+┊   ┊117┊          });\n+┊   ┊118┊          // Remove the chat (mutable)\n+┊   ┊119┊          for (const index of chats.keys()) {\n+┊   ┊120┊            if (chats[index].id === removeChat) {\n+┊   ┊121┊              chats.splice(index, 1);\n+┊   ┊122┊            }\n+┊   ┊123┊          }\n+┊   ┊124┊          // Write our data back to the cache.\n+┊   ┊125┊          store.writeQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊126┊            query: this.getChatsGQL.document,\n+┊   ┊127┊            variables: {\n+┊   ┊128┊              amount: this.messagesAmount,\n+┊   ┊129┊            },\n+┊   ┊130┊            data: {\n+┊   ┊131┊              chats,\n+┊   ┊132┊            },\n+┊   ┊133┊          });\n+┊   ┊134┊        },\n+┊   ┊135┊      }\n+┊   ┊136┊    );\n+┊   ┊137┊  }\n+┊   ┊138┊\n+┊   ┊139┊  removeMessages(chatId: string, messages: GetChat.Messages[], messageIdsOrAll: string[] | boolean) {\n+┊   ┊140┊    let ids: string[] = [];\n+┊   ┊141┊\n+┊   ┊142┊    const options = {\n+┊   ┊143┊      update: (store: DataProxy, { data: { removeMessages } }: {data: RemoveMessages.Mutation | RemoveAllMessages.Mutation}) => {\n+┊   ┊144┊        // Update the messages cache\n+┊   ┊145┊        {\n+┊   ┊146┊          // Read the data from our cache for this query.\n+┊   ┊147┊          const {chat} = store.readQuery<GetChat.Query, GetChat.Variables>({\n+┊   ┊148┊            query: this.getChatGQL.document,\n+┊   ┊149┊            variables: {\n+┊   ┊150┊              chatId,\n+┊   ┊151┊            }\n+┊   ┊152┊          });\n+┊   ┊153┊          // Remove the messages (mutable)\n+┊   ┊154┊          removeMessages.forEach(messageId => {\n+┊   ┊155┊            for (const index of chat.messages.keys()) {\n+┊   ┊156┊              if (chat.messages[index].id === messageId) {\n+┊   ┊157┊                chat.messages.splice(index, 1);\n+┊   ┊158┊              }\n+┊   ┊159┊            }\n+┊   ┊160┊          });\n+┊   ┊161┊          // Write our data back to the cache.\n+┊   ┊162┊          store.writeQuery<GetChat.Query, GetChat.Variables>({\n+┊   ┊163┊            query: this.getChatGQL.document,\n+┊   ┊164┊            data: {\n+┊   ┊165┊              chat\n+┊   ┊166┊            }\n+┊   ┊167┊          });\n+┊   ┊168┊        }\n+┊   ┊169┊        // Update last message cache\n+┊   ┊170┊        {\n+┊   ┊171┊          // Read the data from our cache for this query.\n+┊   ┊172┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊173┊            query: this.getChatsGQL.document,\n+┊   ┊174┊            variables: {\n+┊   ┊175┊              amount: this.messagesAmount,\n+┊   ┊176┊            },\n+┊   ┊177┊          });\n+┊   ┊178┊          // Fix last message\n+┊   ┊179┊          chats.find(chat => chat.id === chatId).messages = messages\n+┊   ┊180┊            .filter(message => !ids.includes(message.id))\n+┊   ┊181┊            .sort((a, b) => Number(b.createdAt) - Number(a.createdAt)) || [];\n+┊   ┊182┊          // Write our data back to the cache.\n+┊   ┊183┊          store.writeQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊184┊            query: this.getChatsGQL.document,\n+┊   ┊185┊            variables: {\n+┊   ┊186┊              amount: this.messagesAmount,\n+┊   ┊187┊            },\n+┊   ┊188┊            data: {\n+┊   ┊189┊              chats,\n+┊   ┊190┊            },\n+┊   ┊191┊          });\n+┊   ┊192┊        }\n+┊   ┊193┊      }\n+┊   ┊194┊    };\n+┊   ┊195┊\n+┊   ┊196┊    if (typeof messageIdsOrAll === 'boolean') {\n+┊   ┊197┊      ids = messages.map(message => message.id);\n+┊   ┊198┊\n+┊   ┊199┊      return this.removeAllMessagesGQL.mutate({\n+┊   ┊200┊        chatId,\n+┊   ┊201┊        all: messageIdsOrAll\n+┊   ┊202┊      }, options);\n+┊   ┊203┊    } else {\n+┊   ┊204┊      ids = messageIdsOrAll;\n+┊   ┊205┊\n+┊   ┊206┊      return this.removeMessagesGQL.mutate({\n+┊   ┊207┊        chatId,\n+┊   ┊208┊        messageIds: messageIdsOrAll,\n+┊   ┊209┊      }, options);\n+┊   ┊210┊    }\n+┊   ┊211┊  }\n ┊ 95┊212┊}\n```\n\n[}]: #\n\nIt might seem like a lot but we simply just updating the store there.\n\n### Summary\n\nThe selectable list directive supports much more different use cases, for info please read the documentation.\n\nAs you can see `ngx-selectable-list` takes care of most of the boilerplate, giving us the freedom to concentrate on the actual code."
          },
          {
            "manualTitle": "Step 12: Chats creation",
            "stepRevision": "ee69029ee3985a5b2d46874694315646d04e5cd0",
            "manualView": "![new-chat](https://user-images.githubusercontent.com/7648874/49270347-ea25ea00-f4a3-11e8-98ac-f67de8bfd8d5.png)\n\n![new-group](https://user-images.githubusercontent.com/7648874/49270350-ec884400-f4a3-11e8-8baa-b6bba0f7f539.png)\n\nWe still cannot create new chats or groups, so let's implement it.\n\nWe're going to create a `ChatsCreation` module, with a `NewChat` and a `NewGroup` containers, along with several presentational components.\n\nWe're going to make use of the selectable list directive once again, to ease selecting the users when we're creating a new group.\nYou should also notice that we are looking for existing chats before creating a new one: if it already exists we're simply redirecting to that chat instead of creating a new one (the server wouldn't allow that anyway and it will simply\nreturn the chat id).\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/graphql/\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n##### Added src&#x2F;graphql&#x2F;addChat.mutation.ts\n```diff\n@@ -0,0 +1,17 @@\n+┊  ┊ 1┊import gql from 'graphql-tag';\n+┊  ┊ 2┊import {fragments} from './fragment';\n+┊  ┊ 3┊\n+┊  ┊ 4┊// We use the gql tag to parse our query string into a query document\n+┊  ┊ 5┊export const addChatMutation = gql`\n+┊  ┊ 6┊  mutation AddChat($recipientId: ID!) {\n+┊  ┊ 7┊    addChat(recipientId: $recipientId) {\n+┊  ┊ 8┊      ...ChatWithoutMessages\n+┊  ┊ 9┊      messages {\n+┊  ┊10┊        ...Message\n+┊  ┊11┊      }\n+┊  ┊12┊    }\n+┊  ┊13┊  }\n+┊  ┊14┊\n+┊  ┊15┊  ${fragments['chatWithoutMessages']}\n+┊  ┊16┊  ${fragments['message']}\n+┊  ┊17┊`;\n```\n\n##### Added src&#x2F;graphql&#x2F;addGroup.mutation.ts\n```diff\n@@ -0,0 +1,17 @@\n+┊  ┊ 1┊import gql from 'graphql-tag';\n+┊  ┊ 2┊import {fragments} from './fragment';\n+┊  ┊ 3┊\n+┊  ┊ 4┊// We use the gql tag to parse our query string into a query document\n+┊  ┊ 5┊export const addGroupMutation = gql`\n+┊  ┊ 6┊  mutation AddGroup($recipientIds: [ID!]!, $groupName: String!) {\n+┊  ┊ 7┊    addGroup(recipientIds: $recipientIds, groupName: $groupName) {\n+┊  ┊ 8┊      ...ChatWithoutMessages\n+┊  ┊ 9┊      messages {\n+┊  ┊10┊        ...Message\n+┊  ┊11┊      }\n+┊  ┊12┊    }\n+┊  ┊13┊  }\n+┊  ┊14┊\n+┊  ┊15┊  ${fragments['chatWithoutMessages']}\n+┊  ┊16┊  ${fragments['message']}\n+┊  ┊17┊`;\n```\n\n##### Added src&#x2F;graphql&#x2F;getUsers.query.ts\n```diff\n@@ -0,0 +1,12 @@\n+┊  ┊ 1┊import gql from 'graphql-tag';\n+┊  ┊ 2┊\n+┊  ┊ 3┊// We use the gql tag to parse our query string into a query document\n+┊  ┊ 4┊export const getUsersQuery = gql`\n+┊  ┊ 5┊  query GetUsers {\n+┊  ┊ 6┊    users {\n+┊  ┊ 7┊      id,\n+┊  ┊ 8┊      name,\n+┊  ┊ 9┊      picture,\n+┊  ┊10┊    }\n+┊  ┊11┊  }\n+┊  ┊12┊`;\n```\n\n[}]: #\n\nAfter creating the mutations we should run the generator to create the corresponding types and services:\n\n    yarn generator\n\nLet's jump straight into `ChatsService` and add few new methods:\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/app/services/chats.service.ts\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,5 +1,7 @@\n ┊1┊1┊import {map} from 'rxjs/operators';\n ┊2┊2┊import {Injectable} from '@angular/core';\n+┊ ┊3┊import {Observable} from 'rxjs';\n+┊ ┊4┊import {QueryRef} from 'apollo-angular';\n ┊3┊5┊import {\n ┊4┊6┊  GetChatsGQL,\n ┊5┊7┊  GetChatGQL,\n```\n```diff\n@@ -7,6 +9,9 @@\n ┊ 7┊ 9┊  RemoveChatGQL,\n ┊ 8┊10┊  RemoveMessagesGQL,\n ┊ 9┊11┊  RemoveAllMessagesGQL,\n+┊  ┊12┊  GetUsersGQL,\n+┊  ┊13┊  AddChatGQL,\n+┊  ┊14┊  AddGroupGQL,\n ┊10┊15┊  AddMessage,\n ┊11┊16┊  GetChats,\n ┊12┊17┊  GetChat,\n```\n```diff\n@@ -15,9 +20,14 @@\n ┊15┊20┊} from '../../graphql';\n ┊16┊21┊import { DataProxy } from 'apollo-cache';\n ┊17┊22┊\n+┊  ┊23┊const currentUserId = '1';\n+┊  ┊24┊\n ┊18┊25┊@Injectable()\n ┊19┊26┊export class ChatsService {\n ┊20┊27┊  messagesAmount = 3;\n+┊  ┊28┊  getChatsWq: QueryRef<GetChats.Query, GetChats.Variables>;\n+┊  ┊29┊  chats$: Observable<GetChats.Chats[]>;\n+┊  ┊30┊  chats: GetChats.Chats[];\n ┊21┊31┊\n ┊22┊32┊  constructor(\n ┊23┊33┊    private getChatsGQL: GetChatsGQL,\n```\n```diff\n@@ -26,17 +36,21 @@\n ┊26┊36┊    private removeChatGQL: RemoveChatGQL,\n ┊27┊37┊    private removeMessagesGQL: RemoveMessagesGQL,\n ┊28┊38┊    private removeAllMessagesGQL: RemoveAllMessagesGQL,\n-┊29┊  ┊  ) {}\n-┊30┊  ┊\n-┊31┊  ┊  getChats() {\n-┊32┊  ┊    const query = this.getChatsGQL.watch({\n+┊  ┊39┊    private getUsersGQL: GetUsersGQL,\n+┊  ┊40┊    private addChatGQL: AddChatGQL,\n+┊  ┊41┊    private addGroupGQL: AddGroupGQL\n+┊  ┊42┊  ) {\n+┊  ┊43┊    this.getChatsWq = this.getChatsGQL.watch({\n ┊33┊44┊      amount: this.messagesAmount,\n ┊34┊45┊    });\n-┊35┊  ┊    const chats$ = query.valueChanges.pipe(\n+┊  ┊46┊    this.chats$ = this.getChatsWq.valueChanges.pipe(\n ┊36┊47┊      map((result) => result.data.chats)\n ┊37┊48┊    );\n+┊  ┊49┊    this.chats$.subscribe(chats => this.chats = chats);\n+┊  ┊50┊  }\n ┊38┊51┊\n-┊39┊  ┊    return {query, chats$};\n+┊  ┊52┊  getChats() {\n+┊  ┊53┊    return {query: this.getChatsWq, chats$: this.chats$};\n ┊40┊54┊  }\n ┊41┊55┊\n ┊42┊56┊  getChat(chatId: string) {\n```\n```diff\n@@ -209,4 +223,83 @@\n ┊209┊223┊      }, options);\n ┊210┊224┊    }\n ┊211┊225┊  }\n+┊   ┊226┊\n+┊   ┊227┊  getUsers() {\n+┊   ┊228┊    const query = this.getUsersGQL.watch();\n+┊   ┊229┊    const users$ = query.valueChanges.pipe(\n+┊   ┊230┊      map((result) => result.data.users)\n+┊   ┊231┊    );\n+┊   ┊232┊\n+┊   ┊233┊    return {query, users$};\n+┊   ┊234┊  }\n+┊   ┊235┊\n+┊   ┊236┊  // Checks if the chat is listed for the current user and returns the id\n+┊   ┊237┊  getChatId(recipientId: string) {\n+┊   ┊238┊    const _chat = this.chats.find(chat => {\n+┊   ┊239┊      return !chat.isGroup && !!chat.allTimeMembers.find(user => user.id === currentUserId) &&\n+┊   ┊240┊        !!chat.allTimeMembers.find(user => user.id === recipientId);\n+┊   ┊241┊    });\n+┊   ┊242┊    return _chat ? _chat.id : false;\n+┊   ┊243┊  }\n+┊   ┊244┊\n+┊   ┊245┊  addChat(recipientId: string) {\n+┊   ┊246┊    return this.addChatGQL.mutate(\n+┊   ┊247┊      {\n+┊   ┊248┊        recipientId,\n+┊   ┊249┊      }, {\n+┊   ┊250┊        update: (store, { data: { addChat } }) => {\n+┊   ┊251┊          // Read the data from our cache for this query.\n+┊   ┊252┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊253┊            query: this.getChatsGQL.document,\n+┊   ┊254┊            variables: {\n+┊   ┊255┊              amount: this.messagesAmount,\n+┊   ┊256┊            },\n+┊   ┊257┊          });\n+┊   ┊258┊          // Add our comment from the mutation to the end.\n+┊   ┊259┊          chats.push(addChat);\n+┊   ┊260┊          // Write our data back to the cache.\n+┊   ┊261┊          store.writeQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊262┊            query: this.getChatsGQL.document,\n+┊   ┊263┊            variables: {\n+┊   ┊264┊              amount: this.messagesAmount,\n+┊   ┊265┊            },\n+┊   ┊266┊            data: {\n+┊   ┊267┊              chats,\n+┊   ┊268┊            },\n+┊   ┊269┊          });\n+┊   ┊270┊        },\n+┊   ┊271┊      }\n+┊   ┊272┊    );\n+┊   ┊273┊  }\n+┊   ┊274┊\n+┊   ┊275┊  addGroup(recipientIds: string[], groupName: string) {\n+┊   ┊276┊    return this.addGroupGQL.mutate(\n+┊   ┊277┊      {\n+┊   ┊278┊        recipientIds,\n+┊   ┊279┊        groupName,\n+┊   ┊280┊      }, {\n+┊   ┊281┊        update: (store, { data: { addGroup } }) => {\n+┊   ┊282┊          // Read the data from our cache for this query.\n+┊   ┊283┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊284┊            query: this.getChatsGQL.document,\n+┊   ┊285┊            variables: {\n+┊   ┊286┊              amount: this.messagesAmount,\n+┊   ┊287┊            },\n+┊   ┊288┊          });\n+┊   ┊289┊          // Add our comment from the mutation to the end.\n+┊   ┊290┊          chats.push(addGroup);\n+┊   ┊291┊          // Write our data back to the cache.\n+┊   ┊292┊          store.writeQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊293┊            query: this.getChatsGQL.document,\n+┊   ┊294┊            variables: {\n+┊   ┊295┊              amount: this.messagesAmount,\n+┊   ┊296┊            },\n+┊   ┊297┊            data: {\n+┊   ┊298┊              chats,\n+┊   ┊299┊            },\n+┊   ┊300┊          });\n+┊   ┊301┊        },\n+┊   ┊302┊      }\n+┊   ┊303┊    );\n+┊   ┊304┊  }\n ┊212┊305┊}\n```\n\n[}]: #\n\nOkay, now since we got the GraphQL part ready, we're going to focus on the component.\n\nFirst, we will download the default group-chat picture:\n\n    $ wget https://raw.githubusercontent.com/DAB0mB/whatsapp-client-angularcli-material/c75c2416b1990da3588015f76b8338764f44d6ec/src/assets/default-group-pic.jpg -P src/assets\n\nAnd update the relevant chat components to use it when necessary:\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/app/chat-viewer/containers/chat/chat.component.ts, src/app/chats-lister/components/chat-item/chat-item.component.ts\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n\n\n[}]: #\n\nThen we will create a space to add a new group:\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/app/chats-creation/containers/new-group/new-group.component.ts, src/app/chats-creation/containers/new-group/new-group.component.scss\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-group&#x2F;new-group.component.scss\n\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-group&#x2F;new-group.component.ts\n```diff\n@@ -0,0 +1,60 @@\n+┊  ┊ 1┊import {Component, OnInit} from '@angular/core';\n+┊  ┊ 2┊import {Location} from '@angular/common';\n+┊  ┊ 3┊import {Router} from '@angular/router';\n+┊  ┊ 4┊import {AddGroup, GetUsers} from '../../../../graphql';\n+┊  ┊ 5┊import {ChatsService} from '../../../services/chats.service';\n+┊  ┊ 6┊\n+┊  ┊ 7┊@Component({\n+┊  ┊ 8┊  template: `\n+┊  ┊ 9┊    <app-toolbar>\n+┊  ┊10┊      <button class=\"navigation\" mat-button (click)=\"goBack()\">\n+┊  ┊11┊        <mat-icon aria-label=\"Icon-button with an arrow back icon\">arrow_back</mat-icon>\n+┊  ┊12┊      </button>\n+┊  ┊13┊      <div class=\"title\">New group</div>\n+┊  ┊14┊    </app-toolbar>\n+┊  ┊15┊\n+┊  ┊16┊    <app-users-list *ngIf=\"!recipientIds.length\" [items]=\"users\"\n+┊  ┊17┊                    libSelectableList=\"multiple_tap\" (multiple)=\"selectUsers($event)\">\n+┊  ┊18┊      <app-confirm-selection #confirmSelection icon=\"arrow_forward\"></app-confirm-selection>\n+┊  ┊19┊    </app-users-list>\n+┊  ┊20┊    <app-new-group-details *ngIf=\"recipientIds.length\" [users]=\"getSelectedUsers()\"\n+┊  ┊21┊                           (groupDetails)=\"addGroup($event)\"></app-new-group-details>\n+┊  ┊22┊  `,\n+┊  ┊23┊  styleUrls: ['new-group.component.scss'],\n+┊  ┊24┊})\n+┊  ┊25┊export class NewGroupComponent implements OnInit {\n+┊  ┊26┊  users: GetUsers.Users[];\n+┊  ┊27┊  recipientIds: string[] = [];\n+┊  ┊28┊\n+┊  ┊29┊  constructor(private router: Router,\n+┊  ┊30┊              private location: Location,\n+┊  ┊31┊              private chatsService: ChatsService) {}\n+┊  ┊32┊\n+┊  ┊33┊  ngOnInit () {\n+┊  ┊34┊    this.chatsService.getUsers().users$.subscribe(users => this.users = users);\n+┊  ┊35┊  }\n+┊  ┊36┊\n+┊  ┊37┊  goBack() {\n+┊  ┊38┊    if (this.recipientIds.length) {\n+┊  ┊39┊      this.recipientIds = [];\n+┊  ┊40┊    } else {\n+┊  ┊41┊      this.location.back();\n+┊  ┊42┊    }\n+┊  ┊43┊  }\n+┊  ┊44┊\n+┊  ┊45┊  selectUsers(recipientIds: string[]) {\n+┊  ┊46┊    this.recipientIds = recipientIds;\n+┊  ┊47┊  }\n+┊  ┊48┊\n+┊  ┊49┊  getSelectedUsers() {\n+┊  ┊50┊    return this.users.filter(user => this.recipientIds.includes(user.id));\n+┊  ┊51┊  }\n+┊  ┊52┊\n+┊  ┊53┊  addGroup(groupName: string) {\n+┊  ┊54┊    if (groupName && this.recipientIds.length) {\n+┊  ┊55┊      this.chatsService.addGroup(this.recipientIds, groupName).subscribe(({data: {addGroup: {id}}}: { data: AddGroup.Mutation }) => {\n+┊  ┊56┊        this.router.navigate(['/chat', id]);\n+┊  ┊57┊      });\n+┊  ┊58┊    }\n+┊  ┊59┊  }\n+┊  ┊60┊}\n```\n\n[}]: #\n\nAnd after, a new chat view:\n\nsrc/app/chats-creation/containers/new-chat/new-chat.component.scss, src/app/chats-creation/containers/new-chat/new-chat.component.ts\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/app/app.module.ts, src/app/chats-creation, src/app/services\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n##### Changed src&#x2F;app&#x2F;app.module.ts\n```diff\n@@ -7,6 +7,7 @@\n ┊ 7┊ 7┊import {ChatsListerModule} from './chats-lister/chats-lister.module';\n ┊ 8┊ 8┊import {RouterModule, Routes} from '@angular/router';\n ┊ 9┊ 9┊import {ChatViewerModule} from './chat-viewer/chat-viewer.module';\n+┊  ┊10┊import {ChatsCreationModule} from './chats-creation/chats-creation.module';\n ┊10┊11┊const routes: Routes = [];\n ┊11┊12┊\n ┊12┊13┊@NgModule({\n```\n```diff\n@@ -22,6 +23,7 @@\n ┊22┊23┊    // Feature modules\n ┊23┊24┊    ChatsListerModule,\n ┊24┊25┊    ChatViewerModule,\n+┊  ┊26┊    ChatsCreationModule,\n ┊25┊27┊  ],\n ┊26┊28┊  providers: [],\n ┊27┊29┊  bootstrap: [AppComponent]\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;chats-creation.module.ts\n```diff\n@@ -0,0 +1,60 @@\n+┊  ┊ 1┊import { BrowserModule } from '@angular/platform-browser';\n+┊  ┊ 2┊import { NgModule } from '@angular/core';\n+┊  ┊ 3┊\n+┊  ┊ 4┊import {BrowserAnimationsModule} from '@angular/platform-browser/animations';\n+┊  ┊ 5┊import {\n+┊  ┊ 6┊  MatButtonModule, MatFormFieldModule, MatGridListModule, MatIconModule, MatInputModule, MatListModule, MatMenuModule,\n+┊  ┊ 7┊  MatToolbarModule\n+┊  ┊ 8┊} from '@angular/material';\n+┊  ┊ 9┊import {RouterModule, Routes} from '@angular/router';\n+┊  ┊10┊import {FormsModule} from '@angular/forms';\n+┊  ┊11┊import {ChatsService} from '../services/chats.service';\n+┊  ┊12┊import {UserItemComponent} from './components/user-item/user-item.component';\n+┊  ┊13┊import {UsersListComponent} from './components/users-list/users-list.component';\n+┊  ┊14┊import {NewGroupComponent} from './containers/new-group/new-group.component';\n+┊  ┊15┊import {NewChatComponent} from './containers/new-chat/new-chat.component';\n+┊  ┊16┊import {NewGroupDetailsComponent} from './components/new-group-details/new-group-details.component';\n+┊  ┊17┊import {SharedModule} from '../shared/shared.module';\n+┊  ┊18┊import {NgxSelectableListModule} from 'ngx-selectable-list';\n+┊  ┊19┊\n+┊  ┊20┊const routes: Routes = [\n+┊  ┊21┊  {path: 'new-chat', component: NewChatComponent},\n+┊  ┊22┊  {path: 'new-group', component: NewGroupComponent},\n+┊  ┊23┊];\n+┊  ┊24┊\n+┊  ┊25┊@NgModule({\n+┊  ┊26┊  declarations: [\n+┊  ┊27┊    NewChatComponent,\n+┊  ┊28┊    UsersListComponent,\n+┊  ┊29┊    NewGroupComponent,\n+┊  ┊30┊    UserItemComponent,\n+┊  ┊31┊    NewGroupDetailsComponent,\n+┊  ┊32┊  ],\n+┊  ┊33┊  imports: [\n+┊  ┊34┊    BrowserModule,\n+┊  ┊35┊    // Animations (for Material)\n+┊  ┊36┊    BrowserAnimationsModule,\n+┊  ┊37┊    // Material\n+┊  ┊38┊    MatToolbarModule,\n+┊  ┊39┊    MatMenuModule,\n+┊  ┊40┊    MatIconModule,\n+┊  ┊41┊    MatButtonModule,\n+┊  ┊42┊    MatListModule,\n+┊  ┊43┊    MatGridListModule,\n+┊  ┊44┊    MatInputModule,\n+┊  ┊45┊    MatFormFieldModule,\n+┊  ┊46┊    MatGridListModule,\n+┊  ┊47┊    // Routing\n+┊  ┊48┊    RouterModule.forChild(routes),\n+┊  ┊49┊    // Forms\n+┊  ┊50┊    FormsModule,\n+┊  ┊51┊    // Feature modules\n+┊  ┊52┊    NgxSelectableListModule,\n+┊  ┊53┊    SharedModule,\n+┊  ┊54┊  ],\n+┊  ┊55┊  providers: [\n+┊  ┊56┊    ChatsService,\n+┊  ┊57┊  ],\n+┊  ┊58┊})\n+┊  ┊59┊export class ChatsCreationModule {\n+┊  ┊60┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;new-group-details&#x2F;new-group-details.component.scss\n```diff\n@@ -0,0 +1,25 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊}\n+┊  ┊ 4┊\n+┊  ┊ 5┊div {\n+┊  ┊ 6┊  padding: 16px;\n+┊  ┊ 7┊  mat-form-field {\n+┊  ┊ 8┊    width: 100%;\n+┊  ┊ 9┊  }\n+┊  ┊10┊}\n+┊  ┊11┊\n+┊  ┊12┊.new-group {\n+┊  ┊13┊  position: absolute;\n+┊  ┊14┊  bottom: 5vw;\n+┊  ┊15┊  right: 5vw;\n+┊  ┊16┊}\n+┊  ┊17┊\n+┊  ┊18┊.users {\n+┊  ┊19┊  display: flex;\n+┊  ┊20┊  flex-flow: row wrap;\n+┊  ┊21┊  img {\n+┊  ┊22┊    flex: 0 1 8vh;\n+┊  ┊23┊    height: 8vh;\n+┊  ┊24┊  }\n+┊  ┊25┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;new-group-details&#x2F;new-group-details.component.ts\n```diff\n@@ -0,0 +1,34 @@\n+┊  ┊ 1┊import {Component, EventEmitter, Input, Output} from '@angular/core';\n+┊  ┊ 2┊import {GetUsers} from '../../../../graphql';\n+┊  ┊ 3┊\n+┊  ┊ 4┊@Component({\n+┊  ┊ 5┊  selector: 'app-new-group-details',\n+┊  ┊ 6┊  template: `\n+┊  ┊ 7┊    <div>\n+┊  ┊ 8┊      <mat-form-field>\n+┊  ┊ 9┊        <input matInput placeholder=\"Group name\" [(ngModel)]=\"groupName\">\n+┊  ┊10┊      </mat-form-field>\n+┊  ┊11┊    </div>\n+┊  ┊12┊    <button [disabled]=\"!groupName\" class=\"new-group\" mat-fab color=\"primary\" (click)=\"emitGroupDetails()\">\n+┊  ┊13┊      <mat-icon aria-label=\"Icon-button with a + icon\">arrow_forward</mat-icon>\n+┊  ┊14┊    </button>\n+┊  ┊15┊    <div>Members</div>\n+┊  ┊16┊    <div class=\"users\">\n+┊  ┊17┊      <img *ngFor=\"let user of users;\" [src]=\"user.picture\"/>\n+┊  ┊18┊    </div>\n+┊  ┊19┊  `,\n+┊  ┊20┊  styleUrls: ['new-group-details.component.scss'],\n+┊  ┊21┊})\n+┊  ┊22┊export class NewGroupDetailsComponent {\n+┊  ┊23┊  groupName: string;\n+┊  ┊24┊  @Input()\n+┊  ┊25┊  users: GetUsers.Users[];\n+┊  ┊26┊  @Output()\n+┊  ┊27┊  groupDetails = new EventEmitter<string>();\n+┊  ┊28┊\n+┊  ┊29┊  emitGroupDetails() {\n+┊  ┊30┊    if (this.groupDetails) {\n+┊  ┊31┊      this.groupDetails.emit(this.groupName);\n+┊  ┊32┊    }\n+┊  ┊33┊  }\n+┊  ┊34┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;user-item&#x2F;user-item.component.scss\n```diff\n@@ -0,0 +1,32 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊  width: 100%;\n+┊  ┊ 4┊  height: 100%;\n+┊  ┊ 5┊}\n+┊  ┊ 6┊\n+┊  ┊ 7┊button {\n+┊  ┊ 8┊  margin: 10px;\n+┊  ┊ 9┊  height: 50px;\n+┊  ┊10┊  padding: 1px 6px;\n+┊  ┊11┊  line-height: 50px;\n+┊  ┊12┊  border: none;\n+┊  ┊13┊  margin: 0;\n+┊  ┊14┊\n+┊  ┊15┊  img {\n+┊  ┊16┊    float: left;\n+┊  ┊17┊    margin-right: 10px;\n+┊  ┊18┊    height: 50px;\n+┊  ┊19┊    width: 50px;\n+┊  ┊20┊    text-align: center;\n+┊  ┊21┊    line-height: inherit;\n+┊  ┊22┊    border-radius: 50%;\n+┊  ┊23┊  }\n+┊  ┊24┊\n+┊  ┊25┊  div {\n+┊  ┊26┊    float: left;\n+┊  ┊27┊    line-height: inherit;\n+┊  ┊28┊    font-family: Roboto, \"Helvetica Neue\", sans-serif;\n+┊  ┊29┊    font-weight: bold;\n+┊  ┊30┊    font-size: 16px;\n+┊  ┊31┊  }\n+┊  ┊32┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;user-item&#x2F;user-item.component.ts\n```diff\n@@ -0,0 +1,18 @@\n+┊  ┊ 1┊import {Component, Input} from '@angular/core';\n+┊  ┊ 2┊import {GetUsers} from '../../../../graphql';\n+┊  ┊ 3┊\n+┊  ┊ 4┊@Component({\n+┊  ┊ 5┊  selector: 'app-user-item',\n+┊  ┊ 6┊  template: `\n+┊  ┊ 7┊    <button mat-menu-item>\n+┊  ┊ 8┊      <img [src]=\"user.picture || 'assets/default-profile-pic.jpg'\">\n+┊  ┊ 9┊      <div>{{ user.name }}</div>\n+┊  ┊10┊    </button>\n+┊  ┊11┊  `,\n+┊  ┊12┊  styleUrls: ['user-item.component.scss']\n+┊  ┊13┊})\n+┊  ┊14┊export class UserItemComponent {\n+┊  ┊15┊  // tslint:disable-next-line:no-input-rename\n+┊  ┊16┊  @Input('item')\n+┊  ┊17┊  user: GetUsers.Users;\n+┊  ┊18┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;users-list&#x2F;users-list.component.scss\n```diff\n@@ -0,0 +1,13 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊}\n+┊  ┊ 4┊\n+┊  ┊ 5┊:host ::ng-deep mat-list-item:first-child div:first-child {\n+┊  ┊ 6┊  padding: 0 !important;\n+┊  ┊ 7┊  margin: 5px;\n+┊  ┊ 8┊  margin-top: 20px;\n+┊  ┊ 9┊}\n+┊  ┊10┊\n+┊  ┊11┊mat-list {\n+┊  ┊12┊  padding: 0;\n+┊  ┊13┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;users-list&#x2F;users-list.component.ts\n```diff\n@@ -0,0 +1,24 @@\n+┊  ┊ 1┊import {Component, Input} from '@angular/core';\n+┊  ┊ 2┊import {GetUsers} from '../../../../graphql';\n+┊  ┊ 3┊import {SelectableListDirective} from 'ngx-selectable-list';\n+┊  ┊ 4┊\n+┊  ┊ 5┊@Component({\n+┊  ┊ 6┊  selector: 'app-users-list',\n+┊  ┊ 7┊  template: `\n+┊  ┊ 8┊    <mat-list>\n+┊  ┊ 9┊      <mat-list-item *ngFor=\"let user of users\">\n+┊  ┊10┊        <app-user-item [item]=\"user\"\n+┊  ┊11┊                       libSelectableItem></app-user-item>\n+┊  ┊12┊      </mat-list-item>\n+┊  ┊13┊    </mat-list>\n+┊  ┊14┊    <ng-content *ngIf=\"selectableListDirective.selecting\"></ng-content>\n+┊  ┊15┊  `,\n+┊  ┊16┊  styleUrls: ['users-list.component.scss'],\n+┊  ┊17┊})\n+┊  ┊18┊export class UsersListComponent {\n+┊  ┊19┊  // tslint:disable-next-line:no-input-rename\n+┊  ┊20┊  @Input('items')\n+┊  ┊21┊  users: GetUsers.Users[];\n+┊  ┊22┊\n+┊  ┊23┊  constructor(public selectableListDirective: SelectableListDirective) {}\n+┊  ┊24┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-chat&#x2F;new-chat.component.scss\n```diff\n@@ -0,0 +1,23 @@\n+┊  ┊ 1┊.new-group {\n+┊  ┊ 2┊  margin: 10px;\n+┊  ┊ 3┊  height: 50px;\n+┊  ┊ 4┊  line-height: 50px;\n+┊  ┊ 5┊  margin-top: 20px;\n+┊  ┊ 6┊\n+┊  ┊ 7┊  mat-icon {\n+┊  ┊ 8┊    float: left;\n+┊  ┊ 9┊    margin-right: 10px;\n+┊  ┊10┊    height: 50px;\n+┊  ┊11┊    width: 50px;\n+┊  ┊12┊    text-align: center;\n+┊  ┊13┊    line-height: inherit;\n+┊  ┊14┊    border-radius: 50%;\n+┊  ┊15┊  }\n+┊  ┊16┊\n+┊  ┊17┊  div {\n+┊  ┊18┊    float: left;\n+┊  ┊19┊    line-height: inherit;\n+┊  ┊20┊    font-family: Roboto, \"Helvetica Neue\", sans-serif;\n+┊  ┊21┊    font-weight: bold;\n+┊  ┊22┊  }\n+┊  ┊23┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-chat&#x2F;new-chat.component.ts\n```diff\n@@ -0,0 +1,55 @@\n+┊  ┊ 1┊import {Component, OnInit} from '@angular/core';\n+┊  ┊ 2┊import {Location} from '@angular/common';\n+┊  ┊ 3┊import {Router} from '@angular/router';\n+┊  ┊ 4┊import {AddChat, GetUsers} from '../../../../graphql';\n+┊  ┊ 5┊import {ChatsService} from '../../../services/chats.service';\n+┊  ┊ 6┊\n+┊  ┊ 7┊@Component({\n+┊  ┊ 8┊  template: `\n+┊  ┊ 9┊    <app-toolbar>\n+┊  ┊10┊      <button class=\"navigation\" mat-button (click)=\"goBack()\">\n+┊  ┊11┊        <mat-icon aria-label=\"Icon-button with an arrow back icon\">arrow_back</mat-icon>\n+┊  ┊12┊      </button>\n+┊  ┊13┊      <div class=\"title\">New chat</div>\n+┊  ┊14┊    </app-toolbar>\n+┊  ┊15┊    <div class=\"new-group\" (click)=\"goToNewGroup()\">\n+┊  ┊16┊      <mat-icon color=\"secondary\" aria-label=\"Icon-button with a group add icon\">group_add</mat-icon>\n+┊  ┊17┊      <div>New group</div>\n+┊  ┊18┊    </div>\n+┊  ┊19┊    <app-users-list [items]=\"users\"\n+┊  ┊20┊                    libSelectableList=\"single\" (single)=\"addChat($event)\">\n+┊  ┊21┊    </app-users-list>\n+┊  ┊22┊  `,\n+┊  ┊23┊  styleUrls: ['new-chat.component.scss'],\n+┊  ┊24┊})\n+┊  ┊25┊export class NewChatComponent implements OnInit {\n+┊  ┊26┊  users: GetUsers.Users[];\n+┊  ┊27┊\n+┊  ┊28┊  constructor(private router: Router,\n+┊  ┊29┊              private location: Location,\n+┊  ┊30┊              private chatsService: ChatsService) {}\n+┊  ┊31┊\n+┊  ┊32┊  ngOnInit () {\n+┊  ┊33┊    this.chatsService.getUsers().users$.subscribe(users => this.users = users);\n+┊  ┊34┊  }\n+┊  ┊35┊\n+┊  ┊36┊  goBack() {\n+┊  ┊37┊    this.location.back();\n+┊  ┊38┊  }\n+┊  ┊39┊\n+┊  ┊40┊  goToNewGroup() {\n+┊  ┊41┊    this.router.navigate(['/new-group']);\n+┊  ┊42┊  }\n+┊  ┊43┊\n+┊  ┊44┊  addChat(recipientId: string) {\n+┊  ┊45┊    const chatId = this.chatsService.getChatId(recipientId);\n+┊  ┊46┊    if (chatId) {\n+┊  ┊47┊      // Chat is already listed for the current user\n+┊  ┊48┊      this.router.navigate(['/chat', chatId]);\n+┊  ┊49┊    } else {\n+┊  ┊50┊      this.chatsService.addChat(recipientId).subscribe(({data: {addChat: {id}}}: { data: AddChat.Mutation }) => {\n+┊  ┊51┊        this.router.navigate(['/chat', id]);\n+┊  ┊52┊      });\n+┊  ┊53┊    }\n+┊  ┊54┊  }\n+┊  ┊55┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-group&#x2F;new-group.component.scss\n\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-group&#x2F;new-group.component.ts\n```diff\n@@ -0,0 +1,60 @@\n+┊  ┊ 1┊import {Component, OnInit} from '@angular/core';\n+┊  ┊ 2┊import {Location} from '@angular/common';\n+┊  ┊ 3┊import {Router} from '@angular/router';\n+┊  ┊ 4┊import {AddGroup, GetUsers} from '../../../../graphql';\n+┊  ┊ 5┊import {ChatsService} from '../../../services/chats.service';\n+┊  ┊ 6┊\n+┊  ┊ 7┊@Component({\n+┊  ┊ 8┊  template: `\n+┊  ┊ 9┊    <app-toolbar>\n+┊  ┊10┊      <button class=\"navigation\" mat-button (click)=\"goBack()\">\n+┊  ┊11┊        <mat-icon aria-label=\"Icon-button with an arrow back icon\">arrow_back</mat-icon>\n+┊  ┊12┊      </button>\n+┊  ┊13┊      <div class=\"title\">New group</div>\n+┊  ┊14┊    </app-toolbar>\n+┊  ┊15┊\n+┊  ┊16┊    <app-users-list *ngIf=\"!recipientIds.length\" [items]=\"users\"\n+┊  ┊17┊                    libSelectableList=\"multiple_tap\" (multiple)=\"selectUsers($event)\">\n+┊  ┊18┊      <app-confirm-selection #confirmSelection icon=\"arrow_forward\"></app-confirm-selection>\n+┊  ┊19┊    </app-users-list>\n+┊  ┊20┊    <app-new-group-details *ngIf=\"recipientIds.length\" [users]=\"getSelectedUsers()\"\n+┊  ┊21┊                           (groupDetails)=\"addGroup($event)\"></app-new-group-details>\n+┊  ┊22┊  `,\n+┊  ┊23┊  styleUrls: ['new-group.component.scss'],\n+┊  ┊24┊})\n+┊  ┊25┊export class NewGroupComponent implements OnInit {\n+┊  ┊26┊  users: GetUsers.Users[];\n+┊  ┊27┊  recipientIds: string[] = [];\n+┊  ┊28┊\n+┊  ┊29┊  constructor(private router: Router,\n+┊  ┊30┊              private location: Location,\n+┊  ┊31┊              private chatsService: ChatsService) {}\n+┊  ┊32┊\n+┊  ┊33┊  ngOnInit () {\n+┊  ┊34┊    this.chatsService.getUsers().users$.subscribe(users => this.users = users);\n+┊  ┊35┊  }\n+┊  ┊36┊\n+┊  ┊37┊  goBack() {\n+┊  ┊38┊    if (this.recipientIds.length) {\n+┊  ┊39┊      this.recipientIds = [];\n+┊  ┊40┊    } else {\n+┊  ┊41┊      this.location.back();\n+┊  ┊42┊    }\n+┊  ┊43┊  }\n+┊  ┊44┊\n+┊  ┊45┊  selectUsers(recipientIds: string[]) {\n+┊  ┊46┊    this.recipientIds = recipientIds;\n+┊  ┊47┊  }\n+┊  ┊48┊\n+┊  ┊49┊  getSelectedUsers() {\n+┊  ┊50┊    return this.users.filter(user => this.recipientIds.includes(user.id));\n+┊  ┊51┊  }\n+┊  ┊52┊\n+┊  ┊53┊  addGroup(groupName: string) {\n+┊  ┊54┊    if (groupName && this.recipientIds.length) {\n+┊  ┊55┊      this.chatsService.addGroup(this.recipientIds, groupName).subscribe(({data: {addGroup: {id}}}: { data: AddGroup.Mutation }) => {\n+┊  ┊56┊        this.router.navigate(['/chat', id]);\n+┊  ┊57┊      });\n+┊  ┊58┊    }\n+┊  ┊59┊  }\n+┊  ┊60┊}\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,5 +1,7 @@\n ┊1┊1┊import {map} from 'rxjs/operators';\n ┊2┊2┊import {Injectable} from '@angular/core';\n+┊ ┊3┊import {Observable} from 'rxjs';\n+┊ ┊4┊import {QueryRef} from 'apollo-angular';\n ┊3┊5┊import {\n ┊4┊6┊  GetChatsGQL,\n ┊5┊7┊  GetChatGQL,\n```\n```diff\n@@ -7,6 +9,9 @@\n ┊ 7┊ 9┊  RemoveChatGQL,\n ┊ 8┊10┊  RemoveMessagesGQL,\n ┊ 9┊11┊  RemoveAllMessagesGQL,\n+┊  ┊12┊  GetUsersGQL,\n+┊  ┊13┊  AddChatGQL,\n+┊  ┊14┊  AddGroupGQL,\n ┊10┊15┊  AddMessage,\n ┊11┊16┊  GetChats,\n ┊12┊17┊  GetChat,\n```\n```diff\n@@ -15,9 +20,14 @@\n ┊15┊20┊} from '../../graphql';\n ┊16┊21┊import { DataProxy } from 'apollo-cache';\n ┊17┊22┊\n+┊  ┊23┊const currentUserId = '1';\n+┊  ┊24┊\n ┊18┊25┊@Injectable()\n ┊19┊26┊export class ChatsService {\n ┊20┊27┊  messagesAmount = 3;\n+┊  ┊28┊  getChatsWq: QueryRef<GetChats.Query, GetChats.Variables>;\n+┊  ┊29┊  chats$: Observable<GetChats.Chats[]>;\n+┊  ┊30┊  chats: GetChats.Chats[];\n ┊21┊31┊\n ┊22┊32┊  constructor(\n ┊23┊33┊    private getChatsGQL: GetChatsGQL,\n```\n```diff\n@@ -26,17 +36,21 @@\n ┊26┊36┊    private removeChatGQL: RemoveChatGQL,\n ┊27┊37┊    private removeMessagesGQL: RemoveMessagesGQL,\n ┊28┊38┊    private removeAllMessagesGQL: RemoveAllMessagesGQL,\n-┊29┊  ┊  ) {}\n-┊30┊  ┊\n-┊31┊  ┊  getChats() {\n-┊32┊  ┊    const query = this.getChatsGQL.watch({\n+┊  ┊39┊    private getUsersGQL: GetUsersGQL,\n+┊  ┊40┊    private addChatGQL: AddChatGQL,\n+┊  ┊41┊    private addGroupGQL: AddGroupGQL\n+┊  ┊42┊  ) {\n+┊  ┊43┊    this.getChatsWq = this.getChatsGQL.watch({\n ┊33┊44┊      amount: this.messagesAmount,\n ┊34┊45┊    });\n-┊35┊  ┊    const chats$ = query.valueChanges.pipe(\n+┊  ┊46┊    this.chats$ = this.getChatsWq.valueChanges.pipe(\n ┊36┊47┊      map((result) => result.data.chats)\n ┊37┊48┊    );\n+┊  ┊49┊    this.chats$.subscribe(chats => this.chats = chats);\n+┊  ┊50┊  }\n ┊38┊51┊\n-┊39┊  ┊    return {query, chats$};\n+┊  ┊52┊  getChats() {\n+┊  ┊53┊    return {query: this.getChatsWq, chats$: this.chats$};\n ┊40┊54┊  }\n ┊41┊55┊\n ┊42┊56┊  getChat(chatId: string) {\n```\n```diff\n@@ -209,4 +223,83 @@\n ┊209┊223┊      }, options);\n ┊210┊224┊    }\n ┊211┊225┊  }\n+┊   ┊226┊\n+┊   ┊227┊  getUsers() {\n+┊   ┊228┊    const query = this.getUsersGQL.watch();\n+┊   ┊229┊    const users$ = query.valueChanges.pipe(\n+┊   ┊230┊      map((result) => result.data.users)\n+┊   ┊231┊    );\n+┊   ┊232┊\n+┊   ┊233┊    return {query, users$};\n+┊   ┊234┊  }\n+┊   ┊235┊\n+┊   ┊236┊  // Checks if the chat is listed for the current user and returns the id\n+┊   ┊237┊  getChatId(recipientId: string) {\n+┊   ┊238┊    const _chat = this.chats.find(chat => {\n+┊   ┊239┊      return !chat.isGroup && !!chat.allTimeMembers.find(user => user.id === currentUserId) &&\n+┊   ┊240┊        !!chat.allTimeMembers.find(user => user.id === recipientId);\n+┊   ┊241┊    });\n+┊   ┊242┊    return _chat ? _chat.id : false;\n+┊   ┊243┊  }\n+┊   ┊244┊\n+┊   ┊245┊  addChat(recipientId: string) {\n+┊   ┊246┊    return this.addChatGQL.mutate(\n+┊   ┊247┊      {\n+┊   ┊248┊        recipientId,\n+┊   ┊249┊      }, {\n+┊   ┊250┊        update: (store, { data: { addChat } }) => {\n+┊   ┊251┊          // Read the data from our cache for this query.\n+┊   ┊252┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊253┊            query: this.getChatsGQL.document,\n+┊   ┊254┊            variables: {\n+┊   ┊255┊              amount: this.messagesAmount,\n+┊   ┊256┊            },\n+┊   ┊257┊          });\n+┊   ┊258┊          // Add our comment from the mutation to the end.\n+┊   ┊259┊          chats.push(addChat);\n+┊   ┊260┊          // Write our data back to the cache.\n+┊   ┊261┊          store.writeQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊262┊            query: this.getChatsGQL.document,\n+┊   ┊263┊            variables: {\n+┊   ┊264┊              amount: this.messagesAmount,\n+┊   ┊265┊            },\n+┊   ┊266┊            data: {\n+┊   ┊267┊              chats,\n+┊   ┊268┊            },\n+┊   ┊269┊          });\n+┊   ┊270┊        },\n+┊   ┊271┊      }\n+┊   ┊272┊    );\n+┊   ┊273┊  }\n+┊   ┊274┊\n+┊   ┊275┊  addGroup(recipientIds: string[], groupName: string) {\n+┊   ┊276┊    return this.addGroupGQL.mutate(\n+┊   ┊277┊      {\n+┊   ┊278┊        recipientIds,\n+┊   ┊279┊        groupName,\n+┊   ┊280┊      }, {\n+┊   ┊281┊        update: (store, { data: { addGroup } }) => {\n+┊   ┊282┊          // Read the data from our cache for this query.\n+┊   ┊283┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊284┊            query: this.getChatsGQL.document,\n+┊   ┊285┊            variables: {\n+┊   ┊286┊              amount: this.messagesAmount,\n+┊   ┊287┊            },\n+┊   ┊288┊          });\n+┊   ┊289┊          // Add our comment from the mutation to the end.\n+┊   ┊290┊          chats.push(addGroup);\n+┊   ┊291┊          // Write our data back to the cache.\n+┊   ┊292┊          store.writeQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊293┊            query: this.getChatsGQL.document,\n+┊   ┊294┊            variables: {\n+┊   ┊295┊              amount: this.messagesAmount,\n+┊   ┊296┊            },\n+┊   ┊297┊            data: {\n+┊   ┊298┊              chats,\n+┊   ┊299┊            },\n+┊   ┊300┊          });\n+┊   ┊301┊        },\n+┊   ┊302┊      }\n+┊   ┊303┊    );\n+┊   ┊304┊  }\n ┊212┊305┊}\n```\n\n[}]: #\n\nThey're both missing few components:\n\n**UsersList**\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/app/chats-creation/components/users-list/users-list.component.ts, src/app/chats-creation/components/users-list/users-list.component.scss\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;users-list&#x2F;users-list.component.scss\n```diff\n@@ -0,0 +1,13 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊}\n+┊  ┊ 4┊\n+┊  ┊ 5┊:host ::ng-deep mat-list-item:first-child div:first-child {\n+┊  ┊ 6┊  padding: 0 !important;\n+┊  ┊ 7┊  margin: 5px;\n+┊  ┊ 8┊  margin-top: 20px;\n+┊  ┊ 9┊}\n+┊  ┊10┊\n+┊  ┊11┊mat-list {\n+┊  ┊12┊  padding: 0;\n+┊  ┊13┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;users-list&#x2F;users-list.component.ts\n```diff\n@@ -0,0 +1,24 @@\n+┊  ┊ 1┊import {Component, Input} from '@angular/core';\n+┊  ┊ 2┊import {GetUsers} from '../../../../graphql';\n+┊  ┊ 3┊import {SelectableListDirective} from 'ngx-selectable-list';\n+┊  ┊ 4┊\n+┊  ┊ 5┊@Component({\n+┊  ┊ 6┊  selector: 'app-users-list',\n+┊  ┊ 7┊  template: `\n+┊  ┊ 8┊    <mat-list>\n+┊  ┊ 9┊      <mat-list-item *ngFor=\"let user of users\">\n+┊  ┊10┊        <app-user-item [item]=\"user\"\n+┊  ┊11┊                       libSelectableItem></app-user-item>\n+┊  ┊12┊      </mat-list-item>\n+┊  ┊13┊    </mat-list>\n+┊  ┊14┊    <ng-content *ngIf=\"selectableListDirective.selecting\"></ng-content>\n+┊  ┊15┊  `,\n+┊  ┊16┊  styleUrls: ['users-list.component.scss'],\n+┊  ┊17┊})\n+┊  ┊18┊export class UsersListComponent {\n+┊  ┊19┊  // tslint:disable-next-line:no-input-rename\n+┊  ┊20┊  @Input('items')\n+┊  ┊21┊  users: GetUsers.Users[];\n+┊  ┊22┊\n+┊  ┊23┊  constructor(public selectableListDirective: SelectableListDirective) {}\n+┊  ┊24┊}\n```\n\n[}]: #\n\n**UserItem**\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/app/chats-creation/components/user-item/user-item.component.ts, src/app/chats-creation/components/user-item/user-item.component.scss\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;user-item&#x2F;user-item.component.scss\n```diff\n@@ -0,0 +1,32 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊  width: 100%;\n+┊  ┊ 4┊  height: 100%;\n+┊  ┊ 5┊}\n+┊  ┊ 6┊\n+┊  ┊ 7┊button {\n+┊  ┊ 8┊  margin: 10px;\n+┊  ┊ 9┊  height: 50px;\n+┊  ┊10┊  padding: 1px 6px;\n+┊  ┊11┊  line-height: 50px;\n+┊  ┊12┊  border: none;\n+┊  ┊13┊  margin: 0;\n+┊  ┊14┊\n+┊  ┊15┊  img {\n+┊  ┊16┊    float: left;\n+┊  ┊17┊    margin-right: 10px;\n+┊  ┊18┊    height: 50px;\n+┊  ┊19┊    width: 50px;\n+┊  ┊20┊    text-align: center;\n+┊  ┊21┊    line-height: inherit;\n+┊  ┊22┊    border-radius: 50%;\n+┊  ┊23┊  }\n+┊  ┊24┊\n+┊  ┊25┊  div {\n+┊  ┊26┊    float: left;\n+┊  ┊27┊    line-height: inherit;\n+┊  ┊28┊    font-family: Roboto, \"Helvetica Neue\", sans-serif;\n+┊  ┊29┊    font-weight: bold;\n+┊  ┊30┊    font-size: 16px;\n+┊  ┊31┊  }\n+┊  ┊32┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;user-item&#x2F;user-item.component.ts\n```diff\n@@ -0,0 +1,18 @@\n+┊  ┊ 1┊import {Component, Input} from '@angular/core';\n+┊  ┊ 2┊import {GetUsers} from '../../../../graphql';\n+┊  ┊ 3┊\n+┊  ┊ 4┊@Component({\n+┊  ┊ 5┊  selector: 'app-user-item',\n+┊  ┊ 6┊  template: `\n+┊  ┊ 7┊    <button mat-menu-item>\n+┊  ┊ 8┊      <img [src]=\"user.picture || 'assets/default-profile-pic.jpg'\">\n+┊  ┊ 9┊      <div>{{ user.name }}</div>\n+┊  ┊10┊    </button>\n+┊  ┊11┊  `,\n+┊  ┊12┊  styleUrls: ['user-item.component.scss']\n+┊  ┊13┊})\n+┊  ┊14┊export class UserItemComponent {\n+┊  ┊15┊  // tslint:disable-next-line:no-input-rename\n+┊  ┊16┊  @Input('item')\n+┊  ┊17┊  user: GetUsers.Users;\n+┊  ┊18┊}\n```\n\n[}]: #\n\n**NewGroupDetails**\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/app/chats-creation/components/new-group-details/new-group-details.component.ts, src/app/chats-creation/components/new-group-details/new-group-details.component.scss\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;new-group-details&#x2F;new-group-details.component.scss\n```diff\n@@ -0,0 +1,25 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊}\n+┊  ┊ 4┊\n+┊  ┊ 5┊div {\n+┊  ┊ 6┊  padding: 16px;\n+┊  ┊ 7┊  mat-form-field {\n+┊  ┊ 8┊    width: 100%;\n+┊  ┊ 9┊  }\n+┊  ┊10┊}\n+┊  ┊11┊\n+┊  ┊12┊.new-group {\n+┊  ┊13┊  position: absolute;\n+┊  ┊14┊  bottom: 5vw;\n+┊  ┊15┊  right: 5vw;\n+┊  ┊16┊}\n+┊  ┊17┊\n+┊  ┊18┊.users {\n+┊  ┊19┊  display: flex;\n+┊  ┊20┊  flex-flow: row wrap;\n+┊  ┊21┊  img {\n+┊  ┊22┊    flex: 0 1 8vh;\n+┊  ┊23┊    height: 8vh;\n+┊  ┊24┊  }\n+┊  ┊25┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;new-group-details&#x2F;new-group-details.component.ts\n```diff\n@@ -0,0 +1,34 @@\n+┊  ┊ 1┊import {Component, EventEmitter, Input, Output} from '@angular/core';\n+┊  ┊ 2┊import {GetUsers} from '../../../../graphql';\n+┊  ┊ 3┊\n+┊  ┊ 4┊@Component({\n+┊  ┊ 5┊  selector: 'app-new-group-details',\n+┊  ┊ 6┊  template: `\n+┊  ┊ 7┊    <div>\n+┊  ┊ 8┊      <mat-form-field>\n+┊  ┊ 9┊        <input matInput placeholder=\"Group name\" [(ngModel)]=\"groupName\">\n+┊  ┊10┊      </mat-form-field>\n+┊  ┊11┊    </div>\n+┊  ┊12┊    <button [disabled]=\"!groupName\" class=\"new-group\" mat-fab color=\"primary\" (click)=\"emitGroupDetails()\">\n+┊  ┊13┊      <mat-icon aria-label=\"Icon-button with a + icon\">arrow_forward</mat-icon>\n+┊  ┊14┊    </button>\n+┊  ┊15┊    <div>Members</div>\n+┊  ┊16┊    <div class=\"users\">\n+┊  ┊17┊      <img *ngFor=\"let user of users;\" [src]=\"user.picture\"/>\n+┊  ┊18┊    </div>\n+┊  ┊19┊  `,\n+┊  ┊20┊  styleUrls: ['new-group-details.component.scss'],\n+┊  ┊21┊})\n+┊  ┊22┊export class NewGroupDetailsComponent {\n+┊  ┊23┊  groupName: string;\n+┊  ┊24┊  @Input()\n+┊  ┊25┊  users: GetUsers.Users[];\n+┊  ┊26┊  @Output()\n+┊  ┊27┊  groupDetails = new EventEmitter<string>();\n+┊  ┊28┊\n+┊  ┊29┊  emitGroupDetails() {\n+┊  ┊30┊    if (this.groupDetails) {\n+┊  ┊31┊      this.groupDetails.emit(this.groupName);\n+┊  ┊32┊    }\n+┊  ┊33┊  }\n+┊  ┊34┊}\n```\n\n[}]: #\n\nWith all that, we can now link NewChat component with Chat container:\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/app/chats-lister/containers/chats/chats.component.ts, src/app/chat-viewer/containers/chat/chat.component.spec.ts\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.spec.ts\n```diff\n@@ -143,7 +143,9 @@\n ┊143┊143┊    component = fixture.componentInstance;\n ┊144┊144┊    fixture.detectChanges();\n ┊145┊145┊\n-┊146┊   ┊    const req = controller.expectOne('GetChat', 'call to api');\n+┊   ┊146┊    controller.expectOne('GetChats', 'call to getChats api');\n+┊   ┊147┊\n+┊   ┊148┊    const req = controller.expectOne('GetChat', 'call to getChat api');\n ┊147┊149┊\n ┊148┊150┊    req.flush({\n ┊149┊151┊      data: {\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.ts\n```diff\n@@ -34,7 +34,7 @@\n ┊34┊34┊      <app-confirm-selection #confirmSelection></app-confirm-selection>\n ┊35┊35┊    </app-chats-list>\n ┊36┊36┊\n-┊37┊  ┊    <button *ngIf=\"!isSelecting\" class=\"chat-button\" mat-fab color=\"secondary\">\n+┊  ┊37┊    <button *ngIf=\"!isSelecting\" class=\"chat-button\" mat-fab color=\"secondary\" (click)=\"goToNewChat()\">\n ┊38┊38┊      <mat-icon aria-label=\"Icon-button with a + icon\">chat</mat-icon>\n ┊39┊39┊    </button>\n ┊40┊40┊  `,\n```\n```diff\n@@ -56,6 +56,10 @@\n ┊56┊56┊    this.router.navigate(['/chat', chatId]);\n ┊57┊57┊  }\n ┊58┊58┊\n+┊  ┊59┊  goToNewChat() {\n+┊  ┊60┊    this.router.navigate(['/new-chat']);\n+┊  ┊61┊  }\n+┊  ┊62┊\n ┊59┊63┊  deleteChats(chatIds: string[]) {\n ┊60┊64┊    chatIds.forEach(chatId => {\n ┊61┊65┊      this.chatsService.removeChat(chatId).subscribe();\n```\n\n[}]: #\n\nNow let's wrap it all together within the `ChatsCreation` module:\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/app/chats-creation/chats-creation.module.ts, src/app/app.module.ts\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n##### Changed src&#x2F;app&#x2F;app.module.ts\n```diff\n@@ -7,6 +7,7 @@\n ┊ 7┊ 7┊import {ChatsListerModule} from './chats-lister/chats-lister.module';\n ┊ 8┊ 8┊import {RouterModule, Routes} from '@angular/router';\n ┊ 9┊ 9┊import {ChatViewerModule} from './chat-viewer/chat-viewer.module';\n+┊  ┊10┊import {ChatsCreationModule} from './chats-creation/chats-creation.module';\n ┊10┊11┊const routes: Routes = [];\n ┊11┊12┊\n ┊12┊13┊@NgModule({\n```\n```diff\n@@ -22,6 +23,7 @@\n ┊22┊23┊    // Feature modules\n ┊23┊24┊    ChatsListerModule,\n ┊24┊25┊    ChatViewerModule,\n+┊  ┊26┊    ChatsCreationModule,\n ┊25┊27┊  ],\n ┊26┊28┊  providers: [],\n ┊27┊29┊  bootstrap: [AppComponent]\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;chats-creation.module.ts\n```diff\n@@ -0,0 +1,60 @@\n+┊  ┊ 1┊import { BrowserModule } from '@angular/platform-browser';\n+┊  ┊ 2┊import { NgModule } from '@angular/core';\n+┊  ┊ 3┊\n+┊  ┊ 4┊import {BrowserAnimationsModule} from '@angular/platform-browser/animations';\n+┊  ┊ 5┊import {\n+┊  ┊ 6┊  MatButtonModule, MatFormFieldModule, MatGridListModule, MatIconModule, MatInputModule, MatListModule, MatMenuModule,\n+┊  ┊ 7┊  MatToolbarModule\n+┊  ┊ 8┊} from '@angular/material';\n+┊  ┊ 9┊import {RouterModule, Routes} from '@angular/router';\n+┊  ┊10┊import {FormsModule} from '@angular/forms';\n+┊  ┊11┊import {ChatsService} from '../services/chats.service';\n+┊  ┊12┊import {UserItemComponent} from './components/user-item/user-item.component';\n+┊  ┊13┊import {UsersListComponent} from './components/users-list/users-list.component';\n+┊  ┊14┊import {NewGroupComponent} from './containers/new-group/new-group.component';\n+┊  ┊15┊import {NewChatComponent} from './containers/new-chat/new-chat.component';\n+┊  ┊16┊import {NewGroupDetailsComponent} from './components/new-group-details/new-group-details.component';\n+┊  ┊17┊import {SharedModule} from '../shared/shared.module';\n+┊  ┊18┊import {NgxSelectableListModule} from 'ngx-selectable-list';\n+┊  ┊19┊\n+┊  ┊20┊const routes: Routes = [\n+┊  ┊21┊  {path: 'new-chat', component: NewChatComponent},\n+┊  ┊22┊  {path: 'new-group', component: NewGroupComponent},\n+┊  ┊23┊];\n+┊  ┊24┊\n+┊  ┊25┊@NgModule({\n+┊  ┊26┊  declarations: [\n+┊  ┊27┊    NewChatComponent,\n+┊  ┊28┊    UsersListComponent,\n+┊  ┊29┊    NewGroupComponent,\n+┊  ┊30┊    UserItemComponent,\n+┊  ┊31┊    NewGroupDetailsComponent,\n+┊  ┊32┊  ],\n+┊  ┊33┊  imports: [\n+┊  ┊34┊    BrowserModule,\n+┊  ┊35┊    // Animations (for Material)\n+┊  ┊36┊    BrowserAnimationsModule,\n+┊  ┊37┊    // Material\n+┊  ┊38┊    MatToolbarModule,\n+┊  ┊39┊    MatMenuModule,\n+┊  ┊40┊    MatIconModule,\n+┊  ┊41┊    MatButtonModule,\n+┊  ┊42┊    MatListModule,\n+┊  ┊43┊    MatGridListModule,\n+┊  ┊44┊    MatInputModule,\n+┊  ┊45┊    MatFormFieldModule,\n+┊  ┊46┊    MatGridListModule,\n+┊  ┊47┊    // Routing\n+┊  ┊48┊    RouterModule.forChild(routes),\n+┊  ┊49┊    // Forms\n+┊  ┊50┊    FormsModule,\n+┊  ┊51┊    // Feature modules\n+┊  ┊52┊    NgxSelectableListModule,\n+┊  ┊53┊    SharedModule,\n+┊  ┊54┊  ],\n+┊  ┊55┊  providers: [\n+┊  ┊56┊    ChatsService,\n+┊  ┊57┊  ],\n+┊  ┊58┊})\n+┊  ┊59┊export class ChatsCreationModule {\n+┊  ┊60┊}\n```\n\n[}]: #"
          },
          {
            "manualTitle": "Step 13: Zero latency on slow 3g networks",
            "stepRevision": "810cc1ec3030d51cec02928dfb862b0b3ed6df90",
            "manualView": "## Client\n\nNow let's start our client in production mode:\n\n    yarn start --prod\n\nNow open the **Chrome Developers Tools** and, in the **Network tab**, select `Slow 3G Network` and `Disable cache`.\nThen refresh the page and look at the `DOMContentLoaded` time and at the transferred size. You'll notice that our bundle size is quite small and so the loads time.\n\nNow let's click on a specific chat. It will take some time to load the data and then add a new message.\nOnce again it will take some time to load the data.\nWe could also create a new chat and the result would be the same.\nThe whole app doesn't feel as snappier as the real Whatsapp on a slow 3G Network.\n\n\"That's normal, it's a web application with a remote db while Whatsapp is a native app with a local database...\"\nThat's just an excuse, because we can do as good as Whatsapp thanks to Apollo!\n\nLet's install `moment`, we will soon need it:\n\n    yarn add moment\n\nStart by making our UI optimistic. We can predict most of the response we will get from our server, except for a few things like `id` of newly created messages. But since we don't really need that id, we can simply generate a fake one\nwhich will be later overridden once we get the response from the server:\n\n[{]: <helper> (diffStep \"9.1\" files=\"^\\(?!package.json$\\).*\" module=\"client\")\n\n#### [Step 9.1: Optimistic updates](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/39432fa)\n\n##### Changed src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-chat&#x2F;new-chat.component.ts\n```diff\n@@ -47,7 +47,7 @@\n ┊47┊47┊      // Chat is already listed for the current user\n ┊48┊48┊      this.router.navigate(['/chat', chatId]);\n ┊49┊49┊    } else {\n-┊50┊  ┊      this.chatsService.addChat(recipientId).subscribe(({data: {addChat: {id}}}: { data: AddChat.Mutation }) => {\n+┊  ┊50┊      this.chatsService.addChat(recipientId, this.users).subscribe(({data: {addChat: {id}}}: { data: AddChat.Mutation }) => {\n ┊51┊51┊        this.router.navigate(['/chat', id]);\n ┊52┊52┊      });\n ┊53┊53┊    }\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -2,6 +2,7 @@\n ┊2┊2┊import {Injectable} from '@angular/core';\n ┊3┊3┊import {Observable} from 'rxjs';\n ┊4┊4┊import {QueryRef} from 'apollo-angular';\n+┊ ┊5┊import * as moment from 'moment';\n ┊5┊6┊import {\n ┊6┊7┊  GetChatsGQL,\n ┊7┊8┊  GetChatGQL,\n```\n```diff\n@@ -17,10 +18,12 @@\n ┊17┊18┊  GetChat,\n ┊18┊19┊  RemoveMessages,\n ┊19┊20┊  RemoveAllMessages,\n+┊  ┊21┊  GetUsers,\n ┊20┊22┊} from '../../graphql';\n ┊21┊23┊import { DataProxy } from 'apollo-cache';\n ┊22┊24┊\n ┊23┊25┊const currentUserId = '1';\n+┊  ┊26┊const currentUserName = 'Ethan Gonzalez';\n ┊24┊27┊\n ┊25┊28┊@Injectable()\n ┊26┊29┊export class ChatsService {\n```\n```diff\n@@ -49,6 +52,10 @@\n ┊49┊52┊    this.chats$.subscribe(chats => this.chats = chats);\n ┊50┊53┊  }\n ┊51┊54┊\n+┊  ┊55┊  static getRandomId() {\n+┊  ┊56┊    return String(Math.round(Math.random() * 1000000000000));\n+┊  ┊57┊  }\n+┊  ┊58┊\n ┊52┊59┊  getChats() {\n ┊53┊60┊    return {query: this.getChatsWq, chats$: this.chats$};\n ┊54┊61┊  }\n```\n```diff\n@@ -70,6 +77,24 @@\n ┊ 70┊ 77┊      chatId,\n ┊ 71┊ 78┊      content,\n ┊ 72┊ 79┊    }, {\n+┊   ┊ 80┊      optimisticResponse: {\n+┊   ┊ 81┊        __typename: 'Mutation',\n+┊   ┊ 82┊        addMessage: {\n+┊   ┊ 83┊          id: ChatsService.getRandomId(),\n+┊   ┊ 84┊          __typename: 'Message',\n+┊   ┊ 85┊          senderId: currentUserId,\n+┊   ┊ 86┊          sender: {\n+┊   ┊ 87┊            id: currentUserId,\n+┊   ┊ 88┊            __typename: 'User',\n+┊   ┊ 89┊            name: currentUserName,\n+┊   ┊ 90┊          },\n+┊   ┊ 91┊          content,\n+┊   ┊ 92┊          createdAt: moment().unix(),\n+┊   ┊ 93┊          type: 0,\n+┊   ┊ 94┊          recipients: [],\n+┊   ┊ 95┊          ownership: true,\n+┊   ┊ 96┊        },\n+┊   ┊ 97┊      },\n ┊ 73┊ 98┊      update: (store, { data: { addMessage } }: {data: AddMessage.Mutation}) => {\n ┊ 74┊ 99┊        // Update the messages cache\n ┊ 75┊100┊        {\n```\n```diff\n@@ -121,6 +146,10 @@\n ┊121┊146┊      {\n ┊122┊147┊        chatId,\n ┊123┊148┊      }, {\n+┊   ┊149┊        optimisticResponse: {\n+┊   ┊150┊          __typename: 'Mutation',\n+┊   ┊151┊          removeChat: chatId,\n+┊   ┊152┊        },\n ┊124┊153┊        update: (store, { data: { removeChat } }) => {\n ┊125┊154┊          // Read the data from our cache for this query.\n ┊126┊155┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n```\n```diff\n@@ -154,6 +183,10 @@\n ┊154┊183┊    let ids: string[] = [];\n ┊155┊184┊\n ┊156┊185┊    const options = {\n+┊   ┊186┊      optimisticResponse: () => ({\n+┊   ┊187┊        __typename: 'Mutation',\n+┊   ┊188┊        removeMessages: ids,\n+┊   ┊189┊      }),\n ┊157┊190┊      update: (store: DataProxy, { data: { removeMessages } }: {data: RemoveMessages.Mutation | RemoveAllMessages.Mutation}) => {\n ┊158┊191┊        // Update the messages cache\n ┊159┊192┊        {\n```\n```diff\n@@ -242,11 +275,33 @@\n ┊242┊275┊    return _chat ? _chat.id : false;\n ┊243┊276┊  }\n ┊244┊277┊\n-┊245┊   ┊  addChat(recipientId: string) {\n+┊   ┊278┊  addChat(recipientId: string, users: GetUsers.Users[]) {\n ┊246┊279┊    return this.addChatGQL.mutate(\n ┊247┊280┊      {\n ┊248┊281┊        recipientId,\n ┊249┊282┊      }, {\n+┊   ┊283┊        optimisticResponse: {\n+┊   ┊284┊          __typename: 'Mutation',\n+┊   ┊285┊          addChat: {\n+┊   ┊286┊            id: ChatsService.getRandomId(),\n+┊   ┊287┊            __typename: 'Chat',\n+┊   ┊288┊            name: users.find(user => user.id === recipientId).name,\n+┊   ┊289┊            picture: users.find(user => user.id === recipientId).picture,\n+┊   ┊290┊            allTimeMembers: [\n+┊   ┊291┊              {\n+┊   ┊292┊                id: currentUserId,\n+┊   ┊293┊                __typename: 'User',\n+┊   ┊294┊              },\n+┊   ┊295┊              {\n+┊   ┊296┊                id: recipientId,\n+┊   ┊297┊                __typename: 'User',\n+┊   ┊298┊              }\n+┊   ┊299┊            ],\n+┊   ┊300┊            unreadMessages: 0,\n+┊   ┊301┊            messages: [],\n+┊   ┊302┊            isGroup: false,\n+┊   ┊303┊          },\n+┊   ┊304┊        },\n ┊250┊305┊        update: (store, { data: { addChat } }) => {\n ┊251┊306┊          // Read the data from our cache for this query.\n ┊252┊307┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n```\n```diff\n@@ -278,6 +333,26 @@\n ┊278┊333┊        recipientIds,\n ┊279┊334┊        groupName,\n ┊280┊335┊      }, {\n+┊   ┊336┊        optimisticResponse: {\n+┊   ┊337┊          __typename: 'Mutation',\n+┊   ┊338┊          addGroup: {\n+┊   ┊339┊            id: ChatsService.getRandomId(),\n+┊   ┊340┊            __typename: 'Chat',\n+┊   ┊341┊            name: groupName,\n+┊   ┊342┊            picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n+┊   ┊343┊            userIds: [currentUserId, recipientIds],\n+┊   ┊344┊            allTimeMembers: [\n+┊   ┊345┊              {\n+┊   ┊346┊                id: currentUserId,\n+┊   ┊347┊                __typename: 'User',\n+┊   ┊348┊              },\n+┊   ┊349┊              ...recipientIds.map(id => ({id, __typename: 'User'})),\n+┊   ┊350┊            ],\n+┊   ┊351┊            unreadMessages: 0,\n+┊   ┊352┊            messages: [],\n+┊   ┊353┊            isGroup: true,\n+┊   ┊354┊          },\n+┊   ┊355┊        },\n ┊281┊356┊        update: (store, { data: { addGroup } }) => {\n ┊282┊357┊          // Read the data from our cache for this query.\n ┊283┊358┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n```\n\n[}]: #\n\nWhen we open a specific chat we can also preload some data from our chats list cache while waiting for the server response. We will initially be able to show only the chat name, the last message or the last few messages and a few more informations instead of the whole content from the server, but that would be more than enough to entertain the user while waiting for the server response:\n\n[{]: <helper> (diffStep \"9.2\" module=\"client\")\n\n#### [Step 9.2: Get chat data from chats cache while waiting for server response](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/632468a)\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,6 +1,6 @@\n-┊1┊ ┊import {map} from 'rxjs/operators';\n+┊ ┊1┊import {concat, map} from 'rxjs/operators';\n ┊2┊2┊import {Injectable} from '@angular/core';\n-┊3┊ ┊import {Observable} from 'rxjs';\n+┊ ┊3┊import {Observable, AsyncSubject, of} from 'rxjs';\n ┊4┊4┊import {QueryRef} from 'apollo-angular';\n ┊5┊5┊import * as moment from 'moment';\n ┊6┊6┊import {\n```\n```diff\n@@ -31,6 +31,7 @@\n ┊31┊31┊  getChatsWq: QueryRef<GetChats.Query, GetChats.Variables>;\n ┊32┊32┊  chats$: Observable<GetChats.Chats[]>;\n ┊33┊33┊  chats: GetChats.Chats[];\n+┊  ┊34┊  getChatWqSubject: AsyncSubject<QueryRef<GetChat.Query>>;\n ┊34┊35┊\n ┊35┊36┊  constructor(\n ┊36┊37┊    private getChatsGQL: GetChatsGQL,\n```\n```diff\n@@ -61,15 +62,34 @@\n ┊61┊62┊  }\n ┊62┊63┊\n ┊63┊64┊  getChat(chatId: string) {\n+┊  ┊65┊    const _chat = this.chats && this.chats.find(chat => chat.id === chatId) || {\n+┊  ┊66┊      id: chatId,\n+┊  ┊67┊      name: '',\n+┊  ┊68┊      picture: null,\n+┊  ┊69┊      allTimeMembers: [],\n+┊  ┊70┊      unreadMessages: 0,\n+┊  ┊71┊      isGroup: false,\n+┊  ┊72┊      messages: [],\n+┊  ┊73┊    };\n+┊  ┊74┊    const chat$FromCache = of<GetChat.Chat>(_chat);\n+┊  ┊75┊\n ┊64┊76┊    const query = this.getChatGQL.watch({\n ┊65┊77┊      chatId: chatId,\n ┊66┊78┊    });\n ┊67┊79┊\n-┊68┊  ┊    const chat$ = query.valueChanges.pipe(\n-┊69┊  ┊      map((result) => result.data.chat)\n+┊  ┊80┊    const chat$ = chat$FromCache.pipe(\n+┊  ┊81┊      concat(\n+┊  ┊82┊        query.valueChanges.pipe(\n+┊  ┊83┊          map((result) => result.data.chat)\n+┊  ┊84┊        )\n+┊  ┊85┊      )\n ┊70┊86┊    );\n ┊71┊87┊\n-┊72┊  ┊    return {query, chat$};\n+┊  ┊88┊    this.getChatWqSubject = new AsyncSubject();\n+┊  ┊89┊    this.getChatWqSubject.next(query);\n+┊  ┊90┊    this.getChatWqSubject.complete();\n+┊  ┊91┊\n+┊  ┊92┊    return {query$: this.getChatWqSubject.asObservable(), chat$};\n ┊73┊93┊  }\n ┊74┊94┊\n ┊75┊95┊  addMessage(chatId: string, content: string) {\n```\n\n[}]: #\n\nNow let's deal with the most difficult part, chats creation.\n\nWe cannot predict the `id` of the new chat and so we cannot navigate to the chat page because it contains the chat id in the url. We could simply navigate to the \"optimistic\" id, but then the user wouldn't be able to reach that url if he refreshes the page or bookmarks it. That's a problem we care about.\n\nHow to solve it? We're going to create a landing page and we will later override the url once we get the response from the server!\n\n[{]: <helper> (diffStep \"9.3\" module=\"client\")\n\n#### [Step 9.3: Landing page for new chats/groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/87b9f5d)\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.spec.ts\n```diff\n@@ -129,7 +129,10 @@\n ┊129┊129┊        },\n ┊130┊130┊        {\n ┊131┊131┊          provide: ActivatedRoute,\n-┊132┊   ┊          useValue: { params: of({ id: chat.id }) },\n+┊   ┊132┊          useValue: {\n+┊   ┊133┊            params: of({ id: chat.id }),\n+┊   ┊134┊            queryParams: of({}),\n+┊   ┊135┊          },\n ┊133┊136┊        },\n ┊134┊137┊      ],\n ┊135┊138┊      schemas: [NO_ERRORS_SCHEMA],\n```\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.ts\n```diff\n@@ -2,6 +2,8 @@\n ┊2┊2┊import {ActivatedRoute, Router} from '@angular/router';\n ┊3┊3┊import {ChatsService} from '../../../services/chats.service';\n ┊4┊4┊import {GetChat} from '../../../../graphql';\n+┊ ┊5┊import {combineLatest} from 'rxjs';\n+┊ ┊6┊import {Location} from '@angular/common';\n ┊5┊7┊\n ┊6┊8┊@Component({\n ┊7┊9┊  template: `\n```\n```diff\n@@ -27,21 +29,40 @@\n ┊27┊29┊  messages: GetChat.Messages[];\n ┊28┊30┊  name: string;\n ┊29┊31┊  isGroup: boolean;\n+┊  ┊32┊  optimisticUI: boolean;\n ┊30┊33┊\n ┊31┊34┊  constructor(private route: ActivatedRoute,\n ┊32┊35┊              private router: Router,\n+┊  ┊36┊              private location: Location,\n ┊33┊37┊              private chatsService: ChatsService) {\n ┊34┊38┊  }\n ┊35┊39┊\n ┊36┊40┊  ngOnInit() {\n-┊37┊  ┊    this.route.params.subscribe(({id: chatId}) => {\n-┊38┊  ┊      this.chatId = chatId;\n-┊39┊  ┊      this.chatsService.getChat(chatId).chat$.subscribe(chat => {\n-┊40┊  ┊        this.messages = chat.messages;\n-┊41┊  ┊        this.name = chat.name;\n-┊42┊  ┊        this.isGroup = chat.isGroup;\n+┊  ┊41┊    combineLatest(this.route.params, this.route.queryParams,\n+┊  ┊42┊      (params: { id: string }, queryParams: { oui?: boolean }) => ({params, queryParams}))\n+┊  ┊43┊      .subscribe(({params: {id: chatId}, queryParams: {oui}}) => {\n+┊  ┊44┊        this.chatId = chatId;\n+┊  ┊45┊\n+┊  ┊46┊        this.optimisticUI = oui;\n+┊  ┊47┊\n+┊  ┊48┊        if (this.optimisticUI) {\n+┊  ┊49┊          // We are using fake IDs generated by the Optimistic UI\n+┊  ┊50┊          this.chatsService.addChat$.subscribe(({data: {addChat, addGroup}}) => {\n+┊  ┊51┊            this.chatId = addChat ? addChat.id : addGroup.id;\n+┊  ┊52┊            console.log(`Switching from the Optimistic UI id ${chatId} to ${this.chatId}`);\n+┊  ┊53┊            // Rewrite the URL\n+┊  ┊54┊            this.location.go(`chat/${this.chatId}`);\n+┊  ┊55┊            // Optimistic UI no more\n+┊  ┊56┊            this.optimisticUI = false;\n+┊  ┊57┊          });\n+┊  ┊58┊        }\n+┊  ┊59┊\n+┊  ┊60┊        this.chatsService.getChat(chatId, this.optimisticUI).chat$.subscribe(chat => {\n+┊  ┊61┊          this.messages = chat.messages;\n+┊  ┊62┊          this.name = chat.name;\n+┊  ┊63┊          this.isGroup = chat.isGroup;\n+┊  ┊64┊        });\n ┊43┊65┊      });\n-┊44┊  ┊    });\n ┊45┊66┊  }\n ┊46┊67┊\n ┊47┊68┊  goToChats() {\n```\n\n##### Changed src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-chat&#x2F;new-chat.component.ts\n```diff\n@@ -47,9 +47,10 @@\n ┊47┊47┊      // Chat is already listed for the current user\n ┊48┊48┊      this.router.navigate(['/chat', chatId]);\n ┊49┊49┊    } else {\n-┊50┊  ┊      this.chatsService.addChat(recipientId, this.users).subscribe(({data: {addChat: {id}}}: { data: AddChat.Mutation }) => {\n-┊51┊  ┊        this.router.navigate(['/chat', id]);\n-┊52┊  ┊      });\n+┊  ┊50┊      // Generate id for Optimistic UI\n+┊  ┊51┊      const ouiId = ChatsService.getRandomId();\n+┊  ┊52┊      this.chatsService.addChat(recipientId, this.users, ouiId).subscribe();\n+┊  ┊53┊      this.router.navigate(['/chat', ouiId], {queryParams: {oui: true}, skipLocationChange: true});\n ┊53┊54┊    }\n ┊54┊55┊  }\n ┊55┊56┊}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-group&#x2F;new-group.component.ts\n```diff\n@@ -52,9 +52,9 @@\n ┊52┊52┊\n ┊53┊53┊  addGroup(groupName: string) {\n ┊54┊54┊    if (groupName && this.recipientIds.length) {\n-┊55┊  ┊      this.chatsService.addGroup(this.recipientIds, groupName).subscribe(({data: {addGroup: {id}}}: { data: AddGroup.Mutation }) => {\n-┊56┊  ┊        this.router.navigate(['/chat', id]);\n-┊57┊  ┊      });\n+┊  ┊55┊      const ouiId = ChatsService.getRandomId();\n+┊  ┊56┊      this.chatsService.addGroup(this.recipientIds, groupName, ouiId).subscribe();\n+┊  ┊57┊      this.router.navigate(['/chat', ouiId], {queryParams: {oui: true}, skipLocationChange: true});\n ┊58┊58┊    }\n ┊59┊59┊  }\n ┊60┊60┊}\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,4 +1,4 @@\n-┊1┊ ┊import {concat, map} from 'rxjs/operators';\n+┊ ┊1┊import {concat, map, share, switchMap} from 'rxjs/operators';\n ┊2┊2┊import {Injectable} from '@angular/core';\n ┊3┊3┊import {Observable, AsyncSubject, of} from 'rxjs';\n ┊4┊4┊import {QueryRef} from 'apollo-angular';\n```\n```diff\n@@ -19,8 +19,11 @@\n ┊19┊19┊  RemoveMessages,\n ┊20┊20┊  RemoveAllMessages,\n ┊21┊21┊  GetUsers,\n+┊  ┊22┊  AddChat,\n+┊  ┊23┊  AddGroup,\n ┊22┊24┊} from '../../graphql';\n ┊23┊25┊import { DataProxy } from 'apollo-cache';\n+┊  ┊26┊import { FetchResult } from 'apollo-link';\n ┊24┊27┊\n ┊25┊28┊const currentUserId = '1';\n ┊26┊29┊const currentUserName = 'Ethan Gonzalez';\n```\n```diff\n@@ -32,6 +35,7 @@\n ┊32┊35┊  chats$: Observable<GetChats.Chats[]>;\n ┊33┊36┊  chats: GetChats.Chats[];\n ┊34┊37┊  getChatWqSubject: AsyncSubject<QueryRef<GetChat.Query>>;\n+┊  ┊38┊  addChat$: Observable<FetchResult<AddChat.Mutation | AddGroup.Mutation>>;\n ┊35┊39┊\n ┊36┊40┊  constructor(\n ┊37┊41┊    private getChatsGQL: GetChatsGQL,\n```\n```diff\n@@ -61,7 +65,7 @@\n ┊61┊65┊    return {query: this.getChatsWq, chats$: this.chats$};\n ┊62┊66┊  }\n ┊63┊67┊\n-┊64┊  ┊  getChat(chatId: string) {\n+┊  ┊68┊  getChat(chatId: string, oui?: boolean) {\n ┊65┊69┊    const _chat = this.chats && this.chats.find(chat => chat.id === chatId) || {\n ┊66┊70┊      id: chatId,\n ┊67┊71┊      name: '',\n```\n```diff\n@@ -73,21 +77,43 @@\n ┊ 73┊ 77┊    };\n ┊ 74┊ 78┊    const chat$FromCache = of<GetChat.Chat>(_chat);\n ┊ 75┊ 79┊\n-┊ 76┊   ┊    const query = this.getChatGQL.watch({\n-┊ 77┊   ┊      chatId: chatId,\n-┊ 78┊   ┊    });\n-┊ 79┊   ┊\n-┊ 80┊   ┊    const chat$ = chat$FromCache.pipe(\n-┊ 81┊   ┊      concat(\n-┊ 82┊   ┊        query.valueChanges.pipe(\n-┊ 83┊   ┊          map((result) => result.data.chat)\n-┊ 84┊   ┊        )\n-┊ 85┊   ┊      )\n-┊ 86┊   ┊    );\n+┊   ┊ 80┊    const getApolloWatchQuery = (id: string) => {\n+┊   ┊ 81┊      return this.getChatGQL.watch({\n+┊   ┊ 82┊        chatId: id,\n+┊   ┊ 83┊      });\n+┊   ┊ 84┊    };\n ┊ 87┊ 85┊\n+┊   ┊ 86┊    let chat$: Observable<GetChat.Chat>;\n ┊ 88┊ 87┊    this.getChatWqSubject = new AsyncSubject();\n-┊ 89┊   ┊    this.getChatWqSubject.next(query);\n-┊ 90┊   ┊    this.getChatWqSubject.complete();\n+┊   ┊ 88┊\n+┊   ┊ 89┊    if (oui) {\n+┊   ┊ 90┊      chat$ = chat$FromCache.pipe(\n+┊   ┊ 91┊        concat(this.addChat$.pipe(\n+┊   ┊ 92┊          switchMap(({ data: { addChat, addGroup } }) => {\n+┊   ┊ 93┊            const query = getApolloWatchQuery(addChat ? addChat.id : addGroup.id);\n+┊   ┊ 94┊\n+┊   ┊ 95┊            this.getChatWqSubject.next(query);\n+┊   ┊ 96┊            this.getChatWqSubject.complete();\n+┊   ┊ 97┊\n+┊   ┊ 98┊            return query.valueChanges.pipe(\n+┊   ┊ 99┊              map((result) => result.data.chat)\n+┊   ┊100┊            );\n+┊   ┊101┊          }))\n+┊   ┊102┊        ));\n+┊   ┊103┊    } else {\n+┊   ┊104┊      const query = getApolloWatchQuery(chatId);\n+┊   ┊105┊\n+┊   ┊106┊      this.getChatWqSubject.next(query);\n+┊   ┊107┊      this.getChatWqSubject.complete();\n+┊   ┊108┊\n+┊   ┊109┊      chat$ = chat$FromCache.pipe(\n+┊   ┊110┊        concat(\n+┊   ┊111┊          query.valueChanges.pipe(\n+┊   ┊112┊            map((result) => result.data.chat)\n+┊   ┊113┊          )\n+┊   ┊114┊        )\n+┊   ┊115┊      );\n+┊   ┊116┊    }\n ┊ 91┊117┊\n ┊ 92┊118┊    return {query$: this.getChatWqSubject.asObservable(), chat$};\n ┊ 93┊119┊  }\n```\n```diff\n@@ -295,15 +321,15 @@\n ┊295┊321┊    return _chat ? _chat.id : false;\n ┊296┊322┊  }\n ┊297┊323┊\n-┊298┊   ┊  addChat(recipientId: string, users: GetUsers.Users[]) {\n-┊299┊   ┊    return this.addChatGQL.mutate(\n+┊   ┊324┊  addChat(recipientId: string, users: GetUsers.Users[], ouiId: string) {\n+┊   ┊325┊    this.addChat$ = this.addChatGQL.mutate(\n ┊300┊326┊      {\n ┊301┊327┊        recipientId,\n ┊302┊328┊      }, {\n ┊303┊329┊        optimisticResponse: {\n ┊304┊330┊          __typename: 'Mutation',\n ┊305┊331┊          addChat: {\n-┊306┊   ┊            id: ChatsService.getRandomId(),\n+┊   ┊332┊            id: ouiId,\n ┊307┊333┊            __typename: 'Chat',\n ┊308┊334┊            name: users.find(user => user.id === recipientId).name,\n ┊309┊335┊            picture: users.find(user => user.id === recipientId).picture,\n```\n```diff\n@@ -344,11 +370,12 @@\n ┊344┊370┊          });\n ┊345┊371┊        },\n ┊346┊372┊      }\n-┊347┊   ┊    );\n+┊   ┊373┊    ).pipe(share());\n+┊   ┊374┊    return this.addChat$;\n ┊348┊375┊  }\n ┊349┊376┊\n-┊350┊   ┊  addGroup(recipientIds: string[], groupName: string) {\n-┊351┊   ┊    return this.addGroupGQL.mutate(\n+┊   ┊377┊  addGroup(recipientIds: string[], groupName: string, ouiId: string) {\n+┊   ┊378┊    this.addChat$ = this.addGroupGQL.mutate(\n ┊352┊379┊      {\n ┊353┊380┊        recipientIds,\n ┊354┊381┊        groupName,\n```\n```diff\n@@ -356,7 +383,7 @@\n ┊356┊383┊        optimisticResponse: {\n ┊357┊384┊          __typename: 'Mutation',\n ┊358┊385┊          addGroup: {\n-┊359┊   ┊            id: ChatsService.getRandomId(),\n+┊   ┊386┊            id: ouiId,\n ┊360┊387┊            __typename: 'Chat',\n ┊361┊388┊            name: groupName,\n ┊362┊389┊            picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n```\n```diff\n@@ -395,6 +422,7 @@\n ┊395┊422┊          });\n ┊396┊423┊        },\n ┊397┊424┊      }\n-┊398┊   ┊    );\n+┊   ┊425┊    ).pipe(share());\n+┊   ┊426┊    return this.addChat$;\n ┊399┊427┊  }\n ┊400┊428┊}\n```\n\n[}]: #\n\nPoof, now our Whatsapp clone feels no more like a clone it has the same native feel."
          },
          {
            "manualTitle": "Step 14: Authentication",
            "stepRevision": "3bbd4a531535c2e7e356cdf86f77e6f301264e21",
            "manualView": "![login](https://user-images.githubusercontent.com/7648874/49270369-06c22200-f4a4-11e8-83e5-cef2400989a6.jpg)\n\n## Authentication on server\n\nAuthentication is an hot topic in the GraphQL world and there are some projects which aim at authenticating through GraphQL.\nSince often you will be required to use a specific auth framework (because of a feature you need or because of an existing authorization infrastructure) I will show you how to use a classic REST API framework within your GraphQL application.\nThis approach is completely fine and in line with the official GraphQL best practices.\nWe will use `Passport` for the authentication and `BasicAuth` as the auth mechanism:\n\n    yarn add bcrypt-nodejs passport passport-http\n    yarn add -D @types/bcrypt-nodejs @types/passport @types/passport-http\n\n`BasicAuth` basically involves to send username e password in an Authorization Header together with each request and is fully supported by any browser (meaning that we will be able to use `Graphiql` simply by proving username and password in the login window provided by the browser itself).\nIt's the most simple auth mechanism but it's completely fine for our needs. Later we could decide to use something more complicated like `JWT`, but it's outside of the scope of this tutorial.\n\n[{]: <helper> (diffStep \"4.1\" files=\"index.ts\" module=\"server\")\n\n#### [Step 4.1: Authentication](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/2ee3fa9)\n\n##### Changed index.ts\n```diff\n@@ -3,6 +3,47 @@\n ┊ 3┊ 3┊import * as cors from 'cors';\n ┊ 4┊ 4┊import * as express from 'express';\n ┊ 5┊ 5┊import { ApolloServer } from \"apollo-server-express\";\n+┊  ┊ 6┊import * as passport from \"passport\";\n+┊  ┊ 7┊import * as basicStrategy from 'passport-http';\n+┊  ┊ 8┊import * as bcrypt from 'bcrypt-nodejs';\n+┊  ┊ 9┊import { db, User } from \"./db\";\n+┊  ┊10┊\n+┊  ┊11┊let users = db.users;\n+┊  ┊12┊\n+┊  ┊13┊function generateHash(password: string) {\n+┊  ┊14┊  return bcrypt.hashSync(password, bcrypt.genSaltSync(8));\n+┊  ┊15┊}\n+┊  ┊16┊\n+┊  ┊17┊function validPassword(password: string, localPassword: string) {\n+┊  ┊18┊  return bcrypt.compareSync(password, localPassword);\n+┊  ┊19┊}\n+┊  ┊20┊\n+┊  ┊21┊passport.use('basic-signin', new basicStrategy.BasicStrategy(\n+┊  ┊22┊  function (username: string, password: string, done: any) {\n+┊  ┊23┊    const user = users.find(user => user.username == username);\n+┊  ┊24┊    if (user && validPassword(password, user.password)) {\n+┊  ┊25┊      return done(null, user);\n+┊  ┊26┊    }\n+┊  ┊27┊    return done(null, false);\n+┊  ┊28┊  }\n+┊  ┊29┊));\n+┊  ┊30┊\n+┊  ┊31┊passport.use('basic-signup', new basicStrategy.BasicStrategy({passReqToCallback: true},\n+┊  ┊32┊  function (req: any, username: any, password: any, done: any) {\n+┊  ┊33┊    const userExists = !!users.find(user => user.username === username);\n+┊  ┊34┊    if (!userExists && password && req.body.name) {\n+┊  ┊35┊      const user: User = {\n+┊  ┊36┊        id: (users.length && users[users.length - 1].id + 1) || 1,\n+┊  ┊37┊        username,\n+┊  ┊38┊        password: generateHash(password),\n+┊  ┊39┊        name: req.body.name,\n+┊  ┊40┊      };\n+┊  ┊41┊      users.push(user);\n+┊  ┊42┊      return done(null, user);\n+┊  ┊43┊    }\n+┊  ┊44┊    return done(null, false);\n+┊  ┊45┊  }\n+┊  ┊46┊));\n ┊ 6┊47┊\n ┊ 7┊48┊const PORT = 3000;\n ┊ 8┊49┊\n```\n```diff\n@@ -10,9 +51,27 @@\n ┊10┊51┊\n ┊11┊52┊app.use(cors());\n ┊12┊53┊app.use(bodyParser.json());\n+┊  ┊54┊app.use(passport.initialize());\n+┊  ┊55┊\n+┊  ┊56┊app.post('/signup',\n+┊  ┊57┊  passport.authenticate('basic-signup', {session: false}),\n+┊  ┊58┊  function (req: any, res) {\n+┊  ┊59┊    res.json(req.user);\n+┊  ┊60┊  });\n+┊  ┊61┊\n+┊  ┊62┊app.use(passport.authenticate('basic-signin', {session: false}));\n+┊  ┊63┊\n+┊  ┊64┊app.post('/signin', function (req: any, res) {\n+┊  ┊65┊  res.json(req.user);\n+┊  ┊66┊});\n ┊13┊67┊\n ┊14┊68┊const apollo = new ApolloServer({\n-┊15┊  ┊  schema\n+┊  ┊69┊  schema,\n+┊  ┊70┊  context(received: any) {\n+┊  ┊71┊    return {\n+┊  ┊72┊      user: received.req!['user'],\n+┊  ┊73┊    }\n+┊  ┊74┊  },\n ┊16┊75┊});\n ┊17┊76┊\n ┊18┊77┊apollo.applyMiddleware({\n```\n\n[}]: #\n\nWe are going to store hashes instead of plain passwords, that's why we're using `bcrypt-nodejs`.\nWith `passport.use('basic-signin')` and `passport.use('basic-signup')` we define how the auth framework deals with our database (well, our JSON file for the moment).\n`app.post('/signup')` is the endpoint for creating new accounts, so we left it out of the authentication middleware (`app.use(passport.authenticate('basic-signin')`).\nWhat's of particular interest is that we're passing the user object to the GraphQL context.\n\n[{]: <helper> (diffStep \"4.1\" files=\"schema/resolvers.ts\" module=\"server\")\n\n#### [Step 4.1: Authentication](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/2ee3fa9)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -8,29 +8,28 @@\n ┊ 8┊ 8┊\n ┊ 9┊ 9┊let users = db.users;\n ┊10┊10┊let chats = db.chats;\n-┊11┊  ┊const currentUser = 1;\n ┊12┊11┊\n ┊13┊12┊export const resolvers: IResolvers = {\n ┊14┊13┊  Query: {\n ┊15┊14┊    // Show all users for the moment.\n-┊16┊  ┊    users: (): User[] => users.filter(user => user.id !== currentUser),\n-┊17┊  ┊    chats: (): Chat[] => chats.filter(chat => chat.listingMemberIds.includes(currentUser)),\n+┊  ┊15┊    users: (obj: any, args: any, {user: currentUser}: {user: User}): User[] => users.filter(user => user.id !== currentUser.id),\n+┊  ┊16┊    chats: (obj: any, args: any, {user: currentUser}: {user: User}): Chat[] => chats.filter(chat => chat.listingMemberIds.includes(currentUser.id)),\n ┊18┊17┊    chat: (obj: any, {chatId}: ChatQueryArgs): Chat | null => chats.find(chat => chat.id === Number(chatId)) || null,\n ┊19┊18┊  },\n ┊20┊19┊  Mutation: {\n-┊21┊  ┊    addChat: (obj: any, {recipientId}: AddChatMutationArgs): Chat => {\n+┊  ┊20┊    addChat: (obj: any, {recipientId}: AddChatMutationArgs, {user: currentUser}: {user: User}): Chat => {\n ┊22┊21┊      if (!users.find(user => user.id === Number(recipientId))) {\n ┊23┊22┊        throw new Error(`Recipient ${recipientId} doesn't exist.`);\n ┊24┊23┊      }\n ┊25┊24┊\n-┊26┊  ┊      const chat = chats.find(chat => !chat.name && chat.allTimeMemberIds.includes(currentUser) && chat.allTimeMemberIds.includes(Number(recipientId)));\n+┊  ┊25┊      const chat = chats.find(chat => !chat.name && chat.allTimeMemberIds.includes(currentUser.id) && chat.allTimeMemberIds.includes(Number(recipientId)));\n ┊27┊26┊      if (chat) {\n ┊28┊27┊        // Chat already exists. Both users are already in the allTimeMemberIds array\n ┊29┊28┊        const chatId = chat.id;\n-┊30┊  ┊        if (!chat.listingMemberIds.includes(currentUser)) {\n+┊  ┊29┊        if (!chat.listingMemberIds.includes(currentUser.id)) {\n ┊31┊30┊          // The chat isn't listed for the current user. Add him to the memberIds\n-┊32┊  ┊          chat.listingMemberIds.push(currentUser);\n-┊33┊  ┊          chats.find(chat => chat.id === chatId)!.listingMemberIds.push(currentUser);\n+┊  ┊31┊          chat.listingMemberIds.push(currentUser.id);\n+┊  ┊32┊          chats.find(chat => chat.id === chatId)!.listingMemberIds.push(currentUser.id);\n ┊34┊33┊          return chat;\n ┊35┊34┊        } else {\n ┊36┊35┊          throw new Error(`Chat already exists.`);\n```\n```diff\n@@ -44,9 +43,9 @@\n ┊44┊43┊          picture: null,\n ┊45┊44┊          adminIds: null,\n ┊46┊45┊          ownerId: null,\n-┊47┊  ┊          allTimeMemberIds: [currentUser, Number(recipientId)],\n+┊  ┊46┊          allTimeMemberIds: [currentUser.id, Number(recipientId)],\n ┊48┊47┊          // Chat will not be listed to the other user until the first message gets written\n-┊49┊  ┊          listingMemberIds: [currentUser],\n+┊  ┊48┊          listingMemberIds: [currentUser.id],\n ┊50┊49┊          actualGroupMemberIds: null,\n ┊51┊50┊          messages: [],\n ┊52┊51┊        };\n```\n```diff\n@@ -54,7 +53,7 @@\n ┊54┊53┊        return chat;\n ┊55┊54┊      }\n ┊56┊55┊    },\n-┊57┊  ┊    addGroup: (obj: any, {recipientIds, groupName}: AddGroupMutationArgs): Chat => {\n+┊  ┊56┊    addGroup: (obj: any, {recipientIds, groupName}: AddGroupMutationArgs, {user: currentUser}: {user: User}): Chat => {\n ┊58┊57┊      recipientIds.forEach(recipientId => {\n ┊59┊58┊        if (!users.find(user => user.id === Number(recipientId))) {\n ┊60┊59┊          throw new Error(`Recipient ${recipientId} doesn't exist.`);\n```\n```diff\n@@ -66,17 +65,17 @@\n ┊66┊65┊        id,\n ┊67┊66┊        name: groupName,\n ┊68┊67┊        picture: null,\n-┊69┊  ┊        adminIds: [currentUser],\n-┊70┊  ┊        ownerId: currentUser,\n-┊71┊  ┊        allTimeMemberIds: [currentUser, ...recipientIds.map(id => Number(id))],\n-┊72┊  ┊        listingMemberIds: [currentUser, ...recipientIds.map(id => Number(id))],\n-┊73┊  ┊        actualGroupMemberIds: [currentUser, ...recipientIds.map(id => Number(id))],\n+┊  ┊68┊        adminIds: [currentUser.id],\n+┊  ┊69┊        ownerId: currentUser.id,\n+┊  ┊70┊        allTimeMemberIds: [currentUser.id, ...recipientIds.map(id => Number(id))],\n+┊  ┊71┊        listingMemberIds: [currentUser.id, ...recipientIds.map(id => Number(id))],\n+┊  ┊72┊        actualGroupMemberIds: [currentUser.id, ...recipientIds.map(id => Number(id))],\n ┊74┊73┊        messages: [],\n ┊75┊74┊      };\n ┊76┊75┊      chats.push(chat);\n ┊77┊76┊      return chat;\n ┊78┊77┊    },\n-┊79┊  ┊    removeChat: (obj: any, {chatId}: RemoveChatMutationArgs): number => {\n+┊  ┊78┊    removeChat: (obj: any, {chatId}: RemoveChatMutationArgs, {user: currentUser}: {user: User}): number => {\n ┊80┊79┊      const chat = chats.find(chat => chat.id === Number(chatId));\n ┊81┊80┊\n ┊82┊81┊      if (!chat) {\n```\n```diff\n@@ -85,14 +84,14 @@\n ┊85┊84┊\n ┊86┊85┊      if (!chat.name) {\n ┊87┊86┊        // Chat\n-┊88┊  ┊        if (!chat.listingMemberIds.includes(currentUser)) {\n+┊  ┊87┊        if (!chat.listingMemberIds.includes(currentUser.id)) {\n ┊89┊88┊          throw new Error(`The user is not a member of the chat ${chatId}.`);\n ┊90┊89┊        }\n ┊91┊90┊\n ┊92┊91┊        // Instead of chaining map and filter we can loop once using reduce\n ┊93┊92┊        const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n ┊94┊93┊          // Remove the current user from the message holders\n-┊95┊  ┊          message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser);\n+┊  ┊94┊          message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser.id);\n ┊96┊95┊\n ┊97┊96┊          if (message.holderIds.length !== 0) {\n ┊98┊97┊            filtered.push(message);\n```\n```diff\n@@ -102,7 +101,7 @@\n ┊102┊101┊        }, []);\n ┊103┊102┊\n ┊104┊103┊        // Remove the current user from who gets the chat listed. The chat will no longer appear in his list\n-┊105┊   ┊        const listingMemberIds = chat.listingMemberIds.filter(listingId => listingId !== currentUser);\n+┊   ┊104┊        const listingMemberIds = chat.listingMemberIds.filter(listingId => listingId !== currentUser.id);\n ┊106┊105┊\n ┊107┊106┊        // Check how many members are left\n ┊108┊107┊        if (listingMemberIds.length === 0) {\n```\n```diff\n@@ -120,14 +119,14 @@\n ┊120┊119┊        return Number(chatId);\n ┊121┊120┊      } else {\n ┊122┊121┊        // Group\n-┊123┊   ┊        if (chat.ownerId !== currentUser) {\n+┊   ┊122┊        if (chat.ownerId !== currentUser.id) {\n ┊124┊123┊          throw new Error(`Group ${chatId} is not owned by the user.`);\n ┊125┊124┊        }\n ┊126┊125┊\n ┊127┊126┊        // Instead of chaining map and filter we can loop once using reduce\n ┊128┊127┊        const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n ┊129┊128┊          // Remove the current user from the message holders\n-┊130┊   ┊          message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser);\n+┊   ┊129┊          message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser.id);\n ┊131┊130┊\n ┊132┊131┊          if (message.holderIds.length !== 0) {\n ┊133┊132┊            filtered.push(message);\n```\n```diff\n@@ -137,7 +136,7 @@\n ┊137┊136┊        }, []);\n ┊138┊137┊\n ┊139┊138┊        // Remove the current user from who gets the group listed. The group will no longer appear in his list\n-┊140┊   ┊        const listingMemberIds = chat.listingMemberIds.filter(listingId => listingId !== currentUser);\n+┊   ┊139┊        const listingMemberIds = chat.listingMemberIds.filter(listingId => listingId !== currentUser.id);\n ┊141┊140┊\n ┊142┊141┊        // Check how many members (including previous ones who can still access old messages) are left\n ┊143┊142┊        if (listingMemberIds.length === 0) {\n```\n```diff\n@@ -147,9 +146,9 @@\n ┊147┊146┊          // Update the group\n ┊148┊147┊\n ┊149┊148┊          // Remove the current user from the chat members. He is no longer a member of the group\n-┊150┊   ┊          const actualGroupMemberIds = chat.actualGroupMemberIds!.filter(memberId => memberId !== currentUser);\n+┊   ┊149┊          const actualGroupMemberIds = chat.actualGroupMemberIds!.filter(memberId => memberId !== currentUser.id);\n ┊151┊150┊          // Remove the current user from the chat admins\n-┊152┊   ┊          const adminIds = chat.adminIds!.filter(memberId => memberId !== currentUser);\n+┊   ┊151┊          const adminIds = chat.adminIds!.filter(memberId => memberId !== currentUser.id);\n ┊153┊152┊          // Set the owner id to be null. A null owner means the group is read-only\n ┊154┊153┊          let ownerId: number | null = null;\n ┊155┊154┊\n```\n```diff\n@@ -169,7 +168,7 @@\n ┊169┊168┊        return Number(chatId);\n ┊170┊169┊      }\n ┊171┊170┊    },\n-┊172┊   ┊    addMessage: (obj: any, {chatId, content}: AddMessageMutationArgs): Message => {\n+┊   ┊171┊    addMessage: (obj: any, {chatId, content}: AddMessageMutationArgs, {user: currentUser}: {user: User}): Message => {\n ┊173┊172┊      if (content === null || content === '') {\n ┊174┊173┊        throw new Error(`Cannot add empty or null messages.`);\n ┊175┊174┊      }\n```\n```diff\n@@ -184,11 +183,11 @@\n ┊184┊183┊\n ┊185┊184┊      if (!chat.name) {\n ┊186┊185┊        // Chat\n-┊187┊   ┊        if (!chat.listingMemberIds.find(listingId => listingId === currentUser)) {\n+┊   ┊186┊        if (!chat.listingMemberIds.find(listingId => listingId === currentUser.id)) {\n ┊188┊187┊          throw new Error(`The chat ${chatId} must be listed for the current user before adding a message.`);\n ┊189┊188┊        }\n ┊190┊189┊\n-┊191┊   ┊        const recipientId = chat.allTimeMemberIds.filter(userId => userId !== currentUser)[0];\n+┊   ┊190┊        const recipientId = chat.allTimeMemberIds.filter(userId => userId !== currentUser.id)[0];\n ┊192┊191┊\n ┊193┊192┊        if (!chat.listingMemberIds.find(listingId => listingId === recipientId)) {\n ┊194┊193┊          // Chat is not listed for the recipient. Add him to the listingMemberIds\n```\n```diff\n@@ -205,7 +204,7 @@\n ┊205┊204┊        }\n ┊206┊205┊      } else {\n ┊207┊206┊        // Group\n-┊208┊   ┊        if (!chat.actualGroupMemberIds!.find(memberId => memberId === currentUser)) {\n+┊   ┊207┊        if (!chat.actualGroupMemberIds!.find(memberId => memberId === currentUser.id)) {\n ┊209┊208┊          throw new Error(`The user is not a member of the group ${chatId}. Cannot add message.`);\n ┊210┊209┊        }\n ┊211┊210┊\n```\n```diff\n@@ -217,7 +216,7 @@\n ┊217┊216┊      let recipients: Recipient[] = [];\n ┊218┊217┊\n ┊219┊218┊      holderIds.forEach(holderId => {\n-┊220┊   ┊        if (holderId !== currentUser) {\n+┊   ┊219┊        if (holderId !== currentUser.id) {\n ┊221┊220┊          recipients.push({\n ┊222┊221┊            userId: holderId,\n ┊223┊222┊            messageId: id,\n```\n```diff\n@@ -231,7 +230,7 @@\n ┊231┊230┊      const message: Message = {\n ┊232┊231┊        id,\n ┊233┊232┊        chatId: Number(chatId),\n-┊234┊   ┊        senderId: currentUser,\n+┊   ┊233┊        senderId: currentUser.id,\n ┊235┊234┊        content,\n ┊236┊235┊        createdAt: moment().unix(),\n ┊237┊236┊        type: MessageType.TEXT,\n```\n```diff\n@@ -248,14 +247,14 @@\n ┊248┊247┊\n ┊249┊248┊      return message;\n ┊250┊249┊    },\n-┊251┊   ┊    removeMessages: (obj: any, {chatId, messageIds, all}: RemoveMessagesMutationArgs): number[] => {\n+┊   ┊250┊    removeMessages: (obj: any, {chatId, messageIds, all}: RemoveMessagesMutationArgs, {user: currentUser}: {user: User}): number[] => {\n ┊252┊251┊      const chat = chats.find(chat => chat.id === Number(chatId));\n ┊253┊252┊\n ┊254┊253┊      if (!chat) {\n ┊255┊254┊        throw new Error(`Cannot find chat ${chatId}.`);\n ┊256┊255┊      }\n ┊257┊256┊\n-┊258┊   ┊      if (!chat.listingMemberIds.find(listingId => listingId === currentUser)) {\n+┊   ┊257┊      if (!chat.listingMemberIds.find(listingId => listingId === currentUser.id)) {\n ┊259┊258┊        throw new Error(`The chat/group ${chatId} is not listed for the current user, so there is nothing to delete.`);\n ┊260┊259┊      }\n ┊261┊260┊\n```\n```diff\n@@ -271,7 +270,7 @@\n ┊271┊270┊            if (all || messageIds!.includes(String(message.id))) {\n ┊272┊271┊              deletedIds.push(message.id);\n ┊273┊272┊              // Remove the current user from the message holders\n-┊274┊   ┊              message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser);\n+┊   ┊273┊              message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser.id);\n ┊275┊274┊            }\n ┊276┊275┊\n ┊277┊276┊            if (message.holderIds.length !== 0) {\n```\n```diff\n@@ -288,24 +287,24 @@\n ┊288┊287┊    },\n ┊289┊288┊  },\n ┊290┊289┊  Chat: {\n-┊291┊   ┊    name: (chat: Chat): string => chat.name ? chat.name : users\n-┊292┊   ┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser))!.name,\n-┊293┊   ┊    picture: (chat: Chat) => chat.name ? chat.picture : users\n-┊294┊   ┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser))!.picture,\n+┊   ┊290┊    name: (chat: Chat, args: any, {user: currentUser}: {user: User}): string => chat.name ? chat.name : users\n+┊   ┊291┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser.id))!.name,\n+┊   ┊292┊    picture: (chat: Chat, args: any, {user: currentUser}: {user: User}) => chat.name ? chat.picture : users\n+┊   ┊293┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser.id))!.picture,\n ┊295┊294┊    allTimeMembers: (chat: Chat): User[] => users.filter(user => chat.allTimeMemberIds.includes(user.id)),\n ┊296┊295┊    listingMembers: (chat: Chat): User[] => users.filter(user => chat.listingMemberIds.includes(user.id)),\n ┊297┊296┊    actualGroupMembers: (chat: Chat): User[] => users.filter(user => chat.actualGroupMemberIds && chat.actualGroupMemberIds.includes(user.id)),\n ┊298┊297┊    admins: (chat: Chat): User[] => users.filter(user => chat.adminIds && chat.adminIds.includes(user.id)),\n ┊299┊298┊    owner: (chat: Chat): User | null => users.find(user => chat.ownerId === user.id) || null,\n-┊300┊   ┊    messages: (chat: Chat, {amount = 0}: {amount: number}): Message[] => {\n+┊   ┊299┊    messages: (chat: Chat, {amount = 0}: {amount: number}, {user: currentUser}: {user: User}): Message[] => {\n ┊301┊300┊      const messages = chat.messages\n-┊302┊   ┊      .filter(message => message.holderIds.includes(currentUser))\n+┊   ┊301┊      .filter(message => message.holderIds.includes(currentUser.id))\n ┊303┊302┊      .sort((a, b) => b.createdAt - a.createdAt) || <Message[]>[];\n ┊304┊303┊      return (amount ? messages.slice(0, amount) : messages).reverse();\n ┊305┊304┊    },\n-┊306┊   ┊    unreadMessages: (chat: Chat): number => chat.messages\n-┊307┊   ┊      .filter(message => message.holderIds.includes(currentUser) &&\n-┊308┊   ┊        message.recipients.find(recipient => recipient.userId === currentUser && !recipient.readAt))\n+┊   ┊305┊    unreadMessages: (chat: Chat, args: any, {user: currentUser}: {user: User}): number => chat.messages\n+┊   ┊306┊      .filter(message => message.holderIds.includes(currentUser.id) &&\n+┊   ┊307┊        message.recipients.find(recipient => recipient.userId === currentUser.id && !recipient.readAt))\n ┊309┊308┊      .length,\n ┊310┊309┊    isGroup: (chat: Chat): boolean => !!chat.name,\n ┊311┊310┊  },\n```\n```diff\n@@ -313,7 +312,7 @@\n ┊313┊312┊    chat: (message: Message): Chat | null => chats.find(chat => message.chatId === chat.id) || null,\n ┊314┊313┊    sender: (message: Message): User | null => users.find(user => user.id === message.senderId) || null,\n ┊315┊314┊    holders: (message: Message): User[] => users.filter(user => message.holderIds.includes(user.id)),\n-┊316┊   ┊    ownership: (message: Message): boolean => message.senderId === currentUser,\n+┊   ┊315┊    ownership: (message: Message, args: any, {user: currentUser}: {user: User}): boolean => message.senderId === currentUser.id,\n ┊317┊316┊  },\n ┊318┊317┊  Recipient: {\n ┊319┊318┊    user: (recipient: Recipient): User | null => users.find(user => recipient.userId === user.id) || null,\n```\n\n[}]: #\n\nIn the resolvers we're basically making use of the user object taken from the context.\n\n## Authentication on client\n\nLet's start installing `@angular/flex-layout`, because we will use it later:\n\n    yarn add @angular/flex-layout\n\n\nFirst of all we need to create an `HTTP Interceptor`, which will intercept every HTTP request and will add authentication headers.\nFor the moment we still don't have those headers, but we are going to store them in the `LocalStorage` later.\nWe are also creating an `AuthGuard`, which we will use to stop the user from reaching unauthorized Routes.\n\nThe `AuthGuard` will simply look for the presence of the `Authentication` Header, but will not guarantee that the header is authentic.\nThis is no problem, because client side AuthGuards are not safe by design and the real authentication will be done server side anyway.\nAuthGuards are here just to redirect the user to the Login page.\n\nThe service we are going to create will contain some auth methods we are going to use across the app.\n\n[{]: <helper> (diffStep \"10.1\" files=\"src/app/login/services\" module=\"client\")\n\n#### [Step 10.1: Authentication](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/34faf60)\n\n##### Added src&#x2F;app&#x2F;login&#x2F;services&#x2F;auth.guard.ts\n```diff\n@@ -0,0 +1,18 @@\n+┊  ┊ 1┊import {Injectable} from '@angular/core';\n+┊  ┊ 2┊import {CanActivate, Router} from '@angular/router';\n+┊  ┊ 3┊import {LoginService} from './login.service';\n+┊  ┊ 4┊\n+┊  ┊ 5┊@Injectable()\n+┊  ┊ 6┊export class AuthGuard implements CanActivate {\n+┊  ┊ 7┊  constructor(private router: Router,\n+┊  ┊ 8┊              private loginService: LoginService) {}\n+┊  ┊ 9┊\n+┊  ┊10┊  canActivate() {\n+┊  ┊11┊    if (this.loginService.getAuthHeader()) {\n+┊  ┊12┊      return true;\n+┊  ┊13┊    } else {\n+┊  ┊14┊      this.router.navigate(['/login']);\n+┊  ┊15┊      return false;\n+┊  ┊16┊    }\n+┊  ┊17┊  }\n+┊  ┊18┊}\n```\n\n##### Added src&#x2F;app&#x2F;login&#x2F;services&#x2F;auth.interceptor.ts\n```diff\n@@ -0,0 +1,20 @@\n+┊  ┊ 1┊import {Injectable} from '@angular/core';\n+┊  ┊ 2┊import {HttpEvent, HttpHandler, HttpInterceptor, HttpRequest} from '@angular/common/http';\n+┊  ┊ 3┊import {Observable} from 'rxjs';\n+┊  ┊ 4┊import {LoginService} from './login.service';\n+┊  ┊ 5┊\n+┊  ┊ 6┊@Injectable()\n+┊  ┊ 7┊export class AuthInterceptor implements HttpInterceptor {\n+┊  ┊ 8┊  constructor(private loginService: LoginService) {}\n+┊  ┊ 9┊  intercept(request: HttpRequest<any>, next: HttpHandler): Observable<HttpEvent<any>> {\n+┊  ┊10┊    const auth = this.loginService.getAuthHeader();\n+┊  ┊11┊    if (auth) {\n+┊  ┊12┊      request = request.clone({\n+┊  ┊13┊        setHeaders: {\n+┊  ┊14┊          Authorization: auth,\n+┊  ┊15┊        }\n+┊  ┊16┊      });\n+┊  ┊17┊    }\n+┊  ┊18┊    return next.handle(request);\n+┊  ┊19┊  }\n+┊  ┊20┊}\n```\n\n##### Added src&#x2F;app&#x2F;login&#x2F;services&#x2F;login.service.ts\n```diff\n@@ -0,0 +1,24 @@\n+┊  ┊ 1┊import { Injectable } from '@angular/core';\n+┊  ┊ 2┊import {User} from '../../../graphql';\n+┊  ┊ 3┊\n+┊  ┊ 4┊@Injectable()\n+┊  ┊ 5┊export class LoginService {\n+┊  ┊ 6┊\n+┊  ┊ 7┊  constructor() { }\n+┊  ┊ 8┊\n+┊  ┊ 9┊  storeAuthHeader(auth: string) {\n+┊  ┊10┊    localStorage.setItem('Authorization', auth);\n+┊  ┊11┊  }\n+┊  ┊12┊\n+┊  ┊13┊  getAuthHeader(): string {\n+┊  ┊14┊    return localStorage.getItem('Authorization');\n+┊  ┊15┊  }\n+┊  ┊16┊\n+┊  ┊17┊  storeUser(user: User) {\n+┊  ┊18┊    localStorage.setItem('user', JSON.stringify(user));\n+┊  ┊19┊  }\n+┊  ┊20┊\n+┊  ┊21┊  getUser(): User {\n+┊  ┊22┊    return JSON.parse(localStorage.getItem('user'));\n+┊  ┊23┊  }\n+┊  ┊24┊}\n```\n\n[}]: #\n\nNow it's time to create a `SignIn`/`SignUp` component. Since we use Passport in the server we are going to make REST calls for the authentication, instead of using GraphQL.\nSince we use `Basic Auth` we will simply combine the username and the password together to create the authentication header.\nWe will also store the response from the server, which will contain the user information like the ID, etc. which we are going to need later.\n\nFirst we we will download a WhatsApp picture that will be used in the login component:\n\n    $ wget https://user-images.githubusercontent.com/7648874/49260078-e7f96680-f476-11e8-8711-06bc6490858a.png -P src/assets\n\nAnd then we will proceed to creating the component itself and everything around it:\n\n[{]: <helper> (diffStep \"10.1\" files=\"src/app/login/containers, src/app/login/login.module.ts\" module=\"client\")\n\n#### [Step 10.1: Authentication](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/34faf60)\n\n##### Added src&#x2F;app&#x2F;login&#x2F;containers&#x2F;login.component.scss\n```diff\n@@ -0,0 +1,18 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊}\n+┊  ┊ 4┊\n+┊  ┊ 5┊form:first-of-type {\n+┊  ┊ 6┊  margin-top: 24px;\n+┊  ┊ 7┊  margin-bottom: 48px;\n+┊  ┊ 8┊}\n+┊  ┊ 9┊\n+┊  ┊10┊label {\n+┊  ┊11┊  display: block;\n+┊  ┊12┊  margin-top: 4px;\n+┊  ┊13┊  margin-bottom: 4px;\n+┊  ┊14┊}\n+┊  ┊15┊\n+┊  ┊16┊.error {\n+┊  ┊17┊  color: red;\n+┊  ┊18┊}\n```\n\n##### Added src&#x2F;app&#x2F;login&#x2F;containers&#x2F;login.component.ts\n```diff\n@@ -0,0 +1,133 @@\n+┊   ┊  1┊import {Component} from '@angular/core';\n+┊   ┊  2┊import {HttpClient} from '@angular/common/http';\n+┊   ┊  3┊import {FormBuilder, Validators} from '@angular/forms';\n+┊   ┊  4┊// import {matchOtherValidator} from '@moebius/ng-validators';\n+┊   ┊  5┊import {Router} from '@angular/router';\n+┊   ┊  6┊import {User} from '../../../graphql';\n+┊   ┊  7┊import {LoginService} from '../services/login.service';\n+┊   ┊  8┊\n+┊   ┊  9┊@Component({\n+┊   ┊ 10┊  selector: 'app-login',\n+┊   ┊ 11┊  template: `\n+┊   ┊ 12┊    <form (ngSubmit)=\"signIn()\" [formGroup]=\"signInForm\" novalidate>\n+┊   ┊ 13┊      <fieldset fxLayout=\"column\" fxLayoutGap=\"17px\">\n+┊   ┊ 14┊        <legend>Sign in</legend>\n+┊   ┊ 15┊        <div>\n+┊   ┊ 16┊          <label>Username</label>\n+┊   ┊ 17┊          <input formControlName=\"username\" autocomplete=\"username\" type=\"text\">\n+┊   ┊ 18┊        </div>\n+┊   ┊ 19┊        <div class=\"error\" *ngIf=\"signInForm.get('username').hasError('required') && signInForm.get('username').touched\">\n+┊   ┊ 20┊          Username is required\n+┊   ┊ 21┊        </div>\n+┊   ┊ 22┊\n+┊   ┊ 23┊        <div>\n+┊   ┊ 24┊          <label>Password</label>\n+┊   ┊ 25┊          <input formControlName=\"password\" autocomplete=\"current-password\" type=\"password\">\n+┊   ┊ 26┊        </div>\n+┊   ┊ 27┊        <div class=\"error\" *ngIf=\"signInForm.get('password').hasError('required') && signInForm.get('password').touched\">\n+┊   ┊ 28┊          Password is required\n+┊   ┊ 29┊        </div>\n+┊   ┊ 30┊\n+┊   ┊ 31┊        <button type=\"submit\" [disabled]=\"signInForm.invalid\">Sign in</button>\n+┊   ┊ 32┊      </fieldset>\n+┊   ┊ 33┊    </form>\n+┊   ┊ 34┊\n+┊   ┊ 35┊    <form (ngSubmit)=\"signUp()\" [formGroup]=\"signUpForm\" novalidate>\n+┊   ┊ 36┊      <fieldset fxLayout=\"column\" fxLayoutGap=\"17px\">\n+┊   ┊ 37┊        <legend>Sign up</legend>\n+┊   ┊ 38┊        <div>\n+┊   ┊ 39┊          <label>Name</label>\n+┊   ┊ 40┊          <input formControlName=\"name\" type=\"text\">\n+┊   ┊ 41┊        </div>\n+┊   ┊ 42┊\n+┊   ┊ 43┊        <div>\n+┊   ┊ 44┊          <label>Username</label>\n+┊   ┊ 45┊          <input formControlName=\"username\" autocomplete=\"username\" type=\"text\">\n+┊   ┊ 46┊        </div>\n+┊   ┊ 47┊        <div class=\"error\" *ngIf=\"signUpForm.get('username').hasError('required') && signUpForm.get('username').touched\">\n+┊   ┊ 48┊          Username is required\n+┊   ┊ 49┊        </div>\n+┊   ┊ 50┊\n+┊   ┊ 51┊        <div>\n+┊   ┊ 52┊          <label>Password</label>\n+┊   ┊ 53┊          <input formControlName=\"newPassword\" autocomplete=\"new-password\" type=\"password\">\n+┊   ┊ 54┊        </div>\n+┊   ┊ 55┊        <div class=\"error\" *ngIf=\"signUpForm.get('newPassword').hasError('required') && signUpForm.get('newPassword').touched\">\n+┊   ┊ 56┊          Password is required\n+┊   ┊ 57┊        </div>\n+┊   ┊ 58┊\n+┊   ┊ 59┊        <div>\n+┊   ┊ 60┊          <label>Password</label>\n+┊   ┊ 61┊          <input formControlName=\"confirmPassword\" type=\"password\">\n+┊   ┊ 62┊        </div>\n+┊   ┊ 63┊        <div class=\"error\" *ngIf=\"signUpForm.get('confirmPassword').hasError('required') && signUpForm.get('confirmPassword').touched\">\n+┊   ┊ 64┊          Passwords must match\n+┊   ┊ 65┊        </div>\n+┊   ┊ 66┊\n+┊   ┊ 67┊        <button type=\"submit\" [disabled]=\"signUpForm.invalid\">Sign up</button>\n+┊   ┊ 68┊      </fieldset>\n+┊   ┊ 69┊    </form>\n+┊   ┊ 70┊  `,\n+┊   ┊ 71┊  styleUrls: ['./login.component.scss'],\n+┊   ┊ 72┊})\n+┊   ┊ 73┊export class LoginComponent {\n+┊   ┊ 74┊  signInForm = this.fb.group({\n+┊   ┊ 75┊    username: [null, [\n+┊   ┊ 76┊      Validators.required,\n+┊   ┊ 77┊    ]],\n+┊   ┊ 78┊    password: [null, [\n+┊   ┊ 79┊      Validators.required,\n+┊   ┊ 80┊    ]],\n+┊   ┊ 81┊  });\n+┊   ┊ 82┊\n+┊   ┊ 83┊  signUpForm = this.fb.group({\n+┊   ┊ 84┊    name: [null, [\n+┊   ┊ 85┊      Validators.required,\n+┊   ┊ 86┊    ]],\n+┊   ┊ 87┊    username: [null, [\n+┊   ┊ 88┊      Validators.required,\n+┊   ┊ 89┊    ]],\n+┊   ┊ 90┊    newPassword: [null, [\n+┊   ┊ 91┊      Validators.required,\n+┊   ┊ 92┊    ]],\n+┊   ┊ 93┊    confirmPassword: [null, [\n+┊   ┊ 94┊      Validators.required,\n+┊   ┊ 95┊      // matchOtherValidator('newPassword'),\n+┊   ┊ 96┊    ]],\n+┊   ┊ 97┊  });\n+┊   ┊ 98┊\n+┊   ┊ 99┊  constructor(private http: HttpClient,\n+┊   ┊100┊              private fb: FormBuilder,\n+┊   ┊101┊              private router: Router,\n+┊   ┊102┊              private loginService: LoginService) {}\n+┊   ┊103┊\n+┊   ┊104┊  signIn() {\n+┊   ┊105┊    const {username, password} = this.signInForm.value;\n+┊   ┊106┊    const auth = `Basic ${btoa(`${username}:${password}`)}`;\n+┊   ┊107┊    this.http.post('http://localhost:3000/signin', null, {\n+┊   ┊108┊      headers: {\n+┊   ┊109┊        Authorization: auth,\n+┊   ┊110┊      }\n+┊   ┊111┊    }).subscribe((user: User) => {\n+┊   ┊112┊      this.loginService.storeAuthHeader(auth);\n+┊   ┊113┊      this.loginService.storeUser(user);\n+┊   ┊114┊      this.router.navigate(['/chats']);\n+┊   ┊115┊    }, err => console.error(err));\n+┊   ┊116┊  }\n+┊   ┊117┊\n+┊   ┊118┊  signUp() {\n+┊   ┊119┊    const {username, newPassword: password, name} = this.signInForm.value;\n+┊   ┊120┊    const auth = `Basic ${btoa(`${username}:${password}`)}`;\n+┊   ┊121┊    this.http.post('http://localhost:3000/signup', {\n+┊   ┊122┊      name,\n+┊   ┊123┊    }, {\n+┊   ┊124┊      headers: {\n+┊   ┊125┊        Authorization: auth,\n+┊   ┊126┊      }\n+┊   ┊127┊    }).subscribe((user: User) => {\n+┊   ┊128┊      this.loginService.storeAuthHeader(auth);\n+┊   ┊129┊      this.loginService.storeUser(user);\n+┊   ┊130┊      this.router.navigate(['/chats']);\n+┊   ┊131┊    }, err => console.error(err));\n+┊   ┊132┊  }\n+┊   ┊133┊}\n```\n\n##### Added src&#x2F;app&#x2F;login&#x2F;login.module.ts\n```diff\n@@ -0,0 +1,52 @@\n+┊  ┊ 1┊import {RouterModule, Routes} from '@angular/router';\n+┊  ┊ 2┊import {NgModule} from '@angular/core';\n+┊  ┊ 3┊import {TruncateModule} from 'ng2-truncate';\n+┊  ┊ 4┊import {MatButtonModule, MatIconModule, MatListModule, MatMenuModule} from '@angular/material';\n+┊  ┊ 5┊import {SharedModule} from '../shared/shared.module';\n+┊  ┊ 6┊import {BrowserModule} from '@angular/platform-browser';\n+┊  ┊ 7┊import {FormsModule, ReactiveFormsModule} from '@angular/forms';\n+┊  ┊ 8┊import {BrowserAnimationsModule} from '@angular/platform-browser/animations';\n+┊  ┊ 9┊import {LoginComponent} from './containers/login.component';\n+┊  ┊10┊import {FlexLayoutModule} from '@angular/flex-layout';\n+┊  ┊11┊import {AuthInterceptor} from './services/auth.interceptor';\n+┊  ┊12┊import {AuthGuard} from './services/auth.guard';\n+┊  ┊13┊import {LoginService} from './services/login.service';\n+┊  ┊14┊\n+┊  ┊15┊\n+┊  ┊16┊const routes: Routes = [\n+┊  ┊17┊  {path: 'login', component: LoginComponent},\n+┊  ┊18┊];\n+┊  ┊19┊\n+┊  ┊20┊@NgModule({\n+┊  ┊21┊  declarations: [\n+┊  ┊22┊    LoginComponent,\n+┊  ┊23┊  ],\n+┊  ┊24┊  imports: [\n+┊  ┊25┊    BrowserModule,\n+┊  ┊26┊    // Material\n+┊  ┊27┊    MatMenuModule,\n+┊  ┊28┊    MatIconModule,\n+┊  ┊29┊    MatButtonModule,\n+┊  ┊30┊    MatListModule,\n+┊  ┊31┊    // Animations\n+┊  ┊32┊    BrowserAnimationsModule,\n+┊  ┊33┊    // Flex layout\n+┊  ┊34┊    FlexLayoutModule,\n+┊  ┊35┊    // Routing\n+┊  ┊36┊    RouterModule.forChild(routes),\n+┊  ┊37┊    // Forms\n+┊  ┊38┊    FormsModule,\n+┊  ┊39┊    ReactiveFormsModule,\n+┊  ┊40┊    // Truncate Pipe\n+┊  ┊41┊    TruncateModule,\n+┊  ┊42┊    // Feature modules\n+┊  ┊43┊    SharedModule,\n+┊  ┊44┊  ],\n+┊  ┊45┊  providers: [\n+┊  ┊46┊    LoginService,\n+┊  ┊47┊    AuthInterceptor,\n+┊  ┊48┊    AuthGuard,\n+┊  ┊49┊  ],\n+┊  ┊50┊})\n+┊  ┊51┊export class LoginModule {\n+┊  ┊52┊}\n```\n\n[}]: #\n\nNow it's time use the Interceptor we just created:\n\n[{]: <helper> (diffStep \"10.1\" files=\"src/app/app.module.ts\" module=\"client\")\n\n#### [Step 10.1: Authentication](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/34faf60)\n\n##### Changed src&#x2F;app&#x2F;app.module.ts\n```diff\n@@ -2,12 +2,14 @@\n ┊ 2┊ 2┊import { NgModule } from '@angular/core';\n ┊ 3┊ 3┊\n ┊ 4┊ 4┊import { AppComponent } from './app.component';\n-┊ 5┊  ┊import { HttpClientModule } from '@angular/common/http';\n+┊  ┊ 5┊import { HttpClientModule, HTTP_INTERCEPTORS } from '@angular/common/http';\n ┊ 6┊ 6┊import { GraphQLModule } from './graphql.module';\n ┊ 7┊ 7┊import {ChatsListerModule} from './chats-lister/chats-lister.module';\n ┊ 8┊ 8┊import {RouterModule, Routes} from '@angular/router';\n ┊ 9┊ 9┊import {ChatViewerModule} from './chat-viewer/chat-viewer.module';\n ┊10┊10┊import {ChatsCreationModule} from './chats-creation/chats-creation.module';\n+┊  ┊11┊import {LoginModule} from './login/login.module';\n+┊  ┊12┊import {AuthInterceptor} from './login/services/auth.interceptor';\n ┊11┊13┊const routes: Routes = [];\n ┊12┊14┊\n ┊13┊15┊@NgModule({\n```\n```diff\n@@ -24,8 +26,15 @@\n ┊24┊26┊    ChatsListerModule,\n ┊25┊27┊    ChatViewerModule,\n ┊26┊28┊    ChatsCreationModule,\n+┊  ┊29┊    LoginModule,\n+┊  ┊30┊  ],\n+┊  ┊31┊  providers: [\n+┊  ┊32┊    {\n+┊  ┊33┊      provide: HTTP_INTERCEPTORS,\n+┊  ┊34┊      useClass: AuthInterceptor,\n+┊  ┊35┊      multi: true,\n+┊  ┊36┊    },\n ┊27┊37┊  ],\n-┊28┊  ┊  providers: [],\n ┊29┊38┊  bootstrap: [AppComponent]\n ┊30┊39┊})\n ┊31┊40┊export class AppModule {}\n```\n\n[}]: #\n\nAs well as the `AuthGuard`:\n\n[{]: <helper> (diffStep \"10.1\" files=\"src/app/chat-viewer/chat-viewer.module.ts, src/app/chats-creation/chats-creation.module.ts, src/app/chats-lister/chats-lister.module.ts\" module=\"client\")\n\n#### [Step 10.1: Authentication](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/34faf60)\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;chat-viewer.module.ts\n```diff\n@@ -12,11 +12,12 @@\n ┊12┊12┊import {NewMessageComponent} from './components/new-message/new-message.component';\n ┊13┊13┊import {SharedModule} from '../shared/shared.module';\n ┊14┊14┊import {NgxSelectableListModule} from 'ngx-selectable-list';\n+┊  ┊15┊import {AuthGuard} from '../login/services/auth.guard';\n ┊15┊16┊\n ┊16┊17┊const routes: Routes = [\n ┊17┊18┊  {\n ┊18┊19┊    path: 'chat', children: [\n-┊19┊  ┊      {path: ':id', component: ChatComponent},\n+┊  ┊20┊      {path: ':id', canActivate: [AuthGuard], component: ChatComponent},\n ┊20┊21┊    ],\n ┊21┊22┊  },\n ┊22┊23┊];\n```\n\n##### Changed src&#x2F;app&#x2F;chats-creation&#x2F;chats-creation.module.ts\n```diff\n@@ -16,10 +16,11 @@\n ┊16┊16┊import {NewGroupDetailsComponent} from './components/new-group-details/new-group-details.component';\n ┊17┊17┊import {SharedModule} from '../shared/shared.module';\n ┊18┊18┊import {NgxSelectableListModule} from 'ngx-selectable-list';\n+┊  ┊19┊import {AuthGuard} from '../login/services/auth.guard';\n ┊19┊20┊\n ┊20┊21┊const routes: Routes = [\n-┊21┊  ┊  {path: 'new-chat', component: NewChatComponent},\n-┊22┊  ┊  {path: 'new-group', component: NewGroupComponent},\n+┊  ┊22┊  {path: 'new-chat', canActivate: [AuthGuard], component: NewChatComponent},\n+┊  ┊23┊  {path: 'new-group', canActivate: [AuthGuard], component: NewGroupComponent},\n ┊23┊24┊];\n ┊24┊25┊\n ┊25┊26┊@NgModule({\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;chats-lister.module.ts\n```diff\n@@ -12,10 +12,11 @@\n ┊12┊12┊import {TruncateModule} from 'ng2-truncate';\n ┊13┊13┊import {SharedModule} from '../shared/shared.module';\n ┊14┊14┊import {NgxSelectableListModule} from 'ngx-selectable-list';\n+┊  ┊15┊import {AuthGuard} from '../login/services/auth.guard';\n ┊15┊16┊\n ┊16┊17┊const routes: Routes = [\n ┊17┊18┊  {path: '', redirectTo: 'chats', pathMatch: 'full'},\n-┊18┊  ┊  {path: 'chats', component: ChatsComponent},\n+┊  ┊19┊  {path: 'chats', canActivate: [AuthGuard], component: ChatsComponent},\n ┊19┊20┊];\n ┊20┊21┊\n ┊21┊22┊@NgModule({\n```\n\n[}]: #\n\nLast but not the least we need to fix our main service in order to not use the hardcoded user anymore. Instead we will use our Login service to read the user info from the `LocalStorage`.\n\n[{]: <helper> (diffStep \"10.1\" files=\"src/app/services/chats.service.ts\" module=\"client\")\n\n#### [Step 10.1: Authentication](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/34faf60)\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -24,6 +24,7 @@\n ┊24┊24┊} from '../../graphql';\n ┊25┊25┊import { DataProxy } from 'apollo-cache';\n ┊26┊26┊import { FetchResult } from 'apollo-link';\n+┊  ┊27┊import {LoginService} from '../login/services/login.service';\n ┊27┊28┊\n ┊28┊29┊const currentUserId = '1';\n ┊29┊30┊const currentUserName = 'Ethan Gonzalez';\n```\n```diff\n@@ -46,7 +47,8 @@\n ┊46┊47┊    private removeAllMessagesGQL: RemoveAllMessagesGQL,\n ┊47┊48┊    private getUsersGQL: GetUsersGQL,\n ┊48┊49┊    private addChatGQL: AddChatGQL,\n-┊49┊  ┊    private addGroupGQL: AddGroupGQL\n+┊  ┊50┊    private addGroupGQL: AddGroupGQL,\n+┊  ┊51┊    private loginService: LoginService\n ┊50┊52┊  ) {\n ┊51┊53┊    this.getChatsWq = this.getChatsGQL.watch({\n ┊52┊54┊      amount: this.messagesAmount,\n```\n```diff\n@@ -128,11 +130,11 @@\n ┊128┊130┊        addMessage: {\n ┊129┊131┊          id: ChatsService.getRandomId(),\n ┊130┊132┊          __typename: 'Message',\n-┊131┊   ┊          senderId: currentUserId,\n+┊   ┊133┊          senderId: this.loginService.getUser().id,\n ┊132┊134┊          sender: {\n-┊133┊   ┊            id: currentUserId,\n+┊   ┊135┊            id: this.loginService.getUser().id,\n ┊134┊136┊            __typename: 'User',\n-┊135┊   ┊            name: currentUserName,\n+┊   ┊137┊            name: this.loginService.getUser().name,\n ┊136┊138┊          },\n ┊137┊139┊          content,\n ┊138┊140┊          createdAt: moment().unix(),\n```\n```diff\n@@ -315,7 +317,7 @@\n ┊315┊317┊  // Checks if the chat is listed for the current user and returns the id\n ┊316┊318┊  getChatId(recipientId: string) {\n ┊317┊319┊    const _chat = this.chats.find(chat => {\n-┊318┊   ┊      return !chat.isGroup && !!chat.allTimeMembers.find(user => user.id === currentUserId) &&\n+┊   ┊320┊      return !chat.isGroup && !!chat.allTimeMembers.find(user => user.id === this.loginService.getUser().id) &&\n ┊319┊321┊        !!chat.allTimeMembers.find(user => user.id === recipientId);\n ┊320┊322┊    });\n ┊321┊323┊    return _chat ? _chat.id : false;\n```\n```diff\n@@ -335,7 +337,7 @@\n ┊335┊337┊            picture: users.find(user => user.id === recipientId).picture,\n ┊336┊338┊            allTimeMembers: [\n ┊337┊339┊              {\n-┊338┊   ┊                id: currentUserId,\n+┊   ┊340┊                id: this.loginService.getUser().id,\n ┊339┊341┊                __typename: 'User',\n ┊340┊342┊              },\n ┊341┊343┊              {\n```\n```diff\n@@ -387,10 +389,10 @@\n ┊387┊389┊            __typename: 'Chat',\n ┊388┊390┊            name: groupName,\n ┊389┊391┊            picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n-┊390┊   ┊            userIds: [currentUserId, recipientIds],\n+┊   ┊392┊            userIds: [this.loginService.getUser().id, recipientIds],\n ┊391┊393┊            allTimeMembers: [\n ┊392┊394┊              {\n-┊393┊   ┊                id: currentUserId,\n+┊   ┊395┊                id: this.loginService.getUser().id,\n ┊394┊396┊                __typename: 'User',\n ┊395┊397┊              },\n ┊396┊398┊              ...recipientIds.map(id => ({id, __typename: 'User'})),\n```\n\n[}]: #\n\nWe also need to fix our tests:\n\n[{]: <helper> (diffStep \"10.1\" files=\"src/app/chat-viewer/containers/chat/chat.component.spec.ts, src/app/chats-lister/containers/chats/chats.component.spec.ts, src/app/services/chats.service.spec.ts\" module=\"client\")\n\n#### [Step 10.1: Authentication](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/34faf60)\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.spec.ts\n```diff\n@@ -29,6 +29,7 @@\n ┊29┊29┊import { NewMessageComponent } from '../../components/new-message/new-message.component';\n ┊30┊30┊import { MessagesListComponent } from '../../components/messages-list/messages-list.component';\n ┊31┊31┊import { MessageItemComponent } from '../../components/message-item/message-item.component';\n+┊  ┊32┊import { LoginService } from '../../../login/services/login.service';\n ┊32┊33┊\n ┊33┊34┊describe('ChatComponent', () => {\n ┊34┊35┊  let component: ChatComponent;\n```\n```diff\n@@ -134,6 +135,7 @@\n ┊134┊135┊            queryParams: of({}),\n ┊135┊136┊          },\n ┊136┊137┊        },\n+┊   ┊138┊        LoginService,\n ┊137┊139┊      ],\n ┊138┊140┊      schemas: [NO_ERRORS_SCHEMA],\n ┊139┊141┊    }).compileComponents();\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.spec.ts\n```diff\n@@ -24,6 +24,7 @@\n ┊24┊24┊import { ChatsListComponent } from '../../components/chats-list/chats-list.component';\n ┊25┊25┊import { ChatItemComponent } from '../../components/chat-item/chat-item.component';\n ┊26┊26┊import { ChatsService } from '../../../services/chats.service';\n+┊  ┊27┊import { LoginService } from '../../../login/services/login.service';\n ┊27┊28┊\n ┊28┊29┊describe('ChatsComponent', () => {\n ┊29┊30┊  let component: ChatsComponent;\n```\n```diff\n@@ -345,6 +346,7 @@\n ┊345┊346┊            return new InMemoryCache({ dataIdFromObject });\n ┊346┊347┊          },\n ┊347┊348┊        },\n+┊   ┊349┊        LoginService,\n ┊348┊350┊      ],\n ┊349┊351┊      schemas: [NO_ERRORS_SCHEMA],\n ┊350┊352┊    }).compileComponents();\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.spec.ts\n```diff\n@@ -11,6 +11,7 @@\n ┊11┊11┊import { GetChats } from '../../graphql';\n ┊12┊12┊import { dataIdFromObject } from '../graphql.module';\n ┊13┊13┊import { ChatsService } from './chats.service';\n+┊  ┊14┊import {LoginService} from '../login/services/login.service';\n ┊14┊15┊\n ┊15┊16┊describe('ChatsService', () => {\n ┊16┊17┊  let controller: ApolloTestingController;\n```\n```diff\n@@ -312,6 +313,7 @@\n ┊312┊313┊      imports: [ApolloTestingModule],\n ┊313┊314┊      providers: [\n ┊314┊315┊        ChatsService,\n+┊   ┊316┊        LoginService,\n ┊315┊317┊        {\n ┊316┊318┊          provide: APOLLO_TESTING_CACHE,\n ┊317┊319┊          useFactory() {\n```\n\n[}]: #\n\n\n### GraphQL Server behind a firewall\n\nThere's still one thing remaining. Our GraphQL Code Generator setup is broken now. That's because every made request to the server has to have proper rights and currently the codegen's request introspection query is not authenticated. In short, we need to attach an `Authorization` header.\n\nWe're going to implement the following scenario:\n\n1. User runs `yarn generator`\n1. He is asked for a _username_ and a _password_\n1. Our script generates an _Authorization_ header\n1. GraphQL Code Generator get the GraphQL Schema of our server and outputs the types\n\nTo achieve the goal, we need to change the way we interact with the codegen.\nRight now we use GraphQL Code Generator's CLI but the tool allows to use it programatically. So one issue solved.\n\nWhat about getting user's name and password part? We will use in-terminal prompt so user can type those. There's a package for that:\n\n    yarn add -D prompt\n\nNext, create a `src/codegen.ts` file and write our script there:\n\n[{]: <helper> (diffStep \"10.1\" files=\"src/codegen.ts\" module=\"client\")\n\n#### [Step 10.1: Authentication](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/34faf60)\n\n##### Added src&#x2F;codegen.ts\n```diff\n@@ -0,0 +1,46 @@\n+┊  ┊ 1┊import * as prompt from 'prompt';\n+┊  ┊ 2┊import { generate } from 'graphql-code-generator';\n+┊  ┊ 3┊\n+┊  ┊ 4┊interface Credentials {\n+┊  ┊ 5┊  username: string;\n+┊  ┊ 6┊  password: string;\n+┊  ┊ 7┊}\n+┊  ┊ 8┊\n+┊  ┊ 9┊async function getCredentials(): Promise<Credentials> {\n+┊  ┊10┊  return new Promise<Credentials>(resolve => {\n+┊  ┊11┊    prompt.start();\n+┊  ┊12┊    prompt.get(['username', 'password'], (_err, result) => {\n+┊  ┊13┊      resolve({\n+┊  ┊14┊        username: result.username,\n+┊  ┊15┊        password: result.password,\n+┊  ┊16┊      });\n+┊  ┊17┊    });\n+┊  ┊18┊  });\n+┊  ┊19┊}\n+┊  ┊20┊\n+┊  ┊21┊function generateHeaders({ username, password }: Credentials): string[] {\n+┊  ┊22┊  const Authorization = `Basic ${Buffer.from(\n+┊  ┊23┊    `${username}:${password}`,\n+┊  ┊24┊  ).toString('base64')}`;\n+┊  ┊25┊\n+┊  ┊26┊  return [`Authorization: ${Authorization}`];\n+┊  ┊27┊}\n+┊  ┊28┊\n+┊  ┊29┊async function main() {\n+┊  ┊30┊  const credentials = await getCredentials();\n+┊  ┊31┊  const headers = generateHeaders(credentials);\n+┊  ┊32┊\n+┊  ┊33┊  await generate(\n+┊  ┊34┊    {\n+┊  ┊35┊      schema: 'http://localhost:3000/graphql',\n+┊  ┊36┊      template: 'graphql-codegen-apollo-angular-template',\n+┊  ┊37┊      out: './src/graphql.ts',\n+┊  ┊38┊      args: ['./src/graphql/**/*.ts'],\n+┊  ┊39┊      header: headers,\n+┊  ┊40┊      overwrite: true,\n+┊  ┊41┊    },\n+┊  ┊42┊    true,\n+┊  ┊43┊  );\n+┊  ┊44┊}\n+┊  ┊45┊\n+┊  ┊46┊main();\n```\n\n[}]: #\n\nLet's take a closer look what we did there:\n\n- We asks user for a _username_ and a _password_ with `prompt`\n- Based on that we generate a header\n- We put the header in `generate` function\n- there's a `true` value as the second argument, it tells codegen to write the output to a file\n\nWith all of that, whenever we run `yarn generator`, we access the GraphQL server as an authenticated user."
          },
          {
            "manualTitle": "Step 15: Subscriptions",
            "stepRevision": "4468c9c93fec39b398667d2eed81c40e4ae89eb7",
            "manualView": "## Server\n\nIn order to use WebSockets we don't need to install any package, it comes for free with Apollo Server 2.0.\n\nOur GraphQL server will use WebSockets only for subscriptions, while using HTTP for everything else. That means that we will have to add subscriptions on a specific path.\nWe're using `connectionParams` for the authentication over WebSockets, that means that we won't be using the `Passport` framework at all. Instead we will use the `onConnect` hook to manually validate the parameters provided by the user to either validate the WebSocket connection or throw an error.\nWe will also return the user object we retrieved from the db, to let the resolvers know who is the current user.\n\n[{]: <helper> (diffStep \"5.1\" files=\"index.ts\" module=\"server\")\n\n#### [Step 5.1: Subscriptions](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/729c8f0)\n\n##### Changed index.ts\n```diff\n@@ -7,9 +7,12 @@\n ┊ 7┊ 7┊import * as basicStrategy from 'passport-http';\n ┊ 8┊ 8┊import * as bcrypt from 'bcrypt-nodejs';\n ┊ 9┊ 9┊import { db, User } from \"./db\";\n+┊  ┊10┊import { createServer } from \"http\";\n ┊10┊11┊\n ┊11┊12┊let users = db.users;\n ┊12┊13┊\n+┊  ┊14┊console.log(users);\n+┊  ┊15┊\n ┊13┊16┊function generateHash(password: string) {\n ┊14┊17┊  return bcrypt.hashSync(password, bcrypt.genSaltSync(8));\n ┊15┊18┊}\n```\n```diff\n@@ -69,9 +72,30 @@\n ┊ 69┊ 72┊  schema,\n ┊ 70┊ 73┊  context(received: any) {\n ┊ 71┊ 74┊    return {\n-┊ 72┊   ┊      user: received.req!['user'],\n+┊   ┊ 75┊      user: received.connection ? received.connection.context.user : received.req!['user'],\n ┊ 73┊ 76┊    }\n ┊ 74┊ 77┊  },\n+┊   ┊ 78┊  subscriptions: {\n+┊   ┊ 79┊    onConnect: (connectionParams: any, webSocket: any) => {\n+┊   ┊ 80┊      if (connectionParams.authToken) {\n+┊   ┊ 81┊        // create a buffer and tell it the data coming in is base64\n+┊   ┊ 82┊        const buf = new Buffer(connectionParams.authToken.split(' ')[1], 'base64');\n+┊   ┊ 83┊        // read it back out as a string\n+┊   ┊ 84┊        const [username, password]: string[] = buf.toString().split(':');\n+┊   ┊ 85┊        if (username && password) {\n+┊   ┊ 86┊          const user = users.find(user => user.username == username);\n+┊   ┊ 87┊\n+┊   ┊ 88┊          if (user && validPassword(password, user.password)) {\n+┊   ┊ 89┊            // Set context for the WebSocket\n+┊   ┊ 90┊            return {user};\n+┊   ┊ 91┊          } else {\n+┊   ┊ 92┊            throw new Error('Wrong credentials!');\n+┊   ┊ 93┊          }\n+┊   ┊ 94┊        }\n+┊   ┊ 95┊      }\n+┊   ┊ 96┊      throw new Error('Missing auth token!');\n+┊   ┊ 97┊    }\n+┊   ┊ 98┊  }\n ┊ 75┊ 99┊});\n ┊ 76┊100┊\n ┊ 77┊101┊apollo.applyMiddleware({\n```\n```diff\n@@ -79,4 +103,11 @@\n ┊ 79┊103┊  path: '/graphql'\n ┊ 80┊104┊});\n ┊ 81┊105┊\n-┊ 82┊   ┊app.listen(PORT);\n+┊   ┊106┊// Wrap the Express server\n+┊   ┊107┊const ws = createServer(app);\n+┊   ┊108┊\n+┊   ┊109┊apollo.installSubscriptionHandlers(ws);\n+┊   ┊110┊\n+┊   ┊111┊ws.listen(PORT, () => {\n+┊   ┊112┊  console.log(`Apollo Server is now running on http://localhost:${PORT}`);\n+┊   ┊113┊});\n```\n\n[}]: #\n\nWe will use the `PubSub` implementation from `apollo-server-express`, and publish the data using with Apollo Server.\n\nThe process of setting up a GraphQL subscriptions server consist of the following steps:\n\n1. Declaring subscriptions in the GraphQL schema\n2. Setup a PubSub instance that our server will publish new events to\n3. Hook together `PubSub` event and GraphQL subscription.\n4. Setting up `ApolloServer`\n\n[{]: <helper> (diffStep \"5.1\" files=\"schema/typeDefs.ts\" module=\"server\")\n\n#### [Step 5.1: Subscriptions](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/729c8f0)\n\n##### Changed schema&#x2F;typeDefs.ts\n```diff\n@@ -5,6 +5,11 @@\n ┊ 5┊ 5┊    chat(chatId: ID!): Chat\n ┊ 6┊ 6┊  }\n ┊ 7┊ 7┊\n+┊  ┊ 8┊  type Subscription {\n+┊  ┊ 9┊    messageAdded(chatId: ID): Message\n+┊  ┊10┊    chatAdded: Chat\n+┊  ┊11┊  }\n+┊  ┊12┊\n ┊ 8┊13┊  enum MessageType {\n ┊ 9┊14┊    LOCATION\n ┊10┊15┊    TEXT\n```\n\n[}]: #\n\nWe created two subscriptions: one to notify for new chats and one to notify for new messages.\n\n[{]: <helper> (diffStep \"5.1\" files=\"schema/resolvers.ts\" module=\"server\")\n\n#### [Step 5.1: Subscriptions](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/729c8f0)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,7 +1,7 @@\n-┊1┊ ┊import { IResolvers } from 'apollo-server-express';\n+┊ ┊1┊import { PubSub, withFilter, IResolvers } from 'apollo-server-express';\n ┊2┊2┊import { Chat, db, Message, MessageType, Recipient, User } from \"../db\";\n ┊3┊3┊import {\n-┊4┊ ┊  AddChatMutationArgs, AddGroupMutationArgs, AddMessageMutationArgs, ChatQueryArgs,\n+┊ ┊4┊  AddChatMutationArgs, AddGroupMutationArgs, AddMessageMutationArgs, ChatQueryArgs, MessageAddedSubscriptionArgs,\n ┊5┊5┊  RemoveChatMutationArgs, RemoveMessagesMutationArgs\n ┊6┊6┊} from \"../types\";\n ┊7┊7┊import * as moment from \"moment\";\n```\n```diff\n@@ -9,6 +9,8 @@\n ┊ 9┊ 9┊let users = db.users;\n ┊10┊10┊let chats = db.chats;\n ┊11┊11┊\n+┊  ┊12┊export const pubsub = new PubSub();\n+┊  ┊13┊\n ┊12┊14┊export const resolvers: IResolvers = {\n ┊13┊15┊  Query: {\n ┊14┊16┊    // Show all users for the moment.\n```\n```diff\n@@ -50,6 +52,7 @@\n ┊50┊52┊          messages: [],\n ┊51┊53┊        };\n ┊52┊54┊        chats.push(chat);\n+┊  ┊55┊\n ┊53┊56┊        return chat;\n ┊54┊57┊      }\n ┊55┊58┊    },\n```\n```diff\n@@ -73,6 +76,12 @@\n ┊73┊76┊        messages: [],\n ┊74┊77┊      };\n ┊75┊78┊      chats.push(chat);\n+┊  ┊79┊\n+┊  ┊80┊      pubsub.publish('chatAdded', {\n+┊  ┊81┊        creatorId: currentUser.id,\n+┊  ┊82┊        chatAdded: chat,\n+┊  ┊83┊      });\n+┊  ┊84┊\n ┊76┊85┊      return chat;\n ┊77┊86┊    },\n ┊78┊87┊    removeChat: (obj: any, {chatId}: RemoveChatMutationArgs, {user: currentUser}: {user: User}): number => {\n```\n```diff\n@@ -201,6 +210,11 @@\n ┊201┊210┊          });\n ┊202┊211┊\n ┊203┊212┊          holderIds = listingMemberIds;\n+┊   ┊213┊\n+┊   ┊214┊          pubsub.publish('chatAdded', {\n+┊   ┊215┊            creatorId: currentUser.id,\n+┊   ┊216┊            chatAdded: chat,\n+┊   ┊217┊          });\n ┊204┊218┊        }\n ┊205┊219┊      } else {\n ┊206┊220┊        // Group\n```\n```diff\n@@ -245,6 +259,10 @@\n ┊245┊259┊        return chat;\n ┊246┊260┊      });\n ┊247┊261┊\n+┊   ┊262┊      pubsub.publish('messageAdded', {\n+┊   ┊263┊        messageAdded: message,\n+┊   ┊264┊      });\n+┊   ┊265┊\n ┊248┊266┊      return message;\n ┊249┊267┊    },\n ┊250┊268┊    removeMessages: (obj: any, {chatId, messageIds, all}: RemoveMessagesMutationArgs, {user: currentUser}: {user: User}): number[] => {\n```\n```diff\n@@ -286,6 +304,21 @@\n ┊286┊304┊      return deletedIds;\n ┊287┊305┊    },\n ┊288┊306┊  },\n+┊   ┊307┊  Subscription: {\n+┊   ┊308┊    messageAdded: {\n+┊   ┊309┊      subscribe: withFilter(() => pubsub.asyncIterator('messageAdded'),\n+┊   ┊310┊        ({messageAdded}: {messageAdded: Message & {chat: {id: number}}}, {chatId}: MessageAddedSubscriptionArgs, {user: currentUser}: { user: User }) => {\n+┊   ┊311┊          return (!chatId || messageAdded.chat.id === Number(chatId)) &&\n+┊   ┊312┊            !!messageAdded.recipients.find((recipient: Recipient) => recipient.userId === currentUser.id);\n+┊   ┊313┊        }),\n+┊   ┊314┊    },\n+┊   ┊315┊    chatAdded: {\n+┊   ┊316┊      subscribe: withFilter(() => pubsub.asyncIterator('chatAdded'),\n+┊   ┊317┊        ({creatorId, chatAdded}: {creatorId: string, chatAdded: Chat}, variables: any, {user: currentUser}: { user: User }) => {\n+┊   ┊318┊          return Number(creatorId) !== currentUser.id && !chatAdded.listingMemberIds.includes(currentUser.id);\n+┊   ┊319┊        }),\n+┊   ┊320┊    }\n+┊   ┊321┊  },\n ┊289┊322┊  Chat: {\n ┊290┊323┊    name: (chat: Chat, args: any, {user: currentUser}: {user: User}): string => chat.name ? chat.name : users\n ┊291┊324┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser.id))!.name,\n```\n\n[}]: #\n\nWe will publish a message to the `messageAdded` subscription every time that a user sends a message, then we will filter them according to the current user (we don't want to send someone else's messages).\nThe `chatAdded` subscription is similar: we will publish each time that a group gets created, but not when chats get created. This is because when a user creates a chat the chat doesn't appear to the other peer until he writes the first message. That's why we also publish when new messages get added (we first look if the other peer already gets the chat listed).\n\n## Client\n\nIn order to use WebSockets we will need to install a couple of dependencies:\n\n    yarn add apollo-link-ws apollo-utilities subscriptions-transport-ws\n\nFirst let's create the queries for the GraphQL Subscriptions:\n\n[{]: <helper> (diffStep \"11.1\" files=\"src/graphql\" module=\"client\")\n\n#### [Step 11.1: Subscriptions](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/8219b49)\n\n##### Changed src&#x2F;graphql.ts\n```diff\n@@ -651,6 +651,22 @@\n ┊651┊651┊  export type AddMessage = Message.Fragment;\n ┊652┊652┊}\n ┊653┊653┊\n+┊   ┊654┊export namespace ChatAdded {\n+┊   ┊655┊  export type Variables = {};\n+┊   ┊656┊\n+┊   ┊657┊  export type Subscription = {\n+┊   ┊658┊    __typename?: \"Subscription\";\n+┊   ┊659┊    chatAdded?: ChatAdded | null;\n+┊   ┊660┊  };\n+┊   ┊661┊\n+┊   ┊662┊  export type ChatAdded = {\n+┊   ┊663┊    __typename?: \"Chat\";\n+┊   ┊664┊    messages: (Messages | null)[];\n+┊   ┊665┊  } & ChatWithoutMessages.Fragment;\n+┊   ┊666┊\n+┊   ┊667┊  export type Messages = Message.Fragment;\n+┊   ┊668┊}\n+┊   ┊669┊\n ┊654┊670┊export namespace GetChat {\n ┊655┊671┊  export type Variables = {\n ┊656┊672┊    chatId: string;\n```\n```diff\n@@ -703,6 +719,27 @@\n ┊703┊719┊  };\n ┊704┊720┊}\n ┊705┊721┊\n+┊   ┊722┊export namespace MessageAdded {\n+┊   ┊723┊  export type Variables = {\n+┊   ┊724┊    chatId?: string | null;\n+┊   ┊725┊  };\n+┊   ┊726┊\n+┊   ┊727┊  export type Subscription = {\n+┊   ┊728┊    __typename?: \"Subscription\";\n+┊   ┊729┊    messageAdded?: MessageAdded | null;\n+┊   ┊730┊  };\n+┊   ┊731┊\n+┊   ┊732┊  export type MessageAdded = {\n+┊   ┊733┊    __typename?: \"Message\";\n+┊   ┊734┊    chat: Chat;\n+┊   ┊735┊  } & Message.Fragment;\n+┊   ┊736┊\n+┊   ┊737┊  export type Chat = {\n+┊   ┊738┊    __typename?: \"Chat\";\n+┊   ┊739┊    id: string;\n+┊   ┊740┊  };\n+┊   ┊741┊}\n+┊   ┊742┊\n ┊706┊743┊export namespace RemoveAllMessages {\n ┊707┊744┊  export type Variables = {\n ┊708┊745┊    chatId: string;\n```\n```diff\n@@ -924,6 +961,27 @@\n ┊924┊961┊@Injectable({\n ┊925┊962┊  providedIn: \"root\"\n ┊926┊963┊})\n+┊   ┊964┊export class ChatAddedGQL extends Apollo.Subscription<\n+┊   ┊965┊  ChatAdded.Subscription,\n+┊   ┊966┊  ChatAdded.Variables\n+┊   ┊967┊> {\n+┊   ┊968┊  document: any = gql`\n+┊   ┊969┊    subscription chatAdded {\n+┊   ┊970┊      chatAdded {\n+┊   ┊971┊        ...ChatWithoutMessages\n+┊   ┊972┊        messages {\n+┊   ┊973┊          ...Message\n+┊   ┊974┊        }\n+┊   ┊975┊      }\n+┊   ┊976┊    }\n+┊   ┊977┊\n+┊   ┊978┊    ${ChatWithoutMessagesFragment}\n+┊   ┊979┊    ${MessageFragment}\n+┊   ┊980┊  `;\n+┊   ┊981┊}\n+┊   ┊982┊@Injectable({\n+┊   ┊983┊  providedIn: \"root\"\n+┊   ┊984┊})\n ┊927┊985┊export class GetChatGQL extends Apollo.Query<GetChat.Query, GetChat.Variables> {\n ┊928┊986┊  document: any = gql`\n ┊929┊987┊    query GetChat($chatId: ID!) {\n```\n```diff\n@@ -980,6 +1038,26 @@\n ┊ 980┊1038┊@Injectable({\n ┊ 981┊1039┊  providedIn: \"root\"\n ┊ 982┊1040┊})\n+┊    ┊1041┊export class MessageAddedGQL extends Apollo.Subscription<\n+┊    ┊1042┊  MessageAdded.Subscription,\n+┊    ┊1043┊  MessageAdded.Variables\n+┊    ┊1044┊> {\n+┊    ┊1045┊  document: any = gql`\n+┊    ┊1046┊    subscription messageAdded($chatId: ID) {\n+┊    ┊1047┊      messageAdded(chatId: $chatId) {\n+┊    ┊1048┊        ...Message\n+┊    ┊1049┊        chat {\n+┊    ┊1050┊          id\n+┊    ┊1051┊        }\n+┊    ┊1052┊      }\n+┊    ┊1053┊    }\n+┊    ┊1054┊\n+┊    ┊1055┊    ${MessageFragment}\n+┊    ┊1056┊  `;\n+┊    ┊1057┊}\n+┊    ┊1058┊@Injectable({\n+┊    ┊1059┊  providedIn: \"root\"\n+┊    ┊1060┊})\n ┊ 983┊1061┊export class RemoveAllMessagesGQL extends Apollo.Mutation<\n ┊ 984┊1062┊  RemoveAllMessages.Mutation,\n ┊ 985┊1063┊  RemoveAllMessages.Variables\n```\n\n##### Added src&#x2F;graphql&#x2F;chatAdded.subscription.ts\n```diff\n@@ -0,0 +1,17 @@\n+┊  ┊ 1┊import gql from 'graphql-tag';\n+┊  ┊ 2┊import {fragments} from './fragment';\n+┊  ┊ 3┊\n+┊  ┊ 4┊// We use the gql tag to parse our query string into a query document\n+┊  ┊ 5┊export const chatAddedSubscription = gql`\n+┊  ┊ 6┊  subscription chatAdded {\n+┊  ┊ 7┊    chatAdded {\n+┊  ┊ 8┊      ...ChatWithoutMessages\n+┊  ┊ 9┊      messages {\n+┊  ┊10┊        ...Message\n+┊  ┊11┊      }\n+┊  ┊12┊    }\n+┊  ┊13┊  }\n+┊  ┊14┊\n+┊  ┊15┊  ${fragments['chatWithoutMessages']}\n+┊  ┊16┊  ${fragments['message']}\n+┊  ┊17┊`;\n```\n\n##### Added src&#x2F;graphql&#x2F;messageAdded.subscription.ts\n```diff\n@@ -0,0 +1,16 @@\n+┊  ┊ 1┊import gql from 'graphql-tag';\n+┊  ┊ 2┊import {fragments} from './fragment';\n+┊  ┊ 3┊\n+┊  ┊ 4┊// We use the gql tag to parse our query string into a query document\n+┊  ┊ 5┊export const messageAddedSubscription = gql`\n+┊  ┊ 6┊  subscription messageAdded($chatId: ID) {\n+┊  ┊ 7┊    messageAdded(chatId: $chatId) {\n+┊  ┊ 8┊      ...Message\n+┊  ┊ 9┊      chat {\n+┊  ┊10┊        id,\n+┊  ┊11┊      },\n+┊  ┊12┊    }\n+┊  ┊13┊  }\n+┊  ┊14┊\n+┊  ┊15┊  ${fragments['message']}\n+┊  ┊16┊`;\n```\n\n[}]: #\n\nThen we need to run `graphql-code-generator` to generate the types:\n\n    yarn generator\n\nNow we can update the chats service to update the getChats query every time that we receive a new chat from the subscription.\nWith GraphQL subscriptions your client will be alerted on push from the server and you should choose the pattern that fits your application the most:\n\n- Use it as a notification and run any logic you want when it fires, for example alerting the user or refetching data\n- Use the data sent along with the notification and merge it directly into the store (existing queries are automatically notified)\n\nWith subscribeToMore, you can easily do the latter. We will manipulate the store to add the newly created chat.\n\nWe will do to do the same for the newMessage subscription, but this time we will have to update two different queries in the store: getChats and getChat.\n\n[{]: <helper> (diffStep \"11.1\" files=\"src/app/services/chats.service.ts\" module=\"client\")\n\n#### [Step 11.1: Subscriptions](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/8219b49)\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,7 +1,7 @@\n ┊1┊1┊import {concat, map, share, switchMap} from 'rxjs/operators';\n ┊2┊2┊import {Injectable} from '@angular/core';\n ┊3┊3┊import {Observable, AsyncSubject, of} from 'rxjs';\n-┊4┊ ┊import {QueryRef} from 'apollo-angular';\n+┊ ┊4┊import {Apollo, QueryRef} from 'apollo-angular';\n ┊5┊5┊import * as moment from 'moment';\n ┊6┊6┊import {\n ┊7┊7┊  GetChatsGQL,\n```\n```diff\n@@ -13,6 +13,8 @@\n ┊13┊13┊  GetUsersGQL,\n ┊14┊14┊  AddChatGQL,\n ┊15┊15┊  AddGroupGQL,\n+┊  ┊16┊  ChatAddedGQL,\n+┊  ┊17┊  MessageAddedGQL,\n ┊16┊18┊  AddMessage,\n ┊17┊19┊  GetChats,\n ┊18┊20┊  GetChat,\n```\n```diff\n@@ -21,6 +23,7 @@\n ┊21┊23┊  GetUsers,\n ┊22┊24┊  AddChat,\n ┊23┊25┊  AddGroup,\n+┊  ┊26┊  MessageAdded,\n ┊24┊27┊} from '../../graphql';\n ┊25┊28┊import { DataProxy } from 'apollo-cache';\n ┊26┊29┊import { FetchResult } from 'apollo-link';\n```\n```diff\n@@ -48,11 +51,69 @@\n ┊ 48┊ 51┊    private getUsersGQL: GetUsersGQL,\n ┊ 49┊ 52┊    private addChatGQL: AddChatGQL,\n ┊ 50┊ 53┊    private addGroupGQL: AddGroupGQL,\n+┊   ┊ 54┊    private chatAddedGQL: ChatAddedGQL,\n+┊   ┊ 55┊    private messageAddedGQL: MessageAddedGQL,\n+┊   ┊ 56┊    private apollo: Apollo,\n ┊ 51┊ 57┊    private loginService: LoginService\n ┊ 52┊ 58┊  ) {\n ┊ 53┊ 59┊    this.getChatsWq = this.getChatsGQL.watch({\n ┊ 54┊ 60┊      amount: this.messagesAmount,\n ┊ 55┊ 61┊    });\n+┊   ┊ 62┊\n+┊   ┊ 63┊    this.getChatsWq.subscribeToMore({\n+┊   ┊ 64┊      document: this.chatAddedGQL.document,\n+┊   ┊ 65┊      updateQuery: (prev: GetChats.Query, { subscriptionData }) => {\n+┊   ┊ 66┊        if (!subscriptionData.data) {\n+┊   ┊ 67┊          return prev;\n+┊   ┊ 68┊        }\n+┊   ┊ 69┊\n+┊   ┊ 70┊        const newChat: GetChats.Chats = subscriptionData.data.chatAdded;\n+┊   ┊ 71┊\n+┊   ┊ 72┊        return Object.assign({}, prev, {\n+┊   ┊ 73┊          chats: [...prev.chats, newChat]\n+┊   ┊ 74┊        });\n+┊   ┊ 75┊      }\n+┊   ┊ 76┊    });\n+┊   ┊ 77┊\n+┊   ┊ 78┊    this.getChatsWq.subscribeToMore({\n+┊   ┊ 79┊      document: this.messageAddedGQL.document,\n+┊   ┊ 80┊      updateQuery: (prev: GetChats.Query, { subscriptionData }) => {\n+┊   ┊ 81┊        if (!subscriptionData.data) {\n+┊   ┊ 82┊          return prev;\n+┊   ┊ 83┊        }\n+┊   ┊ 84┊\n+┊   ┊ 85┊        const newMessage: MessageAdded.MessageAdded = subscriptionData.data.messageAdded;\n+┊   ┊ 86┊\n+┊   ┊ 87┊        // We need to update the cache for both Chat and Chats. The following updates the cache for Chat.\n+┊   ┊ 88┊        try {\n+┊   ┊ 89┊          // Read the data from our cache for this query.\n+┊   ┊ 90┊          const {chat}: GetChat.Query = this.apollo.getClient().readQuery({\n+┊   ┊ 91┊            query: this.getChatGQL.document,\n+┊   ┊ 92┊            variables: {\n+┊   ┊ 93┊              chatId: newMessage.chat.id,\n+┊   ┊ 94┊            }\n+┊   ┊ 95┊          });\n+┊   ┊ 96┊\n+┊   ┊ 97┊          // Add our message from the mutation to the end.\n+┊   ┊ 98┊          chat.messages.push(newMessage);\n+┊   ┊ 99┊          // Write our data back to the cache.\n+┊   ┊100┊          this.apollo.getClient().writeQuery({\n+┊   ┊101┊            query: this.getChatGQL.document,\n+┊   ┊102┊            data: {\n+┊   ┊103┊              chat\n+┊   ┊104┊            }\n+┊   ┊105┊          });\n+┊   ┊106┊        } catch {\n+┊   ┊107┊          console.error('The chat we received an update for does not exist in the store');\n+┊   ┊108┊        }\n+┊   ┊109┊\n+┊   ┊110┊        return Object.assign({}, prev, {\n+┊   ┊111┊          chats: [...prev.chats.map(_chat =>\n+┊   ┊112┊            _chat.id === newMessage.chat.id ? {..._chat, messages: [..._chat.messages, newMessage]} : _chat)]\n+┊   ┊113┊        });\n+┊   ┊114┊      }\n+┊   ┊115┊    });\n+┊   ┊116┊\n ┊ 56┊117┊    this.chats$ = this.getChatsWq.valueChanges.pipe(\n ┊ 57┊118┊      map((result) => result.data.chats)\n ┊ 58┊119┊    );\n```\n```diff\n@@ -130,6 +191,10 @@\n ┊130┊191┊        addMessage: {\n ┊131┊192┊          id: ChatsService.getRandomId(),\n ┊132┊193┊          __typename: 'Message',\n+┊   ┊194┊          chat: {\n+┊   ┊195┊            id: chatId,\n+┊   ┊196┊            __typename: 'Chat',\n+┊   ┊197┊          },\n ┊133┊198┊          senderId: this.loginService.getUser().id,\n ┊134┊199┊          sender: {\n ┊135┊200┊            id: this.loginService.getUser().id,\n```\n\n[}]: #\n\nWe can finally configure the WebSocket in the GraphQL Module. Please notice that the WebSocket has its own authentication instead of using the `HttpInterceptor`, in fact we use `connectionParams` to send the authorization.\nAll queries will go through HTTP except the Subscriptions, which will use the WebSocket.\n\n[{]: <helper> (diffStep \"11.1\" files=\"src/app/graphql.module.ts\" module=\"client\")\n\n#### [Step 11.1: Subscriptions](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/8219b49)\n\n##### Changed src&#x2F;app&#x2F;graphql.module.ts\n```diff\n@@ -2,6 +2,11 @@\n ┊ 2┊ 2┊import { ApolloModule, APOLLO_OPTIONS } from 'apollo-angular';\n ┊ 3┊ 3┊import { HttpLinkModule, HttpLink } from 'apollo-angular-link-http';\n ┊ 4┊ 4┊import { InMemoryCache, defaultDataIdFromObject } from 'apollo-cache-inmemory';\n+┊  ┊ 5┊import {getMainDefinition} from 'apollo-utilities';\n+┊  ┊ 6┊import {OperationDefinitionNode} from 'graphql';\n+┊  ┊ 7┊import {split} from 'apollo-link';\n+┊  ┊ 8┊import {WebSocketLink} from 'apollo-link-ws';\n+┊  ┊ 9┊import {LoginService} from './login/services/login.service';\n ┊ 5┊10┊\n ┊ 6┊11┊const uri = 'http://localhost:3000/graphql';\n ┊ 7┊12┊\n```\n```diff\n@@ -14,9 +19,28 @@\n ┊14┊19┊  }\n ┊15┊20┊};\n ┊16┊21┊\n-┊17┊  ┊export function createApollo(httpLink: HttpLink) {\n+┊  ┊22┊export function createApollo(httpLink: HttpLink, loginService: LoginService) {\n+┊  ┊23┊  const subscriptionLink = new WebSocketLink({\n+┊  ┊24┊    uri: uri.replace('http', 'ws'),\n+┊  ┊25┊    options: {\n+┊  ┊26┊      reconnect: true,\n+┊  ┊27┊      connectionParams: () => ({\n+┊  ┊28┊        authToken: loginService.getAuthHeader() || null\n+┊  ┊29┊      })\n+┊  ┊30┊    }\n+┊  ┊31┊  });\n+┊  ┊32┊\n+┊  ┊33┊  const link = split(\n+┊  ┊34┊    ({ query }) => {\n+┊  ┊35┊      const { kind, operation } = getMainDefinition(query) as OperationDefinitionNode;\n+┊  ┊36┊      return kind === 'OperationDefinition' && operation === 'subscription';\n+┊  ┊37┊    },\n+┊  ┊38┊    subscriptionLink,\n+┊  ┊39┊    httpLink.create({uri})\n+┊  ┊40┊  );\n+┊  ┊41┊\n ┊18┊42┊  return {\n-┊19┊  ┊    link: httpLink.create({ uri }),\n+┊  ┊43┊    link,\n ┊20┊44┊    cache: new InMemoryCache({\n ┊21┊45┊      dataIdFromObject,\n ┊22┊46┊    }),\n```\n```diff\n@@ -29,7 +53,7 @@\n ┊29┊53┊    {\n ┊30┊54┊      provide: APOLLO_OPTIONS,\n ┊31┊55┊      useFactory: createApollo,\n-┊32┊  ┊      deps: [HttpLink],\n+┊  ┊56┊      deps: [HttpLink, LoginService],\n ┊33┊57┊    },\n ┊34┊58┊  ],\n ┊35┊59┊})\n```\n\n[}]: #\n\nWe used `split` of ApolloLink to decide which path should a request get, through WebSocket or HTTP. We decided to push subscriptions over the WebSocket and the rest normally, just like before.\n\nFinally, let's fix the tests:\n\n[{]: <helper> (diffStep \"11.1\" files=\"src/app/chat-viewer/containers/chat/chat.component.spec.ts, src/app/chats-lister/containers/chats/chats.component.spec.ts, src/app/services/chats.service.spec.ts\" module=\"client\")\n\n#### [Step 11.1: Subscriptions](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/8219b49)\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.spec.ts\n```diff\n@@ -148,6 +148,8 @@\n ┊148┊148┊    component = fixture.componentInstance;\n ┊149┊149┊    fixture.detectChanges();\n ┊150┊150┊\n+┊   ┊151┊    controller.expectOne('chatAdded', 'call to chatAdded api');\n+┊   ┊152┊    controller.expectOne('messageAdded', 'call to messageAdded api');\n ┊151┊153┊    controller.expectOne('GetChats', 'call to getChats api');\n ┊152┊154┊\n ┊153┊155┊    const req = controller.expectOne('GetChat', 'call to getChat api');\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.spec.ts\n```diff\n@@ -360,8 +360,10 @@\n ┊360┊360┊    component = fixture.componentInstance;\n ┊361┊361┊    fixture.detectChanges();\n ┊362┊362┊\n-┊363┊   ┊    const req = controller.expectOne('GetChats', 'GetChats operation');\n+┊   ┊363┊    controller.expectOne('chatAdded', 'call to chatAdded api');\n+┊   ┊364┊    controller.expectOne('messageAdded', 'call to messageAdded api');\n ┊364┊365┊\n+┊   ┊366┊    const req = controller.expectOne('GetChats', 'GetChats operation');\n ┊365┊367┊    req.flush({\n ┊366┊368┊      data: {\n ┊367┊369┊        chats,\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.spec.ts\n```diff\n@@ -11,7 +11,7 @@\n ┊11┊11┊import { GetChats } from '../../graphql';\n ┊12┊12┊import { dataIdFromObject } from '../graphql.module';\n ┊13┊13┊import { ChatsService } from './chats.service';\n-┊14┊  ┊import {LoginService} from '../login/services/login.service';\n+┊  ┊14┊import { LoginService } from '../login/services/login.service';\n ┊15┊15┊\n ┊16┊16┊describe('ChatsService', () => {\n ┊17┊17┊  let controller: ApolloTestingController;\n```\n```diff\n@@ -341,6 +341,9 @@\n ┊341┊341┊      }\n ┊342┊342┊    });\n ┊343┊343┊\n+┊   ┊344┊    controller.expectOne('chatAdded', 'call to chatAdded api');\n+┊   ┊345┊    controller.expectOne('messageAdded', 'call to messageAdded api');\n+┊   ┊346┊\n ┊344┊347┊    const req = controller.expectOne('GetChats', 'GetChats operation');\n ┊345┊348┊\n ┊346┊349┊    req.flush({\n```\n\n[}]: #"
          },
          {
            "manualTitle": "Step 16: TypeORM with PostgreSQL",
            "stepRevision": "8686ed12d75fe225a178dd89175a3e594df424c9",
            "manualView": "## Server\n\nFirst of all you will have to install PostgreSQL on your operating system. Since there so many options (different Linux distributions, MacOS X, Windows...) I will assume that you already know how to install a software in your OS and take that part for granted.\n\nThen you will have to install a couple of packages:\n\n    yarn add pg reflect-metadata typeorm\n    yarn add -D @types/pg\n\nWe aren't going to use plain SQL, instead we will use an Object-relational mapping framework (ORM) called `TypeORM`.\n`TypeORM` takes advantage of Typescript classes and type declarations in order to infer the db structure.\n\nWe will need to enable support for experimental decorators, emit type metadata for decorators and disable strict property initialization:\n\n[{]: <helper> (diffStep \"6.1\" files=\"tsconfig.json\" module=\"server\")\n\n#### [Step 6.1: TypeORM with PostgreSQL](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/00c4cab)\n\n##### Changed tsconfig.json\n```diff\n@@ -22,11 +22,11 @@\n ┊22┊22┊    // \"isolatedModules\": true,               /* Transpile each file as a separate module (similar to 'ts.transpileModule'). */\n ┊23┊23┊\n ┊24┊24┊    /* Strict Type-Checking Options */\n-┊25┊  ┊    \"strict\": true,                            /* Enable all strict type-checking options. */\n+┊  ┊25┊    \"strict\": true,                           /* Enable all strict type-checking options. */\n ┊26┊26┊    // \"noImplicitAny\": true,                 /* Raise error on expressions and declarations with an implied 'any' type. */\n ┊27┊27┊    // \"strictNullChecks\": true,              /* Enable strict null checks. */\n ┊28┊28┊    // See https://github.com/DefinitelyTyped/DefinitelyTyped/issues/21359\n-┊29┊  ┊    \"strictFunctionTypes\": false              /* Enable strict checking of function types. */\n+┊  ┊29┊    \"strictFunctionTypes\": false,             /* Enable strict checking of function types. */\n ┊30┊30┊    // \"noImplicitThis\": true,                /* Raise error on 'this' expressions with an implied 'any' type. */\n ┊31┊31┊    // \"alwaysStrict\": true,                  /* Parse in strict mode and emit \"use strict\" for each source file. */\n ┊32┊32┊\n```\n```diff\n@@ -53,7 +53,8 @@\n ┊53┊53┊    // \"inlineSources\": true,                 /* Emit the source alongside the sourcemaps within a single file; requires '--inlineSourceMap' or '--sourceMap' to be set. */\n ┊54┊54┊\n ┊55┊55┊    /* Experimental Options */\n-┊56┊  ┊    // \"experimentalDecorators\": true,        /* Enables experimental support for ES7 decorators. */\n-┊57┊  ┊    // \"emitDecoratorMetadata\": true,         /* Enables experimental support for emitting type metadata for decorators. */\n+┊  ┊56┊    \"experimentalDecorators\": true,           /* Enables experimental support for ES7 decorators. */\n+┊  ┊57┊    \"emitDecoratorMetadata\": true,            /* Enables experimental support for emitting type metadata for decorators. */\n+┊  ┊58┊    \"strictPropertyInitialization\": false\n ┊58┊59┊  }\n ┊59┊60┊}🚫↵\n```\n\n[}]: #\n\nThe next step is to create Entities. An Entity is a class that maps to a database table. You can create a entity by defining a new class and mark it with @Entity():\n\n[{]: <helper> (diffStep \"6.1\" files=\"entity\" module=\"server\")\n\n#### [Step 6.1: TypeORM with PostgreSQL](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/00c4cab)\n\n##### Added entity&#x2F;Chat.ts\n```diff\n@@ -0,0 +1,79 @@\n+┊  ┊ 1┊import { Entity, Column, PrimaryGeneratedColumn, OneToMany, JoinTable, ManyToMany, ManyToOne } from \"typeorm\";\n+┊  ┊ 2┊import { Message } from \"./Message\";\n+┊  ┊ 3┊import { User } from \"./User\";\n+┊  ┊ 4┊import { Recipient } from \"./Recipient\";\n+┊  ┊ 5┊\n+┊  ┊ 6┊interface ChatConstructor {\n+┊  ┊ 7┊  name?: string;\n+┊  ┊ 8┊  picture?: string;\n+┊  ┊ 9┊  allTimeMembers?: User[];\n+┊  ┊10┊  listingMembers?: User[];\n+┊  ┊11┊  actualGroupMembers?: User[];\n+┊  ┊12┊  admins?: User[];\n+┊  ┊13┊  owner?: User;\n+┊  ┊14┊  messages?: Message[];\n+┊  ┊15┊}\n+┊  ┊16┊\n+┊  ┊17┊@Entity()\n+┊  ┊18┊export class Chat {\n+┊  ┊19┊  @PrimaryGeneratedColumn()\n+┊  ┊20┊  id: number;\n+┊  ┊21┊\n+┊  ┊22┊  @Column({nullable: true})\n+┊  ┊23┊  name: string;\n+┊  ┊24┊\n+┊  ┊25┊  @Column({nullable: true})\n+┊  ┊26┊  picture: string;\n+┊  ┊27┊\n+┊  ┊28┊  @ManyToMany(type => User, user => user.allTimeMemberChats, {cascade: [\"insert\", \"update\"], eager: false})\n+┊  ┊29┊  @JoinTable()\n+┊  ┊30┊  allTimeMembers: User[];\n+┊  ┊31┊\n+┊  ┊32┊  @ManyToMany(type => User, user => user.listingMemberChats, {cascade: [\"insert\", \"update\"], eager: false})\n+┊  ┊33┊  @JoinTable()\n+┊  ┊34┊  listingMembers: User[];\n+┊  ┊35┊\n+┊  ┊36┊  @ManyToMany(type => User, user => user.actualGroupMemberChats, {cascade: [\"insert\", \"update\"], eager: false})\n+┊  ┊37┊  @JoinTable()\n+┊  ┊38┊  actualGroupMembers?: User[];\n+┊  ┊39┊\n+┊  ┊40┊  @ManyToMany(type => User, user => user.adminChats, {cascade: [\"insert\", \"update\"], eager: false})\n+┊  ┊41┊  @JoinTable()\n+┊  ┊42┊  admins?: User[];\n+┊  ┊43┊\n+┊  ┊44┊  @ManyToOne(type => User, user => user.ownerChats, {cascade: [\"insert\", \"update\"], eager: false})\n+┊  ┊45┊  owner?: User | null;\n+┊  ┊46┊\n+┊  ┊47┊  @OneToMany(type => Message, message => message.chat, {cascade: [\"insert\", \"update\"], eager: true})\n+┊  ┊48┊  messages: Message[];\n+┊  ┊49┊\n+┊  ┊50┊  @OneToMany(type => Recipient, recipient => recipient.chat)\n+┊  ┊51┊  recipients: Recipient[];\n+┊  ┊52┊\n+┊  ┊53┊  constructor({name, picture, allTimeMembers, listingMembers, actualGroupMembers, admins, owner, messages}: ChatConstructor = {}) {\n+┊  ┊54┊    if (name) {\n+┊  ┊55┊      this.name = name;\n+┊  ┊56┊    }\n+┊  ┊57┊    if (picture) {\n+┊  ┊58┊      this.picture = picture;\n+┊  ┊59┊    }\n+┊  ┊60┊    if (allTimeMembers) {\n+┊  ┊61┊      this.allTimeMembers = allTimeMembers;\n+┊  ┊62┊    }\n+┊  ┊63┊    if (listingMembers) {\n+┊  ┊64┊      this.listingMembers = listingMembers;\n+┊  ┊65┊    }\n+┊  ┊66┊    if (actualGroupMembers) {\n+┊  ┊67┊      this.actualGroupMembers = actualGroupMembers;\n+┊  ┊68┊    }\n+┊  ┊69┊    if (admins) {\n+┊  ┊70┊      this.admins = admins;\n+┊  ┊71┊    }\n+┊  ┊72┊    if (owner) {\n+┊  ┊73┊      this.owner = owner;\n+┊  ┊74┊    }\n+┊  ┊75┊    if (messages) {\n+┊  ┊76┊      this.messages = messages;\n+┊  ┊77┊    }\n+┊  ┊78┊  }\n+┊  ┊79┊}\n```\n\n##### Added entity&#x2F;Message.ts\n```diff\n@@ -0,0 +1,70 @@\n+┊  ┊ 1┊import {\n+┊  ┊ 2┊  Entity, Column, PrimaryGeneratedColumn, OneToMany, ManyToOne, ManyToMany, JoinTable, CreateDateColumn\n+┊  ┊ 3┊} from \"typeorm\";\n+┊  ┊ 4┊import { Chat } from \"./Chat\";\n+┊  ┊ 5┊import { User } from \"./User\";\n+┊  ┊ 6┊import { Recipient } from \"./Recipient\";\n+┊  ┊ 7┊import { MessageType } from \"../db\";\n+┊  ┊ 8┊\n+┊  ┊ 9┊interface MessageConstructor {\n+┊  ┊10┊  sender?: User;\n+┊  ┊11┊  content?: string;\n+┊  ┊12┊  createdAt?: Date,\n+┊  ┊13┊  type?: MessageType;\n+┊  ┊14┊  recipients?: Recipient[];\n+┊  ┊15┊  holders?: User[];\n+┊  ┊16┊  chat?: Chat;\n+┊  ┊17┊}\n+┊  ┊18┊\n+┊  ┊19┊@Entity()\n+┊  ┊20┊export class Message {\n+┊  ┊21┊  @PrimaryGeneratedColumn()\n+┊  ┊22┊  id: number;\n+┊  ┊23┊\n+┊  ┊24┊  @ManyToOne(type => User, user => user.senderMessages, {eager: true})\n+┊  ┊25┊  sender: User;\n+┊  ┊26┊\n+┊  ┊27┊  @Column()\n+┊  ┊28┊  content: string;\n+┊  ┊29┊\n+┊  ┊30┊  @CreateDateColumn({nullable: true})\n+┊  ┊31┊  createdAt: Date;\n+┊  ┊32┊\n+┊  ┊33┊  @Column()\n+┊  ┊34┊  type: number;\n+┊  ┊35┊\n+┊  ┊36┊  @OneToMany(type => Recipient, recipient => recipient.message, {cascade: [\"insert\", \"update\"], eager: true})\n+┊  ┊37┊  recipients: Recipient[];\n+┊  ┊38┊\n+┊  ┊39┊  @ManyToMany(type => User, user => user.holderMessages, {cascade: [\"insert\", \"update\"], eager: true})\n+┊  ┊40┊  @JoinTable()\n+┊  ┊41┊  holders: User[];\n+┊  ┊42┊\n+┊  ┊43┊  @ManyToOne(type => Chat, chat => chat.messages)\n+┊  ┊44┊  chat: Chat;\n+┊  ┊45┊\n+┊  ┊46┊  constructor({sender, content, createdAt, type, recipients, holders, chat}: MessageConstructor = {}) {\n+┊  ┊47┊    if (sender) {\n+┊  ┊48┊      this.sender = sender;\n+┊  ┊49┊    }\n+┊  ┊50┊    if (content) {\n+┊  ┊51┊      this.content = content;\n+┊  ┊52┊    }\n+┊  ┊53┊    if (createdAt) {\n+┊  ┊54┊      this.createdAt = createdAt;\n+┊  ┊55┊    }\n+┊  ┊56┊    if (type) {\n+┊  ┊57┊      this.type = type;\n+┊  ┊58┊    }\n+┊  ┊59┊    if (recipients) {\n+┊  ┊60┊      recipients.forEach(recipient => recipient.message = this);\n+┊  ┊61┊      this.recipients = recipients;\n+┊  ┊62┊    }\n+┊  ┊63┊    if (holders) {\n+┊  ┊64┊      this.holders = holders;\n+┊  ┊65┊    }\n+┊  ┊66┊    if (chat) {\n+┊  ┊67┊      this.chat = chat;\n+┊  ┊68┊    }\n+┊  ┊69┊  }\n+┊  ┊70┊}\n```\n\n##### Added entity&#x2F;Recipient.ts\n```diff\n@@ -0,0 +1,44 @@\n+┊  ┊ 1┊import { Entity, ManyToOne, Column } from \"typeorm\";\n+┊  ┊ 2┊import { Message } from \"./Message\";\n+┊  ┊ 3┊import { User } from \"./User\";\n+┊  ┊ 4┊import { Chat } from \"./Chat\";\n+┊  ┊ 5┊\n+┊  ┊ 6┊interface RecipientConstructor {\n+┊  ┊ 7┊  user?: User;\n+┊  ┊ 8┊  message?: Message;\n+┊  ┊ 9┊  receivedAt?: Date;\n+┊  ┊10┊  readAt?: Date;\n+┊  ┊11┊}\n+┊  ┊12┊\n+┊  ┊13┊@Entity()\n+┊  ┊14┊export class Recipient {\n+┊  ┊15┊  @ManyToOne(type => User, user => user.recipients, { primary: true })\n+┊  ┊16┊  user: User;\n+┊  ┊17┊\n+┊  ┊18┊  @ManyToOne(type => Message, message => message.recipients, { primary: true })\n+┊  ┊19┊  message: Message;\n+┊  ┊20┊\n+┊  ┊21┊  @ManyToOne(type => Chat, chat => chat.recipients)\n+┊  ┊22┊  chat: Chat;\n+┊  ┊23┊\n+┊  ┊24┊  @Column({nullable: true})\n+┊  ┊25┊  receivedAt: Date;\n+┊  ┊26┊\n+┊  ┊27┊  @Column({nullable: true})\n+┊  ┊28┊  readAt: Date;\n+┊  ┊29┊\n+┊  ┊30┊  constructor({user, message, receivedAt, readAt}: RecipientConstructor = {}) {\n+┊  ┊31┊    if (user) {\n+┊  ┊32┊      this.user = user;\n+┊  ┊33┊    }\n+┊  ┊34┊    if (message) {\n+┊  ┊35┊      this.message = message;\n+┊  ┊36┊    }\n+┊  ┊37┊    if (receivedAt) {\n+┊  ┊38┊      this.receivedAt = receivedAt;\n+┊  ┊39┊    }\n+┊  ┊40┊    if (readAt) {\n+┊  ┊41┊      this.readAt = readAt;\n+┊  ┊42┊    }\n+┊  ┊43┊  }\n+┊  ┊44┊}\n```\n\n##### Added entity&#x2F;User.ts\n```diff\n@@ -0,0 +1,75 @@\n+┊  ┊ 1┊import { Entity, Column, PrimaryGeneratedColumn, ManyToMany, OneToMany } from \"typeorm\";\n+┊  ┊ 2┊import { Chat } from \"./Chat\";\n+┊  ┊ 3┊import { Message } from \"./Message\";\n+┊  ┊ 4┊import { Recipient } from \"./Recipient\";\n+┊  ┊ 5┊\n+┊  ┊ 6┊interface UserConstructor {\n+┊  ┊ 7┊  username?: string;\n+┊  ┊ 8┊  password?: string;\n+┊  ┊ 9┊  name?: string;\n+┊  ┊10┊  picture?: string;\n+┊  ┊11┊  phone?: string;\n+┊  ┊12┊}\n+┊  ┊13┊\n+┊  ┊14┊@Entity()\n+┊  ┊15┊export class User {\n+┊  ┊16┊  @PrimaryGeneratedColumn()\n+┊  ┊17┊  id: number;\n+┊  ┊18┊\n+┊  ┊19┊  @Column()\n+┊  ┊20┊  username: string;\n+┊  ┊21┊\n+┊  ┊22┊  @Column()\n+┊  ┊23┊  password: string;\n+┊  ┊24┊\n+┊  ┊25┊  @Column()\n+┊  ┊26┊  name: string;\n+┊  ┊27┊\n+┊  ┊28┊  @Column({nullable: true})\n+┊  ┊29┊  picture: string;\n+┊  ┊30┊\n+┊  ┊31┊  @Column({nullable: true})\n+┊  ┊32┊  phone?: string;\n+┊  ┊33┊\n+┊  ┊34┊  @ManyToMany(type => Chat, chat => chat.allTimeMembers)\n+┊  ┊35┊  allTimeMemberChats: Chat[];\n+┊  ┊36┊\n+┊  ┊37┊  @ManyToMany(type => Chat, chat => chat.listingMembers)\n+┊  ┊38┊  listingMemberChats: Chat[];\n+┊  ┊39┊\n+┊  ┊40┊  @ManyToMany(type => Chat, chat => chat.actualGroupMembers)\n+┊  ┊41┊  actualGroupMemberChats: Chat[];\n+┊  ┊42┊\n+┊  ┊43┊  @ManyToMany(type => Chat, chat => chat.admins)\n+┊  ┊44┊  adminChats: Chat[];\n+┊  ┊45┊\n+┊  ┊46┊  @ManyToMany(type => Message, message => message.holders)\n+┊  ┊47┊  holderMessages: Message[];\n+┊  ┊48┊\n+┊  ┊49┊  @OneToMany(type => Chat, chat => chat.owner)\n+┊  ┊50┊  ownerChats: Chat[];\n+┊  ┊51┊\n+┊  ┊52┊  @OneToMany(type => Message, message => message.sender)\n+┊  ┊53┊  senderMessages: Message[];\n+┊  ┊54┊\n+┊  ┊55┊  @OneToMany(type => Recipient, recipient => recipient.user)\n+┊  ┊56┊  recipients: Recipient[];\n+┊  ┊57┊\n+┊  ┊58┊  constructor({username, password, name, picture, phone}: UserConstructor = {}) {\n+┊  ┊59┊    if (username) {\n+┊  ┊60┊      this.username = username;\n+┊  ┊61┊    }\n+┊  ┊62┊    if (password) {\n+┊  ┊63┊      this.password = password;\n+┊  ┊64┊    }\n+┊  ┊65┊    if (name) {\n+┊  ┊66┊      this.name = name;\n+┊  ┊67┊    }\n+┊  ┊68┊    if (picture) {\n+┊  ┊69┊      this.picture = picture;\n+┊  ┊70┊    }\n+┊  ┊71┊    if (phone) {\n+┊  ┊72┊      this.phone = phone;\n+┊  ┊73┊    }\n+┊  ┊74┊  }\n+┊  ┊75┊}\n```\n\n[}]: #\n\nBasic entities consist of columns and relations. Each entity MUST have a primary column.\n\nEach entity must be registered in your connection options:\n\n[{]: <helper> (diffStep \"6.1\" files=\"ormconfig.json\" module=\"server\")\n\n#### [Step 6.1: TypeORM with PostgreSQL](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/00c4cab)\n\n##### Added ormconfig.json\n```diff\n@@ -0,0 +1,24 @@\n+┊  ┊ 1┊{\n+┊  ┊ 2┊   \"type\": \"postgres\",\n+┊  ┊ 3┊   \"host\": \"localhost\",\n+┊  ┊ 4┊   \"port\": 5432,\n+┊  ┊ 5┊   \"username\": \"test\",\n+┊  ┊ 6┊   \"password\": \"\",\n+┊  ┊ 7┊   \"database\": \"test\",\n+┊  ┊ 8┊   \"synchronize\": true,\n+┊  ┊ 9┊   \"logging\": false,\n+┊  ┊10┊   \"entities\": [\n+┊  ┊11┊      \"entity/**/*.ts\"\n+┊  ┊12┊   ],\n+┊  ┊13┊   \"migrations\": [\n+┊  ┊14┊      \"migration/**/*.ts\"\n+┊  ┊15┊   ],\n+┊  ┊16┊   \"subscribers\": [\n+┊  ┊17┊      \"subscriber/**/*.ts\"\n+┊  ┊18┊   ],\n+┊  ┊19┊   \"cli\": {\n+┊  ┊20┊      \"entitiesDir\": \"entity\",\n+┊  ┊21┊      \"migrationsDir\": \"migration\",\n+┊  ┊22┊      \"subscribersDir\": \"subscriber\"\n+┊  ┊23┊   }\n+┊  ┊24┊}🚫↵\n```\n\n[}]: #\n\nSince database table consist of columns your entities must consist of columns too. Each entity class property you marked with @Column will be mapped to a database table column.\nEach entity must have at least one primary column. There are several types of primary columns, but in our case `@PrimaryGeneratedColumn()` creates a primary column which value will be automatically generated with an auto-increment value.\n`@CreateDateColumn` is a special column that is automatically set to the entity's insertion date. You don't need set this column - it will be automatically set.\nFor the Recipient Entity we use a composite primary key that consists of two foreign keys.\n\nThe next thing to do is to create a connection with the database before firing up the web server:\n\n[{]: <helper> (diffStep \"6.1\" files=\"index.ts\" module=\"server\")\n\n#### [Step 6.1: TypeORM with PostgreSQL](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/00c4cab)\n\n##### Changed index.ts\n```diff\n@@ -1,3 +1,5 @@\n+┊ ┊1┊// For TypeORM\n+┊ ┊2┊import \"reflect-metadata\";\n ┊1┊3┊import { schema } from \"./schema\";\n ┊2┊4┊import * as bodyParser from \"body-parser\";\n ┊3┊5┊import * as cors from 'cors';\n```\n```diff\n@@ -6,12 +8,10 @@\n ┊ 6┊ 8┊import * as passport from \"passport\";\n ┊ 7┊ 9┊import * as basicStrategy from 'passport-http';\n ┊ 8┊10┊import * as bcrypt from 'bcrypt-nodejs';\n-┊ 9┊  ┊import { db, User } from \"./db\";\n ┊10┊11┊import { createServer } from \"http\";\n-┊11┊  ┊\n-┊12┊  ┊let users = db.users;\n-┊13┊  ┊\n-┊14┊  ┊console.log(users);\n+┊  ┊12┊import { createConnection } from \"typeorm\";\n+┊  ┊13┊import { User } from \"./entity/User\";\n+┊  ┊14┊import { addSampleData } from \"./db\";\n ┊15┊15┊\n ┊16┊16┊function generateHash(password: string) {\n ┊17┊17┊  return bcrypt.hashSync(password, bcrypt.genSaltSync(8));\n```\n```diff\n@@ -21,93 +21,96 @@\n ┊ 21┊ 21┊  return bcrypt.compareSync(password, localPassword);\n ┊ 22┊ 22┊}\n ┊ 23┊ 23┊\n-┊ 24┊   ┊passport.use('basic-signin', new basicStrategy.BasicStrategy(\n-┊ 25┊   ┊  function (username: string, password: string, done: any) {\n-┊ 26┊   ┊    const user = users.find(user => user.username == username);\n-┊ 27┊   ┊    if (user && validPassword(password, user.password)) {\n-┊ 28┊   ┊      return done(null, user);\n+┊   ┊ 24┊createConnection().then(async connection => {\n+┊   ┊ 25┊  await addSampleData(connection);\n+┊   ┊ 26┊\n+┊   ┊ 27┊  passport.use('basic-signin', new basicStrategy.BasicStrategy(\n+┊   ┊ 28┊    async function (username: string, password: string, done: any) {\n+┊   ┊ 29┊      const user = await connection.getRepository(User).findOne({where: { username }});\n+┊   ┊ 30┊      if (user && validPassword(password, user.password)) {\n+┊   ┊ 31┊        return done(null, user);\n+┊   ┊ 32┊      }\n+┊   ┊ 33┊      return done(null, false);\n ┊ 29┊ 34┊    }\n-┊ 30┊   ┊    return done(null, false);\n-┊ 31┊   ┊  }\n-┊ 32┊   ┊));\n-┊ 33┊   ┊\n-┊ 34┊   ┊passport.use('basic-signup', new basicStrategy.BasicStrategy({passReqToCallback: true},\n-┊ 35┊   ┊  function (req: any, username: any, password: any, done: any) {\n-┊ 36┊   ┊    const userExists = !!users.find(user => user.username === username);\n-┊ 37┊   ┊    if (!userExists && password && req.body.name) {\n-┊ 38┊   ┊      const user: User = {\n-┊ 39┊   ┊        id: (users.length && users[users.length - 1].id + 1) || 1,\n-┊ 40┊   ┊        username,\n-┊ 41┊   ┊        password: generateHash(password),\n-┊ 42┊   ┊        name: req.body.name,\n-┊ 43┊   ┊      };\n-┊ 44┊   ┊      users.push(user);\n-┊ 45┊   ┊      return done(null, user);\n+┊   ┊ 35┊  ));\n+┊   ┊ 36┊\n+┊   ┊ 37┊  passport.use('basic-signup', new basicStrategy.BasicStrategy({passReqToCallback: true},\n+┊   ┊ 38┊    async function (req: any, username: string, password: string, done: any) {\n+┊   ┊ 39┊      const userExists = !!(await connection.getRepository(User).findOne({where: { username }}));\n+┊   ┊ 40┊      if (!userExists && password && req.body.name) {\n+┊   ┊ 41┊        const user = await connection.manager.save(new User({\n+┊   ┊ 42┊          username,\n+┊   ┊ 43┊          password: generateHash(password),\n+┊   ┊ 44┊          name: req.body.name,\n+┊   ┊ 45┊        }));\n+┊   ┊ 46┊        return done(null, user);\n+┊   ┊ 47┊      }\n+┊   ┊ 48┊      return done(null, false);\n ┊ 46┊ 49┊    }\n-┊ 47┊   ┊    return done(null, false);\n-┊ 48┊   ┊  }\n-┊ 49┊   ┊));\n+┊   ┊ 50┊  ));\n ┊ 50┊ 51┊\n-┊ 51┊   ┊const PORT = 3000;\n+┊   ┊ 52┊  const PORT = 3000;\n ┊ 52┊ 53┊\n-┊ 53┊   ┊const app = express();\n+┊   ┊ 54┊  const app = express();\n ┊ 54┊ 55┊\n-┊ 55┊   ┊app.use(cors());\n-┊ 56┊   ┊app.use(bodyParser.json());\n-┊ 57┊   ┊app.use(passport.initialize());\n+┊   ┊ 56┊  app.use(cors());\n+┊   ┊ 57┊  app.use(bodyParser.json());\n+┊   ┊ 58┊  app.use(passport.initialize());\n ┊ 58┊ 59┊\n-┊ 59┊   ┊app.post('/signup',\n-┊ 60┊   ┊  passport.authenticate('basic-signup', {session: false}),\n-┊ 61┊   ┊  function (req: any, res) {\n-┊ 62┊   ┊    res.json(req.user);\n-┊ 63┊   ┊  });\n+┊   ┊ 60┊  app.post('/signup',\n+┊   ┊ 61┊    passport.authenticate('basic-signup', {session: false}),\n+┊   ┊ 62┊    function (req: any, res) {\n+┊   ┊ 63┊      res.json(req.user);\n+┊   ┊ 64┊    });\n ┊ 64┊ 65┊\n-┊ 65┊   ┊app.use(passport.authenticate('basic-signin', {session: false}));\n+┊   ┊ 66┊  app.use(passport.authenticate('basic-signin', {session: false}));\n ┊ 66┊ 67┊\n-┊ 67┊   ┊app.post('/signin', function (req: any, res) {\n-┊ 68┊   ┊  res.json(req.user);\n-┊ 69┊   ┊});\n+┊   ┊ 68┊  app.post('/signin', function (req, res) {\n+┊   ┊ 69┊    res.json(req.user);\n+┊   ┊ 70┊  });\n ┊ 70┊ 71┊\n-┊ 71┊   ┊const apollo = new ApolloServer({\n-┊ 72┊   ┊  schema,\n-┊ 73┊   ┊  context(received: any) {\n-┊ 74┊   ┊    return {\n-┊ 75┊   ┊      user: received.connection ? received.connection.context.user : received.req!['user'],\n-┊ 76┊   ┊    }\n-┊ 77┊   ┊  },\n-┊ 78┊   ┊  subscriptions: {\n-┊ 79┊   ┊    onConnect: (connectionParams: any, webSocket: any) => {\n-┊ 80┊   ┊      if (connectionParams.authToken) {\n-┊ 81┊   ┊        // create a buffer and tell it the data coming in is base64\n-┊ 82┊   ┊        const buf = new Buffer(connectionParams.authToken.split(' ')[1], 'base64');\n-┊ 83┊   ┊        // read it back out as a string\n-┊ 84┊   ┊        const [username, password]: string[] = buf.toString().split(':');\n-┊ 85┊   ┊        if (username && password) {\n-┊ 86┊   ┊          const user = users.find(user => user.username == username);\n-┊ 87┊   ┊\n-┊ 88┊   ┊          if (user && validPassword(password, user.password)) {\n-┊ 89┊   ┊            // Set context for the WebSocket\n-┊ 90┊   ┊            return {user};\n-┊ 91┊   ┊          } else {\n-┊ 92┊   ┊            throw new Error('Wrong credentials!');\n+┊   ┊ 72┊  const apollo = new ApolloServer({\n+┊   ┊ 73┊    schema,\n+┊   ┊ 74┊    context(received: any) {\n+┊   ┊ 75┊      return {\n+┊   ┊ 76┊        user: received.connection ? received.connection.context.user : received.req!['user'],\n+┊   ┊ 77┊        connection,\n+┊   ┊ 78┊      }\n+┊   ┊ 79┊    },\n+┊   ┊ 80┊    subscriptions: {\n+┊   ┊ 81┊      onConnect: async (connectionParams: any, webSocket: any) => {\n+┊   ┊ 82┊        if (connectionParams.authToken) {\n+┊   ┊ 83┊          // Create a buffer and tell it the data coming in is base64\n+┊   ┊ 84┊          const buf = new Buffer(connectionParams.authToken.split(' ')[1], 'base64');\n+┊   ┊ 85┊          // Read it back out as a string\n+┊   ┊ 86┊          const [username, password]: string[] = buf.toString().split(':');\n+┊   ┊ 87┊          if (username && password) {\n+┊   ┊ 88┊            const user = await connection.getRepository(User).findOne({where: { username }});\n+┊   ┊ 89┊\n+┊   ┊ 90┊            if (user && validPassword(password, user.password)) {\n+┊   ┊ 91┊              // Set context for the WebSocket\n+┊   ┊ 92┊              return {user};\n+┊   ┊ 93┊            } else {\n+┊   ┊ 94┊              throw new Error('Wrong credentials!');\n+┊   ┊ 95┊            }\n ┊ 93┊ 96┊          }\n ┊ 94┊ 97┊        }\n+┊   ┊ 98┊        throw new Error('Missing auth token!');\n ┊ 95┊ 99┊      }\n-┊ 96┊   ┊      throw new Error('Missing auth token!');\n ┊ 97┊100┊    }\n-┊ 98┊   ┊  }\n-┊ 99┊   ┊});\n+┊   ┊101┊  });\n ┊100┊102┊\n-┊101┊   ┊apollo.applyMiddleware({\n-┊102┊   ┊  app,\n-┊103┊   ┊  path: '/graphql'\n-┊104┊   ┊});\n+┊   ┊103┊  apollo.applyMiddleware({\n+┊   ┊104┊    app,\n+┊   ┊105┊    path: '/graphql'\n+┊   ┊106┊  });\n ┊105┊107┊\n-┊106┊   ┊// Wrap the Express server\n-┊107┊   ┊const ws = createServer(app);\n+┊   ┊108┊  // Wrap the Express server\n+┊   ┊109┊  const ws = createServer(app);\n ┊108┊110┊\n-┊109┊   ┊apollo.installSubscriptionHandlers(ws);\n+┊   ┊111┊  apollo.installSubscriptionHandlers(ws);\n ┊110┊112┊\n-┊111┊   ┊ws.listen(PORT, () => {\n-┊112┊   ┊  console.log(`Apollo Server is now running on http://localhost:${PORT}`);\n+┊   ┊113┊  ws.listen(PORT, () => {\n+┊   ┊114┊    console.log(`Apollo Server is now running on http://localhost:${PORT}`);\n+┊   ┊115┊  });\n ┊113┊116┊});\n```\n\n[}]: #\n\nWe will also remove our fake db and replace it with some real data:\n\n[{]: <helper> (diffStep \"6.1\" files=\"db.ts\" module=\"server\")\n\n#### [Step 6.1: TypeORM with PostgreSQL](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/00c4cab)\n\n##### Changed db.ts\n```diff\n@@ -1,4 +1,11 @@\n+┊  ┊ 1┊// For TypeORM\n+┊  ┊ 2┊import \"reflect-metadata\";\n+┊  ┊ 3┊import { Chat } from \"./entity/Chat\";\n+┊  ┊ 4┊import { Recipient } from \"./entity/Recipient\";\n ┊ 1┊ 5┊import * as moment from 'moment';\n+┊  ┊ 6┊import { Message } from \"./entity/Message\";\n+┊  ┊ 7┊import { User } from \"./entity/User\";\n+┊  ┊ 8┊import { Connection } from \"typeorm\";\n ┊ 2┊ 9┊\n ┊ 3┊10┊export enum MessageType {\n ┊ 4┊11┊  PICTURE,\n```\n```diff\n@@ -6,433 +13,280 @@\n ┊  6┊ 13┊  LOCATION,\n ┊  7┊ 14┊}\n ┊  8┊ 15┊\n-┊  9┊   ┊export interface User {\n-┊ 10┊   ┊  id: number,\n-┊ 11┊   ┊  username: string,\n-┊ 12┊   ┊  password: string,\n-┊ 13┊   ┊  name: string,\n-┊ 14┊   ┊  picture?: string | null,\n-┊ 15┊   ┊  phone?: string | null,\n-┊ 16┊   ┊}\n-┊ 17┊   ┊\n-┊ 18┊   ┊export interface Chat {\n-┊ 19┊   ┊  id: number,\n-┊ 20┊   ┊  name?: string | null,\n-┊ 21┊   ┊  picture?: string | null,\n-┊ 22┊   ┊  // All members, current and past ones.\n-┊ 23┊   ┊  allTimeMemberIds: number[],\n-┊ 24┊   ┊  // Whoever gets the chat listed. For groups includes past members who still didn't delete the group.\n-┊ 25┊   ┊  listingMemberIds: number[],\n-┊ 26┊   ┊  // Actual members of the group (they are not the only ones who get the group listed). Null for chats.\n-┊ 27┊   ┊  actualGroupMemberIds?: number[] | null,\n-┊ 28┊   ┊  adminIds?: number[] | null,\n-┊ 29┊   ┊  ownerId?: number | null,\n-┊ 30┊   ┊  messages: Message[],\n-┊ 31┊   ┊}\n-┊ 32┊   ┊\n-┊ 33┊   ┊export interface Message {\n-┊ 34┊   ┊  id: number,\n-┊ 35┊   ┊  chatId: number,\n-┊ 36┊   ┊  senderId: number,\n-┊ 37┊   ┊  content: string,\n-┊ 38┊   ┊  createdAt: number,\n-┊ 39┊   ┊  type: MessageType,\n-┊ 40┊   ┊  recipients: Recipient[],\n-┊ 41┊   ┊  holderIds: number[],\n-┊ 42┊   ┊}\n-┊ 43┊   ┊\n-┊ 44┊   ┊export interface Recipient {\n-┊ 45┊   ┊  userId: number,\n-┊ 46┊   ┊  messageId: number,\n-┊ 47┊   ┊  chatId: number,\n-┊ 48┊   ┊  receivedAt: number | null,\n-┊ 49┊   ┊  readAt: number | null,\n-┊ 50┊   ┊}\n-┊ 51┊   ┊\n-┊ 52┊   ┊const users: User[] = [\n-┊ 53┊   ┊  {\n-┊ 54┊   ┊    id: 1,\n+┊   ┊ 16┊export async function addSampleData(connection: Connection) {\n+┊   ┊ 17┊  const user1 = new User({\n ┊ 55┊ 18┊    username: 'ethan',\n ┊ 56┊ 19┊    password: '$2a$08$NO9tkFLCoSqX1c5wk3s7z.JfxaVMKA.m7zUDdDwEquo4rvzimQeJm', // 111\n ┊ 57┊ 20┊    name: 'Ethan Gonzalez',\n ┊ 58┊ 21┊    picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n ┊ 59┊ 22┊    phone: '+391234567890',\n-┊ 60┊   ┊  },\n-┊ 61┊   ┊  {\n-┊ 62┊   ┊    id: 2,\n+┊   ┊ 23┊  });\n+┊   ┊ 24┊  await connection.manager.save(user1);\n+┊   ┊ 25┊\n+┊   ┊ 26┊  const user2 = new User({\n ┊ 63┊ 27┊    username: 'bryan',\n ┊ 64┊ 28┊    password: '$2a$08$xE4FuCi/ifxjL2S8CzKAmuKLwv18ktksSN.F3XYEnpmcKtpbpeZgO', // 222\n ┊ 65┊ 29┊    name: 'Bryan Wallace',\n ┊ 66┊ 30┊    picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n ┊ 67┊ 31┊    phone: '+391234567891',\n-┊ 68┊   ┊  },\n-┊ 69┊   ┊  {\n-┊ 70┊   ┊    id: 3,\n+┊   ┊ 32┊  });\n+┊   ┊ 33┊  await connection.manager.save(user2);\n+┊   ┊ 34┊\n+┊   ┊ 35┊  const user3 = new User({\n ┊ 71┊ 36┊    username: 'avery',\n ┊ 72┊ 37┊    password: '$2a$08$UHgH7J8G6z1mGQn2qx2kdeWv0jvgHItyAsL9hpEUI3KJmhVW5Q1d.', // 333\n ┊ 73┊ 38┊    name: 'Avery Stewart',\n ┊ 74┊ 39┊    picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n ┊ 75┊ 40┊    phone: '+391234567892',\n-┊ 76┊   ┊  },\n-┊ 77┊   ┊  {\n-┊ 78┊   ┊    id: 4,\n+┊   ┊ 41┊  });\n+┊   ┊ 42┊  await connection.manager.save(user3);\n+┊   ┊ 43┊\n+┊   ┊ 44┊  const user4 = new User({\n ┊ 79┊ 45┊    username: 'katie',\n ┊ 80┊ 46┊    password: '$2a$08$wR1k5Q3T9FC7fUgB7Gdb9Os/GV7dGBBf4PLlWT7HERMFhmFDt47xi', // 444\n ┊ 81┊ 47┊    name: 'Katie Peterson',\n ┊ 82┊ 48┊    picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n ┊ 83┊ 49┊    phone: '+391234567893',\n-┊ 84┊   ┊  },\n-┊ 85┊   ┊  {\n-┊ 86┊   ┊    id: 5,\n+┊   ┊ 50┊  });\n+┊   ┊ 51┊  await connection.manager.save(user4);\n+┊   ┊ 52┊\n+┊   ┊ 53┊  const user5 = new User({\n ┊ 87┊ 54┊    username: 'ray',\n ┊ 88┊ 55┊    password: '$2a$08$6.mbXqsDX82ZZ7q5d8Osb..JrGSsNp4R3IKj7mxgF6YGT0OmMw242', // 555\n ┊ 89┊ 56┊    name: 'Ray Edwards',\n ┊ 90┊ 57┊    picture: 'https://randomuser.me/api/portraits/thumb/men/3.jpg',\n ┊ 91┊ 58┊    phone: '+391234567894',\n-┊ 92┊   ┊  },\n-┊ 93┊   ┊  {\n-┊ 94┊   ┊    id: 6,\n+┊   ┊ 59┊  });\n+┊   ┊ 60┊  await connection.manager.save(user5);\n+┊   ┊ 61┊\n+┊   ┊ 62┊  const user6 = new User({\n ┊ 95┊ 63┊    username: 'niko',\n ┊ 96┊ 64┊    password: '$2a$08$fL5lZR.Rwf9FWWe8XwwlceiPBBim8n9aFtaem.INQhiKT4.Ux3Uq.', // 666\n ┊ 97┊ 65┊    name: 'Niccolò Belli',\n ┊ 98┊ 66┊    picture: 'https://randomuser.me/api/portraits/thumb/men/4.jpg',\n ┊ 99┊ 67┊    phone: '+391234567895',\n-┊100┊   ┊  },\n-┊101┊   ┊  {\n-┊102┊   ┊    id: 7,\n+┊   ┊ 68┊  });\n+┊   ┊ 69┊  await connection.manager.save(user6);\n+┊   ┊ 70┊\n+┊   ┊ 71┊  const user7 = new User({\n ┊103┊ 72┊    username: 'mario',\n ┊104┊ 73┊    password: '$2a$08$nDHDmWcVxDnH5DDT3HMMC.psqcnu6wBiOgkmJUy9IH..qxa3R6YrO', // 777\n ┊105┊ 74┊    name: 'Mario Rossi',\n ┊106┊ 75┊    picture: 'https://randomuser.me/api/portraits/thumb/men/5.jpg',\n ┊107┊ 76┊    phone: '+391234567896',\n-┊108┊   ┊  },\n-┊109┊   ┊];\n+┊   ┊ 77┊  });\n+┊   ┊ 78┊  await connection.manager.save(user7);\n+┊   ┊ 79┊\n+┊   ┊ 80┊\n ┊110┊ 81┊\n-┊111┊   ┊const chats: Chat[] = [\n-┊112┊   ┊  {\n-┊113┊   ┊    id: 1,\n-┊114┊   ┊    name: null,\n-┊115┊   ┊    picture: null,\n-┊116┊   ┊    allTimeMemberIds: [1, 3],\n-┊117┊   ┊    listingMemberIds: [1, 3],\n-┊118┊   ┊    adminIds: null,\n-┊119┊   ┊    ownerId: null,\n+┊   ┊ 82┊\n+┊   ┊ 83┊  await connection.manager.save(new Chat({\n+┊   ┊ 84┊    allTimeMembers: [user1, user3],\n+┊   ┊ 85┊    listingMembers: [user1, user3],\n ┊120┊ 86┊    messages: [\n-┊121┊   ┊      {\n-┊122┊   ┊        id: 1,\n-┊123┊   ┊        chatId: 1,\n-┊124┊   ┊        senderId: 1,\n+┊   ┊ 87┊      new Message({\n+┊   ┊ 88┊        sender: user1,\n ┊125┊ 89┊        content: 'You on your way?',\n-┊126┊   ┊        createdAt: moment().subtract(1, 'hours').unix(),\n+┊   ┊ 90┊        createdAt: moment().subtract(1, 'hours').toDate(),\n ┊127┊ 91┊        type: MessageType.TEXT,\n+┊   ┊ 92┊        holders: [user1, user3],\n ┊128┊ 93┊        recipients: [\n-┊129┊   ┊          {\n-┊130┊   ┊            userId: 3,\n-┊131┊   ┊            messageId: 1,\n-┊132┊   ┊            chatId: 1,\n-┊133┊   ┊            receivedAt: null,\n-┊134┊   ┊            readAt: null,\n-┊135┊   ┊          },\n+┊   ┊ 94┊          new Recipient({\n+┊   ┊ 95┊            user: user3,\n+┊   ┊ 96┊          }),\n ┊136┊ 97┊        ],\n-┊137┊   ┊        holderIds: [1, 3],\n-┊138┊   ┊      },\n-┊139┊   ┊      {\n-┊140┊   ┊        id: 2,\n-┊141┊   ┊        chatId: 1,\n-┊142┊   ┊        senderId: 3,\n+┊   ┊ 98┊      }),\n+┊   ┊ 99┊      new Message({\n+┊   ┊100┊        sender: user3,\n ┊143┊101┊        content: 'Yep!',\n-┊144┊   ┊        createdAt: moment().subtract(1, 'hours').add(5, 'minutes').unix(),\n+┊   ┊102┊        createdAt: moment().subtract(1, 'hours').add(5, 'minutes').toDate(),\n ┊145┊103┊        type: MessageType.TEXT,\n+┊   ┊104┊        holders: [user1, user3],\n ┊146┊105┊        recipients: [\n-┊147┊   ┊          {\n-┊148┊   ┊            userId: 1,\n-┊149┊   ┊            messageId: 2,\n-┊150┊   ┊            chatId: 1,\n-┊151┊   ┊            receivedAt: null,\n-┊152┊   ┊            readAt: null,\n-┊153┊   ┊          },\n+┊   ┊106┊          new Recipient({\n+┊   ┊107┊            user: user1,\n+┊   ┊108┊          }),\n ┊154┊109┊        ],\n-┊155┊   ┊        holderIds: [3, 1],\n-┊156┊   ┊      },\n+┊   ┊110┊      }),\n ┊157┊111┊    ],\n-┊158┊   ┊  },\n-┊159┊   ┊  {\n-┊160┊   ┊    id: 2,\n-┊161┊   ┊    name: null,\n-┊162┊   ┊    picture: null,\n-┊163┊   ┊    allTimeMemberIds: [1, 4],\n-┊164┊   ┊    listingMemberIds: [1, 4],\n-┊165┊   ┊    adminIds: null,\n-┊166┊   ┊    ownerId: null,\n+┊   ┊112┊  }));\n+┊   ┊113┊\n+┊   ┊114┊  await connection.manager.save(new Chat({\n+┊   ┊115┊    allTimeMembers: [user1, user4],\n+┊   ┊116┊    listingMembers: [user1, user4],\n ┊167┊117┊    messages: [\n-┊168┊   ┊      {\n-┊169┊   ┊        id: 1,\n-┊170┊   ┊        chatId: 2,\n-┊171┊   ┊        senderId: 1,\n+┊   ┊118┊      new Message({\n+┊   ┊119┊        sender: user1,\n ┊172┊120┊        content: 'Hey, it\\'s me',\n-┊173┊   ┊        createdAt: moment().subtract(2, 'hours').unix(),\n+┊   ┊121┊        createdAt: moment().subtract(2, 'hours').toDate(),\n ┊174┊122┊        type: MessageType.TEXT,\n+┊   ┊123┊        holders: [user1, user4],\n ┊175┊124┊        recipients: [\n-┊176┊   ┊          {\n-┊177┊   ┊            userId: 4,\n-┊178┊   ┊            messageId: 1,\n-┊179┊   ┊            chatId: 2,\n-┊180┊   ┊            receivedAt: null,\n-┊181┊   ┊            readAt: null,\n-┊182┊   ┊          },\n+┊   ┊125┊          new Recipient({\n+┊   ┊126┊            user: user4,\n+┊   ┊127┊          }),\n ┊183┊128┊        ],\n-┊184┊   ┊        holderIds: [1, 4],\n-┊185┊   ┊      },\n+┊   ┊129┊      }),\n ┊186┊130┊    ],\n-┊187┊   ┊  },\n-┊188┊   ┊  {\n-┊189┊   ┊    id: 3,\n-┊190┊   ┊    name: null,\n-┊191┊   ┊    picture: null,\n-┊192┊   ┊    allTimeMemberIds: [1, 5],\n-┊193┊   ┊    listingMemberIds: [1, 5],\n-┊194┊   ┊    adminIds: null,\n-┊195┊   ┊    ownerId: null,\n+┊   ┊131┊  }));\n+┊   ┊132┊\n+┊   ┊133┊  await connection.manager.save(new Chat({\n+┊   ┊134┊    allTimeMembers: [user1, user5],\n+┊   ┊135┊    listingMembers: [user1, user5],\n ┊196┊136┊    messages: [\n-┊197┊   ┊      {\n-┊198┊   ┊        id: 1,\n-┊199┊   ┊        chatId: 3,\n-┊200┊   ┊        senderId: 1,\n+┊   ┊137┊      new Message({\n+┊   ┊138┊        sender: user1,\n ┊201┊139┊        content: 'I should buy a boat',\n-┊202┊   ┊        createdAt: moment().subtract(1, 'days').unix(),\n+┊   ┊140┊        createdAt: moment().subtract(1, 'days').toDate(),\n ┊203┊141┊        type: MessageType.TEXT,\n+┊   ┊142┊        holders: [user1, user5],\n ┊204┊143┊        recipients: [\n-┊205┊   ┊          {\n-┊206┊   ┊            userId: 5,\n-┊207┊   ┊            messageId: 1,\n-┊208┊   ┊            chatId: 3,\n-┊209┊   ┊            receivedAt: null,\n-┊210┊   ┊            readAt: null,\n-┊211┊   ┊          },\n+┊   ┊144┊          new Recipient({\n+┊   ┊145┊            user: user5,\n+┊   ┊146┊          }),\n ┊212┊147┊        ],\n-┊213┊   ┊        holderIds: [1, 5],\n-┊214┊   ┊      },\n-┊215┊   ┊      {\n-┊216┊   ┊        id: 2,\n-┊217┊   ┊        chatId: 3,\n-┊218┊   ┊        senderId: 1,\n+┊   ┊148┊      }),\n+┊   ┊149┊      new Message({\n+┊   ┊150┊        sender: user1,\n ┊219┊151┊        content: 'You still there?',\n-┊220┊   ┊        createdAt: moment().subtract(1, 'days').add(16, 'hours').unix(),\n+┊   ┊152┊        createdAt: moment().subtract(1, 'days').add(16, 'hours').toDate(),\n ┊221┊153┊        type: MessageType.TEXT,\n+┊   ┊154┊        holders: [user1, user5],\n ┊222┊155┊        recipients: [\n-┊223┊   ┊          {\n-┊224┊   ┊            userId: 5,\n-┊225┊   ┊            messageId: 2,\n-┊226┊   ┊            chatId: 3,\n-┊227┊   ┊            receivedAt: null,\n-┊228┊   ┊            readAt: null,\n-┊229┊   ┊          },\n+┊   ┊156┊          new Recipient({\n+┊   ┊157┊            user: user5,\n+┊   ┊158┊          }),\n ┊230┊159┊        ],\n-┊231┊   ┊        holderIds: [1, 5],\n-┊232┊   ┊      },\n+┊   ┊160┊      }),\n ┊233┊161┊    ],\n-┊234┊   ┊  },\n-┊235┊   ┊  {\n-┊236┊   ┊    id: 4,\n-┊237┊   ┊    name: null,\n-┊238┊   ┊    picture: null,\n-┊239┊   ┊    allTimeMemberIds: [3, 4],\n-┊240┊   ┊    listingMemberIds: [3, 4],\n-┊241┊   ┊    adminIds: null,\n-┊242┊   ┊    ownerId: null,\n+┊   ┊162┊  }));\n+┊   ┊163┊\n+┊   ┊164┊  await connection.manager.save(new Chat({\n+┊   ┊165┊    allTimeMembers: [user3, user4],\n+┊   ┊166┊    listingMembers: [user3, user4],\n ┊243┊167┊    messages: [\n-┊244┊   ┊      {\n-┊245┊   ┊        id: 1,\n-┊246┊   ┊        chatId: 4,\n-┊247┊   ┊        senderId: 3,\n+┊   ┊168┊      new Message({\n+┊   ┊169┊        sender: user3,\n ┊248┊170┊        content: 'Look at my mukluks!',\n-┊249┊   ┊        createdAt: moment().subtract(4, 'days').unix(),\n+┊   ┊171┊        createdAt: moment().subtract(4, 'days').toDate(),\n ┊250┊172┊        type: MessageType.TEXT,\n+┊   ┊173┊        holders: [user3, user4],\n ┊251┊174┊        recipients: [\n-┊252┊   ┊          {\n-┊253┊   ┊            userId: 4,\n-┊254┊   ┊            messageId: 1,\n-┊255┊   ┊            chatId: 4,\n-┊256┊   ┊            receivedAt: null,\n-┊257┊   ┊            readAt: null,\n-┊258┊   ┊          },\n+┊   ┊175┊          new Recipient({\n+┊   ┊176┊            user: user4,\n+┊   ┊177┊          }),\n ┊259┊178┊        ],\n-┊260┊   ┊        holderIds: [3, 4],\n-┊261┊   ┊      },\n+┊   ┊179┊      }),\n ┊262┊180┊    ],\n-┊263┊   ┊  },\n-┊264┊   ┊  {\n-┊265┊   ┊    id: 5,\n-┊266┊   ┊    name: null,\n-┊267┊   ┊    picture: null,\n-┊268┊   ┊    allTimeMemberIds: [2, 5],\n-┊269┊   ┊    listingMemberIds: [2, 5],\n-┊270┊   ┊    adminIds: null,\n-┊271┊   ┊    ownerId: null,\n+┊   ┊181┊  }));\n+┊   ┊182┊\n+┊   ┊183┊  await connection.manager.save(new Chat({\n+┊   ┊184┊    allTimeMembers: [user2, user5],\n+┊   ┊185┊    listingMembers: [user2, user5],\n ┊272┊186┊    messages: [\n-┊273┊   ┊      {\n-┊274┊   ┊        id: 1,\n-┊275┊   ┊        chatId: 5,\n-┊276┊   ┊        senderId: 2,\n+┊   ┊187┊      new Message({\n+┊   ┊188┊        sender: user2,\n ┊277┊189┊        content: 'This is wicked good ice cream.',\n-┊278┊   ┊        createdAt: moment().subtract(2, 'weeks').unix(),\n+┊   ┊190┊        createdAt: moment().subtract(2, 'weeks').toDate(),\n ┊279┊191┊        type: MessageType.TEXT,\n+┊   ┊192┊        holders: [user2, user5],\n ┊280┊193┊        recipients: [\n-┊281┊   ┊          {\n-┊282┊   ┊            userId: 5,\n-┊283┊   ┊            messageId: 1,\n-┊284┊   ┊            chatId: 5,\n-┊285┊   ┊            receivedAt: null,\n-┊286┊   ┊            readAt: null,\n-┊287┊   ┊          },\n+┊   ┊194┊          new Recipient({\n+┊   ┊195┊            user: user5,\n+┊   ┊196┊          }),\n ┊288┊197┊        ],\n-┊289┊   ┊        holderIds: [2, 5],\n-┊290┊   ┊      },\n-┊291┊   ┊      {\n-┊292┊   ┊        id: 2,\n-┊293┊   ┊        chatId: 6,\n-┊294┊   ┊        senderId: 5,\n+┊   ┊198┊      }),\n+┊   ┊199┊      new Message({\n+┊   ┊200┊        sender: user5,\n ┊295┊201┊        content: 'Love it!',\n-┊296┊   ┊        createdAt: moment().subtract(2, 'weeks').add(10, 'minutes').unix(),\n+┊   ┊202┊        createdAt: moment().subtract(2, 'weeks').add(10, 'minutes').toDate(),\n ┊297┊203┊        type: MessageType.TEXT,\n+┊   ┊204┊        holders: [user2, user5],\n ┊298┊205┊        recipients: [\n-┊299┊   ┊          {\n-┊300┊   ┊            userId: 2,\n-┊301┊   ┊            messageId: 2,\n-┊302┊   ┊            chatId: 5,\n-┊303┊   ┊            receivedAt: null,\n-┊304┊   ┊            readAt: null,\n-┊305┊   ┊          },\n+┊   ┊206┊          new Recipient({\n+┊   ┊207┊            user: user2,\n+┊   ┊208┊          }),\n ┊306┊209┊        ],\n-┊307┊   ┊        holderIds: [5, 2],\n-┊308┊   ┊      },\n+┊   ┊210┊      }),\n ┊309┊211┊    ],\n-┊310┊   ┊  },\n-┊311┊   ┊  {\n-┊312┊   ┊    id: 6,\n-┊313┊   ┊    name: null,\n-┊314┊   ┊    picture: null,\n-┊315┊   ┊    allTimeMemberIds: [1, 6],\n-┊316┊   ┊    listingMemberIds: [1],\n-┊317┊   ┊    adminIds: null,\n-┊318┊   ┊    ownerId: null,\n-┊319┊   ┊    messages: [],\n-┊320┊   ┊  },\n-┊321┊   ┊  {\n-┊322┊   ┊    id: 7,\n-┊323┊   ┊    name: null,\n-┊324┊   ┊    picture: null,\n-┊325┊   ┊    allTimeMemberIds: [2, 1],\n-┊326┊   ┊    listingMemberIds: [2],\n-┊327┊   ┊    adminIds: null,\n-┊328┊   ┊    ownerId: null,\n-┊329┊   ┊    messages: [],\n-┊330┊   ┊  },\n-┊331┊   ┊  {\n-┊332┊   ┊    id: 8,\n-┊333┊   ┊    name: 'A user 0 group',\n+┊   ┊212┊  }));\n+┊   ┊213┊\n+┊   ┊214┊  await connection.manager.save(new Chat({\n+┊   ┊215┊    allTimeMembers: [user1, user6],\n+┊   ┊216┊    listingMembers: [user1],\n+┊   ┊217┊  }));\n+┊   ┊218┊\n+┊   ┊219┊  await connection.manager.save(new Chat({\n+┊   ┊220┊    allTimeMembers: [user2, user1],\n+┊   ┊221┊    listingMembers: [user2],\n+┊   ┊222┊  }));\n+┊   ┊223┊\n+┊   ┊224┊  await connection.manager.save(new Chat({\n+┊   ┊225┊    name: 'Ethan\\'s group',\n ┊334┊226┊    picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n-┊335┊   ┊    allTimeMemberIds: [1, 3, 4, 6],\n-┊336┊   ┊    listingMemberIds: [1, 3, 4, 6],\n-┊337┊   ┊    actualGroupMemberIds: [1, 4, 6],\n-┊338┊   ┊    adminIds: [1, 6],\n-┊339┊   ┊    ownerId: 1,\n+┊   ┊227┊    allTimeMembers: [user1, user3, user4, user6],\n+┊   ┊228┊    listingMembers: [user1, user3, user4, user6],\n+┊   ┊229┊    actualGroupMembers: [user1, user4, user6],\n+┊   ┊230┊    admins: [user1, user6],\n+┊   ┊231┊    owner: user1,\n ┊340┊232┊    messages: [\n-┊341┊   ┊      {\n-┊342┊   ┊        id: 1,\n-┊343┊   ┊        chatId: 8,\n-┊344┊   ┊        senderId: 1,\n+┊   ┊233┊      new Message({\n+┊   ┊234┊        sender: user1,\n ┊345┊235┊        content: 'I made a group',\n-┊346┊   ┊        createdAt: moment().subtract(2, 'weeks').unix(),\n+┊   ┊236┊        createdAt: moment().subtract(2, 'weeks').toDate(),\n ┊347┊237┊        type: MessageType.TEXT,\n+┊   ┊238┊        holders: [user1, user3, user4, user6],\n ┊348┊239┊        recipients: [\n-┊349┊   ┊          {\n-┊350┊   ┊            userId: 3,\n-┊351┊   ┊            messageId: 1,\n-┊352┊   ┊            chatId: 8,\n-┊353┊   ┊            receivedAt: null,\n-┊354┊   ┊            readAt: null,\n-┊355┊   ┊          },\n-┊356┊   ┊          {\n-┊357┊   ┊            userId: 4,\n-┊358┊   ┊            messageId: 1,\n-┊359┊   ┊            chatId: 8,\n-┊360┊   ┊            receivedAt: moment().subtract(2, 'weeks').add(1, 'minutes').unix(),\n-┊361┊   ┊            readAt: moment().subtract(2, 'weeks').add(5, 'minutes').unix(),\n-┊362┊   ┊          },\n-┊363┊   ┊          {\n-┊364┊   ┊            userId: 6,\n-┊365┊   ┊            messageId: 1,\n-┊366┊   ┊            chatId: 8,\n-┊367┊   ┊            receivedAt: null,\n-┊368┊   ┊            readAt: null,\n-┊369┊   ┊          },\n+┊   ┊240┊          new Recipient({\n+┊   ┊241┊            user: user3,\n+┊   ┊242┊          }),\n+┊   ┊243┊          new Recipient({\n+┊   ┊244┊            user: user4,\n+┊   ┊245┊          }),\n+┊   ┊246┊          new Recipient({\n+┊   ┊247┊            user: user6,\n+┊   ┊248┊          }),\n ┊370┊249┊        ],\n-┊371┊   ┊        holderIds: [1, 3, 4, 6],\n-┊372┊   ┊      },\n-┊373┊   ┊      {\n-┊374┊   ┊        id: 2,\n-┊375┊   ┊        chatId: 8,\n-┊376┊   ┊        senderId: 1,\n-┊377┊   ┊        content: 'Ops, user 3 was not supposed to be here',\n-┊378┊   ┊        createdAt: moment().subtract(2, 'weeks').add(2, 'minutes').unix(),\n+┊   ┊250┊      }),\n+┊   ┊251┊      new Message({\n+┊   ┊252┊        sender: user1,\n+┊   ┊253┊        content: 'Ops, Avery was not supposed to be here',\n+┊   ┊254┊        createdAt: moment().subtract(2, 'weeks').add(2, 'minutes').toDate(),\n ┊379┊255┊        type: MessageType.TEXT,\n+┊   ┊256┊        holders: [user1, user4, user6],\n ┊380┊257┊        recipients: [\n-┊381┊   ┊          {\n-┊382┊   ┊            userId: 4,\n-┊383┊   ┊            messageId: 2,\n-┊384┊   ┊            chatId: 8,\n-┊385┊   ┊            receivedAt: moment().subtract(2, 'weeks').add(3, 'minutes').unix(),\n-┊386┊   ┊            readAt: moment().subtract(2, 'weeks').add(5, 'minutes').unix(),\n-┊387┊   ┊          },\n-┊388┊   ┊          {\n-┊389┊   ┊            userId: 6,\n-┊390┊   ┊            messageId: 2,\n-┊391┊   ┊            chatId: 8,\n-┊392┊   ┊            receivedAt: null,\n-┊393┊   ┊            readAt: null,\n-┊394┊   ┊          },\n+┊   ┊258┊          new Recipient({\n+┊   ┊259┊            user: user4,\n+┊   ┊260┊          }),\n+┊   ┊261┊          new Recipient({\n+┊   ┊262┊            user: user6,\n+┊   ┊263┊          }),\n ┊395┊264┊        ],\n-┊396┊   ┊        holderIds: [1, 4, 6],\n-┊397┊   ┊      },\n-┊398┊   ┊      {\n-┊399┊   ┊        id: 3,\n-┊400┊   ┊        chatId: 8,\n-┊401┊   ┊        senderId: 4,\n+┊   ┊265┊      }),\n+┊   ┊266┊      new Message({\n+┊   ┊267┊        sender: user4,\n ┊402┊268┊        content: 'Awesome!',\n-┊403┊   ┊        createdAt: moment().subtract(2, 'weeks').add(10, 'minutes').unix(),\n+┊   ┊269┊        createdAt: moment().subtract(2, 'weeks').add(10, 'minutes').toDate(),\n ┊404┊270┊        type: MessageType.TEXT,\n+┊   ┊271┊        holders: [user1, user4, user6],\n ┊405┊272┊        recipients: [\n-┊406┊   ┊          {\n-┊407┊   ┊            userId: 1,\n-┊408┊   ┊            messageId: 3,\n-┊409┊   ┊            chatId: 8,\n-┊410┊   ┊            receivedAt: null,\n-┊411┊   ┊            readAt: null,\n-┊412┊   ┊          },\n-┊413┊   ┊          {\n-┊414┊   ┊            userId: 6,\n-┊415┊   ┊            messageId: 3,\n-┊416┊   ┊            chatId: 8,\n-┊417┊   ┊            receivedAt: null,\n-┊418┊   ┊            readAt: null,\n-┊419┊   ┊          },\n+┊   ┊273┊          new Recipient({\n+┊   ┊274┊            user: user1,\n+┊   ┊275┊          }),\n+┊   ┊276┊          new Recipient({\n+┊   ┊277┊            user: user6,\n+┊   ┊278┊          }),\n ┊420┊279┊        ],\n-┊421┊   ┊        holderIds: [1, 4, 6],\n-┊422┊   ┊      },\n+┊   ┊280┊      }),\n ┊423┊281┊    ],\n-┊424┊   ┊  },\n-┊425┊   ┊  {\n-┊426┊   ┊    id: 9,\n-┊427┊   ┊    name: 'A user 5 group',\n-┊428┊   ┊    picture: null,\n-┊429┊   ┊    allTimeMemberIds: [6, 3],\n-┊430┊   ┊    listingMemberIds: [6, 3],\n-┊431┊   ┊    actualGroupMemberIds: [6, 3],\n-┊432┊   ┊    adminIds: [6],\n-┊433┊   ┊    ownerId: 6,\n-┊434┊   ┊    messages: [],\n-┊435┊   ┊  },\n-┊436┊   ┊];\n+┊   ┊282┊  }));\n ┊437┊283┊\n-┊438┊   ┊export const db = {users, chats};\n+┊   ┊284┊  await connection.manager.save(new Chat({\n+┊   ┊285┊    name: 'Ray\\'s group',\n+┊   ┊286┊    allTimeMembers: [user3, user6],\n+┊   ┊287┊    listingMembers: [user3, user6],\n+┊   ┊288┊    actualGroupMembers: [user3, user6],\n+┊   ┊289┊    admins: [user6],\n+┊   ┊290┊    owner: user6,\n+┊   ┊291┊  }));\n+┊   ┊292┊}\n```\n\n[}]: #\n\nIt's time to deal with resolvers:\n\n[{]: <helper> (diffStep \"6.1\" files=\"schema/resolvers.ts\" module=\"server\")\n\n#### [Step 6.1: TypeORM with PostgreSQL](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/00c4cab)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,91 +1,127 @@\n ┊  1┊  1┊import { PubSub, withFilter, IResolvers } from 'apollo-server-express';\n-┊  2┊   ┊import { Chat, db, Message, MessageType, Recipient, User } from \"../db\";\n+┊   ┊  2┊import { MessageType } from \"../db\";\n ┊  3┊  3┊import {\n ┊  4┊  4┊  AddChatMutationArgs, AddGroupMutationArgs, AddMessageMutationArgs, ChatQueryArgs, MessageAddedSubscriptionArgs,\n ┊  5┊  5┊  RemoveChatMutationArgs, RemoveMessagesMutationArgs\n ┊  6┊  6┊} from \"../types\";\n ┊  7┊  7┊import * as moment from \"moment\";\n-┊  8┊   ┊\n-┊  9┊   ┊let users = db.users;\n-┊ 10┊   ┊let chats = db.chats;\n+┊   ┊  8┊import { User } from \"../entity/User\";\n+┊   ┊  9┊import { Chat } from \"../entity/Chat\";\n+┊   ┊ 10┊import { Message } from \"../entity/Message\";\n+┊   ┊ 11┊import { Recipient } from \"../entity/Recipient\";\n+┊   ┊ 12┊import { Connection } from \"typeorm\";\n ┊ 11┊ 13┊\n ┊ 12┊ 14┊export const pubsub = new PubSub();\n ┊ 13┊ 15┊\n ┊ 14┊ 16┊export const resolvers: IResolvers = {\n ┊ 15┊ 17┊  Query: {\n ┊ 16┊ 18┊    // Show all users for the moment.\n-┊ 17┊   ┊    users: (obj: any, args: any, {user: currentUser}: {user: User}): User[] => users.filter(user => user.id !== currentUser.id),\n-┊ 18┊   ┊    chats: (obj: any, args: any, {user: currentUser}: {user: User}): Chat[] => chats.filter(chat => chat.listingMemberIds.includes(currentUser.id)),\n-┊ 19┊   ┊    chat: (obj: any, {chatId}: ChatQueryArgs): Chat | null => chats.find(chat => chat.id === Number(chatId)) || null,\n+┊   ┊ 19┊    users: async (obj: any, args: any, {user: currentUser, connection}: { user: User, connection: Connection }): Promise<User[]> => {\n+┊   ┊ 20┊      return await connection\n+┊   ┊ 21┊        .createQueryBuilder(User, \"user\")\n+┊   ┊ 22┊        .where('user.id != :id', {id: currentUser.id})\n+┊   ┊ 23┊        .getMany();\n+┊   ┊ 24┊    },\n+┊   ┊ 25┊    chats: async (obj: any, args: any, {user: currentUser, connection}: { user: User, connection: Connection }): Promise<any[]> => {\n+┊   ┊ 26┊      return await connection\n+┊   ┊ 27┊        .createQueryBuilder(Chat, \"chat\")\n+┊   ┊ 28┊        .leftJoin('chat.listingMembers', 'listingMembers')\n+┊   ┊ 29┊        .where('listingMembers.id = :id', {id: currentUser.id})\n+┊   ┊ 30┊        .getMany();\n+┊   ┊ 31┊    },\n+┊   ┊ 32┊    chat: async (obj: any, {chatId}: ChatQueryArgs, {connection}: { user: User, connection: Connection }): Promise<any> => {\n+┊   ┊ 33┊      return await connection\n+┊   ┊ 34┊        .createQueryBuilder(Chat, \"chat\")\n+┊   ┊ 35┊        .whereInIds(chatId)\n+┊   ┊ 36┊        .getOne();\n+┊   ┊ 37┊    },\n ┊ 20┊ 38┊  },\n ┊ 21┊ 39┊  Mutation: {\n-┊ 22┊   ┊    addChat: (obj: any, {recipientId}: AddChatMutationArgs, {user: currentUser}: {user: User}): Chat => {\n-┊ 23┊   ┊      if (!users.find(user => user.id === Number(recipientId))) {\n+┊   ┊ 40┊    addChat: async (obj: any, {recipientId}: AddChatMutationArgs, {user: currentUser, connection}: { user: User, connection: Connection }): Promise<Chat | null> => {\n+┊   ┊ 41┊      const recipient = await connection\n+┊   ┊ 42┊        .createQueryBuilder(User, \"user\")\n+┊   ┊ 43┊        .whereInIds(recipientId)\n+┊   ┊ 44┊        .getOne();\n+┊   ┊ 45┊\n+┊   ┊ 46┊      if (!recipient) {\n ┊ 24┊ 47┊        throw new Error(`Recipient ${recipientId} doesn't exist.`);\n ┊ 25┊ 48┊      }\n ┊ 26┊ 49┊\n-┊ 27┊   ┊      const chat = chats.find(chat => !chat.name && chat.allTimeMemberIds.includes(currentUser.id) && chat.allTimeMemberIds.includes(Number(recipientId)));\n+┊   ┊ 50┊      let chat = await connection\n+┊   ┊ 51┊        .createQueryBuilder(Chat, \"chat\")\n+┊   ┊ 52┊        .where('chat.name IS NULL')\n+┊   ┊ 53┊        .innerJoin('chat.allTimeMembers', 'allTimeMembers1', 'allTimeMembers1.id = :currentUserId', {currentUserId: currentUser.id})\n+┊   ┊ 54┊        .innerJoin('chat.allTimeMembers', 'allTimeMembers2', 'allTimeMembers2.id = :recipientId', {recipientId})\n+┊   ┊ 55┊        .innerJoinAndSelect('chat.listingMembers', 'listingMembers')\n+┊   ┊ 56┊        .getOne();\n+┊   ┊ 57┊\n ┊ 28┊ 58┊      if (chat) {\n-┊ 29┊   ┊        // Chat already exists. Both users are already in the allTimeMemberIds array\n-┊ 30┊   ┊        const chatId = chat.id;\n-┊ 31┊   ┊        if (!chat.listingMemberIds.includes(currentUser.id)) {\n+┊   ┊ 59┊        // Chat already exists. Both users are already in the userIds array\n+┊   ┊ 60┊        const listingMembers = await connection\n+┊   ┊ 61┊          .createQueryBuilder(User, \"user\")\n+┊   ┊ 62┊          .innerJoin('user.listingMemberChats', 'listingMemberChats', 'listingMemberChats.id = :chatId', {chatId: chat.id})\n+┊   ┊ 63┊          .getMany();\n+┊   ┊ 64┊\n+┊   ┊ 65┊        if (!listingMembers.find(user => user.id === currentUser.id)) {\n ┊ 32┊ 66┊          // The chat isn't listed for the current user. Add him to the memberIds\n-┊ 33┊   ┊          chat.listingMemberIds.push(currentUser.id);\n-┊ 34┊   ┊          chats.find(chat => chat.id === chatId)!.listingMemberIds.push(currentUser.id);\n-┊ 35┊   ┊          return chat;\n+┊   ┊ 67┊          chat.listingMembers.push(currentUser);\n+┊   ┊ 68┊          chat = await connection.getRepository(Chat).save(chat);\n+┊   ┊ 69┊\n+┊   ┊ 70┊          return chat || null;\n ┊ 36┊ 71┊        } else {\n ┊ 37┊ 72┊          throw new Error(`Chat already exists.`);\n ┊ 38┊ 73┊        }\n ┊ 39┊ 74┊      } else {\n ┊ 40┊ 75┊        // Create the chat\n-┊ 41┊   ┊        const id = (chats.length && chats[chats.length - 1].id + 1) || 1;\n-┊ 42┊   ┊        const chat: Chat = {\n-┊ 43┊   ┊          id,\n-┊ 44┊   ┊          name: null,\n-┊ 45┊   ┊          picture: null,\n-┊ 46┊   ┊          adminIds: null,\n-┊ 47┊   ┊          ownerId: null,\n-┊ 48┊   ┊          allTimeMemberIds: [currentUser.id, Number(recipientId)],\n+┊   ┊ 76┊        chat = await connection.getRepository(Chat).save(new Chat({\n+┊   ┊ 77┊          allTimeMembers: [currentUser, recipient],\n ┊ 49┊ 78┊          // Chat will not be listed to the other user until the first message gets written\n-┊ 50┊   ┊          listingMemberIds: [currentUser.id],\n-┊ 51┊   ┊          actualGroupMemberIds: null,\n-┊ 52┊   ┊          messages: [],\n-┊ 53┊   ┊        };\n-┊ 54┊   ┊        chats.push(chat);\n+┊   ┊ 79┊          listingMembers: [currentUser],\n+┊   ┊ 80┊        }));\n ┊ 55┊ 81┊\n-┊ 56┊   ┊        return chat;\n+┊   ┊ 82┊        return chat || null;\n ┊ 57┊ 83┊      }\n ┊ 58┊ 84┊    },\n-┊ 59┊   ┊    addGroup: (obj: any, {recipientIds, groupName}: AddGroupMutationArgs, {user: currentUser}: {user: User}): Chat => {\n-┊ 60┊   ┊      recipientIds.forEach(recipientId => {\n-┊ 61┊   ┊        if (!users.find(user => user.id === Number(recipientId))) {\n+┊   ┊ 85┊    addGroup: async (obj: any, {recipientIds, groupName}: AddGroupMutationArgs, {user: currentUser, connection}: { user: User, connection: Connection }): Promise<Chat | null> => {\n+┊   ┊ 86┊      let recipients: User[] = [];\n+┊   ┊ 87┊      for (let recipientId of recipientIds) {\n+┊   ┊ 88┊        const recipient = await connection\n+┊   ┊ 89┊          .createQueryBuilder(User, \"user\")\n+┊   ┊ 90┊          .whereInIds(recipientId)\n+┊   ┊ 91┊          .getOne();\n+┊   ┊ 92┊        if (!recipient) {\n ┊ 62┊ 93┊          throw new Error(`Recipient ${recipientId} doesn't exist.`);\n ┊ 63┊ 94┊        }\n-┊ 64┊   ┊      });\n+┊   ┊ 95┊        recipients.push(recipient);\n+┊   ┊ 96┊      }\n ┊ 65┊ 97┊\n-┊ 66┊   ┊      const id = (chats.length && chats[chats.length - 1].id + 1) || 1;\n-┊ 67┊   ┊      const chat: Chat = {\n-┊ 68┊   ┊        id,\n+┊   ┊ 98┊      const chat = await connection.getRepository(Chat).save(new Chat({\n ┊ 69┊ 99┊        name: groupName,\n-┊ 70┊   ┊        picture: null,\n-┊ 71┊   ┊        adminIds: [currentUser.id],\n-┊ 72┊   ┊        ownerId: currentUser.id,\n-┊ 73┊   ┊        allTimeMemberIds: [currentUser.id, ...recipientIds.map(id => Number(id))],\n-┊ 74┊   ┊        listingMemberIds: [currentUser.id, ...recipientIds.map(id => Number(id))],\n-┊ 75┊   ┊        actualGroupMemberIds: [currentUser.id, ...recipientIds.map(id => Number(id))],\n-┊ 76┊   ┊        messages: [],\n-┊ 77┊   ┊      };\n-┊ 78┊   ┊      chats.push(chat);\n+┊   ┊100┊        admins: [currentUser],\n+┊   ┊101┊        owner: currentUser,\n+┊   ┊102┊        allTimeMembers: [...recipients, currentUser],\n+┊   ┊103┊        listingMembers: [...recipients, currentUser],\n+┊   ┊104┊        actualGroupMembers: [...recipients, currentUser],\n+┊   ┊105┊      }));\n ┊ 79┊106┊\n ┊ 80┊107┊      pubsub.publish('chatAdded', {\n ┊ 81┊108┊        creatorId: currentUser.id,\n ┊ 82┊109┊        chatAdded: chat,\n ┊ 83┊110┊      });\n ┊ 84┊111┊\n-┊ 85┊   ┊      return chat;\n+┊   ┊112┊      return chat || null;\n ┊ 86┊113┊    },\n-┊ 87┊   ┊    removeChat: (obj: any, {chatId}: RemoveChatMutationArgs, {user: currentUser}: {user: User}): number => {\n-┊ 88┊   ┊      const chat = chats.find(chat => chat.id === Number(chatId));\n+┊   ┊114┊    removeChat: async (obj: any, {chatId}: RemoveChatMutationArgs, {user: currentUser, connection}: { user: User, connection: Connection }) => {\n+┊   ┊115┊      const chat = await connection\n+┊   ┊116┊        .createQueryBuilder(Chat, \"chat\")\n+┊   ┊117┊        .whereInIds(Number(chatId))\n+┊   ┊118┊        .innerJoinAndSelect('chat.listingMembers', 'listingMembers')\n+┊   ┊119┊        .leftJoinAndSelect('chat.actualGroupMembers', 'actualGroupMembers')\n+┊   ┊120┊        .leftJoinAndSelect('chat.admins', 'admins')\n+┊   ┊121┊        .leftJoinAndSelect('chat.owner', 'owner')\n+┊   ┊122┊        .leftJoinAndSelect('chat.messages', 'messages')\n+┊   ┊123┊        .leftJoinAndSelect('messages.holders', 'holders')\n+┊   ┊124┊        .getOne();\n ┊ 89┊125┊\n ┊ 90┊126┊      if (!chat) {\n ┊ 91┊127┊        throw new Error(`The chat ${chatId} doesn't exist.`);\n```\n```diff\n@@ -93,186 +129,188 @@\n ┊ 93┊129┊\n ┊ 94┊130┊      if (!chat.name) {\n ┊ 95┊131┊        // Chat\n-┊ 96┊   ┊        if (!chat.listingMemberIds.includes(currentUser.id)) {\n-┊ 97┊   ┊          throw new Error(`The user is not a member of the chat ${chatId}.`);\n+┊   ┊132┊        if (!chat.listingMembers.find(user => user.id === currentUser.id)) {\n+┊   ┊133┊          throw new Error(`The user is not a listing member of the chat ${chatId}.`);\n ┊ 98┊134┊        }\n ┊ 99┊135┊\n ┊100┊136┊        // Instead of chaining map and filter we can loop once using reduce\n-┊101┊   ┊        const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n-┊102┊   ┊          // Remove the current user from the message holders\n-┊103┊   ┊          message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser.id);\n+┊   ┊137┊        chat.messages = await chat.messages.reduce<Promise<Message[]>>(async (filtered$, message) => {\n+┊   ┊138┊          const filtered = await filtered$;\n ┊104┊139┊\n-┊105┊   ┊          if (message.holderIds.length !== 0) {\n+┊   ┊140┊          message.holders = message.holders.filter(user => user.id !== currentUser.id);\n+┊   ┊141┊\n+┊   ┊142┊          if (message.holders.length !== 0) {\n+┊   ┊143┊            // Remove the current user from the message holders\n+┊   ┊144┊            await connection.getRepository(Message).save(message);\n ┊106┊145┊            filtered.push(message);\n-┊107┊   ┊          } // else discard the message\n+┊   ┊146┊          } else {\n+┊   ┊147┊            // Simply remove the message\n+┊   ┊148┊            const recipients = await connection\n+┊   ┊149┊              .createQueryBuilder(Recipient, \"recipient\")\n+┊   ┊150┊              .innerJoinAndSelect('recipient.message', 'message', 'message.id = :messageId', {messageId: message.id})\n+┊   ┊151┊              .innerJoinAndSelect('recipient.user', 'user')\n+┊   ┊152┊              .getMany();\n+┊   ┊153┊            for (let recipient of recipients) {\n+┊   ┊154┊              await connection.getRepository(Recipient).remove(recipient);\n+┊   ┊155┊            }\n+┊   ┊156┊            await connection.getRepository(Message).remove(message);\n+┊   ┊157┊          }\n ┊108┊158┊\n ┊109┊159┊          return filtered;\n-┊110┊   ┊        }, []);\n+┊   ┊160┊        }, Promise.resolve([]));\n ┊111┊161┊\n ┊112┊162┊        // Remove the current user from who gets the chat listed. The chat will no longer appear in his list\n-┊113┊   ┊        const listingMemberIds = chat.listingMemberIds.filter(listingId => listingId !== currentUser.id);\n+┊   ┊163┊        chat.listingMembers = chat.listingMembers.filter(user => user.id !== currentUser.id);\n ┊114┊164┊\n ┊115┊165┊        // Check how many members are left\n-┊116┊   ┊        if (listingMemberIds.length === 0) {\n+┊   ┊166┊        if (chat.listingMembers.length === 0) {\n ┊117┊167┊          // Delete the chat\n-┊118┊   ┊          chats = chats.filter(chat => chat.id !== Number(chatId));\n+┊   ┊168┊          await connection.getRepository(Chat).remove(chat);\n ┊119┊169┊        } else {\n ┊120┊170┊          // Update the chat\n-┊121┊   ┊          chats = chats.map(chat => {\n-┊122┊   ┊            if (chat.id === Number(chatId)) {\n-┊123┊   ┊              chat = {...chat, listingMemberIds, messages};\n-┊124┊   ┊            }\n-┊125┊   ┊            return chat;\n-┊126┊   ┊          });\n+┊   ┊171┊          await connection.getRepository(Chat).save(chat);\n ┊127┊172┊        }\n-┊128┊   ┊        return Number(chatId);\n+┊   ┊173┊        return chatId;\n ┊129┊174┊      } else {\n ┊130┊175┊        // Group\n-┊131┊   ┊        if (chat.ownerId !== currentUser.id) {\n-┊132┊   ┊          throw new Error(`Group ${chatId} is not owned by the user.`);\n-┊133┊   ┊        }\n ┊134┊176┊\n ┊135┊177┊        // Instead of chaining map and filter we can loop once using reduce\n-┊136┊   ┊        const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n-┊137┊   ┊          // Remove the current user from the message holders\n-┊138┊   ┊          message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser.id);\n+┊   ┊178┊        chat.messages = await chat.messages.reduce<Promise<Message[]>>(async (filtered$, message) => {\n+┊   ┊179┊          const filtered = await filtered$;\n+┊   ┊180┊\n+┊   ┊181┊          message.holders = message.holders.filter(user => user.id !== currentUser.id);\n ┊139┊182┊\n-┊140┊   ┊          if (message.holderIds.length !== 0) {\n+┊   ┊183┊          if (message.holders.length !== 0) {\n+┊   ┊184┊            // Remove the current user from the message holders\n+┊   ┊185┊            await connection.getRepository(Message).save(message);\n ┊141┊186┊            filtered.push(message);\n-┊142┊   ┊          } // else discard the message\n+┊   ┊187┊          } else {\n+┊   ┊188┊            // Simply remove the message\n+┊   ┊189┊            const recipients = await connection\n+┊   ┊190┊              .createQueryBuilder(Recipient, \"recipient\")\n+┊   ┊191┊              .innerJoinAndSelect('recipient.message', 'message', 'message.id = :messageId', {messageId: message.id})\n+┊   ┊192┊              .innerJoinAndSelect('recipient.user', 'user')\n+┊   ┊193┊              .getMany();\n+┊   ┊194┊            for (let recipient of recipients) {\n+┊   ┊195┊              await connection.getRepository(Recipient).remove(recipient);\n+┊   ┊196┊            }\n+┊   ┊197┊            await connection.getRepository(Message).remove(message);\n+┊   ┊198┊          }\n ┊143┊199┊\n ┊144┊200┊          return filtered;\n-┊145┊   ┊        }, []);\n+┊   ┊201┊        }, Promise.resolve([]));\n ┊146┊202┊\n ┊147┊203┊        // Remove the current user from who gets the group listed. The group will no longer appear in his list\n-┊148┊   ┊        const listingMemberIds = chat.listingMemberIds.filter(listingId => listingId !== currentUser.id);\n+┊   ┊204┊        chat.listingMembers = chat.listingMembers.filter(user => user.id !== currentUser.id);\n ┊149┊205┊\n ┊150┊206┊        // Check how many members (including previous ones who can still access old messages) are left\n-┊151┊   ┊        if (listingMemberIds.length === 0) {\n+┊   ┊207┊        if (chat.listingMembers.length === 0) {\n ┊152┊208┊          // Remove the group\n-┊153┊   ┊          chats = chats.filter(chat => chat.id !== Number(chatId));\n+┊   ┊209┊          await connection.getRepository(Chat).remove(chat);\n ┊154┊210┊        } else {\n ┊155┊211┊          // Update the group\n ┊156┊212┊\n ┊157┊213┊          // Remove the current user from the chat members. He is no longer a member of the group\n-┊158┊   ┊          const actualGroupMemberIds = chat.actualGroupMemberIds!.filter(memberId => memberId !== currentUser.id);\n+┊   ┊214┊          chat.actualGroupMembers = chat.actualGroupMembers && chat.actualGroupMembers.filter(user => user.id !== currentUser.id);\n ┊159┊215┊          // Remove the current user from the chat admins\n-┊160┊   ┊          const adminIds = chat.adminIds!.filter(memberId => memberId !== currentUser.id);\n-┊161┊   ┊          // Set the owner id to be null. A null owner means the group is read-only\n-┊162┊   ┊          let ownerId: number | null = null;\n-┊163┊   ┊\n-┊164┊   ┊          // Check if there is any admin left\n-┊165┊   ┊          if (adminIds!.length) {\n-┊166┊   ┊            // Pick an admin as the new owner. The group is no longer read-only\n-┊167┊   ┊            ownerId = chat.adminIds![0];\n-┊168┊   ┊          }\n+┊   ┊216┊          chat.admins = chat.admins && chat.admins.filter(user => user.id !== currentUser.id);\n+┊   ┊217┊          // If there are no more admins left the group goes read only\n+┊   ┊218┊          chat.owner = chat.admins && chat.admins[0] || null; // A null owner means the group is read-only\n ┊169┊219┊\n-┊170┊   ┊          chats = chats.map(chat => {\n-┊171┊   ┊            if (chat.id === Number(chatId)) {\n-┊172┊   ┊              chat = {...chat, messages, listingMemberIds, actualGroupMemberIds, adminIds, ownerId};\n-┊173┊   ┊            }\n-┊174┊   ┊            return chat;\n-┊175┊   ┊          });\n+┊   ┊220┊          await connection.getRepository(Chat).save(chat);\n ┊176┊221┊        }\n-┊177┊   ┊        return Number(chatId);\n+┊   ┊222┊        return chatId;\n ┊178┊223┊      }\n ┊179┊224┊    },\n-┊180┊   ┊    addMessage: (obj: any, {chatId, content}: AddMessageMutationArgs, {user: currentUser}: {user: User}): Message => {\n+┊   ┊225┊    addMessage: async (obj: any, {chatId, content}: AddMessageMutationArgs, {user: currentUser, connection}: { user: User, connection: Connection }): Promise<Message | null> => {\n ┊181┊226┊      if (content === null || content === '') {\n ┊182┊227┊        throw new Error(`Cannot add empty or null messages.`);\n ┊183┊228┊      }\n ┊184┊229┊\n-┊185┊   ┊      let chat = chats.find(chat => chat.id === Number(chatId));\n+┊   ┊230┊      let chat = await connection\n+┊   ┊231┊        .createQueryBuilder(Chat, \"chat\")\n+┊   ┊232┊        .whereInIds(chatId)\n+┊   ┊233┊        .innerJoinAndSelect('chat.allTimeMembers', 'allTimeMembers')\n+┊   ┊234┊        .innerJoinAndSelect('chat.listingMembers', 'listingMembers')\n+┊   ┊235┊        .leftJoinAndSelect('chat.actualGroupMembers', 'actualGroupMembers')\n+┊   ┊236┊        .getOne();\n ┊186┊237┊\n ┊187┊238┊      if (!chat) {\n ┊188┊239┊        throw new Error(`Cannot find chat ${chatId}.`);\n ┊189┊240┊      }\n ┊190┊241┊\n-┊191┊   ┊      let holderIds = chat.listingMemberIds;\n+┊   ┊242┊      let holders: User[];\n ┊192┊243┊\n ┊193┊244┊      if (!chat.name) {\n ┊194┊245┊        // Chat\n-┊195┊   ┊        if (!chat.listingMemberIds.find(listingId => listingId === currentUser.id)) {\n+┊   ┊246┊        if (!chat.listingMembers.map(user => user.id).includes(currentUser.id)) {\n ┊196┊247┊          throw new Error(`The chat ${chatId} must be listed for the current user before adding a message.`);\n ┊197┊248┊        }\n ┊198┊249┊\n-┊199┊   ┊        const recipientId = chat.allTimeMemberIds.filter(userId => userId !== currentUser.id)[0];\n+┊   ┊250┊        const recipientUser = chat.allTimeMembers.find(user => user.id !== currentUser.id);\n ┊200┊251┊\n-┊201┊   ┊        if (!chat.listingMemberIds.find(listingId => listingId === recipientId)) {\n-┊202┊   ┊          // Chat is not listed for the recipient. Add him to the listingMemberIds\n-┊203┊   ┊          const listingMemberIds = chat.listingMemberIds.concat(recipientId);\n+┊   ┊252┊        if (!recipientUser) {\n+┊   ┊253┊          throw new Error(`Cannot find recipient user.`);\n+┊   ┊254┊        }\n ┊204┊255┊\n-┊205┊   ┊          chats = chats.map(chat => {\n-┊206┊   ┊            if (chat.id === Number(chatId)) {\n-┊207┊   ┊              chat = {...chat, listingMemberIds};\n-┊208┊   ┊            }\n-┊209┊   ┊            return chat;\n-┊210┊   ┊          });\n+┊   ┊256┊        if (!chat.listingMembers.find(user => user.id === recipientUser.id)) {\n+┊   ┊257┊          // Chat is not listed for the recipient. Add him to the listingIds\n+┊   ┊258┊          chat.listingMembers.push(recipientUser);\n ┊211┊259┊\n-┊212┊   ┊          holderIds = listingMemberIds;\n+┊   ┊260┊          await connection.getRepository(Chat).save(chat);\n ┊213┊261┊\n ┊214┊262┊          pubsub.publish('chatAdded', {\n ┊215┊263┊            creatorId: currentUser.id,\n ┊216┊264┊            chatAdded: chat,\n ┊217┊265┊          });\n ┊218┊266┊        }\n+┊   ┊267┊\n+┊   ┊268┊        holders = chat.listingMembers;\n ┊219┊269┊      } else {\n ┊220┊270┊        // Group\n-┊221┊   ┊        if (!chat.actualGroupMemberIds!.find(memberId => memberId === currentUser.id)) {\n+┊   ┊271┊        if (!chat.actualGroupMembers || !chat.actualGroupMembers.find(user => user.id === currentUser.id)) {\n ┊222┊272┊          throw new Error(`The user is not a member of the group ${chatId}. Cannot add message.`);\n ┊223┊273┊        }\n ┊224┊274┊\n-┊225┊   ┊        holderIds = chat.actualGroupMemberIds!;\n+┊   ┊275┊        holders = chat.actualGroupMembers;\n ┊226┊276┊      }\n ┊227┊277┊\n-┊228┊   ┊      const id = (chat.messages.length && chat.messages[chat.messages.length - 1].id + 1) || 1;\n-┊229┊   ┊\n-┊230┊   ┊      let recipients: Recipient[] = [];\n-┊231┊   ┊\n-┊232┊   ┊      holderIds.forEach(holderId => {\n-┊233┊   ┊        if (holderId !== currentUser.id) {\n-┊234┊   ┊          recipients.push({\n-┊235┊   ┊            userId: holderId,\n-┊236┊   ┊            messageId: id,\n-┊237┊   ┊            chatId: Number(chatId),\n-┊238┊   ┊            receivedAt: null,\n-┊239┊   ┊            readAt: null,\n-┊240┊   ┊          });\n-┊241┊   ┊        }\n-┊242┊   ┊      });\n-┊243┊   ┊\n-┊244┊   ┊      const message: Message = {\n-┊245┊   ┊        id,\n-┊246┊   ┊        chatId: Number(chatId),\n-┊247┊   ┊        senderId: currentUser.id,\n+┊   ┊278┊      const message = await connection.getRepository(Message).save(new Message({\n+┊   ┊279┊        chat: chat,\n+┊   ┊280┊        sender: currentUser,\n ┊248┊281┊        content,\n-┊249┊   ┊        createdAt: moment().unix(),\n ┊250┊282┊        type: MessageType.TEXT,\n-┊251┊   ┊        recipients,\n-┊252┊   ┊        holderIds,\n-┊253┊   ┊      };\n-┊254┊   ┊\n-┊255┊   ┊      chats = chats.map(chat => {\n-┊256┊   ┊        if (chat.id === Number(chatId)) {\n-┊257┊   ┊          chat = {...chat, messages: chat.messages.concat(message)}\n-┊258┊   ┊        }\n-┊259┊   ┊        return chat;\n-┊260┊   ┊      });\n+┊   ┊283┊        holders,\n+┊   ┊284┊        recipients: holders.reduce<Recipient[]>((filtered, user) => {\n+┊   ┊285┊          if (user.id !== currentUser.id) {\n+┊   ┊286┊            filtered.push(new Recipient({\n+┊   ┊287┊              user,\n+┊   ┊288┊            }));\n+┊   ┊289┊          }\n+┊   ┊290┊          return filtered;\n+┊   ┊291┊        }, []),\n+┊   ┊292┊      }));\n ┊261┊293┊\n ┊262┊294┊      pubsub.publish('messageAdded', {\n ┊263┊295┊        messageAdded: message,\n ┊264┊296┊      });\n ┊265┊297┊\n-┊266┊   ┊      return message;\n+┊   ┊298┊      return message || null;\n ┊267┊299┊    },\n-┊268┊   ┊    removeMessages: (obj: any, {chatId, messageIds, all}: RemoveMessagesMutationArgs, {user: currentUser}: {user: User}): number[] => {\n-┊269┊   ┊      const chat = chats.find(chat => chat.id === Number(chatId));\n+┊   ┊300┊    removeMessages: async (obj: any, {chatId, messageIds, all}: RemoveMessagesMutationArgs, {user: currentUser, connection}: { user: User, connection: Connection }) => {\n+┊   ┊301┊      const chat = await connection\n+┊   ┊302┊        .createQueryBuilder(Chat, \"chat\")\n+┊   ┊303┊        .whereInIds(chatId)\n+┊   ┊304┊        .innerJoinAndSelect('chat.listingMembers', 'listingMembers')\n+┊   ┊305┊        .innerJoinAndSelect('chat.messages', 'messages')\n+┊   ┊306┊        .innerJoinAndSelect('messages.holders', 'holders')\n+┊   ┊307┊        .getOne();\n ┊270┊308┊\n ┊271┊309┊      if (!chat) {\n ┊272┊310┊        throw new Error(`Cannot find chat ${chatId}.`);\n ┊273┊311┊      }\n ┊274┊312┊\n-┊275┊   ┊      if (!chat.listingMemberIds.find(listingId => listingId === currentUser.id)) {\n+┊   ┊313┊      if (!chat.listingMembers.find(user => user.id === currentUser.id)) {\n ┊276┊314┊        throw new Error(`The chat/group ${chatId} is not listed for the current user, so there is nothing to delete.`);\n ┊277┊315┊      }\n ┊278┊316┊\n```\n```diff\n@@ -280,79 +318,166 @@\n ┊280┊318┊        throw new Error(`Cannot specify both 'all' and 'messageIds'.`);\n ┊281┊319┊      }\n ┊282┊320┊\n+┊   ┊321┊      if (!all && !(messageIds && messageIds.length)) {\n+┊   ┊322┊        throw new Error(`'all' and 'messageIds' cannot be both null`);\n+┊   ┊323┊      }\n+┊   ┊324┊\n ┊283┊325┊      let deletedIds: number[] = [];\n-┊284┊   ┊      chats = chats.map(chat => {\n-┊285┊   ┊        if (chat.id === Number(chatId)) {\n-┊286┊   ┊          // Instead of chaining map and filter we can loop once using reduce\n-┊287┊   ┊          const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n-┊288┊   ┊            if (all || messageIds!.includes(String(message.id))) {\n-┊289┊   ┊              deletedIds.push(message.id);\n-┊290┊   ┊              // Remove the current user from the message holders\n-┊291┊   ┊              message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser.id);\n-┊292┊   ┊            }\n+┊   ┊326┊      // Instead of chaining map and filter we can loop once using reduce\n+┊   ┊327┊      chat.messages = await chat.messages.reduce<Promise<Message[]>>(async (filtered$, message) => {\n+┊   ┊328┊        const filtered = await filtered$;\n ┊293┊329┊\n-┊294┊   ┊            if (message.holderIds.length !== 0) {\n-┊295┊   ┊              filtered.push(message);\n-┊296┊   ┊            } // else discard the message\n+┊   ┊330┊        if (all || messageIds!.includes(String(message.id))) {\n+┊   ┊331┊          deletedIds.push(message.id);\n+┊   ┊332┊          // Remove the current user from the message holders\n+┊   ┊333┊          message.holders = message.holders.filter(user => user.id !== currentUser.id);\n ┊297┊334┊\n-┊298┊   ┊            return filtered;\n-┊299┊   ┊          }, []);\n-┊300┊   ┊          chat = {...chat, messages};\n ┊301┊335┊        }\n-┊302┊   ┊        return chat;\n-┊303┊   ┊      });\n+┊   ┊336┊\n+┊   ┊337┊        if (message.holders.length !== 0) {\n+┊   ┊338┊          // Remove the current user from the message holders\n+┊   ┊339┊          await connection.getRepository(Message).save(message);\n+┊   ┊340┊          filtered.push(message);\n+┊   ┊341┊        } else {\n+┊   ┊342┊          // Simply remove the message\n+┊   ┊343┊          const recipients = await connection\n+┊   ┊344┊            .createQueryBuilder(Recipient, \"recipient\")\n+┊   ┊345┊            .innerJoinAndSelect('recipient.message', 'message', 'message.id = :messageId', {messageId: message.id})\n+┊   ┊346┊            .innerJoinAndSelect('recipient.user', 'user')\n+┊   ┊347┊            .getMany();\n+┊   ┊348┊          for (let recipient of recipients) {\n+┊   ┊349┊            await connection.getRepository(Recipient).remove(recipient);\n+┊   ┊350┊          }\n+┊   ┊351┊          await connection.getRepository(Message).remove(message);\n+┊   ┊352┊        }\n+┊   ┊353┊\n+┊   ┊354┊        return filtered;\n+┊   ┊355┊      }, Promise.resolve([]));\n+┊   ┊356┊\n+┊   ┊357┊      await connection.getRepository(Chat).save(chat);\n+┊   ┊358┊\n ┊304┊359┊      return deletedIds;\n ┊305┊360┊    },\n ┊306┊361┊  },\n ┊307┊362┊  Subscription: {\n ┊308┊363┊    messageAdded: {\n ┊309┊364┊      subscribe: withFilter(() => pubsub.asyncIterator('messageAdded'),\n-┊310┊   ┊        ({messageAdded}: {messageAdded: Message & {chat: {id: number}}}, {chatId}: MessageAddedSubscriptionArgs, {user: currentUser}: { user: User }) => {\n+┊   ┊365┊        ({messageAdded}: {messageAdded: Message}, {chatId}: MessageAddedSubscriptionArgs, {user: currentUser}: { user: User }) => {\n ┊311┊366┊          return (!chatId || messageAdded.chat.id === Number(chatId)) &&\n-┊312┊   ┊            !!messageAdded.recipients.find((recipient: Recipient) => recipient.userId === currentUser.id);\n+┊   ┊367┊            !!messageAdded.recipients.find((recipient: Recipient) => recipient.user.id === currentUser.id);\n ┊313┊368┊        }),\n ┊314┊369┊    },\n ┊315┊370┊    chatAdded: {\n ┊316┊371┊      subscribe: withFilter(() => pubsub.asyncIterator('chatAdded'),\n-┊317┊   ┊        ({creatorId, chatAdded}: {creatorId: string, chatAdded: Chat}, variables: any, {user: currentUser}: { user: User }) => {\n-┊318┊   ┊          return Number(creatorId) !== currentUser.id && !chatAdded.listingMemberIds.includes(currentUser.id);\n+┊   ┊372┊        ({creatorId, chatAdded}: {creatorId: string, chatAdded: Chat}, variables, {user: currentUser}: { user: User }) => {\n+┊   ┊373┊          return Number(creatorId) !== currentUser.id &&\n+┊   ┊374┊            !!chatAdded.listingMembers.find((user: User) => user.id === currentUser.id);\n ┊319┊375┊        }),\n ┊320┊376┊    }\n ┊321┊377┊  },\n ┊322┊378┊  Chat: {\n-┊323┊   ┊    name: (chat: Chat, args: any, {user: currentUser}: {user: User}): string => chat.name ? chat.name : users\n-┊324┊   ┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser.id))!.name,\n-┊325┊   ┊    picture: (chat: Chat, args: any, {user: currentUser}: {user: User}) => chat.name ? chat.picture : users\n-┊326┊   ┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser.id))!.picture,\n-┊327┊   ┊    allTimeMembers: (chat: Chat): User[] => users.filter(user => chat.allTimeMemberIds.includes(user.id)),\n-┊328┊   ┊    listingMembers: (chat: Chat): User[] => users.filter(user => chat.listingMemberIds.includes(user.id)),\n-┊329┊   ┊    actualGroupMembers: (chat: Chat): User[] => users.filter(user => chat.actualGroupMemberIds && chat.actualGroupMemberIds.includes(user.id)),\n-┊330┊   ┊    admins: (chat: Chat): User[] => users.filter(user => chat.adminIds && chat.adminIds.includes(user.id)),\n-┊331┊   ┊    owner: (chat: Chat): User | null => users.find(user => chat.ownerId === user.id) || null,\n-┊332┊   ┊    messages: (chat: Chat, {amount = 0}: {amount: number}, {user: currentUser}: {user: User}): Message[] => {\n-┊333┊   ┊      const messages = chat.messages\n-┊334┊   ┊      .filter(message => message.holderIds.includes(currentUser.id))\n-┊335┊   ┊      .sort((a, b) => b.createdAt - a.createdAt) || <Message[]>[];\n-┊336┊   ┊      return (amount ? messages.slice(0, amount) : messages).reverse();\n+┊   ┊379┊    name: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<string | null> => {\n+┊   ┊380┊      if (chat.name) {\n+┊   ┊381┊        return chat.name;\n+┊   ┊382┊      }\n+┊   ┊383┊      const user = await connection\n+┊   ┊384┊        .createQueryBuilder(User, \"user\")\n+┊   ┊385┊        .where('user.id != :userId', {userId: currentUser.id})\n+┊   ┊386┊        .innerJoin('user.allTimeMemberChats', 'allTimeMemberChats', 'allTimeMemberChats.id = :chatId', {chatId: chat.id})\n+┊   ┊387┊        .getOne();\n+┊   ┊388┊      return user && user.name || null;\n+┊   ┊389┊    },\n+┊   ┊390┊    picture: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<string | null> => {\n+┊   ┊391┊      if (chat.name) {\n+┊   ┊392┊        return chat.picture;\n+┊   ┊393┊      }\n+┊   ┊394┊      const user = await connection\n+┊   ┊395┊        .createQueryBuilder(User, \"user\")\n+┊   ┊396┊        .where('user.id != :userId', {userId: currentUser.id})\n+┊   ┊397┊        .innerJoin('user.allTimeMemberChats', 'allTimeMemberChats', 'allTimeMemberChats.id = :chatId', {chatId: chat.id})\n+┊   ┊398┊        .getOne();\n+┊   ┊399┊      return user ? user.picture : null;\n+┊   ┊400┊    },\n+┊   ┊401┊    allTimeMembers: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User[]> => {\n+┊   ┊402┊      return await connection\n+┊   ┊403┊        .createQueryBuilder(User, \"user\")\n+┊   ┊404┊        .innerJoin('user.allTimeMemberChats', 'allTimeMemberChats', 'allTimeMemberChats.id = :chatId', {chatId: chat.id})\n+┊   ┊405┊        .getMany();\n+┊   ┊406┊    },\n+┊   ┊407┊    listingMembers: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User[]> => {\n+┊   ┊408┊      return await connection\n+┊   ┊409┊        .createQueryBuilder(User, \"user\")\n+┊   ┊410┊        .innerJoin('user.listingMemberChats', 'listingMemberChats', 'listingMemberChats.id = :chatId', {chatId: chat.id})\n+┊   ┊411┊        .getMany();\n+┊   ┊412┊    },\n+┊   ┊413┊    actualGroupMembers: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User[]> => {\n+┊   ┊414┊      return await connection\n+┊   ┊415┊        .createQueryBuilder(User, \"user\")\n+┊   ┊416┊        .innerJoin('user.actualGroupMemberChats', 'actualGroupMemberChats', 'actualGroupMemberChats.id = :chatId', {chatId: chat.id})\n+┊   ┊417┊        .getMany();\n+┊   ┊418┊    },\n+┊   ┊419┊    admins: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User[]> => {\n+┊   ┊420┊      return await connection\n+┊   ┊421┊        .createQueryBuilder(User, \"user\")\n+┊   ┊422┊        .innerJoin('user.adminChats', 'adminChats', 'adminChats.id = :chatId', {chatId: chat.id})\n+┊   ┊423┊        .getMany();\n ┊337┊424┊    },\n-┊338┊   ┊    unreadMessages: (chat: Chat, args: any, {user: currentUser}: {user: User}): number => chat.messages\n-┊339┊   ┊      .filter(message => message.holderIds.includes(currentUser.id) &&\n-┊340┊   ┊        message.recipients.find(recipient => recipient.userId === currentUser.id && !recipient.readAt))\n-┊341┊   ┊      .length,\n-┊342┊   ┊    isGroup: (chat: Chat): boolean => !!chat.name,\n+┊   ┊425┊    owner: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User | null> => {\n+┊   ┊426┊      return await connection\n+┊   ┊427┊        .createQueryBuilder(User, \"user\")\n+┊   ┊428┊        .innerJoin('user.ownerChats', 'ownerChats', 'ownerChats.id = :chatId', {chatId: chat.id})\n+┊   ┊429┊        .getOne() || null;\n+┊   ┊430┊    },\n+┊   ┊431┊    messages: async (chat: Chat, {amount = 0}: {amount: number}, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<Message[]> => {\n+┊   ┊432┊      const query = connection\n+┊   ┊433┊        .createQueryBuilder(Message, \"message\")\n+┊   ┊434┊        .innerJoin('message.chat', 'chat', 'chat.id = :chatId', {chatId: chat.id})\n+┊   ┊435┊        .innerJoin('message.holders', 'holders', 'holders.id = :userId', {userId: currentUser.id})\n+┊   ┊436┊        .orderBy({\"message.createdAt\": \"DESC\"});\n+┊   ┊437┊      return (amount ? await query.take(amount).getMany() : await query.getMany()).reverse();\n+┊   ┊438┊    },\n+┊   ┊439┊    unreadMessages: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<number> => {\n+┊   ┊440┊      return await connection\n+┊   ┊441┊        .createQueryBuilder(Message, \"message\")\n+┊   ┊442┊        .innerJoin('message.chat', 'chat', 'chat.id = :chatId', {chatId: chat.id})\n+┊   ┊443┊        .innerJoin('message.recipients', 'recipients', 'recipients.user.id = :userId AND recipients.readAt IS NULL', {userId: currentUser.id})\n+┊   ┊444┊        .getCount();\n+┊   ┊445┊    },\n+┊   ┊446┊    isGroup: (chat: Chat) => !!chat.name,\n ┊343┊447┊  },\n ┊344┊448┊  Message: {\n-┊345┊   ┊    chat: (message: Message): Chat | null => chats.find(chat => message.chatId === chat.id) || null,\n-┊346┊   ┊    sender: (message: Message): User | null => users.find(user => user.id === message.senderId) || null,\n-┊347┊   ┊    holders: (message: Message): User[] => users.filter(user => message.holderIds.includes(user.id)),\n-┊348┊   ┊    ownership: (message: Message, args: any, {user: currentUser}: {user: User}): boolean => message.senderId === currentUser.id,\n-┊349┊   ┊  },\n-┊350┊   ┊  Recipient: {\n-┊351┊   ┊    user: (recipient: Recipient): User | null => users.find(user => recipient.userId === user.id) || null,\n-┊352┊   ┊    message: (recipient: Recipient): Message | null => {\n-┊353┊   ┊      const chat = chats.find(chat => recipient.chatId === chat.id);\n-┊354┊   ┊      return chat ? chat.messages.find(message => recipient.messageId === message.id) || null : null;\n+┊   ┊449┊    sender: async (message: Message, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User | null> => {\n+┊   ┊450┊      return (await connection\n+┊   ┊451┊        .createQueryBuilder(User, \"user\")\n+┊   ┊452┊        .innerJoin('user.senderMessages', 'senderMessages', 'senderMessages.id = :messageId', {messageId: message.id})\n+┊   ┊453┊        .getOne()) || null;\n+┊   ┊454┊    },\n+┊   ┊455┊    ownership: async (message: Message, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<boolean> => {\n+┊   ┊456┊      return !!(await connection\n+┊   ┊457┊        .createQueryBuilder(User, \"user\")\n+┊   ┊458┊        .whereInIds(currentUser.id)\n+┊   ┊459┊        .innerJoin('user.senderMessages', 'senderMessages', 'senderMessages.id = :messageId', {messageId: message.id})\n+┊   ┊460┊        .getCount());\n+┊   ┊461┊    },\n+┊   ┊462┊    recipients: async (message: Message, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<Recipient[]> => {\n+┊   ┊463┊      return await connection\n+┊   ┊464┊        .createQueryBuilder(Recipient, \"recipient\")\n+┊   ┊465┊        .innerJoinAndSelect('recipient.message', 'message', 'message.id = :messageId', {messageId: message.id})\n+┊   ┊466┊        .innerJoinAndSelect('recipient.user', 'user')\n+┊   ┊467┊        .innerJoinAndSelect('recipient.chat', 'chat')\n+┊   ┊468┊        .getMany();\n+┊   ┊469┊    },\n+┊   ┊470┊    holders: async (message: Message, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User[]> => {\n+┊   ┊471┊      return await connection\n+┊   ┊472┊        .createQueryBuilder(User, \"user\")\n+┊   ┊473┊        .innerJoin('user.holderMessages', 'holderMessages', 'holderMessages.id = :messageId', {messageId: message.id})\n+┊   ┊474┊        .getMany();\n+┊   ┊475┊    },\n+┊   ┊476┊    chat: async (message: Message, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<Chat | null> => {\n+┊   ┊477┊      return (await connection\n+┊   ┊478┊        .createQueryBuilder(Chat, \"chat\")\n+┊   ┊479┊        .innerJoin('chat.messages', 'messages', 'messages.id = :messageId', {messageId: message.id})\n+┊   ┊480┊        .getOne()) || null;\n ┊355┊481┊    },\n-┊356┊   ┊    chat: (recipient: Recipient): Chat | null => chats.find(chat => recipient.chatId === chat.id) || null,\n ┊357┊482┊  },\n ┊358┊483┊};\n```\n\n[}]: #\n\n`QueryBuilder` is one of the most powerful features of `TypeORM` - it allows you to build SQL queries using elegant and convenient syntax, execute them and get automatically transformed entities.\n\nYou can find more informations on `TypeORM` on http://typeorm.io\n\nThe best part is that you won't have to do anything on the client, everything will be completely transparent to it, even if migrated from NoSQL-like db structure to a relational one!\nOf course, you could remove the custom normalization for the messages because now they have their own table and they are no longer embedded (so they have unique IDs), but we could leave it as well in order to be free to use any kind of backend."
          }
        ]
      },
      {
        "releaseVersion": "1.0.0",
        "releaseDate": "2018-05-29 03:26:43 +0800",
        "tagName": "master@1.0.0",
        "tagRevision": "c38546e6bb3bb87878f0be1d7d6b45c3791f4675",
        "historyRevision": "7dfbb6a92201a238c62dfa2a19681eeca7e981e3",
        "changesDiff": "diff --git a/client/.angular-cli.json b/client/.angular-cli.json\ndeleted file mode 100644\nindex 542e27b..0000000\n--- a/client/.angular-cli.json\n+++ /dev/null\n@@ -1,60 +0,0 @@\n-{\n-  \"$schema\": \"./node_modules/@angular/cli/lib/config/schema.json\",\n-  \"project\": {\n-    \"name\": \"whatsapp-client-angularcli-material\"\n-  },\n-  \"apps\": [\n-    {\n-      \"root\": \"src\",\n-      \"outDir\": \"dist\",\n-      \"assets\": [\n-        \"assets\",\n-        \"favicon.ico\"\n-      ],\n-      \"index\": \"index.html\",\n-      \"main\": \"main.ts\",\n-      \"polyfills\": \"polyfills.ts\",\n-      \"test\": \"test.ts\",\n-      \"tsconfig\": \"tsconfig.app.json\",\n-      \"testTsconfig\": \"tsconfig.spec.json\",\n-      \"prefix\": \"app\",\n-      \"styles\": [\n-        \"styles.scss\"\n-      ],\n-      \"scripts\": [],\n-      \"environmentSource\": \"environments/environment.ts\",\n-      \"environments\": {\n-        \"dev\": \"environments/environment.ts\",\n-        \"prod\": \"environments/environment.prod.ts\"\n-      }\n-    }\n-  ],\n-  \"e2e\": {\n-    \"protractor\": {\n-      \"config\": \"./protractor.conf.js\"\n-    }\n-  },\n-  \"lint\": [\n-    {\n-      \"project\": \"src/tsconfig.app.json\",\n-      \"exclude\": \"**/node_modules/**\"\n-    },\n-    {\n-      \"project\": \"src/tsconfig.spec.json\",\n-      \"exclude\": \"**/node_modules/**\"\n-    },\n-    {\n-      \"project\": \"e2e/tsconfig.e2e.json\",\n-      \"exclude\": \"**/node_modules/**\"\n-    }\n-  ],\n-  \"test\": {\n-    \"karma\": {\n-      \"config\": \"./karma.conf.js\"\n-    }\n-  },\n-  \"defaults\": {\n-    \"styleExt\": \"scss\",\n-    \"component\": {}\n-  }\n-}\ndiff --git a/client/.gitignore b/client/.gitignore\nindex 22657a5..b600fc4 100644\n--- a/client/.gitignore\n+++ b/client/.gitignore\n@@ -2,7 +2,6 @@\n\n # compiled output\n /dist\n-/dist-server\n /tmp\n /out-tsc\n\n@@ -31,13 +30,10 @@\n /coverage\n /libpeerconnection.log\n npm-debug.log\n+yarn-error.log\n testem.log\n /typings\n\n-# e2e\n-/e2e/*.js\n-/e2e/*.map\n-\n # System Files\n .DS_Store\n Thumbs.db\ndiff --git a/client/angular.json b/client/angular.json\nnew file mode 100644\nindex 0000000..3d9af93\n--- /dev/null\n+++ b/client/angular.json\n@@ -0,0 +1,126 @@\n+{\n+  \"$schema\": \"./node_modules/@angular/cli/lib/config/schema.json\",\n+  \"version\": 1,\n+  \"newProjectRoot\": \"projects\",\n+  \"projects\": {\n+    \"whatsapp-client-angularcli-material\": {\n+      \"root\": \"\",\n+      \"sourceRoot\": \"src\",\n+      \"projectType\": \"application\",\n+      \"prefix\": \"app\",\n+      \"schematics\": {\n+        \"@schematics/angular:component\": {\n+          \"styleext\": \"scss\"\n+        }\n+      },\n+      \"architect\": {\n+        \"build\": {\n+          \"builder\": \"@angular-devkit/build-angular:browser\",\n+          \"options\": {\n+            \"outputPath\": \"dist/whatsapp-client-angularcli-material\",\n+            \"index\": \"src/index.html\",\n+            \"main\": \"src/main.ts\",\n+            \"polyfills\": \"src/polyfills.ts\",\n+            \"tsConfig\": \"src/tsconfig.app.json\",\n+            \"assets\": [\n+              \"src/favicon.ico\",\n+              \"src/assets\"\n+            ],\n+            \"styles\": [\n+              \"src/styles.scss\"\n+            ],\n+            \"scripts\": []\n+          },\n+          \"configurations\": {\n+            \"production\": {\n+              \"fileReplacements\": [\n+                {\n+                  \"replace\": \"src/environments/environment.ts\",\n+                  \"with\": \"src/environments/environment.prod.ts\"\n+                }\n+              ],\n+              \"optimization\": true,\n+              \"outputHashing\": \"all\",\n+              \"sourceMap\": false,\n+              \"extractCss\": true,\n+              \"namedChunks\": false,\n+              \"aot\": true,\n+              \"extractLicenses\": true,\n+              \"vendorChunk\": false,\n+              \"buildOptimizer\": true\n+            }\n+          }\n+        },\n+        \"serve\": {\n+          \"builder\": \"@angular-devkit/build-angular:dev-server\",\n+          \"options\": {\n+            \"browserTarget\": \"whatsapp-client-angularcli-material:build\"\n+          },\n+          \"configurations\": {\n+            \"production\": {\n+              \"browserTarget\": \"whatsapp-client-angularcli-material:build:production\"\n+            }\n+          }\n+        },\n+        \"extract-i18n\": {\n+          \"builder\": \"@angular-devkit/build-angular:extract-i18n\",\n+          \"options\": {\n+            \"browserTarget\": \"whatsapp-client-angularcli-material:build\"\n+          }\n+        },\n+        \"test\": {\n+          \"builder\": \"@angular-devkit/build-angular:karma\",\n+          \"options\": {\n+            \"main\": \"src/test.ts\",\n+            \"polyfills\": \"src/polyfills.ts\",\n+            \"tsConfig\": \"src/tsconfig.spec.json\",\n+            \"karmaConfig\": \"src/karma.conf.js\",\n+            \"styles\": [\n+              \"styles.scss\"\n+            ],\n+            \"scripts\": [],\n+            \"assets\": [\n+              \"src/favicon.ico\",\n+              \"src/assets\"\n+            ]\n+          }\n+        },\n+        \"lint\": {\n+          \"builder\": \"@angular-devkit/build-angular:tslint\",\n+          \"options\": {\n+            \"tsConfig\": [\n+              \"src/tsconfig.app.json\",\n+              \"src/tsconfig.spec.json\"\n+            ],\n+            \"exclude\": [\n+              \"**/node_modules/**\"\n+            ]\n+          }\n+        }\n+      }\n+    },\n+    \"whatsapp-client-angularcli-material-e2e\": {\n+      \"root\": \"e2e/\",\n+      \"projectType\": \"application\",\n+      \"architect\": {\n+        \"e2e\": {\n+          \"builder\": \"@angular-devkit/build-angular:protractor\",\n+          \"options\": {\n+            \"protractorConfig\": \"e2e/protractor.conf.js\",\n+            \"devServerTarget\": \"whatsapp-client-angularcli-material:serve\"\n+          }\n+        },\n+        \"lint\": {\n+          \"builder\": \"@angular-devkit/build-angular:tslint\",\n+          \"options\": {\n+            \"tsConfig\": \"e2e/tsconfig.e2e.json\",\n+            \"exclude\": [\n+              \"**/node_modules/**\"\n+            ]\n+          }\n+        }\n+      }\n+    }\n+  },\n+  \"defaultProject\": \"whatsapp-client-angularcli-material\"\n+}\n\\ No newline at end of file\ndiff --git a/client/protractor.conf.js b/client/e2e/protractor.conf.js\nsimilarity index 86%\nrename from client/protractor.conf.js\nrename to client/e2e/protractor.conf.js\nindex 7ee3b5e..86776a3 100644\n--- a/client/protractor.conf.js\n+++ b/client/e2e/protractor.conf.js\n@@ -6,7 +6,7 @@ const { SpecReporter } = require('jasmine-spec-reporter');\n exports.config = {\n   allScriptsTimeout: 11000,\n   specs: [\n-    './e2e/**/*.e2e-spec.ts'\n+    './src/**/*.e2e-spec.ts'\n   ],\n   capabilities: {\n     'browserName': 'chrome'\n@@ -21,8 +21,8 @@ exports.config = {\n   },\n   onPrepare() {\n     require('ts-node').register({\n-      project: 'e2e/tsconfig.e2e.json'\n+      project: require('path').join(__dirname, './tsconfig.e2e.json')\n     });\n     jasmine.getEnv().addReporter(new SpecReporter({ spec: { displayStacktrace: true } }));\n   }\n-};\n+};\n\\ No newline at end of file\ndiff --git a/client/e2e/app.e2e-spec.ts b/client/e2e/src/app.e2e-spec.ts\nsimilarity index 81%\nrename from client/e2e/app.e2e-spec.ts\nrename to client/e2e/src/app.e2e-spec.ts\nindex aaf19d5..e42d1f9 100644\n--- a/client/e2e/app.e2e-spec.ts\n+++ b/client/e2e/src/app.e2e-spec.ts\n@@ -1,6 +1,6 @@\n import { AppPage } from './app.po';\n\n-describe('whatsapp-client-angularcli-material App', () => {\n+describe('workspace-project App', () => {\n   let page: AppPage;\n\n   beforeEach(() => {\ndiff --git a/client/e2e/app.po.ts b/client/e2e/src/app.po.ts\nsimilarity index 100%\nrename from client/e2e/app.po.ts\nrename to client/e2e/src/app.po.ts\ndiff --git a/client/e2e/tsconfig.e2e.json b/client/e2e/tsconfig.e2e.json\nindex 1d9e5ed..a6dd622 100644\n--- a/client/e2e/tsconfig.e2e.json\n+++ b/client/e2e/tsconfig.e2e.json\n@@ -1,8 +1,7 @@\n {\n   \"extends\": \"../tsconfig.json\",\n   \"compilerOptions\": {\n-    \"outDir\": \"../out-tsc/e2e\",\n-    \"baseUrl\": \"./\",\n+    \"outDir\": \"../out-tsc/app\",\n     \"module\": \"commonjs\",\n     \"target\": \"es5\",\n     \"types\": [\n@@ -11,4 +10,4 @@\n       \"node\"\n     ]\n   }\n-}\n+}\n\\ No newline at end of file\ndiff --git a/client/package.json b/client/package.json\nindex 7229a04..b2da7ed 100644\n--- a/client/package.json\n+++ b/client/package.json\n@@ -1,69 +1,69 @@\n {\n   \"name\": \"whatsapp-client-angularcli-material\",\n   \"version\": \"0.0.0\",\n-  \"license\": \"MIT\",\n   \"scripts\": {\n     \"ng\": \"ng\",\n     \"start\": \"ng serve\",\n-    \"build\": \"ng build --prod\",\n+    \"build\": \"ng build\",\n     \"test\": \"ng test\",\n     \"lint\": \"ng lint\",\n     \"e2e\": \"ng e2e\",\n-    \"generator\": \"gql-gen --url http://localhost:3000/graphql --template ts --out ./src/types.d.ts \\\"./src/graphql/**/*.ts\\\"\"\n+    \"generator\": \"gql-gen --schema http://localhost:3000/graphql --template ts --out ./src/types.d.ts \\\"./src/graphql/**/*.ts\\\"\"\n   },\n   \"private\": true,\n   \"dependencies\": {\n-    \"@angular/animations\": \"5.2.5\",\n-    \"@angular/cdk\": \"5.2.1\",\n-    \"@angular/common\": \"5.2.5\",\n-    \"@angular/compiler\": \"5.2.5\",\n-    \"@angular/core\": \"5.2.5\",\n-    \"@angular/flex-layout\": \"2.0.0-beta.12\",\n-    \"@angular/forms\": \"5.2.5\",\n-    \"@angular/http\": \"5.2.5\",\n-    \"@angular/material\": \"5.2.1\",\n-    \"@angular/platform-browser\": \"5.2.5\",\n-    \"@angular/platform-browser-dynamic\": \"5.2.5\",\n-    \"@angular/router\": \"5.2.5\",\n-    \"ajv\": \"6.1.1\",\n-    \"apollo-angular\": \"1.0.1\",\n-    \"apollo-angular-link-http\": \"1.0.2-beta.0\",\n-    \"apollo-cache-inmemory\": \"1.1.9\",\n-    \"apollo-client\": \"2.2.5\",\n-    \"apollo-link\": \"1.1.0\",\n-    \"apollo-link-ws\": \"1.0.5\",\n-    \"apollo-utilities\": \"1.0.8\",\n-    \"core-js\": \"2.5.3\",\n-    \"graphql\": \"0.12.3\",\n-    \"graphql-tag\": \"2.7.3\",\n+    \"@angular/animations\": \"6.0.0\",\n+    \"@angular/cdk\": \"6.0.1\",\n+    \"@angular/common\": \"6.0.0\",\n+    \"@angular/compiler\": \"6.0.0\",\n+    \"@angular/core\": \"6.0.0\",\n+    \"@angular/flex-layout\": \"6.0.0-beta.15\",\n+    \"@angular/forms\": \"6.0.0\",\n+    \"@angular/http\": \"6.0.0\",\n+    \"@angular/material\": \"6.0.1\",\n+    \"@angular/platform-browser\": \"6.0.0\",\n+    \"@angular/platform-browser-dynamic\": \"6.0.0\",\n+    \"@angular/router\": \"6.0.0\",\n+    \"apollo-angular\": \"1.1.0-rc.0\",\n+    \"apollo-angular-link-http\": \"1.1.0-rc.0\",\n+    \"apollo-cache-inmemory\": \"1.2.1\",\n+    \"apollo-client\": \"2.3.1\",\n+    \"apollo-link\": \"1.2.2\",\n+    \"apollo-link-ws\": \"1.0.8\",\n+    \"apollo-utilities\": \"1.0.12\",\n+    \"core-js\": \"2.5.6\",\n+    \"graphql\": \"0.13.2\",\n+    \"graphql-tag\": \"2.9.2\",\n     \"hammerjs\": \"2.0.8\",\n-    \"moment\": \"2.20.1\",\n-    \"ng2-truncate\": \"1.3.11\",\n-    \"ngx-selectable-list\": \"1.1.0\",\n-    \"rxjs\": \"5.5.6\",\n-    \"subscriptions-transport-ws\": \"0.9.5\",\n-    \"zone.js\": \"0.8.20\"\n+    \"moment\": \"2.22.1\",\n+    \"ng2-truncate\": \"1.3.17\",\n+    \"ngx-selectable-list\": \"^1.2.1\",\n+    \"rxjs\": \"6.1.0\",\n+    \"subscriptions-transport-ws\": \"0.9.9\",\n+    \"zone.js\": \"0.8.26\"\n   },\n   \"devDependencies\": {\n-    \"@angular/cli\": \"1.7.0\",\n-    \"@angular/compiler-cli\": \"5.2.5\",\n-    \"@angular/language-service\": \"5.2.5\",\n-    \"@types/graphql\": \"0.12.4\",\n-    \"@types/jasmine\": \"2.8.6\",\n+    \"@angular-devkit/build-angular\": \"0.6.0\",\n+    \"@angular/cli\": \"6.0.0\",\n+    \"@angular/compiler-cli\": \"6.0.0\",\n+    \"@angular/language-service\": \"6.0.0\",\n+    \"@types/graphql\": \"0.13.0\",\n+    \"@types/jasmine\": \"2.8.7\",\n     \"@types/jasminewd2\": \"2.0.3\",\n-    \"@types/node\": \"6.0.101\",\n-    \"codelyzer\": \"4.1.0\",\n-    \"graphql-code-generator\": \"0.8.14\",\n-    \"jasmine-core\": \"2.8.0\",\n+    \"@types/node\": \"8.9.5\",\n+    \"codelyzer\": \"4.2.1\",\n+    \"graphql-code-generator\": \"0.9.1\",\n+    \"graphql-codegen-typescript-template\": \"0.9.1\",\n+    \"jasmine-core\": \"2.99.1\",\n     \"jasmine-spec-reporter\": \"4.2.1\",\n-    \"karma\": \"2.0.0\",\n+    \"karma\": \"1.7.1\",\n     \"karma-chrome-launcher\": \"2.2.0\",\n-    \"karma-coverage-istanbul-reporter\": \"1.4.1\",\n-    \"karma-jasmine\": \"1.1.1\",\n+    \"karma-coverage-istanbul-reporter\": \"1.4.2\",\n+    \"karma-jasmine\": \"1.1.2\",\n     \"karma-jasmine-html-reporter\": \"0.2.2\",\n-    \"protractor\": \"5.1.2\",\n-    \"ts-node\": \"4.1.0\",\n+    \"protractor\": \"5.3.1\",\n+    \"ts-node\": \"5.0.1\",\n     \"tslint\": \"5.9.1\",\n-    \"typescript\": \"2.5.3\"\n+    \"typescript\": \"2.7.2\"\n   }\n }\ndiff --git a/client/package.json.orig b/client/package.json.orig\ndeleted file mode 100644\nindex e025965..0000000\n--- a/client/package.json.orig\n+++ /dev/null\n@@ -1,61 +0,0 @@\n-{\n-  \"name\": \"whatsapp-client-angularcli-material\",\n-  \"version\": \"0.0.0\",\n-  \"license\": \"MIT\",\n-  \"scripts\": {\n-    \"ng\": \"ng\",\n-    \"start\": \"ng serve\",\n-    \"build\": \"ng build --prod\",\n-    \"test\": \"ng test\",\n-    \"lint\": \"ng lint\",\n-    \"e2e\": \"ng e2e\"\n-  },\n-  \"private\": true,\n-  \"dependencies\": {\n-    \"@angular/animations\": \"5.2.5\",\n-    \"@angular/common\": \"5.2.5\",\n-    \"@angular/compiler\": \"5.2.5\",\n-    \"@angular/core\": \"5.2.5\",\n-    \"@angular/forms\": \"5.2.5\",\n-    \"@angular/http\": \"5.2.5\",\n-    \"@angular/platform-browser\": \"5.2.5\",\n-    \"@angular/platform-browser-dynamic\": \"5.2.5\",\n-    \"@angular/router\": \"5.2.5\",\n-    \"ajv\": \"6.1.1\",\n-    \"apollo-angular\": \"1.0.1\",\n-    \"apollo-angular-link-http\": \"1.0.2-beta.0\",\n-    \"apollo-cache-inmemory\": \"1.1.9\",\n-    \"apollo-client\": \"2.2.5\",\n-    \"apollo-link\": \"1.1.0\",\n-    \"core-js\": \"2.5.3\",\n-    \"graphql\": \"0.12.3\",\n-    \"graphql-tag\": \"2.7.3\",\n-    \"rxjs\": \"5.5.6\",\n-    \"zone.js\": \"0.8.20\"\n-  },\n-  \"devDependencies\": {\n-    \"@angular/cli\": \"1.7.0\",\n-    \"@angular/compiler-cli\": \"5.2.5\",\n-    \"@angular/language-service\": \"5.2.5\",\n-<<<<<<< HEAD\n-    \"@types/graphql\": \"^0.12.4\",\n-=======\n-    \"@types/graphql\": \"0.12.4\",\n->>>>>>> 48ac17b... Step 1.2: Add chats service\n-    \"@types/jasmine\": \"2.8.6\",\n-    \"@types/jasminewd2\": \"2.0.3\",\n-    \"@types/node\": \"6.0.101\",\n-    \"codelyzer\": \"4.1.0\",\n-    \"jasmine-core\": \"2.8.0\",\n-    \"jasmine-spec-reporter\": \"4.2.1\",\n-    \"karma\": \"2.0.0\",\n-    \"karma-chrome-launcher\": \"2.2.0\",\n-    \"karma-coverage-istanbul-reporter\": \"1.4.1\",\n-    \"karma-jasmine\": \"1.1.1\",\n-    \"karma-jasmine-html-reporter\": \"0.2.2\",\n-    \"protractor\": \"5.1.2\",\n-    \"ts-node\": \"4.1.0\",\n-    \"tslint\": \"5.9.1\",\n-    \"typescript\": \"2.5.3\"\n-  }\n-}\ndiff --git a/client/src/app/app.module.ts b/client/src/app/app.module.ts\nindex d81a15c..356b000 100644\n--- a/client/src/app/app.module.ts\n+++ b/client/src/app/app.module.ts\n@@ -1,7 +1,6 @@\n import { BrowserModule } from '@angular/platform-browser';\n import { NgModule } from '@angular/core';\n\n-\n import { AppComponent } from './app.component';\n import {HTTP_INTERCEPTORS, HttpClientModule} from '@angular/common/http';\n import {HttpLink, HttpLinkModule, Options} from 'apollo-angular-link-http';\n@@ -18,7 +17,6 @@ import {OperationDefinitionNode} from 'graphql';\n import {split} from 'apollo-link';\n import {WebSocketLink} from 'apollo-link-ws';\n import {LoginService} from './login/services/login.service';\n-\n const routes: Routes = [];\n\n @NgModule({\n@@ -44,7 +42,7 @@ const routes: Routes = [];\n       provide: HTTP_INTERCEPTORS,\n       useClass: AuthInterceptor,\n       multi: true,\n-    }\n+    },\n   ],\n   bootstrap: [AppComponent]\n })\n@@ -67,7 +65,7 @@ export class AppModule {\n\n     const link = split(\n       ({ query }) => {\n-        const { kind, operation } = <OperationDefinitionNode>getMainDefinition(query);\n+        const { kind, operation } = <OperationDefinitionNode>getMainDefinition(<any>query);\n         return kind === 'OperationDefinition' && operation === 'subscription';\n       },\n       subscriptionLink,\ndiff --git a/client/src/app/chat-viewer/chat-viewer.module.ts b/client/src/app/chat-viewer/chat-viewer.module.ts\nindex dac388a..030ee57 100644\n--- a/client/src/app/chat-viewer/chat-viewer.module.ts\n+++ b/client/src/app/chat-viewer/chat-viewer.module.ts\n@@ -11,7 +11,7 @@ import {MessagesListComponent} from './components/messages-list/messages-list.co\n import {MessageItemComponent} from './components/message-item/message-item.component';\n import {NewMessageComponent} from './components/new-message/new-message.component';\n import {SharedModule} from '../shared/shared.module';\n-import {SelectableListModule} from 'ngx-selectable-list';\n+import {NgxSelectableListModule} from 'ngx-selectable-list';\n import {AuthGuard} from '../login/services/auth.guard';\n\n const routes: Routes = [\n@@ -46,7 +46,7 @@ const routes: Routes = [\n     FormsModule,\n     // Feature modules\n     SharedModule,\n-    SelectableListModule,\n+    NgxSelectableListModule,\n   ],\n   providers: [\n     ChatsService,\ndiff --git a/client/src/app/chat-viewer/components/messages-list/messages-list.component.ts b/client/src/app/chat-viewer/components/messages-list/messages-list.component.ts\nindex f123280..c6bc667 100644\n--- a/client/src/app/chat-viewer/components/messages-list/messages-list.component.ts\n+++ b/client/src/app/chat-viewer/components/messages-list/messages-list.component.ts\n@@ -8,7 +8,7 @@ import {SelectableListDirective} from 'ngx-selectable-list';\n     <mat-list>\n       <mat-list-item *ngFor=\"let message of messages\">\n         <app-message-item [item]=\"message\" [isGroup]=\"isGroup\"\n-                          appSelectableItem></app-message-item>\n+                          libSelectableItem></app-message-item>\n       </mat-list-item>\n     </mat-list>\n     <ng-content *ngIf=\"selectableListDirective.selecting\"></ng-content>\ndiff --git a/client/src/app/chat-viewer/containers/chat/chat.component.spec.ts b/client/src/app/chat-viewer/containers/chat/chat.component.spec.ts\nindex 930cf89..1bef7f3 100644\n--- a/client/src/app/chat-viewer/containers/chat/chat.component.spec.ts\n+++ b/client/src/app/chat-viewer/containers/chat/chat.component.spec.ts\n@@ -10,14 +10,14 @@ import {HttpLink, HttpLinkModule, Options} from 'apollo-angular-link-http';\n import {defaultDataIdFromObject, InMemoryCache} from 'apollo-cache-inmemory';\n import {RouterTestingModule} from '@angular/router/testing';\n import {ActivatedRoute} from '@angular/router';\n-import {of} from 'rxjs/observable/of';\n+import {of} from 'rxjs';\n import {By} from '@angular/platform-browser';\n import {FormsModule} from '@angular/forms';\n import {SharedModule} from '../../../shared/shared.module';\n import {NewMessageComponent} from '../../components/new-message/new-message.component';\n import {MessagesListComponent} from '../../components/messages-list/messages-list.component';\n import {MessageItemComponent} from '../../components/message-item/message-item.component';\n-import {SelectableListModule} from 'ngx-selectable-list';\n+import {NgxSelectableListModule} from 'ngx-selectable-list';\n import {LoginService} from '../../../login/services/login.service';\n\n describe('ChatComponent', () => {\n@@ -110,7 +110,7 @@ describe('ChatComponent', () => {\n         HttpLinkModule,\n         HttpClientTestingModule,\n         RouterTestingModule,\n-        SelectableListModule,\n+        NgxSelectableListModule,\n       ],\n       providers: [\n         ChatsService,\ndiff --git a/client/src/app/chat-viewer/containers/chat/chat.component.ts b/client/src/app/chat-viewer/containers/chat/chat.component.ts\nindex a8be4f1..9c48c14 100644\n--- a/client/src/app/chat-viewer/containers/chat/chat.component.ts\n+++ b/client/src/app/chat-viewer/containers/chat/chat.component.ts\n@@ -2,8 +2,9 @@ import {Component, OnInit} from '@angular/core';\n import {ActivatedRoute, Router} from '@angular/router';\n import {ChatsService} from '../../../services/chats.service';\n import {GetChat} from '../../../../types';\n-import {combineLatest} from 'rxjs/observable/combineLatest';\n+import {combineLatest} from 'rxjs';\n import {Location} from '@angular/common';\n+import {QueryRef} from 'apollo-angular';\n\n @Component({\n   template: `\n@@ -15,7 +16,7 @@ import {Location} from '@angular/common';\n     </app-toolbar>\n     <div class=\"container\">\n       <app-messages-list [items]=\"messages\" [isGroup]=\"isGroup\"\n-                         appSelectableList=\"multiple_press\" (multiple)=\"deleteMessages($event)\">\n+                         libSelectableList=\"multiple_press\" (multiple)=\"deleteMessages($event)\">\n         <app-confirm-selection #confirmSelection></app-confirm-selection>\n       </app-messages-list>\n       <app-new-message (newMessage)=\"addMessage($event)\"></app-new-message>\n@@ -29,6 +30,7 @@ export class ChatComponent implements OnInit {\n   name: string;\n   isGroup: boolean;\n   optimisticUI: boolean;\n+  query: QueryRef<GetChat.Query>;\n\n   constructor(private route: ActivatedRoute,\n               private router: Router,\n@@ -56,8 +58,12 @@ export class ChatComponent implements OnInit {\n           });\n         }\n\n-        this.chatsService.getChat(chatId, this.optimisticUI).chat$.subscribe(chat => {\n-          this.messages = chat.messages;\n+        const {query$, chat$} = this.chatsService.getChat(chatId, this.optimisticUI);\n+\n+        query$.subscribe(query => this.query = query);\n+\n+        chat$.subscribe(chat => {\n+          this.messages = chat.messageFeed.messages;\n           this.name = chat.name;\n           this.isGroup = chat.isGroup;\n         });\n@@ -69,7 +75,8 @@ export class ChatComponent implements OnInit {\n   }\n\n   addMessage(content: string) {\n-    this.chatsService.addMessage(this.chatId, content).subscribe();\n+    // this.chatsService.addMessage(this.chatId, content).subscribe();\n+    this.chatsService.moreMessages(this.query, this.chatId);\n   }\n\n   deleteMessages(messageIds: string[]) {\ndiff --git a/client/src/app/chats-creation/chats-creation.module.ts b/client/src/app/chats-creation/chats-creation.module.ts\nindex f8a9754..0504e39 100644\n--- a/client/src/app/chats-creation/chats-creation.module.ts\n+++ b/client/src/app/chats-creation/chats-creation.module.ts\n@@ -15,7 +15,7 @@ import {NewGroupComponent} from './containers/new-group/new-group.component';\n import {NewChatComponent} from './containers/new-chat/new-chat.component';\n import {NewGroupDetailsComponent} from './components/new-group-details/new-group-details.component';\n import {SharedModule} from '../shared/shared.module';\n-import {SelectableListModule} from 'ngx-selectable-list';\n+import {NgxSelectableListModule} from 'ngx-selectable-list';\n import {AuthGuard} from '../login/services/auth.guard';\n\n const routes: Routes = [\n@@ -50,7 +50,7 @@ const routes: Routes = [\n     // Forms\n     FormsModule,\n     // Feature modules\n-    SelectableListModule,\n+    NgxSelectableListModule,\n     SharedModule,\n   ],\n   providers: [\ndiff --git a/client/src/app/chats-creation/components/users-list/users-list.component.ts b/client/src/app/chats-creation/components/users-list/users-list.component.ts\nindex 96d5421..c01a8f8 100644\n--- a/client/src/app/chats-creation/components/users-list/users-list.component.ts\n+++ b/client/src/app/chats-creation/components/users-list/users-list.component.ts\n@@ -8,7 +8,7 @@ import {SelectableListDirective} from 'ngx-selectable-list';\n     <mat-list>\n       <mat-list-item *ngFor=\"let user of users\">\n         <app-user-item [item]=\"user\"\n-                       appSelectableItem></app-user-item>\n+                       libSelectableItem></app-user-item>\n       </mat-list-item>\n     </mat-list>\n     <ng-content *ngIf=\"selectableListDirective.selecting\"></ng-content>\ndiff --git a/client/src/app/chats-creation/containers/new-chat/new-chat.component.ts b/client/src/app/chats-creation/containers/new-chat/new-chat.component.ts\nindex 91820c8..1559ee1 100644\n--- a/client/src/app/chats-creation/containers/new-chat/new-chat.component.ts\n+++ b/client/src/app/chats-creation/containers/new-chat/new-chat.component.ts\n@@ -21,7 +21,7 @@ import {ChatsService} from '../../../services/chats.service';\n     </div>\n\n     <app-users-list [items]=\"users\"\n-                    appSelectableList=\"single\" (single)=\"addChat($event)\">\n+                    libSelectableList=\"single\" (single)=\"addChat($event)\">\n     </app-users-list>\n   `,\n   styleUrls: ['new-chat.component.scss'],\ndiff --git a/client/src/app/chats-creation/containers/new-group/new-group.component.ts b/client/src/app/chats-creation/containers/new-group/new-group.component.ts\nindex 19e9fb9..93586cd 100644\n--- a/client/src/app/chats-creation/containers/new-group/new-group.component.ts\n+++ b/client/src/app/chats-creation/containers/new-group/new-group.component.ts\n@@ -14,7 +14,7 @@ import {ChatsService} from '../../../services/chats.service';\n     </app-toolbar>\n\n     <app-users-list *ngIf=\"!recipientIds.length\" [items]=\"users\"\n-                    appSelectableList=\"multiple_tap\" (multiple)=\"selectUsers($event)\">\n+                    libSelectableList=\"multiple_tap\" (multiple)=\"selectUsers($event)\">\n       <app-confirm-selection #confirmSelection icon=\"arrow_forward\"></app-confirm-selection>\n     </app-users-list>\n     <app-new-group-details *ngIf=\"recipientIds.length\" [users]=\"getSelectedUsers()\"\ndiff --git a/client/src/app/chats-lister/chats-lister.module.ts b/client/src/app/chats-lister/chats-lister.module.ts\nindex 0e86163..714ccce 100644\n--- a/client/src/app/chats-lister/chats-lister.module.ts\n+++ b/client/src/app/chats-lister/chats-lister.module.ts\n@@ -11,7 +11,7 @@ import {ChatsComponent} from './containers/chats/chats.component';\n import {ChatsListComponent} from './components/chats-list/chats-list.component';\n import {TruncateModule} from 'ng2-truncate';\n import {SharedModule} from '../shared/shared.module';\n-import {SelectableListModule} from 'ngx-selectable-list';\n+import {NgxSelectableListModule} from 'ngx-selectable-list';\n import {AuthGuard} from '../login/services/auth.guard';\n\n const routes: Routes = [\n@@ -42,7 +42,7 @@ const routes: Routes = [\n     TruncateModule,\n     // Feature modules\n     SharedModule,\n-    SelectableListModule,\n+    NgxSelectableListModule,\n   ],\n   providers: [\n     ChatsService,\ndiff --git a/client/src/app/chats-lister/components/chat-item/chat-item.component.ts b/client/src/app/chats-lister/components/chat-item/chat-item.component.ts\nindex afd5b1d..dae6050 100644\n--- a/client/src/app/chats-lister/components/chat-item/chat-item.component.ts\n+++ b/client/src/app/chats-lister/components/chat-item/chat-item.component.ts\n@@ -9,7 +9,9 @@ import {GetChats} from '../../../../types';\n           <img *ngIf=\"chat.picture\" [src]=\"chat.picture\" width=\"48\" height=\"48\">\n           <div>{{ chat.name }} [id: {{ chat.id }}]</div>\n         </div>\n-        <div class=\"chat-content\">{{ chat.messages[chat.messages.length - 1]?.content | truncate : 20 : '...' }}</div>\n+        <div class=\"chat-content\">\n+          {{ chat.messageFeed.messages[chat.messageFeed.messages.length - 1]?.content | truncate : 20 : '...' }}\n+        </div>\n     </div>\n   `,\n   styleUrls: ['chat-item.component.scss'],\ndiff --git a/client/src/app/chats-lister/components/chats-list/chats-list.component.ts b/client/src/app/chats-lister/components/chats-list/chats-list.component.ts\nindex 161d07c..0a13405 100644\n--- a/client/src/app/chats-lister/components/chats-list/chats-list.component.ts\n+++ b/client/src/app/chats-lister/components/chats-list/chats-list.component.ts\n@@ -8,7 +8,7 @@ import {SelectableListDirective} from 'ngx-selectable-list';\n     <mat-list>\n       <mat-list-item *ngFor=\"let chat of chats\">\n         <app-chat-item [item]=\"chat\"\n-                       appSelectableItem></app-chat-item>\n+                       libSelectableItem></app-chat-item>\n       </mat-list-item>\n     </mat-list>\n     <ng-content *ngIf=\"selectableListDirective.selecting\"></ng-content>\ndiff --git a/client/src/app/chats-lister/containers/chats/chats.component.spec.ts b/client/src/app/chats-lister/containers/chats/chats.component.spec.ts\nindex 0377385..e7835d0 100644\n--- a/client/src/app/chats-lister/containers/chats/chats.component.spec.ts\n+++ b/client/src/app/chats-lister/containers/chats/chats.component.spec.ts\n@@ -13,7 +13,7 @@ import {HttpLink, HttpLinkModule, Options} from 'apollo-angular-link-http';\n import {defaultDataIdFromObject, InMemoryCache} from 'apollo-cache-inmemory';\n import {By} from '@angular/platform-browser';\n import {RouterTestingModule} from '@angular/router/testing';\n-import {SelectableListModule} from 'ngx-selectable-list';\n+import {NgxSelectableListModule} from 'ngx-selectable-list';\n import {LoginService} from '../../../login/services/login.service';\n\n describe('ChatsComponent', () => {\n@@ -332,7 +332,7 @@ describe('ChatsComponent', () => {\n         HttpLinkModule,\n         HttpClientTestingModule,\n         RouterTestingModule,\n-        SelectableListModule,\n+        NgxSelectableListModule,\n       ],\n       providers: [\n         ChatsService,\ndiff --git a/client/src/app/chats-lister/containers/chats/chats.component.ts b/client/src/app/chats-lister/containers/chats/chats.component.ts\nindex 69ce46c..6f78b4a 100644\n--- a/client/src/app/chats-lister/containers/chats/chats.component.ts\n+++ b/client/src/app/chats-lister/containers/chats/chats.component.ts\n@@ -1,6 +1,6 @@\n import {Component, OnInit} from '@angular/core';\n import {ChatsService} from '../../../services/chats.service';\n-import {Observable} from 'rxjs/Observable';\n+import {Observable} from 'rxjs';\n import {GetChats} from '../../../../types';\n import {Router} from '@angular/router';\n\n@@ -29,7 +29,7 @@ import {Router} from '@angular/router';\n     </mat-menu>\n\n     <app-chats-list [items]=\"chats$ | async\"\n-                    appSelectableList=\"both\"\n+                    libSelectableList=\"both\"\n                     (single)=\"goToChat($event)\" (multiple)=\"deleteChats($event)\" (isSelecting)=\"isSelecting = $event\">\n       <app-confirm-selection #confirmSelection></app-confirm-selection>\n     </app-chats-list>\ndiff --git a/client/src/app/login/services/auth.interceptor.ts b/client/src/app/login/services/auth.interceptor.ts\nindex c0dc097..9f374dd 100644\n--- a/client/src/app/login/services/auth.interceptor.ts\n+++ b/client/src/app/login/services/auth.interceptor.ts\n@@ -1,6 +1,6 @@\n import {Injectable} from '@angular/core';\n import {HttpEvent, HttpHandler, HttpInterceptor, HttpRequest} from '@angular/common/http';\n-import {Observable} from 'rxjs/Observable';\n+import {Observable} from 'rxjs';\n import {LoginService} from './login.service';\n\n @Injectable()\ndiff --git a/client/src/app/services/chats.service.ts b/client/src/app/services/chats.service.ts\nindex 6bd09bd..1c737bc 100644\n--- a/client/src/app/services/chats.service.ts\n+++ b/client/src/app/services/chats.service.ts\n@@ -1,10 +1,10 @@\n-import {ApolloQueryResult, MutationOptions, WatchQueryOptions} from 'apollo-client';\n+import {ApolloQueryResult, FetchMoreOptions, FetchMoreQueryOptions, MutationOptions, WatchQueryOptions} from 'apollo-client';\n import {concat, map, share, switchMap} from 'rxjs/operators';\n import {Apollo, QueryRef} from 'apollo-angular';\n import {Injectable} from '@angular/core';\n import {getChatsQuery} from '../../graphql/getChats.query';\n import {\n-  AddChat, AddGroup, AddMessage, GetChat, GetChats, GetUsers, MessageAdded, RemoveAllMessages, RemoveChat,\n+  AddChat, AddGroup, AddMessage, GetChat, GetChats, GetUsers, MessageAdded, MoreMessages, RemoveAllMessages, RemoveChat,\n   RemoveMessages\n } from '../../types';\n import {getChatQuery} from '../../graphql/getChat.query';\n@@ -14,20 +14,20 @@ import {DocumentNode} from 'graphql';\n import {removeAllMessagesMutation} from '../../graphql/removeAllMessages.mutation';\n import {removeMessagesMutation} from '../../graphql/removeMessages.mutation';\n import {getUsersQuery} from '../../graphql/getUsers.query';\n-import {Observable} from 'rxjs/Observable';\n+import {Observable, AsyncSubject, of} from 'rxjs';\n import {addChatMutation} from '../../graphql/addChat.mutation';\n import {addGroupMutation} from '../../graphql/addGroup.mutation';\n import * as moment from 'moment';\n-import {AsyncSubject} from 'rxjs/AsyncSubject';\n-import {of} from 'rxjs/observable/of';\n import {FetchResult} from 'apollo-link';\n import {LoginService} from '../login/services/login.service';\n import {chatAddedSubscription} from '../../graphql/chatAdded.subscription';\n import {messageAddedSubscription} from '../../graphql/messageAdded.subscription';\n+import {moreMessagesQuery} from '../../graphql/moreMessages.query';\n\n @Injectable()\n export class ChatsService {\n-  messagesAmount = 3;\n+  chatsMessagesAmount = 2;\n+  chatMessagesAmount = 5;\n   getChatsWq: QueryRef<GetChats.Query>;\n   chats$: Observable<GetChats.Chats[]>;\n   chats: GetChats.Chats[];\n@@ -39,12 +39,15 @@ export class ChatsService {\n     this.getChatsWq = this.apollo.watchQuery<GetChats.Query>(<WatchQueryOptions>{\n       query: getChatsQuery,\n       variables: {\n-        amount: this.messagesAmount,\n+        amount: this.chatsMessagesAmount,\n       },\n     });\n\n     this.getChatsWq.subscribeToMore({\n       document: chatAddedSubscription,\n+      variables: {\n+        amount: this.chatsMessagesAmount,\n+      },\n       updateQuery: (prev: GetChats.Query, { subscriptionData }) => {\n         if (!subscriptionData.data) {\n           return prev;\n@@ -73,20 +76,25 @@ export class ChatsService {\n           const {chat}: GetChat.Query = this.apollo.getClient().readQuery({\n             query: getChatQuery, variables: {\n               chatId: newMessage.chat.id,\n+              amount: this.chatMessagesAmount,\n             }\n           });\n\n           // Add our message from the mutation to the end.\n-          chat.messages.push(newMessage);\n+          chat.messageFeed.messages.push(newMessage);\n           // Write our data back to the cache.\n-          this.apollo.getClient().writeQuery({ query: getChatQuery, data: {chat} });\n+          this.apollo.getClient().writeQuery({\n+            query: getChatQuery,\n+            variables: {chatId: newMessage.chat.id, amount: this.chatMessagesAmount},\n+            data: {chat} });\n         } catch {\n           console.error('The chat we received an update for does not exist in the store');\n         }\n\n         return Object.assign({}, prev, {\n-          chats: [...prev.chats.map(_chat =>\n-            _chat.id === newMessage.chat.id ? {..._chat, messages: [..._chat.messages, newMessage]} : _chat)]\n+          chats: [...prev.chats.map(chat => chat.id === newMessage.chat.id ? {\n+            ...chat, messageFeed: {...chat.messageFeed, messages: [...chat.messageFeed.messages, newMessage]}\n+          } : chat)]\n         });\n       }\n     });\n@@ -105,7 +113,7 @@ export class ChatsService {\n     return {query: this.getChatsWq, chats$: this.chats$};\n   }\n\n-  getChat(chatId: string, oui?: boolean) {\n+  getChat(chatId: string, oui?: boolean, amount?: number) {\n     const _chat = this.chats && this.chats.find(chat => chat.id === chatId) || {\n       id: chatId,\n       name: '',\n@@ -113,7 +121,11 @@ export class ChatsService {\n       allTimeMembers: [],\n       unreadMessages: 0,\n       isGroup: false,\n-      messages: [],\n+      messageFeed: {\n+        hasNextPage: false,\n+        cursor: null,\n+        messages: [],\n+      },\n     };\n     const chat$FromCache = of<GetChat.Chat>(_chat);\n\n@@ -122,6 +134,7 @@ export class ChatsService {\n         query: getChatQuery,\n         variables: {\n           chatId: id,\n+          amount: this.chatMessagesAmount,\n         }\n       });\n     };\n@@ -154,6 +167,34 @@ export class ChatsService {\n     return {query$: this.getChatWqSubject.asObservable(), chat$};\n   }\n\n+  moreMessages(query: QueryRef<GetChat.Query>, chatId: string) {\n+    const {data: {chat: {messageFeed}}} = query.getLastResult();\n+    if (messageFeed.hasNextPage) {\n+      query.fetchMore({\n+        query: moreMessagesQuery,\n+        variables: {\n+          chatId,\n+          amount: this.chatMessagesAmount,\n+          before: messageFeed.cursor,\n+        },\n+        updateQuery: (previousResult: GetChat.Query, { fetchMoreResult }) => {\n+          return {\n+            chat: {\n+              ...previousResult.chat,\n+              messageFeed: {\n+                ...fetchMoreResult.chat.messageFeed,\n+                messages: [\n+                  ...fetchMoreResult.chat.messageFeed.messages,\n+                  ...previousResult.chat.messageFeed.messages,\n+                ],\n+              },\n+            },\n+          };\n+        },\n+      });\n+    }\n+  }\n+\n   addMessage(chatId: string, content: string) {\n     return this.apollo.mutate(<MutationOptions>{\n       mutation: addMessageMutation,\n@@ -166,14 +207,17 @@ export class ChatsService {\n         addMessage: {\n           id: ChatsService.getRandomId(),\n           __typename: 'Message',\n-          senderId: this.loginService.getUser().id,\n+          chat: {\n+            id: chatId,\n+            __typename: 'Chat',\n+          },\n           sender: {\n             id: this.loginService.getUser().id,\n             __typename: 'User',\n             name: this.loginService.getUser().name,\n           },\n           content,\n-          createdAt: moment().unix(),\n+          createdAt: new Date(),\n           type: 0,\n           recipients: [],\n           ownership: true,\n@@ -186,12 +230,13 @@ export class ChatsService {\n           const {chat}: GetChat.Query = store.readQuery({\n             query: getChatQuery, variables: {\n               chatId,\n+              amount: this.chatMessagesAmount,\n             }\n           });\n           // Add our message from the mutation to the end.\n-          chat.messages.push(addMessage);\n+          chat.messageFeed.messages.push(addMessage);\n           // Write our data back to the cache.\n-          store.writeQuery({ query: getChatQuery, data: {chat} });\n+          store.writeQuery({ query: getChatQuery, variables: {chatId, amount: this.chatMessagesAmount}, data: {chat} });\n         }\n         // Update last message cache\n         {\n@@ -199,16 +244,16 @@ export class ChatsService {\n           const {chats}: GetChats.Query = store.readQuery({\n             query: getChatsQuery,\n             variables: <GetChats.Variables>{\n-              amount: this.messagesAmount,\n+              amount: this.chatsMessagesAmount,\n             },\n           });\n           // Add our comment from the mutation to the end.\n-          chats.find(chat => chat.id === chatId).messages.push(addMessage);\n+          chats.find(chat => chat.id === chatId).messageFeed.messages.push(addMessage);\n           // Write our data back to the cache.\n           store.writeQuery({\n             query: getChatsQuery,\n             variables: <GetChats.Variables>{\n-              amount: this.messagesAmount,\n+              amount: this.chatsMessagesAmount,\n             },\n             data: {\n               chats,\n@@ -234,7 +279,7 @@ export class ChatsService {\n         const {chats}: GetChats.Query = store.readQuery({\n           query: getChatsQuery,\n           variables: <GetChats.Variables>{\n-            amount: this.messagesAmount,\n+            amount: this.chatsMessagesAmount,\n           },\n         });\n         // Remove the chat (mutable)\n@@ -247,7 +292,7 @@ export class ChatsService {\n         store.writeQuery({\n           query: getChatsQuery,\n           variables: <GetChats.Variables>{\n-            amount: this.messagesAmount,\n+            amount: this.chatsMessagesAmount,\n           },\n           data: {\n             chats,\n@@ -286,18 +331,19 @@ export class ChatsService {\n           const {chat}: GetChat.Query = store.readQuery({\n             query: getChatQuery, variables: {\n               chatId,\n+              amount: this.chatMessagesAmount,\n             }\n           });\n           // Remove the messages (mutable)\n           removeMessages.forEach(messageId => {\n-            for (const index of chat.messages.keys()) {\n-              if (chat.messages[index].id === messageId) {\n-                chat.messages.splice(index, 1);\n+            for (const index of chat.messageFeed.messages.keys()) {\n+              if (chat.messageFeed.messages[index].id === messageId) {\n+                chat.messageFeed.messages.splice(index, 1);\n               }\n             }\n           });\n           // Write our data back to the cache.\n-          store.writeQuery({ query: getChatQuery, data: {chat} });\n+          store.writeQuery({ query: getChatQuery, variables: {chatId, amount: this.chatMessagesAmount}, data: {chat} });\n         }\n         // Update last message cache\n         {\n@@ -305,18 +351,18 @@ export class ChatsService {\n           const {chats}: GetChats.Query = store.readQuery({\n             query: getChatsQuery,\n             variables: <GetChats.Variables>{\n-              amount: this.messagesAmount,\n+              amount: this.chatsMessagesAmount,\n             },\n           });\n           // Fix last message\n-          chats.find(chat => chat.id === chatId).messages = messages\n+          chats.find(chat => chat.id === chatId).messageFeed.messages = messages\n             .filter(message => !ids.includes(message.id))\n             .sort((a, b) => Number(b.createdAt) - Number(a.createdAt)) || [];\n           // Write our data back to the cache.\n           store.writeQuery({\n             query: getChatsQuery,\n             variables: <GetChats.Variables>{\n-              amount: this.messagesAmount,\n+              amount: this.chatsMessagesAmount,\n             },\n             data: {\n               chats,\n@@ -371,7 +417,12 @@ export class ChatsService {\n             }\n           ],\n           unreadMessages: 0,\n-          messages: [],\n+          messageFeed: {\n+            __typename: 'MessageFeed',\n+            hasNextPage: false,\n+            cursor: null,\n+            messages: [],\n+          },\n           isGroup: false,\n         },\n       },\n@@ -380,7 +431,7 @@ export class ChatsService {\n         const {chats}: GetChats.Query = store.readQuery({\n           query: getChatsQuery,\n           variables: <GetChats.Variables>{\n-            amount: this.messagesAmount,\n+            amount: this.chatsMessagesAmount,\n           },\n         });\n         // Add our comment from the mutation to the end.\n@@ -389,7 +440,7 @@ export class ChatsService {\n         store.writeQuery({\n           query: getChatsQuery,\n           variables: <GetChats.Variables>{\n-            amount: this.messagesAmount,\n+            amount: this.chatsMessagesAmount,\n           },\n           data: {\n             chats,\n@@ -423,7 +474,12 @@ export class ChatsService {\n             ...recipientIds.map(id => ({id, __typename: 'User'})),\n           ],\n           unreadMessages: 0,\n-          messages: [],\n+          messageFeed: {\n+            __typename: 'MessageFeed',\n+            hasNextPage: false,\n+            cursor: null,\n+            messages: [],\n+          },\n           isGroup: true,\n         },\n       },\n@@ -432,7 +488,7 @@ export class ChatsService {\n         const {chats}: GetChats.Query = store.readQuery({\n           query: getChatsQuery,\n           variables: <GetChats.Variables>{\n-            amount: this.messagesAmount,\n+            amount: this.chatsMessagesAmount,\n           },\n         });\n         // Add our comment from the mutation to the end.\n@@ -441,7 +497,7 @@ export class ChatsService {\n         store.writeQuery({\n           query: getChatsQuery,\n           variables: <GetChats.Variables>{\n-            amount: this.messagesAmount,\n+            amount: this.chatsMessagesAmount,\n           },\n           data: {\n             chats,\ndiff --git a/client/src/browserslist b/client/src/browserslist\nnew file mode 100644\nindex 0000000..8e09ab4\n--- /dev/null\n+++ b/client/src/browserslist\n@@ -0,0 +1,9 @@\n+# This file is currently used by autoprefixer to adjust CSS to support the below specified browsers\n+# For additional information regarding the format and rule options, please see:\n+# https://github.com/browserslist/browserslist#queries\n+# For IE 9-11 support, please uncomment the last line of the file and adjust as needed\n+> 0.5%\n+last 2 versions\n+Firefox ESR\n+not dead\n+# IE 9-11\n\\ No newline at end of file\ndiff --git a/client/src/environments/environment.ts b/client/src/environments/environment.ts\nindex b7f639a..012182e 100644\n--- a/client/src/environments/environment.ts\n+++ b/client/src/environments/environment.ts\n@@ -1,8 +1,15 @@\n-// The file contents for the current environment will overwrite these during build.\n-// The build system defaults to the dev environment which uses `environment.ts`, but if you do\n-// `ng build --env=prod` then `environment.prod.ts` will be used instead.\n-// The list of which env maps to which file can be found in `.angular-cli.json`.\n+// This file can be replaced during build by using the `fileReplacements` array.\n+// `ng build ---prod` replaces `environment.ts` with `environment.prod.ts`.\n+// The list of file replacements can be found in `angular.json`.\n\n export const environment = {\n   production: false\n };\n+\n+/*\n+ * In development mode, to ignore zone related error stack frames such as\n+ * `zone.run`, `zoneDelegate.invokeTask` for easier debugging, you can\n+ * import the following file, but please comment it out in production mode\n+ * because it will have performance impact when throw error\n+ */\n+// import 'zone.js/dist/zone-error';  // Included with Angular CLI.\ndiff --git a/client/src/graphql/addChat.mutation.ts b/client/src/graphql/addChat.mutation.ts\nindex cf33eba..3e4da4c 100644\n--- a/client/src/graphql/addChat.mutation.ts\n+++ b/client/src/graphql/addChat.mutation.ts\n@@ -6,8 +6,12 @@ export const addChatMutation = gql`\n   mutation AddChat($recipientId: ID!) {\n     addChat(recipientId: $recipientId) {\n       ...ChatWithoutMessages\n-      messages {\n-        ...Message\n+      messageFeed {\n+        hasNextPage,\n+        cursor,\n+        messages {\n+          ...Message\n+        }\n       }\n     }\n   }\ndiff --git a/client/src/graphql/addGroup.mutation.ts b/client/src/graphql/addGroup.mutation.ts\nindex 8fb2362..07eeb21 100644\n--- a/client/src/graphql/addGroup.mutation.ts\n+++ b/client/src/graphql/addGroup.mutation.ts\n@@ -6,8 +6,12 @@ export const addGroupMutation = gql`\n   mutation AddGroup($recipientIds: [ID!]!, $groupName: String!) {\n     addGroup(recipientIds: $recipientIds, groupName: $groupName) {\n       ...ChatWithoutMessages\n-      messages {\n-        ...Message\n+      messageFeed {\n+        hasNextPage,\n+        cursor,\n+        messages {\n+          ...Message\n+        }\n       }\n     }\n   }\ndiff --git a/client/src/graphql/chatAdded.subscription.ts b/client/src/graphql/chatAdded.subscription.ts\nindex 9f6afe5..e6f194d 100644\n--- a/client/src/graphql/chatAdded.subscription.ts\n+++ b/client/src/graphql/chatAdded.subscription.ts\n@@ -3,11 +3,15 @@ import {fragments} from './fragment';\n\n // We use the gql tag to parse our query string into a query document\n export const chatAddedSubscription = gql`\n-  subscription chatAdded {\n+  subscription chatAdded($amount: Int!) {\n     chatAdded {\n       ...ChatWithoutMessages\n-      messages {\n-        ...Message\n+      messageFeed(amount: $amount) {\n+        hasNextPage,\n+        cursor,\n+        messages {\n+          ...Message\n+        }\n       }\n     }\n   }\ndiff --git a/client/src/graphql/getChat.query.ts b/client/src/graphql/getChat.query.ts\nindex 621c4b9..5386633 100644\n--- a/client/src/graphql/getChat.query.ts\n+++ b/client/src/graphql/getChat.query.ts\n@@ -3,11 +3,15 @@ import {fragments} from './fragment';\n\n // We use the gql tag to parse our query string into a query document\n export const getChatQuery = gql`\n-  query GetChat($chatId: ID!) {\n+  query GetChat($chatId: ID!, $amount: Int!) {\n     chat(chatId: $chatId) {\n       ...ChatWithoutMessages\n-      messages {\n-        ...Message\n+      messageFeed(amount: $amount) {\n+        hasNextPage,\n+        cursor,\n+        messages {\n+          ...Message\n+        }\n       }\n     }\n   }\ndiff --git a/client/src/graphql/getChats.query.ts b/client/src/graphql/getChats.query.ts\nindex 44e6d96..127a70d 100644\n--- a/client/src/graphql/getChats.query.ts\n+++ b/client/src/graphql/getChats.query.ts\n@@ -3,11 +3,15 @@ import {fragments} from './fragment';\n\n // We use the gql tag to parse our query string into a query document\n export const getChatsQuery = gql`\n-  query GetChats($amount: Int) {\n+  query GetChats($amount: Int!) {\n     chats {\n       ...ChatWithoutMessages\n-      messages(amount: $amount) {\n-        ...Message\n+      messageFeed(amount: $amount) {\n+        hasNextPage,\n+        cursor,\n+        messages {\n+          ...Message\n+        }\n       }\n     }\n   }\ndiff --git a/client/src/graphql/moreMessages.query.ts b/client/src/graphql/moreMessages.query.ts\nnew file mode 100644\nindex 0000000..369d028\n--- /dev/null\n+++ b/client/src/graphql/moreMessages.query.ts\n@@ -0,0 +1,19 @@\n+import gql from 'graphql-tag';\n+import {fragments} from './fragment';\n+\n+// We use the gql tag to parse our query string into a query document\n+export const moreMessagesQuery = gql`\n+  query MoreMessages($chatId: ID!, $amount: Int!, $before: String!) {\n+    chat(chatId: $chatId) {\n+      messageFeed(amount: $amount, before: $before) {\n+        hasNextPage,\n+        cursor,\n+        messages {\n+          ...Message\n+        }\n+      }\n+    }\n+  }\n+\n+  ${fragments['message']}\n+`;\ndiff --git a/client/karma.conf.js b/client/src/karma.conf.js\nsimilarity index 76%\nrename from client/karma.conf.js\nrename to client/src/karma.conf.js\nindex 68c2f7c..aa9f74a 100644\n--- a/client/karma.conf.js\n+++ b/client/src/karma.conf.js\n@@ -4,24 +4,22 @@\n module.exports = function (config) {\n   config.set({\n     basePath: '',\n-    frameworks: ['jasmine', '@angular/cli'],\n+    frameworks: ['jasmine', '@angular-devkit/build-angular'],\n     plugins: [\n       require('karma-jasmine'),\n       require('karma-chrome-launcher'),\n       require('karma-jasmine-html-reporter'),\n       require('karma-coverage-istanbul-reporter'),\n-      require('@angular/cli/plugins/karma')\n+      require('@angular-devkit/build-angular/plugins/karma')\n     ],\n-    client:{\n+    client: {\n       clearContext: false // leave Jasmine Spec Runner output visible in browser\n     },\n     coverageIstanbulReporter: {\n-      reports: [ 'html', 'lcovonly' ],\n+      dir: require('path').join(__dirname, '../coverage'),\n+      reports: ['html', 'lcovonly'],\n       fixWebpackSourcePaths: true\n     },\n-    angularCli: {\n-      environment: 'dev'\n-    },\n     reporters: ['progress', 'kjhtml'],\n     port: 9876,\n     colors: true,\ndiff --git a/client/src/polyfills.ts b/client/src/polyfills.ts\nindex af84770..d310405 100644\n--- a/client/src/polyfills.ts\n+++ b/client/src/polyfills.ts\n@@ -47,8 +47,9 @@ import 'core-js/es7/reflect';\n\n\n /**\n- * Required to support Web Animations `@angular/platform-browser/animations`.\n- * Needed for: All but Chrome, Firefox and Opera. http://caniuse.com/#feat=web-animation\n+ * Web Animations `@angular/platform-browser/animations`\n+ * Only required if AnimationBuilder is used within the application and using IE/Edge or Safari.\n+ * Standard animation support in Angular DOES NOT require any polyfills (as of Angular 6.0).\n  **/\n // import 'web-animations-js';  // Run `npm install --save web-animations-js`.\n\ndiff --git a/client/src/tsconfig.app.json b/client/src/tsconfig.app.json\nindex 39ba8db..722c370 100644\n--- a/client/src/tsconfig.app.json\n+++ b/client/src/tsconfig.app.json\n@@ -2,12 +2,11 @@\n   \"extends\": \"../tsconfig.json\",\n   \"compilerOptions\": {\n     \"outDir\": \"../out-tsc/app\",\n-    \"baseUrl\": \"./\",\n     \"module\": \"es2015\",\n     \"types\": []\n   },\n   \"exclude\": [\n-    \"test.ts\",\n+    \"src/test.ts\",\n     \"**/*.spec.ts\"\n   ]\n }\ndiff --git a/client/src/tsconfig.spec.json b/client/src/tsconfig.spec.json\nindex ac22a29..8f7cede 100644\n--- a/client/src/tsconfig.spec.json\n+++ b/client/src/tsconfig.spec.json\n@@ -2,7 +2,6 @@\n   \"extends\": \"../tsconfig.json\",\n   \"compilerOptions\": {\n     \"outDir\": \"../out-tsc/spec\",\n-    \"baseUrl\": \"./\",\n     \"module\": \"commonjs\",\n     \"types\": [\n       \"jasmine\",\n@@ -10,7 +9,8 @@\n     ]\n   },\n   \"files\": [\n-    \"test.ts\"\n+    \"test.ts\",\n+    \"polyfills.ts\"\n   ],\n   \"include\": [\n     \"**/*.spec.ts\",\ndiff --git a/client/src/tslint.json b/client/src/tslint.json\nnew file mode 100644\nindex 0000000..52e2c1a\n--- /dev/null\n+++ b/client/src/tslint.json\n@@ -0,0 +1,17 @@\n+{\n+    \"extends\": \"../tslint.json\",\n+    \"rules\": {\n+        \"directive-selector\": [\n+            true,\n+            \"attribute\",\n+            \"app\",\n+            \"camelCase\"\n+        ],\n+        \"component-selector\": [\n+            true,\n+            \"element\",\n+            \"app\",\n+            \"kebab-case\"\n+        ]\n+    }\n+}\ndiff --git a/client/src/types.d.ts b/client/src/types.d.ts\nindex b1986ca..b4b3c22 100644\n--- a/client/src/types.d.ts\n+++ b/client/src/types.d.ts\n@@ -1,321 +1,446 @@\n /* tslint:disable */\n\n+/** A date-time string at UTC, such as 2007-12-03T10:15:30Z, compliant with the `date-time` format outlined in section 5.6 of the RFC 3339 profile of the ISO 8601 standard for representation of dates and times using the Gregorian calendar. */\n+export type DateTime = any;\n+\n export interface Query {\n-  users: User[];\n-  chats: Chat[];\n-  chat?: Chat | null;\n+  users?: User[] | null;\n+  chats?: Chat[] | null;\n+  chat?: Chat | null;\n }\n\n export interface User {\n-  id: string;\n-  name?: string | null;\n-  picture?: string | null;\n-  phone?: string | null;\n+  id: string;\n+  name?: string | null;\n+  picture?: string | null;\n+  phone?: string | null;\n }\n\n export interface Chat {\n-  id: string; /* May be a chat or a group */\n-  name?: string | null; /* Computed for chats */\n-  picture?: string | null; /* Computed for chats */\n-  allTimeMembers: User[]; /* All members, current and past ones. */\n-  listingMembers: User[]; /* Whoever gets the chat listed. For groups includes past members who still didn&#x27;t delete the group. */\n-  actualGroupMembers: User[]; /* Actual members of the group (they are not the only ones who get the group listed). Null for chats. */\n-  admins: User[]; /* Null for chats */\n-  owner?: User | null; /* If null the group is read-only. Null for chats. */\n-  messages: Message[];\n-  unreadMessages: number; /* Computed property */\n-  isGroup: boolean; /* Computed property */\n+  id: string /** May be a chat or a group */;\n+  name?: string | null /** Computed for chats */;\n+  picture?: string | null /** Computed for chats */;\n+  allTimeMembers: User[] /** All members, current and past ones. */;\n+  listingMembers: User[] /** Whoever gets the chat listed. For groups includes past members who still didn't delete the group. */;\n+  actualGroupMembers: User[] /** Actual members of the group (they are not the only ones who get the group listed). Null for chats. */;\n+  admins?: User[] | null /** Null for chats */;\n+  owner?: User | null /** If null the group is read-only. Null for chats. */;\n+  messages: (Message | null)[];\n+  messageFeed?: MessageFeed | null /** Return messages in a a Feed Wrapper with cursor based pagination */;\n+  unreadMessages: number /** Computed property */;\n+  isGroup: boolean /** Computed property */;\n }\n\n export interface Message {\n-  id: string;\n-  sender: User;\n-  chat: Chat;\n-  content: string;\n-  createdAt: string;\n-  type: number; /* FIXME: should return MessageType */\n-  recipients: Recipient[]; /* Whoever received the message */\n-  holders: User[]; /* Whoever still holds a copy of the message. Cannot be null because the message gets deleted otherwise */\n-  ownership: boolean; /* Computed property */\n+  id: string;\n+  sender: User;\n+  chat: Chat;\n+  content: string;\n+  createdAt: DateTime;\n+  type: number /** FIXME: should return MessageType */;\n+  recipients: Recipient[] /** Whoever received the message */;\n+  holders: User[] /** Whoever still holds a copy of the message. Cannot be null because the message gets deleted otherwise */;\n+  ownership: boolean /** Computed property */;\n }\n\n export interface Recipient {\n-  user: User;\n-  message: Message;\n-  receivedAt?: string | null;\n-  readAt?: string | null;\n+  user: User;\n+  message: Message;\n+  chat: Chat;\n+  receivedAt?: DateTime | null;\n+  readAt?: DateTime | null;\n+}\n+\n+export interface MessageFeed {\n+  hasNextPage: boolean;\n+  cursor?: string | null;\n+  messages: (Message | null)[];\n }\n\n export interface Mutation {\n-  addChat?: Chat | null;\n-  addGroup?: Chat | null;\n-  removeChat?: string | null;\n-  addMessage?: Message | null;\n-  removeMessages?: string[] | null;\n-  addMembers?: string[] | null;\n-  removeMembers?: string[] | null;\n-  addAdmins?: string[] | null;\n-  removeAdmins?: string[] | null;\n-  setGroupName?: string | null;\n-  setGroupPicture?: string | null;\n-  markAsReceived?: boolean | null;\n-  markAsRead?: boolean | null;\n+  addChat?: Chat | null;\n+  addGroup?: Chat | null;\n+  removeChat?: string | null;\n+  addMessage?: Message | null;\n+  removeMessages?: (string | null)[] | null;\n+  addMembers?: (string | null)[] | null;\n+  removeMembers?: (string | null)[] | null;\n+  addAdmins?: (string | null)[] | null;\n+  removeAdmins?: (string | null)[] | null;\n+  setGroupName?: string | null;\n+  setGroupPicture?: string | null;\n+  markAsReceived?: boolean | null;\n+  markAsRead?: boolean | null;\n }\n\n export interface Subscription {\n-  messageAdded?: Message | null;\n-  chatAdded?: Chat | null;\n+  messageAdded?: Message | null;\n+  chatAdded?: Chat | null;\n }\n export interface ChatQueryArgs {\n-  chatId: string;\n+  chatId: string;\n }\n export interface MessagesChatArgs {\n-  amount?: number | null;\n+  amount?: number | null;\n+  before?: string | null;\n+}\n+export interface MessageFeedChatArgs {\n+  amount?: number | null;\n+  before?: string | null;\n }\n export interface AddChatMutationArgs {\n-  recipientId: string;\n+  recipientId: string;\n }\n export interface AddGroupMutationArgs {\n-  recipientIds: string[];\n-  groupName: string;\n+  recipientIds: string[];\n+  groupName: string;\n }\n export interface RemoveChatMutationArgs {\n-  chatId: string;\n+  chatId: string;\n }\n export interface AddMessageMutationArgs {\n-  chatId: string;\n-  content: string;\n+  chatId: string;\n+  content: string;\n }\n export interface RemoveMessagesMutationArgs {\n-  chatId: string;\n-  messageIds?: string[] | null;\n-  all?: boolean | null;\n+  chatId: string;\n+  messageIds?: (string | null)[] | null;\n+  all?: boolean | null;\n }\n export interface AddMembersMutationArgs {\n-  groupId: string;\n-  userIds: string[];\n+  groupId: string;\n+  userIds: string[];\n }\n export interface RemoveMembersMutationArgs {\n-  groupId: string;\n-  userIds: string[];\n+  groupId: string;\n+  userIds: string[];\n }\n export interface AddAdminsMutationArgs {\n-  groupId: string;\n-  userIds: string[];\n+  groupId: string;\n+  userIds: string[];\n }\n export interface RemoveAdminsMutationArgs {\n-  groupId: string;\n-  userIds: string[];\n+  groupId: string;\n+  userIds: string[];\n }\n export interface SetGroupNameMutationArgs {\n-  groupId: string;\n+  groupId: string;\n }\n export interface SetGroupPictureMutationArgs {\n-  groupId: string;\n+  groupId: string;\n }\n export interface MarkAsReceivedMutationArgs {\n-  chatId: string;\n+  chatId: string;\n }\n export interface MarkAsReadMutationArgs {\n-  chatId: string;\n+  chatId: string;\n }\n export interface MessageAddedSubscriptionArgs {\n-  chatId?: string | null;\n+  chatId?: string | null;\n }\n\n-export type MessageType = \"LOCATION\" | \"TEXT\" | \"PICTURE\";\n-\n+export enum MessageType {\n+  LOCATION = \"LOCATION\",\n+  TEXT = \"TEXT\",\n+  PICTURE = \"PICTURE\"\n+}\n export namespace AddChat {\n   export type Variables = {\n     recipientId: string;\n-  }\n+  };\n\n   export type Mutation = {\n-    addChat?: AddChat | null;\n-  }\n+    __typename?: \"Mutation\";\n+    addChat?: AddChat | null;\n+  };\n\n   export type AddChat = {\n-    messages: Messages[];\n-  } & ChatWithoutMessages.Fragment\n+    __typename?: \"Chat\";\n+    messageFeed?: MessageFeed | null;\n+  } & ChatWithoutMessages.Fragment;\n\n-  export type Messages = Message.Fragment\n+  export type MessageFeed = {\n+    __typename?: \"MessageFeed\";\n+    hasNextPage: boolean;\n+    cursor?: string | null;\n+    messages: (Messages | null)[];\n+  };\n+\n+  export type Messages = Message.Fragment;\n }\n export namespace AddGroup {\n   export type Variables = {\n     recipientIds: string[];\n     groupName: string;\n-  }\n+  };\n\n   export type Mutation = {\n-    addGroup?: AddGroup | null;\n-  }\n+    __typename?: \"Mutation\";\n+    addGroup?: AddGroup | null;\n+  };\n\n   export type AddGroup = {\n-    messages: Messages[];\n-  } & ChatWithoutMessages.Fragment\n+    __typename?: \"Chat\";\n+    messageFeed?: MessageFeed | null;\n+  } & ChatWithoutMessages.Fragment;\n+\n+  export type MessageFeed = {\n+    __typename?: \"MessageFeed\";\n+    hasNextPage: boolean;\n+    cursor?: string | null;\n+    messages: (Messages | null)[];\n+  };\n\n-  export type Messages = Message.Fragment\n+  export type Messages = Message.Fragment;\n }\n export namespace AddMessage {\n   export type Variables = {\n     chatId: string;\n     content: string;\n-  }\n+  };\n\n   export type Mutation = {\n-    addMessage?: AddMessage | null;\n-  }\n+    __typename?: \"Mutation\";\n+    addMessage?: AddMessage | null;\n+  };\n\n-  export type AddMessage = Message.Fragment\n+  export type AddMessage = Message.Fragment;\n }\n export namespace ChatAdded {\n   export type Variables = {\n-  }\n+    amount: number;\n+  };\n\n   export type Subscription = {\n-    chatAdded?: ChatAdded | null;\n-  }\n+    __typename?: \"Subscription\";\n+    chatAdded?: ChatAdded | null;\n+  };\n\n   export type ChatAdded = {\n-    messages: Messages[];\n-  } & ChatWithoutMessages.Fragment\n+    __typename?: \"Chat\";\n+    messageFeed?: MessageFeed | null;\n+  } & ChatWithoutMessages.Fragment;\n+\n+  export type MessageFeed = {\n+    __typename?: \"MessageFeed\";\n+    hasNextPage: boolean;\n+    cursor?: string | null;\n+    messages: (Messages | null)[];\n+  };\n\n-  export type Messages = Message.Fragment\n+  export type Messages = Message.Fragment;\n }\n export namespace GetChat {\n   export type Variables = {\n     chatId: string;\n-  }\n+    amount: number;\n+  };\n\n   export type Query = {\n-    chat?: Chat | null;\n-  }\n+    __typename?: \"Query\";\n+    chat?: Chat | null;\n+  };\n\n   export type Chat = {\n-    messages: Messages[];\n-  } & ChatWithoutMessages.Fragment\n+    __typename?: \"Chat\";\n+    messageFeed?: MessageFeed | null;\n+  } & ChatWithoutMessages.Fragment;\n\n-  export type Messages = Message.Fragment\n+  export type MessageFeed = {\n+    __typename?: \"MessageFeed\";\n+    hasNextPage: boolean;\n+    cursor?: string | null;\n+    messages: (Messages | null)[];\n+  };\n+\n+  export type Messages = Message.Fragment;\n }\n export namespace GetChats {\n   export type Variables = {\n-    amount?: number | null;\n-  }\n+    amount: number;\n+  };\n\n   export type Query = {\n-    chats: Chats[];\n-  }\n+    __typename?: \"Query\";\n+    chats?: Chats[] | null;\n+  };\n\n   export type Chats = {\n-    messages: Messages[];\n-  } & ChatWithoutMessages.Fragment\n+    __typename?: \"Chat\";\n+    messageFeed?: MessageFeed | null;\n+  } & ChatWithoutMessages.Fragment;\n+\n+  export type MessageFeed = {\n+    __typename?: \"MessageFeed\";\n+    hasNextPage: boolean;\n+    cursor?: string | null;\n+    messages: (Messages | null)[];\n+  };\n\n-  export type Messages = Message.Fragment\n+  export type Messages = Message.Fragment;\n }\n export namespace GetUsers {\n-  export type Variables = {\n-  }\n+  export type Variables = {};\n\n   export type Query = {\n-    users: Users[];\n-  }\n+    __typename?: \"Query\";\n+    users?: Users[] | null;\n+  };\n\n   export type Users = {\n-    id: string;\n-    name?: string | null;\n-    picture?: string | null;\n-  }\n+    __typename?: \"User\";\n+    id: string;\n+    name?: string | null;\n+    picture?: string | null;\n+  };\n }\n export namespace MessageAdded {\n   export type Variables = {\n     chatId?: string | null;\n-  }\n+  };\n\n   export type Subscription = {\n-    messageAdded?: MessageAdded | null;\n-  }\n+    __typename?: \"Subscription\";\n+    messageAdded?: MessageAdded | null;\n+  };\n\n   export type MessageAdded = {\n-    chat: Chat;\n-  } & Message.Fragment\n+    __typename?: \"Message\";\n+    chat: Chat;\n+  } & Message.Fragment;\n\n   export type Chat = {\n-    id: string;\n-  }\n+    __typename?: \"Chat\";\n+    id: string;\n+  };\n+}\n+export namespace MoreMessages {\n+  export type Variables = {\n+    chatId: string;\n+    amount: number;\n+    before: string;\n+  };\n+\n+  export type Query = {\n+    __typename?: \"Query\";\n+    chat?: Chat | null;\n+  };\n+\n+  export type Chat = {\n+    __typename?: \"Chat\";\n+    messageFeed?: MessageFeed | null;\n+  };\n+\n+  export type MessageFeed = {\n+    __typename?: \"MessageFeed\";\n+    hasNextPage: boolean;\n+    cursor?: string | null;\n+    messages: (Messages | null)[];\n+  };\n+\n+  export type Messages = Message.Fragment;\n }\n export namespace RemoveAllMessages {\n   export type Variables = {\n     chatId: string;\n     all?: boolean | null;\n-  }\n+  };\n\n   export type Mutation = {\n-    removeMessages?: string[] | null;\n-  }\n+    __typename?: \"Mutation\";\n+    removeMessages?: (string | null)[] | null;\n+  };\n }\n export namespace RemoveChat {\n   export type Variables = {\n     chatId: string;\n-  }\n+  };\n\n   export type Mutation = {\n-    removeChat?: string | null;\n-  }\n+    __typename?: \"Mutation\";\n+    removeChat?: string | null;\n+  };\n }\n export namespace RemoveMessages {\n   export type Variables = {\n     chatId: string;\n-    messageIds?: string[] | null;\n-  }\n+    messageIds?: (string | null)[] | null;\n+  };\n\n   export type Mutation = {\n-    removeMessages?: string[] | null;\n-  }\n+    __typename?: \"Mutation\";\n+    removeMessages?: (string | null)[] | null;\n+  };\n }\n\n export namespace ChatWithoutMessages {\n   export type Fragment = {\n-    id: string;\n-    name?: string | null;\n-    picture?: string | null;\n-    allTimeMembers: AllTimeMembers[];\n-    unreadMessages: number;\n-    isGroup: boolean;\n-  }\n+    __typename?: \"Chat\";\n+    id: string;\n+    name?: string | null;\n+    picture?: string | null;\n+    allTimeMembers: AllTimeMembers[];\n+    unreadMessages: number;\n+    isGroup: boolean;\n+  };\n\n   export type AllTimeMembers = {\n-    id: string;\n-  }\n+    __typename?: \"User\";\n+    id: string;\n+  };\n }\n\n export namespace Message {\n   export type Fragment = {\n-    id: string;\n-    sender: Sender;\n-    content: string;\n-    createdAt: string;\n-    type: number;\n-    recipients: Recipients[];\n-    ownership: boolean;\n-  }\n+    __typename?: \"Message\";\n+    id: string;\n+    chat: Chat;\n+    sender: Sender;\n+    content: string;\n+    createdAt: DateTime;\n+    type: number;\n+    recipients: Recipients[];\n+    ownership: boolean;\n+  };\n+\n+  export type Chat = {\n+    __typename?: \"Chat\";\n+    id: string;\n+  };\n\n   export type Sender = {\n-    id: string;\n-    name?: string | null;\n-  }\n+    __typename?: \"User\";\n+    id: string;\n+    name?: string | null;\n+  };\n\n   export type Recipients = {\n-    user: User;\n-    message: Message;\n-    receivedAt?: string | null;\n-    readAt?: string | null;\n-  }\n+    __typename?: \"Recipient\";\n+    user: User;\n+    message: Message;\n+    chat: __Chat;\n+    receivedAt?: DateTime | null;\n+    readAt?: DateTime | null;\n+  };\n\n   export type User = {\n-    id: string;\n-  }\n+    __typename?: \"User\";\n+    id: string;\n+  };\n\n   export type Message = {\n-    id: string;\n-  }\n+    __typename?: \"Message\";\n+    id: string;\n+    chat: _Chat;\n+  };\n+\n+  export type _Chat = {\n+    __typename?: \"Chat\";\n+    id: string;\n+  };\n+\n+  export type __Chat = {\n+    __typename?: \"Chat\";\n+    id: string;\n+  };\n }\ndiff --git a/client/src/typings.d.ts b/client/src/typings.d.ts\ndeleted file mode 100644\nindex ef5c7bd..0000000\n--- a/client/src/typings.d.ts\n+++ /dev/null\n@@ -1,5 +0,0 @@\n-/* SystemJS module definition */\n-declare var module: NodeModule;\n-interface NodeModule {\n-  id: string;\n-}\ndiff --git a/client/tsconfig.json b/client/tsconfig.json\nindex d8195f3..9431dd1 100644\n--- a/client/tsconfig.json\n+++ b/client/tsconfig.json\n@@ -1,6 +1,7 @@\n {\n   \"compileOnSave\": false,\n   \"compilerOptions\": {\n+    \"baseUrl\": \"./\",\n     \"outDir\": \"./dist/out-tsc\",\n     \"sourceMap\": true,\n     \"declaration\": false,\ndiff --git a/client/tslint.json b/client/tslint.json\nindex 9963d6c..3ea984c 100644\n--- a/client/tslint.json\n+++ b/client/tslint.json\n@@ -18,7 +18,6 @@\n     \"forin\": true,\n     \"import-blacklist\": [\n       true,\n-      \"rxjs\",\n       \"rxjs/Rx\"\n     ],\n     \"import-spacing\": true,\n@@ -117,18 +116,6 @@\n       \"check-separator\",\n       \"check-type\"\n     ],\n-    \"directive-selector\": [\n-      true,\n-      \"attribute\",\n-      \"app\",\n-      \"camelCase\"\n-    ],\n-    \"component-selector\": [\n-      true,\n-      \"element\",\n-      \"app\",\n-      \"kebab-case\"\n-    ],\n     \"no-output-on-prefix\": true,\n     \"use-input-property-decorator\": true,\n     \"use-output-property-decorator\": true,\ndiff --git a/server/index.ts b/server/index.ts\nindex f8063a6..85fd2d3 100644\n--- a/server/index.ts\n+++ b/server/index.ts\n@@ -24,7 +24,7 @@ function validPassword(password: string, localPassword: string) {\n }\n\n createConnection().then(async connection => {\n-  await addSampleData(connection);\n+  //await addSampleData(connection);\n\n   passport.use('basic-signin', new basicStrategy.BasicStrategy(\n     async function (username, password, done) {\n@@ -62,12 +62,20 @@ createConnection().then(async connection => {\n   app.post('/signup',\n     passport.authenticate('basic-signup', {session: false}),\n     function (req, res) {\n+      if (req.user && req.user.id) {\n+        // We want to return id as string\n+        req.user.id = String(req.user.id);\n+      }\n       res.json(req.user);\n     });\n\n   app.use(passport.authenticate('basic-signin', {session: false}));\n\n   app.post('/signin', function (req, res) {\n+    if (req.user && req.user.id) {\n+      // We want to return id as string\n+      req.user.id = String(req.user.id);\n+    }\n     res.json(req.user);\n   });\n\ndiff --git a/server/package.json b/server/package.json\nindex 05d9063..1c38026 100644\n--- a/server/package.json\n+++ b/server/package.json\n@@ -5,39 +5,42 @@\n   \"scripts\": {\n     \"start\": \"npm run build:live\",\n     \"build:live\": \"nodemon --exec ./node_modules/.bin/ts-node -- ./index.ts\",\n-    \"generator\": \"gql-gen --url http://localhost:3000/graphql --template ts --out ./types.d.ts\"\n+    \"generator\": \"gql-gen --schema http://localhost:3000/graphql --template ts --out ./types.d.ts\"\n   },\n   \"devDependencies\": {\n     \"@types/bcrypt-nodejs\": \"0.0.30\",\n-    \"@types/body-parser\": \"1.16.8\",\n-    \"@types/cors\": \"2.8.3\",\n+    \"@types/body-parser\": \"1.17.0\",\n+    \"@types/cors\": \"2.8.4\",\n     \"@types/express\": \"4.11.1\",\n-    \"@types/graphql\": \"0.12.6\",\n-    \"@types/node\": \"9.6.5\",\n-    \"@types/passport\": \"0.4.4\",\n+    \"@types/graphql\": \"0.13.0\",\n+    \"@types/graphql-iso-date\": \"3.3.0\",\n+    \"@types/node\": \"10.0.6\",\n+    \"@types/passport\": \"0.4.5\",\n     \"@types/passport-http\": \"0.3.6\",\n-    \"@types/pg\": \"7.4.5\",\n-    \"@types/ws\": \"4.0.2\",\n-    \"nodemon\": \"1.17.3\",\n-    \"ts-node\": \"6.0.0\",\n-    \"typescript\": \"2.8.1\"\n+    \"@types/pg\": \"7.4.8\",\n+    \"@types/ws\": \"5.1.1\",\n+    \"nodemon\": \"1.17.4\",\n+    \"ts-node\": \"6.0.3\",\n+    \"typescript\": \"2.8.3\"\n   },\n   \"dependencies\": {\n-    \"apollo-server-express\": \"1.3.4\",\n+    \"apollo-server-express\": \"1.3.6\",\n     \"bcrypt-nodejs\": \"0.0.3\",\n     \"body-parser\": \"1.18.2\",\n     \"cors\": \"2.8.4\",\n     \"express\": \"4.16.3\",\n-    \"graphql\": \"0.12.3\",\n-    \"graphql-code-generator\": \"0.8.21\",\n+    \"graphql\": \"0.13.2\",\n+    \"graphql-code-generator\": \"0.9.1\",\n+    \"graphql-codegen-typescript-template\": \"0.9.1\",\n+    \"graphql-iso-date\": \"3.5.0\",\n     \"graphql-subscriptions\": \"0.5.8\",\n-    \"graphql-tools\": \"2.24.0\",\n+    \"graphql-tools\": \"3.0.1\",\n     \"moment\": \"2.22.1\",\n     \"passport\": \"0.4.0\",\n     \"passport-http\": \"0.3.0\",\n-    \"pg\": \"7.4.1\",\n+    \"pg\": \"7.4.3\",\n     \"reflect-metadata\": \"0.1.12\",\n-    \"subscriptions-transport-ws\": \"0.9.7\",\n-    \"typeorm\": \"0.2.0-alpha.46\"\n+    \"subscriptions-transport-ws\": \"0.9.9\",\n+    \"typeorm\": \"0.2.5\"\n   }\n }\ndiff --git a/server/schema/resolvers.ts b/server/schema/resolvers.ts\nindex d901f79..077dc35 100644\n--- a/server/schema/resolvers.ts\n+++ b/server/schema/resolvers.ts\n@@ -2,7 +2,7 @@ import { MessageType } from \"../db\";\n import { IResolvers } from \"graphql-tools/dist/Interfaces\";\n import {\n   AddChatMutationArgs, AddGroupMutationArgs, AddMessageMutationArgs, ChatQueryArgs, MessageAddedSubscriptionArgs,\n-  RemoveChatMutationArgs, RemoveMessagesMutationArgs\n+  MessageFeedChatArgs, MessagesChatArgs, RemoveChatMutationArgs, RemoveMessagesMutationArgs\n } from \"../types\";\n import * as moment from \"moment\";\n import { PubSub, withFilter } from \"graphql-subscriptions\";\n@@ -11,10 +11,12 @@ import { Chat } from \"../entity/Chat\";\n import { Message } from \"../entity/Message\";\n import { Recipient } from \"../entity/Recipient\";\n import { Connection } from \"typeorm\";\n+import { GraphQLDateTime } from \"graphql-iso-date\";\n\n export const pubsub = new PubSub();\n\n export const resolvers: IResolvers = {\n+  Date: GraphQLDateTime,\n   Query: {\n     // Show all users for the moment.\n     users: async (obj: any, args: any, {user: currentUser, connection}: { user: User, connection: Connection }): Promise<User[]> => {\n@@ -429,13 +431,41 @@ export const resolvers: IResolvers = {\n         .innerJoin('user.ownerChats', 'ownerChats', 'ownerChats.id = :chatId', {chatId: chat.id})\n         .getOne() || null;\n     },\n-    messages: async (chat: Chat, {amount = null}: {amount: number}, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<Message[]> => {\n-      const query = connection\n+    messages: async (chat: Chat, {before, amount}: MessagesChatArgs, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<Message[]> => {\n+      let query = connection\n         .createQueryBuilder(Message, \"message\")\n         .innerJoin('message.chat', 'chat', 'chat.id = :chatId', {chatId: chat.id})\n         .innerJoin('message.holders', 'holders', 'holders.id = :userId', {userId: currentUser.id})\n         .orderBy({\"message.createdAt\": \"DESC\"});\n-      return (amount ? await query.take(amount).getMany() : await query.getMany()).reverse();\n+\n+      if (amount) {\n+        query = query.take(amount);\n+      }\n+\n+      if (before) {\n+        query = query.where('message.createdAt < :before', {before: new Date(before)});\n+      }\n+\n+      return (await query.getMany()).reverse();\n+    },\n+    messageFeed: async (chat: Chat, {before, amount}: MessageFeedChatArgs, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<{hasNextPage: boolean, cursor: Date | null, messages: Message[]}> => {\n+      let query = connection\n+        .createQueryBuilder(Message, \"message\")\n+        .innerJoin('message.chat', 'chat', 'chat.id = :chatId', {chatId: chat.id})\n+        .innerJoin('message.holders', 'holders', 'holders.id = :userId', {userId: currentUser.id})\n+        .orderBy({\"message.createdAt\": \"DESC\"})\n+        .take(amount || 15);\n+\n+      if (before) {\n+        query = query.where('message.createdAt < :before', {before: new Date(before)});\n+      }\n+\n+      const [messages, count] = await query.getManyAndCount();\n+      return {\n+        hasNextPage: messages.length !== count,\n+        cursor: messages && messages.length && messages[messages.length - 1].createdAt || null,\n+        messages: messages.reverse(),\n+      };\n     },\n     unreadMessages: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<number> => {\n       return await connection\ndiff --git a/server/schema/typeDefs.ts b/server/schema/typeDefs.ts\nindex c09cad4..9753c74 100644\n--- a/server/schema/typeDefs.ts\n+++ b/server/schema/typeDefs.ts\n@@ -1,6 +1,8 @@\n import { ITypeDefinitions } from \"graphql-tools/dist/Interfaces\";\n\n export const typeDefs: ITypeDefinitions = `\n+  scalar Date\n+\n   type Query {\n     users: [User!]\n     chats: [Chat!]\n@@ -35,19 +37,27 @@ export const typeDefs: ITypeDefinitions = `\n     admins: [User!]\n     #If null the group is read-only. Null for chats.\n     owner: User\n-    messages(amount: Int): [Message]!\n+    messages(amount: Int, before: String): [Message]!\n+    #Return messages in a a Feed Wrapper with cursor based pagination\n+    messageFeed(amount: Int, before: String): MessageFeed\n     #Computed property\n     unreadMessages: Int!\n     #Computed property\n     isGroup: Boolean!\n   }\n+\n+  type MessageFeed {\n+    hasNextPage: Boolean!\n+    cursor: String\n+    messages: [Message]!\n+  }\n\n   type Message {\n     id: ID!\n     sender: User!\n     chat: Chat!\n     content: String!\n-    createdAt: String!\n+    createdAt: Date!\n     #FIXME: should return MessageType\n     type: Int!\n     #Whoever received the message\n@@ -62,8 +72,8 @@ export const typeDefs: ITypeDefinitions = `\n     user: User!\n     message: Message!\n     chat: Chat!\n-    receivedAt: String\n-    readAt: String\n+    receivedAt: Date\n+    readAt: Date\n   }\n\n   type User {\ndiff --git a/server/types.d.ts b/server/types.d.ts\nindex ce81b7a..f7e996d 100644\n--- a/server/types.d.ts\n+++ b/server/types.d.ts\n@@ -1,127 +1,146 @@\n /* tslint:disable */\n\n+/** A date-time string at UTC, such as 2007-12-03T10:15:30Z, compliant with the `date-time` format outlined in section 5.6 of the RFC 3339 profile of the ISO 8601 standard for representation of dates and times using the Gregorian calendar. */\n+export type DateTime = any;\n+\n export interface Query {\n-  users: User[];\n-  chats: Chat[];\n-  chat?: Chat | null;\n+  users?: User[] | null;\n+  chats?: Chat[] | null;\n+  chat?: Chat | null;\n }\n\n export interface User {\n-  id: string;\n-  name?: string | null;\n-  picture?: string | null;\n-  phone?: string | null;\n+  id: string;\n+  name?: string | null;\n+  picture?: string | null;\n+  phone?: string | null;\n }\n\n export interface Chat {\n-  id: string; /* May be a chat or a group */\n-  name?: string | null; /* Computed for chats */\n-  picture?: string | null; /* Computed for chats */\n-  allTimeMembers: User[]; /* All members, current and past ones. */\n-  listingMembers: User[]; /* Whoever gets the chat listed. For groups includes past members who still didn&#x27;t delete the group. */\n-  actualGroupMembers: User[]; /* Actual members of the group (they are not the only ones who get the group listed). Null for chats. */\n-  admins: User[]; /* Null for chats */\n-  owner?: User | null; /* If null the group is read-only. Null for chats. */\n-  messages: Message[];\n-  unreadMessages: number; /* Computed property */\n-  isGroup: boolean; /* Computed property */\n+  id: string /** May be a chat or a group */;\n+  name?: string | null /** Computed for chats */;\n+  picture?: string | null /** Computed for chats */;\n+  allTimeMembers: User[] /** All members, current and past ones. */;\n+  listingMembers: User[] /** Whoever gets the chat listed. For groups includes past members who still didn't delete the group. */;\n+  actualGroupMembers: User[] /** Actual members of the group (they are not the only ones who get the group listed). Null for chats. */;\n+  admins?: User[] | null /** Null for chats */;\n+  owner?: User | null /** If null the group is read-only. Null for chats. */;\n+  messages: (Message | null)[];\n+  messageFeed?: MessageFeed | null /** Return messages in a a Feed Wrapper with cursor based pagination */;\n+  unreadMessages: number /** Computed property */;\n+  isGroup: boolean /** Computed property */;\n }\n\n export interface Message {\n-  id: string;\n-  sender: User;\n-  chat: Chat;\n-  content: string;\n-  createdAt: string;\n-  type: number; /* FIXME: should return MessageType */\n-  recipients: Recipient[]; /* Whoever received the message */\n-  holders: User[]; /* Whoever still holds a copy of the message. Cannot be null because the message gets deleted otherwise */\n-  ownership: boolean; /* Computed property */\n+  id: string;\n+  sender: User;\n+  chat: Chat;\n+  content: string;\n+  createdAt: DateTime;\n+  type: number /** FIXME: should return MessageType */;\n+  recipients: Recipient[] /** Whoever received the message */;\n+  holders: User[] /** Whoever still holds a copy of the message. Cannot be null because the message gets deleted otherwise */;\n+  ownership: boolean /** Computed property */;\n }\n\n export interface Recipient {\n-  user: User;\n-  message: Message;\n-  receivedAt?: string | null;\n-  readAt?: string | null;\n+  user: User;\n+  message: Message;\n+  chat: Chat;\n+  receivedAt?: DateTime | null;\n+  readAt?: DateTime | null;\n+}\n+\n+export interface MessageFeed {\n+  hasNextPage: boolean;\n+  cursor?: string | null;\n+  messages: (Message | null)[];\n }\n\n export interface Mutation {\n-  addChat?: Chat | null;\n-  addGroup?: Chat | null;\n-  removeChat?: string | null;\n-  addMessage?: Message | null;\n-  removeMessages?: string[] | null;\n-  addMembers?: string[] | null;\n-  removeMembers?: string[] | null;\n-  addAdmins?: string[] | null;\n-  removeAdmins?: string[] | null;\n-  setGroupName?: string | null;\n-  setGroupPicture?: string | null;\n-  markAsReceived?: boolean | null;\n-  markAsRead?: boolean | null;\n+  addChat?: Chat | null;\n+  addGroup?: Chat | null;\n+  removeChat?: string | null;\n+  addMessage?: Message | null;\n+  removeMessages?: (string | null)[] | null;\n+  addMembers?: (string | null)[] | null;\n+  removeMembers?: (string | null)[] | null;\n+  addAdmins?: (string | null)[] | null;\n+  removeAdmins?: (string | null)[] | null;\n+  setGroupName?: string | null;\n+  setGroupPicture?: string | null;\n+  markAsReceived?: boolean | null;\n+  markAsRead?: boolean | null;\n }\n\n export interface Subscription {\n-  messageAdded?: Message | null;\n-  chatAdded?: Chat | null;\n+  messageAdded?: Message | null;\n+  chatAdded?: Chat | null;\n }\n export interface ChatQueryArgs {\n-  chatId: string;\n+  chatId: string;\n }\n export interface MessagesChatArgs {\n-  amount?: number | null;\n+  amount?: number | null;\n+  before?: string | null;\n+}\n+export interface MessageFeedChatArgs {\n+  amount?: number | null;\n+  before?: string | null;\n }\n export interface AddChatMutationArgs {\n-  recipientId: string;\n+  recipientId: string;\n }\n export interface AddGroupMutationArgs {\n-  recipientIds: string[];\n-  groupName: string;\n+  recipientIds: string[];\n+  groupName: string;\n }\n export interface RemoveChatMutationArgs {\n-  chatId: string;\n+  chatId: string;\n }\n export interface AddMessageMutationArgs {\n-  chatId: string;\n-  content: string;\n+  chatId: string;\n+  content: string;\n }\n export interface RemoveMessagesMutationArgs {\n-  chatId: string;\n-  messageIds?: string[] | null;\n-  all?: boolean | null;\n+  chatId: string;\n+  messageIds?: (string | null)[] | null;\n+  all?: boolean | null;\n }\n export interface AddMembersMutationArgs {\n-  groupId: string;\n-  userIds: string[];\n+  groupId: string;\n+  userIds: string[];\n }\n export interface RemoveMembersMutationArgs {\n-  groupId: string;\n-  userIds: string[];\n+  groupId: string;\n+  userIds: string[];\n }\n export interface AddAdminsMutationArgs {\n-  groupId: string;\n-  userIds: string[];\n+  groupId: string;\n+  userIds: string[];\n }\n export interface RemoveAdminsMutationArgs {\n-  groupId: string;\n-  userIds: string[];\n+  groupId: string;\n+  userIds: string[];\n }\n export interface SetGroupNameMutationArgs {\n-  groupId: string;\n+  groupId: string;\n }\n export interface SetGroupPictureMutationArgs {\n-  groupId: string;\n+  groupId: string;\n }\n export interface MarkAsReceivedMutationArgs {\n-  chatId: string;\n+  chatId: string;\n }\n export interface MarkAsReadMutationArgs {\n-  chatId: string;\n+  chatId: string;\n }\n export interface MessageAddedSubscriptionArgs {\n-  chatId?: string | null;\n+  chatId?: string | null;\n }\n\n-export type MessageType = \"LOCATION\" | \"TEXT\" | \"PICTURE\";\n-\n+export enum MessageType {\n+  LOCATION = \"LOCATION\",\n+  TEXT = \"TEXT\",\n+  PICTURE = \"PICTURE\"\n+}\n",
        "manuals": [
          {
            "manualTitle": "A Whatsapp clone written with Angular, Material, Express, Postgresql and Apollo GraphQL.",
            "stepRevision": "56e3257d75fc18dd1850ba8a76ecdc46ad19f508",
            "manualView": "## Startup instructions\n\nThis project is made out of 2 sub-projects - the one is client and the other is server. We will go through the initialization for each of these individually. We will start with the server since the client is dependent on it.\n\n### Server\n\nFirst we need to clone the server project:\n\n    $ git clone git@github.com:Urigo/whatsapp-server-express.git\n\nThen we need to install the NPM dependencies:\n\n    $ npm install\n\nBefore starting the server make sure that postgresql is installed:\n\n    $ sudo apt-get update\n    $ sudo apt-get install postgresql postgresql-contrib\n\nSetup a user named \"test\" with no password by first switching into \"postgres\" account:\n\n    $ sudo -u postgres psql\n\nAnd running the following command:\n\n    postgres=# ALTER USER test WITH PASSWORD '';\n\nTry to run the server:\n\n    $ npm start\n\nIf logs show that connection refused, kill the process and set a random password for the \"test\" user (e.g. \"test\"):\n\n    postgres=# ALTER USER test WITH PASSWORD 'test';\n\nBe sure to set the password in the `ormconfig.json` as well:\n\n```js\n{\n  // ...\n  \"password\": \"test\",\n  // ...\n}\n```\n\nRun the start command again:\n\n    $ npm start\n\n### Client\n\n**Be sure to go through server initialization first**\n\nFirst we need to clone the server project:\n\n    $ git clone git@github.com:Urigo/whatsapp-client-angularcli-material.git\n\nThen we need to install the NPM dependencies:\n\n    $ npm install\n\nStart the app:\n\n    $ npm start"
          },
          {
            "manualTitle": "Step 1: Introduction",
            "stepRevision": "2437e47edf7c1f7530c8b6a38374120ad60b1287",
            "manualView": "# Step 1: How to build an app?\n\nSo you want to build an app!\nThe good news is, it’s not that difficult and after a while anyone can do it!\nAnother good news is that it’s a great skill to have, there is a lot of demand in the job market and you can get to be very creative. Also you can be part of basically any industry you can think of if you know how to program (Healthcare,\nbanking, education, defense, gaming, etc…).\n\nSoftware builds as layers on top of layers.  Every code you write is using code that others have written before already and you can just use it even without fully understanding it.\nThat’s what makes software advance so fast and makes the pace of progress increase as time goes by.\nAlso, most software today is written in an open and free way - everyone can share their code and use other people's code for free.  We even have a social network for that!  It’s called Github.\n\nOne way of learning how to build an app is to study software from the origins. How computers, operating systems and compilers work. It is very interesting but that also takes a long time.\nAnother way to learn how to create a new app is to start by first using all the code that has been already written out there and once we have a real world running app, go deeper to understand how it works from the inside.\n\nI’ll try to use the later approach because I think it is more fun and also it gives context when we will dive inside on how things work. Also it helps when we try to compare between different technologies that do the same thing (Angular vs.\nReact , etc…).\nThat’s because understanding the bigger picture is more important than knowing and remembering the details.\n\nYou noticed that the chapter started with a simple question.\nAll the lessons will start and include many of those questions.  Those are the questions you will need to Google.  The reason is that the most important skill a creator has today is to know how to search Google for the things they need. Most\nprogrammers, even the best ones, don’t remember anything, they just use Google for almost every line of code they write. So know that you don’t need to know it all, Google knows it all for you.\nThis tutorial might get outdated (it won't, hopefully!), but Google will always have the answers so it is more important to know to ask the right questions.\nIn my opinion the most important skill a programmer needs to have is patience and acceptance when something just doesn’t work, enjoy that feeling and start Googling around in order to learn new things and solve this new problem (this process of\nfeeling like you don’t know anything will happen 1000 times a day, also after 20 years of programming).\n\n## Planning the app: how to design an app?\n\nThe first and most important phase in the process is the beginning - designing the app, its parts, components and architecture, and how it all works together.\nFor this tutorial we will build a WhatsApp clone so we have the designs already prepared.\n\nThe process will looks like that:\n\n1. **Visually sketch the screens of the app**. We already know how WhatsApp looks so we’ll just copy it on pen and paper.\n2. **Break down to components**. The best way to describe the UI of apps is to break the UI into separate components and mix them up together. When breaking down to components we would need to think about the following steps:\n  * **Presentational components**: the small building blocks of the UI. For example input fields, images, text, buttons etc…\n  * **Layout**: how the components are positioned inside each other (talk about flex, grid and older layout types)\n  * **Styles**: colors, fonts etc… We might skip that part at the beginning because we can have a perfectly working app without it\n  * **Data dependencies**: the data that those components need - chats, messages, people etc… We will need to to do the following:\n    * Gather data for each component\n    * Attach all those dependencies into one schema\n    * Attach actions for each component\n    * Data updates: decide when the data should be updated in the view (ideally we shouldn’t have to say when but for technical and performance reasons it helps)\n3. **Routing flow**: Moving between screens, what are the different paths the user can navigate through our app\n\nOnce we will finish that process, you will have a big picture in your head (and on your paper) and implementing it with code will be much easier and more technical, meaning you won’t need to know a lot, just Google how to do each step...\n\nAnother interesting thing is, that implementing this same process can be done with a variety of different technologies, so this work will make sense whether you are using web with React or Angular, native apps, Windows UWP or any other\ntechnology for the UI and also relevant whether your data source is a Node, .NET or Ruby server with Mongo, Postgres or MySQL database (if all those words doesn’t mean anything for you, don’t worry, those are just different names to very similar\nideas and we will learn all of them later on and of course you can always just Google them).\n\nHead over to the next chapter to start planning."
          },
          {
            "manualTitle": "Step 2: Planning process",
            "stepRevision": "e59198836c58fead22e1226d1556f7f70003af47",
            "manualView": "## Visual sketch\nWell, not a lot to say about that: just draw your app on paper.\nDoesn’t matter if you don’t know how to draw, it’s just squares and circles.\n\n![alt text](../../assets/chats.png \"Chats\")\n![alt text](../../assets/chat.png \"Chat\")\n![alt text](../../assets/new_chat.png \"New chat\")\n![alt text](../../assets/new_group.png \"New group\")\n![alt text](../../assets/new_group_details.png \"New group details\")\n\n## Breaking down to components\n### -> Google Search\nThis part is a bit more tricky, but after a few examples you’ll get the hang of it.\n\nDraw boxes around every component and subcomponent in different colors and name each one.\nBut how do you know what should be its own component?\nJust follow the **single responsibility principle**, that is, a component should ideally only do one thing. If it ends up growing, it should be decomposed into smaller subcomponents.\n\n![alt text](../../assets/chats_components.png \"Chats components\")\n![alt text](../../assets/chat_components.png \"Chat components\")\n![alt text](../../assets/new_chat_components.png \"New chat components\")\n![alt text](../../assets/new_group_components.png \"New group components\")\n![alt text](../../assets/new_group_details_components.png \"New group details components\")\n\n  * Chats Component\n  * Header Component\n  * ChatsList Component\n  * ChatItem Component\n  * Chat Component\n  * MessagesList Component\n  * MessageItem Component\n  * NewMessage Component\n  * NewChat Component\n  * UsersList Component\n  * UserItem Component\n  * NewGroup Component\n  * NewGroupDetails Component\n\nNow let’s organize them in hierarchy:\n* Chats\n  * Header\n  * ChatsList\n    * ChatItem\n* Chat\n  * Header\n  * MessagesList\n    * MessageItem\n  * NewMessage\n* NewChat\n  * Header\n  * UsersList\n    * UserItem\n* NewGroup\n  * Header\n  * UsersList\n    * UserItem\n  * NewGroupDetails\n\n## Layout\n### -> Google Search\nNow let’s describe how the components are placed within each other.\nThere are infinite ways to explain how components sits inside of each other.\nAny approach has its benefits and limitations.\nWe are going to use one pattern that is pretty common, simple and also covers many types of UI structures.\nUsing that pattern we will keep us covered for a long while (until you would want to create a computer game or a graph. then you’ll need to expand your horizons).\nThis pattern is called flexbox.\n\nIn Flexbox we can separate the alignment in two ways:\nContainer (parent) component behaviour\nChild component behaviour inside the container\n\nWhen describing the parent, we have 3 main properties:\n* Flex-Flow: it's a shorthand for flex-direction and flex-wrap and lets you control the direction in which the items are displayed and whether or not they can wrap onto the next line. There are four possible settings, each of them in the wrap or\nnowrap variant:\n  * row `[wrap, nowrap]`\n  * row-reverse `[wrap, nowrap]`\n  * column `[wrap, nowrap]` - this is the normal way a group of divs would be displayed, so you might not use this often\n  * column-reverse `[wrap, nowrap]`\n* Justify-content: determines where a browser should place the flex items within the row. It works only if the flex items have set widths and if the total width of the items is less than the flex container. There are five possible settings:\n  * Flex-start - squash them to the left\n  * Center - Squash them to the center\n  * Flex-end - squash them to the right\n  * Space-around - squash them away from each other and the ends. Place as much space as possible between all elements\n  * Space-between - Squash the sides to the ends and place as much space between the rest of the elements as possible\n* alignItems: Same as justifyContent but on the secondary axis\n  * Flex-start - squash them to the left\n  * Center - Squash them to the center\n  * Flex-end - squash them to the right\n  * Space-around - squash them away from each other and the ends. Place as much space as possible between all elements\n  * Space-between - Squash the sides to the ends and place as much space between the rest of the elements as possible\n\nThe easiest way to explain that is by showing live examples:\n[awaiting for McFarland's permission to share his pictures]\n\n## Data dependencies\n### -> Google Search\nOur app needs to display data. Otherwise it will be just a nice moving set of pictures…\nSo let’s see what data each component needs and create a descriptions of all the data in our app.\n\nLet’s start with the chats list component:\n\n* Chats: Chats, Users, Messages\n  * Header\n  * ChatsList: Chats, Users, Messages\n    * ChatItem: Chats`[chatId]`, Users`[UserId]`, Message`[messageId]`\n\nWe need to have some basic information about the chats we are part of, like the chat id, the user id and the latest message content.\nThat means we will have to query for all the chats who we are part of, then look at the user IDs and query for those users to retrieve the name. Finally we need to query for the last message of each chat.\n\nNow let’s talk about the chat component (after clicking the single chat app).\nWe need a list of all the messages inside the chat, along with some info about the user or chat on the top corner:\n\n* Chat: Chat, User, Messages\n  * Header: User.name || Chat.name (Because we can have multiple participant could differ from the other person’s name)\n  * MessagesList: Messages\n    * MessageItem: Messages`[ID]`\n  * NewMessage\n\nThe NewChat and NewGroup components will need just some basic info about the user:\n\n* NewChat: Users\n  * Header\n  * UsersList: Users\n    * UserItem: Users`[ID]`\n\n* NewGroup: Users\n  * Header\n  * UsersList: Users\n    * UserItem: Users`[ID]`\n  * NewGroupDetails\n\n## Actions\n### -> Google Search\nBut components can also do thing beyond just displaying data.\nLet’s write all the actions each component can do.\n  * Chats list\n    * tap -> go to chat page\n    * press -> enable selection of multiple chats, confirming the selection will delete them\n  * Single Chat\n    * tap -> send the message\n    * press -> enable selection of multiple messages, confirming the selection will delete them\n  * New Chat\n    * tap -> create new chat or go to the NewGroup component\n  * New Group\n    * tap -> go to NewGroupDetails, then create the group\n\n## Communications\n### -> Google Search\nLet’s define when do we need to get the data from our data source.\nSounds easy but there are a few tricky pitfalls. (query and subscriptions).\nWe will start by simply requesting the data when we first start the component, later on we will tackle subscriptions.\n\n## UI flow\n### -> Google Search\nLet’s draw a diagram of how the user can navigate our app.\n  * Open the app ->\n    * Chats list ->\n      * Click on chat ->\n        * Specific chat page\n          * Click back ->\n            * Chat page\n    * Click on '+' ->\n      * NewChat page ->\n        * Click on user ->\n          * Chat page\n        * Click back ->\n          * Chats list\n        * Click on 'New Group' ->\n          * New Group page\n            * Multiple selection and subsequent confirmation ->\n              * NewGroupDetails page\n                * Insert name and click on confirm ->\n                  * Chat page\n              * Click back ->\n                * New Group page\n          * Click back ->\n            * New Group page\n\nNow let’s look at the whole diagram we created.\nThat basically describes all of our app.\nIf computers were smart enough to understand english and drawings, we would have an app by now.\nBut programming languages are very similar to regular languages so we now just need to translate this into any programming language, just choose a tool and start filling in the gaps.\n\nNext chapter will be about Scaffolding which will tell us the structure to put our code into.\nJust like our sketch has defined parts, we would do the same just with folders and files."
          },
          {
            "manualTitle": "Step 3: Scaffolding",
            "stepRevision": "5bed487598e50759764f608eb4ca3b347c4d6ac5",
            "manualView": "Now we can start writing code!\n\nBut like we said before, software is build in layers and instead of starting from nothing, we can use existing software with prepared structure.\n\n## Tools\n\nFirst let’s install some software that we need on our computer:\n\n### Windows\n\nThe following instructions are for computers with the Windows operating system.\n\nFirst let's start by installing node.js. You need to download an installer, by visiting:\n\n    https://nodejs.org/en/download/\n\nSame, with Yarn:\n\n    https://yarnpkg.com/en/docs/install#windows-stable\n\n\n### Linux\n\nThe following instructions are for computers with the Arch Linux operating system, so your mileage may vary.\n\nFirst let's start by installing npm and node.js, as simple as\n\n    # NodeJS\n    pacman -S nodejs npm\n\n    # Yarn\n    pacman -S yarn\n\n\n### MacOS\n\nThe following instructions are for computers with the MacOS operating system:\n\n    # NodeJS\n    brew install node\n\n    # Yarn\n    brew install yarn --without-node\n\n\n## Packages\n\nThen we will need a way to install our npm global packages on a per-user basis, instead of relying on sudo: https://github.com/sindresorhus/guides/blob/master/npm-global-without-sudo.md\n\nNow it's the right moment to install a couple of global packages we will need later on:\n\n    yarn global add @angular/cli node-sass tortilla typescript\n\n\n## IDE\n\nNow it's time to choose our IDE. I suggest you VSCode, it's available for free: https://code.visualstudio.com/.\nTo have a look at some of the VSCode features you can have a look at the documentation: https://code.visualstudio.com/docs.\n\nVSCode team prepared an Interactive Playground where you can learn what the editor is cappable of and play with it. I highly recommend to check it out!\n\n    Toolbar: Help > Interactive Playground\n\nThere are also many IDEs to recommend and at the end the choice is yours.\n\n## Mobile\n\nWe will talk once again about scaffolding once we will introduce `Android` and `Cordova`."
          },
          {
            "manualTitle": "Step 4: Debugging",
            "stepRevision": "55bc04cf5573341cce8cdfe5fea67fb603e3a74f",
            "manualView": "Before we start writing code, it is important that we learn how to check our code.\n\nThe computer runs through everything we write in split second but we can still pause the computer and go through step by step, check what actually happens when the computer runs our code instructions.\n\nThis phase is sometimes being skipped by developers but trust me, you never want to skip this phase and you should always be super comfortable in debugging your code on whatever environment it’s running on.\n\nThe easiest way to debug your Javascript application is right into your editor:\n  * https://code.visualstudio.com/docs/introvideos/debugging\n  * https://www.jetbrains.com/help/webstorm/debugging-javascript-in-chrome.html\n  * https://blog.jetbrains.com/webstorm/2017/01/debugging-angular-apps/\n\nLater on we will learn how to debug mobile applications."
          },
          {
            "manualTitle": "Step 5: Chats listing",
            "stepRevision": "665d3c8014800890c694d121848b3448cd6335ec",
            "manualView": "![chats-list](https://user-images.githubusercontent.com/7648874/49271096-36bef480-f4a7-11e8-87a9-c9f203f20f6a.png)\n\n## Server\n\nAfter the planning phase it's finally time to start writing some real code!\nWe'll start with the server, so let's install a couple of packages first:\n\n    yarn add apollo-server-express body-parser cors express graphql\n    yarn add -D @types/body-parser @types/cors @types/express @types/graphql\n\nExpress is a fast, unopinionated, minimalist web framework for node.\nCross-Origin Resource Sharing (CORS) is a mechanism that uses additional HTTP headers to let a user agent gain permission to access selected resources from a server on a different origin (domain) than the site currently in use. A user agent makes a cross-origin HTTP request when it requests a resource from a different domain, protocol, or port than the one from which the current document originated.\nWe will need CORS because Webpack's development server used in the client will make use of a different port than the Express server, thus configuring a different origin.\nGraphQL is a query language for APIs and a runtime for fulfilling those queries with your existing data. GraphQL provides a complete and understandable description of the data in your API, gives clients the power to ask for exactly what they need and nothing more, makes it easier to evolve APIs over time, and enables powerful developer tools.\nApollo Server is a community-maintained open-source GraphQL server. It works with pretty much all Node.js HTTP server frameworks. Apollo Server works with any GraphQL schema built with GraphQL.js or with a convenience library such as graphql-tools.\n\nThe GraphQL query language is basically about selecting fields on objects. Because the shape of a GraphQL query closely matches the result, you can predict what the query will return without knowing that much about the server. But it's useful to have an exact description of the data we can ask for - what fields can we select? What kinds of objects might they return? What fields are available on those sub-objects? That's where the schema comes in.\nEvery GraphQL service defines a set of types which completely describe the set of possible data you can query on that service. Then, when queries come in, they are validated and executed against that schema.\n\nFor the moment let's create some empty schemas and resolvers:\n\n[{]: <helper> (diffStep \"1.1\" files=\"schema/*\" module=\"server\")\n\n#### [Step 1.1: Create empty Apollo server](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/1ac723e)\n\n##### Added schema&#x2F;index.ts\n```diff\n@@ -0,0 +1,8 @@\n+┊ ┊1┊import { makeExecutableSchema } from 'apollo-server-express';\n+┊ ┊2┊import typeDefs from './typeDefs';\n+┊ ┊3┊import { resolvers } from './resolvers';\n+┊ ┊4┊\n+┊ ┊5┊export const schema = makeExecutableSchema({\n+┊ ┊6┊  typeDefs,\n+┊ ┊7┊  resolvers,\n+┊ ┊8┊});\n```\n\n##### Added schema&#x2F;resolvers.ts\n```diff\n@@ -0,0 +1,5 @@\n+┊ ┊1┊import { IResolvers } from 'apollo-server-express';\n+┊ ┊2┊\n+┊ ┊3┊export const resolvers: IResolvers = {\n+┊ ┊4┊  Query: {},\n+┊ ┊5┊};\n```\n\n##### Added schema&#x2F;typeDefs.ts\n```diff\n@@ -0,0 +1,2 @@\n+┊ ┊1┊export default `\n+┊ ┊2┊`;\n```\n\n[}]: #\n\nTime to create our index:\n\n[{]: <helper> (diffStep \"1.1\" files=\"^index.ts\" module=\"server\")\n\n#### [Step 1.1: Create empty Apollo server](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/1ac723e)\n\n##### Added index.ts\n```diff\n@@ -0,0 +1,23 @@\n+┊  ┊ 1┊import { schema } from \"./schema\";\n+┊  ┊ 2┊import * as bodyParser from \"body-parser\";\n+┊  ┊ 3┊import * as cors from 'cors';\n+┊  ┊ 4┊import * as express from 'express';\n+┊  ┊ 5┊import { ApolloServer } from \"apollo-server-express\";\n+┊  ┊ 6┊\n+┊  ┊ 7┊const PORT = 3000;\n+┊  ┊ 8┊\n+┊  ┊ 9┊const app = express();\n+┊  ┊10┊\n+┊  ┊11┊app.use(cors());\n+┊  ┊12┊app.use(bodyParser.json());\n+┊  ┊13┊\n+┊  ┊14┊const apollo = new ApolloServer({\n+┊  ┊15┊  schema\n+┊  ┊16┊});\n+┊  ┊17┊\n+┊  ┊18┊apollo.applyMiddleware({\n+┊  ┊19┊  app,\n+┊  ┊20┊  path: '/graphql'\n+┊  ┊21┊});\n+┊  ┊22┊\n+┊  ┊23┊app.listen(PORT);\n```\n\n[}]: #\n\nNow we want to feed our graphql server with some data. Soon we will need `moment`, so let's install it:\n\n    yarn add moment\n\nNow we can create a fake db:\n\n[{]: <helper> (diffStep \"1.2\" files=\"db.ts\" module=\"server\")\n\n#### [Step 1.2: Add fake db](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/a168978)\n\n##### Added db.ts\n```diff\n@@ -0,0 +1,438 @@\n+┊   ┊  1┊import * as moment from 'moment';\n+┊   ┊  2┊\n+┊   ┊  3┊export enum MessageType {\n+┊   ┊  4┊  PICTURE,\n+┊   ┊  5┊  TEXT,\n+┊   ┊  6┊  LOCATION,\n+┊   ┊  7┊}\n+┊   ┊  8┊\n+┊   ┊  9┊export interface User {\n+┊   ┊ 10┊  id: number,\n+┊   ┊ 11┊  username: string,\n+┊   ┊ 12┊  password: string,\n+┊   ┊ 13┊  name: string,\n+┊   ┊ 14┊  picture?: string | null,\n+┊   ┊ 15┊  phone?: string | null,\n+┊   ┊ 16┊}\n+┊   ┊ 17┊\n+┊   ┊ 18┊export interface Chat {\n+┊   ┊ 19┊  id: number,\n+┊   ┊ 20┊  name?: string | null,\n+┊   ┊ 21┊  picture?: string | null,\n+┊   ┊ 22┊  // All members, current and past ones.\n+┊   ┊ 23┊  allTimeMemberIds: number[],\n+┊   ┊ 24┊  // Whoever gets the chat listed. For groups includes past members who still didn't delete the group.\n+┊   ┊ 25┊  listingMemberIds: number[],\n+┊   ┊ 26┊  // Actual members of the group (they are not the only ones who get the group listed). Null for chats.\n+┊   ┊ 27┊  actualGroupMemberIds?: number[] | null,\n+┊   ┊ 28┊  adminIds?: number[] | null,\n+┊   ┊ 29┊  ownerId?: number | null,\n+┊   ┊ 30┊  messages: Message[],\n+┊   ┊ 31┊}\n+┊   ┊ 32┊\n+┊   ┊ 33┊export interface Message {\n+┊   ┊ 34┊  id: number,\n+┊   ┊ 35┊  chatId: number,\n+┊   ┊ 36┊  senderId: number,\n+┊   ┊ 37┊  content: string,\n+┊   ┊ 38┊  createdAt: number,\n+┊   ┊ 39┊  type: MessageType,\n+┊   ┊ 40┊  recipients: Recipient[],\n+┊   ┊ 41┊  holderIds: number[],\n+┊   ┊ 42┊}\n+┊   ┊ 43┊\n+┊   ┊ 44┊export interface Recipient {\n+┊   ┊ 45┊  userId: number,\n+┊   ┊ 46┊  messageId: number,\n+┊   ┊ 47┊  chatId: number,\n+┊   ┊ 48┊  receivedAt: number | null,\n+┊   ┊ 49┊  readAt: number | null,\n+┊   ┊ 50┊}\n+┊   ┊ 51┊\n+┊   ┊ 52┊const users: User[] = [\n+┊   ┊ 53┊  {\n+┊   ┊ 54┊    id: 1,\n+┊   ┊ 55┊    username: 'ethan',\n+┊   ┊ 56┊    password: '$2a$08$NO9tkFLCoSqX1c5wk3s7z.JfxaVMKA.m7zUDdDwEquo4rvzimQeJm', // 111\n+┊   ┊ 57┊    name: 'Ethan Gonzalez',\n+┊   ┊ 58┊    picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n+┊   ┊ 59┊    phone: '+391234567890',\n+┊   ┊ 60┊  },\n+┊   ┊ 61┊  {\n+┊   ┊ 62┊    id: 2,\n+┊   ┊ 63┊    username: 'bryan',\n+┊   ┊ 64┊    password: '$2a$08$xE4FuCi/ifxjL2S8CzKAmuKLwv18ktksSN.F3XYEnpmcKtpbpeZgO', // 222\n+┊   ┊ 65┊    name: 'Bryan Wallace',\n+┊   ┊ 66┊    picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n+┊   ┊ 67┊    phone: '+391234567891',\n+┊   ┊ 68┊  },\n+┊   ┊ 69┊  {\n+┊   ┊ 70┊    id: 3,\n+┊   ┊ 71┊    username: 'avery',\n+┊   ┊ 72┊    password: '$2a$08$UHgH7J8G6z1mGQn2qx2kdeWv0jvgHItyAsL9hpEUI3KJmhVW5Q1d.', // 333\n+┊   ┊ 73┊    name: 'Avery Stewart',\n+┊   ┊ 74┊    picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n+┊   ┊ 75┊    phone: '+391234567892',\n+┊   ┊ 76┊  },\n+┊   ┊ 77┊  {\n+┊   ┊ 78┊    id: 4,\n+┊   ┊ 79┊    username: 'katie',\n+┊   ┊ 80┊    password: '$2a$08$wR1k5Q3T9FC7fUgB7Gdb9Os/GV7dGBBf4PLlWT7HERMFhmFDt47xi', // 444\n+┊   ┊ 81┊    name: 'Katie Peterson',\n+┊   ┊ 82┊    picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n+┊   ┊ 83┊    phone: '+391234567893',\n+┊   ┊ 84┊  },\n+┊   ┊ 85┊  {\n+┊   ┊ 86┊    id: 5,\n+┊   ┊ 87┊    username: 'ray',\n+┊   ┊ 88┊    password: '$2a$08$6.mbXqsDX82ZZ7q5d8Osb..JrGSsNp4R3IKj7mxgF6YGT0OmMw242', // 555\n+┊   ┊ 89┊    name: 'Ray Edwards',\n+┊   ┊ 90┊    picture: 'https://randomuser.me/api/portraits/thumb/men/3.jpg',\n+┊   ┊ 91┊    phone: '+391234567894',\n+┊   ┊ 92┊  },\n+┊   ┊ 93┊  {\n+┊   ┊ 94┊    id: 6,\n+┊   ┊ 95┊    username: 'niko',\n+┊   ┊ 96┊    password: '$2a$08$fL5lZR.Rwf9FWWe8XwwlceiPBBim8n9aFtaem.INQhiKT4.Ux3Uq.', // 666\n+┊   ┊ 97┊    name: 'Niccolò Belli',\n+┊   ┊ 98┊    picture: 'https://randomuser.me/api/portraits/thumb/men/4.jpg',\n+┊   ┊ 99┊    phone: '+391234567895',\n+┊   ┊100┊  },\n+┊   ┊101┊  {\n+┊   ┊102┊    id: 7,\n+┊   ┊103┊    username: 'mario',\n+┊   ┊104┊    password: '$2a$08$nDHDmWcVxDnH5DDT3HMMC.psqcnu6wBiOgkmJUy9IH..qxa3R6YrO', // 777\n+┊   ┊105┊    name: 'Mario Rossi',\n+┊   ┊106┊    picture: 'https://randomuser.me/api/portraits/thumb/men/5.jpg',\n+┊   ┊107┊    phone: '+391234567896',\n+┊   ┊108┊  },\n+┊   ┊109┊];\n+┊   ┊110┊\n+┊   ┊111┊const chats: Chat[] = [\n+┊   ┊112┊  {\n+┊   ┊113┊    id: 1,\n+┊   ┊114┊    name: null,\n+┊   ┊115┊    picture: null,\n+┊   ┊116┊    allTimeMemberIds: [1, 3],\n+┊   ┊117┊    listingMemberIds: [1, 3],\n+┊   ┊118┊    adminIds: null,\n+┊   ┊119┊    ownerId: null,\n+┊   ┊120┊    messages: [\n+┊   ┊121┊      {\n+┊   ┊122┊        id: 1,\n+┊   ┊123┊        chatId: 1,\n+┊   ┊124┊        senderId: 1,\n+┊   ┊125┊        content: 'You on your way?',\n+┊   ┊126┊        createdAt: moment().subtract(1, 'hours').unix(),\n+┊   ┊127┊        type: MessageType.TEXT,\n+┊   ┊128┊        recipients: [\n+┊   ┊129┊          {\n+┊   ┊130┊            userId: 3,\n+┊   ┊131┊            messageId: 1,\n+┊   ┊132┊            chatId: 1,\n+┊   ┊133┊            receivedAt: null,\n+┊   ┊134┊            readAt: null,\n+┊   ┊135┊          },\n+┊   ┊136┊        ],\n+┊   ┊137┊        holderIds: [1, 3],\n+┊   ┊138┊      },\n+┊   ┊139┊      {\n+┊   ┊140┊        id: 2,\n+┊   ┊141┊        chatId: 1,\n+┊   ┊142┊        senderId: 3,\n+┊   ┊143┊        content: 'Yep!',\n+┊   ┊144┊        createdAt: moment().subtract(1, 'hours').add(5, 'minutes').unix(),\n+┊   ┊145┊        type: MessageType.TEXT,\n+┊   ┊146┊        recipients: [\n+┊   ┊147┊          {\n+┊   ┊148┊            userId: 1,\n+┊   ┊149┊            messageId: 2,\n+┊   ┊150┊            chatId: 1,\n+┊   ┊151┊            receivedAt: null,\n+┊   ┊152┊            readAt: null,\n+┊   ┊153┊          },\n+┊   ┊154┊        ],\n+┊   ┊155┊        holderIds: [3, 1],\n+┊   ┊156┊      },\n+┊   ┊157┊    ],\n+┊   ┊158┊  },\n+┊   ┊159┊  {\n+┊   ┊160┊    id: 2,\n+┊   ┊161┊    name: null,\n+┊   ┊162┊    picture: null,\n+┊   ┊163┊    allTimeMemberIds: [1, 4],\n+┊   ┊164┊    listingMemberIds: [1, 4],\n+┊   ┊165┊    adminIds: null,\n+┊   ┊166┊    ownerId: null,\n+┊   ┊167┊    messages: [\n+┊   ┊168┊      {\n+┊   ┊169┊        id: 1,\n+┊   ┊170┊        chatId: 2,\n+┊   ┊171┊        senderId: 1,\n+┊   ┊172┊        content: 'Hey, it\\'s me',\n+┊   ┊173┊        createdAt: moment().subtract(2, 'hours').unix(),\n+┊   ┊174┊        type: MessageType.TEXT,\n+┊   ┊175┊        recipients: [\n+┊   ┊176┊          {\n+┊   ┊177┊            userId: 4,\n+┊   ┊178┊            messageId: 1,\n+┊   ┊179┊            chatId: 2,\n+┊   ┊180┊            receivedAt: null,\n+┊   ┊181┊            readAt: null,\n+┊   ┊182┊          },\n+┊   ┊183┊        ],\n+┊   ┊184┊        holderIds: [1, 4],\n+┊   ┊185┊      },\n+┊   ┊186┊    ],\n+┊   ┊187┊  },\n+┊   ┊188┊  {\n+┊   ┊189┊    id: 3,\n+┊   ┊190┊    name: null,\n+┊   ┊191┊    picture: null,\n+┊   ┊192┊    allTimeMemberIds: [1, 5],\n+┊   ┊193┊    listingMemberIds: [1, 5],\n+┊   ┊194┊    adminIds: null,\n+┊   ┊195┊    ownerId: null,\n+┊   ┊196┊    messages: [\n+┊   ┊197┊      {\n+┊   ┊198┊        id: 1,\n+┊   ┊199┊        chatId: 3,\n+┊   ┊200┊        senderId: 1,\n+┊   ┊201┊        content: 'I should buy a boat',\n+┊   ┊202┊        createdAt: moment().subtract(1, 'days').unix(),\n+┊   ┊203┊        type: MessageType.TEXT,\n+┊   ┊204┊        recipients: [\n+┊   ┊205┊          {\n+┊   ┊206┊            userId: 5,\n+┊   ┊207┊            messageId: 1,\n+┊   ┊208┊            chatId: 3,\n+┊   ┊209┊            receivedAt: null,\n+┊   ┊210┊            readAt: null,\n+┊   ┊211┊          },\n+┊   ┊212┊        ],\n+┊   ┊213┊        holderIds: [1, 5],\n+┊   ┊214┊      },\n+┊   ┊215┊      {\n+┊   ┊216┊        id: 2,\n+┊   ┊217┊        chatId: 3,\n+┊   ┊218┊        senderId: 1,\n+┊   ┊219┊        content: 'You still there?',\n+┊   ┊220┊        createdAt: moment().subtract(1, 'days').add(16, 'hours').unix(),\n+┊   ┊221┊        type: MessageType.TEXT,\n+┊   ┊222┊        recipients: [\n+┊   ┊223┊          {\n+┊   ┊224┊            userId: 5,\n+┊   ┊225┊            messageId: 2,\n+┊   ┊226┊            chatId: 3,\n+┊   ┊227┊            receivedAt: null,\n+┊   ┊228┊            readAt: null,\n+┊   ┊229┊          },\n+┊   ┊230┊        ],\n+┊   ┊231┊        holderIds: [1, 5],\n+┊   ┊232┊      },\n+┊   ┊233┊    ],\n+┊   ┊234┊  },\n+┊   ┊235┊  {\n+┊   ┊236┊    id: 4,\n+┊   ┊237┊    name: null,\n+┊   ┊238┊    picture: null,\n+┊   ┊239┊    allTimeMemberIds: [3, 4],\n+┊   ┊240┊    listingMemberIds: [3, 4],\n+┊   ┊241┊    adminIds: null,\n+┊   ┊242┊    ownerId: null,\n+┊   ┊243┊    messages: [\n+┊   ┊244┊      {\n+┊   ┊245┊        id: 1,\n+┊   ┊246┊        chatId: 4,\n+┊   ┊247┊        senderId: 3,\n+┊   ┊248┊        content: 'Look at my mukluks!',\n+┊   ┊249┊        createdAt: moment().subtract(4, 'days').unix(),\n+┊   ┊250┊        type: MessageType.TEXT,\n+┊   ┊251┊        recipients: [\n+┊   ┊252┊          {\n+┊   ┊253┊            userId: 4,\n+┊   ┊254┊            messageId: 1,\n+┊   ┊255┊            chatId: 4,\n+┊   ┊256┊            receivedAt: null,\n+┊   ┊257┊            readAt: null,\n+┊   ┊258┊          },\n+┊   ┊259┊        ],\n+┊   ┊260┊        holderIds: [3, 4],\n+┊   ┊261┊      },\n+┊   ┊262┊    ],\n+┊   ┊263┊  },\n+┊   ┊264┊  {\n+┊   ┊265┊    id: 5,\n+┊   ┊266┊    name: null,\n+┊   ┊267┊    picture: null,\n+┊   ┊268┊    allTimeMemberIds: [2, 5],\n+┊   ┊269┊    listingMemberIds: [2, 5],\n+┊   ┊270┊    adminIds: null,\n+┊   ┊271┊    ownerId: null,\n+┊   ┊272┊    messages: [\n+┊   ┊273┊      {\n+┊   ┊274┊        id: 1,\n+┊   ┊275┊        chatId: 5,\n+┊   ┊276┊        senderId: 2,\n+┊   ┊277┊        content: 'This is wicked good ice cream.',\n+┊   ┊278┊        createdAt: moment().subtract(2, 'weeks').unix(),\n+┊   ┊279┊        type: MessageType.TEXT,\n+┊   ┊280┊        recipients: [\n+┊   ┊281┊          {\n+┊   ┊282┊            userId: 5,\n+┊   ┊283┊            messageId: 1,\n+┊   ┊284┊            chatId: 5,\n+┊   ┊285┊            receivedAt: null,\n+┊   ┊286┊            readAt: null,\n+┊   ┊287┊          },\n+┊   ┊288┊        ],\n+┊   ┊289┊        holderIds: [2, 5],\n+┊   ┊290┊      },\n+┊   ┊291┊      {\n+┊   ┊292┊        id: 2,\n+┊   ┊293┊        chatId: 6,\n+┊   ┊294┊        senderId: 5,\n+┊   ┊295┊        content: 'Love it!',\n+┊   ┊296┊        createdAt: moment().subtract(2, 'weeks').add(10, 'minutes').unix(),\n+┊   ┊297┊        type: MessageType.TEXT,\n+┊   ┊298┊        recipients: [\n+┊   ┊299┊          {\n+┊   ┊300┊            userId: 2,\n+┊   ┊301┊            messageId: 2,\n+┊   ┊302┊            chatId: 5,\n+┊   ┊303┊            receivedAt: null,\n+┊   ┊304┊            readAt: null,\n+┊   ┊305┊          },\n+┊   ┊306┊        ],\n+┊   ┊307┊        holderIds: [5, 2],\n+┊   ┊308┊      },\n+┊   ┊309┊    ],\n+┊   ┊310┊  },\n+┊   ┊311┊  {\n+┊   ┊312┊    id: 6,\n+┊   ┊313┊    name: null,\n+┊   ┊314┊    picture: null,\n+┊   ┊315┊    allTimeMemberIds: [1, 6],\n+┊   ┊316┊    listingMemberIds: [1],\n+┊   ┊317┊    adminIds: null,\n+┊   ┊318┊    ownerId: null,\n+┊   ┊319┊    messages: [],\n+┊   ┊320┊  },\n+┊   ┊321┊  {\n+┊   ┊322┊    id: 7,\n+┊   ┊323┊    name: null,\n+┊   ┊324┊    picture: null,\n+┊   ┊325┊    allTimeMemberIds: [2, 1],\n+┊   ┊326┊    listingMemberIds: [2],\n+┊   ┊327┊    adminIds: null,\n+┊   ┊328┊    ownerId: null,\n+┊   ┊329┊    messages: [],\n+┊   ┊330┊  },\n+┊   ┊331┊  {\n+┊   ┊332┊    id: 8,\n+┊   ┊333┊    name: 'A user 0 group',\n+┊   ┊334┊    picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n+┊   ┊335┊    allTimeMemberIds: [1, 3, 4, 6],\n+┊   ┊336┊    listingMemberIds: [1, 3, 4, 6],\n+┊   ┊337┊    actualGroupMemberIds: [1, 4, 6],\n+┊   ┊338┊    adminIds: [1, 6],\n+┊   ┊339┊    ownerId: 1,\n+┊   ┊340┊    messages: [\n+┊   ┊341┊      {\n+┊   ┊342┊        id: 1,\n+┊   ┊343┊        chatId: 8,\n+┊   ┊344┊        senderId: 1,\n+┊   ┊345┊        content: 'I made a group',\n+┊   ┊346┊        createdAt: moment().subtract(2, 'weeks').unix(),\n+┊   ┊347┊        type: MessageType.TEXT,\n+┊   ┊348┊        recipients: [\n+┊   ┊349┊          {\n+┊   ┊350┊            userId: 3,\n+┊   ┊351┊            messageId: 1,\n+┊   ┊352┊            chatId: 8,\n+┊   ┊353┊            receivedAt: null,\n+┊   ┊354┊            readAt: null,\n+┊   ┊355┊          },\n+┊   ┊356┊          {\n+┊   ┊357┊            userId: 4,\n+┊   ┊358┊            messageId: 1,\n+┊   ┊359┊            chatId: 8,\n+┊   ┊360┊            receivedAt: moment().subtract(2, 'weeks').add(1, 'minutes').unix(),\n+┊   ┊361┊            readAt: moment().subtract(2, 'weeks').add(5, 'minutes').unix(),\n+┊   ┊362┊          },\n+┊   ┊363┊          {\n+┊   ┊364┊            userId: 6,\n+┊   ┊365┊            messageId: 1,\n+┊   ┊366┊            chatId: 8,\n+┊   ┊367┊            receivedAt: null,\n+┊   ┊368┊            readAt: null,\n+┊   ┊369┊          },\n+┊   ┊370┊        ],\n+┊   ┊371┊        holderIds: [1, 3, 4, 6],\n+┊   ┊372┊      },\n+┊   ┊373┊      {\n+┊   ┊374┊        id: 2,\n+┊   ┊375┊        chatId: 8,\n+┊   ┊376┊        senderId: 1,\n+┊   ┊377┊        content: 'Ops, user 3 was not supposed to be here',\n+┊   ┊378┊        createdAt: moment().subtract(2, 'weeks').add(2, 'minutes').unix(),\n+┊   ┊379┊        type: MessageType.TEXT,\n+┊   ┊380┊        recipients: [\n+┊   ┊381┊          {\n+┊   ┊382┊            userId: 4,\n+┊   ┊383┊            messageId: 2,\n+┊   ┊384┊            chatId: 8,\n+┊   ┊385┊            receivedAt: moment().subtract(2, 'weeks').add(3, 'minutes').unix(),\n+┊   ┊386┊            readAt: moment().subtract(2, 'weeks').add(5, 'minutes').unix(),\n+┊   ┊387┊          },\n+┊   ┊388┊          {\n+┊   ┊389┊            userId: 6,\n+┊   ┊390┊            messageId: 2,\n+┊   ┊391┊            chatId: 8,\n+┊   ┊392┊            receivedAt: null,\n+┊   ┊393┊            readAt: null,\n+┊   ┊394┊          },\n+┊   ┊395┊        ],\n+┊   ┊396┊        holderIds: [1, 4, 6],\n+┊   ┊397┊      },\n+┊   ┊398┊      {\n+┊   ┊399┊        id: 3,\n+┊   ┊400┊        chatId: 8,\n+┊   ┊401┊        senderId: 4,\n+┊   ┊402┊        content: 'Awesome!',\n+┊   ┊403┊        createdAt: moment().subtract(2, 'weeks').add(10, 'minutes').unix(),\n+┊   ┊404┊        type: MessageType.TEXT,\n+┊   ┊405┊        recipients: [\n+┊   ┊406┊          {\n+┊   ┊407┊            userId: 1,\n+┊   ┊408┊            messageId: 3,\n+┊   ┊409┊            chatId: 8,\n+┊   ┊410┊            receivedAt: null,\n+┊   ┊411┊            readAt: null,\n+┊   ┊412┊          },\n+┊   ┊413┊          {\n+┊   ┊414┊            userId: 6,\n+┊   ┊415┊            messageId: 3,\n+┊   ┊416┊            chatId: 8,\n+┊   ┊417┊            receivedAt: null,\n+┊   ┊418┊            readAt: null,\n+┊   ┊419┊          },\n+┊   ┊420┊        ],\n+┊   ┊421┊        holderIds: [1, 4, 6],\n+┊   ┊422┊      },\n+┊   ┊423┊    ],\n+┊   ┊424┊  },\n+┊   ┊425┊  {\n+┊   ┊426┊    id: 9,\n+┊   ┊427┊    name: 'A user 5 group',\n+┊   ┊428┊    picture: null,\n+┊   ┊429┊    allTimeMemberIds: [6, 3],\n+┊   ┊430┊    listingMemberIds: [6, 3],\n+┊   ┊431┊    actualGroupMemberIds: [6, 3],\n+┊   ┊432┊    adminIds: [6],\n+┊   ┊433┊    ownerId: 6,\n+┊   ┊434┊    messages: [],\n+┊   ┊435┊  },\n+┊   ┊436┊];\n+┊   ┊437┊\n+┊   ┊438┊export const db = {users, chats};\n```\n\n[}]: #\n\nIts' finally time to create our schema\n\n[{]: <helper> (diffStep \"1.3\" files=\"schema/typeDefs.ts\" module=\"server\")\n\n#### [Step 1.3: Add resolvers and schema](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/a2cb658)\n\n##### Changed schema&#x2F;typeDefs.ts\n```diff\n@@ -1,2 +1,68 @@\n ┊ 1┊ 1┊export default `\n+┊  ┊ 2┊  type Query {\n+┊  ┊ 3┊    users: [User!]\n+┊  ┊ 4┊    chats: [Chat!]\n+┊  ┊ 5┊    chat(chatId: ID!): Chat\n+┊  ┊ 6┊  }\n+┊  ┊ 7┊\n+┊  ┊ 8┊  enum MessageType {\n+┊  ┊ 9┊    LOCATION\n+┊  ┊10┊    TEXT\n+┊  ┊11┊    PICTURE\n+┊  ┊12┊  }\n+┊  ┊13┊\n+┊  ┊14┊  type Chat {\n+┊  ┊15┊    #May be a chat or a group\n+┊  ┊16┊    id: ID!\n+┊  ┊17┊    #Computed for chats\n+┊  ┊18┊    name: String\n+┊  ┊19┊    #Computed for chats\n+┊  ┊20┊    picture: String\n+┊  ┊21┊    #All members, current and past ones.\n+┊  ┊22┊    allTimeMembers: [User!]!\n+┊  ┊23┊    #Whoever gets the chat listed. For groups includes past members who still didn't delete the group.\n+┊  ┊24┊    listingMembers: [User!]!\n+┊  ┊25┊    #Actual members of the group (they are not the only ones who get the group listed). Null for chats.\n+┊  ┊26┊    actualGroupMembers: [User!]!\n+┊  ┊27┊    #Null for chats\n+┊  ┊28┊    admins: [User!]\n+┊  ┊29┊    #If null the group is read-only. Null for chats.\n+┊  ┊30┊    owner: User\n+┊  ┊31┊    messages(amount: Int): [Message]!\n+┊  ┊32┊    #Computed property\n+┊  ┊33┊    unreadMessages: Int!\n+┊  ┊34┊    #Computed property\n+┊  ┊35┊    isGroup: Boolean!\n+┊  ┊36┊  }\n+┊  ┊37┊\n+┊  ┊38┊  type Message {\n+┊  ┊39┊    id: ID!\n+┊  ┊40┊    sender: User!\n+┊  ┊41┊    chat: Chat!\n+┊  ┊42┊    content: String!\n+┊  ┊43┊    createdAt: String!\n+┊  ┊44┊    #FIXME: should return MessageType\n+┊  ┊45┊    type: Int!\n+┊  ┊46┊    #Whoever received the message\n+┊  ┊47┊    recipients: [Recipient!]!\n+┊  ┊48┊    #Whoever still holds a copy of the message. Cannot be null because the message gets deleted otherwise\n+┊  ┊49┊    holders: [User!]!\n+┊  ┊50┊    #Computed property\n+┊  ┊51┊    ownership: Boolean!\n+┊  ┊52┊  }\n+┊  ┊53┊\n+┊  ┊54┊  type Recipient {\n+┊  ┊55┊    user: User!\n+┊  ┊56┊    message: Message!\n+┊  ┊57┊    chat: Chat!\n+┊  ┊58┊    receivedAt: String\n+┊  ┊59┊    readAt: String\n+┊  ┊60┊  }\n+┊  ┊61┊\n+┊  ┊62┊  type User {\n+┊  ┊63┊    id: ID!\n+┊  ┊64┊    name: String\n+┊  ┊65┊    picture: String\n+┊  ┊66┊    phone: String\n+┊  ┊67┊  }\n ┊ 2┊68┊`;\n```\n\n[}]: #\n\nand our resolvers\n\n[{]: <helper> (diffStep \"1.3\" files=\"schema/resolvers.ts\" module=\"server\")\n\n#### [Step 1.3: Add resolvers and schema](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/a2cb658)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,5 +1,51 @@\n ┊ 1┊ 1┊import { IResolvers } from 'apollo-server-express';\n+┊  ┊ 2┊import { Chat, db, Message, Recipient, User } from \"../db\";\n+┊  ┊ 3┊\n+┊  ┊ 4┊let users = db.users;\n+┊  ┊ 5┊let chats = db.chats;\n+┊  ┊ 6┊const currentUser = 1;\n ┊ 2┊ 7┊\n ┊ 3┊ 8┊export const resolvers: IResolvers = {\n-┊ 4┊  ┊  Query: {},\n+┊  ┊ 9┊  Query: {\n+┊  ┊10┊    // Show all users for the moment.\n+┊  ┊11┊    users: (): User[] => users.filter(user => user.id !== currentUser),\n+┊  ┊12┊    chats: (): Chat[] => chats.filter(chat => chat.listingMemberIds.includes(currentUser)),\n+┊  ┊13┊    chat: (obj: any, {chatId}): Chat | null => chats.find(chat => chat.id === chatId) || null,\n+┊  ┊14┊  },\n+┊  ┊15┊  Chat: {\n+┊  ┊16┊    name: (chat: Chat): string => chat.name ? chat.name : users\n+┊  ┊17┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser))!.name,\n+┊  ┊18┊    picture: (chat: Chat) => chat.name ? chat.picture : users\n+┊  ┊19┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser))!.picture,\n+┊  ┊20┊    allTimeMembers: (chat: Chat): User[] => users.filter(user => chat.allTimeMemberIds.includes(user.id)),\n+┊  ┊21┊    listingMembers: (chat: Chat): User[] => users.filter(user => chat.listingMemberIds.includes(user.id)),\n+┊  ┊22┊    actualGroupMembers: (chat: Chat): User[] => users.filter(user => chat.actualGroupMemberIds && chat.actualGroupMemberIds.includes(user.id)),\n+┊  ┊23┊    admins: (chat: Chat): User[] => users.filter(user => chat.adminIds && chat.adminIds.includes(user.id)),\n+┊  ┊24┊    owner: (chat: Chat): User | null => users.find(user => chat.ownerId === user.id) || null,\n+┊  ┊25┊    messages: (chat: Chat, {amount = 0}: {amount: number}): Message[] => {\n+┊  ┊26┊      const messages = chat.messages\n+┊  ┊27┊      .filter(message => message.holderIds.includes(currentUser))\n+┊  ┊28┊      .sort((a, b) => b.createdAt - a.createdAt) || <Message[]>[];\n+┊  ┊29┊      return (amount ? messages.slice(0, amount) : messages).reverse();\n+┊  ┊30┊    },\n+┊  ┊31┊    unreadMessages: (chat: Chat): number => chat.messages\n+┊  ┊32┊      .filter(message => message.holderIds.includes(currentUser) &&\n+┊  ┊33┊        message.recipients.find(recipient => recipient.userId === currentUser && !recipient.readAt))\n+┊  ┊34┊      .length,\n+┊  ┊35┊    isGroup: (chat: Chat): boolean => !!chat.name,\n+┊  ┊36┊  },\n+┊  ┊37┊  Message: {\n+┊  ┊38┊    chat: (message: Message): Chat | null => chats.find(chat => message.chatId === chat.id) || null,\n+┊  ┊39┊    sender: (message: Message): User | null => users.find(user => user.id === message.senderId) || null,\n+┊  ┊40┊    holders: (message: Message): User[] => users.filter(user => message.holderIds.includes(user.id)),\n+┊  ┊41┊    ownership: (message: Message): boolean => message.senderId === currentUser,\n+┊  ┊42┊  },\n+┊  ┊43┊  Recipient: {\n+┊  ┊44┊    user: (recipient: Recipient): User | null => users.find(user => recipient.userId === user.id) || null,\n+┊  ┊45┊    message: (recipient: Recipient): Message | null => {\n+┊  ┊46┊      const chat = chats.find(chat => recipient.chatId === chat.id);\n+┊  ┊47┊      return chat ? chat.messages.find(message => recipient.messageId === message.id) || null : null;\n+┊  ┊48┊    },\n+┊  ┊49┊    chat: (recipient: Recipient): Chat | null => chats.find(chat => recipient.chatId === chat.id) || null,\n+┊  ┊50┊  },\n ┊ 5┊51┊};\n```\n\n[}]: #\n\nOut basic server is already done and working. We still have no way to do any kind of mutation, but we already set up several queries to return a list of users or chats.\nIn particular we can choose if we want to return all the chats (and how many messages we want to return for each chat) or if we want to return a single chat. We can also choose which and how many properties we want to return for each query.\nWe can start the server by simply running:\n\n    yarn start\n\n## Client\n\nNow we can concentrate on the client and bootstrap it using Angular-CLI.\nFirst you will need to install it globally with:\n\n    yarn global add @angular/cli\n\nThen we can create a new project from scratch:\n\n    ng new client --style scss\n\nTime to install a couple of packages:\n\n    ng add apollo-angular\n    yarn add -D @types/graphql\n\nApollo's Schematics sets everything for us. The only thing missing is to fill the `url`.\n\n[{]: <helper> (diffStep \"1.1\" files=\"src/app/graphql.module.ts\" module=\"client\")\n\n#### [Step 1.1: Add angular-apollo to app module](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/3a40362)\n\n##### Added src&#x2F;app&#x2F;graphql.module.ts\n```diff\n@@ -0,0 +1,25 @@\n+┊  ┊ 1┊import { NgModule} from '@angular/core';\n+┊  ┊ 2┊import { ApolloModule, APOLLO_OPTIONS } from 'apollo-angular';\n+┊  ┊ 3┊import { HttpLinkModule, HttpLink } from 'apollo-angular-link-http';\n+┊  ┊ 4┊import { InMemoryCache } from 'apollo-cache-inmemory';\n+┊  ┊ 5┊\n+┊  ┊ 6┊const uri = 'http://localhost:3000/graphql';\n+┊  ┊ 7┊\n+┊  ┊ 8┊export function createApollo(httpLink: HttpLink) {\n+┊  ┊ 9┊  return {\n+┊  ┊10┊    link: httpLink.create({uri}),\n+┊  ┊11┊    cache: new InMemoryCache(),\n+┊  ┊12┊  };\n+┊  ┊13┊}\n+┊  ┊14┊\n+┊  ┊15┊@NgModule({\n+┊  ┊16┊  exports: [ApolloModule, HttpLinkModule],\n+┊  ┊17┊  providers: [\n+┊  ┊18┊    {\n+┊  ┊19┊      provide: APOLLO_OPTIONS,\n+┊  ┊20┊      useFactory: createApollo,\n+┊  ┊21┊      deps: [HttpLink],\n+┊  ┊22┊    },\n+┊  ┊23┊  ],\n+┊  ┊24┊})\n+┊  ┊25┊export class GraphQLModule {}\n```\n\n[}]: #\n\nLet's take a closer look what Schematics prepared for us.\n\nFirst, it created `graphql.module.ts` and used `ApolloModule` and `HttpLinkModule`.\n\n- `ApolloModule` is the center of using GraphQL in your app! It includes all needed services that allows to use ApolloClient’s features.\n- `HttpLinkModule` makes it easy to fetch data in Angular.\n\n`HttpLinkModule` is optional, you can replace it with any other Link.\nIts biggest advantage of all is that it uses Angular's `HttpClient` internally so it's possible to use it in `NativeScript` or in combination with any other `HttpClient` provider. By using `HttpLinkModule` you get Server-Side Rendering for free, without any additional work.\n\nNext, we got `APOLLO_OPTIONS` provided to Angular.\n\nWe're using the `InMemoryCache` cache, but there are several options like `Redux`, `Hermes` and even `ngrx`.\n\n- `apollo-cache-inmemory` is an official and recommended Apollo Cache.\n\n### Cache and Links\n\nThese are two main parts of Apollo Stack, both are pluggable and customizable.\n\n- **Cache** is responsible for storing data and keeping it consistent.\n- **Links** describe how to access the source of data (usually a GraphQL endpoint).\n\nLet's take a closer look on what cache means for Apollo, we're going to base it on the official `apollo-cache-inmemory`, one of many implementations.\n\nBut first, imagine, we write our own amazing Apollo Cache implementation.\n\n```graphql\nquery getMessages {\n  messages {\n    id\n    content\n    likes\n  }\n}\n```\n\nWhen we execute a query like one above what we get in return is an array of all messages of logged in user:\n\n```json\n{\n  \"data\": {\n    \"messages\": [\n      {\n        \"id\": 0,\n        \"content\": \"Hi\",\n        \"likes\": 0\n      },\n      {\n        \"id\": 1,\n        \"content\": \"Hello\",\n        \"likes\": 0\n      }\n    ]\n  }\n}\n```\n\nOur cache stores the result in exact shape as above.\n\nLater on we add more queries and one of them returns a list of messages from one conversation.\n\nNow, a short story. We've got two users, Niccolo and Dotan.\n\n1. Niccolo opens the app and Apollo fetches all of his messages (I know, it's stupid but stay with me)\n1. One message is to Dotan, Niccolo said \"Hi\" to him.\n1. Now Dotan opens the app and reacts to the message with a like.\n1. After few minutes Niccolo asks for messages from a conversation with Dotan.\n1. Apollo fetches those messages and there is one in which Niccolo says \"Hi\" and it's liked by Dotan.\n1. Now we have the same message twice, one has different state that the other, in one place there is no like, in other, we have +1.\n\nAs you see, our cache is not smart enough to figure out one query might be a subset of another.\nThat's because it doesn't get enough informations.\n\nLet's go back to InMemoryCache and see how it describes itself:\n\n> Thanks to InMemoryCache, it's possible for the results of a query or mutation to update the UI in all the right places. In many cases it's possible for that to happen automatically, whereas in others you need to help the client out a little in doing so.\n\nIt means it could solve the issue we have with duplicated messages with different state.\n\nIt's very important to understand one concept that InMemoryCache is heavily based on, it's called normalization.\n\nThe InMemoryCache splits the result into individual objects, creates a unique identifier for each of them and flattens everything up before saving it to the store.\nMight seem complicated at first, but as InMemoryCache, let's break everything into smaller parts.\n\nFirst, \"breaking the result into pieces\" part. The InMemoryCache tells ApolloClient to add `__typename` field to your query before passing it to the server. I used server for simplicity, it actually passes it to Apollo Links and they are responsible to make a HTTP request. Every Apollo Cache is able to transform a document, that's as a side note.\n\n```graphql\nquery getMessages {\n  messages {\n    id\n    content\n    likes\n    __typename\n  }\n}\n```\n\nThe `__typename` field tells about the type of the object. It's compatible with every GraphQL server as it's part of the specification.\n\n```graphql\ntype Message {\n  id: ID\n  content: String\n  likes: Int\n}\n\ntype Query {\n  messages: [Message]\n}\n```\n\nIn our case, `__typename` returns `Message`. So now InMemoryCache knows that a message is a Message. Computers are stupid, we have to tell them everything!\n\nNext, let's take a look at \"creates a unique identifier\" part.\n\nThe InMemoryCache iterates through every object and looks for the `__typename` and two fields, `id` and `_id` that usually are used as identifiers. Taking our example, it turns every Message object into `Message:1`, `Message:2`, `Message:3` and so on. You get the idea.\n\nIt's the default behaviour but you can change it as you wish:\n\n```typescript\nconst cache = new InMemoryCache({\n  dataIdFromObject(result) {\n    if (result.__typename) {\n      const id = result.uid || result.id || result._id;\n\n      if (id !== undefined) {\n        return `${result.__typename}:${id}`;\n      }\n    }\n    return null;\n  },\n});\n```\n\nGreat, we covered two out of three things InMemoryCache does. Now we're going to explore \"flattens everything up\".\n\nWe're able to understand the type of each individual object and it's unique identifier. It still has to be stored.\n\nWhat InMemoryCache does is it's saves every element on root level in a plain object where the key contains a unique identifier and the value has a body.\n\n```json\n{\n  \"Message:1\": {\n    \"id\": 1,\n    \"content\": \"Hi\",\n    \"likes\": 1,\n    \"__typename\": \"Message\"\n  },\n  \"Message:2\": {\n    \"id\": 2,\n    \"content\": \"Hello\",\n    \"likes\": 0,\n    \"__typename\": \"Message\"\n  },\n  \"ROOT_QUERY\": {\n    \"messages\": [\n      {\n        \"id\": \"Message:1\",\n        \"typename\": \"Message\"\n      },\n      {\n        \"id\": \"Message:2\",\n        \"typename\": \"Message\"\n      }\n    ]\n  }\n}\n```\n\nWait, `ROOT_QUERY`? Yes, it has to somehow store the actual result of every executed query so next time you ask for the same thing, it matches it with the query in store and resolves right away.\n\n> You should be aware that the InMemoryCache stringifies variables of a query too, which means the same queries but with different variables are stored separately. Even the order of those variables matters.\n\nAs you can see, each element in `ROOT_QUERY.message` is kind of a reference to a message record.\n\nLet's bring back our short story, a scenario.\nWhen Niccolo asks for all messages, the whole three part process is started, each message is saved to the store.\nWhen he asks for history of a conversation with Dotan, InMemoryCache starts the process again and if it sees that there is already a massage with the same unique identifier, it knows they both are the same so it merged them.\nThe InMemoryCache can tell what changed and emits the new object to the UI.\nThanks to that we no longer have the same message in two places where one has a like and other doesn't.\n\nUff, Apollo Cache part is done. Thanks for being with us that long, I hope you didn't get bored because there's a lot ahead of us.\n\nLet's talk Apollo Link.\n\nAs I mentioned it's kind of a network stack of Apollo. You execute a document with some metadata like variables or a context, Apollo Client receives it and passes it to the chain of Links.\n\nThe ApolloLink is based on an Observable (not RxJS) and if you know `RxJS` you're familiar with `pipe`. Each Link is basically a function that receives a requested operation and a function that runs the next Link. Just like a pipe!\n\n```typescript\nimport { ApolloLink } from 'apollo-link';\n\nconst log = new ApolloLink((operation, next) => {\n  console.log('Name', operation.operationName);\n  return next(operation);\n});\n```\n\nNow when we add it in `graphql.module.ts` we see the name of each requested operation.\n\nWe can even intercept the result.\n\n```typescript\nconst intercept = new ApolloLink((operation, next) => {\n    return forward(operation).map((data) => {\n        // data from a previous link\n        console.log('data', data);\n        return data;\n    });\n});\n```\n\nAs you can see below, by network we don't always mean making HTTP requests. It could be Http Link at the end of Links chain or WebSocket Link or even something that works on in-memory data.\n\n```typescript\nimport { ApolloLink, Observable } from 'apollo-link';\n\nconst inmemory = new ApolloLink(operation => {\n    return Observable(observer => {\n        // function that executes the operation and returns data\n        const result = resolveOperation(operation);\n\n        observer.next(result);\n        observer.complete();\n    });\n});\n```\n\nYou can find tons of helpful Links [on npm](https://www.npmjs.com/search?q=apollo-link-) and [on Apollo Link documentation](https://www.apollographql.com/docs/link/links/community.html).\n\nWe highly recommend to take a look at Angular related Links [on Apollo Angular documentation](https://www.apollographql.com/docs/angular/guides/tools-and-packages.html).\n\n### GQL Tag\n\nThe `gql` template tag is what you use to define GraphQL queries in your Apollo apps. It parses your GraphQL query into the `GraphQL.js AST format` which may then be consumed by Apollo methods. Whenever Apollo is asking for a GraphQL query you will always want to wrap it in a `gql` template tag.\n\nYou can embed a GraphQL document containing only fragments inside of another GraphQL document using template string interpolation. This allows you to use fragments defined in one part of your codebase inside of a query defined in a completely different file.\n\n[{]: <helper> (diffStep \"1.2\" file=\"src/graphql/fragment.ts\" module=\"client\")\n\n#### [Step 1.2: Add chats service](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/591a455)\n\n##### Added src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -0,0 +1,25 @@\n+┊  ┊ 1┊import {map} from 'rxjs/operators';\n+┊  ┊ 2┊import {Apollo} from 'apollo-angular';\n+┊  ┊ 3┊import {Injectable} from '@angular/core';\n+┊  ┊ 4┊import {getChatsQuery} from '../../graphql/getChats.query';\n+┊  ┊ 5┊\n+┊  ┊ 6┊@Injectable()\n+┊  ┊ 7┊export class ChatsService {\n+┊  ┊ 8┊  messagesAmount = 3;\n+┊  ┊ 9┊\n+┊  ┊10┊  constructor(private apollo: Apollo) {}\n+┊  ┊11┊\n+┊  ┊12┊  getChats() {\n+┊  ┊13┊    const query = this.apollo.watchQuery<any>({\n+┊  ┊14┊      query: getChatsQuery,\n+┊  ┊15┊      variables: {\n+┊  ┊16┊        amount: this.messagesAmount,\n+┊  ┊17┊      },\n+┊  ┊18┊    });\n+┊  ┊19┊    const chats$ = query.valueChanges.pipe(\n+┊  ┊20┊      map((result) => result.data.chats)\n+┊  ┊21┊    );\n+┊  ┊22┊\n+┊  ┊23┊    return {query, chats$};\n+┊  ┊24┊  }\n+┊  ┊25┊}\n```\n\n##### Added src&#x2F;graphql&#x2F;fragment.ts\n```diff\n@@ -0,0 +1,51 @@\n+┊  ┊ 1┊import gql from 'graphql-tag';\n+┊  ┊ 2┊import {DocumentNode} from 'graphql';\n+┊  ┊ 3┊\n+┊  ┊ 4┊export const fragments: {\n+┊  ┊ 5┊  [key: string]: DocumentNode\n+┊  ┊ 6┊} = {\n+┊  ┊ 7┊  chatWithoutMessages: gql`\n+┊  ┊ 8┊    fragment ChatWithoutMessages on Chat {\n+┊  ┊ 9┊      id\n+┊  ┊10┊      name\n+┊  ┊11┊      picture\n+┊  ┊12┊      allTimeMembers {\n+┊  ┊13┊        id\n+┊  ┊14┊      }\n+┊  ┊15┊      unreadMessages\n+┊  ┊16┊      isGroup\n+┊  ┊17┊    }\n+┊  ┊18┊  `,\n+┊  ┊19┊  message: gql`\n+┊  ┊20┊    fragment Message on Message {\n+┊  ┊21┊      id\n+┊  ┊22┊      chat {\n+┊  ┊23┊        id\n+┊  ┊24┊      }\n+┊  ┊25┊      sender {\n+┊  ┊26┊        id\n+┊  ┊27┊        name\n+┊  ┊28┊      }\n+┊  ┊29┊      content\n+┊  ┊30┊      createdAt\n+┊  ┊31┊      type\n+┊  ┊32┊      recipients {\n+┊  ┊33┊        user {\n+┊  ┊34┊          id\n+┊  ┊35┊        }\n+┊  ┊36┊        message {\n+┊  ┊37┊          id\n+┊  ┊38┊          chat {\n+┊  ┊39┊            id\n+┊  ┊40┊          }\n+┊  ┊41┊        }\n+┊  ┊42┊        chat {\n+┊  ┊43┊          id\n+┊  ┊44┊        }\n+┊  ┊45┊        receivedAt\n+┊  ┊46┊        readAt\n+┊  ┊47┊      }\n+┊  ┊48┊      ownership\n+┊  ┊49┊    }\n+┊  ┊50┊  `,\n+┊  ┊51┊};\n```\n\n##### Added src&#x2F;graphql&#x2F;getChats.query.ts\n```diff\n@@ -0,0 +1,17 @@\n+┊  ┊ 1┊import gql from 'graphql-tag';\n+┊  ┊ 2┊import {fragments} from './fragment';\n+┊  ┊ 3┊\n+┊  ┊ 4┊// We use the gql tag to parse our query string into a query document\n+┊  ┊ 5┊export const getChatsQuery = gql`\n+┊  ┊ 6┊  query GetChats($amount: Int) {\n+┊  ┊ 7┊    chats {\n+┊  ┊ 8┊      ...ChatWithoutMessages\n+┊  ┊ 9┊      messages(amount: $amount) {\n+┊  ┊10┊        ...Message\n+┊  ┊11┊      }\n+┊  ┊12┊    }\n+┊  ┊13┊  }\n+┊  ┊14┊\n+┊  ┊15┊  ${fragments['chatWithoutMessages']}\n+┊  ┊16┊  ${fragments['message']}\n+┊  ┊17┊`;\n```\n\n[}]: #\n\n### Use Apollo service\n\nLet's create a simple service to query the chats from our just created server:\n\n[{]: <helper> (diffStep \"1.2\" files=\"src/app/services\" module=\"client\")\n\n#### [Step 1.2: Add chats service](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/591a455)\n\n##### Added src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -0,0 +1,25 @@\n+┊  ┊ 1┊import {map} from 'rxjs/operators';\n+┊  ┊ 2┊import {Apollo} from 'apollo-angular';\n+┊  ┊ 3┊import {Injectable} from '@angular/core';\n+┊  ┊ 4┊import {getChatsQuery} from '../../graphql/getChats.query';\n+┊  ┊ 5┊\n+┊  ┊ 6┊@Injectable()\n+┊  ┊ 7┊export class ChatsService {\n+┊  ┊ 8┊  messagesAmount = 3;\n+┊  ┊ 9┊\n+┊  ┊10┊  constructor(private apollo: Apollo) {}\n+┊  ┊11┊\n+┊  ┊12┊  getChats() {\n+┊  ┊13┊    const query = this.apollo.watchQuery<any>({\n+┊  ┊14┊      query: getChatsQuery,\n+┊  ┊15┊      variables: {\n+┊  ┊16┊        amount: this.messagesAmount,\n+┊  ┊17┊      },\n+┊  ┊18┊    });\n+┊  ┊19┊    const chats$ = query.valueChanges.pipe(\n+┊  ┊20┊      map((result) => result.data.chats)\n+┊  ┊21┊    );\n+┊  ┊22┊\n+┊  ┊23┊    return {query, chats$};\n+┊  ┊24┊  }\n+┊  ┊25┊}\n```\n\n[}]: #\n\nWe just learned how to use Apollo to attach GraphQL query results to the Angular UI.\n\nThe `watchQuery` method returns a `QueryRef` object which has the `valueChanges` property that is an `Observable`.\n\nEvery fetched data is stored in Apollo Client’s cache, so if some other query fetches new information about the chats, this component will update to remain consistent.\n\nIt’s also possible to fetch data only once. You simply use `query` method instead of `watchQuery`. The query method of Apollo service returns an Observable too that also resolves with the same result as above.\n\n#### But what is a `QueryRef`?\n\nAs you know, `query` method returns an Observable that emits a result, just once, then the observable completes. `watchQuery` works a bit different. It fetches data then stays open and listens to the Cache for updates.\n\nSo why `watchQuery` can not simply expose an Observable and it serves `QueryRef` instead?\n\nBecause Apollo Angular is a bridge between Apollo Client (core library) and Angular framework it has to operate on RxJS based Observables. RxJS Observable has a simple API that cannot be easily extended and it's in general a bad practice.\n\nWhy we're talking about those things? Apollo Client exposes an Observable that has bunch of custom method on it. They are super useful and their purpose is to talk to Apollo through them.\n\nSince we have to turn Apollo's Observable to something that is compatible with RxJS we decided to expose an object that has all those methods and `valueChanges` property that is a regular RxJS Observable.\n\n#### Make our app pretty\n\nWe will use Materials for the UI, so let's install it:\n\n    yarn add @angular/cdk @angular/material hammerjs ng2-truncate\n\nLet's configure Material:\n\n[{]: <helper> (diffStep \"1.3\" files=\"src/index.ts, src/main.ts, src/styles.scss\" module=\"client\")\n\n#### [Step 1.3: List the chats](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/7d716ee)\n\n##### Changed src&#x2F;main.ts\n```diff\n@@ -4,6 +4,9 @@\n ┊ 4┊ 4┊import { AppModule } from './app/app.module';\n ┊ 5┊ 5┊import { environment } from './environments/environment';\n ┊ 6┊ 6┊\n+┊  ┊ 7┊// Material gestures\n+┊  ┊ 8┊import 'hammerjs';\n+┊  ┊ 9┊\n ┊ 7┊10┊if (environment.production) {\n ┊ 8┊11┊  enableProdMode();\n ┊ 9┊12┊}\n```\n\n##### Changed src&#x2F;styles.scss\n```diff\n@@ -1 +1,28 @@\n ┊ 1┊ 1┊/* You can add global styles to this file, and also import other style files */\n+┊  ┊ 2┊\n+┊  ┊ 3┊/* Meterial theme */\n+┊  ┊ 4┊@import \"~@angular/material/prebuilt-themes/indigo-pink.css\";\n+┊  ┊ 5┊\n+┊  ┊ 6┊:root {\n+┊  ┊ 7┊  --primary: #2c6157;\n+┊  ┊ 8┊  --secondary: #6fd056;\n+┊  ┊ 9┊}\n+┊  ┊10┊\n+┊  ┊11┊body {\n+┊  ┊12┊  margin: 0;\n+┊  ┊13┊}\n+┊  ┊14┊\n+┊  ┊15┊.mat-primary {\n+┊  ┊16┊  background-color: var(--primary) !important;\n+┊  ┊17┊  color: white;\n+┊  ┊18┊}\n+┊  ┊19┊\n+┊  ┊20┊.mat-secondary {\n+┊  ┊21┊  background-color: var(--secondary) !important;\n+┊  ┊22┊  color: white;\n+┊  ┊23┊}\n+┊  ┊24┊\n+┊  ┊25┊.mat-toolbar {\n+┊  ┊26┊  color: white;\n+┊  ┊27┊  background-color: var(--primary) !important;\n+┊  ┊28┊}\n```\n\n[}]: #\n\nWe're now creating a `shared` module where we will define our header component where we're going to project a different content from each component:\n\n[{]: <helper> (diffStep \"1.3\" files=\"src/app/shared/*\" module=\"client\")\n\n#### [Step 1.3: List the chats](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/7d716ee)\n\n##### Added src&#x2F;app&#x2F;shared&#x2F;components&#x2F;toolbar&#x2F;toolbar.component.scss\n```diff\n@@ -0,0 +1,15 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊  height: 8vh;\n+┊  ┊ 4┊}\n+┊  ┊ 5┊\n+┊  ┊ 6┊.mat-toolbar {\n+┊  ┊ 7┊  justify-content: space-between;\n+┊  ┊ 8┊  height: 100%;\n+┊  ┊ 9┊\n+┊  ┊10┊  .left-block {\n+┊  ┊11┊    display: flex;\n+┊  ┊12┊    height: 8vh;\n+┊  ┊13┊    line-height: 8vh;\n+┊  ┊14┊  }\n+┊  ┊15┊}\n```\n\n##### Added src&#x2F;app&#x2F;shared&#x2F;components&#x2F;toolbar&#x2F;toolbar.component.ts\n```diff\n@@ -0,0 +1,19 @@\n+┊  ┊ 1┊import {Component} from '@angular/core';\n+┊  ┊ 2┊\n+┊  ┊ 3┊@Component({\n+┊  ┊ 4┊  selector: 'app-toolbar',\n+┊  ┊ 5┊  template: `\n+┊  ┊ 6┊    <mat-toolbar>\n+┊  ┊ 7┊      <div class=\"left-block\">\n+┊  ┊ 8┊        <ng-content select=\".navigation\"></ng-content>\n+┊  ┊ 9┊        <ng-content select=\".profile-pic\"></ng-content>\n+┊  ┊10┊        <ng-content select=\".title\"></ng-content>\n+┊  ┊11┊      </div>\n+┊  ┊12┊      <ng-content select=\".menu\"></ng-content>\n+┊  ┊13┊    </mat-toolbar>\n+┊  ┊14┊  `,\n+┊  ┊15┊  styleUrls: ['./toolbar.component.scss']\n+┊  ┊16┊})\n+┊  ┊17┊export class ToolbarComponent {\n+┊  ┊18┊\n+┊  ┊19┊}\n```\n\n##### Added src&#x2F;app&#x2F;shared&#x2F;shared.module.ts\n```diff\n@@ -0,0 +1,28 @@\n+┊  ┊ 1┊import {BrowserModule} from '@angular/platform-browser';\n+┊  ┊ 2┊import {NgModule} from '@angular/core';\n+┊  ┊ 3┊\n+┊  ┊ 4┊import {MatToolbarModule} from '@angular/material';\n+┊  ┊ 5┊import {ToolbarComponent} from './components/toolbar/toolbar.component';\n+┊  ┊ 6┊import {FormsModule} from '@angular/forms';\n+┊  ┊ 7┊import {BrowserAnimationsModule} from '@angular/platform-browser/animations';\n+┊  ┊ 8┊\n+┊  ┊ 9┊@NgModule({\n+┊  ┊10┊  declarations: [\n+┊  ┊11┊    ToolbarComponent,\n+┊  ┊12┊  ],\n+┊  ┊13┊  imports: [\n+┊  ┊14┊    BrowserModule,\n+┊  ┊15┊    // Material\n+┊  ┊16┊    MatToolbarModule,\n+┊  ┊17┊    // Animations\n+┊  ┊18┊    BrowserAnimationsModule,\n+┊  ┊19┊    // Forms\n+┊  ┊20┊    FormsModule,\n+┊  ┊21┊  ],\n+┊  ┊22┊  providers: [],\n+┊  ┊23┊  exports: [\n+┊  ┊24┊    ToolbarComponent,\n+┊  ┊25┊  ],\n+┊  ┊26┊})\n+┊  ┊27┊export class SharedModule {\n+┊  ┊28┊}\n```\n\n[}]: #\n\nNow we want to create the `chats-lister` module, with a container component called `ChatsComponent` and a couple of presentational components. Each and every chat item would be presented with a default profile picture as a placeholder, so before we proceed we will have to download it to the `src/assets` directory:\n\n    $ wget https://raw.githubusercontent.com/DAB0mB/whatsapp-client-angularcli-material/c75c2416b1990da3588015f76b8338764f44d6ec/src/assets/default-profile-pic.jpg -P src/assets\n\nAnd now we can proceed to creating the relevant components and their style sheets:\n\n[{]: <helper> (diffStep \"1.3\" files=\"src/app/chats-lister/*\" module=\"client\")\n\n#### [Step 1.3: List the chats](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/7d716ee)\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;chats-lister.module.ts\n```diff\n@@ -0,0 +1,49 @@\n+┊  ┊ 1┊import { BrowserModule } from '@angular/platform-browser';\n+┊  ┊ 2┊import { NgModule } from '@angular/core';\n+┊  ┊ 3┊\n+┊  ┊ 4┊import {BrowserAnimationsModule} from '@angular/platform-browser/animations';\n+┊  ┊ 5┊import {MatButtonModule, MatIconModule, MatListModule, MatMenuModule} from '@angular/material';\n+┊  ┊ 6┊import {RouterModule, Routes} from '@angular/router';\n+┊  ┊ 7┊import {FormsModule} from '@angular/forms';\n+┊  ┊ 8┊import {ChatsService} from '../services/chats.service';\n+┊  ┊ 9┊import {ChatItemComponent} from './components/chat-item/chat-item.component';\n+┊  ┊10┊import {ChatsComponent} from './containers/chats/chats.component';\n+┊  ┊11┊import {ChatsListComponent} from './components/chats-list/chats-list.component';\n+┊  ┊12┊import {TruncateModule} from 'ng2-truncate';\n+┊  ┊13┊import {SharedModule} from '../shared/shared.module';\n+┊  ┊14┊\n+┊  ┊15┊const routes: Routes = [\n+┊  ┊16┊  {path: '', redirectTo: 'chats', pathMatch: 'full'},\n+┊  ┊17┊  {path: 'chats', component: ChatsComponent},\n+┊  ┊18┊];\n+┊  ┊19┊\n+┊  ┊20┊@NgModule({\n+┊  ┊21┊  declarations: [\n+┊  ┊22┊    ChatsComponent,\n+┊  ┊23┊    ChatsListComponent,\n+┊  ┊24┊    ChatItemComponent,\n+┊  ┊25┊  ],\n+┊  ┊26┊  imports: [\n+┊  ┊27┊    BrowserModule,\n+┊  ┊28┊    // Material\n+┊  ┊29┊    MatMenuModule,\n+┊  ┊30┊    MatIconModule,\n+┊  ┊31┊    MatButtonModule,\n+┊  ┊32┊    MatListModule,\n+┊  ┊33┊    // Animations\n+┊  ┊34┊    BrowserAnimationsModule,\n+┊  ┊35┊    // Routing\n+┊  ┊36┊    RouterModule.forChild(routes),\n+┊  ┊37┊    // Forms\n+┊  ┊38┊    FormsModule,\n+┊  ┊39┊    // Truncate Pipe\n+┊  ┊40┊    TruncateModule,\n+┊  ┊41┊    // Feature modules\n+┊  ┊42┊    SharedModule,\n+┊  ┊43┊  ],\n+┊  ┊44┊  providers: [\n+┊  ┊45┊    ChatsService,\n+┊  ┊46┊  ],\n+┊  ┊47┊})\n+┊  ┊48┊export class ChatsListerModule {\n+┊  ┊49┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chat-item&#x2F;chat-item.component.scss\n```diff\n@@ -0,0 +1,44 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊  width: 100%;\n+┊  ┊ 4┊}\n+┊  ┊ 5┊\n+┊  ┊ 6┊.chat-row {\n+┊  ┊ 7┊  margin: 10px 0 0 10px;\n+┊  ┊ 8┊  height: 60px;\n+┊  ┊ 9┊  display: flex;\n+┊  ┊10┊\n+┊  ┊11┊  .chat-pic {\n+┊  ┊12┊    height: 50px;\n+┊  ┊13┊    width: auto;\n+┊  ┊14┊    border-radius: 50%;\n+┊  ┊15┊  }\n+┊  ┊16┊\n+┊  ┊17┊  .chat-info {\n+┊  ┊18┊    width: calc(100% - 60px);\n+┊  ┊19┊    height: 100%;\n+┊  ┊20┊    margin-left: 10px;\n+┊  ┊21┊    border-bottom: .5px solid silver;\n+┊  ┊22┊    position: relative;\n+┊  ┊23┊\n+┊  ┊24┊    .chat-name {\n+┊  ┊25┊      margin-top: 5px;\n+┊  ┊26┊    }\n+┊  ┊27┊\n+┊  ┊28┊    .chat-last-message {\n+┊  ┊29┊      color: gray;\n+┊  ┊30┊      font-size: 15px;\n+┊  ┊31┊      margin-top: 5px;\n+┊  ┊32┊      text-overflow: ellipsis;\n+┊  ┊33┊      overflow: hidden;\n+┊  ┊34┊    }\n+┊  ┊35┊\n+┊  ┊36┊    .chat-timestamp {\n+┊  ┊37┊      position: absolute;\n+┊  ┊38┊      color: gray;\n+┊  ┊39┊      top: 5px;\n+┊  ┊40┊      right: 5px;\n+┊  ┊41┊      font-size: 13px;\n+┊  ┊42┊    }\n+┊  ┊43┊  }\n+┊  ┊44┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chat-item&#x2F;chat-item.component.ts\n```diff\n@@ -0,0 +1,21 @@\n+┊  ┊ 1┊import {Component, Input} from '@angular/core';\n+┊  ┊ 2┊\n+┊  ┊ 3┊@Component({\n+┊  ┊ 4┊  selector: 'app-chat-item',\n+┊  ┊ 5┊  template: `\n+┊  ┊ 6┊    <div class=\"chat-row\">\n+┊  ┊ 7┊      <img class=\"chat-pic\" [src]=\"chat.picture || 'assets/default-profile-pic.jpg'\">\n+┊  ┊ 8┊      <div class=\"chat-info\">\n+┊  ┊ 9┊        <div class=\"chat-name\">{{ chat.name }}</div>\n+┊  ┊10┊        <div class=\"chat-last-message\">{{ chat.messages?[chat.messages?.length - 1]?.content }}</div>\n+┊  ┊11┊        <div class=\"chat-timestamp\">00:00</div>\n+┊  ┊12┊      </div>\n+┊  ┊13┊    </div>\n+┊  ┊14┊  `,\n+┊  ┊15┊  styleUrls: ['chat-item.component.scss'],\n+┊  ┊16┊})\n+┊  ┊17┊export class ChatItemComponent {\n+┊  ┊18┊  // tslint:disable-next-line:no-input-rename\n+┊  ┊19┊  @Input('item')\n+┊  ┊20┊  chat: any;\n+┊  ┊21┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chats-list&#x2F;chats-list.component.scss\n```diff\n@@ -0,0 +1,8 @@\n+┊ ┊1┊:host {\n+┊ ┊2┊  display: block;\n+┊ ┊3┊}\n+┊ ┊4┊\n+┊ ┊5┊:host ::ng-deep .mat-list-item-content:first-child {\n+┊ ┊6┊  padding-left: 0 !important;\n+┊ ┊7┊  display: flow-root !important;\n+┊ ┊8┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chats-list&#x2F;chats-list.component.ts\n```diff\n@@ -0,0 +1,20 @@\n+┊  ┊ 1┊import {Component, Input} from '@angular/core';\n+┊  ┊ 2┊\n+┊  ┊ 3┊@Component({\n+┊  ┊ 4┊  selector: 'app-chats-list',\n+┊  ┊ 5┊  template: `\n+┊  ┊ 6┊    <mat-list>\n+┊  ┊ 7┊      <mat-list-item *ngFor=\"let chat of chats\">\n+┊  ┊ 8┊        <app-chat-item [item]=\"chat\"></app-chat-item>\n+┊  ┊ 9┊      </mat-list-item>\n+┊  ┊10┊    </mat-list>\n+┊  ┊11┊  `,\n+┊  ┊12┊  styleUrls: ['chats-list.component.scss'],\n+┊  ┊13┊})\n+┊  ┊14┊export class ChatsListComponent {\n+┊  ┊15┊  // tslint:disable-next-line:no-input-rename\n+┊  ┊16┊  @Input('items')\n+┊  ┊17┊  chats: any[];\n+┊  ┊18┊\n+┊  ┊19┊  constructor() {}\n+┊  ┊20┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.scss\n```diff\n@@ -0,0 +1,5 @@\n+┊ ┊1┊.chat-button {\n+┊ ┊2┊  position: absolute;\n+┊ ┊3┊  bottom: 5vw;\n+┊ ┊4┊  right: 5vw;\n+┊ ┊5┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.ts\n```diff\n@@ -0,0 +1,46 @@\n+┊  ┊ 1┊import {Component, OnInit} from '@angular/core';\n+┊  ┊ 2┊import {ChatsService} from '../../../services/chats.service';\n+┊  ┊ 3┊import {Observable} from 'rxjs';\n+┊  ┊ 4┊\n+┊  ┊ 5┊@Component({\n+┊  ┊ 6┊  template: `\n+┊  ┊ 7┊    <app-toolbar>\n+┊  ┊ 8┊      <div class=\"title\">Whatsapp Clone</div>\n+┊  ┊ 9┊      <button mat-icon-button [matMenuTriggerFor]=\"menu\" class=\"menu\">\n+┊  ┊10┊        <mat-icon>more_vert</mat-icon>\n+┊  ┊11┊      </button>\n+┊  ┊12┊    </app-toolbar>\n+┊  ┊13┊\n+┊  ┊14┊    <mat-menu #menu=\"matMenu\">\n+┊  ┊15┊      <button mat-menu-item>\n+┊  ┊16┊        <mat-icon>dialpad</mat-icon>\n+┊  ┊17┊        <span>Redial</span>\n+┊  ┊18┊      </button>\n+┊  ┊19┊      <button mat-menu-item disabled>\n+┊  ┊20┊        <mat-icon>voicemail</mat-icon>\n+┊  ┊21┊        <span>Check voicemail</span>\n+┊  ┊22┊      </button>\n+┊  ┊23┊      <button mat-menu-item>\n+┊  ┊24┊        <mat-icon>notifications_off</mat-icon>\n+┊  ┊25┊        <span>Disable alerts</span>\n+┊  ┊26┊      </button>\n+┊  ┊27┊    </mat-menu>\n+┊  ┊28┊\n+┊  ┊29┊    <app-chats-list [items]=\"chats$ | async\"></app-chats-list>\n+┊  ┊30┊\n+┊  ┊31┊    <button class=\"chat-button\" mat-fab color=\"secondary\">\n+┊  ┊32┊      <mat-icon aria-label=\"Icon-button with a + icon\">chat</mat-icon>\n+┊  ┊33┊    </button>\n+┊  ┊34┊  `,\n+┊  ┊35┊  styleUrls: ['./chats.component.scss'],\n+┊  ┊36┊})\n+┊  ┊37┊export class ChatsComponent implements OnInit {\n+┊  ┊38┊  chats$: Observable<any[]>;\n+┊  ┊39┊\n+┊  ┊40┊  constructor(private chatsService: ChatsService) {\n+┊  ┊41┊  }\n+┊  ┊42┊\n+┊  ┊43┊  ngOnInit() {\n+┊  ┊44┊    this.chats$ = this.chatsService.getChats().chats$;\n+┊  ┊45┊  }\n+┊  ┊46┊}\n```\n\n[}]: #\n\nFinally let's wire everything up to the main module:\n\n[{]: <helper> (diffStep \"1.3\" files=\"src/app/app.component.ts, src/app/app.module.ts\" module=\"client\")\n\n#### [Step 1.3: List the chats](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/7d716ee)\n\n##### Changed src&#x2F;app&#x2F;app.component.ts\n```diff\n@@ -2,7 +2,9 @@\n ┊ 2┊ 2┊\n ┊ 3┊ 3┊@Component({\n ┊ 4┊ 4┊  selector: 'app-root',\n-┊ 5┊  ┊  templateUrl: './app.component.html',\n+┊  ┊ 5┊  template: `\n+┊  ┊ 6┊    <router-outlet></router-outlet>\n+┊  ┊ 7┊  `,\n ┊ 6┊ 8┊  styleUrls: ['./app.component.scss']\n ┊ 7┊ 9┊})\n ┊ 8┊10┊export class AppComponent {\n```\n\n##### Changed src&#x2F;app&#x2F;app.module.ts\n```diff\n@@ -4,6 +4,9 @@\n ┊ 4┊ 4┊import { AppComponent } from './app.component';\n ┊ 5┊ 5┊import { HttpClientModule } from '@angular/common/http';\n ┊ 6┊ 6┊import { GraphQLModule } from './graphql.module';\n+┊  ┊ 7┊import {ChatsListerModule} from './chats-lister/chats-lister.module';\n+┊  ┊ 8┊import {RouterModule, Routes} from '@angular/router';\n+┊  ┊ 9┊const routes: Routes = [];\n ┊ 7┊10┊\n ┊ 8┊11┊@NgModule({\n ┊ 9┊12┊  declarations: [\n```\n```diff\n@@ -13,6 +16,10 @@\n ┊13┊16┊    BrowserModule,\n ┊14┊17┊    HttpClientModule,\n ┊15┊18┊    GraphQLModule,\n+┊  ┊19┊    // Routing\n+┊  ┊20┊    RouterModule.forRoot(routes),\n+┊  ┊21┊    // Feature modules\n+┊  ┊22┊    ChatsListerModule,\n ┊16┊23┊  ],\n ┊17┊24┊  providers: [],\n ┊18┊25┊  bootstrap: [AppComponent]\n```\n\n[}]: #\n\nIf you will try to run the frontend you will notice that several messages seems like duplicated, why does it happen?\n\nSince we use NoSQL-like structure in our backend, messages are stored as an array inside each chat so their incremental identifiers are not unique across different chats. We need to normalize them in a way that takes into account both the message id and the chat id:\n\n[{]: <helper> (diffStep \"1.4\" module=\"client\")\n\n#### [Step 1.4: Better normalize messages](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/4209360)\n\n##### Changed src&#x2F;app&#x2F;graphql.module.ts\n```diff\n@@ -1,14 +1,21 @@\n ┊ 1┊ 1┊import { NgModule} from '@angular/core';\n ┊ 2┊ 2┊import { ApolloModule, APOLLO_OPTIONS } from 'apollo-angular';\n ┊ 3┊ 3┊import { HttpLinkModule, HttpLink } from 'apollo-angular-link-http';\n-┊ 4┊  ┊import { InMemoryCache } from 'apollo-cache-inmemory';\n+┊  ┊ 4┊import { InMemoryCache, defaultDataIdFromObject } from 'apollo-cache-inmemory';\n ┊ 5┊ 5┊\n ┊ 6┊ 6┊const uri = 'http://localhost:3000/graphql';\n ┊ 7┊ 7┊\n ┊ 8┊ 8┊export function createApollo(httpLink: HttpLink) {\n ┊ 9┊ 9┊  return {\n ┊10┊10┊    link: httpLink.create({uri}),\n-┊11┊  ┊    cache: new InMemoryCache(),\n+┊  ┊11┊    cache: new InMemoryCache({\n+┊  ┊12┊      dataIdFromObject: (object: any) => {\n+┊  ┊13┊        switch (object.__typename) {\n+┊  ┊14┊          case 'Message': return `${object.chat.id}:${object.id}`; // use `chatId` prefix and `messageId` as the primary key\n+┊  ┊15┊          default: return defaultDataIdFromObject(object); // fall back to default handling\n+┊  ┊16┊        }\n+┊  ┊17┊      }\n+┊  ┊18┊    }),\n ┊12┊19┊  };\n ┊13┊20┊}\n```\n\n[}]: #\n\nThat way our application will work even if the backend is a NoSQL. What's even more interesting is that our application will keep working as well even when we will switch our backend to PostgreSQL."
          },
          {
            "manualTitle": "Step 6: graphql-code-generator",
            "stepRevision": "b39f987d0944ef79a533fa88893c3a79b814a84f",
            "manualView": "## Code Generation\n\nGraphQL entities are defined as static and typed, which means they can be analyzed and use as a base for generating everything.\n\nThere are many tools related to that topic, but we're going to focus on The **GraphQL Coge Generator**.\n\nThe GraphQL Coge Generator can generate any code for any language  —  including type definitions, data models, query builder, resolvers, ORM code, complete full stack platforms.\n\nThe tool is based on the concept of templates. It has few official templates to solve most required features. The GraphQL Code Gen allows to create your own custom codegen templates in 10 minutes, that fit exactly your needs.\n\nWe will use TypeScript template to generate typings.\n\n### Generating types for server-side code\n\nFirst, let's install `graphql-code-generator` with the TypeScript template and add it to the run scripts:\n\n    yarn add graphql-code-generator graphql-codegen-typescript-template\n\n[{]: <helper> (diffStep \"2.1\" module=\"server\")\n\n#### [Step 2.1: Install graphql-code-generator](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/b8214fd)\n\n##### Changed package.json\n```diff\n@@ -4,7 +4,8 @@\n ┊ 4┊ 4┊  \"private\": true,\n ┊ 5┊ 5┊  \"scripts\": {\n ┊ 6┊ 6┊    \"start\": \"npm run build:live\",\n-┊ 7┊  ┊    \"build:live\": \"nodemon --exec ./node_modules/.bin/ts-node -- ./index.ts\"\n+┊  ┊ 7┊    \"build:live\": \"nodemon --exec ./node_modules/.bin/ts-node -- ./index.ts\",\n+┊  ┊ 8┊    \"generator\": \"gql-gen -r ts-node/register —schema schema/typeDefs.ts --template ts --out ./types.d.ts\"\n ┊ 8┊ 9┊  },\n ┊ 9┊10┊  \"devDependencies\": {\n ┊10┊11┊    \"@types/body-parser\": \"1.17.0\",\n```\n```diff\n@@ -22,6 +23,7 @@\n ┊22┊23┊    \"cors\": \"2.8.4\",\n ┊23┊24┊    \"express\": \"4.16.3\",\n ┊24┊25┊    \"graphql\": \"14.0.2\",\n+┊  ┊26┊    \"graphql-code-generator\": \"0.12.6\",\n ┊25┊27┊    \"moment\": \"2.22.1\"\n ┊26┊28┊  }\n ┊27┊29┊}\n```\n\n[}]: #\n\nFew things here:\n\n- `--require ts-node/register` - makes the ts-node compile TypeScript files\n- `--schema` - points to a file that exports the GraphQL Schema object or a string (it also accepts an url)\n- `--template` - tells about the template we want to use\n- `--out` - the location of a generated file\n\nNow let's run the generator:\n\n    yarn generator\n\nPlease note that the server doesn't have to be running in background because we import schema through a file.\n\nNext, let's use the generated types:\n\n[{]: <helper> (diffStep \"2.3\" module=\"server\")\n\n#### [Step 2.3: Use our types](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/ef59ecf)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,5 +1,6 @@\n ┊1┊1┊import { IResolvers } from 'apollo-server-express';\n ┊2┊2┊import { Chat, db, Message, Recipient, User } from \"../db\";\n+┊ ┊3┊import { ChatQueryArgs } from \"../types\";\n ┊3┊4┊\n ┊4┊5┊let users = db.users;\n ┊5┊6┊let chats = db.chats;\n```\n```diff\n@@ -10,7 +11,7 @@\n ┊10┊11┊    // Show all users for the moment.\n ┊11┊12┊    users: (): User[] => users.filter(user => user.id !== currentUser),\n ┊12┊13┊    chats: (): Chat[] => chats.filter(chat => chat.listingMemberIds.includes(currentUser)),\n-┊13┊  ┊    chat: (obj: any, {chatId}): Chat | null => chats.find(chat => chat.id === chatId) || null,\n+┊  ┊14┊    chat: (obj: any, {chatId}: ChatQueryArgs): Chat | null => chats.find(chat => chat.id === Number(chatId)) || null,\n ┊14┊15┊  },\n ┊15┊16┊  Chat: {\n ┊16┊17┊    name: (chat: Chat): string => chat.name ? chat.name : users\n```\n\n[}]: #\n\nDon't worry, they will be much more useful when we will write our first mutation.\n\n### Generating types for client-side code\n\nLet's do the same on the client:\n\n    yarn add graphql-code-generator graphql-codegen-typescript-template\n\nPlease note that in this case, the server must be started before running the generator.\n\n[{]: <helper> (diffStep \"2.1\" module=\"client\")\n\n#### [Step 2.1: Install graphql-code-generator](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/a97dbe5)\n\n##### Changed package.json\n```diff\n@@ -7,7 +7,8 @@\n ┊ 7┊ 7┊    \"build\": \"ng build\",\n ┊ 8┊ 8┊    \"test\": \"ng test\",\n ┊ 9┊ 9┊    \"lint\": \"ng lint\",\n-┊10┊  ┊    \"e2e\": \"ng e2e\"\n+┊  ┊10┊    \"e2e\": \"ng e2e\",\n+┊  ┊11┊    \"generator\": \"gql-gen --schema http://localhost:3000/graphql --template graphql-codegen-typescript-template --out ./src/graphql.ts ./src/graphql/**/*.ts\"\n ┊11┊12┊  },\n ┊12┊13┊  \"private\": true,\n ┊13┊14┊  \"dependencies\": {\n```\n```diff\n@@ -45,6 +46,7 @@\n ┊45┊46┊    \"@types/jasminewd2\": \"2.0.3\",\n ┊46┊47┊    \"@types/node\": \"8.9.5\",\n ┊47┊48┊    \"codelyzer\": \"4.2.1\",\n+┊  ┊49┊    \"graphql-code-generator\": \"0.12.6\",\n ┊48┊50┊    \"jasmine-core\": \"2.99.1\",\n ┊49┊51┊    \"jasmine-spec-reporter\": \"4.2.1\",\n ┊50┊52┊    \"karma\": \"1.7.1\",\n```\n\n[}]: #\n\nWe saw how to use them on the server but let's see how easy it is to take advantage of them in Apollo.\n\nFirst thing you should know is most of the methods of Apollo service accepts generic types.\n\n#### What are Generic Types\n\nA major part of software engineering is building components that not only have well-defined and consistent APIs, but are also reusable. Components that are capable of working on the data of today as well as the data of tomorrow will give you the most flexible capabilities for building up large software systems.\n\nWe like to work on an code samples so let's do some functional programming and create the `map` method that accepts a transform function and return a new result.\n\nWithout generics, we would have to use a specific type or `any`:\n\n```typescript\nfunction map(mapFn: (value: any) => any) {\n  return function(source: any): any {\n    return mapFn(source);\n  };\n}\n```\n\nImagine, we want to use `map` function to pick user's id from an object:\n\n```typescript\ninterface User {\n  id: number;\n}\nconst me = {\n  id: 1,\n};\n\nconst pickUserId = map(user => user.id);\n\nconsole.log(pickUserId(me)); // outputs: 1\n```\n\nGreat, it works, we get the expected result but it could be done way better.\n\nWhat is the main issue here?\nIt accepts an object of any type and get `any` in return. It's not very useful because we know it return a `number` and receive a `User` but TypeScript doesn't know that and later on, in other part of the code, we end up with no information about the result.\n\nThat's where Generic Types jumps in!\n\nWith generics, it could look like this:\n\n```typescript\nfunction map<T, R>(mapFn: (value: T) => R) {\n  return function(source: T): R {\n    return mapFn(source);\n  };\n}\n```\n\nThere's... a lot! So let's break it:\n\n- `map<T, R>` - the map function accepts two generic types\n- `(mapFn: (value: T) => R)` - the only argument is a function that accepts an object of type `T` and returns value of type `R`\n- `function (source: T): R => {...}` - it's a higher order function that accepts a source of type `T` and transforms to be `R`.\n\nBack to our example, now with generic types:\n\n```typescript\ninterface User {\n  id: number;\n}\nconst me = {\n  id: 1,\n};\n\nconst pickUserId = map<User, number>(user => user.id);\n\nconsole.log(pickUserId(me)); // outputs: 1\n```\n\nOur `map` and `pickUserId` function are strongly typed now so when you try to provide an object that has no `id` field or the field is a `string` you'll receive a proper information from TypeScript (and your IDE).\n\n#### Make client-side code strongly typed\n\nWith all that knowledge let's use how to use those generated typed with `Apollo` service:\n\n[{]: <helper> (diffStep \"2.3\" module=\"client\")\n\n#### [Step 2.3: Use the generated types](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/afdf40c)\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chat-item&#x2F;chat-item.component.ts\n```diff\n@@ -1,4 +1,5 @@\n ┊1┊1┊import {Component, Input} from '@angular/core';\n+┊ ┊2┊import {GetChats} from '../../../../graphql';\n ┊2┊3┊\n ┊3┊4┊@Component({\n ┊4┊5┊  selector: 'app-chat-item',\n```\n```diff\n@@ -17,5 +18,5 @@\n ┊17┊18┊export class ChatItemComponent {\n ┊18┊19┊  // tslint:disable-next-line:no-input-rename\n ┊19┊20┊  @Input('item')\n-┊20┊  ┊  chat: any;\n+┊  ┊21┊  chat: GetChats.Chats;\n ┊21┊22┊}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chats-list&#x2F;chats-list.component.ts\n```diff\n@@ -1,4 +1,5 @@\n ┊1┊1┊import {Component, Input} from '@angular/core';\n+┊ ┊2┊import {GetChats} from '../../../../graphql';\n ┊2┊3┊\n ┊3┊4┊@Component({\n ┊4┊5┊  selector: 'app-chats-list',\n```\n```diff\n@@ -14,7 +15,7 @@\n ┊14┊15┊export class ChatsListComponent {\n ┊15┊16┊  // tslint:disable-next-line:no-input-rename\n ┊16┊17┊  @Input('items')\n-┊17┊  ┊  chats: any[];\n+┊  ┊18┊  chats: GetChats.Chats[];\n ┊18┊19┊\n ┊19┊20┊  constructor() {}\n ┊20┊21┊}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.ts\n```diff\n@@ -1,6 +1,7 @@\n ┊1┊1┊import {Component, OnInit} from '@angular/core';\n ┊2┊2┊import {ChatsService} from '../../../services/chats.service';\n ┊3┊3┊import {Observable} from 'rxjs';\n+┊ ┊4┊import {GetChats} from '../../../../graphql';\n ┊4┊5┊\n ┊5┊6┊@Component({\n ┊6┊7┊  template: `\n```\n```diff\n@@ -35,7 +36,7 @@\n ┊35┊36┊  styleUrls: ['./chats.component.scss'],\n ┊36┊37┊})\n ┊37┊38┊export class ChatsComponent implements OnInit {\n-┊38┊  ┊  chats$: Observable<any[]>;\n+┊  ┊39┊  chats$: Observable<GetChats.Chats[]>;\n ┊39┊40┊\n ┊40┊41┊  constructor(private chatsService: ChatsService) {\n ┊41┊42┊  }\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -2,6 +2,7 @@\n ┊2┊2┊import {Apollo} from 'apollo-angular';\n ┊3┊3┊import {Injectable} from '@angular/core';\n ┊4┊4┊import {getChatsQuery} from '../../graphql/getChats.query';\n+┊ ┊5┊import {GetChats} from '../../graphql';\n ┊5┊6┊\n ┊6┊7┊@Injectable()\n ┊7┊8┊export class ChatsService {\n```\n```diff\n@@ -10,7 +11,7 @@\n ┊10┊11┊  constructor(private apollo: Apollo) {}\n ┊11┊12┊\n ┊12┊13┊  getChats() {\n-┊13┊  ┊    const query = this.apollo.watchQuery<any>({\n+┊  ┊14┊    const query = this.apollo.watchQuery<GetChats.Query>({\n ┊14┊15┊      query: getChatsQuery,\n ┊15┊16┊      variables: {\n ┊16┊17┊        amount: this.messagesAmount,\n```\n\n[}]: #\n\nAs you can probably tell by now, methods like `watchQuery` and `mutate` (and others) accepts two generic types, first one describes the result and the second one the variables.\n\n```typescript\nexport class ChatService {\n  constructor(private apollo: Apollo) {}\n\n  getChat(chatId: string, amount: number): GetChat.Chat {\n    return this.apollo\n      .watchQuery<GetChat.Query, GetChat.Variables>({\n        query: getChatQuery,\n        variables: {\n          chatId,\n          amount,\n        },\n      })\n      .pipe(map(result => result.data.chat));\n  }\n}\n```\n\nFew things here.\n\n- An object of `GetChat.Query` shape lives under the `result.data` because `watchQuery` returns an object of type `ApolloQueryResult<T>` where `T` is our `GetChat.Query`.\n\n```typescript\nexport type ApolloQueryResult<T> = {\n  data: T;\n  // ... other fields\n};\n```\n\nYou get the same result with Mutation or Subscription.\n\n- Thanks to the second argument and `GetChat.Variables` we as well as TypeScript (and an IDE) know that `chatId` is a string and `amount` accepts only a number. Whenever we try to pass a value of different kind an Error will pop out.\n\n### Take full advantage of Codegen and generate ready to use Services!\n\nI've got a fantasctic news, you don't have to manually provide those generated types to each type Apollo service is used. Because GraphQL Documents are statically analyzable, we prepared a codegen template specific for Apollo Angular users.\n\nFirst, let's install `graphql-codegen-apollo-angular` with the Apollo Angular templatea and update the template param of `generator` script\n\n    yarn add graphql-code-generator graphql-codegen-typescript-template\n\n[{]: <helper> (diffStep \"2.4\" file=\"package.json\" module=\"client\")\n\n#### [Step 2.4: Use auto-generated GQL services](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/c0eddd1)\n\n##### Changed package.json\n```diff\n@@ -8,7 +8,7 @@\n ┊ 8┊ 8┊    \"test\": \"ng test\",\n ┊ 9┊ 9┊    \"lint\": \"ng lint\",\n ┊10┊10┊    \"e2e\": \"ng e2e\",\n-┊11┊  ┊    \"generator\": \"gql-gen --schema http://localhost:3000/graphql --template graphql-codegen-typescript-template --out ./src/graphql.ts ./src/graphql/**/*.ts\"\n+┊  ┊11┊    \"generator\": \"gql-gen --schema http://localhost:3000/graphql --template graphql-codegen-apollo-angular-template --out ./src/graphql.ts ./src/graphql/**/*.ts\"\n ┊12┊12┊  },\n ┊13┊13┊  \"private\": true,\n ┊14┊14┊  \"dependencies\": {\n```\n```diff\n@@ -48,6 +48,7 @@\n ┊48┊48┊    \"codelyzer\": \"4.2.1\",\n ┊49┊49┊    \"graphql-code-generator\": \"0.12.6\",\n ┊50┊50┊    \"graphql-codegen-typescript-template\": \"0.12.6\",\n+┊  ┊51┊    \"graphql-codegen-apollo-angular-template\": \"0.12.6\",\n ┊51┊52┊    \"jasmine-core\": \"2.99.1\",\n ┊52┊53┊    \"jasmine-spec-reporter\": \"4.2.1\",\n ┊53┊54┊    \"karma\": \"1.7.1\",\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,21 +1,18 @@\n ┊ 1┊ 1┊import {map} from 'rxjs/operators';\n-┊ 2┊  ┊import {Apollo} from 'apollo-angular';\n ┊ 3┊ 2┊import {Injectable} from '@angular/core';\n-┊ 4┊  ┊import {getChatsQuery} from '../../graphql/getChats.query';\n-┊ 5┊  ┊import {GetChats} from '../../graphql';\n+┊  ┊ 3┊import {GetChatsGQL} from '../../graphql';\n ┊ 6┊ 4┊\n ┊ 7┊ 5┊@Injectable()\n ┊ 8┊ 6┊export class ChatsService {\n ┊ 9┊ 7┊  messagesAmount = 3;\n ┊10┊ 8┊\n-┊11┊  ┊  constructor(private apollo: Apollo) {}\n+┊  ┊ 9┊  constructor(\n+┊  ┊10┊    private getChatsGQL: GetChatsGQL\n+┊  ┊11┊  ) {}\n ┊12┊12┊\n ┊13┊13┊  getChats() {\n-┊14┊  ┊    const query = this.apollo.watchQuery<GetChats.Query>({\n-┊15┊  ┊      query: getChatsQuery,\n-┊16┊  ┊      variables: {\n-┊17┊  ┊        amount: this.messagesAmount,\n-┊18┊  ┊      },\n+┊  ┊14┊    const query = this.getChatsGQL.watch({\n+┊  ┊15┊      amount: this.messagesAmount,\n ┊19┊16┊    });\n ┊20┊17┊    const chats$ = query.valueChanges.pipe(\n ┊21┊18┊      map((result) => result.data.chats)\n```\n\n##### Changed src&#x2F;graphql.ts\n```diff\n@@ -28,6 +28,8 @@\n ┊28┊28┊  ): R | Result | Promise<R | Result>;\n ┊29┊29┊};\n ┊30┊30┊\n+┊  ┊31┊export type Date = any;\n+┊  ┊32┊\n ┊31┊33┊export interface Query {\n ┊32┊34┊  users?: User[] | null;\n ┊33┊35┊  chats?: Chat[] | null;\n```\n```diff\n@@ -42,17 +44,18 @@\n ┊42┊44┊}\n ┊43┊45┊\n ┊44┊46┊export interface Chat {\n-┊45┊  ┊  id: string /** May be a chat or a group */;\n-┊46┊  ┊  name?: string | null /** Computed for chats */;\n-┊47┊  ┊  picture?: string | null /** Computed for chats */;\n-┊48┊  ┊  allTimeMembers: User[] /** All members, current and past ones. */;\n-┊49┊  ┊  listingMembers: User[] /** Whoever gets the chat listed. For groups includes past members who still didn't delete the group. */;\n-┊50┊  ┊  actualGroupMembers: User[] /** Actual members of the group (they are not the only ones who get the group listed). Null for chats. */;\n-┊51┊  ┊  admins?: User[] | null /** Null for chats */;\n-┊52┊  ┊  owner?: User | null /** If null the group is read-only. Null for chats. */;\n+┊  ┊47┊  id: string;\n+┊  ┊48┊  name?: string | null;\n+┊  ┊49┊  picture?: string | null;\n+┊  ┊50┊  allTimeMembers: User[];\n+┊  ┊51┊  listingMembers: User[];\n+┊  ┊52┊  actualGroupMembers: User[];\n+┊  ┊53┊  admins?: User[] | null;\n+┊  ┊54┊  owner?: User | null;\n ┊53┊55┊  messages: (Message | null)[];\n-┊54┊  ┊  unreadMessages: number /** Computed property */;\n-┊55┊  ┊  isGroup: boolean /** Computed property */;\n+┊  ┊56┊  messageFeed?: MessageFeed | null;\n+┊  ┊57┊  unreadMessages: number;\n+┊  ┊58┊  isGroup: boolean;\n ┊56┊59┊}\n ┊57┊60┊\n ┊58┊61┊export interface Message {\n```\n```diff\n@@ -60,25 +63,107 @@\n ┊ 60┊ 63┊  sender: User;\n ┊ 61┊ 64┊  chat: Chat;\n ┊ 62┊ 65┊  content: string;\n-┊ 63┊   ┊  createdAt: string;\n-┊ 64┊   ┊  type: number /** FIXME: should return MessageType */;\n-┊ 65┊   ┊  recipients: Recipient[] /** Whoever received the message */;\n-┊ 66┊   ┊  holders: User[] /** Whoever still holds a copy of the message. Cannot be null because the message gets deleted otherwise */;\n-┊ 67┊   ┊  ownership: boolean /** Computed property */;\n+┊   ┊ 66┊  createdAt: Date;\n+┊   ┊ 67┊  type: number;\n+┊   ┊ 68┊  recipients: Recipient[];\n+┊   ┊ 69┊  holders: User[];\n+┊   ┊ 70┊  ownership: boolean;\n ┊ 68┊ 71┊}\n ┊ 69┊ 72┊\n ┊ 70┊ 73┊export interface Recipient {\n ┊ 71┊ 74┊  user: User;\n ┊ 72┊ 75┊  message: Message;\n ┊ 73┊ 76┊  chat: Chat;\n-┊ 74┊   ┊  receivedAt?: string | null;\n-┊ 75┊   ┊  readAt?: string | null;\n+┊   ┊ 77┊  receivedAt?: Date | null;\n+┊   ┊ 78┊  readAt?: Date | null;\n+┊   ┊ 79┊}\n+┊   ┊ 80┊\n+┊   ┊ 81┊export interface MessageFeed {\n+┊   ┊ 82┊  hasNextPage: boolean;\n+┊   ┊ 83┊  cursor?: string | null;\n+┊   ┊ 84┊  messages: (Message | null)[];\n+┊   ┊ 85┊}\n+┊   ┊ 86┊\n+┊   ┊ 87┊export interface Mutation {\n+┊   ┊ 88┊  addChat?: Chat | null;\n+┊   ┊ 89┊  addGroup?: Chat | null;\n+┊   ┊ 90┊  removeChat?: string | null;\n+┊   ┊ 91┊  addMessage?: Message | null;\n+┊   ┊ 92┊  removeMessages?: (string | null)[] | null;\n+┊   ┊ 93┊  addMembers?: (string | null)[] | null;\n+┊   ┊ 94┊  removeMembers?: (string | null)[] | null;\n+┊   ┊ 95┊  addAdmins?: (string | null)[] | null;\n+┊   ┊ 96┊  removeAdmins?: (string | null)[] | null;\n+┊   ┊ 97┊  setGroupName?: string | null;\n+┊   ┊ 98┊  setGroupPicture?: string | null;\n+┊   ┊ 99┊  markAsReceived?: boolean | null;\n+┊   ┊100┊  markAsRead?: boolean | null;\n+┊   ┊101┊}\n+┊   ┊102┊\n+┊   ┊103┊export interface Subscription {\n+┊   ┊104┊  messageAdded?: Message | null;\n+┊   ┊105┊  chatAdded?: Chat | null;\n ┊ 76┊106┊}\n ┊ 77┊107┊export interface ChatQueryArgs {\n ┊ 78┊108┊  chatId: string;\n ┊ 79┊109┊}\n ┊ 80┊110┊export interface MessagesChatArgs {\n ┊ 81┊111┊  amount?: number | null;\n+┊   ┊112┊  before?: string | null;\n+┊   ┊113┊}\n+┊   ┊114┊export interface MessageFeedChatArgs {\n+┊   ┊115┊  amount?: number | null;\n+┊   ┊116┊  before?: string | null;\n+┊   ┊117┊}\n+┊   ┊118┊export interface AddChatMutationArgs {\n+┊   ┊119┊  recipientId: string;\n+┊   ┊120┊}\n+┊   ┊121┊export interface AddGroupMutationArgs {\n+┊   ┊122┊  recipientIds: string[];\n+┊   ┊123┊  groupName: string;\n+┊   ┊124┊}\n+┊   ┊125┊export interface RemoveChatMutationArgs {\n+┊   ┊126┊  chatId: string;\n+┊   ┊127┊}\n+┊   ┊128┊export interface AddMessageMutationArgs {\n+┊   ┊129┊  chatId: string;\n+┊   ┊130┊  content: string;\n+┊   ┊131┊}\n+┊   ┊132┊export interface RemoveMessagesMutationArgs {\n+┊   ┊133┊  chatId: string;\n+┊   ┊134┊  messageIds?: (string | null)[] | null;\n+┊   ┊135┊  all?: boolean | null;\n+┊   ┊136┊}\n+┊   ┊137┊export interface AddMembersMutationArgs {\n+┊   ┊138┊  groupId: string;\n+┊   ┊139┊  userIds: string[];\n+┊   ┊140┊}\n+┊   ┊141┊export interface RemoveMembersMutationArgs {\n+┊   ┊142┊  groupId: string;\n+┊   ┊143┊  userIds: string[];\n+┊   ┊144┊}\n+┊   ┊145┊export interface AddAdminsMutationArgs {\n+┊   ┊146┊  groupId: string;\n+┊   ┊147┊  userIds: string[];\n+┊   ┊148┊}\n+┊   ┊149┊export interface RemoveAdminsMutationArgs {\n+┊   ┊150┊  groupId: string;\n+┊   ┊151┊  userIds: string[];\n+┊   ┊152┊}\n+┊   ┊153┊export interface SetGroupNameMutationArgs {\n+┊   ┊154┊  groupId: string;\n+┊   ┊155┊}\n+┊   ┊156┊export interface SetGroupPictureMutationArgs {\n+┊   ┊157┊  groupId: string;\n+┊   ┊158┊}\n+┊   ┊159┊export interface MarkAsReceivedMutationArgs {\n+┊   ┊160┊  chatId: string;\n+┊   ┊161┊}\n+┊   ┊162┊export interface MarkAsReadMutationArgs {\n+┊   ┊163┊  chatId: string;\n+┊   ┊164┊}\n+┊   ┊165┊export interface MessageAddedSubscriptionArgs {\n+┊   ┊166┊  chatId?: string | null;\n ┊ 82┊167┊}\n ┊ 83┊168┊\n ┊ 84┊169┊export enum MessageType {\n```\n```diff\n@@ -146,41 +231,18 @@\n ┊146┊231┊\n ┊147┊232┊export namespace ChatResolvers {\n ┊148┊233┊  export interface Resolvers<Context = any> {\n-┊149┊   ┊    id?: IdResolver<string, any, Context> /** May be a chat or a group */;\n-┊150┊   ┊    name?: NameResolver<string | null, any, Context> /** Computed for chats */;\n-┊151┊   ┊    picture?: PictureResolver<\n-┊152┊   ┊      string | null,\n-┊153┊   ┊      any,\n-┊154┊   ┊      Context\n-┊155┊   ┊    > /** Computed for chats */;\n-┊156┊   ┊    allTimeMembers?: AllTimeMembersResolver<\n-┊157┊   ┊      User[],\n-┊158┊   ┊      any,\n-┊159┊   ┊      Context\n-┊160┊   ┊    > /** All members, current and past ones. */;\n-┊161┊   ┊    listingMembers?: ListingMembersResolver<\n-┊162┊   ┊      User[],\n-┊163┊   ┊      any,\n-┊164┊   ┊      Context\n-┊165┊   ┊    > /** Whoever gets the chat listed. For groups includes past members who still didn't delete the group. */;\n-┊166┊   ┊    actualGroupMembers?: ActualGroupMembersResolver<\n-┊167┊   ┊      User[],\n-┊168┊   ┊      any,\n-┊169┊   ┊      Context\n-┊170┊   ┊    > /** Actual members of the group (they are not the only ones who get the group listed). Null for chats. */;\n-┊171┊   ┊    admins?: AdminsResolver<User[] | null, any, Context> /** Null for chats */;\n-┊172┊   ┊    owner?: OwnerResolver<\n-┊173┊   ┊      User | null,\n-┊174┊   ┊      any,\n-┊175┊   ┊      Context\n-┊176┊   ┊    > /** If null the group is read-only. Null for chats. */;\n+┊   ┊234┊    id?: IdResolver<string, any, Context>;\n+┊   ┊235┊    name?: NameResolver<string | null, any, Context>;\n+┊   ┊236┊    picture?: PictureResolver<string | null, any, Context>;\n+┊   ┊237┊    allTimeMembers?: AllTimeMembersResolver<User[], any, Context>;\n+┊   ┊238┊    listingMembers?: ListingMembersResolver<User[], any, Context>;\n+┊   ┊239┊    actualGroupMembers?: ActualGroupMembersResolver<User[], any, Context>;\n+┊   ┊240┊    admins?: AdminsResolver<User[] | null, any, Context>;\n+┊   ┊241┊    owner?: OwnerResolver<User | null, any, Context>;\n ┊177┊242┊    messages?: MessagesResolver<(Message | null)[], any, Context>;\n-┊178┊   ┊    unreadMessages?: UnreadMessagesResolver<\n-┊179┊   ┊      number,\n-┊180┊   ┊      any,\n-┊181┊   ┊      Context\n-┊182┊   ┊    > /** Computed property */;\n-┊183┊   ┊    isGroup?: IsGroupResolver<boolean, any, Context> /** Computed property */;\n+┊   ┊243┊    messageFeed?: MessageFeedResolver<MessageFeed | null, any, Context>;\n+┊   ┊244┊    unreadMessages?: UnreadMessagesResolver<number, any, Context>;\n+┊   ┊245┊    isGroup?: IsGroupResolver<boolean, any, Context>;\n ┊184┊246┊  }\n ┊185┊247┊\n ┊186┊248┊  export type IdResolver<R = string, Parent = any, Context = any> = Resolver<\n```\n```diff\n@@ -230,6 +292,17 @@\n ┊230┊292┊  > = Resolver<R, Parent, Context, MessagesArgs>;\n ┊231┊293┊  export interface MessagesArgs {\n ┊232┊294┊    amount?: number | null;\n+┊   ┊295┊    before?: string | null;\n+┊   ┊296┊  }\n+┊   ┊297┊\n+┊   ┊298┊  export type MessageFeedResolver<\n+┊   ┊299┊    R = MessageFeed | null,\n+┊   ┊300┊    Parent = any,\n+┊   ┊301┊    Context = any\n+┊   ┊302┊  > = Resolver<R, Parent, Context, MessageFeedArgs>;\n+┊   ┊303┊  export interface MessageFeedArgs {\n+┊   ┊304┊    amount?: number | null;\n+┊   ┊305┊    before?: string | null;\n ┊233┊306┊  }\n ┊234┊307┊\n ┊235┊308┊  export type UnreadMessagesResolver<\n```\n```diff\n@@ -250,27 +323,11 @@\n ┊250┊323┊    sender?: SenderResolver<User, any, Context>;\n ┊251┊324┊    chat?: ChatResolver<Chat, any, Context>;\n ┊252┊325┊    content?: ContentResolver<string, any, Context>;\n-┊253┊   ┊    createdAt?: CreatedAtResolver<string, any, Context>;\n-┊254┊   ┊    type?: TypeResolver<\n-┊255┊   ┊      number,\n-┊256┊   ┊      any,\n-┊257┊   ┊      Context\n-┊258┊   ┊    > /** FIXME: should return MessageType */;\n-┊259┊   ┊    recipients?: RecipientsResolver<\n-┊260┊   ┊      Recipient[],\n-┊261┊   ┊      any,\n-┊262┊   ┊      Context\n-┊263┊   ┊    > /** Whoever received the message */;\n-┊264┊   ┊    holders?: HoldersResolver<\n-┊265┊   ┊      User[],\n-┊266┊   ┊      any,\n-┊267┊   ┊      Context\n-┊268┊   ┊    > /** Whoever still holds a copy of the message. Cannot be null because the message gets deleted otherwise */;\n-┊269┊   ┊    ownership?: OwnershipResolver<\n-┊270┊   ┊      boolean,\n-┊271┊   ┊      any,\n-┊272┊   ┊      Context\n-┊273┊   ┊    > /** Computed property */;\n+┊   ┊326┊    createdAt?: CreatedAtResolver<Date, any, Context>;\n+┊   ┊327┊    type?: TypeResolver<number, any, Context>;\n+┊   ┊328┊    recipients?: RecipientsResolver<Recipient[], any, Context>;\n+┊   ┊329┊    holders?: HoldersResolver<User[], any, Context>;\n+┊   ┊330┊    ownership?: OwnershipResolver<boolean, any, Context>;\n ┊274┊331┊  }\n ┊275┊332┊\n ┊276┊333┊  export type IdResolver<R = string, Parent = any, Context = any> = Resolver<\n```\n```diff\n@@ -294,7 +351,7 @@\n ┊294┊351┊    Context = any\n ┊295┊352┊  > = Resolver<R, Parent, Context>;\n ┊296┊353┊  export type CreatedAtResolver<\n-┊297┊   ┊    R = string,\n+┊   ┊354┊    R = Date,\n ┊298┊355┊    Parent = any,\n ┊299┊356┊    Context = any\n ┊300┊357┊  > = Resolver<R, Parent, Context>;\n```\n```diff\n@@ -325,8 +382,8 @@\n ┊325┊382┊    user?: UserResolver<User, any, Context>;\n ┊326┊383┊    message?: MessageResolver<Message, any, Context>;\n ┊327┊384┊    chat?: ChatResolver<Chat, any, Context>;\n-┊328┊   ┊    receivedAt?: ReceivedAtResolver<string | null, any, Context>;\n-┊329┊   ┊    readAt?: ReadAtResolver<string | null, any, Context>;\n+┊   ┊385┊    receivedAt?: ReceivedAtResolver<Date | null, any, Context>;\n+┊   ┊386┊    readAt?: ReadAtResolver<Date | null, any, Context>;\n ┊330┊387┊  }\n ┊331┊388┊\n ┊332┊389┊  export type UserResolver<R = User, Parent = any, Context = any> = Resolver<\n```\n```diff\n@@ -345,14 +402,211 @@\n ┊345┊402┊    Context\n ┊346┊403┊  >;\n ┊347┊404┊  export type ReceivedAtResolver<\n-┊348┊   ┊    R = string | null,\n+┊   ┊405┊    R = Date | null,\n ┊349┊406┊    Parent = any,\n ┊350┊407┊    Context = any\n ┊351┊408┊  > = Resolver<R, Parent, Context>;\n ┊352┊409┊  export type ReadAtResolver<\n+┊   ┊410┊    R = Date | null,\n+┊   ┊411┊    Parent = any,\n+┊   ┊412┊    Context = any\n+┊   ┊413┊  > = Resolver<R, Parent, Context>;\n+┊   ┊414┊}\n+┊   ┊415┊\n+┊   ┊416┊export namespace MessageFeedResolvers {\n+┊   ┊417┊  export interface Resolvers<Context = any> {\n+┊   ┊418┊    hasNextPage?: HasNextPageResolver<boolean, any, Context>;\n+┊   ┊419┊    cursor?: CursorResolver<string | null, any, Context>;\n+┊   ┊420┊    messages?: MessagesResolver<(Message | null)[], any, Context>;\n+┊   ┊421┊  }\n+┊   ┊422┊\n+┊   ┊423┊  export type HasNextPageResolver<\n+┊   ┊424┊    R = boolean,\n+┊   ┊425┊    Parent = any,\n+┊   ┊426┊    Context = any\n+┊   ┊427┊  > = Resolver<R, Parent, Context>;\n+┊   ┊428┊  export type CursorResolver<\n+┊   ┊429┊    R = string | null,\n+┊   ┊430┊    Parent = any,\n+┊   ┊431┊    Context = any\n+┊   ┊432┊  > = Resolver<R, Parent, Context>;\n+┊   ┊433┊  export type MessagesResolver<\n+┊   ┊434┊    R = (Message | null)[],\n+┊   ┊435┊    Parent = any,\n+┊   ┊436┊    Context = any\n+┊   ┊437┊  > = Resolver<R, Parent, Context>;\n+┊   ┊438┊}\n+┊   ┊439┊\n+┊   ┊440┊export namespace MutationResolvers {\n+┊   ┊441┊  export interface Resolvers<Context = any> {\n+┊   ┊442┊    addChat?: AddChatResolver<Chat | null, any, Context>;\n+┊   ┊443┊    addGroup?: AddGroupResolver<Chat | null, any, Context>;\n+┊   ┊444┊    removeChat?: RemoveChatResolver<string | null, any, Context>;\n+┊   ┊445┊    addMessage?: AddMessageResolver<Message | null, any, Context>;\n+┊   ┊446┊    removeMessages?: RemoveMessagesResolver<\n+┊   ┊447┊      (string | null)[] | null,\n+┊   ┊448┊      any,\n+┊   ┊449┊      Context\n+┊   ┊450┊    >;\n+┊   ┊451┊    addMembers?: AddMembersResolver<(string | null)[] | null, any, Context>;\n+┊   ┊452┊    removeMembers?: RemoveMembersResolver<\n+┊   ┊453┊      (string | null)[] | null,\n+┊   ┊454┊      any,\n+┊   ┊455┊      Context\n+┊   ┊456┊    >;\n+┊   ┊457┊    addAdmins?: AddAdminsResolver<(string | null)[] | null, any, Context>;\n+┊   ┊458┊    removeAdmins?: RemoveAdminsResolver<(string | null)[] | null, any, Context>;\n+┊   ┊459┊    setGroupName?: SetGroupNameResolver<string | null, any, Context>;\n+┊   ┊460┊    setGroupPicture?: SetGroupPictureResolver<string | null, any, Context>;\n+┊   ┊461┊    markAsReceived?: MarkAsReceivedResolver<boolean | null, any, Context>;\n+┊   ┊462┊    markAsRead?: MarkAsReadResolver<boolean | null, any, Context>;\n+┊   ┊463┊  }\n+┊   ┊464┊\n+┊   ┊465┊  export type AddChatResolver<\n+┊   ┊466┊    R = Chat | null,\n+┊   ┊467┊    Parent = any,\n+┊   ┊468┊    Context = any\n+┊   ┊469┊  > = Resolver<R, Parent, Context, AddChatArgs>;\n+┊   ┊470┊  export interface AddChatArgs {\n+┊   ┊471┊    recipientId: string;\n+┊   ┊472┊  }\n+┊   ┊473┊\n+┊   ┊474┊  export type AddGroupResolver<\n+┊   ┊475┊    R = Chat | null,\n+┊   ┊476┊    Parent = any,\n+┊   ┊477┊    Context = any\n+┊   ┊478┊  > = Resolver<R, Parent, Context, AddGroupArgs>;\n+┊   ┊479┊  export interface AddGroupArgs {\n+┊   ┊480┊    recipientIds: string[];\n+┊   ┊481┊    groupName: string;\n+┊   ┊482┊  }\n+┊   ┊483┊\n+┊   ┊484┊  export type RemoveChatResolver<\n+┊   ┊485┊    R = string | null,\n+┊   ┊486┊    Parent = any,\n+┊   ┊487┊    Context = any\n+┊   ┊488┊  > = Resolver<R, Parent, Context, RemoveChatArgs>;\n+┊   ┊489┊  export interface RemoveChatArgs {\n+┊   ┊490┊    chatId: string;\n+┊   ┊491┊  }\n+┊   ┊492┊\n+┊   ┊493┊  export type AddMessageResolver<\n+┊   ┊494┊    R = Message | null,\n+┊   ┊495┊    Parent = any,\n+┊   ┊496┊    Context = any\n+┊   ┊497┊  > = Resolver<R, Parent, Context, AddMessageArgs>;\n+┊   ┊498┊  export interface AddMessageArgs {\n+┊   ┊499┊    chatId: string;\n+┊   ┊500┊    content: string;\n+┊   ┊501┊  }\n+┊   ┊502┊\n+┊   ┊503┊  export type RemoveMessagesResolver<\n+┊   ┊504┊    R = (string | null)[] | null,\n+┊   ┊505┊    Parent = any,\n+┊   ┊506┊    Context = any\n+┊   ┊507┊  > = Resolver<R, Parent, Context, RemoveMessagesArgs>;\n+┊   ┊508┊  export interface RemoveMessagesArgs {\n+┊   ┊509┊    chatId: string;\n+┊   ┊510┊    messageIds?: (string | null)[] | null;\n+┊   ┊511┊    all?: boolean | null;\n+┊   ┊512┊  }\n+┊   ┊513┊\n+┊   ┊514┊  export type AddMembersResolver<\n+┊   ┊515┊    R = (string | null)[] | null,\n+┊   ┊516┊    Parent = any,\n+┊   ┊517┊    Context = any\n+┊   ┊518┊  > = Resolver<R, Parent, Context, AddMembersArgs>;\n+┊   ┊519┊  export interface AddMembersArgs {\n+┊   ┊520┊    groupId: string;\n+┊   ┊521┊    userIds: string[];\n+┊   ┊522┊  }\n+┊   ┊523┊\n+┊   ┊524┊  export type RemoveMembersResolver<\n+┊   ┊525┊    R = (string | null)[] | null,\n+┊   ┊526┊    Parent = any,\n+┊   ┊527┊    Context = any\n+┊   ┊528┊  > = Resolver<R, Parent, Context, RemoveMembersArgs>;\n+┊   ┊529┊  export interface RemoveMembersArgs {\n+┊   ┊530┊    groupId: string;\n+┊   ┊531┊    userIds: string[];\n+┊   ┊532┊  }\n+┊   ┊533┊\n+┊   ┊534┊  export type AddAdminsResolver<\n+┊   ┊535┊    R = (string | null)[] | null,\n+┊   ┊536┊    Parent = any,\n+┊   ┊537┊    Context = any\n+┊   ┊538┊  > = Resolver<R, Parent, Context, AddAdminsArgs>;\n+┊   ┊539┊  export interface AddAdminsArgs {\n+┊   ┊540┊    groupId: string;\n+┊   ┊541┊    userIds: string[];\n+┊   ┊542┊  }\n+┊   ┊543┊\n+┊   ┊544┊  export type RemoveAdminsResolver<\n+┊   ┊545┊    R = (string | null)[] | null,\n+┊   ┊546┊    Parent = any,\n+┊   ┊547┊    Context = any\n+┊   ┊548┊  > = Resolver<R, Parent, Context, RemoveAdminsArgs>;\n+┊   ┊549┊  export interface RemoveAdminsArgs {\n+┊   ┊550┊    groupId: string;\n+┊   ┊551┊    userIds: string[];\n+┊   ┊552┊  }\n+┊   ┊553┊\n+┊   ┊554┊  export type SetGroupNameResolver<\n+┊   ┊555┊    R = string | null,\n+┊   ┊556┊    Parent = any,\n+┊   ┊557┊    Context = any\n+┊   ┊558┊  > = Resolver<R, Parent, Context, SetGroupNameArgs>;\n+┊   ┊559┊  export interface SetGroupNameArgs {\n+┊   ┊560┊    groupId: string;\n+┊   ┊561┊  }\n+┊   ┊562┊\n+┊   ┊563┊  export type SetGroupPictureResolver<\n ┊353┊564┊    R = string | null,\n ┊354┊565┊    Parent = any,\n ┊355┊566┊    Context = any\n+┊   ┊567┊  > = Resolver<R, Parent, Context, SetGroupPictureArgs>;\n+┊   ┊568┊  export interface SetGroupPictureArgs {\n+┊   ┊569┊    groupId: string;\n+┊   ┊570┊  }\n+┊   ┊571┊\n+┊   ┊572┊  export type MarkAsReceivedResolver<\n+┊   ┊573┊    R = boolean | null,\n+┊   ┊574┊    Parent = any,\n+┊   ┊575┊    Context = any\n+┊   ┊576┊  > = Resolver<R, Parent, Context, MarkAsReceivedArgs>;\n+┊   ┊577┊  export interface MarkAsReceivedArgs {\n+┊   ┊578┊    chatId: string;\n+┊   ┊579┊  }\n+┊   ┊580┊\n+┊   ┊581┊  export type MarkAsReadResolver<\n+┊   ┊582┊    R = boolean | null,\n+┊   ┊583┊    Parent = any,\n+┊   ┊584┊    Context = any\n+┊   ┊585┊  > = Resolver<R, Parent, Context, MarkAsReadArgs>;\n+┊   ┊586┊  export interface MarkAsReadArgs {\n+┊   ┊587┊    chatId: string;\n+┊   ┊588┊  }\n+┊   ┊589┊}\n+┊   ┊590┊\n+┊   ┊591┊export namespace SubscriptionResolvers {\n+┊   ┊592┊  export interface Resolvers<Context = any> {\n+┊   ┊593┊    messageAdded?: MessageAddedResolver<Message | null, any, Context>;\n+┊   ┊594┊    chatAdded?: ChatAddedResolver<Chat | null, any, Context>;\n+┊   ┊595┊  }\n+┊   ┊596┊\n+┊   ┊597┊  export type MessageAddedResolver<\n+┊   ┊598┊    R = Message | null,\n+┊   ┊599┊    Parent = any,\n+┊   ┊600┊    Context = any\n+┊   ┊601┊  > = Resolver<R, Parent, Context, MessageAddedArgs>;\n+┊   ┊602┊  export interface MessageAddedArgs {\n+┊   ┊603┊    chatId?: string | null;\n+┊   ┊604┊  }\n+┊   ┊605┊\n+┊   ┊606┊  export type ChatAddedResolver<\n+┊   ┊607┊    R = Chat | null,\n+┊   ┊608┊    Parent = any,\n+┊   ┊609┊    Context = any\n ┊356┊610┊  > = Resolver<R, Parent, Context>;\n ┊357┊611┊}\n ┊358┊612┊\n```\n```diff\n@@ -398,7 +652,7 @@\n ┊398┊652┊    chat: Chat;\n ┊399┊653┊    sender: Sender;\n ┊400┊654┊    content: string;\n-┊401┊   ┊    createdAt: string;\n+┊   ┊655┊    createdAt: Date;\n ┊402┊656┊    type: number;\n ┊403┊657┊    recipients: Recipients[];\n ┊404┊658┊    ownership: boolean;\n```\n```diff\n@@ -420,8 +674,8 @@\n ┊420┊674┊    user: User;\n ┊421┊675┊    message: Message;\n ┊422┊676┊    chat: __Chat;\n-┊423┊   ┊    receivedAt?: string | null;\n-┊424┊   ┊    readAt?: string | null;\n+┊   ┊677┊    receivedAt?: Date | null;\n+┊   ┊678┊    readAt?: Date | null;\n ┊425┊679┊  };\n ┊426┊680┊\n ┊427┊681┊  export type User = {\n```\n```diff\n@@ -445,3 +699,77 @@\n ┊445┊699┊    id: string;\n ┊446┊700┊  };\n ┊447┊701┊}\n+┊   ┊702┊\n+┊   ┊703┊import { Injectable } from \"@angular/core\";\n+┊   ┊704┊\n+┊   ┊705┊import * as Apollo from \"apollo-angular\";\n+┊   ┊706┊\n+┊   ┊707┊import gql from \"graphql-tag\";\n+┊   ┊708┊\n+┊   ┊709┊const ChatWithoutMessagesFragment = gql`\n+┊   ┊710┊  fragment ChatWithoutMessages on Chat {\n+┊   ┊711┊    id\n+┊   ┊712┊    name\n+┊   ┊713┊    picture\n+┊   ┊714┊    allTimeMembers {\n+┊   ┊715┊      id\n+┊   ┊716┊    }\n+┊   ┊717┊    unreadMessages\n+┊   ┊718┊    isGroup\n+┊   ┊719┊  }\n+┊   ┊720┊`;\n+┊   ┊721┊\n+┊   ┊722┊const MessageFragment = gql`\n+┊   ┊723┊  fragment Message on Message {\n+┊   ┊724┊    id\n+┊   ┊725┊    chat {\n+┊   ┊726┊      id\n+┊   ┊727┊    }\n+┊   ┊728┊    sender {\n+┊   ┊729┊      id\n+┊   ┊730┊      name\n+┊   ┊731┊    }\n+┊   ┊732┊    content\n+┊   ┊733┊    createdAt\n+┊   ┊734┊    type\n+┊   ┊735┊    recipients {\n+┊   ┊736┊      user {\n+┊   ┊737┊        id\n+┊   ┊738┊      }\n+┊   ┊739┊      message {\n+┊   ┊740┊        id\n+┊   ┊741┊        chat {\n+┊   ┊742┊          id\n+┊   ┊743┊        }\n+┊   ┊744┊      }\n+┊   ┊745┊      chat {\n+┊   ┊746┊        id\n+┊   ┊747┊      }\n+┊   ┊748┊      receivedAt\n+┊   ┊749┊      readAt\n+┊   ┊750┊    }\n+┊   ┊751┊    ownership\n+┊   ┊752┊  }\n+┊   ┊753┊`;\n+┊   ┊754┊\n+┊   ┊755┊@Injectable({\n+┊   ┊756┊  providedIn: \"root\"\n+┊   ┊757┊})\n+┊   ┊758┊export class GetChatsGQL extends Apollo.Query<\n+┊   ┊759┊  GetChats.Query,\n+┊   ┊760┊  GetChats.Variables\n+┊   ┊761┊> {\n+┊   ┊762┊  document: any = gql`\n+┊   ┊763┊    query GetChats($amount: Int) {\n+┊   ┊764┊      chats {\n+┊   ┊765┊        ...ChatWithoutMessages\n+┊   ┊766┊        messages(amount: $amount) {\n+┊   ┊767┊          ...Message\n+┊   ┊768┊        }\n+┊   ┊769┊      }\n+┊   ┊770┊    }\n+┊   ┊771┊\n+┊   ┊772┊    ${ChatWithoutMessagesFragment}\n+┊   ┊773┊    ${MessageFragment}\n+┊   ┊774┊  `;\n+┊   ┊775┊}\n```\n\n[}]: #\n\nThe Apollo Angular template generates a ready to use in your component, strongly typed Angular services, for every defined query, mutation or subscription.\n\nIt's possible thanks to the new API of Apollo Angular. More on that in [\"Query, Mutation, Subscription services\"](http://apollographql.com/docs/angular/basics/services.html?_ga=2.227615197.1327014552.1538988114-793224955.1532981447) chapter of the documentation.\n\nGiven an example:\n\n```graphql\nquery GetChats($amount: Int) {\n  chats {\n    ...ChatWithoutMessages\n    messages(amount: $amount) {\n      ...Message\n    }\n  }\n}\n```\n\nThe Apollo Angular template, after you run `yarn generate`, outputs a service called `GetChatsGQL`:\n\n```typescript\nimport { GetChatsGQL, GetChats } from '../graphql';\n\nexport class AppComponent {\n  constructor(private getChatsGQL: GetChatsGQL) {}\n\n  getChats(): GetChats.Chats[] {\n    return this.getChatsGQL\n      .watch({\n        amount: 10,\n      })\n      .valueChanges.pipe(map(result => result.data.chats));\n  }\n}\n```\n\n> Remember, every operation should has an unique name.\n\nIt might look a bit different then what you have already learnt but we promise, the API is even easier.\n\nBut first, let's dive into how those services look like under the hood.\n\n```typescript\nimport { Query } from 'apollo-angular';\n\n@Injectable({\n  providedIn: 'root',\n})\nexport class GetChatsGQL extends Query<GetChats.Query, GetChats.Variables> {\n  document = gql`\n    here goes the document\n  `;\n}\n```\n\nOkay, seems easy but what is the `Query` class, you might ask!\n\nApollo Angular exposes three classes for three kinds of the GraphQL operation: `Query`, `Mutation` and `Subscription`. Each of them has a different API.\n\n- `Query` has `fetch` and `watch`. First one behave like `Apollo.query()`, second one like `Apollo.watchQuery()`\n- `Mutation` has `mutate`\n- `Subscription` has `subscribe`\n\nBecause the `document` is already defined in a class, they all accept two arguments (Subscription has third one). First argument defines variables, second shapes the options. Thats why we used `this.getChatsGQL.watch({ amount: 10 })`.\n\nLet's stop talking about the API itself and see what benefits it brings us:\n\n- **Less code to write** - no need to create a network call, no need to create Typescript typings, no need to create a dedicated Angular service\n- **Strongly typed out of the box — all** types are being generated, no need to write any Typescript definitions and struggle to keep them updated\n- _More pleasent API_ to work with\n- **Full developer experience of tools and IDEs**  —  development time, autocomplete and error checking, not only across your frontend app but also with your API teams!\n- **Tree-shakable** thanks to Angular 6\n\nMost IDEs with the GraphQL support (built-in or thanks to extensions) fully handles `.graphql` files and helps you with features like auto-completion, validation but they strugle with `gql` tag. To fully enjoy GraphQL we highly recommend to use static `.graphql` files.\n\nWith all that knowledge, let's use GQL services in our application:\n\n[{]: <helper> (diffStep \"2.4\" files=\"src/app/services/chats.service.ts\" module=\"client\")\n\n#### [Step 2.4: Use auto-generated GQL services](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/c0eddd1)\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,21 +1,18 @@\n ┊ 1┊ 1┊import {map} from 'rxjs/operators';\n-┊ 2┊  ┊import {Apollo} from 'apollo-angular';\n ┊ 3┊ 2┊import {Injectable} from '@angular/core';\n-┊ 4┊  ┊import {getChatsQuery} from '../../graphql/getChats.query';\n-┊ 5┊  ┊import {GetChats} from '../../graphql';\n+┊  ┊ 3┊import {GetChatsGQL} from '../../graphql';\n ┊ 6┊ 4┊\n ┊ 7┊ 5┊@Injectable()\n ┊ 8┊ 6┊export class ChatsService {\n ┊ 9┊ 7┊  messagesAmount = 3;\n ┊10┊ 8┊\n-┊11┊  ┊  constructor(private apollo: Apollo) {}\n+┊  ┊ 9┊  constructor(\n+┊  ┊10┊    private getChatsGQL: GetChatsGQL\n+┊  ┊11┊  ) {}\n ┊12┊12┊\n ┊13┊13┊  getChats() {\n-┊14┊  ┊    const query = this.apollo.watchQuery<GetChats.Query>({\n-┊15┊  ┊      query: getChatsQuery,\n-┊16┊  ┊      variables: {\n-┊17┊  ┊        amount: this.messagesAmount,\n-┊18┊  ┊      },\n+┊  ┊14┊    const query = this.getChatsGQL.watch({\n+┊  ┊15┊      amount: this.messagesAmount,\n ┊19┊16┊    });\n ┊20┊17┊    const chats$ = query.valueChanges.pipe(\n ┊21┊18┊      map((result) => result.data.chats)\n```\n\n[}]: #"
          },
          {
            "manualTitle": "Step 7: Testing",
            "stepRevision": "1faa6c13bf9f48f94f7b027bea9c8277612be7ec",
            "manualView": "## Client\n\nTesting is a very important part of each application and for the sake of showing different testing techniques we are going to show how to test a presentational component, a container component and a service.\n\nFirst let's start by importing `hammerjs` for the Material Gestures inside the test script.\n\n[{]: <helper> (diffStep \"3.1\" files=\"src/test.ts\" module=\"client\")\n\n#### [Step 3.1: Testing](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/b76d15b)\n\n##### Changed src&#x2F;test.ts\n```diff\n@@ -7,6 +7,9 @@\n ┊ 7┊ 7┊  platformBrowserDynamicTesting\n ┊ 8┊ 8┊} from '@angular/platform-browser-dynamic/testing';\n ┊ 9┊ 9┊\n+┊  ┊10┊// Material gestures\n+┊  ┊11┊import 'hammerjs';\n+┊  ┊12┊\n ┊10┊13┊declare const require: any;\n ┊11┊14┊\n ┊12┊15┊// First, initialize the Angular testing environment.\n```\n\n[}]: #\n\n### Testing a Presentional Component\n\nLet's start with the simplest one: the presentational component.\nWe are not going to inject any service and we don't need to access our backend, so things are quite simple: we just need to pass our Chat object as an Input, detect the changes and use the query selector to match the UI content to the one we passed as input:\n\n[{]: <helper> (diffStep \"3.1\" files=\"src/app/chats-lister/components/chat-item/chat-item.component.spec.ts\" module=\"client\")\n\n#### [Step 3.1: Testing](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/b76d15b)\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chat-item&#x2F;chat-item.component.spec.ts\n```diff\n@@ -0,0 +1,107 @@\n+┊   ┊  1┊import { async, ComponentFixture, TestBed } from '@angular/core/testing';\n+┊   ┊  2┊\n+┊   ┊  3┊import { ChatItemComponent } from './chat-item.component';\n+┊   ┊  4┊import {DebugElement} from '@angular/core';\n+┊   ┊  5┊import {By} from '@angular/platform-browser';\n+┊   ┊  6┊import {TruncateModule} from 'ng2-truncate';\n+┊   ┊  7┊\n+┊   ┊  8┊describe('ChatItemComponent', () => {\n+┊   ┊  9┊  let component: ChatItemComponent;\n+┊   ┊ 10┊  let fixture: ComponentFixture<ChatItemComponent>;\n+┊   ┊ 11┊  let el: DebugElement;\n+┊   ┊ 12┊\n+┊   ┊ 13┊  const chat: any = {\n+┊   ┊ 14┊    id: '1',\n+┊   ┊ 15┊    __typename: 'Chat',\n+┊   ┊ 16┊    name: 'Niccolo\\' Belli',\n+┊   ┊ 17┊    picture: null,\n+┊   ┊ 18┊    allTimeMembers: [\n+┊   ┊ 19┊      {\n+┊   ┊ 20┊        id: '1',\n+┊   ┊ 21┊        __typename: 'User',\n+┊   ┊ 22┊      },\n+┊   ┊ 23┊      {\n+┊   ┊ 24┊        id: '2',\n+┊   ┊ 25┊        __typename: 'User',\n+┊   ┊ 26┊      }\n+┊   ┊ 27┊    ],\n+┊   ┊ 28┊    unreadMessages: 0,\n+┊   ┊ 29┊    isGroup: false,\n+┊   ┊ 30┊    messages: [\n+┊   ┊ 31┊      {\n+┊   ┊ 32┊        id: '1',\n+┊   ┊ 33┊        chat: {\n+┊   ┊ 34┊          id: '1',\n+┊   ┊ 35┊          __typename: 'Chat',\n+┊   ┊ 36┊        },\n+┊   ┊ 37┊        __typename: 'Message',\n+┊   ┊ 38┊        sender: {\n+┊   ┊ 39┊          id: '1',\n+┊   ┊ 40┊          __typename: 'User',\n+┊   ┊ 41┊          name: 'Niccolo\\' Belli',\n+┊   ┊ 42┊        },\n+┊   ┊ 43┊        content: 'Hello! How are you? A lot happened since last time',\n+┊   ┊ 44┊        createdAt: '1513435525',\n+┊   ┊ 45┊        type: 1,\n+┊   ┊ 46┊        recipients: [\n+┊   ┊ 47┊          {\n+┊   ┊ 48┊            user: {\n+┊   ┊ 49┊              id: '2',\n+┊   ┊ 50┊              __typename: 'User',\n+┊   ┊ 51┊            },\n+┊   ┊ 52┊            message: {\n+┊   ┊ 53┊              id: '1',\n+┊   ┊ 54┊              __typename: 'Message',\n+┊   ┊ 55┊              chat: {\n+┊   ┊ 56┊                id: '1',\n+┊   ┊ 57┊                __typename: 'Chat',\n+┊   ┊ 58┊              },\n+┊   ┊ 59┊            },\n+┊   ┊ 60┊            __typename: 'Recipient',\n+┊   ┊ 61┊            chat: {\n+┊   ┊ 62┊              id: '1',\n+┊   ┊ 63┊              __typename: 'Chat',\n+┊   ┊ 64┊            },\n+┊   ┊ 65┊            receivedAt: null,\n+┊   ┊ 66┊            readAt: null,\n+┊   ┊ 67┊          }\n+┊   ┊ 68┊        ],\n+┊   ┊ 69┊        ownership: true,\n+┊   ┊ 70┊      }\n+┊   ┊ 71┊    ],\n+┊   ┊ 72┊  };\n+┊   ┊ 73┊\n+┊   ┊ 74┊  beforeEach(async(() => {\n+┊   ┊ 75┊    TestBed.configureTestingModule({\n+┊   ┊ 76┊      declarations: [ ChatItemComponent ],\n+┊   ┊ 77┊      imports: [TruncateModule]\n+┊   ┊ 78┊    })\n+┊   ┊ 79┊    .compileComponents();\n+┊   ┊ 80┊  }));\n+┊   ┊ 81┊\n+┊   ┊ 82┊  beforeEach(() => {\n+┊   ┊ 83┊    fixture = TestBed.createComponent(ChatItemComponent);\n+┊   ┊ 84┊    component = fixture.componentInstance;\n+┊   ┊ 85┊    component.chat = chat;\n+┊   ┊ 86┊    fixture.detectChanges();\n+┊   ┊ 87┊    el = fixture.debugElement;\n+┊   ┊ 88┊  });\n+┊   ┊ 89┊\n+┊   ┊ 90┊  it('should create', () => {\n+┊   ┊ 91┊    expect(component).toBeTruthy();\n+┊   ┊ 92┊  });\n+┊   ┊ 93┊\n+┊   ┊ 94┊  it('should contain the chat name', () => {\n+┊   ┊ 95┊    expect(el.query(By.css('.chat-recipient > div:first-child')).nativeElement.textContent).toContain(chat.name);\n+┊   ┊ 96┊  });\n+┊   ┊ 97┊\n+┊   ┊ 98┊  it('should contain the first couple of characters of the message content', () => {\n+┊   ┊ 99┊    expect(el.query(By.css('.chat-content')).nativeElement.textContent)\n+┊   ┊100┊      .toContain(chat.messages[chat.messages.length - 1].content.slice(0, 20));\n+┊   ┊101┊  });\n+┊   ┊102┊\n+┊   ┊103┊  it('should not contain the latest characters of the message content', () => {\n+┊   ┊104┊    expect(el.query(By.css('.chat-content')).nativeElement.textContent)\n+┊   ┊105┊      .not.toContain(chat.messages[chat.messages.length - 1].content.slice(20));\n+┊   ┊106┊  });\n+┊   ┊107┊});\n```\n\n[}]: #\n\n### Testing a Service\n\nTesting a service is a bit more complicated because we will need to mock our backend in order to get fake results instead of having to fire up the backend each time.\n\nWe could simply simply mock the HTTP calls, which is a well known practice in the REST API world. Since we are using HTTP to retrieve the data, it would work as well with our Apollo Client setup.\n\n#### Testing with Apollo Angular\n\nBecause Apollo Angular provides its own testing utilities, let's bring them in!\n\nAlthough `apollo-angular` has a lot going on under the hood, the library provides multiple tools for testing that simplify those abstractions, and allows complete focus on the component logic.\n\nThe `apollo-angular/testing` module exports a `ApolloTestingModule` module and `ApolloTestingController` service which simplifies the testing of Angular components by mocking calls to the GraphQL endpoint. This allows the tests to be run in isolation and provides consistent results on every run by removing the dependence on remote data.\n\nBy using this `ApolloTestingController` service, it’s possible to specify the exact results that should be returned for a certain query.\n\nWorth mentioning, `ApolloTestingModule` comes with a default cache but you can use your own with `APOLLO_TESTING_CACHE` token.\n\nLet's show everything on an example:\n\n[{]: <helper> (diffStep \"3.1\" files=\"src/app/services/chats.service.spec.ts\" module=\"client\")\n\n#### [Step 3.1: Testing](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/b76d15b)\n\n##### Added src&#x2F;app&#x2F;services&#x2F;chats.service.spec.ts\n```diff\n@@ -0,0 +1,352 @@\n+┊   ┊  1┊import { TestBed, inject } from '@angular/core/testing';\n+┊   ┊  2┊\n+┊   ┊  3┊import { Apollo } from 'apollo-angular';\n+┊   ┊  4┊import {\n+┊   ┊  5┊  ApolloTestingModule,\n+┊   ┊  6┊  ApolloTestingController,\n+┊   ┊  7┊  APOLLO_TESTING_CACHE,\n+┊   ┊  8┊} from 'apollo-angular/testing';\n+┊   ┊  9┊import { InMemoryCache } from 'apollo-cache-inmemory';\n+┊   ┊ 10┊\n+┊   ┊ 11┊import { GetChats } from '../../graphql';\n+┊   ┊ 12┊import { dataIdFromObject } from '../graphql.module';\n+┊   ┊ 13┊import { ChatsService } from './chats.service';\n+┊   ┊ 14┊\n+┊   ┊ 15┊describe('ChatsService', () => {\n+┊   ┊ 16┊  let controller: ApolloTestingController;\n+┊   ┊ 17┊  let apollo: Apollo;\n+┊   ┊ 18┊\n+┊   ┊ 19┊  const chats: GetChats.Chats[] = [\n+┊   ┊ 20┊    {\n+┊   ┊ 21┊      id: '1',\n+┊   ┊ 22┊      __typename: 'Chat',\n+┊   ┊ 23┊      name: 'Avery Stewart',\n+┊   ┊ 24┊      picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n+┊   ┊ 25┊      allTimeMembers: [\n+┊   ┊ 26┊        {\n+┊   ┊ 27┊          id: '1',\n+┊   ┊ 28┊          __typename: 'User',\n+┊   ┊ 29┊        },\n+┊   ┊ 30┊        {\n+┊   ┊ 31┊          id: '3',\n+┊   ┊ 32┊          __typename: 'User',\n+┊   ┊ 33┊        },\n+┊   ┊ 34┊      ],\n+┊   ┊ 35┊      unreadMessages: 1,\n+┊   ┊ 36┊      isGroup: false,\n+┊   ┊ 37┊      messages: [\n+┊   ┊ 38┊        {\n+┊   ┊ 39┊          id: '1',\n+┊   ┊ 40┊          chat: {\n+┊   ┊ 41┊            id: '1',\n+┊   ┊ 42┊            __typename: 'Chat',\n+┊   ┊ 43┊          },\n+┊   ┊ 44┊          __typename: 'Message',\n+┊   ┊ 45┊          sender: {\n+┊   ┊ 46┊            id: '3',\n+┊   ┊ 47┊            __typename: 'User',\n+┊   ┊ 48┊            name: 'Avery Stewart',\n+┊   ┊ 49┊          },\n+┊   ┊ 50┊          content: 'Yep!',\n+┊   ┊ 51┊          createdAt: '1514035700',\n+┊   ┊ 52┊          type: 0,\n+┊   ┊ 53┊          recipients: [\n+┊   ┊ 54┊            {\n+┊   ┊ 55┊              user: {\n+┊   ┊ 56┊                id: '1',\n+┊   ┊ 57┊                __typename: 'User',\n+┊   ┊ 58┊              },\n+┊   ┊ 59┊              message: {\n+┊   ┊ 60┊                id: '1',\n+┊   ┊ 61┊                __typename: 'Message',\n+┊   ┊ 62┊                chat: {\n+┊   ┊ 63┊                  id: '1',\n+┊   ┊ 64┊                  __typename: 'Chat',\n+┊   ┊ 65┊                },\n+┊   ┊ 66┊              },\n+┊   ┊ 67┊              __typename: 'Recipient',\n+┊   ┊ 68┊              chat: {\n+┊   ┊ 69┊                id: '1',\n+┊   ┊ 70┊                __typename: 'Chat',\n+┊   ┊ 71┊              },\n+┊   ┊ 72┊              receivedAt: null,\n+┊   ┊ 73┊              readAt: null,\n+┊   ┊ 74┊            },\n+┊   ┊ 75┊          ],\n+┊   ┊ 76┊          ownership: false,\n+┊   ┊ 77┊        },\n+┊   ┊ 78┊      ],\n+┊   ┊ 79┊    },\n+┊   ┊ 80┊    {\n+┊   ┊ 81┊      id: '2',\n+┊   ┊ 82┊      __typename: 'Chat',\n+┊   ┊ 83┊      name: 'Katie Peterson',\n+┊   ┊ 84┊      picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n+┊   ┊ 85┊      allTimeMembers: [\n+┊   ┊ 86┊        {\n+┊   ┊ 87┊          id: '1',\n+┊   ┊ 88┊          __typename: 'User',\n+┊   ┊ 89┊        },\n+┊   ┊ 90┊        {\n+┊   ┊ 91┊          id: '4',\n+┊   ┊ 92┊          __typename: 'User',\n+┊   ┊ 93┊        },\n+┊   ┊ 94┊      ],\n+┊   ┊ 95┊      unreadMessages: 0,\n+┊   ┊ 96┊      isGroup: false,\n+┊   ┊ 97┊      messages: [\n+┊   ┊ 98┊        {\n+┊   ┊ 99┊          id: '1',\n+┊   ┊100┊          chat: {\n+┊   ┊101┊            id: '2',\n+┊   ┊102┊            __typename: 'Chat',\n+┊   ┊103┊          },\n+┊   ┊104┊          __typename: 'Message',\n+┊   ┊105┊          sender: {\n+┊   ┊106┊            id: '1',\n+┊   ┊107┊            __typename: 'User',\n+┊   ┊108┊            name: 'Ethan Gonzalez',\n+┊   ┊109┊          },\n+┊   ┊110┊          content: `Hey, it's me`,\n+┊   ┊111┊          createdAt: '1514031800',\n+┊   ┊112┊          type: 0,\n+┊   ┊113┊          recipients: [\n+┊   ┊114┊            {\n+┊   ┊115┊              user: {\n+┊   ┊116┊                id: '4',\n+┊   ┊117┊                __typename: 'User',\n+┊   ┊118┊              },\n+┊   ┊119┊              message: {\n+┊   ┊120┊                id: '1',\n+┊   ┊121┊                __typename: 'Message',\n+┊   ┊122┊                chat: {\n+┊   ┊123┊                  id: '2',\n+┊   ┊124┊                  __typename: 'Chat',\n+┊   ┊125┊                },\n+┊   ┊126┊              },\n+┊   ┊127┊              __typename: 'Recipient',\n+┊   ┊128┊              chat: {\n+┊   ┊129┊                id: '2',\n+┊   ┊130┊                __typename: 'Chat',\n+┊   ┊131┊              },\n+┊   ┊132┊              receivedAt: null,\n+┊   ┊133┊              readAt: null,\n+┊   ┊134┊            },\n+┊   ┊135┊          ],\n+┊   ┊136┊          ownership: true,\n+┊   ┊137┊        },\n+┊   ┊138┊      ],\n+┊   ┊139┊    },\n+┊   ┊140┊    {\n+┊   ┊141┊      id: '3',\n+┊   ┊142┊      __typename: 'Chat',\n+┊   ┊143┊      name: 'Ray Edwards',\n+┊   ┊144┊      picture: 'https://randomuser.me/api/portraits/thumb/men/3.jpg',\n+┊   ┊145┊      allTimeMembers: [\n+┊   ┊146┊        {\n+┊   ┊147┊          id: '1',\n+┊   ┊148┊          __typename: 'User',\n+┊   ┊149┊        },\n+┊   ┊150┊        {\n+┊   ┊151┊          id: '5',\n+┊   ┊152┊          __typename: 'User',\n+┊   ┊153┊        },\n+┊   ┊154┊      ],\n+┊   ┊155┊      unreadMessages: 0,\n+┊   ┊156┊      isGroup: false,\n+┊   ┊157┊      messages: [\n+┊   ┊158┊        {\n+┊   ┊159┊          id: '1',\n+┊   ┊160┊          __typename: 'Message',\n+┊   ┊161┊          chat: {\n+┊   ┊162┊            id: '3',\n+┊   ┊163┊            __typename: 'Chat',\n+┊   ┊164┊          },\n+┊   ┊165┊          sender: {\n+┊   ┊166┊            id: '1',\n+┊   ┊167┊            __typename: 'User',\n+┊   ┊168┊            name: 'Ethan Gonzalez',\n+┊   ┊169┊          },\n+┊   ┊170┊          content: 'You still there?',\n+┊   ┊171┊          createdAt: '1514010200',\n+┊   ┊172┊          type: 0,\n+┊   ┊173┊          recipients: [\n+┊   ┊174┊            {\n+┊   ┊175┊              user: {\n+┊   ┊176┊                id: '5',\n+┊   ┊177┊                __typename: 'User',\n+┊   ┊178┊              },\n+┊   ┊179┊              message: {\n+┊   ┊180┊                id: '1',\n+┊   ┊181┊                __typename: 'Message',\n+┊   ┊182┊                chat: {\n+┊   ┊183┊                  id: '3',\n+┊   ┊184┊                  __typename: 'Chat',\n+┊   ┊185┊                },\n+┊   ┊186┊              },\n+┊   ┊187┊              __typename: 'Recipient',\n+┊   ┊188┊              chat: {\n+┊   ┊189┊                id: '3',\n+┊   ┊190┊                __typename: 'Chat',\n+┊   ┊191┊              },\n+┊   ┊192┊              receivedAt: null,\n+┊   ┊193┊              readAt: null,\n+┊   ┊194┊            },\n+┊   ┊195┊          ],\n+┊   ┊196┊          ownership: true,\n+┊   ┊197┊        },\n+┊   ┊198┊      ],\n+┊   ┊199┊    },\n+┊   ┊200┊    {\n+┊   ┊201┊      id: '6',\n+┊   ┊202┊      __typename: 'Chat',\n+┊   ┊203┊      name: 'Niccolò Belli',\n+┊   ┊204┊      picture: 'https://randomuser.me/api/portraits/thumb/men/4.jpg',\n+┊   ┊205┊      allTimeMembers: [\n+┊   ┊206┊        {\n+┊   ┊207┊          id: '1',\n+┊   ┊208┊          __typename: 'User',\n+┊   ┊209┊        },\n+┊   ┊210┊        {\n+┊   ┊211┊          id: '6',\n+┊   ┊212┊          __typename: 'User',\n+┊   ┊213┊        },\n+┊   ┊214┊      ],\n+┊   ┊215┊      unreadMessages: 0,\n+┊   ┊216┊      messages: [],\n+┊   ┊217┊      isGroup: false,\n+┊   ┊218┊    },\n+┊   ┊219┊    {\n+┊   ┊220┊      id: '8',\n+┊   ┊221┊      __typename: 'Chat',\n+┊   ┊222┊      name: 'A user 0 group',\n+┊   ┊223┊      picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n+┊   ┊224┊      allTimeMembers: [\n+┊   ┊225┊        {\n+┊   ┊226┊          id: '1',\n+┊   ┊227┊          __typename: 'User',\n+┊   ┊228┊        },\n+┊   ┊229┊        {\n+┊   ┊230┊          id: '3',\n+┊   ┊231┊          __typename: 'User',\n+┊   ┊232┊        },\n+┊   ┊233┊        {\n+┊   ┊234┊          id: '4',\n+┊   ┊235┊          __typename: 'User',\n+┊   ┊236┊        },\n+┊   ┊237┊        {\n+┊   ┊238┊          id: '6',\n+┊   ┊239┊          __typename: 'User',\n+┊   ┊240┊        },\n+┊   ┊241┊      ],\n+┊   ┊242┊      unreadMessages: 1,\n+┊   ┊243┊      isGroup: true,\n+┊   ┊244┊      messages: [\n+┊   ┊245┊        {\n+┊   ┊246┊          id: '1',\n+┊   ┊247┊          __typename: 'Message',\n+┊   ┊248┊          chat: {\n+┊   ┊249┊            id: '8',\n+┊   ┊250┊            __typename: 'Chat',\n+┊   ┊251┊          },\n+┊   ┊252┊          sender: {\n+┊   ┊253┊            id: '4',\n+┊   ┊254┊            __typename: 'User',\n+┊   ┊255┊            name: 'Katie Peterson',\n+┊   ┊256┊          },\n+┊   ┊257┊          content: 'Awesome!',\n+┊   ┊258┊          createdAt: '1512830000',\n+┊   ┊259┊          type: 0,\n+┊   ┊260┊          recipients: [\n+┊   ┊261┊            {\n+┊   ┊262┊              user: {\n+┊   ┊263┊                id: '1',\n+┊   ┊264┊                __typename: 'User',\n+┊   ┊265┊              },\n+┊   ┊266┊              message: {\n+┊   ┊267┊                id: '1',\n+┊   ┊268┊                __typename: 'Message',\n+┊   ┊269┊                chat: {\n+┊   ┊270┊                  id: '8',\n+┊   ┊271┊                  __typename: 'Chat',\n+┊   ┊272┊                },\n+┊   ┊273┊              },\n+┊   ┊274┊              __typename: 'Recipient',\n+┊   ┊275┊              chat: {\n+┊   ┊276┊                id: '8',\n+┊   ┊277┊                __typename: 'Chat',\n+┊   ┊278┊              },\n+┊   ┊279┊              receivedAt: null,\n+┊   ┊280┊              readAt: null,\n+┊   ┊281┊            },\n+┊   ┊282┊            {\n+┊   ┊283┊              user: {\n+┊   ┊284┊                id: '6',\n+┊   ┊285┊                __typename: 'User',\n+┊   ┊286┊              },\n+┊   ┊287┊              message: {\n+┊   ┊288┊                id: '1',\n+┊   ┊289┊                __typename: 'Message',\n+┊   ┊290┊                chat: {\n+┊   ┊291┊                  id: '8',\n+┊   ┊292┊                  __typename: 'Chat',\n+┊   ┊293┊                },\n+┊   ┊294┊              },\n+┊   ┊295┊              __typename: 'Recipient',\n+┊   ┊296┊              chat: {\n+┊   ┊297┊                id: '8',\n+┊   ┊298┊                __typename: 'Chat',\n+┊   ┊299┊              },\n+┊   ┊300┊              receivedAt: null,\n+┊   ┊301┊              readAt: null,\n+┊   ┊302┊            },\n+┊   ┊303┊          ],\n+┊   ┊304┊          ownership: false,\n+┊   ┊305┊        },\n+┊   ┊306┊      ],\n+┊   ┊307┊    },\n+┊   ┊308┊  ];\n+┊   ┊309┊\n+┊   ┊310┊  beforeEach(() => {\n+┊   ┊311┊    TestBed.configureTestingModule({\n+┊   ┊312┊      imports: [ApolloTestingModule],\n+┊   ┊313┊      providers: [\n+┊   ┊314┊        ChatsService,\n+┊   ┊315┊        {\n+┊   ┊316┊          provide: APOLLO_TESTING_CACHE,\n+┊   ┊317┊          useFactory() {\n+┊   ┊318┊            return new InMemoryCache({\n+┊   ┊319┊              dataIdFromObject,\n+┊   ┊320┊            });\n+┊   ┊321┊          },\n+┊   ┊322┊        },\n+┊   ┊323┊      ],\n+┊   ┊324┊    });\n+┊   ┊325┊\n+┊   ┊326┊    controller = TestBed.get(ApolloTestingController);\n+┊   ┊327┊    apollo = TestBed.get(Apollo);\n+┊   ┊328┊  });\n+┊   ┊329┊\n+┊   ┊330┊  it('should be created', inject([ChatsService], (service: ChatsService) => {\n+┊   ┊331┊    expect(service).toBeTruthy();\n+┊   ┊332┊  }));\n+┊   ┊333┊\n+┊   ┊334┊  it('should get chats', inject([ChatsService], (service: ChatsService) => {\n+┊   ┊335┊    service.getChats().chats$.subscribe(_chats => {\n+┊   ┊336┊      expect(_chats.length).toEqual(chats.length);\n+┊   ┊337┊      for (let i = 0; i < _chats.length; i++) {\n+┊   ┊338┊        expect(_chats[i]).toEqual(chats[i]);\n+┊   ┊339┊      }\n+┊   ┊340┊    });\n+┊   ┊341┊\n+┊   ┊342┊    const req = controller.expectOne('GetChats', 'GetChats operation');\n+┊   ┊343┊\n+┊   ┊344┊    req.flush({\n+┊   ┊345┊      data: {\n+┊   ┊346┊        chats,\n+┊   ┊347┊      },\n+┊   ┊348┊    });\n+┊   ┊349┊\n+┊   ┊350┊    controller.verify();\n+┊   ┊351┊  }));\n+┊   ┊352┊});\n```\n\n[}]: #\n\nAs you can see, the API of `ApolloTestingController` is pretty similar to the `HttpTestingController`.\n\nThere are four methods you should know.\n\n**`expectOne()`**\nImportant thing, it accepts two arguments. First is different for different use cases, the second one stays always the same, it’s a string with a description of your assertion. In case of failing assertion, the error is thrown with an error message including the given description.\n\nLet's explore all those possible cases `expectOne` accepts:\n\n- you can match an operation by its name, simply by passing a string as a first argument.\n- by passing the whole Operation object the expectOne method compares: operation’s name, variables, document and extensions.\n- the first argument can also be a function that provides an Operation object and expect a boolean in return\n- or passing a GraphQL Document\n\n**`exceptNone()`**\nIt accepts the same arguments as expectOne but it's a negation of it.\n\n**`match()`**\nSearch for operations that match the given parameters, without any expectations.\n\n**`verify()`**\nVerify that no unmatched operations are outstanding. If any operations are outstanding, fail with an error message indicating which operations were not handled.\n\nIf you want to learn more about testing, we got you covered, please visit [\"Testing Apollo in Angular\" chapter](https://www.apollographql.com/docs/angular/guides/testing.html) in Apollo documentation.\n\n### Testing a Container Component\n\nIn the last example we are going to test a container component, which makes use of several services and multiple other components:\n\n[{]: <helper> (diffStep \"3.1\" files=\"src/app/chats-lister/containers/chats/chats.component.spec.ts\" module=\"client\")\n\n#### [Step 3.1: Testing](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/b76d15b)\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.spec.ts\n```diff\n@@ -0,0 +1,392 @@\n+┊   ┊  1┊import { async, ComponentFixture, TestBed } from '@angular/core/testing';\n+┊   ┊  2┊import { DebugElement, NO_ERRORS_SCHEMA } from '@angular/core';\n+┊   ┊  3┊import { TruncateModule } from 'ng2-truncate';\n+┊   ┊  4┊import {\n+┊   ┊  5┊  MatButtonModule,\n+┊   ┊  6┊  MatIconModule,\n+┊   ┊  7┊  MatListModule,\n+┊   ┊  8┊  MatMenuModule,\n+┊   ┊  9┊} from '@angular/material';\n+┊   ┊ 10┊import { Apollo } from 'apollo-angular';\n+┊   ┊ 11┊import {\n+┊   ┊ 12┊  ApolloTestingModule,\n+┊   ┊ 13┊  ApolloTestingController,\n+┊   ┊ 14┊  APOLLO_TESTING_CACHE,\n+┊   ┊ 15┊} from 'apollo-angular/testing';\n+┊   ┊ 16┊import { InMemoryCache } from 'apollo-cache-inmemory';\n+┊   ┊ 17┊import { By } from '@angular/platform-browser';\n+┊   ┊ 18┊import { RouterTestingModule } from '@angular/router/testing';\n+┊   ┊ 19┊\n+┊   ┊ 20┊import { GetChats } from '../../../../graphql';\n+┊   ┊ 21┊import { dataIdFromObject } from '../../../graphql.module';\n+┊   ┊ 22┊import { ChatsComponent } from './chats.component';\n+┊   ┊ 23┊import { ChatsListComponent } from '../../components/chats-list/chats-list.component';\n+┊   ┊ 24┊import { ChatItemComponent } from '../../components/chat-item/chat-item.component';\n+┊   ┊ 25┊import { ChatsService } from '../../../services/chats.service';\n+┊   ┊ 26┊\n+┊   ┊ 27┊describe('ChatsComponent', () => {\n+┊   ┊ 28┊  let component: ChatsComponent;\n+┊   ┊ 29┊  let fixture: ComponentFixture<ChatsComponent>;\n+┊   ┊ 30┊  let el: DebugElement;\n+┊   ┊ 31┊\n+┊   ┊ 32┊  let controller: ApolloTestingController;\n+┊   ┊ 33┊  let apollo: Apollo;\n+┊   ┊ 34┊\n+┊   ┊ 35┊  const chats: GetChats.Chats[] = [\n+┊   ┊ 36┊    {\n+┊   ┊ 37┊      id: '1',\n+┊   ┊ 38┊      __typename: 'Chat',\n+┊   ┊ 39┊      name: 'Avery Stewart',\n+┊   ┊ 40┊      picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n+┊   ┊ 41┊      allTimeMembers: [\n+┊   ┊ 42┊        {\n+┊   ┊ 43┊          id: '1',\n+┊   ┊ 44┊          __typename: 'User',\n+┊   ┊ 45┊        },\n+┊   ┊ 46┊        {\n+┊   ┊ 47┊          id: '3',\n+┊   ┊ 48┊          __typename: 'User',\n+┊   ┊ 49┊        },\n+┊   ┊ 50┊      ],\n+┊   ┊ 51┊      unreadMessages: 1,\n+┊   ┊ 52┊      isGroup: false,\n+┊   ┊ 53┊      messages: [\n+┊   ┊ 54┊        {\n+┊   ┊ 55┊          id: '1',\n+┊   ┊ 56┊          chat: {\n+┊   ┊ 57┊            id: '1',\n+┊   ┊ 58┊            __typename: 'Chat',\n+┊   ┊ 59┊          },\n+┊   ┊ 60┊          __typename: 'Message',\n+┊   ┊ 61┊          sender: {\n+┊   ┊ 62┊            id: '3',\n+┊   ┊ 63┊            __typename: 'User',\n+┊   ┊ 64┊            name: 'Avery Stewart',\n+┊   ┊ 65┊          },\n+┊   ┊ 66┊          content: 'Yep!',\n+┊   ┊ 67┊          createdAt: '1514035700',\n+┊   ┊ 68┊          type: 0,\n+┊   ┊ 69┊          recipients: [\n+┊   ┊ 70┊            {\n+┊   ┊ 71┊              user: {\n+┊   ┊ 72┊                id: '1',\n+┊   ┊ 73┊                __typename: 'User',\n+┊   ┊ 74┊              },\n+┊   ┊ 75┊              message: {\n+┊   ┊ 76┊                id: '1',\n+┊   ┊ 77┊                __typename: 'Message',\n+┊   ┊ 78┊                chat: {\n+┊   ┊ 79┊                  id: '1',\n+┊   ┊ 80┊                  __typename: 'Chat',\n+┊   ┊ 81┊                },\n+┊   ┊ 82┊              },\n+┊   ┊ 83┊              __typename: 'Recipient',\n+┊   ┊ 84┊              chat: {\n+┊   ┊ 85┊                id: '1',\n+┊   ┊ 86┊                __typename: 'Chat',\n+┊   ┊ 87┊              },\n+┊   ┊ 88┊              receivedAt: null,\n+┊   ┊ 89┊              readAt: null,\n+┊   ┊ 90┊            },\n+┊   ┊ 91┊          ],\n+┊   ┊ 92┊          ownership: false,\n+┊   ┊ 93┊        },\n+┊   ┊ 94┊      ],\n+┊   ┊ 95┊    },\n+┊   ┊ 96┊    {\n+┊   ┊ 97┊      id: '2',\n+┊   ┊ 98┊      __typename: 'Chat',\n+┊   ┊ 99┊      name: 'Katie Peterson',\n+┊   ┊100┊      picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n+┊   ┊101┊      allTimeMembers: [\n+┊   ┊102┊        {\n+┊   ┊103┊          id: '1',\n+┊   ┊104┊          __typename: 'User',\n+┊   ┊105┊        },\n+┊   ┊106┊        {\n+┊   ┊107┊          id: '4',\n+┊   ┊108┊          __typename: 'User',\n+┊   ┊109┊        },\n+┊   ┊110┊      ],\n+┊   ┊111┊      unreadMessages: 0,\n+┊   ┊112┊      isGroup: false,\n+┊   ┊113┊      messages: [\n+┊   ┊114┊        {\n+┊   ┊115┊          id: '1',\n+┊   ┊116┊          chat: {\n+┊   ┊117┊            id: '2',\n+┊   ┊118┊            __typename: 'Chat',\n+┊   ┊119┊          },\n+┊   ┊120┊          __typename: 'Message',\n+┊   ┊121┊          sender: {\n+┊   ┊122┊            id: '1',\n+┊   ┊123┊            __typename: 'User',\n+┊   ┊124┊            name: 'Ethan Gonzalez',\n+┊   ┊125┊          },\n+┊   ┊126┊          content: `Hey, it's me`,\n+┊   ┊127┊          createdAt: '1514031800',\n+┊   ┊128┊          type: 0,\n+┊   ┊129┊          recipients: [\n+┊   ┊130┊            {\n+┊   ┊131┊              user: {\n+┊   ┊132┊                id: '4',\n+┊   ┊133┊                __typename: 'User',\n+┊   ┊134┊              },\n+┊   ┊135┊              message: {\n+┊   ┊136┊                id: '1',\n+┊   ┊137┊                __typename: 'Message',\n+┊   ┊138┊                chat: {\n+┊   ┊139┊                  id: '2',\n+┊   ┊140┊                  __typename: 'Chat',\n+┊   ┊141┊                },\n+┊   ┊142┊              },\n+┊   ┊143┊              __typename: 'Recipient',\n+┊   ┊144┊              chat: {\n+┊   ┊145┊                id: '2',\n+┊   ┊146┊                __typename: 'Chat',\n+┊   ┊147┊              },\n+┊   ┊148┊              receivedAt: null,\n+┊   ┊149┊              readAt: null,\n+┊   ┊150┊            },\n+┊   ┊151┊          ],\n+┊   ┊152┊          ownership: true,\n+┊   ┊153┊        },\n+┊   ┊154┊      ],\n+┊   ┊155┊    },\n+┊   ┊156┊    {\n+┊   ┊157┊      id: '3',\n+┊   ┊158┊      __typename: 'Chat',\n+┊   ┊159┊      name: 'Ray Edwards',\n+┊   ┊160┊      picture: 'https://randomuser.me/api/portraits/thumb/men/3.jpg',\n+┊   ┊161┊      allTimeMembers: [\n+┊   ┊162┊        {\n+┊   ┊163┊          id: '1',\n+┊   ┊164┊          __typename: 'User',\n+┊   ┊165┊        },\n+┊   ┊166┊        {\n+┊   ┊167┊          id: '5',\n+┊   ┊168┊          __typename: 'User',\n+┊   ┊169┊        },\n+┊   ┊170┊      ],\n+┊   ┊171┊      unreadMessages: 0,\n+┊   ┊172┊      isGroup: false,\n+┊   ┊173┊      messages: [\n+┊   ┊174┊        {\n+┊   ┊175┊          id: '1',\n+┊   ┊176┊          __typename: 'Message',\n+┊   ┊177┊          chat: {\n+┊   ┊178┊            id: '3',\n+┊   ┊179┊            __typename: 'Chat',\n+┊   ┊180┊          },\n+┊   ┊181┊          sender: {\n+┊   ┊182┊            id: '1',\n+┊   ┊183┊            __typename: 'User',\n+┊   ┊184┊            name: 'Ethan Gonzalez',\n+┊   ┊185┊          },\n+┊   ┊186┊          content: 'You still there?',\n+┊   ┊187┊          createdAt: '1514010200',\n+┊   ┊188┊          type: 0,\n+┊   ┊189┊          recipients: [\n+┊   ┊190┊            {\n+┊   ┊191┊              user: {\n+┊   ┊192┊                id: '5',\n+┊   ┊193┊                __typename: 'User',\n+┊   ┊194┊              },\n+┊   ┊195┊              message: {\n+┊   ┊196┊                id: '1',\n+┊   ┊197┊                __typename: 'Message',\n+┊   ┊198┊                chat: {\n+┊   ┊199┊                  id: '3',\n+┊   ┊200┊                  __typename: 'Chat',\n+┊   ┊201┊                },\n+┊   ┊202┊              },\n+┊   ┊203┊              __typename: 'Recipient',\n+┊   ┊204┊              chat: {\n+┊   ┊205┊                id: '3',\n+┊   ┊206┊                __typename: 'Chat',\n+┊   ┊207┊              },\n+┊   ┊208┊              receivedAt: null,\n+┊   ┊209┊              readAt: null,\n+┊   ┊210┊            },\n+┊   ┊211┊          ],\n+┊   ┊212┊          ownership: true,\n+┊   ┊213┊        },\n+┊   ┊214┊      ],\n+┊   ┊215┊    },\n+┊   ┊216┊    {\n+┊   ┊217┊      id: '6',\n+┊   ┊218┊      __typename: 'Chat',\n+┊   ┊219┊      name: 'Niccolò Belli',\n+┊   ┊220┊      picture: 'https://randomuser.me/api/portraits/thumb/men/4.jpg',\n+┊   ┊221┊      allTimeMembers: [\n+┊   ┊222┊        {\n+┊   ┊223┊          id: '1',\n+┊   ┊224┊          __typename: 'User',\n+┊   ┊225┊        },\n+┊   ┊226┊        {\n+┊   ┊227┊          id: '6',\n+┊   ┊228┊          __typename: 'User',\n+┊   ┊229┊        },\n+┊   ┊230┊      ],\n+┊   ┊231┊      unreadMessages: 0,\n+┊   ┊232┊      messages: [],\n+┊   ┊233┊      isGroup: false,\n+┊   ┊234┊    },\n+┊   ┊235┊    {\n+┊   ┊236┊      id: '8',\n+┊   ┊237┊      __typename: 'Chat',\n+┊   ┊238┊      name: 'A user 0 group',\n+┊   ┊239┊      picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n+┊   ┊240┊      allTimeMembers: [\n+┊   ┊241┊        {\n+┊   ┊242┊          id: '1',\n+┊   ┊243┊          __typename: 'User',\n+┊   ┊244┊        },\n+┊   ┊245┊        {\n+┊   ┊246┊          id: '3',\n+┊   ┊247┊          __typename: 'User',\n+┊   ┊248┊        },\n+┊   ┊249┊        {\n+┊   ┊250┊          id: '4',\n+┊   ┊251┊          __typename: 'User',\n+┊   ┊252┊        },\n+┊   ┊253┊        {\n+┊   ┊254┊          id: '6',\n+┊   ┊255┊          __typename: 'User',\n+┊   ┊256┊        },\n+┊   ┊257┊      ],\n+┊   ┊258┊      unreadMessages: 1,\n+┊   ┊259┊      isGroup: true,\n+┊   ┊260┊      messages: [\n+┊   ┊261┊        {\n+┊   ┊262┊          id: '1',\n+┊   ┊263┊          __typename: 'Message',\n+┊   ┊264┊          chat: {\n+┊   ┊265┊            id: '8',\n+┊   ┊266┊            __typename: 'Chat',\n+┊   ┊267┊          },\n+┊   ┊268┊          sender: {\n+┊   ┊269┊            id: '4',\n+┊   ┊270┊            __typename: 'User',\n+┊   ┊271┊            name: 'Katie Peterson',\n+┊   ┊272┊          },\n+┊   ┊273┊          content: 'Awesome!',\n+┊   ┊274┊          createdAt: '1512830000',\n+┊   ┊275┊          type: 0,\n+┊   ┊276┊          recipients: [\n+┊   ┊277┊            {\n+┊   ┊278┊              user: {\n+┊   ┊279┊                id: '1',\n+┊   ┊280┊                __typename: 'User',\n+┊   ┊281┊              },\n+┊   ┊282┊              message: {\n+┊   ┊283┊                id: '1',\n+┊   ┊284┊                __typename: 'Message',\n+┊   ┊285┊                chat: {\n+┊   ┊286┊                  id: '8',\n+┊   ┊287┊                  __typename: 'Chat',\n+┊   ┊288┊                },\n+┊   ┊289┊              },\n+┊   ┊290┊              __typename: 'Recipient',\n+┊   ┊291┊              chat: {\n+┊   ┊292┊                id: '8',\n+┊   ┊293┊                __typename: 'Chat',\n+┊   ┊294┊              },\n+┊   ┊295┊              receivedAt: null,\n+┊   ┊296┊              readAt: null,\n+┊   ┊297┊            },\n+┊   ┊298┊            {\n+┊   ┊299┊              user: {\n+┊   ┊300┊                id: '6',\n+┊   ┊301┊                __typename: 'User',\n+┊   ┊302┊              },\n+┊   ┊303┊              message: {\n+┊   ┊304┊                id: '1',\n+┊   ┊305┊                __typename: 'Message',\n+┊   ┊306┊                chat: {\n+┊   ┊307┊                  id: '8',\n+┊   ┊308┊                  __typename: 'Chat',\n+┊   ┊309┊                },\n+┊   ┊310┊              },\n+┊   ┊311┊              __typename: 'Recipient',\n+┊   ┊312┊              chat: {\n+┊   ┊313┊                id: '8',\n+┊   ┊314┊                __typename: 'Chat',\n+┊   ┊315┊              },\n+┊   ┊316┊              receivedAt: null,\n+┊   ┊317┊              readAt: null,\n+┊   ┊318┊            },\n+┊   ┊319┊          ],\n+┊   ┊320┊          ownership: false,\n+┊   ┊321┊        },\n+┊   ┊322┊      ],\n+┊   ┊323┊    },\n+┊   ┊324┊  ];\n+┊   ┊325┊\n+┊   ┊326┊  beforeEach(async(() => {\n+┊   ┊327┊    TestBed.configureTestingModule({\n+┊   ┊328┊      declarations: [ChatsComponent, ChatsListComponent, ChatItemComponent],\n+┊   ┊329┊      imports: [\n+┊   ┊330┊        MatMenuModule,\n+┊   ┊331┊        MatIconModule,\n+┊   ┊332┊        MatButtonModule,\n+┊   ┊333┊        MatListModule,\n+┊   ┊334┊        TruncateModule,\n+┊   ┊335┊        ApolloTestingModule,\n+┊   ┊336┊        RouterTestingModule,\n+┊   ┊337┊      ],\n+┊   ┊338┊      providers: [\n+┊   ┊339┊        ChatsService,\n+┊   ┊340┊        {\n+┊   ┊341┊          provide: APOLLO_TESTING_CACHE,\n+┊   ┊342┊          useFactory() {\n+┊   ┊343┊            return new InMemoryCache({ dataIdFromObject });\n+┊   ┊344┊          },\n+┊   ┊345┊        },\n+┊   ┊346┊      ],\n+┊   ┊347┊      schemas: [NO_ERRORS_SCHEMA],\n+┊   ┊348┊    }).compileComponents();\n+┊   ┊349┊\n+┊   ┊350┊    controller = TestBed.get(ApolloTestingController);\n+┊   ┊351┊    apollo = TestBed.get(Apollo);\n+┊   ┊352┊  }));\n+┊   ┊353┊\n+┊   ┊354┊  beforeEach(() => {\n+┊   ┊355┊    fixture = TestBed.createComponent(ChatsComponent);\n+┊   ┊356┊    component = fixture.componentInstance;\n+┊   ┊357┊    fixture.detectChanges();\n+┊   ┊358┊\n+┊   ┊359┊    const req = controller.expectOne('GetChats', 'GetChats operation');\n+┊   ┊360┊\n+┊   ┊361┊    req.flush({\n+┊   ┊362┊      data: {\n+┊   ┊363┊        chats,\n+┊   ┊364┊      },\n+┊   ┊365┊    });\n+┊   ┊366┊  });\n+┊   ┊367┊\n+┊   ┊368┊  it('should create', () => {\n+┊   ┊369┊    expect(component).toBeTruthy();\n+┊   ┊370┊  });\n+┊   ┊371┊\n+┊   ┊372┊  it('should display the chats', () => {\n+┊   ┊373┊    fixture.whenStable().then(() => {\n+┊   ┊374┊      fixture.detectChanges();\n+┊   ┊375┊      el = fixture.debugElement;\n+┊   ┊376┊      for (let i = 0; i < chats.length; i++) {\n+┊   ┊377┊        expect(\n+┊   ┊378┊          el.query(\n+┊   ┊379┊            By.css(\n+┊   ┊380┊              `app-chats-list > mat-list > mat-list-item:nth-child(${i +\n+┊   ┊381┊                1}) > div > app-chat-item > div > div > div`,\n+┊   ┊382┊            ),\n+┊   ┊383┊          ).nativeElement.textContent,\n+┊   ┊384┊        ).toContain(chats[i].name);\n+┊   ┊385┊      }\n+┊   ┊386┊    });\n+┊   ┊387┊  });\n+┊   ┊388┊\n+┊   ┊389┊  afterAll(() => {\n+┊   ┊390┊    controller.verify();\n+┊   ┊391┊  });\n+┊   ┊392┊});\n```\n\n[}]: #"
          },
          {
            "manualTitle": "Step 8: Chat viewer",
            "stepRevision": "026cf4f16276d61fd0e962c466c76806bb4f397c",
            "manualView": "![chat](https://user-images.githubusercontent.com/7648874/49270290-92877e80-f4a3-11e8-8984-d3ee920838ed.png)\n\nAt this point we have a module which lists all of our chats, but we still need to show a particular chat.\nWe're going to implement in in this chapter.\n\n### ChatViewer module\n\nFirst, let's create a `ChatViewer` module:\n\n[{]: <helper> (diffStep \"4.1\" files=\"src/app/app.module.ts, src/app/chat-viewer/chat-viewer.module.ts\" module=\"client\")\n\n#### [Step 4.1: Chat Viewer](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/257159a)\n\n##### Changed src&#x2F;app&#x2F;app.module.ts\n```diff\n@@ -6,6 +6,7 @@\n ┊ 6┊ 6┊import { GraphQLModule } from './graphql.module';\n ┊ 7┊ 7┊import {ChatsListerModule} from './chats-lister/chats-lister.module';\n ┊ 8┊ 8┊import {RouterModule, Routes} from '@angular/router';\n+┊  ┊ 9┊import {ChatViewerModule} from './chat-viewer/chat-viewer.module';\n ┊ 9┊10┊const routes: Routes = [];\n ┊10┊11┊\n ┊11┊12┊@NgModule({\n```\n```diff\n@@ -20,6 +21,7 @@\n ┊20┊21┊    RouterModule.forRoot(routes),\n ┊21┊22┊    // Feature modules\n ┊22┊23┊    ChatsListerModule,\n+┊  ┊24┊    ChatViewerModule,\n ┊23┊25┊  ],\n ┊24┊26┊  providers: [],\n ┊25┊27┊  bootstrap: [AppComponent]\n```\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;chat-viewer.module.ts\n```diff\n@@ -0,0 +1,53 @@\n+┊  ┊ 1┊import { BrowserModule } from '@angular/platform-browser';\n+┊  ┊ 2┊import { NgModule } from '@angular/core';\n+┊  ┊ 3┊\n+┊  ┊ 4┊import {BrowserAnimationsModule} from '@angular/platform-browser/animations';\n+┊  ┊ 5┊import {MatButtonModule, MatGridListModule, MatIconModule, MatListModule, MatMenuModule, MatToolbarModule} from '@angular/material';\n+┊  ┊ 6┊import {RouterModule, Routes} from '@angular/router';\n+┊  ┊ 7┊import {FormsModule} from '@angular/forms';\n+┊  ┊ 8┊import {ChatsService} from '../services/chats.service';\n+┊  ┊ 9┊import {ChatComponent} from './containers/chat/chat.component';\n+┊  ┊10┊import {MessagesListComponent} from './components/messages-list/messages-list.component';\n+┊  ┊11┊import {MessageItemComponent} from './components/message-item/message-item.component';\n+┊  ┊12┊import {NewMessageComponent} from './components/new-message/new-message.component';\n+┊  ┊13┊import {SharedModule} from '../shared/shared.module';\n+┊  ┊14┊\n+┊  ┊15┊const routes: Routes = [\n+┊  ┊16┊  {\n+┊  ┊17┊    path: 'chat', children: [\n+┊  ┊18┊      {path: ':id', component: ChatComponent},\n+┊  ┊19┊    ],\n+┊  ┊20┊  },\n+┊  ┊21┊];\n+┊  ┊22┊\n+┊  ┊23┊@NgModule({\n+┊  ┊24┊  declarations: [\n+┊  ┊25┊    ChatComponent,\n+┊  ┊26┊    MessagesListComponent,\n+┊  ┊27┊    MessageItemComponent,\n+┊  ┊28┊    NewMessageComponent,\n+┊  ┊29┊  ],\n+┊  ┊30┊  imports: [\n+┊  ┊31┊    BrowserModule,\n+┊  ┊32┊    // Material\n+┊  ┊33┊    MatToolbarModule,\n+┊  ┊34┊    MatMenuModule,\n+┊  ┊35┊    MatIconModule,\n+┊  ┊36┊    MatButtonModule,\n+┊  ┊37┊    MatListModule,\n+┊  ┊38┊    MatGridListModule,\n+┊  ┊39┊    // Animations\n+┊  ┊40┊    BrowserAnimationsModule,\n+┊  ┊41┊    // Routing\n+┊  ┊42┊    RouterModule.forChild(routes),\n+┊  ┊43┊    // Forms\n+┊  ┊44┊    FormsModule,\n+┊  ┊45┊    // Feature modules\n+┊  ┊46┊    SharedModule,\n+┊  ┊47┊  ],\n+┊  ┊48┊  providers: [\n+┊  ┊49┊    ChatsService,\n+┊  ┊50┊  ],\n+┊  ┊51┊})\n+┊  ┊52┊export class ChatViewerModule {\n+┊  ┊53┊}\n```\n\n[}]: #\n\nAs you can see, it has already everything that we might need.\n\n### GetChat operation\n\nComponents need data, so we create the `GetChat` operation and run `yarn generator`:\n\n[{]: <helper> (diffStep \"4.1\" files=\"src/graphql/getChat.query.ts\" module=\"client\")\n\n#### [Step 4.1: Chat Viewer](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/257159a)\n\n##### Added src&#x2F;graphql&#x2F;getChat.query.ts\n```diff\n@@ -0,0 +1,17 @@\n+┊  ┊ 1┊import gql from 'graphql-tag';\n+┊  ┊ 2┊import {fragments} from './fragment';\n+┊  ┊ 3┊\n+┊  ┊ 4┊// We use the gql tag to parse our query string into a query document\n+┊  ┊ 5┊export const getChatQuery = gql`\n+┊  ┊ 6┊  query GetChat($chatId: ID!) {\n+┊  ┊ 7┊    chat(chatId: $chatId) {\n+┊  ┊ 8┊      ...ChatWithoutMessages\n+┊  ┊ 9┊      messages {\n+┊  ┊10┊        ...Message\n+┊  ┊11┊      }\n+┊  ┊12┊    }\n+┊  ┊13┊  }\n+┊  ┊14┊\n+┊  ┊15┊  ${fragments['chatWithoutMessages']}\n+┊  ┊16┊  ${fragments['message']}\n+┊  ┊17┊`;\n```\n\n[}]: #\n\nThe query can be now implemented in `ChatsService`:\n\n[{]: <helper> (diffStep \"4.1\" files=\"src/app/services/chats.service.ts\" module=\"client\")\n\n#### [Step 4.1: Chat Viewer](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/257159a)\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,13 +1,14 @@\n ┊ 1┊ 1┊import {map} from 'rxjs/operators';\n ┊ 2┊ 2┊import {Injectable} from '@angular/core';\n-┊ 3┊  ┊import {GetChatsGQL} from '../../graphql';\n+┊  ┊ 3┊import {GetChatsGQL, GetChatGQL} from '../../graphql';\n ┊ 4┊ 4┊\n ┊ 5┊ 5┊@Injectable()\n ┊ 6┊ 6┊export class ChatsService {\n ┊ 7┊ 7┊  messagesAmount = 3;\n ┊ 8┊ 8┊\n ┊ 9┊ 9┊  constructor(\n-┊10┊  ┊    private getChatsGQL: GetChatsGQL\n+┊  ┊10┊    private getChatsGQL: GetChatsGQL,\n+┊  ┊11┊    private getChatGQL: GetChatGQL\n ┊11┊12┊  ) {}\n ┊12┊13┊\n ┊13┊14┊  getChats() {\n```\n```diff\n@@ -20,4 +21,16 @@\n ┊20┊21┊\n ┊21┊22┊    return {query, chats$};\n ┊22┊23┊  }\n+┊  ┊24┊\n+┊  ┊25┊  getChat(chatId: string) {\n+┊  ┊26┊    const query = this.getChatGQL.watch({\n+┊  ┊27┊      chatId: chatId,\n+┊  ┊28┊    });\n+┊  ┊29┊\n+┊  ┊30┊    const chat$ = query.valueChanges.pipe(\n+┊  ┊31┊      map((result) => result.data.chat)\n+┊  ┊32┊    );\n+┊  ┊33┊\n+┊  ┊34┊    return {query, chat$};\n+┊  ┊35┊  }\n ┊23┊36┊}\n```\n\n[}]: #\n\nGreat!\n\n### Chat view\n\nNow we've got data but a user can't still access the chat view.\nThere is one place where we're able to pick the chat, it's the list:\n\n[{]: <helper> (diffStep \"4.1\" files=\"src/app/chats-lister/components/chat-item/chat-item.component.ts, src/app/chats-lister/components/chats-list/chats-list.component.ts, src/app/chats-lister/containers/chats/chats.component.ts\" module=\"client\")\n\n#### [Step 4.1: Chat Viewer](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/257159a)\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chat-item&#x2F;chat-item.component.ts\n```diff\n@@ -1,14 +1,14 @@\n-┊ 1┊  ┊import {Component, Input} from '@angular/core';\n+┊  ┊ 1┊import {Component, EventEmitter, Input, Output} from '@angular/core';\n ┊ 2┊ 2┊import {GetChats} from '../../../../graphql';\n ┊ 3┊ 3┊\n ┊ 4┊ 4┊@Component({\n ┊ 5┊ 5┊  selector: 'app-chat-item',\n ┊ 6┊ 6┊  template: `\n-┊ 7┊  ┊    <div class=\"chat-row\">\n+┊  ┊ 7┊    <div class=\"chat-row\" (click)=\"selectChat()\">\n ┊ 8┊ 8┊      <img class=\"chat-pic\" [src]=\"chat.picture || 'assets/default-profile-pic.jpg'\">\n ┊ 9┊ 9┊      <div class=\"chat-info\">\n ┊10┊10┊        <div class=\"chat-name\">{{ chat.name }}</div>\n-┊11┊  ┊        <div class=\"chat-last-message\">{{ chat.messages?[chat.messages?.length - 1]?.content }}</div>\n+┊  ┊11┊        <div class=\"chat-last-message\">{{ chat.messages[chat.messages.length - 1]?.content }}</div>\n ┊12┊12┊        <div class=\"chat-timestamp\">00:00</div>\n ┊13┊13┊      </div>\n ┊14┊14┊    </div>\n```\n```diff\n@@ -19,4 +19,11 @@\n ┊19┊19┊  // tslint:disable-next-line:no-input-rename\n ┊20┊20┊  @Input('item')\n ┊21┊21┊  chat: GetChats.Chats;\n+┊  ┊22┊\n+┊  ┊23┊  @Output()\n+┊  ┊24┊  select = new EventEmitter<string>();\n+┊  ┊25┊\n+┊  ┊26┊  selectChat() {\n+┊  ┊27┊    this.select.emit(this.chat.id);\n+┊  ┊28┊  }\n ┊22┊29┊}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chats-list&#x2F;chats-list.component.ts\n```diff\n@@ -1,4 +1,4 @@\n-┊1┊ ┊import {Component, Input} from '@angular/core';\n+┊ ┊1┊import {Component, EventEmitter, Input, Output} from '@angular/core';\n ┊2┊2┊import {GetChats} from '../../../../graphql';\n ┊3┊3┊\n ┊4┊4┊@Component({\n```\n```diff\n@@ -6,7 +6,7 @@\n ┊ 6┊ 6┊  template: `\n ┊ 7┊ 7┊    <mat-list>\n ┊ 8┊ 8┊      <mat-list-item *ngFor=\"let chat of chats\">\n-┊ 9┊  ┊        <app-chat-item [item]=\"chat\"></app-chat-item>\n+┊  ┊ 9┊        <app-chat-item [item]=\"chat\" (select)=\"selectChat($event)\"></app-chat-item>\n ┊10┊10┊      </mat-list-item>\n ┊11┊11┊    </mat-list>\n ┊12┊12┊  `,\n```\n```diff\n@@ -17,5 +17,12 @@\n ┊17┊17┊  @Input('items')\n ┊18┊18┊  chats: GetChats.Chats[];\n ┊19┊19┊\n+┊  ┊20┊  @Output()\n+┊  ┊21┊  select = new EventEmitter<string>();\n+┊  ┊22┊\n ┊20┊23┊  constructor() {}\n+┊  ┊24┊\n+┊  ┊25┊  selectChat(id: string) {\n+┊  ┊26┊    this.select.emit(id);\n+┊  ┊27┊  }\n ┊21┊28┊}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.ts\n```diff\n@@ -2,6 +2,7 @@\n ┊2┊2┊import {ChatsService} from '../../../services/chats.service';\n ┊3┊3┊import {Observable} from 'rxjs';\n ┊4┊4┊import {GetChats} from '../../../../graphql';\n+┊ ┊5┊import {Router} from '@angular/router';\n ┊5┊6┊\n ┊6┊7┊@Component({\n ┊7┊8┊  template: `\n```\n```diff\n@@ -27,7 +28,7 @@\n ┊27┊28┊      </button>\n ┊28┊29┊    </mat-menu>\n ┊29┊30┊\n-┊30┊  ┊    <app-chats-list [items]=\"chats$ | async\"></app-chats-list>\n+┊  ┊31┊    <app-chats-list [items]=\"chats$ | async\" (select)=\"goToChat($event)\"></app-chats-list>\n ┊31┊32┊\n ┊32┊33┊    <button class=\"chat-button\" mat-fab color=\"secondary\">\n ┊33┊34┊      <mat-icon aria-label=\"Icon-button with a + icon\">chat</mat-icon>\n```\n```diff\n@@ -38,10 +39,15 @@\n ┊38┊39┊export class ChatsComponent implements OnInit {\n ┊39┊40┊  chats$: Observable<GetChats.Chats[]>;\n ┊40┊41┊\n-┊41┊  ┊  constructor(private chatsService: ChatsService) {\n+┊  ┊42┊  constructor(private chatsService: ChatsService,\n+┊  ┊43┊              private router: Router) {\n ┊42┊44┊  }\n ┊43┊45┊\n ┊44┊46┊  ngOnInit() {\n ┊45┊47┊    this.chats$ = this.chatsService.getChats().chats$;\n ┊46┊48┊  }\n+┊  ┊49┊\n+┊  ┊50┊  goToChat(chatId: string) {\n+┊  ┊51┊    this.router.navigate(['/chat', chatId]);\n+┊  ┊52┊  }\n ┊47┊53┊}\n```\n\n[}]: #\n\nTime for a next step, an actual implementation of the chat view.\n\n[{]: <helper> (diffStep \"4.1\" files=\"src/app/chat-viewer/containers/chat/chat.component.ts, src/app/chat-viewer/containers/chat/chat.component.scss\" module=\"client\")\n\n#### [Step 4.1: Chat Viewer](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/257159a)\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.scss\n```diff\n@@ -0,0 +1,33 @@\n+┊  ┊ 1┊app-toolbar {\n+┊  ┊ 2┊  .navigation {\n+┊  ┊ 3┊    padding: 0;\n+┊  ┊ 4┊    display: inherit;\n+┊  ┊ 5┊    margin-right: -40px;\n+┊  ┊ 6┊  }\n+┊  ┊ 7┊\n+┊  ┊ 8┊  .title {\n+┊  ┊ 9┊    line-height: 8vh;\n+┊  ┊10┊  }\n+┊  ┊11┊\n+┊  ┊12┊  .profile-pic {\n+┊  ┊13┊    height: calc(100% - 10px);\n+┊  ┊14┊    width: auto;\n+┊  ┊15┊    padding: 5px;\n+┊  ┊16┊    border-radius: 50%;\n+┊  ┊17┊  }\n+┊  ┊18┊}\n+┊  ┊19┊\n+┊  ┊20┊.container {\n+┊  ┊21┊  display: flex;\n+┊  ┊22┊  flex-flow: column;\n+┊  ┊23┊  justify-content: space-between;\n+┊  ┊24┊  height: calc(100vh - 8vh);\n+┊  ┊25┊  background-image: url(/assets/chat-background.jpg);\n+┊  ┊26┊  background-color: #E0DAD6;\n+┊  ┊27┊  background-repeat: no-repeat;\n+┊  ┊28┊  background-size: cover;\n+┊  ┊29┊\n+┊  ┊30┊  app-confirm-selection {\n+┊  ┊31┊    bottom: 10vh;\n+┊  ┊32┊  }\n+┊  ┊33┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.ts\n```diff\n@@ -0,0 +1,46 @@\n+┊  ┊ 1┊import {Component, OnInit} from '@angular/core';\n+┊  ┊ 2┊import {ActivatedRoute, Router} from '@angular/router';\n+┊  ┊ 3┊import {ChatsService} from '../../../services/chats.service';\n+┊  ┊ 4┊\n+┊  ┊ 5┊@Component({\n+┊  ┊ 6┊  template: `\n+┊  ┊ 7┊    <app-toolbar>\n+┊  ┊ 8┊      <button class=\"navigation\" mat-button (click)=\"goToChats()\">\n+┊  ┊ 9┊        <mat-icon aria-label=\"Icon-button with an arrow back icon\">arrow_back</mat-icon>\n+┊  ┊10┊      </button>\n+┊  ┊11┊      <img class=\"profile-pic\" src=\"assets/default-profile-pic.jpg\">\n+┊  ┊12┊      <div class=\"title\">{{ name }}</div>\n+┊  ┊13┊    </app-toolbar>\n+┊  ┊14┊    <div class=\"container\">\n+┊  ┊15┊      <app-messages-list [items]=\"messages\" [isGroup]=\"isGroup\"></app-messages-list>\n+┊  ┊16┊      <app-new-message></app-new-message>\n+┊  ┊17┊    </div>\n+┊  ┊18┊  `,\n+┊  ┊19┊  styleUrls: ['./chat.component.scss']\n+┊  ┊20┊})\n+┊  ┊21┊export class ChatComponent implements OnInit {\n+┊  ┊22┊  chatId: string;\n+┊  ┊23┊  messages: any[];\n+┊  ┊24┊  name: string;\n+┊  ┊25┊  isGroup: boolean;\n+┊  ┊26┊\n+┊  ┊27┊  constructor(private route: ActivatedRoute,\n+┊  ┊28┊              private router: Router,\n+┊  ┊29┊              private chatsService: ChatsService) {\n+┊  ┊30┊  }\n+┊  ┊31┊\n+┊  ┊32┊  ngOnInit() {\n+┊  ┊33┊    this.route.params.subscribe(({id: chatId}) => {\n+┊  ┊34┊      this.chatId = chatId;\n+┊  ┊35┊      this.chatsService.getChat(chatId).chat$.subscribe(chat => {\n+┊  ┊36┊        this.messages = chat.messages;\n+┊  ┊37┊        this.name = chat.name;\n+┊  ┊38┊        this.isGroup = chat.isGroup;\n+┊  ┊39┊      });\n+┊  ┊40┊    });\n+┊  ┊41┊  }\n+┊  ┊42┊\n+┊  ┊43┊  goToChats() {\n+┊  ┊44┊    this.router.navigate(['/chats']);\n+┊  ┊45┊  }\n+┊  ┊46┊}\n```\n\n[}]: #\n\nThe `ChatComponent` component contains:\n\n - Toolbar with chat's name and a \"go back\" button\n - List of messages sorted from oldest to newest\n - Space to submit a new message\n\n### List of messages\n\nFirst we'll download and a couple of images which will help us create a \"bubble\" effect for received messages:\n\n    $ wget https://raw.githubusercontent.com/Urigo/whatsapp-client-angularcli-material/c75c2416b1990da3588015f76b8338764f44d6ec/src/assets/chat-background.jpg -P src/assets\n    $ wget https://raw.githubusercontent.com/Urigo/whatsapp-client-angularcli-material/https://raw.githubusercontent.com/Urigo/whatsapp-client-angularcli-material/c75c2416b1990da3588015f76b8338764f44d6ec/src/assets/chat-background.jpg/src/assets/message-mine.png -P src/assets\n    $ wget https://raw.githubusercontent.com/Urigo/whatsapp-client-angularcli-material/https://raw.githubusercontent.com/Urigo/whatsapp-client-angularcli-material/c75c2416b1990da3588015f76b8338764f44d6ec/src/assets/chat-background.jpg/src/assets/message-other.png -P src/assets\n\nWe'll now split the list of messages to the host:\n\n[{]: <helper> (diffStep \"4.1\" files=\"src/app/chat-viewer/components/messages-list/messages-list.component.ts, src/app/chat-viewer/components/messages-list/messages-list.component.scss\" module=\"client\")\n\n#### [Step 4.1: Chat Viewer](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/257159a)\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;components&#x2F;messages-list&#x2F;messages-list.component.scss\n```diff\n@@ -0,0 +1,14 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊  height: 100%;\n+┊  ┊ 4┊}\n+┊  ┊ 5┊\n+┊  ┊ 6┊::ng-deep .mat-list-item-content {\n+┊  ┊ 7┊  display: block !important;\n+┊  ┊ 8┊}\n+┊  ┊ 9┊\n+┊  ┊10┊/*\n+┊  ┊11┊:host::-webkit-scrollbar {\n+┊  ┊12┊  display: none;\n+┊  ┊13┊}\n+┊  ┊14┊*/🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;components&#x2F;messages-list&#x2F;messages-list.component.ts\n```diff\n@@ -0,0 +1,23 @@\n+┊  ┊ 1┊import {Component, Input} from '@angular/core';\n+┊  ┊ 2┊\n+┊  ┊ 3┊@Component({\n+┊  ┊ 4┊  selector: 'app-messages-list',\n+┊  ┊ 5┊  template: `\n+┊  ┊ 6┊    <mat-list>\n+┊  ┊ 7┊      <mat-list-item *ngFor=\"let message of messages\">\n+┊  ┊ 8┊        <app-message-item [item]=\"message\" [isGroup]=\"isGroup\"></app-message-item>\n+┊  ┊ 9┊      </mat-list-item>\n+┊  ┊10┊    </mat-list>\n+┊  ┊11┊  `,\n+┊  ┊12┊  styleUrls: ['messages-list.component.scss'],\n+┊  ┊13┊})\n+┊  ┊14┊export class MessagesListComponent {\n+┊  ┊15┊  // tslint:disable-next-line:no-input-rename\n+┊  ┊16┊  @Input('items')\n+┊  ┊17┊  messages: any[];\n+┊  ┊18┊\n+┊  ┊19┊  @Input()\n+┊  ┊20┊  isGroup: boolean;\n+┊  ┊21┊\n+┊  ┊22┊  constructor() {}\n+┊  ┊23┊}\n```\n\n[}]: #\n\nand a reused component for each message:\n\n[{]: <helper> (diffStep \"4.1\" files=\"src/app/chat-viewer/components/message-item/message-item.component.ts, src/app/chat-viewer/components/message-item/message-item.component.scss\" module=\"client\")\n\n#### [Step 4.1: Chat Viewer](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/257159a)\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;components&#x2F;message-item&#x2F;message-item.component.scss\n```diff\n@@ -0,0 +1,66 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  margin-bottom: 9px;\n+┊  ┊ 3┊\n+┊  ┊ 4┊  &::after {\n+┊  ┊ 5┊    content: \"\";\n+┊  ┊ 6┊    display: table;\n+┊  ┊ 7┊    clear: both;\n+┊  ┊ 8┊  }\n+┊  ┊ 9┊}\n+┊  ┊10┊\n+┊  ┊11┊.message {\n+┊  ┊12┊  display: inline-block;\n+┊  ┊13┊  position: relative;\n+┊  ┊14┊  max-width: 100%;\n+┊  ┊15┊  border-radius: 7px;\n+┊  ┊16┊  box-shadow: 0 1px 2px rgba(0, 0, 0, .15);\n+┊  ┊17┊\n+┊  ┊18┊  &.message-mine {\n+┊  ┊19┊    float: right;\n+┊  ┊20┊    background-color: #DCF8C6;\n+┊  ┊21┊\n+┊  ┊22┊    &::before {\n+┊  ┊23┊      right: -11px;\n+┊  ┊24┊      background-image: url(/assets/message-mine.png)\n+┊  ┊25┊    }\n+┊  ┊26┊  }\n+┊  ┊27┊\n+┊  ┊28┊  &.message-other {\n+┊  ┊29┊    float: left;\n+┊  ┊30┊    background-color: #FFF;\n+┊  ┊31┊\n+┊  ┊32┊    &::before {\n+┊  ┊33┊      left: -11px;\n+┊  ┊34┊      background-image: url(/assets/message-other.png)\n+┊  ┊35┊    }\n+┊  ┊36┊  }\n+┊  ┊37┊\n+┊  ┊38┊  &.message-other::before, &.message-mine::before {\n+┊  ┊39┊    content: \"\";\n+┊  ┊40┊    position: absolute;\n+┊  ┊41┊    bottom: 3px;\n+┊  ┊42┊    width: 12px;\n+┊  ┊43┊    height: 19px;\n+┊  ┊44┊    background-position: 50% 50%;\n+┊  ┊45┊    background-repeat: no-repeat;\n+┊  ┊46┊    background-size: contain;\n+┊  ┊47┊  }\n+┊  ┊48┊\n+┊  ┊49┊  .message-content {\n+┊  ┊50┊    padding: 5px 7px;\n+┊  ┊51┊    word-wrap: break-word;\n+┊  ┊52┊\n+┊  ┊53┊    &::after {\n+┊  ┊54┊      content: \" \\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\";\n+┊  ┊55┊      display: inline;\n+┊  ┊56┊    }\n+┊  ┊57┊  }\n+┊  ┊58┊\n+┊  ┊59┊  .message-timestamp {\n+┊  ┊60┊    position: absolute;\n+┊  ┊61┊    bottom: 2px;\n+┊  ┊62┊    right: 7px;\n+┊  ┊63┊    color: gray;\n+┊  ┊64┊    font-size: 12px;\n+┊  ┊65┊  }\n+┊  ┊66┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;components&#x2F;message-item&#x2F;message-item.component.ts\n```diff\n@@ -0,0 +1,22 @@\n+┊  ┊ 1┊import {Component, Input} from '@angular/core';\n+┊  ┊ 2┊\n+┊  ┊ 3┊@Component({\n+┊  ┊ 4┊  selector: 'app-message-item',\n+┊  ┊ 5┊  template: `\n+┊  ┊ 6┊    <div class=\"message\"\n+┊  ┊ 7┊         [ngClass]=\"message.ownership ? 'message-mine' : 'message-other'\">\n+┊  ┊ 8┊      <div *ngIf=\"isGroup && !message.ownership\" class=\"message-sender\">{{ message.sender.name }}</div>\n+┊  ┊ 9┊      <div class=\"message-content\">{{ message.content }}</div>\n+┊  ┊10┊      <span class=\"message-timestamp\">00:00</span>\n+┊  ┊11┊    </div>\n+┊  ┊12┊  `,\n+┊  ┊13┊  styleUrls: ['message-item.component.scss'],\n+┊  ┊14┊})\n+┊  ┊15┊export class MessageItemComponent {\n+┊  ┊16┊  // tslint:disable-next-line:no-input-rename\n+┊  ┊17┊  @Input('item')\n+┊  ┊18┊  message: any;\n+┊  ┊19┊\n+┊  ┊20┊  @Input()\n+┊  ┊21┊  isGroup: boolean;\n+┊  ┊22┊}\n```\n\n[}]: #\n\nAs you see, we could easily decide which message comes from which user based on the `ownership` property.\n\n### Submit a new message\n\nThe app shows the conversation and now we're going to focus on the last part, actually emitting a new message!\n\n[{]: <helper> (diffStep \"4.1\" files=\"src/app/chat-viewer/components/new-message/new-message.component.scss, src/app/chat-viewer/components/new-message/new-message.component.ts\" module=\"client\")\n\n#### [Step 4.1: Chat Viewer](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/257159a)\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;components&#x2F;new-message&#x2F;new-message.component.scss\n```diff\n@@ -0,0 +1,32 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: flex;\n+┊  ┊ 3┊  height: 50px;\n+┊  ┊ 4┊  padding: 5px;\n+┊  ┊ 5┊}\n+┊  ┊ 6┊\n+┊  ┊ 7┊input {\n+┊  ┊ 8┊  width: 100%;\n+┊  ┊ 9┊  border: none;\n+┊  ┊10┊  border-radius: 999px;\n+┊  ┊11┊  padding: 10px;\n+┊  ┊12┊  padding-left: 20px;\n+┊  ┊13┊  padding-right: 20px;\n+┊  ┊14┊  font-size: 15px;\n+┊  ┊15┊  outline: none;\n+┊  ┊16┊  box-shadow: 0 1px silver;\n+┊  ┊17┊  font-size: 18px;\n+┊  ┊18┊  line-height: 45px;\n+┊  ┊19┊}\n+┊  ┊20┊\n+┊  ┊21┊button {\n+┊  ┊22┊  min-width: 45px;\n+┊  ┊23┊  width: 45px;\n+┊  ┊24┊  border-radius: 999px;\n+┊  ┊25┊  background-color: var(--primary);\n+┊  ┊26┊  margin-left: 5px;\n+┊  ┊27┊  color: white;\n+┊  ┊28┊\n+┊  ┊29┊  mat-icon {\n+┊  ┊30┊    margin-left: -3px;\n+┊  ┊31┊  }\n+┊  ┊32┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;components&#x2F;new-message&#x2F;new-message.component.ts\n```diff\n@@ -0,0 +1,34 @@\n+┊  ┊ 1┊import {Component, EventEmitter, Input, Output} from '@angular/core';\n+┊  ┊ 2┊\n+┊  ┊ 3┊@Component({\n+┊  ┊ 4┊  selector: 'app-new-message',\n+┊  ┊ 5┊  template: `\n+┊  ┊ 6┊    <input type=\"text\" placeholder=\"Type a message\" [(ngModel)]=\"message\" (keyup)=\"onInputKeyup($event)\"/>\n+┊  ┊ 7┊    <button mat-button (click)=\"emitMessage()\" [disabled]=\"disabled\">\n+┊  ┊ 8┊      <mat-icon aria-label=\"Icon-button with a send icon\">send</mat-icon>\n+┊  ┊ 9┊    </button>\n+┊  ┊10┊  `,\n+┊  ┊11┊  styleUrls: ['new-message.component.scss'],\n+┊  ┊12┊})\n+┊  ┊13┊export class NewMessageComponent {\n+┊  ┊14┊  @Input()\n+┊  ┊15┊  disabled: boolean;\n+┊  ┊16┊\n+┊  ┊17┊  @Output()\n+┊  ┊18┊  newMessage = new EventEmitter<string>();\n+┊  ┊19┊\n+┊  ┊20┊  message = '';\n+┊  ┊21┊\n+┊  ┊22┊  onInputKeyup({ keyCode }: KeyboardEvent) {\n+┊  ┊23┊    if (keyCode === 13) {\n+┊  ┊24┊      this.emitMessage();\n+┊  ┊25┊    }\n+┊  ┊26┊  }\n+┊  ┊27┊\n+┊  ┊28┊  emitMessage() {\n+┊  ┊29┊    if (this.message && !this.disabled) {\n+┊  ┊30┊      this.newMessage.emit(this.message);\n+┊  ┊31┊      this.message = '';\n+┊  ┊32┊    }\n+┊  ┊33┊  }\n+┊  ┊34┊}\n```\n\n[}]: #\n\nIt's not yet fully functional, we receive the message in the `ChatComponent` but we still need to send it to the server. We'll cover that in next few steps!"
          },
          {
            "manualTitle": "Step 9: Mutations",
            "stepRevision": "fcbc9a30cfdd7004eabc050189a94dad094e2ed7",
            "manualView": "In addition to fetching data using queries, Apollo also helps you handle GraphQL mutations. In GraphQL, mutations are identical to queries in syntax, the only difference being that you use the keyword mutation instead of query to indicate that the root fields on this query are going to be performing writes to the backend.\nGraphQL mutations represent two things in one query string:\n\n1. The mutation field name with arguments, which represents the actual operation to be done on the server.\n2. The fields you want back from the result of the mutation to update the client.\n\nWhen we use mutations in Apollo, the result is typically integrated into the cache automatically based on the id of the result, which in turn updates the UI automatically, so we often don't need to explicitly handle the results. In order for the client to correctly do this, we need to ensure we select the necessary fields in the result. One good strategy can be to simply ask for any fields that might have been affected by the mutation. Alternatively, you can use fragments to share the fields between a query and a mutation that updates that query.\n\n## Server\n\nFinally we're going to create our mutations in the server:\n\n[{]: <helper> (diffStep \"3.1\" module=\"server\")\n\n#### [Step 3.1: Add mutations](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/db205b7)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,6 +1,7 @@\n ┊1┊1┊import { IResolvers } from 'apollo-server-express';\n-┊2┊ ┊import { Chat, db, Message, Recipient, User } from \"../db\";\n+┊ ┊2┊import { Chat, db, Message, MessageType, Recipient, User } from \"../db\";\n ┊3┊3┊import { ChatQueryArgs } from \"../types\";\n+┊ ┊4┊import * as moment from \"moment\";\n ┊4┊5┊\n ┊5┊6┊let users = db.users;\n ┊6┊7┊let chats = db.chats;\n```\n```diff\n@@ -13,6 +14,276 @@\n ┊ 13┊ 14┊    chats: (): Chat[] => chats.filter(chat => chat.listingMemberIds.includes(currentUser)),\n ┊ 14┊ 15┊    chat: (obj: any, {chatId}: ChatQueryArgs): Chat | null => chats.find(chat => chat.id === Number(chatId)) || null,\n ┊ 15┊ 16┊  },\n+┊   ┊ 17┊  Mutation: {\n+┊   ┊ 18┊    addChat: (obj: any, {recipientId}: any): Chat => {\n+┊   ┊ 19┊      if (!users.find(user => user.id === recipientId)) {\n+┊   ┊ 20┊        throw new Error(`Recipient ${recipientId} doesn't exist.`);\n+┊   ┊ 21┊      }\n+┊   ┊ 22┊\n+┊   ┊ 23┊      const chat = chats.find(chat => !chat.name && chat.allTimeMemberIds.includes(currentUser) && chat.allTimeMemberIds.includes(recipientId));\n+┊   ┊ 24┊      if (chat) {\n+┊   ┊ 25┊        // Chat already exists. Both users are already in the allTimeMemberIds array\n+┊   ┊ 26┊        const chatId = chat.id;\n+┊   ┊ 27┊        if (!chat.listingMemberIds.includes(currentUser)) {\n+┊   ┊ 28┊          // The chat isn't listed for the current user. Add him to the memberIds\n+┊   ┊ 29┊          chat.listingMemberIds.push(currentUser);\n+┊   ┊ 30┊          chats.find(chat => chat.id === chatId)!.listingMemberIds.push(currentUser);\n+┊   ┊ 31┊          return chat;\n+┊   ┊ 32┊        } else {\n+┊   ┊ 33┊          throw new Error(`Chat already exists.`);\n+┊   ┊ 34┊        }\n+┊   ┊ 35┊      } else {\n+┊   ┊ 36┊        // Create the chat\n+┊   ┊ 37┊        const id = (chats.length && chats[chats.length - 1].id + 1) || 1;\n+┊   ┊ 38┊        const chat: Chat = {\n+┊   ┊ 39┊          id,\n+┊   ┊ 40┊          name: null,\n+┊   ┊ 41┊          picture: null,\n+┊   ┊ 42┊          adminIds: null,\n+┊   ┊ 43┊          ownerId: null,\n+┊   ┊ 44┊          allTimeMemberIds: [currentUser, recipientId],\n+┊   ┊ 45┊          // Chat will not be listed to the other user until the first message gets written\n+┊   ┊ 46┊          listingMemberIds: [currentUser],\n+┊   ┊ 47┊          actualGroupMemberIds: null,\n+┊   ┊ 48┊          messages: [],\n+┊   ┊ 49┊        };\n+┊   ┊ 50┊        chats.push(chat);\n+┊   ┊ 51┊        return chat;\n+┊   ┊ 52┊      }\n+┊   ┊ 53┊    },\n+┊   ┊ 54┊    addGroup: (obj: any, {recipientIds, groupName}: any): Chat => {\n+┊   ┊ 55┊      recipientIds.forEach((recipientId: any) => {\n+┊   ┊ 56┊        if (!users.find(user => user.id === recipientId)) {\n+┊   ┊ 57┊          throw new Error(`Recipient ${recipientId} doesn't exist.`);\n+┊   ┊ 58┊        }\n+┊   ┊ 59┊      });\n+┊   ┊ 60┊\n+┊   ┊ 61┊      const id = (chats.length && chats[chats.length - 1].id + 1) || 1;\n+┊   ┊ 62┊      const chat: Chat = {\n+┊   ┊ 63┊        id,\n+┊   ┊ 64┊        name: groupName,\n+┊   ┊ 65┊        picture: null,\n+┊   ┊ 66┊        adminIds: [currentUser],\n+┊   ┊ 67┊        ownerId: currentUser,\n+┊   ┊ 68┊        allTimeMemberIds: [currentUser, ...recipientIds],\n+┊   ┊ 69┊        listingMemberIds: [currentUser, ...recipientIds],\n+┊   ┊ 70┊        actualGroupMemberIds: [currentUser, ...recipientIds],\n+┊   ┊ 71┊        messages: [],\n+┊   ┊ 72┊      };\n+┊   ┊ 73┊      chats.push(chat);\n+┊   ┊ 74┊      return chat;\n+┊   ┊ 75┊    },\n+┊   ┊ 76┊    removeChat: (obj: any, {chatId}: any): number => {\n+┊   ┊ 77┊      const chat = chats.find(chat => chat.id === chatId);\n+┊   ┊ 78┊\n+┊   ┊ 79┊      if (!chat) {\n+┊   ┊ 80┊        throw new Error(`The chat ${chatId} doesn't exist.`);\n+┊   ┊ 81┊      }\n+┊   ┊ 82┊\n+┊   ┊ 83┊      if (!chat.name) {\n+┊   ┊ 84┊        // Chat\n+┊   ┊ 85┊        if (!chat.listingMemberIds.includes(currentUser)) {\n+┊   ┊ 86┊          throw new Error(`The user is not a member of the chat ${chatId}.`);\n+┊   ┊ 87┊        }\n+┊   ┊ 88┊\n+┊   ┊ 89┊        // Instead of chaining map and filter we can loop once using reduce\n+┊   ┊ 90┊        const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n+┊   ┊ 91┊          // Remove the current user from the message holders\n+┊   ┊ 92┊          message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser);\n+┊   ┊ 93┊\n+┊   ┊ 94┊          if (message.holderIds.length !== 0) {\n+┊   ┊ 95┊            filtered.push(message);\n+┊   ┊ 96┊          } // else discard the message\n+┊   ┊ 97┊\n+┊   ┊ 98┊          return filtered;\n+┊   ┊ 99┊        }, []);\n+┊   ┊100┊\n+┊   ┊101┊        // Remove the current user from who gets the chat listed. The chat will no longer appear in his list\n+┊   ┊102┊        const listingMemberIds = chat.listingMemberIds.filter(listingId => listingId !== currentUser);\n+┊   ┊103┊\n+┊   ┊104┊        // Check how many members are left\n+┊   ┊105┊        if (listingMemberIds.length === 0) {\n+┊   ┊106┊          // Delete the chat\n+┊   ┊107┊          chats = chats.filter(chat => chat.id !== chatId);\n+┊   ┊108┊        } else {\n+┊   ┊109┊          // Update the chat\n+┊   ┊110┊          chats = chats.map(chat => {\n+┊   ┊111┊            if (chat.id === chatId) {\n+┊   ┊112┊              chat = {...chat, listingMemberIds, messages};\n+┊   ┊113┊            }\n+┊   ┊114┊            return chat;\n+┊   ┊115┊          });\n+┊   ┊116┊        }\n+┊   ┊117┊        return chatId;\n+┊   ┊118┊      } else {\n+┊   ┊119┊        // Group\n+┊   ┊120┊        if (chat.ownerId !== currentUser) {\n+┊   ┊121┊          throw new Error(`Group ${chatId} is not owned by the user.`);\n+┊   ┊122┊        }\n+┊   ┊123┊\n+┊   ┊124┊        // Instead of chaining map and filter we can loop once using reduce\n+┊   ┊125┊        const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n+┊   ┊126┊          // Remove the current user from the message holders\n+┊   ┊127┊          message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser);\n+┊   ┊128┊\n+┊   ┊129┊          if (message.holderIds.length !== 0) {\n+┊   ┊130┊            filtered.push(message);\n+┊   ┊131┊          } // else discard the message\n+┊   ┊132┊\n+┊   ┊133┊          return filtered;\n+┊   ┊134┊        }, []);\n+┊   ┊135┊\n+┊   ┊136┊        // Remove the current user from who gets the group listed. The group will no longer appear in his list\n+┊   ┊137┊        const listingMemberIds = chat.listingMemberIds.filter(listingId => listingId !== currentUser);\n+┊   ┊138┊\n+┊   ┊139┊        // Check how many members (including previous ones who can still access old messages) are left\n+┊   ┊140┊        if (listingMemberIds.length === 0) {\n+┊   ┊141┊          // Remove the group\n+┊   ┊142┊          chats = chats.filter(chat => chat.id !== chatId);\n+┊   ┊143┊        } else {\n+┊   ┊144┊          // Update the group\n+┊   ┊145┊\n+┊   ┊146┊          // Remove the current user from the chat members. He is no longer a member of the group\n+┊   ┊147┊          const actualGroupMemberIds = chat.actualGroupMemberIds!.filter(memberId => memberId !== currentUser);\n+┊   ┊148┊          // Remove the current user from the chat admins\n+┊   ┊149┊          const adminIds = chat.adminIds!.filter(memberId => memberId !== currentUser);\n+┊   ┊150┊          // Set the owner id to be null. A null owner means the group is read-only\n+┊   ┊151┊          let ownerId: number | null = null;\n+┊   ┊152┊\n+┊   ┊153┊          // Check if there is any admin left\n+┊   ┊154┊          if (adminIds!.length) {\n+┊   ┊155┊            // Pick an admin as the new owner. The group is no longer read-only\n+┊   ┊156┊            ownerId = chat.adminIds![0];\n+┊   ┊157┊          }\n+┊   ┊158┊\n+┊   ┊159┊          chats = chats.map(chat => {\n+┊   ┊160┊            if (chat.id === chatId) {\n+┊   ┊161┊              chat = {...chat, messages, listingMemberIds, actualGroupMemberIds, adminIds, ownerId};\n+┊   ┊162┊            }\n+┊   ┊163┊            return chat;\n+┊   ┊164┊          });\n+┊   ┊165┊        }\n+┊   ┊166┊        return chatId;\n+┊   ┊167┊      }\n+┊   ┊168┊    },\n+┊   ┊169┊    addMessage: (obj: any, {chatId, content}: any): Message => {\n+┊   ┊170┊      if (content === null || content === '') {\n+┊   ┊171┊        throw new Error(`Cannot add empty or null messages.`);\n+┊   ┊172┊      }\n+┊   ┊173┊\n+┊   ┊174┊      let chat = chats.find(chat => chat.id === chatId);\n+┊   ┊175┊\n+┊   ┊176┊      if (!chat) {\n+┊   ┊177┊        throw new Error(`Cannot find chat ${chatId}.`);\n+┊   ┊178┊      }\n+┊   ┊179┊\n+┊   ┊180┊      let holderIds = chat.listingMemberIds;\n+┊   ┊181┊\n+┊   ┊182┊      if (!chat.name) {\n+┊   ┊183┊        // Chat\n+┊   ┊184┊        if (!chat.listingMemberIds.find(listingId => listingId === currentUser)) {\n+┊   ┊185┊          throw new Error(`The chat ${chatId} must be listed for the current user before adding a message.`);\n+┊   ┊186┊        }\n+┊   ┊187┊\n+┊   ┊188┊        const recipientId = chat.allTimeMemberIds.filter(userId => userId !== currentUser)[0];\n+┊   ┊189┊\n+┊   ┊190┊        if (!chat.listingMemberIds.find(listingId => listingId === recipientId)) {\n+┊   ┊191┊          // Chat is not listed for the recipient. Add him to the listingMemberIds\n+┊   ┊192┊          const listingMemberIds = chat.listingMemberIds.concat(recipientId);\n+┊   ┊193┊\n+┊   ┊194┊          chats = chats.map(chat => {\n+┊   ┊195┊            if (chat.id === chatId) {\n+┊   ┊196┊              chat = {...chat, listingMemberIds};\n+┊   ┊197┊            }\n+┊   ┊198┊            return chat;\n+┊   ┊199┊          });\n+┊   ┊200┊\n+┊   ┊201┊          holderIds = listingMemberIds;\n+┊   ┊202┊        }\n+┊   ┊203┊      } else {\n+┊   ┊204┊        // Group\n+┊   ┊205┊        if (!chat.actualGroupMemberIds!.find(memberId => memberId === currentUser)) {\n+┊   ┊206┊          throw new Error(`The user is not a member of the group ${chatId}. Cannot add message.`);\n+┊   ┊207┊        }\n+┊   ┊208┊\n+┊   ┊209┊        holderIds = chat.actualGroupMemberIds!;\n+┊   ┊210┊      }\n+┊   ┊211┊\n+┊   ┊212┊      const id = (chat.messages.length && chat.messages[chat.messages.length - 1].id + 1) || 1;\n+┊   ┊213┊\n+┊   ┊214┊      let recipients: Recipient[] = [];\n+┊   ┊215┊\n+┊   ┊216┊      holderIds.forEach(holderId => {\n+┊   ┊217┊        if (holderId !== currentUser) {\n+┊   ┊218┊          recipients.push({\n+┊   ┊219┊            userId: holderId,\n+┊   ┊220┊            messageId: id,\n+┊   ┊221┊            chatId: chatId,\n+┊   ┊222┊            receivedAt: null,\n+┊   ┊223┊            readAt: null,\n+┊   ┊224┊          });\n+┊   ┊225┊        }\n+┊   ┊226┊      });\n+┊   ┊227┊\n+┊   ┊228┊      const message: Message = {\n+┊   ┊229┊        id,\n+┊   ┊230┊        chatId,\n+┊   ┊231┊        senderId: currentUser,\n+┊   ┊232┊        content,\n+┊   ┊233┊        createdAt: moment().unix(),\n+┊   ┊234┊        type: MessageType.TEXT,\n+┊   ┊235┊        recipients,\n+┊   ┊236┊        holderIds,\n+┊   ┊237┊      };\n+┊   ┊238┊\n+┊   ┊239┊      chats = chats.map(chat => {\n+┊   ┊240┊        if (chat.id === chatId) {\n+┊   ┊241┊          chat = {...chat, messages: chat.messages.concat(message)}\n+┊   ┊242┊        }\n+┊   ┊243┊        return chat;\n+┊   ┊244┊      });\n+┊   ┊245┊\n+┊   ┊246┊      return message;\n+┊   ┊247┊    },\n+┊   ┊248┊    removeMessages: (obj: any, {chatId, messageIds, all}: any): number[] => {\n+┊   ┊249┊      const chat = chats.find(chat => chat.id === chatId);\n+┊   ┊250┊\n+┊   ┊251┊      if (!chat) {\n+┊   ┊252┊        throw new Error(`Cannot find chat ${chatId}.`);\n+┊   ┊253┊      }\n+┊   ┊254┊\n+┊   ┊255┊      if (!chat.listingMemberIds.find(listingId => listingId === currentUser)) {\n+┊   ┊256┊        throw new Error(`The chat/group ${chatId} is not listed for the current user, so there is nothing to delete.`);\n+┊   ┊257┊      }\n+┊   ┊258┊\n+┊   ┊259┊      if (all && messageIds) {\n+┊   ┊260┊        throw new Error(`Cannot specify both 'all' and 'messageIds'.`);\n+┊   ┊261┊      }\n+┊   ┊262┊\n+┊   ┊263┊      let deletedIds: number[] = [];\n+┊   ┊264┊      chats = chats.map(chat => {\n+┊   ┊265┊        if (chat.id === chatId) {\n+┊   ┊266┊          // Instead of chaining map and filter we can loop once using reduce\n+┊   ┊267┊          const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n+┊   ┊268┊            if (all || messageIds!.includes(message.id)) {\n+┊   ┊269┊              deletedIds.push(message.id);\n+┊   ┊270┊              // Remove the current user from the message holders\n+┊   ┊271┊              message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser);\n+┊   ┊272┊            }\n+┊   ┊273┊\n+┊   ┊274┊            if (message.holderIds.length !== 0) {\n+┊   ┊275┊              filtered.push(message);\n+┊   ┊276┊            } // else discard the message\n+┊   ┊277┊\n+┊   ┊278┊            return filtered;\n+┊   ┊279┊          }, []);\n+┊   ┊280┊          chat = {...chat, messages};\n+┊   ┊281┊        }\n+┊   ┊282┊        return chat;\n+┊   ┊283┊      });\n+┊   ┊284┊      return deletedIds;\n+┊   ┊285┊    },\n+┊   ┊286┊  },\n ┊ 16┊287┊  Chat: {\n ┊ 17┊288┊    name: (chat: Chat): string => chat.name ? chat.name : users\n ┊ 18┊289┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser))!.name,\n```\n\n##### Changed schema&#x2F;typeDefs.ts\n```diff\n@@ -65,4 +65,20 @@\n ┊65┊65┊    picture: String\n ┊66┊66┊    phone: String\n ┊67┊67┊  }\n+┊  ┊68┊\n+┊  ┊69┊  type Mutation {\n+┊  ┊70┊    addChat(recipientId: ID!): Chat\n+┊  ┊71┊    addGroup(recipientIds: [ID!]!, groupName: String!): Chat\n+┊  ┊72┊    removeChat(chatId: ID!): ID\n+┊  ┊73┊    addMessage(chatId: ID!, content: String!): Message\n+┊  ┊74┊    removeMessages(chatId: ID!, messageIds: [ID], all: Boolean): [ID]\n+┊  ┊75┊    addMembers(groupId: ID!, userIds: [ID!]!): [ID]\n+┊  ┊76┊    removeMembers(groupId: ID!, userIds: [ID!]!): [ID]\n+┊  ┊77┊    addAdmins(groupId: ID!, userIds: [ID!]!): [ID]\n+┊  ┊78┊    removeAdmins(groupId: ID!, userIds: [ID!]!): [ID]\n+┊  ┊79┊    setGroupName(groupId: ID!): String\n+┊  ┊80┊    setGroupPicture(groupId: ID!): String\n+┊  ┊81┊    markAsReceived(chatId: ID!): Boolean\n+┊  ┊82┊    markAsRead(chatId: ID!): Boolean\n+┊  ┊83┊  }\n ┊68┊84┊`;\n```\n\n[}]: #\n\nLet me briefly explain what's going on here.\nFor each chat/group we store the `allTimeMemberIds`, `listingMemberIds` and `actualGroupMemberIds` properties in our NoSQL-like fake db.\nWhat's the difference between `allTimeMemberIds` and `listingMemberIds`? When a chat gets created only the user who created it will be able too see it, the chat will be displayed to the other user only once the first messaged gets sent. `allTimeMemberIds` is an array which always contain both the users, while `listingMemberIds` contains only the users which get the chat listed (initially the creator, later both users). `actualGroupMemberIds` is only used for groups.\nGroups, instead, get listed by all members immediately since the creation. So initially both `allTimeMemberIds`, `listingMemberIds` and `actualGroupMemberIds` are similar. Later users can leave the group or get deleted (so they will be removed from `actualGroupMemberIds`) but they will still be able to list the group in read-only mode, thus remaining in the `listingMemberIds`. Once they remove the group they will also be remove from the `listingMemberIds` array.\nThat's why we have to check for several different conditions before adding/deleting messages: it could be necessary to add the other peer to the `listingMemberIds` (for example if we are writing the first message of a chat) or it could be necessary to physically remove the messages instead of simply removing the current user from the `holderIds`. `holderIds` is a field in each message which states which user will currently display that specific message. In fact each user can delete a specific message without affecting what the others will see. Once there will be no more users in the `holderIds` array it will be safe to delete the message.\nEach message has also a `recipients` array containing the receiving date and the viewing date of that particular message for all the other users. That's necessary to implement the single, double and blue ticks used by the real Whatsapp.\n\nIt may seem a bit overwhelming at first, but you should keep in mind that the real Whatsapp has tons of features and also takes advantage of a local database to store messages, so it's easier for them to implement features like per-user messages: their source of truth is not the server because once downloaded the messages are kept in the client itself, so deleting messages doesn't affect anyone else. On the contrary our source of truth is the server, so our approach is more similar to Telegram instead. This is a better approach in my opinion because it allows us to show the messages for the same user on multiple clients, instead of having to rely on questionable approaches like Whatsapp Web.\nAlso we already implemented our mutations to take care of future use cases (like reading notifications) which we still didn't implement.\n\nI said we were going to take greater advantage of `graphql-code-generator` once we started writing our first mutation and I'm going to show you why. Let's run the generator first:\n\n    yarn generator\n\nThen let's use the generated types:\n\n[{]: <helper> (diffStep \"3.3\" module=\"server\")\n\n#### [Step 3.3: Use generated types](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/b7b1be3)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,6 +1,9 @@\n ┊1┊1┊import { IResolvers } from 'apollo-server-express';\n ┊2┊2┊import { Chat, db, Message, MessageType, Recipient, User } from \"../db\";\n-┊3┊ ┊import { ChatQueryArgs } from \"../types\";\n+┊ ┊3┊import {\n+┊ ┊4┊  AddChatMutationArgs, AddGroupMutationArgs, AddMessageMutationArgs, ChatQueryArgs,\n+┊ ┊5┊  RemoveChatMutationArgs, RemoveMessagesMutationArgs\n+┊ ┊6┊} from \"../types\";\n ┊4┊7┊import * as moment from \"moment\";\n ┊5┊8┊\n ┊6┊9┊let users = db.users;\n```\n```diff\n@@ -15,12 +18,12 @@\n ┊15┊18┊    chat: (obj: any, {chatId}: ChatQueryArgs): Chat | null => chats.find(chat => chat.id === Number(chatId)) || null,\n ┊16┊19┊  },\n ┊17┊20┊  Mutation: {\n-┊18┊  ┊    addChat: (obj: any, {recipientId}: any): Chat => {\n-┊19┊  ┊      if (!users.find(user => user.id === recipientId)) {\n+┊  ┊21┊    addChat: (obj: any, {recipientId}: AddChatMutationArgs): Chat => {\n+┊  ┊22┊      if (!users.find(user => user.id === Number(recipientId))) {\n ┊20┊23┊        throw new Error(`Recipient ${recipientId} doesn't exist.`);\n ┊21┊24┊      }\n ┊22┊25┊\n-┊23┊  ┊      const chat = chats.find(chat => !chat.name && chat.allTimeMemberIds.includes(currentUser) && chat.allTimeMemberIds.includes(recipientId));\n+┊  ┊26┊      const chat = chats.find(chat => !chat.name && chat.allTimeMemberIds.includes(currentUser) && chat.allTimeMemberIds.includes(Number(recipientId)));\n ┊24┊27┊      if (chat) {\n ┊25┊28┊        // Chat already exists. Both users are already in the allTimeMemberIds array\n ┊26┊29┊        const chatId = chat.id;\n```\n```diff\n@@ -41,7 +44,7 @@\n ┊41┊44┊          picture: null,\n ┊42┊45┊          adminIds: null,\n ┊43┊46┊          ownerId: null,\n-┊44┊  ┊          allTimeMemberIds: [currentUser, recipientId],\n+┊  ┊47┊          allTimeMemberIds: [currentUser, Number(recipientId)],\n ┊45┊48┊          // Chat will not be listed to the other user until the first message gets written\n ┊46┊49┊          listingMemberIds: [currentUser],\n ┊47┊50┊          actualGroupMemberIds: null,\n```\n```diff\n@@ -51,9 +54,9 @@\n ┊51┊54┊        return chat;\n ┊52┊55┊      }\n ┊53┊56┊    },\n-┊54┊  ┊    addGroup: (obj: any, {recipientIds, groupName}: any): Chat => {\n-┊55┊  ┊      recipientIds.forEach((recipientId: any) => {\n-┊56┊  ┊        if (!users.find(user => user.id === recipientId)) {\n+┊  ┊57┊    addGroup: (obj: any, {recipientIds, groupName}: AddGroupMutationArgs): Chat => {\n+┊  ┊58┊      recipientIds.forEach(recipientId => {\n+┊  ┊59┊        if (!users.find(user => user.id === Number(recipientId))) {\n ┊57┊60┊          throw new Error(`Recipient ${recipientId} doesn't exist.`);\n ┊58┊61┊        }\n ┊59┊62┊      });\n```\n```diff\n@@ -65,16 +68,16 @@\n ┊65┊68┊        picture: null,\n ┊66┊69┊        adminIds: [currentUser],\n ┊67┊70┊        ownerId: currentUser,\n-┊68┊  ┊        allTimeMemberIds: [currentUser, ...recipientIds],\n-┊69┊  ┊        listingMemberIds: [currentUser, ...recipientIds],\n-┊70┊  ┊        actualGroupMemberIds: [currentUser, ...recipientIds],\n+┊  ┊71┊        allTimeMemberIds: [currentUser, ...recipientIds.map(id => Number(id))],\n+┊  ┊72┊        listingMemberIds: [currentUser, ...recipientIds.map(id => Number(id))],\n+┊  ┊73┊        actualGroupMemberIds: [currentUser, ...recipientIds.map(id => Number(id))],\n ┊71┊74┊        messages: [],\n ┊72┊75┊      };\n ┊73┊76┊      chats.push(chat);\n ┊74┊77┊      return chat;\n ┊75┊78┊    },\n-┊76┊  ┊    removeChat: (obj: any, {chatId}: any): number => {\n-┊77┊  ┊      const chat = chats.find(chat => chat.id === chatId);\n+┊  ┊79┊    removeChat: (obj: any, {chatId}: RemoveChatMutationArgs): number => {\n+┊  ┊80┊      const chat = chats.find(chat => chat.id === Number(chatId));\n ┊78┊81┊\n ┊79┊82┊      if (!chat) {\n ┊80┊83┊        throw new Error(`The chat ${chatId} doesn't exist.`);\n```\n```diff\n@@ -104,17 +107,17 @@\n ┊104┊107┊        // Check how many members are left\n ┊105┊108┊        if (listingMemberIds.length === 0) {\n ┊106┊109┊          // Delete the chat\n-┊107┊   ┊          chats = chats.filter(chat => chat.id !== chatId);\n+┊   ┊110┊          chats = chats.filter(chat => chat.id !== Number(chatId));\n ┊108┊111┊        } else {\n ┊109┊112┊          // Update the chat\n ┊110┊113┊          chats = chats.map(chat => {\n-┊111┊   ┊            if (chat.id === chatId) {\n+┊   ┊114┊            if (chat.id === Number(chatId)) {\n ┊112┊115┊              chat = {...chat, listingMemberIds, messages};\n ┊113┊116┊            }\n ┊114┊117┊            return chat;\n ┊115┊118┊          });\n ┊116┊119┊        }\n-┊117┊   ┊        return chatId;\n+┊   ┊120┊        return Number(chatId);\n ┊118┊121┊      } else {\n ┊119┊122┊        // Group\n ┊120┊123┊        if (chat.ownerId !== currentUser) {\n```\n```diff\n@@ -139,7 +142,7 @@\n ┊139┊142┊        // Check how many members (including previous ones who can still access old messages) are left\n ┊140┊143┊        if (listingMemberIds.length === 0) {\n ┊141┊144┊          // Remove the group\n-┊142┊   ┊          chats = chats.filter(chat => chat.id !== chatId);\n+┊   ┊145┊          chats = chats.filter(chat => chat.id !== Number(chatId));\n ┊143┊146┊        } else {\n ┊144┊147┊          // Update the group\n ┊145┊148┊\n```\n```diff\n@@ -157,21 +160,21 @@\n ┊157┊160┊          }\n ┊158┊161┊\n ┊159┊162┊          chats = chats.map(chat => {\n-┊160┊   ┊            if (chat.id === chatId) {\n+┊   ┊163┊            if (chat.id === Number(chatId)) {\n ┊161┊164┊              chat = {...chat, messages, listingMemberIds, actualGroupMemberIds, adminIds, ownerId};\n ┊162┊165┊            }\n ┊163┊166┊            return chat;\n ┊164┊167┊          });\n ┊165┊168┊        }\n-┊166┊   ┊        return chatId;\n+┊   ┊169┊        return Number(chatId);\n ┊167┊170┊      }\n ┊168┊171┊    },\n-┊169┊   ┊    addMessage: (obj: any, {chatId, content}: any): Message => {\n+┊   ┊172┊    addMessage: (obj: any, {chatId, content}: AddMessageMutationArgs): Message => {\n ┊170┊173┊      if (content === null || content === '') {\n ┊171┊174┊        throw new Error(`Cannot add empty or null messages.`);\n ┊172┊175┊      }\n ┊173┊176┊\n-┊174┊   ┊      let chat = chats.find(chat => chat.id === chatId);\n+┊   ┊177┊      let chat = chats.find(chat => chat.id === Number(chatId));\n ┊175┊178┊\n ┊176┊179┊      if (!chat) {\n ┊177┊180┊        throw new Error(`Cannot find chat ${chatId}.`);\n```\n```diff\n@@ -192,7 +195,7 @@\n ┊192┊195┊          const listingMemberIds = chat.listingMemberIds.concat(recipientId);\n ┊193┊196┊\n ┊194┊197┊          chats = chats.map(chat => {\n-┊195┊   ┊            if (chat.id === chatId) {\n+┊   ┊198┊            if (chat.id === Number(chatId)) {\n ┊196┊199┊              chat = {...chat, listingMemberIds};\n ┊197┊200┊            }\n ┊198┊201┊            return chat;\n```\n```diff\n@@ -218,7 +221,7 @@\n ┊218┊221┊          recipients.push({\n ┊219┊222┊            userId: holderId,\n ┊220┊223┊            messageId: id,\n-┊221┊   ┊            chatId: chatId,\n+┊   ┊224┊            chatId: Number(chatId),\n ┊222┊225┊            receivedAt: null,\n ┊223┊226┊            readAt: null,\n ┊224┊227┊          });\n```\n```diff\n@@ -227,7 +230,7 @@\n ┊227┊230┊\n ┊228┊231┊      const message: Message = {\n ┊229┊232┊        id,\n-┊230┊   ┊        chatId,\n+┊   ┊233┊        chatId: Number(chatId),\n ┊231┊234┊        senderId: currentUser,\n ┊232┊235┊        content,\n ┊233┊236┊        createdAt: moment().unix(),\n```\n```diff\n@@ -237,7 +240,7 @@\n ┊237┊240┊      };\n ┊238┊241┊\n ┊239┊242┊      chats = chats.map(chat => {\n-┊240┊   ┊        if (chat.id === chatId) {\n+┊   ┊243┊        if (chat.id === Number(chatId)) {\n ┊241┊244┊          chat = {...chat, messages: chat.messages.concat(message)}\n ┊242┊245┊        }\n ┊243┊246┊        return chat;\n```\n```diff\n@@ -245,8 +248,8 @@\n ┊245┊248┊\n ┊246┊249┊      return message;\n ┊247┊250┊    },\n-┊248┊   ┊    removeMessages: (obj: any, {chatId, messageIds, all}: any): number[] => {\n-┊249┊   ┊      const chat = chats.find(chat => chat.id === chatId);\n+┊   ┊251┊    removeMessages: (obj: any, {chatId, messageIds, all}: RemoveMessagesMutationArgs): number[] => {\n+┊   ┊252┊      const chat = chats.find(chat => chat.id === Number(chatId));\n ┊250┊253┊\n ┊251┊254┊      if (!chat) {\n ┊252┊255┊        throw new Error(`Cannot find chat ${chatId}.`);\n```\n```diff\n@@ -262,10 +265,10 @@\n ┊262┊265┊\n ┊263┊266┊      let deletedIds: number[] = [];\n ┊264┊267┊      chats = chats.map(chat => {\n-┊265┊   ┊        if (chat.id === chatId) {\n+┊   ┊268┊        if (chat.id === Number(chatId)) {\n ┊266┊269┊          // Instead of chaining map and filter we can loop once using reduce\n ┊267┊270┊          const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n-┊268┊   ┊            if (all || messageIds!.includes(message.id)) {\n+┊   ┊271┊            if (all || messageIds!.includes(String(message.id))) {\n ┊269┊272┊              deletedIds.push(message.id);\n ┊270┊273┊              // Remove the current user from the message holders\n ┊271┊274┊              message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser);\n```\n\n[}]: #\n\n## Client\n\nFor the client I'll only show you how to make use of the addMessage mutation in this chapters. The other mutations will require much more boilerplate so I left them for their own chapter.\n\nLet's start by wiring the addMessage mutation. We're going to write the GraphQL query and then use the generator to generate the types:\n\n[{]: <helper> (diffStep \"5.1\" files=\"^\\(?!src/types.d.ts$\\).*\" module=\"client\")\n\n#### [Step 5.1: Create addMessage mutation and generate types](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/706d62e)\n\n##### Changed src&#x2F;graphql.ts\n```diff\n@@ -600,6 +600,20 @@\n ┊600┊600┊  > = Resolver<R, Parent, Context>;\n ┊601┊601┊}\n ┊602┊602┊\n+┊   ┊603┊export namespace AddMessage {\n+┊   ┊604┊  export type Variables = {\n+┊   ┊605┊    chatId: string;\n+┊   ┊606┊    content: string;\n+┊   ┊607┊  };\n+┊   ┊608┊\n+┊   ┊609┊  export type Mutation = {\n+┊   ┊610┊    __typename?: \"Mutation\";\n+┊   ┊611┊    addMessage?: AddMessage | null;\n+┊   ┊612┊  };\n+┊   ┊613┊\n+┊   ┊614┊  export type AddMessage = Message.Fragment;\n+┊   ┊615┊}\n+┊   ┊616┊\n ┊603┊617┊export namespace GetChat {\n ┊604┊618┊  export type Variables = {\n ┊605┊619┊    chatId: string;\n```\n```diff\n@@ -760,6 +774,23 @@\n ┊760┊774┊  }\n ┊761┊775┊`;\n ┊762┊776┊\n+┊   ┊777┊@Injectable({\n+┊   ┊778┊  providedIn: \"root\"\n+┊   ┊779┊})\n+┊   ┊780┊export class AddMessageGQL extends Apollo.Mutation<\n+┊   ┊781┊  AddMessage.Mutation,\n+┊   ┊782┊  AddMessage.Variables\n+┊   ┊783┊> {\n+┊   ┊784┊  document: any = gql`\n+┊   ┊785┊    mutation AddMessage($chatId: ID!, $content: String!) {\n+┊   ┊786┊      addMessage(chatId: $chatId, content: $content) {\n+┊   ┊787┊        ...Message\n+┊   ┊788┊      }\n+┊   ┊789┊    }\n+┊   ┊790┊\n+┊   ┊791┊    ${MessageFragment}\n+┊   ┊792┊  `;\n+┊   ┊793┊}\n ┊763┊794┊@Injectable({\n ┊764┊795┊  providedIn: \"root\"\n ┊765┊796┊})\n```\n\n##### Added src&#x2F;graphql&#x2F;addMessage.mutation.ts\n```diff\n@@ -0,0 +1,13 @@\n+┊  ┊ 1┊import gql from 'graphql-tag';\n+┊  ┊ 2┊import {fragments} from './fragment';\n+┊  ┊ 3┊\n+┊  ┊ 4┊// We use the gql tag to parse our query string into a query document\n+┊  ┊ 5┊export const addMessageMutation = gql`\n+┊  ┊ 6┊  mutation AddMessage($chatId: ID!, $content: String!) {\n+┊  ┊ 7┊    addMessage(chatId: $chatId, content: $content) {\n+┊  ┊ 8┊      ...Message\n+┊  ┊ 9┊    }\n+┊  ┊10┊  }\n+┊  ┊11┊\n+┊  ┊12┊  ${fragments['message']}\n+┊  ┊13┊`;\n```\n\n[}]: #\n\nRun the generator:\n\n    yarn generator\n\nNow let's use the just-created query:\n\n[{]: <helper> (diffStep \"5.2\" module=\"client\")\n\n#### [Step 5.2: Modify chat component and service](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/ad6a5da)\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.ts\n```diff\n@@ -14,7 +14,7 @@\n ┊14┊14┊    </app-toolbar>\n ┊15┊15┊    <div class=\"container\">\n ┊16┊16┊      <app-messages-list [items]=\"messages\" [isGroup]=\"isGroup\"></app-messages-list>\n-┊17┊  ┊      <app-new-message></app-new-message>\n+┊  ┊17┊      <app-new-message (newMessage)=\"addMessage($event)\"></app-new-message>\n ┊18┊18┊    </div>\n ┊19┊19┊  `,\n ┊20┊20┊  styleUrls: ['./chat.component.scss']\n```\n```diff\n@@ -44,4 +44,8 @@\n ┊44┊44┊  goToChats() {\n ┊45┊45┊    this.router.navigate(['/chats']);\n ┊46┊46┊  }\n+┊  ┊47┊\n+┊  ┊48┊  addMessage(content: string) {\n+┊  ┊49┊    this.chatsService.addMessage(this.chatId, content).subscribe();\n+┊  ┊50┊  }\n ┊47┊51┊}\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,6 +1,6 @@\n ┊1┊1┊import {map} from 'rxjs/operators';\n ┊2┊2┊import {Injectable} from '@angular/core';\n-┊3┊ ┊import {GetChatsGQL, GetChatGQL} from '../../graphql';\n+┊ ┊3┊import {GetChatsGQL, GetChatGQL, AddMessageGQL} from '../../graphql';\n ┊4┊4┊\n ┊5┊5┊@Injectable()\n ┊6┊6┊export class ChatsService {\n```\n```diff\n@@ -8,7 +8,8 @@\n ┊ 8┊ 8┊\n ┊ 9┊ 9┊  constructor(\n ┊10┊10┊    private getChatsGQL: GetChatsGQL,\n-┊11┊  ┊    private getChatGQL: GetChatGQL\n+┊  ┊11┊    private getChatGQL: GetChatGQL,\n+┊  ┊12┊    private addMessageGQL: AddMessageGQL\n ┊12┊13┊  ) {}\n ┊13┊14┊\n ┊14┊15┊  getChats() {\n```\n```diff\n@@ -33,4 +34,11 @@\n ┊33┊34┊\n ┊34┊35┊    return {query, chat$};\n ┊35┊36┊  }\n+┊  ┊37┊\n+┊  ┊38┊  addMessage(chatId: string, content: string) {\n+┊  ┊39┊    return this.addMessageGQL.mutate({\n+┊  ┊40┊      chatId,\n+┊  ┊41┊      content,\n+┊  ┊42┊    });\n+┊  ┊43┊  }\n ┊36┊44┊}\n```\n\n[}]: #\n\nIt's that simple! You would be tempted to say that it doesn't work, but you should try to refresh the page first ;)"
          },
          {
            "manualTitle": "Step 10: Updating the store",
            "stepRevision": "04749f21bfdeecb76145491e1d4d373102ad8969",
            "manualView": "## Client\n\nDid you notice that after creating a new message you'll have to refresh the page in order to see it?\n\nHow to fix that?\n\nApollo performs two important core tasks which we covered in one of previous steps: executing queries and mutations, and caching the results.\n\nThanks to Apollo's store design, it's possible for the results of a query or mutation to update your UI in all the right places. In many cases it's possible for that to happen automatically, whereas in others you need to help the client out a little in doing so.\n\nThere are couple of APIs to update the cache after mutation:\n\n- `refetchQueries` - is the most straightforward way of updating the cache. You request queries to be executed once again.\n- `update` - super flexible and allows you to make changes to the store based on mutation. Works well with Optimistic UI which we will cover later.\n- `updateQueries` - It works similar to the previous option but the API may be deprecated in the future and we recommend to stay with `update`.\n\nIf you thought about re-querying the server you would be wrong! The best solution is to use the response provided by the server to update our Apollo local cache.\n\nOf course that we're going to use the `update` API!\n\n### Updating the store\n\nAs you can see, the `update` option is a function that has two arguments:\n\n- `DataProxy` which we named `store`\n- mutation's result\n\nThe `DataProxy` seems very interesting! It's a middleman between you and the cache.\n\n#### How to update fragments\n\nIn pretty much every case, that middleman would allow to write and read data. Take for example the JavaScript `Map` object.\n\nIt has a `get` and `set` methods and both works based on a `key`.\n\nIn Apollo, we do have that key, it's something that was covered in the 5th step, remember? An object of type `Message` with an `id` would be stored in the cache as `Message:<id>`.\n\nLet's call that small object a fragment, for simplicity.\n\nWhat are our _get_ and _set_ methods in Apollo's DataProxy? Simple, `readFragment` and `writeFragment`.\n\nI think it's time to work on a simple example. Scenario: every message can be liked and we keep the sum of likes under the `likes` field.\n\nHow to give a like?\n\n```typescript\nconst store: DataProxy = ...;\nconst messageId = 256;\n\nconst fragment = gql`\n  fragment M on Message {\n    likes\n  }\n`;\nconst fragmentId = `Message:${messageId}`;\n\nconst message = store.readFragment({\n  fragment,\n  id: fragmentId\n});\n\nstore.writeFragment({\n  fragment,\n  id: fragmentId,\n  data: {\n    likes: message.likes + 1\n  }\n});\n```\n\nWhat just happened?!\n\nAt first, it might seem weird to talk to the store like that but you will see that it makes a lot of sense!\n\n - `messageId` - defined the actual id of our message\n - `fragment` - it's a document that tells Apollo what fields we want to read and write\n - `fragmentId` - an unique key under which the fragment is stored (we covered that in 5th step)\n - `readFragment` - reads the fragment in the store and returns the result in exact same shape as requested\n - `writeFragment` - accepts same properties as `readFragment` but also the `data` property\n\n### How to update queries\n\nSimilar as in case of fragments, we update queries with `readQuery` and `writeQuery`.\n\nWe won't cover the same thing again but let's just look at the API based on our WhatsApp clone example:\n\n[{]: <helper> (diffStep \"6.1\" module=\"client\")\n\n#### [Step 6.1: Update the store](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/cb01e16)\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,6 +1,13 @@\n ┊ 1┊ 1┊import {map} from 'rxjs/operators';\n ┊ 2┊ 2┊import {Injectable} from '@angular/core';\n-┊ 3┊  ┊import {GetChatsGQL, GetChatGQL, AddMessageGQL} from '../../graphql';\n+┊  ┊ 3┊import {\n+┊  ┊ 4┊  GetChatsGQL,\n+┊  ┊ 5┊  GetChatGQL,\n+┊  ┊ 6┊  AddMessageGQL,\n+┊  ┊ 7┊  AddMessage,\n+┊  ┊ 8┊  GetChats,\n+┊  ┊ 9┊  GetChat\n+┊  ┊10┊} from '../../graphql';\n ┊ 4┊11┊\n ┊ 5┊12┊@Injectable()\n ┊ 6┊13┊export class ChatsService {\n```\n```diff\n@@ -39,6 +46,50 @@\n ┊39┊46┊    return this.addMessageGQL.mutate({\n ┊40┊47┊      chatId,\n ┊41┊48┊      content,\n+┊  ┊49┊    }, {\n+┊  ┊50┊      update: (store, { data: { addMessage } }: {data: AddMessage.Mutation}) => {\n+┊  ┊51┊        // Update the messages cache\n+┊  ┊52┊        {\n+┊  ┊53┊          // Read the data from our cache for this query.\n+┊  ┊54┊          const {chat} = store.readQuery<GetChat.Query, GetChat.Variables>({\n+┊  ┊55┊            query: this.getChatGQL.document,\n+┊  ┊56┊            variables: {\n+┊  ┊57┊              chatId,\n+┊  ┊58┊            }\n+┊  ┊59┊          });\n+┊  ┊60┊          // Add our message from the mutation to the end.\n+┊  ┊61┊          chat.messages.push(addMessage);\n+┊  ┊62┊          // Write our data back to the cache.\n+┊  ┊63┊          store.writeQuery({\n+┊  ┊64┊            query: this.getChatGQL.document,\n+┊  ┊65┊            data: {\n+┊  ┊66┊              chat\n+┊  ┊67┊            }\n+┊  ┊68┊          });\n+┊  ┊69┊        }\n+┊  ┊70┊        // Update last message cache\n+┊  ┊71┊        {\n+┊  ┊72┊          // Read the data from our cache for this query.\n+┊  ┊73┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n+┊  ┊74┊            query: this.getChatsGQL.document,\n+┊  ┊75┊            variables: {\n+┊  ┊76┊              amount: this.messagesAmount,\n+┊  ┊77┊            },\n+┊  ┊78┊          });\n+┊  ┊79┊          // Add our comment from the mutation to the end.\n+┊  ┊80┊          chats.find(chat => chat.id === chatId).messages.push(addMessage);\n+┊  ┊81┊          // Write our data back to the cache.\n+┊  ┊82┊          store.writeQuery<GetChats.Query, GetChats.Variables>({\n+┊  ┊83┊            query: this.getChatsGQL.document,\n+┊  ┊84┊            variables: {\n+┊  ┊85┊              amount: this.messagesAmount,\n+┊  ┊86┊            },\n+┊  ┊87┊            data: {\n+┊  ┊88┊              chats,\n+┊  ┊89┊            },\n+┊  ┊90┊          });\n+┊  ┊91┊        }\n+┊  ┊92┊      }\n ┊42┊93┊    });\n ┊43┊94┊  }\n ┊44┊95┊}\n```\n\n[}]: #\n\nAs you can see we used the `document` property of a generated GQL service. It contains the actual query that is used in every `watch` or `fetch` calls of the GQL service. It's a part of the open API.\n\n### Keep on mind\n\nIt's very important to know few things:\n\n- update function have to run synchronously\n- the query should always match the query you want to update (even order of fields or variables matters)\n- by updating a query you also update every normalized data it has (we called them fragments in few secions above)\n\nWhen Apollo runs the `update` function? In two cases, rigth after the mutation happens but only if it has an optimistic response defined, and also once we get the response from the server.\n\n> Optimistic Resposne is something we will cover in next steps but so you know, Apollo allows to optimistically update the store with a temporary data that is being replaced right after we get the response from the server.\n\nBut why the update function has to run synchornously? It's by design and not so interesting. We won't cover it in-depth here but in short, when Apollo runs the function it switches the store with the new, empty one, to record every change that's made by the function to later merge it with the original store. If you still have questions, please let us know so we can cover that thing in-depth as a blog post or even a separate chapter in that tutorial.\n\n### Summary\n\nNow you won't need to reload the page in order to see the new message. What's even more interesting is that the message you wrote would also be shown as the last message in the chats list, just hit the back button in the top-left corner to find out!\n\nThis is because we updated our store for both the `GetChat` and the `GetChats` query."
          },
          {
            "manualTitle": "Step 11: Messages and chats removal",
            "stepRevision": "d924471909e13cc56a0bf23311554f1e7413130f",
            "manualView": "## Client\n\nSince we're now familiar with the way mutations work, it's time to add messages and chats removal to our list of features!\nSince the most annoying part is going to be dealing with the user interface (because a multiple selection started by a press event is involved), I created an Angular directive to ease the process.\n\nLet's start by adding `ngx-selectable-list`:\n\n    yarn add ngx-selectable-list\n\n[{]: <helper> (diffStep \"7.1\" module=\"client\")\n\n#### [Step 7.1: Add SelectableListModule](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/5ef06d0)\n\n##### Changed package.json\n```diff\n@@ -34,7 +34,8 @@\n ┊34┊34┊    \"graphql-tag\": \"2.10.0\",\n ┊35┊35┊    \"graphql\": \"14.0.2\",\n ┊36┊36┊    \"hammerjs\": \"2.0.8\",\n-┊37┊  ┊    \"ng2-truncate\": \"1.3.17\"\n+┊  ┊37┊    \"ng2-truncate\": \"1.3.17\",\n+┊  ┊38┊    \"ngx-selectable-list\": \"1.2.1\"\n ┊38┊39┊  },\n ┊39┊40┊  \"devDependencies\": {\n ┊40┊41┊    \"@angular-devkit/build-angular\": \"0.9.0-rc.2\",\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;chats-lister.module.ts\n```diff\n@@ -11,6 +11,7 @@\n ┊11┊11┊import {ChatsListComponent} from './components/chats-list/chats-list.component';\n ┊12┊12┊import {TruncateModule} from 'ng2-truncate';\n ┊13┊13┊import {SharedModule} from '../shared/shared.module';\n+┊  ┊14┊import {NgxSelectableListModule} from 'ngx-selectable-list';\n ┊14┊15┊\n ┊15┊16┊const routes: Routes = [\n ┊16┊17┊  {path: '', redirectTo: 'chats', pathMatch: 'full'},\n```\n```diff\n@@ -40,6 +41,7 @@\n ┊40┊41┊    TruncateModule,\n ┊41┊42┊    // Feature modules\n ┊42┊43┊    SharedModule,\n+┊  ┊44┊    NgxSelectableListModule,\n ┊43┊45┊  ],\n ┊44┊46┊  providers: [\n ┊45┊47┊    ChatsService,\n```\n\n[}]: #\n\nBecause we're going to use the `libSelectableList` directive, we can replace Outputs and EventEmitters with it:\n\n[{]: <helper> (diffStep \"7.2\" files=\"src/app/chats-lister/components/chat-item/chat-item.component.ts, src/app/chats-lister/components/chats-list/chats-list.component.ts, src/app/chat-viewer/components/messages-list/messages-list.component.ts\" module=\"client\")\n\n#### [Step 7.2: Remove messages and chats](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/18cfa7c)\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;components&#x2F;messages-list&#x2F;messages-list.component.ts\n```diff\n@@ -1,14 +1,17 @@\n ┊ 1┊ 1┊import {Component, Input} from '@angular/core';\n ┊ 2┊ 2┊import {GetChat} from '../../../../graphql';\n+┊  ┊ 3┊import {SelectableListDirective} from 'ngx-selectable-list';\n ┊ 3┊ 4┊\n ┊ 4┊ 5┊@Component({\n ┊ 5┊ 6┊  selector: 'app-messages-list',\n ┊ 6┊ 7┊  template: `\n ┊ 7┊ 8┊    <mat-list>\n ┊ 8┊ 9┊      <mat-list-item *ngFor=\"let message of messages\">\n-┊ 9┊  ┊        <app-message-item [item]=\"message\" [isGroup]=\"isGroup\"></app-message-item>\n+┊  ┊10┊        <app-message-item [item]=\"message\" [isGroup]=\"isGroup\"\n+┊  ┊11┊                          libSelectableItem></app-message-item>\n ┊10┊12┊      </mat-list-item>\n ┊11┊13┊    </mat-list>\n+┊  ┊14┊    <ng-content *ngIf=\"selectableListDirective.selecting\"></ng-content>\n ┊12┊15┊  `,\n ┊13┊16┊  styleUrls: ['messages-list.component.scss'],\n ┊14┊17┊})\n```\n```diff\n@@ -20,5 +23,5 @@\n ┊20┊23┊  @Input()\n ┊21┊24┊  isGroup: boolean;\n ┊22┊25┊\n-┊23┊  ┊  constructor() {}\n+┊  ┊26┊  constructor(public selectableListDirective: SelectableListDirective) {}\n ┊24┊27┊}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chat-item&#x2F;chat-item.component.ts\n```diff\n@@ -4,7 +4,7 @@\n ┊ 4┊ 4┊@Component({\n ┊ 5┊ 5┊  selector: 'app-chat-item',\n ┊ 6┊ 6┊  template: `\n-┊ 7┊  ┊    <div class=\"chat-row\" (click)=\"selectChat()\">\n+┊  ┊ 7┊    <div class=\"chat-row\">\n ┊ 8┊ 8┊      <img class=\"chat-pic\" [src]=\"chat.picture || 'assets/default-profile-pic.jpg'\">\n ┊ 9┊ 9┊      <div class=\"chat-info\">\n ┊10┊10┊        <div class=\"chat-name\">{{ chat.name }}</div>\n```\n```diff\n@@ -19,11 +19,4 @@\n ┊19┊19┊  // tslint:disable-next-line:no-input-rename\n ┊20┊20┊  @Input('item')\n ┊21┊21┊  chat: GetChats.Chats;\n-┊22┊  ┊\n-┊23┊  ┊  @Output()\n-┊24┊  ┊  select = new EventEmitter<string>();\n-┊25┊  ┊\n-┊26┊  ┊  selectChat() {\n-┊27┊  ┊    this.select.emit(this.chat.id);\n-┊28┊  ┊  }\n ┊29┊22┊}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chats-list&#x2F;chats-list.component.ts\n```diff\n@@ -1,14 +1,17 @@\n-┊ 1┊  ┊import {Component, EventEmitter, Input, Output} from '@angular/core';\n+┊  ┊ 1┊import {Component, Input} from '@angular/core';\n ┊ 2┊ 2┊import {GetChats} from '../../../../graphql';\n+┊  ┊ 3┊import {SelectableListDirective} from 'ngx-selectable-list';\n ┊ 3┊ 4┊\n ┊ 4┊ 5┊@Component({\n ┊ 5┊ 6┊  selector: 'app-chats-list',\n ┊ 6┊ 7┊  template: `\n ┊ 7┊ 8┊    <mat-list>\n ┊ 8┊ 9┊      <mat-list-item *ngFor=\"let chat of chats\">\n-┊ 9┊  ┊        <app-chat-item [item]=\"chat\" (select)=\"selectChat($event)\"></app-chat-item>\n+┊  ┊10┊        <app-chat-item [item]=\"chat\"\n+┊  ┊11┊                       libSelectableItem></app-chat-item>\n ┊10┊12┊      </mat-list-item>\n ┊11┊13┊    </mat-list>\n+┊  ┊14┊    <ng-content *ngIf=\"selectableListDirective.selecting\"></ng-content>\n ┊12┊15┊  `,\n ┊13┊16┊  styleUrls: ['chats-list.component.scss'],\n ┊14┊17┊})\n```\n```diff\n@@ -17,12 +20,5 @@\n ┊17┊20┊  @Input('items')\n ┊18┊21┊  chats: GetChats.Chats[];\n ┊19┊22┊\n-┊20┊  ┊  @Output()\n-┊21┊  ┊  select = new EventEmitter<string>();\n-┊22┊  ┊\n-┊23┊  ┊  constructor() {}\n-┊24┊  ┊\n-┊25┊  ┊  selectChat(id: string) {\n-┊26┊  ┊    this.select.emit(id);\n-┊27┊  ┊  }\n+┊  ┊23┊  constructor(public selectableListDirective: SelectableListDirective) {}\n ┊28┊24┊}\n```\n\n[}]: #\n\nDon't forget to add the `NgxSelectableListModule` to `ChatViewer` and `ChatLister` modules.\n\nWe also created a `ConfirmSelectionComponent` to use for content projection, since our selectable list directive will be able to listen to its events.\n\n[{]: <helper> (diffStep \"7.2\" files=\"src/app/shared/components/confirm-selection/confirm-selection.component.scss, src/app/shared/components/confirm-selection/confirm-selection.component.ts, src/app/shared/shared.module.ts\" module=\"client\")\n\n#### [Step 7.2: Remove messages and chats](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/18cfa7c)\n\n##### Added src&#x2F;app&#x2F;shared&#x2F;components&#x2F;confirm-selection&#x2F;confirm-selection.component.scss\n```diff\n@@ -0,0 +1,6 @@\n+┊ ┊1┊:host {\n+┊ ┊2┊  display: block;\n+┊ ┊3┊  position: absolute;\n+┊ ┊4┊  bottom: 5vw;\n+┊ ┊5┊  right: 5vw;\n+┊ ┊6┊}\n```\n\n##### Added src&#x2F;app&#x2F;shared&#x2F;components&#x2F;confirm-selection&#x2F;confirm-selection.component.ts\n```diff\n@@ -0,0 +1,21 @@\n+┊  ┊ 1┊import {Component, EventEmitter, Input, Output} from '@angular/core';\n+┊  ┊ 2┊\n+┊  ┊ 3┊@Component({\n+┊  ┊ 4┊  selector: 'app-confirm-selection',\n+┊  ┊ 5┊  template: `\n+┊  ┊ 6┊    <button mat-fab color=\"primary\" (click)=\"handleClick()\">\n+┊  ┊ 7┊      <mat-icon aria-label=\"Icon-button\">{{ icon }}</mat-icon>\n+┊  ┊ 8┊    </button>\n+┊  ┊ 9┊  `,\n+┊  ┊10┊  styleUrls: ['./confirm-selection.component.scss'],\n+┊  ┊11┊})\n+┊  ┊12┊export class ConfirmSelectionComponent {\n+┊  ┊13┊  @Input()\n+┊  ┊14┊  icon = 'delete';\n+┊  ┊15┊  @Output()\n+┊  ┊16┊  emitClick = new EventEmitter<null>();\n+┊  ┊17┊\n+┊  ┊18┊  handleClick() {\n+┊  ┊19┊    this.emitClick.emit();\n+┊  ┊20┊  }\n+┊  ┊21┊}\n```\n\n##### Changed src&#x2F;app&#x2F;shared&#x2F;shared.module.ts\n```diff\n@@ -1,19 +1,23 @@\n ┊ 1┊ 1┊import {BrowserModule} from '@angular/platform-browser';\n ┊ 2┊ 2┊import {NgModule} from '@angular/core';\n ┊ 3┊ 3┊\n-┊ 4┊  ┊import {MatToolbarModule} from '@angular/material';\n+┊  ┊ 4┊import {MatButtonModule, MatIconModule, MatToolbarModule} from '@angular/material';\n ┊ 5┊ 5┊import {ToolbarComponent} from './components/toolbar/toolbar.component';\n ┊ 6┊ 6┊import {FormsModule} from '@angular/forms';\n ┊ 7┊ 7┊import {BrowserAnimationsModule} from '@angular/platform-browser/animations';\n+┊  ┊ 8┊import {ConfirmSelectionComponent} from './components/confirm-selection/confirm-selection.component';\n ┊ 8┊ 9┊\n ┊ 9┊10┊@NgModule({\n ┊10┊11┊  declarations: [\n ┊11┊12┊    ToolbarComponent,\n+┊  ┊13┊    ConfirmSelectionComponent,\n ┊12┊14┊  ],\n ┊13┊15┊  imports: [\n ┊14┊16┊    BrowserModule,\n ┊15┊17┊    // Material\n ┊16┊18┊    MatToolbarModule,\n+┊  ┊19┊    MatIconModule,\n+┊  ┊20┊    MatButtonModule,\n ┊17┊21┊    // Animations\n ┊18┊22┊    BrowserAnimationsModule,\n ┊19┊23┊    // Forms\n```\n```diff\n@@ -22,6 +26,7 @@\n ┊22┊26┊  providers: [],\n ┊23┊27┊  exports: [\n ┊24┊28┊    ToolbarComponent,\n+┊  ┊29┊    ConfirmSelectionComponent,\n ┊25┊30┊  ],\n ┊26┊31┊})\n ┊27┊32┊export class SharedModule {\n```\n\n[}]: #\n\nGreat, let's finish the component part by adding the connection between our container components and the `ChatsService`. We're going to use `removeMessages` and `removeChat` methods.\n\n[{]: <helper> (diffStep \"7.2\" files=\"src/app/chat-viewer/containers/chat/chat.component.ts, src/app/chat-viewer/containers/chat/chat.component.spec.ts, src/app/chats-lister/containers/chats/chats.component.ts, src/app/chats-lister/containers/chats/chats.component.spec.ts\" module=\"client\")\n\n#### [Step 7.2: Remove messages and chats](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/18cfa7c)\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.spec.ts\n```diff\n@@ -20,6 +20,7 @@\n ┊20┊20┊  APOLLO_TESTING_CACHE,\n ┊21┊21┊} from 'apollo-angular/testing';\n ┊22┊22┊import { InMemoryCache } from 'apollo-cache-inmemory';\n+┊  ┊23┊import { NgxSelectableListModule } from 'ngx-selectable-list';\n ┊23┊24┊\n ┊24┊25┊import { dataIdFromObject } from '../../../graphql.module';\n ┊25┊26┊import { ChatComponent } from './chat.component';\n```\n```diff\n@@ -116,6 +117,7 @@\n ┊116┊117┊        SharedModule,\n ┊117┊118┊        ApolloTestingModule,\n ┊118┊119┊        RouterTestingModule,\n+┊   ┊120┊        NgxSelectableListModule,\n ┊119┊121┊      ],\n ┊120┊122┊      providers: [\n ┊121┊123┊        ChatsService,\n```\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.ts\n```diff\n@@ -13,7 +13,10 @@\n ┊13┊13┊      <div class=\"title\">{{ name }}</div>\n ┊14┊14┊    </app-toolbar>\n ┊15┊15┊    <div class=\"container\">\n-┊16┊  ┊      <app-messages-list [items]=\"messages\" [isGroup]=\"isGroup\"></app-messages-list>\n+┊  ┊16┊      <app-messages-list [items]=\"messages\" [isGroup]=\"isGroup\"\n+┊  ┊17┊                         libSelectableList=\"multiple_press\" (multiple)=\"deleteMessages($event)\">\n+┊  ┊18┊        <app-confirm-selection #confirmSelection></app-confirm-selection>\n+┊  ┊19┊      </app-messages-list>\n ┊17┊20┊      <app-new-message (newMessage)=\"addMessage($event)\"></app-new-message>\n ┊18┊21┊    </div>\n ┊19┊22┊  `,\n```\n```diff\n@@ -48,4 +51,8 @@\n ┊48┊51┊  addMessage(content: string) {\n ┊49┊52┊    this.chatsService.addMessage(this.chatId, content).subscribe();\n ┊50┊53┊  }\n+┊  ┊54┊\n+┊  ┊55┊  deleteMessages(messageIds: string[]) {\n+┊  ┊56┊    this.chatsService.removeMessages(this.chatId, this.messages, messageIds).subscribe();\n+┊  ┊57┊  }\n ┊51┊58┊}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.spec.ts\n```diff\n@@ -16,6 +16,7 @@\n ┊16┊16┊import { InMemoryCache } from 'apollo-cache-inmemory';\n ┊17┊17┊import { By } from '@angular/platform-browser';\n ┊18┊18┊import { RouterTestingModule } from '@angular/router/testing';\n+┊  ┊19┊import { NgxSelectableListModule } from 'ngx-selectable-list';\n ┊19┊20┊\n ┊20┊21┊import { GetChats } from '../../../../graphql';\n ┊21┊22┊import { dataIdFromObject } from '../../../graphql.module';\n```\n```diff\n@@ -334,6 +335,7 @@\n ┊334┊335┊        TruncateModule,\n ┊335┊336┊        ApolloTestingModule,\n ┊336┊337┊        RouterTestingModule,\n+┊   ┊338┊        NgxSelectableListModule,\n ┊337┊339┊      ],\n ┊338┊340┊      providers: [\n ┊339┊341┊        ChatsService,\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.ts\n```diff\n@@ -28,9 +28,13 @@\n ┊28┊28┊      </button>\n ┊29┊29┊    </mat-menu>\n ┊30┊30┊\n-┊31┊  ┊    <app-chats-list [items]=\"chats$ | async\" (select)=\"goToChat($event)\"></app-chats-list>\n+┊  ┊31┊    <app-chats-list [items]=\"chats$ | async\"\n+┊  ┊32┊                    libSelectableList=\"both\"\n+┊  ┊33┊                    (single)=\"goToChat($event)\" (multiple)=\"deleteChats($event)\" (isSelecting)=\"isSelecting = $event\">\n+┊  ┊34┊      <app-confirm-selection #confirmSelection></app-confirm-selection>\n+┊  ┊35┊    </app-chats-list>\n ┊32┊36┊\n-┊33┊  ┊    <button class=\"chat-button\" mat-fab color=\"secondary\">\n+┊  ┊37┊    <button *ngIf=\"!isSelecting\" class=\"chat-button\" mat-fab color=\"secondary\">\n ┊34┊38┊      <mat-icon aria-label=\"Icon-button with a + icon\">chat</mat-icon>\n ┊35┊39┊    </button>\n ┊36┊40┊  `,\n```\n```diff\n@@ -38,6 +42,7 @@\n ┊38┊42┊})\n ┊39┊43┊export class ChatsComponent implements OnInit {\n ┊40┊44┊  chats$: Observable<GetChats.Chats[]>;\n+┊  ┊45┊  isSelecting = false;\n ┊41┊46┊\n ┊42┊47┊  constructor(private chatsService: ChatsService,\n ┊43┊48┊              private router: Router) {\n```\n```diff\n@@ -50,4 +55,10 @@\n ┊50┊55┊  goToChat(chatId: string) {\n ┊51┊56┊    this.router.navigate(['/chat', chatId]);\n ┊52┊57┊  }\n+┊  ┊58┊\n+┊  ┊59┊  deleteChats(chatIds: string[]) {\n+┊  ┊60┊    chatIds.forEach(chatId => {\n+┊  ┊61┊      this.chatsService.removeChat(chatId).subscribe();\n+┊  ┊62┊    });\n+┊  ┊63┊  }\n ┊53┊64┊}\n```\n\n[}]: #\n\n### Connecting actions with the server\n\nThe UI part is pretty much complete but we still need to implement two methods in the `ChatsService`. We're going to create mutations to remove a chat, selected messages or all of them.\n\n[{]: <helper> (diffStep \"7.2\" files=\"src/graphql/removeChat.mutation.ts, src/graphql/removeMessages.mutation.ts, src/graphql/removeAllMessages.mutation.ts\" module=\"client\")\n\n#### [Step 7.2: Remove messages and chats](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/18cfa7c)\n\n##### Added src&#x2F;graphql&#x2F;removeAllMessages.mutation.ts\n```diff\n@@ -0,0 +1,8 @@\n+┊ ┊1┊import gql from 'graphql-tag';\n+┊ ┊2┊\n+┊ ┊3┊// We use the gql tag to parse our query string into a query document\n+┊ ┊4┊export const removeAllMessagesMutation = gql`\n+┊ ┊5┊  mutation RemoveAllMessages($chatId: ID!, $all: Boolean) {\n+┊ ┊6┊    removeMessages(chatId: $chatId, all: $all)\n+┊ ┊7┊  }\n+┊ ┊8┊`;\n```\n\n##### Added src&#x2F;graphql&#x2F;removeChat.mutation.ts\n```diff\n@@ -0,0 +1,8 @@\n+┊ ┊1┊import gql from 'graphql-tag';\n+┊ ┊2┊\n+┊ ┊3┊// We use the gql tag to parse our query string into a query document\n+┊ ┊4┊export const removeChatMutation = gql`\n+┊ ┊5┊  mutation RemoveChat($chatId: ID!) {\n+┊ ┊6┊    removeChat(chatId: $chatId)\n+┊ ┊7┊  }\n+┊ ┊8┊`;\n```\n\n##### Added src&#x2F;graphql&#x2F;removeMessages.mutation.ts\n```diff\n@@ -0,0 +1,8 @@\n+┊ ┊1┊import gql from 'graphql-tag';\n+┊ ┊2┊\n+┊ ┊3┊// We use the gql tag to parse our query string into a query document\n+┊ ┊4┊export const removeMessagesMutation = gql`\n+┊ ┊5┊  mutation RemoveMessages($chatId: ID!, $messageIds: [ID]) {\n+┊ ┊6┊    removeMessages(chatId: $chatId, messageIds: $messageIds)\n+┊ ┊7┊  }\n+┊ ┊8┊`;\n```\n\n[}]: #\n\nOnce again, we run the GraphQL Code Generator to get the GQL services:\n\n    yarn generator\n\nNow we can import those services, create `removeChat` and `removeMessages` methods in which we call a mutation.\n\n[{]: <helper> (diffStep \"7.2\" files=\"src/app/services/chats.service.ts\" module=\"client\")\n\n#### [Step 7.2: Remove messages and chats](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/18cfa7c)\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -4,10 +4,16 @@\n ┊ 4┊ 4┊  GetChatsGQL,\n ┊ 5┊ 5┊  GetChatGQL,\n ┊ 6┊ 6┊  AddMessageGQL,\n+┊  ┊ 7┊  RemoveChatGQL,\n+┊  ┊ 8┊  RemoveMessagesGQL,\n+┊  ┊ 9┊  RemoveAllMessagesGQL,\n ┊ 7┊10┊  AddMessage,\n ┊ 8┊11┊  GetChats,\n-┊ 9┊  ┊  GetChat\n+┊  ┊12┊  GetChat,\n+┊  ┊13┊  RemoveMessages,\n+┊  ┊14┊  RemoveAllMessages,\n ┊10┊15┊} from '../../graphql';\n+┊  ┊16┊import { DataProxy } from 'apollo-cache';\n ┊11┊17┊\n ┊12┊18┊@Injectable()\n ┊13┊19┊export class ChatsService {\n```\n```diff\n@@ -16,7 +22,10 @@\n ┊16┊22┊  constructor(\n ┊17┊23┊    private getChatsGQL: GetChatsGQL,\n ┊18┊24┊    private getChatGQL: GetChatGQL,\n-┊19┊  ┊    private addMessageGQL: AddMessageGQL\n+┊  ┊25┊    private addMessageGQL: AddMessageGQL,\n+┊  ┊26┊    private removeChatGQL: RemoveChatGQL,\n+┊  ┊27┊    private removeMessagesGQL: RemoveMessagesGQL,\n+┊  ┊28┊    private removeAllMessagesGQL: RemoveAllMessagesGQL,\n ┊20┊29┊  ) {}\n ┊21┊30┊\n ┊22┊31┊  getChats() {\n```\n```diff\n@@ -92,4 +101,112 @@\n ┊ 92┊101┊      }\n ┊ 93┊102┊    });\n ┊ 94┊103┊  }\n+┊   ┊104┊\n+┊   ┊105┊  removeChat(chatId: string) {\n+┊   ┊106┊    return this.removeChatGQL.mutate(\n+┊   ┊107┊      {\n+┊   ┊108┊        chatId,\n+┊   ┊109┊      }, {\n+┊   ┊110┊        update: (store, { data: { removeChat } }) => {\n+┊   ┊111┊          // Read the data from our cache for this query.\n+┊   ┊112┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊113┊            query: this.getChatsGQL.document,\n+┊   ┊114┊            variables: {\n+┊   ┊115┊              amount: this.messagesAmount,\n+┊   ┊116┊            },\n+┊   ┊117┊          });\n+┊   ┊118┊          // Remove the chat (mutable)\n+┊   ┊119┊          for (const index of chats.keys()) {\n+┊   ┊120┊            if (chats[index].id === removeChat) {\n+┊   ┊121┊              chats.splice(index, 1);\n+┊   ┊122┊            }\n+┊   ┊123┊          }\n+┊   ┊124┊          // Write our data back to the cache.\n+┊   ┊125┊          store.writeQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊126┊            query: this.getChatsGQL.document,\n+┊   ┊127┊            variables: {\n+┊   ┊128┊              amount: this.messagesAmount,\n+┊   ┊129┊            },\n+┊   ┊130┊            data: {\n+┊   ┊131┊              chats,\n+┊   ┊132┊            },\n+┊   ┊133┊          });\n+┊   ┊134┊        },\n+┊   ┊135┊      }\n+┊   ┊136┊    );\n+┊   ┊137┊  }\n+┊   ┊138┊\n+┊   ┊139┊  removeMessages(chatId: string, messages: GetChat.Messages[], messageIdsOrAll: string[] | boolean) {\n+┊   ┊140┊    let ids: string[] = [];\n+┊   ┊141┊\n+┊   ┊142┊    const options = {\n+┊   ┊143┊      update: (store: DataProxy, { data: { removeMessages } }: {data: RemoveMessages.Mutation | RemoveAllMessages.Mutation}) => {\n+┊   ┊144┊        // Update the messages cache\n+┊   ┊145┊        {\n+┊   ┊146┊          // Read the data from our cache for this query.\n+┊   ┊147┊          const {chat} = store.readQuery<GetChat.Query, GetChat.Variables>({\n+┊   ┊148┊            query: this.getChatGQL.document,\n+┊   ┊149┊            variables: {\n+┊   ┊150┊              chatId,\n+┊   ┊151┊            }\n+┊   ┊152┊          });\n+┊   ┊153┊          // Remove the messages (mutable)\n+┊   ┊154┊          removeMessages.forEach(messageId => {\n+┊   ┊155┊            for (const index of chat.messages.keys()) {\n+┊   ┊156┊              if (chat.messages[index].id === messageId) {\n+┊   ┊157┊                chat.messages.splice(index, 1);\n+┊   ┊158┊              }\n+┊   ┊159┊            }\n+┊   ┊160┊          });\n+┊   ┊161┊          // Write our data back to the cache.\n+┊   ┊162┊          store.writeQuery<GetChat.Query, GetChat.Variables>({\n+┊   ┊163┊            query: this.getChatGQL.document,\n+┊   ┊164┊            data: {\n+┊   ┊165┊              chat\n+┊   ┊166┊            }\n+┊   ┊167┊          });\n+┊   ┊168┊        }\n+┊   ┊169┊        // Update last message cache\n+┊   ┊170┊        {\n+┊   ┊171┊          // Read the data from our cache for this query.\n+┊   ┊172┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊173┊            query: this.getChatsGQL.document,\n+┊   ┊174┊            variables: {\n+┊   ┊175┊              amount: this.messagesAmount,\n+┊   ┊176┊            },\n+┊   ┊177┊          });\n+┊   ┊178┊          // Fix last message\n+┊   ┊179┊          chats.find(chat => chat.id === chatId).messages = messages\n+┊   ┊180┊            .filter(message => !ids.includes(message.id))\n+┊   ┊181┊            .sort((a, b) => Number(b.createdAt) - Number(a.createdAt)) || [];\n+┊   ┊182┊          // Write our data back to the cache.\n+┊   ┊183┊          store.writeQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊184┊            query: this.getChatsGQL.document,\n+┊   ┊185┊            variables: {\n+┊   ┊186┊              amount: this.messagesAmount,\n+┊   ┊187┊            },\n+┊   ┊188┊            data: {\n+┊   ┊189┊              chats,\n+┊   ┊190┊            },\n+┊   ┊191┊          });\n+┊   ┊192┊        }\n+┊   ┊193┊      }\n+┊   ┊194┊    };\n+┊   ┊195┊\n+┊   ┊196┊    if (typeof messageIdsOrAll === 'boolean') {\n+┊   ┊197┊      ids = messages.map(message => message.id);\n+┊   ┊198┊\n+┊   ┊199┊      return this.removeAllMessagesGQL.mutate({\n+┊   ┊200┊        chatId,\n+┊   ┊201┊        all: messageIdsOrAll\n+┊   ┊202┊      }, options);\n+┊   ┊203┊    } else {\n+┊   ┊204┊      ids = messageIdsOrAll;\n+┊   ┊205┊\n+┊   ┊206┊      return this.removeMessagesGQL.mutate({\n+┊   ┊207┊        chatId,\n+┊   ┊208┊        messageIds: messageIdsOrAll,\n+┊   ┊209┊      }, options);\n+┊   ┊210┊    }\n+┊   ┊211┊  }\n ┊ 95┊212┊}\n```\n\n[}]: #\n\nIt might seem like a lot but we simply just updating the store there.\n\n### Summary\n\nThe selectable list directive supports much more different use cases, for info please read the documentation.\n\nAs you can see `ngx-selectable-list` takes care of most of the boilerplate, giving us the freedom to concentrate on the actual code."
          },
          {
            "manualTitle": "Step 12: Chats creation",
            "stepRevision": "ee69029ee3985a5b2d46874694315646d04e5cd0",
            "manualView": "![new-chat](https://user-images.githubusercontent.com/7648874/49270347-ea25ea00-f4a3-11e8-98ac-f67de8bfd8d5.png)\n\n![new-group](https://user-images.githubusercontent.com/7648874/49270350-ec884400-f4a3-11e8-8baa-b6bba0f7f539.png)\n\nWe still cannot create new chats or groups, so let's implement it.\n\nWe're going to create a `ChatsCreation` module, with a `NewChat` and a `NewGroup` containers, along with several presentational components.\n\nWe're going to make use of the selectable list directive once again, to ease selecting the users when we're creating a new group.\nYou should also notice that we are looking for existing chats before creating a new one: if it already exists we're simply redirecting to that chat instead of creating a new one (the server wouldn't allow that anyway and it will simply\nreturn the chat id).\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/graphql/\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n##### Added src&#x2F;graphql&#x2F;addChat.mutation.ts\n```diff\n@@ -0,0 +1,17 @@\n+┊  ┊ 1┊import gql from 'graphql-tag';\n+┊  ┊ 2┊import {fragments} from './fragment';\n+┊  ┊ 3┊\n+┊  ┊ 4┊// We use the gql tag to parse our query string into a query document\n+┊  ┊ 5┊export const addChatMutation = gql`\n+┊  ┊ 6┊  mutation AddChat($recipientId: ID!) {\n+┊  ┊ 7┊    addChat(recipientId: $recipientId) {\n+┊  ┊ 8┊      ...ChatWithoutMessages\n+┊  ┊ 9┊      messages {\n+┊  ┊10┊        ...Message\n+┊  ┊11┊      }\n+┊  ┊12┊    }\n+┊  ┊13┊  }\n+┊  ┊14┊\n+┊  ┊15┊  ${fragments['chatWithoutMessages']}\n+┊  ┊16┊  ${fragments['message']}\n+┊  ┊17┊`;\n```\n\n##### Added src&#x2F;graphql&#x2F;addGroup.mutation.ts\n```diff\n@@ -0,0 +1,17 @@\n+┊  ┊ 1┊import gql from 'graphql-tag';\n+┊  ┊ 2┊import {fragments} from './fragment';\n+┊  ┊ 3┊\n+┊  ┊ 4┊// We use the gql tag to parse our query string into a query document\n+┊  ┊ 5┊export const addGroupMutation = gql`\n+┊  ┊ 6┊  mutation AddGroup($recipientIds: [ID!]!, $groupName: String!) {\n+┊  ┊ 7┊    addGroup(recipientIds: $recipientIds, groupName: $groupName) {\n+┊  ┊ 8┊      ...ChatWithoutMessages\n+┊  ┊ 9┊      messages {\n+┊  ┊10┊        ...Message\n+┊  ┊11┊      }\n+┊  ┊12┊    }\n+┊  ┊13┊  }\n+┊  ┊14┊\n+┊  ┊15┊  ${fragments['chatWithoutMessages']}\n+┊  ┊16┊  ${fragments['message']}\n+┊  ┊17┊`;\n```\n\n##### Added src&#x2F;graphql&#x2F;getUsers.query.ts\n```diff\n@@ -0,0 +1,12 @@\n+┊  ┊ 1┊import gql from 'graphql-tag';\n+┊  ┊ 2┊\n+┊  ┊ 3┊// We use the gql tag to parse our query string into a query document\n+┊  ┊ 4┊export const getUsersQuery = gql`\n+┊  ┊ 5┊  query GetUsers {\n+┊  ┊ 6┊    users {\n+┊  ┊ 7┊      id,\n+┊  ┊ 8┊      name,\n+┊  ┊ 9┊      picture,\n+┊  ┊10┊    }\n+┊  ┊11┊  }\n+┊  ┊12┊`;\n```\n\n[}]: #\n\nAfter creating the mutations we should run the generator to create the corresponding types and services:\n\n    yarn generator\n\nLet's jump straight into `ChatsService` and add few new methods:\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/app/services/chats.service.ts\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,5 +1,7 @@\n ┊1┊1┊import {map} from 'rxjs/operators';\n ┊2┊2┊import {Injectable} from '@angular/core';\n+┊ ┊3┊import {Observable} from 'rxjs';\n+┊ ┊4┊import {QueryRef} from 'apollo-angular';\n ┊3┊5┊import {\n ┊4┊6┊  GetChatsGQL,\n ┊5┊7┊  GetChatGQL,\n```\n```diff\n@@ -7,6 +9,9 @@\n ┊ 7┊ 9┊  RemoveChatGQL,\n ┊ 8┊10┊  RemoveMessagesGQL,\n ┊ 9┊11┊  RemoveAllMessagesGQL,\n+┊  ┊12┊  GetUsersGQL,\n+┊  ┊13┊  AddChatGQL,\n+┊  ┊14┊  AddGroupGQL,\n ┊10┊15┊  AddMessage,\n ┊11┊16┊  GetChats,\n ┊12┊17┊  GetChat,\n```\n```diff\n@@ -15,9 +20,14 @@\n ┊15┊20┊} from '../../graphql';\n ┊16┊21┊import { DataProxy } from 'apollo-cache';\n ┊17┊22┊\n+┊  ┊23┊const currentUserId = '1';\n+┊  ┊24┊\n ┊18┊25┊@Injectable()\n ┊19┊26┊export class ChatsService {\n ┊20┊27┊  messagesAmount = 3;\n+┊  ┊28┊  getChatsWq: QueryRef<GetChats.Query, GetChats.Variables>;\n+┊  ┊29┊  chats$: Observable<GetChats.Chats[]>;\n+┊  ┊30┊  chats: GetChats.Chats[];\n ┊21┊31┊\n ┊22┊32┊  constructor(\n ┊23┊33┊    private getChatsGQL: GetChatsGQL,\n```\n```diff\n@@ -26,17 +36,21 @@\n ┊26┊36┊    private removeChatGQL: RemoveChatGQL,\n ┊27┊37┊    private removeMessagesGQL: RemoveMessagesGQL,\n ┊28┊38┊    private removeAllMessagesGQL: RemoveAllMessagesGQL,\n-┊29┊  ┊  ) {}\n-┊30┊  ┊\n-┊31┊  ┊  getChats() {\n-┊32┊  ┊    const query = this.getChatsGQL.watch({\n+┊  ┊39┊    private getUsersGQL: GetUsersGQL,\n+┊  ┊40┊    private addChatGQL: AddChatGQL,\n+┊  ┊41┊    private addGroupGQL: AddGroupGQL\n+┊  ┊42┊  ) {\n+┊  ┊43┊    this.getChatsWq = this.getChatsGQL.watch({\n ┊33┊44┊      amount: this.messagesAmount,\n ┊34┊45┊    });\n-┊35┊  ┊    const chats$ = query.valueChanges.pipe(\n+┊  ┊46┊    this.chats$ = this.getChatsWq.valueChanges.pipe(\n ┊36┊47┊      map((result) => result.data.chats)\n ┊37┊48┊    );\n+┊  ┊49┊    this.chats$.subscribe(chats => this.chats = chats);\n+┊  ┊50┊  }\n ┊38┊51┊\n-┊39┊  ┊    return {query, chats$};\n+┊  ┊52┊  getChats() {\n+┊  ┊53┊    return {query: this.getChatsWq, chats$: this.chats$};\n ┊40┊54┊  }\n ┊41┊55┊\n ┊42┊56┊  getChat(chatId: string) {\n```\n```diff\n@@ -209,4 +223,83 @@\n ┊209┊223┊      }, options);\n ┊210┊224┊    }\n ┊211┊225┊  }\n+┊   ┊226┊\n+┊   ┊227┊  getUsers() {\n+┊   ┊228┊    const query = this.getUsersGQL.watch();\n+┊   ┊229┊    const users$ = query.valueChanges.pipe(\n+┊   ┊230┊      map((result) => result.data.users)\n+┊   ┊231┊    );\n+┊   ┊232┊\n+┊   ┊233┊    return {query, users$};\n+┊   ┊234┊  }\n+┊   ┊235┊\n+┊   ┊236┊  // Checks if the chat is listed for the current user and returns the id\n+┊   ┊237┊  getChatId(recipientId: string) {\n+┊   ┊238┊    const _chat = this.chats.find(chat => {\n+┊   ┊239┊      return !chat.isGroup && !!chat.allTimeMembers.find(user => user.id === currentUserId) &&\n+┊   ┊240┊        !!chat.allTimeMembers.find(user => user.id === recipientId);\n+┊   ┊241┊    });\n+┊   ┊242┊    return _chat ? _chat.id : false;\n+┊   ┊243┊  }\n+┊   ┊244┊\n+┊   ┊245┊  addChat(recipientId: string) {\n+┊   ┊246┊    return this.addChatGQL.mutate(\n+┊   ┊247┊      {\n+┊   ┊248┊        recipientId,\n+┊   ┊249┊      }, {\n+┊   ┊250┊        update: (store, { data: { addChat } }) => {\n+┊   ┊251┊          // Read the data from our cache for this query.\n+┊   ┊252┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊253┊            query: this.getChatsGQL.document,\n+┊   ┊254┊            variables: {\n+┊   ┊255┊              amount: this.messagesAmount,\n+┊   ┊256┊            },\n+┊   ┊257┊          });\n+┊   ┊258┊          // Add our comment from the mutation to the end.\n+┊   ┊259┊          chats.push(addChat);\n+┊   ┊260┊          // Write our data back to the cache.\n+┊   ┊261┊          store.writeQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊262┊            query: this.getChatsGQL.document,\n+┊   ┊263┊            variables: {\n+┊   ┊264┊              amount: this.messagesAmount,\n+┊   ┊265┊            },\n+┊   ┊266┊            data: {\n+┊   ┊267┊              chats,\n+┊   ┊268┊            },\n+┊   ┊269┊          });\n+┊   ┊270┊        },\n+┊   ┊271┊      }\n+┊   ┊272┊    );\n+┊   ┊273┊  }\n+┊   ┊274┊\n+┊   ┊275┊  addGroup(recipientIds: string[], groupName: string) {\n+┊   ┊276┊    return this.addGroupGQL.mutate(\n+┊   ┊277┊      {\n+┊   ┊278┊        recipientIds,\n+┊   ┊279┊        groupName,\n+┊   ┊280┊      }, {\n+┊   ┊281┊        update: (store, { data: { addGroup } }) => {\n+┊   ┊282┊          // Read the data from our cache for this query.\n+┊   ┊283┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊284┊            query: this.getChatsGQL.document,\n+┊   ┊285┊            variables: {\n+┊   ┊286┊              amount: this.messagesAmount,\n+┊   ┊287┊            },\n+┊   ┊288┊          });\n+┊   ┊289┊          // Add our comment from the mutation to the end.\n+┊   ┊290┊          chats.push(addGroup);\n+┊   ┊291┊          // Write our data back to the cache.\n+┊   ┊292┊          store.writeQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊293┊            query: this.getChatsGQL.document,\n+┊   ┊294┊            variables: {\n+┊   ┊295┊              amount: this.messagesAmount,\n+┊   ┊296┊            },\n+┊   ┊297┊            data: {\n+┊   ┊298┊              chats,\n+┊   ┊299┊            },\n+┊   ┊300┊          });\n+┊   ┊301┊        },\n+┊   ┊302┊      }\n+┊   ┊303┊    );\n+┊   ┊304┊  }\n ┊212┊305┊}\n```\n\n[}]: #\n\nOkay, now since we got the GraphQL part ready, we're going to focus on the component.\n\nFirst, we will download the default group-chat picture:\n\n    $ wget https://raw.githubusercontent.com/DAB0mB/whatsapp-client-angularcli-material/c75c2416b1990da3588015f76b8338764f44d6ec/src/assets/default-group-pic.jpg -P src/assets\n\nAnd update the relevant chat components to use it when necessary:\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/app/chat-viewer/containers/chat/chat.component.ts, src/app/chats-lister/components/chat-item/chat-item.component.ts\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n\n\n[}]: #\n\nThen we will create a space to add a new group:\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/app/chats-creation/containers/new-group/new-group.component.ts, src/app/chats-creation/containers/new-group/new-group.component.scss\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-group&#x2F;new-group.component.scss\n\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-group&#x2F;new-group.component.ts\n```diff\n@@ -0,0 +1,60 @@\n+┊  ┊ 1┊import {Component, OnInit} from '@angular/core';\n+┊  ┊ 2┊import {Location} from '@angular/common';\n+┊  ┊ 3┊import {Router} from '@angular/router';\n+┊  ┊ 4┊import {AddGroup, GetUsers} from '../../../../graphql';\n+┊  ┊ 5┊import {ChatsService} from '../../../services/chats.service';\n+┊  ┊ 6┊\n+┊  ┊ 7┊@Component({\n+┊  ┊ 8┊  template: `\n+┊  ┊ 9┊    <app-toolbar>\n+┊  ┊10┊      <button class=\"navigation\" mat-button (click)=\"goBack()\">\n+┊  ┊11┊        <mat-icon aria-label=\"Icon-button with an arrow back icon\">arrow_back</mat-icon>\n+┊  ┊12┊      </button>\n+┊  ┊13┊      <div class=\"title\">New group</div>\n+┊  ┊14┊    </app-toolbar>\n+┊  ┊15┊\n+┊  ┊16┊    <app-users-list *ngIf=\"!recipientIds.length\" [items]=\"users\"\n+┊  ┊17┊                    libSelectableList=\"multiple_tap\" (multiple)=\"selectUsers($event)\">\n+┊  ┊18┊      <app-confirm-selection #confirmSelection icon=\"arrow_forward\"></app-confirm-selection>\n+┊  ┊19┊    </app-users-list>\n+┊  ┊20┊    <app-new-group-details *ngIf=\"recipientIds.length\" [users]=\"getSelectedUsers()\"\n+┊  ┊21┊                           (groupDetails)=\"addGroup($event)\"></app-new-group-details>\n+┊  ┊22┊  `,\n+┊  ┊23┊  styleUrls: ['new-group.component.scss'],\n+┊  ┊24┊})\n+┊  ┊25┊export class NewGroupComponent implements OnInit {\n+┊  ┊26┊  users: GetUsers.Users[];\n+┊  ┊27┊  recipientIds: string[] = [];\n+┊  ┊28┊\n+┊  ┊29┊  constructor(private router: Router,\n+┊  ┊30┊              private location: Location,\n+┊  ┊31┊              private chatsService: ChatsService) {}\n+┊  ┊32┊\n+┊  ┊33┊  ngOnInit () {\n+┊  ┊34┊    this.chatsService.getUsers().users$.subscribe(users => this.users = users);\n+┊  ┊35┊  }\n+┊  ┊36┊\n+┊  ┊37┊  goBack() {\n+┊  ┊38┊    if (this.recipientIds.length) {\n+┊  ┊39┊      this.recipientIds = [];\n+┊  ┊40┊    } else {\n+┊  ┊41┊      this.location.back();\n+┊  ┊42┊    }\n+┊  ┊43┊  }\n+┊  ┊44┊\n+┊  ┊45┊  selectUsers(recipientIds: string[]) {\n+┊  ┊46┊    this.recipientIds = recipientIds;\n+┊  ┊47┊  }\n+┊  ┊48┊\n+┊  ┊49┊  getSelectedUsers() {\n+┊  ┊50┊    return this.users.filter(user => this.recipientIds.includes(user.id));\n+┊  ┊51┊  }\n+┊  ┊52┊\n+┊  ┊53┊  addGroup(groupName: string) {\n+┊  ┊54┊    if (groupName && this.recipientIds.length) {\n+┊  ┊55┊      this.chatsService.addGroup(this.recipientIds, groupName).subscribe(({data: {addGroup: {id}}}: { data: AddGroup.Mutation }) => {\n+┊  ┊56┊        this.router.navigate(['/chat', id]);\n+┊  ┊57┊      });\n+┊  ┊58┊    }\n+┊  ┊59┊  }\n+┊  ┊60┊}\n```\n\n[}]: #\n\nAnd after, a new chat view:\n\nsrc/app/chats-creation/containers/new-chat/new-chat.component.scss, src/app/chats-creation/containers/new-chat/new-chat.component.ts\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/app/app.module.ts, src/app/chats-creation, src/app/services\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n##### Changed src&#x2F;app&#x2F;app.module.ts\n```diff\n@@ -7,6 +7,7 @@\n ┊ 7┊ 7┊import {ChatsListerModule} from './chats-lister/chats-lister.module';\n ┊ 8┊ 8┊import {RouterModule, Routes} from '@angular/router';\n ┊ 9┊ 9┊import {ChatViewerModule} from './chat-viewer/chat-viewer.module';\n+┊  ┊10┊import {ChatsCreationModule} from './chats-creation/chats-creation.module';\n ┊10┊11┊const routes: Routes = [];\n ┊11┊12┊\n ┊12┊13┊@NgModule({\n```\n```diff\n@@ -22,6 +23,7 @@\n ┊22┊23┊    // Feature modules\n ┊23┊24┊    ChatsListerModule,\n ┊24┊25┊    ChatViewerModule,\n+┊  ┊26┊    ChatsCreationModule,\n ┊25┊27┊  ],\n ┊26┊28┊  providers: [],\n ┊27┊29┊  bootstrap: [AppComponent]\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;chats-creation.module.ts\n```diff\n@@ -0,0 +1,60 @@\n+┊  ┊ 1┊import { BrowserModule } from '@angular/platform-browser';\n+┊  ┊ 2┊import { NgModule } from '@angular/core';\n+┊  ┊ 3┊\n+┊  ┊ 4┊import {BrowserAnimationsModule} from '@angular/platform-browser/animations';\n+┊  ┊ 5┊import {\n+┊  ┊ 6┊  MatButtonModule, MatFormFieldModule, MatGridListModule, MatIconModule, MatInputModule, MatListModule, MatMenuModule,\n+┊  ┊ 7┊  MatToolbarModule\n+┊  ┊ 8┊} from '@angular/material';\n+┊  ┊ 9┊import {RouterModule, Routes} from '@angular/router';\n+┊  ┊10┊import {FormsModule} from '@angular/forms';\n+┊  ┊11┊import {ChatsService} from '../services/chats.service';\n+┊  ┊12┊import {UserItemComponent} from './components/user-item/user-item.component';\n+┊  ┊13┊import {UsersListComponent} from './components/users-list/users-list.component';\n+┊  ┊14┊import {NewGroupComponent} from './containers/new-group/new-group.component';\n+┊  ┊15┊import {NewChatComponent} from './containers/new-chat/new-chat.component';\n+┊  ┊16┊import {NewGroupDetailsComponent} from './components/new-group-details/new-group-details.component';\n+┊  ┊17┊import {SharedModule} from '../shared/shared.module';\n+┊  ┊18┊import {NgxSelectableListModule} from 'ngx-selectable-list';\n+┊  ┊19┊\n+┊  ┊20┊const routes: Routes = [\n+┊  ┊21┊  {path: 'new-chat', component: NewChatComponent},\n+┊  ┊22┊  {path: 'new-group', component: NewGroupComponent},\n+┊  ┊23┊];\n+┊  ┊24┊\n+┊  ┊25┊@NgModule({\n+┊  ┊26┊  declarations: [\n+┊  ┊27┊    NewChatComponent,\n+┊  ┊28┊    UsersListComponent,\n+┊  ┊29┊    NewGroupComponent,\n+┊  ┊30┊    UserItemComponent,\n+┊  ┊31┊    NewGroupDetailsComponent,\n+┊  ┊32┊  ],\n+┊  ┊33┊  imports: [\n+┊  ┊34┊    BrowserModule,\n+┊  ┊35┊    // Animations (for Material)\n+┊  ┊36┊    BrowserAnimationsModule,\n+┊  ┊37┊    // Material\n+┊  ┊38┊    MatToolbarModule,\n+┊  ┊39┊    MatMenuModule,\n+┊  ┊40┊    MatIconModule,\n+┊  ┊41┊    MatButtonModule,\n+┊  ┊42┊    MatListModule,\n+┊  ┊43┊    MatGridListModule,\n+┊  ┊44┊    MatInputModule,\n+┊  ┊45┊    MatFormFieldModule,\n+┊  ┊46┊    MatGridListModule,\n+┊  ┊47┊    // Routing\n+┊  ┊48┊    RouterModule.forChild(routes),\n+┊  ┊49┊    // Forms\n+┊  ┊50┊    FormsModule,\n+┊  ┊51┊    // Feature modules\n+┊  ┊52┊    NgxSelectableListModule,\n+┊  ┊53┊    SharedModule,\n+┊  ┊54┊  ],\n+┊  ┊55┊  providers: [\n+┊  ┊56┊    ChatsService,\n+┊  ┊57┊  ],\n+┊  ┊58┊})\n+┊  ┊59┊export class ChatsCreationModule {\n+┊  ┊60┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;new-group-details&#x2F;new-group-details.component.scss\n```diff\n@@ -0,0 +1,25 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊}\n+┊  ┊ 4┊\n+┊  ┊ 5┊div {\n+┊  ┊ 6┊  padding: 16px;\n+┊  ┊ 7┊  mat-form-field {\n+┊  ┊ 8┊    width: 100%;\n+┊  ┊ 9┊  }\n+┊  ┊10┊}\n+┊  ┊11┊\n+┊  ┊12┊.new-group {\n+┊  ┊13┊  position: absolute;\n+┊  ┊14┊  bottom: 5vw;\n+┊  ┊15┊  right: 5vw;\n+┊  ┊16┊}\n+┊  ┊17┊\n+┊  ┊18┊.users {\n+┊  ┊19┊  display: flex;\n+┊  ┊20┊  flex-flow: row wrap;\n+┊  ┊21┊  img {\n+┊  ┊22┊    flex: 0 1 8vh;\n+┊  ┊23┊    height: 8vh;\n+┊  ┊24┊  }\n+┊  ┊25┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;new-group-details&#x2F;new-group-details.component.ts\n```diff\n@@ -0,0 +1,34 @@\n+┊  ┊ 1┊import {Component, EventEmitter, Input, Output} from '@angular/core';\n+┊  ┊ 2┊import {GetUsers} from '../../../../graphql';\n+┊  ┊ 3┊\n+┊  ┊ 4┊@Component({\n+┊  ┊ 5┊  selector: 'app-new-group-details',\n+┊  ┊ 6┊  template: `\n+┊  ┊ 7┊    <div>\n+┊  ┊ 8┊      <mat-form-field>\n+┊  ┊ 9┊        <input matInput placeholder=\"Group name\" [(ngModel)]=\"groupName\">\n+┊  ┊10┊      </mat-form-field>\n+┊  ┊11┊    </div>\n+┊  ┊12┊    <button [disabled]=\"!groupName\" class=\"new-group\" mat-fab color=\"primary\" (click)=\"emitGroupDetails()\">\n+┊  ┊13┊      <mat-icon aria-label=\"Icon-button with a + icon\">arrow_forward</mat-icon>\n+┊  ┊14┊    </button>\n+┊  ┊15┊    <div>Members</div>\n+┊  ┊16┊    <div class=\"users\">\n+┊  ┊17┊      <img *ngFor=\"let user of users;\" [src]=\"user.picture\"/>\n+┊  ┊18┊    </div>\n+┊  ┊19┊  `,\n+┊  ┊20┊  styleUrls: ['new-group-details.component.scss'],\n+┊  ┊21┊})\n+┊  ┊22┊export class NewGroupDetailsComponent {\n+┊  ┊23┊  groupName: string;\n+┊  ┊24┊  @Input()\n+┊  ┊25┊  users: GetUsers.Users[];\n+┊  ┊26┊  @Output()\n+┊  ┊27┊  groupDetails = new EventEmitter<string>();\n+┊  ┊28┊\n+┊  ┊29┊  emitGroupDetails() {\n+┊  ┊30┊    if (this.groupDetails) {\n+┊  ┊31┊      this.groupDetails.emit(this.groupName);\n+┊  ┊32┊    }\n+┊  ┊33┊  }\n+┊  ┊34┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;user-item&#x2F;user-item.component.scss\n```diff\n@@ -0,0 +1,32 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊  width: 100%;\n+┊  ┊ 4┊  height: 100%;\n+┊  ┊ 5┊}\n+┊  ┊ 6┊\n+┊  ┊ 7┊button {\n+┊  ┊ 8┊  margin: 10px;\n+┊  ┊ 9┊  height: 50px;\n+┊  ┊10┊  padding: 1px 6px;\n+┊  ┊11┊  line-height: 50px;\n+┊  ┊12┊  border: none;\n+┊  ┊13┊  margin: 0;\n+┊  ┊14┊\n+┊  ┊15┊  img {\n+┊  ┊16┊    float: left;\n+┊  ┊17┊    margin-right: 10px;\n+┊  ┊18┊    height: 50px;\n+┊  ┊19┊    width: 50px;\n+┊  ┊20┊    text-align: center;\n+┊  ┊21┊    line-height: inherit;\n+┊  ┊22┊    border-radius: 50%;\n+┊  ┊23┊  }\n+┊  ┊24┊\n+┊  ┊25┊  div {\n+┊  ┊26┊    float: left;\n+┊  ┊27┊    line-height: inherit;\n+┊  ┊28┊    font-family: Roboto, \"Helvetica Neue\", sans-serif;\n+┊  ┊29┊    font-weight: bold;\n+┊  ┊30┊    font-size: 16px;\n+┊  ┊31┊  }\n+┊  ┊32┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;user-item&#x2F;user-item.component.ts\n```diff\n@@ -0,0 +1,18 @@\n+┊  ┊ 1┊import {Component, Input} from '@angular/core';\n+┊  ┊ 2┊import {GetUsers} from '../../../../graphql';\n+┊  ┊ 3┊\n+┊  ┊ 4┊@Component({\n+┊  ┊ 5┊  selector: 'app-user-item',\n+┊  ┊ 6┊  template: `\n+┊  ┊ 7┊    <button mat-menu-item>\n+┊  ┊ 8┊      <img [src]=\"user.picture || 'assets/default-profile-pic.jpg'\">\n+┊  ┊ 9┊      <div>{{ user.name }}</div>\n+┊  ┊10┊    </button>\n+┊  ┊11┊  `,\n+┊  ┊12┊  styleUrls: ['user-item.component.scss']\n+┊  ┊13┊})\n+┊  ┊14┊export class UserItemComponent {\n+┊  ┊15┊  // tslint:disable-next-line:no-input-rename\n+┊  ┊16┊  @Input('item')\n+┊  ┊17┊  user: GetUsers.Users;\n+┊  ┊18┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;users-list&#x2F;users-list.component.scss\n```diff\n@@ -0,0 +1,13 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊}\n+┊  ┊ 4┊\n+┊  ┊ 5┊:host ::ng-deep mat-list-item:first-child div:first-child {\n+┊  ┊ 6┊  padding: 0 !important;\n+┊  ┊ 7┊  margin: 5px;\n+┊  ┊ 8┊  margin-top: 20px;\n+┊  ┊ 9┊}\n+┊  ┊10┊\n+┊  ┊11┊mat-list {\n+┊  ┊12┊  padding: 0;\n+┊  ┊13┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;users-list&#x2F;users-list.component.ts\n```diff\n@@ -0,0 +1,24 @@\n+┊  ┊ 1┊import {Component, Input} from '@angular/core';\n+┊  ┊ 2┊import {GetUsers} from '../../../../graphql';\n+┊  ┊ 3┊import {SelectableListDirective} from 'ngx-selectable-list';\n+┊  ┊ 4┊\n+┊  ┊ 5┊@Component({\n+┊  ┊ 6┊  selector: 'app-users-list',\n+┊  ┊ 7┊  template: `\n+┊  ┊ 8┊    <mat-list>\n+┊  ┊ 9┊      <mat-list-item *ngFor=\"let user of users\">\n+┊  ┊10┊        <app-user-item [item]=\"user\"\n+┊  ┊11┊                       libSelectableItem></app-user-item>\n+┊  ┊12┊      </mat-list-item>\n+┊  ┊13┊    </mat-list>\n+┊  ┊14┊    <ng-content *ngIf=\"selectableListDirective.selecting\"></ng-content>\n+┊  ┊15┊  `,\n+┊  ┊16┊  styleUrls: ['users-list.component.scss'],\n+┊  ┊17┊})\n+┊  ┊18┊export class UsersListComponent {\n+┊  ┊19┊  // tslint:disable-next-line:no-input-rename\n+┊  ┊20┊  @Input('items')\n+┊  ┊21┊  users: GetUsers.Users[];\n+┊  ┊22┊\n+┊  ┊23┊  constructor(public selectableListDirective: SelectableListDirective) {}\n+┊  ┊24┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-chat&#x2F;new-chat.component.scss\n```diff\n@@ -0,0 +1,23 @@\n+┊  ┊ 1┊.new-group {\n+┊  ┊ 2┊  margin: 10px;\n+┊  ┊ 3┊  height: 50px;\n+┊  ┊ 4┊  line-height: 50px;\n+┊  ┊ 5┊  margin-top: 20px;\n+┊  ┊ 6┊\n+┊  ┊ 7┊  mat-icon {\n+┊  ┊ 8┊    float: left;\n+┊  ┊ 9┊    margin-right: 10px;\n+┊  ┊10┊    height: 50px;\n+┊  ┊11┊    width: 50px;\n+┊  ┊12┊    text-align: center;\n+┊  ┊13┊    line-height: inherit;\n+┊  ┊14┊    border-radius: 50%;\n+┊  ┊15┊  }\n+┊  ┊16┊\n+┊  ┊17┊  div {\n+┊  ┊18┊    float: left;\n+┊  ┊19┊    line-height: inherit;\n+┊  ┊20┊    font-family: Roboto, \"Helvetica Neue\", sans-serif;\n+┊  ┊21┊    font-weight: bold;\n+┊  ┊22┊  }\n+┊  ┊23┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-chat&#x2F;new-chat.component.ts\n```diff\n@@ -0,0 +1,55 @@\n+┊  ┊ 1┊import {Component, OnInit} from '@angular/core';\n+┊  ┊ 2┊import {Location} from '@angular/common';\n+┊  ┊ 3┊import {Router} from '@angular/router';\n+┊  ┊ 4┊import {AddChat, GetUsers} from '../../../../graphql';\n+┊  ┊ 5┊import {ChatsService} from '../../../services/chats.service';\n+┊  ┊ 6┊\n+┊  ┊ 7┊@Component({\n+┊  ┊ 8┊  template: `\n+┊  ┊ 9┊    <app-toolbar>\n+┊  ┊10┊      <button class=\"navigation\" mat-button (click)=\"goBack()\">\n+┊  ┊11┊        <mat-icon aria-label=\"Icon-button with an arrow back icon\">arrow_back</mat-icon>\n+┊  ┊12┊      </button>\n+┊  ┊13┊      <div class=\"title\">New chat</div>\n+┊  ┊14┊    </app-toolbar>\n+┊  ┊15┊    <div class=\"new-group\" (click)=\"goToNewGroup()\">\n+┊  ┊16┊      <mat-icon color=\"secondary\" aria-label=\"Icon-button with a group add icon\">group_add</mat-icon>\n+┊  ┊17┊      <div>New group</div>\n+┊  ┊18┊    </div>\n+┊  ┊19┊    <app-users-list [items]=\"users\"\n+┊  ┊20┊                    libSelectableList=\"single\" (single)=\"addChat($event)\">\n+┊  ┊21┊    </app-users-list>\n+┊  ┊22┊  `,\n+┊  ┊23┊  styleUrls: ['new-chat.component.scss'],\n+┊  ┊24┊})\n+┊  ┊25┊export class NewChatComponent implements OnInit {\n+┊  ┊26┊  users: GetUsers.Users[];\n+┊  ┊27┊\n+┊  ┊28┊  constructor(private router: Router,\n+┊  ┊29┊              private location: Location,\n+┊  ┊30┊              private chatsService: ChatsService) {}\n+┊  ┊31┊\n+┊  ┊32┊  ngOnInit () {\n+┊  ┊33┊    this.chatsService.getUsers().users$.subscribe(users => this.users = users);\n+┊  ┊34┊  }\n+┊  ┊35┊\n+┊  ┊36┊  goBack() {\n+┊  ┊37┊    this.location.back();\n+┊  ┊38┊  }\n+┊  ┊39┊\n+┊  ┊40┊  goToNewGroup() {\n+┊  ┊41┊    this.router.navigate(['/new-group']);\n+┊  ┊42┊  }\n+┊  ┊43┊\n+┊  ┊44┊  addChat(recipientId: string) {\n+┊  ┊45┊    const chatId = this.chatsService.getChatId(recipientId);\n+┊  ┊46┊    if (chatId) {\n+┊  ┊47┊      // Chat is already listed for the current user\n+┊  ┊48┊      this.router.navigate(['/chat', chatId]);\n+┊  ┊49┊    } else {\n+┊  ┊50┊      this.chatsService.addChat(recipientId).subscribe(({data: {addChat: {id}}}: { data: AddChat.Mutation }) => {\n+┊  ┊51┊        this.router.navigate(['/chat', id]);\n+┊  ┊52┊      });\n+┊  ┊53┊    }\n+┊  ┊54┊  }\n+┊  ┊55┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-group&#x2F;new-group.component.scss\n\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-group&#x2F;new-group.component.ts\n```diff\n@@ -0,0 +1,60 @@\n+┊  ┊ 1┊import {Component, OnInit} from '@angular/core';\n+┊  ┊ 2┊import {Location} from '@angular/common';\n+┊  ┊ 3┊import {Router} from '@angular/router';\n+┊  ┊ 4┊import {AddGroup, GetUsers} from '../../../../graphql';\n+┊  ┊ 5┊import {ChatsService} from '../../../services/chats.service';\n+┊  ┊ 6┊\n+┊  ┊ 7┊@Component({\n+┊  ┊ 8┊  template: `\n+┊  ┊ 9┊    <app-toolbar>\n+┊  ┊10┊      <button class=\"navigation\" mat-button (click)=\"goBack()\">\n+┊  ┊11┊        <mat-icon aria-label=\"Icon-button with an arrow back icon\">arrow_back</mat-icon>\n+┊  ┊12┊      </button>\n+┊  ┊13┊      <div class=\"title\">New group</div>\n+┊  ┊14┊    </app-toolbar>\n+┊  ┊15┊\n+┊  ┊16┊    <app-users-list *ngIf=\"!recipientIds.length\" [items]=\"users\"\n+┊  ┊17┊                    libSelectableList=\"multiple_tap\" (multiple)=\"selectUsers($event)\">\n+┊  ┊18┊      <app-confirm-selection #confirmSelection icon=\"arrow_forward\"></app-confirm-selection>\n+┊  ┊19┊    </app-users-list>\n+┊  ┊20┊    <app-new-group-details *ngIf=\"recipientIds.length\" [users]=\"getSelectedUsers()\"\n+┊  ┊21┊                           (groupDetails)=\"addGroup($event)\"></app-new-group-details>\n+┊  ┊22┊  `,\n+┊  ┊23┊  styleUrls: ['new-group.component.scss'],\n+┊  ┊24┊})\n+┊  ┊25┊export class NewGroupComponent implements OnInit {\n+┊  ┊26┊  users: GetUsers.Users[];\n+┊  ┊27┊  recipientIds: string[] = [];\n+┊  ┊28┊\n+┊  ┊29┊  constructor(private router: Router,\n+┊  ┊30┊              private location: Location,\n+┊  ┊31┊              private chatsService: ChatsService) {}\n+┊  ┊32┊\n+┊  ┊33┊  ngOnInit () {\n+┊  ┊34┊    this.chatsService.getUsers().users$.subscribe(users => this.users = users);\n+┊  ┊35┊  }\n+┊  ┊36┊\n+┊  ┊37┊  goBack() {\n+┊  ┊38┊    if (this.recipientIds.length) {\n+┊  ┊39┊      this.recipientIds = [];\n+┊  ┊40┊    } else {\n+┊  ┊41┊      this.location.back();\n+┊  ┊42┊    }\n+┊  ┊43┊  }\n+┊  ┊44┊\n+┊  ┊45┊  selectUsers(recipientIds: string[]) {\n+┊  ┊46┊    this.recipientIds = recipientIds;\n+┊  ┊47┊  }\n+┊  ┊48┊\n+┊  ┊49┊  getSelectedUsers() {\n+┊  ┊50┊    return this.users.filter(user => this.recipientIds.includes(user.id));\n+┊  ┊51┊  }\n+┊  ┊52┊\n+┊  ┊53┊  addGroup(groupName: string) {\n+┊  ┊54┊    if (groupName && this.recipientIds.length) {\n+┊  ┊55┊      this.chatsService.addGroup(this.recipientIds, groupName).subscribe(({data: {addGroup: {id}}}: { data: AddGroup.Mutation }) => {\n+┊  ┊56┊        this.router.navigate(['/chat', id]);\n+┊  ┊57┊      });\n+┊  ┊58┊    }\n+┊  ┊59┊  }\n+┊  ┊60┊}\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,5 +1,7 @@\n ┊1┊1┊import {map} from 'rxjs/operators';\n ┊2┊2┊import {Injectable} from '@angular/core';\n+┊ ┊3┊import {Observable} from 'rxjs';\n+┊ ┊4┊import {QueryRef} from 'apollo-angular';\n ┊3┊5┊import {\n ┊4┊6┊  GetChatsGQL,\n ┊5┊7┊  GetChatGQL,\n```\n```diff\n@@ -7,6 +9,9 @@\n ┊ 7┊ 9┊  RemoveChatGQL,\n ┊ 8┊10┊  RemoveMessagesGQL,\n ┊ 9┊11┊  RemoveAllMessagesGQL,\n+┊  ┊12┊  GetUsersGQL,\n+┊  ┊13┊  AddChatGQL,\n+┊  ┊14┊  AddGroupGQL,\n ┊10┊15┊  AddMessage,\n ┊11┊16┊  GetChats,\n ┊12┊17┊  GetChat,\n```\n```diff\n@@ -15,9 +20,14 @@\n ┊15┊20┊} from '../../graphql';\n ┊16┊21┊import { DataProxy } from 'apollo-cache';\n ┊17┊22┊\n+┊  ┊23┊const currentUserId = '1';\n+┊  ┊24┊\n ┊18┊25┊@Injectable()\n ┊19┊26┊export class ChatsService {\n ┊20┊27┊  messagesAmount = 3;\n+┊  ┊28┊  getChatsWq: QueryRef<GetChats.Query, GetChats.Variables>;\n+┊  ┊29┊  chats$: Observable<GetChats.Chats[]>;\n+┊  ┊30┊  chats: GetChats.Chats[];\n ┊21┊31┊\n ┊22┊32┊  constructor(\n ┊23┊33┊    private getChatsGQL: GetChatsGQL,\n```\n```diff\n@@ -26,17 +36,21 @@\n ┊26┊36┊    private removeChatGQL: RemoveChatGQL,\n ┊27┊37┊    private removeMessagesGQL: RemoveMessagesGQL,\n ┊28┊38┊    private removeAllMessagesGQL: RemoveAllMessagesGQL,\n-┊29┊  ┊  ) {}\n-┊30┊  ┊\n-┊31┊  ┊  getChats() {\n-┊32┊  ┊    const query = this.getChatsGQL.watch({\n+┊  ┊39┊    private getUsersGQL: GetUsersGQL,\n+┊  ┊40┊    private addChatGQL: AddChatGQL,\n+┊  ┊41┊    private addGroupGQL: AddGroupGQL\n+┊  ┊42┊  ) {\n+┊  ┊43┊    this.getChatsWq = this.getChatsGQL.watch({\n ┊33┊44┊      amount: this.messagesAmount,\n ┊34┊45┊    });\n-┊35┊  ┊    const chats$ = query.valueChanges.pipe(\n+┊  ┊46┊    this.chats$ = this.getChatsWq.valueChanges.pipe(\n ┊36┊47┊      map((result) => result.data.chats)\n ┊37┊48┊    );\n+┊  ┊49┊    this.chats$.subscribe(chats => this.chats = chats);\n+┊  ┊50┊  }\n ┊38┊51┊\n-┊39┊  ┊    return {query, chats$};\n+┊  ┊52┊  getChats() {\n+┊  ┊53┊    return {query: this.getChatsWq, chats$: this.chats$};\n ┊40┊54┊  }\n ┊41┊55┊\n ┊42┊56┊  getChat(chatId: string) {\n```\n```diff\n@@ -209,4 +223,83 @@\n ┊209┊223┊      }, options);\n ┊210┊224┊    }\n ┊211┊225┊  }\n+┊   ┊226┊\n+┊   ┊227┊  getUsers() {\n+┊   ┊228┊    const query = this.getUsersGQL.watch();\n+┊   ┊229┊    const users$ = query.valueChanges.pipe(\n+┊   ┊230┊      map((result) => result.data.users)\n+┊   ┊231┊    );\n+┊   ┊232┊\n+┊   ┊233┊    return {query, users$};\n+┊   ┊234┊  }\n+┊   ┊235┊\n+┊   ┊236┊  // Checks if the chat is listed for the current user and returns the id\n+┊   ┊237┊  getChatId(recipientId: string) {\n+┊   ┊238┊    const _chat = this.chats.find(chat => {\n+┊   ┊239┊      return !chat.isGroup && !!chat.allTimeMembers.find(user => user.id === currentUserId) &&\n+┊   ┊240┊        !!chat.allTimeMembers.find(user => user.id === recipientId);\n+┊   ┊241┊    });\n+┊   ┊242┊    return _chat ? _chat.id : false;\n+┊   ┊243┊  }\n+┊   ┊244┊\n+┊   ┊245┊  addChat(recipientId: string) {\n+┊   ┊246┊    return this.addChatGQL.mutate(\n+┊   ┊247┊      {\n+┊   ┊248┊        recipientId,\n+┊   ┊249┊      }, {\n+┊   ┊250┊        update: (store, { data: { addChat } }) => {\n+┊   ┊251┊          // Read the data from our cache for this query.\n+┊   ┊252┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊253┊            query: this.getChatsGQL.document,\n+┊   ┊254┊            variables: {\n+┊   ┊255┊              amount: this.messagesAmount,\n+┊   ┊256┊            },\n+┊   ┊257┊          });\n+┊   ┊258┊          // Add our comment from the mutation to the end.\n+┊   ┊259┊          chats.push(addChat);\n+┊   ┊260┊          // Write our data back to the cache.\n+┊   ┊261┊          store.writeQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊262┊            query: this.getChatsGQL.document,\n+┊   ┊263┊            variables: {\n+┊   ┊264┊              amount: this.messagesAmount,\n+┊   ┊265┊            },\n+┊   ┊266┊            data: {\n+┊   ┊267┊              chats,\n+┊   ┊268┊            },\n+┊   ┊269┊          });\n+┊   ┊270┊        },\n+┊   ┊271┊      }\n+┊   ┊272┊    );\n+┊   ┊273┊  }\n+┊   ┊274┊\n+┊   ┊275┊  addGroup(recipientIds: string[], groupName: string) {\n+┊   ┊276┊    return this.addGroupGQL.mutate(\n+┊   ┊277┊      {\n+┊   ┊278┊        recipientIds,\n+┊   ┊279┊        groupName,\n+┊   ┊280┊      }, {\n+┊   ┊281┊        update: (store, { data: { addGroup } }) => {\n+┊   ┊282┊          // Read the data from our cache for this query.\n+┊   ┊283┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊284┊            query: this.getChatsGQL.document,\n+┊   ┊285┊            variables: {\n+┊   ┊286┊              amount: this.messagesAmount,\n+┊   ┊287┊            },\n+┊   ┊288┊          });\n+┊   ┊289┊          // Add our comment from the mutation to the end.\n+┊   ┊290┊          chats.push(addGroup);\n+┊   ┊291┊          // Write our data back to the cache.\n+┊   ┊292┊          store.writeQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊293┊            query: this.getChatsGQL.document,\n+┊   ┊294┊            variables: {\n+┊   ┊295┊              amount: this.messagesAmount,\n+┊   ┊296┊            },\n+┊   ┊297┊            data: {\n+┊   ┊298┊              chats,\n+┊   ┊299┊            },\n+┊   ┊300┊          });\n+┊   ┊301┊        },\n+┊   ┊302┊      }\n+┊   ┊303┊    );\n+┊   ┊304┊  }\n ┊212┊305┊}\n```\n\n[}]: #\n\nThey're both missing few components:\n\n**UsersList**\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/app/chats-creation/components/users-list/users-list.component.ts, src/app/chats-creation/components/users-list/users-list.component.scss\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;users-list&#x2F;users-list.component.scss\n```diff\n@@ -0,0 +1,13 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊}\n+┊  ┊ 4┊\n+┊  ┊ 5┊:host ::ng-deep mat-list-item:first-child div:first-child {\n+┊  ┊ 6┊  padding: 0 !important;\n+┊  ┊ 7┊  margin: 5px;\n+┊  ┊ 8┊  margin-top: 20px;\n+┊  ┊ 9┊}\n+┊  ┊10┊\n+┊  ┊11┊mat-list {\n+┊  ┊12┊  padding: 0;\n+┊  ┊13┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;users-list&#x2F;users-list.component.ts\n```diff\n@@ -0,0 +1,24 @@\n+┊  ┊ 1┊import {Component, Input} from '@angular/core';\n+┊  ┊ 2┊import {GetUsers} from '../../../../graphql';\n+┊  ┊ 3┊import {SelectableListDirective} from 'ngx-selectable-list';\n+┊  ┊ 4┊\n+┊  ┊ 5┊@Component({\n+┊  ┊ 6┊  selector: 'app-users-list',\n+┊  ┊ 7┊  template: `\n+┊  ┊ 8┊    <mat-list>\n+┊  ┊ 9┊      <mat-list-item *ngFor=\"let user of users\">\n+┊  ┊10┊        <app-user-item [item]=\"user\"\n+┊  ┊11┊                       libSelectableItem></app-user-item>\n+┊  ┊12┊      </mat-list-item>\n+┊  ┊13┊    </mat-list>\n+┊  ┊14┊    <ng-content *ngIf=\"selectableListDirective.selecting\"></ng-content>\n+┊  ┊15┊  `,\n+┊  ┊16┊  styleUrls: ['users-list.component.scss'],\n+┊  ┊17┊})\n+┊  ┊18┊export class UsersListComponent {\n+┊  ┊19┊  // tslint:disable-next-line:no-input-rename\n+┊  ┊20┊  @Input('items')\n+┊  ┊21┊  users: GetUsers.Users[];\n+┊  ┊22┊\n+┊  ┊23┊  constructor(public selectableListDirective: SelectableListDirective) {}\n+┊  ┊24┊}\n```\n\n[}]: #\n\n**UserItem**\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/app/chats-creation/components/user-item/user-item.component.ts, src/app/chats-creation/components/user-item/user-item.component.scss\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;user-item&#x2F;user-item.component.scss\n```diff\n@@ -0,0 +1,32 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊  width: 100%;\n+┊  ┊ 4┊  height: 100%;\n+┊  ┊ 5┊}\n+┊  ┊ 6┊\n+┊  ┊ 7┊button {\n+┊  ┊ 8┊  margin: 10px;\n+┊  ┊ 9┊  height: 50px;\n+┊  ┊10┊  padding: 1px 6px;\n+┊  ┊11┊  line-height: 50px;\n+┊  ┊12┊  border: none;\n+┊  ┊13┊  margin: 0;\n+┊  ┊14┊\n+┊  ┊15┊  img {\n+┊  ┊16┊    float: left;\n+┊  ┊17┊    margin-right: 10px;\n+┊  ┊18┊    height: 50px;\n+┊  ┊19┊    width: 50px;\n+┊  ┊20┊    text-align: center;\n+┊  ┊21┊    line-height: inherit;\n+┊  ┊22┊    border-radius: 50%;\n+┊  ┊23┊  }\n+┊  ┊24┊\n+┊  ┊25┊  div {\n+┊  ┊26┊    float: left;\n+┊  ┊27┊    line-height: inherit;\n+┊  ┊28┊    font-family: Roboto, \"Helvetica Neue\", sans-serif;\n+┊  ┊29┊    font-weight: bold;\n+┊  ┊30┊    font-size: 16px;\n+┊  ┊31┊  }\n+┊  ┊32┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;user-item&#x2F;user-item.component.ts\n```diff\n@@ -0,0 +1,18 @@\n+┊  ┊ 1┊import {Component, Input} from '@angular/core';\n+┊  ┊ 2┊import {GetUsers} from '../../../../graphql';\n+┊  ┊ 3┊\n+┊  ┊ 4┊@Component({\n+┊  ┊ 5┊  selector: 'app-user-item',\n+┊  ┊ 6┊  template: `\n+┊  ┊ 7┊    <button mat-menu-item>\n+┊  ┊ 8┊      <img [src]=\"user.picture || 'assets/default-profile-pic.jpg'\">\n+┊  ┊ 9┊      <div>{{ user.name }}</div>\n+┊  ┊10┊    </button>\n+┊  ┊11┊  `,\n+┊  ┊12┊  styleUrls: ['user-item.component.scss']\n+┊  ┊13┊})\n+┊  ┊14┊export class UserItemComponent {\n+┊  ┊15┊  // tslint:disable-next-line:no-input-rename\n+┊  ┊16┊  @Input('item')\n+┊  ┊17┊  user: GetUsers.Users;\n+┊  ┊18┊}\n```\n\n[}]: #\n\n**NewGroupDetails**\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/app/chats-creation/components/new-group-details/new-group-details.component.ts, src/app/chats-creation/components/new-group-details/new-group-details.component.scss\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;new-group-details&#x2F;new-group-details.component.scss\n```diff\n@@ -0,0 +1,25 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊}\n+┊  ┊ 4┊\n+┊  ┊ 5┊div {\n+┊  ┊ 6┊  padding: 16px;\n+┊  ┊ 7┊  mat-form-field {\n+┊  ┊ 8┊    width: 100%;\n+┊  ┊ 9┊  }\n+┊  ┊10┊}\n+┊  ┊11┊\n+┊  ┊12┊.new-group {\n+┊  ┊13┊  position: absolute;\n+┊  ┊14┊  bottom: 5vw;\n+┊  ┊15┊  right: 5vw;\n+┊  ┊16┊}\n+┊  ┊17┊\n+┊  ┊18┊.users {\n+┊  ┊19┊  display: flex;\n+┊  ┊20┊  flex-flow: row wrap;\n+┊  ┊21┊  img {\n+┊  ┊22┊    flex: 0 1 8vh;\n+┊  ┊23┊    height: 8vh;\n+┊  ┊24┊  }\n+┊  ┊25┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;new-group-details&#x2F;new-group-details.component.ts\n```diff\n@@ -0,0 +1,34 @@\n+┊  ┊ 1┊import {Component, EventEmitter, Input, Output} from '@angular/core';\n+┊  ┊ 2┊import {GetUsers} from '../../../../graphql';\n+┊  ┊ 3┊\n+┊  ┊ 4┊@Component({\n+┊  ┊ 5┊  selector: 'app-new-group-details',\n+┊  ┊ 6┊  template: `\n+┊  ┊ 7┊    <div>\n+┊  ┊ 8┊      <mat-form-field>\n+┊  ┊ 9┊        <input matInput placeholder=\"Group name\" [(ngModel)]=\"groupName\">\n+┊  ┊10┊      </mat-form-field>\n+┊  ┊11┊    </div>\n+┊  ┊12┊    <button [disabled]=\"!groupName\" class=\"new-group\" mat-fab color=\"primary\" (click)=\"emitGroupDetails()\">\n+┊  ┊13┊      <mat-icon aria-label=\"Icon-button with a + icon\">arrow_forward</mat-icon>\n+┊  ┊14┊    </button>\n+┊  ┊15┊    <div>Members</div>\n+┊  ┊16┊    <div class=\"users\">\n+┊  ┊17┊      <img *ngFor=\"let user of users;\" [src]=\"user.picture\"/>\n+┊  ┊18┊    </div>\n+┊  ┊19┊  `,\n+┊  ┊20┊  styleUrls: ['new-group-details.component.scss'],\n+┊  ┊21┊})\n+┊  ┊22┊export class NewGroupDetailsComponent {\n+┊  ┊23┊  groupName: string;\n+┊  ┊24┊  @Input()\n+┊  ┊25┊  users: GetUsers.Users[];\n+┊  ┊26┊  @Output()\n+┊  ┊27┊  groupDetails = new EventEmitter<string>();\n+┊  ┊28┊\n+┊  ┊29┊  emitGroupDetails() {\n+┊  ┊30┊    if (this.groupDetails) {\n+┊  ┊31┊      this.groupDetails.emit(this.groupName);\n+┊  ┊32┊    }\n+┊  ┊33┊  }\n+┊  ┊34┊}\n```\n\n[}]: #\n\nWith all that, we can now link NewChat component with Chat container:\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/app/chats-lister/containers/chats/chats.component.ts, src/app/chat-viewer/containers/chat/chat.component.spec.ts\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.spec.ts\n```diff\n@@ -143,7 +143,9 @@\n ┊143┊143┊    component = fixture.componentInstance;\n ┊144┊144┊    fixture.detectChanges();\n ┊145┊145┊\n-┊146┊   ┊    const req = controller.expectOne('GetChat', 'call to api');\n+┊   ┊146┊    controller.expectOne('GetChats', 'call to getChats api');\n+┊   ┊147┊\n+┊   ┊148┊    const req = controller.expectOne('GetChat', 'call to getChat api');\n ┊147┊149┊\n ┊148┊150┊    req.flush({\n ┊149┊151┊      data: {\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.ts\n```diff\n@@ -34,7 +34,7 @@\n ┊34┊34┊      <app-confirm-selection #confirmSelection></app-confirm-selection>\n ┊35┊35┊    </app-chats-list>\n ┊36┊36┊\n-┊37┊  ┊    <button *ngIf=\"!isSelecting\" class=\"chat-button\" mat-fab color=\"secondary\">\n+┊  ┊37┊    <button *ngIf=\"!isSelecting\" class=\"chat-button\" mat-fab color=\"secondary\" (click)=\"goToNewChat()\">\n ┊38┊38┊      <mat-icon aria-label=\"Icon-button with a + icon\">chat</mat-icon>\n ┊39┊39┊    </button>\n ┊40┊40┊  `,\n```\n```diff\n@@ -56,6 +56,10 @@\n ┊56┊56┊    this.router.navigate(['/chat', chatId]);\n ┊57┊57┊  }\n ┊58┊58┊\n+┊  ┊59┊  goToNewChat() {\n+┊  ┊60┊    this.router.navigate(['/new-chat']);\n+┊  ┊61┊  }\n+┊  ┊62┊\n ┊59┊63┊  deleteChats(chatIds: string[]) {\n ┊60┊64┊    chatIds.forEach(chatId => {\n ┊61┊65┊      this.chatsService.removeChat(chatId).subscribe();\n```\n\n[}]: #\n\nNow let's wrap it all together within the `ChatsCreation` module:\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/app/chats-creation/chats-creation.module.ts, src/app/app.module.ts\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n##### Changed src&#x2F;app&#x2F;app.module.ts\n```diff\n@@ -7,6 +7,7 @@\n ┊ 7┊ 7┊import {ChatsListerModule} from './chats-lister/chats-lister.module';\n ┊ 8┊ 8┊import {RouterModule, Routes} from '@angular/router';\n ┊ 9┊ 9┊import {ChatViewerModule} from './chat-viewer/chat-viewer.module';\n+┊  ┊10┊import {ChatsCreationModule} from './chats-creation/chats-creation.module';\n ┊10┊11┊const routes: Routes = [];\n ┊11┊12┊\n ┊12┊13┊@NgModule({\n```\n```diff\n@@ -22,6 +23,7 @@\n ┊22┊23┊    // Feature modules\n ┊23┊24┊    ChatsListerModule,\n ┊24┊25┊    ChatViewerModule,\n+┊  ┊26┊    ChatsCreationModule,\n ┊25┊27┊  ],\n ┊26┊28┊  providers: [],\n ┊27┊29┊  bootstrap: [AppComponent]\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;chats-creation.module.ts\n```diff\n@@ -0,0 +1,60 @@\n+┊  ┊ 1┊import { BrowserModule } from '@angular/platform-browser';\n+┊  ┊ 2┊import { NgModule } from '@angular/core';\n+┊  ┊ 3┊\n+┊  ┊ 4┊import {BrowserAnimationsModule} from '@angular/platform-browser/animations';\n+┊  ┊ 5┊import {\n+┊  ┊ 6┊  MatButtonModule, MatFormFieldModule, MatGridListModule, MatIconModule, MatInputModule, MatListModule, MatMenuModule,\n+┊  ┊ 7┊  MatToolbarModule\n+┊  ┊ 8┊} from '@angular/material';\n+┊  ┊ 9┊import {RouterModule, Routes} from '@angular/router';\n+┊  ┊10┊import {FormsModule} from '@angular/forms';\n+┊  ┊11┊import {ChatsService} from '../services/chats.service';\n+┊  ┊12┊import {UserItemComponent} from './components/user-item/user-item.component';\n+┊  ┊13┊import {UsersListComponent} from './components/users-list/users-list.component';\n+┊  ┊14┊import {NewGroupComponent} from './containers/new-group/new-group.component';\n+┊  ┊15┊import {NewChatComponent} from './containers/new-chat/new-chat.component';\n+┊  ┊16┊import {NewGroupDetailsComponent} from './components/new-group-details/new-group-details.component';\n+┊  ┊17┊import {SharedModule} from '../shared/shared.module';\n+┊  ┊18┊import {NgxSelectableListModule} from 'ngx-selectable-list';\n+┊  ┊19┊\n+┊  ┊20┊const routes: Routes = [\n+┊  ┊21┊  {path: 'new-chat', component: NewChatComponent},\n+┊  ┊22┊  {path: 'new-group', component: NewGroupComponent},\n+┊  ┊23┊];\n+┊  ┊24┊\n+┊  ┊25┊@NgModule({\n+┊  ┊26┊  declarations: [\n+┊  ┊27┊    NewChatComponent,\n+┊  ┊28┊    UsersListComponent,\n+┊  ┊29┊    NewGroupComponent,\n+┊  ┊30┊    UserItemComponent,\n+┊  ┊31┊    NewGroupDetailsComponent,\n+┊  ┊32┊  ],\n+┊  ┊33┊  imports: [\n+┊  ┊34┊    BrowserModule,\n+┊  ┊35┊    // Animations (for Material)\n+┊  ┊36┊    BrowserAnimationsModule,\n+┊  ┊37┊    // Material\n+┊  ┊38┊    MatToolbarModule,\n+┊  ┊39┊    MatMenuModule,\n+┊  ┊40┊    MatIconModule,\n+┊  ┊41┊    MatButtonModule,\n+┊  ┊42┊    MatListModule,\n+┊  ┊43┊    MatGridListModule,\n+┊  ┊44┊    MatInputModule,\n+┊  ┊45┊    MatFormFieldModule,\n+┊  ┊46┊    MatGridListModule,\n+┊  ┊47┊    // Routing\n+┊  ┊48┊    RouterModule.forChild(routes),\n+┊  ┊49┊    // Forms\n+┊  ┊50┊    FormsModule,\n+┊  ┊51┊    // Feature modules\n+┊  ┊52┊    NgxSelectableListModule,\n+┊  ┊53┊    SharedModule,\n+┊  ┊54┊  ],\n+┊  ┊55┊  providers: [\n+┊  ┊56┊    ChatsService,\n+┊  ┊57┊  ],\n+┊  ┊58┊})\n+┊  ┊59┊export class ChatsCreationModule {\n+┊  ┊60┊}\n```\n\n[}]: #"
          },
          {
            "manualTitle": "Step 13: Zero latency on slow 3g networks",
            "stepRevision": "810cc1ec3030d51cec02928dfb862b0b3ed6df90",
            "manualView": "## Client\n\nNow let's start our client in production mode:\n\n    yarn start --prod\n\nNow open the **Chrome Developers Tools** and, in the **Network tab**, select `Slow 3G Network` and `Disable cache`.\nThen refresh the page and look at the `DOMContentLoaded` time and at the transferred size. You'll notice that our bundle size is quite small and so the loads time.\n\nNow let's click on a specific chat. It will take some time to load the data and then add a new message.\nOnce again it will take some time to load the data.\nWe could also create a new chat and the result would be the same.\nThe whole app doesn't feel as snappier as the real Whatsapp on a slow 3G Network.\n\n\"That's normal, it's a web application with a remote db while Whatsapp is a native app with a local database...\"\nThat's just an excuse, because we can do as good as Whatsapp thanks to Apollo!\n\nLet's install `moment`, we will soon need it:\n\n    yarn add moment\n\nStart by making our UI optimistic. We can predict most of the response we will get from our server, except for a few things like `id` of newly created messages. But since we don't really need that id, we can simply generate a fake one\nwhich will be later overridden once we get the response from the server:\n\n[{]: <helper> (diffStep \"9.1\" files=\"^\\(?!package.json$\\).*\" module=\"client\")\n\n#### [Step 9.1: Optimistic updates](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/39432fa)\n\n##### Changed src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-chat&#x2F;new-chat.component.ts\n```diff\n@@ -47,7 +47,7 @@\n ┊47┊47┊      // Chat is already listed for the current user\n ┊48┊48┊      this.router.navigate(['/chat', chatId]);\n ┊49┊49┊    } else {\n-┊50┊  ┊      this.chatsService.addChat(recipientId).subscribe(({data: {addChat: {id}}}: { data: AddChat.Mutation }) => {\n+┊  ┊50┊      this.chatsService.addChat(recipientId, this.users).subscribe(({data: {addChat: {id}}}: { data: AddChat.Mutation }) => {\n ┊51┊51┊        this.router.navigate(['/chat', id]);\n ┊52┊52┊      });\n ┊53┊53┊    }\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -2,6 +2,7 @@\n ┊2┊2┊import {Injectable} from '@angular/core';\n ┊3┊3┊import {Observable} from 'rxjs';\n ┊4┊4┊import {QueryRef} from 'apollo-angular';\n+┊ ┊5┊import * as moment from 'moment';\n ┊5┊6┊import {\n ┊6┊7┊  GetChatsGQL,\n ┊7┊8┊  GetChatGQL,\n```\n```diff\n@@ -17,10 +18,12 @@\n ┊17┊18┊  GetChat,\n ┊18┊19┊  RemoveMessages,\n ┊19┊20┊  RemoveAllMessages,\n+┊  ┊21┊  GetUsers,\n ┊20┊22┊} from '../../graphql';\n ┊21┊23┊import { DataProxy } from 'apollo-cache';\n ┊22┊24┊\n ┊23┊25┊const currentUserId = '1';\n+┊  ┊26┊const currentUserName = 'Ethan Gonzalez';\n ┊24┊27┊\n ┊25┊28┊@Injectable()\n ┊26┊29┊export class ChatsService {\n```\n```diff\n@@ -49,6 +52,10 @@\n ┊49┊52┊    this.chats$.subscribe(chats => this.chats = chats);\n ┊50┊53┊  }\n ┊51┊54┊\n+┊  ┊55┊  static getRandomId() {\n+┊  ┊56┊    return String(Math.round(Math.random() * 1000000000000));\n+┊  ┊57┊  }\n+┊  ┊58┊\n ┊52┊59┊  getChats() {\n ┊53┊60┊    return {query: this.getChatsWq, chats$: this.chats$};\n ┊54┊61┊  }\n```\n```diff\n@@ -70,6 +77,24 @@\n ┊ 70┊ 77┊      chatId,\n ┊ 71┊ 78┊      content,\n ┊ 72┊ 79┊    }, {\n+┊   ┊ 80┊      optimisticResponse: {\n+┊   ┊ 81┊        __typename: 'Mutation',\n+┊   ┊ 82┊        addMessage: {\n+┊   ┊ 83┊          id: ChatsService.getRandomId(),\n+┊   ┊ 84┊          __typename: 'Message',\n+┊   ┊ 85┊          senderId: currentUserId,\n+┊   ┊ 86┊          sender: {\n+┊   ┊ 87┊            id: currentUserId,\n+┊   ┊ 88┊            __typename: 'User',\n+┊   ┊ 89┊            name: currentUserName,\n+┊   ┊ 90┊          },\n+┊   ┊ 91┊          content,\n+┊   ┊ 92┊          createdAt: moment().unix(),\n+┊   ┊ 93┊          type: 0,\n+┊   ┊ 94┊          recipients: [],\n+┊   ┊ 95┊          ownership: true,\n+┊   ┊ 96┊        },\n+┊   ┊ 97┊      },\n ┊ 73┊ 98┊      update: (store, { data: { addMessage } }: {data: AddMessage.Mutation}) => {\n ┊ 74┊ 99┊        // Update the messages cache\n ┊ 75┊100┊        {\n```\n```diff\n@@ -121,6 +146,10 @@\n ┊121┊146┊      {\n ┊122┊147┊        chatId,\n ┊123┊148┊      }, {\n+┊   ┊149┊        optimisticResponse: {\n+┊   ┊150┊          __typename: 'Mutation',\n+┊   ┊151┊          removeChat: chatId,\n+┊   ┊152┊        },\n ┊124┊153┊        update: (store, { data: { removeChat } }) => {\n ┊125┊154┊          // Read the data from our cache for this query.\n ┊126┊155┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n```\n```diff\n@@ -154,6 +183,10 @@\n ┊154┊183┊    let ids: string[] = [];\n ┊155┊184┊\n ┊156┊185┊    const options = {\n+┊   ┊186┊      optimisticResponse: () => ({\n+┊   ┊187┊        __typename: 'Mutation',\n+┊   ┊188┊        removeMessages: ids,\n+┊   ┊189┊      }),\n ┊157┊190┊      update: (store: DataProxy, { data: { removeMessages } }: {data: RemoveMessages.Mutation | RemoveAllMessages.Mutation}) => {\n ┊158┊191┊        // Update the messages cache\n ┊159┊192┊        {\n```\n```diff\n@@ -242,11 +275,33 @@\n ┊242┊275┊    return _chat ? _chat.id : false;\n ┊243┊276┊  }\n ┊244┊277┊\n-┊245┊   ┊  addChat(recipientId: string) {\n+┊   ┊278┊  addChat(recipientId: string, users: GetUsers.Users[]) {\n ┊246┊279┊    return this.addChatGQL.mutate(\n ┊247┊280┊      {\n ┊248┊281┊        recipientId,\n ┊249┊282┊      }, {\n+┊   ┊283┊        optimisticResponse: {\n+┊   ┊284┊          __typename: 'Mutation',\n+┊   ┊285┊          addChat: {\n+┊   ┊286┊            id: ChatsService.getRandomId(),\n+┊   ┊287┊            __typename: 'Chat',\n+┊   ┊288┊            name: users.find(user => user.id === recipientId).name,\n+┊   ┊289┊            picture: users.find(user => user.id === recipientId).picture,\n+┊   ┊290┊            allTimeMembers: [\n+┊   ┊291┊              {\n+┊   ┊292┊                id: currentUserId,\n+┊   ┊293┊                __typename: 'User',\n+┊   ┊294┊              },\n+┊   ┊295┊              {\n+┊   ┊296┊                id: recipientId,\n+┊   ┊297┊                __typename: 'User',\n+┊   ┊298┊              }\n+┊   ┊299┊            ],\n+┊   ┊300┊            unreadMessages: 0,\n+┊   ┊301┊            messages: [],\n+┊   ┊302┊            isGroup: false,\n+┊   ┊303┊          },\n+┊   ┊304┊        },\n ┊250┊305┊        update: (store, { data: { addChat } }) => {\n ┊251┊306┊          // Read the data from our cache for this query.\n ┊252┊307┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n```\n```diff\n@@ -278,6 +333,26 @@\n ┊278┊333┊        recipientIds,\n ┊279┊334┊        groupName,\n ┊280┊335┊      }, {\n+┊   ┊336┊        optimisticResponse: {\n+┊   ┊337┊          __typename: 'Mutation',\n+┊   ┊338┊          addGroup: {\n+┊   ┊339┊            id: ChatsService.getRandomId(),\n+┊   ┊340┊            __typename: 'Chat',\n+┊   ┊341┊            name: groupName,\n+┊   ┊342┊            picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n+┊   ┊343┊            userIds: [currentUserId, recipientIds],\n+┊   ┊344┊            allTimeMembers: [\n+┊   ┊345┊              {\n+┊   ┊346┊                id: currentUserId,\n+┊   ┊347┊                __typename: 'User',\n+┊   ┊348┊              },\n+┊   ┊349┊              ...recipientIds.map(id => ({id, __typename: 'User'})),\n+┊   ┊350┊            ],\n+┊   ┊351┊            unreadMessages: 0,\n+┊   ┊352┊            messages: [],\n+┊   ┊353┊            isGroup: true,\n+┊   ┊354┊          },\n+┊   ┊355┊        },\n ┊281┊356┊        update: (store, { data: { addGroup } }) => {\n ┊282┊357┊          // Read the data from our cache for this query.\n ┊283┊358┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n```\n\n[}]: #\n\nWhen we open a specific chat we can also preload some data from our chats list cache while waiting for the server response. We will initially be able to show only the chat name, the last message or the last few messages and a few more informations instead of the whole content from the server, but that would be more than enough to entertain the user while waiting for the server response:\n\n[{]: <helper> (diffStep \"9.2\" module=\"client\")\n\n#### [Step 9.2: Get chat data from chats cache while waiting for server response](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/632468a)\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,6 +1,6 @@\n-┊1┊ ┊import {map} from 'rxjs/operators';\n+┊ ┊1┊import {concat, map} from 'rxjs/operators';\n ┊2┊2┊import {Injectable} from '@angular/core';\n-┊3┊ ┊import {Observable} from 'rxjs';\n+┊ ┊3┊import {Observable, AsyncSubject, of} from 'rxjs';\n ┊4┊4┊import {QueryRef} from 'apollo-angular';\n ┊5┊5┊import * as moment from 'moment';\n ┊6┊6┊import {\n```\n```diff\n@@ -31,6 +31,7 @@\n ┊31┊31┊  getChatsWq: QueryRef<GetChats.Query, GetChats.Variables>;\n ┊32┊32┊  chats$: Observable<GetChats.Chats[]>;\n ┊33┊33┊  chats: GetChats.Chats[];\n+┊  ┊34┊  getChatWqSubject: AsyncSubject<QueryRef<GetChat.Query>>;\n ┊34┊35┊\n ┊35┊36┊  constructor(\n ┊36┊37┊    private getChatsGQL: GetChatsGQL,\n```\n```diff\n@@ -61,15 +62,34 @@\n ┊61┊62┊  }\n ┊62┊63┊\n ┊63┊64┊  getChat(chatId: string) {\n+┊  ┊65┊    const _chat = this.chats && this.chats.find(chat => chat.id === chatId) || {\n+┊  ┊66┊      id: chatId,\n+┊  ┊67┊      name: '',\n+┊  ┊68┊      picture: null,\n+┊  ┊69┊      allTimeMembers: [],\n+┊  ┊70┊      unreadMessages: 0,\n+┊  ┊71┊      isGroup: false,\n+┊  ┊72┊      messages: [],\n+┊  ┊73┊    };\n+┊  ┊74┊    const chat$FromCache = of<GetChat.Chat>(_chat);\n+┊  ┊75┊\n ┊64┊76┊    const query = this.getChatGQL.watch({\n ┊65┊77┊      chatId: chatId,\n ┊66┊78┊    });\n ┊67┊79┊\n-┊68┊  ┊    const chat$ = query.valueChanges.pipe(\n-┊69┊  ┊      map((result) => result.data.chat)\n+┊  ┊80┊    const chat$ = chat$FromCache.pipe(\n+┊  ┊81┊      concat(\n+┊  ┊82┊        query.valueChanges.pipe(\n+┊  ┊83┊          map((result) => result.data.chat)\n+┊  ┊84┊        )\n+┊  ┊85┊      )\n ┊70┊86┊    );\n ┊71┊87┊\n-┊72┊  ┊    return {query, chat$};\n+┊  ┊88┊    this.getChatWqSubject = new AsyncSubject();\n+┊  ┊89┊    this.getChatWqSubject.next(query);\n+┊  ┊90┊    this.getChatWqSubject.complete();\n+┊  ┊91┊\n+┊  ┊92┊    return {query$: this.getChatWqSubject.asObservable(), chat$};\n ┊73┊93┊  }\n ┊74┊94┊\n ┊75┊95┊  addMessage(chatId: string, content: string) {\n```\n\n[}]: #\n\nNow let's deal with the most difficult part, chats creation.\n\nWe cannot predict the `id` of the new chat and so we cannot navigate to the chat page because it contains the chat id in the url. We could simply navigate to the \"optimistic\" id, but then the user wouldn't be able to reach that url if he refreshes the page or bookmarks it. That's a problem we care about.\n\nHow to solve it? We're going to create a landing page and we will later override the url once we get the response from the server!\n\n[{]: <helper> (diffStep \"9.3\" module=\"client\")\n\n#### [Step 9.3: Landing page for new chats/groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/87b9f5d)\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.spec.ts\n```diff\n@@ -129,7 +129,10 @@\n ┊129┊129┊        },\n ┊130┊130┊        {\n ┊131┊131┊          provide: ActivatedRoute,\n-┊132┊   ┊          useValue: { params: of({ id: chat.id }) },\n+┊   ┊132┊          useValue: {\n+┊   ┊133┊            params: of({ id: chat.id }),\n+┊   ┊134┊            queryParams: of({}),\n+┊   ┊135┊          },\n ┊133┊136┊        },\n ┊134┊137┊      ],\n ┊135┊138┊      schemas: [NO_ERRORS_SCHEMA],\n```\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.ts\n```diff\n@@ -2,6 +2,8 @@\n ┊2┊2┊import {ActivatedRoute, Router} from '@angular/router';\n ┊3┊3┊import {ChatsService} from '../../../services/chats.service';\n ┊4┊4┊import {GetChat} from '../../../../graphql';\n+┊ ┊5┊import {combineLatest} from 'rxjs';\n+┊ ┊6┊import {Location} from '@angular/common';\n ┊5┊7┊\n ┊6┊8┊@Component({\n ┊7┊9┊  template: `\n```\n```diff\n@@ -27,21 +29,40 @@\n ┊27┊29┊  messages: GetChat.Messages[];\n ┊28┊30┊  name: string;\n ┊29┊31┊  isGroup: boolean;\n+┊  ┊32┊  optimisticUI: boolean;\n ┊30┊33┊\n ┊31┊34┊  constructor(private route: ActivatedRoute,\n ┊32┊35┊              private router: Router,\n+┊  ┊36┊              private location: Location,\n ┊33┊37┊              private chatsService: ChatsService) {\n ┊34┊38┊  }\n ┊35┊39┊\n ┊36┊40┊  ngOnInit() {\n-┊37┊  ┊    this.route.params.subscribe(({id: chatId}) => {\n-┊38┊  ┊      this.chatId = chatId;\n-┊39┊  ┊      this.chatsService.getChat(chatId).chat$.subscribe(chat => {\n-┊40┊  ┊        this.messages = chat.messages;\n-┊41┊  ┊        this.name = chat.name;\n-┊42┊  ┊        this.isGroup = chat.isGroup;\n+┊  ┊41┊    combineLatest(this.route.params, this.route.queryParams,\n+┊  ┊42┊      (params: { id: string }, queryParams: { oui?: boolean }) => ({params, queryParams}))\n+┊  ┊43┊      .subscribe(({params: {id: chatId}, queryParams: {oui}}) => {\n+┊  ┊44┊        this.chatId = chatId;\n+┊  ┊45┊\n+┊  ┊46┊        this.optimisticUI = oui;\n+┊  ┊47┊\n+┊  ┊48┊        if (this.optimisticUI) {\n+┊  ┊49┊          // We are using fake IDs generated by the Optimistic UI\n+┊  ┊50┊          this.chatsService.addChat$.subscribe(({data: {addChat, addGroup}}) => {\n+┊  ┊51┊            this.chatId = addChat ? addChat.id : addGroup.id;\n+┊  ┊52┊            console.log(`Switching from the Optimistic UI id ${chatId} to ${this.chatId}`);\n+┊  ┊53┊            // Rewrite the URL\n+┊  ┊54┊            this.location.go(`chat/${this.chatId}`);\n+┊  ┊55┊            // Optimistic UI no more\n+┊  ┊56┊            this.optimisticUI = false;\n+┊  ┊57┊          });\n+┊  ┊58┊        }\n+┊  ┊59┊\n+┊  ┊60┊        this.chatsService.getChat(chatId, this.optimisticUI).chat$.subscribe(chat => {\n+┊  ┊61┊          this.messages = chat.messages;\n+┊  ┊62┊          this.name = chat.name;\n+┊  ┊63┊          this.isGroup = chat.isGroup;\n+┊  ┊64┊        });\n ┊43┊65┊      });\n-┊44┊  ┊    });\n ┊45┊66┊  }\n ┊46┊67┊\n ┊47┊68┊  goToChats() {\n```\n\n##### Changed src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-chat&#x2F;new-chat.component.ts\n```diff\n@@ -47,9 +47,10 @@\n ┊47┊47┊      // Chat is already listed for the current user\n ┊48┊48┊      this.router.navigate(['/chat', chatId]);\n ┊49┊49┊    } else {\n-┊50┊  ┊      this.chatsService.addChat(recipientId, this.users).subscribe(({data: {addChat: {id}}}: { data: AddChat.Mutation }) => {\n-┊51┊  ┊        this.router.navigate(['/chat', id]);\n-┊52┊  ┊      });\n+┊  ┊50┊      // Generate id for Optimistic UI\n+┊  ┊51┊      const ouiId = ChatsService.getRandomId();\n+┊  ┊52┊      this.chatsService.addChat(recipientId, this.users, ouiId).subscribe();\n+┊  ┊53┊      this.router.navigate(['/chat', ouiId], {queryParams: {oui: true}, skipLocationChange: true});\n ┊53┊54┊    }\n ┊54┊55┊  }\n ┊55┊56┊}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-group&#x2F;new-group.component.ts\n```diff\n@@ -52,9 +52,9 @@\n ┊52┊52┊\n ┊53┊53┊  addGroup(groupName: string) {\n ┊54┊54┊    if (groupName && this.recipientIds.length) {\n-┊55┊  ┊      this.chatsService.addGroup(this.recipientIds, groupName).subscribe(({data: {addGroup: {id}}}: { data: AddGroup.Mutation }) => {\n-┊56┊  ┊        this.router.navigate(['/chat', id]);\n-┊57┊  ┊      });\n+┊  ┊55┊      const ouiId = ChatsService.getRandomId();\n+┊  ┊56┊      this.chatsService.addGroup(this.recipientIds, groupName, ouiId).subscribe();\n+┊  ┊57┊      this.router.navigate(['/chat', ouiId], {queryParams: {oui: true}, skipLocationChange: true});\n ┊58┊58┊    }\n ┊59┊59┊  }\n ┊60┊60┊}\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,4 +1,4 @@\n-┊1┊ ┊import {concat, map} from 'rxjs/operators';\n+┊ ┊1┊import {concat, map, share, switchMap} from 'rxjs/operators';\n ┊2┊2┊import {Injectable} from '@angular/core';\n ┊3┊3┊import {Observable, AsyncSubject, of} from 'rxjs';\n ┊4┊4┊import {QueryRef} from 'apollo-angular';\n```\n```diff\n@@ -19,8 +19,11 @@\n ┊19┊19┊  RemoveMessages,\n ┊20┊20┊  RemoveAllMessages,\n ┊21┊21┊  GetUsers,\n+┊  ┊22┊  AddChat,\n+┊  ┊23┊  AddGroup,\n ┊22┊24┊} from '../../graphql';\n ┊23┊25┊import { DataProxy } from 'apollo-cache';\n+┊  ┊26┊import { FetchResult } from 'apollo-link';\n ┊24┊27┊\n ┊25┊28┊const currentUserId = '1';\n ┊26┊29┊const currentUserName = 'Ethan Gonzalez';\n```\n```diff\n@@ -32,6 +35,7 @@\n ┊32┊35┊  chats$: Observable<GetChats.Chats[]>;\n ┊33┊36┊  chats: GetChats.Chats[];\n ┊34┊37┊  getChatWqSubject: AsyncSubject<QueryRef<GetChat.Query>>;\n+┊  ┊38┊  addChat$: Observable<FetchResult<AddChat.Mutation | AddGroup.Mutation>>;\n ┊35┊39┊\n ┊36┊40┊  constructor(\n ┊37┊41┊    private getChatsGQL: GetChatsGQL,\n```\n```diff\n@@ -61,7 +65,7 @@\n ┊61┊65┊    return {query: this.getChatsWq, chats$: this.chats$};\n ┊62┊66┊  }\n ┊63┊67┊\n-┊64┊  ┊  getChat(chatId: string) {\n+┊  ┊68┊  getChat(chatId: string, oui?: boolean) {\n ┊65┊69┊    const _chat = this.chats && this.chats.find(chat => chat.id === chatId) || {\n ┊66┊70┊      id: chatId,\n ┊67┊71┊      name: '',\n```\n```diff\n@@ -73,21 +77,43 @@\n ┊ 73┊ 77┊    };\n ┊ 74┊ 78┊    const chat$FromCache = of<GetChat.Chat>(_chat);\n ┊ 75┊ 79┊\n-┊ 76┊   ┊    const query = this.getChatGQL.watch({\n-┊ 77┊   ┊      chatId: chatId,\n-┊ 78┊   ┊    });\n-┊ 79┊   ┊\n-┊ 80┊   ┊    const chat$ = chat$FromCache.pipe(\n-┊ 81┊   ┊      concat(\n-┊ 82┊   ┊        query.valueChanges.pipe(\n-┊ 83┊   ┊          map((result) => result.data.chat)\n-┊ 84┊   ┊        )\n-┊ 85┊   ┊      )\n-┊ 86┊   ┊    );\n+┊   ┊ 80┊    const getApolloWatchQuery = (id: string) => {\n+┊   ┊ 81┊      return this.getChatGQL.watch({\n+┊   ┊ 82┊        chatId: id,\n+┊   ┊ 83┊      });\n+┊   ┊ 84┊    };\n ┊ 87┊ 85┊\n+┊   ┊ 86┊    let chat$: Observable<GetChat.Chat>;\n ┊ 88┊ 87┊    this.getChatWqSubject = new AsyncSubject();\n-┊ 89┊   ┊    this.getChatWqSubject.next(query);\n-┊ 90┊   ┊    this.getChatWqSubject.complete();\n+┊   ┊ 88┊\n+┊   ┊ 89┊    if (oui) {\n+┊   ┊ 90┊      chat$ = chat$FromCache.pipe(\n+┊   ┊ 91┊        concat(this.addChat$.pipe(\n+┊   ┊ 92┊          switchMap(({ data: { addChat, addGroup } }) => {\n+┊   ┊ 93┊            const query = getApolloWatchQuery(addChat ? addChat.id : addGroup.id);\n+┊   ┊ 94┊\n+┊   ┊ 95┊            this.getChatWqSubject.next(query);\n+┊   ┊ 96┊            this.getChatWqSubject.complete();\n+┊   ┊ 97┊\n+┊   ┊ 98┊            return query.valueChanges.pipe(\n+┊   ┊ 99┊              map((result) => result.data.chat)\n+┊   ┊100┊            );\n+┊   ┊101┊          }))\n+┊   ┊102┊        ));\n+┊   ┊103┊    } else {\n+┊   ┊104┊      const query = getApolloWatchQuery(chatId);\n+┊   ┊105┊\n+┊   ┊106┊      this.getChatWqSubject.next(query);\n+┊   ┊107┊      this.getChatWqSubject.complete();\n+┊   ┊108┊\n+┊   ┊109┊      chat$ = chat$FromCache.pipe(\n+┊   ┊110┊        concat(\n+┊   ┊111┊          query.valueChanges.pipe(\n+┊   ┊112┊            map((result) => result.data.chat)\n+┊   ┊113┊          )\n+┊   ┊114┊        )\n+┊   ┊115┊      );\n+┊   ┊116┊    }\n ┊ 91┊117┊\n ┊ 92┊118┊    return {query$: this.getChatWqSubject.asObservable(), chat$};\n ┊ 93┊119┊  }\n```\n```diff\n@@ -295,15 +321,15 @@\n ┊295┊321┊    return _chat ? _chat.id : false;\n ┊296┊322┊  }\n ┊297┊323┊\n-┊298┊   ┊  addChat(recipientId: string, users: GetUsers.Users[]) {\n-┊299┊   ┊    return this.addChatGQL.mutate(\n+┊   ┊324┊  addChat(recipientId: string, users: GetUsers.Users[], ouiId: string) {\n+┊   ┊325┊    this.addChat$ = this.addChatGQL.mutate(\n ┊300┊326┊      {\n ┊301┊327┊        recipientId,\n ┊302┊328┊      }, {\n ┊303┊329┊        optimisticResponse: {\n ┊304┊330┊          __typename: 'Mutation',\n ┊305┊331┊          addChat: {\n-┊306┊   ┊            id: ChatsService.getRandomId(),\n+┊   ┊332┊            id: ouiId,\n ┊307┊333┊            __typename: 'Chat',\n ┊308┊334┊            name: users.find(user => user.id === recipientId).name,\n ┊309┊335┊            picture: users.find(user => user.id === recipientId).picture,\n```\n```diff\n@@ -344,11 +370,12 @@\n ┊344┊370┊          });\n ┊345┊371┊        },\n ┊346┊372┊      }\n-┊347┊   ┊    );\n+┊   ┊373┊    ).pipe(share());\n+┊   ┊374┊    return this.addChat$;\n ┊348┊375┊  }\n ┊349┊376┊\n-┊350┊   ┊  addGroup(recipientIds: string[], groupName: string) {\n-┊351┊   ┊    return this.addGroupGQL.mutate(\n+┊   ┊377┊  addGroup(recipientIds: string[], groupName: string, ouiId: string) {\n+┊   ┊378┊    this.addChat$ = this.addGroupGQL.mutate(\n ┊352┊379┊      {\n ┊353┊380┊        recipientIds,\n ┊354┊381┊        groupName,\n```\n```diff\n@@ -356,7 +383,7 @@\n ┊356┊383┊        optimisticResponse: {\n ┊357┊384┊          __typename: 'Mutation',\n ┊358┊385┊          addGroup: {\n-┊359┊   ┊            id: ChatsService.getRandomId(),\n+┊   ┊386┊            id: ouiId,\n ┊360┊387┊            __typename: 'Chat',\n ┊361┊388┊            name: groupName,\n ┊362┊389┊            picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n```\n```diff\n@@ -395,6 +422,7 @@\n ┊395┊422┊          });\n ┊396┊423┊        },\n ┊397┊424┊      }\n-┊398┊   ┊    );\n+┊   ┊425┊    ).pipe(share());\n+┊   ┊426┊    return this.addChat$;\n ┊399┊427┊  }\n ┊400┊428┊}\n```\n\n[}]: #\n\nPoof, now our Whatsapp clone feels no more like a clone it has the same native feel."
          },
          {
            "manualTitle": "Step 14: Authentication",
            "stepRevision": "3bbd4a531535c2e7e356cdf86f77e6f301264e21",
            "manualView": "![login](https://user-images.githubusercontent.com/7648874/49270369-06c22200-f4a4-11e8-83e5-cef2400989a6.jpg)\n\n## Authentication on server\n\nAuthentication is an hot topic in the GraphQL world and there are some projects which aim at authenticating through GraphQL.\nSince often you will be required to use a specific auth framework (because of a feature you need or because of an existing authorization infrastructure) I will show you how to use a classic REST API framework within your GraphQL application.\nThis approach is completely fine and in line with the official GraphQL best practices.\nWe will use `Passport` for the authentication and `BasicAuth` as the auth mechanism:\n\n    yarn add bcrypt-nodejs passport passport-http\n    yarn add -D @types/bcrypt-nodejs @types/passport @types/passport-http\n\n`BasicAuth` basically involves to send username e password in an Authorization Header together with each request and is fully supported by any browser (meaning that we will be able to use `Graphiql` simply by proving username and password in the login window provided by the browser itself).\nIt's the most simple auth mechanism but it's completely fine for our needs. Later we could decide to use something more complicated like `JWT`, but it's outside of the scope of this tutorial.\n\n[{]: <helper> (diffStep \"4.1\" files=\"index.ts\" module=\"server\")\n\n#### [Step 4.1: Authentication](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/2ee3fa9)\n\n##### Changed index.ts\n```diff\n@@ -3,6 +3,47 @@\n ┊ 3┊ 3┊import * as cors from 'cors';\n ┊ 4┊ 4┊import * as express from 'express';\n ┊ 5┊ 5┊import { ApolloServer } from \"apollo-server-express\";\n+┊  ┊ 6┊import * as passport from \"passport\";\n+┊  ┊ 7┊import * as basicStrategy from 'passport-http';\n+┊  ┊ 8┊import * as bcrypt from 'bcrypt-nodejs';\n+┊  ┊ 9┊import { db, User } from \"./db\";\n+┊  ┊10┊\n+┊  ┊11┊let users = db.users;\n+┊  ┊12┊\n+┊  ┊13┊function generateHash(password: string) {\n+┊  ┊14┊  return bcrypt.hashSync(password, bcrypt.genSaltSync(8));\n+┊  ┊15┊}\n+┊  ┊16┊\n+┊  ┊17┊function validPassword(password: string, localPassword: string) {\n+┊  ┊18┊  return bcrypt.compareSync(password, localPassword);\n+┊  ┊19┊}\n+┊  ┊20┊\n+┊  ┊21┊passport.use('basic-signin', new basicStrategy.BasicStrategy(\n+┊  ┊22┊  function (username: string, password: string, done: any) {\n+┊  ┊23┊    const user = users.find(user => user.username == username);\n+┊  ┊24┊    if (user && validPassword(password, user.password)) {\n+┊  ┊25┊      return done(null, user);\n+┊  ┊26┊    }\n+┊  ┊27┊    return done(null, false);\n+┊  ┊28┊  }\n+┊  ┊29┊));\n+┊  ┊30┊\n+┊  ┊31┊passport.use('basic-signup', new basicStrategy.BasicStrategy({passReqToCallback: true},\n+┊  ┊32┊  function (req: any, username: any, password: any, done: any) {\n+┊  ┊33┊    const userExists = !!users.find(user => user.username === username);\n+┊  ┊34┊    if (!userExists && password && req.body.name) {\n+┊  ┊35┊      const user: User = {\n+┊  ┊36┊        id: (users.length && users[users.length - 1].id + 1) || 1,\n+┊  ┊37┊        username,\n+┊  ┊38┊        password: generateHash(password),\n+┊  ┊39┊        name: req.body.name,\n+┊  ┊40┊      };\n+┊  ┊41┊      users.push(user);\n+┊  ┊42┊      return done(null, user);\n+┊  ┊43┊    }\n+┊  ┊44┊    return done(null, false);\n+┊  ┊45┊  }\n+┊  ┊46┊));\n ┊ 6┊47┊\n ┊ 7┊48┊const PORT = 3000;\n ┊ 8┊49┊\n```\n```diff\n@@ -10,9 +51,27 @@\n ┊10┊51┊\n ┊11┊52┊app.use(cors());\n ┊12┊53┊app.use(bodyParser.json());\n+┊  ┊54┊app.use(passport.initialize());\n+┊  ┊55┊\n+┊  ┊56┊app.post('/signup',\n+┊  ┊57┊  passport.authenticate('basic-signup', {session: false}),\n+┊  ┊58┊  function (req: any, res) {\n+┊  ┊59┊    res.json(req.user);\n+┊  ┊60┊  });\n+┊  ┊61┊\n+┊  ┊62┊app.use(passport.authenticate('basic-signin', {session: false}));\n+┊  ┊63┊\n+┊  ┊64┊app.post('/signin', function (req: any, res) {\n+┊  ┊65┊  res.json(req.user);\n+┊  ┊66┊});\n ┊13┊67┊\n ┊14┊68┊const apollo = new ApolloServer({\n-┊15┊  ┊  schema\n+┊  ┊69┊  schema,\n+┊  ┊70┊  context(received: any) {\n+┊  ┊71┊    return {\n+┊  ┊72┊      user: received.req!['user'],\n+┊  ┊73┊    }\n+┊  ┊74┊  },\n ┊16┊75┊});\n ┊17┊76┊\n ┊18┊77┊apollo.applyMiddleware({\n```\n\n[}]: #\n\nWe are going to store hashes instead of plain passwords, that's why we're using `bcrypt-nodejs`.\nWith `passport.use('basic-signin')` and `passport.use('basic-signup')` we define how the auth framework deals with our database (well, our JSON file for the moment).\n`app.post('/signup')` is the endpoint for creating new accounts, so we left it out of the authentication middleware (`app.use(passport.authenticate('basic-signin')`).\nWhat's of particular interest is that we're passing the user object to the GraphQL context.\n\n[{]: <helper> (diffStep \"4.1\" files=\"schema/resolvers.ts\" module=\"server\")\n\n#### [Step 4.1: Authentication](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/2ee3fa9)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -8,29 +8,28 @@\n ┊ 8┊ 8┊\n ┊ 9┊ 9┊let users = db.users;\n ┊10┊10┊let chats = db.chats;\n-┊11┊  ┊const currentUser = 1;\n ┊12┊11┊\n ┊13┊12┊export const resolvers: IResolvers = {\n ┊14┊13┊  Query: {\n ┊15┊14┊    // Show all users for the moment.\n-┊16┊  ┊    users: (): User[] => users.filter(user => user.id !== currentUser),\n-┊17┊  ┊    chats: (): Chat[] => chats.filter(chat => chat.listingMemberIds.includes(currentUser)),\n+┊  ┊15┊    users: (obj: any, args: any, {user: currentUser}: {user: User}): User[] => users.filter(user => user.id !== currentUser.id),\n+┊  ┊16┊    chats: (obj: any, args: any, {user: currentUser}: {user: User}): Chat[] => chats.filter(chat => chat.listingMemberIds.includes(currentUser.id)),\n ┊18┊17┊    chat: (obj: any, {chatId}: ChatQueryArgs): Chat | null => chats.find(chat => chat.id === Number(chatId)) || null,\n ┊19┊18┊  },\n ┊20┊19┊  Mutation: {\n-┊21┊  ┊    addChat: (obj: any, {recipientId}: AddChatMutationArgs): Chat => {\n+┊  ┊20┊    addChat: (obj: any, {recipientId}: AddChatMutationArgs, {user: currentUser}: {user: User}): Chat => {\n ┊22┊21┊      if (!users.find(user => user.id === Number(recipientId))) {\n ┊23┊22┊        throw new Error(`Recipient ${recipientId} doesn't exist.`);\n ┊24┊23┊      }\n ┊25┊24┊\n-┊26┊  ┊      const chat = chats.find(chat => !chat.name && chat.allTimeMemberIds.includes(currentUser) && chat.allTimeMemberIds.includes(Number(recipientId)));\n+┊  ┊25┊      const chat = chats.find(chat => !chat.name && chat.allTimeMemberIds.includes(currentUser.id) && chat.allTimeMemberIds.includes(Number(recipientId)));\n ┊27┊26┊      if (chat) {\n ┊28┊27┊        // Chat already exists. Both users are already in the allTimeMemberIds array\n ┊29┊28┊        const chatId = chat.id;\n-┊30┊  ┊        if (!chat.listingMemberIds.includes(currentUser)) {\n+┊  ┊29┊        if (!chat.listingMemberIds.includes(currentUser.id)) {\n ┊31┊30┊          // The chat isn't listed for the current user. Add him to the memberIds\n-┊32┊  ┊          chat.listingMemberIds.push(currentUser);\n-┊33┊  ┊          chats.find(chat => chat.id === chatId)!.listingMemberIds.push(currentUser);\n+┊  ┊31┊          chat.listingMemberIds.push(currentUser.id);\n+┊  ┊32┊          chats.find(chat => chat.id === chatId)!.listingMemberIds.push(currentUser.id);\n ┊34┊33┊          return chat;\n ┊35┊34┊        } else {\n ┊36┊35┊          throw new Error(`Chat already exists.`);\n```\n```diff\n@@ -44,9 +43,9 @@\n ┊44┊43┊          picture: null,\n ┊45┊44┊          adminIds: null,\n ┊46┊45┊          ownerId: null,\n-┊47┊  ┊          allTimeMemberIds: [currentUser, Number(recipientId)],\n+┊  ┊46┊          allTimeMemberIds: [currentUser.id, Number(recipientId)],\n ┊48┊47┊          // Chat will not be listed to the other user until the first message gets written\n-┊49┊  ┊          listingMemberIds: [currentUser],\n+┊  ┊48┊          listingMemberIds: [currentUser.id],\n ┊50┊49┊          actualGroupMemberIds: null,\n ┊51┊50┊          messages: [],\n ┊52┊51┊        };\n```\n```diff\n@@ -54,7 +53,7 @@\n ┊54┊53┊        return chat;\n ┊55┊54┊      }\n ┊56┊55┊    },\n-┊57┊  ┊    addGroup: (obj: any, {recipientIds, groupName}: AddGroupMutationArgs): Chat => {\n+┊  ┊56┊    addGroup: (obj: any, {recipientIds, groupName}: AddGroupMutationArgs, {user: currentUser}: {user: User}): Chat => {\n ┊58┊57┊      recipientIds.forEach(recipientId => {\n ┊59┊58┊        if (!users.find(user => user.id === Number(recipientId))) {\n ┊60┊59┊          throw new Error(`Recipient ${recipientId} doesn't exist.`);\n```\n```diff\n@@ -66,17 +65,17 @@\n ┊66┊65┊        id,\n ┊67┊66┊        name: groupName,\n ┊68┊67┊        picture: null,\n-┊69┊  ┊        adminIds: [currentUser],\n-┊70┊  ┊        ownerId: currentUser,\n-┊71┊  ┊        allTimeMemberIds: [currentUser, ...recipientIds.map(id => Number(id))],\n-┊72┊  ┊        listingMemberIds: [currentUser, ...recipientIds.map(id => Number(id))],\n-┊73┊  ┊        actualGroupMemberIds: [currentUser, ...recipientIds.map(id => Number(id))],\n+┊  ┊68┊        adminIds: [currentUser.id],\n+┊  ┊69┊        ownerId: currentUser.id,\n+┊  ┊70┊        allTimeMemberIds: [currentUser.id, ...recipientIds.map(id => Number(id))],\n+┊  ┊71┊        listingMemberIds: [currentUser.id, ...recipientIds.map(id => Number(id))],\n+┊  ┊72┊        actualGroupMemberIds: [currentUser.id, ...recipientIds.map(id => Number(id))],\n ┊74┊73┊        messages: [],\n ┊75┊74┊      };\n ┊76┊75┊      chats.push(chat);\n ┊77┊76┊      return chat;\n ┊78┊77┊    },\n-┊79┊  ┊    removeChat: (obj: any, {chatId}: RemoveChatMutationArgs): number => {\n+┊  ┊78┊    removeChat: (obj: any, {chatId}: RemoveChatMutationArgs, {user: currentUser}: {user: User}): number => {\n ┊80┊79┊      const chat = chats.find(chat => chat.id === Number(chatId));\n ┊81┊80┊\n ┊82┊81┊      if (!chat) {\n```\n```diff\n@@ -85,14 +84,14 @@\n ┊85┊84┊\n ┊86┊85┊      if (!chat.name) {\n ┊87┊86┊        // Chat\n-┊88┊  ┊        if (!chat.listingMemberIds.includes(currentUser)) {\n+┊  ┊87┊        if (!chat.listingMemberIds.includes(currentUser.id)) {\n ┊89┊88┊          throw new Error(`The user is not a member of the chat ${chatId}.`);\n ┊90┊89┊        }\n ┊91┊90┊\n ┊92┊91┊        // Instead of chaining map and filter we can loop once using reduce\n ┊93┊92┊        const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n ┊94┊93┊          // Remove the current user from the message holders\n-┊95┊  ┊          message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser);\n+┊  ┊94┊          message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser.id);\n ┊96┊95┊\n ┊97┊96┊          if (message.holderIds.length !== 0) {\n ┊98┊97┊            filtered.push(message);\n```\n```diff\n@@ -102,7 +101,7 @@\n ┊102┊101┊        }, []);\n ┊103┊102┊\n ┊104┊103┊        // Remove the current user from who gets the chat listed. The chat will no longer appear in his list\n-┊105┊   ┊        const listingMemberIds = chat.listingMemberIds.filter(listingId => listingId !== currentUser);\n+┊   ┊104┊        const listingMemberIds = chat.listingMemberIds.filter(listingId => listingId !== currentUser.id);\n ┊106┊105┊\n ┊107┊106┊        // Check how many members are left\n ┊108┊107┊        if (listingMemberIds.length === 0) {\n```\n```diff\n@@ -120,14 +119,14 @@\n ┊120┊119┊        return Number(chatId);\n ┊121┊120┊      } else {\n ┊122┊121┊        // Group\n-┊123┊   ┊        if (chat.ownerId !== currentUser) {\n+┊   ┊122┊        if (chat.ownerId !== currentUser.id) {\n ┊124┊123┊          throw new Error(`Group ${chatId} is not owned by the user.`);\n ┊125┊124┊        }\n ┊126┊125┊\n ┊127┊126┊        // Instead of chaining map and filter we can loop once using reduce\n ┊128┊127┊        const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n ┊129┊128┊          // Remove the current user from the message holders\n-┊130┊   ┊          message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser);\n+┊   ┊129┊          message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser.id);\n ┊131┊130┊\n ┊132┊131┊          if (message.holderIds.length !== 0) {\n ┊133┊132┊            filtered.push(message);\n```\n```diff\n@@ -137,7 +136,7 @@\n ┊137┊136┊        }, []);\n ┊138┊137┊\n ┊139┊138┊        // Remove the current user from who gets the group listed. The group will no longer appear in his list\n-┊140┊   ┊        const listingMemberIds = chat.listingMemberIds.filter(listingId => listingId !== currentUser);\n+┊   ┊139┊        const listingMemberIds = chat.listingMemberIds.filter(listingId => listingId !== currentUser.id);\n ┊141┊140┊\n ┊142┊141┊        // Check how many members (including previous ones who can still access old messages) are left\n ┊143┊142┊        if (listingMemberIds.length === 0) {\n```\n```diff\n@@ -147,9 +146,9 @@\n ┊147┊146┊          // Update the group\n ┊148┊147┊\n ┊149┊148┊          // Remove the current user from the chat members. He is no longer a member of the group\n-┊150┊   ┊          const actualGroupMemberIds = chat.actualGroupMemberIds!.filter(memberId => memberId !== currentUser);\n+┊   ┊149┊          const actualGroupMemberIds = chat.actualGroupMemberIds!.filter(memberId => memberId !== currentUser.id);\n ┊151┊150┊          // Remove the current user from the chat admins\n-┊152┊   ┊          const adminIds = chat.adminIds!.filter(memberId => memberId !== currentUser);\n+┊   ┊151┊          const adminIds = chat.adminIds!.filter(memberId => memberId !== currentUser.id);\n ┊153┊152┊          // Set the owner id to be null. A null owner means the group is read-only\n ┊154┊153┊          let ownerId: number | null = null;\n ┊155┊154┊\n```\n```diff\n@@ -169,7 +168,7 @@\n ┊169┊168┊        return Number(chatId);\n ┊170┊169┊      }\n ┊171┊170┊    },\n-┊172┊   ┊    addMessage: (obj: any, {chatId, content}: AddMessageMutationArgs): Message => {\n+┊   ┊171┊    addMessage: (obj: any, {chatId, content}: AddMessageMutationArgs, {user: currentUser}: {user: User}): Message => {\n ┊173┊172┊      if (content === null || content === '') {\n ┊174┊173┊        throw new Error(`Cannot add empty or null messages.`);\n ┊175┊174┊      }\n```\n```diff\n@@ -184,11 +183,11 @@\n ┊184┊183┊\n ┊185┊184┊      if (!chat.name) {\n ┊186┊185┊        // Chat\n-┊187┊   ┊        if (!chat.listingMemberIds.find(listingId => listingId === currentUser)) {\n+┊   ┊186┊        if (!chat.listingMemberIds.find(listingId => listingId === currentUser.id)) {\n ┊188┊187┊          throw new Error(`The chat ${chatId} must be listed for the current user before adding a message.`);\n ┊189┊188┊        }\n ┊190┊189┊\n-┊191┊   ┊        const recipientId = chat.allTimeMemberIds.filter(userId => userId !== currentUser)[0];\n+┊   ┊190┊        const recipientId = chat.allTimeMemberIds.filter(userId => userId !== currentUser.id)[0];\n ┊192┊191┊\n ┊193┊192┊        if (!chat.listingMemberIds.find(listingId => listingId === recipientId)) {\n ┊194┊193┊          // Chat is not listed for the recipient. Add him to the listingMemberIds\n```\n```diff\n@@ -205,7 +204,7 @@\n ┊205┊204┊        }\n ┊206┊205┊      } else {\n ┊207┊206┊        // Group\n-┊208┊   ┊        if (!chat.actualGroupMemberIds!.find(memberId => memberId === currentUser)) {\n+┊   ┊207┊        if (!chat.actualGroupMemberIds!.find(memberId => memberId === currentUser.id)) {\n ┊209┊208┊          throw new Error(`The user is not a member of the group ${chatId}. Cannot add message.`);\n ┊210┊209┊        }\n ┊211┊210┊\n```\n```diff\n@@ -217,7 +216,7 @@\n ┊217┊216┊      let recipients: Recipient[] = [];\n ┊218┊217┊\n ┊219┊218┊      holderIds.forEach(holderId => {\n-┊220┊   ┊        if (holderId !== currentUser) {\n+┊   ┊219┊        if (holderId !== currentUser.id) {\n ┊221┊220┊          recipients.push({\n ┊222┊221┊            userId: holderId,\n ┊223┊222┊            messageId: id,\n```\n```diff\n@@ -231,7 +230,7 @@\n ┊231┊230┊      const message: Message = {\n ┊232┊231┊        id,\n ┊233┊232┊        chatId: Number(chatId),\n-┊234┊   ┊        senderId: currentUser,\n+┊   ┊233┊        senderId: currentUser.id,\n ┊235┊234┊        content,\n ┊236┊235┊        createdAt: moment().unix(),\n ┊237┊236┊        type: MessageType.TEXT,\n```\n```diff\n@@ -248,14 +247,14 @@\n ┊248┊247┊\n ┊249┊248┊      return message;\n ┊250┊249┊    },\n-┊251┊   ┊    removeMessages: (obj: any, {chatId, messageIds, all}: RemoveMessagesMutationArgs): number[] => {\n+┊   ┊250┊    removeMessages: (obj: any, {chatId, messageIds, all}: RemoveMessagesMutationArgs, {user: currentUser}: {user: User}): number[] => {\n ┊252┊251┊      const chat = chats.find(chat => chat.id === Number(chatId));\n ┊253┊252┊\n ┊254┊253┊      if (!chat) {\n ┊255┊254┊        throw new Error(`Cannot find chat ${chatId}.`);\n ┊256┊255┊      }\n ┊257┊256┊\n-┊258┊   ┊      if (!chat.listingMemberIds.find(listingId => listingId === currentUser)) {\n+┊   ┊257┊      if (!chat.listingMemberIds.find(listingId => listingId === currentUser.id)) {\n ┊259┊258┊        throw new Error(`The chat/group ${chatId} is not listed for the current user, so there is nothing to delete.`);\n ┊260┊259┊      }\n ┊261┊260┊\n```\n```diff\n@@ -271,7 +270,7 @@\n ┊271┊270┊            if (all || messageIds!.includes(String(message.id))) {\n ┊272┊271┊              deletedIds.push(message.id);\n ┊273┊272┊              // Remove the current user from the message holders\n-┊274┊   ┊              message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser);\n+┊   ┊273┊              message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser.id);\n ┊275┊274┊            }\n ┊276┊275┊\n ┊277┊276┊            if (message.holderIds.length !== 0) {\n```\n```diff\n@@ -288,24 +287,24 @@\n ┊288┊287┊    },\n ┊289┊288┊  },\n ┊290┊289┊  Chat: {\n-┊291┊   ┊    name: (chat: Chat): string => chat.name ? chat.name : users\n-┊292┊   ┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser))!.name,\n-┊293┊   ┊    picture: (chat: Chat) => chat.name ? chat.picture : users\n-┊294┊   ┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser))!.picture,\n+┊   ┊290┊    name: (chat: Chat, args: any, {user: currentUser}: {user: User}): string => chat.name ? chat.name : users\n+┊   ┊291┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser.id))!.name,\n+┊   ┊292┊    picture: (chat: Chat, args: any, {user: currentUser}: {user: User}) => chat.name ? chat.picture : users\n+┊   ┊293┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser.id))!.picture,\n ┊295┊294┊    allTimeMembers: (chat: Chat): User[] => users.filter(user => chat.allTimeMemberIds.includes(user.id)),\n ┊296┊295┊    listingMembers: (chat: Chat): User[] => users.filter(user => chat.listingMemberIds.includes(user.id)),\n ┊297┊296┊    actualGroupMembers: (chat: Chat): User[] => users.filter(user => chat.actualGroupMemberIds && chat.actualGroupMemberIds.includes(user.id)),\n ┊298┊297┊    admins: (chat: Chat): User[] => users.filter(user => chat.adminIds && chat.adminIds.includes(user.id)),\n ┊299┊298┊    owner: (chat: Chat): User | null => users.find(user => chat.ownerId === user.id) || null,\n-┊300┊   ┊    messages: (chat: Chat, {amount = 0}: {amount: number}): Message[] => {\n+┊   ┊299┊    messages: (chat: Chat, {amount = 0}: {amount: number}, {user: currentUser}: {user: User}): Message[] => {\n ┊301┊300┊      const messages = chat.messages\n-┊302┊   ┊      .filter(message => message.holderIds.includes(currentUser))\n+┊   ┊301┊      .filter(message => message.holderIds.includes(currentUser.id))\n ┊303┊302┊      .sort((a, b) => b.createdAt - a.createdAt) || <Message[]>[];\n ┊304┊303┊      return (amount ? messages.slice(0, amount) : messages).reverse();\n ┊305┊304┊    },\n-┊306┊   ┊    unreadMessages: (chat: Chat): number => chat.messages\n-┊307┊   ┊      .filter(message => message.holderIds.includes(currentUser) &&\n-┊308┊   ┊        message.recipients.find(recipient => recipient.userId === currentUser && !recipient.readAt))\n+┊   ┊305┊    unreadMessages: (chat: Chat, args: any, {user: currentUser}: {user: User}): number => chat.messages\n+┊   ┊306┊      .filter(message => message.holderIds.includes(currentUser.id) &&\n+┊   ┊307┊        message.recipients.find(recipient => recipient.userId === currentUser.id && !recipient.readAt))\n ┊309┊308┊      .length,\n ┊310┊309┊    isGroup: (chat: Chat): boolean => !!chat.name,\n ┊311┊310┊  },\n```\n```diff\n@@ -313,7 +312,7 @@\n ┊313┊312┊    chat: (message: Message): Chat | null => chats.find(chat => message.chatId === chat.id) || null,\n ┊314┊313┊    sender: (message: Message): User | null => users.find(user => user.id === message.senderId) || null,\n ┊315┊314┊    holders: (message: Message): User[] => users.filter(user => message.holderIds.includes(user.id)),\n-┊316┊   ┊    ownership: (message: Message): boolean => message.senderId === currentUser,\n+┊   ┊315┊    ownership: (message: Message, args: any, {user: currentUser}: {user: User}): boolean => message.senderId === currentUser.id,\n ┊317┊316┊  },\n ┊318┊317┊  Recipient: {\n ┊319┊318┊    user: (recipient: Recipient): User | null => users.find(user => recipient.userId === user.id) || null,\n```\n\n[}]: #\n\nIn the resolvers we're basically making use of the user object taken from the context.\n\n## Authentication on client\n\nLet's start installing `@angular/flex-layout`, because we will use it later:\n\n    yarn add @angular/flex-layout\n\n\nFirst of all we need to create an `HTTP Interceptor`, which will intercept every HTTP request and will add authentication headers.\nFor the moment we still don't have those headers, but we are going to store them in the `LocalStorage` later.\nWe are also creating an `AuthGuard`, which we will use to stop the user from reaching unauthorized Routes.\n\nThe `AuthGuard` will simply look for the presence of the `Authentication` Header, but will not guarantee that the header is authentic.\nThis is no problem, because client side AuthGuards are not safe by design and the real authentication will be done server side anyway.\nAuthGuards are here just to redirect the user to the Login page.\n\nThe service we are going to create will contain some auth methods we are going to use across the app.\n\n[{]: <helper> (diffStep \"10.1\" files=\"src/app/login/services\" module=\"client\")\n\n#### [Step 10.1: Authentication](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/34faf60)\n\n##### Added src&#x2F;app&#x2F;login&#x2F;services&#x2F;auth.guard.ts\n```diff\n@@ -0,0 +1,18 @@\n+┊  ┊ 1┊import {Injectable} from '@angular/core';\n+┊  ┊ 2┊import {CanActivate, Router} from '@angular/router';\n+┊  ┊ 3┊import {LoginService} from './login.service';\n+┊  ┊ 4┊\n+┊  ┊ 5┊@Injectable()\n+┊  ┊ 6┊export class AuthGuard implements CanActivate {\n+┊  ┊ 7┊  constructor(private router: Router,\n+┊  ┊ 8┊              private loginService: LoginService) {}\n+┊  ┊ 9┊\n+┊  ┊10┊  canActivate() {\n+┊  ┊11┊    if (this.loginService.getAuthHeader()) {\n+┊  ┊12┊      return true;\n+┊  ┊13┊    } else {\n+┊  ┊14┊      this.router.navigate(['/login']);\n+┊  ┊15┊      return false;\n+┊  ┊16┊    }\n+┊  ┊17┊  }\n+┊  ┊18┊}\n```\n\n##### Added src&#x2F;app&#x2F;login&#x2F;services&#x2F;auth.interceptor.ts\n```diff\n@@ -0,0 +1,20 @@\n+┊  ┊ 1┊import {Injectable} from '@angular/core';\n+┊  ┊ 2┊import {HttpEvent, HttpHandler, HttpInterceptor, HttpRequest} from '@angular/common/http';\n+┊  ┊ 3┊import {Observable} from 'rxjs';\n+┊  ┊ 4┊import {LoginService} from './login.service';\n+┊  ┊ 5┊\n+┊  ┊ 6┊@Injectable()\n+┊  ┊ 7┊export class AuthInterceptor implements HttpInterceptor {\n+┊  ┊ 8┊  constructor(private loginService: LoginService) {}\n+┊  ┊ 9┊  intercept(request: HttpRequest<any>, next: HttpHandler): Observable<HttpEvent<any>> {\n+┊  ┊10┊    const auth = this.loginService.getAuthHeader();\n+┊  ┊11┊    if (auth) {\n+┊  ┊12┊      request = request.clone({\n+┊  ┊13┊        setHeaders: {\n+┊  ┊14┊          Authorization: auth,\n+┊  ┊15┊        }\n+┊  ┊16┊      });\n+┊  ┊17┊    }\n+┊  ┊18┊    return next.handle(request);\n+┊  ┊19┊  }\n+┊  ┊20┊}\n```\n\n##### Added src&#x2F;app&#x2F;login&#x2F;services&#x2F;login.service.ts\n```diff\n@@ -0,0 +1,24 @@\n+┊  ┊ 1┊import { Injectable } from '@angular/core';\n+┊  ┊ 2┊import {User} from '../../../graphql';\n+┊  ┊ 3┊\n+┊  ┊ 4┊@Injectable()\n+┊  ┊ 5┊export class LoginService {\n+┊  ┊ 6┊\n+┊  ┊ 7┊  constructor() { }\n+┊  ┊ 8┊\n+┊  ┊ 9┊  storeAuthHeader(auth: string) {\n+┊  ┊10┊    localStorage.setItem('Authorization', auth);\n+┊  ┊11┊  }\n+┊  ┊12┊\n+┊  ┊13┊  getAuthHeader(): string {\n+┊  ┊14┊    return localStorage.getItem('Authorization');\n+┊  ┊15┊  }\n+┊  ┊16┊\n+┊  ┊17┊  storeUser(user: User) {\n+┊  ┊18┊    localStorage.setItem('user', JSON.stringify(user));\n+┊  ┊19┊  }\n+┊  ┊20┊\n+┊  ┊21┊  getUser(): User {\n+┊  ┊22┊    return JSON.parse(localStorage.getItem('user'));\n+┊  ┊23┊  }\n+┊  ┊24┊}\n```\n\n[}]: #\n\nNow it's time to create a `SignIn`/`SignUp` component. Since we use Passport in the server we are going to make REST calls for the authentication, instead of using GraphQL.\nSince we use `Basic Auth` we will simply combine the username and the password together to create the authentication header.\nWe will also store the response from the server, which will contain the user information like the ID, etc. which we are going to need later.\n\nFirst we we will download a WhatsApp picture that will be used in the login component:\n\n    $ wget https://user-images.githubusercontent.com/7648874/49260078-e7f96680-f476-11e8-8711-06bc6490858a.png -P src/assets\n\nAnd then we will proceed to creating the component itself and everything around it:\n\n[{]: <helper> (diffStep \"10.1\" files=\"src/app/login/containers, src/app/login/login.module.ts\" module=\"client\")\n\n#### [Step 10.1: Authentication](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/34faf60)\n\n##### Added src&#x2F;app&#x2F;login&#x2F;containers&#x2F;login.component.scss\n```diff\n@@ -0,0 +1,18 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊}\n+┊  ┊ 4┊\n+┊  ┊ 5┊form:first-of-type {\n+┊  ┊ 6┊  margin-top: 24px;\n+┊  ┊ 7┊  margin-bottom: 48px;\n+┊  ┊ 8┊}\n+┊  ┊ 9┊\n+┊  ┊10┊label {\n+┊  ┊11┊  display: block;\n+┊  ┊12┊  margin-top: 4px;\n+┊  ┊13┊  margin-bottom: 4px;\n+┊  ┊14┊}\n+┊  ┊15┊\n+┊  ┊16┊.error {\n+┊  ┊17┊  color: red;\n+┊  ┊18┊}\n```\n\n##### Added src&#x2F;app&#x2F;login&#x2F;containers&#x2F;login.component.ts\n```diff\n@@ -0,0 +1,133 @@\n+┊   ┊  1┊import {Component} from '@angular/core';\n+┊   ┊  2┊import {HttpClient} from '@angular/common/http';\n+┊   ┊  3┊import {FormBuilder, Validators} from '@angular/forms';\n+┊   ┊  4┊// import {matchOtherValidator} from '@moebius/ng-validators';\n+┊   ┊  5┊import {Router} from '@angular/router';\n+┊   ┊  6┊import {User} from '../../../graphql';\n+┊   ┊  7┊import {LoginService} from '../services/login.service';\n+┊   ┊  8┊\n+┊   ┊  9┊@Component({\n+┊   ┊ 10┊  selector: 'app-login',\n+┊   ┊ 11┊  template: `\n+┊   ┊ 12┊    <form (ngSubmit)=\"signIn()\" [formGroup]=\"signInForm\" novalidate>\n+┊   ┊ 13┊      <fieldset fxLayout=\"column\" fxLayoutGap=\"17px\">\n+┊   ┊ 14┊        <legend>Sign in</legend>\n+┊   ┊ 15┊        <div>\n+┊   ┊ 16┊          <label>Username</label>\n+┊   ┊ 17┊          <input formControlName=\"username\" autocomplete=\"username\" type=\"text\">\n+┊   ┊ 18┊        </div>\n+┊   ┊ 19┊        <div class=\"error\" *ngIf=\"signInForm.get('username').hasError('required') && signInForm.get('username').touched\">\n+┊   ┊ 20┊          Username is required\n+┊   ┊ 21┊        </div>\n+┊   ┊ 22┊\n+┊   ┊ 23┊        <div>\n+┊   ┊ 24┊          <label>Password</label>\n+┊   ┊ 25┊          <input formControlName=\"password\" autocomplete=\"current-password\" type=\"password\">\n+┊   ┊ 26┊        </div>\n+┊   ┊ 27┊        <div class=\"error\" *ngIf=\"signInForm.get('password').hasError('required') && signInForm.get('password').touched\">\n+┊   ┊ 28┊          Password is required\n+┊   ┊ 29┊        </div>\n+┊   ┊ 30┊\n+┊   ┊ 31┊        <button type=\"submit\" [disabled]=\"signInForm.invalid\">Sign in</button>\n+┊   ┊ 32┊      </fieldset>\n+┊   ┊ 33┊    </form>\n+┊   ┊ 34┊\n+┊   ┊ 35┊    <form (ngSubmit)=\"signUp()\" [formGroup]=\"signUpForm\" novalidate>\n+┊   ┊ 36┊      <fieldset fxLayout=\"column\" fxLayoutGap=\"17px\">\n+┊   ┊ 37┊        <legend>Sign up</legend>\n+┊   ┊ 38┊        <div>\n+┊   ┊ 39┊          <label>Name</label>\n+┊   ┊ 40┊          <input formControlName=\"name\" type=\"text\">\n+┊   ┊ 41┊        </div>\n+┊   ┊ 42┊\n+┊   ┊ 43┊        <div>\n+┊   ┊ 44┊          <label>Username</label>\n+┊   ┊ 45┊          <input formControlName=\"username\" autocomplete=\"username\" type=\"text\">\n+┊   ┊ 46┊        </div>\n+┊   ┊ 47┊        <div class=\"error\" *ngIf=\"signUpForm.get('username').hasError('required') && signUpForm.get('username').touched\">\n+┊   ┊ 48┊          Username is required\n+┊   ┊ 49┊        </div>\n+┊   ┊ 50┊\n+┊   ┊ 51┊        <div>\n+┊   ┊ 52┊          <label>Password</label>\n+┊   ┊ 53┊          <input formControlName=\"newPassword\" autocomplete=\"new-password\" type=\"password\">\n+┊   ┊ 54┊        </div>\n+┊   ┊ 55┊        <div class=\"error\" *ngIf=\"signUpForm.get('newPassword').hasError('required') && signUpForm.get('newPassword').touched\">\n+┊   ┊ 56┊          Password is required\n+┊   ┊ 57┊        </div>\n+┊   ┊ 58┊\n+┊   ┊ 59┊        <div>\n+┊   ┊ 60┊          <label>Password</label>\n+┊   ┊ 61┊          <input formControlName=\"confirmPassword\" type=\"password\">\n+┊   ┊ 62┊        </div>\n+┊   ┊ 63┊        <div class=\"error\" *ngIf=\"signUpForm.get('confirmPassword').hasError('required') && signUpForm.get('confirmPassword').touched\">\n+┊   ┊ 64┊          Passwords must match\n+┊   ┊ 65┊        </div>\n+┊   ┊ 66┊\n+┊   ┊ 67┊        <button type=\"submit\" [disabled]=\"signUpForm.invalid\">Sign up</button>\n+┊   ┊ 68┊      </fieldset>\n+┊   ┊ 69┊    </form>\n+┊   ┊ 70┊  `,\n+┊   ┊ 71┊  styleUrls: ['./login.component.scss'],\n+┊   ┊ 72┊})\n+┊   ┊ 73┊export class LoginComponent {\n+┊   ┊ 74┊  signInForm = this.fb.group({\n+┊   ┊ 75┊    username: [null, [\n+┊   ┊ 76┊      Validators.required,\n+┊   ┊ 77┊    ]],\n+┊   ┊ 78┊    password: [null, [\n+┊   ┊ 79┊      Validators.required,\n+┊   ┊ 80┊    ]],\n+┊   ┊ 81┊  });\n+┊   ┊ 82┊\n+┊   ┊ 83┊  signUpForm = this.fb.group({\n+┊   ┊ 84┊    name: [null, [\n+┊   ┊ 85┊      Validators.required,\n+┊   ┊ 86┊    ]],\n+┊   ┊ 87┊    username: [null, [\n+┊   ┊ 88┊      Validators.required,\n+┊   ┊ 89┊    ]],\n+┊   ┊ 90┊    newPassword: [null, [\n+┊   ┊ 91┊      Validators.required,\n+┊   ┊ 92┊    ]],\n+┊   ┊ 93┊    confirmPassword: [null, [\n+┊   ┊ 94┊      Validators.required,\n+┊   ┊ 95┊      // matchOtherValidator('newPassword'),\n+┊   ┊ 96┊    ]],\n+┊   ┊ 97┊  });\n+┊   ┊ 98┊\n+┊   ┊ 99┊  constructor(private http: HttpClient,\n+┊   ┊100┊              private fb: FormBuilder,\n+┊   ┊101┊              private router: Router,\n+┊   ┊102┊              private loginService: LoginService) {}\n+┊   ┊103┊\n+┊   ┊104┊  signIn() {\n+┊   ┊105┊    const {username, password} = this.signInForm.value;\n+┊   ┊106┊    const auth = `Basic ${btoa(`${username}:${password}`)}`;\n+┊   ┊107┊    this.http.post('http://localhost:3000/signin', null, {\n+┊   ┊108┊      headers: {\n+┊   ┊109┊        Authorization: auth,\n+┊   ┊110┊      }\n+┊   ┊111┊    }).subscribe((user: User) => {\n+┊   ┊112┊      this.loginService.storeAuthHeader(auth);\n+┊   ┊113┊      this.loginService.storeUser(user);\n+┊   ┊114┊      this.router.navigate(['/chats']);\n+┊   ┊115┊    }, err => console.error(err));\n+┊   ┊116┊  }\n+┊   ┊117┊\n+┊   ┊118┊  signUp() {\n+┊   ┊119┊    const {username, newPassword: password, name} = this.signInForm.value;\n+┊   ┊120┊    const auth = `Basic ${btoa(`${username}:${password}`)}`;\n+┊   ┊121┊    this.http.post('http://localhost:3000/signup', {\n+┊   ┊122┊      name,\n+┊   ┊123┊    }, {\n+┊   ┊124┊      headers: {\n+┊   ┊125┊        Authorization: auth,\n+┊   ┊126┊      }\n+┊   ┊127┊    }).subscribe((user: User) => {\n+┊   ┊128┊      this.loginService.storeAuthHeader(auth);\n+┊   ┊129┊      this.loginService.storeUser(user);\n+┊   ┊130┊      this.router.navigate(['/chats']);\n+┊   ┊131┊    }, err => console.error(err));\n+┊   ┊132┊  }\n+┊   ┊133┊}\n```\n\n##### Added src&#x2F;app&#x2F;login&#x2F;login.module.ts\n```diff\n@@ -0,0 +1,52 @@\n+┊  ┊ 1┊import {RouterModule, Routes} from '@angular/router';\n+┊  ┊ 2┊import {NgModule} from '@angular/core';\n+┊  ┊ 3┊import {TruncateModule} from 'ng2-truncate';\n+┊  ┊ 4┊import {MatButtonModule, MatIconModule, MatListModule, MatMenuModule} from '@angular/material';\n+┊  ┊ 5┊import {SharedModule} from '../shared/shared.module';\n+┊  ┊ 6┊import {BrowserModule} from '@angular/platform-browser';\n+┊  ┊ 7┊import {FormsModule, ReactiveFormsModule} from '@angular/forms';\n+┊  ┊ 8┊import {BrowserAnimationsModule} from '@angular/platform-browser/animations';\n+┊  ┊ 9┊import {LoginComponent} from './containers/login.component';\n+┊  ┊10┊import {FlexLayoutModule} from '@angular/flex-layout';\n+┊  ┊11┊import {AuthInterceptor} from './services/auth.interceptor';\n+┊  ┊12┊import {AuthGuard} from './services/auth.guard';\n+┊  ┊13┊import {LoginService} from './services/login.service';\n+┊  ┊14┊\n+┊  ┊15┊\n+┊  ┊16┊const routes: Routes = [\n+┊  ┊17┊  {path: 'login', component: LoginComponent},\n+┊  ┊18┊];\n+┊  ┊19┊\n+┊  ┊20┊@NgModule({\n+┊  ┊21┊  declarations: [\n+┊  ┊22┊    LoginComponent,\n+┊  ┊23┊  ],\n+┊  ┊24┊  imports: [\n+┊  ┊25┊    BrowserModule,\n+┊  ┊26┊    // Material\n+┊  ┊27┊    MatMenuModule,\n+┊  ┊28┊    MatIconModule,\n+┊  ┊29┊    MatButtonModule,\n+┊  ┊30┊    MatListModule,\n+┊  ┊31┊    // Animations\n+┊  ┊32┊    BrowserAnimationsModule,\n+┊  ┊33┊    // Flex layout\n+┊  ┊34┊    FlexLayoutModule,\n+┊  ┊35┊    // Routing\n+┊  ┊36┊    RouterModule.forChild(routes),\n+┊  ┊37┊    // Forms\n+┊  ┊38┊    FormsModule,\n+┊  ┊39┊    ReactiveFormsModule,\n+┊  ┊40┊    // Truncate Pipe\n+┊  ┊41┊    TruncateModule,\n+┊  ┊42┊    // Feature modules\n+┊  ┊43┊    SharedModule,\n+┊  ┊44┊  ],\n+┊  ┊45┊  providers: [\n+┊  ┊46┊    LoginService,\n+┊  ┊47┊    AuthInterceptor,\n+┊  ┊48┊    AuthGuard,\n+┊  ┊49┊  ],\n+┊  ┊50┊})\n+┊  ┊51┊export class LoginModule {\n+┊  ┊52┊}\n```\n\n[}]: #\n\nNow it's time use the Interceptor we just created:\n\n[{]: <helper> (diffStep \"10.1\" files=\"src/app/app.module.ts\" module=\"client\")\n\n#### [Step 10.1: Authentication](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/34faf60)\n\n##### Changed src&#x2F;app&#x2F;app.module.ts\n```diff\n@@ -2,12 +2,14 @@\n ┊ 2┊ 2┊import { NgModule } from '@angular/core';\n ┊ 3┊ 3┊\n ┊ 4┊ 4┊import { AppComponent } from './app.component';\n-┊ 5┊  ┊import { HttpClientModule } from '@angular/common/http';\n+┊  ┊ 5┊import { HttpClientModule, HTTP_INTERCEPTORS } from '@angular/common/http';\n ┊ 6┊ 6┊import { GraphQLModule } from './graphql.module';\n ┊ 7┊ 7┊import {ChatsListerModule} from './chats-lister/chats-lister.module';\n ┊ 8┊ 8┊import {RouterModule, Routes} from '@angular/router';\n ┊ 9┊ 9┊import {ChatViewerModule} from './chat-viewer/chat-viewer.module';\n ┊10┊10┊import {ChatsCreationModule} from './chats-creation/chats-creation.module';\n+┊  ┊11┊import {LoginModule} from './login/login.module';\n+┊  ┊12┊import {AuthInterceptor} from './login/services/auth.interceptor';\n ┊11┊13┊const routes: Routes = [];\n ┊12┊14┊\n ┊13┊15┊@NgModule({\n```\n```diff\n@@ -24,8 +26,15 @@\n ┊24┊26┊    ChatsListerModule,\n ┊25┊27┊    ChatViewerModule,\n ┊26┊28┊    ChatsCreationModule,\n+┊  ┊29┊    LoginModule,\n+┊  ┊30┊  ],\n+┊  ┊31┊  providers: [\n+┊  ┊32┊    {\n+┊  ┊33┊      provide: HTTP_INTERCEPTORS,\n+┊  ┊34┊      useClass: AuthInterceptor,\n+┊  ┊35┊      multi: true,\n+┊  ┊36┊    },\n ┊27┊37┊  ],\n-┊28┊  ┊  providers: [],\n ┊29┊38┊  bootstrap: [AppComponent]\n ┊30┊39┊})\n ┊31┊40┊export class AppModule {}\n```\n\n[}]: #\n\nAs well as the `AuthGuard`:\n\n[{]: <helper> (diffStep \"10.1\" files=\"src/app/chat-viewer/chat-viewer.module.ts, src/app/chats-creation/chats-creation.module.ts, src/app/chats-lister/chats-lister.module.ts\" module=\"client\")\n\n#### [Step 10.1: Authentication](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/34faf60)\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;chat-viewer.module.ts\n```diff\n@@ -12,11 +12,12 @@\n ┊12┊12┊import {NewMessageComponent} from './components/new-message/new-message.component';\n ┊13┊13┊import {SharedModule} from '../shared/shared.module';\n ┊14┊14┊import {NgxSelectableListModule} from 'ngx-selectable-list';\n+┊  ┊15┊import {AuthGuard} from '../login/services/auth.guard';\n ┊15┊16┊\n ┊16┊17┊const routes: Routes = [\n ┊17┊18┊  {\n ┊18┊19┊    path: 'chat', children: [\n-┊19┊  ┊      {path: ':id', component: ChatComponent},\n+┊  ┊20┊      {path: ':id', canActivate: [AuthGuard], component: ChatComponent},\n ┊20┊21┊    ],\n ┊21┊22┊  },\n ┊22┊23┊];\n```\n\n##### Changed src&#x2F;app&#x2F;chats-creation&#x2F;chats-creation.module.ts\n```diff\n@@ -16,10 +16,11 @@\n ┊16┊16┊import {NewGroupDetailsComponent} from './components/new-group-details/new-group-details.component';\n ┊17┊17┊import {SharedModule} from '../shared/shared.module';\n ┊18┊18┊import {NgxSelectableListModule} from 'ngx-selectable-list';\n+┊  ┊19┊import {AuthGuard} from '../login/services/auth.guard';\n ┊19┊20┊\n ┊20┊21┊const routes: Routes = [\n-┊21┊  ┊  {path: 'new-chat', component: NewChatComponent},\n-┊22┊  ┊  {path: 'new-group', component: NewGroupComponent},\n+┊  ┊22┊  {path: 'new-chat', canActivate: [AuthGuard], component: NewChatComponent},\n+┊  ┊23┊  {path: 'new-group', canActivate: [AuthGuard], component: NewGroupComponent},\n ┊23┊24┊];\n ┊24┊25┊\n ┊25┊26┊@NgModule({\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;chats-lister.module.ts\n```diff\n@@ -12,10 +12,11 @@\n ┊12┊12┊import {TruncateModule} from 'ng2-truncate';\n ┊13┊13┊import {SharedModule} from '../shared/shared.module';\n ┊14┊14┊import {NgxSelectableListModule} from 'ngx-selectable-list';\n+┊  ┊15┊import {AuthGuard} from '../login/services/auth.guard';\n ┊15┊16┊\n ┊16┊17┊const routes: Routes = [\n ┊17┊18┊  {path: '', redirectTo: 'chats', pathMatch: 'full'},\n-┊18┊  ┊  {path: 'chats', component: ChatsComponent},\n+┊  ┊19┊  {path: 'chats', canActivate: [AuthGuard], component: ChatsComponent},\n ┊19┊20┊];\n ┊20┊21┊\n ┊21┊22┊@NgModule({\n```\n\n[}]: #\n\nLast but not the least we need to fix our main service in order to not use the hardcoded user anymore. Instead we will use our Login service to read the user info from the `LocalStorage`.\n\n[{]: <helper> (diffStep \"10.1\" files=\"src/app/services/chats.service.ts\" module=\"client\")\n\n#### [Step 10.1: Authentication](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/34faf60)\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -24,6 +24,7 @@\n ┊24┊24┊} from '../../graphql';\n ┊25┊25┊import { DataProxy } from 'apollo-cache';\n ┊26┊26┊import { FetchResult } from 'apollo-link';\n+┊  ┊27┊import {LoginService} from '../login/services/login.service';\n ┊27┊28┊\n ┊28┊29┊const currentUserId = '1';\n ┊29┊30┊const currentUserName = 'Ethan Gonzalez';\n```\n```diff\n@@ -46,7 +47,8 @@\n ┊46┊47┊    private removeAllMessagesGQL: RemoveAllMessagesGQL,\n ┊47┊48┊    private getUsersGQL: GetUsersGQL,\n ┊48┊49┊    private addChatGQL: AddChatGQL,\n-┊49┊  ┊    private addGroupGQL: AddGroupGQL\n+┊  ┊50┊    private addGroupGQL: AddGroupGQL,\n+┊  ┊51┊    private loginService: LoginService\n ┊50┊52┊  ) {\n ┊51┊53┊    this.getChatsWq = this.getChatsGQL.watch({\n ┊52┊54┊      amount: this.messagesAmount,\n```\n```diff\n@@ -128,11 +130,11 @@\n ┊128┊130┊        addMessage: {\n ┊129┊131┊          id: ChatsService.getRandomId(),\n ┊130┊132┊          __typename: 'Message',\n-┊131┊   ┊          senderId: currentUserId,\n+┊   ┊133┊          senderId: this.loginService.getUser().id,\n ┊132┊134┊          sender: {\n-┊133┊   ┊            id: currentUserId,\n+┊   ┊135┊            id: this.loginService.getUser().id,\n ┊134┊136┊            __typename: 'User',\n-┊135┊   ┊            name: currentUserName,\n+┊   ┊137┊            name: this.loginService.getUser().name,\n ┊136┊138┊          },\n ┊137┊139┊          content,\n ┊138┊140┊          createdAt: moment().unix(),\n```\n```diff\n@@ -315,7 +317,7 @@\n ┊315┊317┊  // Checks if the chat is listed for the current user and returns the id\n ┊316┊318┊  getChatId(recipientId: string) {\n ┊317┊319┊    const _chat = this.chats.find(chat => {\n-┊318┊   ┊      return !chat.isGroup && !!chat.allTimeMembers.find(user => user.id === currentUserId) &&\n+┊   ┊320┊      return !chat.isGroup && !!chat.allTimeMembers.find(user => user.id === this.loginService.getUser().id) &&\n ┊319┊321┊        !!chat.allTimeMembers.find(user => user.id === recipientId);\n ┊320┊322┊    });\n ┊321┊323┊    return _chat ? _chat.id : false;\n```\n```diff\n@@ -335,7 +337,7 @@\n ┊335┊337┊            picture: users.find(user => user.id === recipientId).picture,\n ┊336┊338┊            allTimeMembers: [\n ┊337┊339┊              {\n-┊338┊   ┊                id: currentUserId,\n+┊   ┊340┊                id: this.loginService.getUser().id,\n ┊339┊341┊                __typename: 'User',\n ┊340┊342┊              },\n ┊341┊343┊              {\n```\n```diff\n@@ -387,10 +389,10 @@\n ┊387┊389┊            __typename: 'Chat',\n ┊388┊390┊            name: groupName,\n ┊389┊391┊            picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n-┊390┊   ┊            userIds: [currentUserId, recipientIds],\n+┊   ┊392┊            userIds: [this.loginService.getUser().id, recipientIds],\n ┊391┊393┊            allTimeMembers: [\n ┊392┊394┊              {\n-┊393┊   ┊                id: currentUserId,\n+┊   ┊395┊                id: this.loginService.getUser().id,\n ┊394┊396┊                __typename: 'User',\n ┊395┊397┊              },\n ┊396┊398┊              ...recipientIds.map(id => ({id, __typename: 'User'})),\n```\n\n[}]: #\n\nWe also need to fix our tests:\n\n[{]: <helper> (diffStep \"10.1\" files=\"src/app/chat-viewer/containers/chat/chat.component.spec.ts, src/app/chats-lister/containers/chats/chats.component.spec.ts, src/app/services/chats.service.spec.ts\" module=\"client\")\n\n#### [Step 10.1: Authentication](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/34faf60)\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.spec.ts\n```diff\n@@ -29,6 +29,7 @@\n ┊29┊29┊import { NewMessageComponent } from '../../components/new-message/new-message.component';\n ┊30┊30┊import { MessagesListComponent } from '../../components/messages-list/messages-list.component';\n ┊31┊31┊import { MessageItemComponent } from '../../components/message-item/message-item.component';\n+┊  ┊32┊import { LoginService } from '../../../login/services/login.service';\n ┊32┊33┊\n ┊33┊34┊describe('ChatComponent', () => {\n ┊34┊35┊  let component: ChatComponent;\n```\n```diff\n@@ -134,6 +135,7 @@\n ┊134┊135┊            queryParams: of({}),\n ┊135┊136┊          },\n ┊136┊137┊        },\n+┊   ┊138┊        LoginService,\n ┊137┊139┊      ],\n ┊138┊140┊      schemas: [NO_ERRORS_SCHEMA],\n ┊139┊141┊    }).compileComponents();\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.spec.ts\n```diff\n@@ -24,6 +24,7 @@\n ┊24┊24┊import { ChatsListComponent } from '../../components/chats-list/chats-list.component';\n ┊25┊25┊import { ChatItemComponent } from '../../components/chat-item/chat-item.component';\n ┊26┊26┊import { ChatsService } from '../../../services/chats.service';\n+┊  ┊27┊import { LoginService } from '../../../login/services/login.service';\n ┊27┊28┊\n ┊28┊29┊describe('ChatsComponent', () => {\n ┊29┊30┊  let component: ChatsComponent;\n```\n```diff\n@@ -345,6 +346,7 @@\n ┊345┊346┊            return new InMemoryCache({ dataIdFromObject });\n ┊346┊347┊          },\n ┊347┊348┊        },\n+┊   ┊349┊        LoginService,\n ┊348┊350┊      ],\n ┊349┊351┊      schemas: [NO_ERRORS_SCHEMA],\n ┊350┊352┊    }).compileComponents();\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.spec.ts\n```diff\n@@ -11,6 +11,7 @@\n ┊11┊11┊import { GetChats } from '../../graphql';\n ┊12┊12┊import { dataIdFromObject } from '../graphql.module';\n ┊13┊13┊import { ChatsService } from './chats.service';\n+┊  ┊14┊import {LoginService} from '../login/services/login.service';\n ┊14┊15┊\n ┊15┊16┊describe('ChatsService', () => {\n ┊16┊17┊  let controller: ApolloTestingController;\n```\n```diff\n@@ -312,6 +313,7 @@\n ┊312┊313┊      imports: [ApolloTestingModule],\n ┊313┊314┊      providers: [\n ┊314┊315┊        ChatsService,\n+┊   ┊316┊        LoginService,\n ┊315┊317┊        {\n ┊316┊318┊          provide: APOLLO_TESTING_CACHE,\n ┊317┊319┊          useFactory() {\n```\n\n[}]: #\n\n\n### GraphQL Server behind a firewall\n\nThere's still one thing remaining. Our GraphQL Code Generator setup is broken now. That's because every made request to the server has to have proper rights and currently the codegen's request introspection query is not authenticated. In short, we need to attach an `Authorization` header.\n\nWe're going to implement the following scenario:\n\n1. User runs `yarn generator`\n1. He is asked for a _username_ and a _password_\n1. Our script generates an _Authorization_ header\n1. GraphQL Code Generator get the GraphQL Schema of our server and outputs the types\n\nTo achieve the goal, we need to change the way we interact with the codegen.\nRight now we use GraphQL Code Generator's CLI but the tool allows to use it programatically. So one issue solved.\n\nWhat about getting user's name and password part? We will use in-terminal prompt so user can type those. There's a package for that:\n\n    yarn add -D prompt\n\nNext, create a `src/codegen.ts` file and write our script there:\n\n[{]: <helper> (diffStep \"10.1\" files=\"src/codegen.ts\" module=\"client\")\n\n#### [Step 10.1: Authentication](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/34faf60)\n\n##### Added src&#x2F;codegen.ts\n```diff\n@@ -0,0 +1,46 @@\n+┊  ┊ 1┊import * as prompt from 'prompt';\n+┊  ┊ 2┊import { generate } from 'graphql-code-generator';\n+┊  ┊ 3┊\n+┊  ┊ 4┊interface Credentials {\n+┊  ┊ 5┊  username: string;\n+┊  ┊ 6┊  password: string;\n+┊  ┊ 7┊}\n+┊  ┊ 8┊\n+┊  ┊ 9┊async function getCredentials(): Promise<Credentials> {\n+┊  ┊10┊  return new Promise<Credentials>(resolve => {\n+┊  ┊11┊    prompt.start();\n+┊  ┊12┊    prompt.get(['username', 'password'], (_err, result) => {\n+┊  ┊13┊      resolve({\n+┊  ┊14┊        username: result.username,\n+┊  ┊15┊        password: result.password,\n+┊  ┊16┊      });\n+┊  ┊17┊    });\n+┊  ┊18┊  });\n+┊  ┊19┊}\n+┊  ┊20┊\n+┊  ┊21┊function generateHeaders({ username, password }: Credentials): string[] {\n+┊  ┊22┊  const Authorization = `Basic ${Buffer.from(\n+┊  ┊23┊    `${username}:${password}`,\n+┊  ┊24┊  ).toString('base64')}`;\n+┊  ┊25┊\n+┊  ┊26┊  return [`Authorization: ${Authorization}`];\n+┊  ┊27┊}\n+┊  ┊28┊\n+┊  ┊29┊async function main() {\n+┊  ┊30┊  const credentials = await getCredentials();\n+┊  ┊31┊  const headers = generateHeaders(credentials);\n+┊  ┊32┊\n+┊  ┊33┊  await generate(\n+┊  ┊34┊    {\n+┊  ┊35┊      schema: 'http://localhost:3000/graphql',\n+┊  ┊36┊      template: 'graphql-codegen-apollo-angular-template',\n+┊  ┊37┊      out: './src/graphql.ts',\n+┊  ┊38┊      args: ['./src/graphql/**/*.ts'],\n+┊  ┊39┊      header: headers,\n+┊  ┊40┊      overwrite: true,\n+┊  ┊41┊    },\n+┊  ┊42┊    true,\n+┊  ┊43┊  );\n+┊  ┊44┊}\n+┊  ┊45┊\n+┊  ┊46┊main();\n```\n\n[}]: #\n\nLet's take a closer look what we did there:\n\n- We asks user for a _username_ and a _password_ with `prompt`\n- Based on that we generate a header\n- We put the header in `generate` function\n- there's a `true` value as the second argument, it tells codegen to write the output to a file\n\nWith all of that, whenever we run `yarn generator`, we access the GraphQL server as an authenticated user."
          },
          {
            "manualTitle": "Step 15: Subscriptions",
            "stepRevision": "4468c9c93fec39b398667d2eed81c40e4ae89eb7",
            "manualView": "## Server\n\nIn order to use WebSockets we don't need to install any package, it comes for free with Apollo Server 2.0.\n\nOur GraphQL server will use WebSockets only for subscriptions, while using HTTP for everything else. That means that we will have to add subscriptions on a specific path.\nWe're using `connectionParams` for the authentication over WebSockets, that means that we won't be using the `Passport` framework at all. Instead we will use the `onConnect` hook to manually validate the parameters provided by the user to either validate the WebSocket connection or throw an error.\nWe will also return the user object we retrieved from the db, to let the resolvers know who is the current user.\n\n[{]: <helper> (diffStep \"5.1\" files=\"index.ts\" module=\"server\")\n\n#### [Step 5.1: Subscriptions](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/729c8f0)\n\n##### Changed index.ts\n```diff\n@@ -7,9 +7,12 @@\n ┊ 7┊ 7┊import * as basicStrategy from 'passport-http';\n ┊ 8┊ 8┊import * as bcrypt from 'bcrypt-nodejs';\n ┊ 9┊ 9┊import { db, User } from \"./db\";\n+┊  ┊10┊import { createServer } from \"http\";\n ┊10┊11┊\n ┊11┊12┊let users = db.users;\n ┊12┊13┊\n+┊  ┊14┊console.log(users);\n+┊  ┊15┊\n ┊13┊16┊function generateHash(password: string) {\n ┊14┊17┊  return bcrypt.hashSync(password, bcrypt.genSaltSync(8));\n ┊15┊18┊}\n```\n```diff\n@@ -69,9 +72,30 @@\n ┊ 69┊ 72┊  schema,\n ┊ 70┊ 73┊  context(received: any) {\n ┊ 71┊ 74┊    return {\n-┊ 72┊   ┊      user: received.req!['user'],\n+┊   ┊ 75┊      user: received.connection ? received.connection.context.user : received.req!['user'],\n ┊ 73┊ 76┊    }\n ┊ 74┊ 77┊  },\n+┊   ┊ 78┊  subscriptions: {\n+┊   ┊ 79┊    onConnect: (connectionParams: any, webSocket: any) => {\n+┊   ┊ 80┊      if (connectionParams.authToken) {\n+┊   ┊ 81┊        // create a buffer and tell it the data coming in is base64\n+┊   ┊ 82┊        const buf = new Buffer(connectionParams.authToken.split(' ')[1], 'base64');\n+┊   ┊ 83┊        // read it back out as a string\n+┊   ┊ 84┊        const [username, password]: string[] = buf.toString().split(':');\n+┊   ┊ 85┊        if (username && password) {\n+┊   ┊ 86┊          const user = users.find(user => user.username == username);\n+┊   ┊ 87┊\n+┊   ┊ 88┊          if (user && validPassword(password, user.password)) {\n+┊   ┊ 89┊            // Set context for the WebSocket\n+┊   ┊ 90┊            return {user};\n+┊   ┊ 91┊          } else {\n+┊   ┊ 92┊            throw new Error('Wrong credentials!');\n+┊   ┊ 93┊          }\n+┊   ┊ 94┊        }\n+┊   ┊ 95┊      }\n+┊   ┊ 96┊      throw new Error('Missing auth token!');\n+┊   ┊ 97┊    }\n+┊   ┊ 98┊  }\n ┊ 75┊ 99┊});\n ┊ 76┊100┊\n ┊ 77┊101┊apollo.applyMiddleware({\n```\n```diff\n@@ -79,4 +103,11 @@\n ┊ 79┊103┊  path: '/graphql'\n ┊ 80┊104┊});\n ┊ 81┊105┊\n-┊ 82┊   ┊app.listen(PORT);\n+┊   ┊106┊// Wrap the Express server\n+┊   ┊107┊const ws = createServer(app);\n+┊   ┊108┊\n+┊   ┊109┊apollo.installSubscriptionHandlers(ws);\n+┊   ┊110┊\n+┊   ┊111┊ws.listen(PORT, () => {\n+┊   ┊112┊  console.log(`Apollo Server is now running on http://localhost:${PORT}`);\n+┊   ┊113┊});\n```\n\n[}]: #\n\nWe will use the `PubSub` implementation from `apollo-server-express`, and publish the data using with Apollo Server.\n\nThe process of setting up a GraphQL subscriptions server consist of the following steps:\n\n1. Declaring subscriptions in the GraphQL schema\n2. Setup a PubSub instance that our server will publish new events to\n3. Hook together `PubSub` event and GraphQL subscription.\n4. Setting up `ApolloServer`\n\n[{]: <helper> (diffStep \"5.1\" files=\"schema/typeDefs.ts\" module=\"server\")\n\n#### [Step 5.1: Subscriptions](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/729c8f0)\n\n##### Changed schema&#x2F;typeDefs.ts\n```diff\n@@ -5,6 +5,11 @@\n ┊ 5┊ 5┊    chat(chatId: ID!): Chat\n ┊ 6┊ 6┊  }\n ┊ 7┊ 7┊\n+┊  ┊ 8┊  type Subscription {\n+┊  ┊ 9┊    messageAdded(chatId: ID): Message\n+┊  ┊10┊    chatAdded: Chat\n+┊  ┊11┊  }\n+┊  ┊12┊\n ┊ 8┊13┊  enum MessageType {\n ┊ 9┊14┊    LOCATION\n ┊10┊15┊    TEXT\n```\n\n[}]: #\n\nWe created two subscriptions: one to notify for new chats and one to notify for new messages.\n\n[{]: <helper> (diffStep \"5.1\" files=\"schema/resolvers.ts\" module=\"server\")\n\n#### [Step 5.1: Subscriptions](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/729c8f0)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,7 +1,7 @@\n-┊1┊ ┊import { IResolvers } from 'apollo-server-express';\n+┊ ┊1┊import { PubSub, withFilter, IResolvers } from 'apollo-server-express';\n ┊2┊2┊import { Chat, db, Message, MessageType, Recipient, User } from \"../db\";\n ┊3┊3┊import {\n-┊4┊ ┊  AddChatMutationArgs, AddGroupMutationArgs, AddMessageMutationArgs, ChatQueryArgs,\n+┊ ┊4┊  AddChatMutationArgs, AddGroupMutationArgs, AddMessageMutationArgs, ChatQueryArgs, MessageAddedSubscriptionArgs,\n ┊5┊5┊  RemoveChatMutationArgs, RemoveMessagesMutationArgs\n ┊6┊6┊} from \"../types\";\n ┊7┊7┊import * as moment from \"moment\";\n```\n```diff\n@@ -9,6 +9,8 @@\n ┊ 9┊ 9┊let users = db.users;\n ┊10┊10┊let chats = db.chats;\n ┊11┊11┊\n+┊  ┊12┊export const pubsub = new PubSub();\n+┊  ┊13┊\n ┊12┊14┊export const resolvers: IResolvers = {\n ┊13┊15┊  Query: {\n ┊14┊16┊    // Show all users for the moment.\n```\n```diff\n@@ -50,6 +52,7 @@\n ┊50┊52┊          messages: [],\n ┊51┊53┊        };\n ┊52┊54┊        chats.push(chat);\n+┊  ┊55┊\n ┊53┊56┊        return chat;\n ┊54┊57┊      }\n ┊55┊58┊    },\n```\n```diff\n@@ -73,6 +76,12 @@\n ┊73┊76┊        messages: [],\n ┊74┊77┊      };\n ┊75┊78┊      chats.push(chat);\n+┊  ┊79┊\n+┊  ┊80┊      pubsub.publish('chatAdded', {\n+┊  ┊81┊        creatorId: currentUser.id,\n+┊  ┊82┊        chatAdded: chat,\n+┊  ┊83┊      });\n+┊  ┊84┊\n ┊76┊85┊      return chat;\n ┊77┊86┊    },\n ┊78┊87┊    removeChat: (obj: any, {chatId}: RemoveChatMutationArgs, {user: currentUser}: {user: User}): number => {\n```\n```diff\n@@ -201,6 +210,11 @@\n ┊201┊210┊          });\n ┊202┊211┊\n ┊203┊212┊          holderIds = listingMemberIds;\n+┊   ┊213┊\n+┊   ┊214┊          pubsub.publish('chatAdded', {\n+┊   ┊215┊            creatorId: currentUser.id,\n+┊   ┊216┊            chatAdded: chat,\n+┊   ┊217┊          });\n ┊204┊218┊        }\n ┊205┊219┊      } else {\n ┊206┊220┊        // Group\n```\n```diff\n@@ -245,6 +259,10 @@\n ┊245┊259┊        return chat;\n ┊246┊260┊      });\n ┊247┊261┊\n+┊   ┊262┊      pubsub.publish('messageAdded', {\n+┊   ┊263┊        messageAdded: message,\n+┊   ┊264┊      });\n+┊   ┊265┊\n ┊248┊266┊      return message;\n ┊249┊267┊    },\n ┊250┊268┊    removeMessages: (obj: any, {chatId, messageIds, all}: RemoveMessagesMutationArgs, {user: currentUser}: {user: User}): number[] => {\n```\n```diff\n@@ -286,6 +304,21 @@\n ┊286┊304┊      return deletedIds;\n ┊287┊305┊    },\n ┊288┊306┊  },\n+┊   ┊307┊  Subscription: {\n+┊   ┊308┊    messageAdded: {\n+┊   ┊309┊      subscribe: withFilter(() => pubsub.asyncIterator('messageAdded'),\n+┊   ┊310┊        ({messageAdded}: {messageAdded: Message & {chat: {id: number}}}, {chatId}: MessageAddedSubscriptionArgs, {user: currentUser}: { user: User }) => {\n+┊   ┊311┊          return (!chatId || messageAdded.chat.id === Number(chatId)) &&\n+┊   ┊312┊            !!messageAdded.recipients.find((recipient: Recipient) => recipient.userId === currentUser.id);\n+┊   ┊313┊        }),\n+┊   ┊314┊    },\n+┊   ┊315┊    chatAdded: {\n+┊   ┊316┊      subscribe: withFilter(() => pubsub.asyncIterator('chatAdded'),\n+┊   ┊317┊        ({creatorId, chatAdded}: {creatorId: string, chatAdded: Chat}, variables: any, {user: currentUser}: { user: User }) => {\n+┊   ┊318┊          return Number(creatorId) !== currentUser.id && !chatAdded.listingMemberIds.includes(currentUser.id);\n+┊   ┊319┊        }),\n+┊   ┊320┊    }\n+┊   ┊321┊  },\n ┊289┊322┊  Chat: {\n ┊290┊323┊    name: (chat: Chat, args: any, {user: currentUser}: {user: User}): string => chat.name ? chat.name : users\n ┊291┊324┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser.id))!.name,\n```\n\n[}]: #\n\nWe will publish a message to the `messageAdded` subscription every time that a user sends a message, then we will filter them according to the current user (we don't want to send someone else's messages).\nThe `chatAdded` subscription is similar: we will publish each time that a group gets created, but not when chats get created. This is because when a user creates a chat the chat doesn't appear to the other peer until he writes the first message. That's why we also publish when new messages get added (we first look if the other peer already gets the chat listed).\n\n## Client\n\nIn order to use WebSockets we will need to install a couple of dependencies:\n\n    yarn add apollo-link-ws apollo-utilities subscriptions-transport-ws\n\nFirst let's create the queries for the GraphQL Subscriptions:\n\n[{]: <helper> (diffStep \"11.1\" files=\"src/graphql\" module=\"client\")\n\n#### [Step 11.1: Subscriptions](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/8219b49)\n\n##### Changed src&#x2F;graphql.ts\n```diff\n@@ -651,6 +651,22 @@\n ┊651┊651┊  export type AddMessage = Message.Fragment;\n ┊652┊652┊}\n ┊653┊653┊\n+┊   ┊654┊export namespace ChatAdded {\n+┊   ┊655┊  export type Variables = {};\n+┊   ┊656┊\n+┊   ┊657┊  export type Subscription = {\n+┊   ┊658┊    __typename?: \"Subscription\";\n+┊   ┊659┊    chatAdded?: ChatAdded | null;\n+┊   ┊660┊  };\n+┊   ┊661┊\n+┊   ┊662┊  export type ChatAdded = {\n+┊   ┊663┊    __typename?: \"Chat\";\n+┊   ┊664┊    messages: (Messages | null)[];\n+┊   ┊665┊  } & ChatWithoutMessages.Fragment;\n+┊   ┊666┊\n+┊   ┊667┊  export type Messages = Message.Fragment;\n+┊   ┊668┊}\n+┊   ┊669┊\n ┊654┊670┊export namespace GetChat {\n ┊655┊671┊  export type Variables = {\n ┊656┊672┊    chatId: string;\n```\n```diff\n@@ -703,6 +719,27 @@\n ┊703┊719┊  };\n ┊704┊720┊}\n ┊705┊721┊\n+┊   ┊722┊export namespace MessageAdded {\n+┊   ┊723┊  export type Variables = {\n+┊   ┊724┊    chatId?: string | null;\n+┊   ┊725┊  };\n+┊   ┊726┊\n+┊   ┊727┊  export type Subscription = {\n+┊   ┊728┊    __typename?: \"Subscription\";\n+┊   ┊729┊    messageAdded?: MessageAdded | null;\n+┊   ┊730┊  };\n+┊   ┊731┊\n+┊   ┊732┊  export type MessageAdded = {\n+┊   ┊733┊    __typename?: \"Message\";\n+┊   ┊734┊    chat: Chat;\n+┊   ┊735┊  } & Message.Fragment;\n+┊   ┊736┊\n+┊   ┊737┊  export type Chat = {\n+┊   ┊738┊    __typename?: \"Chat\";\n+┊   ┊739┊    id: string;\n+┊   ┊740┊  };\n+┊   ┊741┊}\n+┊   ┊742┊\n ┊706┊743┊export namespace RemoveAllMessages {\n ┊707┊744┊  export type Variables = {\n ┊708┊745┊    chatId: string;\n```\n```diff\n@@ -924,6 +961,27 @@\n ┊924┊961┊@Injectable({\n ┊925┊962┊  providedIn: \"root\"\n ┊926┊963┊})\n+┊   ┊964┊export class ChatAddedGQL extends Apollo.Subscription<\n+┊   ┊965┊  ChatAdded.Subscription,\n+┊   ┊966┊  ChatAdded.Variables\n+┊   ┊967┊> {\n+┊   ┊968┊  document: any = gql`\n+┊   ┊969┊    subscription chatAdded {\n+┊   ┊970┊      chatAdded {\n+┊   ┊971┊        ...ChatWithoutMessages\n+┊   ┊972┊        messages {\n+┊   ┊973┊          ...Message\n+┊   ┊974┊        }\n+┊   ┊975┊      }\n+┊   ┊976┊    }\n+┊   ┊977┊\n+┊   ┊978┊    ${ChatWithoutMessagesFragment}\n+┊   ┊979┊    ${MessageFragment}\n+┊   ┊980┊  `;\n+┊   ┊981┊}\n+┊   ┊982┊@Injectable({\n+┊   ┊983┊  providedIn: \"root\"\n+┊   ┊984┊})\n ┊927┊985┊export class GetChatGQL extends Apollo.Query<GetChat.Query, GetChat.Variables> {\n ┊928┊986┊  document: any = gql`\n ┊929┊987┊    query GetChat($chatId: ID!) {\n```\n```diff\n@@ -980,6 +1038,26 @@\n ┊ 980┊1038┊@Injectable({\n ┊ 981┊1039┊  providedIn: \"root\"\n ┊ 982┊1040┊})\n+┊    ┊1041┊export class MessageAddedGQL extends Apollo.Subscription<\n+┊    ┊1042┊  MessageAdded.Subscription,\n+┊    ┊1043┊  MessageAdded.Variables\n+┊    ┊1044┊> {\n+┊    ┊1045┊  document: any = gql`\n+┊    ┊1046┊    subscription messageAdded($chatId: ID) {\n+┊    ┊1047┊      messageAdded(chatId: $chatId) {\n+┊    ┊1048┊        ...Message\n+┊    ┊1049┊        chat {\n+┊    ┊1050┊          id\n+┊    ┊1051┊        }\n+┊    ┊1052┊      }\n+┊    ┊1053┊    }\n+┊    ┊1054┊\n+┊    ┊1055┊    ${MessageFragment}\n+┊    ┊1056┊  `;\n+┊    ┊1057┊}\n+┊    ┊1058┊@Injectable({\n+┊    ┊1059┊  providedIn: \"root\"\n+┊    ┊1060┊})\n ┊ 983┊1061┊export class RemoveAllMessagesGQL extends Apollo.Mutation<\n ┊ 984┊1062┊  RemoveAllMessages.Mutation,\n ┊ 985┊1063┊  RemoveAllMessages.Variables\n```\n\n##### Added src&#x2F;graphql&#x2F;chatAdded.subscription.ts\n```diff\n@@ -0,0 +1,17 @@\n+┊  ┊ 1┊import gql from 'graphql-tag';\n+┊  ┊ 2┊import {fragments} from './fragment';\n+┊  ┊ 3┊\n+┊  ┊ 4┊// We use the gql tag to parse our query string into a query document\n+┊  ┊ 5┊export const chatAddedSubscription = gql`\n+┊  ┊ 6┊  subscription chatAdded {\n+┊  ┊ 7┊    chatAdded {\n+┊  ┊ 8┊      ...ChatWithoutMessages\n+┊  ┊ 9┊      messages {\n+┊  ┊10┊        ...Message\n+┊  ┊11┊      }\n+┊  ┊12┊    }\n+┊  ┊13┊  }\n+┊  ┊14┊\n+┊  ┊15┊  ${fragments['chatWithoutMessages']}\n+┊  ┊16┊  ${fragments['message']}\n+┊  ┊17┊`;\n```\n\n##### Added src&#x2F;graphql&#x2F;messageAdded.subscription.ts\n```diff\n@@ -0,0 +1,16 @@\n+┊  ┊ 1┊import gql from 'graphql-tag';\n+┊  ┊ 2┊import {fragments} from './fragment';\n+┊  ┊ 3┊\n+┊  ┊ 4┊// We use the gql tag to parse our query string into a query document\n+┊  ┊ 5┊export const messageAddedSubscription = gql`\n+┊  ┊ 6┊  subscription messageAdded($chatId: ID) {\n+┊  ┊ 7┊    messageAdded(chatId: $chatId) {\n+┊  ┊ 8┊      ...Message\n+┊  ┊ 9┊      chat {\n+┊  ┊10┊        id,\n+┊  ┊11┊      },\n+┊  ┊12┊    }\n+┊  ┊13┊  }\n+┊  ┊14┊\n+┊  ┊15┊  ${fragments['message']}\n+┊  ┊16┊`;\n```\n\n[}]: #\n\nThen we need to run `graphql-code-generator` to generate the types:\n\n    yarn generator\n\nNow we can update the chats service to update the getChats query every time that we receive a new chat from the subscription.\nWith GraphQL subscriptions your client will be alerted on push from the server and you should choose the pattern that fits your application the most:\n\n- Use it as a notification and run any logic you want when it fires, for example alerting the user or refetching data\n- Use the data sent along with the notification and merge it directly into the store (existing queries are automatically notified)\n\nWith subscribeToMore, you can easily do the latter. We will manipulate the store to add the newly created chat.\n\nWe will do to do the same for the newMessage subscription, but this time we will have to update two different queries in the store: getChats and getChat.\n\n[{]: <helper> (diffStep \"11.1\" files=\"src/app/services/chats.service.ts\" module=\"client\")\n\n#### [Step 11.1: Subscriptions](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/8219b49)\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,7 +1,7 @@\n ┊1┊1┊import {concat, map, share, switchMap} from 'rxjs/operators';\n ┊2┊2┊import {Injectable} from '@angular/core';\n ┊3┊3┊import {Observable, AsyncSubject, of} from 'rxjs';\n-┊4┊ ┊import {QueryRef} from 'apollo-angular';\n+┊ ┊4┊import {Apollo, QueryRef} from 'apollo-angular';\n ┊5┊5┊import * as moment from 'moment';\n ┊6┊6┊import {\n ┊7┊7┊  GetChatsGQL,\n```\n```diff\n@@ -13,6 +13,8 @@\n ┊13┊13┊  GetUsersGQL,\n ┊14┊14┊  AddChatGQL,\n ┊15┊15┊  AddGroupGQL,\n+┊  ┊16┊  ChatAddedGQL,\n+┊  ┊17┊  MessageAddedGQL,\n ┊16┊18┊  AddMessage,\n ┊17┊19┊  GetChats,\n ┊18┊20┊  GetChat,\n```\n```diff\n@@ -21,6 +23,7 @@\n ┊21┊23┊  GetUsers,\n ┊22┊24┊  AddChat,\n ┊23┊25┊  AddGroup,\n+┊  ┊26┊  MessageAdded,\n ┊24┊27┊} from '../../graphql';\n ┊25┊28┊import { DataProxy } from 'apollo-cache';\n ┊26┊29┊import { FetchResult } from 'apollo-link';\n```\n```diff\n@@ -48,11 +51,69 @@\n ┊ 48┊ 51┊    private getUsersGQL: GetUsersGQL,\n ┊ 49┊ 52┊    private addChatGQL: AddChatGQL,\n ┊ 50┊ 53┊    private addGroupGQL: AddGroupGQL,\n+┊   ┊ 54┊    private chatAddedGQL: ChatAddedGQL,\n+┊   ┊ 55┊    private messageAddedGQL: MessageAddedGQL,\n+┊   ┊ 56┊    private apollo: Apollo,\n ┊ 51┊ 57┊    private loginService: LoginService\n ┊ 52┊ 58┊  ) {\n ┊ 53┊ 59┊    this.getChatsWq = this.getChatsGQL.watch({\n ┊ 54┊ 60┊      amount: this.messagesAmount,\n ┊ 55┊ 61┊    });\n+┊   ┊ 62┊\n+┊   ┊ 63┊    this.getChatsWq.subscribeToMore({\n+┊   ┊ 64┊      document: this.chatAddedGQL.document,\n+┊   ┊ 65┊      updateQuery: (prev: GetChats.Query, { subscriptionData }) => {\n+┊   ┊ 66┊        if (!subscriptionData.data) {\n+┊   ┊ 67┊          return prev;\n+┊   ┊ 68┊        }\n+┊   ┊ 69┊\n+┊   ┊ 70┊        const newChat: GetChats.Chats = subscriptionData.data.chatAdded;\n+┊   ┊ 71┊\n+┊   ┊ 72┊        return Object.assign({}, prev, {\n+┊   ┊ 73┊          chats: [...prev.chats, newChat]\n+┊   ┊ 74┊        });\n+┊   ┊ 75┊      }\n+┊   ┊ 76┊    });\n+┊   ┊ 77┊\n+┊   ┊ 78┊    this.getChatsWq.subscribeToMore({\n+┊   ┊ 79┊      document: this.messageAddedGQL.document,\n+┊   ┊ 80┊      updateQuery: (prev: GetChats.Query, { subscriptionData }) => {\n+┊   ┊ 81┊        if (!subscriptionData.data) {\n+┊   ┊ 82┊          return prev;\n+┊   ┊ 83┊        }\n+┊   ┊ 84┊\n+┊   ┊ 85┊        const newMessage: MessageAdded.MessageAdded = subscriptionData.data.messageAdded;\n+┊   ┊ 86┊\n+┊   ┊ 87┊        // We need to update the cache for both Chat and Chats. The following updates the cache for Chat.\n+┊   ┊ 88┊        try {\n+┊   ┊ 89┊          // Read the data from our cache for this query.\n+┊   ┊ 90┊          const {chat}: GetChat.Query = this.apollo.getClient().readQuery({\n+┊   ┊ 91┊            query: this.getChatGQL.document,\n+┊   ┊ 92┊            variables: {\n+┊   ┊ 93┊              chatId: newMessage.chat.id,\n+┊   ┊ 94┊            }\n+┊   ┊ 95┊          });\n+┊   ┊ 96┊\n+┊   ┊ 97┊          // Add our message from the mutation to the end.\n+┊   ┊ 98┊          chat.messages.push(newMessage);\n+┊   ┊ 99┊          // Write our data back to the cache.\n+┊   ┊100┊          this.apollo.getClient().writeQuery({\n+┊   ┊101┊            query: this.getChatGQL.document,\n+┊   ┊102┊            data: {\n+┊   ┊103┊              chat\n+┊   ┊104┊            }\n+┊   ┊105┊          });\n+┊   ┊106┊        } catch {\n+┊   ┊107┊          console.error('The chat we received an update for does not exist in the store');\n+┊   ┊108┊        }\n+┊   ┊109┊\n+┊   ┊110┊        return Object.assign({}, prev, {\n+┊   ┊111┊          chats: [...prev.chats.map(_chat =>\n+┊   ┊112┊            _chat.id === newMessage.chat.id ? {..._chat, messages: [..._chat.messages, newMessage]} : _chat)]\n+┊   ┊113┊        });\n+┊   ┊114┊      }\n+┊   ┊115┊    });\n+┊   ┊116┊\n ┊ 56┊117┊    this.chats$ = this.getChatsWq.valueChanges.pipe(\n ┊ 57┊118┊      map((result) => result.data.chats)\n ┊ 58┊119┊    );\n```\n```diff\n@@ -130,6 +191,10 @@\n ┊130┊191┊        addMessage: {\n ┊131┊192┊          id: ChatsService.getRandomId(),\n ┊132┊193┊          __typename: 'Message',\n+┊   ┊194┊          chat: {\n+┊   ┊195┊            id: chatId,\n+┊   ┊196┊            __typename: 'Chat',\n+┊   ┊197┊          },\n ┊133┊198┊          senderId: this.loginService.getUser().id,\n ┊134┊199┊          sender: {\n ┊135┊200┊            id: this.loginService.getUser().id,\n```\n\n[}]: #\n\nWe can finally configure the WebSocket in the GraphQL Module. Please notice that the WebSocket has its own authentication instead of using the `HttpInterceptor`, in fact we use `connectionParams` to send the authorization.\nAll queries will go through HTTP except the Subscriptions, which will use the WebSocket.\n\n[{]: <helper> (diffStep \"11.1\" files=\"src/app/graphql.module.ts\" module=\"client\")\n\n#### [Step 11.1: Subscriptions](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/8219b49)\n\n##### Changed src&#x2F;app&#x2F;graphql.module.ts\n```diff\n@@ -2,6 +2,11 @@\n ┊ 2┊ 2┊import { ApolloModule, APOLLO_OPTIONS } from 'apollo-angular';\n ┊ 3┊ 3┊import { HttpLinkModule, HttpLink } from 'apollo-angular-link-http';\n ┊ 4┊ 4┊import { InMemoryCache, defaultDataIdFromObject } from 'apollo-cache-inmemory';\n+┊  ┊ 5┊import {getMainDefinition} from 'apollo-utilities';\n+┊  ┊ 6┊import {OperationDefinitionNode} from 'graphql';\n+┊  ┊ 7┊import {split} from 'apollo-link';\n+┊  ┊ 8┊import {WebSocketLink} from 'apollo-link-ws';\n+┊  ┊ 9┊import {LoginService} from './login/services/login.service';\n ┊ 5┊10┊\n ┊ 6┊11┊const uri = 'http://localhost:3000/graphql';\n ┊ 7┊12┊\n```\n```diff\n@@ -14,9 +19,28 @@\n ┊14┊19┊  }\n ┊15┊20┊};\n ┊16┊21┊\n-┊17┊  ┊export function createApollo(httpLink: HttpLink) {\n+┊  ┊22┊export function createApollo(httpLink: HttpLink, loginService: LoginService) {\n+┊  ┊23┊  const subscriptionLink = new WebSocketLink({\n+┊  ┊24┊    uri: uri.replace('http', 'ws'),\n+┊  ┊25┊    options: {\n+┊  ┊26┊      reconnect: true,\n+┊  ┊27┊      connectionParams: () => ({\n+┊  ┊28┊        authToken: loginService.getAuthHeader() || null\n+┊  ┊29┊      })\n+┊  ┊30┊    }\n+┊  ┊31┊  });\n+┊  ┊32┊\n+┊  ┊33┊  const link = split(\n+┊  ┊34┊    ({ query }) => {\n+┊  ┊35┊      const { kind, operation } = getMainDefinition(query) as OperationDefinitionNode;\n+┊  ┊36┊      return kind === 'OperationDefinition' && operation === 'subscription';\n+┊  ┊37┊    },\n+┊  ┊38┊    subscriptionLink,\n+┊  ┊39┊    httpLink.create({uri})\n+┊  ┊40┊  );\n+┊  ┊41┊\n ┊18┊42┊  return {\n-┊19┊  ┊    link: httpLink.create({ uri }),\n+┊  ┊43┊    link,\n ┊20┊44┊    cache: new InMemoryCache({\n ┊21┊45┊      dataIdFromObject,\n ┊22┊46┊    }),\n```\n```diff\n@@ -29,7 +53,7 @@\n ┊29┊53┊    {\n ┊30┊54┊      provide: APOLLO_OPTIONS,\n ┊31┊55┊      useFactory: createApollo,\n-┊32┊  ┊      deps: [HttpLink],\n+┊  ┊56┊      deps: [HttpLink, LoginService],\n ┊33┊57┊    },\n ┊34┊58┊  ],\n ┊35┊59┊})\n```\n\n[}]: #\n\nWe used `split` of ApolloLink to decide which path should a request get, through WebSocket or HTTP. We decided to push subscriptions over the WebSocket and the rest normally, just like before.\n\nFinally, let's fix the tests:\n\n[{]: <helper> (diffStep \"11.1\" files=\"src/app/chat-viewer/containers/chat/chat.component.spec.ts, src/app/chats-lister/containers/chats/chats.component.spec.ts, src/app/services/chats.service.spec.ts\" module=\"client\")\n\n#### [Step 11.1: Subscriptions](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/8219b49)\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.spec.ts\n```diff\n@@ -148,6 +148,8 @@\n ┊148┊148┊    component = fixture.componentInstance;\n ┊149┊149┊    fixture.detectChanges();\n ┊150┊150┊\n+┊   ┊151┊    controller.expectOne('chatAdded', 'call to chatAdded api');\n+┊   ┊152┊    controller.expectOne('messageAdded', 'call to messageAdded api');\n ┊151┊153┊    controller.expectOne('GetChats', 'call to getChats api');\n ┊152┊154┊\n ┊153┊155┊    const req = controller.expectOne('GetChat', 'call to getChat api');\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.spec.ts\n```diff\n@@ -360,8 +360,10 @@\n ┊360┊360┊    component = fixture.componentInstance;\n ┊361┊361┊    fixture.detectChanges();\n ┊362┊362┊\n-┊363┊   ┊    const req = controller.expectOne('GetChats', 'GetChats operation');\n+┊   ┊363┊    controller.expectOne('chatAdded', 'call to chatAdded api');\n+┊   ┊364┊    controller.expectOne('messageAdded', 'call to messageAdded api');\n ┊364┊365┊\n+┊   ┊366┊    const req = controller.expectOne('GetChats', 'GetChats operation');\n ┊365┊367┊    req.flush({\n ┊366┊368┊      data: {\n ┊367┊369┊        chats,\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.spec.ts\n```diff\n@@ -11,7 +11,7 @@\n ┊11┊11┊import { GetChats } from '../../graphql';\n ┊12┊12┊import { dataIdFromObject } from '../graphql.module';\n ┊13┊13┊import { ChatsService } from './chats.service';\n-┊14┊  ┊import {LoginService} from '../login/services/login.service';\n+┊  ┊14┊import { LoginService } from '../login/services/login.service';\n ┊15┊15┊\n ┊16┊16┊describe('ChatsService', () => {\n ┊17┊17┊  let controller: ApolloTestingController;\n```\n```diff\n@@ -341,6 +341,9 @@\n ┊341┊341┊      }\n ┊342┊342┊    });\n ┊343┊343┊\n+┊   ┊344┊    controller.expectOne('chatAdded', 'call to chatAdded api');\n+┊   ┊345┊    controller.expectOne('messageAdded', 'call to messageAdded api');\n+┊   ┊346┊\n ┊344┊347┊    const req = controller.expectOne('GetChats', 'GetChats operation');\n ┊345┊348┊\n ┊346┊349┊    req.flush({\n```\n\n[}]: #"
          },
          {
            "manualTitle": "Step 16: TypeORM with PostgreSQL",
            "stepRevision": "8686ed12d75fe225a178dd89175a3e594df424c9",
            "manualView": "## Server\n\nFirst of all you will have to install PostgreSQL on your operating system. Since there so many options (different Linux distributions, MacOS X, Windows...) I will assume that you already know how to install a software in your OS and take that part for granted.\n\nThen you will have to install a couple of packages:\n\n    yarn add pg reflect-metadata typeorm\n    yarn add -D @types/pg\n\nWe aren't going to use plain SQL, instead we will use an Object-relational mapping framework (ORM) called `TypeORM`.\n`TypeORM` takes advantage of Typescript classes and type declarations in order to infer the db structure.\n\nWe will need to enable support for experimental decorators, emit type metadata for decorators and disable strict property initialization:\n\n[{]: <helper> (diffStep \"6.1\" files=\"tsconfig.json\" module=\"server\")\n\n#### [Step 6.1: TypeORM with PostgreSQL](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/00c4cab)\n\n##### Changed tsconfig.json\n```diff\n@@ -22,11 +22,11 @@\n ┊22┊22┊    // \"isolatedModules\": true,               /* Transpile each file as a separate module (similar to 'ts.transpileModule'). */\n ┊23┊23┊\n ┊24┊24┊    /* Strict Type-Checking Options */\n-┊25┊  ┊    \"strict\": true,                            /* Enable all strict type-checking options. */\n+┊  ┊25┊    \"strict\": true,                           /* Enable all strict type-checking options. */\n ┊26┊26┊    // \"noImplicitAny\": true,                 /* Raise error on expressions and declarations with an implied 'any' type. */\n ┊27┊27┊    // \"strictNullChecks\": true,              /* Enable strict null checks. */\n ┊28┊28┊    // See https://github.com/DefinitelyTyped/DefinitelyTyped/issues/21359\n-┊29┊  ┊    \"strictFunctionTypes\": false              /* Enable strict checking of function types. */\n+┊  ┊29┊    \"strictFunctionTypes\": false,             /* Enable strict checking of function types. */\n ┊30┊30┊    // \"noImplicitThis\": true,                /* Raise error on 'this' expressions with an implied 'any' type. */\n ┊31┊31┊    // \"alwaysStrict\": true,                  /* Parse in strict mode and emit \"use strict\" for each source file. */\n ┊32┊32┊\n```\n```diff\n@@ -53,7 +53,8 @@\n ┊53┊53┊    // \"inlineSources\": true,                 /* Emit the source alongside the sourcemaps within a single file; requires '--inlineSourceMap' or '--sourceMap' to be set. */\n ┊54┊54┊\n ┊55┊55┊    /* Experimental Options */\n-┊56┊  ┊    // \"experimentalDecorators\": true,        /* Enables experimental support for ES7 decorators. */\n-┊57┊  ┊    // \"emitDecoratorMetadata\": true,         /* Enables experimental support for emitting type metadata for decorators. */\n+┊  ┊56┊    \"experimentalDecorators\": true,           /* Enables experimental support for ES7 decorators. */\n+┊  ┊57┊    \"emitDecoratorMetadata\": true,            /* Enables experimental support for emitting type metadata for decorators. */\n+┊  ┊58┊    \"strictPropertyInitialization\": false\n ┊58┊59┊  }\n ┊59┊60┊}🚫↵\n```\n\n[}]: #\n\nThe next step is to create Entities. An Entity is a class that maps to a database table. You can create a entity by defining a new class and mark it with @Entity():\n\n[{]: <helper> (diffStep \"6.1\" files=\"entity\" module=\"server\")\n\n#### [Step 6.1: TypeORM with PostgreSQL](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/00c4cab)\n\n##### Added entity&#x2F;Chat.ts\n```diff\n@@ -0,0 +1,79 @@\n+┊  ┊ 1┊import { Entity, Column, PrimaryGeneratedColumn, OneToMany, JoinTable, ManyToMany, ManyToOne } from \"typeorm\";\n+┊  ┊ 2┊import { Message } from \"./Message\";\n+┊  ┊ 3┊import { User } from \"./User\";\n+┊  ┊ 4┊import { Recipient } from \"./Recipient\";\n+┊  ┊ 5┊\n+┊  ┊ 6┊interface ChatConstructor {\n+┊  ┊ 7┊  name?: string;\n+┊  ┊ 8┊  picture?: string;\n+┊  ┊ 9┊  allTimeMembers?: User[];\n+┊  ┊10┊  listingMembers?: User[];\n+┊  ┊11┊  actualGroupMembers?: User[];\n+┊  ┊12┊  admins?: User[];\n+┊  ┊13┊  owner?: User;\n+┊  ┊14┊  messages?: Message[];\n+┊  ┊15┊}\n+┊  ┊16┊\n+┊  ┊17┊@Entity()\n+┊  ┊18┊export class Chat {\n+┊  ┊19┊  @PrimaryGeneratedColumn()\n+┊  ┊20┊  id: number;\n+┊  ┊21┊\n+┊  ┊22┊  @Column({nullable: true})\n+┊  ┊23┊  name: string;\n+┊  ┊24┊\n+┊  ┊25┊  @Column({nullable: true})\n+┊  ┊26┊  picture: string;\n+┊  ┊27┊\n+┊  ┊28┊  @ManyToMany(type => User, user => user.allTimeMemberChats, {cascade: [\"insert\", \"update\"], eager: false})\n+┊  ┊29┊  @JoinTable()\n+┊  ┊30┊  allTimeMembers: User[];\n+┊  ┊31┊\n+┊  ┊32┊  @ManyToMany(type => User, user => user.listingMemberChats, {cascade: [\"insert\", \"update\"], eager: false})\n+┊  ┊33┊  @JoinTable()\n+┊  ┊34┊  listingMembers: User[];\n+┊  ┊35┊\n+┊  ┊36┊  @ManyToMany(type => User, user => user.actualGroupMemberChats, {cascade: [\"insert\", \"update\"], eager: false})\n+┊  ┊37┊  @JoinTable()\n+┊  ┊38┊  actualGroupMembers?: User[];\n+┊  ┊39┊\n+┊  ┊40┊  @ManyToMany(type => User, user => user.adminChats, {cascade: [\"insert\", \"update\"], eager: false})\n+┊  ┊41┊  @JoinTable()\n+┊  ┊42┊  admins?: User[];\n+┊  ┊43┊\n+┊  ┊44┊  @ManyToOne(type => User, user => user.ownerChats, {cascade: [\"insert\", \"update\"], eager: false})\n+┊  ┊45┊  owner?: User | null;\n+┊  ┊46┊\n+┊  ┊47┊  @OneToMany(type => Message, message => message.chat, {cascade: [\"insert\", \"update\"], eager: true})\n+┊  ┊48┊  messages: Message[];\n+┊  ┊49┊\n+┊  ┊50┊  @OneToMany(type => Recipient, recipient => recipient.chat)\n+┊  ┊51┊  recipients: Recipient[];\n+┊  ┊52┊\n+┊  ┊53┊  constructor({name, picture, allTimeMembers, listingMembers, actualGroupMembers, admins, owner, messages}: ChatConstructor = {}) {\n+┊  ┊54┊    if (name) {\n+┊  ┊55┊      this.name = name;\n+┊  ┊56┊    }\n+┊  ┊57┊    if (picture) {\n+┊  ┊58┊      this.picture = picture;\n+┊  ┊59┊    }\n+┊  ┊60┊    if (allTimeMembers) {\n+┊  ┊61┊      this.allTimeMembers = allTimeMembers;\n+┊  ┊62┊    }\n+┊  ┊63┊    if (listingMembers) {\n+┊  ┊64┊      this.listingMembers = listingMembers;\n+┊  ┊65┊    }\n+┊  ┊66┊    if (actualGroupMembers) {\n+┊  ┊67┊      this.actualGroupMembers = actualGroupMembers;\n+┊  ┊68┊    }\n+┊  ┊69┊    if (admins) {\n+┊  ┊70┊      this.admins = admins;\n+┊  ┊71┊    }\n+┊  ┊72┊    if (owner) {\n+┊  ┊73┊      this.owner = owner;\n+┊  ┊74┊    }\n+┊  ┊75┊    if (messages) {\n+┊  ┊76┊      this.messages = messages;\n+┊  ┊77┊    }\n+┊  ┊78┊  }\n+┊  ┊79┊}\n```\n\n##### Added entity&#x2F;Message.ts\n```diff\n@@ -0,0 +1,70 @@\n+┊  ┊ 1┊import {\n+┊  ┊ 2┊  Entity, Column, PrimaryGeneratedColumn, OneToMany, ManyToOne, ManyToMany, JoinTable, CreateDateColumn\n+┊  ┊ 3┊} from \"typeorm\";\n+┊  ┊ 4┊import { Chat } from \"./Chat\";\n+┊  ┊ 5┊import { User } from \"./User\";\n+┊  ┊ 6┊import { Recipient } from \"./Recipient\";\n+┊  ┊ 7┊import { MessageType } from \"../db\";\n+┊  ┊ 8┊\n+┊  ┊ 9┊interface MessageConstructor {\n+┊  ┊10┊  sender?: User;\n+┊  ┊11┊  content?: string;\n+┊  ┊12┊  createdAt?: Date,\n+┊  ┊13┊  type?: MessageType;\n+┊  ┊14┊  recipients?: Recipient[];\n+┊  ┊15┊  holders?: User[];\n+┊  ┊16┊  chat?: Chat;\n+┊  ┊17┊}\n+┊  ┊18┊\n+┊  ┊19┊@Entity()\n+┊  ┊20┊export class Message {\n+┊  ┊21┊  @PrimaryGeneratedColumn()\n+┊  ┊22┊  id: number;\n+┊  ┊23┊\n+┊  ┊24┊  @ManyToOne(type => User, user => user.senderMessages, {eager: true})\n+┊  ┊25┊  sender: User;\n+┊  ┊26┊\n+┊  ┊27┊  @Column()\n+┊  ┊28┊  content: string;\n+┊  ┊29┊\n+┊  ┊30┊  @CreateDateColumn({nullable: true})\n+┊  ┊31┊  createdAt: Date;\n+┊  ┊32┊\n+┊  ┊33┊  @Column()\n+┊  ┊34┊  type: number;\n+┊  ┊35┊\n+┊  ┊36┊  @OneToMany(type => Recipient, recipient => recipient.message, {cascade: [\"insert\", \"update\"], eager: true})\n+┊  ┊37┊  recipients: Recipient[];\n+┊  ┊38┊\n+┊  ┊39┊  @ManyToMany(type => User, user => user.holderMessages, {cascade: [\"insert\", \"update\"], eager: true})\n+┊  ┊40┊  @JoinTable()\n+┊  ┊41┊  holders: User[];\n+┊  ┊42┊\n+┊  ┊43┊  @ManyToOne(type => Chat, chat => chat.messages)\n+┊  ┊44┊  chat: Chat;\n+┊  ┊45┊\n+┊  ┊46┊  constructor({sender, content, createdAt, type, recipients, holders, chat}: MessageConstructor = {}) {\n+┊  ┊47┊    if (sender) {\n+┊  ┊48┊      this.sender = sender;\n+┊  ┊49┊    }\n+┊  ┊50┊    if (content) {\n+┊  ┊51┊      this.content = content;\n+┊  ┊52┊    }\n+┊  ┊53┊    if (createdAt) {\n+┊  ┊54┊      this.createdAt = createdAt;\n+┊  ┊55┊    }\n+┊  ┊56┊    if (type) {\n+┊  ┊57┊      this.type = type;\n+┊  ┊58┊    }\n+┊  ┊59┊    if (recipients) {\n+┊  ┊60┊      recipients.forEach(recipient => recipient.message = this);\n+┊  ┊61┊      this.recipients = recipients;\n+┊  ┊62┊    }\n+┊  ┊63┊    if (holders) {\n+┊  ┊64┊      this.holders = holders;\n+┊  ┊65┊    }\n+┊  ┊66┊    if (chat) {\n+┊  ┊67┊      this.chat = chat;\n+┊  ┊68┊    }\n+┊  ┊69┊  }\n+┊  ┊70┊}\n```\n\n##### Added entity&#x2F;Recipient.ts\n```diff\n@@ -0,0 +1,44 @@\n+┊  ┊ 1┊import { Entity, ManyToOne, Column } from \"typeorm\";\n+┊  ┊ 2┊import { Message } from \"./Message\";\n+┊  ┊ 3┊import { User } from \"./User\";\n+┊  ┊ 4┊import { Chat } from \"./Chat\";\n+┊  ┊ 5┊\n+┊  ┊ 6┊interface RecipientConstructor {\n+┊  ┊ 7┊  user?: User;\n+┊  ┊ 8┊  message?: Message;\n+┊  ┊ 9┊  receivedAt?: Date;\n+┊  ┊10┊  readAt?: Date;\n+┊  ┊11┊}\n+┊  ┊12┊\n+┊  ┊13┊@Entity()\n+┊  ┊14┊export class Recipient {\n+┊  ┊15┊  @ManyToOne(type => User, user => user.recipients, { primary: true })\n+┊  ┊16┊  user: User;\n+┊  ┊17┊\n+┊  ┊18┊  @ManyToOne(type => Message, message => message.recipients, { primary: true })\n+┊  ┊19┊  message: Message;\n+┊  ┊20┊\n+┊  ┊21┊  @ManyToOne(type => Chat, chat => chat.recipients)\n+┊  ┊22┊  chat: Chat;\n+┊  ┊23┊\n+┊  ┊24┊  @Column({nullable: true})\n+┊  ┊25┊  receivedAt: Date;\n+┊  ┊26┊\n+┊  ┊27┊  @Column({nullable: true})\n+┊  ┊28┊  readAt: Date;\n+┊  ┊29┊\n+┊  ┊30┊  constructor({user, message, receivedAt, readAt}: RecipientConstructor = {}) {\n+┊  ┊31┊    if (user) {\n+┊  ┊32┊      this.user = user;\n+┊  ┊33┊    }\n+┊  ┊34┊    if (message) {\n+┊  ┊35┊      this.message = message;\n+┊  ┊36┊    }\n+┊  ┊37┊    if (receivedAt) {\n+┊  ┊38┊      this.receivedAt = receivedAt;\n+┊  ┊39┊    }\n+┊  ┊40┊    if (readAt) {\n+┊  ┊41┊      this.readAt = readAt;\n+┊  ┊42┊    }\n+┊  ┊43┊  }\n+┊  ┊44┊}\n```\n\n##### Added entity&#x2F;User.ts\n```diff\n@@ -0,0 +1,75 @@\n+┊  ┊ 1┊import { Entity, Column, PrimaryGeneratedColumn, ManyToMany, OneToMany } from \"typeorm\";\n+┊  ┊ 2┊import { Chat } from \"./Chat\";\n+┊  ┊ 3┊import { Message } from \"./Message\";\n+┊  ┊ 4┊import { Recipient } from \"./Recipient\";\n+┊  ┊ 5┊\n+┊  ┊ 6┊interface UserConstructor {\n+┊  ┊ 7┊  username?: string;\n+┊  ┊ 8┊  password?: string;\n+┊  ┊ 9┊  name?: string;\n+┊  ┊10┊  picture?: string;\n+┊  ┊11┊  phone?: string;\n+┊  ┊12┊}\n+┊  ┊13┊\n+┊  ┊14┊@Entity()\n+┊  ┊15┊export class User {\n+┊  ┊16┊  @PrimaryGeneratedColumn()\n+┊  ┊17┊  id: number;\n+┊  ┊18┊\n+┊  ┊19┊  @Column()\n+┊  ┊20┊  username: string;\n+┊  ┊21┊\n+┊  ┊22┊  @Column()\n+┊  ┊23┊  password: string;\n+┊  ┊24┊\n+┊  ┊25┊  @Column()\n+┊  ┊26┊  name: string;\n+┊  ┊27┊\n+┊  ┊28┊  @Column({nullable: true})\n+┊  ┊29┊  picture: string;\n+┊  ┊30┊\n+┊  ┊31┊  @Column({nullable: true})\n+┊  ┊32┊  phone?: string;\n+┊  ┊33┊\n+┊  ┊34┊  @ManyToMany(type => Chat, chat => chat.allTimeMembers)\n+┊  ┊35┊  allTimeMemberChats: Chat[];\n+┊  ┊36┊\n+┊  ┊37┊  @ManyToMany(type => Chat, chat => chat.listingMembers)\n+┊  ┊38┊  listingMemberChats: Chat[];\n+┊  ┊39┊\n+┊  ┊40┊  @ManyToMany(type => Chat, chat => chat.actualGroupMembers)\n+┊  ┊41┊  actualGroupMemberChats: Chat[];\n+┊  ┊42┊\n+┊  ┊43┊  @ManyToMany(type => Chat, chat => chat.admins)\n+┊  ┊44┊  adminChats: Chat[];\n+┊  ┊45┊\n+┊  ┊46┊  @ManyToMany(type => Message, message => message.holders)\n+┊  ┊47┊  holderMessages: Message[];\n+┊  ┊48┊\n+┊  ┊49┊  @OneToMany(type => Chat, chat => chat.owner)\n+┊  ┊50┊  ownerChats: Chat[];\n+┊  ┊51┊\n+┊  ┊52┊  @OneToMany(type => Message, message => message.sender)\n+┊  ┊53┊  senderMessages: Message[];\n+┊  ┊54┊\n+┊  ┊55┊  @OneToMany(type => Recipient, recipient => recipient.user)\n+┊  ┊56┊  recipients: Recipient[];\n+┊  ┊57┊\n+┊  ┊58┊  constructor({username, password, name, picture, phone}: UserConstructor = {}) {\n+┊  ┊59┊    if (username) {\n+┊  ┊60┊      this.username = username;\n+┊  ┊61┊    }\n+┊  ┊62┊    if (password) {\n+┊  ┊63┊      this.password = password;\n+┊  ┊64┊    }\n+┊  ┊65┊    if (name) {\n+┊  ┊66┊      this.name = name;\n+┊  ┊67┊    }\n+┊  ┊68┊    if (picture) {\n+┊  ┊69┊      this.picture = picture;\n+┊  ┊70┊    }\n+┊  ┊71┊    if (phone) {\n+┊  ┊72┊      this.phone = phone;\n+┊  ┊73┊    }\n+┊  ┊74┊  }\n+┊  ┊75┊}\n```\n\n[}]: #\n\nBasic entities consist of columns and relations. Each entity MUST have a primary column.\n\nEach entity must be registered in your connection options:\n\n[{]: <helper> (diffStep \"6.1\" files=\"ormconfig.json\" module=\"server\")\n\n#### [Step 6.1: TypeORM with PostgreSQL](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/00c4cab)\n\n##### Added ormconfig.json\n```diff\n@@ -0,0 +1,24 @@\n+┊  ┊ 1┊{\n+┊  ┊ 2┊   \"type\": \"postgres\",\n+┊  ┊ 3┊   \"host\": \"localhost\",\n+┊  ┊ 4┊   \"port\": 5432,\n+┊  ┊ 5┊   \"username\": \"test\",\n+┊  ┊ 6┊   \"password\": \"\",\n+┊  ┊ 7┊   \"database\": \"test\",\n+┊  ┊ 8┊   \"synchronize\": true,\n+┊  ┊ 9┊   \"logging\": false,\n+┊  ┊10┊   \"entities\": [\n+┊  ┊11┊      \"entity/**/*.ts\"\n+┊  ┊12┊   ],\n+┊  ┊13┊   \"migrations\": [\n+┊  ┊14┊      \"migration/**/*.ts\"\n+┊  ┊15┊   ],\n+┊  ┊16┊   \"subscribers\": [\n+┊  ┊17┊      \"subscriber/**/*.ts\"\n+┊  ┊18┊   ],\n+┊  ┊19┊   \"cli\": {\n+┊  ┊20┊      \"entitiesDir\": \"entity\",\n+┊  ┊21┊      \"migrationsDir\": \"migration\",\n+┊  ┊22┊      \"subscribersDir\": \"subscriber\"\n+┊  ┊23┊   }\n+┊  ┊24┊}🚫↵\n```\n\n[}]: #\n\nSince database table consist of columns your entities must consist of columns too. Each entity class property you marked with @Column will be mapped to a database table column.\nEach entity must have at least one primary column. There are several types of primary columns, but in our case `@PrimaryGeneratedColumn()` creates a primary column which value will be automatically generated with an auto-increment value.\n`@CreateDateColumn` is a special column that is automatically set to the entity's insertion date. You don't need set this column - it will be automatically set.\nFor the Recipient Entity we use a composite primary key that consists of two foreign keys.\n\nThe next thing to do is to create a connection with the database before firing up the web server:\n\n[{]: <helper> (diffStep \"6.1\" files=\"index.ts\" module=\"server\")\n\n#### [Step 6.1: TypeORM with PostgreSQL](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/00c4cab)\n\n##### Changed index.ts\n```diff\n@@ -1,3 +1,5 @@\n+┊ ┊1┊// For TypeORM\n+┊ ┊2┊import \"reflect-metadata\";\n ┊1┊3┊import { schema } from \"./schema\";\n ┊2┊4┊import * as bodyParser from \"body-parser\";\n ┊3┊5┊import * as cors from 'cors';\n```\n```diff\n@@ -6,12 +8,10 @@\n ┊ 6┊ 8┊import * as passport from \"passport\";\n ┊ 7┊ 9┊import * as basicStrategy from 'passport-http';\n ┊ 8┊10┊import * as bcrypt from 'bcrypt-nodejs';\n-┊ 9┊  ┊import { db, User } from \"./db\";\n ┊10┊11┊import { createServer } from \"http\";\n-┊11┊  ┊\n-┊12┊  ┊let users = db.users;\n-┊13┊  ┊\n-┊14┊  ┊console.log(users);\n+┊  ┊12┊import { createConnection } from \"typeorm\";\n+┊  ┊13┊import { User } from \"./entity/User\";\n+┊  ┊14┊import { addSampleData } from \"./db\";\n ┊15┊15┊\n ┊16┊16┊function generateHash(password: string) {\n ┊17┊17┊  return bcrypt.hashSync(password, bcrypt.genSaltSync(8));\n```\n```diff\n@@ -21,93 +21,96 @@\n ┊ 21┊ 21┊  return bcrypt.compareSync(password, localPassword);\n ┊ 22┊ 22┊}\n ┊ 23┊ 23┊\n-┊ 24┊   ┊passport.use('basic-signin', new basicStrategy.BasicStrategy(\n-┊ 25┊   ┊  function (username: string, password: string, done: any) {\n-┊ 26┊   ┊    const user = users.find(user => user.username == username);\n-┊ 27┊   ┊    if (user && validPassword(password, user.password)) {\n-┊ 28┊   ┊      return done(null, user);\n+┊   ┊ 24┊createConnection().then(async connection => {\n+┊   ┊ 25┊  await addSampleData(connection);\n+┊   ┊ 26┊\n+┊   ┊ 27┊  passport.use('basic-signin', new basicStrategy.BasicStrategy(\n+┊   ┊ 28┊    async function (username: string, password: string, done: any) {\n+┊   ┊ 29┊      const user = await connection.getRepository(User).findOne({where: { username }});\n+┊   ┊ 30┊      if (user && validPassword(password, user.password)) {\n+┊   ┊ 31┊        return done(null, user);\n+┊   ┊ 32┊      }\n+┊   ┊ 33┊      return done(null, false);\n ┊ 29┊ 34┊    }\n-┊ 30┊   ┊    return done(null, false);\n-┊ 31┊   ┊  }\n-┊ 32┊   ┊));\n-┊ 33┊   ┊\n-┊ 34┊   ┊passport.use('basic-signup', new basicStrategy.BasicStrategy({passReqToCallback: true},\n-┊ 35┊   ┊  function (req: any, username: any, password: any, done: any) {\n-┊ 36┊   ┊    const userExists = !!users.find(user => user.username === username);\n-┊ 37┊   ┊    if (!userExists && password && req.body.name) {\n-┊ 38┊   ┊      const user: User = {\n-┊ 39┊   ┊        id: (users.length && users[users.length - 1].id + 1) || 1,\n-┊ 40┊   ┊        username,\n-┊ 41┊   ┊        password: generateHash(password),\n-┊ 42┊   ┊        name: req.body.name,\n-┊ 43┊   ┊      };\n-┊ 44┊   ┊      users.push(user);\n-┊ 45┊   ┊      return done(null, user);\n+┊   ┊ 35┊  ));\n+┊   ┊ 36┊\n+┊   ┊ 37┊  passport.use('basic-signup', new basicStrategy.BasicStrategy({passReqToCallback: true},\n+┊   ┊ 38┊    async function (req: any, username: string, password: string, done: any) {\n+┊   ┊ 39┊      const userExists = !!(await connection.getRepository(User).findOne({where: { username }}));\n+┊   ┊ 40┊      if (!userExists && password && req.body.name) {\n+┊   ┊ 41┊        const user = await connection.manager.save(new User({\n+┊   ┊ 42┊          username,\n+┊   ┊ 43┊          password: generateHash(password),\n+┊   ┊ 44┊          name: req.body.name,\n+┊   ┊ 45┊        }));\n+┊   ┊ 46┊        return done(null, user);\n+┊   ┊ 47┊      }\n+┊   ┊ 48┊      return done(null, false);\n ┊ 46┊ 49┊    }\n-┊ 47┊   ┊    return done(null, false);\n-┊ 48┊   ┊  }\n-┊ 49┊   ┊));\n+┊   ┊ 50┊  ));\n ┊ 50┊ 51┊\n-┊ 51┊   ┊const PORT = 3000;\n+┊   ┊ 52┊  const PORT = 3000;\n ┊ 52┊ 53┊\n-┊ 53┊   ┊const app = express();\n+┊   ┊ 54┊  const app = express();\n ┊ 54┊ 55┊\n-┊ 55┊   ┊app.use(cors());\n-┊ 56┊   ┊app.use(bodyParser.json());\n-┊ 57┊   ┊app.use(passport.initialize());\n+┊   ┊ 56┊  app.use(cors());\n+┊   ┊ 57┊  app.use(bodyParser.json());\n+┊   ┊ 58┊  app.use(passport.initialize());\n ┊ 58┊ 59┊\n-┊ 59┊   ┊app.post('/signup',\n-┊ 60┊   ┊  passport.authenticate('basic-signup', {session: false}),\n-┊ 61┊   ┊  function (req: any, res) {\n-┊ 62┊   ┊    res.json(req.user);\n-┊ 63┊   ┊  });\n+┊   ┊ 60┊  app.post('/signup',\n+┊   ┊ 61┊    passport.authenticate('basic-signup', {session: false}),\n+┊   ┊ 62┊    function (req: any, res) {\n+┊   ┊ 63┊      res.json(req.user);\n+┊   ┊ 64┊    });\n ┊ 64┊ 65┊\n-┊ 65┊   ┊app.use(passport.authenticate('basic-signin', {session: false}));\n+┊   ┊ 66┊  app.use(passport.authenticate('basic-signin', {session: false}));\n ┊ 66┊ 67┊\n-┊ 67┊   ┊app.post('/signin', function (req: any, res) {\n-┊ 68┊   ┊  res.json(req.user);\n-┊ 69┊   ┊});\n+┊   ┊ 68┊  app.post('/signin', function (req, res) {\n+┊   ┊ 69┊    res.json(req.user);\n+┊   ┊ 70┊  });\n ┊ 70┊ 71┊\n-┊ 71┊   ┊const apollo = new ApolloServer({\n-┊ 72┊   ┊  schema,\n-┊ 73┊   ┊  context(received: any) {\n-┊ 74┊   ┊    return {\n-┊ 75┊   ┊      user: received.connection ? received.connection.context.user : received.req!['user'],\n-┊ 76┊   ┊    }\n-┊ 77┊   ┊  },\n-┊ 78┊   ┊  subscriptions: {\n-┊ 79┊   ┊    onConnect: (connectionParams: any, webSocket: any) => {\n-┊ 80┊   ┊      if (connectionParams.authToken) {\n-┊ 81┊   ┊        // create a buffer and tell it the data coming in is base64\n-┊ 82┊   ┊        const buf = new Buffer(connectionParams.authToken.split(' ')[1], 'base64');\n-┊ 83┊   ┊        // read it back out as a string\n-┊ 84┊   ┊        const [username, password]: string[] = buf.toString().split(':');\n-┊ 85┊   ┊        if (username && password) {\n-┊ 86┊   ┊          const user = users.find(user => user.username == username);\n-┊ 87┊   ┊\n-┊ 88┊   ┊          if (user && validPassword(password, user.password)) {\n-┊ 89┊   ┊            // Set context for the WebSocket\n-┊ 90┊   ┊            return {user};\n-┊ 91┊   ┊          } else {\n-┊ 92┊   ┊            throw new Error('Wrong credentials!');\n+┊   ┊ 72┊  const apollo = new ApolloServer({\n+┊   ┊ 73┊    schema,\n+┊   ┊ 74┊    context(received: any) {\n+┊   ┊ 75┊      return {\n+┊   ┊ 76┊        user: received.connection ? received.connection.context.user : received.req!['user'],\n+┊   ┊ 77┊        connection,\n+┊   ┊ 78┊      }\n+┊   ┊ 79┊    },\n+┊   ┊ 80┊    subscriptions: {\n+┊   ┊ 81┊      onConnect: async (connectionParams: any, webSocket: any) => {\n+┊   ┊ 82┊        if (connectionParams.authToken) {\n+┊   ┊ 83┊          // Create a buffer and tell it the data coming in is base64\n+┊   ┊ 84┊          const buf = new Buffer(connectionParams.authToken.split(' ')[1], 'base64');\n+┊   ┊ 85┊          // Read it back out as a string\n+┊   ┊ 86┊          const [username, password]: string[] = buf.toString().split(':');\n+┊   ┊ 87┊          if (username && password) {\n+┊   ┊ 88┊            const user = await connection.getRepository(User).findOne({where: { username }});\n+┊   ┊ 89┊\n+┊   ┊ 90┊            if (user && validPassword(password, user.password)) {\n+┊   ┊ 91┊              // Set context for the WebSocket\n+┊   ┊ 92┊              return {user};\n+┊   ┊ 93┊            } else {\n+┊   ┊ 94┊              throw new Error('Wrong credentials!');\n+┊   ┊ 95┊            }\n ┊ 93┊ 96┊          }\n ┊ 94┊ 97┊        }\n+┊   ┊ 98┊        throw new Error('Missing auth token!');\n ┊ 95┊ 99┊      }\n-┊ 96┊   ┊      throw new Error('Missing auth token!');\n ┊ 97┊100┊    }\n-┊ 98┊   ┊  }\n-┊ 99┊   ┊});\n+┊   ┊101┊  });\n ┊100┊102┊\n-┊101┊   ┊apollo.applyMiddleware({\n-┊102┊   ┊  app,\n-┊103┊   ┊  path: '/graphql'\n-┊104┊   ┊});\n+┊   ┊103┊  apollo.applyMiddleware({\n+┊   ┊104┊    app,\n+┊   ┊105┊    path: '/graphql'\n+┊   ┊106┊  });\n ┊105┊107┊\n-┊106┊   ┊// Wrap the Express server\n-┊107┊   ┊const ws = createServer(app);\n+┊   ┊108┊  // Wrap the Express server\n+┊   ┊109┊  const ws = createServer(app);\n ┊108┊110┊\n-┊109┊   ┊apollo.installSubscriptionHandlers(ws);\n+┊   ┊111┊  apollo.installSubscriptionHandlers(ws);\n ┊110┊112┊\n-┊111┊   ┊ws.listen(PORT, () => {\n-┊112┊   ┊  console.log(`Apollo Server is now running on http://localhost:${PORT}`);\n+┊   ┊113┊  ws.listen(PORT, () => {\n+┊   ┊114┊    console.log(`Apollo Server is now running on http://localhost:${PORT}`);\n+┊   ┊115┊  });\n ┊113┊116┊});\n```\n\n[}]: #\n\nWe will also remove our fake db and replace it with some real data:\n\n[{]: <helper> (diffStep \"6.1\" files=\"db.ts\" module=\"server\")\n\n#### [Step 6.1: TypeORM with PostgreSQL](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/00c4cab)\n\n##### Changed db.ts\n```diff\n@@ -1,4 +1,11 @@\n+┊  ┊ 1┊// For TypeORM\n+┊  ┊ 2┊import \"reflect-metadata\";\n+┊  ┊ 3┊import { Chat } from \"./entity/Chat\";\n+┊  ┊ 4┊import { Recipient } from \"./entity/Recipient\";\n ┊ 1┊ 5┊import * as moment from 'moment';\n+┊  ┊ 6┊import { Message } from \"./entity/Message\";\n+┊  ┊ 7┊import { User } from \"./entity/User\";\n+┊  ┊ 8┊import { Connection } from \"typeorm\";\n ┊ 2┊ 9┊\n ┊ 3┊10┊export enum MessageType {\n ┊ 4┊11┊  PICTURE,\n```\n```diff\n@@ -6,433 +13,280 @@\n ┊  6┊ 13┊  LOCATION,\n ┊  7┊ 14┊}\n ┊  8┊ 15┊\n-┊  9┊   ┊export interface User {\n-┊ 10┊   ┊  id: number,\n-┊ 11┊   ┊  username: string,\n-┊ 12┊   ┊  password: string,\n-┊ 13┊   ┊  name: string,\n-┊ 14┊   ┊  picture?: string | null,\n-┊ 15┊   ┊  phone?: string | null,\n-┊ 16┊   ┊}\n-┊ 17┊   ┊\n-┊ 18┊   ┊export interface Chat {\n-┊ 19┊   ┊  id: number,\n-┊ 20┊   ┊  name?: string | null,\n-┊ 21┊   ┊  picture?: string | null,\n-┊ 22┊   ┊  // All members, current and past ones.\n-┊ 23┊   ┊  allTimeMemberIds: number[],\n-┊ 24┊   ┊  // Whoever gets the chat listed. For groups includes past members who still didn't delete the group.\n-┊ 25┊   ┊  listingMemberIds: number[],\n-┊ 26┊   ┊  // Actual members of the group (they are not the only ones who get the group listed). Null for chats.\n-┊ 27┊   ┊  actualGroupMemberIds?: number[] | null,\n-┊ 28┊   ┊  adminIds?: number[] | null,\n-┊ 29┊   ┊  ownerId?: number | null,\n-┊ 30┊   ┊  messages: Message[],\n-┊ 31┊   ┊}\n-┊ 32┊   ┊\n-┊ 33┊   ┊export interface Message {\n-┊ 34┊   ┊  id: number,\n-┊ 35┊   ┊  chatId: number,\n-┊ 36┊   ┊  senderId: number,\n-┊ 37┊   ┊  content: string,\n-┊ 38┊   ┊  createdAt: number,\n-┊ 39┊   ┊  type: MessageType,\n-┊ 40┊   ┊  recipients: Recipient[],\n-┊ 41┊   ┊  holderIds: number[],\n-┊ 42┊   ┊}\n-┊ 43┊   ┊\n-┊ 44┊   ┊export interface Recipient {\n-┊ 45┊   ┊  userId: number,\n-┊ 46┊   ┊  messageId: number,\n-┊ 47┊   ┊  chatId: number,\n-┊ 48┊   ┊  receivedAt: number | null,\n-┊ 49┊   ┊  readAt: number | null,\n-┊ 50┊   ┊}\n-┊ 51┊   ┊\n-┊ 52┊   ┊const users: User[] = [\n-┊ 53┊   ┊  {\n-┊ 54┊   ┊    id: 1,\n+┊   ┊ 16┊export async function addSampleData(connection: Connection) {\n+┊   ┊ 17┊  const user1 = new User({\n ┊ 55┊ 18┊    username: 'ethan',\n ┊ 56┊ 19┊    password: '$2a$08$NO9tkFLCoSqX1c5wk3s7z.JfxaVMKA.m7zUDdDwEquo4rvzimQeJm', // 111\n ┊ 57┊ 20┊    name: 'Ethan Gonzalez',\n ┊ 58┊ 21┊    picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n ┊ 59┊ 22┊    phone: '+391234567890',\n-┊ 60┊   ┊  },\n-┊ 61┊   ┊  {\n-┊ 62┊   ┊    id: 2,\n+┊   ┊ 23┊  });\n+┊   ┊ 24┊  await connection.manager.save(user1);\n+┊   ┊ 25┊\n+┊   ┊ 26┊  const user2 = new User({\n ┊ 63┊ 27┊    username: 'bryan',\n ┊ 64┊ 28┊    password: '$2a$08$xE4FuCi/ifxjL2S8CzKAmuKLwv18ktksSN.F3XYEnpmcKtpbpeZgO', // 222\n ┊ 65┊ 29┊    name: 'Bryan Wallace',\n ┊ 66┊ 30┊    picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n ┊ 67┊ 31┊    phone: '+391234567891',\n-┊ 68┊   ┊  },\n-┊ 69┊   ┊  {\n-┊ 70┊   ┊    id: 3,\n+┊   ┊ 32┊  });\n+┊   ┊ 33┊  await connection.manager.save(user2);\n+┊   ┊ 34┊\n+┊   ┊ 35┊  const user3 = new User({\n ┊ 71┊ 36┊    username: 'avery',\n ┊ 72┊ 37┊    password: '$2a$08$UHgH7J8G6z1mGQn2qx2kdeWv0jvgHItyAsL9hpEUI3KJmhVW5Q1d.', // 333\n ┊ 73┊ 38┊    name: 'Avery Stewart',\n ┊ 74┊ 39┊    picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n ┊ 75┊ 40┊    phone: '+391234567892',\n-┊ 76┊   ┊  },\n-┊ 77┊   ┊  {\n-┊ 78┊   ┊    id: 4,\n+┊   ┊ 41┊  });\n+┊   ┊ 42┊  await connection.manager.save(user3);\n+┊   ┊ 43┊\n+┊   ┊ 44┊  const user4 = new User({\n ┊ 79┊ 45┊    username: 'katie',\n ┊ 80┊ 46┊    password: '$2a$08$wR1k5Q3T9FC7fUgB7Gdb9Os/GV7dGBBf4PLlWT7HERMFhmFDt47xi', // 444\n ┊ 81┊ 47┊    name: 'Katie Peterson',\n ┊ 82┊ 48┊    picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n ┊ 83┊ 49┊    phone: '+391234567893',\n-┊ 84┊   ┊  },\n-┊ 85┊   ┊  {\n-┊ 86┊   ┊    id: 5,\n+┊   ┊ 50┊  });\n+┊   ┊ 51┊  await connection.manager.save(user4);\n+┊   ┊ 52┊\n+┊   ┊ 53┊  const user5 = new User({\n ┊ 87┊ 54┊    username: 'ray',\n ┊ 88┊ 55┊    password: '$2a$08$6.mbXqsDX82ZZ7q5d8Osb..JrGSsNp4R3IKj7mxgF6YGT0OmMw242', // 555\n ┊ 89┊ 56┊    name: 'Ray Edwards',\n ┊ 90┊ 57┊    picture: 'https://randomuser.me/api/portraits/thumb/men/3.jpg',\n ┊ 91┊ 58┊    phone: '+391234567894',\n-┊ 92┊   ┊  },\n-┊ 93┊   ┊  {\n-┊ 94┊   ┊    id: 6,\n+┊   ┊ 59┊  });\n+┊   ┊ 60┊  await connection.manager.save(user5);\n+┊   ┊ 61┊\n+┊   ┊ 62┊  const user6 = new User({\n ┊ 95┊ 63┊    username: 'niko',\n ┊ 96┊ 64┊    password: '$2a$08$fL5lZR.Rwf9FWWe8XwwlceiPBBim8n9aFtaem.INQhiKT4.Ux3Uq.', // 666\n ┊ 97┊ 65┊    name: 'Niccolò Belli',\n ┊ 98┊ 66┊    picture: 'https://randomuser.me/api/portraits/thumb/men/4.jpg',\n ┊ 99┊ 67┊    phone: '+391234567895',\n-┊100┊   ┊  },\n-┊101┊   ┊  {\n-┊102┊   ┊    id: 7,\n+┊   ┊ 68┊  });\n+┊   ┊ 69┊  await connection.manager.save(user6);\n+┊   ┊ 70┊\n+┊   ┊ 71┊  const user7 = new User({\n ┊103┊ 72┊    username: 'mario',\n ┊104┊ 73┊    password: '$2a$08$nDHDmWcVxDnH5DDT3HMMC.psqcnu6wBiOgkmJUy9IH..qxa3R6YrO', // 777\n ┊105┊ 74┊    name: 'Mario Rossi',\n ┊106┊ 75┊    picture: 'https://randomuser.me/api/portraits/thumb/men/5.jpg',\n ┊107┊ 76┊    phone: '+391234567896',\n-┊108┊   ┊  },\n-┊109┊   ┊];\n+┊   ┊ 77┊  });\n+┊   ┊ 78┊  await connection.manager.save(user7);\n+┊   ┊ 79┊\n+┊   ┊ 80┊\n ┊110┊ 81┊\n-┊111┊   ┊const chats: Chat[] = [\n-┊112┊   ┊  {\n-┊113┊   ┊    id: 1,\n-┊114┊   ┊    name: null,\n-┊115┊   ┊    picture: null,\n-┊116┊   ┊    allTimeMemberIds: [1, 3],\n-┊117┊   ┊    listingMemberIds: [1, 3],\n-┊118┊   ┊    adminIds: null,\n-┊119┊   ┊    ownerId: null,\n+┊   ┊ 82┊\n+┊   ┊ 83┊  await connection.manager.save(new Chat({\n+┊   ┊ 84┊    allTimeMembers: [user1, user3],\n+┊   ┊ 85┊    listingMembers: [user1, user3],\n ┊120┊ 86┊    messages: [\n-┊121┊   ┊      {\n-┊122┊   ┊        id: 1,\n-┊123┊   ┊        chatId: 1,\n-┊124┊   ┊        senderId: 1,\n+┊   ┊ 87┊      new Message({\n+┊   ┊ 88┊        sender: user1,\n ┊125┊ 89┊        content: 'You on your way?',\n-┊126┊   ┊        createdAt: moment().subtract(1, 'hours').unix(),\n+┊   ┊ 90┊        createdAt: moment().subtract(1, 'hours').toDate(),\n ┊127┊ 91┊        type: MessageType.TEXT,\n+┊   ┊ 92┊        holders: [user1, user3],\n ┊128┊ 93┊        recipients: [\n-┊129┊   ┊          {\n-┊130┊   ┊            userId: 3,\n-┊131┊   ┊            messageId: 1,\n-┊132┊   ┊            chatId: 1,\n-┊133┊   ┊            receivedAt: null,\n-┊134┊   ┊            readAt: null,\n-┊135┊   ┊          },\n+┊   ┊ 94┊          new Recipient({\n+┊   ┊ 95┊            user: user3,\n+┊   ┊ 96┊          }),\n ┊136┊ 97┊        ],\n-┊137┊   ┊        holderIds: [1, 3],\n-┊138┊   ┊      },\n-┊139┊   ┊      {\n-┊140┊   ┊        id: 2,\n-┊141┊   ┊        chatId: 1,\n-┊142┊   ┊        senderId: 3,\n+┊   ┊ 98┊      }),\n+┊   ┊ 99┊      new Message({\n+┊   ┊100┊        sender: user3,\n ┊143┊101┊        content: 'Yep!',\n-┊144┊   ┊        createdAt: moment().subtract(1, 'hours').add(5, 'minutes').unix(),\n+┊   ┊102┊        createdAt: moment().subtract(1, 'hours').add(5, 'minutes').toDate(),\n ┊145┊103┊        type: MessageType.TEXT,\n+┊   ┊104┊        holders: [user1, user3],\n ┊146┊105┊        recipients: [\n-┊147┊   ┊          {\n-┊148┊   ┊            userId: 1,\n-┊149┊   ┊            messageId: 2,\n-┊150┊   ┊            chatId: 1,\n-┊151┊   ┊            receivedAt: null,\n-┊152┊   ┊            readAt: null,\n-┊153┊   ┊          },\n+┊   ┊106┊          new Recipient({\n+┊   ┊107┊            user: user1,\n+┊   ┊108┊          }),\n ┊154┊109┊        ],\n-┊155┊   ┊        holderIds: [3, 1],\n-┊156┊   ┊      },\n+┊   ┊110┊      }),\n ┊157┊111┊    ],\n-┊158┊   ┊  },\n-┊159┊   ┊  {\n-┊160┊   ┊    id: 2,\n-┊161┊   ┊    name: null,\n-┊162┊   ┊    picture: null,\n-┊163┊   ┊    allTimeMemberIds: [1, 4],\n-┊164┊   ┊    listingMemberIds: [1, 4],\n-┊165┊   ┊    adminIds: null,\n-┊166┊   ┊    ownerId: null,\n+┊   ┊112┊  }));\n+┊   ┊113┊\n+┊   ┊114┊  await connection.manager.save(new Chat({\n+┊   ┊115┊    allTimeMembers: [user1, user4],\n+┊   ┊116┊    listingMembers: [user1, user4],\n ┊167┊117┊    messages: [\n-┊168┊   ┊      {\n-┊169┊   ┊        id: 1,\n-┊170┊   ┊        chatId: 2,\n-┊171┊   ┊        senderId: 1,\n+┊   ┊118┊      new Message({\n+┊   ┊119┊        sender: user1,\n ┊172┊120┊        content: 'Hey, it\\'s me',\n-┊173┊   ┊        createdAt: moment().subtract(2, 'hours').unix(),\n+┊   ┊121┊        createdAt: moment().subtract(2, 'hours').toDate(),\n ┊174┊122┊        type: MessageType.TEXT,\n+┊   ┊123┊        holders: [user1, user4],\n ┊175┊124┊        recipients: [\n-┊176┊   ┊          {\n-┊177┊   ┊            userId: 4,\n-┊178┊   ┊            messageId: 1,\n-┊179┊   ┊            chatId: 2,\n-┊180┊   ┊            receivedAt: null,\n-┊181┊   ┊            readAt: null,\n-┊182┊   ┊          },\n+┊   ┊125┊          new Recipient({\n+┊   ┊126┊            user: user4,\n+┊   ┊127┊          }),\n ┊183┊128┊        ],\n-┊184┊   ┊        holderIds: [1, 4],\n-┊185┊   ┊      },\n+┊   ┊129┊      }),\n ┊186┊130┊    ],\n-┊187┊   ┊  },\n-┊188┊   ┊  {\n-┊189┊   ┊    id: 3,\n-┊190┊   ┊    name: null,\n-┊191┊   ┊    picture: null,\n-┊192┊   ┊    allTimeMemberIds: [1, 5],\n-┊193┊   ┊    listingMemberIds: [1, 5],\n-┊194┊   ┊    adminIds: null,\n-┊195┊   ┊    ownerId: null,\n+┊   ┊131┊  }));\n+┊   ┊132┊\n+┊   ┊133┊  await connection.manager.save(new Chat({\n+┊   ┊134┊    allTimeMembers: [user1, user5],\n+┊   ┊135┊    listingMembers: [user1, user5],\n ┊196┊136┊    messages: [\n-┊197┊   ┊      {\n-┊198┊   ┊        id: 1,\n-┊199┊   ┊        chatId: 3,\n-┊200┊   ┊        senderId: 1,\n+┊   ┊137┊      new Message({\n+┊   ┊138┊        sender: user1,\n ┊201┊139┊        content: 'I should buy a boat',\n-┊202┊   ┊        createdAt: moment().subtract(1, 'days').unix(),\n+┊   ┊140┊        createdAt: moment().subtract(1, 'days').toDate(),\n ┊203┊141┊        type: MessageType.TEXT,\n+┊   ┊142┊        holders: [user1, user5],\n ┊204┊143┊        recipients: [\n-┊205┊   ┊          {\n-┊206┊   ┊            userId: 5,\n-┊207┊   ┊            messageId: 1,\n-┊208┊   ┊            chatId: 3,\n-┊209┊   ┊            receivedAt: null,\n-┊210┊   ┊            readAt: null,\n-┊211┊   ┊          },\n+┊   ┊144┊          new Recipient({\n+┊   ┊145┊            user: user5,\n+┊   ┊146┊          }),\n ┊212┊147┊        ],\n-┊213┊   ┊        holderIds: [1, 5],\n-┊214┊   ┊      },\n-┊215┊   ┊      {\n-┊216┊   ┊        id: 2,\n-┊217┊   ┊        chatId: 3,\n-┊218┊   ┊        senderId: 1,\n+┊   ┊148┊      }),\n+┊   ┊149┊      new Message({\n+┊   ┊150┊        sender: user1,\n ┊219┊151┊        content: 'You still there?',\n-┊220┊   ┊        createdAt: moment().subtract(1, 'days').add(16, 'hours').unix(),\n+┊   ┊152┊        createdAt: moment().subtract(1, 'days').add(16, 'hours').toDate(),\n ┊221┊153┊        type: MessageType.TEXT,\n+┊   ┊154┊        holders: [user1, user5],\n ┊222┊155┊        recipients: [\n-┊223┊   ┊          {\n-┊224┊   ┊            userId: 5,\n-┊225┊   ┊            messageId: 2,\n-┊226┊   ┊            chatId: 3,\n-┊227┊   ┊            receivedAt: null,\n-┊228┊   ┊            readAt: null,\n-┊229┊   ┊          },\n+┊   ┊156┊          new Recipient({\n+┊   ┊157┊            user: user5,\n+┊   ┊158┊          }),\n ┊230┊159┊        ],\n-┊231┊   ┊        holderIds: [1, 5],\n-┊232┊   ┊      },\n+┊   ┊160┊      }),\n ┊233┊161┊    ],\n-┊234┊   ┊  },\n-┊235┊   ┊  {\n-┊236┊   ┊    id: 4,\n-┊237┊   ┊    name: null,\n-┊238┊   ┊    picture: null,\n-┊239┊   ┊    allTimeMemberIds: [3, 4],\n-┊240┊   ┊    listingMemberIds: [3, 4],\n-┊241┊   ┊    adminIds: null,\n-┊242┊   ┊    ownerId: null,\n+┊   ┊162┊  }));\n+┊   ┊163┊\n+┊   ┊164┊  await connection.manager.save(new Chat({\n+┊   ┊165┊    allTimeMembers: [user3, user4],\n+┊   ┊166┊    listingMembers: [user3, user4],\n ┊243┊167┊    messages: [\n-┊244┊   ┊      {\n-┊245┊   ┊        id: 1,\n-┊246┊   ┊        chatId: 4,\n-┊247┊   ┊        senderId: 3,\n+┊   ┊168┊      new Message({\n+┊   ┊169┊        sender: user3,\n ┊248┊170┊        content: 'Look at my mukluks!',\n-┊249┊   ┊        createdAt: moment().subtract(4, 'days').unix(),\n+┊   ┊171┊        createdAt: moment().subtract(4, 'days').toDate(),\n ┊250┊172┊        type: MessageType.TEXT,\n+┊   ┊173┊        holders: [user3, user4],\n ┊251┊174┊        recipients: [\n-┊252┊   ┊          {\n-┊253┊   ┊            userId: 4,\n-┊254┊   ┊            messageId: 1,\n-┊255┊   ┊            chatId: 4,\n-┊256┊   ┊            receivedAt: null,\n-┊257┊   ┊            readAt: null,\n-┊258┊   ┊          },\n+┊   ┊175┊          new Recipient({\n+┊   ┊176┊            user: user4,\n+┊   ┊177┊          }),\n ┊259┊178┊        ],\n-┊260┊   ┊        holderIds: [3, 4],\n-┊261┊   ┊      },\n+┊   ┊179┊      }),\n ┊262┊180┊    ],\n-┊263┊   ┊  },\n-┊264┊   ┊  {\n-┊265┊   ┊    id: 5,\n-┊266┊   ┊    name: null,\n-┊267┊   ┊    picture: null,\n-┊268┊   ┊    allTimeMemberIds: [2, 5],\n-┊269┊   ┊    listingMemberIds: [2, 5],\n-┊270┊   ┊    adminIds: null,\n-┊271┊   ┊    ownerId: null,\n+┊   ┊181┊  }));\n+┊   ┊182┊\n+┊   ┊183┊  await connection.manager.save(new Chat({\n+┊   ┊184┊    allTimeMembers: [user2, user5],\n+┊   ┊185┊    listingMembers: [user2, user5],\n ┊272┊186┊    messages: [\n-┊273┊   ┊      {\n-┊274┊   ┊        id: 1,\n-┊275┊   ┊        chatId: 5,\n-┊276┊   ┊        senderId: 2,\n+┊   ┊187┊      new Message({\n+┊   ┊188┊        sender: user2,\n ┊277┊189┊        content: 'This is wicked good ice cream.',\n-┊278┊   ┊        createdAt: moment().subtract(2, 'weeks').unix(),\n+┊   ┊190┊        createdAt: moment().subtract(2, 'weeks').toDate(),\n ┊279┊191┊        type: MessageType.TEXT,\n+┊   ┊192┊        holders: [user2, user5],\n ┊280┊193┊        recipients: [\n-┊281┊   ┊          {\n-┊282┊   ┊            userId: 5,\n-┊283┊   ┊            messageId: 1,\n-┊284┊   ┊            chatId: 5,\n-┊285┊   ┊            receivedAt: null,\n-┊286┊   ┊            readAt: null,\n-┊287┊   ┊          },\n+┊   ┊194┊          new Recipient({\n+┊   ┊195┊            user: user5,\n+┊   ┊196┊          }),\n ┊288┊197┊        ],\n-┊289┊   ┊        holderIds: [2, 5],\n-┊290┊   ┊      },\n-┊291┊   ┊      {\n-┊292┊   ┊        id: 2,\n-┊293┊   ┊        chatId: 6,\n-┊294┊   ┊        senderId: 5,\n+┊   ┊198┊      }),\n+┊   ┊199┊      new Message({\n+┊   ┊200┊        sender: user5,\n ┊295┊201┊        content: 'Love it!',\n-┊296┊   ┊        createdAt: moment().subtract(2, 'weeks').add(10, 'minutes').unix(),\n+┊   ┊202┊        createdAt: moment().subtract(2, 'weeks').add(10, 'minutes').toDate(),\n ┊297┊203┊        type: MessageType.TEXT,\n+┊   ┊204┊        holders: [user2, user5],\n ┊298┊205┊        recipients: [\n-┊299┊   ┊          {\n-┊300┊   ┊            userId: 2,\n-┊301┊   ┊            messageId: 2,\n-┊302┊   ┊            chatId: 5,\n-┊303┊   ┊            receivedAt: null,\n-┊304┊   ┊            readAt: null,\n-┊305┊   ┊          },\n+┊   ┊206┊          new Recipient({\n+┊   ┊207┊            user: user2,\n+┊   ┊208┊          }),\n ┊306┊209┊        ],\n-┊307┊   ┊        holderIds: [5, 2],\n-┊308┊   ┊      },\n+┊   ┊210┊      }),\n ┊309┊211┊    ],\n-┊310┊   ┊  },\n-┊311┊   ┊  {\n-┊312┊   ┊    id: 6,\n-┊313┊   ┊    name: null,\n-┊314┊   ┊    picture: null,\n-┊315┊   ┊    allTimeMemberIds: [1, 6],\n-┊316┊   ┊    listingMemberIds: [1],\n-┊317┊   ┊    adminIds: null,\n-┊318┊   ┊    ownerId: null,\n-┊319┊   ┊    messages: [],\n-┊320┊   ┊  },\n-┊321┊   ┊  {\n-┊322┊   ┊    id: 7,\n-┊323┊   ┊    name: null,\n-┊324┊   ┊    picture: null,\n-┊325┊   ┊    allTimeMemberIds: [2, 1],\n-┊326┊   ┊    listingMemberIds: [2],\n-┊327┊   ┊    adminIds: null,\n-┊328┊   ┊    ownerId: null,\n-┊329┊   ┊    messages: [],\n-┊330┊   ┊  },\n-┊331┊   ┊  {\n-┊332┊   ┊    id: 8,\n-┊333┊   ┊    name: 'A user 0 group',\n+┊   ┊212┊  }));\n+┊   ┊213┊\n+┊   ┊214┊  await connection.manager.save(new Chat({\n+┊   ┊215┊    allTimeMembers: [user1, user6],\n+┊   ┊216┊    listingMembers: [user1],\n+┊   ┊217┊  }));\n+┊   ┊218┊\n+┊   ┊219┊  await connection.manager.save(new Chat({\n+┊   ┊220┊    allTimeMembers: [user2, user1],\n+┊   ┊221┊    listingMembers: [user2],\n+┊   ┊222┊  }));\n+┊   ┊223┊\n+┊   ┊224┊  await connection.manager.save(new Chat({\n+┊   ┊225┊    name: 'Ethan\\'s group',\n ┊334┊226┊    picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n-┊335┊   ┊    allTimeMemberIds: [1, 3, 4, 6],\n-┊336┊   ┊    listingMemberIds: [1, 3, 4, 6],\n-┊337┊   ┊    actualGroupMemberIds: [1, 4, 6],\n-┊338┊   ┊    adminIds: [1, 6],\n-┊339┊   ┊    ownerId: 1,\n+┊   ┊227┊    allTimeMembers: [user1, user3, user4, user6],\n+┊   ┊228┊    listingMembers: [user1, user3, user4, user6],\n+┊   ┊229┊    actualGroupMembers: [user1, user4, user6],\n+┊   ┊230┊    admins: [user1, user6],\n+┊   ┊231┊    owner: user1,\n ┊340┊232┊    messages: [\n-┊341┊   ┊      {\n-┊342┊   ┊        id: 1,\n-┊343┊   ┊        chatId: 8,\n-┊344┊   ┊        senderId: 1,\n+┊   ┊233┊      new Message({\n+┊   ┊234┊        sender: user1,\n ┊345┊235┊        content: 'I made a group',\n-┊346┊   ┊        createdAt: moment().subtract(2, 'weeks').unix(),\n+┊   ┊236┊        createdAt: moment().subtract(2, 'weeks').toDate(),\n ┊347┊237┊        type: MessageType.TEXT,\n+┊   ┊238┊        holders: [user1, user3, user4, user6],\n ┊348┊239┊        recipients: [\n-┊349┊   ┊          {\n-┊350┊   ┊            userId: 3,\n-┊351┊   ┊            messageId: 1,\n-┊352┊   ┊            chatId: 8,\n-┊353┊   ┊            receivedAt: null,\n-┊354┊   ┊            readAt: null,\n-┊355┊   ┊          },\n-┊356┊   ┊          {\n-┊357┊   ┊            userId: 4,\n-┊358┊   ┊            messageId: 1,\n-┊359┊   ┊            chatId: 8,\n-┊360┊   ┊            receivedAt: moment().subtract(2, 'weeks').add(1, 'minutes').unix(),\n-┊361┊   ┊            readAt: moment().subtract(2, 'weeks').add(5, 'minutes').unix(),\n-┊362┊   ┊          },\n-┊363┊   ┊          {\n-┊364┊   ┊            userId: 6,\n-┊365┊   ┊            messageId: 1,\n-┊366┊   ┊            chatId: 8,\n-┊367┊   ┊            receivedAt: null,\n-┊368┊   ┊            readAt: null,\n-┊369┊   ┊          },\n+┊   ┊240┊          new Recipient({\n+┊   ┊241┊            user: user3,\n+┊   ┊242┊          }),\n+┊   ┊243┊          new Recipient({\n+┊   ┊244┊            user: user4,\n+┊   ┊245┊          }),\n+┊   ┊246┊          new Recipient({\n+┊   ┊247┊            user: user6,\n+┊   ┊248┊          }),\n ┊370┊249┊        ],\n-┊371┊   ┊        holderIds: [1, 3, 4, 6],\n-┊372┊   ┊      },\n-┊373┊   ┊      {\n-┊374┊   ┊        id: 2,\n-┊375┊   ┊        chatId: 8,\n-┊376┊   ┊        senderId: 1,\n-┊377┊   ┊        content: 'Ops, user 3 was not supposed to be here',\n-┊378┊   ┊        createdAt: moment().subtract(2, 'weeks').add(2, 'minutes').unix(),\n+┊   ┊250┊      }),\n+┊   ┊251┊      new Message({\n+┊   ┊252┊        sender: user1,\n+┊   ┊253┊        content: 'Ops, Avery was not supposed to be here',\n+┊   ┊254┊        createdAt: moment().subtract(2, 'weeks').add(2, 'minutes').toDate(),\n ┊379┊255┊        type: MessageType.TEXT,\n+┊   ┊256┊        holders: [user1, user4, user6],\n ┊380┊257┊        recipients: [\n-┊381┊   ┊          {\n-┊382┊   ┊            userId: 4,\n-┊383┊   ┊            messageId: 2,\n-┊384┊   ┊            chatId: 8,\n-┊385┊   ┊            receivedAt: moment().subtract(2, 'weeks').add(3, 'minutes').unix(),\n-┊386┊   ┊            readAt: moment().subtract(2, 'weeks').add(5, 'minutes').unix(),\n-┊387┊   ┊          },\n-┊388┊   ┊          {\n-┊389┊   ┊            userId: 6,\n-┊390┊   ┊            messageId: 2,\n-┊391┊   ┊            chatId: 8,\n-┊392┊   ┊            receivedAt: null,\n-┊393┊   ┊            readAt: null,\n-┊394┊   ┊          },\n+┊   ┊258┊          new Recipient({\n+┊   ┊259┊            user: user4,\n+┊   ┊260┊          }),\n+┊   ┊261┊          new Recipient({\n+┊   ┊262┊            user: user6,\n+┊   ┊263┊          }),\n ┊395┊264┊        ],\n-┊396┊   ┊        holderIds: [1, 4, 6],\n-┊397┊   ┊      },\n-┊398┊   ┊      {\n-┊399┊   ┊        id: 3,\n-┊400┊   ┊        chatId: 8,\n-┊401┊   ┊        senderId: 4,\n+┊   ┊265┊      }),\n+┊   ┊266┊      new Message({\n+┊   ┊267┊        sender: user4,\n ┊402┊268┊        content: 'Awesome!',\n-┊403┊   ┊        createdAt: moment().subtract(2, 'weeks').add(10, 'minutes').unix(),\n+┊   ┊269┊        createdAt: moment().subtract(2, 'weeks').add(10, 'minutes').toDate(),\n ┊404┊270┊        type: MessageType.TEXT,\n+┊   ┊271┊        holders: [user1, user4, user6],\n ┊405┊272┊        recipients: [\n-┊406┊   ┊          {\n-┊407┊   ┊            userId: 1,\n-┊408┊   ┊            messageId: 3,\n-┊409┊   ┊            chatId: 8,\n-┊410┊   ┊            receivedAt: null,\n-┊411┊   ┊            readAt: null,\n-┊412┊   ┊          },\n-┊413┊   ┊          {\n-┊414┊   ┊            userId: 6,\n-┊415┊   ┊            messageId: 3,\n-┊416┊   ┊            chatId: 8,\n-┊417┊   ┊            receivedAt: null,\n-┊418┊   ┊            readAt: null,\n-┊419┊   ┊          },\n+┊   ┊273┊          new Recipient({\n+┊   ┊274┊            user: user1,\n+┊   ┊275┊          }),\n+┊   ┊276┊          new Recipient({\n+┊   ┊277┊            user: user6,\n+┊   ┊278┊          }),\n ┊420┊279┊        ],\n-┊421┊   ┊        holderIds: [1, 4, 6],\n-┊422┊   ┊      },\n+┊   ┊280┊      }),\n ┊423┊281┊    ],\n-┊424┊   ┊  },\n-┊425┊   ┊  {\n-┊426┊   ┊    id: 9,\n-┊427┊   ┊    name: 'A user 5 group',\n-┊428┊   ┊    picture: null,\n-┊429┊   ┊    allTimeMemberIds: [6, 3],\n-┊430┊   ┊    listingMemberIds: [6, 3],\n-┊431┊   ┊    actualGroupMemberIds: [6, 3],\n-┊432┊   ┊    adminIds: [6],\n-┊433┊   ┊    ownerId: 6,\n-┊434┊   ┊    messages: [],\n-┊435┊   ┊  },\n-┊436┊   ┊];\n+┊   ┊282┊  }));\n ┊437┊283┊\n-┊438┊   ┊export const db = {users, chats};\n+┊   ┊284┊  await connection.manager.save(new Chat({\n+┊   ┊285┊    name: 'Ray\\'s group',\n+┊   ┊286┊    allTimeMembers: [user3, user6],\n+┊   ┊287┊    listingMembers: [user3, user6],\n+┊   ┊288┊    actualGroupMembers: [user3, user6],\n+┊   ┊289┊    admins: [user6],\n+┊   ┊290┊    owner: user6,\n+┊   ┊291┊  }));\n+┊   ┊292┊}\n```\n\n[}]: #\n\nIt's time to deal with resolvers:\n\n[{]: <helper> (diffStep \"6.1\" files=\"schema/resolvers.ts\" module=\"server\")\n\n#### [Step 6.1: TypeORM with PostgreSQL](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/00c4cab)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,91 +1,127 @@\n ┊  1┊  1┊import { PubSub, withFilter, IResolvers } from 'apollo-server-express';\n-┊  2┊   ┊import { Chat, db, Message, MessageType, Recipient, User } from \"../db\";\n+┊   ┊  2┊import { MessageType } from \"../db\";\n ┊  3┊  3┊import {\n ┊  4┊  4┊  AddChatMutationArgs, AddGroupMutationArgs, AddMessageMutationArgs, ChatQueryArgs, MessageAddedSubscriptionArgs,\n ┊  5┊  5┊  RemoveChatMutationArgs, RemoveMessagesMutationArgs\n ┊  6┊  6┊} from \"../types\";\n ┊  7┊  7┊import * as moment from \"moment\";\n-┊  8┊   ┊\n-┊  9┊   ┊let users = db.users;\n-┊ 10┊   ┊let chats = db.chats;\n+┊   ┊  8┊import { User } from \"../entity/User\";\n+┊   ┊  9┊import { Chat } from \"../entity/Chat\";\n+┊   ┊ 10┊import { Message } from \"../entity/Message\";\n+┊   ┊ 11┊import { Recipient } from \"../entity/Recipient\";\n+┊   ┊ 12┊import { Connection } from \"typeorm\";\n ┊ 11┊ 13┊\n ┊ 12┊ 14┊export const pubsub = new PubSub();\n ┊ 13┊ 15┊\n ┊ 14┊ 16┊export const resolvers: IResolvers = {\n ┊ 15┊ 17┊  Query: {\n ┊ 16┊ 18┊    // Show all users for the moment.\n-┊ 17┊   ┊    users: (obj: any, args: any, {user: currentUser}: {user: User}): User[] => users.filter(user => user.id !== currentUser.id),\n-┊ 18┊   ┊    chats: (obj: any, args: any, {user: currentUser}: {user: User}): Chat[] => chats.filter(chat => chat.listingMemberIds.includes(currentUser.id)),\n-┊ 19┊   ┊    chat: (obj: any, {chatId}: ChatQueryArgs): Chat | null => chats.find(chat => chat.id === Number(chatId)) || null,\n+┊   ┊ 19┊    users: async (obj: any, args: any, {user: currentUser, connection}: { user: User, connection: Connection }): Promise<User[]> => {\n+┊   ┊ 20┊      return await connection\n+┊   ┊ 21┊        .createQueryBuilder(User, \"user\")\n+┊   ┊ 22┊        .where('user.id != :id', {id: currentUser.id})\n+┊   ┊ 23┊        .getMany();\n+┊   ┊ 24┊    },\n+┊   ┊ 25┊    chats: async (obj: any, args: any, {user: currentUser, connection}: { user: User, connection: Connection }): Promise<any[]> => {\n+┊   ┊ 26┊      return await connection\n+┊   ┊ 27┊        .createQueryBuilder(Chat, \"chat\")\n+┊   ┊ 28┊        .leftJoin('chat.listingMembers', 'listingMembers')\n+┊   ┊ 29┊        .where('listingMembers.id = :id', {id: currentUser.id})\n+┊   ┊ 30┊        .getMany();\n+┊   ┊ 31┊    },\n+┊   ┊ 32┊    chat: async (obj: any, {chatId}: ChatQueryArgs, {connection}: { user: User, connection: Connection }): Promise<any> => {\n+┊   ┊ 33┊      return await connection\n+┊   ┊ 34┊        .createQueryBuilder(Chat, \"chat\")\n+┊   ┊ 35┊        .whereInIds(chatId)\n+┊   ┊ 36┊        .getOne();\n+┊   ┊ 37┊    },\n ┊ 20┊ 38┊  },\n ┊ 21┊ 39┊  Mutation: {\n-┊ 22┊   ┊    addChat: (obj: any, {recipientId}: AddChatMutationArgs, {user: currentUser}: {user: User}): Chat => {\n-┊ 23┊   ┊      if (!users.find(user => user.id === Number(recipientId))) {\n+┊   ┊ 40┊    addChat: async (obj: any, {recipientId}: AddChatMutationArgs, {user: currentUser, connection}: { user: User, connection: Connection }): Promise<Chat | null> => {\n+┊   ┊ 41┊      const recipient = await connection\n+┊   ┊ 42┊        .createQueryBuilder(User, \"user\")\n+┊   ┊ 43┊        .whereInIds(recipientId)\n+┊   ┊ 44┊        .getOne();\n+┊   ┊ 45┊\n+┊   ┊ 46┊      if (!recipient) {\n ┊ 24┊ 47┊        throw new Error(`Recipient ${recipientId} doesn't exist.`);\n ┊ 25┊ 48┊      }\n ┊ 26┊ 49┊\n-┊ 27┊   ┊      const chat = chats.find(chat => !chat.name && chat.allTimeMemberIds.includes(currentUser.id) && chat.allTimeMemberIds.includes(Number(recipientId)));\n+┊   ┊ 50┊      let chat = await connection\n+┊   ┊ 51┊        .createQueryBuilder(Chat, \"chat\")\n+┊   ┊ 52┊        .where('chat.name IS NULL')\n+┊   ┊ 53┊        .innerJoin('chat.allTimeMembers', 'allTimeMembers1', 'allTimeMembers1.id = :currentUserId', {currentUserId: currentUser.id})\n+┊   ┊ 54┊        .innerJoin('chat.allTimeMembers', 'allTimeMembers2', 'allTimeMembers2.id = :recipientId', {recipientId})\n+┊   ┊ 55┊        .innerJoinAndSelect('chat.listingMembers', 'listingMembers')\n+┊   ┊ 56┊        .getOne();\n+┊   ┊ 57┊\n ┊ 28┊ 58┊      if (chat) {\n-┊ 29┊   ┊        // Chat already exists. Both users are already in the allTimeMemberIds array\n-┊ 30┊   ┊        const chatId = chat.id;\n-┊ 31┊   ┊        if (!chat.listingMemberIds.includes(currentUser.id)) {\n+┊   ┊ 59┊        // Chat already exists. Both users are already in the userIds array\n+┊   ┊ 60┊        const listingMembers = await connection\n+┊   ┊ 61┊          .createQueryBuilder(User, \"user\")\n+┊   ┊ 62┊          .innerJoin('user.listingMemberChats', 'listingMemberChats', 'listingMemberChats.id = :chatId', {chatId: chat.id})\n+┊   ┊ 63┊          .getMany();\n+┊   ┊ 64┊\n+┊   ┊ 65┊        if (!listingMembers.find(user => user.id === currentUser.id)) {\n ┊ 32┊ 66┊          // The chat isn't listed for the current user. Add him to the memberIds\n-┊ 33┊   ┊          chat.listingMemberIds.push(currentUser.id);\n-┊ 34┊   ┊          chats.find(chat => chat.id === chatId)!.listingMemberIds.push(currentUser.id);\n-┊ 35┊   ┊          return chat;\n+┊   ┊ 67┊          chat.listingMembers.push(currentUser);\n+┊   ┊ 68┊          chat = await connection.getRepository(Chat).save(chat);\n+┊   ┊ 69┊\n+┊   ┊ 70┊          return chat || null;\n ┊ 36┊ 71┊        } else {\n ┊ 37┊ 72┊          throw new Error(`Chat already exists.`);\n ┊ 38┊ 73┊        }\n ┊ 39┊ 74┊      } else {\n ┊ 40┊ 75┊        // Create the chat\n-┊ 41┊   ┊        const id = (chats.length && chats[chats.length - 1].id + 1) || 1;\n-┊ 42┊   ┊        const chat: Chat = {\n-┊ 43┊   ┊          id,\n-┊ 44┊   ┊          name: null,\n-┊ 45┊   ┊          picture: null,\n-┊ 46┊   ┊          adminIds: null,\n-┊ 47┊   ┊          ownerId: null,\n-┊ 48┊   ┊          allTimeMemberIds: [currentUser.id, Number(recipientId)],\n+┊   ┊ 76┊        chat = await connection.getRepository(Chat).save(new Chat({\n+┊   ┊ 77┊          allTimeMembers: [currentUser, recipient],\n ┊ 49┊ 78┊          // Chat will not be listed to the other user until the first message gets written\n-┊ 50┊   ┊          listingMemberIds: [currentUser.id],\n-┊ 51┊   ┊          actualGroupMemberIds: null,\n-┊ 52┊   ┊          messages: [],\n-┊ 53┊   ┊        };\n-┊ 54┊   ┊        chats.push(chat);\n+┊   ┊ 79┊          listingMembers: [currentUser],\n+┊   ┊ 80┊        }));\n ┊ 55┊ 81┊\n-┊ 56┊   ┊        return chat;\n+┊   ┊ 82┊        return chat || null;\n ┊ 57┊ 83┊      }\n ┊ 58┊ 84┊    },\n-┊ 59┊   ┊    addGroup: (obj: any, {recipientIds, groupName}: AddGroupMutationArgs, {user: currentUser}: {user: User}): Chat => {\n-┊ 60┊   ┊      recipientIds.forEach(recipientId => {\n-┊ 61┊   ┊        if (!users.find(user => user.id === Number(recipientId))) {\n+┊   ┊ 85┊    addGroup: async (obj: any, {recipientIds, groupName}: AddGroupMutationArgs, {user: currentUser, connection}: { user: User, connection: Connection }): Promise<Chat | null> => {\n+┊   ┊ 86┊      let recipients: User[] = [];\n+┊   ┊ 87┊      for (let recipientId of recipientIds) {\n+┊   ┊ 88┊        const recipient = await connection\n+┊   ┊ 89┊          .createQueryBuilder(User, \"user\")\n+┊   ┊ 90┊          .whereInIds(recipientId)\n+┊   ┊ 91┊          .getOne();\n+┊   ┊ 92┊        if (!recipient) {\n ┊ 62┊ 93┊          throw new Error(`Recipient ${recipientId} doesn't exist.`);\n ┊ 63┊ 94┊        }\n-┊ 64┊   ┊      });\n+┊   ┊ 95┊        recipients.push(recipient);\n+┊   ┊ 96┊      }\n ┊ 65┊ 97┊\n-┊ 66┊   ┊      const id = (chats.length && chats[chats.length - 1].id + 1) || 1;\n-┊ 67┊   ┊      const chat: Chat = {\n-┊ 68┊   ┊        id,\n+┊   ┊ 98┊      const chat = await connection.getRepository(Chat).save(new Chat({\n ┊ 69┊ 99┊        name: groupName,\n-┊ 70┊   ┊        picture: null,\n-┊ 71┊   ┊        adminIds: [currentUser.id],\n-┊ 72┊   ┊        ownerId: currentUser.id,\n-┊ 73┊   ┊        allTimeMemberIds: [currentUser.id, ...recipientIds.map(id => Number(id))],\n-┊ 74┊   ┊        listingMemberIds: [currentUser.id, ...recipientIds.map(id => Number(id))],\n-┊ 75┊   ┊        actualGroupMemberIds: [currentUser.id, ...recipientIds.map(id => Number(id))],\n-┊ 76┊   ┊        messages: [],\n-┊ 77┊   ┊      };\n-┊ 78┊   ┊      chats.push(chat);\n+┊   ┊100┊        admins: [currentUser],\n+┊   ┊101┊        owner: currentUser,\n+┊   ┊102┊        allTimeMembers: [...recipients, currentUser],\n+┊   ┊103┊        listingMembers: [...recipients, currentUser],\n+┊   ┊104┊        actualGroupMembers: [...recipients, currentUser],\n+┊   ┊105┊      }));\n ┊ 79┊106┊\n ┊ 80┊107┊      pubsub.publish('chatAdded', {\n ┊ 81┊108┊        creatorId: currentUser.id,\n ┊ 82┊109┊        chatAdded: chat,\n ┊ 83┊110┊      });\n ┊ 84┊111┊\n-┊ 85┊   ┊      return chat;\n+┊   ┊112┊      return chat || null;\n ┊ 86┊113┊    },\n-┊ 87┊   ┊    removeChat: (obj: any, {chatId}: RemoveChatMutationArgs, {user: currentUser}: {user: User}): number => {\n-┊ 88┊   ┊      const chat = chats.find(chat => chat.id === Number(chatId));\n+┊   ┊114┊    removeChat: async (obj: any, {chatId}: RemoveChatMutationArgs, {user: currentUser, connection}: { user: User, connection: Connection }) => {\n+┊   ┊115┊      const chat = await connection\n+┊   ┊116┊        .createQueryBuilder(Chat, \"chat\")\n+┊   ┊117┊        .whereInIds(Number(chatId))\n+┊   ┊118┊        .innerJoinAndSelect('chat.listingMembers', 'listingMembers')\n+┊   ┊119┊        .leftJoinAndSelect('chat.actualGroupMembers', 'actualGroupMembers')\n+┊   ┊120┊        .leftJoinAndSelect('chat.admins', 'admins')\n+┊   ┊121┊        .leftJoinAndSelect('chat.owner', 'owner')\n+┊   ┊122┊        .leftJoinAndSelect('chat.messages', 'messages')\n+┊   ┊123┊        .leftJoinAndSelect('messages.holders', 'holders')\n+┊   ┊124┊        .getOne();\n ┊ 89┊125┊\n ┊ 90┊126┊      if (!chat) {\n ┊ 91┊127┊        throw new Error(`The chat ${chatId} doesn't exist.`);\n```\n```diff\n@@ -93,186 +129,188 @@\n ┊ 93┊129┊\n ┊ 94┊130┊      if (!chat.name) {\n ┊ 95┊131┊        // Chat\n-┊ 96┊   ┊        if (!chat.listingMemberIds.includes(currentUser.id)) {\n-┊ 97┊   ┊          throw new Error(`The user is not a member of the chat ${chatId}.`);\n+┊   ┊132┊        if (!chat.listingMembers.find(user => user.id === currentUser.id)) {\n+┊   ┊133┊          throw new Error(`The user is not a listing member of the chat ${chatId}.`);\n ┊ 98┊134┊        }\n ┊ 99┊135┊\n ┊100┊136┊        // Instead of chaining map and filter we can loop once using reduce\n-┊101┊   ┊        const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n-┊102┊   ┊          // Remove the current user from the message holders\n-┊103┊   ┊          message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser.id);\n+┊   ┊137┊        chat.messages = await chat.messages.reduce<Promise<Message[]>>(async (filtered$, message) => {\n+┊   ┊138┊          const filtered = await filtered$;\n ┊104┊139┊\n-┊105┊   ┊          if (message.holderIds.length !== 0) {\n+┊   ┊140┊          message.holders = message.holders.filter(user => user.id !== currentUser.id);\n+┊   ┊141┊\n+┊   ┊142┊          if (message.holders.length !== 0) {\n+┊   ┊143┊            // Remove the current user from the message holders\n+┊   ┊144┊            await connection.getRepository(Message).save(message);\n ┊106┊145┊            filtered.push(message);\n-┊107┊   ┊          } // else discard the message\n+┊   ┊146┊          } else {\n+┊   ┊147┊            // Simply remove the message\n+┊   ┊148┊            const recipients = await connection\n+┊   ┊149┊              .createQueryBuilder(Recipient, \"recipient\")\n+┊   ┊150┊              .innerJoinAndSelect('recipient.message', 'message', 'message.id = :messageId', {messageId: message.id})\n+┊   ┊151┊              .innerJoinAndSelect('recipient.user', 'user')\n+┊   ┊152┊              .getMany();\n+┊   ┊153┊            for (let recipient of recipients) {\n+┊   ┊154┊              await connection.getRepository(Recipient).remove(recipient);\n+┊   ┊155┊            }\n+┊   ┊156┊            await connection.getRepository(Message).remove(message);\n+┊   ┊157┊          }\n ┊108┊158┊\n ┊109┊159┊          return filtered;\n-┊110┊   ┊        }, []);\n+┊   ┊160┊        }, Promise.resolve([]));\n ┊111┊161┊\n ┊112┊162┊        // Remove the current user from who gets the chat listed. The chat will no longer appear in his list\n-┊113┊   ┊        const listingMemberIds = chat.listingMemberIds.filter(listingId => listingId !== currentUser.id);\n+┊   ┊163┊        chat.listingMembers = chat.listingMembers.filter(user => user.id !== currentUser.id);\n ┊114┊164┊\n ┊115┊165┊        // Check how many members are left\n-┊116┊   ┊        if (listingMemberIds.length === 0) {\n+┊   ┊166┊        if (chat.listingMembers.length === 0) {\n ┊117┊167┊          // Delete the chat\n-┊118┊   ┊          chats = chats.filter(chat => chat.id !== Number(chatId));\n+┊   ┊168┊          await connection.getRepository(Chat).remove(chat);\n ┊119┊169┊        } else {\n ┊120┊170┊          // Update the chat\n-┊121┊   ┊          chats = chats.map(chat => {\n-┊122┊   ┊            if (chat.id === Number(chatId)) {\n-┊123┊   ┊              chat = {...chat, listingMemberIds, messages};\n-┊124┊   ┊            }\n-┊125┊   ┊            return chat;\n-┊126┊   ┊          });\n+┊   ┊171┊          await connection.getRepository(Chat).save(chat);\n ┊127┊172┊        }\n-┊128┊   ┊        return Number(chatId);\n+┊   ┊173┊        return chatId;\n ┊129┊174┊      } else {\n ┊130┊175┊        // Group\n-┊131┊   ┊        if (chat.ownerId !== currentUser.id) {\n-┊132┊   ┊          throw new Error(`Group ${chatId} is not owned by the user.`);\n-┊133┊   ┊        }\n ┊134┊176┊\n ┊135┊177┊        // Instead of chaining map and filter we can loop once using reduce\n-┊136┊   ┊        const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n-┊137┊   ┊          // Remove the current user from the message holders\n-┊138┊   ┊          message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser.id);\n+┊   ┊178┊        chat.messages = await chat.messages.reduce<Promise<Message[]>>(async (filtered$, message) => {\n+┊   ┊179┊          const filtered = await filtered$;\n+┊   ┊180┊\n+┊   ┊181┊          message.holders = message.holders.filter(user => user.id !== currentUser.id);\n ┊139┊182┊\n-┊140┊   ┊          if (message.holderIds.length !== 0) {\n+┊   ┊183┊          if (message.holders.length !== 0) {\n+┊   ┊184┊            // Remove the current user from the message holders\n+┊   ┊185┊            await connection.getRepository(Message).save(message);\n ┊141┊186┊            filtered.push(message);\n-┊142┊   ┊          } // else discard the message\n+┊   ┊187┊          } else {\n+┊   ┊188┊            // Simply remove the message\n+┊   ┊189┊            const recipients = await connection\n+┊   ┊190┊              .createQueryBuilder(Recipient, \"recipient\")\n+┊   ┊191┊              .innerJoinAndSelect('recipient.message', 'message', 'message.id = :messageId', {messageId: message.id})\n+┊   ┊192┊              .innerJoinAndSelect('recipient.user', 'user')\n+┊   ┊193┊              .getMany();\n+┊   ┊194┊            for (let recipient of recipients) {\n+┊   ┊195┊              await connection.getRepository(Recipient).remove(recipient);\n+┊   ┊196┊            }\n+┊   ┊197┊            await connection.getRepository(Message).remove(message);\n+┊   ┊198┊          }\n ┊143┊199┊\n ┊144┊200┊          return filtered;\n-┊145┊   ┊        }, []);\n+┊   ┊201┊        }, Promise.resolve([]));\n ┊146┊202┊\n ┊147┊203┊        // Remove the current user from who gets the group listed. The group will no longer appear in his list\n-┊148┊   ┊        const listingMemberIds = chat.listingMemberIds.filter(listingId => listingId !== currentUser.id);\n+┊   ┊204┊        chat.listingMembers = chat.listingMembers.filter(user => user.id !== currentUser.id);\n ┊149┊205┊\n ┊150┊206┊        // Check how many members (including previous ones who can still access old messages) are left\n-┊151┊   ┊        if (listingMemberIds.length === 0) {\n+┊   ┊207┊        if (chat.listingMembers.length === 0) {\n ┊152┊208┊          // Remove the group\n-┊153┊   ┊          chats = chats.filter(chat => chat.id !== Number(chatId));\n+┊   ┊209┊          await connection.getRepository(Chat).remove(chat);\n ┊154┊210┊        } else {\n ┊155┊211┊          // Update the group\n ┊156┊212┊\n ┊157┊213┊          // Remove the current user from the chat members. He is no longer a member of the group\n-┊158┊   ┊          const actualGroupMemberIds = chat.actualGroupMemberIds!.filter(memberId => memberId !== currentUser.id);\n+┊   ┊214┊          chat.actualGroupMembers = chat.actualGroupMembers && chat.actualGroupMembers.filter(user => user.id !== currentUser.id);\n ┊159┊215┊          // Remove the current user from the chat admins\n-┊160┊   ┊          const adminIds = chat.adminIds!.filter(memberId => memberId !== currentUser.id);\n-┊161┊   ┊          // Set the owner id to be null. A null owner means the group is read-only\n-┊162┊   ┊          let ownerId: number | null = null;\n-┊163┊   ┊\n-┊164┊   ┊          // Check if there is any admin left\n-┊165┊   ┊          if (adminIds!.length) {\n-┊166┊   ┊            // Pick an admin as the new owner. The group is no longer read-only\n-┊167┊   ┊            ownerId = chat.adminIds![0];\n-┊168┊   ┊          }\n+┊   ┊216┊          chat.admins = chat.admins && chat.admins.filter(user => user.id !== currentUser.id);\n+┊   ┊217┊          // If there are no more admins left the group goes read only\n+┊   ┊218┊          chat.owner = chat.admins && chat.admins[0] || null; // A null owner means the group is read-only\n ┊169┊219┊\n-┊170┊   ┊          chats = chats.map(chat => {\n-┊171┊   ┊            if (chat.id === Number(chatId)) {\n-┊172┊   ┊              chat = {...chat, messages, listingMemberIds, actualGroupMemberIds, adminIds, ownerId};\n-┊173┊   ┊            }\n-┊174┊   ┊            return chat;\n-┊175┊   ┊          });\n+┊   ┊220┊          await connection.getRepository(Chat).save(chat);\n ┊176┊221┊        }\n-┊177┊   ┊        return Number(chatId);\n+┊   ┊222┊        return chatId;\n ┊178┊223┊      }\n ┊179┊224┊    },\n-┊180┊   ┊    addMessage: (obj: any, {chatId, content}: AddMessageMutationArgs, {user: currentUser}: {user: User}): Message => {\n+┊   ┊225┊    addMessage: async (obj: any, {chatId, content}: AddMessageMutationArgs, {user: currentUser, connection}: { user: User, connection: Connection }): Promise<Message | null> => {\n ┊181┊226┊      if (content === null || content === '') {\n ┊182┊227┊        throw new Error(`Cannot add empty or null messages.`);\n ┊183┊228┊      }\n ┊184┊229┊\n-┊185┊   ┊      let chat = chats.find(chat => chat.id === Number(chatId));\n+┊   ┊230┊      let chat = await connection\n+┊   ┊231┊        .createQueryBuilder(Chat, \"chat\")\n+┊   ┊232┊        .whereInIds(chatId)\n+┊   ┊233┊        .innerJoinAndSelect('chat.allTimeMembers', 'allTimeMembers')\n+┊   ┊234┊        .innerJoinAndSelect('chat.listingMembers', 'listingMembers')\n+┊   ┊235┊        .leftJoinAndSelect('chat.actualGroupMembers', 'actualGroupMembers')\n+┊   ┊236┊        .getOne();\n ┊186┊237┊\n ┊187┊238┊      if (!chat) {\n ┊188┊239┊        throw new Error(`Cannot find chat ${chatId}.`);\n ┊189┊240┊      }\n ┊190┊241┊\n-┊191┊   ┊      let holderIds = chat.listingMemberIds;\n+┊   ┊242┊      let holders: User[];\n ┊192┊243┊\n ┊193┊244┊      if (!chat.name) {\n ┊194┊245┊        // Chat\n-┊195┊   ┊        if (!chat.listingMemberIds.find(listingId => listingId === currentUser.id)) {\n+┊   ┊246┊        if (!chat.listingMembers.map(user => user.id).includes(currentUser.id)) {\n ┊196┊247┊          throw new Error(`The chat ${chatId} must be listed for the current user before adding a message.`);\n ┊197┊248┊        }\n ┊198┊249┊\n-┊199┊   ┊        const recipientId = chat.allTimeMemberIds.filter(userId => userId !== currentUser.id)[0];\n+┊   ┊250┊        const recipientUser = chat.allTimeMembers.find(user => user.id !== currentUser.id);\n ┊200┊251┊\n-┊201┊   ┊        if (!chat.listingMemberIds.find(listingId => listingId === recipientId)) {\n-┊202┊   ┊          // Chat is not listed for the recipient. Add him to the listingMemberIds\n-┊203┊   ┊          const listingMemberIds = chat.listingMemberIds.concat(recipientId);\n+┊   ┊252┊        if (!recipientUser) {\n+┊   ┊253┊          throw new Error(`Cannot find recipient user.`);\n+┊   ┊254┊        }\n ┊204┊255┊\n-┊205┊   ┊          chats = chats.map(chat => {\n-┊206┊   ┊            if (chat.id === Number(chatId)) {\n-┊207┊   ┊              chat = {...chat, listingMemberIds};\n-┊208┊   ┊            }\n-┊209┊   ┊            return chat;\n-┊210┊   ┊          });\n+┊   ┊256┊        if (!chat.listingMembers.find(user => user.id === recipientUser.id)) {\n+┊   ┊257┊          // Chat is not listed for the recipient. Add him to the listingIds\n+┊   ┊258┊          chat.listingMembers.push(recipientUser);\n ┊211┊259┊\n-┊212┊   ┊          holderIds = listingMemberIds;\n+┊   ┊260┊          await connection.getRepository(Chat).save(chat);\n ┊213┊261┊\n ┊214┊262┊          pubsub.publish('chatAdded', {\n ┊215┊263┊            creatorId: currentUser.id,\n ┊216┊264┊            chatAdded: chat,\n ┊217┊265┊          });\n ┊218┊266┊        }\n+┊   ┊267┊\n+┊   ┊268┊        holders = chat.listingMembers;\n ┊219┊269┊      } else {\n ┊220┊270┊        // Group\n-┊221┊   ┊        if (!chat.actualGroupMemberIds!.find(memberId => memberId === currentUser.id)) {\n+┊   ┊271┊        if (!chat.actualGroupMembers || !chat.actualGroupMembers.find(user => user.id === currentUser.id)) {\n ┊222┊272┊          throw new Error(`The user is not a member of the group ${chatId}. Cannot add message.`);\n ┊223┊273┊        }\n ┊224┊274┊\n-┊225┊   ┊        holderIds = chat.actualGroupMemberIds!;\n+┊   ┊275┊        holders = chat.actualGroupMembers;\n ┊226┊276┊      }\n ┊227┊277┊\n-┊228┊   ┊      const id = (chat.messages.length && chat.messages[chat.messages.length - 1].id + 1) || 1;\n-┊229┊   ┊\n-┊230┊   ┊      let recipients: Recipient[] = [];\n-┊231┊   ┊\n-┊232┊   ┊      holderIds.forEach(holderId => {\n-┊233┊   ┊        if (holderId !== currentUser.id) {\n-┊234┊   ┊          recipients.push({\n-┊235┊   ┊            userId: holderId,\n-┊236┊   ┊            messageId: id,\n-┊237┊   ┊            chatId: Number(chatId),\n-┊238┊   ┊            receivedAt: null,\n-┊239┊   ┊            readAt: null,\n-┊240┊   ┊          });\n-┊241┊   ┊        }\n-┊242┊   ┊      });\n-┊243┊   ┊\n-┊244┊   ┊      const message: Message = {\n-┊245┊   ┊        id,\n-┊246┊   ┊        chatId: Number(chatId),\n-┊247┊   ┊        senderId: currentUser.id,\n+┊   ┊278┊      const message = await connection.getRepository(Message).save(new Message({\n+┊   ┊279┊        chat: chat,\n+┊   ┊280┊        sender: currentUser,\n ┊248┊281┊        content,\n-┊249┊   ┊        createdAt: moment().unix(),\n ┊250┊282┊        type: MessageType.TEXT,\n-┊251┊   ┊        recipients,\n-┊252┊   ┊        holderIds,\n-┊253┊   ┊      };\n-┊254┊   ┊\n-┊255┊   ┊      chats = chats.map(chat => {\n-┊256┊   ┊        if (chat.id === Number(chatId)) {\n-┊257┊   ┊          chat = {...chat, messages: chat.messages.concat(message)}\n-┊258┊   ┊        }\n-┊259┊   ┊        return chat;\n-┊260┊   ┊      });\n+┊   ┊283┊        holders,\n+┊   ┊284┊        recipients: holders.reduce<Recipient[]>((filtered, user) => {\n+┊   ┊285┊          if (user.id !== currentUser.id) {\n+┊   ┊286┊            filtered.push(new Recipient({\n+┊   ┊287┊              user,\n+┊   ┊288┊            }));\n+┊   ┊289┊          }\n+┊   ┊290┊          return filtered;\n+┊   ┊291┊        }, []),\n+┊   ┊292┊      }));\n ┊261┊293┊\n ┊262┊294┊      pubsub.publish('messageAdded', {\n ┊263┊295┊        messageAdded: message,\n ┊264┊296┊      });\n ┊265┊297┊\n-┊266┊   ┊      return message;\n+┊   ┊298┊      return message || null;\n ┊267┊299┊    },\n-┊268┊   ┊    removeMessages: (obj: any, {chatId, messageIds, all}: RemoveMessagesMutationArgs, {user: currentUser}: {user: User}): number[] => {\n-┊269┊   ┊      const chat = chats.find(chat => chat.id === Number(chatId));\n+┊   ┊300┊    removeMessages: async (obj: any, {chatId, messageIds, all}: RemoveMessagesMutationArgs, {user: currentUser, connection}: { user: User, connection: Connection }) => {\n+┊   ┊301┊      const chat = await connection\n+┊   ┊302┊        .createQueryBuilder(Chat, \"chat\")\n+┊   ┊303┊        .whereInIds(chatId)\n+┊   ┊304┊        .innerJoinAndSelect('chat.listingMembers', 'listingMembers')\n+┊   ┊305┊        .innerJoinAndSelect('chat.messages', 'messages')\n+┊   ┊306┊        .innerJoinAndSelect('messages.holders', 'holders')\n+┊   ┊307┊        .getOne();\n ┊270┊308┊\n ┊271┊309┊      if (!chat) {\n ┊272┊310┊        throw new Error(`Cannot find chat ${chatId}.`);\n ┊273┊311┊      }\n ┊274┊312┊\n-┊275┊   ┊      if (!chat.listingMemberIds.find(listingId => listingId === currentUser.id)) {\n+┊   ┊313┊      if (!chat.listingMembers.find(user => user.id === currentUser.id)) {\n ┊276┊314┊        throw new Error(`The chat/group ${chatId} is not listed for the current user, so there is nothing to delete.`);\n ┊277┊315┊      }\n ┊278┊316┊\n```\n```diff\n@@ -280,79 +318,166 @@\n ┊280┊318┊        throw new Error(`Cannot specify both 'all' and 'messageIds'.`);\n ┊281┊319┊      }\n ┊282┊320┊\n+┊   ┊321┊      if (!all && !(messageIds && messageIds.length)) {\n+┊   ┊322┊        throw new Error(`'all' and 'messageIds' cannot be both null`);\n+┊   ┊323┊      }\n+┊   ┊324┊\n ┊283┊325┊      let deletedIds: number[] = [];\n-┊284┊   ┊      chats = chats.map(chat => {\n-┊285┊   ┊        if (chat.id === Number(chatId)) {\n-┊286┊   ┊          // Instead of chaining map and filter we can loop once using reduce\n-┊287┊   ┊          const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n-┊288┊   ┊            if (all || messageIds!.includes(String(message.id))) {\n-┊289┊   ┊              deletedIds.push(message.id);\n-┊290┊   ┊              // Remove the current user from the message holders\n-┊291┊   ┊              message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser.id);\n-┊292┊   ┊            }\n+┊   ┊326┊      // Instead of chaining map and filter we can loop once using reduce\n+┊   ┊327┊      chat.messages = await chat.messages.reduce<Promise<Message[]>>(async (filtered$, message) => {\n+┊   ┊328┊        const filtered = await filtered$;\n ┊293┊329┊\n-┊294┊   ┊            if (message.holderIds.length !== 0) {\n-┊295┊   ┊              filtered.push(message);\n-┊296┊   ┊            } // else discard the message\n+┊   ┊330┊        if (all || messageIds!.includes(String(message.id))) {\n+┊   ┊331┊          deletedIds.push(message.id);\n+┊   ┊332┊          // Remove the current user from the message holders\n+┊   ┊333┊          message.holders = message.holders.filter(user => user.id !== currentUser.id);\n ┊297┊334┊\n-┊298┊   ┊            return filtered;\n-┊299┊   ┊          }, []);\n-┊300┊   ┊          chat = {...chat, messages};\n ┊301┊335┊        }\n-┊302┊   ┊        return chat;\n-┊303┊   ┊      });\n+┊   ┊336┊\n+┊   ┊337┊        if (message.holders.length !== 0) {\n+┊   ┊338┊          // Remove the current user from the message holders\n+┊   ┊339┊          await connection.getRepository(Message).save(message);\n+┊   ┊340┊          filtered.push(message);\n+┊   ┊341┊        } else {\n+┊   ┊342┊          // Simply remove the message\n+┊   ┊343┊          const recipients = await connection\n+┊   ┊344┊            .createQueryBuilder(Recipient, \"recipient\")\n+┊   ┊345┊            .innerJoinAndSelect('recipient.message', 'message', 'message.id = :messageId', {messageId: message.id})\n+┊   ┊346┊            .innerJoinAndSelect('recipient.user', 'user')\n+┊   ┊347┊            .getMany();\n+┊   ┊348┊          for (let recipient of recipients) {\n+┊   ┊349┊            await connection.getRepository(Recipient).remove(recipient);\n+┊   ┊350┊          }\n+┊   ┊351┊          await connection.getRepository(Message).remove(message);\n+┊   ┊352┊        }\n+┊   ┊353┊\n+┊   ┊354┊        return filtered;\n+┊   ┊355┊      }, Promise.resolve([]));\n+┊   ┊356┊\n+┊   ┊357┊      await connection.getRepository(Chat).save(chat);\n+┊   ┊358┊\n ┊304┊359┊      return deletedIds;\n ┊305┊360┊    },\n ┊306┊361┊  },\n ┊307┊362┊  Subscription: {\n ┊308┊363┊    messageAdded: {\n ┊309┊364┊      subscribe: withFilter(() => pubsub.asyncIterator('messageAdded'),\n-┊310┊   ┊        ({messageAdded}: {messageAdded: Message & {chat: {id: number}}}, {chatId}: MessageAddedSubscriptionArgs, {user: currentUser}: { user: User }) => {\n+┊   ┊365┊        ({messageAdded}: {messageAdded: Message}, {chatId}: MessageAddedSubscriptionArgs, {user: currentUser}: { user: User }) => {\n ┊311┊366┊          return (!chatId || messageAdded.chat.id === Number(chatId)) &&\n-┊312┊   ┊            !!messageAdded.recipients.find((recipient: Recipient) => recipient.userId === currentUser.id);\n+┊   ┊367┊            !!messageAdded.recipients.find((recipient: Recipient) => recipient.user.id === currentUser.id);\n ┊313┊368┊        }),\n ┊314┊369┊    },\n ┊315┊370┊    chatAdded: {\n ┊316┊371┊      subscribe: withFilter(() => pubsub.asyncIterator('chatAdded'),\n-┊317┊   ┊        ({creatorId, chatAdded}: {creatorId: string, chatAdded: Chat}, variables: any, {user: currentUser}: { user: User }) => {\n-┊318┊   ┊          return Number(creatorId) !== currentUser.id && !chatAdded.listingMemberIds.includes(currentUser.id);\n+┊   ┊372┊        ({creatorId, chatAdded}: {creatorId: string, chatAdded: Chat}, variables, {user: currentUser}: { user: User }) => {\n+┊   ┊373┊          return Number(creatorId) !== currentUser.id &&\n+┊   ┊374┊            !!chatAdded.listingMembers.find((user: User) => user.id === currentUser.id);\n ┊319┊375┊        }),\n ┊320┊376┊    }\n ┊321┊377┊  },\n ┊322┊378┊  Chat: {\n-┊323┊   ┊    name: (chat: Chat, args: any, {user: currentUser}: {user: User}): string => chat.name ? chat.name : users\n-┊324┊   ┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser.id))!.name,\n-┊325┊   ┊    picture: (chat: Chat, args: any, {user: currentUser}: {user: User}) => chat.name ? chat.picture : users\n-┊326┊   ┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser.id))!.picture,\n-┊327┊   ┊    allTimeMembers: (chat: Chat): User[] => users.filter(user => chat.allTimeMemberIds.includes(user.id)),\n-┊328┊   ┊    listingMembers: (chat: Chat): User[] => users.filter(user => chat.listingMemberIds.includes(user.id)),\n-┊329┊   ┊    actualGroupMembers: (chat: Chat): User[] => users.filter(user => chat.actualGroupMemberIds && chat.actualGroupMemberIds.includes(user.id)),\n-┊330┊   ┊    admins: (chat: Chat): User[] => users.filter(user => chat.adminIds && chat.adminIds.includes(user.id)),\n-┊331┊   ┊    owner: (chat: Chat): User | null => users.find(user => chat.ownerId === user.id) || null,\n-┊332┊   ┊    messages: (chat: Chat, {amount = 0}: {amount: number}, {user: currentUser}: {user: User}): Message[] => {\n-┊333┊   ┊      const messages = chat.messages\n-┊334┊   ┊      .filter(message => message.holderIds.includes(currentUser.id))\n-┊335┊   ┊      .sort((a, b) => b.createdAt - a.createdAt) || <Message[]>[];\n-┊336┊   ┊      return (amount ? messages.slice(0, amount) : messages).reverse();\n+┊   ┊379┊    name: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<string | null> => {\n+┊   ┊380┊      if (chat.name) {\n+┊   ┊381┊        return chat.name;\n+┊   ┊382┊      }\n+┊   ┊383┊      const user = await connection\n+┊   ┊384┊        .createQueryBuilder(User, \"user\")\n+┊   ┊385┊        .where('user.id != :userId', {userId: currentUser.id})\n+┊   ┊386┊        .innerJoin('user.allTimeMemberChats', 'allTimeMemberChats', 'allTimeMemberChats.id = :chatId', {chatId: chat.id})\n+┊   ┊387┊        .getOne();\n+┊   ┊388┊      return user && user.name || null;\n+┊   ┊389┊    },\n+┊   ┊390┊    picture: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<string | null> => {\n+┊   ┊391┊      if (chat.name) {\n+┊   ┊392┊        return chat.picture;\n+┊   ┊393┊      }\n+┊   ┊394┊      const user = await connection\n+┊   ┊395┊        .createQueryBuilder(User, \"user\")\n+┊   ┊396┊        .where('user.id != :userId', {userId: currentUser.id})\n+┊   ┊397┊        .innerJoin('user.allTimeMemberChats', 'allTimeMemberChats', 'allTimeMemberChats.id = :chatId', {chatId: chat.id})\n+┊   ┊398┊        .getOne();\n+┊   ┊399┊      return user ? user.picture : null;\n+┊   ┊400┊    },\n+┊   ┊401┊    allTimeMembers: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User[]> => {\n+┊   ┊402┊      return await connection\n+┊   ┊403┊        .createQueryBuilder(User, \"user\")\n+┊   ┊404┊        .innerJoin('user.allTimeMemberChats', 'allTimeMemberChats', 'allTimeMemberChats.id = :chatId', {chatId: chat.id})\n+┊   ┊405┊        .getMany();\n+┊   ┊406┊    },\n+┊   ┊407┊    listingMembers: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User[]> => {\n+┊   ┊408┊      return await connection\n+┊   ┊409┊        .createQueryBuilder(User, \"user\")\n+┊   ┊410┊        .innerJoin('user.listingMemberChats', 'listingMemberChats', 'listingMemberChats.id = :chatId', {chatId: chat.id})\n+┊   ┊411┊        .getMany();\n+┊   ┊412┊    },\n+┊   ┊413┊    actualGroupMembers: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User[]> => {\n+┊   ┊414┊      return await connection\n+┊   ┊415┊        .createQueryBuilder(User, \"user\")\n+┊   ┊416┊        .innerJoin('user.actualGroupMemberChats', 'actualGroupMemberChats', 'actualGroupMemberChats.id = :chatId', {chatId: chat.id})\n+┊   ┊417┊        .getMany();\n+┊   ┊418┊    },\n+┊   ┊419┊    admins: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User[]> => {\n+┊   ┊420┊      return await connection\n+┊   ┊421┊        .createQueryBuilder(User, \"user\")\n+┊   ┊422┊        .innerJoin('user.adminChats', 'adminChats', 'adminChats.id = :chatId', {chatId: chat.id})\n+┊   ┊423┊        .getMany();\n ┊337┊424┊    },\n-┊338┊   ┊    unreadMessages: (chat: Chat, args: any, {user: currentUser}: {user: User}): number => chat.messages\n-┊339┊   ┊      .filter(message => message.holderIds.includes(currentUser.id) &&\n-┊340┊   ┊        message.recipients.find(recipient => recipient.userId === currentUser.id && !recipient.readAt))\n-┊341┊   ┊      .length,\n-┊342┊   ┊    isGroup: (chat: Chat): boolean => !!chat.name,\n+┊   ┊425┊    owner: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User | null> => {\n+┊   ┊426┊      return await connection\n+┊   ┊427┊        .createQueryBuilder(User, \"user\")\n+┊   ┊428┊        .innerJoin('user.ownerChats', 'ownerChats', 'ownerChats.id = :chatId', {chatId: chat.id})\n+┊   ┊429┊        .getOne() || null;\n+┊   ┊430┊    },\n+┊   ┊431┊    messages: async (chat: Chat, {amount = 0}: {amount: number}, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<Message[]> => {\n+┊   ┊432┊      const query = connection\n+┊   ┊433┊        .createQueryBuilder(Message, \"message\")\n+┊   ┊434┊        .innerJoin('message.chat', 'chat', 'chat.id = :chatId', {chatId: chat.id})\n+┊   ┊435┊        .innerJoin('message.holders', 'holders', 'holders.id = :userId', {userId: currentUser.id})\n+┊   ┊436┊        .orderBy({\"message.createdAt\": \"DESC\"});\n+┊   ┊437┊      return (amount ? await query.take(amount).getMany() : await query.getMany()).reverse();\n+┊   ┊438┊    },\n+┊   ┊439┊    unreadMessages: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<number> => {\n+┊   ┊440┊      return await connection\n+┊   ┊441┊        .createQueryBuilder(Message, \"message\")\n+┊   ┊442┊        .innerJoin('message.chat', 'chat', 'chat.id = :chatId', {chatId: chat.id})\n+┊   ┊443┊        .innerJoin('message.recipients', 'recipients', 'recipients.user.id = :userId AND recipients.readAt IS NULL', {userId: currentUser.id})\n+┊   ┊444┊        .getCount();\n+┊   ┊445┊    },\n+┊   ┊446┊    isGroup: (chat: Chat) => !!chat.name,\n ┊343┊447┊  },\n ┊344┊448┊  Message: {\n-┊345┊   ┊    chat: (message: Message): Chat | null => chats.find(chat => message.chatId === chat.id) || null,\n-┊346┊   ┊    sender: (message: Message): User | null => users.find(user => user.id === message.senderId) || null,\n-┊347┊   ┊    holders: (message: Message): User[] => users.filter(user => message.holderIds.includes(user.id)),\n-┊348┊   ┊    ownership: (message: Message, args: any, {user: currentUser}: {user: User}): boolean => message.senderId === currentUser.id,\n-┊349┊   ┊  },\n-┊350┊   ┊  Recipient: {\n-┊351┊   ┊    user: (recipient: Recipient): User | null => users.find(user => recipient.userId === user.id) || null,\n-┊352┊   ┊    message: (recipient: Recipient): Message | null => {\n-┊353┊   ┊      const chat = chats.find(chat => recipient.chatId === chat.id);\n-┊354┊   ┊      return chat ? chat.messages.find(message => recipient.messageId === message.id) || null : null;\n+┊   ┊449┊    sender: async (message: Message, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User | null> => {\n+┊   ┊450┊      return (await connection\n+┊   ┊451┊        .createQueryBuilder(User, \"user\")\n+┊   ┊452┊        .innerJoin('user.senderMessages', 'senderMessages', 'senderMessages.id = :messageId', {messageId: message.id})\n+┊   ┊453┊        .getOne()) || null;\n+┊   ┊454┊    },\n+┊   ┊455┊    ownership: async (message: Message, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<boolean> => {\n+┊   ┊456┊      return !!(await connection\n+┊   ┊457┊        .createQueryBuilder(User, \"user\")\n+┊   ┊458┊        .whereInIds(currentUser.id)\n+┊   ┊459┊        .innerJoin('user.senderMessages', 'senderMessages', 'senderMessages.id = :messageId', {messageId: message.id})\n+┊   ┊460┊        .getCount());\n+┊   ┊461┊    },\n+┊   ┊462┊    recipients: async (message: Message, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<Recipient[]> => {\n+┊   ┊463┊      return await connection\n+┊   ┊464┊        .createQueryBuilder(Recipient, \"recipient\")\n+┊   ┊465┊        .innerJoinAndSelect('recipient.message', 'message', 'message.id = :messageId', {messageId: message.id})\n+┊   ┊466┊        .innerJoinAndSelect('recipient.user', 'user')\n+┊   ┊467┊        .innerJoinAndSelect('recipient.chat', 'chat')\n+┊   ┊468┊        .getMany();\n+┊   ┊469┊    },\n+┊   ┊470┊    holders: async (message: Message, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User[]> => {\n+┊   ┊471┊      return await connection\n+┊   ┊472┊        .createQueryBuilder(User, \"user\")\n+┊   ┊473┊        .innerJoin('user.holderMessages', 'holderMessages', 'holderMessages.id = :messageId', {messageId: message.id})\n+┊   ┊474┊        .getMany();\n+┊   ┊475┊    },\n+┊   ┊476┊    chat: async (message: Message, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<Chat | null> => {\n+┊   ┊477┊      return (await connection\n+┊   ┊478┊        .createQueryBuilder(Chat, \"chat\")\n+┊   ┊479┊        .innerJoin('chat.messages', 'messages', 'messages.id = :messageId', {messageId: message.id})\n+┊   ┊480┊        .getOne()) || null;\n ┊355┊481┊    },\n-┊356┊   ┊    chat: (recipient: Recipient): Chat | null => chats.find(chat => recipient.chatId === chat.id) || null,\n ┊357┊482┊  },\n ┊358┊483┊};\n```\n\n[}]: #\n\n`QueryBuilder` is one of the most powerful features of `TypeORM` - it allows you to build SQL queries using elegant and convenient syntax, execute them and get automatically transformed entities.\n\nYou can find more informations on `TypeORM` on http://typeorm.io\n\nThe best part is that you won't have to do anything on the client, everything will be completely transparent to it, even if migrated from NoSQL-like db structure to a relational one!\nOf course, you could remove the custom normalization for the messages because now they have their own table and they are no longer embedded (so they have unique IDs), but we could leave it as well in order to be free to use any kind of backend."
          }
        ]
      },
      {
        "releaseVersion": "0.1.0",
        "releaseDate": "2018-05-29 01:26:37 +0800",
        "tagName": "master@0.1.0",
        "tagRevision": "dc3b0485a1410fd0e000edded1014b2ab463e5c1",
        "historyRevision": "b064427f8611b3a87d2be9523e107fa5e59c62cb",
        "changesDiff": "diff --git a/.gitignore b/.gitignore\nnew file mode 100644\nindex 0000000..05ade97\n--- /dev/null\n+++ b/.gitignore\n@@ -0,0 +1,3 @@\n+node_modules\n+npm-debug.log\n+.idea\ndiff --git a/.tortilla/assets/chat.png b/.tortilla/assets/chat.png\nnew file mode 100644\nindex 0000000..6bf670a\nBinary files /dev/null and b/.tortilla/assets/chat.png differ\ndiff --git a/.tortilla/assets/chat_components.png b/.tortilla/assets/chat_components.png\nnew file mode 100644\nindex 0000000..8330cd0\nBinary files /dev/null and b/.tortilla/assets/chat_components.png differ\ndiff --git a/.tortilla/assets/chats.png b/.tortilla/assets/chats.png\nnew file mode 100644\nindex 0000000..979021d\nBinary files /dev/null and b/.tortilla/assets/chats.png differ\ndiff --git a/.tortilla/assets/chats_components.png b/.tortilla/assets/chats_components.png\nnew file mode 100644\nindex 0000000..35c712e\nBinary files /dev/null and b/.tortilla/assets/chats_components.png differ\ndiff --git a/.tortilla/assets/new_chat.png b/.tortilla/assets/new_chat.png\nnew file mode 100644\nindex 0000000..77bccab\nBinary files /dev/null and b/.tortilla/assets/new_chat.png differ\ndiff --git a/.tortilla/assets/new_chat_components.png b/.tortilla/assets/new_chat_components.png\nnew file mode 100644\nindex 0000000..4cfab73\nBinary files /dev/null and b/.tortilla/assets/new_chat_components.png differ\ndiff --git a/.tortilla/assets/new_group.png b/.tortilla/assets/new_group.png\nnew file mode 100644\nindex 0000000..a887fc3\nBinary files /dev/null and b/.tortilla/assets/new_group.png differ\ndiff --git a/.tortilla/assets/new_group_components.png b/.tortilla/assets/new_group_components.png\nnew file mode 100644\nindex 0000000..5418757\nBinary files /dev/null and b/.tortilla/assets/new_group_components.png differ\ndiff --git a/.tortilla/assets/new_group_details.png b/.tortilla/assets/new_group_details.png\nnew file mode 100644\nindex 0000000..71b6f31\nBinary files /dev/null and b/.tortilla/assets/new_group_details.png differ\ndiff --git a/.tortilla/assets/new_group_details_components.png b/.tortilla/assets/new_group_details_components.png\nnew file mode 100644\nindex 0000000..7540778\nBinary files /dev/null and b/.tortilla/assets/new_group_details_components.png differ\ndiff --git a/.tortilla/manuals/templates/root.tmpl b/.tortilla/manuals/templates/root.tmpl\nnew file mode 100644\nindex 0000000..37c481e\n--- /dev/null\n+++ b/.tortilla/manuals/templates/root.tmpl\n@@ -0,0 +1 @@\n+A newly created Tortilla project. For more information, see https://github.com/Urigo/tortilla.\n\\ No newline at end of file\ndiff --git a/.tortilla/manuals/templates/step1.tmpl b/.tortilla/manuals/templates/step1.tmpl\nnew file mode 100644\nindex 0000000..b26ae49\n--- /dev/null\n+++ b/.tortilla/manuals/templates/step1.tmpl\n@@ -0,0 +1,51 @@\n+# Step 1: How to build an app?\n+\n+So you want to build an app!\n+The good news is, it’s not that difficult and after a while anyone can do it!\n+Another good news is that it’s a great skill to have, there is a lot of demand in the job market and you can get to be very creative. Also you can be part of basically any industry you can think of if you know how to program (Healthcare,\n+banking, education, defense, gaming, etc…).\n+\n+Software builds as layers on top of layers.  Every code you write is using code that others have written before already and you can just use it even without fully understanding it.\n+That’s what makes software advance so fast and makes the pace of progress increase as time goes by.\n+Also, most software today is written in an open and free way - everyone can share their code and use other people's code for free.  We even have a social network for that!  It’s called Github.\n+\n+One way of learning how to build an app is to study software from the origins. How computers, operating systems and compilers work. It is very interesting but that also takes a long time.\n+Another way to learn how to create a new app is to start by first using all the code that has been already written out there and once we have a real world running app, go deeper to understand how it works from the inside.\n+\n+I’ll try to use the later approach because I think it is more fun and also it gives context when we will dive inside on how things work. Also it helps when we try to compare between different technologies that do the same thing (Angular vs.\n+React , etc…).\n+That’s because understanding the bigger picture is more important than knowing and remembering the details.\n+\n+You noticed that the chapter started with a simple question.\n+All the lessons will start and include many of those questions.  Those are the questions you will need to Google.  The reason is that the most important skill a creator has today is to know how to search Google for the things they need. Most\n+programmers, even the best ones, don’t remember anything, they just use Google for almost every line of code they write. So know that you don’t need to know it all, Google knows it all for you.\n+This tutorial might get outdated (it won't, hopefully!), but Google will always have the answers so it is more important to know to ask the right questions.\n+In my opinion the most important skill a programmer needs to have is patience and acceptance when something just doesn’t work, enjoy that feeling and start Googling around in order to learn new things and solve this new problem (this process of\n+feeling like you don’t know anything will happen 1000 times a day, also after 20 years of programming).\n+\n+## Planning the app: how to design an app?\n+\n+The first and most important phase in the process is the beginning - designing the app, its parts, components and architecture, and how it all works together.\n+For this tutorial we will build a WhatsApp clone so we have the designs already prepared.\n+\n+The process will looks like that:\n+\n+1. **Visually sketch the screens of the app**. We already know how WhatsApp looks so we’ll just copy it on pen and paper.\n+2. **Break down to components**. The best way to describe the UI of apps is to break the UI into separate components and mix them up together. When breaking down to components we would need to think about the following steps:\n+  * **Presentational components**: the small building blocks of the UI. For example input fields, images, text, buttons etc…\n+  * **Layout**: how the components are positioned inside each other (talk about flex, grid and older layout types)\n+  * **Styles**: colors, fonts etc… We might skip that part at the beginning because we can have a perfectly working app without it\n+  * **Data dependencies**: the data that those components need - chats, messages, people etc… We will need to to do the following:\n+    * Gather data for each component\n+    * Attach all those dependencies into one schema\n+    * Attach actions for each component\n+    * Data updates: decide when the data should be updated in the view (ideally we shouldn’t have to say when but for technical and performance reasons it helps)\n+3. **Routing flow**: Moving between screens, what are the different paths the user can navigate through our app\n+\n+Once we will finish that process, you will have a big picture in your head (and on your paper) and implementing it with code will be much easier and more technical, meaning you won’t need to know a lot, just Google how to do each step...\n+\n+Another interesting thing is, that implementing this same process can be done with a variety of different technologies, so this work will make sense whether you are using web with React or Angular, native apps, Windows UWP or any other\n+technology for the UI and also relevant whether your data source is a Node, .NET or Ruby server with Mongo, Postgres or MySQL database (if all those words doesn’t mean anything for you, don’t worry, those are just different names to very similar\n+ideas and we will learn all of them later on and of course you can always just Google them).\n+\n+Head over to the next chapter to start planning.\ndiff --git a/.tortilla/manuals/templates/step10.tmpl b/.tortilla/manuals/templates/step10.tmpl\nnew file mode 100644\nindex 0000000..e87fd4d\n--- /dev/null\n+++ b/.tortilla/manuals/templates/step10.tmpl\n@@ -0,0 +1,13 @@\n+## Client\n+\n+Did you notice that after creating a new message you'll have to refresh the page in order to see it?\n+How to fix that? If you thought about re-querying the server you would be wrong! The best solution is to use the response provided by the server to update our Apollo local cache.\n+\n+Apollo performs two important core tasks: Executing queries and mutations, and caching the results.\n+\n+Thanks to Apollo’s store design, it’s possible for the results of a query or mutation to update your UI in all the right places. In many cases it’s possible for that to happen automatically, whereas in others you need to help the client out a little in doing so:\n+\n+{{{ diffStep \"6.1\" module=\"client\" }}}\n+\n+Now you won't need to reload the page in order to see the new message. What's even more interesting is that the message you wrote would also be shown as the last message in the chats list, just hit the back button in the top-left corner to find out!\n+This is because we updated our store for both the `GetChat` and the `GetChats` query.\n\\ No newline at end of file\ndiff --git a/.tortilla/manuals/templates/step11.tmpl b/.tortilla/manuals/templates/step11.tmpl\nnew file mode 100644\nindex 0000000..fd33d28\n--- /dev/null\n+++ b/.tortilla/manuals/templates/step11.tmpl\n@@ -0,0 +1,30 @@\n+## Client\n+\n+Since we're now familiar with the way mutations work, it's time to add messages and chats removal to our list of features!\n+Since the most annoying part is going to be dealing with the user interface (because a multiple selection started by a press event is involved), I created an Angular directive to ease the process.\n+Let's start by installing it:\n+\n+    $ npm install ngx-selectable-list\n+\n+Now let's import it:\n+\n+{{{ diffStep \"7.1\" module=\"client\" files=\"^(?!package.json$).*\" }}}\n+\n+Let's create the mutations:\n+\n+{{{ diffStep \"7.2\" module=\"client\" files=\"src/graphql\" }}}\n+\n+Now let's update our service:\n+\n+{{{ diffStep \"7.2\" module=\"client\" files=\"chats.service.ts\" }}}\n+\n+As you can see every time that we remove a message we also have to update the last message in the chats list.\n+\n+Finally we can wire everything up into our components:\n+\n+{{{ diffStep \"7.2\" module=\"client\" files=\"src/app/chat-viewer, src/app/chats-lister, src/app/shared\" }}}\n+\n+We also created a `ConfirmSelectionComponent` to use for content projection, since our selectable list directive will be able to listen to its events.\n+The selectable list directive supports much more different use cases, for info please read the documentation.\n+\n+As you can see `ngx-selectable-list` takes care of most of the boilerplate, giving us the freedom to concentrate on the actual code.\n\\ No newline at end of file\ndiff --git a/.tortilla/manuals/templates/step12.tmpl b/.tortilla/manuals/templates/step12.tmpl\nnew file mode 100644\nindex 0000000..896a39e\n--- /dev/null\n+++ b/.tortilla/manuals/templates/step12.tmpl\n@@ -0,0 +1,17 @@\n+We still cannot create new chats or groups, so let's implement it.\n+We're going to create a `ChatsCreation` module, with a `NewChat` and a `NewGroup` containers, along with several presentational components.\n+We're going to make use of the selectable list directive once again, to ease selecting the users when we're creating a new group.\n+You should also notice that we are looking for existing chats before creating a new one: if it already exists we're are simply redirecting to that chat instead of creating a new one (the server wouldn't allow that anyway and it will simply\n+return the chat id).\n+\n+{{{ diffStep \"8.1\" module=\"client\" files=\"src/graphql\" }}}\n+\n+After creating the mutations we should run the generator to create the corresponding types:\n+\n+    npm run generator\n+\n+{{{ diffStep \"8.1\" module=\"client\" files=\"src/app/app.module.ts, src/app/chats-creation, src/app/services\" }}}\n+\n+Finally we should update our tests:\n+\n+{{{ diffStep \"8.1\" module=\"client\" files=\"src/app/chat-viewer/containers/chat/chat.component.spec.ts\" }}}\ndiff --git a/.tortilla/manuals/templates/step13.tmpl b/.tortilla/manuals/templates/step13.tmpl\nnew file mode 100644\nindex 0000000..5708027\n--- /dev/null\n+++ b/.tortilla/manuals/templates/step13.tmpl\n@@ -0,0 +1,29 @@\n+## Client\n+\n+Now let's start our client in production mode:\n+\n+    $ ng serve --prod\n+\n+Now open the Chrome Developers Tools and, in the Network tab, select 'Slow 3G Network' and 'Disable cache'.\n+Now refresh the page and look at the DOMContentLoaded time and at the transferred size. You'll notice that our bundle size is quite small and so the loads time.\n+Now let's click on a specific chat. It will take some time to load the data. Now let's add a new message. Once again it will take some time to load the data. We could also create a new chat and the result would be the same. The whole app doesn't\n+feel as snappier as the real Whatsapp on a slow 3G Network.\n+\"That's normal, it's a web application with a remote db while Whatsapp is a native app with a local database...\"\n+That's just an excuse, because we can do as good as Whatsapp thanks to Apollo!\n+\n+Let's install `moment`, we will soon need it:\n+\n+    $ npm install moment\n+\n+Let's start by making our UI optimistic. We can predict most of the response we will get from our server, except for a few things like `id` of newly created messages. But since we don't really need that id, we can simply generate a fake one\n+which will be later overridden once we get the response from the server:\n+\n+{{{ diffStep \"9.1\" module=\"client\" files=\"^(?!package.json$).*\" }}}\n+\n+When we open a specific chat we can also preload some data from our chats list cache while waiting for the server response. We will initially be able to show only the chat name, the last message or the last few messages and a few more informations instead of the whole content from the server, but that would be more than enough to entertain the user while waiting for the server response:\n+\n+{{{ diffStep \"9.2\" module=\"client\" }}}\n+\n+Now let's deal with the most difficult part: what about chats creation? We cannot predict the `id` of the new chat and so we cannot navigate to the chat page because it contains the chat id in the url. We could simply navigate to the \"optimistic\" id, but then the user wouldn't be able to reach that url if he refreshes the page or bookmarks it. That's a problem we care about. How to solve it? We're going to create a landing page and we will later override the url once we get the response from the server!\n+\n+{{{ diffStep \"9.3\" module=\"client\" }}}\n\\ No newline at end of file\ndiff --git a/.tortilla/manuals/templates/step14.tmpl b/.tortilla/manuals/templates/step14.tmpl\nnew file mode 100644\nindex 0000000..79efac8\n--- /dev/null\n+++ b/.tortilla/manuals/templates/step14.tmpl\n@@ -0,0 +1,61 @@\n+## Server\n+\n+Authentication is an hot topic in the GraphQL world and there are some projects which aim at authenticating through GraphQL.\n+Since often you will be required to use a specific auth framework (because of a feature you need or because of an existing authorization infrastructure) I will show you how to use a classic REST API framework within your GraphQL application.\n+This approach is completely fine and in line with the official GraphQL best practices.\n+We will use `Passport` for the authentication and `BasicAuth` as the auth mechanism:\n+\n+    npm install bcrypt-nodejs passport passport-http\n+    npm install --save-dev @types/bcrypt-nodejs @types/passport @types/passport-http\n+\n+`BasicAuth` basically involves to send username e password in an Authorization Header together with each request and is fully supported by any browser (meaning that we will be able to use `Graphiql` simply by proving username and password in the login window provided by the browser itself).\n+It's the most simple auth mechanism but it's completely fine for our needs. Later we could decide to use something more complicated like `JWT`, but it's outside of the scope of this tutorial.\n+\n+{{{ diffStep \"4.1\" module=\"server\" files=\"index.ts\" }}}\n+\n+We are going to store hashes instead of plain passwords, that's why we're using `bcrypt-nodejs`.\n+With `passport.use('basic-signin')` and `passport.use('basic-signup')` we define how the auth framework deals with our database (well, our JSON file for the moment).\n+`app.post('/signup')` is the endpoint for creating new accounts, so we left it out of the authentication middleware (`app.use(passport.authenticate('basic-signin')`).\n+What's of particular interest is that we're passing the user object to the GraphQL context.\n+\n+{{{ diffStep \"4.1\" module=\"server\" files=\"schema/resolvers.ts\" }}}\n+\n+In the resolvers we're basically making use of the user object taken from the context.\n+\n+## Client\n+\n+Let's start installing `@angular/flex-layout`, because we will use it later:\n+\n+    $ npm install @angular/flex-layout\n+\n+First of all we need to create an HTTP Interceptor, which will intercept every HTTP request and will add authentication headers.\n+For the moment we still don't have those headers, but we are going to store them in the LocalStorage later.\n+We are also creating an AuthGuard, which we will use to stop the user from reaching unauthorized Routes.\n+The AuthGuard will simply look for the presence of the Authentication Header, but will not guarantee that the header is authentic.\n+This is no problem, because client side AuthGuards are not safe by design and the real authentication will be done server side anyway.\n+AuthGuards are here just to redirect the user to the Login page.\n+The service we are going to create will contain some auth methods we are going to use across the app.\n+\n+{{{ diffStep \"10.1\" module=\"client\" files=\"src/app/login/services\" }}}\n+\n+Now it's time to create a SignIn/SignUp component. Since we use Passport in the server we are going to make REST calls for the authentication, instead of using GraphQL.\n+Since we use Basic Auth we will simply combine the username and the password together to create the authentication header.\n+We will also store the response from the server, which will contain the user information like the ID, etc. which we are going to need later.\n+\n+{{{ diffStep \"10.1\" module=\"client\" files=\"src/app/login/containers, src/app/login/login.module.ts\" }}}\n+\n+Now it's time use the Interceptor we just created:\n+\n+{{{ diffStep \"10.1\" module=\"client\" files=\"src/app/app.module.ts\" }}}\n+\n+As well as the AuthGuard:\n+\n+{{{ diffStep \"10.1\" module=\"client\" files=\"src/app/chat-viewer/chat-viewer.module.ts, src/app/chats-creation/chats-creation.module.ts, src/app/chats-lister/chats-lister.module.ts\" }}}\n+\n+Last but not the least we need to fix our main service in order to not use the hardcoded user anymore. Instead we will use our Login service to read the user info from the LocalStorage.\n+\n+{{{ diffStep \"10.1\" module=\"client\" files=\"src/app/services/chats.service.ts\" }}}\n+\n+We also need to fix our tests:\n+\n+{{{ diffStep \"10.1\" module=\"client\" files=\"src/app/chat-viewer/containers/chat/chat.component.spec.ts, src/app/chats-lister/containers/chats/chats.component.spec.ts, src/app/services/chats.service.spec.ts\" }}}\n\\ No newline at end of file\ndiff --git a/.tortilla/manuals/templates/step15.tmpl b/.tortilla/manuals/templates/step15.tmpl\nnew file mode 100644\nindex 0000000..80b910a\n--- /dev/null\n+++ b/.tortilla/manuals/templates/step15.tmpl\n@@ -0,0 +1,64 @@\n+## Server\n+\n+In order to use WebSockets we will need to install a couple of packages:\n+\n+    npm install graphql-subscriptions subscriptions-transport-ws\n+\n+Our GraphQL server will use WebSockets only for subscriptions, while using HTTP for everything else. That means that we will have to add subscriptions on a specific path.\n+We're using `connectionParams` for the authentication over WebSockets, that means that we won't be using the `Passport` framework at all. Instead we will use the `onConnect` hook to manually validate the parameters provided by the user to either validate the WebSocket connection or throw an error.\n+We will also return the user object we retrieved from the db, to let the resolvers know who is the current user.\n+\n+{{{ diffStep \"5.1\" module=\"server\" files=\"index.ts\" }}}\n+\n+We will use the `PubSub` implementation from `graphql-subscriptions`, and we will connect it to `subscribe` executor of `graphql`, and publish the data using `subscriptions-transport-ws` (a WebSocket server and client library for GraphQL that can be used directly in a JavaScript app or wired up to a fully-featured GraphQL client like Apollo).\n+\n+The process of setting up a GraphQL subscriptions server consist of the following steps:\n+\n+1. Declaring subscriptions in the GraphQL schema\n+2. Setup a PubSub instance that our server will publish new events to\n+3. Hook together `PubSub` event and GraphQL subscription.\n+4. Setting up `SubscriptionsServer`, a transport between the server and the clients\n+\n+{{{ diffStep \"5.1\" module=\"server\" files=\"schema/typeDefs.ts\" }}}\n+\n+We created two subscriptions: one to notify for new chats and one to notify for new messages.\n+\n+{{{ diffStep \"5.1\" module=\"server\" files=\"schema/resolvers.ts\" }}}\n+\n+We will publish a message to the `messageAdded` subscription every time that a user sends a message, then we will filter them according to the current user (we don't want to send someone else's messages).\n+The `chatAdded` subscription is similar: we will publish each time that a group gets created, but not when chats get created. This is because when a user creates a chat the chat doesn't appear to the other peer until he writes the first message. That's why we also publish when new messages get added (we first look if the other peer already gets the chat listed).\n+\n+## Client\n+\n+In order to use WebSockets we will need to install a couple of dependencies:\n+\n+    $ npm install apollo-link-ws apollo-utilities subscriptions-transport-ws\n+\n+First let's create the queries for the GraphQL Subscriptions:\n+\n+{{{ diffStep \"11.1\" module=\"client\" files=\"src/graphql\" }}}\n+\n+Then we need to run `graphql-code-generator` to generate the types:\n+\n+    $ npm run generator\n+\n+Now we can update the chats service to update the getChats query every time that we receive a new chat from the subscription.\n+With GraphQL subscriptions your client will be alerted on push from the server and you should choose the pattern that fits your application the most:\n+\n+- Use it as a notification and run any logic you want when it fires, for example alerting the user or refetching data\n+- Use the data sent along with the notification and merge it directly into the store (existing queries are automatically notified)\n+\n+With subscribeToMore, you can easily do the latter. We will manipulate the store to add the newly created chat.\n+\n+We will do to do the same for the newMessage subscription, but this time we will have to update two different queries in the store: getChats and getChat.\n+\n+{{{ diffStep \"11.1\" module=\"client\" files=\"src/app/services/chats.service.ts\" }}}\n+\n+We can finally configure the WebSocket in the app module. Please notice that the WebSocket has its own authentication instead of using the HttpInterceptor, in fact we use `connectionParams` to send the authorization.\n+All queries will go through HTTP except the Subscriptions, which will use the WebSocket.\n+\n+{{{ diffStep \"11.1\" module=\"client\" files=\"src/app/app.module.ts\" }}}\n+\n+Finally, let's fix the tests:\n+\n+{{{ diffStep \"11.1\" module=\"client\" files=\"src/app/chat-viewer/containers/chat/chat.component.spec.ts, src/app/chats-lister/containers/chats/chats.component.spec.ts, src/app/services/chats.service.spec.ts\" }}}\ndiff --git a/.tortilla/manuals/templates/step16.tmpl b/.tortilla/manuals/templates/step16.tmpl\nnew file mode 100644\nindex 0000000..f7c3935\n--- /dev/null\n+++ b/.tortilla/manuals/templates/step16.tmpl\n@@ -0,0 +1,49 @@\n+## Server\n+\n+First of all you will have to install PostgreSQL on your operating system. Since there so many options (different Linux distributions, MacOS X, Windows...) I will assume that you already know how to install a software in your OS and take that part for granted.\n+\n+Then you will have to install a couple of packages:\n+\n+    npm install pg reflect-metadata typeorm\n+    npm install --save-dev @types/pg\n+\n+We aren't going to use plain SQL, instead we will use an Object-relational mapping framework (ORM) called `TypeORM`.\n+`TypeORM` takes advantage of Typescript classes and type declarations in order to infer the db structure.\n+\n+We will need to enable support for experimental decorators, emit type metadata for decorators and disable strict property initialization:\n+\n+{{{ diffStep \"6.1\" module=\"server\" files=\"tsconfig.json\" }}}\n+\n+The next step is to create Entities. An Entity is a class that maps to a database table. You can create a entity by defining a new class and mark it with @Entity():\n+\n+{{{ diffStep \"6.1\" module=\"server\" files=\"entity\" }}}\n+\n+Basic entities consist of columns and relations. Each entity MUST have a primary column.\n+\n+Each entity must be registered in your connection options:\n+\n+{{{ diffStep \"6.1\" module=\"server\" files=\"ormconfig.json\" }}}\n+\n+Since database table consist of columns your entities must consist of columns too. Each entity class property you marked with @Column will be mapped to a database table column.\n+Each entity must have at least one primary column. There are several types of primary columns, but in our case `@PrimaryGeneratedColumn()` creates a primary column which value will be automatically generated with an auto-increment value.\n+`@CreateDateColumn` is a special column that is automatically set to the entity's insertion date. You don't need set this column - it will be automatically set.\n+For the Recipient Entity we use a composite primary key that consists of two foreign keys.\n+\n+The next thing to do is to create a connection with the database before firing up the web server:\n+\n+{{{ diffStep \"6.1\" module=\"server\" files=\"index.ts\" }}}\n+\n+We will also remove our fake db and replace it with some real data:\n+\n+{{{ diffStep \"6.1\" module=\"server\" files=\"db.ts\" }}}\n+\n+It's time to deal with resolvers:\n+\n+{{{ diffStep \"6.1\" module=\"server\" files=\"schema/resolvers.ts\" }}}\n+\n+`QueryBuilder` is one of the most powerful features of `TypeORM` - it allows you to build SQL queries using elegant and convenient syntax, execute them and get automatically transformed entities.\n+\n+You can find more informations on `TypeORM` on http://typeorm.io\n+\n+The best part is that you won't have to do anything on the client, everything will be completely transparent to it, even if migrated from NoSQL-like db structure to a relational one!\n+Of course, you could remove the custom normalization for the messages because now they have their own table and they are no longer embedded (so they have unique IDs), but we could leave it as well in order to be free to use any kind of backend.\n\\ No newline at end of file\ndiff --git a/.tortilla/manuals/templates/step2.tmpl b/.tortilla/manuals/templates/step2.tmpl\nnew file mode 100644\nindex 0000000..cc6e4b0\n--- /dev/null\n+++ b/.tortilla/manuals/templates/step2.tmpl\n@@ -0,0 +1,185 @@\n+## Visual sketch\n+Well, not a lot to say about that: just draw your app on paper.\n+Doesn’t matter if you don’t know how to draw, it’s just squares and circles.\n+\n+![alt text](../../assets/chats.png \"Chats\")\n+![alt text](../../assets/chat.png \"Chat\")\n+![alt text](../../assets/new_chat.png \"New chat\")\n+![alt text](../../assets/new_group.png \"New group\")\n+![alt text](../../assets/new_group_details.png \"New group details\")\n+\n+## Breaking down to components\n+### -> Google Search\n+This part is a bit more tricky, but after a few examples you’ll get the hang of it.\n+\n+Draw boxes around every component and subcomponent in different colors and name each one.\n+But how do you know what should be its own component?\n+Just follow the **single responsibility principle**, that is, a component should ideally only do one thing. If it ends up growing, it should be decomposed into smaller subcomponents.\n+\n+![alt text](../../assets/chats_components.png \"Chats components\")\n+![alt text](../../assets/chat_components.png \"Chat components\")\n+![alt text](../../assets/new_chat_components.png \"New chat components\")\n+![alt text](../../assets/new_group_components.png \"New group components\")\n+![alt text](../../assets/new_group_details_components.png \"New group details components\")\n+\n+  * Chats Component\n+  * Header Component\n+  * ChatsList Component\n+  * ChatItem Component\n+  * Chat Component\n+  * MessagesList Component\n+  * MessageItem Component\n+  * NewMessage Component\n+  * NewChat Component\n+  * UsersList Component\n+  * UserItem Component\n+  * NewGroup Component\n+  * NewGroupDetails Component\n+\n+Now let’s organize them in hierarchy:\n+* Chats\n+  * Header\n+  * ChatsList\n+    * ChatItem\n+* Chat\n+  * Header\n+  * MessagesList\n+    * MessageItem\n+  * NewMessage\n+* NewChat\n+  * Header\n+  * UsersList\n+    * UserItem\n+* NewGroup\n+  * Header\n+  * UsersList\n+    * UserItem\n+  * NewGroupDetails\n+\n+## Layout\n+### -> Google Search\n+Now let’s describe how the components are placed within each other.\n+There are infinite ways to explain how components sits inside of each other.\n+Any approach has its benefits and limitations.\n+We are going to use one pattern that is pretty common, simple and also covers many types of UI structures.\n+Using that pattern we will keep us covered for a long while (until you would want to create a computer game or a graph. then you’ll need to expand your horizons).\n+This pattern is called flexbox.\n+\n+In Flexbox we can separate the alignment in two ways:\n+Container (parent) component behaviour\n+Child component behaviour inside the container\n+\n+When describing the parent, we have 3 main properties:\n+* Flex-Flow: it's a shorthand for flex-direction and flex-wrap and lets you control the direction in which the items are displayed and whether or not they can wrap onto the next line. There are four possible settings, each of them in the wrap or\n+nowrap variant:\n+  * row `[wrap, nowrap]`\n+  * row-reverse `[wrap, nowrap]`\n+  * column `[wrap, nowrap]` - this is the normal way a group of divs would be displayed, so you might not use this often\n+  * column-reverse `[wrap, nowrap]`\n+* Justify-content: determines where a browser should place the flex items within the row. It works only if the flex items have set widths and if the total width of the items is less than the flex container. There are five possible settings:\n+  * Flex-start - squash them to the left\n+  * Center - Squash them to the center\n+  * Flex-end - squash them to the right\n+  * Space-around - squash them away from each other and the ends. Place as much space as possible between all elements\n+  * Space-between - Squash the sides to the ends and place as much space between the rest of the elements as possible\n+* alignItems: Same as justifyContent but on the secondary axis\n+  * Flex-start - squash them to the left\n+  * Center - Squash them to the center\n+  * Flex-end - squash them to the right\n+  * Space-around - squash them away from each other and the ends. Place as much space as possible between all elements\n+  * Space-between - Squash the sides to the ends and place as much space between the rest of the elements as possible\n+\n+The easiest way to explain that is by showing live examples:\n+[awaiting for McFarland's permission to share his pictures]\n+\n+## Data dependencies\n+### -> Google Search\n+Our app needs to display data. Otherwise it will be just a nice moving set of pictures…\n+So let’s see what data each component needs and create a descriptions of all the data in our app.\n+\n+Let’s start with the chats list component:\n+\n+* Chats: Chats, Users, Messages\n+  * Header\n+  * ChatsList: Chats, Users, Messages\n+    * ChatItem: Chats`[chatId]`, Users`[UserId]`, Message`[messageId]`\n+\n+We need to have some basic information about the chats we are part of, like the chat id, the user id and the latest message content.\n+That means we will have to query for all the chats who we are part of, then look at the user IDs and query for those users to retrieve the name. Finally we need to query for the last message of each chat.\n+\n+Now let’s talk about the chat component (after clicking the single chat app).\n+We need a list of all the messages inside the chat, along with some info about the user or chat on the top corner:\n+\n+* Chat: Chat, User, Messages\n+  * Header: User.name || Chat.name (Because we can have multiple participant could differ from the other person’s name)\n+  * MessagesList: Messages\n+    * MessageItem: Messages`[ID]`\n+  * NewMessage\n+\n+The NewChat and NewGroup components will need just some basic info about the user:\n+\n+* NewChat: Users\n+  * Header\n+  * UsersList: Users\n+    * UserItem: Users`[ID]`\n+\n+* NewGroup: Users\n+  * Header\n+  * UsersList: Users\n+    * UserItem: Users`[ID]`\n+  * NewGroupDetails\n+\n+## Actions\n+### -> Google Search\n+But components can also do thing beyond just displaying data.\n+Let’s write all the actions each component can do.\n+  * Chats list\n+    * tap -> go to chat page\n+    * press -> enable selection of multiple chats, confirming the selection will delete them\n+  * Single Chat\n+    * tap -> send the message\n+    * press -> enable selection of multiple messages, confirming the selection will delete them\n+  * New Chat\n+    * tap -> create new chat or go to the NewGroup component\n+  * New Group\n+    * tap -> go to NewGroupDetails, then create the group\n+\n+## Communications\n+### -> Google Search\n+Let’s define when do we need to get the data from our data source.\n+Sounds easy but there are a few tricky pitfalls. (query and subscriptions).\n+We will start by simply requesting the data when we first start the component, later on we will tackle subscriptions.\n+\n+## UI flow\n+### -> Google Search\n+Let’s draw a diagram of how the user can navigate our app.\n+  * Open the app ->\n+    * Chats list ->\n+      * Click on chat ->\n+        * Specific chat page\n+          * Click back ->\n+            * Chat page\n+    * Click on '+' ->\n+      * NewChat page ->\n+        * Click on user ->\n+          * Chat page\n+        * Click back ->\n+          * Chats list\n+        * Click on 'New Group' ->\n+          * New Group page\n+            * Multiple selection and subsequent confirmation ->\n+              * NewGroupDetails page\n+                * Insert name and click on confirm ->\n+                  * Chat page\n+              * Click back ->\n+                * New Group page\n+          * Click back ->\n+            * New Group page\n+\n+Now let’s look at the whole diagram we created.\n+That basically describes all of our app.\n+If computers were smart enough to understand english and drawings, we would have an app by now.\n+But programming languages are very similar to regular languages so we now just need to translate this into any programming language, just choose a tool and start filling in the gaps.\n+\n+Next chapter will be about Scaffolding which will tell us the structure to put our code into.\n+Just like our sketch has defined parts, we would do the same just with folders and files.\ndiff --git a/.tortilla/manuals/templates/step3.tmpl b/.tortilla/manuals/templates/step3.tmpl\nnew file mode 100644\nindex 0000000..eb29a4a\n--- /dev/null\n+++ b/.tortilla/manuals/templates/step3.tmpl\n@@ -0,0 +1,27 @@\n+Now we can start writing code!\n+\n+But like we said before, software is build in layers and instead of starting from nothing, we can use existing software with prepared structure.\n+\n+First let’s install some software that we need on our computer:\n+\n+The following instructions are for computers with the Arch Linux operating system, so your mileage may vary.\n+\n+First let's start by installing npm and node.js, as simple as `# pacman -S nodejs npm`.\n+\n+Then we will need a way to install our npm global packages on a per-user basis, instead of relying on sudo: https://github.com/sindresorhus/guides/blob/master/npm-global-without-sudo.md\n+\n+Now it's the right moment to install a couple of global packages we will need later on: `npm install -g @angular/cli node-sass tortilla typescript`\n+\n+## IDE\n+\n+Now it's time to choose our IDE. I suggest you Webstorm, but it's paid software with a kind-of perpetual EAP (Early Access Preview) available for free: https://blog.jetbrains.com/webstorm/category/eap/\n+If you decide to start using Webstorm keep in mind that sooner or later you'll have to start paying an annual subscription because EAPs are not always available.\n+To have a look at some of the Webstorm features you can have a look at those videos: https://www.jetbrains.com/webstorm/documentation/\n+\n+Another, completely free (as in freedom) alternative is VSCode: https://code.visualstudio.com/\n+For most things it's as good as Webstorm, for others (like type inference) it's even better. Unfortunately it lacks most of the Webstorm features.\n+\n+At the end the choice is yours.\n+\n+## Mobile\n+We will talk once again about scaffolding once we will introduce `Android` and `Cordova`.\ndiff --git a/.tortilla/manuals/templates/step4.tmpl b/.tortilla/manuals/templates/step4.tmpl\nnew file mode 100644\nindex 0000000..ba63323\n--- /dev/null\n+++ b/.tortilla/manuals/templates/step4.tmpl\n@@ -0,0 +1,11 @@\n+Before we start writing code, it is important that we learn how to check our code.\n+\n+The computer runs through everything we write in split second but we can still pause the computer and go through step by step, check what actually happens when the computer runs our code instructions.\n+\n+This phase is sometimes being skipped by developers but trust me, you never want to skip this phase and you should always be super comfortable in debugging your code on whatever environment it’s running on.\n+\n+The easiest way to debug your Javascript application is right into your editor:\n+  * https://www.jetbrains.com/help/webstorm/debugging-javascript-in-chrome.html\n+  * https://blog.jetbrains.com/webstorm/2017/01/debugging-angular-apps/\n+\n+Later on we will learn how to debug mobile applications.\ndiff --git a/.tortilla/manuals/templates/step5.tmpl b/.tortilla/manuals/templates/step5.tmpl\nnew file mode 100644\nindex 0000000..0c7558f\n--- /dev/null\n+++ b/.tortilla/manuals/templates/step5.tmpl\n@@ -0,0 +1,132 @@\n+## Server\n+\n+After the planning phase it's finally time to start writing some real code!\n+We'll start with the server, so let's install a couple of packages first:\n+\n+    $ npm install apollo-server-express body-parser cors express graphql graphql-tools\n+    $ npm install --save-dev @types/body-parser @types/cors @types/express @types/graphql\n+\n+Express is a fast, unopinionated, minimalist web framework for node.\n+Cross-Origin Resource Sharing (CORS) is a mechanism that uses additional HTTP headers to let a user agent gain permission to access selected resources from a server on a different origin (domain) than the site currently in use. A user agent makes a cross-origin HTTP request when it requests a resource from a different domain, protocol, or port than the one from which the current document originated.\n+We will need CORS because Webpack's development server used in the client will make use of a different port than the Express server, thus configuring a different origin.\n+GraphQL is a query language for APIs and a runtime for fulfilling those queries with your existing data. GraphQL provides a complete and understandable description of the data in your API, gives clients the power to ask for exactly what they need and nothing more, makes it easier to evolve APIs over time, and enables powerful developer tools.\n+Apollo Server is a community-maintained open-source GraphQL server. It works with pretty much all Node.js HTTP server frameworks. Apollo Server works with any GraphQL schema built with GraphQL.js or with a convenience library such as graphql-tools.\n+\n+The GraphQL query language is basically about selecting fields on objects. Because the shape of a GraphQL query closely matches the result, you can predict what the query will return without knowing that much about the server. But it's useful to have an exact description of the data we can ask for - what fields can we select? What kinds of objects might they return? What fields are available on those sub-objects? That's where the schema comes in.\n+Every GraphQL service defines a set of types which completely describe the set of possible data you can query on that service. Then, when queries come in, they are validated and executed against that schema.\n+\n+For the moment let's create some empty schemas and resolvers:\n+\n+{{{ diffStep \"1.1\" module=\"server\" files=\"schema/*\" }}}\n+\n+Time to create our index:\n+\n+{{{ diffStep \"1.1\" module=\"server\" files=\"^index.ts\" }}}\n+\n+Now we want to feed our graphql server with some data. Soon we will need `moment`, so let's install it:\n+\n+    $ npm install moment\n+\n+Now we can create a fake db:\n+\n+{{{ diffStep \"1.2\" module=\"server\" files=\"db.ts\" }}}\n+\n+Its' finally time to create our schema and our resolvers:\n+\n+{{{ diffStep \"1.3\" module=\"server\" }}}\n+\n+Out basic server is already done and working. We still have no way to do any kind of mutation, but we already set up several queries to return a list of users or chats.\n+In particular we can choose if we want to return all the chats (and how many messages we want to return for each chat) or if we want to return a single chat. We can also choose which and how many properties we want to return for each query.\n+We can start the server by simply running:\n+\n+    $ npm start\n+\n+## Client\n+\n+Now we can concentrate on the client and bootstrap it using angular-cli.\n+First you will need to install angular-cli globally with:\n+\n+    $ npm install -g @angular/cli\n+\n+Then we can create a new project from scratch:\n+\n+    $ ng new client --style scss\n+\n+Time to install a couple of packages:\n+\n+    $ npm install apollo-angular apollo-angular-link-http apollo-cache-inmemory apollo-client apollo-link graphql graphql-tag\n+    $ npm install --save-dev @types/graphql\n+\n+We will also need to add `esnext.asynciterable` to the libs:\n+\n+{{{ diffStep \"1.1\" module=\"client\" files=\"tsconfig.json\" }}}\n+\n+We also added the `downlevelIteration` option which is required to make sure that everything will be transpiled to ES5.\n+\n+To get started using Apollo with Angular, we need to import two NgModules, `ApolloModule` and `HttpLinkModule`.\n+\n+- `ApolloModule` is the center of using GraphQL in your app! It includes all needed services that allows to use ApolloClient’s features.\n+- `HttpLinkModule` makes it easy to fetch data in Angular.\n+\n+`HttpLinkModule` is optional, you can replace it with any other Link.\n+Its biggest advantage of all is that it uses `HttpClient` internally so it’s possible to use it in `NativeScript` or in combination with any other `HttpClient` provider. By using `HttpLinkModule` you get Server-Side Rendering for free, without any additional work.\n+\n+To get started, inject `Apollo` and `HttpLink` services and then create a client:\n+\n+{{{ diffStep \"1.1\" module=\"client\" files=\"app.module.ts\" }}}\n+\n+We're using the `InMemory` cache, but there are several options like `Redux`, `Hermes`, `ngrx`...\n+\n+The `gql` template tag is what you use to define GraphQL queries in your Apollo apps. It parses your GraphQL query into the `GraphQL.js AST format` which may then be consumed by Apollo methods. Whenever Apollo is asking for a GraphQL query you will always want to wrap it in a `gql` template tag.\n+\n+You can embed a GraphQL document containing only fragments inside of another GraphQL document using template string interpolation. This allows you to use fragments defined in one part of your codebase inside of a query defined in a completely different file.\n+\n+{{{ diffStep \"1.2\" module=\"client\" files=\"src/graphql\" }}}\n+\n+Let's create a simple service to query the chats from our just created server:\n+\n+{{{ diffStep \"1.2\" module=\"client\" files=\"src/app/services\" }}}\n+\n+We just learned how to use Apollo to attach GraphQL query results to the Angular UI. The `watchQuery` method returns a `QueryRef` object which has the `valueChanges` property that is an Observable.\n+That information is stored in Apollo Client’s global cache, so if some other query fetches new information about the chats, this component will update to remain consistent.\n+It’s also possible to fetch data only once. The query method of Apollo service returns an Observable that also resolves with the same result as above.\n+\n+#### But what is a `QueryRef`?\n+\n+As you know, `Apollo.query` method returns an Observable that emits a result, just once, but `Apollo.watchQuery` also does the same except it passes multiple results.\n+So why `Apollo.watchQuery` can not expose an Observable?\n+\n+In `ApolloClient.watchQuery` returns an Observable, but not a standard one, it contains many useful methods (like `refetch()`) to manipulate the watched query.\n+A normal Observable, has only one method, `subscribe()`.\n+\n+The API of `QueryRef` is very simple. It has the same methods as the Apollo’s Observable we talked about. To subscribe to query results you have to access `valueChanges` property which exposes a clean RxJS Observable.\n+\n+We will use Materials for the UI, so let's install it:\n+\n+    $ npm install @angular/cdk @angular/material hammerjs ng2-truncate\n+\n+Let's configure Material:\n+\n+{{{ diffStep \"1.3\" module=\"client\" files=\"src/index.ts, src/main.ts, src/styles.scss\" }}}\n+\n+We're now creating a `shared` module where we will define our header component where we're going to project a different content from each component:\n+\n+{{{ diffStep \"1.3\" module=\"client\" files=\"src/app/shared/*\" }}}\n+\n+Now we want to create the `chats-lister` module, with a container component called `ChatsComponent` and a couple of presentational components.\n+\n+{{{ diffStep \"1.3\" module=\"client\" files=\"src/app/chats-lister/*\" }}}\n+\n+Finally let's wire everything up to the main module:\n+\n+{{{ diffStep \"1.3\" module=\"client\" files=\"src/app/app.component.ts, src/app/app.module.ts\" }}}\n+\n+If you will try to run the frontend you will notice that several messages seems like duplicated, why does it happen?\n+\n+`apollo-cache-inmemory` is the default cache implementation for Apollo Client 2.0. `InMemoryCache` is a normalized data store that supports all of Apollo Client 1.0's features without the dependency on Redux.\n+The `InMemoryCache` normalizes your data before saving it to the store by splitting the result into individual objects, creating a unique identifier for each object, and storing those objects in a flattened data structure. By default, `InMemoryCache` will attempt to use the commonly found primary keys of `id` and `_id` for the unique identifier if they exist along with `__typename` on an object.\n+Since we use NoSQL-like structure in our backend, messages are stored as an array inside each chat so their incremental identifiers are not unique across different chats. We need to normalize them in a way that takes into account both the message id and the chat id:\n+\n+{{{ diffStep \"1.4\" module=\"client\" }}}\n+\n+That way our application will work even if the backend is a NoSQL. What's even more interesting is that our application will keep working as well even when we will switch our backend to PostgreSQL.\ndiff --git a/.tortilla/manuals/templates/step6.tmpl b/.tortilla/manuals/templates/step6.tmpl\nnew file mode 100644\nindex 0000000..9e9d289\n--- /dev/null\n+++ b/.tortilla/manuals/templates/step6.tmpl\n@@ -0,0 +1,44 @@\n+## Server\n+\n+The GraphQL codegen library can generate any code for any language — including type definitions, data models, query builder, resolvers, ORM code, complete full stack platforms.\n+You can create your own custom GraphQL codegen templates in 10 minutes, that fit exactly your needs. We will use it to generate `Typescript` typings.\n+\n+First, let's install `graphql-code-generator`  in our server and add it to the run scripts:\n+\n+    $ npm install graphql-code-generator\n+\n+{{{ diffStep \"2.1\" module=\"server\" }}}\n+\n+Now let's run the generator (the server must be running in the background):\n+\n+    $ npm run generator\n+\n+Please note that the server must be started before running the generator.\n+\n+Those are the types created with `npm run generator`:\n+\n+{{{ diffStep \"2.2\" module=\"server\" }}}\n+\n+Now let's use them:\n+\n+{{{ diffStep \"2.3\" module=\"server\" }}}\n+\n+Don't worry, they will be much more useful when we will write our first mutation.\n+\n+## Client\n+\n+Let's do the same on the client:\n+\n+    $ npm install graphql-code-generator\n+\n+Please note that the server must be started before running the generator.\n+\n+{{{ diffStep \"2.1\" module=\"client\" }}}\n+\n+Those are our generated types:\n+\n+{{{ diffStep \"2.2\" module=\"client\" }}}\n+\n+Let's use them:\n+\n+{{{ diffStep \"2.3\" module=\"client\" }}}\ndiff --git a/.tortilla/manuals/templates/step7.tmpl b/.tortilla/manuals/templates/step7.tmpl\nnew file mode 100644\nindex 0000000..4a58645\n--- /dev/null\n+++ b/.tortilla/manuals/templates/step7.tmpl\n@@ -0,0 +1,21 @@\n+## Client\n+\n+Testing is a very important part of each application and for the sake of showing different testing techniques we are going to show how to test a presentational component, a container component and a service.\n+\n+First let's start by importing `hammerjs` for the Material Gestures inside the test script.\n+\n+{{{ diffStep \"3.1\" module=\"client\" files=\"src/test.ts\" }}}\n+\n+Let's start with the simplest one: the presentational component.\n+We are not going to inject any service and we don't need to access our backend, so things are quite simple: we just need to pass our Chat object as an Input, detect the changes and use the query selector to match the UI content to the one we passed as input:\n+\n+{{{ diffStep \"3.1\" module=\"client\" files=\"src/app/chats-lister/components/chat-item/chat-item.component.spec.ts\" }}}\n+\n+Testing a service is a bit more complicated because we will need to mock our backend in order to get fake results instead of having to fire up the backend each time.\n+We are going to simply mock the HTTP calls, which is a well known practice in the REST API world. Since we are using HTTP to retrieve the data, it will work as well with Apollo client:\n+\n+{{{ diffStep \"3.1\" module=\"client\" files=\"src/app/services/chats.service.spec.ts\" }}}\n+\n+In the last example we are going to test a container component, which makes use of several services and multiple other components:\n+\n+{{{ diffStep \"3.1\" module=\"client\" files=\"src/app/chats-lister/containers/chats/chats.component.spec.ts\" }}}\ndiff --git a/.tortilla/manuals/templates/step8.tmpl b/.tortilla/manuals/templates/step8.tmpl\nnew file mode 100644\nindex 0000000..7ddbd22\n--- /dev/null\n+++ b/.tortilla/manuals/templates/step8.tmpl\n@@ -0,0 +1,16 @@\n+We created a module which lists all of our chats, but we still need to show a particular chat.\n+Let's create the `chat-viewer` module! We're going to create a container component called `ChatComponent` and a couple of presentational components.\n+\n+{{{ diffStep \"4.1\" module=\"client\" }}}\n+\n+It's time to generate our types:\n+\n+    $ npm run generator\n+\n+And use them:\n+\n+{{{ diffStep \"4.2\" module=\"client\" files=\"^(?!src/types.d.ts$).*\" }}}\n+\n+We will also create some more tests for the newly created Chat container component:\n+\n+{{{ diffStep \"4.3\" module=\"client\" }}}\ndiff --git a/.tortilla/manuals/templates/step9.tmpl b/.tortilla/manuals/templates/step9.tmpl\nnew file mode 100644\nindex 0000000..5b24b0c\n--- /dev/null\n+++ b/.tortilla/manuals/templates/step9.tmpl\n@@ -0,0 +1,49 @@\n+In addition to fetching data using queries, Apollo also helps you handle GraphQL mutations. In GraphQL, mutations are identical to queries in syntax, the only difference being that you use the keyword mutation instead of query to indicate that the root fields on this query are going to be performing writes to the backend.\n+GraphQL mutations represent two things in one query string:\n+\n+1. The mutation field name with arguments, which represents the actual operation to be done on the server.\n+2. The fields you want back from the result of the mutation to update the client.\n+\n+When we use mutations in Apollo, the result is typically integrated into the cache automatically based on the id of the result, which in turn updates the UI automatically, so we often don't need to explicitly handle the results. In order for the client to correctly do this, we need to ensure we select the necessary fields in the result. One good strategy can be to simply ask for any fields that might have been affected by the mutation. Alternatively, you can use fragments to share the fields between a query and a mutation that updates that query.\n+\n+## Server\n+\n+Finally we're going to create our mutations in the server:\n+\n+{{{ diffStep \"3.1\" module=\"server\" }}}\n+\n+Let me briefly explain what's going on here.\n+For each chat/group we store the `allTimeMemberIds`, `listingMemberIds` and `actualGroupMemberIds` properties in our NoSQL-like fake db.\n+What's the difference between `allTimeMemberIds` and `listingMemberIds`? When a chat gets created only the user who created it will be able too see it, the chat will be displayed to the other user only once the first messaged gets sent. `allTimeMemberIds` is an array which always contain both the users, while `listingMemberIds` contains only the users which get the chat listed (initially the creator, later both users). `actualGroupMemberIds` is only used for groups.\n+Groups, instead, get listed by all members immediately since the creation. So initially both `allTimeMemberIds`, `listingMemberIds` and `actualGroupMemberIds` are similar. Later users can leave the group or get deleted (so they will be removed from `actualGroupMemberIds`) but they will still be able to list the group in read-only mode, thus remaining in the `listingMemberIds`. Once they remove the group they will also be remove from the `listingMemberIds` array.\n+That's why we have to check for several different conditions before adding/deleting messages: it could be necessary to add the other peer to the `listingMemberIds` (for example if we are writing the first message of a chat) or it could be necessary to physically remove the messages instead of simply removing the current user from the `holderIds`. `holderIds` is a field in each message which states which user will currently display that specific message. In fact each user can delete a specific message without affecting what the others will see. Once there will be no more users in the `holderIds` array it will be safe to delete the message.\n+Each message has also a `recipients` array containing the receiving date and the viewing date of that particular message for all the other users. That's necessary to implement the single, double and blue ticks used by the real Whatsapp.\n+\n+It may seem a bit overwhelming at first, but you should keep in mind that the real Whatsapp has tons of features and also takes advantage of a local database to store messages, so it's easier for them to implement features like per-user messages: their source of truth is not the server because once downloaded the messages are kept in the client itself, so deleting messages doesn't affect anyone else. On the contrary our source of truth is the server, so our approach is more similar to Telegram instead. This is a better approach in my opinion because it allows us to show the messages for the same user on multiple clients, instead of having to rely on questionable approaches like Whatsapp Web.\n+Also we already implemented our mutations to take care of future use cases (like reading notifications) which we still didn't implement.\n+\n+I said we were going to take greater advantage of `graphql-code-generator` once we started writing our first mutation and I'm going to show you why. Let's run the generator first:\n+\n+    $ npm run generator\n+\n+Then let's use the generated types:\n+\n+{{{ diffStep \"3.3\" module=\"server\" }}}\n+\n+## Client\n+\n+For the client I'll only show you how to make use of the addMessage mutation in this chapters. The other mutations will require much more boilerplate so I left them for their own chapter.\n+\n+Let's start by wiring the addMessage mutation. We're going to write the GraphQL query and then use the generator to generate the types:\n+\n+{{{ diffStep \"5.1\" module=\"client\" files=\"^(?!src/types.d.ts$).*\" }}}\n+\n+Run the generator:\n+\n+    $ npm run generator\n+\n+Now let's use the just-created query:\n+\n+{{{ diffStep \"5.2\" module=\"client\" }}}\n+\n+It's that simple! You would be tempted to say that it doesn't work, but you should try to refresh the page first ;)\n\\ No newline at end of file\ndiff --git a/client/.angular-cli.json b/client/.angular-cli.json\nnew file mode 100644\nindex 0000000..542e27b\n--- /dev/null\n+++ b/client/.angular-cli.json\n@@ -0,0 +1,60 @@\n+{\n+  \"$schema\": \"./node_modules/@angular/cli/lib/config/schema.json\",\n+  \"project\": {\n+    \"name\": \"whatsapp-client-angularcli-material\"\n+  },\n+  \"apps\": [\n+    {\n+      \"root\": \"src\",\n+      \"outDir\": \"dist\",\n+      \"assets\": [\n+        \"assets\",\n+        \"favicon.ico\"\n+      ],\n+      \"index\": \"index.html\",\n+      \"main\": \"main.ts\",\n+      \"polyfills\": \"polyfills.ts\",\n+      \"test\": \"test.ts\",\n+      \"tsconfig\": \"tsconfig.app.json\",\n+      \"testTsconfig\": \"tsconfig.spec.json\",\n+      \"prefix\": \"app\",\n+      \"styles\": [\n+        \"styles.scss\"\n+      ],\n+      \"scripts\": [],\n+      \"environmentSource\": \"environments/environment.ts\",\n+      \"environments\": {\n+        \"dev\": \"environments/environment.ts\",\n+        \"prod\": \"environments/environment.prod.ts\"\n+      }\n+    }\n+  ],\n+  \"e2e\": {\n+    \"protractor\": {\n+      \"config\": \"./protractor.conf.js\"\n+    }\n+  },\n+  \"lint\": [\n+    {\n+      \"project\": \"src/tsconfig.app.json\",\n+      \"exclude\": \"**/node_modules/**\"\n+    },\n+    {\n+      \"project\": \"src/tsconfig.spec.json\",\n+      \"exclude\": \"**/node_modules/**\"\n+    },\n+    {\n+      \"project\": \"e2e/tsconfig.e2e.json\",\n+      \"exclude\": \"**/node_modules/**\"\n+    }\n+  ],\n+  \"test\": {\n+    \"karma\": {\n+      \"config\": \"./karma.conf.js\"\n+    }\n+  },\n+  \"defaults\": {\n+    \"styleExt\": \"scss\",\n+    \"component\": {}\n+  }\n+}\ndiff --git a/client/.editorconfig b/client/.editorconfig\nnew file mode 100644\nindex 0000000..6e87a00\n--- /dev/null\n+++ b/client/.editorconfig\n@@ -0,0 +1,13 @@\n+# Editor configuration, see http://editorconfig.org\n+root = true\n+\n+[*]\n+charset = utf-8\n+indent_style = space\n+indent_size = 2\n+insert_final_newline = true\n+trim_trailing_whitespace = true\n+\n+[*.md]\n+max_line_length = off\n+trim_trailing_whitespace = false\ndiff --git a/client/.gitignore b/client/.gitignore\nnew file mode 100644\nindex 0000000..22657a5\n--- /dev/null\n+++ b/client/.gitignore\n@@ -0,0 +1,46 @@\n+# See http://help.github.com/ignore-files/ for more about ignoring files.\n+\n+# compiled output\n+/dist\n+/dist-server\n+/tmp\n+/out-tsc\n+\n+# dependencies\n+/node_modules\n+\n+# IDEs and editors\n+/.idea\n+.project\n+.classpath\n+.c9/\n+*.launch\n+.settings/\n+*.sublime-workspace\n+\n+# IDE - VSCode\n+.vscode/*\n+!.vscode/settings.json\n+!.vscode/tasks.json\n+!.vscode/launch.json\n+!.vscode/extensions.json\n+\n+# misc\n+/.sass-cache\n+/connect.lock\n+/coverage\n+/libpeerconnection.log\n+npm-debug.log\n+testem.log\n+/typings\n+\n+# e2e\n+/e2e/*.js\n+/e2e/*.map\n+\n+# System Files\n+.DS_Store\n+Thumbs.db\n+\n+#Tortilla\n+package-lock.json\ndiff --git a/client/.travis.yml b/client/.travis.yml\nnew file mode 100644\nindex 0000000..b90ab94\n--- /dev/null\n+++ b/client/.travis.yml\n@@ -0,0 +1,20 @@\n+dist: trusty\n+sudo: required\n+\n+branches:\n+  except:\n+  - master-step1\n+  - master-step2\n+\n+language: node_js\n+node_js:\n+  - \"8\"\n+\n+cache:\n+  directories:\n+     - ./node_modules\n+\n+script:\n+  # Use Chromium instead of Chrome.\n+  - export CHROME_BIN=chromium-browser\n+  - npm run test\ndiff --git a/client/e2e/app.e2e-spec.ts b/client/e2e/app.e2e-spec.ts\nnew file mode 100644\nindex 0000000..aaf19d5\n--- /dev/null\n+++ b/client/e2e/app.e2e-spec.ts\n@@ -0,0 +1,14 @@\n+import { AppPage } from './app.po';\n+\n+describe('whatsapp-client-angularcli-material App', () => {\n+  let page: AppPage;\n+\n+  beforeEach(() => {\n+    page = new AppPage();\n+  });\n+\n+  it('should display welcome message', () => {\n+    page.navigateTo();\n+    expect(page.getParagraphText()).toEqual('Welcome to app!');\n+  });\n+});\ndiff --git a/client/e2e/app.po.ts b/client/e2e/app.po.ts\nnew file mode 100644\nindex 0000000..82ea75b\n--- /dev/null\n+++ b/client/e2e/app.po.ts\n@@ -0,0 +1,11 @@\n+import { browser, by, element } from 'protractor';\n+\n+export class AppPage {\n+  navigateTo() {\n+    return browser.get('/');\n+  }\n+\n+  getParagraphText() {\n+    return element(by.css('app-root h1')).getText();\n+  }\n+}\ndiff --git a/client/e2e/tsconfig.e2e.json b/client/e2e/tsconfig.e2e.json\nnew file mode 100644\nindex 0000000..1d9e5ed\n--- /dev/null\n+++ b/client/e2e/tsconfig.e2e.json\n@@ -0,0 +1,14 @@\n+{\n+  \"extends\": \"../tsconfig.json\",\n+  \"compilerOptions\": {\n+    \"outDir\": \"../out-tsc/e2e\",\n+    \"baseUrl\": \"./\",\n+    \"module\": \"commonjs\",\n+    \"target\": \"es5\",\n+    \"types\": [\n+      \"jasmine\",\n+      \"jasminewd2\",\n+      \"node\"\n+    ]\n+  }\n+}\ndiff --git a/client/karma.conf.js b/client/karma.conf.js\nnew file mode 100644\nindex 0000000..68c2f7c\n--- /dev/null\n+++ b/client/karma.conf.js\n@@ -0,0 +1,33 @@\n+// Karma configuration file, see link for more information\n+// https://karma-runner.github.io/1.0/config/configuration-file.html\n+\n+module.exports = function (config) {\n+  config.set({\n+    basePath: '',\n+    frameworks: ['jasmine', '@angular/cli'],\n+    plugins: [\n+      require('karma-jasmine'),\n+      require('karma-chrome-launcher'),\n+      require('karma-jasmine-html-reporter'),\n+      require('karma-coverage-istanbul-reporter'),\n+      require('@angular/cli/plugins/karma')\n+    ],\n+    client:{\n+      clearContext: false // leave Jasmine Spec Runner output visible in browser\n+    },\n+    coverageIstanbulReporter: {\n+      reports: [ 'html', 'lcovonly' ],\n+      fixWebpackSourcePaths: true\n+    },\n+    angularCli: {\n+      environment: 'dev'\n+    },\n+    reporters: ['progress', 'kjhtml'],\n+    port: 9876,\n+    colors: true,\n+    logLevel: config.LOG_INFO,\n+    autoWatch: true,\n+    browsers: ['ChromeHeadless'],\n+    singleRun: true\n+  });\n+};\ndiff --git a/client/package.json b/client/package.json\nnew file mode 100644\nindex 0000000..7229a04\n--- /dev/null\n+++ b/client/package.json\n@@ -0,0 +1,69 @@\n+{\n+  \"name\": \"whatsapp-client-angularcli-material\",\n+  \"version\": \"0.0.0\",\n+  \"license\": \"MIT\",\n+  \"scripts\": {\n+    \"ng\": \"ng\",\n+    \"start\": \"ng serve\",\n+    \"build\": \"ng build --prod\",\n+    \"test\": \"ng test\",\n+    \"lint\": \"ng lint\",\n+    \"e2e\": \"ng e2e\",\n+    \"generator\": \"gql-gen --url http://localhost:3000/graphql --template ts --out ./src/types.d.ts \\\"./src/graphql/**/*.ts\\\"\"\n+  },\n+  \"private\": true,\n+  \"dependencies\": {\n+    \"@angular/animations\": \"5.2.5\",\n+    \"@angular/cdk\": \"5.2.1\",\n+    \"@angular/common\": \"5.2.5\",\n+    \"@angular/compiler\": \"5.2.5\",\n+    \"@angular/core\": \"5.2.5\",\n+    \"@angular/flex-layout\": \"2.0.0-beta.12\",\n+    \"@angular/forms\": \"5.2.5\",\n+    \"@angular/http\": \"5.2.5\",\n+    \"@angular/material\": \"5.2.1\",\n+    \"@angular/platform-browser\": \"5.2.5\",\n+    \"@angular/platform-browser-dynamic\": \"5.2.5\",\n+    \"@angular/router\": \"5.2.5\",\n+    \"ajv\": \"6.1.1\",\n+    \"apollo-angular\": \"1.0.1\",\n+    \"apollo-angular-link-http\": \"1.0.2-beta.0\",\n+    \"apollo-cache-inmemory\": \"1.1.9\",\n+    \"apollo-client\": \"2.2.5\",\n+    \"apollo-link\": \"1.1.0\",\n+    \"apollo-link-ws\": \"1.0.5\",\n+    \"apollo-utilities\": \"1.0.8\",\n+    \"core-js\": \"2.5.3\",\n+    \"graphql\": \"0.12.3\",\n+    \"graphql-tag\": \"2.7.3\",\n+    \"hammerjs\": \"2.0.8\",\n+    \"moment\": \"2.20.1\",\n+    \"ng2-truncate\": \"1.3.11\",\n+    \"ngx-selectable-list\": \"1.1.0\",\n+    \"rxjs\": \"5.5.6\",\n+    \"subscriptions-transport-ws\": \"0.9.5\",\n+    \"zone.js\": \"0.8.20\"\n+  },\n+  \"devDependencies\": {\n+    \"@angular/cli\": \"1.7.0\",\n+    \"@angular/compiler-cli\": \"5.2.5\",\n+    \"@angular/language-service\": \"5.2.5\",\n+    \"@types/graphql\": \"0.12.4\",\n+    \"@types/jasmine\": \"2.8.6\",\n+    \"@types/jasminewd2\": \"2.0.3\",\n+    \"@types/node\": \"6.0.101\",\n+    \"codelyzer\": \"4.1.0\",\n+    \"graphql-code-generator\": \"0.8.14\",\n+    \"jasmine-core\": \"2.8.0\",\n+    \"jasmine-spec-reporter\": \"4.2.1\",\n+    \"karma\": \"2.0.0\",\n+    \"karma-chrome-launcher\": \"2.2.0\",\n+    \"karma-coverage-istanbul-reporter\": \"1.4.1\",\n+    \"karma-jasmine\": \"1.1.1\",\n+    \"karma-jasmine-html-reporter\": \"0.2.2\",\n+    \"protractor\": \"5.1.2\",\n+    \"ts-node\": \"4.1.0\",\n+    \"tslint\": \"5.9.1\",\n+    \"typescript\": \"2.5.3\"\n+  }\n+}\ndiff --git a/client/package.json.orig b/client/package.json.orig\nnew file mode 100644\nindex 0000000..e025965\n--- /dev/null\n+++ b/client/package.json.orig\n@@ -0,0 +1,61 @@\n+{\n+  \"name\": \"whatsapp-client-angularcli-material\",\n+  \"version\": \"0.0.0\",\n+  \"license\": \"MIT\",\n+  \"scripts\": {\n+    \"ng\": \"ng\",\n+    \"start\": \"ng serve\",\n+    \"build\": \"ng build --prod\",\n+    \"test\": \"ng test\",\n+    \"lint\": \"ng lint\",\n+    \"e2e\": \"ng e2e\"\n+  },\n+  \"private\": true,\n+  \"dependencies\": {\n+    \"@angular/animations\": \"5.2.5\",\n+    \"@angular/common\": \"5.2.5\",\n+    \"@angular/compiler\": \"5.2.5\",\n+    \"@angular/core\": \"5.2.5\",\n+    \"@angular/forms\": \"5.2.5\",\n+    \"@angular/http\": \"5.2.5\",\n+    \"@angular/platform-browser\": \"5.2.5\",\n+    \"@angular/platform-browser-dynamic\": \"5.2.5\",\n+    \"@angular/router\": \"5.2.5\",\n+    \"ajv\": \"6.1.1\",\n+    \"apollo-angular\": \"1.0.1\",\n+    \"apollo-angular-link-http\": \"1.0.2-beta.0\",\n+    \"apollo-cache-inmemory\": \"1.1.9\",\n+    \"apollo-client\": \"2.2.5\",\n+    \"apollo-link\": \"1.1.0\",\n+    \"core-js\": \"2.5.3\",\n+    \"graphql\": \"0.12.3\",\n+    \"graphql-tag\": \"2.7.3\",\n+    \"rxjs\": \"5.5.6\",\n+    \"zone.js\": \"0.8.20\"\n+  },\n+  \"devDependencies\": {\n+    \"@angular/cli\": \"1.7.0\",\n+    \"@angular/compiler-cli\": \"5.2.5\",\n+    \"@angular/language-service\": \"5.2.5\",\n+<<<<<<< HEAD\n+    \"@types/graphql\": \"^0.12.4\",\n+=======\n+    \"@types/graphql\": \"0.12.4\",\n+>>>>>>> 48ac17b... Step 1.2: Add chats service\n+    \"@types/jasmine\": \"2.8.6\",\n+    \"@types/jasminewd2\": \"2.0.3\",\n+    \"@types/node\": \"6.0.101\",\n+    \"codelyzer\": \"4.1.0\",\n+    \"jasmine-core\": \"2.8.0\",\n+    \"jasmine-spec-reporter\": \"4.2.1\",\n+    \"karma\": \"2.0.0\",\n+    \"karma-chrome-launcher\": \"2.2.0\",\n+    \"karma-coverage-istanbul-reporter\": \"1.4.1\",\n+    \"karma-jasmine\": \"1.1.1\",\n+    \"karma-jasmine-html-reporter\": \"0.2.2\",\n+    \"protractor\": \"5.1.2\",\n+    \"ts-node\": \"4.1.0\",\n+    \"tslint\": \"5.9.1\",\n+    \"typescript\": \"2.5.3\"\n+  }\n+}\ndiff --git a/client/protractor.conf.js b/client/protractor.conf.js\nnew file mode 100644\nindex 0000000..7ee3b5e\n--- /dev/null\n+++ b/client/protractor.conf.js\n@@ -0,0 +1,28 @@\n+// Protractor configuration file, see link for more information\n+// https://github.com/angular/protractor/blob/master/lib/config.ts\n+\n+const { SpecReporter } = require('jasmine-spec-reporter');\n+\n+exports.config = {\n+  allScriptsTimeout: 11000,\n+  specs: [\n+    './e2e/**/*.e2e-spec.ts'\n+  ],\n+  capabilities: {\n+    'browserName': 'chrome'\n+  },\n+  directConnect: true,\n+  baseUrl: 'http://localhost:4200/',\n+  framework: 'jasmine',\n+  jasmineNodeOpts: {\n+    showColors: true,\n+    defaultTimeoutInterval: 30000,\n+    print: function() {}\n+  },\n+  onPrepare() {\n+    require('ts-node').register({\n+      project: 'e2e/tsconfig.e2e.json'\n+    });\n+    jasmine.getEnv().addReporter(new SpecReporter({ spec: { displayStacktrace: true } }));\n+  }\n+};\ndiff --git a/client/renovate.json b/client/renovate.json\nnew file mode 100644\nindex 0000000..7516e39\n--- /dev/null\n+++ b/client/renovate.json\n@@ -0,0 +1,19 @@\n+{\n+  \"extends\": [\n+    \"config:base\",\n+    \":automergeMajor\"\n+  ],\n+  \"baseBranches\": [\n+    \"master-step3\",\n+    \"master-step4\",\n+    \"master-step5\",\n+    \"master-step6\",\n+    \"master-step7\",\n+    \"master-step8\",\n+    \"master-step9\",\n+    \"master-step10\",\n+    \"master-step11\"\n+  ],\n+  \"prHourlyLimit\": 60,\n+  \"recreateClosed\": true\n+}\ndiff --git a/client/src/app/app.component.scss b/client/src/app/app.component.scss\nnew file mode 100644\nindex 0000000..e69de29\ndiff --git a/client/src/app/app.component.ts b/client/src/app/app.component.ts\nnew file mode 100644\nindex 0000000..61feda0\n--- /dev/null\n+++ b/client/src/app/app.component.ts\n@@ -0,0 +1,12 @@\n+import { Component } from '@angular/core';\n+\n+@Component({\n+  selector: 'app-root',\n+  template: `\n+    <router-outlet></router-outlet>\n+  `,\n+  styleUrls: ['./app.component.scss']\n+})\n+export class AppComponent {\n+  title = 'app';\n+}\ndiff --git a/client/src/app/app.module.ts b/client/src/app/app.module.ts\nnew file mode 100644\nindex 0000000..d81a15c\n--- /dev/null\n+++ b/client/src/app/app.module.ts\n@@ -0,0 +1,89 @@\n+import { BrowserModule } from '@angular/platform-browser';\n+import { NgModule } from '@angular/core';\n+\n+\n+import { AppComponent } from './app.component';\n+import {HTTP_INTERCEPTORS, HttpClientModule} from '@angular/common/http';\n+import {HttpLink, HttpLinkModule, Options} from 'apollo-angular-link-http';\n+import {Apollo, ApolloModule} from 'apollo-angular';\n+import {defaultDataIdFromObject, InMemoryCache} from 'apollo-cache-inmemory';\n+import {ChatsListerModule} from './chats-lister/chats-lister.module';\n+import {RouterModule, Routes} from '@angular/router';\n+import {ChatViewerModule} from './chat-viewer/chat-viewer.module';\n+import {ChatsCreationModule} from './chats-creation/chats-creation.module';\n+import {LoginModule} from './login/login.module';\n+import {AuthInterceptor} from './login/services/auth.interceptor';\n+import {getMainDefinition} from 'apollo-utilities';\n+import {OperationDefinitionNode} from 'graphql';\n+import {split} from 'apollo-link';\n+import {WebSocketLink} from 'apollo-link-ws';\n+import {LoginService} from './login/services/login.service';\n+\n+const routes: Routes = [];\n+\n+@NgModule({\n+  declarations: [\n+    AppComponent\n+  ],\n+  imports: [\n+    BrowserModule,\n+    // Apollo\n+    ApolloModule,\n+    HttpLinkModule,\n+    HttpClientModule,\n+    // Routing\n+    RouterModule.forRoot(routes),\n+    // Feature modules\n+    ChatsListerModule,\n+    ChatViewerModule,\n+    ChatsCreationModule,\n+    LoginModule,\n+  ],\n+  providers: [\n+    {\n+      provide: HTTP_INTERCEPTORS,\n+      useClass: AuthInterceptor,\n+      multi: true,\n+    }\n+  ],\n+  bootstrap: [AppComponent]\n+})\n+export class AppModule {\n+  constructor(\n+    apollo: Apollo,\n+    httpLink: HttpLink,\n+    loginService: LoginService,\n+  ) {\n+    const subscriptionLink = new WebSocketLink({\n+      uri:\n+        'ws://localhost:3000/subscriptions',\n+      options: {\n+        reconnect: true,\n+        connectionParams: () => ({\n+          authToken: loginService.getAuthHeader() || null\n+        })\n+      }\n+    });\n+\n+    const link = split(\n+      ({ query }) => {\n+        const { kind, operation } = <OperationDefinitionNode>getMainDefinition(query);\n+        return kind === 'OperationDefinition' && operation === 'subscription';\n+      },\n+      subscriptionLink,\n+      httpLink.create(<Options>{uri: 'http://localhost:3000/graphql'})\n+    );\n+\n+    apollo.create({\n+      link,\n+      cache: new InMemoryCache({\n+        dataIdFromObject: (object: any) => {\n+          switch (object.__typename) {\n+            case 'Message': return `${object.chat.id}:${object.id}`; // use `chatId` prefix and `messageId` as the primary key\n+            default: return defaultDataIdFromObject(object); // fall back to default handling\n+          }\n+        }\n+      }),\n+    });\n+  }\n+}\ndiff --git a/client/src/app/chat-viewer/chat-viewer.module.ts b/client/src/app/chat-viewer/chat-viewer.module.ts\nnew file mode 100644\nindex 0000000..dac388a\n--- /dev/null\n+++ b/client/src/app/chat-viewer/chat-viewer.module.ts\n@@ -0,0 +1,56 @@\n+import { BrowserModule } from '@angular/platform-browser';\n+import { NgModule } from '@angular/core';\n+\n+import {BrowserAnimationsModule} from '@angular/platform-browser/animations';\n+import {MatButtonModule, MatGridListModule, MatIconModule, MatListModule, MatMenuModule, MatToolbarModule} from '@angular/material';\n+import {RouterModule, Routes} from '@angular/router';\n+import {FormsModule} from '@angular/forms';\n+import {ChatsService} from '../services/chats.service';\n+import {ChatComponent} from './containers/chat/chat.component';\n+import {MessagesListComponent} from './components/messages-list/messages-list.component';\n+import {MessageItemComponent} from './components/message-item/message-item.component';\n+import {NewMessageComponent} from './components/new-message/new-message.component';\n+import {SharedModule} from '../shared/shared.module';\n+import {SelectableListModule} from 'ngx-selectable-list';\n+import {AuthGuard} from '../login/services/auth.guard';\n+\n+const routes: Routes = [\n+  {\n+    path: 'chat', children: [\n+      {path: ':id', canActivate: [AuthGuard], component: ChatComponent},\n+    ],\n+  },\n+];\n+\n+@NgModule({\n+  declarations: [\n+    ChatComponent,\n+    MessagesListComponent,\n+    MessageItemComponent,\n+    NewMessageComponent,\n+  ],\n+  imports: [\n+    BrowserModule,\n+    // Material\n+    MatToolbarModule,\n+    MatMenuModule,\n+    MatIconModule,\n+    MatButtonModule,\n+    MatListModule,\n+    MatGridListModule,\n+    // Animations\n+    BrowserAnimationsModule,\n+    // Routing\n+    RouterModule.forChild(routes),\n+    // Forms\n+    FormsModule,\n+    // Feature modules\n+    SharedModule,\n+    SelectableListModule,\n+  ],\n+  providers: [\n+    ChatsService,\n+  ],\n+})\n+export class ChatViewerModule {\n+}\ndiff --git a/client/src/app/chat-viewer/components/message-item/message-item.component.scss b/client/src/app/chat-viewer/components/message-item/message-item.component.scss\nnew file mode 100644\nindex 0000000..d680766\n--- /dev/null\n+++ b/client/src/app/chat-viewer/components/message-item/message-item.component.scss\n@@ -0,0 +1,18 @@\n+:host {\n+  display: flex;\n+  width: 100%;\n+}\n+\n+.message {\n+  max-width: 75%;\n+  background-color: lightgoldenrodyellow;\n+\n+  &.mine {\n+    background-color: lightcyan;\n+    margin-left: auto;\n+  }\n+\n+  .message-sender {\n+    font-size: small;\n+  }\n+}\ndiff --git a/client/src/app/chat-viewer/components/message-item/message-item.component.ts b/client/src/app/chat-viewer/components/message-item/message-item.component.ts\nnew file mode 100644\nindex 0000000..c556072\n--- /dev/null\n+++ b/client/src/app/chat-viewer/components/message-item/message-item.component.ts\n@@ -0,0 +1,22 @@\n+import {Component, Input} from '@angular/core';\n+import {GetChat} from '../../../../types';\n+\n+@Component({\n+  selector: 'app-message-item',\n+  template: `\n+    <div class=\"message\"\n+         [ngClass]=\"{'mine': message.ownership}\">\n+      <div *ngIf=\"isGroup && !message.ownership\" class=\"message-sender\">{{ message.sender.name }}</div>\n+      <div>{{ message.content }}</div>\n+    </div>\n+  `,\n+  styleUrls: ['message-item.component.scss'],\n+})\n+export class MessageItemComponent {\n+  // tslint:disable-next-line:no-input-rename\n+  @Input('item')\n+  message: GetChat.Messages;\n+\n+  @Input()\n+  isGroup: boolean;\n+}\ndiff --git a/client/src/app/chat-viewer/components/messages-list/messages-list.component.scss b/client/src/app/chat-viewer/components/messages-list/messages-list.component.scss\nnew file mode 100644\nindex 0000000..ed1ac7c\n--- /dev/null\n+++ b/client/src/app/chat-viewer/components/messages-list/messages-list.component.scss\n@@ -0,0 +1,12 @@\n+:host {\n+  display: block;\n+  height: 100%;\n+  overflow-y: scroll;\n+  background-color: aliceblue;\n+}\n+\n+/*\n+:host::-webkit-scrollbar {\n+  display: none;\n+}\n+*/\ndiff --git a/client/src/app/chat-viewer/components/messages-list/messages-list.component.ts b/client/src/app/chat-viewer/components/messages-list/messages-list.component.ts\nnew file mode 100644\nindex 0000000..f123280\n--- /dev/null\n+++ b/client/src/app/chat-viewer/components/messages-list/messages-list.component.ts\n@@ -0,0 +1,27 @@\n+import {Component, Input} from '@angular/core';\n+import {GetChat} from '../../../../types';\n+import {SelectableListDirective} from 'ngx-selectable-list';\n+\n+@Component({\n+  selector: 'app-messages-list',\n+  template: `\n+    <mat-list>\n+      <mat-list-item *ngFor=\"let message of messages\">\n+        <app-message-item [item]=\"message\" [isGroup]=\"isGroup\"\n+                          appSelectableItem></app-message-item>\n+      </mat-list-item>\n+    </mat-list>\n+    <ng-content *ngIf=\"selectableListDirective.selecting\"></ng-content>\n+  `,\n+  styleUrls: ['messages-list.component.scss'],\n+})\n+export class MessagesListComponent {\n+  // tslint:disable-next-line:no-input-rename\n+  @Input('items')\n+  messages: GetChat.Messages[];\n+\n+  @Input()\n+  isGroup: boolean;\n+\n+  constructor(public selectableListDirective: SelectableListDirective) {}\n+}\ndiff --git a/client/src/app/chat-viewer/components/new-message/new-message.component.scss b/client/src/app/chat-viewer/components/new-message/new-message.component.scss\nnew file mode 100644\nindex 0000000..da4ed4f\n--- /dev/null\n+++ b/client/src/app/chat-viewer/components/new-message/new-message.component.scss\n@@ -0,0 +1,13 @@\n+:host {\n+  display: flex;\n+  height: 8vh;\n+}\n+\n+input {\n+  width: 100%;\n+}\n+\n+button {\n+  width: 8vh;\n+  min-width: 56px;\n+}\ndiff --git a/client/src/app/chat-viewer/components/new-message/new-message.component.ts b/client/src/app/chat-viewer/components/new-message/new-message.component.ts\nnew file mode 100644\nindex 0000000..10b526c\n--- /dev/null\n+++ b/client/src/app/chat-viewer/components/new-message/new-message.component.ts\n@@ -0,0 +1,34 @@\n+import {Component, EventEmitter, Input, Output} from '@angular/core';\n+\n+@Component({\n+  selector: 'app-new-message',\n+  template: `\n+    <input type=\"text\" [(ngModel)]=\"message\" (keyup)=\"onInputKeyup($event)\"/>\n+    <button mat-button (click)=\"emitMessage()\" [disabled]=\"disabled\">\n+      <mat-icon aria-label=\"Icon-button with a send icon\">send</mat-icon>\n+    </button>\n+  `,\n+  styleUrls: ['new-message.component.scss'],\n+})\n+export class NewMessageComponent {\n+  @Input()\n+  disabled: boolean;\n+\n+  @Output()\n+  newMessage = new EventEmitter<string>();\n+\n+  message = '';\n+\n+  onInputKeyup({ keyCode }: KeyboardEvent) {\n+    if (keyCode === 13) {\n+      this.emitMessage();\n+    }\n+  }\n+\n+  emitMessage() {\n+    if (this.message && !this.disabled) {\n+      this.newMessage.emit(this.message);\n+      this.message = '';\n+    }\n+  }\n+}\ndiff --git a/client/src/app/chat-viewer/containers/chat/chat.component.scss b/client/src/app/chat-viewer/containers/chat/chat.component.scss\nnew file mode 100644\nindex 0000000..56ffb7e\n--- /dev/null\n+++ b/client/src/app/chat-viewer/containers/chat/chat.component.scss\n@@ -0,0 +1,10 @@\n+.container {\n+  display: flex;\n+  flex-flow: column;\n+  justify-content: space-between;\n+  height: calc(100vh - 8vh);\n+\n+  app-confirm-selection {\n+    bottom: 10vh;\n+  }\n+}\ndiff --git a/client/src/app/chat-viewer/containers/chat/chat.component.spec.ts b/client/src/app/chat-viewer/containers/chat/chat.component.spec.ts\nnew file mode 100644\nindex 0000000..930cf89\n--- /dev/null\n+++ b/client/src/app/chat-viewer/containers/chat/chat.component.spec.ts\n@@ -0,0 +1,180 @@\n+import { async, ComponentFixture, TestBed } from '@angular/core/testing';\n+\n+import { ChatComponent } from './chat.component';\n+import {DebugElement, NO_ERRORS_SCHEMA} from '@angular/core';\n+import {MatButtonModule, MatGridListModule, MatIconModule, MatListModule, MatMenuModule, MatToolbarModule} from '@angular/material';\n+import {ChatsService} from '../../../services/chats.service';\n+import {Apollo} from 'apollo-angular';\n+import {HttpClientTestingModule, HttpTestingController} from '@angular/common/http/testing';\n+import {HttpLink, HttpLinkModule, Options} from 'apollo-angular-link-http';\n+import {defaultDataIdFromObject, InMemoryCache} from 'apollo-cache-inmemory';\n+import {RouterTestingModule} from '@angular/router/testing';\n+import {ActivatedRoute} from '@angular/router';\n+import {of} from 'rxjs/observable/of';\n+import {By} from '@angular/platform-browser';\n+import {FormsModule} from '@angular/forms';\n+import {SharedModule} from '../../../shared/shared.module';\n+import {NewMessageComponent} from '../../components/new-message/new-message.component';\n+import {MessagesListComponent} from '../../components/messages-list/messages-list.component';\n+import {MessageItemComponent} from '../../components/message-item/message-item.component';\n+import {SelectableListModule} from 'ngx-selectable-list';\n+import {LoginService} from '../../../login/services/login.service';\n+\n+describe('ChatComponent', () => {\n+  let component: ChatComponent;\n+  let fixture: ComponentFixture<ChatComponent>;\n+  let el: DebugElement;\n+\n+  let httpMock: HttpTestingController;\n+  let httpLink: HttpLink;\n+  let apollo: Apollo;\n+\n+  const chat: any = {\n+    id: '1',\n+    __typename: 'Chat',\n+    name: 'Avery Stewart',\n+    picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n+    allTimeMembers: [\n+      {\n+        id: '1',\n+        __typename: 'User',\n+      },\n+      {\n+        id: '3',\n+        __typename: 'User',\n+      }\n+    ],\n+    unreadMessages: 1,\n+    isGroup: false,\n+    messages: [\n+      {\n+        id: '1',\n+        chat: {\n+          id: '1',\n+          __typename: 'Chat',\n+        },\n+        __typename: 'Message',\n+        sender: {\n+          id: '3',\n+          __typename: 'User',\n+          name: 'Avery Stewart'\n+        },\n+        content: 'Yep!',\n+        createdAt: '1514035700',\n+        type: 0,\n+        recipients: [\n+          {\n+            user: {\n+              id: '1',\n+              __typename: 'User',\n+            },\n+            message: {\n+              id: '1',\n+              __typename: 'Message',\n+              chat: {\n+                id: '1',\n+                __typename: 'Chat',\n+              },\n+            },\n+            __typename: 'Recipient',\n+            chat: {\n+              id: '1',\n+              __typename: 'Chat',\n+            },\n+            receivedAt: null,\n+            readAt: null\n+          }\n+        ],\n+        ownership: false\n+      }\n+    ],\n+  };\n+\n+  beforeEach(async(() => {\n+    TestBed.configureTestingModule({\n+      declarations: [\n+        ChatComponent,\n+        MessagesListComponent,\n+        MessageItemComponent,\n+        NewMessageComponent,\n+      ],\n+      imports: [\n+        MatToolbarModule,\n+        MatMenuModule,\n+        MatIconModule,\n+        MatButtonModule,\n+        MatListModule,\n+        MatGridListModule,\n+        FormsModule,\n+        SharedModule,\n+        HttpLinkModule,\n+        HttpClientTestingModule,\n+        RouterTestingModule,\n+        SelectableListModule,\n+      ],\n+      providers: [\n+        ChatsService,\n+        Apollo,\n+        {\n+          provide: ActivatedRoute,\n+          useValue: {\n+            params: of({ id: chat.id }),\n+            queryParams: of({}),\n+          }\n+        },\n+        LoginService,\n+      ],\n+      schemas: [NO_ERRORS_SCHEMA]\n+    })\n+      .compileComponents();\n+\n+    httpMock = TestBed.get(HttpTestingController);\n+    httpLink = TestBed.get(HttpLink);\n+    apollo = TestBed.get(Apollo);\n+\n+    apollo.create({\n+      link: httpLink.create(<Options>{ uri: 'http://localhost:3000/graphql' }),\n+      cache: new InMemoryCache({\n+        dataIdFromObject: (object: any) => {\n+          switch (object.__typename) {\n+            case 'Message': return `${object.chat.id}:${object.id}`; // use `chatId` prefix and `messageId` as the primary key\n+            default: return defaultDataIdFromObject(object); // fall back to default handling\n+          }\n+        }\n+      }),\n+    });\n+  }));\n+\n+  beforeEach(() => {\n+    fixture = TestBed.createComponent(ChatComponent);\n+    component = fixture.componentInstance;\n+    fixture.detectChanges();\n+    httpMock.expectOne(httpReq => httpReq.body.operationName === 'chatAdded', 'call to chatAdded api');\n+    httpMock.expectOne(httpReq => httpReq.body.operationName === 'messageAdded', 'call to messageAdded api');\n+    httpMock.expectOne(httpReq => httpReq.body.operationName === 'GetChats', 'call to getChats api');\n+    const req = httpMock.expectOne(httpReq => httpReq.body.operationName === 'GetChat', 'call to getChat api');\n+    req.flush({\n+      data: {\n+        chat\n+      }\n+    });\n+  });\n+\n+  it('should create', () => {\n+    expect(component).toBeTruthy();\n+  });\n+\n+  it('should display the chat', () => {\n+    fixture.whenStable().then(() => {\n+      fixture.detectChanges();\n+      el = fixture.debugElement;\n+      expect(el.query(By.css(`app-toolbar > mat-toolbar > div > div`)).nativeElement.textContent).toContain(chat.name);\n+      for (let i = 0; i < chat.messages.length; i++) {\n+        expect(el.query(By.css(`app-messages-list > mat-list > mat-list-item:nth-child(${i + 1}) > div > app-message-item > div`))\n+          .nativeElement.textContent).toContain(chat.messages[i].content);\n+      }\n+    });\n+\n+    httpMock.verify();\n+  });\n+});\ndiff --git a/client/src/app/chat-viewer/containers/chat/chat.component.ts b/client/src/app/chat-viewer/containers/chat/chat.component.ts\nnew file mode 100644\nindex 0000000..a8be4f1\n--- /dev/null\n+++ b/client/src/app/chat-viewer/containers/chat/chat.component.ts\n@@ -0,0 +1,78 @@\n+import {Component, OnInit} from '@angular/core';\n+import {ActivatedRoute, Router} from '@angular/router';\n+import {ChatsService} from '../../../services/chats.service';\n+import {GetChat} from '../../../../types';\n+import {combineLatest} from 'rxjs/observable/combineLatest';\n+import {Location} from '@angular/common';\n+\n+@Component({\n+  template: `\n+    <app-toolbar>\n+      <button class=\"navigation\" mat-button (click)=\"goToChats()\">\n+        <mat-icon aria-label=\"Icon-button with an arrow back icon\">arrow_back</mat-icon>\n+      </button>\n+      <div class=\"title\">{{ name }}</div>\n+    </app-toolbar>\n+    <div class=\"container\">\n+      <app-messages-list [items]=\"messages\" [isGroup]=\"isGroup\"\n+                         appSelectableList=\"multiple_press\" (multiple)=\"deleteMessages($event)\">\n+        <app-confirm-selection #confirmSelection></app-confirm-selection>\n+      </app-messages-list>\n+      <app-new-message (newMessage)=\"addMessage($event)\"></app-new-message>\n+    </div>\n+  `,\n+  styleUrls: ['./chat.component.scss']\n+})\n+export class ChatComponent implements OnInit {\n+  chatId: string;\n+  messages: GetChat.Messages[];\n+  name: string;\n+  isGroup: boolean;\n+  optimisticUI: boolean;\n+\n+  constructor(private route: ActivatedRoute,\n+              private router: Router,\n+              private location: Location,\n+              private chatsService: ChatsService) {\n+  }\n+\n+  ngOnInit() {\n+    combineLatest(this.route.params, this.route.queryParams,\n+      (params: { id: string }, queryParams: { oui?: boolean }) => ({params, queryParams}))\n+      .subscribe(({params: {id: chatId}, queryParams: {oui}}) => {\n+        this.chatId = chatId;\n+\n+        this.optimisticUI = oui;\n+\n+        if (this.optimisticUI) {\n+          // We are using fake IDs generated by the Optimistic UI\n+          this.chatsService.addChat$.subscribe(({data: {addChat, addGroup}}) => {\n+            this.chatId = addChat ? addChat.id : addGroup.id;\n+            console.log(`Switching from the Optimistic UI id ${chatId} to ${this.chatId}`);\n+            // Rewrite the URL\n+            this.location.go(`chat/${this.chatId}`);\n+            // Optimistic UI no more\n+            this.optimisticUI = false;\n+          });\n+        }\n+\n+        this.chatsService.getChat(chatId, this.optimisticUI).chat$.subscribe(chat => {\n+          this.messages = chat.messages;\n+          this.name = chat.name;\n+          this.isGroup = chat.isGroup;\n+        });\n+      });\n+  }\n+\n+  goToChats() {\n+    this.router.navigate(['/chats']);\n+  }\n+\n+  addMessage(content: string) {\n+    this.chatsService.addMessage(this.chatId, content).subscribe();\n+  }\n+\n+  deleteMessages(messageIds: string[]) {\n+    this.chatsService.removeMessages(this.chatId, this.messages, messageIds).subscribe();\n+  }\n+}\ndiff --git a/client/src/app/chats-creation/chats-creation.module.ts b/client/src/app/chats-creation/chats-creation.module.ts\nnew file mode 100644\nindex 0000000..f8a9754\n--- /dev/null\n+++ b/client/src/app/chats-creation/chats-creation.module.ts\n@@ -0,0 +1,61 @@\n+import { BrowserModule } from '@angular/platform-browser';\n+import { NgModule } from '@angular/core';\n+\n+import {BrowserAnimationsModule} from '@angular/platform-browser/animations';\n+import {\n+  MatButtonModule, MatFormFieldModule, MatGridListModule, MatIconModule, MatInputModule, MatListModule, MatMenuModule,\n+  MatToolbarModule\n+} from '@angular/material';\n+import {RouterModule, Routes} from '@angular/router';\n+import {FormsModule} from '@angular/forms';\n+import {ChatsService} from '../services/chats.service';\n+import {UserItemComponent} from './components/user-item/user-item.component';\n+import {UsersListComponent} from './components/users-list/users-list.component';\n+import {NewGroupComponent} from './containers/new-group/new-group.component';\n+import {NewChatComponent} from './containers/new-chat/new-chat.component';\n+import {NewGroupDetailsComponent} from './components/new-group-details/new-group-details.component';\n+import {SharedModule} from '../shared/shared.module';\n+import {SelectableListModule} from 'ngx-selectable-list';\n+import {AuthGuard} from '../login/services/auth.guard';\n+\n+const routes: Routes = [\n+  {path: 'new-chat', canActivate: [AuthGuard], component: NewChatComponent},\n+  {path: 'new-group', canActivate: [AuthGuard], component: NewGroupComponent},\n+];\n+\n+@NgModule({\n+  declarations: [\n+    NewChatComponent,\n+    UsersListComponent,\n+    NewGroupComponent,\n+    UserItemComponent,\n+    NewGroupDetailsComponent,\n+  ],\n+  imports: [\n+    BrowserModule,\n+    // Animations (for Material)\n+    BrowserAnimationsModule,\n+    // Material\n+    MatToolbarModule,\n+    MatMenuModule,\n+    MatIconModule,\n+    MatButtonModule,\n+    MatListModule,\n+    MatGridListModule,\n+    MatInputModule,\n+    MatFormFieldModule,\n+    MatGridListModule,\n+    // Routing\n+    RouterModule.forChild(routes),\n+    // Forms\n+    FormsModule,\n+    // Feature modules\n+    SelectableListModule,\n+    SharedModule,\n+  ],\n+  providers: [\n+    ChatsService,\n+  ],\n+})\n+export class ChatsCreationModule {\n+}\ndiff --git a/client/src/app/chats-creation/components/new-group-details/new-group-details.component.scss b/client/src/app/chats-creation/components/new-group-details/new-group-details.component.scss\nnew file mode 100644\nindex 0000000..458b376\n--- /dev/null\n+++ b/client/src/app/chats-creation/components/new-group-details/new-group-details.component.scss\n@@ -0,0 +1,25 @@\n+:host {\n+  display: block;\n+}\n+\n+div {\n+  padding: 16px;\n+  mat-form-field {\n+    width: 100%;\n+  }\n+}\n+\n+.new-group {\n+  position: absolute;\n+  bottom: 5vw;\n+  right: 5vw;\n+}\n+\n+.users {\n+  display: flex;\n+  flex-flow: row wrap;\n+  img {\n+    flex: 0 1 8vh;\n+    height: 8vh;\n+  }\n+}\ndiff --git a/client/src/app/chats-creation/components/new-group-details/new-group-details.component.ts b/client/src/app/chats-creation/components/new-group-details/new-group-details.component.ts\nnew file mode 100644\nindex 0000000..dd6554c\n--- /dev/null\n+++ b/client/src/app/chats-creation/components/new-group-details/new-group-details.component.ts\n@@ -0,0 +1,34 @@\n+import {Component, EventEmitter, Input, Output} from '@angular/core';\n+import {GetUsers} from '../../../../types';\n+\n+@Component({\n+  selector: 'app-new-group-details',\n+  template: `\n+    <div>\n+      <mat-form-field>\n+        <input matInput placeholder=\"Group name\" [(ngModel)]=\"groupName\">\n+      </mat-form-field>\n+    </div>\n+    <button [disabled]=\"!groupName\" class=\"new-group\" mat-fab color=\"primary\" (click)=\"emitGroupDetails()\">\n+      <mat-icon aria-label=\"Icon-button with a + icon\">arrow_forward</mat-icon>\n+    </button>\n+    <div>Members</div>\n+    <div class=\"users\">\n+      <img *ngFor=\"let user of users;\" [src]=\"user.picture\"/>\n+    </div>\n+  `,\n+  styleUrls: ['new-group-details.component.scss'],\n+})\n+export class NewGroupDetailsComponent {\n+  groupName: string;\n+  @Input()\n+  users: GetUsers.Users[];\n+  @Output()\n+  groupDetails = new EventEmitter<string>();\n+\n+  emitGroupDetails() {\n+    if (this.groupDetails) {\n+      this.groupDetails.emit(this.groupName);\n+    }\n+  }\n+}\ndiff --git a/client/src/app/chats-creation/components/user-item/user-item.component.scss b/client/src/app/chats-creation/components/user-item/user-item.component.scss\nnew file mode 100644\nindex 0000000..9d7b0cf\n--- /dev/null\n+++ b/client/src/app/chats-creation/components/user-item/user-item.component.scss\n@@ -0,0 +1,28 @@\n+:host {\n+  display: block;\n+  width: 100%;\n+  height: 100%;\n+}\n+\n+button {\n+  padding: 0;\n+  display: flex;\n+  align-items: center;\n+  height: 100%;\n+  width: 100%;\n+  border: none;\n+\n+  div:first-of-type {\n+    display: flex;\n+    justify-content: center;\n+    align-items: center;\n+\n+    img {\n+      max-width: 100%;\n+    }\n+  }\n+\n+  div:nth-of-type(2) {\n+    padding-left: 16px;\n+  }\n+}\ndiff --git a/client/src/app/chats-creation/components/user-item/user-item.component.ts b/client/src/app/chats-creation/components/user-item/user-item.component.ts\nnew file mode 100644\nindex 0000000..75257e1\n--- /dev/null\n+++ b/client/src/app/chats-creation/components/user-item/user-item.component.ts\n@@ -0,0 +1,20 @@\n+import {Component, Input} from '@angular/core';\n+import {GetUsers} from '../../../../types';\n+\n+@Component({\n+  selector: 'app-user-item',\n+  template: `\n+    <button mat-menu-item>\n+      <div>\n+        <img [src]=\"user.picture\" *ngIf=\"user.picture\">\n+      </div>\n+      <div>{{ user.name }}</div>\n+    </button>\n+  `,\n+  styleUrls: ['user-item.component.scss']\n+})\n+export class UserItemComponent {\n+  // tslint:disable-next-line:no-input-rename\n+  @Input('item')\n+  user: GetUsers.Users;\n+}\ndiff --git a/client/src/app/chats-creation/components/users-list/users-list.component.scss b/client/src/app/chats-creation/components/users-list/users-list.component.scss\nnew file mode 100644\nindex 0000000..5d4e87f\n--- /dev/null\n+++ b/client/src/app/chats-creation/components/users-list/users-list.component.scss\n@@ -0,0 +1,3 @@\n+:host {\n+  display: block;\n+}\ndiff --git a/client/src/app/chats-creation/components/users-list/users-list.component.ts b/client/src/app/chats-creation/components/users-list/users-list.component.ts\nnew file mode 100644\nindex 0000000..96d5421\n--- /dev/null\n+++ b/client/src/app/chats-creation/components/users-list/users-list.component.ts\n@@ -0,0 +1,24 @@\n+import {Component, Input} from '@angular/core';\n+import {GetUsers} from '../../../../types';\n+import {SelectableListDirective} from 'ngx-selectable-list';\n+\n+@Component({\n+  selector: 'app-users-list',\n+  template: `\n+    <mat-list>\n+      <mat-list-item *ngFor=\"let user of users\">\n+        <app-user-item [item]=\"user\"\n+                       appSelectableItem></app-user-item>\n+      </mat-list-item>\n+    </mat-list>\n+    <ng-content *ngIf=\"selectableListDirective.selecting\"></ng-content>\n+  `,\n+  styleUrls: ['users-list.component.scss'],\n+})\n+export class UsersListComponent {\n+  // tslint:disable-next-line:no-input-rename\n+  @Input('items')\n+  users: GetUsers.Users[];\n+\n+  constructor(public selectableListDirective: SelectableListDirective) {}\n+}\ndiff --git a/client/src/app/chats-creation/containers/new-chat/new-chat.component.scss b/client/src/app/chats-creation/containers/new-chat/new-chat.component.scss\nnew file mode 100644\nindex 0000000..ec7b4f8\n--- /dev/null\n+++ b/client/src/app/chats-creation/containers/new-chat/new-chat.component.scss\n@@ -0,0 +1,23 @@\n+.new-group {\n+  display: flex;\n+  height: 8vh;\n+  align-items: center;\n+\n+  div:first-of-type {\n+    height: 8vh;\n+    width: 8vh;\n+    display: flex;\n+    justify-content: center;\n+    align-items: center;\n+\n+    mat-icon {\n+      height: 5vh;\n+      width: 5vh;\n+      font-size: 5vh;\n+    }\n+  }\n+\n+  div:nth-of-type(2) {\n+    padding: 16px;\n+  }\n+}\ndiff --git a/client/src/app/chats-creation/containers/new-chat/new-chat.component.ts b/client/src/app/chats-creation/containers/new-chat/new-chat.component.ts\nnew file mode 100644\nindex 0000000..91820c8\n--- /dev/null\n+++ b/client/src/app/chats-creation/containers/new-chat/new-chat.component.ts\n@@ -0,0 +1,60 @@\n+import {Component, OnInit} from '@angular/core';\n+import {Location} from '@angular/common';\n+import {Router} from '@angular/router';\n+import {AddChat, GetUsers} from '../../../../types';\n+import {ChatsService} from '../../../services/chats.service';\n+\n+@Component({\n+  template: `\n+    <app-toolbar>\n+      <button class=\"navigation\" mat-button (click)=\"goBack()\">\n+        <mat-icon aria-label=\"Icon-button with an arrow back icon\">arrow_back</mat-icon>\n+      </button>\n+      <div class=\"title\">New chat</div>\n+    </app-toolbar>\n+\n+    <div class=\"new-group\" (click)=\"goToNewGroup()\">\n+      <div>\n+        <mat-icon aria-label=\"Icon-button with a group add icon\">group_add</mat-icon>\n+      </div>\n+      <div>New group</div>\n+    </div>\n+\n+    <app-users-list [items]=\"users\"\n+                    appSelectableList=\"single\" (single)=\"addChat($event)\">\n+    </app-users-list>\n+  `,\n+  styleUrls: ['new-chat.component.scss'],\n+})\n+export class NewChatComponent implements OnInit {\n+  users: GetUsers.Users[];\n+\n+  constructor(private router: Router,\n+              private location: Location,\n+              private chatsService: ChatsService) {}\n+\n+  ngOnInit () {\n+    this.chatsService.getUsers().users$.subscribe(users => this.users = users);\n+  }\n+\n+  goBack() {\n+    this.location.back();\n+  }\n+\n+  goToNewGroup() {\n+    this.router.navigate(['/new-group']);\n+  }\n+\n+  addChat(recipientId: string) {\n+    const chatId = this.chatsService.getChatId(recipientId);\n+    if (chatId) {\n+      // Chat is already listed for the current user\n+      this.router.navigate(['/chat', chatId]);\n+    } else {\n+      // Generate id for Optimistic UI\n+      const ouiId = ChatsService.getRandomId();\n+      this.chatsService.addChat(recipientId, this.users, ouiId).subscribe();\n+      this.router.navigate(['/chat', ouiId], {queryParams: {oui: true}, skipLocationChange: true});\n+    }\n+  }\n+}\ndiff --git a/client/src/app/chats-creation/containers/new-group/new-group.component.scss b/client/src/app/chats-creation/containers/new-group/new-group.component.scss\nnew file mode 100644\nindex 0000000..e69de29\ndiff --git a/client/src/app/chats-creation/containers/new-group/new-group.component.ts b/client/src/app/chats-creation/containers/new-group/new-group.component.ts\nnew file mode 100644\nindex 0000000..19e9fb9\n--- /dev/null\n+++ b/client/src/app/chats-creation/containers/new-group/new-group.component.ts\n@@ -0,0 +1,60 @@\n+import {Component, OnInit} from '@angular/core';\n+import {Location} from '@angular/common';\n+import {Router} from '@angular/router';\n+import {AddGroup, GetUsers} from '../../../../types';\n+import {ChatsService} from '../../../services/chats.service';\n+\n+@Component({\n+  template: `\n+    <app-toolbar>\n+      <button class=\"navigation\" mat-button (click)=\"goBack()\">\n+        <mat-icon aria-label=\"Icon-button with an arrow back icon\">arrow_back</mat-icon>\n+      </button>\n+      <div class=\"title\">New group</div>\n+    </app-toolbar>\n+\n+    <app-users-list *ngIf=\"!recipientIds.length\" [items]=\"users\"\n+                    appSelectableList=\"multiple_tap\" (multiple)=\"selectUsers($event)\">\n+      <app-confirm-selection #confirmSelection icon=\"arrow_forward\"></app-confirm-selection>\n+    </app-users-list>\n+    <app-new-group-details *ngIf=\"recipientIds.length\" [users]=\"getSelectedUsers()\"\n+                           (groupDetails)=\"addGroup($event)\"></app-new-group-details>\n+  `,\n+  styleUrls: ['new-group.component.scss'],\n+})\n+export class NewGroupComponent implements OnInit {\n+  users: GetUsers.Users[];\n+  recipientIds: string[] = [];\n+\n+  constructor(private router: Router,\n+              private location: Location,\n+              private chatsService: ChatsService) {}\n+\n+  ngOnInit () {\n+    this.chatsService.getUsers().users$.subscribe(users => this.users = users);\n+  }\n+\n+  goBack() {\n+    if (this.recipientIds.length) {\n+      this.recipientIds = [];\n+    } else {\n+      this.location.back();\n+    }\n+  }\n+\n+  selectUsers(recipientIds: string[]) {\n+    this.recipientIds = recipientIds;\n+  }\n+\n+  getSelectedUsers() {\n+    return this.users.filter(user => this.recipientIds.includes(user.id));\n+  }\n+\n+  addGroup(groupName: string) {\n+    if (groupName && this.recipientIds.length) {\n+      const ouiId = ChatsService.getRandomId();\n+      this.chatsService.addGroup(this.recipientIds, groupName, ouiId).subscribe();\n+      this.router.navigate(['/chat', ouiId], {queryParams: {oui: true}, skipLocationChange: true});\n+    }\n+  }\n+}\ndiff --git a/client/src/app/chats-lister/chats-lister.module.ts b/client/src/app/chats-lister/chats-lister.module.ts\nnew file mode 100644\nindex 0000000..0e86163\n--- /dev/null\n+++ b/client/src/app/chats-lister/chats-lister.module.ts\n@@ -0,0 +1,52 @@\n+import { BrowserModule } from '@angular/platform-browser';\n+import { NgModule } from '@angular/core';\n+\n+import {BrowserAnimationsModule} from '@angular/platform-browser/animations';\n+import {MatButtonModule, MatIconModule, MatListModule, MatMenuModule} from '@angular/material';\n+import {RouterModule, Routes} from '@angular/router';\n+import {FormsModule} from '@angular/forms';\n+import {ChatsService} from '../services/chats.service';\n+import {ChatItemComponent} from './components/chat-item/chat-item.component';\n+import {ChatsComponent} from './containers/chats/chats.component';\n+import {ChatsListComponent} from './components/chats-list/chats-list.component';\n+import {TruncateModule} from 'ng2-truncate';\n+import {SharedModule} from '../shared/shared.module';\n+import {SelectableListModule} from 'ngx-selectable-list';\n+import {AuthGuard} from '../login/services/auth.guard';\n+\n+const routes: Routes = [\n+  {path: '', redirectTo: 'chats', pathMatch: 'full'},\n+  {path: 'chats', canActivate: [AuthGuard], component: ChatsComponent},\n+];\n+\n+@NgModule({\n+  declarations: [\n+    ChatsComponent,\n+    ChatsListComponent,\n+    ChatItemComponent,\n+  ],\n+  imports: [\n+    BrowserModule,\n+    // Material\n+    MatMenuModule,\n+    MatIconModule,\n+    MatButtonModule,\n+    MatListModule,\n+    // Animations\n+    BrowserAnimationsModule,\n+    // Routing\n+    RouterModule.forChild(routes),\n+    // Forms\n+    FormsModule,\n+    // Truncate Pipe\n+    TruncateModule,\n+    // Feature modules\n+    SharedModule,\n+    SelectableListModule,\n+  ],\n+  providers: [\n+    ChatsService,\n+  ],\n+})\n+export class ChatsListerModule {\n+}\ndiff --git a/client/src/app/chats-lister/components/chat-item/chat-item.component.scss b/client/src/app/chats-lister/components/chat-item/chat-item.component.scss\nnew file mode 100644\nindex 0000000..78a5e41\n--- /dev/null\n+++ b/client/src/app/chats-lister/components/chat-item/chat-item.component.scss\n@@ -0,0 +1,17 @@\n+:host {\n+  display: block;\n+  width: 100%;\n+}\n+\n+.chat-row {\n+  padding: 0;\n+  display: flex;\n+  width: 100%;\n+  justify-content: space-between;\n+  align-items: center;\n+\n+  .chat-recipient {\n+    display: flex;\n+    width: 60%;\n+  }\n+}\ndiff --git a/client/src/app/chats-lister/components/chat-item/chat-item.component.spec.ts b/client/src/app/chats-lister/components/chat-item/chat-item.component.spec.ts\nnew file mode 100644\nindex 0000000..8dc38a0\n--- /dev/null\n+++ b/client/src/app/chats-lister/components/chat-item/chat-item.component.spec.ts\n@@ -0,0 +1,107 @@\n+import { async, ComponentFixture, TestBed } from '@angular/core/testing';\n+\n+import { ChatItemComponent } from './chat-item.component';\n+import {DebugElement} from '@angular/core';\n+import {By} from '@angular/platform-browser';\n+import {TruncateModule} from 'ng2-truncate';\n+\n+describe('ChatItemComponent', () => {\n+  let component: ChatItemComponent;\n+  let fixture: ComponentFixture<ChatItemComponent>;\n+  let el: DebugElement;\n+\n+  const chat: any = {\n+    id: '1',\n+    __typename: 'Chat',\n+    name: 'Niccolo\\' Belli',\n+    picture: null,\n+    allTimeMembers: [\n+      {\n+        id: '1',\n+        __typename: 'User',\n+      },\n+      {\n+        id: '2',\n+        __typename: 'User',\n+      }\n+    ],\n+    unreadMessages: 0,\n+    isGroup: false,\n+    messages: [\n+      {\n+        id: '1',\n+        chat: {\n+          id: '1',\n+          __typename: 'Chat',\n+        },\n+        __typename: 'Message',\n+        sender: {\n+          id: '1',\n+          __typename: 'User',\n+          name: 'Niccolo\\' Belli',\n+        },\n+        content: 'Hello! How are you? A lot happened since last time',\n+        createdAt: '1513435525',\n+        type: 1,\n+        recipients: [\n+          {\n+            user: {\n+              id: '2',\n+              __typename: 'User',\n+            },\n+            message: {\n+              id: '1',\n+              __typename: 'Message',\n+              chat: {\n+                id: '1',\n+                __typename: 'Chat',\n+              },\n+            },\n+            __typename: 'Recipient',\n+            chat: {\n+              id: '1',\n+              __typename: 'Chat',\n+            },\n+            receivedAt: null,\n+            readAt: null,\n+          }\n+        ],\n+        ownership: true,\n+      }\n+    ],\n+  };\n+\n+  beforeEach(async(() => {\n+    TestBed.configureTestingModule({\n+      declarations: [ ChatItemComponent ],\n+      imports: [TruncateModule]\n+    })\n+    .compileComponents();\n+  }));\n+\n+  beforeEach(() => {\n+    fixture = TestBed.createComponent(ChatItemComponent);\n+    component = fixture.componentInstance;\n+    component.chat = chat;\n+    fixture.detectChanges();\n+    el = fixture.debugElement;\n+  });\n+\n+  it('should create', () => {\n+    expect(component).toBeTruthy();\n+  });\n+\n+  it('should contain the chat name', () => {\n+    expect(el.query(By.css('.chat-recipient > div:first-child')).nativeElement.textContent).toContain(chat.name);\n+  });\n+\n+  it('should contain the first couple of characters of the message content', () => {\n+    expect(el.query(By.css('.chat-content')).nativeElement.textContent)\n+      .toContain(chat.messages[chat.messages.length - 1].content.slice(0, 20));\n+  });\n+\n+  it('should not contain the latest characters of the message content', () => {\n+    expect(el.query(By.css('.chat-content')).nativeElement.textContent)\n+      .not.toContain(chat.messages[chat.messages.length - 1].content.slice(20));\n+  });\n+});\ndiff --git a/client/src/app/chats-lister/components/chat-item/chat-item.component.ts b/client/src/app/chats-lister/components/chat-item/chat-item.component.ts\nnew file mode 100644\nindex 0000000..afd5b1d\n--- /dev/null\n+++ b/client/src/app/chats-lister/components/chat-item/chat-item.component.ts\n@@ -0,0 +1,21 @@\n+import {Component, EventEmitter, Input, Output} from '@angular/core';\n+import {GetChats} from '../../../../types';\n+\n+@Component({\n+  selector: 'app-chat-item',\n+  template: `\n+    <div class=\"chat-row\">\n+        <div class=\"chat-recipient\">\n+          <img *ngIf=\"chat.picture\" [src]=\"chat.picture\" width=\"48\" height=\"48\">\n+          <div>{{ chat.name }} [id: {{ chat.id }}]</div>\n+        </div>\n+        <div class=\"chat-content\">{{ chat.messages[chat.messages.length - 1]?.content | truncate : 20 : '...' }}</div>\n+    </div>\n+  `,\n+  styleUrls: ['chat-item.component.scss'],\n+})\n+export class ChatItemComponent {\n+  // tslint:disable-next-line:no-input-rename\n+  @Input('item')\n+  chat: GetChats.Chats;\n+}\ndiff --git a/client/src/app/chats-lister/components/chats-list/chats-list.component.scss b/client/src/app/chats-lister/components/chats-list/chats-list.component.scss\nnew file mode 100644\nindex 0000000..5d4e87f\n--- /dev/null\n+++ b/client/src/app/chats-lister/components/chats-list/chats-list.component.scss\n@@ -0,0 +1,3 @@\n+:host {\n+  display: block;\n+}\ndiff --git a/client/src/app/chats-lister/components/chats-list/chats-list.component.ts b/client/src/app/chats-lister/components/chats-list/chats-list.component.ts\nnew file mode 100644\nindex 0000000..161d07c\n--- /dev/null\n+++ b/client/src/app/chats-lister/components/chats-list/chats-list.component.ts\n@@ -0,0 +1,24 @@\n+import {Component, Input} from '@angular/core';\n+import {GetChats} from '../../../../types';\n+import {SelectableListDirective} from 'ngx-selectable-list';\n+\n+@Component({\n+  selector: 'app-chats-list',\n+  template: `\n+    <mat-list>\n+      <mat-list-item *ngFor=\"let chat of chats\">\n+        <app-chat-item [item]=\"chat\"\n+                       appSelectableItem></app-chat-item>\n+      </mat-list-item>\n+    </mat-list>\n+    <ng-content *ngIf=\"selectableListDirective.selecting\"></ng-content>\n+  `,\n+  styleUrls: ['chats-list.component.scss'],\n+})\n+export class ChatsListComponent {\n+  // tslint:disable-next-line:no-input-rename\n+  @Input('items')\n+  chats: GetChats.Chats[];\n+\n+  constructor(public selectableListDirective: SelectableListDirective) {}\n+}\ndiff --git a/client/src/app/chats-lister/containers/chats/chats.component.scss b/client/src/app/chats-lister/containers/chats/chats.component.scss\nnew file mode 100644\nindex 0000000..79e6e09\n--- /dev/null\n+++ b/client/src/app/chats-lister/containers/chats/chats.component.scss\n@@ -0,0 +1,5 @@\n+.chat-button {\n+  position: absolute;\n+  bottom: 5vw;\n+  right: 5vw;\n+}\ndiff --git a/client/src/app/chats-lister/containers/chats/chats.component.spec.ts b/client/src/app/chats-lister/containers/chats/chats.component.spec.ts\nnew file mode 100644\nindex 0000000..0377385\n--- /dev/null\n+++ b/client/src/app/chats-lister/containers/chats/chats.component.spec.ts\n@@ -0,0 +1,393 @@\n+import { async, ComponentFixture, TestBed } from '@angular/core/testing';\n+\n+import { ChatsComponent } from './chats.component';\n+import {DebugElement, NO_ERRORS_SCHEMA} from '@angular/core';\n+import {ChatsListComponent} from '../../components/chats-list/chats-list.component';\n+import {ChatItemComponent} from '../../components/chat-item/chat-item.component';\n+import {TruncateModule} from 'ng2-truncate';\n+import {MatButtonModule, MatIconModule, MatListModule, MatMenuModule} from '@angular/material';\n+import {ChatsService} from '../../../services/chats.service';\n+import {Apollo} from 'apollo-angular';\n+import {HttpClientTestingModule, HttpTestingController} from '@angular/common/http/testing';\n+import {HttpLink, HttpLinkModule, Options} from 'apollo-angular-link-http';\n+import {defaultDataIdFromObject, InMemoryCache} from 'apollo-cache-inmemory';\n+import {By} from '@angular/platform-browser';\n+import {RouterTestingModule} from '@angular/router/testing';\n+import {SelectableListModule} from 'ngx-selectable-list';\n+import {LoginService} from '../../../login/services/login.service';\n+\n+describe('ChatsComponent', () => {\n+  let component: ChatsComponent;\n+  let fixture: ComponentFixture<ChatsComponent>;\n+  let el: DebugElement;\n+\n+  let httpMock: HttpTestingController;\n+  let httpLink: HttpLink;\n+  let apollo: Apollo;\n+\n+  const chats: any = [\n+    {\n+      id: '1',\n+      __typename: 'Chat',\n+      name: 'Avery Stewart',\n+      picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n+      allTimeMembers: [\n+        {\n+          id: '1',\n+          __typename: 'User',\n+        },\n+        {\n+          id: '3',\n+          __typename: 'User',\n+        }\n+      ],\n+      unreadMessages: 1,\n+      isGroup: false,\n+      messages: [\n+        {\n+          id: '1',\n+          chat: {\n+            id: '1',\n+            __typename: 'Chat',\n+          },\n+          __typename: 'Message',\n+          sender: {\n+            id: '3',\n+            __typename: 'User',\n+            name: 'Avery Stewart'\n+          },\n+          content: 'Yep!',\n+          createdAt: '1514035700',\n+          type: 0,\n+          recipients: [\n+            {\n+              user: {\n+                id: '1',\n+                __typename: 'User',\n+              },\n+              message: {\n+                id: '1',\n+                __typename: 'Message',\n+                chat: {\n+                  id: '1',\n+                  __typename: 'Chat',\n+                },\n+              },\n+              __typename: 'Recipient',\n+              chat: {\n+                id: '1',\n+                __typename: 'Chat',\n+              },\n+              receivedAt: null,\n+              readAt: null,\n+            }\n+          ],\n+          ownership: false,\n+        }\n+      ],\n+    },\n+    {\n+      id: '2',\n+      __typename: 'Chat',\n+      name: 'Katie Peterson',\n+      picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n+      allTimeMembers: [\n+        {\n+          id: '1',\n+          __typename: 'User',\n+        },\n+        {\n+          id: '4',\n+          __typename: 'User',\n+        }\n+      ],\n+      unreadMessages: 0,\n+      isGroup: false,\n+      messages: [\n+        {\n+          id: '1',\n+          chat: {\n+            id: '2',\n+            __typename: 'Chat',\n+          },\n+          __typename: 'Message',\n+          sender: {\n+            id: '1',\n+            __typename: 'User',\n+            name: 'Ethan Gonzalez'\n+          },\n+          content: 'Hey, it\\'s me',\n+          createdAt: '1514031800',\n+          type: 0,\n+          recipients: [\n+            {\n+              user: {\n+                id: '4',\n+                __typename: 'User',\n+              },\n+              message: {\n+                id: '1',\n+                __typename: 'Message',\n+                chat: {\n+                  id: '2',\n+                  __typename: 'Chat',\n+                },\n+              },\n+              __typename: 'Recipient',\n+              chat: {\n+                id: '2',\n+                __typename: 'Chat',\n+              },\n+              receivedAt: null,\n+              readAt: null,\n+            }\n+          ],\n+          ownership: true\n+        }\n+      ],\n+    },\n+    {\n+      id: '3',\n+      __typename: 'Chat',\n+      name: 'Ray Edwards',\n+      picture: 'https://randomuser.me/api/portraits/thumb/men/3.jpg',\n+      allTimeMembers: [\n+        {\n+          id: '1',\n+          __typename: 'User',\n+        },\n+        {\n+          id: '5',\n+          __typename: 'User',\n+        }\n+      ],\n+      unreadMessages: 0,\n+      isGroup: false,\n+      messages: [\n+        {\n+          id: '1',\n+          __typename: 'Message',\n+          chat: {\n+            id: '3',\n+            __typename: 'Chat',\n+          },\n+          sender: {\n+            id: '1',\n+            __typename: 'User',\n+            name: 'Ethan Gonzalez'\n+          },\n+          content: 'You still there?',\n+          createdAt: '1514010200',\n+          type: 0,\n+          recipients: [\n+            {\n+              user: {\n+                id: '5',\n+                __typename: 'User',\n+              },\n+              message: {\n+                id: '1',\n+                __typename: 'Message',\n+                chat: {\n+                  id: '3',\n+                  __typename: 'Chat',\n+                },\n+              },\n+              __typename: 'Recipient',\n+              chat: {\n+                id: '3',\n+                __typename: 'Chat',\n+              },\n+              receivedAt: null,\n+              readAt: null\n+            }\n+          ],\n+          ownership: true\n+        }\n+      ],\n+    },\n+    {\n+      id: '6',\n+      __typename: 'Chat',\n+      name: 'Niccolò Belli',\n+      picture: 'https://randomuser.me/api/portraits/thumb/men/4.jpg',\n+      allTimeMembers: [\n+        {\n+          id: '1',\n+          __typename: 'User',\n+        },\n+        {\n+          id: '6',\n+          __typename: 'User',\n+        }\n+      ],\n+      unreadMessages: 0,\n+      messages: [],\n+      isGroup: false\n+    },\n+    {\n+      id: '8',\n+      __typename: 'Chat',\n+      name: 'A user 0 group',\n+      picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n+      allTimeMembers: [\n+        {\n+          id: '1',\n+          __typename: 'User',\n+        },\n+        {\n+          id: '3',\n+          __typename: 'User',\n+        },\n+        {\n+          id: '4',\n+          __typename: 'User',\n+        },\n+        {\n+          id: '6',\n+          __typename: 'User',\n+        },\n+      ],\n+      unreadMessages: 1,\n+      isGroup: true,\n+      messages: [\n+        {\n+          id: '1',\n+          __typename: 'Message',\n+          chat: {\n+            id: '8',\n+            __typename: 'Chat',\n+          },\n+          sender: {\n+            id: '4',\n+            __typename: 'User',\n+            name: 'Katie Peterson'\n+          },\n+          content: 'Awesome!',\n+          createdAt: '1512830000',\n+          type: 0,\n+          recipients: [\n+            {\n+              user: {\n+                id: '1',\n+                __typename: 'User',\n+              },\n+              message: {\n+                id: '1',\n+                __typename: 'Message',\n+                chat: {\n+                  id: '8',\n+                  __typename: 'Chat',\n+                },\n+              },\n+              __typename: 'Recipient',\n+              chat: {\n+                id: '8',\n+                __typename: 'Chat',\n+              },\n+              receivedAt: null,\n+              readAt: null\n+            },\n+            {\n+              user: {\n+                id: '6',\n+                __typename: 'User',\n+              },\n+              message: {\n+                id: '1',\n+                __typename: 'Message',\n+                chat: {\n+                  id: '8',\n+                  __typename: 'Chat',\n+                },\n+              },\n+              __typename: 'Recipient',\n+              chat: {\n+                id: '8',\n+                __typename: 'Chat',\n+              },\n+              receivedAt: null,\n+              readAt: null\n+            }\n+          ],\n+          ownership: false\n+        }\n+      ],\n+    },\n+  ];\n+\n+  beforeEach(async(() => {\n+    TestBed.configureTestingModule({\n+      declarations: [\n+        ChatsComponent,\n+        ChatsListComponent,\n+        ChatItemComponent\n+      ],\n+      imports: [\n+        MatMenuModule,\n+        MatIconModule,\n+        MatButtonModule,\n+        MatListModule,\n+        TruncateModule,\n+        HttpLinkModule,\n+        HttpClientTestingModule,\n+        RouterTestingModule,\n+        SelectableListModule,\n+      ],\n+      providers: [\n+        ChatsService,\n+        Apollo,\n+        LoginService,\n+      ],\n+      schemas: [NO_ERRORS_SCHEMA]\n+    })\n+      .compileComponents();\n+\n+    httpMock = TestBed.get(HttpTestingController);\n+    httpLink = TestBed.get(HttpLink);\n+    apollo = TestBed.get(Apollo);\n+\n+    apollo.create({\n+      link: httpLink.create(<Options>{ uri: 'http://localhost:3000/graphql' }),\n+      cache: new InMemoryCache({\n+        dataIdFromObject: (object: any) => {\n+          switch (object.__typename) {\n+            case 'Message': return `${object.chat.id}:${object.id}`; // use `chatId` prefix and `messageId` as the primary key\n+            default: return defaultDataIdFromObject(object); // fall back to default handling\n+          }\n+        }\n+      }),\n+    });\n+  }));\n+\n+  beforeEach(() => {\n+    fixture = TestBed.createComponent(ChatsComponent);\n+    component = fixture.componentInstance;\n+    fixture.detectChanges();\n+    httpMock.expectOne(httpReq => httpReq.body.operationName === 'chatAdded', 'call to chatAdded api');\n+    httpMock.expectOne(httpReq => httpReq.body.operationName === 'messageAdded', 'call to messageAdded api');\n+    const req = httpMock.expectOne(httpReq => httpReq.body.operationName === 'GetChats', 'call to getChats api');\n+    req.flush({\n+      data: {\n+        chats\n+      }\n+    });\n+  });\n+\n+  it('should create', () => {\n+    expect(component).toBeTruthy();\n+  });\n+\n+  it('should display the chats', () => {\n+    fixture.whenStable().then(() => {\n+      fixture.detectChanges();\n+      el = fixture.debugElement;\n+      for (let i = 0; i < chats.length; i++) {\n+        expect(el.query(By.css(`app-chats-list > mat-list > mat-list-item:nth-child(${i + 1}) > div > app-chat-item > div > div > div`))\n+          .nativeElement.textContent).toContain(chats[i].name);\n+      }\n+    });\n+\n+    httpMock.verify();\n+  });\n+});\ndiff --git a/client/src/app/chats-lister/containers/chats/chats.component.ts b/client/src/app/chats-lister/containers/chats/chats.component.ts\nnew file mode 100644\nindex 0000000..69ce46c\n--- /dev/null\n+++ b/client/src/app/chats-lister/containers/chats/chats.component.ts\n@@ -0,0 +1,68 @@\n+import {Component, OnInit} from '@angular/core';\n+import {ChatsService} from '../../../services/chats.service';\n+import {Observable} from 'rxjs/Observable';\n+import {GetChats} from '../../../../types';\n+import {Router} from '@angular/router';\n+\n+@Component({\n+  template: `\n+    <app-toolbar>\n+      <div class=\"title\">Whatsapp Clone</div>\n+      <button mat-icon-button [matMenuTriggerFor]=\"menu\" class=\"menu\">\n+        <mat-icon>more_vert</mat-icon>\n+      </button>\n+    </app-toolbar>\n+\n+    <mat-menu #menu=\"matMenu\">\n+      <button mat-menu-item>\n+        <mat-icon>dialpad</mat-icon>\n+        <span>Redial</span>\n+      </button>\n+      <button mat-menu-item disabled>\n+        <mat-icon>voicemail</mat-icon>\n+        <span>Check voicemail</span>\n+      </button>\n+      <button mat-menu-item>\n+        <mat-icon>notifications_off</mat-icon>\n+        <span>Disable alerts</span>\n+      </button>\n+    </mat-menu>\n+\n+    <app-chats-list [items]=\"chats$ | async\"\n+                    appSelectableList=\"both\"\n+                    (single)=\"goToChat($event)\" (multiple)=\"deleteChats($event)\" (isSelecting)=\"isSelecting = $event\">\n+      <app-confirm-selection #confirmSelection></app-confirm-selection>\n+    </app-chats-list>\n+\n+    <button *ngIf=\"!isSelecting\" class=\"chat-button\" mat-fab color=\"primary\" (click)=\"goToNewChat()\">\n+      <mat-icon aria-label=\"Icon-button with a + icon\">add</mat-icon>\n+    </button>\n+  `,\n+  styleUrls: ['./chats.component.scss'],\n+})\n+export class ChatsComponent implements OnInit {\n+  chats$: Observable<GetChats.Chats[]>;\n+  isSelecting = false;\n+\n+  constructor(private chatsService: ChatsService,\n+              private router: Router) {\n+  }\n+\n+  ngOnInit() {\n+    this.chats$ = this.chatsService.getChats().chats$;\n+  }\n+\n+  goToChat(chatId: string) {\n+    this.router.navigate(['/chat', chatId]);\n+  }\n+\n+  goToNewChat() {\n+    this.router.navigate(['/new-chat']);\n+  }\n+\n+  deleteChats(chatIds: string[]) {\n+    chatIds.forEach(chatId => {\n+      this.chatsService.removeChat(chatId).subscribe();\n+    });\n+  }\n+}\ndiff --git a/client/src/app/login/containers/login.component.scss b/client/src/app/login/containers/login.component.scss\nnew file mode 100644\nindex 0000000..1897a22\n--- /dev/null\n+++ b/client/src/app/login/containers/login.component.scss\n@@ -0,0 +1,18 @@\n+:host {\n+  display: block;\n+}\n+\n+form:first-of-type {\n+  margin-top: 24px;\n+  margin-bottom: 48px;\n+}\n+\n+label {\n+  display: block;\n+  margin-top: 4px;\n+  margin-bottom: 4px;\n+}\n+\n+.error {\n+  color: red;\n+}\ndiff --git a/client/src/app/login/containers/login.component.ts b/client/src/app/login/containers/login.component.ts\nnew file mode 100644\nindex 0000000..51f5582\n--- /dev/null\n+++ b/client/src/app/login/containers/login.component.ts\n@@ -0,0 +1,133 @@\n+import {Component} from '@angular/core';\n+import {HttpClient} from '@angular/common/http';\n+import {FormBuilder, Validators} from '@angular/forms';\n+// import {matchOtherValidator} from '@moebius/ng-validators';\n+import {Router} from '@angular/router';\n+import {User} from '../../../types';\n+import {LoginService} from '../services/login.service';\n+\n+@Component({\n+  selector: 'app-login',\n+  template: `\n+    <form (ngSubmit)=\"signIn()\" [formGroup]=\"signInForm\" novalidate>\n+      <fieldset fxLayout=\"column\" fxLayoutGap=\"17px\">\n+        <legend>Sign in</legend>\n+        <div>\n+          <label>Username</label>\n+          <input formControlName=\"username\" autocomplete=\"username\" type=\"text\">\n+        </div>\n+        <div class=\"error\" *ngIf=\"signInForm.get('username').hasError('required') && signInForm.get('username').touched\">\n+          Username is required\n+        </div>\n+\n+        <div>\n+          <label>Password</label>\n+          <input formControlName=\"password\" autocomplete=\"current-password\" type=\"password\">\n+        </div>\n+        <div class=\"error\" *ngIf=\"signInForm.get('password').hasError('required') && signInForm.get('password').touched\">\n+          Password is required\n+        </div>\n+\n+        <button type=\"submit\" [disabled]=\"signInForm.invalid\">Sign in</button>\n+      </fieldset>\n+    </form>\n+\n+    <form (ngSubmit)=\"signUp()\" [formGroup]=\"signUpForm\" novalidate>\n+      <fieldset fxLayout=\"column\" fxLayoutGap=\"17px\">\n+        <legend>Sign up</legend>\n+        <div>\n+          <label>Name</label>\n+          <input formControlName=\"name\" type=\"text\">\n+        </div>\n+\n+        <div>\n+          <label>Username</label>\n+          <input formControlName=\"username\" autocomplete=\"username\" type=\"text\">\n+        </div>\n+        <div class=\"error\" *ngIf=\"signUpForm.get('username').hasError('required') && signUpForm.get('username').touched\">\n+          Username is required\n+        </div>\n+\n+        <div>\n+          <label>Password</label>\n+          <input formControlName=\"newPassword\" autocomplete=\"new-password\" type=\"password\">\n+        </div>\n+        <div class=\"error\" *ngIf=\"signUpForm.get('newPassword').hasError('required') && signUpForm.get('newPassword').touched\">\n+          Password is required\n+        </div>\n+\n+        <div>\n+          <label>Password</label>\n+          <input formControlName=\"confirmPassword\" type=\"password\">\n+        </div>\n+        <div class=\"error\" *ngIf=\"signUpForm.get('confirmPassword').hasError('required') && signUpForm.get('confirmPassword').touched\">\n+          Passwords must match\n+        </div>\n+\n+        <button type=\"submit\" [disabled]=\"signUpForm.invalid\">Sign up</button>\n+      </fieldset>\n+    </form>\n+  `,\n+  styleUrls: ['./login.component.scss'],\n+})\n+export class LoginComponent {\n+  signInForm = this.fb.group({\n+    username: [null, [\n+      Validators.required,\n+    ]],\n+    password: [null, [\n+      Validators.required,\n+    ]],\n+  });\n+\n+  signUpForm = this.fb.group({\n+    name: [null, [\n+      Validators.required,\n+    ]],\n+    username: [null, [\n+      Validators.required,\n+    ]],\n+    newPassword: [null, [\n+      Validators.required,\n+    ]],\n+    confirmPassword: [null, [\n+      Validators.required,\n+      // matchOtherValidator('newPassword'),\n+    ]],\n+  });\n+\n+  constructor(private http: HttpClient,\n+              private fb: FormBuilder,\n+              private router: Router,\n+              private loginService: LoginService) {}\n+\n+  signIn() {\n+    const {username, password} = this.signInForm.value;\n+    const auth = `Basic ${btoa(`${username}:${password}`)}`;\n+    this.http.post('http://localhost:3000/signin', null, {\n+      headers: {\n+        Authorization: auth,\n+      }\n+    }).subscribe((user: User) => {\n+      this.loginService.storeAuthHeader(auth);\n+      this.loginService.storeUser(user);\n+      this.router.navigate(['/chats']);\n+    }, err => console.error(err));\n+  }\n+\n+  signUp() {\n+    const {username, newPassword: password, name} = this.signInForm.value;\n+    const auth = `Basic ${btoa(`${username}:${password}`)}`;\n+    this.http.post('http://localhost:3000/signup', {\n+      name,\n+    }, {\n+      headers: {\n+        Authorization: auth,\n+      }\n+    }).subscribe((user: User) => {\n+      this.loginService.storeAuthHeader(auth);\n+      this.loginService.storeUser(user);\n+      this.router.navigate(['/chats']);\n+    }, err => console.error(err));\n+  }\n+}\ndiff --git a/client/src/app/login/login.module.ts b/client/src/app/login/login.module.ts\nnew file mode 100644\nindex 0000000..9fdda69\n--- /dev/null\n+++ b/client/src/app/login/login.module.ts\n@@ -0,0 +1,52 @@\n+import {RouterModule, Routes} from '@angular/router';\n+import {NgModule} from '@angular/core';\n+import {TruncateModule} from 'ng2-truncate';\n+import {MatButtonModule, MatIconModule, MatListModule, MatMenuModule} from '@angular/material';\n+import {SharedModule} from '../shared/shared.module';\n+import {BrowserModule} from '@angular/platform-browser';\n+import {FormsModule, ReactiveFormsModule} from '@angular/forms';\n+import {BrowserAnimationsModule} from '@angular/platform-browser/animations';\n+import {LoginComponent} from './containers/login.component';\n+import {FlexLayoutModule} from '@angular/flex-layout';\n+import {AuthInterceptor} from './services/auth.interceptor';\n+import {AuthGuard} from './services/auth.guard';\n+import {LoginService} from './services/login.service';\n+\n+\n+const routes: Routes = [\n+  {path: 'login', component: LoginComponent},\n+];\n+\n+@NgModule({\n+  declarations: [\n+    LoginComponent,\n+  ],\n+  imports: [\n+    BrowserModule,\n+    // Material\n+    MatMenuModule,\n+    MatIconModule,\n+    MatButtonModule,\n+    MatListModule,\n+    // Animations\n+    BrowserAnimationsModule,\n+    // Flex layout\n+    FlexLayoutModule,\n+    // Routing\n+    RouterModule.forChild(routes),\n+    // Forms\n+    FormsModule,\n+    ReactiveFormsModule,\n+    // Truncate Pipe\n+    TruncateModule,\n+    // Feature modules\n+    SharedModule,\n+  ],\n+  providers: [\n+    LoginService,\n+    AuthInterceptor,\n+    AuthGuard,\n+  ],\n+})\n+export class LoginModule {\n+}\ndiff --git a/client/src/app/login/services/auth.guard.ts b/client/src/app/login/services/auth.guard.ts\nnew file mode 100644\nindex 0000000..e67307b\n--- /dev/null\n+++ b/client/src/app/login/services/auth.guard.ts\n@@ -0,0 +1,18 @@\n+import {Injectable} from '@angular/core';\n+import {CanActivate, Router} from '@angular/router';\n+import {LoginService} from './login.service';\n+\n+@Injectable()\n+export class AuthGuard implements CanActivate {\n+  constructor(private router: Router,\n+              private loginService: LoginService) {}\n+\n+  canActivate() {\n+    if (this.loginService.getAuthHeader()) {\n+      return true;\n+    } else {\n+      this.router.navigate(['/login']);\n+      return false;\n+    }\n+  }\n+}\ndiff --git a/client/src/app/login/services/auth.interceptor.ts b/client/src/app/login/services/auth.interceptor.ts\nnew file mode 100644\nindex 0000000..c0dc097\n--- /dev/null\n+++ b/client/src/app/login/services/auth.interceptor.ts\n@@ -0,0 +1,20 @@\n+import {Injectable} from '@angular/core';\n+import {HttpEvent, HttpHandler, HttpInterceptor, HttpRequest} from '@angular/common/http';\n+import {Observable} from 'rxjs/Observable';\n+import {LoginService} from './login.service';\n+\n+@Injectable()\n+export class AuthInterceptor implements HttpInterceptor {\n+  constructor(private loginService: LoginService) {}\n+  intercept(request: HttpRequest<any>, next: HttpHandler): Observable<HttpEvent<any>> {\n+    const auth = this.loginService.getAuthHeader();\n+    if (auth) {\n+      request = request.clone({\n+        setHeaders: {\n+          Authorization: auth,\n+        }\n+      });\n+    }\n+    return next.handle(request);\n+  }\n+}\ndiff --git a/client/src/app/login/services/login.service.ts b/client/src/app/login/services/login.service.ts\nnew file mode 100644\nindex 0000000..1a4c3e3\n--- /dev/null\n+++ b/client/src/app/login/services/login.service.ts\n@@ -0,0 +1,24 @@\n+import { Injectable } from '@angular/core';\n+import {User} from '../../../types';\n+\n+@Injectable()\n+export class LoginService {\n+\n+  constructor() { }\n+\n+  storeAuthHeader(auth: string) {\n+    localStorage.setItem('Authorization', auth);\n+  }\n+\n+  getAuthHeader(): string {\n+    return localStorage.getItem('Authorization');\n+  }\n+\n+  storeUser(user: User) {\n+    localStorage.setItem('user', JSON.stringify(user));\n+  }\n+\n+  getUser(): User {\n+    return JSON.parse(localStorage.getItem('user'));\n+  }\n+}\ndiff --git a/client/src/app/services/chats.service.spec.ts b/client/src/app/services/chats.service.spec.ts\nnew file mode 100644\nindex 0000000..c4b3754\n--- /dev/null\n+++ b/client/src/app/services/chats.service.spec.ts\n@@ -0,0 +1,360 @@\n+import { TestBed, inject } from '@angular/core/testing';\n+\n+import { ChatsService } from './chats.service';\n+import {Apollo} from 'apollo-angular';\n+import {HttpLink, HttpLinkModule, Options} from 'apollo-angular-link-http';\n+import {HttpClientTestingModule, HttpTestingController} from '@angular/common/http/testing';\n+import {defaultDataIdFromObject, InMemoryCache} from 'apollo-cache-inmemory';\n+import {LoginService} from '../login/services/login.service';\n+\n+describe('ChatsService', () => {\n+  let httpMock: HttpTestingController;\n+  let httpLink: HttpLink;\n+  let apollo: Apollo;\n+\n+  const chats: any = [\n+    {\n+      id: '1',\n+      __typename: 'Chat',\n+      name: 'Avery Stewart',\n+      picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n+      allTimeMembers: [\n+        {\n+          id: '1',\n+          __typename: 'User',\n+        },\n+        {\n+          id: '3',\n+          __typename: 'User',\n+        }\n+      ],\n+      unreadMessages: 1,\n+      isGroup: false,\n+      messages: [\n+        {\n+          id: '1',\n+          chat: {\n+            id: '1',\n+            __typename: 'Chat',\n+          },\n+          __typename: 'Message',\n+          sender: {\n+            id: '3',\n+            __typename: 'User',\n+            name: 'Avery Stewart'\n+          },\n+          content: 'Yep!',\n+          createdAt: '1514035700',\n+          type: 0,\n+          recipients: [\n+            {\n+              user: {\n+                id: '1',\n+                __typename: 'User',\n+              },\n+              message: {\n+                id: '1',\n+                __typename: 'Message',\n+                chat: {\n+                  id: '1',\n+                  __typename: 'Chat',\n+                },\n+              },\n+              __typename: 'Recipient',\n+              chat: {\n+                id: '1',\n+                __typename: 'Chat',\n+              },\n+              receivedAt: null,\n+              readAt: null,\n+            }\n+          ],\n+          ownership: false,\n+        }\n+      ],\n+    },\n+    {\n+      id: '2',\n+      __typename: 'Chat',\n+      name: 'Katie Peterson',\n+      picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n+      allTimeMembers: [\n+        {\n+          id: '1',\n+          __typename: 'User',\n+        },\n+        {\n+          id: '4',\n+          __typename: 'User',\n+        }\n+      ],\n+      unreadMessages: 0,\n+      isGroup: false,\n+      messages: [\n+        {\n+          id: '1',\n+          chat: {\n+            id: '2',\n+            __typename: 'Chat',\n+          },\n+          __typename: 'Message',\n+          sender: {\n+            id: '1',\n+            __typename: 'User',\n+            name: 'Ethan Gonzalez'\n+          },\n+          content: 'Hey, it\\'s me',\n+          createdAt: '1514031800',\n+          type: 0,\n+          recipients: [\n+            {\n+              user: {\n+                id: '4',\n+                __typename: 'User',\n+              },\n+              message: {\n+                id: '1',\n+                __typename: 'Message',\n+                chat: {\n+                  id: '2',\n+                  __typename: 'Chat',\n+                },\n+              },\n+              __typename: 'Recipient',\n+              chat: {\n+                id: '2',\n+                __typename: 'Chat',\n+              },\n+              receivedAt: null,\n+              readAt: null,\n+            }\n+          ],\n+          ownership: true\n+        }\n+      ],\n+    },\n+    {\n+      id: '3',\n+      __typename: 'Chat',\n+      name: 'Ray Edwards',\n+      picture: 'https://randomuser.me/api/portraits/thumb/men/3.jpg',\n+      allTimeMembers: [\n+        {\n+          id: '1',\n+          __typename: 'User',\n+        },\n+        {\n+          id: '5',\n+          __typename: 'User',\n+        }\n+      ],\n+      unreadMessages: 0,\n+      isGroup: false,\n+      messages: [\n+        {\n+          id: '1',\n+          __typename: 'Message',\n+          chat: {\n+            id: '3',\n+            __typename: 'Chat',\n+          },\n+          sender: {\n+            id: '1',\n+            __typename: 'User',\n+            name: 'Ethan Gonzalez'\n+          },\n+          content: 'You still there?',\n+          createdAt: '1514010200',\n+          type: 0,\n+          recipients: [\n+            {\n+              user: {\n+                id: '5',\n+                __typename: 'User',\n+              },\n+              message: {\n+                id: '1',\n+                __typename: 'Message',\n+                chat: {\n+                  id: '3',\n+                  __typename: 'Chat',\n+                },\n+              },\n+              __typename: 'Recipient',\n+              chat: {\n+                id: '3',\n+                __typename: 'Chat',\n+              },\n+              receivedAt: null,\n+              readAt: null\n+            }\n+          ],\n+          ownership: true\n+        }\n+      ],\n+    },\n+    {\n+      id: '6',\n+      __typename: 'Chat',\n+      name: 'Niccolò Belli',\n+      picture: 'https://randomuser.me/api/portraits/thumb/men/4.jpg',\n+      allTimeMembers: [\n+        {\n+          id: '1',\n+          __typename: 'User',\n+        },\n+        {\n+          id: '6',\n+          __typename: 'User',\n+        }\n+      ],\n+      unreadMessages: 0,\n+      messages: [],\n+      isGroup: false\n+    },\n+    {\n+      id: '8',\n+      __typename: 'Chat',\n+      name: 'A user 0 group',\n+      picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n+      allTimeMembers: [\n+        {\n+          id: '1',\n+          __typename: 'User',\n+        },\n+        {\n+          id: '3',\n+          __typename: 'User',\n+        },\n+        {\n+          id: '4',\n+          __typename: 'User',\n+        },\n+        {\n+          id: '6',\n+          __typename: 'User',\n+        },\n+      ],\n+      unreadMessages: 1,\n+      isGroup: true,\n+      messages: [\n+        {\n+          id: '1',\n+          __typename: 'Message',\n+          chat: {\n+            id: '8',\n+            __typename: 'Chat',\n+          },\n+          sender: {\n+            id: '4',\n+            __typename: 'User',\n+            name: 'Katie Peterson'\n+          },\n+          content: 'Awesome!',\n+          createdAt: '1512830000',\n+          type: 0,\n+          recipients: [\n+            {\n+              user: {\n+                id: '1',\n+                __typename: 'User',\n+              },\n+              message: {\n+                id: '1',\n+                __typename: 'Message',\n+                chat: {\n+                  id: '8',\n+                  __typename: 'Chat',\n+                },\n+              },\n+              __typename: 'Recipient',\n+              chat: {\n+                id: '8',\n+                __typename: 'Chat',\n+              },\n+              receivedAt: null,\n+              readAt: null\n+            },\n+            {\n+              user: {\n+                id: '6',\n+                __typename: 'User',\n+              },\n+              message: {\n+                id: '1',\n+                __typename: 'Message',\n+                chat: {\n+                  id: '8',\n+                  __typename: 'Chat',\n+                },\n+              },\n+              __typename: 'Recipient',\n+              chat: {\n+                id: '8',\n+                __typename: 'Chat',\n+              },\n+              receivedAt: null,\n+              readAt: null\n+            }\n+          ],\n+          ownership: false\n+        }\n+      ],\n+    },\n+  ];\n+\n+  beforeEach(() => {\n+    TestBed.configureTestingModule({\n+      imports: [\n+        HttpLinkModule,\n+        // HttpClientModule,\n+        HttpClientTestingModule,\n+      ],\n+      providers: [\n+        ChatsService,\n+        Apollo,\n+        LoginService,\n+      ]\n+    });\n+\n+    httpMock = TestBed.get(HttpTestingController);\n+    httpLink = TestBed.get(HttpLink);\n+    apollo = TestBed.get(Apollo);\n+\n+    apollo.create({\n+      link: httpLink.create(<Options>{ uri: 'http://localhost:3000/graphql' }),\n+      cache: new InMemoryCache({\n+        dataIdFromObject: (object: any) => {\n+          switch (object.__typename) {\n+            case 'Message': return `${object.chat.id}:${object.id}`; // use `chatId` prefix and `messageId` as the primary key\n+            default: return defaultDataIdFromObject(object); // fall back to default handling\n+          }\n+        }\n+      }),\n+    });\n+  });\n+\n+  it('should be created', inject([ChatsService], (service: ChatsService) => {\n+    expect(service).toBeTruthy();\n+  }));\n+\n+  it('should get chats', inject([ChatsService], (service: ChatsService) => {\n+    service.getChats().chats$.subscribe(_chats => {\n+      expect(_chats.length).toEqual(chats.length);\n+      for (let i = 0; i < _chats.length; i++) {\n+        expect(_chats[i]).toEqual(chats[i]);\n+      }\n+    });\n+\n+    httpMock.expectOne(httpReq => httpReq.body.operationName === 'chatAdded', 'call to chatAdded api');\n+    httpMock.expectOne(httpReq => httpReq.body.operationName === 'messageAdded', 'call to messageAdded api');\n+    const req = httpMock.expectOne(httpReq => httpReq.body.operationName === 'GetChats', 'call to getChats api');\n+    expect(req.request.method).toBe('POST');\n+    req.flush({\n+      data: {\n+        chats\n+      }\n+    });\n+    httpMock.verify();\n+  }));\n+});\ndiff --git a/client/src/app/services/chats.service.ts b/client/src/app/services/chats.service.ts\nnew file mode 100644\nindex 0000000..6bd09bd\n--- /dev/null\n+++ b/client/src/app/services/chats.service.ts\n@@ -0,0 +1,454 @@\n+import {ApolloQueryResult, MutationOptions, WatchQueryOptions} from 'apollo-client';\n+import {concat, map, share, switchMap} from 'rxjs/operators';\n+import {Apollo, QueryRef} from 'apollo-angular';\n+import {Injectable} from '@angular/core';\n+import {getChatsQuery} from '../../graphql/getChats.query';\n+import {\n+  AddChat, AddGroup, AddMessage, GetChat, GetChats, GetUsers, MessageAdded, RemoveAllMessages, RemoveChat,\n+  RemoveMessages\n+} from '../../types';\n+import {getChatQuery} from '../../graphql/getChat.query';\n+import {addMessageMutation} from '../../graphql/addMessage.mutation';\n+import {removeChatMutation} from '../../graphql/removeChat.mutation';\n+import {DocumentNode} from 'graphql';\n+import {removeAllMessagesMutation} from '../../graphql/removeAllMessages.mutation';\n+import {removeMessagesMutation} from '../../graphql/removeMessages.mutation';\n+import {getUsersQuery} from '../../graphql/getUsers.query';\n+import {Observable} from 'rxjs/Observable';\n+import {addChatMutation} from '../../graphql/addChat.mutation';\n+import {addGroupMutation} from '../../graphql/addGroup.mutation';\n+import * as moment from 'moment';\n+import {AsyncSubject} from 'rxjs/AsyncSubject';\n+import {of} from 'rxjs/observable/of';\n+import {FetchResult} from 'apollo-link';\n+import {LoginService} from '../login/services/login.service';\n+import {chatAddedSubscription} from '../../graphql/chatAdded.subscription';\n+import {messageAddedSubscription} from '../../graphql/messageAdded.subscription';\n+\n+@Injectable()\n+export class ChatsService {\n+  messagesAmount = 3;\n+  getChatsWq: QueryRef<GetChats.Query>;\n+  chats$: Observable<GetChats.Chats[]>;\n+  chats: GetChats.Chats[];\n+  getChatWqSubject: AsyncSubject<QueryRef<GetChat.Query>>;\n+  addChat$: Observable<FetchResult<AddChat.Mutation | AddGroup.Mutation>>;\n+\n+  constructor(private apollo: Apollo,\n+              private loginService: LoginService) {\n+    this.getChatsWq = this.apollo.watchQuery<GetChats.Query>(<WatchQueryOptions>{\n+      query: getChatsQuery,\n+      variables: {\n+        amount: this.messagesAmount,\n+      },\n+    });\n+\n+    this.getChatsWq.subscribeToMore({\n+      document: chatAddedSubscription,\n+      updateQuery: (prev: GetChats.Query, { subscriptionData }) => {\n+        if (!subscriptionData.data) {\n+          return prev;\n+        }\n+\n+        const newChat: GetChats.Chats = subscriptionData.data.chatAdded;\n+\n+        return Object.assign({}, prev, {\n+          chats: [...prev.chats, newChat]\n+        });\n+      }\n+    });\n+\n+    this.getChatsWq.subscribeToMore({\n+      document: messageAddedSubscription,\n+      updateQuery: (prev: GetChats.Query, { subscriptionData }) => {\n+        if (!subscriptionData.data) {\n+          return prev;\n+        }\n+\n+        const newMessage: MessageAdded.MessageAdded = subscriptionData.data.messageAdded;\n+\n+        // We need to update the cache for both Chat and Chats. The following updates the cache for Chat.\n+        try {\n+          // Read the data from our cache for this query.\n+          const {chat}: GetChat.Query = this.apollo.getClient().readQuery({\n+            query: getChatQuery, variables: {\n+              chatId: newMessage.chat.id,\n+            }\n+          });\n+\n+          // Add our message from the mutation to the end.\n+          chat.messages.push(newMessage);\n+          // Write our data back to the cache.\n+          this.apollo.getClient().writeQuery({ query: getChatQuery, data: {chat} });\n+        } catch {\n+          console.error('The chat we received an update for does not exist in the store');\n+        }\n+\n+        return Object.assign({}, prev, {\n+          chats: [...prev.chats.map(_chat =>\n+            _chat.id === newMessage.chat.id ? {..._chat, messages: [..._chat.messages, newMessage]} : _chat)]\n+        });\n+      }\n+    });\n+\n+    this.chats$ = this.getChatsWq.valueChanges.pipe(\n+      map((result: ApolloQueryResult<GetChats.Query>) => result.data.chats)\n+    );\n+    this.chats$.subscribe(chats => this.chats = chats);\n+  }\n+\n+  static getRandomId() {\n+    return String(Math.round(Math.random() * 1000000000000));\n+  }\n+\n+  getChats() {\n+    return {query: this.getChatsWq, chats$: this.chats$};\n+  }\n+\n+  getChat(chatId: string, oui?: boolean) {\n+    const _chat = this.chats && this.chats.find(chat => chat.id === chatId) || {\n+      id: chatId,\n+      name: '',\n+      picture: null,\n+      allTimeMembers: [],\n+      unreadMessages: 0,\n+      isGroup: false,\n+      messages: [],\n+    };\n+    const chat$FromCache = of<GetChat.Chat>(_chat);\n+\n+    const getApolloWatchQuery = (id: string) => {\n+      return this.apollo.watchQuery<GetChat.Query>({\n+        query: getChatQuery,\n+        variables: {\n+          chatId: id,\n+        }\n+      });\n+    };\n+\n+    let chat$: Observable<GetChat.Chat>;\n+    this.getChatWqSubject = new AsyncSubject();\n+\n+    if (oui) {\n+      chat$ = chat$FromCache.pipe(\n+        concat(this.addChat$.pipe(\n+          switchMap(({ data: { addChat, addGroup } }) => {\n+            const query = getApolloWatchQuery(addChat ? addChat.id : addGroup.id);\n+            this.getChatWqSubject.next(query);\n+            this.getChatWqSubject.complete();\n+            return query.valueChanges.pipe(\n+              map((result: ApolloQueryResult<GetChat.Query>) => result.data.chat)\n+            );\n+          }))\n+        ));\n+    } else {\n+      const query = getApolloWatchQuery(chatId);\n+      this.getChatWqSubject.next(query);\n+      this.getChatWqSubject.complete();\n+      chat$ = chat$FromCache.pipe(\n+        concat(query.valueChanges.pipe(\n+          map((result: ApolloQueryResult<GetChat.Query>) => result.data.chat)\n+        )));\n+    }\n+\n+    return {query$: this.getChatWqSubject.asObservable(), chat$};\n+  }\n+\n+  addMessage(chatId: string, content: string) {\n+    return this.apollo.mutate(<MutationOptions>{\n+      mutation: addMessageMutation,\n+      variables: <AddMessage.Variables>{\n+        chatId,\n+        content,\n+      },\n+      optimisticResponse: {\n+        __typename: 'Mutation',\n+        addMessage: {\n+          id: ChatsService.getRandomId(),\n+          __typename: 'Message',\n+          senderId: this.loginService.getUser().id,\n+          sender: {\n+            id: this.loginService.getUser().id,\n+            __typename: 'User',\n+            name: this.loginService.getUser().name,\n+          },\n+          content,\n+          createdAt: moment().unix(),\n+          type: 0,\n+          recipients: [],\n+          ownership: true,\n+        },\n+      },\n+      update: (store, { data: { addMessage } }: {data: AddMessage.Mutation}) => {\n+        // Update the messages cache\n+        {\n+          // Read the data from our cache for this query.\n+          const {chat}: GetChat.Query = store.readQuery({\n+            query: getChatQuery, variables: {\n+              chatId,\n+            }\n+          });\n+          // Add our message from the mutation to the end.\n+          chat.messages.push(addMessage);\n+          // Write our data back to the cache.\n+          store.writeQuery({ query: getChatQuery, data: {chat} });\n+        }\n+        // Update last message cache\n+        {\n+          // Read the data from our cache for this query.\n+          const {chats}: GetChats.Query = store.readQuery({\n+            query: getChatsQuery,\n+            variables: <GetChats.Variables>{\n+              amount: this.messagesAmount,\n+            },\n+          });\n+          // Add our comment from the mutation to the end.\n+          chats.find(chat => chat.id === chatId).messages.push(addMessage);\n+          // Write our data back to the cache.\n+          store.writeQuery({\n+            query: getChatsQuery,\n+            variables: <GetChats.Variables>{\n+              amount: this.messagesAmount,\n+            },\n+            data: {\n+              chats,\n+            },\n+          });\n+        }\n+      },\n+    });\n+  }\n+\n+  removeChat(chatId: string) {\n+    return this.apollo.mutate({\n+      mutation: removeChatMutation,\n+      variables: <RemoveChat.Variables>{\n+        chatId,\n+      },\n+      optimisticResponse: {\n+        __typename: 'Mutation',\n+        removeChat: chatId,\n+      },\n+      update: (store, { data: { removeChat } }) => {\n+        // Read the data from our cache for this query.\n+        const {chats}: GetChats.Query = store.readQuery({\n+          query: getChatsQuery,\n+          variables: <GetChats.Variables>{\n+            amount: this.messagesAmount,\n+          },\n+        });\n+        // Remove the chat (mutable)\n+        for (const index of chats.keys()) {\n+          if (chats[index].id === removeChat) {\n+            chats.splice(index, 1);\n+          }\n+        }\n+        // Write our data back to the cache.\n+        store.writeQuery({\n+          query: getChatsQuery,\n+          variables: <GetChats.Variables>{\n+            amount: this.messagesAmount,\n+          },\n+          data: {\n+            chats,\n+          },\n+        });\n+      },\n+    });\n+  }\n+\n+  removeMessages(chatId: string, messages: GetChat.Messages[], messageIdsOrAll: string[] | boolean) {\n+    let variables: RemoveMessages.Variables | RemoveAllMessages.Variables;\n+    let ids: string[] = [];\n+    let mutation: DocumentNode;\n+\n+    if (typeof messageIdsOrAll === 'boolean') {\n+      variables = {chatId, all: messageIdsOrAll} as RemoveAllMessages.Variables;\n+      ids = messages.map(message => message.id);\n+      mutation = removeAllMessagesMutation;\n+    } else {\n+      variables = {chatId, messageIds: messageIdsOrAll} as RemoveMessages.Variables;\n+      ids = messageIdsOrAll;\n+      mutation = removeMessagesMutation;\n+    }\n+\n+    return this.apollo.mutate(<MutationOptions>{\n+      mutation,\n+      variables,\n+      optimisticResponse: {\n+        __typename: 'Mutation',\n+        removeMessages: ids,\n+      },\n+      update: (store, { data: { removeMessages } }: {data: RemoveMessages.Mutation | RemoveAllMessages.Mutation}) => {\n+        // Update the messages cache\n+        {\n+          // Read the data from our cache for this query.\n+          const {chat}: GetChat.Query = store.readQuery({\n+            query: getChatQuery, variables: {\n+              chatId,\n+            }\n+          });\n+          // Remove the messages (mutable)\n+          removeMessages.forEach(messageId => {\n+            for (const index of chat.messages.keys()) {\n+              if (chat.messages[index].id === messageId) {\n+                chat.messages.splice(index, 1);\n+              }\n+            }\n+          });\n+          // Write our data back to the cache.\n+          store.writeQuery({ query: getChatQuery, data: {chat} });\n+        }\n+        // Update last message cache\n+        {\n+          // Read the data from our cache for this query.\n+          const {chats}: GetChats.Query = store.readQuery({\n+            query: getChatsQuery,\n+            variables: <GetChats.Variables>{\n+              amount: this.messagesAmount,\n+            },\n+          });\n+          // Fix last message\n+          chats.find(chat => chat.id === chatId).messages = messages\n+            .filter(message => !ids.includes(message.id))\n+            .sort((a, b) => Number(b.createdAt) - Number(a.createdAt)) || [];\n+          // Write our data back to the cache.\n+          store.writeQuery({\n+            query: getChatsQuery,\n+            variables: <GetChats.Variables>{\n+              amount: this.messagesAmount,\n+            },\n+            data: {\n+              chats,\n+            },\n+          });\n+        }\n+      },\n+    });\n+  }\n+\n+  getUsers() {\n+    const query = this.apollo.watchQuery<GetUsers.Query>(<WatchQueryOptions>{\n+      query: getUsersQuery,\n+    });\n+    const users$ = query.valueChanges.pipe(\n+      map((result: ApolloQueryResult<GetUsers.Query>) => result.data.users)\n+    );\n+\n+    return {query, users$};\n+  }\n+\n+  // Checks if the chat is listed for the current user and returns the id\n+  getChatId(recipientId: string) {\n+    const _chat = this.chats.find(chat => {\n+      return !chat.isGroup && !!chat.allTimeMembers.find(user => user.id === this.loginService.getUser().id) &&\n+        !!chat.allTimeMembers.find(user => user.id === recipientId);\n+    });\n+    return _chat ? _chat.id : false;\n+  }\n+\n+  addChat(recipientId: string, users: GetUsers.Users[], ouiId: string) {\n+    this.addChat$ = this.apollo.mutate({\n+      mutation: addChatMutation,\n+      variables: <AddChat.Variables>{\n+        recipientId,\n+      },\n+      optimisticResponse: {\n+        __typename: 'Mutation',\n+        addChat: {\n+          id: ouiId,\n+          __typename: 'Chat',\n+          name: users.find(user => user.id === recipientId).name,\n+          picture: users.find(user => user.id === recipientId).picture,\n+          allTimeMembers: [\n+            {\n+              id: this.loginService.getUser().id,\n+              __typename: 'User',\n+            },\n+            {\n+              id: recipientId,\n+              __typename: 'User',\n+            }\n+          ],\n+          unreadMessages: 0,\n+          messages: [],\n+          isGroup: false,\n+        },\n+      },\n+      update: (store, { data: { addChat } }) => {\n+        // Read the data from our cache for this query.\n+        const {chats}: GetChats.Query = store.readQuery({\n+          query: getChatsQuery,\n+          variables: <GetChats.Variables>{\n+            amount: this.messagesAmount,\n+          },\n+        });\n+        // Add our comment from the mutation to the end.\n+        chats.push(addChat);\n+        // Write our data back to the cache.\n+        store.writeQuery({\n+          query: getChatsQuery,\n+          variables: <GetChats.Variables>{\n+            amount: this.messagesAmount,\n+          },\n+          data: {\n+            chats,\n+          },\n+        });\n+      },\n+    }).pipe(share());\n+    return this.addChat$;\n+  }\n+\n+  addGroup(recipientIds: string[], groupName: string, ouiId: string) {\n+    this.addChat$ = this.apollo.mutate({\n+      mutation: addGroupMutation,\n+      variables: <AddGroup.Variables>{\n+        recipientIds,\n+        groupName,\n+      },\n+      optimisticResponse: {\n+        __typename: 'Mutation',\n+        addGroup: {\n+          id: ouiId,\n+          __typename: 'Chat',\n+          name: groupName,\n+          picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n+          userIds: [this.loginService.getUser().id, recipientIds],\n+          allTimeMembers: [\n+            {\n+              id: this.loginService.getUser().id,\n+              __typename: 'User',\n+            },\n+            ...recipientIds.map(id => ({id, __typename: 'User'})),\n+          ],\n+          unreadMessages: 0,\n+          messages: [],\n+          isGroup: true,\n+        },\n+      },\n+      update: (store, { data: { addGroup } }) => {\n+        // Read the data from our cache for this query.\n+        const {chats}: GetChats.Query = store.readQuery({\n+          query: getChatsQuery,\n+          variables: <GetChats.Variables>{\n+            amount: this.messagesAmount,\n+          },\n+        });\n+        // Add our comment from the mutation to the end.\n+        chats.push(addGroup);\n+        // Write our data back to the cache.\n+        store.writeQuery({\n+          query: getChatsQuery,\n+          variables: <GetChats.Variables>{\n+            amount: this.messagesAmount,\n+          },\n+          data: {\n+            chats,\n+          },\n+        });\n+      },\n+    }).pipe(share());\n+    return this.addChat$;\n+  }\n+}\ndiff --git a/client/src/app/shared/components/confirm-selection/confirm-selection.component.scss b/client/src/app/shared/components/confirm-selection/confirm-selection.component.scss\nnew file mode 100644\nindex 0000000..7809636\n--- /dev/null\n+++ b/client/src/app/shared/components/confirm-selection/confirm-selection.component.scss\n@@ -0,0 +1,6 @@\n+:host {\n+  display: block;\n+  position: absolute;\n+  bottom: 5vw;\n+  right: 5vw;\n+}\ndiff --git a/client/src/app/shared/components/confirm-selection/confirm-selection.component.ts b/client/src/app/shared/components/confirm-selection/confirm-selection.component.ts\nnew file mode 100644\nindex 0000000..26bd9a9\n--- /dev/null\n+++ b/client/src/app/shared/components/confirm-selection/confirm-selection.component.ts\n@@ -0,0 +1,21 @@\n+import {Component, EventEmitter, Input, Output} from '@angular/core';\n+\n+@Component({\n+  selector: 'app-confirm-selection',\n+  template: `\n+    <button mat-fab color=\"primary\" (click)=\"handleClick()\">\n+      <mat-icon aria-label=\"Icon-button\">{{ icon }}</mat-icon>\n+    </button>\n+  `,\n+  styleUrls: ['./confirm-selection.component.scss'],\n+})\n+export class ConfirmSelectionComponent {\n+  @Input()\n+  icon = 'delete';\n+  @Output()\n+  emitClick = new EventEmitter<null>();\n+\n+  handleClick() {\n+    this.emitClick.emit();\n+  }\n+}\ndiff --git a/client/src/app/shared/components/toolbar/toolbar.component.scss b/client/src/app/shared/components/toolbar/toolbar.component.scss\nnew file mode 100644\nindex 0000000..974207c\n--- /dev/null\n+++ b/client/src/app/shared/components/toolbar/toolbar.component.scss\n@@ -0,0 +1,13 @@\n+:host {\n+  display: block;\n+  height: 8vh;\n+}\n+\n+.mat-toolbar {\n+  justify-content: space-between;\n+  height: 100%;\n+\n+  .left-block {\n+    display: flex;\n+  }\n+}\ndiff --git a/client/src/app/shared/components/toolbar/toolbar.component.ts b/client/src/app/shared/components/toolbar/toolbar.component.ts\nnew file mode 100644\nindex 0000000..d986d30\n--- /dev/null\n+++ b/client/src/app/shared/components/toolbar/toolbar.component.ts\n@@ -0,0 +1,18 @@\n+import {Component} from '@angular/core';\n+\n+@Component({\n+  selector: 'app-toolbar',\n+  template: `\n+    <mat-toolbar>\n+      <div class=\"left-block\">\n+        <ng-content select=\".navigation\"></ng-content>\n+        <ng-content select=\".title\"></ng-content>\n+      </div>\n+      <ng-content select=\".menu\"></ng-content>\n+    </mat-toolbar>\n+  `,\n+  styleUrls: ['./toolbar.component.scss']\n+})\n+export class ToolbarComponent {\n+\n+}\ndiff --git a/client/src/app/shared/shared.module.ts b/client/src/app/shared/shared.module.ts\nnew file mode 100644\nindex 0000000..5d48eea\n--- /dev/null\n+++ b/client/src/app/shared/shared.module.ts\n@@ -0,0 +1,33 @@\n+import {BrowserModule} from '@angular/platform-browser';\n+import {NgModule} from '@angular/core';\n+\n+import {MatButtonModule, MatIconModule, MatToolbarModule} from '@angular/material';\n+import {ToolbarComponent} from './components/toolbar/toolbar.component';\n+import {FormsModule} from '@angular/forms';\n+import {BrowserAnimationsModule} from '@angular/platform-browser/animations';\n+import {ConfirmSelectionComponent} from './components/confirm-selection/confirm-selection.component';\n+\n+@NgModule({\n+  declarations: [\n+    ToolbarComponent,\n+    ConfirmSelectionComponent,\n+  ],\n+  imports: [\n+    BrowserModule,\n+    // Material\n+    MatToolbarModule,\n+    MatIconModule,\n+    MatButtonModule,\n+    // Animations\n+    BrowserAnimationsModule,\n+    // Forms\n+    FormsModule,\n+  ],\n+  providers: [],\n+  exports: [\n+    ToolbarComponent,\n+    ConfirmSelectionComponent,\n+  ],\n+})\n+export class SharedModule {\n+}\ndiff --git a/client/src/assets/.gitkeep b/client/src/assets/.gitkeep\nnew file mode 100644\nindex 0000000..e69de29\ndiff --git a/client/src/environments/environment.prod.ts b/client/src/environments/environment.prod.ts\nnew file mode 100644\nindex 0000000..3612073\n--- /dev/null\n+++ b/client/src/environments/environment.prod.ts\n@@ -0,0 +1,3 @@\n+export const environment = {\n+  production: true\n+};\ndiff --git a/client/src/environments/environment.ts b/client/src/environments/environment.ts\nnew file mode 100644\nindex 0000000..b7f639a\n--- /dev/null\n+++ b/client/src/environments/environment.ts\n@@ -0,0 +1,8 @@\n+// The file contents for the current environment will overwrite these during build.\n+// The build system defaults to the dev environment which uses `environment.ts`, but if you do\n+// `ng build --env=prod` then `environment.prod.ts` will be used instead.\n+// The list of which env maps to which file can be found in `.angular-cli.json`.\n+\n+export const environment = {\n+  production: false\n+};\ndiff --git a/client/src/favicon.ico b/client/src/favicon.ico\nnew file mode 100644\nindex 0000000..8081c7c\nBinary files /dev/null and b/client/src/favicon.ico differ\ndiff --git a/client/src/graphql/addChat.mutation.ts b/client/src/graphql/addChat.mutation.ts\nnew file mode 100644\nindex 0000000..cf33eba\n--- /dev/null\n+++ b/client/src/graphql/addChat.mutation.ts\n@@ -0,0 +1,17 @@\n+import gql from 'graphql-tag';\n+import {fragments} from './fragment';\n+\n+// We use the gql tag to parse our query string into a query document\n+export const addChatMutation = gql`\n+  mutation AddChat($recipientId: ID!) {\n+    addChat(recipientId: $recipientId) {\n+      ...ChatWithoutMessages\n+      messages {\n+        ...Message\n+      }\n+    }\n+  }\n+\n+  ${fragments['chatWithoutMessages']}\n+  ${fragments['message']}\n+`;\ndiff --git a/client/src/graphql/addGroup.mutation.ts b/client/src/graphql/addGroup.mutation.ts\nnew file mode 100644\nindex 0000000..8fb2362\n--- /dev/null\n+++ b/client/src/graphql/addGroup.mutation.ts\n@@ -0,0 +1,17 @@\n+import gql from 'graphql-tag';\n+import {fragments} from './fragment';\n+\n+// We use the gql tag to parse our query string into a query document\n+export const addGroupMutation = gql`\n+  mutation AddGroup($recipientIds: [ID!]!, $groupName: String!) {\n+    addGroup(recipientIds: $recipientIds, groupName: $groupName) {\n+      ...ChatWithoutMessages\n+      messages {\n+        ...Message\n+      }\n+    }\n+  }\n+\n+  ${fragments['chatWithoutMessages']}\n+  ${fragments['message']}\n+`;\ndiff --git a/client/src/graphql/addMessage.mutation.ts b/client/src/graphql/addMessage.mutation.ts\nnew file mode 100644\nindex 0000000..abcd58d\n--- /dev/null\n+++ b/client/src/graphql/addMessage.mutation.ts\n@@ -0,0 +1,13 @@\n+import gql from 'graphql-tag';\n+import {fragments} from './fragment';\n+\n+// We use the gql tag to parse our query string into a query document\n+export const addMessageMutation = gql`\n+  mutation AddMessage($chatId: ID!, $content: String!) {\n+    addMessage(chatId: $chatId, content: $content) {\n+      ...Message\n+    }\n+  }\n+\n+  ${fragments['message']}\n+`;\ndiff --git a/client/src/graphql/chatAdded.subscription.ts b/client/src/graphql/chatAdded.subscription.ts\nnew file mode 100644\nindex 0000000..9f6afe5\n--- /dev/null\n+++ b/client/src/graphql/chatAdded.subscription.ts\n@@ -0,0 +1,17 @@\n+import gql from 'graphql-tag';\n+import {fragments} from './fragment';\n+\n+// We use the gql tag to parse our query string into a query document\n+export const chatAddedSubscription = gql`\n+  subscription chatAdded {\n+    chatAdded {\n+      ...ChatWithoutMessages\n+      messages {\n+        ...Message\n+      }\n+    }\n+  }\n+\n+  ${fragments['chatWithoutMessages']}\n+  ${fragments['message']}\n+`;\ndiff --git a/client/src/graphql/fragment.ts b/client/src/graphql/fragment.ts\nnew file mode 100644\nindex 0000000..fae680e\n--- /dev/null\n+++ b/client/src/graphql/fragment.ts\n@@ -0,0 +1,51 @@\n+import gql from 'graphql-tag';\n+import {DocumentNode} from 'graphql';\n+\n+export const fragments: {\n+  [key: string]: DocumentNode\n+} = {\n+  chatWithoutMessages: gql`\n+    fragment ChatWithoutMessages on Chat {\n+      id\n+      name\n+      picture\n+      allTimeMembers {\n+        id\n+      }\n+      unreadMessages\n+      isGroup\n+    }\n+  `,\n+  message: gql`\n+    fragment Message on Message {\n+      id\n+      chat {\n+        id\n+      }\n+      sender {\n+        id\n+        name\n+      }\n+      content\n+      createdAt\n+      type\n+      recipients {\n+        user {\n+          id\n+        }\n+        message {\n+          id\n+          chat {\n+            id\n+          }\n+        }\n+        chat {\n+          id\n+        }\n+        receivedAt\n+        readAt\n+      }\n+      ownership\n+    }\n+  `,\n+};\ndiff --git a/client/src/graphql/getChat.query.ts b/client/src/graphql/getChat.query.ts\nnew file mode 100644\nindex 0000000..621c4b9\n--- /dev/null\n+++ b/client/src/graphql/getChat.query.ts\n@@ -0,0 +1,17 @@\n+import gql from 'graphql-tag';\n+import {fragments} from './fragment';\n+\n+// We use the gql tag to parse our query string into a query document\n+export const getChatQuery = gql`\n+  query GetChat($chatId: ID!) {\n+    chat(chatId: $chatId) {\n+      ...ChatWithoutMessages\n+      messages {\n+        ...Message\n+      }\n+    }\n+  }\n+\n+  ${fragments['chatWithoutMessages']}\n+  ${fragments['message']}\n+`;\ndiff --git a/client/src/graphql/getChats.query.ts b/client/src/graphql/getChats.query.ts\nnew file mode 100644\nindex 0000000..44e6d96\n--- /dev/null\n+++ b/client/src/graphql/getChats.query.ts\n@@ -0,0 +1,17 @@\n+import gql from 'graphql-tag';\n+import {fragments} from './fragment';\n+\n+// We use the gql tag to parse our query string into a query document\n+export const getChatsQuery = gql`\n+  query GetChats($amount: Int) {\n+    chats {\n+      ...ChatWithoutMessages\n+      messages(amount: $amount) {\n+        ...Message\n+      }\n+    }\n+  }\n+\n+  ${fragments['chatWithoutMessages']}\n+  ${fragments['message']}\n+`;\ndiff --git a/client/src/graphql/getUsers.query.ts b/client/src/graphql/getUsers.query.ts\nnew file mode 100644\nindex 0000000..ddb62a6\n--- /dev/null\n+++ b/client/src/graphql/getUsers.query.ts\n@@ -0,0 +1,12 @@\n+import gql from 'graphql-tag';\n+\n+// We use the gql tag to parse our query string into a query document\n+export const getUsersQuery = gql`\n+  query GetUsers {\n+    users {\n+      id,\n+      name,\n+      picture,\n+    }\n+  }\n+`;\ndiff --git a/client/src/graphql/messageAdded.subscription.ts b/client/src/graphql/messageAdded.subscription.ts\nnew file mode 100644\nindex 0000000..9132e1b\n--- /dev/null\n+++ b/client/src/graphql/messageAdded.subscription.ts\n@@ -0,0 +1,16 @@\n+import gql from 'graphql-tag';\n+import {fragments} from './fragment';\n+\n+// We use the gql tag to parse our query string into a query document\n+export const messageAddedSubscription = gql`\n+  subscription messageAdded($chatId: ID) {\n+    messageAdded(chatId: $chatId) {\n+      ...Message\n+      chat {\n+        id,\n+      },\n+    }\n+  }\n+\n+  ${fragments['message']}\n+`;\ndiff --git a/client/src/graphql/removeAllMessages.mutation.ts b/client/src/graphql/removeAllMessages.mutation.ts\nnew file mode 100644\nindex 0000000..65a89b8\n--- /dev/null\n+++ b/client/src/graphql/removeAllMessages.mutation.ts\n@@ -0,0 +1,8 @@\n+import gql from 'graphql-tag';\n+\n+// We use the gql tag to parse our query string into a query document\n+export const removeAllMessagesMutation = gql`\n+  mutation RemoveAllMessages($chatId: ID!, $all: Boolean) {\n+    removeMessages(chatId: $chatId, all: $all)\n+  }\n+`;\ndiff --git a/client/src/graphql/removeChat.mutation.ts b/client/src/graphql/removeChat.mutation.ts\nnew file mode 100644\nindex 0000000..8f432d5\n--- /dev/null\n+++ b/client/src/graphql/removeChat.mutation.ts\n@@ -0,0 +1,8 @@\n+import gql from 'graphql-tag';\n+\n+// We use the gql tag to parse our query string into a query document\n+export const removeChatMutation = gql`\n+  mutation RemoveChat($chatId: ID!) {\n+    removeChat(chatId: $chatId)\n+  }\n+`;\ndiff --git a/client/src/graphql/removeMessages.mutation.ts b/client/src/graphql/removeMessages.mutation.ts\nnew file mode 100644\nindex 0000000..f5c676f\n--- /dev/null\n+++ b/client/src/graphql/removeMessages.mutation.ts\n@@ -0,0 +1,8 @@\n+import gql from 'graphql-tag';\n+\n+// We use the gql tag to parse our query string into a query document\n+export const removeMessagesMutation = gql`\n+  mutation RemoveMessages($chatId: ID!, $messageIds: [ID]) {\n+    removeMessages(chatId: $chatId, messageIds: $messageIds)\n+  }\n+`;\ndiff --git a/client/src/index.html b/client/src/index.html\nnew file mode 100644\nindex 0000000..db90117\n--- /dev/null\n+++ b/client/src/index.html\n@@ -0,0 +1,16 @@\n+<!doctype html>\n+<html lang=\"en\">\n+<head>\n+  <meta charset=\"utf-8\">\n+  <title>WhatsappClientAngularcliMaterial</title>\n+  <base href=\"/\">\n+\n+  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1, user-scalable=no\">\n+  <link rel=\"icon\" type=\"image/x-icon\" href=\"favicon.ico\">\n+  <!-- Material icons -->\n+  <link href=\"https://fonts.googleapis.com/icon?family=Material+Icons\" rel=\"stylesheet\">\n+</head>\n+<body>\n+  <app-root></app-root>\n+</body>\n+</html>\ndiff --git a/client/src/main.ts b/client/src/main.ts\nnew file mode 100644\nindex 0000000..27d19d9\n--- /dev/null\n+++ b/client/src/main.ts\n@@ -0,0 +1,15 @@\n+import { enableProdMode } from '@angular/core';\n+import { platformBrowserDynamic } from '@angular/platform-browser-dynamic';\n+\n+import { AppModule } from './app/app.module';\n+import { environment } from './environments/environment';\n+\n+// Material gestures\n+import 'hammerjs';\n+\n+if (environment.production) {\n+  enableProdMode();\n+}\n+\n+platformBrowserDynamic().bootstrapModule(AppModule)\n+  .catch(err => console.log(err));\ndiff --git a/client/src/polyfills.ts b/client/src/polyfills.ts\nnew file mode 100644\nindex 0000000..af84770\n--- /dev/null\n+++ b/client/src/polyfills.ts\n@@ -0,0 +1,79 @@\n+/**\n+ * This file includes polyfills needed by Angular and is loaded before the app.\n+ * You can add your own extra polyfills to this file.\n+ *\n+ * This file is divided into 2 sections:\n+ *   1. Browser polyfills. These are applied before loading ZoneJS and are sorted by browsers.\n+ *   2. Application imports. Files imported after ZoneJS that should be loaded before your main\n+ *      file.\n+ *\n+ * The current setup is for so-called \"evergreen\" browsers; the last versions of browsers that\n+ * automatically update themselves. This includes Safari >= 10, Chrome >= 55 (including Opera),\n+ * Edge >= 13 on the desktop, and iOS 10 and Chrome on mobile.\n+ *\n+ * Learn more in https://angular.io/docs/ts/latest/guide/browser-support.html\n+ */\n+\n+/***************************************************************************************************\n+ * BROWSER POLYFILLS\n+ */\n+\n+/** IE9, IE10 and IE11 requires all of the following polyfills. **/\n+// import 'core-js/es6/symbol';\n+// import 'core-js/es6/object';\n+// import 'core-js/es6/function';\n+// import 'core-js/es6/parse-int';\n+// import 'core-js/es6/parse-float';\n+// import 'core-js/es6/number';\n+// import 'core-js/es6/math';\n+// import 'core-js/es6/string';\n+// import 'core-js/es6/date';\n+// import 'core-js/es6/array';\n+// import 'core-js/es6/regexp';\n+// import 'core-js/es6/map';\n+// import 'core-js/es6/weak-map';\n+// import 'core-js/es6/set';\n+\n+/** IE10 and IE11 requires the following for NgClass support on SVG elements */\n+// import 'classlist.js';  // Run `npm install --save classlist.js`.\n+\n+/** IE10 and IE11 requires the following for the Reflect API. */\n+// import 'core-js/es6/reflect';\n+\n+\n+/** Evergreen browsers require these. **/\n+// Used for reflect-metadata in JIT. If you use AOT (and only Angular decorators), you can remove.\n+import 'core-js/es7/reflect';\n+\n+\n+/**\n+ * Required to support Web Animations `@angular/platform-browser/animations`.\n+ * Needed for: All but Chrome, Firefox and Opera. http://caniuse.com/#feat=web-animation\n+ **/\n+// import 'web-animations-js';  // Run `npm install --save web-animations-js`.\n+\n+/**\n+ * By default, zone.js will patch all possible macroTask and DomEvents\n+ * user can disable parts of macroTask/DomEvents patch by setting following flags\n+ */\n+\n+ // (window as any).__Zone_disable_requestAnimationFrame = true; // disable patch requestAnimationFrame\n+ // (window as any).__Zone_disable_on_property = true; // disable patch onProperty such as onclick\n+ // (window as any).__zone_symbol__BLACK_LISTED_EVENTS = ['scroll', 'mousemove']; // disable patch specified eventNames\n+\n+ /*\n+ * in IE/Edge developer tools, the addEventListener will also be wrapped by zone.js\n+ * with the following flag, it will bypass `zone.js` patch for IE/Edge\n+ */\n+// (window as any).__Zone_enable_cross_context_check = true;\n+\n+/***************************************************************************************************\n+ * Zone JS is required by default for Angular itself.\n+ */\n+import 'zone.js/dist/zone';  // Included with Angular CLI.\n+\n+\n+\n+/***************************************************************************************************\n+ * APPLICATION IMPORTS\n+ */\ndiff --git a/client/src/styles.scss b/client/src/styles.scss\nnew file mode 100644\nindex 0000000..efd56a4\n--- /dev/null\n+++ b/client/src/styles.scss\n@@ -0,0 +1,8 @@\n+/* You can add global styles to this file, and also import other style files */\n+\n+/* Meterial theme */\n+@import \"~@angular/material/prebuilt-themes/indigo-pink.css\";\n+\n+body {\n+  margin: 0;\n+}\ndiff --git a/client/src/test.ts b/client/src/test.ts\nnew file mode 100644\nindex 0000000..25a1ed7\n--- /dev/null\n+++ b/client/src/test.ts\n@@ -0,0 +1,23 @@\n+// This file is required by karma.conf.js and loads recursively all the .spec and framework files\n+\n+import 'zone.js/dist/zone-testing';\n+import { getTestBed } from '@angular/core/testing';\n+import {\n+  BrowserDynamicTestingModule,\n+  platformBrowserDynamicTesting\n+} from '@angular/platform-browser-dynamic/testing';\n+\n+// Material gestures\n+import 'hammerjs';\n+\n+declare const require: any;\n+\n+// First, initialize the Angular testing environment.\n+getTestBed().initTestEnvironment(\n+  BrowserDynamicTestingModule,\n+  platformBrowserDynamicTesting()\n+);\n+// Then we find all the tests.\n+const context = require.context('./', true, /\\.spec\\.ts$/);\n+// And load the modules.\n+context.keys().map(context);\ndiff --git a/client/src/tsconfig.app.json b/client/src/tsconfig.app.json\nnew file mode 100644\nindex 0000000..39ba8db\n--- /dev/null\n+++ b/client/src/tsconfig.app.json\n@@ -0,0 +1,13 @@\n+{\n+  \"extends\": \"../tsconfig.json\",\n+  \"compilerOptions\": {\n+    \"outDir\": \"../out-tsc/app\",\n+    \"baseUrl\": \"./\",\n+    \"module\": \"es2015\",\n+    \"types\": []\n+  },\n+  \"exclude\": [\n+    \"test.ts\",\n+    \"**/*.spec.ts\"\n+  ]\n+}\ndiff --git a/client/src/tsconfig.spec.json b/client/src/tsconfig.spec.json\nnew file mode 100644\nindex 0000000..ac22a29\n--- /dev/null\n+++ b/client/src/tsconfig.spec.json\n@@ -0,0 +1,19 @@\n+{\n+  \"extends\": \"../tsconfig.json\",\n+  \"compilerOptions\": {\n+    \"outDir\": \"../out-tsc/spec\",\n+    \"baseUrl\": \"./\",\n+    \"module\": \"commonjs\",\n+    \"types\": [\n+      \"jasmine\",\n+      \"node\"\n+    ]\n+  },\n+  \"files\": [\n+    \"test.ts\"\n+  ],\n+  \"include\": [\n+    \"**/*.spec.ts\",\n+    \"**/*.d.ts\"\n+  ]\n+}\ndiff --git a/client/src/types.d.ts b/client/src/types.d.ts\nnew file mode 100644\nindex 0000000..b1986ca\n--- /dev/null\n+++ b/client/src/types.d.ts\n@@ -0,0 +1,321 @@\n+/* tslint:disable */\n+\n+export interface Query {\n+  users: User[];\n+  chats: Chat[];\n+  chat?: Chat | null;\n+}\n+\n+export interface User {\n+  id: string;\n+  name?: string | null;\n+  picture?: string | null;\n+  phone?: string | null;\n+}\n+\n+export interface Chat {\n+  id: string; /* May be a chat or a group */\n+  name?: string | null; /* Computed for chats */\n+  picture?: string | null; /* Computed for chats */\n+  allTimeMembers: User[]; /* All members, current and past ones. */\n+  listingMembers: User[]; /* Whoever gets the chat listed. For groups includes past members who still didn&#x27;t delete the group. */\n+  actualGroupMembers: User[]; /* Actual members of the group (they are not the only ones who get the group listed). Null for chats. */\n+  admins: User[]; /* Null for chats */\n+  owner?: User | null; /* If null the group is read-only. Null for chats. */\n+  messages: Message[];\n+  unreadMessages: number; /* Computed property */\n+  isGroup: boolean; /* Computed property */\n+}\n+\n+export interface Message {\n+  id: string;\n+  sender: User;\n+  chat: Chat;\n+  content: string;\n+  createdAt: string;\n+  type: number; /* FIXME: should return MessageType */\n+  recipients: Recipient[]; /* Whoever received the message */\n+  holders: User[]; /* Whoever still holds a copy of the message. Cannot be null because the message gets deleted otherwise */\n+  ownership: boolean; /* Computed property */\n+}\n+\n+export interface Recipient {\n+  user: User;\n+  message: Message;\n+  receivedAt?: string | null;\n+  readAt?: string | null;\n+}\n+\n+export interface Mutation {\n+  addChat?: Chat | null;\n+  addGroup?: Chat | null;\n+  removeChat?: string | null;\n+  addMessage?: Message | null;\n+  removeMessages?: string[] | null;\n+  addMembers?: string[] | null;\n+  removeMembers?: string[] | null;\n+  addAdmins?: string[] | null;\n+  removeAdmins?: string[] | null;\n+  setGroupName?: string | null;\n+  setGroupPicture?: string | null;\n+  markAsReceived?: boolean | null;\n+  markAsRead?: boolean | null;\n+}\n+\n+export interface Subscription {\n+  messageAdded?: Message | null;\n+  chatAdded?: Chat | null;\n+}\n+export interface ChatQueryArgs {\n+  chatId: string;\n+}\n+export interface MessagesChatArgs {\n+  amount?: number | null;\n+}\n+export interface AddChatMutationArgs {\n+  recipientId: string;\n+}\n+export interface AddGroupMutationArgs {\n+  recipientIds: string[];\n+  groupName: string;\n+}\n+export interface RemoveChatMutationArgs {\n+  chatId: string;\n+}\n+export interface AddMessageMutationArgs {\n+  chatId: string;\n+  content: string;\n+}\n+export interface RemoveMessagesMutationArgs {\n+  chatId: string;\n+  messageIds?: string[] | null;\n+  all?: boolean | null;\n+}\n+export interface AddMembersMutationArgs {\n+  groupId: string;\n+  userIds: string[];\n+}\n+export interface RemoveMembersMutationArgs {\n+  groupId: string;\n+  userIds: string[];\n+}\n+export interface AddAdminsMutationArgs {\n+  groupId: string;\n+  userIds: string[];\n+}\n+export interface RemoveAdminsMutationArgs {\n+  groupId: string;\n+  userIds: string[];\n+}\n+export interface SetGroupNameMutationArgs {\n+  groupId: string;\n+}\n+export interface SetGroupPictureMutationArgs {\n+  groupId: string;\n+}\n+export interface MarkAsReceivedMutationArgs {\n+  chatId: string;\n+}\n+export interface MarkAsReadMutationArgs {\n+  chatId: string;\n+}\n+export interface MessageAddedSubscriptionArgs {\n+  chatId?: string | null;\n+}\n+\n+export type MessageType = \"LOCATION\" | \"TEXT\" | \"PICTURE\";\n+\n+export namespace AddChat {\n+  export type Variables = {\n+    recipientId: string;\n+  }\n+\n+  export type Mutation = {\n+    addChat?: AddChat | null;\n+  }\n+\n+  export type AddChat = {\n+    messages: Messages[];\n+  } & ChatWithoutMessages.Fragment\n+\n+  export type Messages = Message.Fragment\n+}\n+export namespace AddGroup {\n+  export type Variables = {\n+    recipientIds: string[];\n+    groupName: string;\n+  }\n+\n+  export type Mutation = {\n+    addGroup?: AddGroup | null;\n+  }\n+\n+  export type AddGroup = {\n+    messages: Messages[];\n+  } & ChatWithoutMessages.Fragment\n+\n+  export type Messages = Message.Fragment\n+}\n+export namespace AddMessage {\n+  export type Variables = {\n+    chatId: string;\n+    content: string;\n+  }\n+\n+  export type Mutation = {\n+    addMessage?: AddMessage | null;\n+  }\n+\n+  export type AddMessage = Message.Fragment\n+}\n+export namespace ChatAdded {\n+  export type Variables = {\n+  }\n+\n+  export type Subscription = {\n+    chatAdded?: ChatAdded | null;\n+  }\n+\n+  export type ChatAdded = {\n+    messages: Messages[];\n+  } & ChatWithoutMessages.Fragment\n+\n+  export type Messages = Message.Fragment\n+}\n+export namespace GetChat {\n+  export type Variables = {\n+    chatId: string;\n+  }\n+\n+  export type Query = {\n+    chat?: Chat | null;\n+  }\n+\n+  export type Chat = {\n+    messages: Messages[];\n+  } & ChatWithoutMessages.Fragment\n+\n+  export type Messages = Message.Fragment\n+}\n+export namespace GetChats {\n+  export type Variables = {\n+    amount?: number | null;\n+  }\n+\n+  export type Query = {\n+    chats: Chats[];\n+  }\n+\n+  export type Chats = {\n+    messages: Messages[];\n+  } & ChatWithoutMessages.Fragment\n+\n+  export type Messages = Message.Fragment\n+}\n+export namespace GetUsers {\n+  export type Variables = {\n+  }\n+\n+  export type Query = {\n+    users: Users[];\n+  }\n+\n+  export type Users = {\n+    id: string;\n+    name?: string | null;\n+    picture?: string | null;\n+  }\n+}\n+export namespace MessageAdded {\n+  export type Variables = {\n+    chatId?: string | null;\n+  }\n+\n+  export type Subscription = {\n+    messageAdded?: MessageAdded | null;\n+  }\n+\n+  export type MessageAdded = {\n+    chat: Chat;\n+  } & Message.Fragment\n+\n+  export type Chat = {\n+    id: string;\n+  }\n+}\n+export namespace RemoveAllMessages {\n+  export type Variables = {\n+    chatId: string;\n+    all?: boolean | null;\n+  }\n+\n+  export type Mutation = {\n+    removeMessages?: string[] | null;\n+  }\n+}\n+export namespace RemoveChat {\n+  export type Variables = {\n+    chatId: string;\n+  }\n+\n+  export type Mutation = {\n+    removeChat?: string | null;\n+  }\n+}\n+export namespace RemoveMessages {\n+  export type Variables = {\n+    chatId: string;\n+    messageIds?: string[] | null;\n+  }\n+\n+  export type Mutation = {\n+    removeMessages?: string[] | null;\n+  }\n+}\n+\n+export namespace ChatWithoutMessages {\n+  export type Fragment = {\n+    id: string;\n+    name?: string | null;\n+    picture?: string | null;\n+    allTimeMembers: AllTimeMembers[];\n+    unreadMessages: number;\n+    isGroup: boolean;\n+  }\n+\n+  export type AllTimeMembers = {\n+    id: string;\n+  }\n+}\n+\n+export namespace Message {\n+  export type Fragment = {\n+    id: string;\n+    sender: Sender;\n+    content: string;\n+    createdAt: string;\n+    type: number;\n+    recipients: Recipients[];\n+    ownership: boolean;\n+  }\n+\n+  export type Sender = {\n+    id: string;\n+    name?: string | null;\n+  }\n+\n+  export type Recipients = {\n+    user: User;\n+    message: Message;\n+    receivedAt?: string | null;\n+    readAt?: string | null;\n+  }\n+\n+  export type User = {\n+    id: string;\n+  }\n+\n+  export type Message = {\n+    id: string;\n+  }\n+}\ndiff --git a/client/src/typings.d.ts b/client/src/typings.d.ts\nnew file mode 100644\nindex 0000000..ef5c7bd\n--- /dev/null\n+++ b/client/src/typings.d.ts\n@@ -0,0 +1,5 @@\n+/* SystemJS module definition */\n+declare var module: NodeModule;\n+interface NodeModule {\n+  id: string;\n+}\ndiff --git a/client/tsconfig.json b/client/tsconfig.json\nnew file mode 100644\nindex 0000000..d8195f3\n--- /dev/null\n+++ b/client/tsconfig.json\n@@ -0,0 +1,21 @@\n+{\n+  \"compileOnSave\": false,\n+  \"compilerOptions\": {\n+    \"outDir\": \"./dist/out-tsc\",\n+    \"sourceMap\": true,\n+    \"declaration\": false,\n+    \"moduleResolution\": \"node\",\n+    \"emitDecoratorMetadata\": true,\n+    \"experimentalDecorators\": true,\n+    \"downlevelIteration\": true,\n+    \"target\": \"es5\",\n+    \"typeRoots\": [\n+      \"node_modules/@types\"\n+    ],\n+    \"lib\": [\n+      \"es2017\",\n+      \"dom\",\n+      \"esnext.asynciterable\"\n+    ]\n+  }\n+}\ndiff --git a/client/tslint.json b/client/tslint.json\nnew file mode 100644\nindex 0000000..9963d6c\n--- /dev/null\n+++ b/client/tslint.json\n@@ -0,0 +1,143 @@\n+{\n+  \"rulesDirectory\": [\n+    \"node_modules/codelyzer\"\n+  ],\n+  \"rules\": {\n+    \"arrow-return-shorthand\": true,\n+    \"callable-types\": true,\n+    \"class-name\": true,\n+    \"comment-format\": [\n+      true,\n+      \"check-space\"\n+    ],\n+    \"curly\": true,\n+    \"deprecation\": {\n+      \"severity\": \"warn\"\n+    },\n+    \"eofline\": true,\n+    \"forin\": true,\n+    \"import-blacklist\": [\n+      true,\n+      \"rxjs\",\n+      \"rxjs/Rx\"\n+    ],\n+    \"import-spacing\": true,\n+    \"indent\": [\n+      true,\n+      \"spaces\"\n+    ],\n+    \"interface-over-type-literal\": true,\n+    \"label-position\": true,\n+    \"max-line-length\": [\n+      true,\n+      140\n+    ],\n+    \"member-access\": false,\n+    \"member-ordering\": [\n+      true,\n+      {\n+        \"order\": [\n+          \"static-field\",\n+          \"instance-field\",\n+          \"static-method\",\n+          \"instance-method\"\n+        ]\n+      }\n+    ],\n+    \"no-arg\": true,\n+    \"no-bitwise\": true,\n+    \"no-console\": [\n+      true,\n+      \"debug\",\n+      \"info\",\n+      \"time\",\n+      \"timeEnd\",\n+      \"trace\"\n+    ],\n+    \"no-construct\": true,\n+    \"no-debugger\": true,\n+    \"no-duplicate-super\": true,\n+    \"no-empty\": false,\n+    \"no-empty-interface\": true,\n+    \"no-eval\": true,\n+    \"no-inferrable-types\": [\n+      true,\n+      \"ignore-params\"\n+    ],\n+    \"no-misused-new\": true,\n+    \"no-non-null-assertion\": true,\n+    \"no-shadowed-variable\": true,\n+    \"no-string-literal\": false,\n+    \"no-string-throw\": true,\n+    \"no-switch-case-fall-through\": true,\n+    \"no-trailing-whitespace\": true,\n+    \"no-unnecessary-initializer\": true,\n+    \"no-unused-expression\": true,\n+    \"no-use-before-declare\": true,\n+    \"no-var-keyword\": true,\n+    \"object-literal-sort-keys\": false,\n+    \"one-line\": [\n+      true,\n+      \"check-open-brace\",\n+      \"check-catch\",\n+      \"check-else\",\n+      \"check-whitespace\"\n+    ],\n+    \"prefer-const\": true,\n+    \"quotemark\": [\n+      true,\n+      \"single\"\n+    ],\n+    \"radix\": true,\n+    \"semicolon\": [\n+      true,\n+      \"always\"\n+    ],\n+    \"triple-equals\": [\n+      true,\n+      \"allow-null-check\"\n+    ],\n+    \"typedef-whitespace\": [\n+      true,\n+      {\n+        \"call-signature\": \"nospace\",\n+        \"index-signature\": \"nospace\",\n+        \"parameter\": \"nospace\",\n+        \"property-declaration\": \"nospace\",\n+        \"variable-declaration\": \"nospace\"\n+      }\n+    ],\n+    \"unified-signatures\": true,\n+    \"variable-name\": false,\n+    \"whitespace\": [\n+      true,\n+      \"check-branch\",\n+      \"check-decl\",\n+      \"check-operator\",\n+      \"check-separator\",\n+      \"check-type\"\n+    ],\n+    \"directive-selector\": [\n+      true,\n+      \"attribute\",\n+      \"app\",\n+      \"camelCase\"\n+    ],\n+    \"component-selector\": [\n+      true,\n+      \"element\",\n+      \"app\",\n+      \"kebab-case\"\n+    ],\n+    \"no-output-on-prefix\": true,\n+    \"use-input-property-decorator\": true,\n+    \"use-output-property-decorator\": true,\n+    \"use-host-property-decorator\": true,\n+    \"no-input-rename\": true,\n+    \"no-output-rename\": true,\n+    \"use-life-cycle-interface\": true,\n+    \"use-pipe-transform-interface\": true,\n+    \"component-class-suffix\": true,\n+    \"directive-class-suffix\": true\n+  }\n+}\ndiff --git a/package.json b/package.json\nnew file mode 100644\nindex 0000000..b1d25d1\n--- /dev/null\n+++ b/package.json\n@@ -0,0 +1,5 @@\n+{\n+  \"name\": \"whatsapp-textrepo-angularcli-express\",\n+  \"description\": \"A newly created Tortilla project\",\n+  \"private\": true\n+}\ndiff --git a/server/.gitignore b/server/.gitignore\nnew file mode 100644\nindex 0000000..e23c92b\n--- /dev/null\n+++ b/server/.gitignore\n@@ -0,0 +1,4 @@\n+node_modules\n+npm-debug.log\n+.idea\n+package-lock.json\ndiff --git a/server/db.ts b/server/db.ts\nnew file mode 100644\nindex 0000000..d8d4d55\n--- /dev/null\n+++ b/server/db.ts\n@@ -0,0 +1,292 @@\n+// For TypeORM\n+import \"reflect-metadata\";\n+import { Chat } from \"./entity/Chat\";\n+import { Recipient } from \"./entity/Recipient\";\n+import * as moment from 'moment';\n+import { Message } from \"./entity/Message\";\n+import { User } from \"./entity/User\";\n+import { Connection } from \"typeorm\";\n+\n+export enum MessageType {\n+  PICTURE,\n+  TEXT,\n+  LOCATION,\n+}\n+\n+export async function addSampleData(connection: Connection) {\n+  const user1 = new User({\n+    username: 'ethan',\n+    password: '$2a$08$NO9tkFLCoSqX1c5wk3s7z.JfxaVMKA.m7zUDdDwEquo4rvzimQeJm', // 111\n+    name: 'Ethan Gonzalez',\n+    picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n+    phone: '+391234567890',\n+  });\n+  await connection.manager.save(user1);\n+\n+  const user2 = new User({\n+    username: 'bryan',\n+    password: '$2a$08$xE4FuCi/ifxjL2S8CzKAmuKLwv18ktksSN.F3XYEnpmcKtpbpeZgO', // 222\n+    name: 'Bryan Wallace',\n+    picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n+    phone: '+391234567891',\n+  });\n+  await connection.manager.save(user2);\n+\n+  const user3 = new User({\n+    username: 'avery',\n+    password: '$2a$08$UHgH7J8G6z1mGQn2qx2kdeWv0jvgHItyAsL9hpEUI3KJmhVW5Q1d.', // 333\n+    name: 'Avery Stewart',\n+    picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n+    phone: '+391234567892',\n+  });\n+  await connection.manager.save(user3);\n+\n+  const user4 = new User({\n+    username: 'katie',\n+    password: '$2a$08$wR1k5Q3T9FC7fUgB7Gdb9Os/GV7dGBBf4PLlWT7HERMFhmFDt47xi', // 444\n+    name: 'Katie Peterson',\n+    picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n+    phone: '+391234567893',\n+  });\n+  await connection.manager.save(user4);\n+\n+  const user5 = new User({\n+    username: 'ray',\n+    password: '$2a$08$6.mbXqsDX82ZZ7q5d8Osb..JrGSsNp4R3IKj7mxgF6YGT0OmMw242', // 555\n+    name: 'Ray Edwards',\n+    picture: 'https://randomuser.me/api/portraits/thumb/men/3.jpg',\n+    phone: '+391234567894',\n+  });\n+  await connection.manager.save(user5);\n+\n+  const user6 = new User({\n+    username: 'niko',\n+    password: '$2a$08$fL5lZR.Rwf9FWWe8XwwlceiPBBim8n9aFtaem.INQhiKT4.Ux3Uq.', // 666\n+    name: 'Niccolò Belli',\n+    picture: 'https://randomuser.me/api/portraits/thumb/men/4.jpg',\n+    phone: '+391234567895',\n+  });\n+  await connection.manager.save(user6);\n+\n+  const user7 = new User({\n+    username: 'mario',\n+    password: '$2a$08$nDHDmWcVxDnH5DDT3HMMC.psqcnu6wBiOgkmJUy9IH..qxa3R6YrO', // 777\n+    name: 'Mario Rossi',\n+    picture: 'https://randomuser.me/api/portraits/thumb/men/5.jpg',\n+    phone: '+391234567896',\n+  });\n+  await connection.manager.save(user7);\n+\n+\n+\n+\n+  await connection.manager.save(new Chat({\n+    allTimeMembers: [user1, user3],\n+    listingMembers: [user1, user3],\n+    messages: [\n+      new Message({\n+        sender: user1,\n+        content: 'You on your way?',\n+        createdAt: moment().subtract(1, 'hours').toDate(),\n+        type: MessageType.TEXT,\n+        holders: [user1, user3],\n+        recipients: [\n+          new Recipient({\n+            user: user3,\n+          }),\n+        ],\n+      }),\n+      new Message({\n+        sender: user3,\n+        content: 'Yep!',\n+        createdAt: moment().subtract(1, 'hours').add(5, 'minutes').toDate(),\n+        type: MessageType.TEXT,\n+        holders: [user1, user3],\n+        recipients: [\n+          new Recipient({\n+            user: user1,\n+          }),\n+        ],\n+      }),\n+    ],\n+  }));\n+\n+  await connection.manager.save(new Chat({\n+    allTimeMembers: [user1, user4],\n+    listingMembers: [user1, user4],\n+    messages: [\n+      new Message({\n+        sender: user1,\n+        content: 'Hey, it\\'s me',\n+        createdAt: moment().subtract(2, 'hours').toDate(),\n+        type: MessageType.TEXT,\n+        holders: [user1, user4],\n+        recipients: [\n+          new Recipient({\n+            user: user4,\n+          }),\n+        ],\n+      }),\n+    ],\n+  }));\n+\n+  await connection.manager.save(new Chat({\n+    allTimeMembers: [user1, user5],\n+    listingMembers: [user1, user5],\n+    messages: [\n+      new Message({\n+        sender: user1,\n+        content: 'I should buy a boat',\n+        createdAt: moment().subtract(1, 'days').toDate(),\n+        type: MessageType.TEXT,\n+        holders: [user1, user5],\n+        recipients: [\n+          new Recipient({\n+            user: user5,\n+          }),\n+        ],\n+      }),\n+      new Message({\n+        sender: user1,\n+        content: 'You still there?',\n+        createdAt: moment().subtract(1, 'days').add(16, 'hours').toDate(),\n+        type: MessageType.TEXT,\n+        holders: [user1, user5],\n+        recipients: [\n+          new Recipient({\n+            user: user5,\n+          }),\n+        ],\n+      }),\n+    ],\n+  }));\n+\n+  await connection.manager.save(new Chat({\n+    allTimeMembers: [user3, user4],\n+    listingMembers: [user3, user4],\n+    messages: [\n+      new Message({\n+        sender: user3,\n+        content: 'Look at my mukluks!',\n+        createdAt: moment().subtract(4, 'days').toDate(),\n+        type: MessageType.TEXT,\n+        holders: [user3, user4],\n+        recipients: [\n+          new Recipient({\n+            user: user4,\n+          }),\n+        ],\n+      }),\n+    ],\n+  }));\n+\n+  await connection.manager.save(new Chat({\n+    allTimeMembers: [user2, user5],\n+    listingMembers: [user2, user5],\n+    messages: [\n+      new Message({\n+        sender: user2,\n+        content: 'This is wicked good ice cream.',\n+        createdAt: moment().subtract(2, 'weeks').toDate(),\n+        type: MessageType.TEXT,\n+        holders: [user2, user5],\n+        recipients: [\n+          new Recipient({\n+            user: user5,\n+          }),\n+        ],\n+      }),\n+      new Message({\n+        sender: user5,\n+        content: 'Love it!',\n+        createdAt: moment().subtract(2, 'weeks').add(10, 'minutes').toDate(),\n+        type: MessageType.TEXT,\n+        holders: [user2, user5],\n+        recipients: [\n+          new Recipient({\n+            user: user2,\n+          }),\n+        ],\n+      }),\n+    ],\n+  }));\n+\n+  await connection.manager.save(new Chat({\n+    allTimeMembers: [user1, user6],\n+    listingMembers: [user1],\n+  }));\n+\n+  await connection.manager.save(new Chat({\n+    allTimeMembers: [user2, user1],\n+    listingMembers: [user2],\n+  }));\n+\n+  await connection.manager.save(new Chat({\n+    name: 'Ethan\\'s group',\n+    picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n+    allTimeMembers: [user1, user3, user4, user6],\n+    listingMembers: [user1, user3, user4, user6],\n+    actualGroupMembers: [user1, user4, user6],\n+    admins: [user1, user6],\n+    owner: user1,\n+    messages: [\n+      new Message({\n+        sender: user1,\n+        content: 'I made a group',\n+        createdAt: moment().subtract(2, 'weeks').toDate(),\n+        type: MessageType.TEXT,\n+        holders: [user1, user3, user4, user6],\n+        recipients: [\n+          new Recipient({\n+            user: user3,\n+          }),\n+          new Recipient({\n+            user: user4,\n+          }),\n+          new Recipient({\n+            user: user6,\n+          }),\n+        ],\n+      }),\n+      new Message({\n+        sender: user1,\n+        content: 'Ops, Avery was not supposed to be here',\n+        createdAt: moment().subtract(2, 'weeks').add(2, 'minutes').toDate(),\n+        type: MessageType.TEXT,\n+        holders: [user1, user4, user6],\n+        recipients: [\n+          new Recipient({\n+            user: user4,\n+          }),\n+          new Recipient({\n+            user: user6,\n+          }),\n+        ],\n+      }),\n+      new Message({\n+        sender: user4,\n+        content: 'Awesome!',\n+        createdAt: moment().subtract(2, 'weeks').add(10, 'minutes').toDate(),\n+        type: MessageType.TEXT,\n+        holders: [user1, user4, user6],\n+        recipients: [\n+          new Recipient({\n+            user: user1,\n+          }),\n+          new Recipient({\n+            user: user6,\n+          }),\n+        ],\n+      }),\n+    ],\n+  }));\n+\n+  await connection.manager.save(new Chat({\n+    name: 'Ray\\'s group',\n+    allTimeMembers: [user3, user6],\n+    listingMembers: [user3, user6],\n+    actualGroupMembers: [user3, user6],\n+    admins: [user6],\n+    owner: user6,\n+  }));\n+}\ndiff --git a/server/entity/Chat.ts b/server/entity/Chat.ts\nnew file mode 100644\nindex 0000000..827aa59\n--- /dev/null\n+++ b/server/entity/Chat.ts\n@@ -0,0 +1,79 @@\n+import { Entity, Column, PrimaryGeneratedColumn, OneToMany, JoinTable, ManyToMany, ManyToOne } from \"typeorm\";\n+import { Message } from \"./Message\";\n+import { User } from \"./User\";\n+import { Recipient } from \"./Recipient\";\n+\n+interface ChatConstructor {\n+  name?: string;\n+  picture?: string;\n+  allTimeMembers?: User[];\n+  listingMembers?: User[];\n+  actualGroupMembers?: User[];\n+  admins?: User[];\n+  owner?: User;\n+  messages?: Message[];\n+}\n+\n+@Entity()\n+export class Chat {\n+  @PrimaryGeneratedColumn()\n+  id: number;\n+\n+  @Column({nullable: true})\n+  name: string;\n+\n+  @Column({nullable: true})\n+  picture: string;\n+\n+  @ManyToMany(type => User, user => user.allTimeMemberChats, {cascade: [\"insert\", \"update\"], eager: false})\n+  @JoinTable()\n+  allTimeMembers: User[];\n+\n+  @ManyToMany(type => User, user => user.listingMemberChats, {cascade: [\"insert\", \"update\"], eager: false})\n+  @JoinTable()\n+  listingMembers: User[];\n+\n+  @ManyToMany(type => User, user => user.actualGroupMemberChats, {cascade: [\"insert\", \"update\"], eager: false})\n+  @JoinTable()\n+  actualGroupMembers?: User[];\n+\n+  @ManyToMany(type => User, user => user.adminChats, {cascade: [\"insert\", \"update\"], eager: false})\n+  @JoinTable()\n+  admins?: User[];\n+\n+  @ManyToOne(type => User, user => user.ownerChats, {cascade: [\"insert\", \"update\"], eager: false})\n+  owner?: User | null;\n+\n+  @OneToMany(type => Message, message => message.chat, {cascade: [\"insert\", \"update\"], eager: true})\n+  messages: Message[];\n+\n+  @OneToMany(type => Recipient, recipient => recipient.chat)\n+  recipients: Recipient[];\n+\n+  constructor({name, picture, allTimeMembers, listingMembers, actualGroupMembers, admins, owner, messages}: ChatConstructor = {}) {\n+    if (name) {\n+      this.name = name;\n+    }\n+    if (picture) {\n+      this.picture = picture;\n+    }\n+    if (allTimeMembers) {\n+      this.allTimeMembers = allTimeMembers;\n+    }\n+    if (listingMembers) {\n+      this.listingMembers = listingMembers;\n+    }\n+    if (actualGroupMembers) {\n+      this.actualGroupMembers = actualGroupMembers;\n+    }\n+    if (admins) {\n+      this.admins = admins;\n+    }\n+    if (owner) {\n+      this.owner = owner;\n+    }\n+    if (messages) {\n+      this.messages = messages;\n+    }\n+  }\n+}\ndiff --git a/server/entity/Message.ts b/server/entity/Message.ts\nnew file mode 100644\nindex 0000000..36f7701\n--- /dev/null\n+++ b/server/entity/Message.ts\n@@ -0,0 +1,70 @@\n+import {\n+  Entity, Column, PrimaryGeneratedColumn, OneToMany, ManyToOne, ManyToMany, JoinTable, CreateDateColumn\n+} from \"typeorm\";\n+import { Chat } from \"./Chat\";\n+import { User } from \"./User\";\n+import { Recipient } from \"./Recipient\";\n+import { MessageType } from \"../db\";\n+\n+interface MessageConstructor {\n+  sender?: User;\n+  content?: string;\n+  createdAt?: Date,\n+  type?: MessageType;\n+  recipients?: Recipient[];\n+  holders?: User[];\n+  chat?: Chat;\n+}\n+\n+@Entity()\n+export class Message {\n+  @PrimaryGeneratedColumn()\n+  id: number;\n+\n+  @ManyToOne(type => User, user => user.senderMessages, {eager: true})\n+  sender: User;\n+\n+  @Column()\n+  content: string;\n+\n+  @CreateDateColumn({nullable: true})\n+  createdAt: Date;\n+\n+  @Column()\n+  type: number;\n+\n+  @OneToMany(type => Recipient, recipient => recipient.message, {cascade: [\"insert\", \"update\"], eager: true})\n+  recipients: Recipient[];\n+\n+  @ManyToMany(type => User, user => user.holderMessages, {cascade: [\"insert\", \"update\"], eager: true})\n+  @JoinTable()\n+  holders: User[];\n+\n+  @ManyToOne(type => Chat, chat => chat.messages)\n+  chat: Chat;\n+\n+  constructor({sender, content, createdAt, type, recipients, holders, chat}: MessageConstructor = {}) {\n+    if (sender) {\n+      this.sender = sender;\n+    }\n+    if (content) {\n+      this.content = content;\n+    }\n+    if (createdAt) {\n+      this.createdAt = createdAt;\n+    }\n+    if (type) {\n+      this.type = type;\n+    }\n+    if (recipients) {\n+      recipients.forEach(recipient => recipient.message = this);\n+      this.recipients = recipients;\n+    }\n+    if (holders) {\n+      this.holders = holders;\n+    }\n+    if (chat) {\n+      this.chat = chat;\n+    }\n+  }\n+}\ndiff --git a/server/entity/Recipient.ts b/server/entity/Recipient.ts\nnew file mode 100644\nindex 0000000..4ad5542\n--- /dev/null\n+++ b/server/entity/Recipient.ts\n@@ -0,0 +1,44 @@\n+import { Entity, ManyToOne, Column } from \"typeorm\";\n+import { Message } from \"./Message\";\n+import { User } from \"./User\";\n+import { Chat } from \"./Chat\";\n+\n+interface RecipientConstructor {\n+  user?: User;\n+  message?: Message;\n+  receivedAt?: Date;\n+  readAt?: Date;\n+}\n+\n+@Entity()\n+export class Recipient {\n+  @ManyToOne(type => User, user => user.recipients, { primary: true })\n+  user: User;\n+\n+  @ManyToOne(type => Message, message => message.recipients, { primary: true })\n+  message: Message;\n+\n+  @ManyToOne(type => Chat, chat => chat.recipients)\n+  chat: Chat;\n+\n+  @Column({nullable: true})\n+  receivedAt: Date;\n+\n+  @Column({nullable: true})\n+  readAt: Date;\n+\n+  constructor({user, message, receivedAt, readAt}: RecipientConstructor = {}) {\n+    if (user) {\n+      this.user = user;\n+    }\n+    if (message) {\n+      this.message = message;\n+    }\n+    if (receivedAt) {\n+      this.receivedAt = receivedAt;\n+    }\n+    if (readAt) {\n+      this.readAt = readAt;\n+    }\n+  }\n+}\ndiff --git a/server/entity/User.ts b/server/entity/User.ts\nnew file mode 100644\nindex 0000000..454ef60\n--- /dev/null\n+++ b/server/entity/User.ts\n@@ -0,0 +1,75 @@\n+import { Entity, Column, PrimaryGeneratedColumn, ManyToMany, OneToMany } from \"typeorm\";\n+import { Chat } from \"./Chat\";\n+import { Message } from \"./Message\";\n+import { Recipient } from \"./Recipient\";\n+\n+interface UserConstructor {\n+  username?: string;\n+  password?: string;\n+  name?: string;\n+  picture?: string;\n+  phone?: string;\n+}\n+\n+@Entity()\n+export class User {\n+  @PrimaryGeneratedColumn()\n+  id: number;\n+\n+  @Column()\n+  username: string;\n+\n+  @Column()\n+  password: string;\n+\n+  @Column()\n+  name: string;\n+\n+  @Column({nullable: true})\n+  picture: string;\n+\n+  @Column({nullable: true})\n+  phone?: string;\n+\n+  @ManyToMany(type => Chat, chat => chat.allTimeMembers)\n+  allTimeMemberChats: Chat[];\n+\n+  @ManyToMany(type => Chat, chat => chat.listingMembers)\n+  listingMemberChats: Chat[];\n+\n+  @ManyToMany(type => Chat, chat => chat.actualGroupMembers)\n+  actualGroupMemberChats: Chat[];\n+\n+  @ManyToMany(type => Chat, chat => chat.admins)\n+  adminChats: Chat[];\n+\n+  @ManyToMany(type => Message, message => message.holders)\n+  holderMessages: Message[];\n+\n+  @OneToMany(type => Chat, chat => chat.owner)\n+  ownerChats: Chat[];\n+\n+  @OneToMany(type => Message, message => message.sender)\n+  senderMessages: Message[];\n+\n+  @OneToMany(type => Recipient, recipient => recipient.user)\n+  recipients: Recipient[];\n+\n+  constructor({username, password, name, picture, phone}: UserConstructor = {}) {\n+    if (username) {\n+      this.username = username;\n+    }\n+    if (password) {\n+      this.password = password;\n+    }\n+    if (name) {\n+      this.name = name;\n+    }\n+    if (picture) {\n+      this.picture = picture;\n+    }\n+    if (phone) {\n+      this.phone = phone;\n+    }\n+  }\n+}\ndiff --git a/server/index.ts b/server/index.ts\nnew file mode 100644\nindex 0000000..f8063a6\n--- /dev/null\n+++ b/server/index.ts\n@@ -0,0 +1,119 @@\n+// For TypeORM\n+import \"reflect-metadata\";\n+import { schema } from \"./schema\";\n+import * as bodyParser from \"body-parser\";\n+import * as cors from 'cors';\n+import * as express from 'express';\n+import { graphiqlExpress, graphqlExpress } from \"apollo-server-express\";\n+import * as passport from \"passport\";\n+import * as basicStrategy from 'passport-http';\n+import * as bcrypt from 'bcrypt-nodejs';\n+import { createServer } from \"http\";\n+import { SubscriptionServer } from \"subscriptions-transport-ws\";\n+import { execute, subscribe } from \"graphql\";\n+import { createConnection } from \"typeorm\";\n+import { User } from \"./entity/User\";\n+import { addSampleData } from \"./db\";\n+\n+function generateHash(password: string) {\n+  return bcrypt.hashSync(password, bcrypt.genSaltSync(8));\n+}\n+\n+function validPassword(password: string, localPassword: string) {\n+  return bcrypt.compareSync(password, localPassword);\n+}\n+\n+createConnection().then(async connection => {\n+  await addSampleData(connection);\n+\n+  passport.use('basic-signin', new basicStrategy.BasicStrategy(\n+    async function (username, password, done) {\n+      const user = await connection.getRepository(User).findOne({where: { username }});\n+      if (user && validPassword(password, user.password)) {\n+        return done(null, user);\n+      }\n+      return done(null, false);\n+    }\n+  ));\n+\n+  passport.use('basic-signup', new basicStrategy.BasicStrategy({passReqToCallback: true},\n+    async function (req: any, username: any, password: any, done: any) {\n+      const userExists = !!(await connection.getRepository(User).findOne({where: { username }}));\n+      if (!userExists && password && req.body.name) {\n+        const user = await connection.manager.save(new User({\n+          username,\n+          password: generateHash(password),\n+          name: req.body.name,\n+        }));\n+        return done(null, user);\n+      }\n+      return done(null, false);\n+    }\n+  ));\n+\n+  const PORT = 3000;\n+\n+  const app = express();\n+\n+  app.use(cors());\n+  app.use(bodyParser.json());\n+  app.use(passport.initialize());\n+\n+  app.post('/signup',\n+    passport.authenticate('basic-signup', {session: false}),\n+    function (req, res) {\n+      res.json(req.user);\n+    });\n+\n+  app.use(passport.authenticate('basic-signin', {session: false}));\n+\n+  app.post('/signin', function (req, res) {\n+    res.json(req.user);\n+  });\n+\n+  app.use('/graphql', graphqlExpress(req => ({\n+    schema: schema,\n+    context: {\n+      user: req!['user'],\n+      connection,\n+    },\n+  })));\n+\n+  app.use('/graphiql', graphiqlExpress({\n+    endpointURL: '/graphql',\n+  }));\n+\n+// Wrap the Express server\n+  const ws = createServer(app);\n+  ws.listen(PORT, () => {\n+    console.log(`Apollo Server is now running on http://localhost:${PORT}`);\n+    // Set up the WebSocket for handling GraphQL subscriptions\n+    new SubscriptionServer({\n+      onConnect: async (connectionParams: any, webSocket: any) => {\n+        if (connectionParams.authToken) {\n+          // Create a buffer and tell it the data coming in is base64\n+          const buf = new Buffer(connectionParams.authToken.split(' ')[1], 'base64');\n+          // Read it back out as a string\n+          const [username, password]: string[] = buf.toString().split(':');\n+          if (username && password) {\n+            const user = await connection.getRepository(User).findOne({where: { username }});\n+\n+            if (user && validPassword(password, user.password)) {\n+              // Set context for the WebSocket\n+              return {user, connection};\n+            } else {\n+              throw new Error('Wrong credentials!');\n+            }\n+          }\n+        }\n+        throw new Error('Missing auth token!');\n+      },\n+      execute,\n+      subscribe,\n+      schema\n+    }, {\n+      server: ws,\n+      path: '/subscriptions',\n+    });\n+  });\n+});\ndiff --git a/server/ormconfig.json b/server/ormconfig.json\nnew file mode 100644\nindex 0000000..029b87c\n--- /dev/null\n+++ b/server/ormconfig.json\n@@ -0,0 +1,24 @@\n+{\n+   \"type\": \"postgres\",\n+   \"host\": \"localhost\",\n+   \"port\": 5432,\n+   \"username\": \"test\",\n+   \"password\": \"\",\n+   \"database\": \"test\",\n+   \"synchronize\": true,\n+   \"logging\": false,\n+   \"entities\": [\n+      \"entity/**/*.ts\"\n+   ],\n+   \"migrations\": [\n+      \"migration/**/*.ts\"\n+   ],\n+   \"subscribers\": [\n+      \"subscriber/**/*.ts\"\n+   ],\n+   \"cli\": {\n+      \"entitiesDir\": \"entity\",\n+      \"migrationsDir\": \"migration\",\n+      \"subscribersDir\": \"subscriber\"\n+   }\n+}\n\\ No newline at end of file\ndiff --git a/server/package.json b/server/package.json\nnew file mode 100644\nindex 0000000..05d9063\n--- /dev/null\n+++ b/server/package.json\n@@ -0,0 +1,43 @@\n+{\n+  \"name\": \"whatsapp-server-express\",\n+  \"description\": \"A newly created Tortilla project\",\n+  \"private\": true,\n+  \"scripts\": {\n+    \"start\": \"npm run build:live\",\n+    \"build:live\": \"nodemon --exec ./node_modules/.bin/ts-node -- ./index.ts\",\n+    \"generator\": \"gql-gen --url http://localhost:3000/graphql --template ts --out ./types.d.ts\"\n+  },\n+  \"devDependencies\": {\n+    \"@types/bcrypt-nodejs\": \"0.0.30\",\n+    \"@types/body-parser\": \"1.16.8\",\n+    \"@types/cors\": \"2.8.3\",\n+    \"@types/express\": \"4.11.1\",\n+    \"@types/graphql\": \"0.12.6\",\n+    \"@types/node\": \"9.6.5\",\n+    \"@types/passport\": \"0.4.4\",\n+    \"@types/passport-http\": \"0.3.6\",\n+    \"@types/pg\": \"7.4.5\",\n+    \"@types/ws\": \"4.0.2\",\n+    \"nodemon\": \"1.17.3\",\n+    \"ts-node\": \"6.0.0\",\n+    \"typescript\": \"2.8.1\"\n+  },\n+  \"dependencies\": {\n+    \"apollo-server-express\": \"1.3.4\",\n+    \"bcrypt-nodejs\": \"0.0.3\",\n+    \"body-parser\": \"1.18.2\",\n+    \"cors\": \"2.8.4\",\n+    \"express\": \"4.16.3\",\n+    \"graphql\": \"0.12.3\",\n+    \"graphql-code-generator\": \"0.8.21\",\n+    \"graphql-subscriptions\": \"0.5.8\",\n+    \"graphql-tools\": \"2.24.0\",\n+    \"moment\": \"2.22.1\",\n+    \"passport\": \"0.4.0\",\n+    \"passport-http\": \"0.3.0\",\n+    \"pg\": \"7.4.1\",\n+    \"reflect-metadata\": \"0.1.12\",\n+    \"subscriptions-transport-ws\": \"0.9.7\",\n+    \"typeorm\": \"0.2.0-alpha.46\"\n+  }\n+}\ndiff --git a/server/schema/index.ts b/server/schema/index.ts\nnew file mode 100644\nindex 0000000..cedee02\n--- /dev/null\n+++ b/server/schema/index.ts\n@@ -0,0 +1,10 @@\n+import { makeExecutableSchema } from 'graphql-tools';\n+import { typeDefs } from \"./typeDefs\";\n+import { resolvers } from \"./resolvers\";\n+import { IExecutableSchemaDefinition } from \"graphql-tools/dist/Interfaces\";\n+import { GraphQLSchema } from \"graphql\";\n+\n+export const schema: GraphQLSchema = makeExecutableSchema(<IExecutableSchemaDefinition>{\n+  typeDefs,\n+  resolvers,\n+});\n\\ No newline at end of file\ndiff --git a/server/schema/resolvers.ts b/server/schema/resolvers.ts\nnew file mode 100644\nindex 0000000..d901f79\n--- /dev/null\n+++ b/server/schema/resolvers.ts\n@@ -0,0 +1,484 @@\n+import { MessageType } from \"../db\";\n+import { IResolvers } from \"graphql-tools/dist/Interfaces\";\n+import {\n+  AddChatMutationArgs, AddGroupMutationArgs, AddMessageMutationArgs, ChatQueryArgs, MessageAddedSubscriptionArgs,\n+  RemoveChatMutationArgs, RemoveMessagesMutationArgs\n+} from \"../types\";\n+import * as moment from \"moment\";\n+import { PubSub, withFilter } from \"graphql-subscriptions\";\n+import { User } from \"../entity/User\";\n+import { Chat } from \"../entity/Chat\";\n+import { Message } from \"../entity/Message\";\n+import { Recipient } from \"../entity/Recipient\";\n+import { Connection } from \"typeorm\";\n+\n+export const pubsub = new PubSub();\n+\n+export const resolvers: IResolvers = {\n+  Query: {\n+    // Show all users for the moment.\n+    users: async (obj: any, args: any, {user: currentUser, connection}: { user: User, connection: Connection }): Promise<User[]> => {\n+      return await connection\n+        .createQueryBuilder(User, \"user\")\n+        .where('user.id != :id', {id: currentUser.id})\n+        .getMany();\n+    },\n+    chats: async (obj: any, args: any, {user: currentUser, connection}: { user: User, connection: Connection }): Promise<any[]> => {\n+      return await connection\n+        .createQueryBuilder(Chat, \"chat\")\n+        .leftJoin('chat.listingMembers', 'listingMembers')\n+        .where('listingMembers.id = :id', {id: currentUser.id})\n+        .getMany();\n+    },\n+    chat: async (obj: any, {chatId}: ChatQueryArgs, {connection}: { user: User, connection: Connection }): Promise<any> => {\n+      return await connection\n+        .createQueryBuilder(Chat, \"chat\")\n+        .whereInIds(chatId)\n+        .getOne();\n+    },\n+  },\n+  Mutation: {\n+    addChat: async (obj: any, {recipientId}: AddChatMutationArgs, {user: currentUser, connection}: { user: User, connection: Connection }): Promise<Chat | null> => {\n+      const recipient = await connection\n+        .createQueryBuilder(User, \"user\")\n+        .whereInIds(recipientId)\n+        .getOne();\n+\n+      if (!recipient) {\n+        throw new Error(`Recipient ${recipientId} doesn't exist.`);\n+      }\n+\n+      let chat = await connection\n+        .createQueryBuilder(Chat, \"chat\")\n+        .where('chat.name IS NULL')\n+        .innerJoin('chat.allTimeMembers', 'allTimeMembers1', 'allTimeMembers1.id = :currentUserId', {currentUserId: currentUser.id})\n+        .innerJoin('chat.allTimeMembers', 'allTimeMembers2', 'allTimeMembers2.id = :recipientId', {recipientId})\n+        .innerJoinAndSelect('chat.listingMembers', 'listingMembers')\n+        .getOne();\n+\n+      if (chat) {\n+        // Chat already exists. Both users are already in the userIds array\n+        const listingMembers = await connection\n+          .createQueryBuilder(User, \"user\")\n+          .innerJoin('user.listingMemberChats', 'listingMemberChats', 'listingMemberChats.id = :chatId', {chatId: chat.id})\n+          .getMany();\n+\n+        if (!listingMembers.find(user => user.id === currentUser.id)) {\n+          // The chat isn't listed for the current user. Add him to the memberIds\n+          chat.listingMembers.push(currentUser);\n+          chat = await connection.getRepository(Chat).save(chat);\n+\n+          return chat || null;\n+        } else {\n+          throw new Error(`Chat already exists.`);\n+        }\n+      } else {\n+        // Create the chat\n+        chat = await connection.getRepository(Chat).save(new Chat({\n+          allTimeMembers: [currentUser, recipient],\n+          // Chat will not be listed to the other user until the first message gets written\n+          listingMembers: [currentUser],\n+        }));\n+\n+        return chat || null;\n+      }\n+    },\n+    addGroup: async (obj: any, {recipientIds, groupName}: AddGroupMutationArgs, {user: currentUser, connection}: { user: User, connection: Connection }): Promise<Chat | null> => {\n+      let recipients: User[] = [];\n+      for (let recipientId of recipientIds) {\n+        const recipient = await connection\n+          .createQueryBuilder(User, \"user\")\n+          .whereInIds(recipientId)\n+          .getOne();\n+        if (!recipient) {\n+          throw new Error(`Recipient ${recipientId} doesn't exist.`);\n+        }\n+        recipients.push(recipient);\n+      }\n+\n+      const chat = await connection.getRepository(Chat).save(new Chat({\n+        name: groupName,\n+        admins: [currentUser],\n+        owner: currentUser,\n+        allTimeMembers: [...recipients, currentUser],\n+        listingMembers: [...recipients, currentUser],\n+        actualGroupMembers: [...recipients, currentUser],\n+      }));\n+\n+      pubsub.publish('chatAdded', {\n+        creatorId: currentUser.id,\n+        chatAdded: chat,\n+      });\n+\n+      return chat || null;\n+    },\n+    removeChat: async (obj: any, {chatId}: RemoveChatMutationArgs, {user: currentUser, connection}: { user: User, connection: Connection }) => {\n+      const chat = await connection\n+        .createQueryBuilder(Chat, \"chat\")\n+        .whereInIds(Number(chatId))\n+        .innerJoinAndSelect('chat.listingMembers', 'listingMembers')\n+        .leftJoinAndSelect('chat.actualGroupMembers', 'actualGroupMembers')\n+        .leftJoinAndSelect('chat.admins', 'admins')\n+        .leftJoinAndSelect('chat.owner', 'owner')\n+        .leftJoinAndSelect('chat.messages', 'messages')\n+        .leftJoinAndSelect('messages.holders', 'holders')\n+        .getOne();\n+\n+      if (!chat) {\n+        throw new Error(`The chat ${chatId} doesn't exist.`);\n+      }\n+\n+      if (!chat.name) {\n+        // Chat\n+        if (!chat.listingMembers.find(user => user.id === currentUser.id)) {\n+          throw new Error(`The user is not a listing member of the chat ${chatId}.`);\n+        }\n+\n+        // Instead of chaining map and filter we can loop once using reduce\n+        chat.messages = await chat.messages.reduce<Promise<Message[]>>(async (filtered$, message) => {\n+          const filtered = await filtered$;\n+\n+          message.holders = message.holders.filter(user => user.id !== currentUser.id);\n+\n+          if (message.holders.length !== 0) {\n+            // Remove the current user from the message holders\n+            await connection.getRepository(Message).save(message);\n+            filtered.push(message);\n+          } else {\n+            // Simply remove the message\n+            const recipients = await connection\n+              .createQueryBuilder(Recipient, \"recipient\")\n+              .innerJoinAndSelect('recipient.message', 'message', 'message.id = :messageId', {messageId: message.id})\n+              .innerJoinAndSelect('recipient.user', 'user')\n+              .getMany();\n+            for (let recipient of recipients) {\n+              await connection.getRepository(Recipient).remove(recipient);\n+            }\n+            await connection.getRepository(Message).remove(message);\n+          }\n+\n+          return filtered;\n+        }, Promise.resolve([]));\n+\n+        // Remove the current user from who gets the chat listed. The chat will no longer appear in his list\n+        chat.listingMembers = chat.listingMembers.filter(user => user.id !== currentUser.id);\n+\n+        // Check how many members are left\n+        if (chat.listingMembers.length === 0) {\n+          // Delete the chat\n+          await connection.getRepository(Chat).remove(chat);\n+        } else {\n+          // Update the chat\n+          await connection.getRepository(Chat).save(chat);\n+        }\n+        return chatId;\n+      } else {\n+        // Group\n+\n+        // Instead of chaining map and filter we can loop once using reduce\n+        chat.messages = await chat.messages.reduce<Promise<Message[]>>(async (filtered$, message) => {\n+          const filtered = await filtered$;\n+\n+          message.holders = message.holders.filter(user => user.id !== currentUser.id);\n+\n+          if (message.holders.length !== 0) {\n+            // Remove the current user from the message holders\n+            await connection.getRepository(Message).save(message);\n+            filtered.push(message);\n+          } else {\n+            // Simply remove the message\n+            const recipients = await connection\n+              .createQueryBuilder(Recipient, \"recipient\")\n+              .innerJoinAndSelect('recipient.message', 'message', 'message.id = :messageId', {messageId: message.id})\n+              .innerJoinAndSelect('recipient.user', 'user')\n+              .getMany();\n+            for (let recipient of recipients) {\n+              await connection.getRepository(Recipient).remove(recipient);\n+            }\n+            await connection.getRepository(Message).remove(message);\n+          }\n+\n+          return filtered;\n+        }, Promise.resolve([]));\n+\n+        // Remove the current user from who gets the group listed. The group will no longer appear in his list\n+        chat.listingMembers = chat.listingMembers.filter(user => user.id !== currentUser.id);\n+\n+        // Check how many members (including previous ones who can still access old messages) are left\n+        if (chat.listingMembers.length === 0) {\n+          // Remove the group\n+          await connection.getRepository(Chat).remove(chat);\n+        } else {\n+          // Update the group\n+\n+          // Remove the current user from the chat members. He is no longer a member of the group\n+          chat.actualGroupMembers = chat.actualGroupMembers && chat.actualGroupMembers.filter(user => user.id !== currentUser.id);\n+          // Remove the current user from the chat admins\n+          chat.admins = chat.admins && chat.admins.filter(user => user.id !== currentUser.id);\n+          // If there are no more admins left the group goes read only\n+          chat.owner = chat.admins && chat.admins[0] || null; // A null owner means the group is read-only\n+\n+          await connection.getRepository(Chat).save(chat);\n+        }\n+        return chatId;\n+      }\n+    },\n+    addMessage: async (obj: any, {chatId, content}: AddMessageMutationArgs, {user: currentUser, connection}: { user: User, connection: Connection }): Promise<Message | null> => {\n+      if (content === null || content === '') {\n+        throw new Error(`Cannot add empty or null messages.`);\n+      }\n+\n+      let chat = await connection\n+        .createQueryBuilder(Chat, \"chat\")\n+        .whereInIds(chatId)\n+        .innerJoinAndSelect('chat.allTimeMembers', 'allTimeMembers')\n+        .innerJoinAndSelect('chat.listingMembers', 'listingMembers')\n+        .leftJoinAndSelect('chat.actualGroupMembers', 'actualGroupMembers')\n+        .getOne();\n+\n+      if (!chat) {\n+        throw new Error(`Cannot find chat ${chatId}.`);\n+      }\n+\n+      let holders: User[];\n+\n+      if (!chat.name) {\n+        // Chat\n+        if (!chat.listingMembers.map(user => user.id).includes(currentUser.id)) {\n+          throw new Error(`The chat ${chatId} must be listed for the current user before adding a message.`);\n+        }\n+\n+        const recipientUser = chat.allTimeMembers.find(user => user.id !== currentUser.id);\n+\n+        if (!recipientUser) {\n+          throw new Error(`Cannot find recipient user.`);\n+        }\n+\n+        if (!chat.listingMembers.find(user => user.id === recipientUser.id)) {\n+          // Chat is not listed for the recipient. Add him to the listingIds\n+          chat.listingMembers.push(recipientUser);\n+\n+          await connection.getRepository(Chat).save(chat);\n+\n+          pubsub.publish('chatAdded', {\n+            creatorId: currentUser.id,\n+            chatAdded: chat,\n+          });\n+        }\n+\n+        holders = chat.listingMembers;\n+      } else {\n+        // Group\n+        if (!chat.actualGroupMembers || !chat.actualGroupMembers.find(user => user.id === currentUser.id)) {\n+          throw new Error(`The user is not a member of the group ${chatId}. Cannot add message.`);\n+        }\n+\n+        holders = chat.actualGroupMembers;\n+      }\n+\n+      const message = await connection.getRepository(Message).save(new Message({\n+        chat: chat,\n+        sender: currentUser,\n+        content,\n+        type: MessageType.TEXT,\n+        holders,\n+        recipients: holders.reduce<Recipient[]>((filtered, user) => {\n+          if (user.id !== currentUser.id) {\n+            filtered.push(new Recipient({\n+              user,\n+            }));\n+          }\n+          return filtered;\n+        }, []),\n+      }));\n+\n+      pubsub.publish('messageAdded', {\n+        messageAdded: message,\n+      });\n+\n+      return message || null;\n+    },\n+    removeMessages: async (obj: any, {chatId, messageIds, all}: RemoveMessagesMutationArgs, {user: currentUser, connection}: { user: User, connection: Connection }) => {\n+      const chat = await connection\n+        .createQueryBuilder(Chat, \"chat\")\n+        .whereInIds(chatId)\n+        .innerJoinAndSelect('chat.listingMembers', 'listingMembers')\n+        .innerJoinAndSelect('chat.messages', 'messages')\n+        .innerJoinAndSelect('messages.holders', 'holders')\n+        .getOne();\n+\n+      if (!chat) {\n+        throw new Error(`Cannot find chat ${chatId}.`);\n+      }\n+\n+      if (!chat.listingMembers.find(user => user.id === currentUser.id)) {\n+        throw new Error(`The chat/group ${chatId} is not listed for the current user, so there is nothing to delete.`);\n+      }\n+\n+      if (all && messageIds) {\n+        throw new Error(`Cannot specify both 'all' and 'messageIds'.`);\n+      }\n+\n+      if (!all && !(messageIds && messageIds.length)) {\n+        throw new Error(`'all' and 'messageIds' cannot be both null`);\n+      }\n+\n+      let deletedIds: number[] = [];\n+      // Instead of chaining map and filter we can loop once using reduce\n+      chat.messages = await chat.messages.reduce<Promise<Message[]>>(async (filtered$, message) => {\n+        const filtered = await filtered$;\n+\n+        if (all || messageIds!.includes(String(message.id))) {\n+          deletedIds.push(message.id);\n+          // Remove the current user from the message holders\n+          message.holders = message.holders.filter(user => user.id !== currentUser.id);\n+\n+        }\n+\n+        if (message.holders.length !== 0) {\n+          // Remove the current user from the message holders\n+          await connection.getRepository(Message).save(message);\n+          filtered.push(message);\n+        } else {\n+          // Simply remove the message\n+          const recipients = await connection\n+            .createQueryBuilder(Recipient, \"recipient\")\n+            .innerJoinAndSelect('recipient.message', 'message', 'message.id = :messageId', {messageId: message.id})\n+            .innerJoinAndSelect('recipient.user', 'user')\n+            .getMany();\n+          for (let recipient of recipients) {\n+            await connection.getRepository(Recipient).remove(recipient);\n+          }\n+          await connection.getRepository(Message).remove(message);\n+        }\n+\n+        return filtered;\n+      }, Promise.resolve([]));\n+\n+      await connection.getRepository(Chat).save(chat);\n+\n+      return deletedIds;\n+    },\n+  },\n+  Subscription: {\n+    messageAdded: {\n+      subscribe: withFilter(() => pubsub.asyncIterator('messageAdded'),\n+        ({messageAdded}: {messageAdded: Message}, {chatId}: MessageAddedSubscriptionArgs, {user: currentUser}: { user: User }) => {\n+          return (!chatId || messageAdded.chat.id === Number(chatId)) &&\n+            !!messageAdded.recipients.find((recipient: Recipient) => recipient.user.id === currentUser.id);\n+        }),\n+    },\n+    chatAdded: {\n+      subscribe: withFilter(() => pubsub.asyncIterator('chatAdded'),\n+        ({creatorId, chatAdded}: {creatorId: string, chatAdded: Chat}, variables, {user: currentUser}: { user: User }) => {\n+          return Number(creatorId) !== currentUser.id &&\n+            !!chatAdded.listingMembers.find((user: User) => user.id === currentUser.id);\n+        }),\n+    }\n+  },\n+  Chat: {\n+    name: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<string | null> => {\n+      if (chat.name) {\n+        return chat.name;\n+      }\n+      const user = await connection\n+        .createQueryBuilder(User, \"user\")\n+        .where('user.id != :userId', {userId: currentUser.id})\n+        .innerJoin('user.allTimeMemberChats', 'allTimeMemberChats', 'allTimeMemberChats.id = :chatId', {chatId: chat.id})\n+        .getOne();\n+      return user && user.name || null;\n+    },\n+    picture: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<string | null> => {\n+      if (chat.name) {\n+        return chat.picture;\n+      }\n+      const user = await connection\n+        .createQueryBuilder(User, \"user\")\n+        .where('user.id != :userId', {userId: currentUser.id})\n+        .innerJoin('user.allTimeMemberChats', 'allTimeMemberChats', 'allTimeMemberChats.id = :chatId', {chatId: chat.id})\n+        .getOne();\n+      return user ? user.picture : null;\n+    },\n+    allTimeMembers: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User[]> => {\n+      return await connection\n+        .createQueryBuilder(User, \"user\")\n+        .innerJoin('user.allTimeMemberChats', 'allTimeMemberChats', 'allTimeMemberChats.id = :chatId', {chatId: chat.id})\n+        .getMany();\n+    },\n+    listingMembers: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User[]> => {\n+      return await connection\n+        .createQueryBuilder(User, \"user\")\n+        .innerJoin('user.listingMemberChats', 'listingMemberChats', 'listingMemberChats.id = :chatId', {chatId: chat.id})\n+        .getMany();\n+    },\n+    actualGroupMembers: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User[]> => {\n+      return await connection\n+        .createQueryBuilder(User, \"user\")\n+        .innerJoin('user.actualGroupMemberChats', 'actualGroupMemberChats', 'actualGroupMemberChats.id = :chatId', {chatId: chat.id})\n+        .getMany();\n+    },\n+    admins: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User[]> => {\n+      return await connection\n+        .createQueryBuilder(User, \"user\")\n+        .innerJoin('user.adminChats', 'adminChats', 'adminChats.id = :chatId', {chatId: chat.id})\n+        .getMany();\n+    },\n+    owner: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User | null> => {\n+      return await connection\n+        .createQueryBuilder(User, \"user\")\n+        .innerJoin('user.ownerChats', 'ownerChats', 'ownerChats.id = :chatId', {chatId: chat.id})\n+        .getOne() || null;\n+    },\n+    messages: async (chat: Chat, {amount = null}: {amount: number}, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<Message[]> => {\n+      const query = connection\n+        .createQueryBuilder(Message, \"message\")\n+        .innerJoin('message.chat', 'chat', 'chat.id = :chatId', {chatId: chat.id})\n+        .innerJoin('message.holders', 'holders', 'holders.id = :userId', {userId: currentUser.id})\n+        .orderBy({\"message.createdAt\": \"DESC\"});\n+      return (amount ? await query.take(amount).getMany() : await query.getMany()).reverse();\n+    },\n+    unreadMessages: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<number> => {\n+      return await connection\n+        .createQueryBuilder(Message, \"message\")\n+        .innerJoin('message.chat', 'chat', 'chat.id = :chatId', {chatId: chat.id})\n+        .innerJoin('message.recipients', 'recipients', 'recipients.user.id = :userId AND recipients.readAt IS NULL', {userId: currentUser.id})\n+        .getCount();\n+    },\n+    isGroup: (chat: Chat) => !!chat.name,\n+  },\n+  Message: {\n+    sender: async (message: Message, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User | null> => {\n+      return (await connection\n+        .createQueryBuilder(User, \"user\")\n+        .innerJoin('user.senderMessages', 'senderMessages', 'senderMessages.id = :messageId', {messageId: message.id})\n+        .getOne()) || null;\n+    },\n+    ownership: async (message: Message, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<boolean> => {\n+      return !!(await connection\n+        .createQueryBuilder(User, \"user\")\n+        .whereInIds(currentUser.id)\n+        .innerJoin('user.senderMessages', 'senderMessages', 'senderMessages.id = :messageId', {messageId: message.id})\n+        .getCount());\n+    },\n+    recipients: async (message: Message, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<Recipient[]> => {\n+      return await connection\n+        .createQueryBuilder(Recipient, \"recipient\")\n+        .innerJoinAndSelect('recipient.message', 'message', 'message.id = :messageId', {messageId: message.id})\n+        .innerJoinAndSelect('recipient.user', 'user')\n+        .innerJoinAndSelect('recipient.chat', 'chat')\n+        .getMany();\n+    },\n+    holders: async (message: Message, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User[]> => {\n+      return await connection\n+        .createQueryBuilder(User, \"user\")\n+        .innerJoin('user.holderMessages', 'holderMessages', 'holderMessages.id = :messageId', {messageId: message.id})\n+        .getMany();\n+    },\n+    chat: async (message: Message, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<Chat | null> => {\n+      return (await connection\n+        .createQueryBuilder(Chat, \"chat\")\n+        .innerJoin('chat.messages', 'messages', 'messages.id = :messageId', {messageId: message.id})\n+        .getOne()) || null;\n+    },\n+  },\n+};\ndiff --git a/server/schema/typeDefs.ts b/server/schema/typeDefs.ts\nnew file mode 100644\nindex 0000000..c09cad4\n--- /dev/null\n+++ b/server/schema/typeDefs.ts\n@@ -0,0 +1,91 @@\n+import { ITypeDefinitions } from \"graphql-tools/dist/Interfaces\";\n+\n+export const typeDefs: ITypeDefinitions = `\n+  type Query {\n+    users: [User!]\n+    chats: [Chat!]\n+    chat(chatId: ID!): Chat\n+  }\n+\n+  type Subscription {\n+    messageAdded(chatId: ID): Message\n+    chatAdded: Chat\n+  }\n+\n+  enum MessageType {\n+    LOCATION\n+    TEXT\n+    PICTURE\n+  }\n+\n+  type Chat {\n+    #May be a chat or a group\n+    id: ID!\n+    #Computed for chats\n+    name: String\n+    #Computed for chats\n+    picture: String\n+    #All members, current and past ones.\n+    allTimeMembers: [User!]!\n+    #Whoever gets the chat listed. For groups includes past members who still didn't delete the group.\n+    listingMembers: [User!]!\n+    #Actual members of the group (they are not the only ones who get the group listed). Null for chats.\n+    actualGroupMembers: [User!]!\n+    #Null for chats\n+    admins: [User!]\n+    #If null the group is read-only. Null for chats.\n+    owner: User\n+    messages(amount: Int): [Message]!\n+    #Computed property\n+    unreadMessages: Int!\n+    #Computed property\n+    isGroup: Boolean!\n+  }\n+\n+  type Message {\n+    id: ID!\n+    sender: User!\n+    chat: Chat!\n+    content: String!\n+    createdAt: String!\n+    #FIXME: should return MessageType\n+    type: Int!\n+    #Whoever received the message\n+    recipients: [Recipient!]!\n+    #Whoever still holds a copy of the message. Cannot be null because the message gets deleted otherwise\n+    holders: [User!]!\n+    #Computed property\n+    ownership: Boolean!\n+  }\n+\n+  type Recipient {\n+    user: User!\n+    message: Message!\n+    chat: Chat!\n+    receivedAt: String\n+    readAt: String\n+  }\n+\n+  type User {\n+    id: ID!\n+    name: String\n+    picture: String\n+    phone: String\n+  }\n+\n+  type Mutation {\n+    addChat(recipientId: ID!): Chat\n+    addGroup(recipientIds: [ID!]!, groupName: String!): Chat\n+    removeChat(chatId: ID!): ID\n+    addMessage(chatId: ID!, content: String!): Message\n+    removeMessages(chatId: ID!, messageIds: [ID], all: Boolean): [ID]\n+    addMembers(groupId: ID!, userIds: [ID!]!): [ID]\n+    removeMembers(groupId: ID!, userIds: [ID!]!): [ID]\n+    addAdmins(groupId: ID!, userIds: [ID!]!): [ID]\n+    removeAdmins(groupId: ID!, userIds: [ID!]!): [ID]\n+    setGroupName(groupId: ID!): String\n+    setGroupPicture(groupId: ID!): String\n+    markAsReceived(chatId: ID!): Boolean\n+    markAsRead(chatId: ID!): Boolean\n+  }\n+`;\ndiff --git a/server/tsconfig.json b/server/tsconfig.json\nnew file mode 100644\nindex 0000000..def032f\n--- /dev/null\n+++ b/server/tsconfig.json\n@@ -0,0 +1,60 @@\n+{\n+  \"compilerOptions\": {\n+    /* Basic Options */\n+    \"target\": \"es2017\",                       /* Specify ECMAScript target version: 'ES3' (default), 'ES5', 'ES2015', 'ES2016', 'ES2017', or 'ESNEXT'. */\n+    \"module\": \"commonjs\",                     /* Specify module code generation: 'none', 'commonjs', 'amd', 'system', 'umd', 'es2015', or 'ESNext'. */\n+    \"lib\": [                                  /* Specify library files to be included in the compilation:  */\n+      \"es2017\",\n+      \"esnext.asynciterable\"\n+    ],\n+    // \"allowJs\": true,                       /* Allow javascript files to be compiled. */\n+    // \"checkJs\": true,                       /* Report errors in .js files. */\n+    // \"jsx\": \"preserve\",                     /* Specify JSX code generation: 'preserve', 'react-native', or 'react'. */\n+    // \"declaration\": true,                   /* Generates corresponding '.d.ts' file. */\n+    // \"sourceMap\": true,                     /* Generates corresponding '.map' file. */\n+    // \"outFile\": \"./\",                       /* Concatenate and emit output to single file. */\n+    // \"outDir\": \"./\",                        /* Redirect output structure to the directory. */\n+    // \"rootDir\": \"./\",                       /* Specify the root directory of input files. Use to control the output directory structure with --outDir. */\n+    // \"removeComments\": true,                /* Do not emit comments to output. */\n+    // \"noEmit\": true,                        /* Do not emit outputs. */\n+    // \"importHelpers\": true,                 /* Import emit helpers from 'tslib'. */\n+    // \"downlevelIteration\": true,            /* Provide full support for iterables in 'for-of', spread, and destructuring when targeting 'ES5' or 'ES3'. */\n+    // \"isolatedModules\": true,               /* Transpile each file as a separate module (similar to 'ts.transpileModule'). */\n+\n+    /* Strict Type-Checking Options */\n+    \"strict\": true,                           /* Enable all strict type-checking options. */\n+    // \"noImplicitAny\": true,                 /* Raise error on expressions and declarations with an implied 'any' type. */\n+    // \"strictNullChecks\": true,              /* Enable strict null checks. */\n+    // See https://github.com/DefinitelyTyped/DefinitelyTyped/issues/21359\n+    \"strictFunctionTypes\": false,             /* Enable strict checking of function types. */\n+    // \"noImplicitThis\": true,                /* Raise error on 'this' expressions with an implied 'any' type. */\n+    // \"alwaysStrict\": true,                  /* Parse in strict mode and emit \"use strict\" for each source file. */\n+\n+    /* Additional Checks */\n+    // \"noUnusedLocals\": true,                /* Report errors on unused locals. */\n+    // \"noUnusedParameters\": true,            /* Report errors on unused parameters. */\n+    // \"noImplicitReturns\": true,             /* Report error when not all code paths in function return a value. */\n+    // \"noFallthroughCasesInSwitch\": true,    /* Report errors for fallthrough cases in switch statement. */\n+\n+    /* Module Resolution Options */\n+    // \"moduleResolution\": \"node\",            /* Specify module resolution strategy: 'node' (Node.js) or 'classic' (TypeScript pre-1.6). */\n+    // \"baseUrl\": \"./\",                       /* Base directory to resolve non-absolute module names. */\n+    // \"paths\": {},                           /* A series of entries which re-map imports to lookup locations relative to the 'baseUrl'. */\n+    // \"rootDirs\": [],                        /* List of root folders whose combined content represents the structure of the project at runtime. */\n+    // \"typeRoots\": [],                       /* List of folders to include type definitions from. */\n+    // \"types\": [],                           /* Type declaration files to be included in compilation. */\n+    // \"allowSyntheticDefaultImports\": true,  /* Allow default imports from modules with no default export. This does not affect code emit, just typechecking. */\n+    // \"preserveSymlinks\": true,              /* Do not resolve the real path of symlinks. */\n+\n+    /* Source Map Options */\n+    // \"sourceRoot\": \"./\",                    /* Specify the location where debugger should locate TypeScript files instead of source locations. */\n+    // \"mapRoot\": \"./\",                       /* Specify the location where debugger should locate map files instead of generated locations. */\n+    // \"inlineSourceMap\": true,               /* Emit a single file with source maps instead of having a separate file. */\n+    // \"inlineSources\": true,                 /* Emit the source alongside the sourcemaps within a single file; requires '--inlineSourceMap' or '--sourceMap' to be set. */\n+\n+    /* Experimental Options */\n+    \"experimentalDecorators\": true,           /* Enables experimental support for ES7 decorators. */\n+    \"emitDecoratorMetadata\": true,            /* Enables experimental support for emitting type metadata for decorators. */\n+    \"strictPropertyInitialization\": false\n+  }\n+}\n\\ No newline at end of file\ndiff --git a/server/types.d.ts b/server/types.d.ts\nnew file mode 100644\nindex 0000000..ce81b7a\n--- /dev/null\n+++ b/server/types.d.ts\n@@ -0,0 +1,127 @@\n+/* tslint:disable */\n+\n+export interface Query {\n+  users: User[];\n+  chats: Chat[];\n+  chat?: Chat | null;\n+}\n+\n+export interface User {\n+  id: string;\n+  name?: string | null;\n+  picture?: string | null;\n+  phone?: string | null;\n+}\n+\n+export interface Chat {\n+  id: string; /* May be a chat or a group */\n+  name?: string | null; /* Computed for chats */\n+  picture?: string | null; /* Computed for chats */\n+  allTimeMembers: User[]; /* All members, current and past ones. */\n+  listingMembers: User[]; /* Whoever gets the chat listed. For groups includes past members who still didn&#x27;t delete the group. */\n+  actualGroupMembers: User[]; /* Actual members of the group (they are not the only ones who get the group listed). Null for chats. */\n+  admins: User[]; /* Null for chats */\n+  owner?: User | null; /* If null the group is read-only. Null for chats. */\n+  messages: Message[];\n+  unreadMessages: number; /* Computed property */\n+  isGroup: boolean; /* Computed property */\n+}\n+\n+export interface Message {\n+  id: string;\n+  sender: User;\n+  chat: Chat;\n+  content: string;\n+  createdAt: string;\n+  type: number; /* FIXME: should return MessageType */\n+  recipients: Recipient[]; /* Whoever received the message */\n+  holders: User[]; /* Whoever still holds a copy of the message. Cannot be null because the message gets deleted otherwise */\n+  ownership: boolean; /* Computed property */\n+}\n+\n+export interface Recipient {\n+  user: User;\n+  message: Message;\n+  receivedAt?: string | null;\n+  readAt?: string | null;\n+}\n+\n+export interface Mutation {\n+  addChat?: Chat | null;\n+  addGroup?: Chat | null;\n+  removeChat?: string | null;\n+  addMessage?: Message | null;\n+  removeMessages?: string[] | null;\n+  addMembers?: string[] | null;\n+  removeMembers?: string[] | null;\n+  addAdmins?: string[] | null;\n+  removeAdmins?: string[] | null;\n+  setGroupName?: string | null;\n+  setGroupPicture?: string | null;\n+  markAsReceived?: boolean | null;\n+  markAsRead?: boolean | null;\n+}\n+\n+export interface Subscription {\n+  messageAdded?: Message | null;\n+  chatAdded?: Chat | null;\n+}\n+export interface ChatQueryArgs {\n+  chatId: string;\n+}\n+export interface MessagesChatArgs {\n+  amount?: number | null;\n+}\n+export interface AddChatMutationArgs {\n+  recipientId: string;\n+}\n+export interface AddGroupMutationArgs {\n+  recipientIds: string[];\n+  groupName: string;\n+}\n+export interface RemoveChatMutationArgs {\n+  chatId: string;\n+}\n+export interface AddMessageMutationArgs {\n+  chatId: string;\n+  content: string;\n+}\n+export interface RemoveMessagesMutationArgs {\n+  chatId: string;\n+  messageIds?: string[] | null;\n+  all?: boolean | null;\n+}\n+export interface AddMembersMutationArgs {\n+  groupId: string;\n+  userIds: string[];\n+}\n+export interface RemoveMembersMutationArgs {\n+  groupId: string;\n+  userIds: string[];\n+}\n+export interface AddAdminsMutationArgs {\n+  groupId: string;\n+  userIds: string[];\n+}\n+export interface RemoveAdminsMutationArgs {\n+  groupId: string;\n+  userIds: string[];\n+}\n+export interface SetGroupNameMutationArgs {\n+  groupId: string;\n+}\n+export interface SetGroupPictureMutationArgs {\n+  groupId: string;\n+}\n+export interface MarkAsReceivedMutationArgs {\n+  chatId: string;\n+}\n+export interface MarkAsReadMutationArgs {\n+  chatId: string;\n+}\n+export interface MessageAddedSubscriptionArgs {\n+  chatId?: string | null;\n+}\n+\n+export type MessageType = \"LOCATION\" | \"TEXT\" | \"PICTURE\";\n+\n",
        "manuals": [
          {
            "manualTitle": "A Whatsapp clone written with Angular, Material, Express, Postgresql and Apollo GraphQL.",
            "stepRevision": "56e3257d75fc18dd1850ba8a76ecdc46ad19f508",
            "manualView": "## Startup instructions\n\nThis project is made out of 2 sub-projects - the one is client and the other is server. We will go through the initialization for each of these individually. We will start with the server since the client is dependent on it.\n\n### Server\n\nFirst we need to clone the server project:\n\n    $ git clone git@github.com:Urigo/whatsapp-server-express.git\n\nThen we need to install the NPM dependencies:\n\n    $ npm install\n\nBefore starting the server make sure that postgresql is installed:\n\n    $ sudo apt-get update\n    $ sudo apt-get install postgresql postgresql-contrib\n\nSetup a user named \"test\" with no password by first switching into \"postgres\" account:\n\n    $ sudo -u postgres psql\n\nAnd running the following command:\n\n    postgres=# ALTER USER test WITH PASSWORD '';\n\nTry to run the server:\n\n    $ npm start\n\nIf logs show that connection refused, kill the process and set a random password for the \"test\" user (e.g. \"test\"):\n\n    postgres=# ALTER USER test WITH PASSWORD 'test';\n\nBe sure to set the password in the `ormconfig.json` as well:\n\n```js\n{\n  // ...\n  \"password\": \"test\",\n  // ...\n}\n```\n\nRun the start command again:\n\n    $ npm start\n\n### Client\n\n**Be sure to go through server initialization first**\n\nFirst we need to clone the server project:\n\n    $ git clone git@github.com:Urigo/whatsapp-client-angularcli-material.git\n\nThen we need to install the NPM dependencies:\n\n    $ npm install\n\nStart the app:\n\n    $ npm start"
          },
          {
            "manualTitle": "Step 1: Introduction",
            "stepRevision": "2437e47edf7c1f7530c8b6a38374120ad60b1287",
            "manualView": "# Step 1: How to build an app?\n\nSo you want to build an app!\nThe good news is, it’s not that difficult and after a while anyone can do it!\nAnother good news is that it’s a great skill to have, there is a lot of demand in the job market and you can get to be very creative. Also you can be part of basically any industry you can think of if you know how to program (Healthcare,\nbanking, education, defense, gaming, etc…).\n\nSoftware builds as layers on top of layers.  Every code you write is using code that others have written before already and you can just use it even without fully understanding it.\nThat’s what makes software advance so fast and makes the pace of progress increase as time goes by.\nAlso, most software today is written in an open and free way - everyone can share their code and use other people's code for free.  We even have a social network for that!  It’s called Github.\n\nOne way of learning how to build an app is to study software from the origins. How computers, operating systems and compilers work. It is very interesting but that also takes a long time.\nAnother way to learn how to create a new app is to start by first using all the code that has been already written out there and once we have a real world running app, go deeper to understand how it works from the inside.\n\nI’ll try to use the later approach because I think it is more fun and also it gives context when we will dive inside on how things work. Also it helps when we try to compare between different technologies that do the same thing (Angular vs.\nReact , etc…).\nThat’s because understanding the bigger picture is more important than knowing and remembering the details.\n\nYou noticed that the chapter started with a simple question.\nAll the lessons will start and include many of those questions.  Those are the questions you will need to Google.  The reason is that the most important skill a creator has today is to know how to search Google for the things they need. Most\nprogrammers, even the best ones, don’t remember anything, they just use Google for almost every line of code they write. So know that you don’t need to know it all, Google knows it all for you.\nThis tutorial might get outdated (it won't, hopefully!), but Google will always have the answers so it is more important to know to ask the right questions.\nIn my opinion the most important skill a programmer needs to have is patience and acceptance when something just doesn’t work, enjoy that feeling and start Googling around in order to learn new things and solve this new problem (this process of\nfeeling like you don’t know anything will happen 1000 times a day, also after 20 years of programming).\n\n## Planning the app: how to design an app?\n\nThe first and most important phase in the process is the beginning - designing the app, its parts, components and architecture, and how it all works together.\nFor this tutorial we will build a WhatsApp clone so we have the designs already prepared.\n\nThe process will looks like that:\n\n1. **Visually sketch the screens of the app**. We already know how WhatsApp looks so we’ll just copy it on pen and paper.\n2. **Break down to components**. The best way to describe the UI of apps is to break the UI into separate components and mix them up together. When breaking down to components we would need to think about the following steps:\n  * **Presentational components**: the small building blocks of the UI. For example input fields, images, text, buttons etc…\n  * **Layout**: how the components are positioned inside each other (talk about flex, grid and older layout types)\n  * **Styles**: colors, fonts etc… We might skip that part at the beginning because we can have a perfectly working app without it\n  * **Data dependencies**: the data that those components need - chats, messages, people etc… We will need to to do the following:\n    * Gather data for each component\n    * Attach all those dependencies into one schema\n    * Attach actions for each component\n    * Data updates: decide when the data should be updated in the view (ideally we shouldn’t have to say when but for technical and performance reasons it helps)\n3. **Routing flow**: Moving between screens, what are the different paths the user can navigate through our app\n\nOnce we will finish that process, you will have a big picture in your head (and on your paper) and implementing it with code will be much easier and more technical, meaning you won’t need to know a lot, just Google how to do each step...\n\nAnother interesting thing is, that implementing this same process can be done with a variety of different technologies, so this work will make sense whether you are using web with React or Angular, native apps, Windows UWP or any other\ntechnology for the UI and also relevant whether your data source is a Node, .NET or Ruby server with Mongo, Postgres or MySQL database (if all those words doesn’t mean anything for you, don’t worry, those are just different names to very similar\nideas and we will learn all of them later on and of course you can always just Google them).\n\nHead over to the next chapter to start planning."
          },
          {
            "manualTitle": "Step 2: Planning process",
            "stepRevision": "e59198836c58fead22e1226d1556f7f70003af47",
            "manualView": "## Visual sketch\nWell, not a lot to say about that: just draw your app on paper.\nDoesn’t matter if you don’t know how to draw, it’s just squares and circles.\n\n![alt text](../../assets/chats.png \"Chats\")\n![alt text](../../assets/chat.png \"Chat\")\n![alt text](../../assets/new_chat.png \"New chat\")\n![alt text](../../assets/new_group.png \"New group\")\n![alt text](../../assets/new_group_details.png \"New group details\")\n\n## Breaking down to components\n### -> Google Search\nThis part is a bit more tricky, but after a few examples you’ll get the hang of it.\n\nDraw boxes around every component and subcomponent in different colors and name each one.\nBut how do you know what should be its own component?\nJust follow the **single responsibility principle**, that is, a component should ideally only do one thing. If it ends up growing, it should be decomposed into smaller subcomponents.\n\n![alt text](../../assets/chats_components.png \"Chats components\")\n![alt text](../../assets/chat_components.png \"Chat components\")\n![alt text](../../assets/new_chat_components.png \"New chat components\")\n![alt text](../../assets/new_group_components.png \"New group components\")\n![alt text](../../assets/new_group_details_components.png \"New group details components\")\n\n  * Chats Component\n  * Header Component\n  * ChatsList Component\n  * ChatItem Component\n  * Chat Component\n  * MessagesList Component\n  * MessageItem Component\n  * NewMessage Component\n  * NewChat Component\n  * UsersList Component\n  * UserItem Component\n  * NewGroup Component\n  * NewGroupDetails Component\n\nNow let’s organize them in hierarchy:\n* Chats\n  * Header\n  * ChatsList\n    * ChatItem\n* Chat\n  * Header\n  * MessagesList\n    * MessageItem\n  * NewMessage\n* NewChat\n  * Header\n  * UsersList\n    * UserItem\n* NewGroup\n  * Header\n  * UsersList\n    * UserItem\n  * NewGroupDetails\n\n## Layout\n### -> Google Search\nNow let’s describe how the components are placed within each other.\nThere are infinite ways to explain how components sits inside of each other.\nAny approach has its benefits and limitations.\nWe are going to use one pattern that is pretty common, simple and also covers many types of UI structures.\nUsing that pattern we will keep us covered for a long while (until you would want to create a computer game or a graph. then you’ll need to expand your horizons).\nThis pattern is called flexbox.\n\nIn Flexbox we can separate the alignment in two ways:\nContainer (parent) component behaviour\nChild component behaviour inside the container\n\nWhen describing the parent, we have 3 main properties:\n* Flex-Flow: it's a shorthand for flex-direction and flex-wrap and lets you control the direction in which the items are displayed and whether or not they can wrap onto the next line. There are four possible settings, each of them in the wrap or\nnowrap variant:\n  * row `[wrap, nowrap]`\n  * row-reverse `[wrap, nowrap]`\n  * column `[wrap, nowrap]` - this is the normal way a group of divs would be displayed, so you might not use this often\n  * column-reverse `[wrap, nowrap]`\n* Justify-content: determines where a browser should place the flex items within the row. It works only if the flex items have set widths and if the total width of the items is less than the flex container. There are five possible settings:\n  * Flex-start - squash them to the left\n  * Center - Squash them to the center\n  * Flex-end - squash them to the right\n  * Space-around - squash them away from each other and the ends. Place as much space as possible between all elements\n  * Space-between - Squash the sides to the ends and place as much space between the rest of the elements as possible\n* alignItems: Same as justifyContent but on the secondary axis\n  * Flex-start - squash them to the left\n  * Center - Squash them to the center\n  * Flex-end - squash them to the right\n  * Space-around - squash them away from each other and the ends. Place as much space as possible between all elements\n  * Space-between - Squash the sides to the ends and place as much space between the rest of the elements as possible\n\nThe easiest way to explain that is by showing live examples:\n[awaiting for McFarland's permission to share his pictures]\n\n## Data dependencies\n### -> Google Search\nOur app needs to display data. Otherwise it will be just a nice moving set of pictures…\nSo let’s see what data each component needs and create a descriptions of all the data in our app.\n\nLet’s start with the chats list component:\n\n* Chats: Chats, Users, Messages\n  * Header\n  * ChatsList: Chats, Users, Messages\n    * ChatItem: Chats`[chatId]`, Users`[UserId]`, Message`[messageId]`\n\nWe need to have some basic information about the chats we are part of, like the chat id, the user id and the latest message content.\nThat means we will have to query for all the chats who we are part of, then look at the user IDs and query for those users to retrieve the name. Finally we need to query for the last message of each chat.\n\nNow let’s talk about the chat component (after clicking the single chat app).\nWe need a list of all the messages inside the chat, along with some info about the user or chat on the top corner:\n\n* Chat: Chat, User, Messages\n  * Header: User.name || Chat.name (Because we can have multiple participant could differ from the other person’s name)\n  * MessagesList: Messages\n    * MessageItem: Messages`[ID]`\n  * NewMessage\n\nThe NewChat and NewGroup components will need just some basic info about the user:\n\n* NewChat: Users\n  * Header\n  * UsersList: Users\n    * UserItem: Users`[ID]`\n\n* NewGroup: Users\n  * Header\n  * UsersList: Users\n    * UserItem: Users`[ID]`\n  * NewGroupDetails\n\n## Actions\n### -> Google Search\nBut components can also do thing beyond just displaying data.\nLet’s write all the actions each component can do.\n  * Chats list\n    * tap -> go to chat page\n    * press -> enable selection of multiple chats, confirming the selection will delete them\n  * Single Chat\n    * tap -> send the message\n    * press -> enable selection of multiple messages, confirming the selection will delete them\n  * New Chat\n    * tap -> create new chat or go to the NewGroup component\n  * New Group\n    * tap -> go to NewGroupDetails, then create the group\n\n## Communications\n### -> Google Search\nLet’s define when do we need to get the data from our data source.\nSounds easy but there are a few tricky pitfalls. (query and subscriptions).\nWe will start by simply requesting the data when we first start the component, later on we will tackle subscriptions.\n\n## UI flow\n### -> Google Search\nLet’s draw a diagram of how the user can navigate our app.\n  * Open the app ->\n    * Chats list ->\n      * Click on chat ->\n        * Specific chat page\n          * Click back ->\n            * Chat page\n    * Click on '+' ->\n      * NewChat page ->\n        * Click on user ->\n          * Chat page\n        * Click back ->\n          * Chats list\n        * Click on 'New Group' ->\n          * New Group page\n            * Multiple selection and subsequent confirmation ->\n              * NewGroupDetails page\n                * Insert name and click on confirm ->\n                  * Chat page\n              * Click back ->\n                * New Group page\n          * Click back ->\n            * New Group page\n\nNow let’s look at the whole diagram we created.\nThat basically describes all of our app.\nIf computers were smart enough to understand english and drawings, we would have an app by now.\nBut programming languages are very similar to regular languages so we now just need to translate this into any programming language, just choose a tool and start filling in the gaps.\n\nNext chapter will be about Scaffolding which will tell us the structure to put our code into.\nJust like our sketch has defined parts, we would do the same just with folders and files."
          },
          {
            "manualTitle": "Step 3: Scaffolding",
            "stepRevision": "5bed487598e50759764f608eb4ca3b347c4d6ac5",
            "manualView": "Now we can start writing code!\n\nBut like we said before, software is build in layers and instead of starting from nothing, we can use existing software with prepared structure.\n\n## Tools\n\nFirst let’s install some software that we need on our computer:\n\n### Windows\n\nThe following instructions are for computers with the Windows operating system.\n\nFirst let's start by installing node.js. You need to download an installer, by visiting:\n\n    https://nodejs.org/en/download/\n\nSame, with Yarn:\n\n    https://yarnpkg.com/en/docs/install#windows-stable\n\n\n### Linux\n\nThe following instructions are for computers with the Arch Linux operating system, so your mileage may vary.\n\nFirst let's start by installing npm and node.js, as simple as\n\n    # NodeJS\n    pacman -S nodejs npm\n\n    # Yarn\n    pacman -S yarn\n\n\n### MacOS\n\nThe following instructions are for computers with the MacOS operating system:\n\n    # NodeJS\n    brew install node\n\n    # Yarn\n    brew install yarn --without-node\n\n\n## Packages\n\nThen we will need a way to install our npm global packages on a per-user basis, instead of relying on sudo: https://github.com/sindresorhus/guides/blob/master/npm-global-without-sudo.md\n\nNow it's the right moment to install a couple of global packages we will need later on:\n\n    yarn global add @angular/cli node-sass tortilla typescript\n\n\n## IDE\n\nNow it's time to choose our IDE. I suggest you VSCode, it's available for free: https://code.visualstudio.com/.\nTo have a look at some of the VSCode features you can have a look at the documentation: https://code.visualstudio.com/docs.\n\nVSCode team prepared an Interactive Playground where you can learn what the editor is cappable of and play with it. I highly recommend to check it out!\n\n    Toolbar: Help > Interactive Playground\n\nThere are also many IDEs to recommend and at the end the choice is yours.\n\n## Mobile\n\nWe will talk once again about scaffolding once we will introduce `Android` and `Cordova`."
          },
          {
            "manualTitle": "Step 4: Debugging",
            "stepRevision": "55bc04cf5573341cce8cdfe5fea67fb603e3a74f",
            "manualView": "Before we start writing code, it is important that we learn how to check our code.\n\nThe computer runs through everything we write in split second but we can still pause the computer and go through step by step, check what actually happens when the computer runs our code instructions.\n\nThis phase is sometimes being skipped by developers but trust me, you never want to skip this phase and you should always be super comfortable in debugging your code on whatever environment it’s running on.\n\nThe easiest way to debug your Javascript application is right into your editor:\n  * https://code.visualstudio.com/docs/introvideos/debugging\n  * https://www.jetbrains.com/help/webstorm/debugging-javascript-in-chrome.html\n  * https://blog.jetbrains.com/webstorm/2017/01/debugging-angular-apps/\n\nLater on we will learn how to debug mobile applications."
          },
          {
            "manualTitle": "Step 5: Chats listing",
            "stepRevision": "665d3c8014800890c694d121848b3448cd6335ec",
            "manualView": "![chats-list](https://user-images.githubusercontent.com/7648874/49271096-36bef480-f4a7-11e8-87a9-c9f203f20f6a.png)\n\n## Server\n\nAfter the planning phase it's finally time to start writing some real code!\nWe'll start with the server, so let's install a couple of packages first:\n\n    yarn add apollo-server-express body-parser cors express graphql\n    yarn add -D @types/body-parser @types/cors @types/express @types/graphql\n\nExpress is a fast, unopinionated, minimalist web framework for node.\nCross-Origin Resource Sharing (CORS) is a mechanism that uses additional HTTP headers to let a user agent gain permission to access selected resources from a server on a different origin (domain) than the site currently in use. A user agent makes a cross-origin HTTP request when it requests a resource from a different domain, protocol, or port than the one from which the current document originated.\nWe will need CORS because Webpack's development server used in the client will make use of a different port than the Express server, thus configuring a different origin.\nGraphQL is a query language for APIs and a runtime for fulfilling those queries with your existing data. GraphQL provides a complete and understandable description of the data in your API, gives clients the power to ask for exactly what they need and nothing more, makes it easier to evolve APIs over time, and enables powerful developer tools.\nApollo Server is a community-maintained open-source GraphQL server. It works with pretty much all Node.js HTTP server frameworks. Apollo Server works with any GraphQL schema built with GraphQL.js or with a convenience library such as graphql-tools.\n\nThe GraphQL query language is basically about selecting fields on objects. Because the shape of a GraphQL query closely matches the result, you can predict what the query will return without knowing that much about the server. But it's useful to have an exact description of the data we can ask for - what fields can we select? What kinds of objects might they return? What fields are available on those sub-objects? That's where the schema comes in.\nEvery GraphQL service defines a set of types which completely describe the set of possible data you can query on that service. Then, when queries come in, they are validated and executed against that schema.\n\nFor the moment let's create some empty schemas and resolvers:\n\n[{]: <helper> (diffStep \"1.1\" files=\"schema/*\" module=\"server\")\n\n#### [Step 1.1: Create empty Apollo server](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/1ac723e)\n\n##### Added schema&#x2F;index.ts\n```diff\n@@ -0,0 +1,8 @@\n+┊ ┊1┊import { makeExecutableSchema } from 'apollo-server-express';\n+┊ ┊2┊import typeDefs from './typeDefs';\n+┊ ┊3┊import { resolvers } from './resolvers';\n+┊ ┊4┊\n+┊ ┊5┊export const schema = makeExecutableSchema({\n+┊ ┊6┊  typeDefs,\n+┊ ┊7┊  resolvers,\n+┊ ┊8┊});\n```\n\n##### Added schema&#x2F;resolvers.ts\n```diff\n@@ -0,0 +1,5 @@\n+┊ ┊1┊import { IResolvers } from 'apollo-server-express';\n+┊ ┊2┊\n+┊ ┊3┊export const resolvers: IResolvers = {\n+┊ ┊4┊  Query: {},\n+┊ ┊5┊};\n```\n\n##### Added schema&#x2F;typeDefs.ts\n```diff\n@@ -0,0 +1,2 @@\n+┊ ┊1┊export default `\n+┊ ┊2┊`;\n```\n\n[}]: #\n\nTime to create our index:\n\n[{]: <helper> (diffStep \"1.1\" files=\"^index.ts\" module=\"server\")\n\n#### [Step 1.1: Create empty Apollo server](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/1ac723e)\n\n##### Added index.ts\n```diff\n@@ -0,0 +1,23 @@\n+┊  ┊ 1┊import { schema } from \"./schema\";\n+┊  ┊ 2┊import * as bodyParser from \"body-parser\";\n+┊  ┊ 3┊import * as cors from 'cors';\n+┊  ┊ 4┊import * as express from 'express';\n+┊  ┊ 5┊import { ApolloServer } from \"apollo-server-express\";\n+┊  ┊ 6┊\n+┊  ┊ 7┊const PORT = 3000;\n+┊  ┊ 8┊\n+┊  ┊ 9┊const app = express();\n+┊  ┊10┊\n+┊  ┊11┊app.use(cors());\n+┊  ┊12┊app.use(bodyParser.json());\n+┊  ┊13┊\n+┊  ┊14┊const apollo = new ApolloServer({\n+┊  ┊15┊  schema\n+┊  ┊16┊});\n+┊  ┊17┊\n+┊  ┊18┊apollo.applyMiddleware({\n+┊  ┊19┊  app,\n+┊  ┊20┊  path: '/graphql'\n+┊  ┊21┊});\n+┊  ┊22┊\n+┊  ┊23┊app.listen(PORT);\n```\n\n[}]: #\n\nNow we want to feed our graphql server with some data. Soon we will need `moment`, so let's install it:\n\n    yarn add moment\n\nNow we can create a fake db:\n\n[{]: <helper> (diffStep \"1.2\" files=\"db.ts\" module=\"server\")\n\n#### [Step 1.2: Add fake db](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/a168978)\n\n##### Added db.ts\n```diff\n@@ -0,0 +1,438 @@\n+┊   ┊  1┊import * as moment from 'moment';\n+┊   ┊  2┊\n+┊   ┊  3┊export enum MessageType {\n+┊   ┊  4┊  PICTURE,\n+┊   ┊  5┊  TEXT,\n+┊   ┊  6┊  LOCATION,\n+┊   ┊  7┊}\n+┊   ┊  8┊\n+┊   ┊  9┊export interface User {\n+┊   ┊ 10┊  id: number,\n+┊   ┊ 11┊  username: string,\n+┊   ┊ 12┊  password: string,\n+┊   ┊ 13┊  name: string,\n+┊   ┊ 14┊  picture?: string | null,\n+┊   ┊ 15┊  phone?: string | null,\n+┊   ┊ 16┊}\n+┊   ┊ 17┊\n+┊   ┊ 18┊export interface Chat {\n+┊   ┊ 19┊  id: number,\n+┊   ┊ 20┊  name?: string | null,\n+┊   ┊ 21┊  picture?: string | null,\n+┊   ┊ 22┊  // All members, current and past ones.\n+┊   ┊ 23┊  allTimeMemberIds: number[],\n+┊   ┊ 24┊  // Whoever gets the chat listed. For groups includes past members who still didn't delete the group.\n+┊   ┊ 25┊  listingMemberIds: number[],\n+┊   ┊ 26┊  // Actual members of the group (they are not the only ones who get the group listed). Null for chats.\n+┊   ┊ 27┊  actualGroupMemberIds?: number[] | null,\n+┊   ┊ 28┊  adminIds?: number[] | null,\n+┊   ┊ 29┊  ownerId?: number | null,\n+┊   ┊ 30┊  messages: Message[],\n+┊   ┊ 31┊}\n+┊   ┊ 32┊\n+┊   ┊ 33┊export interface Message {\n+┊   ┊ 34┊  id: number,\n+┊   ┊ 35┊  chatId: number,\n+┊   ┊ 36┊  senderId: number,\n+┊   ┊ 37┊  content: string,\n+┊   ┊ 38┊  createdAt: number,\n+┊   ┊ 39┊  type: MessageType,\n+┊   ┊ 40┊  recipients: Recipient[],\n+┊   ┊ 41┊  holderIds: number[],\n+┊   ┊ 42┊}\n+┊   ┊ 43┊\n+┊   ┊ 44┊export interface Recipient {\n+┊   ┊ 45┊  userId: number,\n+┊   ┊ 46┊  messageId: number,\n+┊   ┊ 47┊  chatId: number,\n+┊   ┊ 48┊  receivedAt: number | null,\n+┊   ┊ 49┊  readAt: number | null,\n+┊   ┊ 50┊}\n+┊   ┊ 51┊\n+┊   ┊ 52┊const users: User[] = [\n+┊   ┊ 53┊  {\n+┊   ┊ 54┊    id: 1,\n+┊   ┊ 55┊    username: 'ethan',\n+┊   ┊ 56┊    password: '$2a$08$NO9tkFLCoSqX1c5wk3s7z.JfxaVMKA.m7zUDdDwEquo4rvzimQeJm', // 111\n+┊   ┊ 57┊    name: 'Ethan Gonzalez',\n+┊   ┊ 58┊    picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n+┊   ┊ 59┊    phone: '+391234567890',\n+┊   ┊ 60┊  },\n+┊   ┊ 61┊  {\n+┊   ┊ 62┊    id: 2,\n+┊   ┊ 63┊    username: 'bryan',\n+┊   ┊ 64┊    password: '$2a$08$xE4FuCi/ifxjL2S8CzKAmuKLwv18ktksSN.F3XYEnpmcKtpbpeZgO', // 222\n+┊   ┊ 65┊    name: 'Bryan Wallace',\n+┊   ┊ 66┊    picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n+┊   ┊ 67┊    phone: '+391234567891',\n+┊   ┊ 68┊  },\n+┊   ┊ 69┊  {\n+┊   ┊ 70┊    id: 3,\n+┊   ┊ 71┊    username: 'avery',\n+┊   ┊ 72┊    password: '$2a$08$UHgH7J8G6z1mGQn2qx2kdeWv0jvgHItyAsL9hpEUI3KJmhVW5Q1d.', // 333\n+┊   ┊ 73┊    name: 'Avery Stewart',\n+┊   ┊ 74┊    picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n+┊   ┊ 75┊    phone: '+391234567892',\n+┊   ┊ 76┊  },\n+┊   ┊ 77┊  {\n+┊   ┊ 78┊    id: 4,\n+┊   ┊ 79┊    username: 'katie',\n+┊   ┊ 80┊    password: '$2a$08$wR1k5Q3T9FC7fUgB7Gdb9Os/GV7dGBBf4PLlWT7HERMFhmFDt47xi', // 444\n+┊   ┊ 81┊    name: 'Katie Peterson',\n+┊   ┊ 82┊    picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n+┊   ┊ 83┊    phone: '+391234567893',\n+┊   ┊ 84┊  },\n+┊   ┊ 85┊  {\n+┊   ┊ 86┊    id: 5,\n+┊   ┊ 87┊    username: 'ray',\n+┊   ┊ 88┊    password: '$2a$08$6.mbXqsDX82ZZ7q5d8Osb..JrGSsNp4R3IKj7mxgF6YGT0OmMw242', // 555\n+┊   ┊ 89┊    name: 'Ray Edwards',\n+┊   ┊ 90┊    picture: 'https://randomuser.me/api/portraits/thumb/men/3.jpg',\n+┊   ┊ 91┊    phone: '+391234567894',\n+┊   ┊ 92┊  },\n+┊   ┊ 93┊  {\n+┊   ┊ 94┊    id: 6,\n+┊   ┊ 95┊    username: 'niko',\n+┊   ┊ 96┊    password: '$2a$08$fL5lZR.Rwf9FWWe8XwwlceiPBBim8n9aFtaem.INQhiKT4.Ux3Uq.', // 666\n+┊   ┊ 97┊    name: 'Niccolò Belli',\n+┊   ┊ 98┊    picture: 'https://randomuser.me/api/portraits/thumb/men/4.jpg',\n+┊   ┊ 99┊    phone: '+391234567895',\n+┊   ┊100┊  },\n+┊   ┊101┊  {\n+┊   ┊102┊    id: 7,\n+┊   ┊103┊    username: 'mario',\n+┊   ┊104┊    password: '$2a$08$nDHDmWcVxDnH5DDT3HMMC.psqcnu6wBiOgkmJUy9IH..qxa3R6YrO', // 777\n+┊   ┊105┊    name: 'Mario Rossi',\n+┊   ┊106┊    picture: 'https://randomuser.me/api/portraits/thumb/men/5.jpg',\n+┊   ┊107┊    phone: '+391234567896',\n+┊   ┊108┊  },\n+┊   ┊109┊];\n+┊   ┊110┊\n+┊   ┊111┊const chats: Chat[] = [\n+┊   ┊112┊  {\n+┊   ┊113┊    id: 1,\n+┊   ┊114┊    name: null,\n+┊   ┊115┊    picture: null,\n+┊   ┊116┊    allTimeMemberIds: [1, 3],\n+┊   ┊117┊    listingMemberIds: [1, 3],\n+┊   ┊118┊    adminIds: null,\n+┊   ┊119┊    ownerId: null,\n+┊   ┊120┊    messages: [\n+┊   ┊121┊      {\n+┊   ┊122┊        id: 1,\n+┊   ┊123┊        chatId: 1,\n+┊   ┊124┊        senderId: 1,\n+┊   ┊125┊        content: 'You on your way?',\n+┊   ┊126┊        createdAt: moment().subtract(1, 'hours').unix(),\n+┊   ┊127┊        type: MessageType.TEXT,\n+┊   ┊128┊        recipients: [\n+┊   ┊129┊          {\n+┊   ┊130┊            userId: 3,\n+┊   ┊131┊            messageId: 1,\n+┊   ┊132┊            chatId: 1,\n+┊   ┊133┊            receivedAt: null,\n+┊   ┊134┊            readAt: null,\n+┊   ┊135┊          },\n+┊   ┊136┊        ],\n+┊   ┊137┊        holderIds: [1, 3],\n+┊   ┊138┊      },\n+┊   ┊139┊      {\n+┊   ┊140┊        id: 2,\n+┊   ┊141┊        chatId: 1,\n+┊   ┊142┊        senderId: 3,\n+┊   ┊143┊        content: 'Yep!',\n+┊   ┊144┊        createdAt: moment().subtract(1, 'hours').add(5, 'minutes').unix(),\n+┊   ┊145┊        type: MessageType.TEXT,\n+┊   ┊146┊        recipients: [\n+┊   ┊147┊          {\n+┊   ┊148┊            userId: 1,\n+┊   ┊149┊            messageId: 2,\n+┊   ┊150┊            chatId: 1,\n+┊   ┊151┊            receivedAt: null,\n+┊   ┊152┊            readAt: null,\n+┊   ┊153┊          },\n+┊   ┊154┊        ],\n+┊   ┊155┊        holderIds: [3, 1],\n+┊   ┊156┊      },\n+┊   ┊157┊    ],\n+┊   ┊158┊  },\n+┊   ┊159┊  {\n+┊   ┊160┊    id: 2,\n+┊   ┊161┊    name: null,\n+┊   ┊162┊    picture: null,\n+┊   ┊163┊    allTimeMemberIds: [1, 4],\n+┊   ┊164┊    listingMemberIds: [1, 4],\n+┊   ┊165┊    adminIds: null,\n+┊   ┊166┊    ownerId: null,\n+┊   ┊167┊    messages: [\n+┊   ┊168┊      {\n+┊   ┊169┊        id: 1,\n+┊   ┊170┊        chatId: 2,\n+┊   ┊171┊        senderId: 1,\n+┊   ┊172┊        content: 'Hey, it\\'s me',\n+┊   ┊173┊        createdAt: moment().subtract(2, 'hours').unix(),\n+┊   ┊174┊        type: MessageType.TEXT,\n+┊   ┊175┊        recipients: [\n+┊   ┊176┊          {\n+┊   ┊177┊            userId: 4,\n+┊   ┊178┊            messageId: 1,\n+┊   ┊179┊            chatId: 2,\n+┊   ┊180┊            receivedAt: null,\n+┊   ┊181┊            readAt: null,\n+┊   ┊182┊          },\n+┊   ┊183┊        ],\n+┊   ┊184┊        holderIds: [1, 4],\n+┊   ┊185┊      },\n+┊   ┊186┊    ],\n+┊   ┊187┊  },\n+┊   ┊188┊  {\n+┊   ┊189┊    id: 3,\n+┊   ┊190┊    name: null,\n+┊   ┊191┊    picture: null,\n+┊   ┊192┊    allTimeMemberIds: [1, 5],\n+┊   ┊193┊    listingMemberIds: [1, 5],\n+┊   ┊194┊    adminIds: null,\n+┊   ┊195┊    ownerId: null,\n+┊   ┊196┊    messages: [\n+┊   ┊197┊      {\n+┊   ┊198┊        id: 1,\n+┊   ┊199┊        chatId: 3,\n+┊   ┊200┊        senderId: 1,\n+┊   ┊201┊        content: 'I should buy a boat',\n+┊   ┊202┊        createdAt: moment().subtract(1, 'days').unix(),\n+┊   ┊203┊        type: MessageType.TEXT,\n+┊   ┊204┊        recipients: [\n+┊   ┊205┊          {\n+┊   ┊206┊            userId: 5,\n+┊   ┊207┊            messageId: 1,\n+┊   ┊208┊            chatId: 3,\n+┊   ┊209┊            receivedAt: null,\n+┊   ┊210┊            readAt: null,\n+┊   ┊211┊          },\n+┊   ┊212┊        ],\n+┊   ┊213┊        holderIds: [1, 5],\n+┊   ┊214┊      },\n+┊   ┊215┊      {\n+┊   ┊216┊        id: 2,\n+┊   ┊217┊        chatId: 3,\n+┊   ┊218┊        senderId: 1,\n+┊   ┊219┊        content: 'You still there?',\n+┊   ┊220┊        createdAt: moment().subtract(1, 'days').add(16, 'hours').unix(),\n+┊   ┊221┊        type: MessageType.TEXT,\n+┊   ┊222┊        recipients: [\n+┊   ┊223┊          {\n+┊   ┊224┊            userId: 5,\n+┊   ┊225┊            messageId: 2,\n+┊   ┊226┊            chatId: 3,\n+┊   ┊227┊            receivedAt: null,\n+┊   ┊228┊            readAt: null,\n+┊   ┊229┊          },\n+┊   ┊230┊        ],\n+┊   ┊231┊        holderIds: [1, 5],\n+┊   ┊232┊      },\n+┊   ┊233┊    ],\n+┊   ┊234┊  },\n+┊   ┊235┊  {\n+┊   ┊236┊    id: 4,\n+┊   ┊237┊    name: null,\n+┊   ┊238┊    picture: null,\n+┊   ┊239┊    allTimeMemberIds: [3, 4],\n+┊   ┊240┊    listingMemberIds: [3, 4],\n+┊   ┊241┊    adminIds: null,\n+┊   ┊242┊    ownerId: null,\n+┊   ┊243┊    messages: [\n+┊   ┊244┊      {\n+┊   ┊245┊        id: 1,\n+┊   ┊246┊        chatId: 4,\n+┊   ┊247┊        senderId: 3,\n+┊   ┊248┊        content: 'Look at my mukluks!',\n+┊   ┊249┊        createdAt: moment().subtract(4, 'days').unix(),\n+┊   ┊250┊        type: MessageType.TEXT,\n+┊   ┊251┊        recipients: [\n+┊   ┊252┊          {\n+┊   ┊253┊            userId: 4,\n+┊   ┊254┊            messageId: 1,\n+┊   ┊255┊            chatId: 4,\n+┊   ┊256┊            receivedAt: null,\n+┊   ┊257┊            readAt: null,\n+┊   ┊258┊          },\n+┊   ┊259┊        ],\n+┊   ┊260┊        holderIds: [3, 4],\n+┊   ┊261┊      },\n+┊   ┊262┊    ],\n+┊   ┊263┊  },\n+┊   ┊264┊  {\n+┊   ┊265┊    id: 5,\n+┊   ┊266┊    name: null,\n+┊   ┊267┊    picture: null,\n+┊   ┊268┊    allTimeMemberIds: [2, 5],\n+┊   ┊269┊    listingMemberIds: [2, 5],\n+┊   ┊270┊    adminIds: null,\n+┊   ┊271┊    ownerId: null,\n+┊   ┊272┊    messages: [\n+┊   ┊273┊      {\n+┊   ┊274┊        id: 1,\n+┊   ┊275┊        chatId: 5,\n+┊   ┊276┊        senderId: 2,\n+┊   ┊277┊        content: 'This is wicked good ice cream.',\n+┊   ┊278┊        createdAt: moment().subtract(2, 'weeks').unix(),\n+┊   ┊279┊        type: MessageType.TEXT,\n+┊   ┊280┊        recipients: [\n+┊   ┊281┊          {\n+┊   ┊282┊            userId: 5,\n+┊   ┊283┊            messageId: 1,\n+┊   ┊284┊            chatId: 5,\n+┊   ┊285┊            receivedAt: null,\n+┊   ┊286┊            readAt: null,\n+┊   ┊287┊          },\n+┊   ┊288┊        ],\n+┊   ┊289┊        holderIds: [2, 5],\n+┊   ┊290┊      },\n+┊   ┊291┊      {\n+┊   ┊292┊        id: 2,\n+┊   ┊293┊        chatId: 6,\n+┊   ┊294┊        senderId: 5,\n+┊   ┊295┊        content: 'Love it!',\n+┊   ┊296┊        createdAt: moment().subtract(2, 'weeks').add(10, 'minutes').unix(),\n+┊   ┊297┊        type: MessageType.TEXT,\n+┊   ┊298┊        recipients: [\n+┊   ┊299┊          {\n+┊   ┊300┊            userId: 2,\n+┊   ┊301┊            messageId: 2,\n+┊   ┊302┊            chatId: 5,\n+┊   ┊303┊            receivedAt: null,\n+┊   ┊304┊            readAt: null,\n+┊   ┊305┊          },\n+┊   ┊306┊        ],\n+┊   ┊307┊        holderIds: [5, 2],\n+┊   ┊308┊      },\n+┊   ┊309┊    ],\n+┊   ┊310┊  },\n+┊   ┊311┊  {\n+┊   ┊312┊    id: 6,\n+┊   ┊313┊    name: null,\n+┊   ┊314┊    picture: null,\n+┊   ┊315┊    allTimeMemberIds: [1, 6],\n+┊   ┊316┊    listingMemberIds: [1],\n+┊   ┊317┊    adminIds: null,\n+┊   ┊318┊    ownerId: null,\n+┊   ┊319┊    messages: [],\n+┊   ┊320┊  },\n+┊   ┊321┊  {\n+┊   ┊322┊    id: 7,\n+┊   ┊323┊    name: null,\n+┊   ┊324┊    picture: null,\n+┊   ┊325┊    allTimeMemberIds: [2, 1],\n+┊   ┊326┊    listingMemberIds: [2],\n+┊   ┊327┊    adminIds: null,\n+┊   ┊328┊    ownerId: null,\n+┊   ┊329┊    messages: [],\n+┊   ┊330┊  },\n+┊   ┊331┊  {\n+┊   ┊332┊    id: 8,\n+┊   ┊333┊    name: 'A user 0 group',\n+┊   ┊334┊    picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n+┊   ┊335┊    allTimeMemberIds: [1, 3, 4, 6],\n+┊   ┊336┊    listingMemberIds: [1, 3, 4, 6],\n+┊   ┊337┊    actualGroupMemberIds: [1, 4, 6],\n+┊   ┊338┊    adminIds: [1, 6],\n+┊   ┊339┊    ownerId: 1,\n+┊   ┊340┊    messages: [\n+┊   ┊341┊      {\n+┊   ┊342┊        id: 1,\n+┊   ┊343┊        chatId: 8,\n+┊   ┊344┊        senderId: 1,\n+┊   ┊345┊        content: 'I made a group',\n+┊   ┊346┊        createdAt: moment().subtract(2, 'weeks').unix(),\n+┊   ┊347┊        type: MessageType.TEXT,\n+┊   ┊348┊        recipients: [\n+┊   ┊349┊          {\n+┊   ┊350┊            userId: 3,\n+┊   ┊351┊            messageId: 1,\n+┊   ┊352┊            chatId: 8,\n+┊   ┊353┊            receivedAt: null,\n+┊   ┊354┊            readAt: null,\n+┊   ┊355┊          },\n+┊   ┊356┊          {\n+┊   ┊357┊            userId: 4,\n+┊   ┊358┊            messageId: 1,\n+┊   ┊359┊            chatId: 8,\n+┊   ┊360┊            receivedAt: moment().subtract(2, 'weeks').add(1, 'minutes').unix(),\n+┊   ┊361┊            readAt: moment().subtract(2, 'weeks').add(5, 'minutes').unix(),\n+┊   ┊362┊          },\n+┊   ┊363┊          {\n+┊   ┊364┊            userId: 6,\n+┊   ┊365┊            messageId: 1,\n+┊   ┊366┊            chatId: 8,\n+┊   ┊367┊            receivedAt: null,\n+┊   ┊368┊            readAt: null,\n+┊   ┊369┊          },\n+┊   ┊370┊        ],\n+┊   ┊371┊        holderIds: [1, 3, 4, 6],\n+┊   ┊372┊      },\n+┊   ┊373┊      {\n+┊   ┊374┊        id: 2,\n+┊   ┊375┊        chatId: 8,\n+┊   ┊376┊        senderId: 1,\n+┊   ┊377┊        content: 'Ops, user 3 was not supposed to be here',\n+┊   ┊378┊        createdAt: moment().subtract(2, 'weeks').add(2, 'minutes').unix(),\n+┊   ┊379┊        type: MessageType.TEXT,\n+┊   ┊380┊        recipients: [\n+┊   ┊381┊          {\n+┊   ┊382┊            userId: 4,\n+┊   ┊383┊            messageId: 2,\n+┊   ┊384┊            chatId: 8,\n+┊   ┊385┊            receivedAt: moment().subtract(2, 'weeks').add(3, 'minutes').unix(),\n+┊   ┊386┊            readAt: moment().subtract(2, 'weeks').add(5, 'minutes').unix(),\n+┊   ┊387┊          },\n+┊   ┊388┊          {\n+┊   ┊389┊            userId: 6,\n+┊   ┊390┊            messageId: 2,\n+┊   ┊391┊            chatId: 8,\n+┊   ┊392┊            receivedAt: null,\n+┊   ┊393┊            readAt: null,\n+┊   ┊394┊          },\n+┊   ┊395┊        ],\n+┊   ┊396┊        holderIds: [1, 4, 6],\n+┊   ┊397┊      },\n+┊   ┊398┊      {\n+┊   ┊399┊        id: 3,\n+┊   ┊400┊        chatId: 8,\n+┊   ┊401┊        senderId: 4,\n+┊   ┊402┊        content: 'Awesome!',\n+┊   ┊403┊        createdAt: moment().subtract(2, 'weeks').add(10, 'minutes').unix(),\n+┊   ┊404┊        type: MessageType.TEXT,\n+┊   ┊405┊        recipients: [\n+┊   ┊406┊          {\n+┊   ┊407┊            userId: 1,\n+┊   ┊408┊            messageId: 3,\n+┊   ┊409┊            chatId: 8,\n+┊   ┊410┊            receivedAt: null,\n+┊   ┊411┊            readAt: null,\n+┊   ┊412┊          },\n+┊   ┊413┊          {\n+┊   ┊414┊            userId: 6,\n+┊   ┊415┊            messageId: 3,\n+┊   ┊416┊            chatId: 8,\n+┊   ┊417┊            receivedAt: null,\n+┊   ┊418┊            readAt: null,\n+┊   ┊419┊          },\n+┊   ┊420┊        ],\n+┊   ┊421┊        holderIds: [1, 4, 6],\n+┊   ┊422┊      },\n+┊   ┊423┊    ],\n+┊   ┊424┊  },\n+┊   ┊425┊  {\n+┊   ┊426┊    id: 9,\n+┊   ┊427┊    name: 'A user 5 group',\n+┊   ┊428┊    picture: null,\n+┊   ┊429┊    allTimeMemberIds: [6, 3],\n+┊   ┊430┊    listingMemberIds: [6, 3],\n+┊   ┊431┊    actualGroupMemberIds: [6, 3],\n+┊   ┊432┊    adminIds: [6],\n+┊   ┊433┊    ownerId: 6,\n+┊   ┊434┊    messages: [],\n+┊   ┊435┊  },\n+┊   ┊436┊];\n+┊   ┊437┊\n+┊   ┊438┊export const db = {users, chats};\n```\n\n[}]: #\n\nIts' finally time to create our schema\n\n[{]: <helper> (diffStep \"1.3\" files=\"schema/typeDefs.ts\" module=\"server\")\n\n#### [Step 1.3: Add resolvers and schema](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/a2cb658)\n\n##### Changed schema&#x2F;typeDefs.ts\n```diff\n@@ -1,2 +1,68 @@\n ┊ 1┊ 1┊export default `\n+┊  ┊ 2┊  type Query {\n+┊  ┊ 3┊    users: [User!]\n+┊  ┊ 4┊    chats: [Chat!]\n+┊  ┊ 5┊    chat(chatId: ID!): Chat\n+┊  ┊ 6┊  }\n+┊  ┊ 7┊\n+┊  ┊ 8┊  enum MessageType {\n+┊  ┊ 9┊    LOCATION\n+┊  ┊10┊    TEXT\n+┊  ┊11┊    PICTURE\n+┊  ┊12┊  }\n+┊  ┊13┊\n+┊  ┊14┊  type Chat {\n+┊  ┊15┊    #May be a chat or a group\n+┊  ┊16┊    id: ID!\n+┊  ┊17┊    #Computed for chats\n+┊  ┊18┊    name: String\n+┊  ┊19┊    #Computed for chats\n+┊  ┊20┊    picture: String\n+┊  ┊21┊    #All members, current and past ones.\n+┊  ┊22┊    allTimeMembers: [User!]!\n+┊  ┊23┊    #Whoever gets the chat listed. For groups includes past members who still didn't delete the group.\n+┊  ┊24┊    listingMembers: [User!]!\n+┊  ┊25┊    #Actual members of the group (they are not the only ones who get the group listed). Null for chats.\n+┊  ┊26┊    actualGroupMembers: [User!]!\n+┊  ┊27┊    #Null for chats\n+┊  ┊28┊    admins: [User!]\n+┊  ┊29┊    #If null the group is read-only. Null for chats.\n+┊  ┊30┊    owner: User\n+┊  ┊31┊    messages(amount: Int): [Message]!\n+┊  ┊32┊    #Computed property\n+┊  ┊33┊    unreadMessages: Int!\n+┊  ┊34┊    #Computed property\n+┊  ┊35┊    isGroup: Boolean!\n+┊  ┊36┊  }\n+┊  ┊37┊\n+┊  ┊38┊  type Message {\n+┊  ┊39┊    id: ID!\n+┊  ┊40┊    sender: User!\n+┊  ┊41┊    chat: Chat!\n+┊  ┊42┊    content: String!\n+┊  ┊43┊    createdAt: String!\n+┊  ┊44┊    #FIXME: should return MessageType\n+┊  ┊45┊    type: Int!\n+┊  ┊46┊    #Whoever received the message\n+┊  ┊47┊    recipients: [Recipient!]!\n+┊  ┊48┊    #Whoever still holds a copy of the message. Cannot be null because the message gets deleted otherwise\n+┊  ┊49┊    holders: [User!]!\n+┊  ┊50┊    #Computed property\n+┊  ┊51┊    ownership: Boolean!\n+┊  ┊52┊  }\n+┊  ┊53┊\n+┊  ┊54┊  type Recipient {\n+┊  ┊55┊    user: User!\n+┊  ┊56┊    message: Message!\n+┊  ┊57┊    chat: Chat!\n+┊  ┊58┊    receivedAt: String\n+┊  ┊59┊    readAt: String\n+┊  ┊60┊  }\n+┊  ┊61┊\n+┊  ┊62┊  type User {\n+┊  ┊63┊    id: ID!\n+┊  ┊64┊    name: String\n+┊  ┊65┊    picture: String\n+┊  ┊66┊    phone: String\n+┊  ┊67┊  }\n ┊ 2┊68┊`;\n```\n\n[}]: #\n\nand our resolvers\n\n[{]: <helper> (diffStep \"1.3\" files=\"schema/resolvers.ts\" module=\"server\")\n\n#### [Step 1.3: Add resolvers and schema](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/a2cb658)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,5 +1,51 @@\n ┊ 1┊ 1┊import { IResolvers } from 'apollo-server-express';\n+┊  ┊ 2┊import { Chat, db, Message, Recipient, User } from \"../db\";\n+┊  ┊ 3┊\n+┊  ┊ 4┊let users = db.users;\n+┊  ┊ 5┊let chats = db.chats;\n+┊  ┊ 6┊const currentUser = 1;\n ┊ 2┊ 7┊\n ┊ 3┊ 8┊export const resolvers: IResolvers = {\n-┊ 4┊  ┊  Query: {},\n+┊  ┊ 9┊  Query: {\n+┊  ┊10┊    // Show all users for the moment.\n+┊  ┊11┊    users: (): User[] => users.filter(user => user.id !== currentUser),\n+┊  ┊12┊    chats: (): Chat[] => chats.filter(chat => chat.listingMemberIds.includes(currentUser)),\n+┊  ┊13┊    chat: (obj: any, {chatId}): Chat | null => chats.find(chat => chat.id === chatId) || null,\n+┊  ┊14┊  },\n+┊  ┊15┊  Chat: {\n+┊  ┊16┊    name: (chat: Chat): string => chat.name ? chat.name : users\n+┊  ┊17┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser))!.name,\n+┊  ┊18┊    picture: (chat: Chat) => chat.name ? chat.picture : users\n+┊  ┊19┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser))!.picture,\n+┊  ┊20┊    allTimeMembers: (chat: Chat): User[] => users.filter(user => chat.allTimeMemberIds.includes(user.id)),\n+┊  ┊21┊    listingMembers: (chat: Chat): User[] => users.filter(user => chat.listingMemberIds.includes(user.id)),\n+┊  ┊22┊    actualGroupMembers: (chat: Chat): User[] => users.filter(user => chat.actualGroupMemberIds && chat.actualGroupMemberIds.includes(user.id)),\n+┊  ┊23┊    admins: (chat: Chat): User[] => users.filter(user => chat.adminIds && chat.adminIds.includes(user.id)),\n+┊  ┊24┊    owner: (chat: Chat): User | null => users.find(user => chat.ownerId === user.id) || null,\n+┊  ┊25┊    messages: (chat: Chat, {amount = 0}: {amount: number}): Message[] => {\n+┊  ┊26┊      const messages = chat.messages\n+┊  ┊27┊      .filter(message => message.holderIds.includes(currentUser))\n+┊  ┊28┊      .sort((a, b) => b.createdAt - a.createdAt) || <Message[]>[];\n+┊  ┊29┊      return (amount ? messages.slice(0, amount) : messages).reverse();\n+┊  ┊30┊    },\n+┊  ┊31┊    unreadMessages: (chat: Chat): number => chat.messages\n+┊  ┊32┊      .filter(message => message.holderIds.includes(currentUser) &&\n+┊  ┊33┊        message.recipients.find(recipient => recipient.userId === currentUser && !recipient.readAt))\n+┊  ┊34┊      .length,\n+┊  ┊35┊    isGroup: (chat: Chat): boolean => !!chat.name,\n+┊  ┊36┊  },\n+┊  ┊37┊  Message: {\n+┊  ┊38┊    chat: (message: Message): Chat | null => chats.find(chat => message.chatId === chat.id) || null,\n+┊  ┊39┊    sender: (message: Message): User | null => users.find(user => user.id === message.senderId) || null,\n+┊  ┊40┊    holders: (message: Message): User[] => users.filter(user => message.holderIds.includes(user.id)),\n+┊  ┊41┊    ownership: (message: Message): boolean => message.senderId === currentUser,\n+┊  ┊42┊  },\n+┊  ┊43┊  Recipient: {\n+┊  ┊44┊    user: (recipient: Recipient): User | null => users.find(user => recipient.userId === user.id) || null,\n+┊  ┊45┊    message: (recipient: Recipient): Message | null => {\n+┊  ┊46┊      const chat = chats.find(chat => recipient.chatId === chat.id);\n+┊  ┊47┊      return chat ? chat.messages.find(message => recipient.messageId === message.id) || null : null;\n+┊  ┊48┊    },\n+┊  ┊49┊    chat: (recipient: Recipient): Chat | null => chats.find(chat => recipient.chatId === chat.id) || null,\n+┊  ┊50┊  },\n ┊ 5┊51┊};\n```\n\n[}]: #\n\nOut basic server is already done and working. We still have no way to do any kind of mutation, but we already set up several queries to return a list of users or chats.\nIn particular we can choose if we want to return all the chats (and how many messages we want to return for each chat) or if we want to return a single chat. We can also choose which and how many properties we want to return for each query.\nWe can start the server by simply running:\n\n    yarn start\n\n## Client\n\nNow we can concentrate on the client and bootstrap it using Angular-CLI.\nFirst you will need to install it globally with:\n\n    yarn global add @angular/cli\n\nThen we can create a new project from scratch:\n\n    ng new client --style scss\n\nTime to install a couple of packages:\n\n    ng add apollo-angular\n    yarn add -D @types/graphql\n\nApollo's Schematics sets everything for us. The only thing missing is to fill the `url`.\n\n[{]: <helper> (diffStep \"1.1\" files=\"src/app/graphql.module.ts\" module=\"client\")\n\n#### [Step 1.1: Add angular-apollo to app module](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/3a40362)\n\n##### Added src&#x2F;app&#x2F;graphql.module.ts\n```diff\n@@ -0,0 +1,25 @@\n+┊  ┊ 1┊import { NgModule} from '@angular/core';\n+┊  ┊ 2┊import { ApolloModule, APOLLO_OPTIONS } from 'apollo-angular';\n+┊  ┊ 3┊import { HttpLinkModule, HttpLink } from 'apollo-angular-link-http';\n+┊  ┊ 4┊import { InMemoryCache } from 'apollo-cache-inmemory';\n+┊  ┊ 5┊\n+┊  ┊ 6┊const uri = 'http://localhost:3000/graphql';\n+┊  ┊ 7┊\n+┊  ┊ 8┊export function createApollo(httpLink: HttpLink) {\n+┊  ┊ 9┊  return {\n+┊  ┊10┊    link: httpLink.create({uri}),\n+┊  ┊11┊    cache: new InMemoryCache(),\n+┊  ┊12┊  };\n+┊  ┊13┊}\n+┊  ┊14┊\n+┊  ┊15┊@NgModule({\n+┊  ┊16┊  exports: [ApolloModule, HttpLinkModule],\n+┊  ┊17┊  providers: [\n+┊  ┊18┊    {\n+┊  ┊19┊      provide: APOLLO_OPTIONS,\n+┊  ┊20┊      useFactory: createApollo,\n+┊  ┊21┊      deps: [HttpLink],\n+┊  ┊22┊    },\n+┊  ┊23┊  ],\n+┊  ┊24┊})\n+┊  ┊25┊export class GraphQLModule {}\n```\n\n[}]: #\n\nLet's take a closer look what Schematics prepared for us.\n\nFirst, it created `graphql.module.ts` and used `ApolloModule` and `HttpLinkModule`.\n\n- `ApolloModule` is the center of using GraphQL in your app! It includes all needed services that allows to use ApolloClient’s features.\n- `HttpLinkModule` makes it easy to fetch data in Angular.\n\n`HttpLinkModule` is optional, you can replace it with any other Link.\nIts biggest advantage of all is that it uses Angular's `HttpClient` internally so it's possible to use it in `NativeScript` or in combination with any other `HttpClient` provider. By using `HttpLinkModule` you get Server-Side Rendering for free, without any additional work.\n\nNext, we got `APOLLO_OPTIONS` provided to Angular.\n\nWe're using the `InMemoryCache` cache, but there are several options like `Redux`, `Hermes` and even `ngrx`.\n\n- `apollo-cache-inmemory` is an official and recommended Apollo Cache.\n\n### Cache and Links\n\nThese are two main parts of Apollo Stack, both are pluggable and customizable.\n\n- **Cache** is responsible for storing data and keeping it consistent.\n- **Links** describe how to access the source of data (usually a GraphQL endpoint).\n\nLet's take a closer look on what cache means for Apollo, we're going to base it on the official `apollo-cache-inmemory`, one of many implementations.\n\nBut first, imagine, we write our own amazing Apollo Cache implementation.\n\n```graphql\nquery getMessages {\n  messages {\n    id\n    content\n    likes\n  }\n}\n```\n\nWhen we execute a query like one above what we get in return is an array of all messages of logged in user:\n\n```json\n{\n  \"data\": {\n    \"messages\": [\n      {\n        \"id\": 0,\n        \"content\": \"Hi\",\n        \"likes\": 0\n      },\n      {\n        \"id\": 1,\n        \"content\": \"Hello\",\n        \"likes\": 0\n      }\n    ]\n  }\n}\n```\n\nOur cache stores the result in exact shape as above.\n\nLater on we add more queries and one of them returns a list of messages from one conversation.\n\nNow, a short story. We've got two users, Niccolo and Dotan.\n\n1. Niccolo opens the app and Apollo fetches all of his messages (I know, it's stupid but stay with me)\n1. One message is to Dotan, Niccolo said \"Hi\" to him.\n1. Now Dotan opens the app and reacts to the message with a like.\n1. After few minutes Niccolo asks for messages from a conversation with Dotan.\n1. Apollo fetches those messages and there is one in which Niccolo says \"Hi\" and it's liked by Dotan.\n1. Now we have the same message twice, one has different state that the other, in one place there is no like, in other, we have +1.\n\nAs you see, our cache is not smart enough to figure out one query might be a subset of another.\nThat's because it doesn't get enough informations.\n\nLet's go back to InMemoryCache and see how it describes itself:\n\n> Thanks to InMemoryCache, it's possible for the results of a query or mutation to update the UI in all the right places. In many cases it's possible for that to happen automatically, whereas in others you need to help the client out a little in doing so.\n\nIt means it could solve the issue we have with duplicated messages with different state.\n\nIt's very important to understand one concept that InMemoryCache is heavily based on, it's called normalization.\n\nThe InMemoryCache splits the result into individual objects, creates a unique identifier for each of them and flattens everything up before saving it to the store.\nMight seem complicated at first, but as InMemoryCache, let's break everything into smaller parts.\n\nFirst, \"breaking the result into pieces\" part. The InMemoryCache tells ApolloClient to add `__typename` field to your query before passing it to the server. I used server for simplicity, it actually passes it to Apollo Links and they are responsible to make a HTTP request. Every Apollo Cache is able to transform a document, that's as a side note.\n\n```graphql\nquery getMessages {\n  messages {\n    id\n    content\n    likes\n    __typename\n  }\n}\n```\n\nThe `__typename` field tells about the type of the object. It's compatible with every GraphQL server as it's part of the specification.\n\n```graphql\ntype Message {\n  id: ID\n  content: String\n  likes: Int\n}\n\ntype Query {\n  messages: [Message]\n}\n```\n\nIn our case, `__typename` returns `Message`. So now InMemoryCache knows that a message is a Message. Computers are stupid, we have to tell them everything!\n\nNext, let's take a look at \"creates a unique identifier\" part.\n\nThe InMemoryCache iterates through every object and looks for the `__typename` and two fields, `id` and `_id` that usually are used as identifiers. Taking our example, it turns every Message object into `Message:1`, `Message:2`, `Message:3` and so on. You get the idea.\n\nIt's the default behaviour but you can change it as you wish:\n\n```typescript\nconst cache = new InMemoryCache({\n  dataIdFromObject(result) {\n    if (result.__typename) {\n      const id = result.uid || result.id || result._id;\n\n      if (id !== undefined) {\n        return `${result.__typename}:${id}`;\n      }\n    }\n    return null;\n  },\n});\n```\n\nGreat, we covered two out of three things InMemoryCache does. Now we're going to explore \"flattens everything up\".\n\nWe're able to understand the type of each individual object and it's unique identifier. It still has to be stored.\n\nWhat InMemoryCache does is it's saves every element on root level in a plain object where the key contains a unique identifier and the value has a body.\n\n```json\n{\n  \"Message:1\": {\n    \"id\": 1,\n    \"content\": \"Hi\",\n    \"likes\": 1,\n    \"__typename\": \"Message\"\n  },\n  \"Message:2\": {\n    \"id\": 2,\n    \"content\": \"Hello\",\n    \"likes\": 0,\n    \"__typename\": \"Message\"\n  },\n  \"ROOT_QUERY\": {\n    \"messages\": [\n      {\n        \"id\": \"Message:1\",\n        \"typename\": \"Message\"\n      },\n      {\n        \"id\": \"Message:2\",\n        \"typename\": \"Message\"\n      }\n    ]\n  }\n}\n```\n\nWait, `ROOT_QUERY`? Yes, it has to somehow store the actual result of every executed query so next time you ask for the same thing, it matches it with the query in store and resolves right away.\n\n> You should be aware that the InMemoryCache stringifies variables of a query too, which means the same queries but with different variables are stored separately. Even the order of those variables matters.\n\nAs you can see, each element in `ROOT_QUERY.message` is kind of a reference to a message record.\n\nLet's bring back our short story, a scenario.\nWhen Niccolo asks for all messages, the whole three part process is started, each message is saved to the store.\nWhen he asks for history of a conversation with Dotan, InMemoryCache starts the process again and if it sees that there is already a massage with the same unique identifier, it knows they both are the same so it merged them.\nThe InMemoryCache can tell what changed and emits the new object to the UI.\nThanks to that we no longer have the same message in two places where one has a like and other doesn't.\n\nUff, Apollo Cache part is done. Thanks for being with us that long, I hope you didn't get bored because there's a lot ahead of us.\n\nLet's talk Apollo Link.\n\nAs I mentioned it's kind of a network stack of Apollo. You execute a document with some metadata like variables or a context, Apollo Client receives it and passes it to the chain of Links.\n\nThe ApolloLink is based on an Observable (not RxJS) and if you know `RxJS` you're familiar with `pipe`. Each Link is basically a function that receives a requested operation and a function that runs the next Link. Just like a pipe!\n\n```typescript\nimport { ApolloLink } from 'apollo-link';\n\nconst log = new ApolloLink((operation, next) => {\n  console.log('Name', operation.operationName);\n  return next(operation);\n});\n```\n\nNow when we add it in `graphql.module.ts` we see the name of each requested operation.\n\nWe can even intercept the result.\n\n```typescript\nconst intercept = new ApolloLink((operation, next) => {\n    return forward(operation).map((data) => {\n        // data from a previous link\n        console.log('data', data);\n        return data;\n    });\n});\n```\n\nAs you can see below, by network we don't always mean making HTTP requests. It could be Http Link at the end of Links chain or WebSocket Link or even something that works on in-memory data.\n\n```typescript\nimport { ApolloLink, Observable } from 'apollo-link';\n\nconst inmemory = new ApolloLink(operation => {\n    return Observable(observer => {\n        // function that executes the operation and returns data\n        const result = resolveOperation(operation);\n\n        observer.next(result);\n        observer.complete();\n    });\n});\n```\n\nYou can find tons of helpful Links [on npm](https://www.npmjs.com/search?q=apollo-link-) and [on Apollo Link documentation](https://www.apollographql.com/docs/link/links/community.html).\n\nWe highly recommend to take a look at Angular related Links [on Apollo Angular documentation](https://www.apollographql.com/docs/angular/guides/tools-and-packages.html).\n\n### GQL Tag\n\nThe `gql` template tag is what you use to define GraphQL queries in your Apollo apps. It parses your GraphQL query into the `GraphQL.js AST format` which may then be consumed by Apollo methods. Whenever Apollo is asking for a GraphQL query you will always want to wrap it in a `gql` template tag.\n\nYou can embed a GraphQL document containing only fragments inside of another GraphQL document using template string interpolation. This allows you to use fragments defined in one part of your codebase inside of a query defined in a completely different file.\n\n[{]: <helper> (diffStep \"1.2\" file=\"src/graphql/fragment.ts\" module=\"client\")\n\n#### [Step 1.2: Add chats service](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/591a455)\n\n##### Added src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -0,0 +1,25 @@\n+┊  ┊ 1┊import {map} from 'rxjs/operators';\n+┊  ┊ 2┊import {Apollo} from 'apollo-angular';\n+┊  ┊ 3┊import {Injectable} from '@angular/core';\n+┊  ┊ 4┊import {getChatsQuery} from '../../graphql/getChats.query';\n+┊  ┊ 5┊\n+┊  ┊ 6┊@Injectable()\n+┊  ┊ 7┊export class ChatsService {\n+┊  ┊ 8┊  messagesAmount = 3;\n+┊  ┊ 9┊\n+┊  ┊10┊  constructor(private apollo: Apollo) {}\n+┊  ┊11┊\n+┊  ┊12┊  getChats() {\n+┊  ┊13┊    const query = this.apollo.watchQuery<any>({\n+┊  ┊14┊      query: getChatsQuery,\n+┊  ┊15┊      variables: {\n+┊  ┊16┊        amount: this.messagesAmount,\n+┊  ┊17┊      },\n+┊  ┊18┊    });\n+┊  ┊19┊    const chats$ = query.valueChanges.pipe(\n+┊  ┊20┊      map((result) => result.data.chats)\n+┊  ┊21┊    );\n+┊  ┊22┊\n+┊  ┊23┊    return {query, chats$};\n+┊  ┊24┊  }\n+┊  ┊25┊}\n```\n\n##### Added src&#x2F;graphql&#x2F;fragment.ts\n```diff\n@@ -0,0 +1,51 @@\n+┊  ┊ 1┊import gql from 'graphql-tag';\n+┊  ┊ 2┊import {DocumentNode} from 'graphql';\n+┊  ┊ 3┊\n+┊  ┊ 4┊export const fragments: {\n+┊  ┊ 5┊  [key: string]: DocumentNode\n+┊  ┊ 6┊} = {\n+┊  ┊ 7┊  chatWithoutMessages: gql`\n+┊  ┊ 8┊    fragment ChatWithoutMessages on Chat {\n+┊  ┊ 9┊      id\n+┊  ┊10┊      name\n+┊  ┊11┊      picture\n+┊  ┊12┊      allTimeMembers {\n+┊  ┊13┊        id\n+┊  ┊14┊      }\n+┊  ┊15┊      unreadMessages\n+┊  ┊16┊      isGroup\n+┊  ┊17┊    }\n+┊  ┊18┊  `,\n+┊  ┊19┊  message: gql`\n+┊  ┊20┊    fragment Message on Message {\n+┊  ┊21┊      id\n+┊  ┊22┊      chat {\n+┊  ┊23┊        id\n+┊  ┊24┊      }\n+┊  ┊25┊      sender {\n+┊  ┊26┊        id\n+┊  ┊27┊        name\n+┊  ┊28┊      }\n+┊  ┊29┊      content\n+┊  ┊30┊      createdAt\n+┊  ┊31┊      type\n+┊  ┊32┊      recipients {\n+┊  ┊33┊        user {\n+┊  ┊34┊          id\n+┊  ┊35┊        }\n+┊  ┊36┊        message {\n+┊  ┊37┊          id\n+┊  ┊38┊          chat {\n+┊  ┊39┊            id\n+┊  ┊40┊          }\n+┊  ┊41┊        }\n+┊  ┊42┊        chat {\n+┊  ┊43┊          id\n+┊  ┊44┊        }\n+┊  ┊45┊        receivedAt\n+┊  ┊46┊        readAt\n+┊  ┊47┊      }\n+┊  ┊48┊      ownership\n+┊  ┊49┊    }\n+┊  ┊50┊  `,\n+┊  ┊51┊};\n```\n\n##### Added src&#x2F;graphql&#x2F;getChats.query.ts\n```diff\n@@ -0,0 +1,17 @@\n+┊  ┊ 1┊import gql from 'graphql-tag';\n+┊  ┊ 2┊import {fragments} from './fragment';\n+┊  ┊ 3┊\n+┊  ┊ 4┊// We use the gql tag to parse our query string into a query document\n+┊  ┊ 5┊export const getChatsQuery = gql`\n+┊  ┊ 6┊  query GetChats($amount: Int) {\n+┊  ┊ 7┊    chats {\n+┊  ┊ 8┊      ...ChatWithoutMessages\n+┊  ┊ 9┊      messages(amount: $amount) {\n+┊  ┊10┊        ...Message\n+┊  ┊11┊      }\n+┊  ┊12┊    }\n+┊  ┊13┊  }\n+┊  ┊14┊\n+┊  ┊15┊  ${fragments['chatWithoutMessages']}\n+┊  ┊16┊  ${fragments['message']}\n+┊  ┊17┊`;\n```\n\n[}]: #\n\n### Use Apollo service\n\nLet's create a simple service to query the chats from our just created server:\n\n[{]: <helper> (diffStep \"1.2\" files=\"src/app/services\" module=\"client\")\n\n#### [Step 1.2: Add chats service](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/591a455)\n\n##### Added src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -0,0 +1,25 @@\n+┊  ┊ 1┊import {map} from 'rxjs/operators';\n+┊  ┊ 2┊import {Apollo} from 'apollo-angular';\n+┊  ┊ 3┊import {Injectable} from '@angular/core';\n+┊  ┊ 4┊import {getChatsQuery} from '../../graphql/getChats.query';\n+┊  ┊ 5┊\n+┊  ┊ 6┊@Injectable()\n+┊  ┊ 7┊export class ChatsService {\n+┊  ┊ 8┊  messagesAmount = 3;\n+┊  ┊ 9┊\n+┊  ┊10┊  constructor(private apollo: Apollo) {}\n+┊  ┊11┊\n+┊  ┊12┊  getChats() {\n+┊  ┊13┊    const query = this.apollo.watchQuery<any>({\n+┊  ┊14┊      query: getChatsQuery,\n+┊  ┊15┊      variables: {\n+┊  ┊16┊        amount: this.messagesAmount,\n+┊  ┊17┊      },\n+┊  ┊18┊    });\n+┊  ┊19┊    const chats$ = query.valueChanges.pipe(\n+┊  ┊20┊      map((result) => result.data.chats)\n+┊  ┊21┊    );\n+┊  ┊22┊\n+┊  ┊23┊    return {query, chats$};\n+┊  ┊24┊  }\n+┊  ┊25┊}\n```\n\n[}]: #\n\nWe just learned how to use Apollo to attach GraphQL query results to the Angular UI.\n\nThe `watchQuery` method returns a `QueryRef` object which has the `valueChanges` property that is an `Observable`.\n\nEvery fetched data is stored in Apollo Client’s cache, so if some other query fetches new information about the chats, this component will update to remain consistent.\n\nIt’s also possible to fetch data only once. You simply use `query` method instead of `watchQuery`. The query method of Apollo service returns an Observable too that also resolves with the same result as above.\n\n#### But what is a `QueryRef`?\n\nAs you know, `query` method returns an Observable that emits a result, just once, then the observable completes. `watchQuery` works a bit different. It fetches data then stays open and listens to the Cache for updates.\n\nSo why `watchQuery` can not simply expose an Observable and it serves `QueryRef` instead?\n\nBecause Apollo Angular is a bridge between Apollo Client (core library) and Angular framework it has to operate on RxJS based Observables. RxJS Observable has a simple API that cannot be easily extended and it's in general a bad practice.\n\nWhy we're talking about those things? Apollo Client exposes an Observable that has bunch of custom method on it. They are super useful and their purpose is to talk to Apollo through them.\n\nSince we have to turn Apollo's Observable to something that is compatible with RxJS we decided to expose an object that has all those methods and `valueChanges` property that is a regular RxJS Observable.\n\n#### Make our app pretty\n\nWe will use Materials for the UI, so let's install it:\n\n    yarn add @angular/cdk @angular/material hammerjs ng2-truncate\n\nLet's configure Material:\n\n[{]: <helper> (diffStep \"1.3\" files=\"src/index.ts, src/main.ts, src/styles.scss\" module=\"client\")\n\n#### [Step 1.3: List the chats](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/7d716ee)\n\n##### Changed src&#x2F;main.ts\n```diff\n@@ -4,6 +4,9 @@\n ┊ 4┊ 4┊import { AppModule } from './app/app.module';\n ┊ 5┊ 5┊import { environment } from './environments/environment';\n ┊ 6┊ 6┊\n+┊  ┊ 7┊// Material gestures\n+┊  ┊ 8┊import 'hammerjs';\n+┊  ┊ 9┊\n ┊ 7┊10┊if (environment.production) {\n ┊ 8┊11┊  enableProdMode();\n ┊ 9┊12┊}\n```\n\n##### Changed src&#x2F;styles.scss\n```diff\n@@ -1 +1,28 @@\n ┊ 1┊ 1┊/* You can add global styles to this file, and also import other style files */\n+┊  ┊ 2┊\n+┊  ┊ 3┊/* Meterial theme */\n+┊  ┊ 4┊@import \"~@angular/material/prebuilt-themes/indigo-pink.css\";\n+┊  ┊ 5┊\n+┊  ┊ 6┊:root {\n+┊  ┊ 7┊  --primary: #2c6157;\n+┊  ┊ 8┊  --secondary: #6fd056;\n+┊  ┊ 9┊}\n+┊  ┊10┊\n+┊  ┊11┊body {\n+┊  ┊12┊  margin: 0;\n+┊  ┊13┊}\n+┊  ┊14┊\n+┊  ┊15┊.mat-primary {\n+┊  ┊16┊  background-color: var(--primary) !important;\n+┊  ┊17┊  color: white;\n+┊  ┊18┊}\n+┊  ┊19┊\n+┊  ┊20┊.mat-secondary {\n+┊  ┊21┊  background-color: var(--secondary) !important;\n+┊  ┊22┊  color: white;\n+┊  ┊23┊}\n+┊  ┊24┊\n+┊  ┊25┊.mat-toolbar {\n+┊  ┊26┊  color: white;\n+┊  ┊27┊  background-color: var(--primary) !important;\n+┊  ┊28┊}\n```\n\n[}]: #\n\nWe're now creating a `shared` module where we will define our header component where we're going to project a different content from each component:\n\n[{]: <helper> (diffStep \"1.3\" files=\"src/app/shared/*\" module=\"client\")\n\n#### [Step 1.3: List the chats](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/7d716ee)\n\n##### Added src&#x2F;app&#x2F;shared&#x2F;components&#x2F;toolbar&#x2F;toolbar.component.scss\n```diff\n@@ -0,0 +1,15 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊  height: 8vh;\n+┊  ┊ 4┊}\n+┊  ┊ 5┊\n+┊  ┊ 6┊.mat-toolbar {\n+┊  ┊ 7┊  justify-content: space-between;\n+┊  ┊ 8┊  height: 100%;\n+┊  ┊ 9┊\n+┊  ┊10┊  .left-block {\n+┊  ┊11┊    display: flex;\n+┊  ┊12┊    height: 8vh;\n+┊  ┊13┊    line-height: 8vh;\n+┊  ┊14┊  }\n+┊  ┊15┊}\n```\n\n##### Added src&#x2F;app&#x2F;shared&#x2F;components&#x2F;toolbar&#x2F;toolbar.component.ts\n```diff\n@@ -0,0 +1,19 @@\n+┊  ┊ 1┊import {Component} from '@angular/core';\n+┊  ┊ 2┊\n+┊  ┊ 3┊@Component({\n+┊  ┊ 4┊  selector: 'app-toolbar',\n+┊  ┊ 5┊  template: `\n+┊  ┊ 6┊    <mat-toolbar>\n+┊  ┊ 7┊      <div class=\"left-block\">\n+┊  ┊ 8┊        <ng-content select=\".navigation\"></ng-content>\n+┊  ┊ 9┊        <ng-content select=\".profile-pic\"></ng-content>\n+┊  ┊10┊        <ng-content select=\".title\"></ng-content>\n+┊  ┊11┊      </div>\n+┊  ┊12┊      <ng-content select=\".menu\"></ng-content>\n+┊  ┊13┊    </mat-toolbar>\n+┊  ┊14┊  `,\n+┊  ┊15┊  styleUrls: ['./toolbar.component.scss']\n+┊  ┊16┊})\n+┊  ┊17┊export class ToolbarComponent {\n+┊  ┊18┊\n+┊  ┊19┊}\n```\n\n##### Added src&#x2F;app&#x2F;shared&#x2F;shared.module.ts\n```diff\n@@ -0,0 +1,28 @@\n+┊  ┊ 1┊import {BrowserModule} from '@angular/platform-browser';\n+┊  ┊ 2┊import {NgModule} from '@angular/core';\n+┊  ┊ 3┊\n+┊  ┊ 4┊import {MatToolbarModule} from '@angular/material';\n+┊  ┊ 5┊import {ToolbarComponent} from './components/toolbar/toolbar.component';\n+┊  ┊ 6┊import {FormsModule} from '@angular/forms';\n+┊  ┊ 7┊import {BrowserAnimationsModule} from '@angular/platform-browser/animations';\n+┊  ┊ 8┊\n+┊  ┊ 9┊@NgModule({\n+┊  ┊10┊  declarations: [\n+┊  ┊11┊    ToolbarComponent,\n+┊  ┊12┊  ],\n+┊  ┊13┊  imports: [\n+┊  ┊14┊    BrowserModule,\n+┊  ┊15┊    // Material\n+┊  ┊16┊    MatToolbarModule,\n+┊  ┊17┊    // Animations\n+┊  ┊18┊    BrowserAnimationsModule,\n+┊  ┊19┊    // Forms\n+┊  ┊20┊    FormsModule,\n+┊  ┊21┊  ],\n+┊  ┊22┊  providers: [],\n+┊  ┊23┊  exports: [\n+┊  ┊24┊    ToolbarComponent,\n+┊  ┊25┊  ],\n+┊  ┊26┊})\n+┊  ┊27┊export class SharedModule {\n+┊  ┊28┊}\n```\n\n[}]: #\n\nNow we want to create the `chats-lister` module, with a container component called `ChatsComponent` and a couple of presentational components. Each and every chat item would be presented with a default profile picture as a placeholder, so before we proceed we will have to download it to the `src/assets` directory:\n\n    $ wget https://raw.githubusercontent.com/DAB0mB/whatsapp-client-angularcli-material/c75c2416b1990da3588015f76b8338764f44d6ec/src/assets/default-profile-pic.jpg -P src/assets\n\nAnd now we can proceed to creating the relevant components and their style sheets:\n\n[{]: <helper> (diffStep \"1.3\" files=\"src/app/chats-lister/*\" module=\"client\")\n\n#### [Step 1.3: List the chats](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/7d716ee)\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;chats-lister.module.ts\n```diff\n@@ -0,0 +1,49 @@\n+┊  ┊ 1┊import { BrowserModule } from '@angular/platform-browser';\n+┊  ┊ 2┊import { NgModule } from '@angular/core';\n+┊  ┊ 3┊\n+┊  ┊ 4┊import {BrowserAnimationsModule} from '@angular/platform-browser/animations';\n+┊  ┊ 5┊import {MatButtonModule, MatIconModule, MatListModule, MatMenuModule} from '@angular/material';\n+┊  ┊ 6┊import {RouterModule, Routes} from '@angular/router';\n+┊  ┊ 7┊import {FormsModule} from '@angular/forms';\n+┊  ┊ 8┊import {ChatsService} from '../services/chats.service';\n+┊  ┊ 9┊import {ChatItemComponent} from './components/chat-item/chat-item.component';\n+┊  ┊10┊import {ChatsComponent} from './containers/chats/chats.component';\n+┊  ┊11┊import {ChatsListComponent} from './components/chats-list/chats-list.component';\n+┊  ┊12┊import {TruncateModule} from 'ng2-truncate';\n+┊  ┊13┊import {SharedModule} from '../shared/shared.module';\n+┊  ┊14┊\n+┊  ┊15┊const routes: Routes = [\n+┊  ┊16┊  {path: '', redirectTo: 'chats', pathMatch: 'full'},\n+┊  ┊17┊  {path: 'chats', component: ChatsComponent},\n+┊  ┊18┊];\n+┊  ┊19┊\n+┊  ┊20┊@NgModule({\n+┊  ┊21┊  declarations: [\n+┊  ┊22┊    ChatsComponent,\n+┊  ┊23┊    ChatsListComponent,\n+┊  ┊24┊    ChatItemComponent,\n+┊  ┊25┊  ],\n+┊  ┊26┊  imports: [\n+┊  ┊27┊    BrowserModule,\n+┊  ┊28┊    // Material\n+┊  ┊29┊    MatMenuModule,\n+┊  ┊30┊    MatIconModule,\n+┊  ┊31┊    MatButtonModule,\n+┊  ┊32┊    MatListModule,\n+┊  ┊33┊    // Animations\n+┊  ┊34┊    BrowserAnimationsModule,\n+┊  ┊35┊    // Routing\n+┊  ┊36┊    RouterModule.forChild(routes),\n+┊  ┊37┊    // Forms\n+┊  ┊38┊    FormsModule,\n+┊  ┊39┊    // Truncate Pipe\n+┊  ┊40┊    TruncateModule,\n+┊  ┊41┊    // Feature modules\n+┊  ┊42┊    SharedModule,\n+┊  ┊43┊  ],\n+┊  ┊44┊  providers: [\n+┊  ┊45┊    ChatsService,\n+┊  ┊46┊  ],\n+┊  ┊47┊})\n+┊  ┊48┊export class ChatsListerModule {\n+┊  ┊49┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chat-item&#x2F;chat-item.component.scss\n```diff\n@@ -0,0 +1,44 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊  width: 100%;\n+┊  ┊ 4┊}\n+┊  ┊ 5┊\n+┊  ┊ 6┊.chat-row {\n+┊  ┊ 7┊  margin: 10px 0 0 10px;\n+┊  ┊ 8┊  height: 60px;\n+┊  ┊ 9┊  display: flex;\n+┊  ┊10┊\n+┊  ┊11┊  .chat-pic {\n+┊  ┊12┊    height: 50px;\n+┊  ┊13┊    width: auto;\n+┊  ┊14┊    border-radius: 50%;\n+┊  ┊15┊  }\n+┊  ┊16┊\n+┊  ┊17┊  .chat-info {\n+┊  ┊18┊    width: calc(100% - 60px);\n+┊  ┊19┊    height: 100%;\n+┊  ┊20┊    margin-left: 10px;\n+┊  ┊21┊    border-bottom: .5px solid silver;\n+┊  ┊22┊    position: relative;\n+┊  ┊23┊\n+┊  ┊24┊    .chat-name {\n+┊  ┊25┊      margin-top: 5px;\n+┊  ┊26┊    }\n+┊  ┊27┊\n+┊  ┊28┊    .chat-last-message {\n+┊  ┊29┊      color: gray;\n+┊  ┊30┊      font-size: 15px;\n+┊  ┊31┊      margin-top: 5px;\n+┊  ┊32┊      text-overflow: ellipsis;\n+┊  ┊33┊      overflow: hidden;\n+┊  ┊34┊    }\n+┊  ┊35┊\n+┊  ┊36┊    .chat-timestamp {\n+┊  ┊37┊      position: absolute;\n+┊  ┊38┊      color: gray;\n+┊  ┊39┊      top: 5px;\n+┊  ┊40┊      right: 5px;\n+┊  ┊41┊      font-size: 13px;\n+┊  ┊42┊    }\n+┊  ┊43┊  }\n+┊  ┊44┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chat-item&#x2F;chat-item.component.ts\n```diff\n@@ -0,0 +1,21 @@\n+┊  ┊ 1┊import {Component, Input} from '@angular/core';\n+┊  ┊ 2┊\n+┊  ┊ 3┊@Component({\n+┊  ┊ 4┊  selector: 'app-chat-item',\n+┊  ┊ 5┊  template: `\n+┊  ┊ 6┊    <div class=\"chat-row\">\n+┊  ┊ 7┊      <img class=\"chat-pic\" [src]=\"chat.picture || 'assets/default-profile-pic.jpg'\">\n+┊  ┊ 8┊      <div class=\"chat-info\">\n+┊  ┊ 9┊        <div class=\"chat-name\">{{ chat.name }}</div>\n+┊  ┊10┊        <div class=\"chat-last-message\">{{ chat.messages?[chat.messages?.length - 1]?.content }}</div>\n+┊  ┊11┊        <div class=\"chat-timestamp\">00:00</div>\n+┊  ┊12┊      </div>\n+┊  ┊13┊    </div>\n+┊  ┊14┊  `,\n+┊  ┊15┊  styleUrls: ['chat-item.component.scss'],\n+┊  ┊16┊})\n+┊  ┊17┊export class ChatItemComponent {\n+┊  ┊18┊  // tslint:disable-next-line:no-input-rename\n+┊  ┊19┊  @Input('item')\n+┊  ┊20┊  chat: any;\n+┊  ┊21┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chats-list&#x2F;chats-list.component.scss\n```diff\n@@ -0,0 +1,8 @@\n+┊ ┊1┊:host {\n+┊ ┊2┊  display: block;\n+┊ ┊3┊}\n+┊ ┊4┊\n+┊ ┊5┊:host ::ng-deep .mat-list-item-content:first-child {\n+┊ ┊6┊  padding-left: 0 !important;\n+┊ ┊7┊  display: flow-root !important;\n+┊ ┊8┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chats-list&#x2F;chats-list.component.ts\n```diff\n@@ -0,0 +1,20 @@\n+┊  ┊ 1┊import {Component, Input} from '@angular/core';\n+┊  ┊ 2┊\n+┊  ┊ 3┊@Component({\n+┊  ┊ 4┊  selector: 'app-chats-list',\n+┊  ┊ 5┊  template: `\n+┊  ┊ 6┊    <mat-list>\n+┊  ┊ 7┊      <mat-list-item *ngFor=\"let chat of chats\">\n+┊  ┊ 8┊        <app-chat-item [item]=\"chat\"></app-chat-item>\n+┊  ┊ 9┊      </mat-list-item>\n+┊  ┊10┊    </mat-list>\n+┊  ┊11┊  `,\n+┊  ┊12┊  styleUrls: ['chats-list.component.scss'],\n+┊  ┊13┊})\n+┊  ┊14┊export class ChatsListComponent {\n+┊  ┊15┊  // tslint:disable-next-line:no-input-rename\n+┊  ┊16┊  @Input('items')\n+┊  ┊17┊  chats: any[];\n+┊  ┊18┊\n+┊  ┊19┊  constructor() {}\n+┊  ┊20┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.scss\n```diff\n@@ -0,0 +1,5 @@\n+┊ ┊1┊.chat-button {\n+┊ ┊2┊  position: absolute;\n+┊ ┊3┊  bottom: 5vw;\n+┊ ┊4┊  right: 5vw;\n+┊ ┊5┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.ts\n```diff\n@@ -0,0 +1,46 @@\n+┊  ┊ 1┊import {Component, OnInit} from '@angular/core';\n+┊  ┊ 2┊import {ChatsService} from '../../../services/chats.service';\n+┊  ┊ 3┊import {Observable} from 'rxjs';\n+┊  ┊ 4┊\n+┊  ┊ 5┊@Component({\n+┊  ┊ 6┊  template: `\n+┊  ┊ 7┊    <app-toolbar>\n+┊  ┊ 8┊      <div class=\"title\">Whatsapp Clone</div>\n+┊  ┊ 9┊      <button mat-icon-button [matMenuTriggerFor]=\"menu\" class=\"menu\">\n+┊  ┊10┊        <mat-icon>more_vert</mat-icon>\n+┊  ┊11┊      </button>\n+┊  ┊12┊    </app-toolbar>\n+┊  ┊13┊\n+┊  ┊14┊    <mat-menu #menu=\"matMenu\">\n+┊  ┊15┊      <button mat-menu-item>\n+┊  ┊16┊        <mat-icon>dialpad</mat-icon>\n+┊  ┊17┊        <span>Redial</span>\n+┊  ┊18┊      </button>\n+┊  ┊19┊      <button mat-menu-item disabled>\n+┊  ┊20┊        <mat-icon>voicemail</mat-icon>\n+┊  ┊21┊        <span>Check voicemail</span>\n+┊  ┊22┊      </button>\n+┊  ┊23┊      <button mat-menu-item>\n+┊  ┊24┊        <mat-icon>notifications_off</mat-icon>\n+┊  ┊25┊        <span>Disable alerts</span>\n+┊  ┊26┊      </button>\n+┊  ┊27┊    </mat-menu>\n+┊  ┊28┊\n+┊  ┊29┊    <app-chats-list [items]=\"chats$ | async\"></app-chats-list>\n+┊  ┊30┊\n+┊  ┊31┊    <button class=\"chat-button\" mat-fab color=\"secondary\">\n+┊  ┊32┊      <mat-icon aria-label=\"Icon-button with a + icon\">chat</mat-icon>\n+┊  ┊33┊    </button>\n+┊  ┊34┊  `,\n+┊  ┊35┊  styleUrls: ['./chats.component.scss'],\n+┊  ┊36┊})\n+┊  ┊37┊export class ChatsComponent implements OnInit {\n+┊  ┊38┊  chats$: Observable<any[]>;\n+┊  ┊39┊\n+┊  ┊40┊  constructor(private chatsService: ChatsService) {\n+┊  ┊41┊  }\n+┊  ┊42┊\n+┊  ┊43┊  ngOnInit() {\n+┊  ┊44┊    this.chats$ = this.chatsService.getChats().chats$;\n+┊  ┊45┊  }\n+┊  ┊46┊}\n```\n\n[}]: #\n\nFinally let's wire everything up to the main module:\n\n[{]: <helper> (diffStep \"1.3\" files=\"src/app/app.component.ts, src/app/app.module.ts\" module=\"client\")\n\n#### [Step 1.3: List the chats](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/7d716ee)\n\n##### Changed src&#x2F;app&#x2F;app.component.ts\n```diff\n@@ -2,7 +2,9 @@\n ┊ 2┊ 2┊\n ┊ 3┊ 3┊@Component({\n ┊ 4┊ 4┊  selector: 'app-root',\n-┊ 5┊  ┊  templateUrl: './app.component.html',\n+┊  ┊ 5┊  template: `\n+┊  ┊ 6┊    <router-outlet></router-outlet>\n+┊  ┊ 7┊  `,\n ┊ 6┊ 8┊  styleUrls: ['./app.component.scss']\n ┊ 7┊ 9┊})\n ┊ 8┊10┊export class AppComponent {\n```\n\n##### Changed src&#x2F;app&#x2F;app.module.ts\n```diff\n@@ -4,6 +4,9 @@\n ┊ 4┊ 4┊import { AppComponent } from './app.component';\n ┊ 5┊ 5┊import { HttpClientModule } from '@angular/common/http';\n ┊ 6┊ 6┊import { GraphQLModule } from './graphql.module';\n+┊  ┊ 7┊import {ChatsListerModule} from './chats-lister/chats-lister.module';\n+┊  ┊ 8┊import {RouterModule, Routes} from '@angular/router';\n+┊  ┊ 9┊const routes: Routes = [];\n ┊ 7┊10┊\n ┊ 8┊11┊@NgModule({\n ┊ 9┊12┊  declarations: [\n```\n```diff\n@@ -13,6 +16,10 @@\n ┊13┊16┊    BrowserModule,\n ┊14┊17┊    HttpClientModule,\n ┊15┊18┊    GraphQLModule,\n+┊  ┊19┊    // Routing\n+┊  ┊20┊    RouterModule.forRoot(routes),\n+┊  ┊21┊    // Feature modules\n+┊  ┊22┊    ChatsListerModule,\n ┊16┊23┊  ],\n ┊17┊24┊  providers: [],\n ┊18┊25┊  bootstrap: [AppComponent]\n```\n\n[}]: #\n\nIf you will try to run the frontend you will notice that several messages seems like duplicated, why does it happen?\n\nSince we use NoSQL-like structure in our backend, messages are stored as an array inside each chat so their incremental identifiers are not unique across different chats. We need to normalize them in a way that takes into account both the message id and the chat id:\n\n[{]: <helper> (diffStep \"1.4\" module=\"client\")\n\n#### [Step 1.4: Better normalize messages](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/4209360)\n\n##### Changed src&#x2F;app&#x2F;graphql.module.ts\n```diff\n@@ -1,14 +1,21 @@\n ┊ 1┊ 1┊import { NgModule} from '@angular/core';\n ┊ 2┊ 2┊import { ApolloModule, APOLLO_OPTIONS } from 'apollo-angular';\n ┊ 3┊ 3┊import { HttpLinkModule, HttpLink } from 'apollo-angular-link-http';\n-┊ 4┊  ┊import { InMemoryCache } from 'apollo-cache-inmemory';\n+┊  ┊ 4┊import { InMemoryCache, defaultDataIdFromObject } from 'apollo-cache-inmemory';\n ┊ 5┊ 5┊\n ┊ 6┊ 6┊const uri = 'http://localhost:3000/graphql';\n ┊ 7┊ 7┊\n ┊ 8┊ 8┊export function createApollo(httpLink: HttpLink) {\n ┊ 9┊ 9┊  return {\n ┊10┊10┊    link: httpLink.create({uri}),\n-┊11┊  ┊    cache: new InMemoryCache(),\n+┊  ┊11┊    cache: new InMemoryCache({\n+┊  ┊12┊      dataIdFromObject: (object: any) => {\n+┊  ┊13┊        switch (object.__typename) {\n+┊  ┊14┊          case 'Message': return `${object.chat.id}:${object.id}`; // use `chatId` prefix and `messageId` as the primary key\n+┊  ┊15┊          default: return defaultDataIdFromObject(object); // fall back to default handling\n+┊  ┊16┊        }\n+┊  ┊17┊      }\n+┊  ┊18┊    }),\n ┊12┊19┊  };\n ┊13┊20┊}\n```\n\n[}]: #\n\nThat way our application will work even if the backend is a NoSQL. What's even more interesting is that our application will keep working as well even when we will switch our backend to PostgreSQL."
          },
          {
            "manualTitle": "Step 6: graphql-code-generator",
            "stepRevision": "b39f987d0944ef79a533fa88893c3a79b814a84f",
            "manualView": "## Code Generation\n\nGraphQL entities are defined as static and typed, which means they can be analyzed and use as a base for generating everything.\n\nThere are many tools related to that topic, but we're going to focus on The **GraphQL Coge Generator**.\n\nThe GraphQL Coge Generator can generate any code for any language  —  including type definitions, data models, query builder, resolvers, ORM code, complete full stack platforms.\n\nThe tool is based on the concept of templates. It has few official templates to solve most required features. The GraphQL Code Gen allows to create your own custom codegen templates in 10 minutes, that fit exactly your needs.\n\nWe will use TypeScript template to generate typings.\n\n### Generating types for server-side code\n\nFirst, let's install `graphql-code-generator` with the TypeScript template and add it to the run scripts:\n\n    yarn add graphql-code-generator graphql-codegen-typescript-template\n\n[{]: <helper> (diffStep \"2.1\" module=\"server\")\n\n#### [Step 2.1: Install graphql-code-generator](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/b8214fd)\n\n##### Changed package.json\n```diff\n@@ -4,7 +4,8 @@\n ┊ 4┊ 4┊  \"private\": true,\n ┊ 5┊ 5┊  \"scripts\": {\n ┊ 6┊ 6┊    \"start\": \"npm run build:live\",\n-┊ 7┊  ┊    \"build:live\": \"nodemon --exec ./node_modules/.bin/ts-node -- ./index.ts\"\n+┊  ┊ 7┊    \"build:live\": \"nodemon --exec ./node_modules/.bin/ts-node -- ./index.ts\",\n+┊  ┊ 8┊    \"generator\": \"gql-gen -r ts-node/register —schema schema/typeDefs.ts --template ts --out ./types.d.ts\"\n ┊ 8┊ 9┊  },\n ┊ 9┊10┊  \"devDependencies\": {\n ┊10┊11┊    \"@types/body-parser\": \"1.17.0\",\n```\n```diff\n@@ -22,6 +23,7 @@\n ┊22┊23┊    \"cors\": \"2.8.4\",\n ┊23┊24┊    \"express\": \"4.16.3\",\n ┊24┊25┊    \"graphql\": \"14.0.2\",\n+┊  ┊26┊    \"graphql-code-generator\": \"0.12.6\",\n ┊25┊27┊    \"moment\": \"2.22.1\"\n ┊26┊28┊  }\n ┊27┊29┊}\n```\n\n[}]: #\n\nFew things here:\n\n- `--require ts-node/register` - makes the ts-node compile TypeScript files\n- `--schema` - points to a file that exports the GraphQL Schema object or a string (it also accepts an url)\n- `--template` - tells about the template we want to use\n- `--out` - the location of a generated file\n\nNow let's run the generator:\n\n    yarn generator\n\nPlease note that the server doesn't have to be running in background because we import schema through a file.\n\nNext, let's use the generated types:\n\n[{]: <helper> (diffStep \"2.3\" module=\"server\")\n\n#### [Step 2.3: Use our types](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/ef59ecf)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,5 +1,6 @@\n ┊1┊1┊import { IResolvers } from 'apollo-server-express';\n ┊2┊2┊import { Chat, db, Message, Recipient, User } from \"../db\";\n+┊ ┊3┊import { ChatQueryArgs } from \"../types\";\n ┊3┊4┊\n ┊4┊5┊let users = db.users;\n ┊5┊6┊let chats = db.chats;\n```\n```diff\n@@ -10,7 +11,7 @@\n ┊10┊11┊    // Show all users for the moment.\n ┊11┊12┊    users: (): User[] => users.filter(user => user.id !== currentUser),\n ┊12┊13┊    chats: (): Chat[] => chats.filter(chat => chat.listingMemberIds.includes(currentUser)),\n-┊13┊  ┊    chat: (obj: any, {chatId}): Chat | null => chats.find(chat => chat.id === chatId) || null,\n+┊  ┊14┊    chat: (obj: any, {chatId}: ChatQueryArgs): Chat | null => chats.find(chat => chat.id === Number(chatId)) || null,\n ┊14┊15┊  },\n ┊15┊16┊  Chat: {\n ┊16┊17┊    name: (chat: Chat): string => chat.name ? chat.name : users\n```\n\n[}]: #\n\nDon't worry, they will be much more useful when we will write our first mutation.\n\n### Generating types for client-side code\n\nLet's do the same on the client:\n\n    yarn add graphql-code-generator graphql-codegen-typescript-template\n\nPlease note that in this case, the server must be started before running the generator.\n\n[{]: <helper> (diffStep \"2.1\" module=\"client\")\n\n#### [Step 2.1: Install graphql-code-generator](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/a97dbe5)\n\n##### Changed package.json\n```diff\n@@ -7,7 +7,8 @@\n ┊ 7┊ 7┊    \"build\": \"ng build\",\n ┊ 8┊ 8┊    \"test\": \"ng test\",\n ┊ 9┊ 9┊    \"lint\": \"ng lint\",\n-┊10┊  ┊    \"e2e\": \"ng e2e\"\n+┊  ┊10┊    \"e2e\": \"ng e2e\",\n+┊  ┊11┊    \"generator\": \"gql-gen --schema http://localhost:3000/graphql --template graphql-codegen-typescript-template --out ./src/graphql.ts ./src/graphql/**/*.ts\"\n ┊11┊12┊  },\n ┊12┊13┊  \"private\": true,\n ┊13┊14┊  \"dependencies\": {\n```\n```diff\n@@ -45,6 +46,7 @@\n ┊45┊46┊    \"@types/jasminewd2\": \"2.0.3\",\n ┊46┊47┊    \"@types/node\": \"8.9.5\",\n ┊47┊48┊    \"codelyzer\": \"4.2.1\",\n+┊  ┊49┊    \"graphql-code-generator\": \"0.12.6\",\n ┊48┊50┊    \"jasmine-core\": \"2.99.1\",\n ┊49┊51┊    \"jasmine-spec-reporter\": \"4.2.1\",\n ┊50┊52┊    \"karma\": \"1.7.1\",\n```\n\n[}]: #\n\nWe saw how to use them on the server but let's see how easy it is to take advantage of them in Apollo.\n\nFirst thing you should know is most of the methods of Apollo service accepts generic types.\n\n#### What are Generic Types\n\nA major part of software engineering is building components that not only have well-defined and consistent APIs, but are also reusable. Components that are capable of working on the data of today as well as the data of tomorrow will give you the most flexible capabilities for building up large software systems.\n\nWe like to work on an code samples so let's do some functional programming and create the `map` method that accepts a transform function and return a new result.\n\nWithout generics, we would have to use a specific type or `any`:\n\n```typescript\nfunction map(mapFn: (value: any) => any) {\n  return function(source: any): any {\n    return mapFn(source);\n  };\n}\n```\n\nImagine, we want to use `map` function to pick user's id from an object:\n\n```typescript\ninterface User {\n  id: number;\n}\nconst me = {\n  id: 1,\n};\n\nconst pickUserId = map(user => user.id);\n\nconsole.log(pickUserId(me)); // outputs: 1\n```\n\nGreat, it works, we get the expected result but it could be done way better.\n\nWhat is the main issue here?\nIt accepts an object of any type and get `any` in return. It's not very useful because we know it return a `number` and receive a `User` but TypeScript doesn't know that and later on, in other part of the code, we end up with no information about the result.\n\nThat's where Generic Types jumps in!\n\nWith generics, it could look like this:\n\n```typescript\nfunction map<T, R>(mapFn: (value: T) => R) {\n  return function(source: T): R {\n    return mapFn(source);\n  };\n}\n```\n\nThere's... a lot! So let's break it:\n\n- `map<T, R>` - the map function accepts two generic types\n- `(mapFn: (value: T) => R)` - the only argument is a function that accepts an object of type `T` and returns value of type `R`\n- `function (source: T): R => {...}` - it's a higher order function that accepts a source of type `T` and transforms to be `R`.\n\nBack to our example, now with generic types:\n\n```typescript\ninterface User {\n  id: number;\n}\nconst me = {\n  id: 1,\n};\n\nconst pickUserId = map<User, number>(user => user.id);\n\nconsole.log(pickUserId(me)); // outputs: 1\n```\n\nOur `map` and `pickUserId` function are strongly typed now so when you try to provide an object that has no `id` field or the field is a `string` you'll receive a proper information from TypeScript (and your IDE).\n\n#### Make client-side code strongly typed\n\nWith all that knowledge let's use how to use those generated typed with `Apollo` service:\n\n[{]: <helper> (diffStep \"2.3\" module=\"client\")\n\n#### [Step 2.3: Use the generated types](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/afdf40c)\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chat-item&#x2F;chat-item.component.ts\n```diff\n@@ -1,4 +1,5 @@\n ┊1┊1┊import {Component, Input} from '@angular/core';\n+┊ ┊2┊import {GetChats} from '../../../../graphql';\n ┊2┊3┊\n ┊3┊4┊@Component({\n ┊4┊5┊  selector: 'app-chat-item',\n```\n```diff\n@@ -17,5 +18,5 @@\n ┊17┊18┊export class ChatItemComponent {\n ┊18┊19┊  // tslint:disable-next-line:no-input-rename\n ┊19┊20┊  @Input('item')\n-┊20┊  ┊  chat: any;\n+┊  ┊21┊  chat: GetChats.Chats;\n ┊21┊22┊}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chats-list&#x2F;chats-list.component.ts\n```diff\n@@ -1,4 +1,5 @@\n ┊1┊1┊import {Component, Input} from '@angular/core';\n+┊ ┊2┊import {GetChats} from '../../../../graphql';\n ┊2┊3┊\n ┊3┊4┊@Component({\n ┊4┊5┊  selector: 'app-chats-list',\n```\n```diff\n@@ -14,7 +15,7 @@\n ┊14┊15┊export class ChatsListComponent {\n ┊15┊16┊  // tslint:disable-next-line:no-input-rename\n ┊16┊17┊  @Input('items')\n-┊17┊  ┊  chats: any[];\n+┊  ┊18┊  chats: GetChats.Chats[];\n ┊18┊19┊\n ┊19┊20┊  constructor() {}\n ┊20┊21┊}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.ts\n```diff\n@@ -1,6 +1,7 @@\n ┊1┊1┊import {Component, OnInit} from '@angular/core';\n ┊2┊2┊import {ChatsService} from '../../../services/chats.service';\n ┊3┊3┊import {Observable} from 'rxjs';\n+┊ ┊4┊import {GetChats} from '../../../../graphql';\n ┊4┊5┊\n ┊5┊6┊@Component({\n ┊6┊7┊  template: `\n```\n```diff\n@@ -35,7 +36,7 @@\n ┊35┊36┊  styleUrls: ['./chats.component.scss'],\n ┊36┊37┊})\n ┊37┊38┊export class ChatsComponent implements OnInit {\n-┊38┊  ┊  chats$: Observable<any[]>;\n+┊  ┊39┊  chats$: Observable<GetChats.Chats[]>;\n ┊39┊40┊\n ┊40┊41┊  constructor(private chatsService: ChatsService) {\n ┊41┊42┊  }\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -2,6 +2,7 @@\n ┊2┊2┊import {Apollo} from 'apollo-angular';\n ┊3┊3┊import {Injectable} from '@angular/core';\n ┊4┊4┊import {getChatsQuery} from '../../graphql/getChats.query';\n+┊ ┊5┊import {GetChats} from '../../graphql';\n ┊5┊6┊\n ┊6┊7┊@Injectable()\n ┊7┊8┊export class ChatsService {\n```\n```diff\n@@ -10,7 +11,7 @@\n ┊10┊11┊  constructor(private apollo: Apollo) {}\n ┊11┊12┊\n ┊12┊13┊  getChats() {\n-┊13┊  ┊    const query = this.apollo.watchQuery<any>({\n+┊  ┊14┊    const query = this.apollo.watchQuery<GetChats.Query>({\n ┊14┊15┊      query: getChatsQuery,\n ┊15┊16┊      variables: {\n ┊16┊17┊        amount: this.messagesAmount,\n```\n\n[}]: #\n\nAs you can probably tell by now, methods like `watchQuery` and `mutate` (and others) accepts two generic types, first one describes the result and the second one the variables.\n\n```typescript\nexport class ChatService {\n  constructor(private apollo: Apollo) {}\n\n  getChat(chatId: string, amount: number): GetChat.Chat {\n    return this.apollo\n      .watchQuery<GetChat.Query, GetChat.Variables>({\n        query: getChatQuery,\n        variables: {\n          chatId,\n          amount,\n        },\n      })\n      .pipe(map(result => result.data.chat));\n  }\n}\n```\n\nFew things here.\n\n- An object of `GetChat.Query` shape lives under the `result.data` because `watchQuery` returns an object of type `ApolloQueryResult<T>` where `T` is our `GetChat.Query`.\n\n```typescript\nexport type ApolloQueryResult<T> = {\n  data: T;\n  // ... other fields\n};\n```\n\nYou get the same result with Mutation or Subscription.\n\n- Thanks to the second argument and `GetChat.Variables` we as well as TypeScript (and an IDE) know that `chatId` is a string and `amount` accepts only a number. Whenever we try to pass a value of different kind an Error will pop out.\n\n### Take full advantage of Codegen and generate ready to use Services!\n\nI've got a fantasctic news, you don't have to manually provide those generated types to each type Apollo service is used. Because GraphQL Documents are statically analyzable, we prepared a codegen template specific for Apollo Angular users.\n\nFirst, let's install `graphql-codegen-apollo-angular` with the Apollo Angular templatea and update the template param of `generator` script\n\n    yarn add graphql-code-generator graphql-codegen-typescript-template\n\n[{]: <helper> (diffStep \"2.4\" file=\"package.json\" module=\"client\")\n\n#### [Step 2.4: Use auto-generated GQL services](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/c0eddd1)\n\n##### Changed package.json\n```diff\n@@ -8,7 +8,7 @@\n ┊ 8┊ 8┊    \"test\": \"ng test\",\n ┊ 9┊ 9┊    \"lint\": \"ng lint\",\n ┊10┊10┊    \"e2e\": \"ng e2e\",\n-┊11┊  ┊    \"generator\": \"gql-gen --schema http://localhost:3000/graphql --template graphql-codegen-typescript-template --out ./src/graphql.ts ./src/graphql/**/*.ts\"\n+┊  ┊11┊    \"generator\": \"gql-gen --schema http://localhost:3000/graphql --template graphql-codegen-apollo-angular-template --out ./src/graphql.ts ./src/graphql/**/*.ts\"\n ┊12┊12┊  },\n ┊13┊13┊  \"private\": true,\n ┊14┊14┊  \"dependencies\": {\n```\n```diff\n@@ -48,6 +48,7 @@\n ┊48┊48┊    \"codelyzer\": \"4.2.1\",\n ┊49┊49┊    \"graphql-code-generator\": \"0.12.6\",\n ┊50┊50┊    \"graphql-codegen-typescript-template\": \"0.12.6\",\n+┊  ┊51┊    \"graphql-codegen-apollo-angular-template\": \"0.12.6\",\n ┊51┊52┊    \"jasmine-core\": \"2.99.1\",\n ┊52┊53┊    \"jasmine-spec-reporter\": \"4.2.1\",\n ┊53┊54┊    \"karma\": \"1.7.1\",\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,21 +1,18 @@\n ┊ 1┊ 1┊import {map} from 'rxjs/operators';\n-┊ 2┊  ┊import {Apollo} from 'apollo-angular';\n ┊ 3┊ 2┊import {Injectable} from '@angular/core';\n-┊ 4┊  ┊import {getChatsQuery} from '../../graphql/getChats.query';\n-┊ 5┊  ┊import {GetChats} from '../../graphql';\n+┊  ┊ 3┊import {GetChatsGQL} from '../../graphql';\n ┊ 6┊ 4┊\n ┊ 7┊ 5┊@Injectable()\n ┊ 8┊ 6┊export class ChatsService {\n ┊ 9┊ 7┊  messagesAmount = 3;\n ┊10┊ 8┊\n-┊11┊  ┊  constructor(private apollo: Apollo) {}\n+┊  ┊ 9┊  constructor(\n+┊  ┊10┊    private getChatsGQL: GetChatsGQL\n+┊  ┊11┊  ) {}\n ┊12┊12┊\n ┊13┊13┊  getChats() {\n-┊14┊  ┊    const query = this.apollo.watchQuery<GetChats.Query>({\n-┊15┊  ┊      query: getChatsQuery,\n-┊16┊  ┊      variables: {\n-┊17┊  ┊        amount: this.messagesAmount,\n-┊18┊  ┊      },\n+┊  ┊14┊    const query = this.getChatsGQL.watch({\n+┊  ┊15┊      amount: this.messagesAmount,\n ┊19┊16┊    });\n ┊20┊17┊    const chats$ = query.valueChanges.pipe(\n ┊21┊18┊      map((result) => result.data.chats)\n```\n\n##### Changed src&#x2F;graphql.ts\n```diff\n@@ -28,6 +28,8 @@\n ┊28┊28┊  ): R | Result | Promise<R | Result>;\n ┊29┊29┊};\n ┊30┊30┊\n+┊  ┊31┊export type Date = any;\n+┊  ┊32┊\n ┊31┊33┊export interface Query {\n ┊32┊34┊  users?: User[] | null;\n ┊33┊35┊  chats?: Chat[] | null;\n```\n```diff\n@@ -42,17 +44,18 @@\n ┊42┊44┊}\n ┊43┊45┊\n ┊44┊46┊export interface Chat {\n-┊45┊  ┊  id: string /** May be a chat or a group */;\n-┊46┊  ┊  name?: string | null /** Computed for chats */;\n-┊47┊  ┊  picture?: string | null /** Computed for chats */;\n-┊48┊  ┊  allTimeMembers: User[] /** All members, current and past ones. */;\n-┊49┊  ┊  listingMembers: User[] /** Whoever gets the chat listed. For groups includes past members who still didn't delete the group. */;\n-┊50┊  ┊  actualGroupMembers: User[] /** Actual members of the group (they are not the only ones who get the group listed). Null for chats. */;\n-┊51┊  ┊  admins?: User[] | null /** Null for chats */;\n-┊52┊  ┊  owner?: User | null /** If null the group is read-only. Null for chats. */;\n+┊  ┊47┊  id: string;\n+┊  ┊48┊  name?: string | null;\n+┊  ┊49┊  picture?: string | null;\n+┊  ┊50┊  allTimeMembers: User[];\n+┊  ┊51┊  listingMembers: User[];\n+┊  ┊52┊  actualGroupMembers: User[];\n+┊  ┊53┊  admins?: User[] | null;\n+┊  ┊54┊  owner?: User | null;\n ┊53┊55┊  messages: (Message | null)[];\n-┊54┊  ┊  unreadMessages: number /** Computed property */;\n-┊55┊  ┊  isGroup: boolean /** Computed property */;\n+┊  ┊56┊  messageFeed?: MessageFeed | null;\n+┊  ┊57┊  unreadMessages: number;\n+┊  ┊58┊  isGroup: boolean;\n ┊56┊59┊}\n ┊57┊60┊\n ┊58┊61┊export interface Message {\n```\n```diff\n@@ -60,25 +63,107 @@\n ┊ 60┊ 63┊  sender: User;\n ┊ 61┊ 64┊  chat: Chat;\n ┊ 62┊ 65┊  content: string;\n-┊ 63┊   ┊  createdAt: string;\n-┊ 64┊   ┊  type: number /** FIXME: should return MessageType */;\n-┊ 65┊   ┊  recipients: Recipient[] /** Whoever received the message */;\n-┊ 66┊   ┊  holders: User[] /** Whoever still holds a copy of the message. Cannot be null because the message gets deleted otherwise */;\n-┊ 67┊   ┊  ownership: boolean /** Computed property */;\n+┊   ┊ 66┊  createdAt: Date;\n+┊   ┊ 67┊  type: number;\n+┊   ┊ 68┊  recipients: Recipient[];\n+┊   ┊ 69┊  holders: User[];\n+┊   ┊ 70┊  ownership: boolean;\n ┊ 68┊ 71┊}\n ┊ 69┊ 72┊\n ┊ 70┊ 73┊export interface Recipient {\n ┊ 71┊ 74┊  user: User;\n ┊ 72┊ 75┊  message: Message;\n ┊ 73┊ 76┊  chat: Chat;\n-┊ 74┊   ┊  receivedAt?: string | null;\n-┊ 75┊   ┊  readAt?: string | null;\n+┊   ┊ 77┊  receivedAt?: Date | null;\n+┊   ┊ 78┊  readAt?: Date | null;\n+┊   ┊ 79┊}\n+┊   ┊ 80┊\n+┊   ┊ 81┊export interface MessageFeed {\n+┊   ┊ 82┊  hasNextPage: boolean;\n+┊   ┊ 83┊  cursor?: string | null;\n+┊   ┊ 84┊  messages: (Message | null)[];\n+┊   ┊ 85┊}\n+┊   ┊ 86┊\n+┊   ┊ 87┊export interface Mutation {\n+┊   ┊ 88┊  addChat?: Chat | null;\n+┊   ┊ 89┊  addGroup?: Chat | null;\n+┊   ┊ 90┊  removeChat?: string | null;\n+┊   ┊ 91┊  addMessage?: Message | null;\n+┊   ┊ 92┊  removeMessages?: (string | null)[] | null;\n+┊   ┊ 93┊  addMembers?: (string | null)[] | null;\n+┊   ┊ 94┊  removeMembers?: (string | null)[] | null;\n+┊   ┊ 95┊  addAdmins?: (string | null)[] | null;\n+┊   ┊ 96┊  removeAdmins?: (string | null)[] | null;\n+┊   ┊ 97┊  setGroupName?: string | null;\n+┊   ┊ 98┊  setGroupPicture?: string | null;\n+┊   ┊ 99┊  markAsReceived?: boolean | null;\n+┊   ┊100┊  markAsRead?: boolean | null;\n+┊   ┊101┊}\n+┊   ┊102┊\n+┊   ┊103┊export interface Subscription {\n+┊   ┊104┊  messageAdded?: Message | null;\n+┊   ┊105┊  chatAdded?: Chat | null;\n ┊ 76┊106┊}\n ┊ 77┊107┊export interface ChatQueryArgs {\n ┊ 78┊108┊  chatId: string;\n ┊ 79┊109┊}\n ┊ 80┊110┊export interface MessagesChatArgs {\n ┊ 81┊111┊  amount?: number | null;\n+┊   ┊112┊  before?: string | null;\n+┊   ┊113┊}\n+┊   ┊114┊export interface MessageFeedChatArgs {\n+┊   ┊115┊  amount?: number | null;\n+┊   ┊116┊  before?: string | null;\n+┊   ┊117┊}\n+┊   ┊118┊export interface AddChatMutationArgs {\n+┊   ┊119┊  recipientId: string;\n+┊   ┊120┊}\n+┊   ┊121┊export interface AddGroupMutationArgs {\n+┊   ┊122┊  recipientIds: string[];\n+┊   ┊123┊  groupName: string;\n+┊   ┊124┊}\n+┊   ┊125┊export interface RemoveChatMutationArgs {\n+┊   ┊126┊  chatId: string;\n+┊   ┊127┊}\n+┊   ┊128┊export interface AddMessageMutationArgs {\n+┊   ┊129┊  chatId: string;\n+┊   ┊130┊  content: string;\n+┊   ┊131┊}\n+┊   ┊132┊export interface RemoveMessagesMutationArgs {\n+┊   ┊133┊  chatId: string;\n+┊   ┊134┊  messageIds?: (string | null)[] | null;\n+┊   ┊135┊  all?: boolean | null;\n+┊   ┊136┊}\n+┊   ┊137┊export interface AddMembersMutationArgs {\n+┊   ┊138┊  groupId: string;\n+┊   ┊139┊  userIds: string[];\n+┊   ┊140┊}\n+┊   ┊141┊export interface RemoveMembersMutationArgs {\n+┊   ┊142┊  groupId: string;\n+┊   ┊143┊  userIds: string[];\n+┊   ┊144┊}\n+┊   ┊145┊export interface AddAdminsMutationArgs {\n+┊   ┊146┊  groupId: string;\n+┊   ┊147┊  userIds: string[];\n+┊   ┊148┊}\n+┊   ┊149┊export interface RemoveAdminsMutationArgs {\n+┊   ┊150┊  groupId: string;\n+┊   ┊151┊  userIds: string[];\n+┊   ┊152┊}\n+┊   ┊153┊export interface SetGroupNameMutationArgs {\n+┊   ┊154┊  groupId: string;\n+┊   ┊155┊}\n+┊   ┊156┊export interface SetGroupPictureMutationArgs {\n+┊   ┊157┊  groupId: string;\n+┊   ┊158┊}\n+┊   ┊159┊export interface MarkAsReceivedMutationArgs {\n+┊   ┊160┊  chatId: string;\n+┊   ┊161┊}\n+┊   ┊162┊export interface MarkAsReadMutationArgs {\n+┊   ┊163┊  chatId: string;\n+┊   ┊164┊}\n+┊   ┊165┊export interface MessageAddedSubscriptionArgs {\n+┊   ┊166┊  chatId?: string | null;\n ┊ 82┊167┊}\n ┊ 83┊168┊\n ┊ 84┊169┊export enum MessageType {\n```\n```diff\n@@ -146,41 +231,18 @@\n ┊146┊231┊\n ┊147┊232┊export namespace ChatResolvers {\n ┊148┊233┊  export interface Resolvers<Context = any> {\n-┊149┊   ┊    id?: IdResolver<string, any, Context> /** May be a chat or a group */;\n-┊150┊   ┊    name?: NameResolver<string | null, any, Context> /** Computed for chats */;\n-┊151┊   ┊    picture?: PictureResolver<\n-┊152┊   ┊      string | null,\n-┊153┊   ┊      any,\n-┊154┊   ┊      Context\n-┊155┊   ┊    > /** Computed for chats */;\n-┊156┊   ┊    allTimeMembers?: AllTimeMembersResolver<\n-┊157┊   ┊      User[],\n-┊158┊   ┊      any,\n-┊159┊   ┊      Context\n-┊160┊   ┊    > /** All members, current and past ones. */;\n-┊161┊   ┊    listingMembers?: ListingMembersResolver<\n-┊162┊   ┊      User[],\n-┊163┊   ┊      any,\n-┊164┊   ┊      Context\n-┊165┊   ┊    > /** Whoever gets the chat listed. For groups includes past members who still didn't delete the group. */;\n-┊166┊   ┊    actualGroupMembers?: ActualGroupMembersResolver<\n-┊167┊   ┊      User[],\n-┊168┊   ┊      any,\n-┊169┊   ┊      Context\n-┊170┊   ┊    > /** Actual members of the group (they are not the only ones who get the group listed). Null for chats. */;\n-┊171┊   ┊    admins?: AdminsResolver<User[] | null, any, Context> /** Null for chats */;\n-┊172┊   ┊    owner?: OwnerResolver<\n-┊173┊   ┊      User | null,\n-┊174┊   ┊      any,\n-┊175┊   ┊      Context\n-┊176┊   ┊    > /** If null the group is read-only. Null for chats. */;\n+┊   ┊234┊    id?: IdResolver<string, any, Context>;\n+┊   ┊235┊    name?: NameResolver<string | null, any, Context>;\n+┊   ┊236┊    picture?: PictureResolver<string | null, any, Context>;\n+┊   ┊237┊    allTimeMembers?: AllTimeMembersResolver<User[], any, Context>;\n+┊   ┊238┊    listingMembers?: ListingMembersResolver<User[], any, Context>;\n+┊   ┊239┊    actualGroupMembers?: ActualGroupMembersResolver<User[], any, Context>;\n+┊   ┊240┊    admins?: AdminsResolver<User[] | null, any, Context>;\n+┊   ┊241┊    owner?: OwnerResolver<User | null, any, Context>;\n ┊177┊242┊    messages?: MessagesResolver<(Message | null)[], any, Context>;\n-┊178┊   ┊    unreadMessages?: UnreadMessagesResolver<\n-┊179┊   ┊      number,\n-┊180┊   ┊      any,\n-┊181┊   ┊      Context\n-┊182┊   ┊    > /** Computed property */;\n-┊183┊   ┊    isGroup?: IsGroupResolver<boolean, any, Context> /** Computed property */;\n+┊   ┊243┊    messageFeed?: MessageFeedResolver<MessageFeed | null, any, Context>;\n+┊   ┊244┊    unreadMessages?: UnreadMessagesResolver<number, any, Context>;\n+┊   ┊245┊    isGroup?: IsGroupResolver<boolean, any, Context>;\n ┊184┊246┊  }\n ┊185┊247┊\n ┊186┊248┊  export type IdResolver<R = string, Parent = any, Context = any> = Resolver<\n```\n```diff\n@@ -230,6 +292,17 @@\n ┊230┊292┊  > = Resolver<R, Parent, Context, MessagesArgs>;\n ┊231┊293┊  export interface MessagesArgs {\n ┊232┊294┊    amount?: number | null;\n+┊   ┊295┊    before?: string | null;\n+┊   ┊296┊  }\n+┊   ┊297┊\n+┊   ┊298┊  export type MessageFeedResolver<\n+┊   ┊299┊    R = MessageFeed | null,\n+┊   ┊300┊    Parent = any,\n+┊   ┊301┊    Context = any\n+┊   ┊302┊  > = Resolver<R, Parent, Context, MessageFeedArgs>;\n+┊   ┊303┊  export interface MessageFeedArgs {\n+┊   ┊304┊    amount?: number | null;\n+┊   ┊305┊    before?: string | null;\n ┊233┊306┊  }\n ┊234┊307┊\n ┊235┊308┊  export type UnreadMessagesResolver<\n```\n```diff\n@@ -250,27 +323,11 @@\n ┊250┊323┊    sender?: SenderResolver<User, any, Context>;\n ┊251┊324┊    chat?: ChatResolver<Chat, any, Context>;\n ┊252┊325┊    content?: ContentResolver<string, any, Context>;\n-┊253┊   ┊    createdAt?: CreatedAtResolver<string, any, Context>;\n-┊254┊   ┊    type?: TypeResolver<\n-┊255┊   ┊      number,\n-┊256┊   ┊      any,\n-┊257┊   ┊      Context\n-┊258┊   ┊    > /** FIXME: should return MessageType */;\n-┊259┊   ┊    recipients?: RecipientsResolver<\n-┊260┊   ┊      Recipient[],\n-┊261┊   ┊      any,\n-┊262┊   ┊      Context\n-┊263┊   ┊    > /** Whoever received the message */;\n-┊264┊   ┊    holders?: HoldersResolver<\n-┊265┊   ┊      User[],\n-┊266┊   ┊      any,\n-┊267┊   ┊      Context\n-┊268┊   ┊    > /** Whoever still holds a copy of the message. Cannot be null because the message gets deleted otherwise */;\n-┊269┊   ┊    ownership?: OwnershipResolver<\n-┊270┊   ┊      boolean,\n-┊271┊   ┊      any,\n-┊272┊   ┊      Context\n-┊273┊   ┊    > /** Computed property */;\n+┊   ┊326┊    createdAt?: CreatedAtResolver<Date, any, Context>;\n+┊   ┊327┊    type?: TypeResolver<number, any, Context>;\n+┊   ┊328┊    recipients?: RecipientsResolver<Recipient[], any, Context>;\n+┊   ┊329┊    holders?: HoldersResolver<User[], any, Context>;\n+┊   ┊330┊    ownership?: OwnershipResolver<boolean, any, Context>;\n ┊274┊331┊  }\n ┊275┊332┊\n ┊276┊333┊  export type IdResolver<R = string, Parent = any, Context = any> = Resolver<\n```\n```diff\n@@ -294,7 +351,7 @@\n ┊294┊351┊    Context = any\n ┊295┊352┊  > = Resolver<R, Parent, Context>;\n ┊296┊353┊  export type CreatedAtResolver<\n-┊297┊   ┊    R = string,\n+┊   ┊354┊    R = Date,\n ┊298┊355┊    Parent = any,\n ┊299┊356┊    Context = any\n ┊300┊357┊  > = Resolver<R, Parent, Context>;\n```\n```diff\n@@ -325,8 +382,8 @@\n ┊325┊382┊    user?: UserResolver<User, any, Context>;\n ┊326┊383┊    message?: MessageResolver<Message, any, Context>;\n ┊327┊384┊    chat?: ChatResolver<Chat, any, Context>;\n-┊328┊   ┊    receivedAt?: ReceivedAtResolver<string | null, any, Context>;\n-┊329┊   ┊    readAt?: ReadAtResolver<string | null, any, Context>;\n+┊   ┊385┊    receivedAt?: ReceivedAtResolver<Date | null, any, Context>;\n+┊   ┊386┊    readAt?: ReadAtResolver<Date | null, any, Context>;\n ┊330┊387┊  }\n ┊331┊388┊\n ┊332┊389┊  export type UserResolver<R = User, Parent = any, Context = any> = Resolver<\n```\n```diff\n@@ -345,14 +402,211 @@\n ┊345┊402┊    Context\n ┊346┊403┊  >;\n ┊347┊404┊  export type ReceivedAtResolver<\n-┊348┊   ┊    R = string | null,\n+┊   ┊405┊    R = Date | null,\n ┊349┊406┊    Parent = any,\n ┊350┊407┊    Context = any\n ┊351┊408┊  > = Resolver<R, Parent, Context>;\n ┊352┊409┊  export type ReadAtResolver<\n+┊   ┊410┊    R = Date | null,\n+┊   ┊411┊    Parent = any,\n+┊   ┊412┊    Context = any\n+┊   ┊413┊  > = Resolver<R, Parent, Context>;\n+┊   ┊414┊}\n+┊   ┊415┊\n+┊   ┊416┊export namespace MessageFeedResolvers {\n+┊   ┊417┊  export interface Resolvers<Context = any> {\n+┊   ┊418┊    hasNextPage?: HasNextPageResolver<boolean, any, Context>;\n+┊   ┊419┊    cursor?: CursorResolver<string | null, any, Context>;\n+┊   ┊420┊    messages?: MessagesResolver<(Message | null)[], any, Context>;\n+┊   ┊421┊  }\n+┊   ┊422┊\n+┊   ┊423┊  export type HasNextPageResolver<\n+┊   ┊424┊    R = boolean,\n+┊   ┊425┊    Parent = any,\n+┊   ┊426┊    Context = any\n+┊   ┊427┊  > = Resolver<R, Parent, Context>;\n+┊   ┊428┊  export type CursorResolver<\n+┊   ┊429┊    R = string | null,\n+┊   ┊430┊    Parent = any,\n+┊   ┊431┊    Context = any\n+┊   ┊432┊  > = Resolver<R, Parent, Context>;\n+┊   ┊433┊  export type MessagesResolver<\n+┊   ┊434┊    R = (Message | null)[],\n+┊   ┊435┊    Parent = any,\n+┊   ┊436┊    Context = any\n+┊   ┊437┊  > = Resolver<R, Parent, Context>;\n+┊   ┊438┊}\n+┊   ┊439┊\n+┊   ┊440┊export namespace MutationResolvers {\n+┊   ┊441┊  export interface Resolvers<Context = any> {\n+┊   ┊442┊    addChat?: AddChatResolver<Chat | null, any, Context>;\n+┊   ┊443┊    addGroup?: AddGroupResolver<Chat | null, any, Context>;\n+┊   ┊444┊    removeChat?: RemoveChatResolver<string | null, any, Context>;\n+┊   ┊445┊    addMessage?: AddMessageResolver<Message | null, any, Context>;\n+┊   ┊446┊    removeMessages?: RemoveMessagesResolver<\n+┊   ┊447┊      (string | null)[] | null,\n+┊   ┊448┊      any,\n+┊   ┊449┊      Context\n+┊   ┊450┊    >;\n+┊   ┊451┊    addMembers?: AddMembersResolver<(string | null)[] | null, any, Context>;\n+┊   ┊452┊    removeMembers?: RemoveMembersResolver<\n+┊   ┊453┊      (string | null)[] | null,\n+┊   ┊454┊      any,\n+┊   ┊455┊      Context\n+┊   ┊456┊    >;\n+┊   ┊457┊    addAdmins?: AddAdminsResolver<(string | null)[] | null, any, Context>;\n+┊   ┊458┊    removeAdmins?: RemoveAdminsResolver<(string | null)[] | null, any, Context>;\n+┊   ┊459┊    setGroupName?: SetGroupNameResolver<string | null, any, Context>;\n+┊   ┊460┊    setGroupPicture?: SetGroupPictureResolver<string | null, any, Context>;\n+┊   ┊461┊    markAsReceived?: MarkAsReceivedResolver<boolean | null, any, Context>;\n+┊   ┊462┊    markAsRead?: MarkAsReadResolver<boolean | null, any, Context>;\n+┊   ┊463┊  }\n+┊   ┊464┊\n+┊   ┊465┊  export type AddChatResolver<\n+┊   ┊466┊    R = Chat | null,\n+┊   ┊467┊    Parent = any,\n+┊   ┊468┊    Context = any\n+┊   ┊469┊  > = Resolver<R, Parent, Context, AddChatArgs>;\n+┊   ┊470┊  export interface AddChatArgs {\n+┊   ┊471┊    recipientId: string;\n+┊   ┊472┊  }\n+┊   ┊473┊\n+┊   ┊474┊  export type AddGroupResolver<\n+┊   ┊475┊    R = Chat | null,\n+┊   ┊476┊    Parent = any,\n+┊   ┊477┊    Context = any\n+┊   ┊478┊  > = Resolver<R, Parent, Context, AddGroupArgs>;\n+┊   ┊479┊  export interface AddGroupArgs {\n+┊   ┊480┊    recipientIds: string[];\n+┊   ┊481┊    groupName: string;\n+┊   ┊482┊  }\n+┊   ┊483┊\n+┊   ┊484┊  export type RemoveChatResolver<\n+┊   ┊485┊    R = string | null,\n+┊   ┊486┊    Parent = any,\n+┊   ┊487┊    Context = any\n+┊   ┊488┊  > = Resolver<R, Parent, Context, RemoveChatArgs>;\n+┊   ┊489┊  export interface RemoveChatArgs {\n+┊   ┊490┊    chatId: string;\n+┊   ┊491┊  }\n+┊   ┊492┊\n+┊   ┊493┊  export type AddMessageResolver<\n+┊   ┊494┊    R = Message | null,\n+┊   ┊495┊    Parent = any,\n+┊   ┊496┊    Context = any\n+┊   ┊497┊  > = Resolver<R, Parent, Context, AddMessageArgs>;\n+┊   ┊498┊  export interface AddMessageArgs {\n+┊   ┊499┊    chatId: string;\n+┊   ┊500┊    content: string;\n+┊   ┊501┊  }\n+┊   ┊502┊\n+┊   ┊503┊  export type RemoveMessagesResolver<\n+┊   ┊504┊    R = (string | null)[] | null,\n+┊   ┊505┊    Parent = any,\n+┊   ┊506┊    Context = any\n+┊   ┊507┊  > = Resolver<R, Parent, Context, RemoveMessagesArgs>;\n+┊   ┊508┊  export interface RemoveMessagesArgs {\n+┊   ┊509┊    chatId: string;\n+┊   ┊510┊    messageIds?: (string | null)[] | null;\n+┊   ┊511┊    all?: boolean | null;\n+┊   ┊512┊  }\n+┊   ┊513┊\n+┊   ┊514┊  export type AddMembersResolver<\n+┊   ┊515┊    R = (string | null)[] | null,\n+┊   ┊516┊    Parent = any,\n+┊   ┊517┊    Context = any\n+┊   ┊518┊  > = Resolver<R, Parent, Context, AddMembersArgs>;\n+┊   ┊519┊  export interface AddMembersArgs {\n+┊   ┊520┊    groupId: string;\n+┊   ┊521┊    userIds: string[];\n+┊   ┊522┊  }\n+┊   ┊523┊\n+┊   ┊524┊  export type RemoveMembersResolver<\n+┊   ┊525┊    R = (string | null)[] | null,\n+┊   ┊526┊    Parent = any,\n+┊   ┊527┊    Context = any\n+┊   ┊528┊  > = Resolver<R, Parent, Context, RemoveMembersArgs>;\n+┊   ┊529┊  export interface RemoveMembersArgs {\n+┊   ┊530┊    groupId: string;\n+┊   ┊531┊    userIds: string[];\n+┊   ┊532┊  }\n+┊   ┊533┊\n+┊   ┊534┊  export type AddAdminsResolver<\n+┊   ┊535┊    R = (string | null)[] | null,\n+┊   ┊536┊    Parent = any,\n+┊   ┊537┊    Context = any\n+┊   ┊538┊  > = Resolver<R, Parent, Context, AddAdminsArgs>;\n+┊   ┊539┊  export interface AddAdminsArgs {\n+┊   ┊540┊    groupId: string;\n+┊   ┊541┊    userIds: string[];\n+┊   ┊542┊  }\n+┊   ┊543┊\n+┊   ┊544┊  export type RemoveAdminsResolver<\n+┊   ┊545┊    R = (string | null)[] | null,\n+┊   ┊546┊    Parent = any,\n+┊   ┊547┊    Context = any\n+┊   ┊548┊  > = Resolver<R, Parent, Context, RemoveAdminsArgs>;\n+┊   ┊549┊  export interface RemoveAdminsArgs {\n+┊   ┊550┊    groupId: string;\n+┊   ┊551┊    userIds: string[];\n+┊   ┊552┊  }\n+┊   ┊553┊\n+┊   ┊554┊  export type SetGroupNameResolver<\n+┊   ┊555┊    R = string | null,\n+┊   ┊556┊    Parent = any,\n+┊   ┊557┊    Context = any\n+┊   ┊558┊  > = Resolver<R, Parent, Context, SetGroupNameArgs>;\n+┊   ┊559┊  export interface SetGroupNameArgs {\n+┊   ┊560┊    groupId: string;\n+┊   ┊561┊  }\n+┊   ┊562┊\n+┊   ┊563┊  export type SetGroupPictureResolver<\n ┊353┊564┊    R = string | null,\n ┊354┊565┊    Parent = any,\n ┊355┊566┊    Context = any\n+┊   ┊567┊  > = Resolver<R, Parent, Context, SetGroupPictureArgs>;\n+┊   ┊568┊  export interface SetGroupPictureArgs {\n+┊   ┊569┊    groupId: string;\n+┊   ┊570┊  }\n+┊   ┊571┊\n+┊   ┊572┊  export type MarkAsReceivedResolver<\n+┊   ┊573┊    R = boolean | null,\n+┊   ┊574┊    Parent = any,\n+┊   ┊575┊    Context = any\n+┊   ┊576┊  > = Resolver<R, Parent, Context, MarkAsReceivedArgs>;\n+┊   ┊577┊  export interface MarkAsReceivedArgs {\n+┊   ┊578┊    chatId: string;\n+┊   ┊579┊  }\n+┊   ┊580┊\n+┊   ┊581┊  export type MarkAsReadResolver<\n+┊   ┊582┊    R = boolean | null,\n+┊   ┊583┊    Parent = any,\n+┊   ┊584┊    Context = any\n+┊   ┊585┊  > = Resolver<R, Parent, Context, MarkAsReadArgs>;\n+┊   ┊586┊  export interface MarkAsReadArgs {\n+┊   ┊587┊    chatId: string;\n+┊   ┊588┊  }\n+┊   ┊589┊}\n+┊   ┊590┊\n+┊   ┊591┊export namespace SubscriptionResolvers {\n+┊   ┊592┊  export interface Resolvers<Context = any> {\n+┊   ┊593┊    messageAdded?: MessageAddedResolver<Message | null, any, Context>;\n+┊   ┊594┊    chatAdded?: ChatAddedResolver<Chat | null, any, Context>;\n+┊   ┊595┊  }\n+┊   ┊596┊\n+┊   ┊597┊  export type MessageAddedResolver<\n+┊   ┊598┊    R = Message | null,\n+┊   ┊599┊    Parent = any,\n+┊   ┊600┊    Context = any\n+┊   ┊601┊  > = Resolver<R, Parent, Context, MessageAddedArgs>;\n+┊   ┊602┊  export interface MessageAddedArgs {\n+┊   ┊603┊    chatId?: string | null;\n+┊   ┊604┊  }\n+┊   ┊605┊\n+┊   ┊606┊  export type ChatAddedResolver<\n+┊   ┊607┊    R = Chat | null,\n+┊   ┊608┊    Parent = any,\n+┊   ┊609┊    Context = any\n ┊356┊610┊  > = Resolver<R, Parent, Context>;\n ┊357┊611┊}\n ┊358┊612┊\n```\n```diff\n@@ -398,7 +652,7 @@\n ┊398┊652┊    chat: Chat;\n ┊399┊653┊    sender: Sender;\n ┊400┊654┊    content: string;\n-┊401┊   ┊    createdAt: string;\n+┊   ┊655┊    createdAt: Date;\n ┊402┊656┊    type: number;\n ┊403┊657┊    recipients: Recipients[];\n ┊404┊658┊    ownership: boolean;\n```\n```diff\n@@ -420,8 +674,8 @@\n ┊420┊674┊    user: User;\n ┊421┊675┊    message: Message;\n ┊422┊676┊    chat: __Chat;\n-┊423┊   ┊    receivedAt?: string | null;\n-┊424┊   ┊    readAt?: string | null;\n+┊   ┊677┊    receivedAt?: Date | null;\n+┊   ┊678┊    readAt?: Date | null;\n ┊425┊679┊  };\n ┊426┊680┊\n ┊427┊681┊  export type User = {\n```\n```diff\n@@ -445,3 +699,77 @@\n ┊445┊699┊    id: string;\n ┊446┊700┊  };\n ┊447┊701┊}\n+┊   ┊702┊\n+┊   ┊703┊import { Injectable } from \"@angular/core\";\n+┊   ┊704┊\n+┊   ┊705┊import * as Apollo from \"apollo-angular\";\n+┊   ┊706┊\n+┊   ┊707┊import gql from \"graphql-tag\";\n+┊   ┊708┊\n+┊   ┊709┊const ChatWithoutMessagesFragment = gql`\n+┊   ┊710┊  fragment ChatWithoutMessages on Chat {\n+┊   ┊711┊    id\n+┊   ┊712┊    name\n+┊   ┊713┊    picture\n+┊   ┊714┊    allTimeMembers {\n+┊   ┊715┊      id\n+┊   ┊716┊    }\n+┊   ┊717┊    unreadMessages\n+┊   ┊718┊    isGroup\n+┊   ┊719┊  }\n+┊   ┊720┊`;\n+┊   ┊721┊\n+┊   ┊722┊const MessageFragment = gql`\n+┊   ┊723┊  fragment Message on Message {\n+┊   ┊724┊    id\n+┊   ┊725┊    chat {\n+┊   ┊726┊      id\n+┊   ┊727┊    }\n+┊   ┊728┊    sender {\n+┊   ┊729┊      id\n+┊   ┊730┊      name\n+┊   ┊731┊    }\n+┊   ┊732┊    content\n+┊   ┊733┊    createdAt\n+┊   ┊734┊    type\n+┊   ┊735┊    recipients {\n+┊   ┊736┊      user {\n+┊   ┊737┊        id\n+┊   ┊738┊      }\n+┊   ┊739┊      message {\n+┊   ┊740┊        id\n+┊   ┊741┊        chat {\n+┊   ┊742┊          id\n+┊   ┊743┊        }\n+┊   ┊744┊      }\n+┊   ┊745┊      chat {\n+┊   ┊746┊        id\n+┊   ┊747┊      }\n+┊   ┊748┊      receivedAt\n+┊   ┊749┊      readAt\n+┊   ┊750┊    }\n+┊   ┊751┊    ownership\n+┊   ┊752┊  }\n+┊   ┊753┊`;\n+┊   ┊754┊\n+┊   ┊755┊@Injectable({\n+┊   ┊756┊  providedIn: \"root\"\n+┊   ┊757┊})\n+┊   ┊758┊export class GetChatsGQL extends Apollo.Query<\n+┊   ┊759┊  GetChats.Query,\n+┊   ┊760┊  GetChats.Variables\n+┊   ┊761┊> {\n+┊   ┊762┊  document: any = gql`\n+┊   ┊763┊    query GetChats($amount: Int) {\n+┊   ┊764┊      chats {\n+┊   ┊765┊        ...ChatWithoutMessages\n+┊   ┊766┊        messages(amount: $amount) {\n+┊   ┊767┊          ...Message\n+┊   ┊768┊        }\n+┊   ┊769┊      }\n+┊   ┊770┊    }\n+┊   ┊771┊\n+┊   ┊772┊    ${ChatWithoutMessagesFragment}\n+┊   ┊773┊    ${MessageFragment}\n+┊   ┊774┊  `;\n+┊   ┊775┊}\n```\n\n[}]: #\n\nThe Apollo Angular template generates a ready to use in your component, strongly typed Angular services, for every defined query, mutation or subscription.\n\nIt's possible thanks to the new API of Apollo Angular. More on that in [\"Query, Mutation, Subscription services\"](http://apollographql.com/docs/angular/basics/services.html?_ga=2.227615197.1327014552.1538988114-793224955.1532981447) chapter of the documentation.\n\nGiven an example:\n\n```graphql\nquery GetChats($amount: Int) {\n  chats {\n    ...ChatWithoutMessages\n    messages(amount: $amount) {\n      ...Message\n    }\n  }\n}\n```\n\nThe Apollo Angular template, after you run `yarn generate`, outputs a service called `GetChatsGQL`:\n\n```typescript\nimport { GetChatsGQL, GetChats } from '../graphql';\n\nexport class AppComponent {\n  constructor(private getChatsGQL: GetChatsGQL) {}\n\n  getChats(): GetChats.Chats[] {\n    return this.getChatsGQL\n      .watch({\n        amount: 10,\n      })\n      .valueChanges.pipe(map(result => result.data.chats));\n  }\n}\n```\n\n> Remember, every operation should has an unique name.\n\nIt might look a bit different then what you have already learnt but we promise, the API is even easier.\n\nBut first, let's dive into how those services look like under the hood.\n\n```typescript\nimport { Query } from 'apollo-angular';\n\n@Injectable({\n  providedIn: 'root',\n})\nexport class GetChatsGQL extends Query<GetChats.Query, GetChats.Variables> {\n  document = gql`\n    here goes the document\n  `;\n}\n```\n\nOkay, seems easy but what is the `Query` class, you might ask!\n\nApollo Angular exposes three classes for three kinds of the GraphQL operation: `Query`, `Mutation` and `Subscription`. Each of them has a different API.\n\n- `Query` has `fetch` and `watch`. First one behave like `Apollo.query()`, second one like `Apollo.watchQuery()`\n- `Mutation` has `mutate`\n- `Subscription` has `subscribe`\n\nBecause the `document` is already defined in a class, they all accept two arguments (Subscription has third one). First argument defines variables, second shapes the options. Thats why we used `this.getChatsGQL.watch({ amount: 10 })`.\n\nLet's stop talking about the API itself and see what benefits it brings us:\n\n- **Less code to write** - no need to create a network call, no need to create Typescript typings, no need to create a dedicated Angular service\n- **Strongly typed out of the box — all** types are being generated, no need to write any Typescript definitions and struggle to keep them updated\n- _More pleasent API_ to work with\n- **Full developer experience of tools and IDEs**  —  development time, autocomplete and error checking, not only across your frontend app but also with your API teams!\n- **Tree-shakable** thanks to Angular 6\n\nMost IDEs with the GraphQL support (built-in or thanks to extensions) fully handles `.graphql` files and helps you with features like auto-completion, validation but they strugle with `gql` tag. To fully enjoy GraphQL we highly recommend to use static `.graphql` files.\n\nWith all that knowledge, let's use GQL services in our application:\n\n[{]: <helper> (diffStep \"2.4\" files=\"src/app/services/chats.service.ts\" module=\"client\")\n\n#### [Step 2.4: Use auto-generated GQL services](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/c0eddd1)\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,21 +1,18 @@\n ┊ 1┊ 1┊import {map} from 'rxjs/operators';\n-┊ 2┊  ┊import {Apollo} from 'apollo-angular';\n ┊ 3┊ 2┊import {Injectable} from '@angular/core';\n-┊ 4┊  ┊import {getChatsQuery} from '../../graphql/getChats.query';\n-┊ 5┊  ┊import {GetChats} from '../../graphql';\n+┊  ┊ 3┊import {GetChatsGQL} from '../../graphql';\n ┊ 6┊ 4┊\n ┊ 7┊ 5┊@Injectable()\n ┊ 8┊ 6┊export class ChatsService {\n ┊ 9┊ 7┊  messagesAmount = 3;\n ┊10┊ 8┊\n-┊11┊  ┊  constructor(private apollo: Apollo) {}\n+┊  ┊ 9┊  constructor(\n+┊  ┊10┊    private getChatsGQL: GetChatsGQL\n+┊  ┊11┊  ) {}\n ┊12┊12┊\n ┊13┊13┊  getChats() {\n-┊14┊  ┊    const query = this.apollo.watchQuery<GetChats.Query>({\n-┊15┊  ┊      query: getChatsQuery,\n-┊16┊  ┊      variables: {\n-┊17┊  ┊        amount: this.messagesAmount,\n-┊18┊  ┊      },\n+┊  ┊14┊    const query = this.getChatsGQL.watch({\n+┊  ┊15┊      amount: this.messagesAmount,\n ┊19┊16┊    });\n ┊20┊17┊    const chats$ = query.valueChanges.pipe(\n ┊21┊18┊      map((result) => result.data.chats)\n```\n\n[}]: #"
          },
          {
            "manualTitle": "Step 7: Testing",
            "stepRevision": "1faa6c13bf9f48f94f7b027bea9c8277612be7ec",
            "manualView": "## Client\n\nTesting is a very important part of each application and for the sake of showing different testing techniques we are going to show how to test a presentational component, a container component and a service.\n\nFirst let's start by importing `hammerjs` for the Material Gestures inside the test script.\n\n[{]: <helper> (diffStep \"3.1\" files=\"src/test.ts\" module=\"client\")\n\n#### [Step 3.1: Testing](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/b76d15b)\n\n##### Changed src&#x2F;test.ts\n```diff\n@@ -7,6 +7,9 @@\n ┊ 7┊ 7┊  platformBrowserDynamicTesting\n ┊ 8┊ 8┊} from '@angular/platform-browser-dynamic/testing';\n ┊ 9┊ 9┊\n+┊  ┊10┊// Material gestures\n+┊  ┊11┊import 'hammerjs';\n+┊  ┊12┊\n ┊10┊13┊declare const require: any;\n ┊11┊14┊\n ┊12┊15┊// First, initialize the Angular testing environment.\n```\n\n[}]: #\n\n### Testing a Presentional Component\n\nLet's start with the simplest one: the presentational component.\nWe are not going to inject any service and we don't need to access our backend, so things are quite simple: we just need to pass our Chat object as an Input, detect the changes and use the query selector to match the UI content to the one we passed as input:\n\n[{]: <helper> (diffStep \"3.1\" files=\"src/app/chats-lister/components/chat-item/chat-item.component.spec.ts\" module=\"client\")\n\n#### [Step 3.1: Testing](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/b76d15b)\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chat-item&#x2F;chat-item.component.spec.ts\n```diff\n@@ -0,0 +1,107 @@\n+┊   ┊  1┊import { async, ComponentFixture, TestBed } from '@angular/core/testing';\n+┊   ┊  2┊\n+┊   ┊  3┊import { ChatItemComponent } from './chat-item.component';\n+┊   ┊  4┊import {DebugElement} from '@angular/core';\n+┊   ┊  5┊import {By} from '@angular/platform-browser';\n+┊   ┊  6┊import {TruncateModule} from 'ng2-truncate';\n+┊   ┊  7┊\n+┊   ┊  8┊describe('ChatItemComponent', () => {\n+┊   ┊  9┊  let component: ChatItemComponent;\n+┊   ┊ 10┊  let fixture: ComponentFixture<ChatItemComponent>;\n+┊   ┊ 11┊  let el: DebugElement;\n+┊   ┊ 12┊\n+┊   ┊ 13┊  const chat: any = {\n+┊   ┊ 14┊    id: '1',\n+┊   ┊ 15┊    __typename: 'Chat',\n+┊   ┊ 16┊    name: 'Niccolo\\' Belli',\n+┊   ┊ 17┊    picture: null,\n+┊   ┊ 18┊    allTimeMembers: [\n+┊   ┊ 19┊      {\n+┊   ┊ 20┊        id: '1',\n+┊   ┊ 21┊        __typename: 'User',\n+┊   ┊ 22┊      },\n+┊   ┊ 23┊      {\n+┊   ┊ 24┊        id: '2',\n+┊   ┊ 25┊        __typename: 'User',\n+┊   ┊ 26┊      }\n+┊   ┊ 27┊    ],\n+┊   ┊ 28┊    unreadMessages: 0,\n+┊   ┊ 29┊    isGroup: false,\n+┊   ┊ 30┊    messages: [\n+┊   ┊ 31┊      {\n+┊   ┊ 32┊        id: '1',\n+┊   ┊ 33┊        chat: {\n+┊   ┊ 34┊          id: '1',\n+┊   ┊ 35┊          __typename: 'Chat',\n+┊   ┊ 36┊        },\n+┊   ┊ 37┊        __typename: 'Message',\n+┊   ┊ 38┊        sender: {\n+┊   ┊ 39┊          id: '1',\n+┊   ┊ 40┊          __typename: 'User',\n+┊   ┊ 41┊          name: 'Niccolo\\' Belli',\n+┊   ┊ 42┊        },\n+┊   ┊ 43┊        content: 'Hello! How are you? A lot happened since last time',\n+┊   ┊ 44┊        createdAt: '1513435525',\n+┊   ┊ 45┊        type: 1,\n+┊   ┊ 46┊        recipients: [\n+┊   ┊ 47┊          {\n+┊   ┊ 48┊            user: {\n+┊   ┊ 49┊              id: '2',\n+┊   ┊ 50┊              __typename: 'User',\n+┊   ┊ 51┊            },\n+┊   ┊ 52┊            message: {\n+┊   ┊ 53┊              id: '1',\n+┊   ┊ 54┊              __typename: 'Message',\n+┊   ┊ 55┊              chat: {\n+┊   ┊ 56┊                id: '1',\n+┊   ┊ 57┊                __typename: 'Chat',\n+┊   ┊ 58┊              },\n+┊   ┊ 59┊            },\n+┊   ┊ 60┊            __typename: 'Recipient',\n+┊   ┊ 61┊            chat: {\n+┊   ┊ 62┊              id: '1',\n+┊   ┊ 63┊              __typename: 'Chat',\n+┊   ┊ 64┊            },\n+┊   ┊ 65┊            receivedAt: null,\n+┊   ┊ 66┊            readAt: null,\n+┊   ┊ 67┊          }\n+┊   ┊ 68┊        ],\n+┊   ┊ 69┊        ownership: true,\n+┊   ┊ 70┊      }\n+┊   ┊ 71┊    ],\n+┊   ┊ 72┊  };\n+┊   ┊ 73┊\n+┊   ┊ 74┊  beforeEach(async(() => {\n+┊   ┊ 75┊    TestBed.configureTestingModule({\n+┊   ┊ 76┊      declarations: [ ChatItemComponent ],\n+┊   ┊ 77┊      imports: [TruncateModule]\n+┊   ┊ 78┊    })\n+┊   ┊ 79┊    .compileComponents();\n+┊   ┊ 80┊  }));\n+┊   ┊ 81┊\n+┊   ┊ 82┊  beforeEach(() => {\n+┊   ┊ 83┊    fixture = TestBed.createComponent(ChatItemComponent);\n+┊   ┊ 84┊    component = fixture.componentInstance;\n+┊   ┊ 85┊    component.chat = chat;\n+┊   ┊ 86┊    fixture.detectChanges();\n+┊   ┊ 87┊    el = fixture.debugElement;\n+┊   ┊ 88┊  });\n+┊   ┊ 89┊\n+┊   ┊ 90┊  it('should create', () => {\n+┊   ┊ 91┊    expect(component).toBeTruthy();\n+┊   ┊ 92┊  });\n+┊   ┊ 93┊\n+┊   ┊ 94┊  it('should contain the chat name', () => {\n+┊   ┊ 95┊    expect(el.query(By.css('.chat-recipient > div:first-child')).nativeElement.textContent).toContain(chat.name);\n+┊   ┊ 96┊  });\n+┊   ┊ 97┊\n+┊   ┊ 98┊  it('should contain the first couple of characters of the message content', () => {\n+┊   ┊ 99┊    expect(el.query(By.css('.chat-content')).nativeElement.textContent)\n+┊   ┊100┊      .toContain(chat.messages[chat.messages.length - 1].content.slice(0, 20));\n+┊   ┊101┊  });\n+┊   ┊102┊\n+┊   ┊103┊  it('should not contain the latest characters of the message content', () => {\n+┊   ┊104┊    expect(el.query(By.css('.chat-content')).nativeElement.textContent)\n+┊   ┊105┊      .not.toContain(chat.messages[chat.messages.length - 1].content.slice(20));\n+┊   ┊106┊  });\n+┊   ┊107┊});\n```\n\n[}]: #\n\n### Testing a Service\n\nTesting a service is a bit more complicated because we will need to mock our backend in order to get fake results instead of having to fire up the backend each time.\n\nWe could simply simply mock the HTTP calls, which is a well known practice in the REST API world. Since we are using HTTP to retrieve the data, it would work as well with our Apollo Client setup.\n\n#### Testing with Apollo Angular\n\nBecause Apollo Angular provides its own testing utilities, let's bring them in!\n\nAlthough `apollo-angular` has a lot going on under the hood, the library provides multiple tools for testing that simplify those abstractions, and allows complete focus on the component logic.\n\nThe `apollo-angular/testing` module exports a `ApolloTestingModule` module and `ApolloTestingController` service which simplifies the testing of Angular components by mocking calls to the GraphQL endpoint. This allows the tests to be run in isolation and provides consistent results on every run by removing the dependence on remote data.\n\nBy using this `ApolloTestingController` service, it’s possible to specify the exact results that should be returned for a certain query.\n\nWorth mentioning, `ApolloTestingModule` comes with a default cache but you can use your own with `APOLLO_TESTING_CACHE` token.\n\nLet's show everything on an example:\n\n[{]: <helper> (diffStep \"3.1\" files=\"src/app/services/chats.service.spec.ts\" module=\"client\")\n\n#### [Step 3.1: Testing](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/b76d15b)\n\n##### Added src&#x2F;app&#x2F;services&#x2F;chats.service.spec.ts\n```diff\n@@ -0,0 +1,352 @@\n+┊   ┊  1┊import { TestBed, inject } from '@angular/core/testing';\n+┊   ┊  2┊\n+┊   ┊  3┊import { Apollo } from 'apollo-angular';\n+┊   ┊  4┊import {\n+┊   ┊  5┊  ApolloTestingModule,\n+┊   ┊  6┊  ApolloTestingController,\n+┊   ┊  7┊  APOLLO_TESTING_CACHE,\n+┊   ┊  8┊} from 'apollo-angular/testing';\n+┊   ┊  9┊import { InMemoryCache } from 'apollo-cache-inmemory';\n+┊   ┊ 10┊\n+┊   ┊ 11┊import { GetChats } from '../../graphql';\n+┊   ┊ 12┊import { dataIdFromObject } from '../graphql.module';\n+┊   ┊ 13┊import { ChatsService } from './chats.service';\n+┊   ┊ 14┊\n+┊   ┊ 15┊describe('ChatsService', () => {\n+┊   ┊ 16┊  let controller: ApolloTestingController;\n+┊   ┊ 17┊  let apollo: Apollo;\n+┊   ┊ 18┊\n+┊   ┊ 19┊  const chats: GetChats.Chats[] = [\n+┊   ┊ 20┊    {\n+┊   ┊ 21┊      id: '1',\n+┊   ┊ 22┊      __typename: 'Chat',\n+┊   ┊ 23┊      name: 'Avery Stewart',\n+┊   ┊ 24┊      picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n+┊   ┊ 25┊      allTimeMembers: [\n+┊   ┊ 26┊        {\n+┊   ┊ 27┊          id: '1',\n+┊   ┊ 28┊          __typename: 'User',\n+┊   ┊ 29┊        },\n+┊   ┊ 30┊        {\n+┊   ┊ 31┊          id: '3',\n+┊   ┊ 32┊          __typename: 'User',\n+┊   ┊ 33┊        },\n+┊   ┊ 34┊      ],\n+┊   ┊ 35┊      unreadMessages: 1,\n+┊   ┊ 36┊      isGroup: false,\n+┊   ┊ 37┊      messages: [\n+┊   ┊ 38┊        {\n+┊   ┊ 39┊          id: '1',\n+┊   ┊ 40┊          chat: {\n+┊   ┊ 41┊            id: '1',\n+┊   ┊ 42┊            __typename: 'Chat',\n+┊   ┊ 43┊          },\n+┊   ┊ 44┊          __typename: 'Message',\n+┊   ┊ 45┊          sender: {\n+┊   ┊ 46┊            id: '3',\n+┊   ┊ 47┊            __typename: 'User',\n+┊   ┊ 48┊            name: 'Avery Stewart',\n+┊   ┊ 49┊          },\n+┊   ┊ 50┊          content: 'Yep!',\n+┊   ┊ 51┊          createdAt: '1514035700',\n+┊   ┊ 52┊          type: 0,\n+┊   ┊ 53┊          recipients: [\n+┊   ┊ 54┊            {\n+┊   ┊ 55┊              user: {\n+┊   ┊ 56┊                id: '1',\n+┊   ┊ 57┊                __typename: 'User',\n+┊   ┊ 58┊              },\n+┊   ┊ 59┊              message: {\n+┊   ┊ 60┊                id: '1',\n+┊   ┊ 61┊                __typename: 'Message',\n+┊   ┊ 62┊                chat: {\n+┊   ┊ 63┊                  id: '1',\n+┊   ┊ 64┊                  __typename: 'Chat',\n+┊   ┊ 65┊                },\n+┊   ┊ 66┊              },\n+┊   ┊ 67┊              __typename: 'Recipient',\n+┊   ┊ 68┊              chat: {\n+┊   ┊ 69┊                id: '1',\n+┊   ┊ 70┊                __typename: 'Chat',\n+┊   ┊ 71┊              },\n+┊   ┊ 72┊              receivedAt: null,\n+┊   ┊ 73┊              readAt: null,\n+┊   ┊ 74┊            },\n+┊   ┊ 75┊          ],\n+┊   ┊ 76┊          ownership: false,\n+┊   ┊ 77┊        },\n+┊   ┊ 78┊      ],\n+┊   ┊ 79┊    },\n+┊   ┊ 80┊    {\n+┊   ┊ 81┊      id: '2',\n+┊   ┊ 82┊      __typename: 'Chat',\n+┊   ┊ 83┊      name: 'Katie Peterson',\n+┊   ┊ 84┊      picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n+┊   ┊ 85┊      allTimeMembers: [\n+┊   ┊ 86┊        {\n+┊   ┊ 87┊          id: '1',\n+┊   ┊ 88┊          __typename: 'User',\n+┊   ┊ 89┊        },\n+┊   ┊ 90┊        {\n+┊   ┊ 91┊          id: '4',\n+┊   ┊ 92┊          __typename: 'User',\n+┊   ┊ 93┊        },\n+┊   ┊ 94┊      ],\n+┊   ┊ 95┊      unreadMessages: 0,\n+┊   ┊ 96┊      isGroup: false,\n+┊   ┊ 97┊      messages: [\n+┊   ┊ 98┊        {\n+┊   ┊ 99┊          id: '1',\n+┊   ┊100┊          chat: {\n+┊   ┊101┊            id: '2',\n+┊   ┊102┊            __typename: 'Chat',\n+┊   ┊103┊          },\n+┊   ┊104┊          __typename: 'Message',\n+┊   ┊105┊          sender: {\n+┊   ┊106┊            id: '1',\n+┊   ┊107┊            __typename: 'User',\n+┊   ┊108┊            name: 'Ethan Gonzalez',\n+┊   ┊109┊          },\n+┊   ┊110┊          content: `Hey, it's me`,\n+┊   ┊111┊          createdAt: '1514031800',\n+┊   ┊112┊          type: 0,\n+┊   ┊113┊          recipients: [\n+┊   ┊114┊            {\n+┊   ┊115┊              user: {\n+┊   ┊116┊                id: '4',\n+┊   ┊117┊                __typename: 'User',\n+┊   ┊118┊              },\n+┊   ┊119┊              message: {\n+┊   ┊120┊                id: '1',\n+┊   ┊121┊                __typename: 'Message',\n+┊   ┊122┊                chat: {\n+┊   ┊123┊                  id: '2',\n+┊   ┊124┊                  __typename: 'Chat',\n+┊   ┊125┊                },\n+┊   ┊126┊              },\n+┊   ┊127┊              __typename: 'Recipient',\n+┊   ┊128┊              chat: {\n+┊   ┊129┊                id: '2',\n+┊   ┊130┊                __typename: 'Chat',\n+┊   ┊131┊              },\n+┊   ┊132┊              receivedAt: null,\n+┊   ┊133┊              readAt: null,\n+┊   ┊134┊            },\n+┊   ┊135┊          ],\n+┊   ┊136┊          ownership: true,\n+┊   ┊137┊        },\n+┊   ┊138┊      ],\n+┊   ┊139┊    },\n+┊   ┊140┊    {\n+┊   ┊141┊      id: '3',\n+┊   ┊142┊      __typename: 'Chat',\n+┊   ┊143┊      name: 'Ray Edwards',\n+┊   ┊144┊      picture: 'https://randomuser.me/api/portraits/thumb/men/3.jpg',\n+┊   ┊145┊      allTimeMembers: [\n+┊   ┊146┊        {\n+┊   ┊147┊          id: '1',\n+┊   ┊148┊          __typename: 'User',\n+┊   ┊149┊        },\n+┊   ┊150┊        {\n+┊   ┊151┊          id: '5',\n+┊   ┊152┊          __typename: 'User',\n+┊   ┊153┊        },\n+┊   ┊154┊      ],\n+┊   ┊155┊      unreadMessages: 0,\n+┊   ┊156┊      isGroup: false,\n+┊   ┊157┊      messages: [\n+┊   ┊158┊        {\n+┊   ┊159┊          id: '1',\n+┊   ┊160┊          __typename: 'Message',\n+┊   ┊161┊          chat: {\n+┊   ┊162┊            id: '3',\n+┊   ┊163┊            __typename: 'Chat',\n+┊   ┊164┊          },\n+┊   ┊165┊          sender: {\n+┊   ┊166┊            id: '1',\n+┊   ┊167┊            __typename: 'User',\n+┊   ┊168┊            name: 'Ethan Gonzalez',\n+┊   ┊169┊          },\n+┊   ┊170┊          content: 'You still there?',\n+┊   ┊171┊          createdAt: '1514010200',\n+┊   ┊172┊          type: 0,\n+┊   ┊173┊          recipients: [\n+┊   ┊174┊            {\n+┊   ┊175┊              user: {\n+┊   ┊176┊                id: '5',\n+┊   ┊177┊                __typename: 'User',\n+┊   ┊178┊              },\n+┊   ┊179┊              message: {\n+┊   ┊180┊                id: '1',\n+┊   ┊181┊                __typename: 'Message',\n+┊   ┊182┊                chat: {\n+┊   ┊183┊                  id: '3',\n+┊   ┊184┊                  __typename: 'Chat',\n+┊   ┊185┊                },\n+┊   ┊186┊              },\n+┊   ┊187┊              __typename: 'Recipient',\n+┊   ┊188┊              chat: {\n+┊   ┊189┊                id: '3',\n+┊   ┊190┊                __typename: 'Chat',\n+┊   ┊191┊              },\n+┊   ┊192┊              receivedAt: null,\n+┊   ┊193┊              readAt: null,\n+┊   ┊194┊            },\n+┊   ┊195┊          ],\n+┊   ┊196┊          ownership: true,\n+┊   ┊197┊        },\n+┊   ┊198┊      ],\n+┊   ┊199┊    },\n+┊   ┊200┊    {\n+┊   ┊201┊      id: '6',\n+┊   ┊202┊      __typename: 'Chat',\n+┊   ┊203┊      name: 'Niccolò Belli',\n+┊   ┊204┊      picture: 'https://randomuser.me/api/portraits/thumb/men/4.jpg',\n+┊   ┊205┊      allTimeMembers: [\n+┊   ┊206┊        {\n+┊   ┊207┊          id: '1',\n+┊   ┊208┊          __typename: 'User',\n+┊   ┊209┊        },\n+┊   ┊210┊        {\n+┊   ┊211┊          id: '6',\n+┊   ┊212┊          __typename: 'User',\n+┊   ┊213┊        },\n+┊   ┊214┊      ],\n+┊   ┊215┊      unreadMessages: 0,\n+┊   ┊216┊      messages: [],\n+┊   ┊217┊      isGroup: false,\n+┊   ┊218┊    },\n+┊   ┊219┊    {\n+┊   ┊220┊      id: '8',\n+┊   ┊221┊      __typename: 'Chat',\n+┊   ┊222┊      name: 'A user 0 group',\n+┊   ┊223┊      picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n+┊   ┊224┊      allTimeMembers: [\n+┊   ┊225┊        {\n+┊   ┊226┊          id: '1',\n+┊   ┊227┊          __typename: 'User',\n+┊   ┊228┊        },\n+┊   ┊229┊        {\n+┊   ┊230┊          id: '3',\n+┊   ┊231┊          __typename: 'User',\n+┊   ┊232┊        },\n+┊   ┊233┊        {\n+┊   ┊234┊          id: '4',\n+┊   ┊235┊          __typename: 'User',\n+┊   ┊236┊        },\n+┊   ┊237┊        {\n+┊   ┊238┊          id: '6',\n+┊   ┊239┊          __typename: 'User',\n+┊   ┊240┊        },\n+┊   ┊241┊      ],\n+┊   ┊242┊      unreadMessages: 1,\n+┊   ┊243┊      isGroup: true,\n+┊   ┊244┊      messages: [\n+┊   ┊245┊        {\n+┊   ┊246┊          id: '1',\n+┊   ┊247┊          __typename: 'Message',\n+┊   ┊248┊          chat: {\n+┊   ┊249┊            id: '8',\n+┊   ┊250┊            __typename: 'Chat',\n+┊   ┊251┊          },\n+┊   ┊252┊          sender: {\n+┊   ┊253┊            id: '4',\n+┊   ┊254┊            __typename: 'User',\n+┊   ┊255┊            name: 'Katie Peterson',\n+┊   ┊256┊          },\n+┊   ┊257┊          content: 'Awesome!',\n+┊   ┊258┊          createdAt: '1512830000',\n+┊   ┊259┊          type: 0,\n+┊   ┊260┊          recipients: [\n+┊   ┊261┊            {\n+┊   ┊262┊              user: {\n+┊   ┊263┊                id: '1',\n+┊   ┊264┊                __typename: 'User',\n+┊   ┊265┊              },\n+┊   ┊266┊              message: {\n+┊   ┊267┊                id: '1',\n+┊   ┊268┊                __typename: 'Message',\n+┊   ┊269┊                chat: {\n+┊   ┊270┊                  id: '8',\n+┊   ┊271┊                  __typename: 'Chat',\n+┊   ┊272┊                },\n+┊   ┊273┊              },\n+┊   ┊274┊              __typename: 'Recipient',\n+┊   ┊275┊              chat: {\n+┊   ┊276┊                id: '8',\n+┊   ┊277┊                __typename: 'Chat',\n+┊   ┊278┊              },\n+┊   ┊279┊              receivedAt: null,\n+┊   ┊280┊              readAt: null,\n+┊   ┊281┊            },\n+┊   ┊282┊            {\n+┊   ┊283┊              user: {\n+┊   ┊284┊                id: '6',\n+┊   ┊285┊                __typename: 'User',\n+┊   ┊286┊              },\n+┊   ┊287┊              message: {\n+┊   ┊288┊                id: '1',\n+┊   ┊289┊                __typename: 'Message',\n+┊   ┊290┊                chat: {\n+┊   ┊291┊                  id: '8',\n+┊   ┊292┊                  __typename: 'Chat',\n+┊   ┊293┊                },\n+┊   ┊294┊              },\n+┊   ┊295┊              __typename: 'Recipient',\n+┊   ┊296┊              chat: {\n+┊   ┊297┊                id: '8',\n+┊   ┊298┊                __typename: 'Chat',\n+┊   ┊299┊              },\n+┊   ┊300┊              receivedAt: null,\n+┊   ┊301┊              readAt: null,\n+┊   ┊302┊            },\n+┊   ┊303┊          ],\n+┊   ┊304┊          ownership: false,\n+┊   ┊305┊        },\n+┊   ┊306┊      ],\n+┊   ┊307┊    },\n+┊   ┊308┊  ];\n+┊   ┊309┊\n+┊   ┊310┊  beforeEach(() => {\n+┊   ┊311┊    TestBed.configureTestingModule({\n+┊   ┊312┊      imports: [ApolloTestingModule],\n+┊   ┊313┊      providers: [\n+┊   ┊314┊        ChatsService,\n+┊   ┊315┊        {\n+┊   ┊316┊          provide: APOLLO_TESTING_CACHE,\n+┊   ┊317┊          useFactory() {\n+┊   ┊318┊            return new InMemoryCache({\n+┊   ┊319┊              dataIdFromObject,\n+┊   ┊320┊            });\n+┊   ┊321┊          },\n+┊   ┊322┊        },\n+┊   ┊323┊      ],\n+┊   ┊324┊    });\n+┊   ┊325┊\n+┊   ┊326┊    controller = TestBed.get(ApolloTestingController);\n+┊   ┊327┊    apollo = TestBed.get(Apollo);\n+┊   ┊328┊  });\n+┊   ┊329┊\n+┊   ┊330┊  it('should be created', inject([ChatsService], (service: ChatsService) => {\n+┊   ┊331┊    expect(service).toBeTruthy();\n+┊   ┊332┊  }));\n+┊   ┊333┊\n+┊   ┊334┊  it('should get chats', inject([ChatsService], (service: ChatsService) => {\n+┊   ┊335┊    service.getChats().chats$.subscribe(_chats => {\n+┊   ┊336┊      expect(_chats.length).toEqual(chats.length);\n+┊   ┊337┊      for (let i = 0; i < _chats.length; i++) {\n+┊   ┊338┊        expect(_chats[i]).toEqual(chats[i]);\n+┊   ┊339┊      }\n+┊   ┊340┊    });\n+┊   ┊341┊\n+┊   ┊342┊    const req = controller.expectOne('GetChats', 'GetChats operation');\n+┊   ┊343┊\n+┊   ┊344┊    req.flush({\n+┊   ┊345┊      data: {\n+┊   ┊346┊        chats,\n+┊   ┊347┊      },\n+┊   ┊348┊    });\n+┊   ┊349┊\n+┊   ┊350┊    controller.verify();\n+┊   ┊351┊  }));\n+┊   ┊352┊});\n```\n\n[}]: #\n\nAs you can see, the API of `ApolloTestingController` is pretty similar to the `HttpTestingController`.\n\nThere are four methods you should know.\n\n**`expectOne()`**\nImportant thing, it accepts two arguments. First is different for different use cases, the second one stays always the same, it’s a string with a description of your assertion. In case of failing assertion, the error is thrown with an error message including the given description.\n\nLet's explore all those possible cases `expectOne` accepts:\n\n- you can match an operation by its name, simply by passing a string as a first argument.\n- by passing the whole Operation object the expectOne method compares: operation’s name, variables, document and extensions.\n- the first argument can also be a function that provides an Operation object and expect a boolean in return\n- or passing a GraphQL Document\n\n**`exceptNone()`**\nIt accepts the same arguments as expectOne but it's a negation of it.\n\n**`match()`**\nSearch for operations that match the given parameters, without any expectations.\n\n**`verify()`**\nVerify that no unmatched operations are outstanding. If any operations are outstanding, fail with an error message indicating which operations were not handled.\n\nIf you want to learn more about testing, we got you covered, please visit [\"Testing Apollo in Angular\" chapter](https://www.apollographql.com/docs/angular/guides/testing.html) in Apollo documentation.\n\n### Testing a Container Component\n\nIn the last example we are going to test a container component, which makes use of several services and multiple other components:\n\n[{]: <helper> (diffStep \"3.1\" files=\"src/app/chats-lister/containers/chats/chats.component.spec.ts\" module=\"client\")\n\n#### [Step 3.1: Testing](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/b76d15b)\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.spec.ts\n```diff\n@@ -0,0 +1,392 @@\n+┊   ┊  1┊import { async, ComponentFixture, TestBed } from '@angular/core/testing';\n+┊   ┊  2┊import { DebugElement, NO_ERRORS_SCHEMA } from '@angular/core';\n+┊   ┊  3┊import { TruncateModule } from 'ng2-truncate';\n+┊   ┊  4┊import {\n+┊   ┊  5┊  MatButtonModule,\n+┊   ┊  6┊  MatIconModule,\n+┊   ┊  7┊  MatListModule,\n+┊   ┊  8┊  MatMenuModule,\n+┊   ┊  9┊} from '@angular/material';\n+┊   ┊ 10┊import { Apollo } from 'apollo-angular';\n+┊   ┊ 11┊import {\n+┊   ┊ 12┊  ApolloTestingModule,\n+┊   ┊ 13┊  ApolloTestingController,\n+┊   ┊ 14┊  APOLLO_TESTING_CACHE,\n+┊   ┊ 15┊} from 'apollo-angular/testing';\n+┊   ┊ 16┊import { InMemoryCache } from 'apollo-cache-inmemory';\n+┊   ┊ 17┊import { By } from '@angular/platform-browser';\n+┊   ┊ 18┊import { RouterTestingModule } from '@angular/router/testing';\n+┊   ┊ 19┊\n+┊   ┊ 20┊import { GetChats } from '../../../../graphql';\n+┊   ┊ 21┊import { dataIdFromObject } from '../../../graphql.module';\n+┊   ┊ 22┊import { ChatsComponent } from './chats.component';\n+┊   ┊ 23┊import { ChatsListComponent } from '../../components/chats-list/chats-list.component';\n+┊   ┊ 24┊import { ChatItemComponent } from '../../components/chat-item/chat-item.component';\n+┊   ┊ 25┊import { ChatsService } from '../../../services/chats.service';\n+┊   ┊ 26┊\n+┊   ┊ 27┊describe('ChatsComponent', () => {\n+┊   ┊ 28┊  let component: ChatsComponent;\n+┊   ┊ 29┊  let fixture: ComponentFixture<ChatsComponent>;\n+┊   ┊ 30┊  let el: DebugElement;\n+┊   ┊ 31┊\n+┊   ┊ 32┊  let controller: ApolloTestingController;\n+┊   ┊ 33┊  let apollo: Apollo;\n+┊   ┊ 34┊\n+┊   ┊ 35┊  const chats: GetChats.Chats[] = [\n+┊   ┊ 36┊    {\n+┊   ┊ 37┊      id: '1',\n+┊   ┊ 38┊      __typename: 'Chat',\n+┊   ┊ 39┊      name: 'Avery Stewart',\n+┊   ┊ 40┊      picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n+┊   ┊ 41┊      allTimeMembers: [\n+┊   ┊ 42┊        {\n+┊   ┊ 43┊          id: '1',\n+┊   ┊ 44┊          __typename: 'User',\n+┊   ┊ 45┊        },\n+┊   ┊ 46┊        {\n+┊   ┊ 47┊          id: '3',\n+┊   ┊ 48┊          __typename: 'User',\n+┊   ┊ 49┊        },\n+┊   ┊ 50┊      ],\n+┊   ┊ 51┊      unreadMessages: 1,\n+┊   ┊ 52┊      isGroup: false,\n+┊   ┊ 53┊      messages: [\n+┊   ┊ 54┊        {\n+┊   ┊ 55┊          id: '1',\n+┊   ┊ 56┊          chat: {\n+┊   ┊ 57┊            id: '1',\n+┊   ┊ 58┊            __typename: 'Chat',\n+┊   ┊ 59┊          },\n+┊   ┊ 60┊          __typename: 'Message',\n+┊   ┊ 61┊          sender: {\n+┊   ┊ 62┊            id: '3',\n+┊   ┊ 63┊            __typename: 'User',\n+┊   ┊ 64┊            name: 'Avery Stewart',\n+┊   ┊ 65┊          },\n+┊   ┊ 66┊          content: 'Yep!',\n+┊   ┊ 67┊          createdAt: '1514035700',\n+┊   ┊ 68┊          type: 0,\n+┊   ┊ 69┊          recipients: [\n+┊   ┊ 70┊            {\n+┊   ┊ 71┊              user: {\n+┊   ┊ 72┊                id: '1',\n+┊   ┊ 73┊                __typename: 'User',\n+┊   ┊ 74┊              },\n+┊   ┊ 75┊              message: {\n+┊   ┊ 76┊                id: '1',\n+┊   ┊ 77┊                __typename: 'Message',\n+┊   ┊ 78┊                chat: {\n+┊   ┊ 79┊                  id: '1',\n+┊   ┊ 80┊                  __typename: 'Chat',\n+┊   ┊ 81┊                },\n+┊   ┊ 82┊              },\n+┊   ┊ 83┊              __typename: 'Recipient',\n+┊   ┊ 84┊              chat: {\n+┊   ┊ 85┊                id: '1',\n+┊   ┊ 86┊                __typename: 'Chat',\n+┊   ┊ 87┊              },\n+┊   ┊ 88┊              receivedAt: null,\n+┊   ┊ 89┊              readAt: null,\n+┊   ┊ 90┊            },\n+┊   ┊ 91┊          ],\n+┊   ┊ 92┊          ownership: false,\n+┊   ┊ 93┊        },\n+┊   ┊ 94┊      ],\n+┊   ┊ 95┊    },\n+┊   ┊ 96┊    {\n+┊   ┊ 97┊      id: '2',\n+┊   ┊ 98┊      __typename: 'Chat',\n+┊   ┊ 99┊      name: 'Katie Peterson',\n+┊   ┊100┊      picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n+┊   ┊101┊      allTimeMembers: [\n+┊   ┊102┊        {\n+┊   ┊103┊          id: '1',\n+┊   ┊104┊          __typename: 'User',\n+┊   ┊105┊        },\n+┊   ┊106┊        {\n+┊   ┊107┊          id: '4',\n+┊   ┊108┊          __typename: 'User',\n+┊   ┊109┊        },\n+┊   ┊110┊      ],\n+┊   ┊111┊      unreadMessages: 0,\n+┊   ┊112┊      isGroup: false,\n+┊   ┊113┊      messages: [\n+┊   ┊114┊        {\n+┊   ┊115┊          id: '1',\n+┊   ┊116┊          chat: {\n+┊   ┊117┊            id: '2',\n+┊   ┊118┊            __typename: 'Chat',\n+┊   ┊119┊          },\n+┊   ┊120┊          __typename: 'Message',\n+┊   ┊121┊          sender: {\n+┊   ┊122┊            id: '1',\n+┊   ┊123┊            __typename: 'User',\n+┊   ┊124┊            name: 'Ethan Gonzalez',\n+┊   ┊125┊          },\n+┊   ┊126┊          content: `Hey, it's me`,\n+┊   ┊127┊          createdAt: '1514031800',\n+┊   ┊128┊          type: 0,\n+┊   ┊129┊          recipients: [\n+┊   ┊130┊            {\n+┊   ┊131┊              user: {\n+┊   ┊132┊                id: '4',\n+┊   ┊133┊                __typename: 'User',\n+┊   ┊134┊              },\n+┊   ┊135┊              message: {\n+┊   ┊136┊                id: '1',\n+┊   ┊137┊                __typename: 'Message',\n+┊   ┊138┊                chat: {\n+┊   ┊139┊                  id: '2',\n+┊   ┊140┊                  __typename: 'Chat',\n+┊   ┊141┊                },\n+┊   ┊142┊              },\n+┊   ┊143┊              __typename: 'Recipient',\n+┊   ┊144┊              chat: {\n+┊   ┊145┊                id: '2',\n+┊   ┊146┊                __typename: 'Chat',\n+┊   ┊147┊              },\n+┊   ┊148┊              receivedAt: null,\n+┊   ┊149┊              readAt: null,\n+┊   ┊150┊            },\n+┊   ┊151┊          ],\n+┊   ┊152┊          ownership: true,\n+┊   ┊153┊        },\n+┊   ┊154┊      ],\n+┊   ┊155┊    },\n+┊   ┊156┊    {\n+┊   ┊157┊      id: '3',\n+┊   ┊158┊      __typename: 'Chat',\n+┊   ┊159┊      name: 'Ray Edwards',\n+┊   ┊160┊      picture: 'https://randomuser.me/api/portraits/thumb/men/3.jpg',\n+┊   ┊161┊      allTimeMembers: [\n+┊   ┊162┊        {\n+┊   ┊163┊          id: '1',\n+┊   ┊164┊          __typename: 'User',\n+┊   ┊165┊        },\n+┊   ┊166┊        {\n+┊   ┊167┊          id: '5',\n+┊   ┊168┊          __typename: 'User',\n+┊   ┊169┊        },\n+┊   ┊170┊      ],\n+┊   ┊171┊      unreadMessages: 0,\n+┊   ┊172┊      isGroup: false,\n+┊   ┊173┊      messages: [\n+┊   ┊174┊        {\n+┊   ┊175┊          id: '1',\n+┊   ┊176┊          __typename: 'Message',\n+┊   ┊177┊          chat: {\n+┊   ┊178┊            id: '3',\n+┊   ┊179┊            __typename: 'Chat',\n+┊   ┊180┊          },\n+┊   ┊181┊          sender: {\n+┊   ┊182┊            id: '1',\n+┊   ┊183┊            __typename: 'User',\n+┊   ┊184┊            name: 'Ethan Gonzalez',\n+┊   ┊185┊          },\n+┊   ┊186┊          content: 'You still there?',\n+┊   ┊187┊          createdAt: '1514010200',\n+┊   ┊188┊          type: 0,\n+┊   ┊189┊          recipients: [\n+┊   ┊190┊            {\n+┊   ┊191┊              user: {\n+┊   ┊192┊                id: '5',\n+┊   ┊193┊                __typename: 'User',\n+┊   ┊194┊              },\n+┊   ┊195┊              message: {\n+┊   ┊196┊                id: '1',\n+┊   ┊197┊                __typename: 'Message',\n+┊   ┊198┊                chat: {\n+┊   ┊199┊                  id: '3',\n+┊   ┊200┊                  __typename: 'Chat',\n+┊   ┊201┊                },\n+┊   ┊202┊              },\n+┊   ┊203┊              __typename: 'Recipient',\n+┊   ┊204┊              chat: {\n+┊   ┊205┊                id: '3',\n+┊   ┊206┊                __typename: 'Chat',\n+┊   ┊207┊              },\n+┊   ┊208┊              receivedAt: null,\n+┊   ┊209┊              readAt: null,\n+┊   ┊210┊            },\n+┊   ┊211┊          ],\n+┊   ┊212┊          ownership: true,\n+┊   ┊213┊        },\n+┊   ┊214┊      ],\n+┊   ┊215┊    },\n+┊   ┊216┊    {\n+┊   ┊217┊      id: '6',\n+┊   ┊218┊      __typename: 'Chat',\n+┊   ┊219┊      name: 'Niccolò Belli',\n+┊   ┊220┊      picture: 'https://randomuser.me/api/portraits/thumb/men/4.jpg',\n+┊   ┊221┊      allTimeMembers: [\n+┊   ┊222┊        {\n+┊   ┊223┊          id: '1',\n+┊   ┊224┊          __typename: 'User',\n+┊   ┊225┊        },\n+┊   ┊226┊        {\n+┊   ┊227┊          id: '6',\n+┊   ┊228┊          __typename: 'User',\n+┊   ┊229┊        },\n+┊   ┊230┊      ],\n+┊   ┊231┊      unreadMessages: 0,\n+┊   ┊232┊      messages: [],\n+┊   ┊233┊      isGroup: false,\n+┊   ┊234┊    },\n+┊   ┊235┊    {\n+┊   ┊236┊      id: '8',\n+┊   ┊237┊      __typename: 'Chat',\n+┊   ┊238┊      name: 'A user 0 group',\n+┊   ┊239┊      picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n+┊   ┊240┊      allTimeMembers: [\n+┊   ┊241┊        {\n+┊   ┊242┊          id: '1',\n+┊   ┊243┊          __typename: 'User',\n+┊   ┊244┊        },\n+┊   ┊245┊        {\n+┊   ┊246┊          id: '3',\n+┊   ┊247┊          __typename: 'User',\n+┊   ┊248┊        },\n+┊   ┊249┊        {\n+┊   ┊250┊          id: '4',\n+┊   ┊251┊          __typename: 'User',\n+┊   ┊252┊        },\n+┊   ┊253┊        {\n+┊   ┊254┊          id: '6',\n+┊   ┊255┊          __typename: 'User',\n+┊   ┊256┊        },\n+┊   ┊257┊      ],\n+┊   ┊258┊      unreadMessages: 1,\n+┊   ┊259┊      isGroup: true,\n+┊   ┊260┊      messages: [\n+┊   ┊261┊        {\n+┊   ┊262┊          id: '1',\n+┊   ┊263┊          __typename: 'Message',\n+┊   ┊264┊          chat: {\n+┊   ┊265┊            id: '8',\n+┊   ┊266┊            __typename: 'Chat',\n+┊   ┊267┊          },\n+┊   ┊268┊          sender: {\n+┊   ┊269┊            id: '4',\n+┊   ┊270┊            __typename: 'User',\n+┊   ┊271┊            name: 'Katie Peterson',\n+┊   ┊272┊          },\n+┊   ┊273┊          content: 'Awesome!',\n+┊   ┊274┊          createdAt: '1512830000',\n+┊   ┊275┊          type: 0,\n+┊   ┊276┊          recipients: [\n+┊   ┊277┊            {\n+┊   ┊278┊              user: {\n+┊   ┊279┊                id: '1',\n+┊   ┊280┊                __typename: 'User',\n+┊   ┊281┊              },\n+┊   ┊282┊              message: {\n+┊   ┊283┊                id: '1',\n+┊   ┊284┊                __typename: 'Message',\n+┊   ┊285┊                chat: {\n+┊   ┊286┊                  id: '8',\n+┊   ┊287┊                  __typename: 'Chat',\n+┊   ┊288┊                },\n+┊   ┊289┊              },\n+┊   ┊290┊              __typename: 'Recipient',\n+┊   ┊291┊              chat: {\n+┊   ┊292┊                id: '8',\n+┊   ┊293┊                __typename: 'Chat',\n+┊   ┊294┊              },\n+┊   ┊295┊              receivedAt: null,\n+┊   ┊296┊              readAt: null,\n+┊   ┊297┊            },\n+┊   ┊298┊            {\n+┊   ┊299┊              user: {\n+┊   ┊300┊                id: '6',\n+┊   ┊301┊                __typename: 'User',\n+┊   ┊302┊              },\n+┊   ┊303┊              message: {\n+┊   ┊304┊                id: '1',\n+┊   ┊305┊                __typename: 'Message',\n+┊   ┊306┊                chat: {\n+┊   ┊307┊                  id: '8',\n+┊   ┊308┊                  __typename: 'Chat',\n+┊   ┊309┊                },\n+┊   ┊310┊              },\n+┊   ┊311┊              __typename: 'Recipient',\n+┊   ┊312┊              chat: {\n+┊   ┊313┊                id: '8',\n+┊   ┊314┊                __typename: 'Chat',\n+┊   ┊315┊              },\n+┊   ┊316┊              receivedAt: null,\n+┊   ┊317┊              readAt: null,\n+┊   ┊318┊            },\n+┊   ┊319┊          ],\n+┊   ┊320┊          ownership: false,\n+┊   ┊321┊        },\n+┊   ┊322┊      ],\n+┊   ┊323┊    },\n+┊   ┊324┊  ];\n+┊   ┊325┊\n+┊   ┊326┊  beforeEach(async(() => {\n+┊   ┊327┊    TestBed.configureTestingModule({\n+┊   ┊328┊      declarations: [ChatsComponent, ChatsListComponent, ChatItemComponent],\n+┊   ┊329┊      imports: [\n+┊   ┊330┊        MatMenuModule,\n+┊   ┊331┊        MatIconModule,\n+┊   ┊332┊        MatButtonModule,\n+┊   ┊333┊        MatListModule,\n+┊   ┊334┊        TruncateModule,\n+┊   ┊335┊        ApolloTestingModule,\n+┊   ┊336┊        RouterTestingModule,\n+┊   ┊337┊      ],\n+┊   ┊338┊      providers: [\n+┊   ┊339┊        ChatsService,\n+┊   ┊340┊        {\n+┊   ┊341┊          provide: APOLLO_TESTING_CACHE,\n+┊   ┊342┊          useFactory() {\n+┊   ┊343┊            return new InMemoryCache({ dataIdFromObject });\n+┊   ┊344┊          },\n+┊   ┊345┊        },\n+┊   ┊346┊      ],\n+┊   ┊347┊      schemas: [NO_ERRORS_SCHEMA],\n+┊   ┊348┊    }).compileComponents();\n+┊   ┊349┊\n+┊   ┊350┊    controller = TestBed.get(ApolloTestingController);\n+┊   ┊351┊    apollo = TestBed.get(Apollo);\n+┊   ┊352┊  }));\n+┊   ┊353┊\n+┊   ┊354┊  beforeEach(() => {\n+┊   ┊355┊    fixture = TestBed.createComponent(ChatsComponent);\n+┊   ┊356┊    component = fixture.componentInstance;\n+┊   ┊357┊    fixture.detectChanges();\n+┊   ┊358┊\n+┊   ┊359┊    const req = controller.expectOne('GetChats', 'GetChats operation');\n+┊   ┊360┊\n+┊   ┊361┊    req.flush({\n+┊   ┊362┊      data: {\n+┊   ┊363┊        chats,\n+┊   ┊364┊      },\n+┊   ┊365┊    });\n+┊   ┊366┊  });\n+┊   ┊367┊\n+┊   ┊368┊  it('should create', () => {\n+┊   ┊369┊    expect(component).toBeTruthy();\n+┊   ┊370┊  });\n+┊   ┊371┊\n+┊   ┊372┊  it('should display the chats', () => {\n+┊   ┊373┊    fixture.whenStable().then(() => {\n+┊   ┊374┊      fixture.detectChanges();\n+┊   ┊375┊      el = fixture.debugElement;\n+┊   ┊376┊      for (let i = 0; i < chats.length; i++) {\n+┊   ┊377┊        expect(\n+┊   ┊378┊          el.query(\n+┊   ┊379┊            By.css(\n+┊   ┊380┊              `app-chats-list > mat-list > mat-list-item:nth-child(${i +\n+┊   ┊381┊                1}) > div > app-chat-item > div > div > div`,\n+┊   ┊382┊            ),\n+┊   ┊383┊          ).nativeElement.textContent,\n+┊   ┊384┊        ).toContain(chats[i].name);\n+┊   ┊385┊      }\n+┊   ┊386┊    });\n+┊   ┊387┊  });\n+┊   ┊388┊\n+┊   ┊389┊  afterAll(() => {\n+┊   ┊390┊    controller.verify();\n+┊   ┊391┊  });\n+┊   ┊392┊});\n```\n\n[}]: #"
          },
          {
            "manualTitle": "Step 8: Chat viewer",
            "stepRevision": "026cf4f16276d61fd0e962c466c76806bb4f397c",
            "manualView": "![chat](https://user-images.githubusercontent.com/7648874/49270290-92877e80-f4a3-11e8-8984-d3ee920838ed.png)\n\nAt this point we have a module which lists all of our chats, but we still need to show a particular chat.\nWe're going to implement in in this chapter.\n\n### ChatViewer module\n\nFirst, let's create a `ChatViewer` module:\n\n[{]: <helper> (diffStep \"4.1\" files=\"src/app/app.module.ts, src/app/chat-viewer/chat-viewer.module.ts\" module=\"client\")\n\n#### [Step 4.1: Chat Viewer](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/257159a)\n\n##### Changed src&#x2F;app&#x2F;app.module.ts\n```diff\n@@ -6,6 +6,7 @@\n ┊ 6┊ 6┊import { GraphQLModule } from './graphql.module';\n ┊ 7┊ 7┊import {ChatsListerModule} from './chats-lister/chats-lister.module';\n ┊ 8┊ 8┊import {RouterModule, Routes} from '@angular/router';\n+┊  ┊ 9┊import {ChatViewerModule} from './chat-viewer/chat-viewer.module';\n ┊ 9┊10┊const routes: Routes = [];\n ┊10┊11┊\n ┊11┊12┊@NgModule({\n```\n```diff\n@@ -20,6 +21,7 @@\n ┊20┊21┊    RouterModule.forRoot(routes),\n ┊21┊22┊    // Feature modules\n ┊22┊23┊    ChatsListerModule,\n+┊  ┊24┊    ChatViewerModule,\n ┊23┊25┊  ],\n ┊24┊26┊  providers: [],\n ┊25┊27┊  bootstrap: [AppComponent]\n```\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;chat-viewer.module.ts\n```diff\n@@ -0,0 +1,53 @@\n+┊  ┊ 1┊import { BrowserModule } from '@angular/platform-browser';\n+┊  ┊ 2┊import { NgModule } from '@angular/core';\n+┊  ┊ 3┊\n+┊  ┊ 4┊import {BrowserAnimationsModule} from '@angular/platform-browser/animations';\n+┊  ┊ 5┊import {MatButtonModule, MatGridListModule, MatIconModule, MatListModule, MatMenuModule, MatToolbarModule} from '@angular/material';\n+┊  ┊ 6┊import {RouterModule, Routes} from '@angular/router';\n+┊  ┊ 7┊import {FormsModule} from '@angular/forms';\n+┊  ┊ 8┊import {ChatsService} from '../services/chats.service';\n+┊  ┊ 9┊import {ChatComponent} from './containers/chat/chat.component';\n+┊  ┊10┊import {MessagesListComponent} from './components/messages-list/messages-list.component';\n+┊  ┊11┊import {MessageItemComponent} from './components/message-item/message-item.component';\n+┊  ┊12┊import {NewMessageComponent} from './components/new-message/new-message.component';\n+┊  ┊13┊import {SharedModule} from '../shared/shared.module';\n+┊  ┊14┊\n+┊  ┊15┊const routes: Routes = [\n+┊  ┊16┊  {\n+┊  ┊17┊    path: 'chat', children: [\n+┊  ┊18┊      {path: ':id', component: ChatComponent},\n+┊  ┊19┊    ],\n+┊  ┊20┊  },\n+┊  ┊21┊];\n+┊  ┊22┊\n+┊  ┊23┊@NgModule({\n+┊  ┊24┊  declarations: [\n+┊  ┊25┊    ChatComponent,\n+┊  ┊26┊    MessagesListComponent,\n+┊  ┊27┊    MessageItemComponent,\n+┊  ┊28┊    NewMessageComponent,\n+┊  ┊29┊  ],\n+┊  ┊30┊  imports: [\n+┊  ┊31┊    BrowserModule,\n+┊  ┊32┊    // Material\n+┊  ┊33┊    MatToolbarModule,\n+┊  ┊34┊    MatMenuModule,\n+┊  ┊35┊    MatIconModule,\n+┊  ┊36┊    MatButtonModule,\n+┊  ┊37┊    MatListModule,\n+┊  ┊38┊    MatGridListModule,\n+┊  ┊39┊    // Animations\n+┊  ┊40┊    BrowserAnimationsModule,\n+┊  ┊41┊    // Routing\n+┊  ┊42┊    RouterModule.forChild(routes),\n+┊  ┊43┊    // Forms\n+┊  ┊44┊    FormsModule,\n+┊  ┊45┊    // Feature modules\n+┊  ┊46┊    SharedModule,\n+┊  ┊47┊  ],\n+┊  ┊48┊  providers: [\n+┊  ┊49┊    ChatsService,\n+┊  ┊50┊  ],\n+┊  ┊51┊})\n+┊  ┊52┊export class ChatViewerModule {\n+┊  ┊53┊}\n```\n\n[}]: #\n\nAs you can see, it has already everything that we might need.\n\n### GetChat operation\n\nComponents need data, so we create the `GetChat` operation and run `yarn generator`:\n\n[{]: <helper> (diffStep \"4.1\" files=\"src/graphql/getChat.query.ts\" module=\"client\")\n\n#### [Step 4.1: Chat Viewer](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/257159a)\n\n##### Added src&#x2F;graphql&#x2F;getChat.query.ts\n```diff\n@@ -0,0 +1,17 @@\n+┊  ┊ 1┊import gql from 'graphql-tag';\n+┊  ┊ 2┊import {fragments} from './fragment';\n+┊  ┊ 3┊\n+┊  ┊ 4┊// We use the gql tag to parse our query string into a query document\n+┊  ┊ 5┊export const getChatQuery = gql`\n+┊  ┊ 6┊  query GetChat($chatId: ID!) {\n+┊  ┊ 7┊    chat(chatId: $chatId) {\n+┊  ┊ 8┊      ...ChatWithoutMessages\n+┊  ┊ 9┊      messages {\n+┊  ┊10┊        ...Message\n+┊  ┊11┊      }\n+┊  ┊12┊    }\n+┊  ┊13┊  }\n+┊  ┊14┊\n+┊  ┊15┊  ${fragments['chatWithoutMessages']}\n+┊  ┊16┊  ${fragments['message']}\n+┊  ┊17┊`;\n```\n\n[}]: #\n\nThe query can be now implemented in `ChatsService`:\n\n[{]: <helper> (diffStep \"4.1\" files=\"src/app/services/chats.service.ts\" module=\"client\")\n\n#### [Step 4.1: Chat Viewer](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/257159a)\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,13 +1,14 @@\n ┊ 1┊ 1┊import {map} from 'rxjs/operators';\n ┊ 2┊ 2┊import {Injectable} from '@angular/core';\n-┊ 3┊  ┊import {GetChatsGQL} from '../../graphql';\n+┊  ┊ 3┊import {GetChatsGQL, GetChatGQL} from '../../graphql';\n ┊ 4┊ 4┊\n ┊ 5┊ 5┊@Injectable()\n ┊ 6┊ 6┊export class ChatsService {\n ┊ 7┊ 7┊  messagesAmount = 3;\n ┊ 8┊ 8┊\n ┊ 9┊ 9┊  constructor(\n-┊10┊  ┊    private getChatsGQL: GetChatsGQL\n+┊  ┊10┊    private getChatsGQL: GetChatsGQL,\n+┊  ┊11┊    private getChatGQL: GetChatGQL\n ┊11┊12┊  ) {}\n ┊12┊13┊\n ┊13┊14┊  getChats() {\n```\n```diff\n@@ -20,4 +21,16 @@\n ┊20┊21┊\n ┊21┊22┊    return {query, chats$};\n ┊22┊23┊  }\n+┊  ┊24┊\n+┊  ┊25┊  getChat(chatId: string) {\n+┊  ┊26┊    const query = this.getChatGQL.watch({\n+┊  ┊27┊      chatId: chatId,\n+┊  ┊28┊    });\n+┊  ┊29┊\n+┊  ┊30┊    const chat$ = query.valueChanges.pipe(\n+┊  ┊31┊      map((result) => result.data.chat)\n+┊  ┊32┊    );\n+┊  ┊33┊\n+┊  ┊34┊    return {query, chat$};\n+┊  ┊35┊  }\n ┊23┊36┊}\n```\n\n[}]: #\n\nGreat!\n\n### Chat view\n\nNow we've got data but a user can't still access the chat view.\nThere is one place where we're able to pick the chat, it's the list:\n\n[{]: <helper> (diffStep \"4.1\" files=\"src/app/chats-lister/components/chat-item/chat-item.component.ts, src/app/chats-lister/components/chats-list/chats-list.component.ts, src/app/chats-lister/containers/chats/chats.component.ts\" module=\"client\")\n\n#### [Step 4.1: Chat Viewer](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/257159a)\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chat-item&#x2F;chat-item.component.ts\n```diff\n@@ -1,14 +1,14 @@\n-┊ 1┊  ┊import {Component, Input} from '@angular/core';\n+┊  ┊ 1┊import {Component, EventEmitter, Input, Output} from '@angular/core';\n ┊ 2┊ 2┊import {GetChats} from '../../../../graphql';\n ┊ 3┊ 3┊\n ┊ 4┊ 4┊@Component({\n ┊ 5┊ 5┊  selector: 'app-chat-item',\n ┊ 6┊ 6┊  template: `\n-┊ 7┊  ┊    <div class=\"chat-row\">\n+┊  ┊ 7┊    <div class=\"chat-row\" (click)=\"selectChat()\">\n ┊ 8┊ 8┊      <img class=\"chat-pic\" [src]=\"chat.picture || 'assets/default-profile-pic.jpg'\">\n ┊ 9┊ 9┊      <div class=\"chat-info\">\n ┊10┊10┊        <div class=\"chat-name\">{{ chat.name }}</div>\n-┊11┊  ┊        <div class=\"chat-last-message\">{{ chat.messages?[chat.messages?.length - 1]?.content }}</div>\n+┊  ┊11┊        <div class=\"chat-last-message\">{{ chat.messages[chat.messages.length - 1]?.content }}</div>\n ┊12┊12┊        <div class=\"chat-timestamp\">00:00</div>\n ┊13┊13┊      </div>\n ┊14┊14┊    </div>\n```\n```diff\n@@ -19,4 +19,11 @@\n ┊19┊19┊  // tslint:disable-next-line:no-input-rename\n ┊20┊20┊  @Input('item')\n ┊21┊21┊  chat: GetChats.Chats;\n+┊  ┊22┊\n+┊  ┊23┊  @Output()\n+┊  ┊24┊  select = new EventEmitter<string>();\n+┊  ┊25┊\n+┊  ┊26┊  selectChat() {\n+┊  ┊27┊    this.select.emit(this.chat.id);\n+┊  ┊28┊  }\n ┊22┊29┊}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chats-list&#x2F;chats-list.component.ts\n```diff\n@@ -1,4 +1,4 @@\n-┊1┊ ┊import {Component, Input} from '@angular/core';\n+┊ ┊1┊import {Component, EventEmitter, Input, Output} from '@angular/core';\n ┊2┊2┊import {GetChats} from '../../../../graphql';\n ┊3┊3┊\n ┊4┊4┊@Component({\n```\n```diff\n@@ -6,7 +6,7 @@\n ┊ 6┊ 6┊  template: `\n ┊ 7┊ 7┊    <mat-list>\n ┊ 8┊ 8┊      <mat-list-item *ngFor=\"let chat of chats\">\n-┊ 9┊  ┊        <app-chat-item [item]=\"chat\"></app-chat-item>\n+┊  ┊ 9┊        <app-chat-item [item]=\"chat\" (select)=\"selectChat($event)\"></app-chat-item>\n ┊10┊10┊      </mat-list-item>\n ┊11┊11┊    </mat-list>\n ┊12┊12┊  `,\n```\n```diff\n@@ -17,5 +17,12 @@\n ┊17┊17┊  @Input('items')\n ┊18┊18┊  chats: GetChats.Chats[];\n ┊19┊19┊\n+┊  ┊20┊  @Output()\n+┊  ┊21┊  select = new EventEmitter<string>();\n+┊  ┊22┊\n ┊20┊23┊  constructor() {}\n+┊  ┊24┊\n+┊  ┊25┊  selectChat(id: string) {\n+┊  ┊26┊    this.select.emit(id);\n+┊  ┊27┊  }\n ┊21┊28┊}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.ts\n```diff\n@@ -2,6 +2,7 @@\n ┊2┊2┊import {ChatsService} from '../../../services/chats.service';\n ┊3┊3┊import {Observable} from 'rxjs';\n ┊4┊4┊import {GetChats} from '../../../../graphql';\n+┊ ┊5┊import {Router} from '@angular/router';\n ┊5┊6┊\n ┊6┊7┊@Component({\n ┊7┊8┊  template: `\n```\n```diff\n@@ -27,7 +28,7 @@\n ┊27┊28┊      </button>\n ┊28┊29┊    </mat-menu>\n ┊29┊30┊\n-┊30┊  ┊    <app-chats-list [items]=\"chats$ | async\"></app-chats-list>\n+┊  ┊31┊    <app-chats-list [items]=\"chats$ | async\" (select)=\"goToChat($event)\"></app-chats-list>\n ┊31┊32┊\n ┊32┊33┊    <button class=\"chat-button\" mat-fab color=\"secondary\">\n ┊33┊34┊      <mat-icon aria-label=\"Icon-button with a + icon\">chat</mat-icon>\n```\n```diff\n@@ -38,10 +39,15 @@\n ┊38┊39┊export class ChatsComponent implements OnInit {\n ┊39┊40┊  chats$: Observable<GetChats.Chats[]>;\n ┊40┊41┊\n-┊41┊  ┊  constructor(private chatsService: ChatsService) {\n+┊  ┊42┊  constructor(private chatsService: ChatsService,\n+┊  ┊43┊              private router: Router) {\n ┊42┊44┊  }\n ┊43┊45┊\n ┊44┊46┊  ngOnInit() {\n ┊45┊47┊    this.chats$ = this.chatsService.getChats().chats$;\n ┊46┊48┊  }\n+┊  ┊49┊\n+┊  ┊50┊  goToChat(chatId: string) {\n+┊  ┊51┊    this.router.navigate(['/chat', chatId]);\n+┊  ┊52┊  }\n ┊47┊53┊}\n```\n\n[}]: #\n\nTime for a next step, an actual implementation of the chat view.\n\n[{]: <helper> (diffStep \"4.1\" files=\"src/app/chat-viewer/containers/chat/chat.component.ts, src/app/chat-viewer/containers/chat/chat.component.scss\" module=\"client\")\n\n#### [Step 4.1: Chat Viewer](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/257159a)\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.scss\n```diff\n@@ -0,0 +1,33 @@\n+┊  ┊ 1┊app-toolbar {\n+┊  ┊ 2┊  .navigation {\n+┊  ┊ 3┊    padding: 0;\n+┊  ┊ 4┊    display: inherit;\n+┊  ┊ 5┊    margin-right: -40px;\n+┊  ┊ 6┊  }\n+┊  ┊ 7┊\n+┊  ┊ 8┊  .title {\n+┊  ┊ 9┊    line-height: 8vh;\n+┊  ┊10┊  }\n+┊  ┊11┊\n+┊  ┊12┊  .profile-pic {\n+┊  ┊13┊    height: calc(100% - 10px);\n+┊  ┊14┊    width: auto;\n+┊  ┊15┊    padding: 5px;\n+┊  ┊16┊    border-radius: 50%;\n+┊  ┊17┊  }\n+┊  ┊18┊}\n+┊  ┊19┊\n+┊  ┊20┊.container {\n+┊  ┊21┊  display: flex;\n+┊  ┊22┊  flex-flow: column;\n+┊  ┊23┊  justify-content: space-between;\n+┊  ┊24┊  height: calc(100vh - 8vh);\n+┊  ┊25┊  background-image: url(/assets/chat-background.jpg);\n+┊  ┊26┊  background-color: #E0DAD6;\n+┊  ┊27┊  background-repeat: no-repeat;\n+┊  ┊28┊  background-size: cover;\n+┊  ┊29┊\n+┊  ┊30┊  app-confirm-selection {\n+┊  ┊31┊    bottom: 10vh;\n+┊  ┊32┊  }\n+┊  ┊33┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.ts\n```diff\n@@ -0,0 +1,46 @@\n+┊  ┊ 1┊import {Component, OnInit} from '@angular/core';\n+┊  ┊ 2┊import {ActivatedRoute, Router} from '@angular/router';\n+┊  ┊ 3┊import {ChatsService} from '../../../services/chats.service';\n+┊  ┊ 4┊\n+┊  ┊ 5┊@Component({\n+┊  ┊ 6┊  template: `\n+┊  ┊ 7┊    <app-toolbar>\n+┊  ┊ 8┊      <button class=\"navigation\" mat-button (click)=\"goToChats()\">\n+┊  ┊ 9┊        <mat-icon aria-label=\"Icon-button with an arrow back icon\">arrow_back</mat-icon>\n+┊  ┊10┊      </button>\n+┊  ┊11┊      <img class=\"profile-pic\" src=\"assets/default-profile-pic.jpg\">\n+┊  ┊12┊      <div class=\"title\">{{ name }}</div>\n+┊  ┊13┊    </app-toolbar>\n+┊  ┊14┊    <div class=\"container\">\n+┊  ┊15┊      <app-messages-list [items]=\"messages\" [isGroup]=\"isGroup\"></app-messages-list>\n+┊  ┊16┊      <app-new-message></app-new-message>\n+┊  ┊17┊    </div>\n+┊  ┊18┊  `,\n+┊  ┊19┊  styleUrls: ['./chat.component.scss']\n+┊  ┊20┊})\n+┊  ┊21┊export class ChatComponent implements OnInit {\n+┊  ┊22┊  chatId: string;\n+┊  ┊23┊  messages: any[];\n+┊  ┊24┊  name: string;\n+┊  ┊25┊  isGroup: boolean;\n+┊  ┊26┊\n+┊  ┊27┊  constructor(private route: ActivatedRoute,\n+┊  ┊28┊              private router: Router,\n+┊  ┊29┊              private chatsService: ChatsService) {\n+┊  ┊30┊  }\n+┊  ┊31┊\n+┊  ┊32┊  ngOnInit() {\n+┊  ┊33┊    this.route.params.subscribe(({id: chatId}) => {\n+┊  ┊34┊      this.chatId = chatId;\n+┊  ┊35┊      this.chatsService.getChat(chatId).chat$.subscribe(chat => {\n+┊  ┊36┊        this.messages = chat.messages;\n+┊  ┊37┊        this.name = chat.name;\n+┊  ┊38┊        this.isGroup = chat.isGroup;\n+┊  ┊39┊      });\n+┊  ┊40┊    });\n+┊  ┊41┊  }\n+┊  ┊42┊\n+┊  ┊43┊  goToChats() {\n+┊  ┊44┊    this.router.navigate(['/chats']);\n+┊  ┊45┊  }\n+┊  ┊46┊}\n```\n\n[}]: #\n\nThe `ChatComponent` component contains:\n\n - Toolbar with chat's name and a \"go back\" button\n - List of messages sorted from oldest to newest\n - Space to submit a new message\n\n### List of messages\n\nFirst we'll download and a couple of images which will help us create a \"bubble\" effect for received messages:\n\n    $ wget https://raw.githubusercontent.com/Urigo/whatsapp-client-angularcli-material/c75c2416b1990da3588015f76b8338764f44d6ec/src/assets/chat-background.jpg -P src/assets\n    $ wget https://raw.githubusercontent.com/Urigo/whatsapp-client-angularcli-material/https://raw.githubusercontent.com/Urigo/whatsapp-client-angularcli-material/c75c2416b1990da3588015f76b8338764f44d6ec/src/assets/chat-background.jpg/src/assets/message-mine.png -P src/assets\n    $ wget https://raw.githubusercontent.com/Urigo/whatsapp-client-angularcli-material/https://raw.githubusercontent.com/Urigo/whatsapp-client-angularcli-material/c75c2416b1990da3588015f76b8338764f44d6ec/src/assets/chat-background.jpg/src/assets/message-other.png -P src/assets\n\nWe'll now split the list of messages to the host:\n\n[{]: <helper> (diffStep \"4.1\" files=\"src/app/chat-viewer/components/messages-list/messages-list.component.ts, src/app/chat-viewer/components/messages-list/messages-list.component.scss\" module=\"client\")\n\n#### [Step 4.1: Chat Viewer](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/257159a)\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;components&#x2F;messages-list&#x2F;messages-list.component.scss\n```diff\n@@ -0,0 +1,14 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊  height: 100%;\n+┊  ┊ 4┊}\n+┊  ┊ 5┊\n+┊  ┊ 6┊::ng-deep .mat-list-item-content {\n+┊  ┊ 7┊  display: block !important;\n+┊  ┊ 8┊}\n+┊  ┊ 9┊\n+┊  ┊10┊/*\n+┊  ┊11┊:host::-webkit-scrollbar {\n+┊  ┊12┊  display: none;\n+┊  ┊13┊}\n+┊  ┊14┊*/🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;components&#x2F;messages-list&#x2F;messages-list.component.ts\n```diff\n@@ -0,0 +1,23 @@\n+┊  ┊ 1┊import {Component, Input} from '@angular/core';\n+┊  ┊ 2┊\n+┊  ┊ 3┊@Component({\n+┊  ┊ 4┊  selector: 'app-messages-list',\n+┊  ┊ 5┊  template: `\n+┊  ┊ 6┊    <mat-list>\n+┊  ┊ 7┊      <mat-list-item *ngFor=\"let message of messages\">\n+┊  ┊ 8┊        <app-message-item [item]=\"message\" [isGroup]=\"isGroup\"></app-message-item>\n+┊  ┊ 9┊      </mat-list-item>\n+┊  ┊10┊    </mat-list>\n+┊  ┊11┊  `,\n+┊  ┊12┊  styleUrls: ['messages-list.component.scss'],\n+┊  ┊13┊})\n+┊  ┊14┊export class MessagesListComponent {\n+┊  ┊15┊  // tslint:disable-next-line:no-input-rename\n+┊  ┊16┊  @Input('items')\n+┊  ┊17┊  messages: any[];\n+┊  ┊18┊\n+┊  ┊19┊  @Input()\n+┊  ┊20┊  isGroup: boolean;\n+┊  ┊21┊\n+┊  ┊22┊  constructor() {}\n+┊  ┊23┊}\n```\n\n[}]: #\n\nand a reused component for each message:\n\n[{]: <helper> (diffStep \"4.1\" files=\"src/app/chat-viewer/components/message-item/message-item.component.ts, src/app/chat-viewer/components/message-item/message-item.component.scss\" module=\"client\")\n\n#### [Step 4.1: Chat Viewer](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/257159a)\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;components&#x2F;message-item&#x2F;message-item.component.scss\n```diff\n@@ -0,0 +1,66 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  margin-bottom: 9px;\n+┊  ┊ 3┊\n+┊  ┊ 4┊  &::after {\n+┊  ┊ 5┊    content: \"\";\n+┊  ┊ 6┊    display: table;\n+┊  ┊ 7┊    clear: both;\n+┊  ┊ 8┊  }\n+┊  ┊ 9┊}\n+┊  ┊10┊\n+┊  ┊11┊.message {\n+┊  ┊12┊  display: inline-block;\n+┊  ┊13┊  position: relative;\n+┊  ┊14┊  max-width: 100%;\n+┊  ┊15┊  border-radius: 7px;\n+┊  ┊16┊  box-shadow: 0 1px 2px rgba(0, 0, 0, .15);\n+┊  ┊17┊\n+┊  ┊18┊  &.message-mine {\n+┊  ┊19┊    float: right;\n+┊  ┊20┊    background-color: #DCF8C6;\n+┊  ┊21┊\n+┊  ┊22┊    &::before {\n+┊  ┊23┊      right: -11px;\n+┊  ┊24┊      background-image: url(/assets/message-mine.png)\n+┊  ┊25┊    }\n+┊  ┊26┊  }\n+┊  ┊27┊\n+┊  ┊28┊  &.message-other {\n+┊  ┊29┊    float: left;\n+┊  ┊30┊    background-color: #FFF;\n+┊  ┊31┊\n+┊  ┊32┊    &::before {\n+┊  ┊33┊      left: -11px;\n+┊  ┊34┊      background-image: url(/assets/message-other.png)\n+┊  ┊35┊    }\n+┊  ┊36┊  }\n+┊  ┊37┊\n+┊  ┊38┊  &.message-other::before, &.message-mine::before {\n+┊  ┊39┊    content: \"\";\n+┊  ┊40┊    position: absolute;\n+┊  ┊41┊    bottom: 3px;\n+┊  ┊42┊    width: 12px;\n+┊  ┊43┊    height: 19px;\n+┊  ┊44┊    background-position: 50% 50%;\n+┊  ┊45┊    background-repeat: no-repeat;\n+┊  ┊46┊    background-size: contain;\n+┊  ┊47┊  }\n+┊  ┊48┊\n+┊  ┊49┊  .message-content {\n+┊  ┊50┊    padding: 5px 7px;\n+┊  ┊51┊    word-wrap: break-word;\n+┊  ┊52┊\n+┊  ┊53┊    &::after {\n+┊  ┊54┊      content: \" \\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\\00a0\";\n+┊  ┊55┊      display: inline;\n+┊  ┊56┊    }\n+┊  ┊57┊  }\n+┊  ┊58┊\n+┊  ┊59┊  .message-timestamp {\n+┊  ┊60┊    position: absolute;\n+┊  ┊61┊    bottom: 2px;\n+┊  ┊62┊    right: 7px;\n+┊  ┊63┊    color: gray;\n+┊  ┊64┊    font-size: 12px;\n+┊  ┊65┊  }\n+┊  ┊66┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;components&#x2F;message-item&#x2F;message-item.component.ts\n```diff\n@@ -0,0 +1,22 @@\n+┊  ┊ 1┊import {Component, Input} from '@angular/core';\n+┊  ┊ 2┊\n+┊  ┊ 3┊@Component({\n+┊  ┊ 4┊  selector: 'app-message-item',\n+┊  ┊ 5┊  template: `\n+┊  ┊ 6┊    <div class=\"message\"\n+┊  ┊ 7┊         [ngClass]=\"message.ownership ? 'message-mine' : 'message-other'\">\n+┊  ┊ 8┊      <div *ngIf=\"isGroup && !message.ownership\" class=\"message-sender\">{{ message.sender.name }}</div>\n+┊  ┊ 9┊      <div class=\"message-content\">{{ message.content }}</div>\n+┊  ┊10┊      <span class=\"message-timestamp\">00:00</span>\n+┊  ┊11┊    </div>\n+┊  ┊12┊  `,\n+┊  ┊13┊  styleUrls: ['message-item.component.scss'],\n+┊  ┊14┊})\n+┊  ┊15┊export class MessageItemComponent {\n+┊  ┊16┊  // tslint:disable-next-line:no-input-rename\n+┊  ┊17┊  @Input('item')\n+┊  ┊18┊  message: any;\n+┊  ┊19┊\n+┊  ┊20┊  @Input()\n+┊  ┊21┊  isGroup: boolean;\n+┊  ┊22┊}\n```\n\n[}]: #\n\nAs you see, we could easily decide which message comes from which user based on the `ownership` property.\n\n### Submit a new message\n\nThe app shows the conversation and now we're going to focus on the last part, actually emitting a new message!\n\n[{]: <helper> (diffStep \"4.1\" files=\"src/app/chat-viewer/components/new-message/new-message.component.scss, src/app/chat-viewer/components/new-message/new-message.component.ts\" module=\"client\")\n\n#### [Step 4.1: Chat Viewer](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/257159a)\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;components&#x2F;new-message&#x2F;new-message.component.scss\n```diff\n@@ -0,0 +1,32 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: flex;\n+┊  ┊ 3┊  height: 50px;\n+┊  ┊ 4┊  padding: 5px;\n+┊  ┊ 5┊}\n+┊  ┊ 6┊\n+┊  ┊ 7┊input {\n+┊  ┊ 8┊  width: 100%;\n+┊  ┊ 9┊  border: none;\n+┊  ┊10┊  border-radius: 999px;\n+┊  ┊11┊  padding: 10px;\n+┊  ┊12┊  padding-left: 20px;\n+┊  ┊13┊  padding-right: 20px;\n+┊  ┊14┊  font-size: 15px;\n+┊  ┊15┊  outline: none;\n+┊  ┊16┊  box-shadow: 0 1px silver;\n+┊  ┊17┊  font-size: 18px;\n+┊  ┊18┊  line-height: 45px;\n+┊  ┊19┊}\n+┊  ┊20┊\n+┊  ┊21┊button {\n+┊  ┊22┊  min-width: 45px;\n+┊  ┊23┊  width: 45px;\n+┊  ┊24┊  border-radius: 999px;\n+┊  ┊25┊  background-color: var(--primary);\n+┊  ┊26┊  margin-left: 5px;\n+┊  ┊27┊  color: white;\n+┊  ┊28┊\n+┊  ┊29┊  mat-icon {\n+┊  ┊30┊    margin-left: -3px;\n+┊  ┊31┊  }\n+┊  ┊32┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;components&#x2F;new-message&#x2F;new-message.component.ts\n```diff\n@@ -0,0 +1,34 @@\n+┊  ┊ 1┊import {Component, EventEmitter, Input, Output} from '@angular/core';\n+┊  ┊ 2┊\n+┊  ┊ 3┊@Component({\n+┊  ┊ 4┊  selector: 'app-new-message',\n+┊  ┊ 5┊  template: `\n+┊  ┊ 6┊    <input type=\"text\" placeholder=\"Type a message\" [(ngModel)]=\"message\" (keyup)=\"onInputKeyup($event)\"/>\n+┊  ┊ 7┊    <button mat-button (click)=\"emitMessage()\" [disabled]=\"disabled\">\n+┊  ┊ 8┊      <mat-icon aria-label=\"Icon-button with a send icon\">send</mat-icon>\n+┊  ┊ 9┊    </button>\n+┊  ┊10┊  `,\n+┊  ┊11┊  styleUrls: ['new-message.component.scss'],\n+┊  ┊12┊})\n+┊  ┊13┊export class NewMessageComponent {\n+┊  ┊14┊  @Input()\n+┊  ┊15┊  disabled: boolean;\n+┊  ┊16┊\n+┊  ┊17┊  @Output()\n+┊  ┊18┊  newMessage = new EventEmitter<string>();\n+┊  ┊19┊\n+┊  ┊20┊  message = '';\n+┊  ┊21┊\n+┊  ┊22┊  onInputKeyup({ keyCode }: KeyboardEvent) {\n+┊  ┊23┊    if (keyCode === 13) {\n+┊  ┊24┊      this.emitMessage();\n+┊  ┊25┊    }\n+┊  ┊26┊  }\n+┊  ┊27┊\n+┊  ┊28┊  emitMessage() {\n+┊  ┊29┊    if (this.message && !this.disabled) {\n+┊  ┊30┊      this.newMessage.emit(this.message);\n+┊  ┊31┊      this.message = '';\n+┊  ┊32┊    }\n+┊  ┊33┊  }\n+┊  ┊34┊}\n```\n\n[}]: #\n\nIt's not yet fully functional, we receive the message in the `ChatComponent` but we still need to send it to the server. We'll cover that in next few steps!"
          },
          {
            "manualTitle": "Step 9: Mutations",
            "stepRevision": "fcbc9a30cfdd7004eabc050189a94dad094e2ed7",
            "manualView": "In addition to fetching data using queries, Apollo also helps you handle GraphQL mutations. In GraphQL, mutations are identical to queries in syntax, the only difference being that you use the keyword mutation instead of query to indicate that the root fields on this query are going to be performing writes to the backend.\nGraphQL mutations represent two things in one query string:\n\n1. The mutation field name with arguments, which represents the actual operation to be done on the server.\n2. The fields you want back from the result of the mutation to update the client.\n\nWhen we use mutations in Apollo, the result is typically integrated into the cache automatically based on the id of the result, which in turn updates the UI automatically, so we often don't need to explicitly handle the results. In order for the client to correctly do this, we need to ensure we select the necessary fields in the result. One good strategy can be to simply ask for any fields that might have been affected by the mutation. Alternatively, you can use fragments to share the fields between a query and a mutation that updates that query.\n\n## Server\n\nFinally we're going to create our mutations in the server:\n\n[{]: <helper> (diffStep \"3.1\" module=\"server\")\n\n#### [Step 3.1: Add mutations](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/db205b7)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,6 +1,7 @@\n ┊1┊1┊import { IResolvers } from 'apollo-server-express';\n-┊2┊ ┊import { Chat, db, Message, Recipient, User } from \"../db\";\n+┊ ┊2┊import { Chat, db, Message, MessageType, Recipient, User } from \"../db\";\n ┊3┊3┊import { ChatQueryArgs } from \"../types\";\n+┊ ┊4┊import * as moment from \"moment\";\n ┊4┊5┊\n ┊5┊6┊let users = db.users;\n ┊6┊7┊let chats = db.chats;\n```\n```diff\n@@ -13,6 +14,276 @@\n ┊ 13┊ 14┊    chats: (): Chat[] => chats.filter(chat => chat.listingMemberIds.includes(currentUser)),\n ┊ 14┊ 15┊    chat: (obj: any, {chatId}: ChatQueryArgs): Chat | null => chats.find(chat => chat.id === Number(chatId)) || null,\n ┊ 15┊ 16┊  },\n+┊   ┊ 17┊  Mutation: {\n+┊   ┊ 18┊    addChat: (obj: any, {recipientId}: any): Chat => {\n+┊   ┊ 19┊      if (!users.find(user => user.id === recipientId)) {\n+┊   ┊ 20┊        throw new Error(`Recipient ${recipientId} doesn't exist.`);\n+┊   ┊ 21┊      }\n+┊   ┊ 22┊\n+┊   ┊ 23┊      const chat = chats.find(chat => !chat.name && chat.allTimeMemberIds.includes(currentUser) && chat.allTimeMemberIds.includes(recipientId));\n+┊   ┊ 24┊      if (chat) {\n+┊   ┊ 25┊        // Chat already exists. Both users are already in the allTimeMemberIds array\n+┊   ┊ 26┊        const chatId = chat.id;\n+┊   ┊ 27┊        if (!chat.listingMemberIds.includes(currentUser)) {\n+┊   ┊ 28┊          // The chat isn't listed for the current user. Add him to the memberIds\n+┊   ┊ 29┊          chat.listingMemberIds.push(currentUser);\n+┊   ┊ 30┊          chats.find(chat => chat.id === chatId)!.listingMemberIds.push(currentUser);\n+┊   ┊ 31┊          return chat;\n+┊   ┊ 32┊        } else {\n+┊   ┊ 33┊          throw new Error(`Chat already exists.`);\n+┊   ┊ 34┊        }\n+┊   ┊ 35┊      } else {\n+┊   ┊ 36┊        // Create the chat\n+┊   ┊ 37┊        const id = (chats.length && chats[chats.length - 1].id + 1) || 1;\n+┊   ┊ 38┊        const chat: Chat = {\n+┊   ┊ 39┊          id,\n+┊   ┊ 40┊          name: null,\n+┊   ┊ 41┊          picture: null,\n+┊   ┊ 42┊          adminIds: null,\n+┊   ┊ 43┊          ownerId: null,\n+┊   ┊ 44┊          allTimeMemberIds: [currentUser, recipientId],\n+┊   ┊ 45┊          // Chat will not be listed to the other user until the first message gets written\n+┊   ┊ 46┊          listingMemberIds: [currentUser],\n+┊   ┊ 47┊          actualGroupMemberIds: null,\n+┊   ┊ 48┊          messages: [],\n+┊   ┊ 49┊        };\n+┊   ┊ 50┊        chats.push(chat);\n+┊   ┊ 51┊        return chat;\n+┊   ┊ 52┊      }\n+┊   ┊ 53┊    },\n+┊   ┊ 54┊    addGroup: (obj: any, {recipientIds, groupName}: any): Chat => {\n+┊   ┊ 55┊      recipientIds.forEach((recipientId: any) => {\n+┊   ┊ 56┊        if (!users.find(user => user.id === recipientId)) {\n+┊   ┊ 57┊          throw new Error(`Recipient ${recipientId} doesn't exist.`);\n+┊   ┊ 58┊        }\n+┊   ┊ 59┊      });\n+┊   ┊ 60┊\n+┊   ┊ 61┊      const id = (chats.length && chats[chats.length - 1].id + 1) || 1;\n+┊   ┊ 62┊      const chat: Chat = {\n+┊   ┊ 63┊        id,\n+┊   ┊ 64┊        name: groupName,\n+┊   ┊ 65┊        picture: null,\n+┊   ┊ 66┊        adminIds: [currentUser],\n+┊   ┊ 67┊        ownerId: currentUser,\n+┊   ┊ 68┊        allTimeMemberIds: [currentUser, ...recipientIds],\n+┊   ┊ 69┊        listingMemberIds: [currentUser, ...recipientIds],\n+┊   ┊ 70┊        actualGroupMemberIds: [currentUser, ...recipientIds],\n+┊   ┊ 71┊        messages: [],\n+┊   ┊ 72┊      };\n+┊   ┊ 73┊      chats.push(chat);\n+┊   ┊ 74┊      return chat;\n+┊   ┊ 75┊    },\n+┊   ┊ 76┊    removeChat: (obj: any, {chatId}: any): number => {\n+┊   ┊ 77┊      const chat = chats.find(chat => chat.id === chatId);\n+┊   ┊ 78┊\n+┊   ┊ 79┊      if (!chat) {\n+┊   ┊ 80┊        throw new Error(`The chat ${chatId} doesn't exist.`);\n+┊   ┊ 81┊      }\n+┊   ┊ 82┊\n+┊   ┊ 83┊      if (!chat.name) {\n+┊   ┊ 84┊        // Chat\n+┊   ┊ 85┊        if (!chat.listingMemberIds.includes(currentUser)) {\n+┊   ┊ 86┊          throw new Error(`The user is not a member of the chat ${chatId}.`);\n+┊   ┊ 87┊        }\n+┊   ┊ 88┊\n+┊   ┊ 89┊        // Instead of chaining map and filter we can loop once using reduce\n+┊   ┊ 90┊        const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n+┊   ┊ 91┊          // Remove the current user from the message holders\n+┊   ┊ 92┊          message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser);\n+┊   ┊ 93┊\n+┊   ┊ 94┊          if (message.holderIds.length !== 0) {\n+┊   ┊ 95┊            filtered.push(message);\n+┊   ┊ 96┊          } // else discard the message\n+┊   ┊ 97┊\n+┊   ┊ 98┊          return filtered;\n+┊   ┊ 99┊        }, []);\n+┊   ┊100┊\n+┊   ┊101┊        // Remove the current user from who gets the chat listed. The chat will no longer appear in his list\n+┊   ┊102┊        const listingMemberIds = chat.listingMemberIds.filter(listingId => listingId !== currentUser);\n+┊   ┊103┊\n+┊   ┊104┊        // Check how many members are left\n+┊   ┊105┊        if (listingMemberIds.length === 0) {\n+┊   ┊106┊          // Delete the chat\n+┊   ┊107┊          chats = chats.filter(chat => chat.id !== chatId);\n+┊   ┊108┊        } else {\n+┊   ┊109┊          // Update the chat\n+┊   ┊110┊          chats = chats.map(chat => {\n+┊   ┊111┊            if (chat.id === chatId) {\n+┊   ┊112┊              chat = {...chat, listingMemberIds, messages};\n+┊   ┊113┊            }\n+┊   ┊114┊            return chat;\n+┊   ┊115┊          });\n+┊   ┊116┊        }\n+┊   ┊117┊        return chatId;\n+┊   ┊118┊      } else {\n+┊   ┊119┊        // Group\n+┊   ┊120┊        if (chat.ownerId !== currentUser) {\n+┊   ┊121┊          throw new Error(`Group ${chatId} is not owned by the user.`);\n+┊   ┊122┊        }\n+┊   ┊123┊\n+┊   ┊124┊        // Instead of chaining map and filter we can loop once using reduce\n+┊   ┊125┊        const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n+┊   ┊126┊          // Remove the current user from the message holders\n+┊   ┊127┊          message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser);\n+┊   ┊128┊\n+┊   ┊129┊          if (message.holderIds.length !== 0) {\n+┊   ┊130┊            filtered.push(message);\n+┊   ┊131┊          } // else discard the message\n+┊   ┊132┊\n+┊   ┊133┊          return filtered;\n+┊   ┊134┊        }, []);\n+┊   ┊135┊\n+┊   ┊136┊        // Remove the current user from who gets the group listed. The group will no longer appear in his list\n+┊   ┊137┊        const listingMemberIds = chat.listingMemberIds.filter(listingId => listingId !== currentUser);\n+┊   ┊138┊\n+┊   ┊139┊        // Check how many members (including previous ones who can still access old messages) are left\n+┊   ┊140┊        if (listingMemberIds.length === 0) {\n+┊   ┊141┊          // Remove the group\n+┊   ┊142┊          chats = chats.filter(chat => chat.id !== chatId);\n+┊   ┊143┊        } else {\n+┊   ┊144┊          // Update the group\n+┊   ┊145┊\n+┊   ┊146┊          // Remove the current user from the chat members. He is no longer a member of the group\n+┊   ┊147┊          const actualGroupMemberIds = chat.actualGroupMemberIds!.filter(memberId => memberId !== currentUser);\n+┊   ┊148┊          // Remove the current user from the chat admins\n+┊   ┊149┊          const adminIds = chat.adminIds!.filter(memberId => memberId !== currentUser);\n+┊   ┊150┊          // Set the owner id to be null. A null owner means the group is read-only\n+┊   ┊151┊          let ownerId: number | null = null;\n+┊   ┊152┊\n+┊   ┊153┊          // Check if there is any admin left\n+┊   ┊154┊          if (adminIds!.length) {\n+┊   ┊155┊            // Pick an admin as the new owner. The group is no longer read-only\n+┊   ┊156┊            ownerId = chat.adminIds![0];\n+┊   ┊157┊          }\n+┊   ┊158┊\n+┊   ┊159┊          chats = chats.map(chat => {\n+┊   ┊160┊            if (chat.id === chatId) {\n+┊   ┊161┊              chat = {...chat, messages, listingMemberIds, actualGroupMemberIds, adminIds, ownerId};\n+┊   ┊162┊            }\n+┊   ┊163┊            return chat;\n+┊   ┊164┊          });\n+┊   ┊165┊        }\n+┊   ┊166┊        return chatId;\n+┊   ┊167┊      }\n+┊   ┊168┊    },\n+┊   ┊169┊    addMessage: (obj: any, {chatId, content}: any): Message => {\n+┊   ┊170┊      if (content === null || content === '') {\n+┊   ┊171┊        throw new Error(`Cannot add empty or null messages.`);\n+┊   ┊172┊      }\n+┊   ┊173┊\n+┊   ┊174┊      let chat = chats.find(chat => chat.id === chatId);\n+┊   ┊175┊\n+┊   ┊176┊      if (!chat) {\n+┊   ┊177┊        throw new Error(`Cannot find chat ${chatId}.`);\n+┊   ┊178┊      }\n+┊   ┊179┊\n+┊   ┊180┊      let holderIds = chat.listingMemberIds;\n+┊   ┊181┊\n+┊   ┊182┊      if (!chat.name) {\n+┊   ┊183┊        // Chat\n+┊   ┊184┊        if (!chat.listingMemberIds.find(listingId => listingId === currentUser)) {\n+┊   ┊185┊          throw new Error(`The chat ${chatId} must be listed for the current user before adding a message.`);\n+┊   ┊186┊        }\n+┊   ┊187┊\n+┊   ┊188┊        const recipientId = chat.allTimeMemberIds.filter(userId => userId !== currentUser)[0];\n+┊   ┊189┊\n+┊   ┊190┊        if (!chat.listingMemberIds.find(listingId => listingId === recipientId)) {\n+┊   ┊191┊          // Chat is not listed for the recipient. Add him to the listingMemberIds\n+┊   ┊192┊          const listingMemberIds = chat.listingMemberIds.concat(recipientId);\n+┊   ┊193┊\n+┊   ┊194┊          chats = chats.map(chat => {\n+┊   ┊195┊            if (chat.id === chatId) {\n+┊   ┊196┊              chat = {...chat, listingMemberIds};\n+┊   ┊197┊            }\n+┊   ┊198┊            return chat;\n+┊   ┊199┊          });\n+┊   ┊200┊\n+┊   ┊201┊          holderIds = listingMemberIds;\n+┊   ┊202┊        }\n+┊   ┊203┊      } else {\n+┊   ┊204┊        // Group\n+┊   ┊205┊        if (!chat.actualGroupMemberIds!.find(memberId => memberId === currentUser)) {\n+┊   ┊206┊          throw new Error(`The user is not a member of the group ${chatId}. Cannot add message.`);\n+┊   ┊207┊        }\n+┊   ┊208┊\n+┊   ┊209┊        holderIds = chat.actualGroupMemberIds!;\n+┊   ┊210┊      }\n+┊   ┊211┊\n+┊   ┊212┊      const id = (chat.messages.length && chat.messages[chat.messages.length - 1].id + 1) || 1;\n+┊   ┊213┊\n+┊   ┊214┊      let recipients: Recipient[] = [];\n+┊   ┊215┊\n+┊   ┊216┊      holderIds.forEach(holderId => {\n+┊   ┊217┊        if (holderId !== currentUser) {\n+┊   ┊218┊          recipients.push({\n+┊   ┊219┊            userId: holderId,\n+┊   ┊220┊            messageId: id,\n+┊   ┊221┊            chatId: chatId,\n+┊   ┊222┊            receivedAt: null,\n+┊   ┊223┊            readAt: null,\n+┊   ┊224┊          });\n+┊   ┊225┊        }\n+┊   ┊226┊      });\n+┊   ┊227┊\n+┊   ┊228┊      const message: Message = {\n+┊   ┊229┊        id,\n+┊   ┊230┊        chatId,\n+┊   ┊231┊        senderId: currentUser,\n+┊   ┊232┊        content,\n+┊   ┊233┊        createdAt: moment().unix(),\n+┊   ┊234┊        type: MessageType.TEXT,\n+┊   ┊235┊        recipients,\n+┊   ┊236┊        holderIds,\n+┊   ┊237┊      };\n+┊   ┊238┊\n+┊   ┊239┊      chats = chats.map(chat => {\n+┊   ┊240┊        if (chat.id === chatId) {\n+┊   ┊241┊          chat = {...chat, messages: chat.messages.concat(message)}\n+┊   ┊242┊        }\n+┊   ┊243┊        return chat;\n+┊   ┊244┊      });\n+┊   ┊245┊\n+┊   ┊246┊      return message;\n+┊   ┊247┊    },\n+┊   ┊248┊    removeMessages: (obj: any, {chatId, messageIds, all}: any): number[] => {\n+┊   ┊249┊      const chat = chats.find(chat => chat.id === chatId);\n+┊   ┊250┊\n+┊   ┊251┊      if (!chat) {\n+┊   ┊252┊        throw new Error(`Cannot find chat ${chatId}.`);\n+┊   ┊253┊      }\n+┊   ┊254┊\n+┊   ┊255┊      if (!chat.listingMemberIds.find(listingId => listingId === currentUser)) {\n+┊   ┊256┊        throw new Error(`The chat/group ${chatId} is not listed for the current user, so there is nothing to delete.`);\n+┊   ┊257┊      }\n+┊   ┊258┊\n+┊   ┊259┊      if (all && messageIds) {\n+┊   ┊260┊        throw new Error(`Cannot specify both 'all' and 'messageIds'.`);\n+┊   ┊261┊      }\n+┊   ┊262┊\n+┊   ┊263┊      let deletedIds: number[] = [];\n+┊   ┊264┊      chats = chats.map(chat => {\n+┊   ┊265┊        if (chat.id === chatId) {\n+┊   ┊266┊          // Instead of chaining map and filter we can loop once using reduce\n+┊   ┊267┊          const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n+┊   ┊268┊            if (all || messageIds!.includes(message.id)) {\n+┊   ┊269┊              deletedIds.push(message.id);\n+┊   ┊270┊              // Remove the current user from the message holders\n+┊   ┊271┊              message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser);\n+┊   ┊272┊            }\n+┊   ┊273┊\n+┊   ┊274┊            if (message.holderIds.length !== 0) {\n+┊   ┊275┊              filtered.push(message);\n+┊   ┊276┊            } // else discard the message\n+┊   ┊277┊\n+┊   ┊278┊            return filtered;\n+┊   ┊279┊          }, []);\n+┊   ┊280┊          chat = {...chat, messages};\n+┊   ┊281┊        }\n+┊   ┊282┊        return chat;\n+┊   ┊283┊      });\n+┊   ┊284┊      return deletedIds;\n+┊   ┊285┊    },\n+┊   ┊286┊  },\n ┊ 16┊287┊  Chat: {\n ┊ 17┊288┊    name: (chat: Chat): string => chat.name ? chat.name : users\n ┊ 18┊289┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser))!.name,\n```\n\n##### Changed schema&#x2F;typeDefs.ts\n```diff\n@@ -65,4 +65,20 @@\n ┊65┊65┊    picture: String\n ┊66┊66┊    phone: String\n ┊67┊67┊  }\n+┊  ┊68┊\n+┊  ┊69┊  type Mutation {\n+┊  ┊70┊    addChat(recipientId: ID!): Chat\n+┊  ┊71┊    addGroup(recipientIds: [ID!]!, groupName: String!): Chat\n+┊  ┊72┊    removeChat(chatId: ID!): ID\n+┊  ┊73┊    addMessage(chatId: ID!, content: String!): Message\n+┊  ┊74┊    removeMessages(chatId: ID!, messageIds: [ID], all: Boolean): [ID]\n+┊  ┊75┊    addMembers(groupId: ID!, userIds: [ID!]!): [ID]\n+┊  ┊76┊    removeMembers(groupId: ID!, userIds: [ID!]!): [ID]\n+┊  ┊77┊    addAdmins(groupId: ID!, userIds: [ID!]!): [ID]\n+┊  ┊78┊    removeAdmins(groupId: ID!, userIds: [ID!]!): [ID]\n+┊  ┊79┊    setGroupName(groupId: ID!): String\n+┊  ┊80┊    setGroupPicture(groupId: ID!): String\n+┊  ┊81┊    markAsReceived(chatId: ID!): Boolean\n+┊  ┊82┊    markAsRead(chatId: ID!): Boolean\n+┊  ┊83┊  }\n ┊68┊84┊`;\n```\n\n[}]: #\n\nLet me briefly explain what's going on here.\nFor each chat/group we store the `allTimeMemberIds`, `listingMemberIds` and `actualGroupMemberIds` properties in our NoSQL-like fake db.\nWhat's the difference between `allTimeMemberIds` and `listingMemberIds`? When a chat gets created only the user who created it will be able too see it, the chat will be displayed to the other user only once the first messaged gets sent. `allTimeMemberIds` is an array which always contain both the users, while `listingMemberIds` contains only the users which get the chat listed (initially the creator, later both users). `actualGroupMemberIds` is only used for groups.\nGroups, instead, get listed by all members immediately since the creation. So initially both `allTimeMemberIds`, `listingMemberIds` and `actualGroupMemberIds` are similar. Later users can leave the group or get deleted (so they will be removed from `actualGroupMemberIds`) but they will still be able to list the group in read-only mode, thus remaining in the `listingMemberIds`. Once they remove the group they will also be remove from the `listingMemberIds` array.\nThat's why we have to check for several different conditions before adding/deleting messages: it could be necessary to add the other peer to the `listingMemberIds` (for example if we are writing the first message of a chat) or it could be necessary to physically remove the messages instead of simply removing the current user from the `holderIds`. `holderIds` is a field in each message which states which user will currently display that specific message. In fact each user can delete a specific message without affecting what the others will see. Once there will be no more users in the `holderIds` array it will be safe to delete the message.\nEach message has also a `recipients` array containing the receiving date and the viewing date of that particular message for all the other users. That's necessary to implement the single, double and blue ticks used by the real Whatsapp.\n\nIt may seem a bit overwhelming at first, but you should keep in mind that the real Whatsapp has tons of features and also takes advantage of a local database to store messages, so it's easier for them to implement features like per-user messages: their source of truth is not the server because once downloaded the messages are kept in the client itself, so deleting messages doesn't affect anyone else. On the contrary our source of truth is the server, so our approach is more similar to Telegram instead. This is a better approach in my opinion because it allows us to show the messages for the same user on multiple clients, instead of having to rely on questionable approaches like Whatsapp Web.\nAlso we already implemented our mutations to take care of future use cases (like reading notifications) which we still didn't implement.\n\nI said we were going to take greater advantage of `graphql-code-generator` once we started writing our first mutation and I'm going to show you why. Let's run the generator first:\n\n    yarn generator\n\nThen let's use the generated types:\n\n[{]: <helper> (diffStep \"3.3\" module=\"server\")\n\n#### [Step 3.3: Use generated types](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/b7b1be3)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,6 +1,9 @@\n ┊1┊1┊import { IResolvers } from 'apollo-server-express';\n ┊2┊2┊import { Chat, db, Message, MessageType, Recipient, User } from \"../db\";\n-┊3┊ ┊import { ChatQueryArgs } from \"../types\";\n+┊ ┊3┊import {\n+┊ ┊4┊  AddChatMutationArgs, AddGroupMutationArgs, AddMessageMutationArgs, ChatQueryArgs,\n+┊ ┊5┊  RemoveChatMutationArgs, RemoveMessagesMutationArgs\n+┊ ┊6┊} from \"../types\";\n ┊4┊7┊import * as moment from \"moment\";\n ┊5┊8┊\n ┊6┊9┊let users = db.users;\n```\n```diff\n@@ -15,12 +18,12 @@\n ┊15┊18┊    chat: (obj: any, {chatId}: ChatQueryArgs): Chat | null => chats.find(chat => chat.id === Number(chatId)) || null,\n ┊16┊19┊  },\n ┊17┊20┊  Mutation: {\n-┊18┊  ┊    addChat: (obj: any, {recipientId}: any): Chat => {\n-┊19┊  ┊      if (!users.find(user => user.id === recipientId)) {\n+┊  ┊21┊    addChat: (obj: any, {recipientId}: AddChatMutationArgs): Chat => {\n+┊  ┊22┊      if (!users.find(user => user.id === Number(recipientId))) {\n ┊20┊23┊        throw new Error(`Recipient ${recipientId} doesn't exist.`);\n ┊21┊24┊      }\n ┊22┊25┊\n-┊23┊  ┊      const chat = chats.find(chat => !chat.name && chat.allTimeMemberIds.includes(currentUser) && chat.allTimeMemberIds.includes(recipientId));\n+┊  ┊26┊      const chat = chats.find(chat => !chat.name && chat.allTimeMemberIds.includes(currentUser) && chat.allTimeMemberIds.includes(Number(recipientId)));\n ┊24┊27┊      if (chat) {\n ┊25┊28┊        // Chat already exists. Both users are already in the allTimeMemberIds array\n ┊26┊29┊        const chatId = chat.id;\n```\n```diff\n@@ -41,7 +44,7 @@\n ┊41┊44┊          picture: null,\n ┊42┊45┊          adminIds: null,\n ┊43┊46┊          ownerId: null,\n-┊44┊  ┊          allTimeMemberIds: [currentUser, recipientId],\n+┊  ┊47┊          allTimeMemberIds: [currentUser, Number(recipientId)],\n ┊45┊48┊          // Chat will not be listed to the other user until the first message gets written\n ┊46┊49┊          listingMemberIds: [currentUser],\n ┊47┊50┊          actualGroupMemberIds: null,\n```\n```diff\n@@ -51,9 +54,9 @@\n ┊51┊54┊        return chat;\n ┊52┊55┊      }\n ┊53┊56┊    },\n-┊54┊  ┊    addGroup: (obj: any, {recipientIds, groupName}: any): Chat => {\n-┊55┊  ┊      recipientIds.forEach((recipientId: any) => {\n-┊56┊  ┊        if (!users.find(user => user.id === recipientId)) {\n+┊  ┊57┊    addGroup: (obj: any, {recipientIds, groupName}: AddGroupMutationArgs): Chat => {\n+┊  ┊58┊      recipientIds.forEach(recipientId => {\n+┊  ┊59┊        if (!users.find(user => user.id === Number(recipientId))) {\n ┊57┊60┊          throw new Error(`Recipient ${recipientId} doesn't exist.`);\n ┊58┊61┊        }\n ┊59┊62┊      });\n```\n```diff\n@@ -65,16 +68,16 @@\n ┊65┊68┊        picture: null,\n ┊66┊69┊        adminIds: [currentUser],\n ┊67┊70┊        ownerId: currentUser,\n-┊68┊  ┊        allTimeMemberIds: [currentUser, ...recipientIds],\n-┊69┊  ┊        listingMemberIds: [currentUser, ...recipientIds],\n-┊70┊  ┊        actualGroupMemberIds: [currentUser, ...recipientIds],\n+┊  ┊71┊        allTimeMemberIds: [currentUser, ...recipientIds.map(id => Number(id))],\n+┊  ┊72┊        listingMemberIds: [currentUser, ...recipientIds.map(id => Number(id))],\n+┊  ┊73┊        actualGroupMemberIds: [currentUser, ...recipientIds.map(id => Number(id))],\n ┊71┊74┊        messages: [],\n ┊72┊75┊      };\n ┊73┊76┊      chats.push(chat);\n ┊74┊77┊      return chat;\n ┊75┊78┊    },\n-┊76┊  ┊    removeChat: (obj: any, {chatId}: any): number => {\n-┊77┊  ┊      const chat = chats.find(chat => chat.id === chatId);\n+┊  ┊79┊    removeChat: (obj: any, {chatId}: RemoveChatMutationArgs): number => {\n+┊  ┊80┊      const chat = chats.find(chat => chat.id === Number(chatId));\n ┊78┊81┊\n ┊79┊82┊      if (!chat) {\n ┊80┊83┊        throw new Error(`The chat ${chatId} doesn't exist.`);\n```\n```diff\n@@ -104,17 +107,17 @@\n ┊104┊107┊        // Check how many members are left\n ┊105┊108┊        if (listingMemberIds.length === 0) {\n ┊106┊109┊          // Delete the chat\n-┊107┊   ┊          chats = chats.filter(chat => chat.id !== chatId);\n+┊   ┊110┊          chats = chats.filter(chat => chat.id !== Number(chatId));\n ┊108┊111┊        } else {\n ┊109┊112┊          // Update the chat\n ┊110┊113┊          chats = chats.map(chat => {\n-┊111┊   ┊            if (chat.id === chatId) {\n+┊   ┊114┊            if (chat.id === Number(chatId)) {\n ┊112┊115┊              chat = {...chat, listingMemberIds, messages};\n ┊113┊116┊            }\n ┊114┊117┊            return chat;\n ┊115┊118┊          });\n ┊116┊119┊        }\n-┊117┊   ┊        return chatId;\n+┊   ┊120┊        return Number(chatId);\n ┊118┊121┊      } else {\n ┊119┊122┊        // Group\n ┊120┊123┊        if (chat.ownerId !== currentUser) {\n```\n```diff\n@@ -139,7 +142,7 @@\n ┊139┊142┊        // Check how many members (including previous ones who can still access old messages) are left\n ┊140┊143┊        if (listingMemberIds.length === 0) {\n ┊141┊144┊          // Remove the group\n-┊142┊   ┊          chats = chats.filter(chat => chat.id !== chatId);\n+┊   ┊145┊          chats = chats.filter(chat => chat.id !== Number(chatId));\n ┊143┊146┊        } else {\n ┊144┊147┊          // Update the group\n ┊145┊148┊\n```\n```diff\n@@ -157,21 +160,21 @@\n ┊157┊160┊          }\n ┊158┊161┊\n ┊159┊162┊          chats = chats.map(chat => {\n-┊160┊   ┊            if (chat.id === chatId) {\n+┊   ┊163┊            if (chat.id === Number(chatId)) {\n ┊161┊164┊              chat = {...chat, messages, listingMemberIds, actualGroupMemberIds, adminIds, ownerId};\n ┊162┊165┊            }\n ┊163┊166┊            return chat;\n ┊164┊167┊          });\n ┊165┊168┊        }\n-┊166┊   ┊        return chatId;\n+┊   ┊169┊        return Number(chatId);\n ┊167┊170┊      }\n ┊168┊171┊    },\n-┊169┊   ┊    addMessage: (obj: any, {chatId, content}: any): Message => {\n+┊   ┊172┊    addMessage: (obj: any, {chatId, content}: AddMessageMutationArgs): Message => {\n ┊170┊173┊      if (content === null || content === '') {\n ┊171┊174┊        throw new Error(`Cannot add empty or null messages.`);\n ┊172┊175┊      }\n ┊173┊176┊\n-┊174┊   ┊      let chat = chats.find(chat => chat.id === chatId);\n+┊   ┊177┊      let chat = chats.find(chat => chat.id === Number(chatId));\n ┊175┊178┊\n ┊176┊179┊      if (!chat) {\n ┊177┊180┊        throw new Error(`Cannot find chat ${chatId}.`);\n```\n```diff\n@@ -192,7 +195,7 @@\n ┊192┊195┊          const listingMemberIds = chat.listingMemberIds.concat(recipientId);\n ┊193┊196┊\n ┊194┊197┊          chats = chats.map(chat => {\n-┊195┊   ┊            if (chat.id === chatId) {\n+┊   ┊198┊            if (chat.id === Number(chatId)) {\n ┊196┊199┊              chat = {...chat, listingMemberIds};\n ┊197┊200┊            }\n ┊198┊201┊            return chat;\n```\n```diff\n@@ -218,7 +221,7 @@\n ┊218┊221┊          recipients.push({\n ┊219┊222┊            userId: holderId,\n ┊220┊223┊            messageId: id,\n-┊221┊   ┊            chatId: chatId,\n+┊   ┊224┊            chatId: Number(chatId),\n ┊222┊225┊            receivedAt: null,\n ┊223┊226┊            readAt: null,\n ┊224┊227┊          });\n```\n```diff\n@@ -227,7 +230,7 @@\n ┊227┊230┊\n ┊228┊231┊      const message: Message = {\n ┊229┊232┊        id,\n-┊230┊   ┊        chatId,\n+┊   ┊233┊        chatId: Number(chatId),\n ┊231┊234┊        senderId: currentUser,\n ┊232┊235┊        content,\n ┊233┊236┊        createdAt: moment().unix(),\n```\n```diff\n@@ -237,7 +240,7 @@\n ┊237┊240┊      };\n ┊238┊241┊\n ┊239┊242┊      chats = chats.map(chat => {\n-┊240┊   ┊        if (chat.id === chatId) {\n+┊   ┊243┊        if (chat.id === Number(chatId)) {\n ┊241┊244┊          chat = {...chat, messages: chat.messages.concat(message)}\n ┊242┊245┊        }\n ┊243┊246┊        return chat;\n```\n```diff\n@@ -245,8 +248,8 @@\n ┊245┊248┊\n ┊246┊249┊      return message;\n ┊247┊250┊    },\n-┊248┊   ┊    removeMessages: (obj: any, {chatId, messageIds, all}: any): number[] => {\n-┊249┊   ┊      const chat = chats.find(chat => chat.id === chatId);\n+┊   ┊251┊    removeMessages: (obj: any, {chatId, messageIds, all}: RemoveMessagesMutationArgs): number[] => {\n+┊   ┊252┊      const chat = chats.find(chat => chat.id === Number(chatId));\n ┊250┊253┊\n ┊251┊254┊      if (!chat) {\n ┊252┊255┊        throw new Error(`Cannot find chat ${chatId}.`);\n```\n```diff\n@@ -262,10 +265,10 @@\n ┊262┊265┊\n ┊263┊266┊      let deletedIds: number[] = [];\n ┊264┊267┊      chats = chats.map(chat => {\n-┊265┊   ┊        if (chat.id === chatId) {\n+┊   ┊268┊        if (chat.id === Number(chatId)) {\n ┊266┊269┊          // Instead of chaining map and filter we can loop once using reduce\n ┊267┊270┊          const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n-┊268┊   ┊            if (all || messageIds!.includes(message.id)) {\n+┊   ┊271┊            if (all || messageIds!.includes(String(message.id))) {\n ┊269┊272┊              deletedIds.push(message.id);\n ┊270┊273┊              // Remove the current user from the message holders\n ┊271┊274┊              message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser);\n```\n\n[}]: #\n\n## Client\n\nFor the client I'll only show you how to make use of the addMessage mutation in this chapters. The other mutations will require much more boilerplate so I left them for their own chapter.\n\nLet's start by wiring the addMessage mutation. We're going to write the GraphQL query and then use the generator to generate the types:\n\n[{]: <helper> (diffStep \"5.1\" files=\"^\\(?!src/types.d.ts$\\).*\" module=\"client\")\n\n#### [Step 5.1: Create addMessage mutation and generate types](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/706d62e)\n\n##### Changed src&#x2F;graphql.ts\n```diff\n@@ -600,6 +600,20 @@\n ┊600┊600┊  > = Resolver<R, Parent, Context>;\n ┊601┊601┊}\n ┊602┊602┊\n+┊   ┊603┊export namespace AddMessage {\n+┊   ┊604┊  export type Variables = {\n+┊   ┊605┊    chatId: string;\n+┊   ┊606┊    content: string;\n+┊   ┊607┊  };\n+┊   ┊608┊\n+┊   ┊609┊  export type Mutation = {\n+┊   ┊610┊    __typename?: \"Mutation\";\n+┊   ┊611┊    addMessage?: AddMessage | null;\n+┊   ┊612┊  };\n+┊   ┊613┊\n+┊   ┊614┊  export type AddMessage = Message.Fragment;\n+┊   ┊615┊}\n+┊   ┊616┊\n ┊603┊617┊export namespace GetChat {\n ┊604┊618┊  export type Variables = {\n ┊605┊619┊    chatId: string;\n```\n```diff\n@@ -760,6 +774,23 @@\n ┊760┊774┊  }\n ┊761┊775┊`;\n ┊762┊776┊\n+┊   ┊777┊@Injectable({\n+┊   ┊778┊  providedIn: \"root\"\n+┊   ┊779┊})\n+┊   ┊780┊export class AddMessageGQL extends Apollo.Mutation<\n+┊   ┊781┊  AddMessage.Mutation,\n+┊   ┊782┊  AddMessage.Variables\n+┊   ┊783┊> {\n+┊   ┊784┊  document: any = gql`\n+┊   ┊785┊    mutation AddMessage($chatId: ID!, $content: String!) {\n+┊   ┊786┊      addMessage(chatId: $chatId, content: $content) {\n+┊   ┊787┊        ...Message\n+┊   ┊788┊      }\n+┊   ┊789┊    }\n+┊   ┊790┊\n+┊   ┊791┊    ${MessageFragment}\n+┊   ┊792┊  `;\n+┊   ┊793┊}\n ┊763┊794┊@Injectable({\n ┊764┊795┊  providedIn: \"root\"\n ┊765┊796┊})\n```\n\n##### Added src&#x2F;graphql&#x2F;addMessage.mutation.ts\n```diff\n@@ -0,0 +1,13 @@\n+┊  ┊ 1┊import gql from 'graphql-tag';\n+┊  ┊ 2┊import {fragments} from './fragment';\n+┊  ┊ 3┊\n+┊  ┊ 4┊// We use the gql tag to parse our query string into a query document\n+┊  ┊ 5┊export const addMessageMutation = gql`\n+┊  ┊ 6┊  mutation AddMessage($chatId: ID!, $content: String!) {\n+┊  ┊ 7┊    addMessage(chatId: $chatId, content: $content) {\n+┊  ┊ 8┊      ...Message\n+┊  ┊ 9┊    }\n+┊  ┊10┊  }\n+┊  ┊11┊\n+┊  ┊12┊  ${fragments['message']}\n+┊  ┊13┊`;\n```\n\n[}]: #\n\nRun the generator:\n\n    yarn generator\n\nNow let's use the just-created query:\n\n[{]: <helper> (diffStep \"5.2\" module=\"client\")\n\n#### [Step 5.2: Modify chat component and service](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/ad6a5da)\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.ts\n```diff\n@@ -14,7 +14,7 @@\n ┊14┊14┊    </app-toolbar>\n ┊15┊15┊    <div class=\"container\">\n ┊16┊16┊      <app-messages-list [items]=\"messages\" [isGroup]=\"isGroup\"></app-messages-list>\n-┊17┊  ┊      <app-new-message></app-new-message>\n+┊  ┊17┊      <app-new-message (newMessage)=\"addMessage($event)\"></app-new-message>\n ┊18┊18┊    </div>\n ┊19┊19┊  `,\n ┊20┊20┊  styleUrls: ['./chat.component.scss']\n```\n```diff\n@@ -44,4 +44,8 @@\n ┊44┊44┊  goToChats() {\n ┊45┊45┊    this.router.navigate(['/chats']);\n ┊46┊46┊  }\n+┊  ┊47┊\n+┊  ┊48┊  addMessage(content: string) {\n+┊  ┊49┊    this.chatsService.addMessage(this.chatId, content).subscribe();\n+┊  ┊50┊  }\n ┊47┊51┊}\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,6 +1,6 @@\n ┊1┊1┊import {map} from 'rxjs/operators';\n ┊2┊2┊import {Injectable} from '@angular/core';\n-┊3┊ ┊import {GetChatsGQL, GetChatGQL} from '../../graphql';\n+┊ ┊3┊import {GetChatsGQL, GetChatGQL, AddMessageGQL} from '../../graphql';\n ┊4┊4┊\n ┊5┊5┊@Injectable()\n ┊6┊6┊export class ChatsService {\n```\n```diff\n@@ -8,7 +8,8 @@\n ┊ 8┊ 8┊\n ┊ 9┊ 9┊  constructor(\n ┊10┊10┊    private getChatsGQL: GetChatsGQL,\n-┊11┊  ┊    private getChatGQL: GetChatGQL\n+┊  ┊11┊    private getChatGQL: GetChatGQL,\n+┊  ┊12┊    private addMessageGQL: AddMessageGQL\n ┊12┊13┊  ) {}\n ┊13┊14┊\n ┊14┊15┊  getChats() {\n```\n```diff\n@@ -33,4 +34,11 @@\n ┊33┊34┊\n ┊34┊35┊    return {query, chat$};\n ┊35┊36┊  }\n+┊  ┊37┊\n+┊  ┊38┊  addMessage(chatId: string, content: string) {\n+┊  ┊39┊    return this.addMessageGQL.mutate({\n+┊  ┊40┊      chatId,\n+┊  ┊41┊      content,\n+┊  ┊42┊    });\n+┊  ┊43┊  }\n ┊36┊44┊}\n```\n\n[}]: #\n\nIt's that simple! You would be tempted to say that it doesn't work, but you should try to refresh the page first ;)"
          },
          {
            "manualTitle": "Step 10: Updating the store",
            "stepRevision": "04749f21bfdeecb76145491e1d4d373102ad8969",
            "manualView": "## Client\n\nDid you notice that after creating a new message you'll have to refresh the page in order to see it?\n\nHow to fix that?\n\nApollo performs two important core tasks which we covered in one of previous steps: executing queries and mutations, and caching the results.\n\nThanks to Apollo's store design, it's possible for the results of a query or mutation to update your UI in all the right places. In many cases it's possible for that to happen automatically, whereas in others you need to help the client out a little in doing so.\n\nThere are couple of APIs to update the cache after mutation:\n\n- `refetchQueries` - is the most straightforward way of updating the cache. You request queries to be executed once again.\n- `update` - super flexible and allows you to make changes to the store based on mutation. Works well with Optimistic UI which we will cover later.\n- `updateQueries` - It works similar to the previous option but the API may be deprecated in the future and we recommend to stay with `update`.\n\nIf you thought about re-querying the server you would be wrong! The best solution is to use the response provided by the server to update our Apollo local cache.\n\nOf course that we're going to use the `update` API!\n\n### Updating the store\n\nAs you can see, the `update` option is a function that has two arguments:\n\n- `DataProxy` which we named `store`\n- mutation's result\n\nThe `DataProxy` seems very interesting! It's a middleman between you and the cache.\n\n#### How to update fragments\n\nIn pretty much every case, that middleman would allow to write and read data. Take for example the JavaScript `Map` object.\n\nIt has a `get` and `set` methods and both works based on a `key`.\n\nIn Apollo, we do have that key, it's something that was covered in the 5th step, remember? An object of type `Message` with an `id` would be stored in the cache as `Message:<id>`.\n\nLet's call that small object a fragment, for simplicity.\n\nWhat are our _get_ and _set_ methods in Apollo's DataProxy? Simple, `readFragment` and `writeFragment`.\n\nI think it's time to work on a simple example. Scenario: every message can be liked and we keep the sum of likes under the `likes` field.\n\nHow to give a like?\n\n```typescript\nconst store: DataProxy = ...;\nconst messageId = 256;\n\nconst fragment = gql`\n  fragment M on Message {\n    likes\n  }\n`;\nconst fragmentId = `Message:${messageId}`;\n\nconst message = store.readFragment({\n  fragment,\n  id: fragmentId\n});\n\nstore.writeFragment({\n  fragment,\n  id: fragmentId,\n  data: {\n    likes: message.likes + 1\n  }\n});\n```\n\nWhat just happened?!\n\nAt first, it might seem weird to talk to the store like that but you will see that it makes a lot of sense!\n\n - `messageId` - defined the actual id of our message\n - `fragment` - it's a document that tells Apollo what fields we want to read and write\n - `fragmentId` - an unique key under which the fragment is stored (we covered that in 5th step)\n - `readFragment` - reads the fragment in the store and returns the result in exact same shape as requested\n - `writeFragment` - accepts same properties as `readFragment` but also the `data` property\n\n### How to update queries\n\nSimilar as in case of fragments, we update queries with `readQuery` and `writeQuery`.\n\nWe won't cover the same thing again but let's just look at the API based on our WhatsApp clone example:\n\n[{]: <helper> (diffStep \"6.1\" module=\"client\")\n\n#### [Step 6.1: Update the store](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/cb01e16)\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,6 +1,13 @@\n ┊ 1┊ 1┊import {map} from 'rxjs/operators';\n ┊ 2┊ 2┊import {Injectable} from '@angular/core';\n-┊ 3┊  ┊import {GetChatsGQL, GetChatGQL, AddMessageGQL} from '../../graphql';\n+┊  ┊ 3┊import {\n+┊  ┊ 4┊  GetChatsGQL,\n+┊  ┊ 5┊  GetChatGQL,\n+┊  ┊ 6┊  AddMessageGQL,\n+┊  ┊ 7┊  AddMessage,\n+┊  ┊ 8┊  GetChats,\n+┊  ┊ 9┊  GetChat\n+┊  ┊10┊} from '../../graphql';\n ┊ 4┊11┊\n ┊ 5┊12┊@Injectable()\n ┊ 6┊13┊export class ChatsService {\n```\n```diff\n@@ -39,6 +46,50 @@\n ┊39┊46┊    return this.addMessageGQL.mutate({\n ┊40┊47┊      chatId,\n ┊41┊48┊      content,\n+┊  ┊49┊    }, {\n+┊  ┊50┊      update: (store, { data: { addMessage } }: {data: AddMessage.Mutation}) => {\n+┊  ┊51┊        // Update the messages cache\n+┊  ┊52┊        {\n+┊  ┊53┊          // Read the data from our cache for this query.\n+┊  ┊54┊          const {chat} = store.readQuery<GetChat.Query, GetChat.Variables>({\n+┊  ┊55┊            query: this.getChatGQL.document,\n+┊  ┊56┊            variables: {\n+┊  ┊57┊              chatId,\n+┊  ┊58┊            }\n+┊  ┊59┊          });\n+┊  ┊60┊          // Add our message from the mutation to the end.\n+┊  ┊61┊          chat.messages.push(addMessage);\n+┊  ┊62┊          // Write our data back to the cache.\n+┊  ┊63┊          store.writeQuery({\n+┊  ┊64┊            query: this.getChatGQL.document,\n+┊  ┊65┊            data: {\n+┊  ┊66┊              chat\n+┊  ┊67┊            }\n+┊  ┊68┊          });\n+┊  ┊69┊        }\n+┊  ┊70┊        // Update last message cache\n+┊  ┊71┊        {\n+┊  ┊72┊          // Read the data from our cache for this query.\n+┊  ┊73┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n+┊  ┊74┊            query: this.getChatsGQL.document,\n+┊  ┊75┊            variables: {\n+┊  ┊76┊              amount: this.messagesAmount,\n+┊  ┊77┊            },\n+┊  ┊78┊          });\n+┊  ┊79┊          // Add our comment from the mutation to the end.\n+┊  ┊80┊          chats.find(chat => chat.id === chatId).messages.push(addMessage);\n+┊  ┊81┊          // Write our data back to the cache.\n+┊  ┊82┊          store.writeQuery<GetChats.Query, GetChats.Variables>({\n+┊  ┊83┊            query: this.getChatsGQL.document,\n+┊  ┊84┊            variables: {\n+┊  ┊85┊              amount: this.messagesAmount,\n+┊  ┊86┊            },\n+┊  ┊87┊            data: {\n+┊  ┊88┊              chats,\n+┊  ┊89┊            },\n+┊  ┊90┊          });\n+┊  ┊91┊        }\n+┊  ┊92┊      }\n ┊42┊93┊    });\n ┊43┊94┊  }\n ┊44┊95┊}\n```\n\n[}]: #\n\nAs you can see we used the `document` property of a generated GQL service. It contains the actual query that is used in every `watch` or `fetch` calls of the GQL service. It's a part of the open API.\n\n### Keep on mind\n\nIt's very important to know few things:\n\n- update function have to run synchronously\n- the query should always match the query you want to update (even order of fields or variables matters)\n- by updating a query you also update every normalized data it has (we called them fragments in few secions above)\n\nWhen Apollo runs the `update` function? In two cases, rigth after the mutation happens but only if it has an optimistic response defined, and also once we get the response from the server.\n\n> Optimistic Resposne is something we will cover in next steps but so you know, Apollo allows to optimistically update the store with a temporary data that is being replaced right after we get the response from the server.\n\nBut why the update function has to run synchornously? It's by design and not so interesting. We won't cover it in-depth here but in short, when Apollo runs the function it switches the store with the new, empty one, to record every change that's made by the function to later merge it with the original store. If you still have questions, please let us know so we can cover that thing in-depth as a blog post or even a separate chapter in that tutorial.\n\n### Summary\n\nNow you won't need to reload the page in order to see the new message. What's even more interesting is that the message you wrote would also be shown as the last message in the chats list, just hit the back button in the top-left corner to find out!\n\nThis is because we updated our store for both the `GetChat` and the `GetChats` query."
          },
          {
            "manualTitle": "Step 11: Messages and chats removal",
            "stepRevision": "d924471909e13cc56a0bf23311554f1e7413130f",
            "manualView": "## Client\n\nSince we're now familiar with the way mutations work, it's time to add messages and chats removal to our list of features!\nSince the most annoying part is going to be dealing with the user interface (because a multiple selection started by a press event is involved), I created an Angular directive to ease the process.\n\nLet's start by adding `ngx-selectable-list`:\n\n    yarn add ngx-selectable-list\n\n[{]: <helper> (diffStep \"7.1\" module=\"client\")\n\n#### [Step 7.1: Add SelectableListModule](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/5ef06d0)\n\n##### Changed package.json\n```diff\n@@ -34,7 +34,8 @@\n ┊34┊34┊    \"graphql-tag\": \"2.10.0\",\n ┊35┊35┊    \"graphql\": \"14.0.2\",\n ┊36┊36┊    \"hammerjs\": \"2.0.8\",\n-┊37┊  ┊    \"ng2-truncate\": \"1.3.17\"\n+┊  ┊37┊    \"ng2-truncate\": \"1.3.17\",\n+┊  ┊38┊    \"ngx-selectable-list\": \"1.2.1\"\n ┊38┊39┊  },\n ┊39┊40┊  \"devDependencies\": {\n ┊40┊41┊    \"@angular-devkit/build-angular\": \"0.9.0-rc.2\",\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;chats-lister.module.ts\n```diff\n@@ -11,6 +11,7 @@\n ┊11┊11┊import {ChatsListComponent} from './components/chats-list/chats-list.component';\n ┊12┊12┊import {TruncateModule} from 'ng2-truncate';\n ┊13┊13┊import {SharedModule} from '../shared/shared.module';\n+┊  ┊14┊import {NgxSelectableListModule} from 'ngx-selectable-list';\n ┊14┊15┊\n ┊15┊16┊const routes: Routes = [\n ┊16┊17┊  {path: '', redirectTo: 'chats', pathMatch: 'full'},\n```\n```diff\n@@ -40,6 +41,7 @@\n ┊40┊41┊    TruncateModule,\n ┊41┊42┊    // Feature modules\n ┊42┊43┊    SharedModule,\n+┊  ┊44┊    NgxSelectableListModule,\n ┊43┊45┊  ],\n ┊44┊46┊  providers: [\n ┊45┊47┊    ChatsService,\n```\n\n[}]: #\n\nBecause we're going to use the `libSelectableList` directive, we can replace Outputs and EventEmitters with it:\n\n[{]: <helper> (diffStep \"7.2\" files=\"src/app/chats-lister/components/chat-item/chat-item.component.ts, src/app/chats-lister/components/chats-list/chats-list.component.ts, src/app/chat-viewer/components/messages-list/messages-list.component.ts\" module=\"client\")\n\n#### [Step 7.2: Remove messages and chats](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/18cfa7c)\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;components&#x2F;messages-list&#x2F;messages-list.component.ts\n```diff\n@@ -1,14 +1,17 @@\n ┊ 1┊ 1┊import {Component, Input} from '@angular/core';\n ┊ 2┊ 2┊import {GetChat} from '../../../../graphql';\n+┊  ┊ 3┊import {SelectableListDirective} from 'ngx-selectable-list';\n ┊ 3┊ 4┊\n ┊ 4┊ 5┊@Component({\n ┊ 5┊ 6┊  selector: 'app-messages-list',\n ┊ 6┊ 7┊  template: `\n ┊ 7┊ 8┊    <mat-list>\n ┊ 8┊ 9┊      <mat-list-item *ngFor=\"let message of messages\">\n-┊ 9┊  ┊        <app-message-item [item]=\"message\" [isGroup]=\"isGroup\"></app-message-item>\n+┊  ┊10┊        <app-message-item [item]=\"message\" [isGroup]=\"isGroup\"\n+┊  ┊11┊                          libSelectableItem></app-message-item>\n ┊10┊12┊      </mat-list-item>\n ┊11┊13┊    </mat-list>\n+┊  ┊14┊    <ng-content *ngIf=\"selectableListDirective.selecting\"></ng-content>\n ┊12┊15┊  `,\n ┊13┊16┊  styleUrls: ['messages-list.component.scss'],\n ┊14┊17┊})\n```\n```diff\n@@ -20,5 +23,5 @@\n ┊20┊23┊  @Input()\n ┊21┊24┊  isGroup: boolean;\n ┊22┊25┊\n-┊23┊  ┊  constructor() {}\n+┊  ┊26┊  constructor(public selectableListDirective: SelectableListDirective) {}\n ┊24┊27┊}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chat-item&#x2F;chat-item.component.ts\n```diff\n@@ -4,7 +4,7 @@\n ┊ 4┊ 4┊@Component({\n ┊ 5┊ 5┊  selector: 'app-chat-item',\n ┊ 6┊ 6┊  template: `\n-┊ 7┊  ┊    <div class=\"chat-row\" (click)=\"selectChat()\">\n+┊  ┊ 7┊    <div class=\"chat-row\">\n ┊ 8┊ 8┊      <img class=\"chat-pic\" [src]=\"chat.picture || 'assets/default-profile-pic.jpg'\">\n ┊ 9┊ 9┊      <div class=\"chat-info\">\n ┊10┊10┊        <div class=\"chat-name\">{{ chat.name }}</div>\n```\n```diff\n@@ -19,11 +19,4 @@\n ┊19┊19┊  // tslint:disable-next-line:no-input-rename\n ┊20┊20┊  @Input('item')\n ┊21┊21┊  chat: GetChats.Chats;\n-┊22┊  ┊\n-┊23┊  ┊  @Output()\n-┊24┊  ┊  select = new EventEmitter<string>();\n-┊25┊  ┊\n-┊26┊  ┊  selectChat() {\n-┊27┊  ┊    this.select.emit(this.chat.id);\n-┊28┊  ┊  }\n ┊29┊22┊}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chats-list&#x2F;chats-list.component.ts\n```diff\n@@ -1,14 +1,17 @@\n-┊ 1┊  ┊import {Component, EventEmitter, Input, Output} from '@angular/core';\n+┊  ┊ 1┊import {Component, Input} from '@angular/core';\n ┊ 2┊ 2┊import {GetChats} from '../../../../graphql';\n+┊  ┊ 3┊import {SelectableListDirective} from 'ngx-selectable-list';\n ┊ 3┊ 4┊\n ┊ 4┊ 5┊@Component({\n ┊ 5┊ 6┊  selector: 'app-chats-list',\n ┊ 6┊ 7┊  template: `\n ┊ 7┊ 8┊    <mat-list>\n ┊ 8┊ 9┊      <mat-list-item *ngFor=\"let chat of chats\">\n-┊ 9┊  ┊        <app-chat-item [item]=\"chat\" (select)=\"selectChat($event)\"></app-chat-item>\n+┊  ┊10┊        <app-chat-item [item]=\"chat\"\n+┊  ┊11┊                       libSelectableItem></app-chat-item>\n ┊10┊12┊      </mat-list-item>\n ┊11┊13┊    </mat-list>\n+┊  ┊14┊    <ng-content *ngIf=\"selectableListDirective.selecting\"></ng-content>\n ┊12┊15┊  `,\n ┊13┊16┊  styleUrls: ['chats-list.component.scss'],\n ┊14┊17┊})\n```\n```diff\n@@ -17,12 +20,5 @@\n ┊17┊20┊  @Input('items')\n ┊18┊21┊  chats: GetChats.Chats[];\n ┊19┊22┊\n-┊20┊  ┊  @Output()\n-┊21┊  ┊  select = new EventEmitter<string>();\n-┊22┊  ┊\n-┊23┊  ┊  constructor() {}\n-┊24┊  ┊\n-┊25┊  ┊  selectChat(id: string) {\n-┊26┊  ┊    this.select.emit(id);\n-┊27┊  ┊  }\n+┊  ┊23┊  constructor(public selectableListDirective: SelectableListDirective) {}\n ┊28┊24┊}\n```\n\n[}]: #\n\nDon't forget to add the `NgxSelectableListModule` to `ChatViewer` and `ChatLister` modules.\n\nWe also created a `ConfirmSelectionComponent` to use for content projection, since our selectable list directive will be able to listen to its events.\n\n[{]: <helper> (diffStep \"7.2\" files=\"src/app/shared/components/confirm-selection/confirm-selection.component.scss, src/app/shared/components/confirm-selection/confirm-selection.component.ts, src/app/shared/shared.module.ts\" module=\"client\")\n\n#### [Step 7.2: Remove messages and chats](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/18cfa7c)\n\n##### Added src&#x2F;app&#x2F;shared&#x2F;components&#x2F;confirm-selection&#x2F;confirm-selection.component.scss\n```diff\n@@ -0,0 +1,6 @@\n+┊ ┊1┊:host {\n+┊ ┊2┊  display: block;\n+┊ ┊3┊  position: absolute;\n+┊ ┊4┊  bottom: 5vw;\n+┊ ┊5┊  right: 5vw;\n+┊ ┊6┊}\n```\n\n##### Added src&#x2F;app&#x2F;shared&#x2F;components&#x2F;confirm-selection&#x2F;confirm-selection.component.ts\n```diff\n@@ -0,0 +1,21 @@\n+┊  ┊ 1┊import {Component, EventEmitter, Input, Output} from '@angular/core';\n+┊  ┊ 2┊\n+┊  ┊ 3┊@Component({\n+┊  ┊ 4┊  selector: 'app-confirm-selection',\n+┊  ┊ 5┊  template: `\n+┊  ┊ 6┊    <button mat-fab color=\"primary\" (click)=\"handleClick()\">\n+┊  ┊ 7┊      <mat-icon aria-label=\"Icon-button\">{{ icon }}</mat-icon>\n+┊  ┊ 8┊    </button>\n+┊  ┊ 9┊  `,\n+┊  ┊10┊  styleUrls: ['./confirm-selection.component.scss'],\n+┊  ┊11┊})\n+┊  ┊12┊export class ConfirmSelectionComponent {\n+┊  ┊13┊  @Input()\n+┊  ┊14┊  icon = 'delete';\n+┊  ┊15┊  @Output()\n+┊  ┊16┊  emitClick = new EventEmitter<null>();\n+┊  ┊17┊\n+┊  ┊18┊  handleClick() {\n+┊  ┊19┊    this.emitClick.emit();\n+┊  ┊20┊  }\n+┊  ┊21┊}\n```\n\n##### Changed src&#x2F;app&#x2F;shared&#x2F;shared.module.ts\n```diff\n@@ -1,19 +1,23 @@\n ┊ 1┊ 1┊import {BrowserModule} from '@angular/platform-browser';\n ┊ 2┊ 2┊import {NgModule} from '@angular/core';\n ┊ 3┊ 3┊\n-┊ 4┊  ┊import {MatToolbarModule} from '@angular/material';\n+┊  ┊ 4┊import {MatButtonModule, MatIconModule, MatToolbarModule} from '@angular/material';\n ┊ 5┊ 5┊import {ToolbarComponent} from './components/toolbar/toolbar.component';\n ┊ 6┊ 6┊import {FormsModule} from '@angular/forms';\n ┊ 7┊ 7┊import {BrowserAnimationsModule} from '@angular/platform-browser/animations';\n+┊  ┊ 8┊import {ConfirmSelectionComponent} from './components/confirm-selection/confirm-selection.component';\n ┊ 8┊ 9┊\n ┊ 9┊10┊@NgModule({\n ┊10┊11┊  declarations: [\n ┊11┊12┊    ToolbarComponent,\n+┊  ┊13┊    ConfirmSelectionComponent,\n ┊12┊14┊  ],\n ┊13┊15┊  imports: [\n ┊14┊16┊    BrowserModule,\n ┊15┊17┊    // Material\n ┊16┊18┊    MatToolbarModule,\n+┊  ┊19┊    MatIconModule,\n+┊  ┊20┊    MatButtonModule,\n ┊17┊21┊    // Animations\n ┊18┊22┊    BrowserAnimationsModule,\n ┊19┊23┊    // Forms\n```\n```diff\n@@ -22,6 +26,7 @@\n ┊22┊26┊  providers: [],\n ┊23┊27┊  exports: [\n ┊24┊28┊    ToolbarComponent,\n+┊  ┊29┊    ConfirmSelectionComponent,\n ┊25┊30┊  ],\n ┊26┊31┊})\n ┊27┊32┊export class SharedModule {\n```\n\n[}]: #\n\nGreat, let's finish the component part by adding the connection between our container components and the `ChatsService`. We're going to use `removeMessages` and `removeChat` methods.\n\n[{]: <helper> (diffStep \"7.2\" files=\"src/app/chat-viewer/containers/chat/chat.component.ts, src/app/chat-viewer/containers/chat/chat.component.spec.ts, src/app/chats-lister/containers/chats/chats.component.ts, src/app/chats-lister/containers/chats/chats.component.spec.ts\" module=\"client\")\n\n#### [Step 7.2: Remove messages and chats](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/18cfa7c)\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.spec.ts\n```diff\n@@ -20,6 +20,7 @@\n ┊20┊20┊  APOLLO_TESTING_CACHE,\n ┊21┊21┊} from 'apollo-angular/testing';\n ┊22┊22┊import { InMemoryCache } from 'apollo-cache-inmemory';\n+┊  ┊23┊import { NgxSelectableListModule } from 'ngx-selectable-list';\n ┊23┊24┊\n ┊24┊25┊import { dataIdFromObject } from '../../../graphql.module';\n ┊25┊26┊import { ChatComponent } from './chat.component';\n```\n```diff\n@@ -116,6 +117,7 @@\n ┊116┊117┊        SharedModule,\n ┊117┊118┊        ApolloTestingModule,\n ┊118┊119┊        RouterTestingModule,\n+┊   ┊120┊        NgxSelectableListModule,\n ┊119┊121┊      ],\n ┊120┊122┊      providers: [\n ┊121┊123┊        ChatsService,\n```\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.ts\n```diff\n@@ -13,7 +13,10 @@\n ┊13┊13┊      <div class=\"title\">{{ name }}</div>\n ┊14┊14┊    </app-toolbar>\n ┊15┊15┊    <div class=\"container\">\n-┊16┊  ┊      <app-messages-list [items]=\"messages\" [isGroup]=\"isGroup\"></app-messages-list>\n+┊  ┊16┊      <app-messages-list [items]=\"messages\" [isGroup]=\"isGroup\"\n+┊  ┊17┊                         libSelectableList=\"multiple_press\" (multiple)=\"deleteMessages($event)\">\n+┊  ┊18┊        <app-confirm-selection #confirmSelection></app-confirm-selection>\n+┊  ┊19┊      </app-messages-list>\n ┊17┊20┊      <app-new-message (newMessage)=\"addMessage($event)\"></app-new-message>\n ┊18┊21┊    </div>\n ┊19┊22┊  `,\n```\n```diff\n@@ -48,4 +51,8 @@\n ┊48┊51┊  addMessage(content: string) {\n ┊49┊52┊    this.chatsService.addMessage(this.chatId, content).subscribe();\n ┊50┊53┊  }\n+┊  ┊54┊\n+┊  ┊55┊  deleteMessages(messageIds: string[]) {\n+┊  ┊56┊    this.chatsService.removeMessages(this.chatId, this.messages, messageIds).subscribe();\n+┊  ┊57┊  }\n ┊51┊58┊}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.spec.ts\n```diff\n@@ -16,6 +16,7 @@\n ┊16┊16┊import { InMemoryCache } from 'apollo-cache-inmemory';\n ┊17┊17┊import { By } from '@angular/platform-browser';\n ┊18┊18┊import { RouterTestingModule } from '@angular/router/testing';\n+┊  ┊19┊import { NgxSelectableListModule } from 'ngx-selectable-list';\n ┊19┊20┊\n ┊20┊21┊import { GetChats } from '../../../../graphql';\n ┊21┊22┊import { dataIdFromObject } from '../../../graphql.module';\n```\n```diff\n@@ -334,6 +335,7 @@\n ┊334┊335┊        TruncateModule,\n ┊335┊336┊        ApolloTestingModule,\n ┊336┊337┊        RouterTestingModule,\n+┊   ┊338┊        NgxSelectableListModule,\n ┊337┊339┊      ],\n ┊338┊340┊      providers: [\n ┊339┊341┊        ChatsService,\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.ts\n```diff\n@@ -28,9 +28,13 @@\n ┊28┊28┊      </button>\n ┊29┊29┊    </mat-menu>\n ┊30┊30┊\n-┊31┊  ┊    <app-chats-list [items]=\"chats$ | async\" (select)=\"goToChat($event)\"></app-chats-list>\n+┊  ┊31┊    <app-chats-list [items]=\"chats$ | async\"\n+┊  ┊32┊                    libSelectableList=\"both\"\n+┊  ┊33┊                    (single)=\"goToChat($event)\" (multiple)=\"deleteChats($event)\" (isSelecting)=\"isSelecting = $event\">\n+┊  ┊34┊      <app-confirm-selection #confirmSelection></app-confirm-selection>\n+┊  ┊35┊    </app-chats-list>\n ┊32┊36┊\n-┊33┊  ┊    <button class=\"chat-button\" mat-fab color=\"secondary\">\n+┊  ┊37┊    <button *ngIf=\"!isSelecting\" class=\"chat-button\" mat-fab color=\"secondary\">\n ┊34┊38┊      <mat-icon aria-label=\"Icon-button with a + icon\">chat</mat-icon>\n ┊35┊39┊    </button>\n ┊36┊40┊  `,\n```\n```diff\n@@ -38,6 +42,7 @@\n ┊38┊42┊})\n ┊39┊43┊export class ChatsComponent implements OnInit {\n ┊40┊44┊  chats$: Observable<GetChats.Chats[]>;\n+┊  ┊45┊  isSelecting = false;\n ┊41┊46┊\n ┊42┊47┊  constructor(private chatsService: ChatsService,\n ┊43┊48┊              private router: Router) {\n```\n```diff\n@@ -50,4 +55,10 @@\n ┊50┊55┊  goToChat(chatId: string) {\n ┊51┊56┊    this.router.navigate(['/chat', chatId]);\n ┊52┊57┊  }\n+┊  ┊58┊\n+┊  ┊59┊  deleteChats(chatIds: string[]) {\n+┊  ┊60┊    chatIds.forEach(chatId => {\n+┊  ┊61┊      this.chatsService.removeChat(chatId).subscribe();\n+┊  ┊62┊    });\n+┊  ┊63┊  }\n ┊53┊64┊}\n```\n\n[}]: #\n\n### Connecting actions with the server\n\nThe UI part is pretty much complete but we still need to implement two methods in the `ChatsService`. We're going to create mutations to remove a chat, selected messages or all of them.\n\n[{]: <helper> (diffStep \"7.2\" files=\"src/graphql/removeChat.mutation.ts, src/graphql/removeMessages.mutation.ts, src/graphql/removeAllMessages.mutation.ts\" module=\"client\")\n\n#### [Step 7.2: Remove messages and chats](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/18cfa7c)\n\n##### Added src&#x2F;graphql&#x2F;removeAllMessages.mutation.ts\n```diff\n@@ -0,0 +1,8 @@\n+┊ ┊1┊import gql from 'graphql-tag';\n+┊ ┊2┊\n+┊ ┊3┊// We use the gql tag to parse our query string into a query document\n+┊ ┊4┊export const removeAllMessagesMutation = gql`\n+┊ ┊5┊  mutation RemoveAllMessages($chatId: ID!, $all: Boolean) {\n+┊ ┊6┊    removeMessages(chatId: $chatId, all: $all)\n+┊ ┊7┊  }\n+┊ ┊8┊`;\n```\n\n##### Added src&#x2F;graphql&#x2F;removeChat.mutation.ts\n```diff\n@@ -0,0 +1,8 @@\n+┊ ┊1┊import gql from 'graphql-tag';\n+┊ ┊2┊\n+┊ ┊3┊// We use the gql tag to parse our query string into a query document\n+┊ ┊4┊export const removeChatMutation = gql`\n+┊ ┊5┊  mutation RemoveChat($chatId: ID!) {\n+┊ ┊6┊    removeChat(chatId: $chatId)\n+┊ ┊7┊  }\n+┊ ┊8┊`;\n```\n\n##### Added src&#x2F;graphql&#x2F;removeMessages.mutation.ts\n```diff\n@@ -0,0 +1,8 @@\n+┊ ┊1┊import gql from 'graphql-tag';\n+┊ ┊2┊\n+┊ ┊3┊// We use the gql tag to parse our query string into a query document\n+┊ ┊4┊export const removeMessagesMutation = gql`\n+┊ ┊5┊  mutation RemoveMessages($chatId: ID!, $messageIds: [ID]) {\n+┊ ┊6┊    removeMessages(chatId: $chatId, messageIds: $messageIds)\n+┊ ┊7┊  }\n+┊ ┊8┊`;\n```\n\n[}]: #\n\nOnce again, we run the GraphQL Code Generator to get the GQL services:\n\n    yarn generator\n\nNow we can import those services, create `removeChat` and `removeMessages` methods in which we call a mutation.\n\n[{]: <helper> (diffStep \"7.2\" files=\"src/app/services/chats.service.ts\" module=\"client\")\n\n#### [Step 7.2: Remove messages and chats](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/18cfa7c)\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -4,10 +4,16 @@\n ┊ 4┊ 4┊  GetChatsGQL,\n ┊ 5┊ 5┊  GetChatGQL,\n ┊ 6┊ 6┊  AddMessageGQL,\n+┊  ┊ 7┊  RemoveChatGQL,\n+┊  ┊ 8┊  RemoveMessagesGQL,\n+┊  ┊ 9┊  RemoveAllMessagesGQL,\n ┊ 7┊10┊  AddMessage,\n ┊ 8┊11┊  GetChats,\n-┊ 9┊  ┊  GetChat\n+┊  ┊12┊  GetChat,\n+┊  ┊13┊  RemoveMessages,\n+┊  ┊14┊  RemoveAllMessages,\n ┊10┊15┊} from '../../graphql';\n+┊  ┊16┊import { DataProxy } from 'apollo-cache';\n ┊11┊17┊\n ┊12┊18┊@Injectable()\n ┊13┊19┊export class ChatsService {\n```\n```diff\n@@ -16,7 +22,10 @@\n ┊16┊22┊  constructor(\n ┊17┊23┊    private getChatsGQL: GetChatsGQL,\n ┊18┊24┊    private getChatGQL: GetChatGQL,\n-┊19┊  ┊    private addMessageGQL: AddMessageGQL\n+┊  ┊25┊    private addMessageGQL: AddMessageGQL,\n+┊  ┊26┊    private removeChatGQL: RemoveChatGQL,\n+┊  ┊27┊    private removeMessagesGQL: RemoveMessagesGQL,\n+┊  ┊28┊    private removeAllMessagesGQL: RemoveAllMessagesGQL,\n ┊20┊29┊  ) {}\n ┊21┊30┊\n ┊22┊31┊  getChats() {\n```\n```diff\n@@ -92,4 +101,112 @@\n ┊ 92┊101┊      }\n ┊ 93┊102┊    });\n ┊ 94┊103┊  }\n+┊   ┊104┊\n+┊   ┊105┊  removeChat(chatId: string) {\n+┊   ┊106┊    return this.removeChatGQL.mutate(\n+┊   ┊107┊      {\n+┊   ┊108┊        chatId,\n+┊   ┊109┊      }, {\n+┊   ┊110┊        update: (store, { data: { removeChat } }) => {\n+┊   ┊111┊          // Read the data from our cache for this query.\n+┊   ┊112┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊113┊            query: this.getChatsGQL.document,\n+┊   ┊114┊            variables: {\n+┊   ┊115┊              amount: this.messagesAmount,\n+┊   ┊116┊            },\n+┊   ┊117┊          });\n+┊   ┊118┊          // Remove the chat (mutable)\n+┊   ┊119┊          for (const index of chats.keys()) {\n+┊   ┊120┊            if (chats[index].id === removeChat) {\n+┊   ┊121┊              chats.splice(index, 1);\n+┊   ┊122┊            }\n+┊   ┊123┊          }\n+┊   ┊124┊          // Write our data back to the cache.\n+┊   ┊125┊          store.writeQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊126┊            query: this.getChatsGQL.document,\n+┊   ┊127┊            variables: {\n+┊   ┊128┊              amount: this.messagesAmount,\n+┊   ┊129┊            },\n+┊   ┊130┊            data: {\n+┊   ┊131┊              chats,\n+┊   ┊132┊            },\n+┊   ┊133┊          });\n+┊   ┊134┊        },\n+┊   ┊135┊      }\n+┊   ┊136┊    );\n+┊   ┊137┊  }\n+┊   ┊138┊\n+┊   ┊139┊  removeMessages(chatId: string, messages: GetChat.Messages[], messageIdsOrAll: string[] | boolean) {\n+┊   ┊140┊    let ids: string[] = [];\n+┊   ┊141┊\n+┊   ┊142┊    const options = {\n+┊   ┊143┊      update: (store: DataProxy, { data: { removeMessages } }: {data: RemoveMessages.Mutation | RemoveAllMessages.Mutation}) => {\n+┊   ┊144┊        // Update the messages cache\n+┊   ┊145┊        {\n+┊   ┊146┊          // Read the data from our cache for this query.\n+┊   ┊147┊          const {chat} = store.readQuery<GetChat.Query, GetChat.Variables>({\n+┊   ┊148┊            query: this.getChatGQL.document,\n+┊   ┊149┊            variables: {\n+┊   ┊150┊              chatId,\n+┊   ┊151┊            }\n+┊   ┊152┊          });\n+┊   ┊153┊          // Remove the messages (mutable)\n+┊   ┊154┊          removeMessages.forEach(messageId => {\n+┊   ┊155┊            for (const index of chat.messages.keys()) {\n+┊   ┊156┊              if (chat.messages[index].id === messageId) {\n+┊   ┊157┊                chat.messages.splice(index, 1);\n+┊   ┊158┊              }\n+┊   ┊159┊            }\n+┊   ┊160┊          });\n+┊   ┊161┊          // Write our data back to the cache.\n+┊   ┊162┊          store.writeQuery<GetChat.Query, GetChat.Variables>({\n+┊   ┊163┊            query: this.getChatGQL.document,\n+┊   ┊164┊            data: {\n+┊   ┊165┊              chat\n+┊   ┊166┊            }\n+┊   ┊167┊          });\n+┊   ┊168┊        }\n+┊   ┊169┊        // Update last message cache\n+┊   ┊170┊        {\n+┊   ┊171┊          // Read the data from our cache for this query.\n+┊   ┊172┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊173┊            query: this.getChatsGQL.document,\n+┊   ┊174┊            variables: {\n+┊   ┊175┊              amount: this.messagesAmount,\n+┊   ┊176┊            },\n+┊   ┊177┊          });\n+┊   ┊178┊          // Fix last message\n+┊   ┊179┊          chats.find(chat => chat.id === chatId).messages = messages\n+┊   ┊180┊            .filter(message => !ids.includes(message.id))\n+┊   ┊181┊            .sort((a, b) => Number(b.createdAt) - Number(a.createdAt)) || [];\n+┊   ┊182┊          // Write our data back to the cache.\n+┊   ┊183┊          store.writeQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊184┊            query: this.getChatsGQL.document,\n+┊   ┊185┊            variables: {\n+┊   ┊186┊              amount: this.messagesAmount,\n+┊   ┊187┊            },\n+┊   ┊188┊            data: {\n+┊   ┊189┊              chats,\n+┊   ┊190┊            },\n+┊   ┊191┊          });\n+┊   ┊192┊        }\n+┊   ┊193┊      }\n+┊   ┊194┊    };\n+┊   ┊195┊\n+┊   ┊196┊    if (typeof messageIdsOrAll === 'boolean') {\n+┊   ┊197┊      ids = messages.map(message => message.id);\n+┊   ┊198┊\n+┊   ┊199┊      return this.removeAllMessagesGQL.mutate({\n+┊   ┊200┊        chatId,\n+┊   ┊201┊        all: messageIdsOrAll\n+┊   ┊202┊      }, options);\n+┊   ┊203┊    } else {\n+┊   ┊204┊      ids = messageIdsOrAll;\n+┊   ┊205┊\n+┊   ┊206┊      return this.removeMessagesGQL.mutate({\n+┊   ┊207┊        chatId,\n+┊   ┊208┊        messageIds: messageIdsOrAll,\n+┊   ┊209┊      }, options);\n+┊   ┊210┊    }\n+┊   ┊211┊  }\n ┊ 95┊212┊}\n```\n\n[}]: #\n\nIt might seem like a lot but we simply just updating the store there.\n\n### Summary\n\nThe selectable list directive supports much more different use cases, for info please read the documentation.\n\nAs you can see `ngx-selectable-list` takes care of most of the boilerplate, giving us the freedom to concentrate on the actual code."
          },
          {
            "manualTitle": "Step 12: Chats creation",
            "stepRevision": "ee69029ee3985a5b2d46874694315646d04e5cd0",
            "manualView": "![new-chat](https://user-images.githubusercontent.com/7648874/49270347-ea25ea00-f4a3-11e8-98ac-f67de8bfd8d5.png)\n\n![new-group](https://user-images.githubusercontent.com/7648874/49270350-ec884400-f4a3-11e8-8baa-b6bba0f7f539.png)\n\nWe still cannot create new chats or groups, so let's implement it.\n\nWe're going to create a `ChatsCreation` module, with a `NewChat` and a `NewGroup` containers, along with several presentational components.\n\nWe're going to make use of the selectable list directive once again, to ease selecting the users when we're creating a new group.\nYou should also notice that we are looking for existing chats before creating a new one: if it already exists we're simply redirecting to that chat instead of creating a new one (the server wouldn't allow that anyway and it will simply\nreturn the chat id).\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/graphql/\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n##### Added src&#x2F;graphql&#x2F;addChat.mutation.ts\n```diff\n@@ -0,0 +1,17 @@\n+┊  ┊ 1┊import gql from 'graphql-tag';\n+┊  ┊ 2┊import {fragments} from './fragment';\n+┊  ┊ 3┊\n+┊  ┊ 4┊// We use the gql tag to parse our query string into a query document\n+┊  ┊ 5┊export const addChatMutation = gql`\n+┊  ┊ 6┊  mutation AddChat($recipientId: ID!) {\n+┊  ┊ 7┊    addChat(recipientId: $recipientId) {\n+┊  ┊ 8┊      ...ChatWithoutMessages\n+┊  ┊ 9┊      messages {\n+┊  ┊10┊        ...Message\n+┊  ┊11┊      }\n+┊  ┊12┊    }\n+┊  ┊13┊  }\n+┊  ┊14┊\n+┊  ┊15┊  ${fragments['chatWithoutMessages']}\n+┊  ┊16┊  ${fragments['message']}\n+┊  ┊17┊`;\n```\n\n##### Added src&#x2F;graphql&#x2F;addGroup.mutation.ts\n```diff\n@@ -0,0 +1,17 @@\n+┊  ┊ 1┊import gql from 'graphql-tag';\n+┊  ┊ 2┊import {fragments} from './fragment';\n+┊  ┊ 3┊\n+┊  ┊ 4┊// We use the gql tag to parse our query string into a query document\n+┊  ┊ 5┊export const addGroupMutation = gql`\n+┊  ┊ 6┊  mutation AddGroup($recipientIds: [ID!]!, $groupName: String!) {\n+┊  ┊ 7┊    addGroup(recipientIds: $recipientIds, groupName: $groupName) {\n+┊  ┊ 8┊      ...ChatWithoutMessages\n+┊  ┊ 9┊      messages {\n+┊  ┊10┊        ...Message\n+┊  ┊11┊      }\n+┊  ┊12┊    }\n+┊  ┊13┊  }\n+┊  ┊14┊\n+┊  ┊15┊  ${fragments['chatWithoutMessages']}\n+┊  ┊16┊  ${fragments['message']}\n+┊  ┊17┊`;\n```\n\n##### Added src&#x2F;graphql&#x2F;getUsers.query.ts\n```diff\n@@ -0,0 +1,12 @@\n+┊  ┊ 1┊import gql from 'graphql-tag';\n+┊  ┊ 2┊\n+┊  ┊ 3┊// We use the gql tag to parse our query string into a query document\n+┊  ┊ 4┊export const getUsersQuery = gql`\n+┊  ┊ 5┊  query GetUsers {\n+┊  ┊ 6┊    users {\n+┊  ┊ 7┊      id,\n+┊  ┊ 8┊      name,\n+┊  ┊ 9┊      picture,\n+┊  ┊10┊    }\n+┊  ┊11┊  }\n+┊  ┊12┊`;\n```\n\n[}]: #\n\nAfter creating the mutations we should run the generator to create the corresponding types and services:\n\n    yarn generator\n\nLet's jump straight into `ChatsService` and add few new methods:\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/app/services/chats.service.ts\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,5 +1,7 @@\n ┊1┊1┊import {map} from 'rxjs/operators';\n ┊2┊2┊import {Injectable} from '@angular/core';\n+┊ ┊3┊import {Observable} from 'rxjs';\n+┊ ┊4┊import {QueryRef} from 'apollo-angular';\n ┊3┊5┊import {\n ┊4┊6┊  GetChatsGQL,\n ┊5┊7┊  GetChatGQL,\n```\n```diff\n@@ -7,6 +9,9 @@\n ┊ 7┊ 9┊  RemoveChatGQL,\n ┊ 8┊10┊  RemoveMessagesGQL,\n ┊ 9┊11┊  RemoveAllMessagesGQL,\n+┊  ┊12┊  GetUsersGQL,\n+┊  ┊13┊  AddChatGQL,\n+┊  ┊14┊  AddGroupGQL,\n ┊10┊15┊  AddMessage,\n ┊11┊16┊  GetChats,\n ┊12┊17┊  GetChat,\n```\n```diff\n@@ -15,9 +20,14 @@\n ┊15┊20┊} from '../../graphql';\n ┊16┊21┊import { DataProxy } from 'apollo-cache';\n ┊17┊22┊\n+┊  ┊23┊const currentUserId = '1';\n+┊  ┊24┊\n ┊18┊25┊@Injectable()\n ┊19┊26┊export class ChatsService {\n ┊20┊27┊  messagesAmount = 3;\n+┊  ┊28┊  getChatsWq: QueryRef<GetChats.Query, GetChats.Variables>;\n+┊  ┊29┊  chats$: Observable<GetChats.Chats[]>;\n+┊  ┊30┊  chats: GetChats.Chats[];\n ┊21┊31┊\n ┊22┊32┊  constructor(\n ┊23┊33┊    private getChatsGQL: GetChatsGQL,\n```\n```diff\n@@ -26,17 +36,21 @@\n ┊26┊36┊    private removeChatGQL: RemoveChatGQL,\n ┊27┊37┊    private removeMessagesGQL: RemoveMessagesGQL,\n ┊28┊38┊    private removeAllMessagesGQL: RemoveAllMessagesGQL,\n-┊29┊  ┊  ) {}\n-┊30┊  ┊\n-┊31┊  ┊  getChats() {\n-┊32┊  ┊    const query = this.getChatsGQL.watch({\n+┊  ┊39┊    private getUsersGQL: GetUsersGQL,\n+┊  ┊40┊    private addChatGQL: AddChatGQL,\n+┊  ┊41┊    private addGroupGQL: AddGroupGQL\n+┊  ┊42┊  ) {\n+┊  ┊43┊    this.getChatsWq = this.getChatsGQL.watch({\n ┊33┊44┊      amount: this.messagesAmount,\n ┊34┊45┊    });\n-┊35┊  ┊    const chats$ = query.valueChanges.pipe(\n+┊  ┊46┊    this.chats$ = this.getChatsWq.valueChanges.pipe(\n ┊36┊47┊      map((result) => result.data.chats)\n ┊37┊48┊    );\n+┊  ┊49┊    this.chats$.subscribe(chats => this.chats = chats);\n+┊  ┊50┊  }\n ┊38┊51┊\n-┊39┊  ┊    return {query, chats$};\n+┊  ┊52┊  getChats() {\n+┊  ┊53┊    return {query: this.getChatsWq, chats$: this.chats$};\n ┊40┊54┊  }\n ┊41┊55┊\n ┊42┊56┊  getChat(chatId: string) {\n```\n```diff\n@@ -209,4 +223,83 @@\n ┊209┊223┊      }, options);\n ┊210┊224┊    }\n ┊211┊225┊  }\n+┊   ┊226┊\n+┊   ┊227┊  getUsers() {\n+┊   ┊228┊    const query = this.getUsersGQL.watch();\n+┊   ┊229┊    const users$ = query.valueChanges.pipe(\n+┊   ┊230┊      map((result) => result.data.users)\n+┊   ┊231┊    );\n+┊   ┊232┊\n+┊   ┊233┊    return {query, users$};\n+┊   ┊234┊  }\n+┊   ┊235┊\n+┊   ┊236┊  // Checks if the chat is listed for the current user and returns the id\n+┊   ┊237┊  getChatId(recipientId: string) {\n+┊   ┊238┊    const _chat = this.chats.find(chat => {\n+┊   ┊239┊      return !chat.isGroup && !!chat.allTimeMembers.find(user => user.id === currentUserId) &&\n+┊   ┊240┊        !!chat.allTimeMembers.find(user => user.id === recipientId);\n+┊   ┊241┊    });\n+┊   ┊242┊    return _chat ? _chat.id : false;\n+┊   ┊243┊  }\n+┊   ┊244┊\n+┊   ┊245┊  addChat(recipientId: string) {\n+┊   ┊246┊    return this.addChatGQL.mutate(\n+┊   ┊247┊      {\n+┊   ┊248┊        recipientId,\n+┊   ┊249┊      }, {\n+┊   ┊250┊        update: (store, { data: { addChat } }) => {\n+┊   ┊251┊          // Read the data from our cache for this query.\n+┊   ┊252┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊253┊            query: this.getChatsGQL.document,\n+┊   ┊254┊            variables: {\n+┊   ┊255┊              amount: this.messagesAmount,\n+┊   ┊256┊            },\n+┊   ┊257┊          });\n+┊   ┊258┊          // Add our comment from the mutation to the end.\n+┊   ┊259┊          chats.push(addChat);\n+┊   ┊260┊          // Write our data back to the cache.\n+┊   ┊261┊          store.writeQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊262┊            query: this.getChatsGQL.document,\n+┊   ┊263┊            variables: {\n+┊   ┊264┊              amount: this.messagesAmount,\n+┊   ┊265┊            },\n+┊   ┊266┊            data: {\n+┊   ┊267┊              chats,\n+┊   ┊268┊            },\n+┊   ┊269┊          });\n+┊   ┊270┊        },\n+┊   ┊271┊      }\n+┊   ┊272┊    );\n+┊   ┊273┊  }\n+┊   ┊274┊\n+┊   ┊275┊  addGroup(recipientIds: string[], groupName: string) {\n+┊   ┊276┊    return this.addGroupGQL.mutate(\n+┊   ┊277┊      {\n+┊   ┊278┊        recipientIds,\n+┊   ┊279┊        groupName,\n+┊   ┊280┊      }, {\n+┊   ┊281┊        update: (store, { data: { addGroup } }) => {\n+┊   ┊282┊          // Read the data from our cache for this query.\n+┊   ┊283┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊284┊            query: this.getChatsGQL.document,\n+┊   ┊285┊            variables: {\n+┊   ┊286┊              amount: this.messagesAmount,\n+┊   ┊287┊            },\n+┊   ┊288┊          });\n+┊   ┊289┊          // Add our comment from the mutation to the end.\n+┊   ┊290┊          chats.push(addGroup);\n+┊   ┊291┊          // Write our data back to the cache.\n+┊   ┊292┊          store.writeQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊293┊            query: this.getChatsGQL.document,\n+┊   ┊294┊            variables: {\n+┊   ┊295┊              amount: this.messagesAmount,\n+┊   ┊296┊            },\n+┊   ┊297┊            data: {\n+┊   ┊298┊              chats,\n+┊   ┊299┊            },\n+┊   ┊300┊          });\n+┊   ┊301┊        },\n+┊   ┊302┊      }\n+┊   ┊303┊    );\n+┊   ┊304┊  }\n ┊212┊305┊}\n```\n\n[}]: #\n\nOkay, now since we got the GraphQL part ready, we're going to focus on the component.\n\nFirst, we will download the default group-chat picture:\n\n    $ wget https://raw.githubusercontent.com/DAB0mB/whatsapp-client-angularcli-material/c75c2416b1990da3588015f76b8338764f44d6ec/src/assets/default-group-pic.jpg -P src/assets\n\nAnd update the relevant chat components to use it when necessary:\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/app/chat-viewer/containers/chat/chat.component.ts, src/app/chats-lister/components/chat-item/chat-item.component.ts\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n\n\n[}]: #\n\nThen we will create a space to add a new group:\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/app/chats-creation/containers/new-group/new-group.component.ts, src/app/chats-creation/containers/new-group/new-group.component.scss\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-group&#x2F;new-group.component.scss\n\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-group&#x2F;new-group.component.ts\n```diff\n@@ -0,0 +1,60 @@\n+┊  ┊ 1┊import {Component, OnInit} from '@angular/core';\n+┊  ┊ 2┊import {Location} from '@angular/common';\n+┊  ┊ 3┊import {Router} from '@angular/router';\n+┊  ┊ 4┊import {AddGroup, GetUsers} from '../../../../graphql';\n+┊  ┊ 5┊import {ChatsService} from '../../../services/chats.service';\n+┊  ┊ 6┊\n+┊  ┊ 7┊@Component({\n+┊  ┊ 8┊  template: `\n+┊  ┊ 9┊    <app-toolbar>\n+┊  ┊10┊      <button class=\"navigation\" mat-button (click)=\"goBack()\">\n+┊  ┊11┊        <mat-icon aria-label=\"Icon-button with an arrow back icon\">arrow_back</mat-icon>\n+┊  ┊12┊      </button>\n+┊  ┊13┊      <div class=\"title\">New group</div>\n+┊  ┊14┊    </app-toolbar>\n+┊  ┊15┊\n+┊  ┊16┊    <app-users-list *ngIf=\"!recipientIds.length\" [items]=\"users\"\n+┊  ┊17┊                    libSelectableList=\"multiple_tap\" (multiple)=\"selectUsers($event)\">\n+┊  ┊18┊      <app-confirm-selection #confirmSelection icon=\"arrow_forward\"></app-confirm-selection>\n+┊  ┊19┊    </app-users-list>\n+┊  ┊20┊    <app-new-group-details *ngIf=\"recipientIds.length\" [users]=\"getSelectedUsers()\"\n+┊  ┊21┊                           (groupDetails)=\"addGroup($event)\"></app-new-group-details>\n+┊  ┊22┊  `,\n+┊  ┊23┊  styleUrls: ['new-group.component.scss'],\n+┊  ┊24┊})\n+┊  ┊25┊export class NewGroupComponent implements OnInit {\n+┊  ┊26┊  users: GetUsers.Users[];\n+┊  ┊27┊  recipientIds: string[] = [];\n+┊  ┊28┊\n+┊  ┊29┊  constructor(private router: Router,\n+┊  ┊30┊              private location: Location,\n+┊  ┊31┊              private chatsService: ChatsService) {}\n+┊  ┊32┊\n+┊  ┊33┊  ngOnInit () {\n+┊  ┊34┊    this.chatsService.getUsers().users$.subscribe(users => this.users = users);\n+┊  ┊35┊  }\n+┊  ┊36┊\n+┊  ┊37┊  goBack() {\n+┊  ┊38┊    if (this.recipientIds.length) {\n+┊  ┊39┊      this.recipientIds = [];\n+┊  ┊40┊    } else {\n+┊  ┊41┊      this.location.back();\n+┊  ┊42┊    }\n+┊  ┊43┊  }\n+┊  ┊44┊\n+┊  ┊45┊  selectUsers(recipientIds: string[]) {\n+┊  ┊46┊    this.recipientIds = recipientIds;\n+┊  ┊47┊  }\n+┊  ┊48┊\n+┊  ┊49┊  getSelectedUsers() {\n+┊  ┊50┊    return this.users.filter(user => this.recipientIds.includes(user.id));\n+┊  ┊51┊  }\n+┊  ┊52┊\n+┊  ┊53┊  addGroup(groupName: string) {\n+┊  ┊54┊    if (groupName && this.recipientIds.length) {\n+┊  ┊55┊      this.chatsService.addGroup(this.recipientIds, groupName).subscribe(({data: {addGroup: {id}}}: { data: AddGroup.Mutation }) => {\n+┊  ┊56┊        this.router.navigate(['/chat', id]);\n+┊  ┊57┊      });\n+┊  ┊58┊    }\n+┊  ┊59┊  }\n+┊  ┊60┊}\n```\n\n[}]: #\n\nAnd after, a new chat view:\n\nsrc/app/chats-creation/containers/new-chat/new-chat.component.scss, src/app/chats-creation/containers/new-chat/new-chat.component.ts\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/app/app.module.ts, src/app/chats-creation, src/app/services\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n##### Changed src&#x2F;app&#x2F;app.module.ts\n```diff\n@@ -7,6 +7,7 @@\n ┊ 7┊ 7┊import {ChatsListerModule} from './chats-lister/chats-lister.module';\n ┊ 8┊ 8┊import {RouterModule, Routes} from '@angular/router';\n ┊ 9┊ 9┊import {ChatViewerModule} from './chat-viewer/chat-viewer.module';\n+┊  ┊10┊import {ChatsCreationModule} from './chats-creation/chats-creation.module';\n ┊10┊11┊const routes: Routes = [];\n ┊11┊12┊\n ┊12┊13┊@NgModule({\n```\n```diff\n@@ -22,6 +23,7 @@\n ┊22┊23┊    // Feature modules\n ┊23┊24┊    ChatsListerModule,\n ┊24┊25┊    ChatViewerModule,\n+┊  ┊26┊    ChatsCreationModule,\n ┊25┊27┊  ],\n ┊26┊28┊  providers: [],\n ┊27┊29┊  bootstrap: [AppComponent]\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;chats-creation.module.ts\n```diff\n@@ -0,0 +1,60 @@\n+┊  ┊ 1┊import { BrowserModule } from '@angular/platform-browser';\n+┊  ┊ 2┊import { NgModule } from '@angular/core';\n+┊  ┊ 3┊\n+┊  ┊ 4┊import {BrowserAnimationsModule} from '@angular/platform-browser/animations';\n+┊  ┊ 5┊import {\n+┊  ┊ 6┊  MatButtonModule, MatFormFieldModule, MatGridListModule, MatIconModule, MatInputModule, MatListModule, MatMenuModule,\n+┊  ┊ 7┊  MatToolbarModule\n+┊  ┊ 8┊} from '@angular/material';\n+┊  ┊ 9┊import {RouterModule, Routes} from '@angular/router';\n+┊  ┊10┊import {FormsModule} from '@angular/forms';\n+┊  ┊11┊import {ChatsService} from '../services/chats.service';\n+┊  ┊12┊import {UserItemComponent} from './components/user-item/user-item.component';\n+┊  ┊13┊import {UsersListComponent} from './components/users-list/users-list.component';\n+┊  ┊14┊import {NewGroupComponent} from './containers/new-group/new-group.component';\n+┊  ┊15┊import {NewChatComponent} from './containers/new-chat/new-chat.component';\n+┊  ┊16┊import {NewGroupDetailsComponent} from './components/new-group-details/new-group-details.component';\n+┊  ┊17┊import {SharedModule} from '../shared/shared.module';\n+┊  ┊18┊import {NgxSelectableListModule} from 'ngx-selectable-list';\n+┊  ┊19┊\n+┊  ┊20┊const routes: Routes = [\n+┊  ┊21┊  {path: 'new-chat', component: NewChatComponent},\n+┊  ┊22┊  {path: 'new-group', component: NewGroupComponent},\n+┊  ┊23┊];\n+┊  ┊24┊\n+┊  ┊25┊@NgModule({\n+┊  ┊26┊  declarations: [\n+┊  ┊27┊    NewChatComponent,\n+┊  ┊28┊    UsersListComponent,\n+┊  ┊29┊    NewGroupComponent,\n+┊  ┊30┊    UserItemComponent,\n+┊  ┊31┊    NewGroupDetailsComponent,\n+┊  ┊32┊  ],\n+┊  ┊33┊  imports: [\n+┊  ┊34┊    BrowserModule,\n+┊  ┊35┊    // Animations (for Material)\n+┊  ┊36┊    BrowserAnimationsModule,\n+┊  ┊37┊    // Material\n+┊  ┊38┊    MatToolbarModule,\n+┊  ┊39┊    MatMenuModule,\n+┊  ┊40┊    MatIconModule,\n+┊  ┊41┊    MatButtonModule,\n+┊  ┊42┊    MatListModule,\n+┊  ┊43┊    MatGridListModule,\n+┊  ┊44┊    MatInputModule,\n+┊  ┊45┊    MatFormFieldModule,\n+┊  ┊46┊    MatGridListModule,\n+┊  ┊47┊    // Routing\n+┊  ┊48┊    RouterModule.forChild(routes),\n+┊  ┊49┊    // Forms\n+┊  ┊50┊    FormsModule,\n+┊  ┊51┊    // Feature modules\n+┊  ┊52┊    NgxSelectableListModule,\n+┊  ┊53┊    SharedModule,\n+┊  ┊54┊  ],\n+┊  ┊55┊  providers: [\n+┊  ┊56┊    ChatsService,\n+┊  ┊57┊  ],\n+┊  ┊58┊})\n+┊  ┊59┊export class ChatsCreationModule {\n+┊  ┊60┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;new-group-details&#x2F;new-group-details.component.scss\n```diff\n@@ -0,0 +1,25 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊}\n+┊  ┊ 4┊\n+┊  ┊ 5┊div {\n+┊  ┊ 6┊  padding: 16px;\n+┊  ┊ 7┊  mat-form-field {\n+┊  ┊ 8┊    width: 100%;\n+┊  ┊ 9┊  }\n+┊  ┊10┊}\n+┊  ┊11┊\n+┊  ┊12┊.new-group {\n+┊  ┊13┊  position: absolute;\n+┊  ┊14┊  bottom: 5vw;\n+┊  ┊15┊  right: 5vw;\n+┊  ┊16┊}\n+┊  ┊17┊\n+┊  ┊18┊.users {\n+┊  ┊19┊  display: flex;\n+┊  ┊20┊  flex-flow: row wrap;\n+┊  ┊21┊  img {\n+┊  ┊22┊    flex: 0 1 8vh;\n+┊  ┊23┊    height: 8vh;\n+┊  ┊24┊  }\n+┊  ┊25┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;new-group-details&#x2F;new-group-details.component.ts\n```diff\n@@ -0,0 +1,34 @@\n+┊  ┊ 1┊import {Component, EventEmitter, Input, Output} from '@angular/core';\n+┊  ┊ 2┊import {GetUsers} from '../../../../graphql';\n+┊  ┊ 3┊\n+┊  ┊ 4┊@Component({\n+┊  ┊ 5┊  selector: 'app-new-group-details',\n+┊  ┊ 6┊  template: `\n+┊  ┊ 7┊    <div>\n+┊  ┊ 8┊      <mat-form-field>\n+┊  ┊ 9┊        <input matInput placeholder=\"Group name\" [(ngModel)]=\"groupName\">\n+┊  ┊10┊      </mat-form-field>\n+┊  ┊11┊    </div>\n+┊  ┊12┊    <button [disabled]=\"!groupName\" class=\"new-group\" mat-fab color=\"primary\" (click)=\"emitGroupDetails()\">\n+┊  ┊13┊      <mat-icon aria-label=\"Icon-button with a + icon\">arrow_forward</mat-icon>\n+┊  ┊14┊    </button>\n+┊  ┊15┊    <div>Members</div>\n+┊  ┊16┊    <div class=\"users\">\n+┊  ┊17┊      <img *ngFor=\"let user of users;\" [src]=\"user.picture\"/>\n+┊  ┊18┊    </div>\n+┊  ┊19┊  `,\n+┊  ┊20┊  styleUrls: ['new-group-details.component.scss'],\n+┊  ┊21┊})\n+┊  ┊22┊export class NewGroupDetailsComponent {\n+┊  ┊23┊  groupName: string;\n+┊  ┊24┊  @Input()\n+┊  ┊25┊  users: GetUsers.Users[];\n+┊  ┊26┊  @Output()\n+┊  ┊27┊  groupDetails = new EventEmitter<string>();\n+┊  ┊28┊\n+┊  ┊29┊  emitGroupDetails() {\n+┊  ┊30┊    if (this.groupDetails) {\n+┊  ┊31┊      this.groupDetails.emit(this.groupName);\n+┊  ┊32┊    }\n+┊  ┊33┊  }\n+┊  ┊34┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;user-item&#x2F;user-item.component.scss\n```diff\n@@ -0,0 +1,32 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊  width: 100%;\n+┊  ┊ 4┊  height: 100%;\n+┊  ┊ 5┊}\n+┊  ┊ 6┊\n+┊  ┊ 7┊button {\n+┊  ┊ 8┊  margin: 10px;\n+┊  ┊ 9┊  height: 50px;\n+┊  ┊10┊  padding: 1px 6px;\n+┊  ┊11┊  line-height: 50px;\n+┊  ┊12┊  border: none;\n+┊  ┊13┊  margin: 0;\n+┊  ┊14┊\n+┊  ┊15┊  img {\n+┊  ┊16┊    float: left;\n+┊  ┊17┊    margin-right: 10px;\n+┊  ┊18┊    height: 50px;\n+┊  ┊19┊    width: 50px;\n+┊  ┊20┊    text-align: center;\n+┊  ┊21┊    line-height: inherit;\n+┊  ┊22┊    border-radius: 50%;\n+┊  ┊23┊  }\n+┊  ┊24┊\n+┊  ┊25┊  div {\n+┊  ┊26┊    float: left;\n+┊  ┊27┊    line-height: inherit;\n+┊  ┊28┊    font-family: Roboto, \"Helvetica Neue\", sans-serif;\n+┊  ┊29┊    font-weight: bold;\n+┊  ┊30┊    font-size: 16px;\n+┊  ┊31┊  }\n+┊  ┊32┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;user-item&#x2F;user-item.component.ts\n```diff\n@@ -0,0 +1,18 @@\n+┊  ┊ 1┊import {Component, Input} from '@angular/core';\n+┊  ┊ 2┊import {GetUsers} from '../../../../graphql';\n+┊  ┊ 3┊\n+┊  ┊ 4┊@Component({\n+┊  ┊ 5┊  selector: 'app-user-item',\n+┊  ┊ 6┊  template: `\n+┊  ┊ 7┊    <button mat-menu-item>\n+┊  ┊ 8┊      <img [src]=\"user.picture || 'assets/default-profile-pic.jpg'\">\n+┊  ┊ 9┊      <div>{{ user.name }}</div>\n+┊  ┊10┊    </button>\n+┊  ┊11┊  `,\n+┊  ┊12┊  styleUrls: ['user-item.component.scss']\n+┊  ┊13┊})\n+┊  ┊14┊export class UserItemComponent {\n+┊  ┊15┊  // tslint:disable-next-line:no-input-rename\n+┊  ┊16┊  @Input('item')\n+┊  ┊17┊  user: GetUsers.Users;\n+┊  ┊18┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;users-list&#x2F;users-list.component.scss\n```diff\n@@ -0,0 +1,13 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊}\n+┊  ┊ 4┊\n+┊  ┊ 5┊:host ::ng-deep mat-list-item:first-child div:first-child {\n+┊  ┊ 6┊  padding: 0 !important;\n+┊  ┊ 7┊  margin: 5px;\n+┊  ┊ 8┊  margin-top: 20px;\n+┊  ┊ 9┊}\n+┊  ┊10┊\n+┊  ┊11┊mat-list {\n+┊  ┊12┊  padding: 0;\n+┊  ┊13┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;users-list&#x2F;users-list.component.ts\n```diff\n@@ -0,0 +1,24 @@\n+┊  ┊ 1┊import {Component, Input} from '@angular/core';\n+┊  ┊ 2┊import {GetUsers} from '../../../../graphql';\n+┊  ┊ 3┊import {SelectableListDirective} from 'ngx-selectable-list';\n+┊  ┊ 4┊\n+┊  ┊ 5┊@Component({\n+┊  ┊ 6┊  selector: 'app-users-list',\n+┊  ┊ 7┊  template: `\n+┊  ┊ 8┊    <mat-list>\n+┊  ┊ 9┊      <mat-list-item *ngFor=\"let user of users\">\n+┊  ┊10┊        <app-user-item [item]=\"user\"\n+┊  ┊11┊                       libSelectableItem></app-user-item>\n+┊  ┊12┊      </mat-list-item>\n+┊  ┊13┊    </mat-list>\n+┊  ┊14┊    <ng-content *ngIf=\"selectableListDirective.selecting\"></ng-content>\n+┊  ┊15┊  `,\n+┊  ┊16┊  styleUrls: ['users-list.component.scss'],\n+┊  ┊17┊})\n+┊  ┊18┊export class UsersListComponent {\n+┊  ┊19┊  // tslint:disable-next-line:no-input-rename\n+┊  ┊20┊  @Input('items')\n+┊  ┊21┊  users: GetUsers.Users[];\n+┊  ┊22┊\n+┊  ┊23┊  constructor(public selectableListDirective: SelectableListDirective) {}\n+┊  ┊24┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-chat&#x2F;new-chat.component.scss\n```diff\n@@ -0,0 +1,23 @@\n+┊  ┊ 1┊.new-group {\n+┊  ┊ 2┊  margin: 10px;\n+┊  ┊ 3┊  height: 50px;\n+┊  ┊ 4┊  line-height: 50px;\n+┊  ┊ 5┊  margin-top: 20px;\n+┊  ┊ 6┊\n+┊  ┊ 7┊  mat-icon {\n+┊  ┊ 8┊    float: left;\n+┊  ┊ 9┊    margin-right: 10px;\n+┊  ┊10┊    height: 50px;\n+┊  ┊11┊    width: 50px;\n+┊  ┊12┊    text-align: center;\n+┊  ┊13┊    line-height: inherit;\n+┊  ┊14┊    border-radius: 50%;\n+┊  ┊15┊  }\n+┊  ┊16┊\n+┊  ┊17┊  div {\n+┊  ┊18┊    float: left;\n+┊  ┊19┊    line-height: inherit;\n+┊  ┊20┊    font-family: Roboto, \"Helvetica Neue\", sans-serif;\n+┊  ┊21┊    font-weight: bold;\n+┊  ┊22┊  }\n+┊  ┊23┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-chat&#x2F;new-chat.component.ts\n```diff\n@@ -0,0 +1,55 @@\n+┊  ┊ 1┊import {Component, OnInit} from '@angular/core';\n+┊  ┊ 2┊import {Location} from '@angular/common';\n+┊  ┊ 3┊import {Router} from '@angular/router';\n+┊  ┊ 4┊import {AddChat, GetUsers} from '../../../../graphql';\n+┊  ┊ 5┊import {ChatsService} from '../../../services/chats.service';\n+┊  ┊ 6┊\n+┊  ┊ 7┊@Component({\n+┊  ┊ 8┊  template: `\n+┊  ┊ 9┊    <app-toolbar>\n+┊  ┊10┊      <button class=\"navigation\" mat-button (click)=\"goBack()\">\n+┊  ┊11┊        <mat-icon aria-label=\"Icon-button with an arrow back icon\">arrow_back</mat-icon>\n+┊  ┊12┊      </button>\n+┊  ┊13┊      <div class=\"title\">New chat</div>\n+┊  ┊14┊    </app-toolbar>\n+┊  ┊15┊    <div class=\"new-group\" (click)=\"goToNewGroup()\">\n+┊  ┊16┊      <mat-icon color=\"secondary\" aria-label=\"Icon-button with a group add icon\">group_add</mat-icon>\n+┊  ┊17┊      <div>New group</div>\n+┊  ┊18┊    </div>\n+┊  ┊19┊    <app-users-list [items]=\"users\"\n+┊  ┊20┊                    libSelectableList=\"single\" (single)=\"addChat($event)\">\n+┊  ┊21┊    </app-users-list>\n+┊  ┊22┊  `,\n+┊  ┊23┊  styleUrls: ['new-chat.component.scss'],\n+┊  ┊24┊})\n+┊  ┊25┊export class NewChatComponent implements OnInit {\n+┊  ┊26┊  users: GetUsers.Users[];\n+┊  ┊27┊\n+┊  ┊28┊  constructor(private router: Router,\n+┊  ┊29┊              private location: Location,\n+┊  ┊30┊              private chatsService: ChatsService) {}\n+┊  ┊31┊\n+┊  ┊32┊  ngOnInit () {\n+┊  ┊33┊    this.chatsService.getUsers().users$.subscribe(users => this.users = users);\n+┊  ┊34┊  }\n+┊  ┊35┊\n+┊  ┊36┊  goBack() {\n+┊  ┊37┊    this.location.back();\n+┊  ┊38┊  }\n+┊  ┊39┊\n+┊  ┊40┊  goToNewGroup() {\n+┊  ┊41┊    this.router.navigate(['/new-group']);\n+┊  ┊42┊  }\n+┊  ┊43┊\n+┊  ┊44┊  addChat(recipientId: string) {\n+┊  ┊45┊    const chatId = this.chatsService.getChatId(recipientId);\n+┊  ┊46┊    if (chatId) {\n+┊  ┊47┊      // Chat is already listed for the current user\n+┊  ┊48┊      this.router.navigate(['/chat', chatId]);\n+┊  ┊49┊    } else {\n+┊  ┊50┊      this.chatsService.addChat(recipientId).subscribe(({data: {addChat: {id}}}: { data: AddChat.Mutation }) => {\n+┊  ┊51┊        this.router.navigate(['/chat', id]);\n+┊  ┊52┊      });\n+┊  ┊53┊    }\n+┊  ┊54┊  }\n+┊  ┊55┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-group&#x2F;new-group.component.scss\n\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-group&#x2F;new-group.component.ts\n```diff\n@@ -0,0 +1,60 @@\n+┊  ┊ 1┊import {Component, OnInit} from '@angular/core';\n+┊  ┊ 2┊import {Location} from '@angular/common';\n+┊  ┊ 3┊import {Router} from '@angular/router';\n+┊  ┊ 4┊import {AddGroup, GetUsers} from '../../../../graphql';\n+┊  ┊ 5┊import {ChatsService} from '../../../services/chats.service';\n+┊  ┊ 6┊\n+┊  ┊ 7┊@Component({\n+┊  ┊ 8┊  template: `\n+┊  ┊ 9┊    <app-toolbar>\n+┊  ┊10┊      <button class=\"navigation\" mat-button (click)=\"goBack()\">\n+┊  ┊11┊        <mat-icon aria-label=\"Icon-button with an arrow back icon\">arrow_back</mat-icon>\n+┊  ┊12┊      </button>\n+┊  ┊13┊      <div class=\"title\">New group</div>\n+┊  ┊14┊    </app-toolbar>\n+┊  ┊15┊\n+┊  ┊16┊    <app-users-list *ngIf=\"!recipientIds.length\" [items]=\"users\"\n+┊  ┊17┊                    libSelectableList=\"multiple_tap\" (multiple)=\"selectUsers($event)\">\n+┊  ┊18┊      <app-confirm-selection #confirmSelection icon=\"arrow_forward\"></app-confirm-selection>\n+┊  ┊19┊    </app-users-list>\n+┊  ┊20┊    <app-new-group-details *ngIf=\"recipientIds.length\" [users]=\"getSelectedUsers()\"\n+┊  ┊21┊                           (groupDetails)=\"addGroup($event)\"></app-new-group-details>\n+┊  ┊22┊  `,\n+┊  ┊23┊  styleUrls: ['new-group.component.scss'],\n+┊  ┊24┊})\n+┊  ┊25┊export class NewGroupComponent implements OnInit {\n+┊  ┊26┊  users: GetUsers.Users[];\n+┊  ┊27┊  recipientIds: string[] = [];\n+┊  ┊28┊\n+┊  ┊29┊  constructor(private router: Router,\n+┊  ┊30┊              private location: Location,\n+┊  ┊31┊              private chatsService: ChatsService) {}\n+┊  ┊32┊\n+┊  ┊33┊  ngOnInit () {\n+┊  ┊34┊    this.chatsService.getUsers().users$.subscribe(users => this.users = users);\n+┊  ┊35┊  }\n+┊  ┊36┊\n+┊  ┊37┊  goBack() {\n+┊  ┊38┊    if (this.recipientIds.length) {\n+┊  ┊39┊      this.recipientIds = [];\n+┊  ┊40┊    } else {\n+┊  ┊41┊      this.location.back();\n+┊  ┊42┊    }\n+┊  ┊43┊  }\n+┊  ┊44┊\n+┊  ┊45┊  selectUsers(recipientIds: string[]) {\n+┊  ┊46┊    this.recipientIds = recipientIds;\n+┊  ┊47┊  }\n+┊  ┊48┊\n+┊  ┊49┊  getSelectedUsers() {\n+┊  ┊50┊    return this.users.filter(user => this.recipientIds.includes(user.id));\n+┊  ┊51┊  }\n+┊  ┊52┊\n+┊  ┊53┊  addGroup(groupName: string) {\n+┊  ┊54┊    if (groupName && this.recipientIds.length) {\n+┊  ┊55┊      this.chatsService.addGroup(this.recipientIds, groupName).subscribe(({data: {addGroup: {id}}}: { data: AddGroup.Mutation }) => {\n+┊  ┊56┊        this.router.navigate(['/chat', id]);\n+┊  ┊57┊      });\n+┊  ┊58┊    }\n+┊  ┊59┊  }\n+┊  ┊60┊}\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,5 +1,7 @@\n ┊1┊1┊import {map} from 'rxjs/operators';\n ┊2┊2┊import {Injectable} from '@angular/core';\n+┊ ┊3┊import {Observable} from 'rxjs';\n+┊ ┊4┊import {QueryRef} from 'apollo-angular';\n ┊3┊5┊import {\n ┊4┊6┊  GetChatsGQL,\n ┊5┊7┊  GetChatGQL,\n```\n```diff\n@@ -7,6 +9,9 @@\n ┊ 7┊ 9┊  RemoveChatGQL,\n ┊ 8┊10┊  RemoveMessagesGQL,\n ┊ 9┊11┊  RemoveAllMessagesGQL,\n+┊  ┊12┊  GetUsersGQL,\n+┊  ┊13┊  AddChatGQL,\n+┊  ┊14┊  AddGroupGQL,\n ┊10┊15┊  AddMessage,\n ┊11┊16┊  GetChats,\n ┊12┊17┊  GetChat,\n```\n```diff\n@@ -15,9 +20,14 @@\n ┊15┊20┊} from '../../graphql';\n ┊16┊21┊import { DataProxy } from 'apollo-cache';\n ┊17┊22┊\n+┊  ┊23┊const currentUserId = '1';\n+┊  ┊24┊\n ┊18┊25┊@Injectable()\n ┊19┊26┊export class ChatsService {\n ┊20┊27┊  messagesAmount = 3;\n+┊  ┊28┊  getChatsWq: QueryRef<GetChats.Query, GetChats.Variables>;\n+┊  ┊29┊  chats$: Observable<GetChats.Chats[]>;\n+┊  ┊30┊  chats: GetChats.Chats[];\n ┊21┊31┊\n ┊22┊32┊  constructor(\n ┊23┊33┊    private getChatsGQL: GetChatsGQL,\n```\n```diff\n@@ -26,17 +36,21 @@\n ┊26┊36┊    private removeChatGQL: RemoveChatGQL,\n ┊27┊37┊    private removeMessagesGQL: RemoveMessagesGQL,\n ┊28┊38┊    private removeAllMessagesGQL: RemoveAllMessagesGQL,\n-┊29┊  ┊  ) {}\n-┊30┊  ┊\n-┊31┊  ┊  getChats() {\n-┊32┊  ┊    const query = this.getChatsGQL.watch({\n+┊  ┊39┊    private getUsersGQL: GetUsersGQL,\n+┊  ┊40┊    private addChatGQL: AddChatGQL,\n+┊  ┊41┊    private addGroupGQL: AddGroupGQL\n+┊  ┊42┊  ) {\n+┊  ┊43┊    this.getChatsWq = this.getChatsGQL.watch({\n ┊33┊44┊      amount: this.messagesAmount,\n ┊34┊45┊    });\n-┊35┊  ┊    const chats$ = query.valueChanges.pipe(\n+┊  ┊46┊    this.chats$ = this.getChatsWq.valueChanges.pipe(\n ┊36┊47┊      map((result) => result.data.chats)\n ┊37┊48┊    );\n+┊  ┊49┊    this.chats$.subscribe(chats => this.chats = chats);\n+┊  ┊50┊  }\n ┊38┊51┊\n-┊39┊  ┊    return {query, chats$};\n+┊  ┊52┊  getChats() {\n+┊  ┊53┊    return {query: this.getChatsWq, chats$: this.chats$};\n ┊40┊54┊  }\n ┊41┊55┊\n ┊42┊56┊  getChat(chatId: string) {\n```\n```diff\n@@ -209,4 +223,83 @@\n ┊209┊223┊      }, options);\n ┊210┊224┊    }\n ┊211┊225┊  }\n+┊   ┊226┊\n+┊   ┊227┊  getUsers() {\n+┊   ┊228┊    const query = this.getUsersGQL.watch();\n+┊   ┊229┊    const users$ = query.valueChanges.pipe(\n+┊   ┊230┊      map((result) => result.data.users)\n+┊   ┊231┊    );\n+┊   ┊232┊\n+┊   ┊233┊    return {query, users$};\n+┊   ┊234┊  }\n+┊   ┊235┊\n+┊   ┊236┊  // Checks if the chat is listed for the current user and returns the id\n+┊   ┊237┊  getChatId(recipientId: string) {\n+┊   ┊238┊    const _chat = this.chats.find(chat => {\n+┊   ┊239┊      return !chat.isGroup && !!chat.allTimeMembers.find(user => user.id === currentUserId) &&\n+┊   ┊240┊        !!chat.allTimeMembers.find(user => user.id === recipientId);\n+┊   ┊241┊    });\n+┊   ┊242┊    return _chat ? _chat.id : false;\n+┊   ┊243┊  }\n+┊   ┊244┊\n+┊   ┊245┊  addChat(recipientId: string) {\n+┊   ┊246┊    return this.addChatGQL.mutate(\n+┊   ┊247┊      {\n+┊   ┊248┊        recipientId,\n+┊   ┊249┊      }, {\n+┊   ┊250┊        update: (store, { data: { addChat } }) => {\n+┊   ┊251┊          // Read the data from our cache for this query.\n+┊   ┊252┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊253┊            query: this.getChatsGQL.document,\n+┊   ┊254┊            variables: {\n+┊   ┊255┊              amount: this.messagesAmount,\n+┊   ┊256┊            },\n+┊   ┊257┊          });\n+┊   ┊258┊          // Add our comment from the mutation to the end.\n+┊   ┊259┊          chats.push(addChat);\n+┊   ┊260┊          // Write our data back to the cache.\n+┊   ┊261┊          store.writeQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊262┊            query: this.getChatsGQL.document,\n+┊   ┊263┊            variables: {\n+┊   ┊264┊              amount: this.messagesAmount,\n+┊   ┊265┊            },\n+┊   ┊266┊            data: {\n+┊   ┊267┊              chats,\n+┊   ┊268┊            },\n+┊   ┊269┊          });\n+┊   ┊270┊        },\n+┊   ┊271┊      }\n+┊   ┊272┊    );\n+┊   ┊273┊  }\n+┊   ┊274┊\n+┊   ┊275┊  addGroup(recipientIds: string[], groupName: string) {\n+┊   ┊276┊    return this.addGroupGQL.mutate(\n+┊   ┊277┊      {\n+┊   ┊278┊        recipientIds,\n+┊   ┊279┊        groupName,\n+┊   ┊280┊      }, {\n+┊   ┊281┊        update: (store, { data: { addGroup } }) => {\n+┊   ┊282┊          // Read the data from our cache for this query.\n+┊   ┊283┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊284┊            query: this.getChatsGQL.document,\n+┊   ┊285┊            variables: {\n+┊   ┊286┊              amount: this.messagesAmount,\n+┊   ┊287┊            },\n+┊   ┊288┊          });\n+┊   ┊289┊          // Add our comment from the mutation to the end.\n+┊   ┊290┊          chats.push(addGroup);\n+┊   ┊291┊          // Write our data back to the cache.\n+┊   ┊292┊          store.writeQuery<GetChats.Query, GetChats.Variables>({\n+┊   ┊293┊            query: this.getChatsGQL.document,\n+┊   ┊294┊            variables: {\n+┊   ┊295┊              amount: this.messagesAmount,\n+┊   ┊296┊            },\n+┊   ┊297┊            data: {\n+┊   ┊298┊              chats,\n+┊   ┊299┊            },\n+┊   ┊300┊          });\n+┊   ┊301┊        },\n+┊   ┊302┊      }\n+┊   ┊303┊    );\n+┊   ┊304┊  }\n ┊212┊305┊}\n```\n\n[}]: #\n\nThey're both missing few components:\n\n**UsersList**\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/app/chats-creation/components/users-list/users-list.component.ts, src/app/chats-creation/components/users-list/users-list.component.scss\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;users-list&#x2F;users-list.component.scss\n```diff\n@@ -0,0 +1,13 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊}\n+┊  ┊ 4┊\n+┊  ┊ 5┊:host ::ng-deep mat-list-item:first-child div:first-child {\n+┊  ┊ 6┊  padding: 0 !important;\n+┊  ┊ 7┊  margin: 5px;\n+┊  ┊ 8┊  margin-top: 20px;\n+┊  ┊ 9┊}\n+┊  ┊10┊\n+┊  ┊11┊mat-list {\n+┊  ┊12┊  padding: 0;\n+┊  ┊13┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;users-list&#x2F;users-list.component.ts\n```diff\n@@ -0,0 +1,24 @@\n+┊  ┊ 1┊import {Component, Input} from '@angular/core';\n+┊  ┊ 2┊import {GetUsers} from '../../../../graphql';\n+┊  ┊ 3┊import {SelectableListDirective} from 'ngx-selectable-list';\n+┊  ┊ 4┊\n+┊  ┊ 5┊@Component({\n+┊  ┊ 6┊  selector: 'app-users-list',\n+┊  ┊ 7┊  template: `\n+┊  ┊ 8┊    <mat-list>\n+┊  ┊ 9┊      <mat-list-item *ngFor=\"let user of users\">\n+┊  ┊10┊        <app-user-item [item]=\"user\"\n+┊  ┊11┊                       libSelectableItem></app-user-item>\n+┊  ┊12┊      </mat-list-item>\n+┊  ┊13┊    </mat-list>\n+┊  ┊14┊    <ng-content *ngIf=\"selectableListDirective.selecting\"></ng-content>\n+┊  ┊15┊  `,\n+┊  ┊16┊  styleUrls: ['users-list.component.scss'],\n+┊  ┊17┊})\n+┊  ┊18┊export class UsersListComponent {\n+┊  ┊19┊  // tslint:disable-next-line:no-input-rename\n+┊  ┊20┊  @Input('items')\n+┊  ┊21┊  users: GetUsers.Users[];\n+┊  ┊22┊\n+┊  ┊23┊  constructor(public selectableListDirective: SelectableListDirective) {}\n+┊  ┊24┊}\n```\n\n[}]: #\n\n**UserItem**\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/app/chats-creation/components/user-item/user-item.component.ts, src/app/chats-creation/components/user-item/user-item.component.scss\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;user-item&#x2F;user-item.component.scss\n```diff\n@@ -0,0 +1,32 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊  width: 100%;\n+┊  ┊ 4┊  height: 100%;\n+┊  ┊ 5┊}\n+┊  ┊ 6┊\n+┊  ┊ 7┊button {\n+┊  ┊ 8┊  margin: 10px;\n+┊  ┊ 9┊  height: 50px;\n+┊  ┊10┊  padding: 1px 6px;\n+┊  ┊11┊  line-height: 50px;\n+┊  ┊12┊  border: none;\n+┊  ┊13┊  margin: 0;\n+┊  ┊14┊\n+┊  ┊15┊  img {\n+┊  ┊16┊    float: left;\n+┊  ┊17┊    margin-right: 10px;\n+┊  ┊18┊    height: 50px;\n+┊  ┊19┊    width: 50px;\n+┊  ┊20┊    text-align: center;\n+┊  ┊21┊    line-height: inherit;\n+┊  ┊22┊    border-radius: 50%;\n+┊  ┊23┊  }\n+┊  ┊24┊\n+┊  ┊25┊  div {\n+┊  ┊26┊    float: left;\n+┊  ┊27┊    line-height: inherit;\n+┊  ┊28┊    font-family: Roboto, \"Helvetica Neue\", sans-serif;\n+┊  ┊29┊    font-weight: bold;\n+┊  ┊30┊    font-size: 16px;\n+┊  ┊31┊  }\n+┊  ┊32┊}🚫↵\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;user-item&#x2F;user-item.component.ts\n```diff\n@@ -0,0 +1,18 @@\n+┊  ┊ 1┊import {Component, Input} from '@angular/core';\n+┊  ┊ 2┊import {GetUsers} from '../../../../graphql';\n+┊  ┊ 3┊\n+┊  ┊ 4┊@Component({\n+┊  ┊ 5┊  selector: 'app-user-item',\n+┊  ┊ 6┊  template: `\n+┊  ┊ 7┊    <button mat-menu-item>\n+┊  ┊ 8┊      <img [src]=\"user.picture || 'assets/default-profile-pic.jpg'\">\n+┊  ┊ 9┊      <div>{{ user.name }}</div>\n+┊  ┊10┊    </button>\n+┊  ┊11┊  `,\n+┊  ┊12┊  styleUrls: ['user-item.component.scss']\n+┊  ┊13┊})\n+┊  ┊14┊export class UserItemComponent {\n+┊  ┊15┊  // tslint:disable-next-line:no-input-rename\n+┊  ┊16┊  @Input('item')\n+┊  ┊17┊  user: GetUsers.Users;\n+┊  ┊18┊}\n```\n\n[}]: #\n\n**NewGroupDetails**\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/app/chats-creation/components/new-group-details/new-group-details.component.ts, src/app/chats-creation/components/new-group-details/new-group-details.component.scss\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;new-group-details&#x2F;new-group-details.component.scss\n```diff\n@@ -0,0 +1,25 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊}\n+┊  ┊ 4┊\n+┊  ┊ 5┊div {\n+┊  ┊ 6┊  padding: 16px;\n+┊  ┊ 7┊  mat-form-field {\n+┊  ┊ 8┊    width: 100%;\n+┊  ┊ 9┊  }\n+┊  ┊10┊}\n+┊  ┊11┊\n+┊  ┊12┊.new-group {\n+┊  ┊13┊  position: absolute;\n+┊  ┊14┊  bottom: 5vw;\n+┊  ┊15┊  right: 5vw;\n+┊  ┊16┊}\n+┊  ┊17┊\n+┊  ┊18┊.users {\n+┊  ┊19┊  display: flex;\n+┊  ┊20┊  flex-flow: row wrap;\n+┊  ┊21┊  img {\n+┊  ┊22┊    flex: 0 1 8vh;\n+┊  ┊23┊    height: 8vh;\n+┊  ┊24┊  }\n+┊  ┊25┊}\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;new-group-details&#x2F;new-group-details.component.ts\n```diff\n@@ -0,0 +1,34 @@\n+┊  ┊ 1┊import {Component, EventEmitter, Input, Output} from '@angular/core';\n+┊  ┊ 2┊import {GetUsers} from '../../../../graphql';\n+┊  ┊ 3┊\n+┊  ┊ 4┊@Component({\n+┊  ┊ 5┊  selector: 'app-new-group-details',\n+┊  ┊ 6┊  template: `\n+┊  ┊ 7┊    <div>\n+┊  ┊ 8┊      <mat-form-field>\n+┊  ┊ 9┊        <input matInput placeholder=\"Group name\" [(ngModel)]=\"groupName\">\n+┊  ┊10┊      </mat-form-field>\n+┊  ┊11┊    </div>\n+┊  ┊12┊    <button [disabled]=\"!groupName\" class=\"new-group\" mat-fab color=\"primary\" (click)=\"emitGroupDetails()\">\n+┊  ┊13┊      <mat-icon aria-label=\"Icon-button with a + icon\">arrow_forward</mat-icon>\n+┊  ┊14┊    </button>\n+┊  ┊15┊    <div>Members</div>\n+┊  ┊16┊    <div class=\"users\">\n+┊  ┊17┊      <img *ngFor=\"let user of users;\" [src]=\"user.picture\"/>\n+┊  ┊18┊    </div>\n+┊  ┊19┊  `,\n+┊  ┊20┊  styleUrls: ['new-group-details.component.scss'],\n+┊  ┊21┊})\n+┊  ┊22┊export class NewGroupDetailsComponent {\n+┊  ┊23┊  groupName: string;\n+┊  ┊24┊  @Input()\n+┊  ┊25┊  users: GetUsers.Users[];\n+┊  ┊26┊  @Output()\n+┊  ┊27┊  groupDetails = new EventEmitter<string>();\n+┊  ┊28┊\n+┊  ┊29┊  emitGroupDetails() {\n+┊  ┊30┊    if (this.groupDetails) {\n+┊  ┊31┊      this.groupDetails.emit(this.groupName);\n+┊  ┊32┊    }\n+┊  ┊33┊  }\n+┊  ┊34┊}\n```\n\n[}]: #\n\nWith all that, we can now link NewChat component with Chat container:\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/app/chats-lister/containers/chats/chats.component.ts, src/app/chat-viewer/containers/chat/chat.component.spec.ts\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.spec.ts\n```diff\n@@ -143,7 +143,9 @@\n ┊143┊143┊    component = fixture.componentInstance;\n ┊144┊144┊    fixture.detectChanges();\n ┊145┊145┊\n-┊146┊   ┊    const req = controller.expectOne('GetChat', 'call to api');\n+┊   ┊146┊    controller.expectOne('GetChats', 'call to getChats api');\n+┊   ┊147┊\n+┊   ┊148┊    const req = controller.expectOne('GetChat', 'call to getChat api');\n ┊147┊149┊\n ┊148┊150┊    req.flush({\n ┊149┊151┊      data: {\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.ts\n```diff\n@@ -34,7 +34,7 @@\n ┊34┊34┊      <app-confirm-selection #confirmSelection></app-confirm-selection>\n ┊35┊35┊    </app-chats-list>\n ┊36┊36┊\n-┊37┊  ┊    <button *ngIf=\"!isSelecting\" class=\"chat-button\" mat-fab color=\"secondary\">\n+┊  ┊37┊    <button *ngIf=\"!isSelecting\" class=\"chat-button\" mat-fab color=\"secondary\" (click)=\"goToNewChat()\">\n ┊38┊38┊      <mat-icon aria-label=\"Icon-button with a + icon\">chat</mat-icon>\n ┊39┊39┊    </button>\n ┊40┊40┊  `,\n```\n```diff\n@@ -56,6 +56,10 @@\n ┊56┊56┊    this.router.navigate(['/chat', chatId]);\n ┊57┊57┊  }\n ┊58┊58┊\n+┊  ┊59┊  goToNewChat() {\n+┊  ┊60┊    this.router.navigate(['/new-chat']);\n+┊  ┊61┊  }\n+┊  ┊62┊\n ┊59┊63┊  deleteChats(chatIds: string[]) {\n ┊60┊64┊    chatIds.forEach(chatId => {\n ┊61┊65┊      this.chatsService.removeChat(chatId).subscribe();\n```\n\n[}]: #\n\nNow let's wrap it all together within the `ChatsCreation` module:\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/app/chats-creation/chats-creation.module.ts, src/app/app.module.ts\" module=\"client\")\n\n#### [Step 8.1: New chats and groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/d4dface)\n\n##### Changed src&#x2F;app&#x2F;app.module.ts\n```diff\n@@ -7,6 +7,7 @@\n ┊ 7┊ 7┊import {ChatsListerModule} from './chats-lister/chats-lister.module';\n ┊ 8┊ 8┊import {RouterModule, Routes} from '@angular/router';\n ┊ 9┊ 9┊import {ChatViewerModule} from './chat-viewer/chat-viewer.module';\n+┊  ┊10┊import {ChatsCreationModule} from './chats-creation/chats-creation.module';\n ┊10┊11┊const routes: Routes = [];\n ┊11┊12┊\n ┊12┊13┊@NgModule({\n```\n```diff\n@@ -22,6 +23,7 @@\n ┊22┊23┊    // Feature modules\n ┊23┊24┊    ChatsListerModule,\n ┊24┊25┊    ChatViewerModule,\n+┊  ┊26┊    ChatsCreationModule,\n ┊25┊27┊  ],\n ┊26┊28┊  providers: [],\n ┊27┊29┊  bootstrap: [AppComponent]\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;chats-creation.module.ts\n```diff\n@@ -0,0 +1,60 @@\n+┊  ┊ 1┊import { BrowserModule } from '@angular/platform-browser';\n+┊  ┊ 2┊import { NgModule } from '@angular/core';\n+┊  ┊ 3┊\n+┊  ┊ 4┊import {BrowserAnimationsModule} from '@angular/platform-browser/animations';\n+┊  ┊ 5┊import {\n+┊  ┊ 6┊  MatButtonModule, MatFormFieldModule, MatGridListModule, MatIconModule, MatInputModule, MatListModule, MatMenuModule,\n+┊  ┊ 7┊  MatToolbarModule\n+┊  ┊ 8┊} from '@angular/material';\n+┊  ┊ 9┊import {RouterModule, Routes} from '@angular/router';\n+┊  ┊10┊import {FormsModule} from '@angular/forms';\n+┊  ┊11┊import {ChatsService} from '../services/chats.service';\n+┊  ┊12┊import {UserItemComponent} from './components/user-item/user-item.component';\n+┊  ┊13┊import {UsersListComponent} from './components/users-list/users-list.component';\n+┊  ┊14┊import {NewGroupComponent} from './containers/new-group/new-group.component';\n+┊  ┊15┊import {NewChatComponent} from './containers/new-chat/new-chat.component';\n+┊  ┊16┊import {NewGroupDetailsComponent} from './components/new-group-details/new-group-details.component';\n+┊  ┊17┊import {SharedModule} from '../shared/shared.module';\n+┊  ┊18┊import {NgxSelectableListModule} from 'ngx-selectable-list';\n+┊  ┊19┊\n+┊  ┊20┊const routes: Routes = [\n+┊  ┊21┊  {path: 'new-chat', component: NewChatComponent},\n+┊  ┊22┊  {path: 'new-group', component: NewGroupComponent},\n+┊  ┊23┊];\n+┊  ┊24┊\n+┊  ┊25┊@NgModule({\n+┊  ┊26┊  declarations: [\n+┊  ┊27┊    NewChatComponent,\n+┊  ┊28┊    UsersListComponent,\n+┊  ┊29┊    NewGroupComponent,\n+┊  ┊30┊    UserItemComponent,\n+┊  ┊31┊    NewGroupDetailsComponent,\n+┊  ┊32┊  ],\n+┊  ┊33┊  imports: [\n+┊  ┊34┊    BrowserModule,\n+┊  ┊35┊    // Animations (for Material)\n+┊  ┊36┊    BrowserAnimationsModule,\n+┊  ┊37┊    // Material\n+┊  ┊38┊    MatToolbarModule,\n+┊  ┊39┊    MatMenuModule,\n+┊  ┊40┊    MatIconModule,\n+┊  ┊41┊    MatButtonModule,\n+┊  ┊42┊    MatListModule,\n+┊  ┊43┊    MatGridListModule,\n+┊  ┊44┊    MatInputModule,\n+┊  ┊45┊    MatFormFieldModule,\n+┊  ┊46┊    MatGridListModule,\n+┊  ┊47┊    // Routing\n+┊  ┊48┊    RouterModule.forChild(routes),\n+┊  ┊49┊    // Forms\n+┊  ┊50┊    FormsModule,\n+┊  ┊51┊    // Feature modules\n+┊  ┊52┊    NgxSelectableListModule,\n+┊  ┊53┊    SharedModule,\n+┊  ┊54┊  ],\n+┊  ┊55┊  providers: [\n+┊  ┊56┊    ChatsService,\n+┊  ┊57┊  ],\n+┊  ┊58┊})\n+┊  ┊59┊export class ChatsCreationModule {\n+┊  ┊60┊}\n```\n\n[}]: #"
          },
          {
            "manualTitle": "Step 13: Zero latency on slow 3g networks",
            "stepRevision": "810cc1ec3030d51cec02928dfb862b0b3ed6df90",
            "manualView": "## Client\n\nNow let's start our client in production mode:\n\n    yarn start --prod\n\nNow open the **Chrome Developers Tools** and, in the **Network tab**, select `Slow 3G Network` and `Disable cache`.\nThen refresh the page and look at the `DOMContentLoaded` time and at the transferred size. You'll notice that our bundle size is quite small and so the loads time.\n\nNow let's click on a specific chat. It will take some time to load the data and then add a new message.\nOnce again it will take some time to load the data.\nWe could also create a new chat and the result would be the same.\nThe whole app doesn't feel as snappier as the real Whatsapp on a slow 3G Network.\n\n\"That's normal, it's a web application with a remote db while Whatsapp is a native app with a local database...\"\nThat's just an excuse, because we can do as good as Whatsapp thanks to Apollo!\n\nLet's install `moment`, we will soon need it:\n\n    yarn add moment\n\nStart by making our UI optimistic. We can predict most of the response we will get from our server, except for a few things like `id` of newly created messages. But since we don't really need that id, we can simply generate a fake one\nwhich will be later overridden once we get the response from the server:\n\n[{]: <helper> (diffStep \"9.1\" files=\"^\\(?!package.json$\\).*\" module=\"client\")\n\n#### [Step 9.1: Optimistic updates](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/39432fa)\n\n##### Changed src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-chat&#x2F;new-chat.component.ts\n```diff\n@@ -47,7 +47,7 @@\n ┊47┊47┊      // Chat is already listed for the current user\n ┊48┊48┊      this.router.navigate(['/chat', chatId]);\n ┊49┊49┊    } else {\n-┊50┊  ┊      this.chatsService.addChat(recipientId).subscribe(({data: {addChat: {id}}}: { data: AddChat.Mutation }) => {\n+┊  ┊50┊      this.chatsService.addChat(recipientId, this.users).subscribe(({data: {addChat: {id}}}: { data: AddChat.Mutation }) => {\n ┊51┊51┊        this.router.navigate(['/chat', id]);\n ┊52┊52┊      });\n ┊53┊53┊    }\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -2,6 +2,7 @@\n ┊2┊2┊import {Injectable} from '@angular/core';\n ┊3┊3┊import {Observable} from 'rxjs';\n ┊4┊4┊import {QueryRef} from 'apollo-angular';\n+┊ ┊5┊import * as moment from 'moment';\n ┊5┊6┊import {\n ┊6┊7┊  GetChatsGQL,\n ┊7┊8┊  GetChatGQL,\n```\n```diff\n@@ -17,10 +18,12 @@\n ┊17┊18┊  GetChat,\n ┊18┊19┊  RemoveMessages,\n ┊19┊20┊  RemoveAllMessages,\n+┊  ┊21┊  GetUsers,\n ┊20┊22┊} from '../../graphql';\n ┊21┊23┊import { DataProxy } from 'apollo-cache';\n ┊22┊24┊\n ┊23┊25┊const currentUserId = '1';\n+┊  ┊26┊const currentUserName = 'Ethan Gonzalez';\n ┊24┊27┊\n ┊25┊28┊@Injectable()\n ┊26┊29┊export class ChatsService {\n```\n```diff\n@@ -49,6 +52,10 @@\n ┊49┊52┊    this.chats$.subscribe(chats => this.chats = chats);\n ┊50┊53┊  }\n ┊51┊54┊\n+┊  ┊55┊  static getRandomId() {\n+┊  ┊56┊    return String(Math.round(Math.random() * 1000000000000));\n+┊  ┊57┊  }\n+┊  ┊58┊\n ┊52┊59┊  getChats() {\n ┊53┊60┊    return {query: this.getChatsWq, chats$: this.chats$};\n ┊54┊61┊  }\n```\n```diff\n@@ -70,6 +77,24 @@\n ┊ 70┊ 77┊      chatId,\n ┊ 71┊ 78┊      content,\n ┊ 72┊ 79┊    }, {\n+┊   ┊ 80┊      optimisticResponse: {\n+┊   ┊ 81┊        __typename: 'Mutation',\n+┊   ┊ 82┊        addMessage: {\n+┊   ┊ 83┊          id: ChatsService.getRandomId(),\n+┊   ┊ 84┊          __typename: 'Message',\n+┊   ┊ 85┊          senderId: currentUserId,\n+┊   ┊ 86┊          sender: {\n+┊   ┊ 87┊            id: currentUserId,\n+┊   ┊ 88┊            __typename: 'User',\n+┊   ┊ 89┊            name: currentUserName,\n+┊   ┊ 90┊          },\n+┊   ┊ 91┊          content,\n+┊   ┊ 92┊          createdAt: moment().unix(),\n+┊   ┊ 93┊          type: 0,\n+┊   ┊ 94┊          recipients: [],\n+┊   ┊ 95┊          ownership: true,\n+┊   ┊ 96┊        },\n+┊   ┊ 97┊      },\n ┊ 73┊ 98┊      update: (store, { data: { addMessage } }: {data: AddMessage.Mutation}) => {\n ┊ 74┊ 99┊        // Update the messages cache\n ┊ 75┊100┊        {\n```\n```diff\n@@ -121,6 +146,10 @@\n ┊121┊146┊      {\n ┊122┊147┊        chatId,\n ┊123┊148┊      }, {\n+┊   ┊149┊        optimisticResponse: {\n+┊   ┊150┊          __typename: 'Mutation',\n+┊   ┊151┊          removeChat: chatId,\n+┊   ┊152┊        },\n ┊124┊153┊        update: (store, { data: { removeChat } }) => {\n ┊125┊154┊          // Read the data from our cache for this query.\n ┊126┊155┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n```\n```diff\n@@ -154,6 +183,10 @@\n ┊154┊183┊    let ids: string[] = [];\n ┊155┊184┊\n ┊156┊185┊    const options = {\n+┊   ┊186┊      optimisticResponse: () => ({\n+┊   ┊187┊        __typename: 'Mutation',\n+┊   ┊188┊        removeMessages: ids,\n+┊   ┊189┊      }),\n ┊157┊190┊      update: (store: DataProxy, { data: { removeMessages } }: {data: RemoveMessages.Mutation | RemoveAllMessages.Mutation}) => {\n ┊158┊191┊        // Update the messages cache\n ┊159┊192┊        {\n```\n```diff\n@@ -242,11 +275,33 @@\n ┊242┊275┊    return _chat ? _chat.id : false;\n ┊243┊276┊  }\n ┊244┊277┊\n-┊245┊   ┊  addChat(recipientId: string) {\n+┊   ┊278┊  addChat(recipientId: string, users: GetUsers.Users[]) {\n ┊246┊279┊    return this.addChatGQL.mutate(\n ┊247┊280┊      {\n ┊248┊281┊        recipientId,\n ┊249┊282┊      }, {\n+┊   ┊283┊        optimisticResponse: {\n+┊   ┊284┊          __typename: 'Mutation',\n+┊   ┊285┊          addChat: {\n+┊   ┊286┊            id: ChatsService.getRandomId(),\n+┊   ┊287┊            __typename: 'Chat',\n+┊   ┊288┊            name: users.find(user => user.id === recipientId).name,\n+┊   ┊289┊            picture: users.find(user => user.id === recipientId).picture,\n+┊   ┊290┊            allTimeMembers: [\n+┊   ┊291┊              {\n+┊   ┊292┊                id: currentUserId,\n+┊   ┊293┊                __typename: 'User',\n+┊   ┊294┊              },\n+┊   ┊295┊              {\n+┊   ┊296┊                id: recipientId,\n+┊   ┊297┊                __typename: 'User',\n+┊   ┊298┊              }\n+┊   ┊299┊            ],\n+┊   ┊300┊            unreadMessages: 0,\n+┊   ┊301┊            messages: [],\n+┊   ┊302┊            isGroup: false,\n+┊   ┊303┊          },\n+┊   ┊304┊        },\n ┊250┊305┊        update: (store, { data: { addChat } }) => {\n ┊251┊306┊          // Read the data from our cache for this query.\n ┊252┊307┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n```\n```diff\n@@ -278,6 +333,26 @@\n ┊278┊333┊        recipientIds,\n ┊279┊334┊        groupName,\n ┊280┊335┊      }, {\n+┊   ┊336┊        optimisticResponse: {\n+┊   ┊337┊          __typename: 'Mutation',\n+┊   ┊338┊          addGroup: {\n+┊   ┊339┊            id: ChatsService.getRandomId(),\n+┊   ┊340┊            __typename: 'Chat',\n+┊   ┊341┊            name: groupName,\n+┊   ┊342┊            picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n+┊   ┊343┊            userIds: [currentUserId, recipientIds],\n+┊   ┊344┊            allTimeMembers: [\n+┊   ┊345┊              {\n+┊   ┊346┊                id: currentUserId,\n+┊   ┊347┊                __typename: 'User',\n+┊   ┊348┊              },\n+┊   ┊349┊              ...recipientIds.map(id => ({id, __typename: 'User'})),\n+┊   ┊350┊            ],\n+┊   ┊351┊            unreadMessages: 0,\n+┊   ┊352┊            messages: [],\n+┊   ┊353┊            isGroup: true,\n+┊   ┊354┊          },\n+┊   ┊355┊        },\n ┊281┊356┊        update: (store, { data: { addGroup } }) => {\n ┊282┊357┊          // Read the data from our cache for this query.\n ┊283┊358┊          const {chats} = store.readQuery<GetChats.Query, GetChats.Variables>({\n```\n\n[}]: #\n\nWhen we open a specific chat we can also preload some data from our chats list cache while waiting for the server response. We will initially be able to show only the chat name, the last message or the last few messages and a few more informations instead of the whole content from the server, but that would be more than enough to entertain the user while waiting for the server response:\n\n[{]: <helper> (diffStep \"9.2\" module=\"client\")\n\n#### [Step 9.2: Get chat data from chats cache while waiting for server response](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/632468a)\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,6 +1,6 @@\n-┊1┊ ┊import {map} from 'rxjs/operators';\n+┊ ┊1┊import {concat, map} from 'rxjs/operators';\n ┊2┊2┊import {Injectable} from '@angular/core';\n-┊3┊ ┊import {Observable} from 'rxjs';\n+┊ ┊3┊import {Observable, AsyncSubject, of} from 'rxjs';\n ┊4┊4┊import {QueryRef} from 'apollo-angular';\n ┊5┊5┊import * as moment from 'moment';\n ┊6┊6┊import {\n```\n```diff\n@@ -31,6 +31,7 @@\n ┊31┊31┊  getChatsWq: QueryRef<GetChats.Query, GetChats.Variables>;\n ┊32┊32┊  chats$: Observable<GetChats.Chats[]>;\n ┊33┊33┊  chats: GetChats.Chats[];\n+┊  ┊34┊  getChatWqSubject: AsyncSubject<QueryRef<GetChat.Query>>;\n ┊34┊35┊\n ┊35┊36┊  constructor(\n ┊36┊37┊    private getChatsGQL: GetChatsGQL,\n```\n```diff\n@@ -61,15 +62,34 @@\n ┊61┊62┊  }\n ┊62┊63┊\n ┊63┊64┊  getChat(chatId: string) {\n+┊  ┊65┊    const _chat = this.chats && this.chats.find(chat => chat.id === chatId) || {\n+┊  ┊66┊      id: chatId,\n+┊  ┊67┊      name: '',\n+┊  ┊68┊      picture: null,\n+┊  ┊69┊      allTimeMembers: [],\n+┊  ┊70┊      unreadMessages: 0,\n+┊  ┊71┊      isGroup: false,\n+┊  ┊72┊      messages: [],\n+┊  ┊73┊    };\n+┊  ┊74┊    const chat$FromCache = of<GetChat.Chat>(_chat);\n+┊  ┊75┊\n ┊64┊76┊    const query = this.getChatGQL.watch({\n ┊65┊77┊      chatId: chatId,\n ┊66┊78┊    });\n ┊67┊79┊\n-┊68┊  ┊    const chat$ = query.valueChanges.pipe(\n-┊69┊  ┊      map((result) => result.data.chat)\n+┊  ┊80┊    const chat$ = chat$FromCache.pipe(\n+┊  ┊81┊      concat(\n+┊  ┊82┊        query.valueChanges.pipe(\n+┊  ┊83┊          map((result) => result.data.chat)\n+┊  ┊84┊        )\n+┊  ┊85┊      )\n ┊70┊86┊    );\n ┊71┊87┊\n-┊72┊  ┊    return {query, chat$};\n+┊  ┊88┊    this.getChatWqSubject = new AsyncSubject();\n+┊  ┊89┊    this.getChatWqSubject.next(query);\n+┊  ┊90┊    this.getChatWqSubject.complete();\n+┊  ┊91┊\n+┊  ┊92┊    return {query$: this.getChatWqSubject.asObservable(), chat$};\n ┊73┊93┊  }\n ┊74┊94┊\n ┊75┊95┊  addMessage(chatId: string, content: string) {\n```\n\n[}]: #\n\nNow let's deal with the most difficult part, chats creation.\n\nWe cannot predict the `id` of the new chat and so we cannot navigate to the chat page because it contains the chat id in the url. We could simply navigate to the \"optimistic\" id, but then the user wouldn't be able to reach that url if he refreshes the page or bookmarks it. That's a problem we care about.\n\nHow to solve it? We're going to create a landing page and we will later override the url once we get the response from the server!\n\n[{]: <helper> (diffStep \"9.3\" module=\"client\")\n\n#### [Step 9.3: Landing page for new chats/groups](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/87b9f5d)\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.spec.ts\n```diff\n@@ -129,7 +129,10 @@\n ┊129┊129┊        },\n ┊130┊130┊        {\n ┊131┊131┊          provide: ActivatedRoute,\n-┊132┊   ┊          useValue: { params: of({ id: chat.id }) },\n+┊   ┊132┊          useValue: {\n+┊   ┊133┊            params: of({ id: chat.id }),\n+┊   ┊134┊            queryParams: of({}),\n+┊   ┊135┊          },\n ┊133┊136┊        },\n ┊134┊137┊      ],\n ┊135┊138┊      schemas: [NO_ERRORS_SCHEMA],\n```\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.ts\n```diff\n@@ -2,6 +2,8 @@\n ┊2┊2┊import {ActivatedRoute, Router} from '@angular/router';\n ┊3┊3┊import {ChatsService} from '../../../services/chats.service';\n ┊4┊4┊import {GetChat} from '../../../../graphql';\n+┊ ┊5┊import {combineLatest} from 'rxjs';\n+┊ ┊6┊import {Location} from '@angular/common';\n ┊5┊7┊\n ┊6┊8┊@Component({\n ┊7┊9┊  template: `\n```\n```diff\n@@ -27,21 +29,40 @@\n ┊27┊29┊  messages: GetChat.Messages[];\n ┊28┊30┊  name: string;\n ┊29┊31┊  isGroup: boolean;\n+┊  ┊32┊  optimisticUI: boolean;\n ┊30┊33┊\n ┊31┊34┊  constructor(private route: ActivatedRoute,\n ┊32┊35┊              private router: Router,\n+┊  ┊36┊              private location: Location,\n ┊33┊37┊              private chatsService: ChatsService) {\n ┊34┊38┊  }\n ┊35┊39┊\n ┊36┊40┊  ngOnInit() {\n-┊37┊  ┊    this.route.params.subscribe(({id: chatId}) => {\n-┊38┊  ┊      this.chatId = chatId;\n-┊39┊  ┊      this.chatsService.getChat(chatId).chat$.subscribe(chat => {\n-┊40┊  ┊        this.messages = chat.messages;\n-┊41┊  ┊        this.name = chat.name;\n-┊42┊  ┊        this.isGroup = chat.isGroup;\n+┊  ┊41┊    combineLatest(this.route.params, this.route.queryParams,\n+┊  ┊42┊      (params: { id: string }, queryParams: { oui?: boolean }) => ({params, queryParams}))\n+┊  ┊43┊      .subscribe(({params: {id: chatId}, queryParams: {oui}}) => {\n+┊  ┊44┊        this.chatId = chatId;\n+┊  ┊45┊\n+┊  ┊46┊        this.optimisticUI = oui;\n+┊  ┊47┊\n+┊  ┊48┊        if (this.optimisticUI) {\n+┊  ┊49┊          // We are using fake IDs generated by the Optimistic UI\n+┊  ┊50┊          this.chatsService.addChat$.subscribe(({data: {addChat, addGroup}}) => {\n+┊  ┊51┊            this.chatId = addChat ? addChat.id : addGroup.id;\n+┊  ┊52┊            console.log(`Switching from the Optimistic UI id ${chatId} to ${this.chatId}`);\n+┊  ┊53┊            // Rewrite the URL\n+┊  ┊54┊            this.location.go(`chat/${this.chatId}`);\n+┊  ┊55┊            // Optimistic UI no more\n+┊  ┊56┊            this.optimisticUI = false;\n+┊  ┊57┊          });\n+┊  ┊58┊        }\n+┊  ┊59┊\n+┊  ┊60┊        this.chatsService.getChat(chatId, this.optimisticUI).chat$.subscribe(chat => {\n+┊  ┊61┊          this.messages = chat.messages;\n+┊  ┊62┊          this.name = chat.name;\n+┊  ┊63┊          this.isGroup = chat.isGroup;\n+┊  ┊64┊        });\n ┊43┊65┊      });\n-┊44┊  ┊    });\n ┊45┊66┊  }\n ┊46┊67┊\n ┊47┊68┊  goToChats() {\n```\n\n##### Changed src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-chat&#x2F;new-chat.component.ts\n```diff\n@@ -47,9 +47,10 @@\n ┊47┊47┊      // Chat is already listed for the current user\n ┊48┊48┊      this.router.navigate(['/chat', chatId]);\n ┊49┊49┊    } else {\n-┊50┊  ┊      this.chatsService.addChat(recipientId, this.users).subscribe(({data: {addChat: {id}}}: { data: AddChat.Mutation }) => {\n-┊51┊  ┊        this.router.navigate(['/chat', id]);\n-┊52┊  ┊      });\n+┊  ┊50┊      // Generate id for Optimistic UI\n+┊  ┊51┊      const ouiId = ChatsService.getRandomId();\n+┊  ┊52┊      this.chatsService.addChat(recipientId, this.users, ouiId).subscribe();\n+┊  ┊53┊      this.router.navigate(['/chat', ouiId], {queryParams: {oui: true}, skipLocationChange: true});\n ┊53┊54┊    }\n ┊54┊55┊  }\n ┊55┊56┊}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-group&#x2F;new-group.component.ts\n```diff\n@@ -52,9 +52,9 @@\n ┊52┊52┊\n ┊53┊53┊  addGroup(groupName: string) {\n ┊54┊54┊    if (groupName && this.recipientIds.length) {\n-┊55┊  ┊      this.chatsService.addGroup(this.recipientIds, groupName).subscribe(({data: {addGroup: {id}}}: { data: AddGroup.Mutation }) => {\n-┊56┊  ┊        this.router.navigate(['/chat', id]);\n-┊57┊  ┊      });\n+┊  ┊55┊      const ouiId = ChatsService.getRandomId();\n+┊  ┊56┊      this.chatsService.addGroup(this.recipientIds, groupName, ouiId).subscribe();\n+┊  ┊57┊      this.router.navigate(['/chat', ouiId], {queryParams: {oui: true}, skipLocationChange: true});\n ┊58┊58┊    }\n ┊59┊59┊  }\n ┊60┊60┊}\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,4 +1,4 @@\n-┊1┊ ┊import {concat, map} from 'rxjs/operators';\n+┊ ┊1┊import {concat, map, share, switchMap} from 'rxjs/operators';\n ┊2┊2┊import {Injectable} from '@angular/core';\n ┊3┊3┊import {Observable, AsyncSubject, of} from 'rxjs';\n ┊4┊4┊import {QueryRef} from 'apollo-angular';\n```\n```diff\n@@ -19,8 +19,11 @@\n ┊19┊19┊  RemoveMessages,\n ┊20┊20┊  RemoveAllMessages,\n ┊21┊21┊  GetUsers,\n+┊  ┊22┊  AddChat,\n+┊  ┊23┊  AddGroup,\n ┊22┊24┊} from '../../graphql';\n ┊23┊25┊import { DataProxy } from 'apollo-cache';\n+┊  ┊26┊import { FetchResult } from 'apollo-link';\n ┊24┊27┊\n ┊25┊28┊const currentUserId = '1';\n ┊26┊29┊const currentUserName = 'Ethan Gonzalez';\n```\n```diff\n@@ -32,6 +35,7 @@\n ┊32┊35┊  chats$: Observable<GetChats.Chats[]>;\n ┊33┊36┊  chats: GetChats.Chats[];\n ┊34┊37┊  getChatWqSubject: AsyncSubject<QueryRef<GetChat.Query>>;\n+┊  ┊38┊  addChat$: Observable<FetchResult<AddChat.Mutation | AddGroup.Mutation>>;\n ┊35┊39┊\n ┊36┊40┊  constructor(\n ┊37┊41┊    private getChatsGQL: GetChatsGQL,\n```\n```diff\n@@ -61,7 +65,7 @@\n ┊61┊65┊    return {query: this.getChatsWq, chats$: this.chats$};\n ┊62┊66┊  }\n ┊63┊67┊\n-┊64┊  ┊  getChat(chatId: string) {\n+┊  ┊68┊  getChat(chatId: string, oui?: boolean) {\n ┊65┊69┊    const _chat = this.chats && this.chats.find(chat => chat.id === chatId) || {\n ┊66┊70┊      id: chatId,\n ┊67┊71┊      name: '',\n```\n```diff\n@@ -73,21 +77,43 @@\n ┊ 73┊ 77┊    };\n ┊ 74┊ 78┊    const chat$FromCache = of<GetChat.Chat>(_chat);\n ┊ 75┊ 79┊\n-┊ 76┊   ┊    const query = this.getChatGQL.watch({\n-┊ 77┊   ┊      chatId: chatId,\n-┊ 78┊   ┊    });\n-┊ 79┊   ┊\n-┊ 80┊   ┊    const chat$ = chat$FromCache.pipe(\n-┊ 81┊   ┊      concat(\n-┊ 82┊   ┊        query.valueChanges.pipe(\n-┊ 83┊   ┊          map((result) => result.data.chat)\n-┊ 84┊   ┊        )\n-┊ 85┊   ┊      )\n-┊ 86┊   ┊    );\n+┊   ┊ 80┊    const getApolloWatchQuery = (id: string) => {\n+┊   ┊ 81┊      return this.getChatGQL.watch({\n+┊   ┊ 82┊        chatId: id,\n+┊   ┊ 83┊      });\n+┊   ┊ 84┊    };\n ┊ 87┊ 85┊\n+┊   ┊ 86┊    let chat$: Observable<GetChat.Chat>;\n ┊ 88┊ 87┊    this.getChatWqSubject = new AsyncSubject();\n-┊ 89┊   ┊    this.getChatWqSubject.next(query);\n-┊ 90┊   ┊    this.getChatWqSubject.complete();\n+┊   ┊ 88┊\n+┊   ┊ 89┊    if (oui) {\n+┊   ┊ 90┊      chat$ = chat$FromCache.pipe(\n+┊   ┊ 91┊        concat(this.addChat$.pipe(\n+┊   ┊ 92┊          switchMap(({ data: { addChat, addGroup } }) => {\n+┊   ┊ 93┊            const query = getApolloWatchQuery(addChat ? addChat.id : addGroup.id);\n+┊   ┊ 94┊\n+┊   ┊ 95┊            this.getChatWqSubject.next(query);\n+┊   ┊ 96┊            this.getChatWqSubject.complete();\n+┊   ┊ 97┊\n+┊   ┊ 98┊            return query.valueChanges.pipe(\n+┊   ┊ 99┊              map((result) => result.data.chat)\n+┊   ┊100┊            );\n+┊   ┊101┊          }))\n+┊   ┊102┊        ));\n+┊   ┊103┊    } else {\n+┊   ┊104┊      const query = getApolloWatchQuery(chatId);\n+┊   ┊105┊\n+┊   ┊106┊      this.getChatWqSubject.next(query);\n+┊   ┊107┊      this.getChatWqSubject.complete();\n+┊   ┊108┊\n+┊   ┊109┊      chat$ = chat$FromCache.pipe(\n+┊   ┊110┊        concat(\n+┊   ┊111┊          query.valueChanges.pipe(\n+┊   ┊112┊            map((result) => result.data.chat)\n+┊   ┊113┊          )\n+┊   ┊114┊        )\n+┊   ┊115┊      );\n+┊   ┊116┊    }\n ┊ 91┊117┊\n ┊ 92┊118┊    return {query$: this.getChatWqSubject.asObservable(), chat$};\n ┊ 93┊119┊  }\n```\n```diff\n@@ -295,15 +321,15 @@\n ┊295┊321┊    return _chat ? _chat.id : false;\n ┊296┊322┊  }\n ┊297┊323┊\n-┊298┊   ┊  addChat(recipientId: string, users: GetUsers.Users[]) {\n-┊299┊   ┊    return this.addChatGQL.mutate(\n+┊   ┊324┊  addChat(recipientId: string, users: GetUsers.Users[], ouiId: string) {\n+┊   ┊325┊    this.addChat$ = this.addChatGQL.mutate(\n ┊300┊326┊      {\n ┊301┊327┊        recipientId,\n ┊302┊328┊      }, {\n ┊303┊329┊        optimisticResponse: {\n ┊304┊330┊          __typename: 'Mutation',\n ┊305┊331┊          addChat: {\n-┊306┊   ┊            id: ChatsService.getRandomId(),\n+┊   ┊332┊            id: ouiId,\n ┊307┊333┊            __typename: 'Chat',\n ┊308┊334┊            name: users.find(user => user.id === recipientId).name,\n ┊309┊335┊            picture: users.find(user => user.id === recipientId).picture,\n```\n```diff\n@@ -344,11 +370,12 @@\n ┊344┊370┊          });\n ┊345┊371┊        },\n ┊346┊372┊      }\n-┊347┊   ┊    );\n+┊   ┊373┊    ).pipe(share());\n+┊   ┊374┊    return this.addChat$;\n ┊348┊375┊  }\n ┊349┊376┊\n-┊350┊   ┊  addGroup(recipientIds: string[], groupName: string) {\n-┊351┊   ┊    return this.addGroupGQL.mutate(\n+┊   ┊377┊  addGroup(recipientIds: string[], groupName: string, ouiId: string) {\n+┊   ┊378┊    this.addChat$ = this.addGroupGQL.mutate(\n ┊352┊379┊      {\n ┊353┊380┊        recipientIds,\n ┊354┊381┊        groupName,\n```\n```diff\n@@ -356,7 +383,7 @@\n ┊356┊383┊        optimisticResponse: {\n ┊357┊384┊          __typename: 'Mutation',\n ┊358┊385┊          addGroup: {\n-┊359┊   ┊            id: ChatsService.getRandomId(),\n+┊   ┊386┊            id: ouiId,\n ┊360┊387┊            __typename: 'Chat',\n ┊361┊388┊            name: groupName,\n ┊362┊389┊            picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n```\n```diff\n@@ -395,6 +422,7 @@\n ┊395┊422┊          });\n ┊396┊423┊        },\n ┊397┊424┊      }\n-┊398┊   ┊    );\n+┊   ┊425┊    ).pipe(share());\n+┊   ┊426┊    return this.addChat$;\n ┊399┊427┊  }\n ┊400┊428┊}\n```\n\n[}]: #\n\nPoof, now our Whatsapp clone feels no more like a clone it has the same native feel."
          },
          {
            "manualTitle": "Step 14: Authentication",
            "stepRevision": "3bbd4a531535c2e7e356cdf86f77e6f301264e21",
            "manualView": "![login](https://user-images.githubusercontent.com/7648874/49270369-06c22200-f4a4-11e8-83e5-cef2400989a6.jpg)\n\n## Authentication on server\n\nAuthentication is an hot topic in the GraphQL world and there are some projects which aim at authenticating through GraphQL.\nSince often you will be required to use a specific auth framework (because of a feature you need or because of an existing authorization infrastructure) I will show you how to use a classic REST API framework within your GraphQL application.\nThis approach is completely fine and in line with the official GraphQL best practices.\nWe will use `Passport` for the authentication and `BasicAuth` as the auth mechanism:\n\n    yarn add bcrypt-nodejs passport passport-http\n    yarn add -D @types/bcrypt-nodejs @types/passport @types/passport-http\n\n`BasicAuth` basically involves to send username e password in an Authorization Header together with each request and is fully supported by any browser (meaning that we will be able to use `Graphiql` simply by proving username and password in the login window provided by the browser itself).\nIt's the most simple auth mechanism but it's completely fine for our needs. Later we could decide to use something more complicated like `JWT`, but it's outside of the scope of this tutorial.\n\n[{]: <helper> (diffStep \"4.1\" files=\"index.ts\" module=\"server\")\n\n#### [Step 4.1: Authentication](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/2ee3fa9)\n\n##### Changed index.ts\n```diff\n@@ -3,6 +3,47 @@\n ┊ 3┊ 3┊import * as cors from 'cors';\n ┊ 4┊ 4┊import * as express from 'express';\n ┊ 5┊ 5┊import { ApolloServer } from \"apollo-server-express\";\n+┊  ┊ 6┊import * as passport from \"passport\";\n+┊  ┊ 7┊import * as basicStrategy from 'passport-http';\n+┊  ┊ 8┊import * as bcrypt from 'bcrypt-nodejs';\n+┊  ┊ 9┊import { db, User } from \"./db\";\n+┊  ┊10┊\n+┊  ┊11┊let users = db.users;\n+┊  ┊12┊\n+┊  ┊13┊function generateHash(password: string) {\n+┊  ┊14┊  return bcrypt.hashSync(password, bcrypt.genSaltSync(8));\n+┊  ┊15┊}\n+┊  ┊16┊\n+┊  ┊17┊function validPassword(password: string, localPassword: string) {\n+┊  ┊18┊  return bcrypt.compareSync(password, localPassword);\n+┊  ┊19┊}\n+┊  ┊20┊\n+┊  ┊21┊passport.use('basic-signin', new basicStrategy.BasicStrategy(\n+┊  ┊22┊  function (username: string, password: string, done: any) {\n+┊  ┊23┊    const user = users.find(user => user.username == username);\n+┊  ┊24┊    if (user && validPassword(password, user.password)) {\n+┊  ┊25┊      return done(null, user);\n+┊  ┊26┊    }\n+┊  ┊27┊    return done(null, false);\n+┊  ┊28┊  }\n+┊  ┊29┊));\n+┊  ┊30┊\n+┊  ┊31┊passport.use('basic-signup', new basicStrategy.BasicStrategy({passReqToCallback: true},\n+┊  ┊32┊  function (req: any, username: any, password: any, done: any) {\n+┊  ┊33┊    const userExists = !!users.find(user => user.username === username);\n+┊  ┊34┊    if (!userExists && password && req.body.name) {\n+┊  ┊35┊      const user: User = {\n+┊  ┊36┊        id: (users.length && users[users.length - 1].id + 1) || 1,\n+┊  ┊37┊        username,\n+┊  ┊38┊        password: generateHash(password),\n+┊  ┊39┊        name: req.body.name,\n+┊  ┊40┊      };\n+┊  ┊41┊      users.push(user);\n+┊  ┊42┊      return done(null, user);\n+┊  ┊43┊    }\n+┊  ┊44┊    return done(null, false);\n+┊  ┊45┊  }\n+┊  ┊46┊));\n ┊ 6┊47┊\n ┊ 7┊48┊const PORT = 3000;\n ┊ 8┊49┊\n```\n```diff\n@@ -10,9 +51,27 @@\n ┊10┊51┊\n ┊11┊52┊app.use(cors());\n ┊12┊53┊app.use(bodyParser.json());\n+┊  ┊54┊app.use(passport.initialize());\n+┊  ┊55┊\n+┊  ┊56┊app.post('/signup',\n+┊  ┊57┊  passport.authenticate('basic-signup', {session: false}),\n+┊  ┊58┊  function (req: any, res) {\n+┊  ┊59┊    res.json(req.user);\n+┊  ┊60┊  });\n+┊  ┊61┊\n+┊  ┊62┊app.use(passport.authenticate('basic-signin', {session: false}));\n+┊  ┊63┊\n+┊  ┊64┊app.post('/signin', function (req: any, res) {\n+┊  ┊65┊  res.json(req.user);\n+┊  ┊66┊});\n ┊13┊67┊\n ┊14┊68┊const apollo = new ApolloServer({\n-┊15┊  ┊  schema\n+┊  ┊69┊  schema,\n+┊  ┊70┊  context(received: any) {\n+┊  ┊71┊    return {\n+┊  ┊72┊      user: received.req!['user'],\n+┊  ┊73┊    }\n+┊  ┊74┊  },\n ┊16┊75┊});\n ┊17┊76┊\n ┊18┊77┊apollo.applyMiddleware({\n```\n\n[}]: #\n\nWe are going to store hashes instead of plain passwords, that's why we're using `bcrypt-nodejs`.\nWith `passport.use('basic-signin')` and `passport.use('basic-signup')` we define how the auth framework deals with our database (well, our JSON file for the moment).\n`app.post('/signup')` is the endpoint for creating new accounts, so we left it out of the authentication middleware (`app.use(passport.authenticate('basic-signin')`).\nWhat's of particular interest is that we're passing the user object to the GraphQL context.\n\n[{]: <helper> (diffStep \"4.1\" files=\"schema/resolvers.ts\" module=\"server\")\n\n#### [Step 4.1: Authentication](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/2ee3fa9)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -8,29 +8,28 @@\n ┊ 8┊ 8┊\n ┊ 9┊ 9┊let users = db.users;\n ┊10┊10┊let chats = db.chats;\n-┊11┊  ┊const currentUser = 1;\n ┊12┊11┊\n ┊13┊12┊export const resolvers: IResolvers = {\n ┊14┊13┊  Query: {\n ┊15┊14┊    // Show all users for the moment.\n-┊16┊  ┊    users: (): User[] => users.filter(user => user.id !== currentUser),\n-┊17┊  ┊    chats: (): Chat[] => chats.filter(chat => chat.listingMemberIds.includes(currentUser)),\n+┊  ┊15┊    users: (obj: any, args: any, {user: currentUser}: {user: User}): User[] => users.filter(user => user.id !== currentUser.id),\n+┊  ┊16┊    chats: (obj: any, args: any, {user: currentUser}: {user: User}): Chat[] => chats.filter(chat => chat.listingMemberIds.includes(currentUser.id)),\n ┊18┊17┊    chat: (obj: any, {chatId}: ChatQueryArgs): Chat | null => chats.find(chat => chat.id === Number(chatId)) || null,\n ┊19┊18┊  },\n ┊20┊19┊  Mutation: {\n-┊21┊  ┊    addChat: (obj: any, {recipientId}: AddChatMutationArgs): Chat => {\n+┊  ┊20┊    addChat: (obj: any, {recipientId}: AddChatMutationArgs, {user: currentUser}: {user: User}): Chat => {\n ┊22┊21┊      if (!users.find(user => user.id === Number(recipientId))) {\n ┊23┊22┊        throw new Error(`Recipient ${recipientId} doesn't exist.`);\n ┊24┊23┊      }\n ┊25┊24┊\n-┊26┊  ┊      const chat = chats.find(chat => !chat.name && chat.allTimeMemberIds.includes(currentUser) && chat.allTimeMemberIds.includes(Number(recipientId)));\n+┊  ┊25┊      const chat = chats.find(chat => !chat.name && chat.allTimeMemberIds.includes(currentUser.id) && chat.allTimeMemberIds.includes(Number(recipientId)));\n ┊27┊26┊      if (chat) {\n ┊28┊27┊        // Chat already exists. Both users are already in the allTimeMemberIds array\n ┊29┊28┊        const chatId = chat.id;\n-┊30┊  ┊        if (!chat.listingMemberIds.includes(currentUser)) {\n+┊  ┊29┊        if (!chat.listingMemberIds.includes(currentUser.id)) {\n ┊31┊30┊          // The chat isn't listed for the current user. Add him to the memberIds\n-┊32┊  ┊          chat.listingMemberIds.push(currentUser);\n-┊33┊  ┊          chats.find(chat => chat.id === chatId)!.listingMemberIds.push(currentUser);\n+┊  ┊31┊          chat.listingMemberIds.push(currentUser.id);\n+┊  ┊32┊          chats.find(chat => chat.id === chatId)!.listingMemberIds.push(currentUser.id);\n ┊34┊33┊          return chat;\n ┊35┊34┊        } else {\n ┊36┊35┊          throw new Error(`Chat already exists.`);\n```\n```diff\n@@ -44,9 +43,9 @@\n ┊44┊43┊          picture: null,\n ┊45┊44┊          adminIds: null,\n ┊46┊45┊          ownerId: null,\n-┊47┊  ┊          allTimeMemberIds: [currentUser, Number(recipientId)],\n+┊  ┊46┊          allTimeMemberIds: [currentUser.id, Number(recipientId)],\n ┊48┊47┊          // Chat will not be listed to the other user until the first message gets written\n-┊49┊  ┊          listingMemberIds: [currentUser],\n+┊  ┊48┊          listingMemberIds: [currentUser.id],\n ┊50┊49┊          actualGroupMemberIds: null,\n ┊51┊50┊          messages: [],\n ┊52┊51┊        };\n```\n```diff\n@@ -54,7 +53,7 @@\n ┊54┊53┊        return chat;\n ┊55┊54┊      }\n ┊56┊55┊    },\n-┊57┊  ┊    addGroup: (obj: any, {recipientIds, groupName}: AddGroupMutationArgs): Chat => {\n+┊  ┊56┊    addGroup: (obj: any, {recipientIds, groupName}: AddGroupMutationArgs, {user: currentUser}: {user: User}): Chat => {\n ┊58┊57┊      recipientIds.forEach(recipientId => {\n ┊59┊58┊        if (!users.find(user => user.id === Number(recipientId))) {\n ┊60┊59┊          throw new Error(`Recipient ${recipientId} doesn't exist.`);\n```\n```diff\n@@ -66,17 +65,17 @@\n ┊66┊65┊        id,\n ┊67┊66┊        name: groupName,\n ┊68┊67┊        picture: null,\n-┊69┊  ┊        adminIds: [currentUser],\n-┊70┊  ┊        ownerId: currentUser,\n-┊71┊  ┊        allTimeMemberIds: [currentUser, ...recipientIds.map(id => Number(id))],\n-┊72┊  ┊        listingMemberIds: [currentUser, ...recipientIds.map(id => Number(id))],\n-┊73┊  ┊        actualGroupMemberIds: [currentUser, ...recipientIds.map(id => Number(id))],\n+┊  ┊68┊        adminIds: [currentUser.id],\n+┊  ┊69┊        ownerId: currentUser.id,\n+┊  ┊70┊        allTimeMemberIds: [currentUser.id, ...recipientIds.map(id => Number(id))],\n+┊  ┊71┊        listingMemberIds: [currentUser.id, ...recipientIds.map(id => Number(id))],\n+┊  ┊72┊        actualGroupMemberIds: [currentUser.id, ...recipientIds.map(id => Number(id))],\n ┊74┊73┊        messages: [],\n ┊75┊74┊      };\n ┊76┊75┊      chats.push(chat);\n ┊77┊76┊      return chat;\n ┊78┊77┊    },\n-┊79┊  ┊    removeChat: (obj: any, {chatId}: RemoveChatMutationArgs): number => {\n+┊  ┊78┊    removeChat: (obj: any, {chatId}: RemoveChatMutationArgs, {user: currentUser}: {user: User}): number => {\n ┊80┊79┊      const chat = chats.find(chat => chat.id === Number(chatId));\n ┊81┊80┊\n ┊82┊81┊      if (!chat) {\n```\n```diff\n@@ -85,14 +84,14 @@\n ┊85┊84┊\n ┊86┊85┊      if (!chat.name) {\n ┊87┊86┊        // Chat\n-┊88┊  ┊        if (!chat.listingMemberIds.includes(currentUser)) {\n+┊  ┊87┊        if (!chat.listingMemberIds.includes(currentUser.id)) {\n ┊89┊88┊          throw new Error(`The user is not a member of the chat ${chatId}.`);\n ┊90┊89┊        }\n ┊91┊90┊\n ┊92┊91┊        // Instead of chaining map and filter we can loop once using reduce\n ┊93┊92┊        const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n ┊94┊93┊          // Remove the current user from the message holders\n-┊95┊  ┊          message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser);\n+┊  ┊94┊          message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser.id);\n ┊96┊95┊\n ┊97┊96┊          if (message.holderIds.length !== 0) {\n ┊98┊97┊            filtered.push(message);\n```\n```diff\n@@ -102,7 +101,7 @@\n ┊102┊101┊        }, []);\n ┊103┊102┊\n ┊104┊103┊        // Remove the current user from who gets the chat listed. The chat will no longer appear in his list\n-┊105┊   ┊        const listingMemberIds = chat.listingMemberIds.filter(listingId => listingId !== currentUser);\n+┊   ┊104┊        const listingMemberIds = chat.listingMemberIds.filter(listingId => listingId !== currentUser.id);\n ┊106┊105┊\n ┊107┊106┊        // Check how many members are left\n ┊108┊107┊        if (listingMemberIds.length === 0) {\n```\n```diff\n@@ -120,14 +119,14 @@\n ┊120┊119┊        return Number(chatId);\n ┊121┊120┊      } else {\n ┊122┊121┊        // Group\n-┊123┊   ┊        if (chat.ownerId !== currentUser) {\n+┊   ┊122┊        if (chat.ownerId !== currentUser.id) {\n ┊124┊123┊          throw new Error(`Group ${chatId} is not owned by the user.`);\n ┊125┊124┊        }\n ┊126┊125┊\n ┊127┊126┊        // Instead of chaining map and filter we can loop once using reduce\n ┊128┊127┊        const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n ┊129┊128┊          // Remove the current user from the message holders\n-┊130┊   ┊          message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser);\n+┊   ┊129┊          message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser.id);\n ┊131┊130┊\n ┊132┊131┊          if (message.holderIds.length !== 0) {\n ┊133┊132┊            filtered.push(message);\n```\n```diff\n@@ -137,7 +136,7 @@\n ┊137┊136┊        }, []);\n ┊138┊137┊\n ┊139┊138┊        // Remove the current user from who gets the group listed. The group will no longer appear in his list\n-┊140┊   ┊        const listingMemberIds = chat.listingMemberIds.filter(listingId => listingId !== currentUser);\n+┊   ┊139┊        const listingMemberIds = chat.listingMemberIds.filter(listingId => listingId !== currentUser.id);\n ┊141┊140┊\n ┊142┊141┊        // Check how many members (including previous ones who can still access old messages) are left\n ┊143┊142┊        if (listingMemberIds.length === 0) {\n```\n```diff\n@@ -147,9 +146,9 @@\n ┊147┊146┊          // Update the group\n ┊148┊147┊\n ┊149┊148┊          // Remove the current user from the chat members. He is no longer a member of the group\n-┊150┊   ┊          const actualGroupMemberIds = chat.actualGroupMemberIds!.filter(memberId => memberId !== currentUser);\n+┊   ┊149┊          const actualGroupMemberIds = chat.actualGroupMemberIds!.filter(memberId => memberId !== currentUser.id);\n ┊151┊150┊          // Remove the current user from the chat admins\n-┊152┊   ┊          const adminIds = chat.adminIds!.filter(memberId => memberId !== currentUser);\n+┊   ┊151┊          const adminIds = chat.adminIds!.filter(memberId => memberId !== currentUser.id);\n ┊153┊152┊          // Set the owner id to be null. A null owner means the group is read-only\n ┊154┊153┊          let ownerId: number | null = null;\n ┊155┊154┊\n```\n```diff\n@@ -169,7 +168,7 @@\n ┊169┊168┊        return Number(chatId);\n ┊170┊169┊      }\n ┊171┊170┊    },\n-┊172┊   ┊    addMessage: (obj: any, {chatId, content}: AddMessageMutationArgs): Message => {\n+┊   ┊171┊    addMessage: (obj: any, {chatId, content}: AddMessageMutationArgs, {user: currentUser}: {user: User}): Message => {\n ┊173┊172┊      if (content === null || content === '') {\n ┊174┊173┊        throw new Error(`Cannot add empty or null messages.`);\n ┊175┊174┊      }\n```\n```diff\n@@ -184,11 +183,11 @@\n ┊184┊183┊\n ┊185┊184┊      if (!chat.name) {\n ┊186┊185┊        // Chat\n-┊187┊   ┊        if (!chat.listingMemberIds.find(listingId => listingId === currentUser)) {\n+┊   ┊186┊        if (!chat.listingMemberIds.find(listingId => listingId === currentUser.id)) {\n ┊188┊187┊          throw new Error(`The chat ${chatId} must be listed for the current user before adding a message.`);\n ┊189┊188┊        }\n ┊190┊189┊\n-┊191┊   ┊        const recipientId = chat.allTimeMemberIds.filter(userId => userId !== currentUser)[0];\n+┊   ┊190┊        const recipientId = chat.allTimeMemberIds.filter(userId => userId !== currentUser.id)[0];\n ┊192┊191┊\n ┊193┊192┊        if (!chat.listingMemberIds.find(listingId => listingId === recipientId)) {\n ┊194┊193┊          // Chat is not listed for the recipient. Add him to the listingMemberIds\n```\n```diff\n@@ -205,7 +204,7 @@\n ┊205┊204┊        }\n ┊206┊205┊      } else {\n ┊207┊206┊        // Group\n-┊208┊   ┊        if (!chat.actualGroupMemberIds!.find(memberId => memberId === currentUser)) {\n+┊   ┊207┊        if (!chat.actualGroupMemberIds!.find(memberId => memberId === currentUser.id)) {\n ┊209┊208┊          throw new Error(`The user is not a member of the group ${chatId}. Cannot add message.`);\n ┊210┊209┊        }\n ┊211┊210┊\n```\n```diff\n@@ -217,7 +216,7 @@\n ┊217┊216┊      let recipients: Recipient[] = [];\n ┊218┊217┊\n ┊219┊218┊      holderIds.forEach(holderId => {\n-┊220┊   ┊        if (holderId !== currentUser) {\n+┊   ┊219┊        if (holderId !== currentUser.id) {\n ┊221┊220┊          recipients.push({\n ┊222┊221┊            userId: holderId,\n ┊223┊222┊            messageId: id,\n```\n```diff\n@@ -231,7 +230,7 @@\n ┊231┊230┊      const message: Message = {\n ┊232┊231┊        id,\n ┊233┊232┊        chatId: Number(chatId),\n-┊234┊   ┊        senderId: currentUser,\n+┊   ┊233┊        senderId: currentUser.id,\n ┊235┊234┊        content,\n ┊236┊235┊        createdAt: moment().unix(),\n ┊237┊236┊        type: MessageType.TEXT,\n```\n```diff\n@@ -248,14 +247,14 @@\n ┊248┊247┊\n ┊249┊248┊      return message;\n ┊250┊249┊    },\n-┊251┊   ┊    removeMessages: (obj: any, {chatId, messageIds, all}: RemoveMessagesMutationArgs): number[] => {\n+┊   ┊250┊    removeMessages: (obj: any, {chatId, messageIds, all}: RemoveMessagesMutationArgs, {user: currentUser}: {user: User}): number[] => {\n ┊252┊251┊      const chat = chats.find(chat => chat.id === Number(chatId));\n ┊253┊252┊\n ┊254┊253┊      if (!chat) {\n ┊255┊254┊        throw new Error(`Cannot find chat ${chatId}.`);\n ┊256┊255┊      }\n ┊257┊256┊\n-┊258┊   ┊      if (!chat.listingMemberIds.find(listingId => listingId === currentUser)) {\n+┊   ┊257┊      if (!chat.listingMemberIds.find(listingId => listingId === currentUser.id)) {\n ┊259┊258┊        throw new Error(`The chat/group ${chatId} is not listed for the current user, so there is nothing to delete.`);\n ┊260┊259┊      }\n ┊261┊260┊\n```\n```diff\n@@ -271,7 +270,7 @@\n ┊271┊270┊            if (all || messageIds!.includes(String(message.id))) {\n ┊272┊271┊              deletedIds.push(message.id);\n ┊273┊272┊              // Remove the current user from the message holders\n-┊274┊   ┊              message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser);\n+┊   ┊273┊              message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser.id);\n ┊275┊274┊            }\n ┊276┊275┊\n ┊277┊276┊            if (message.holderIds.length !== 0) {\n```\n```diff\n@@ -288,24 +287,24 @@\n ┊288┊287┊    },\n ┊289┊288┊  },\n ┊290┊289┊  Chat: {\n-┊291┊   ┊    name: (chat: Chat): string => chat.name ? chat.name : users\n-┊292┊   ┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser))!.name,\n-┊293┊   ┊    picture: (chat: Chat) => chat.name ? chat.picture : users\n-┊294┊   ┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser))!.picture,\n+┊   ┊290┊    name: (chat: Chat, args: any, {user: currentUser}: {user: User}): string => chat.name ? chat.name : users\n+┊   ┊291┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser.id))!.name,\n+┊   ┊292┊    picture: (chat: Chat, args: any, {user: currentUser}: {user: User}) => chat.name ? chat.picture : users\n+┊   ┊293┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser.id))!.picture,\n ┊295┊294┊    allTimeMembers: (chat: Chat): User[] => users.filter(user => chat.allTimeMemberIds.includes(user.id)),\n ┊296┊295┊    listingMembers: (chat: Chat): User[] => users.filter(user => chat.listingMemberIds.includes(user.id)),\n ┊297┊296┊    actualGroupMembers: (chat: Chat): User[] => users.filter(user => chat.actualGroupMemberIds && chat.actualGroupMemberIds.includes(user.id)),\n ┊298┊297┊    admins: (chat: Chat): User[] => users.filter(user => chat.adminIds && chat.adminIds.includes(user.id)),\n ┊299┊298┊    owner: (chat: Chat): User | null => users.find(user => chat.ownerId === user.id) || null,\n-┊300┊   ┊    messages: (chat: Chat, {amount = 0}: {amount: number}): Message[] => {\n+┊   ┊299┊    messages: (chat: Chat, {amount = 0}: {amount: number}, {user: currentUser}: {user: User}): Message[] => {\n ┊301┊300┊      const messages = chat.messages\n-┊302┊   ┊      .filter(message => message.holderIds.includes(currentUser))\n+┊   ┊301┊      .filter(message => message.holderIds.includes(currentUser.id))\n ┊303┊302┊      .sort((a, b) => b.createdAt - a.createdAt) || <Message[]>[];\n ┊304┊303┊      return (amount ? messages.slice(0, amount) : messages).reverse();\n ┊305┊304┊    },\n-┊306┊   ┊    unreadMessages: (chat: Chat): number => chat.messages\n-┊307┊   ┊      .filter(message => message.holderIds.includes(currentUser) &&\n-┊308┊   ┊        message.recipients.find(recipient => recipient.userId === currentUser && !recipient.readAt))\n+┊   ┊305┊    unreadMessages: (chat: Chat, args: any, {user: currentUser}: {user: User}): number => chat.messages\n+┊   ┊306┊      .filter(message => message.holderIds.includes(currentUser.id) &&\n+┊   ┊307┊        message.recipients.find(recipient => recipient.userId === currentUser.id && !recipient.readAt))\n ┊309┊308┊      .length,\n ┊310┊309┊    isGroup: (chat: Chat): boolean => !!chat.name,\n ┊311┊310┊  },\n```\n```diff\n@@ -313,7 +312,7 @@\n ┊313┊312┊    chat: (message: Message): Chat | null => chats.find(chat => message.chatId === chat.id) || null,\n ┊314┊313┊    sender: (message: Message): User | null => users.find(user => user.id === message.senderId) || null,\n ┊315┊314┊    holders: (message: Message): User[] => users.filter(user => message.holderIds.includes(user.id)),\n-┊316┊   ┊    ownership: (message: Message): boolean => message.senderId === currentUser,\n+┊   ┊315┊    ownership: (message: Message, args: any, {user: currentUser}: {user: User}): boolean => message.senderId === currentUser.id,\n ┊317┊316┊  },\n ┊318┊317┊  Recipient: {\n ┊319┊318┊    user: (recipient: Recipient): User | null => users.find(user => recipient.userId === user.id) || null,\n```\n\n[}]: #\n\nIn the resolvers we're basically making use of the user object taken from the context.\n\n## Authentication on client\n\nLet's start installing `@angular/flex-layout`, because we will use it later:\n\n    yarn add @angular/flex-layout\n\n\nFirst of all we need to create an `HTTP Interceptor`, which will intercept every HTTP request and will add authentication headers.\nFor the moment we still don't have those headers, but we are going to store them in the `LocalStorage` later.\nWe are also creating an `AuthGuard`, which we will use to stop the user from reaching unauthorized Routes.\n\nThe `AuthGuard` will simply look for the presence of the `Authentication` Header, but will not guarantee that the header is authentic.\nThis is no problem, because client side AuthGuards are not safe by design and the real authentication will be done server side anyway.\nAuthGuards are here just to redirect the user to the Login page.\n\nThe service we are going to create will contain some auth methods we are going to use across the app.\n\n[{]: <helper> (diffStep \"10.1\" files=\"src/app/login/services\" module=\"client\")\n\n#### [Step 10.1: Authentication](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/34faf60)\n\n##### Added src&#x2F;app&#x2F;login&#x2F;services&#x2F;auth.guard.ts\n```diff\n@@ -0,0 +1,18 @@\n+┊  ┊ 1┊import {Injectable} from '@angular/core';\n+┊  ┊ 2┊import {CanActivate, Router} from '@angular/router';\n+┊  ┊ 3┊import {LoginService} from './login.service';\n+┊  ┊ 4┊\n+┊  ┊ 5┊@Injectable()\n+┊  ┊ 6┊export class AuthGuard implements CanActivate {\n+┊  ┊ 7┊  constructor(private router: Router,\n+┊  ┊ 8┊              private loginService: LoginService) {}\n+┊  ┊ 9┊\n+┊  ┊10┊  canActivate() {\n+┊  ┊11┊    if (this.loginService.getAuthHeader()) {\n+┊  ┊12┊      return true;\n+┊  ┊13┊    } else {\n+┊  ┊14┊      this.router.navigate(['/login']);\n+┊  ┊15┊      return false;\n+┊  ┊16┊    }\n+┊  ┊17┊  }\n+┊  ┊18┊}\n```\n\n##### Added src&#x2F;app&#x2F;login&#x2F;services&#x2F;auth.interceptor.ts\n```diff\n@@ -0,0 +1,20 @@\n+┊  ┊ 1┊import {Injectable} from '@angular/core';\n+┊  ┊ 2┊import {HttpEvent, HttpHandler, HttpInterceptor, HttpRequest} from '@angular/common/http';\n+┊  ┊ 3┊import {Observable} from 'rxjs';\n+┊  ┊ 4┊import {LoginService} from './login.service';\n+┊  ┊ 5┊\n+┊  ┊ 6┊@Injectable()\n+┊  ┊ 7┊export class AuthInterceptor implements HttpInterceptor {\n+┊  ┊ 8┊  constructor(private loginService: LoginService) {}\n+┊  ┊ 9┊  intercept(request: HttpRequest<any>, next: HttpHandler): Observable<HttpEvent<any>> {\n+┊  ┊10┊    const auth = this.loginService.getAuthHeader();\n+┊  ┊11┊    if (auth) {\n+┊  ┊12┊      request = request.clone({\n+┊  ┊13┊        setHeaders: {\n+┊  ┊14┊          Authorization: auth,\n+┊  ┊15┊        }\n+┊  ┊16┊      });\n+┊  ┊17┊    }\n+┊  ┊18┊    return next.handle(request);\n+┊  ┊19┊  }\n+┊  ┊20┊}\n```\n\n##### Added src&#x2F;app&#x2F;login&#x2F;services&#x2F;login.service.ts\n```diff\n@@ -0,0 +1,24 @@\n+┊  ┊ 1┊import { Injectable } from '@angular/core';\n+┊  ┊ 2┊import {User} from '../../../graphql';\n+┊  ┊ 3┊\n+┊  ┊ 4┊@Injectable()\n+┊  ┊ 5┊export class LoginService {\n+┊  ┊ 6┊\n+┊  ┊ 7┊  constructor() { }\n+┊  ┊ 8┊\n+┊  ┊ 9┊  storeAuthHeader(auth: string) {\n+┊  ┊10┊    localStorage.setItem('Authorization', auth);\n+┊  ┊11┊  }\n+┊  ┊12┊\n+┊  ┊13┊  getAuthHeader(): string {\n+┊  ┊14┊    return localStorage.getItem('Authorization');\n+┊  ┊15┊  }\n+┊  ┊16┊\n+┊  ┊17┊  storeUser(user: User) {\n+┊  ┊18┊    localStorage.setItem('user', JSON.stringify(user));\n+┊  ┊19┊  }\n+┊  ┊20┊\n+┊  ┊21┊  getUser(): User {\n+┊  ┊22┊    return JSON.parse(localStorage.getItem('user'));\n+┊  ┊23┊  }\n+┊  ┊24┊}\n```\n\n[}]: #\n\nNow it's time to create a `SignIn`/`SignUp` component. Since we use Passport in the server we are going to make REST calls for the authentication, instead of using GraphQL.\nSince we use `Basic Auth` we will simply combine the username and the password together to create the authentication header.\nWe will also store the response from the server, which will contain the user information like the ID, etc. which we are going to need later.\n\nFirst we we will download a WhatsApp picture that will be used in the login component:\n\n    $ wget https://user-images.githubusercontent.com/7648874/49260078-e7f96680-f476-11e8-8711-06bc6490858a.png -P src/assets\n\nAnd then we will proceed to creating the component itself and everything around it:\n\n[{]: <helper> (diffStep \"10.1\" files=\"src/app/login/containers, src/app/login/login.module.ts\" module=\"client\")\n\n#### [Step 10.1: Authentication](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/34faf60)\n\n##### Added src&#x2F;app&#x2F;login&#x2F;containers&#x2F;login.component.scss\n```diff\n@@ -0,0 +1,18 @@\n+┊  ┊ 1┊:host {\n+┊  ┊ 2┊  display: block;\n+┊  ┊ 3┊}\n+┊  ┊ 4┊\n+┊  ┊ 5┊form:first-of-type {\n+┊  ┊ 6┊  margin-top: 24px;\n+┊  ┊ 7┊  margin-bottom: 48px;\n+┊  ┊ 8┊}\n+┊  ┊ 9┊\n+┊  ┊10┊label {\n+┊  ┊11┊  display: block;\n+┊  ┊12┊  margin-top: 4px;\n+┊  ┊13┊  margin-bottom: 4px;\n+┊  ┊14┊}\n+┊  ┊15┊\n+┊  ┊16┊.error {\n+┊  ┊17┊  color: red;\n+┊  ┊18┊}\n```\n\n##### Added src&#x2F;app&#x2F;login&#x2F;containers&#x2F;login.component.ts\n```diff\n@@ -0,0 +1,133 @@\n+┊   ┊  1┊import {Component} from '@angular/core';\n+┊   ┊  2┊import {HttpClient} from '@angular/common/http';\n+┊   ┊  3┊import {FormBuilder, Validators} from '@angular/forms';\n+┊   ┊  4┊// import {matchOtherValidator} from '@moebius/ng-validators';\n+┊   ┊  5┊import {Router} from '@angular/router';\n+┊   ┊  6┊import {User} from '../../../graphql';\n+┊   ┊  7┊import {LoginService} from '../services/login.service';\n+┊   ┊  8┊\n+┊   ┊  9┊@Component({\n+┊   ┊ 10┊  selector: 'app-login',\n+┊   ┊ 11┊  template: `\n+┊   ┊ 12┊    <form (ngSubmit)=\"signIn()\" [formGroup]=\"signInForm\" novalidate>\n+┊   ┊ 13┊      <fieldset fxLayout=\"column\" fxLayoutGap=\"17px\">\n+┊   ┊ 14┊        <legend>Sign in</legend>\n+┊   ┊ 15┊        <div>\n+┊   ┊ 16┊          <label>Username</label>\n+┊   ┊ 17┊          <input formControlName=\"username\" autocomplete=\"username\" type=\"text\">\n+┊   ┊ 18┊        </div>\n+┊   ┊ 19┊        <div class=\"error\" *ngIf=\"signInForm.get('username').hasError('required') && signInForm.get('username').touched\">\n+┊   ┊ 20┊          Username is required\n+┊   ┊ 21┊        </div>\n+┊   ┊ 22┊\n+┊   ┊ 23┊        <div>\n+┊   ┊ 24┊          <label>Password</label>\n+┊   ┊ 25┊          <input formControlName=\"password\" autocomplete=\"current-password\" type=\"password\">\n+┊   ┊ 26┊        </div>\n+┊   ┊ 27┊        <div class=\"error\" *ngIf=\"signInForm.get('password').hasError('required') && signInForm.get('password').touched\">\n+┊   ┊ 28┊          Password is required\n+┊   ┊ 29┊        </div>\n+┊   ┊ 30┊\n+┊   ┊ 31┊        <button type=\"submit\" [disabled]=\"signInForm.invalid\">Sign in</button>\n+┊   ┊ 32┊      </fieldset>\n+┊   ┊ 33┊    </form>\n+┊   ┊ 34┊\n+┊   ┊ 35┊    <form (ngSubmit)=\"signUp()\" [formGroup]=\"signUpForm\" novalidate>\n+┊   ┊ 36┊      <fieldset fxLayout=\"column\" fxLayoutGap=\"17px\">\n+┊   ┊ 37┊        <legend>Sign up</legend>\n+┊   ┊ 38┊        <div>\n+┊   ┊ 39┊          <label>Name</label>\n+┊   ┊ 40┊          <input formControlName=\"name\" type=\"text\">\n+┊   ┊ 41┊        </div>\n+┊   ┊ 42┊\n+┊   ┊ 43┊        <div>\n+┊   ┊ 44┊          <label>Username</label>\n+┊   ┊ 45┊          <input formControlName=\"username\" autocomplete=\"username\" type=\"text\">\n+┊   ┊ 46┊        </div>\n+┊   ┊ 47┊        <div class=\"error\" *ngIf=\"signUpForm.get('username').hasError('required') && signUpForm.get('username').touched\">\n+┊   ┊ 48┊          Username is required\n+┊   ┊ 49┊        </div>\n+┊   ┊ 50┊\n+┊   ┊ 51┊        <div>\n+┊   ┊ 52┊          <label>Password</label>\n+┊   ┊ 53┊          <input formControlName=\"newPassword\" autocomplete=\"new-password\" type=\"password\">\n+┊   ┊ 54┊        </div>\n+┊   ┊ 55┊        <div class=\"error\" *ngIf=\"signUpForm.get('newPassword').hasError('required') && signUpForm.get('newPassword').touched\">\n+┊   ┊ 56┊          Password is required\n+┊   ┊ 57┊        </div>\n+┊   ┊ 58┊\n+┊   ┊ 59┊        <div>\n+┊   ┊ 60┊          <label>Password</label>\n+┊   ┊ 61┊          <input formControlName=\"confirmPassword\" type=\"password\">\n+┊   ┊ 62┊        </div>\n+┊   ┊ 63┊        <div class=\"error\" *ngIf=\"signUpForm.get('confirmPassword').hasError('required') && signUpForm.get('confirmPassword').touched\">\n+┊   ┊ 64┊          Passwords must match\n+┊   ┊ 65┊        </div>\n+┊   ┊ 66┊\n+┊   ┊ 67┊        <button type=\"submit\" [disabled]=\"signUpForm.invalid\">Sign up</button>\n+┊   ┊ 68┊      </fieldset>\n+┊   ┊ 69┊    </form>\n+┊   ┊ 70┊  `,\n+┊   ┊ 71┊  styleUrls: ['./login.component.scss'],\n+┊   ┊ 72┊})\n+┊   ┊ 73┊export class LoginComponent {\n+┊   ┊ 74┊  signInForm = this.fb.group({\n+┊   ┊ 75┊    username: [null, [\n+┊   ┊ 76┊      Validators.required,\n+┊   ┊ 77┊    ]],\n+┊   ┊ 78┊    password: [null, [\n+┊   ┊ 79┊      Validators.required,\n+┊   ┊ 80┊    ]],\n+┊   ┊ 81┊  });\n+┊   ┊ 82┊\n+┊   ┊ 83┊  signUpForm = this.fb.group({\n+┊   ┊ 84┊    name: [null, [\n+┊   ┊ 85┊      Validators.required,\n+┊   ┊ 86┊    ]],\n+┊   ┊ 87┊    username: [null, [\n+┊   ┊ 88┊      Validators.required,\n+┊   ┊ 89┊    ]],\n+┊   ┊ 90┊    newPassword: [null, [\n+┊   ┊ 91┊      Validators.required,\n+┊   ┊ 92┊    ]],\n+┊   ┊ 93┊    confirmPassword: [null, [\n+┊   ┊ 94┊      Validators.required,\n+┊   ┊ 95┊      // matchOtherValidator('newPassword'),\n+┊   ┊ 96┊    ]],\n+┊   ┊ 97┊  });\n+┊   ┊ 98┊\n+┊   ┊ 99┊  constructor(private http: HttpClient,\n+┊   ┊100┊              private fb: FormBuilder,\n+┊   ┊101┊              private router: Router,\n+┊   ┊102┊              private loginService: LoginService) {}\n+┊   ┊103┊\n+┊   ┊104┊  signIn() {\n+┊   ┊105┊    const {username, password} = this.signInForm.value;\n+┊   ┊106┊    const auth = `Basic ${btoa(`${username}:${password}`)}`;\n+┊   ┊107┊    this.http.post('http://localhost:3000/signin', null, {\n+┊   ┊108┊      headers: {\n+┊   ┊109┊        Authorization: auth,\n+┊   ┊110┊      }\n+┊   ┊111┊    }).subscribe((user: User) => {\n+┊   ┊112┊      this.loginService.storeAuthHeader(auth);\n+┊   ┊113┊      this.loginService.storeUser(user);\n+┊   ┊114┊      this.router.navigate(['/chats']);\n+┊   ┊115┊    }, err => console.error(err));\n+┊   ┊116┊  }\n+┊   ┊117┊\n+┊   ┊118┊  signUp() {\n+┊   ┊119┊    const {username, newPassword: password, name} = this.signInForm.value;\n+┊   ┊120┊    const auth = `Basic ${btoa(`${username}:${password}`)}`;\n+┊   ┊121┊    this.http.post('http://localhost:3000/signup', {\n+┊   ┊122┊      name,\n+┊   ┊123┊    }, {\n+┊   ┊124┊      headers: {\n+┊   ┊125┊        Authorization: auth,\n+┊   ┊126┊      }\n+┊   ┊127┊    }).subscribe((user: User) => {\n+┊   ┊128┊      this.loginService.storeAuthHeader(auth);\n+┊   ┊129┊      this.loginService.storeUser(user);\n+┊   ┊130┊      this.router.navigate(['/chats']);\n+┊   ┊131┊    }, err => console.error(err));\n+┊   ┊132┊  }\n+┊   ┊133┊}\n```\n\n##### Added src&#x2F;app&#x2F;login&#x2F;login.module.ts\n```diff\n@@ -0,0 +1,52 @@\n+┊  ┊ 1┊import {RouterModule, Routes} from '@angular/router';\n+┊  ┊ 2┊import {NgModule} from '@angular/core';\n+┊  ┊ 3┊import {TruncateModule} from 'ng2-truncate';\n+┊  ┊ 4┊import {MatButtonModule, MatIconModule, MatListModule, MatMenuModule} from '@angular/material';\n+┊  ┊ 5┊import {SharedModule} from '../shared/shared.module';\n+┊  ┊ 6┊import {BrowserModule} from '@angular/platform-browser';\n+┊  ┊ 7┊import {FormsModule, ReactiveFormsModule} from '@angular/forms';\n+┊  ┊ 8┊import {BrowserAnimationsModule} from '@angular/platform-browser/animations';\n+┊  ┊ 9┊import {LoginComponent} from './containers/login.component';\n+┊  ┊10┊import {FlexLayoutModule} from '@angular/flex-layout';\n+┊  ┊11┊import {AuthInterceptor} from './services/auth.interceptor';\n+┊  ┊12┊import {AuthGuard} from './services/auth.guard';\n+┊  ┊13┊import {LoginService} from './services/login.service';\n+┊  ┊14┊\n+┊  ┊15┊\n+┊  ┊16┊const routes: Routes = [\n+┊  ┊17┊  {path: 'login', component: LoginComponent},\n+┊  ┊18┊];\n+┊  ┊19┊\n+┊  ┊20┊@NgModule({\n+┊  ┊21┊  declarations: [\n+┊  ┊22┊    LoginComponent,\n+┊  ┊23┊  ],\n+┊  ┊24┊  imports: [\n+┊  ┊25┊    BrowserModule,\n+┊  ┊26┊    // Material\n+┊  ┊27┊    MatMenuModule,\n+┊  ┊28┊    MatIconModule,\n+┊  ┊29┊    MatButtonModule,\n+┊  ┊30┊    MatListModule,\n+┊  ┊31┊    // Animations\n+┊  ┊32┊    BrowserAnimationsModule,\n+┊  ┊33┊    // Flex layout\n+┊  ┊34┊    FlexLayoutModule,\n+┊  ┊35┊    // Routing\n+┊  ┊36┊    RouterModule.forChild(routes),\n+┊  ┊37┊    // Forms\n+┊  ┊38┊    FormsModule,\n+┊  ┊39┊    ReactiveFormsModule,\n+┊  ┊40┊    // Truncate Pipe\n+┊  ┊41┊    TruncateModule,\n+┊  ┊42┊    // Feature modules\n+┊  ┊43┊    SharedModule,\n+┊  ┊44┊  ],\n+┊  ┊45┊  providers: [\n+┊  ┊46┊    LoginService,\n+┊  ┊47┊    AuthInterceptor,\n+┊  ┊48┊    AuthGuard,\n+┊  ┊49┊  ],\n+┊  ┊50┊})\n+┊  ┊51┊export class LoginModule {\n+┊  ┊52┊}\n```\n\n[}]: #\n\nNow it's time use the Interceptor we just created:\n\n[{]: <helper> (diffStep \"10.1\" files=\"src/app/app.module.ts\" module=\"client\")\n\n#### [Step 10.1: Authentication](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/34faf60)\n\n##### Changed src&#x2F;app&#x2F;app.module.ts\n```diff\n@@ -2,12 +2,14 @@\n ┊ 2┊ 2┊import { NgModule } from '@angular/core';\n ┊ 3┊ 3┊\n ┊ 4┊ 4┊import { AppComponent } from './app.component';\n-┊ 5┊  ┊import { HttpClientModule } from '@angular/common/http';\n+┊  ┊ 5┊import { HttpClientModule, HTTP_INTERCEPTORS } from '@angular/common/http';\n ┊ 6┊ 6┊import { GraphQLModule } from './graphql.module';\n ┊ 7┊ 7┊import {ChatsListerModule} from './chats-lister/chats-lister.module';\n ┊ 8┊ 8┊import {RouterModule, Routes} from '@angular/router';\n ┊ 9┊ 9┊import {ChatViewerModule} from './chat-viewer/chat-viewer.module';\n ┊10┊10┊import {ChatsCreationModule} from './chats-creation/chats-creation.module';\n+┊  ┊11┊import {LoginModule} from './login/login.module';\n+┊  ┊12┊import {AuthInterceptor} from './login/services/auth.interceptor';\n ┊11┊13┊const routes: Routes = [];\n ┊12┊14┊\n ┊13┊15┊@NgModule({\n```\n```diff\n@@ -24,8 +26,15 @@\n ┊24┊26┊    ChatsListerModule,\n ┊25┊27┊    ChatViewerModule,\n ┊26┊28┊    ChatsCreationModule,\n+┊  ┊29┊    LoginModule,\n+┊  ┊30┊  ],\n+┊  ┊31┊  providers: [\n+┊  ┊32┊    {\n+┊  ┊33┊      provide: HTTP_INTERCEPTORS,\n+┊  ┊34┊      useClass: AuthInterceptor,\n+┊  ┊35┊      multi: true,\n+┊  ┊36┊    },\n ┊27┊37┊  ],\n-┊28┊  ┊  providers: [],\n ┊29┊38┊  bootstrap: [AppComponent]\n ┊30┊39┊})\n ┊31┊40┊export class AppModule {}\n```\n\n[}]: #\n\nAs well as the `AuthGuard`:\n\n[{]: <helper> (diffStep \"10.1\" files=\"src/app/chat-viewer/chat-viewer.module.ts, src/app/chats-creation/chats-creation.module.ts, src/app/chats-lister/chats-lister.module.ts\" module=\"client\")\n\n#### [Step 10.1: Authentication](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/34faf60)\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;chat-viewer.module.ts\n```diff\n@@ -12,11 +12,12 @@\n ┊12┊12┊import {NewMessageComponent} from './components/new-message/new-message.component';\n ┊13┊13┊import {SharedModule} from '../shared/shared.module';\n ┊14┊14┊import {NgxSelectableListModule} from 'ngx-selectable-list';\n+┊  ┊15┊import {AuthGuard} from '../login/services/auth.guard';\n ┊15┊16┊\n ┊16┊17┊const routes: Routes = [\n ┊17┊18┊  {\n ┊18┊19┊    path: 'chat', children: [\n-┊19┊  ┊      {path: ':id', component: ChatComponent},\n+┊  ┊20┊      {path: ':id', canActivate: [AuthGuard], component: ChatComponent},\n ┊20┊21┊    ],\n ┊21┊22┊  },\n ┊22┊23┊];\n```\n\n##### Changed src&#x2F;app&#x2F;chats-creation&#x2F;chats-creation.module.ts\n```diff\n@@ -16,10 +16,11 @@\n ┊16┊16┊import {NewGroupDetailsComponent} from './components/new-group-details/new-group-details.component';\n ┊17┊17┊import {SharedModule} from '../shared/shared.module';\n ┊18┊18┊import {NgxSelectableListModule} from 'ngx-selectable-list';\n+┊  ┊19┊import {AuthGuard} from '../login/services/auth.guard';\n ┊19┊20┊\n ┊20┊21┊const routes: Routes = [\n-┊21┊  ┊  {path: 'new-chat', component: NewChatComponent},\n-┊22┊  ┊  {path: 'new-group', component: NewGroupComponent},\n+┊  ┊22┊  {path: 'new-chat', canActivate: [AuthGuard], component: NewChatComponent},\n+┊  ┊23┊  {path: 'new-group', canActivate: [AuthGuard], component: NewGroupComponent},\n ┊23┊24┊];\n ┊24┊25┊\n ┊25┊26┊@NgModule({\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;chats-lister.module.ts\n```diff\n@@ -12,10 +12,11 @@\n ┊12┊12┊import {TruncateModule} from 'ng2-truncate';\n ┊13┊13┊import {SharedModule} from '../shared/shared.module';\n ┊14┊14┊import {NgxSelectableListModule} from 'ngx-selectable-list';\n+┊  ┊15┊import {AuthGuard} from '../login/services/auth.guard';\n ┊15┊16┊\n ┊16┊17┊const routes: Routes = [\n ┊17┊18┊  {path: '', redirectTo: 'chats', pathMatch: 'full'},\n-┊18┊  ┊  {path: 'chats', component: ChatsComponent},\n+┊  ┊19┊  {path: 'chats', canActivate: [AuthGuard], component: ChatsComponent},\n ┊19┊20┊];\n ┊20┊21┊\n ┊21┊22┊@NgModule({\n```\n\n[}]: #\n\nLast but not the least we need to fix our main service in order to not use the hardcoded user anymore. Instead we will use our Login service to read the user info from the `LocalStorage`.\n\n[{]: <helper> (diffStep \"10.1\" files=\"src/app/services/chats.service.ts\" module=\"client\")\n\n#### [Step 10.1: Authentication](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/34faf60)\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -24,6 +24,7 @@\n ┊24┊24┊} from '../../graphql';\n ┊25┊25┊import { DataProxy } from 'apollo-cache';\n ┊26┊26┊import { FetchResult } from 'apollo-link';\n+┊  ┊27┊import {LoginService} from '../login/services/login.service';\n ┊27┊28┊\n ┊28┊29┊const currentUserId = '1';\n ┊29┊30┊const currentUserName = 'Ethan Gonzalez';\n```\n```diff\n@@ -46,7 +47,8 @@\n ┊46┊47┊    private removeAllMessagesGQL: RemoveAllMessagesGQL,\n ┊47┊48┊    private getUsersGQL: GetUsersGQL,\n ┊48┊49┊    private addChatGQL: AddChatGQL,\n-┊49┊  ┊    private addGroupGQL: AddGroupGQL\n+┊  ┊50┊    private addGroupGQL: AddGroupGQL,\n+┊  ┊51┊    private loginService: LoginService\n ┊50┊52┊  ) {\n ┊51┊53┊    this.getChatsWq = this.getChatsGQL.watch({\n ┊52┊54┊      amount: this.messagesAmount,\n```\n```diff\n@@ -128,11 +130,11 @@\n ┊128┊130┊        addMessage: {\n ┊129┊131┊          id: ChatsService.getRandomId(),\n ┊130┊132┊          __typename: 'Message',\n-┊131┊   ┊          senderId: currentUserId,\n+┊   ┊133┊          senderId: this.loginService.getUser().id,\n ┊132┊134┊          sender: {\n-┊133┊   ┊            id: currentUserId,\n+┊   ┊135┊            id: this.loginService.getUser().id,\n ┊134┊136┊            __typename: 'User',\n-┊135┊   ┊            name: currentUserName,\n+┊   ┊137┊            name: this.loginService.getUser().name,\n ┊136┊138┊          },\n ┊137┊139┊          content,\n ┊138┊140┊          createdAt: moment().unix(),\n```\n```diff\n@@ -315,7 +317,7 @@\n ┊315┊317┊  // Checks if the chat is listed for the current user and returns the id\n ┊316┊318┊  getChatId(recipientId: string) {\n ┊317┊319┊    const _chat = this.chats.find(chat => {\n-┊318┊   ┊      return !chat.isGroup && !!chat.allTimeMembers.find(user => user.id === currentUserId) &&\n+┊   ┊320┊      return !chat.isGroup && !!chat.allTimeMembers.find(user => user.id === this.loginService.getUser().id) &&\n ┊319┊321┊        !!chat.allTimeMembers.find(user => user.id === recipientId);\n ┊320┊322┊    });\n ┊321┊323┊    return _chat ? _chat.id : false;\n```\n```diff\n@@ -335,7 +337,7 @@\n ┊335┊337┊            picture: users.find(user => user.id === recipientId).picture,\n ┊336┊338┊            allTimeMembers: [\n ┊337┊339┊              {\n-┊338┊   ┊                id: currentUserId,\n+┊   ┊340┊                id: this.loginService.getUser().id,\n ┊339┊341┊                __typename: 'User',\n ┊340┊342┊              },\n ┊341┊343┊              {\n```\n```diff\n@@ -387,10 +389,10 @@\n ┊387┊389┊            __typename: 'Chat',\n ┊388┊390┊            name: groupName,\n ┊389┊391┊            picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n-┊390┊   ┊            userIds: [currentUserId, recipientIds],\n+┊   ┊392┊            userIds: [this.loginService.getUser().id, recipientIds],\n ┊391┊393┊            allTimeMembers: [\n ┊392┊394┊              {\n-┊393┊   ┊                id: currentUserId,\n+┊   ┊395┊                id: this.loginService.getUser().id,\n ┊394┊396┊                __typename: 'User',\n ┊395┊397┊              },\n ┊396┊398┊              ...recipientIds.map(id => ({id, __typename: 'User'})),\n```\n\n[}]: #\n\nWe also need to fix our tests:\n\n[{]: <helper> (diffStep \"10.1\" files=\"src/app/chat-viewer/containers/chat/chat.component.spec.ts, src/app/chats-lister/containers/chats/chats.component.spec.ts, src/app/services/chats.service.spec.ts\" module=\"client\")\n\n#### [Step 10.1: Authentication](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/34faf60)\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.spec.ts\n```diff\n@@ -29,6 +29,7 @@\n ┊29┊29┊import { NewMessageComponent } from '../../components/new-message/new-message.component';\n ┊30┊30┊import { MessagesListComponent } from '../../components/messages-list/messages-list.component';\n ┊31┊31┊import { MessageItemComponent } from '../../components/message-item/message-item.component';\n+┊  ┊32┊import { LoginService } from '../../../login/services/login.service';\n ┊32┊33┊\n ┊33┊34┊describe('ChatComponent', () => {\n ┊34┊35┊  let component: ChatComponent;\n```\n```diff\n@@ -134,6 +135,7 @@\n ┊134┊135┊            queryParams: of({}),\n ┊135┊136┊          },\n ┊136┊137┊        },\n+┊   ┊138┊        LoginService,\n ┊137┊139┊      ],\n ┊138┊140┊      schemas: [NO_ERRORS_SCHEMA],\n ┊139┊141┊    }).compileComponents();\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.spec.ts\n```diff\n@@ -24,6 +24,7 @@\n ┊24┊24┊import { ChatsListComponent } from '../../components/chats-list/chats-list.component';\n ┊25┊25┊import { ChatItemComponent } from '../../components/chat-item/chat-item.component';\n ┊26┊26┊import { ChatsService } from '../../../services/chats.service';\n+┊  ┊27┊import { LoginService } from '../../../login/services/login.service';\n ┊27┊28┊\n ┊28┊29┊describe('ChatsComponent', () => {\n ┊29┊30┊  let component: ChatsComponent;\n```\n```diff\n@@ -345,6 +346,7 @@\n ┊345┊346┊            return new InMemoryCache({ dataIdFromObject });\n ┊346┊347┊          },\n ┊347┊348┊        },\n+┊   ┊349┊        LoginService,\n ┊348┊350┊      ],\n ┊349┊351┊      schemas: [NO_ERRORS_SCHEMA],\n ┊350┊352┊    }).compileComponents();\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.spec.ts\n```diff\n@@ -11,6 +11,7 @@\n ┊11┊11┊import { GetChats } from '../../graphql';\n ┊12┊12┊import { dataIdFromObject } from '../graphql.module';\n ┊13┊13┊import { ChatsService } from './chats.service';\n+┊  ┊14┊import {LoginService} from '../login/services/login.service';\n ┊14┊15┊\n ┊15┊16┊describe('ChatsService', () => {\n ┊16┊17┊  let controller: ApolloTestingController;\n```\n```diff\n@@ -312,6 +313,7 @@\n ┊312┊313┊      imports: [ApolloTestingModule],\n ┊313┊314┊      providers: [\n ┊314┊315┊        ChatsService,\n+┊   ┊316┊        LoginService,\n ┊315┊317┊        {\n ┊316┊318┊          provide: APOLLO_TESTING_CACHE,\n ┊317┊319┊          useFactory() {\n```\n\n[}]: #\n\n\n### GraphQL Server behind a firewall\n\nThere's still one thing remaining. Our GraphQL Code Generator setup is broken now. That's because every made request to the server has to have proper rights and currently the codegen's request introspection query is not authenticated. In short, we need to attach an `Authorization` header.\n\nWe're going to implement the following scenario:\n\n1. User runs `yarn generator`\n1. He is asked for a _username_ and a _password_\n1. Our script generates an _Authorization_ header\n1. GraphQL Code Generator get the GraphQL Schema of our server and outputs the types\n\nTo achieve the goal, we need to change the way we interact with the codegen.\nRight now we use GraphQL Code Generator's CLI but the tool allows to use it programatically. So one issue solved.\n\nWhat about getting user's name and password part? We will use in-terminal prompt so user can type those. There's a package for that:\n\n    yarn add -D prompt\n\nNext, create a `src/codegen.ts` file and write our script there:\n\n[{]: <helper> (diffStep \"10.1\" files=\"src/codegen.ts\" module=\"client\")\n\n#### [Step 10.1: Authentication](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/34faf60)\n\n##### Added src&#x2F;codegen.ts\n```diff\n@@ -0,0 +1,46 @@\n+┊  ┊ 1┊import * as prompt from 'prompt';\n+┊  ┊ 2┊import { generate } from 'graphql-code-generator';\n+┊  ┊ 3┊\n+┊  ┊ 4┊interface Credentials {\n+┊  ┊ 5┊  username: string;\n+┊  ┊ 6┊  password: string;\n+┊  ┊ 7┊}\n+┊  ┊ 8┊\n+┊  ┊ 9┊async function getCredentials(): Promise<Credentials> {\n+┊  ┊10┊  return new Promise<Credentials>(resolve => {\n+┊  ┊11┊    prompt.start();\n+┊  ┊12┊    prompt.get(['username', 'password'], (_err, result) => {\n+┊  ┊13┊      resolve({\n+┊  ┊14┊        username: result.username,\n+┊  ┊15┊        password: result.password,\n+┊  ┊16┊      });\n+┊  ┊17┊    });\n+┊  ┊18┊  });\n+┊  ┊19┊}\n+┊  ┊20┊\n+┊  ┊21┊function generateHeaders({ username, password }: Credentials): string[] {\n+┊  ┊22┊  const Authorization = `Basic ${Buffer.from(\n+┊  ┊23┊    `${username}:${password}`,\n+┊  ┊24┊  ).toString('base64')}`;\n+┊  ┊25┊\n+┊  ┊26┊  return [`Authorization: ${Authorization}`];\n+┊  ┊27┊}\n+┊  ┊28┊\n+┊  ┊29┊async function main() {\n+┊  ┊30┊  const credentials = await getCredentials();\n+┊  ┊31┊  const headers = generateHeaders(credentials);\n+┊  ┊32┊\n+┊  ┊33┊  await generate(\n+┊  ┊34┊    {\n+┊  ┊35┊      schema: 'http://localhost:3000/graphql',\n+┊  ┊36┊      template: 'graphql-codegen-apollo-angular-template',\n+┊  ┊37┊      out: './src/graphql.ts',\n+┊  ┊38┊      args: ['./src/graphql/**/*.ts'],\n+┊  ┊39┊      header: headers,\n+┊  ┊40┊      overwrite: true,\n+┊  ┊41┊    },\n+┊  ┊42┊    true,\n+┊  ┊43┊  );\n+┊  ┊44┊}\n+┊  ┊45┊\n+┊  ┊46┊main();\n```\n\n[}]: #\n\nLet's take a closer look what we did there:\n\n- We asks user for a _username_ and a _password_ with `prompt`\n- Based on that we generate a header\n- We put the header in `generate` function\n- there's a `true` value as the second argument, it tells codegen to write the output to a file\n\nWith all of that, whenever we run `yarn generator`, we access the GraphQL server as an authenticated user."
          },
          {
            "manualTitle": "Step 15: Subscriptions",
            "stepRevision": "4468c9c93fec39b398667d2eed81c40e4ae89eb7",
            "manualView": "## Server\n\nIn order to use WebSockets we don't need to install any package, it comes for free with Apollo Server 2.0.\n\nOur GraphQL server will use WebSockets only for subscriptions, while using HTTP for everything else. That means that we will have to add subscriptions on a specific path.\nWe're using `connectionParams` for the authentication over WebSockets, that means that we won't be using the `Passport` framework at all. Instead we will use the `onConnect` hook to manually validate the parameters provided by the user to either validate the WebSocket connection or throw an error.\nWe will also return the user object we retrieved from the db, to let the resolvers know who is the current user.\n\n[{]: <helper> (diffStep \"5.1\" files=\"index.ts\" module=\"server\")\n\n#### [Step 5.1: Subscriptions](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/729c8f0)\n\n##### Changed index.ts\n```diff\n@@ -7,9 +7,12 @@\n ┊ 7┊ 7┊import * as basicStrategy from 'passport-http';\n ┊ 8┊ 8┊import * as bcrypt from 'bcrypt-nodejs';\n ┊ 9┊ 9┊import { db, User } from \"./db\";\n+┊  ┊10┊import { createServer } from \"http\";\n ┊10┊11┊\n ┊11┊12┊let users = db.users;\n ┊12┊13┊\n+┊  ┊14┊console.log(users);\n+┊  ┊15┊\n ┊13┊16┊function generateHash(password: string) {\n ┊14┊17┊  return bcrypt.hashSync(password, bcrypt.genSaltSync(8));\n ┊15┊18┊}\n```\n```diff\n@@ -69,9 +72,30 @@\n ┊ 69┊ 72┊  schema,\n ┊ 70┊ 73┊  context(received: any) {\n ┊ 71┊ 74┊    return {\n-┊ 72┊   ┊      user: received.req!['user'],\n+┊   ┊ 75┊      user: received.connection ? received.connection.context.user : received.req!['user'],\n ┊ 73┊ 76┊    }\n ┊ 74┊ 77┊  },\n+┊   ┊ 78┊  subscriptions: {\n+┊   ┊ 79┊    onConnect: (connectionParams: any, webSocket: any) => {\n+┊   ┊ 80┊      if (connectionParams.authToken) {\n+┊   ┊ 81┊        // create a buffer and tell it the data coming in is base64\n+┊   ┊ 82┊        const buf = new Buffer(connectionParams.authToken.split(' ')[1], 'base64');\n+┊   ┊ 83┊        // read it back out as a string\n+┊   ┊ 84┊        const [username, password]: string[] = buf.toString().split(':');\n+┊   ┊ 85┊        if (username && password) {\n+┊   ┊ 86┊          const user = users.find(user => user.username == username);\n+┊   ┊ 87┊\n+┊   ┊ 88┊          if (user && validPassword(password, user.password)) {\n+┊   ┊ 89┊            // Set context for the WebSocket\n+┊   ┊ 90┊            return {user};\n+┊   ┊ 91┊          } else {\n+┊   ┊ 92┊            throw new Error('Wrong credentials!');\n+┊   ┊ 93┊          }\n+┊   ┊ 94┊        }\n+┊   ┊ 95┊      }\n+┊   ┊ 96┊      throw new Error('Missing auth token!');\n+┊   ┊ 97┊    }\n+┊   ┊ 98┊  }\n ┊ 75┊ 99┊});\n ┊ 76┊100┊\n ┊ 77┊101┊apollo.applyMiddleware({\n```\n```diff\n@@ -79,4 +103,11 @@\n ┊ 79┊103┊  path: '/graphql'\n ┊ 80┊104┊});\n ┊ 81┊105┊\n-┊ 82┊   ┊app.listen(PORT);\n+┊   ┊106┊// Wrap the Express server\n+┊   ┊107┊const ws = createServer(app);\n+┊   ┊108┊\n+┊   ┊109┊apollo.installSubscriptionHandlers(ws);\n+┊   ┊110┊\n+┊   ┊111┊ws.listen(PORT, () => {\n+┊   ┊112┊  console.log(`Apollo Server is now running on http://localhost:${PORT}`);\n+┊   ┊113┊});\n```\n\n[}]: #\n\nWe will use the `PubSub` implementation from `apollo-server-express`, and publish the data using with Apollo Server.\n\nThe process of setting up a GraphQL subscriptions server consist of the following steps:\n\n1. Declaring subscriptions in the GraphQL schema\n2. Setup a PubSub instance that our server will publish new events to\n3. Hook together `PubSub` event and GraphQL subscription.\n4. Setting up `ApolloServer`\n\n[{]: <helper> (diffStep \"5.1\" files=\"schema/typeDefs.ts\" module=\"server\")\n\n#### [Step 5.1: Subscriptions](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/729c8f0)\n\n##### Changed schema&#x2F;typeDefs.ts\n```diff\n@@ -5,6 +5,11 @@\n ┊ 5┊ 5┊    chat(chatId: ID!): Chat\n ┊ 6┊ 6┊  }\n ┊ 7┊ 7┊\n+┊  ┊ 8┊  type Subscription {\n+┊  ┊ 9┊    messageAdded(chatId: ID): Message\n+┊  ┊10┊    chatAdded: Chat\n+┊  ┊11┊  }\n+┊  ┊12┊\n ┊ 8┊13┊  enum MessageType {\n ┊ 9┊14┊    LOCATION\n ┊10┊15┊    TEXT\n```\n\n[}]: #\n\nWe created two subscriptions: one to notify for new chats and one to notify for new messages.\n\n[{]: <helper> (diffStep \"5.1\" files=\"schema/resolvers.ts\" module=\"server\")\n\n#### [Step 5.1: Subscriptions](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/729c8f0)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,7 +1,7 @@\n-┊1┊ ┊import { IResolvers } from 'apollo-server-express';\n+┊ ┊1┊import { PubSub, withFilter, IResolvers } from 'apollo-server-express';\n ┊2┊2┊import { Chat, db, Message, MessageType, Recipient, User } from \"../db\";\n ┊3┊3┊import {\n-┊4┊ ┊  AddChatMutationArgs, AddGroupMutationArgs, AddMessageMutationArgs, ChatQueryArgs,\n+┊ ┊4┊  AddChatMutationArgs, AddGroupMutationArgs, AddMessageMutationArgs, ChatQueryArgs, MessageAddedSubscriptionArgs,\n ┊5┊5┊  RemoveChatMutationArgs, RemoveMessagesMutationArgs\n ┊6┊6┊} from \"../types\";\n ┊7┊7┊import * as moment from \"moment\";\n```\n```diff\n@@ -9,6 +9,8 @@\n ┊ 9┊ 9┊let users = db.users;\n ┊10┊10┊let chats = db.chats;\n ┊11┊11┊\n+┊  ┊12┊export const pubsub = new PubSub();\n+┊  ┊13┊\n ┊12┊14┊export const resolvers: IResolvers = {\n ┊13┊15┊  Query: {\n ┊14┊16┊    // Show all users for the moment.\n```\n```diff\n@@ -50,6 +52,7 @@\n ┊50┊52┊          messages: [],\n ┊51┊53┊        };\n ┊52┊54┊        chats.push(chat);\n+┊  ┊55┊\n ┊53┊56┊        return chat;\n ┊54┊57┊      }\n ┊55┊58┊    },\n```\n```diff\n@@ -73,6 +76,12 @@\n ┊73┊76┊        messages: [],\n ┊74┊77┊      };\n ┊75┊78┊      chats.push(chat);\n+┊  ┊79┊\n+┊  ┊80┊      pubsub.publish('chatAdded', {\n+┊  ┊81┊        creatorId: currentUser.id,\n+┊  ┊82┊        chatAdded: chat,\n+┊  ┊83┊      });\n+┊  ┊84┊\n ┊76┊85┊      return chat;\n ┊77┊86┊    },\n ┊78┊87┊    removeChat: (obj: any, {chatId}: RemoveChatMutationArgs, {user: currentUser}: {user: User}): number => {\n```\n```diff\n@@ -201,6 +210,11 @@\n ┊201┊210┊          });\n ┊202┊211┊\n ┊203┊212┊          holderIds = listingMemberIds;\n+┊   ┊213┊\n+┊   ┊214┊          pubsub.publish('chatAdded', {\n+┊   ┊215┊            creatorId: currentUser.id,\n+┊   ┊216┊            chatAdded: chat,\n+┊   ┊217┊          });\n ┊204┊218┊        }\n ┊205┊219┊      } else {\n ┊206┊220┊        // Group\n```\n```diff\n@@ -245,6 +259,10 @@\n ┊245┊259┊        return chat;\n ┊246┊260┊      });\n ┊247┊261┊\n+┊   ┊262┊      pubsub.publish('messageAdded', {\n+┊   ┊263┊        messageAdded: message,\n+┊   ┊264┊      });\n+┊   ┊265┊\n ┊248┊266┊      return message;\n ┊249┊267┊    },\n ┊250┊268┊    removeMessages: (obj: any, {chatId, messageIds, all}: RemoveMessagesMutationArgs, {user: currentUser}: {user: User}): number[] => {\n```\n```diff\n@@ -286,6 +304,21 @@\n ┊286┊304┊      return deletedIds;\n ┊287┊305┊    },\n ┊288┊306┊  },\n+┊   ┊307┊  Subscription: {\n+┊   ┊308┊    messageAdded: {\n+┊   ┊309┊      subscribe: withFilter(() => pubsub.asyncIterator('messageAdded'),\n+┊   ┊310┊        ({messageAdded}: {messageAdded: Message & {chat: {id: number}}}, {chatId}: MessageAddedSubscriptionArgs, {user: currentUser}: { user: User }) => {\n+┊   ┊311┊          return (!chatId || messageAdded.chat.id === Number(chatId)) &&\n+┊   ┊312┊            !!messageAdded.recipients.find((recipient: Recipient) => recipient.userId === currentUser.id);\n+┊   ┊313┊        }),\n+┊   ┊314┊    },\n+┊   ┊315┊    chatAdded: {\n+┊   ┊316┊      subscribe: withFilter(() => pubsub.asyncIterator('chatAdded'),\n+┊   ┊317┊        ({creatorId, chatAdded}: {creatorId: string, chatAdded: Chat}, variables: any, {user: currentUser}: { user: User }) => {\n+┊   ┊318┊          return Number(creatorId) !== currentUser.id && !chatAdded.listingMemberIds.includes(currentUser.id);\n+┊   ┊319┊        }),\n+┊   ┊320┊    }\n+┊   ┊321┊  },\n ┊289┊322┊  Chat: {\n ┊290┊323┊    name: (chat: Chat, args: any, {user: currentUser}: {user: User}): string => chat.name ? chat.name : users\n ┊291┊324┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser.id))!.name,\n```\n\n[}]: #\n\nWe will publish a message to the `messageAdded` subscription every time that a user sends a message, then we will filter them according to the current user (we don't want to send someone else's messages).\nThe `chatAdded` subscription is similar: we will publish each time that a group gets created, but not when chats get created. This is because when a user creates a chat the chat doesn't appear to the other peer until he writes the first message. That's why we also publish when new messages get added (we first look if the other peer already gets the chat listed).\n\n## Client\n\nIn order to use WebSockets we will need to install a couple of dependencies:\n\n    yarn add apollo-link-ws apollo-utilities subscriptions-transport-ws\n\nFirst let's create the queries for the GraphQL Subscriptions:\n\n[{]: <helper> (diffStep \"11.1\" files=\"src/graphql\" module=\"client\")\n\n#### [Step 11.1: Subscriptions](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/8219b49)\n\n##### Changed src&#x2F;graphql.ts\n```diff\n@@ -651,6 +651,22 @@\n ┊651┊651┊  export type AddMessage = Message.Fragment;\n ┊652┊652┊}\n ┊653┊653┊\n+┊   ┊654┊export namespace ChatAdded {\n+┊   ┊655┊  export type Variables = {};\n+┊   ┊656┊\n+┊   ┊657┊  export type Subscription = {\n+┊   ┊658┊    __typename?: \"Subscription\";\n+┊   ┊659┊    chatAdded?: ChatAdded | null;\n+┊   ┊660┊  };\n+┊   ┊661┊\n+┊   ┊662┊  export type ChatAdded = {\n+┊   ┊663┊    __typename?: \"Chat\";\n+┊   ┊664┊    messages: (Messages | null)[];\n+┊   ┊665┊  } & ChatWithoutMessages.Fragment;\n+┊   ┊666┊\n+┊   ┊667┊  export type Messages = Message.Fragment;\n+┊   ┊668┊}\n+┊   ┊669┊\n ┊654┊670┊export namespace GetChat {\n ┊655┊671┊  export type Variables = {\n ┊656┊672┊    chatId: string;\n```\n```diff\n@@ -703,6 +719,27 @@\n ┊703┊719┊  };\n ┊704┊720┊}\n ┊705┊721┊\n+┊   ┊722┊export namespace MessageAdded {\n+┊   ┊723┊  export type Variables = {\n+┊   ┊724┊    chatId?: string | null;\n+┊   ┊725┊  };\n+┊   ┊726┊\n+┊   ┊727┊  export type Subscription = {\n+┊   ┊728┊    __typename?: \"Subscription\";\n+┊   ┊729┊    messageAdded?: MessageAdded | null;\n+┊   ┊730┊  };\n+┊   ┊731┊\n+┊   ┊732┊  export type MessageAdded = {\n+┊   ┊733┊    __typename?: \"Message\";\n+┊   ┊734┊    chat: Chat;\n+┊   ┊735┊  } & Message.Fragment;\n+┊   ┊736┊\n+┊   ┊737┊  export type Chat = {\n+┊   ┊738┊    __typename?: \"Chat\";\n+┊   ┊739┊    id: string;\n+┊   ┊740┊  };\n+┊   ┊741┊}\n+┊   ┊742┊\n ┊706┊743┊export namespace RemoveAllMessages {\n ┊707┊744┊  export type Variables = {\n ┊708┊745┊    chatId: string;\n```\n```diff\n@@ -924,6 +961,27 @@\n ┊924┊961┊@Injectable({\n ┊925┊962┊  providedIn: \"root\"\n ┊926┊963┊})\n+┊   ┊964┊export class ChatAddedGQL extends Apollo.Subscription<\n+┊   ┊965┊  ChatAdded.Subscription,\n+┊   ┊966┊  ChatAdded.Variables\n+┊   ┊967┊> {\n+┊   ┊968┊  document: any = gql`\n+┊   ┊969┊    subscription chatAdded {\n+┊   ┊970┊      chatAdded {\n+┊   ┊971┊        ...ChatWithoutMessages\n+┊   ┊972┊        messages {\n+┊   ┊973┊          ...Message\n+┊   ┊974┊        }\n+┊   ┊975┊      }\n+┊   ┊976┊    }\n+┊   ┊977┊\n+┊   ┊978┊    ${ChatWithoutMessagesFragment}\n+┊   ┊979┊    ${MessageFragment}\n+┊   ┊980┊  `;\n+┊   ┊981┊}\n+┊   ┊982┊@Injectable({\n+┊   ┊983┊  providedIn: \"root\"\n+┊   ┊984┊})\n ┊927┊985┊export class GetChatGQL extends Apollo.Query<GetChat.Query, GetChat.Variables> {\n ┊928┊986┊  document: any = gql`\n ┊929┊987┊    query GetChat($chatId: ID!) {\n```\n```diff\n@@ -980,6 +1038,26 @@\n ┊ 980┊1038┊@Injectable({\n ┊ 981┊1039┊  providedIn: \"root\"\n ┊ 982┊1040┊})\n+┊    ┊1041┊export class MessageAddedGQL extends Apollo.Subscription<\n+┊    ┊1042┊  MessageAdded.Subscription,\n+┊    ┊1043┊  MessageAdded.Variables\n+┊    ┊1044┊> {\n+┊    ┊1045┊  document: any = gql`\n+┊    ┊1046┊    subscription messageAdded($chatId: ID) {\n+┊    ┊1047┊      messageAdded(chatId: $chatId) {\n+┊    ┊1048┊        ...Message\n+┊    ┊1049┊        chat {\n+┊    ┊1050┊          id\n+┊    ┊1051┊        }\n+┊    ┊1052┊      }\n+┊    ┊1053┊    }\n+┊    ┊1054┊\n+┊    ┊1055┊    ${MessageFragment}\n+┊    ┊1056┊  `;\n+┊    ┊1057┊}\n+┊    ┊1058┊@Injectable({\n+┊    ┊1059┊  providedIn: \"root\"\n+┊    ┊1060┊})\n ┊ 983┊1061┊export class RemoveAllMessagesGQL extends Apollo.Mutation<\n ┊ 984┊1062┊  RemoveAllMessages.Mutation,\n ┊ 985┊1063┊  RemoveAllMessages.Variables\n```\n\n##### Added src&#x2F;graphql&#x2F;chatAdded.subscription.ts\n```diff\n@@ -0,0 +1,17 @@\n+┊  ┊ 1┊import gql from 'graphql-tag';\n+┊  ┊ 2┊import {fragments} from './fragment';\n+┊  ┊ 3┊\n+┊  ┊ 4┊// We use the gql tag to parse our query string into a query document\n+┊  ┊ 5┊export const chatAddedSubscription = gql`\n+┊  ┊ 6┊  subscription chatAdded {\n+┊  ┊ 7┊    chatAdded {\n+┊  ┊ 8┊      ...ChatWithoutMessages\n+┊  ┊ 9┊      messages {\n+┊  ┊10┊        ...Message\n+┊  ┊11┊      }\n+┊  ┊12┊    }\n+┊  ┊13┊  }\n+┊  ┊14┊\n+┊  ┊15┊  ${fragments['chatWithoutMessages']}\n+┊  ┊16┊  ${fragments['message']}\n+┊  ┊17┊`;\n```\n\n##### Added src&#x2F;graphql&#x2F;messageAdded.subscription.ts\n```diff\n@@ -0,0 +1,16 @@\n+┊  ┊ 1┊import gql from 'graphql-tag';\n+┊  ┊ 2┊import {fragments} from './fragment';\n+┊  ┊ 3┊\n+┊  ┊ 4┊// We use the gql tag to parse our query string into a query document\n+┊  ┊ 5┊export const messageAddedSubscription = gql`\n+┊  ┊ 6┊  subscription messageAdded($chatId: ID) {\n+┊  ┊ 7┊    messageAdded(chatId: $chatId) {\n+┊  ┊ 8┊      ...Message\n+┊  ┊ 9┊      chat {\n+┊  ┊10┊        id,\n+┊  ┊11┊      },\n+┊  ┊12┊    }\n+┊  ┊13┊  }\n+┊  ┊14┊\n+┊  ┊15┊  ${fragments['message']}\n+┊  ┊16┊`;\n```\n\n[}]: #\n\nThen we need to run `graphql-code-generator` to generate the types:\n\n    yarn generator\n\nNow we can update the chats service to update the getChats query every time that we receive a new chat from the subscription.\nWith GraphQL subscriptions your client will be alerted on push from the server and you should choose the pattern that fits your application the most:\n\n- Use it as a notification and run any logic you want when it fires, for example alerting the user or refetching data\n- Use the data sent along with the notification and merge it directly into the store (existing queries are automatically notified)\n\nWith subscribeToMore, you can easily do the latter. We will manipulate the store to add the newly created chat.\n\nWe will do to do the same for the newMessage subscription, but this time we will have to update two different queries in the store: getChats and getChat.\n\n[{]: <helper> (diffStep \"11.1\" files=\"src/app/services/chats.service.ts\" module=\"client\")\n\n#### [Step 11.1: Subscriptions](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/8219b49)\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,7 +1,7 @@\n ┊1┊1┊import {concat, map, share, switchMap} from 'rxjs/operators';\n ┊2┊2┊import {Injectable} from '@angular/core';\n ┊3┊3┊import {Observable, AsyncSubject, of} from 'rxjs';\n-┊4┊ ┊import {QueryRef} from 'apollo-angular';\n+┊ ┊4┊import {Apollo, QueryRef} from 'apollo-angular';\n ┊5┊5┊import * as moment from 'moment';\n ┊6┊6┊import {\n ┊7┊7┊  GetChatsGQL,\n```\n```diff\n@@ -13,6 +13,8 @@\n ┊13┊13┊  GetUsersGQL,\n ┊14┊14┊  AddChatGQL,\n ┊15┊15┊  AddGroupGQL,\n+┊  ┊16┊  ChatAddedGQL,\n+┊  ┊17┊  MessageAddedGQL,\n ┊16┊18┊  AddMessage,\n ┊17┊19┊  GetChats,\n ┊18┊20┊  GetChat,\n```\n```diff\n@@ -21,6 +23,7 @@\n ┊21┊23┊  GetUsers,\n ┊22┊24┊  AddChat,\n ┊23┊25┊  AddGroup,\n+┊  ┊26┊  MessageAdded,\n ┊24┊27┊} from '../../graphql';\n ┊25┊28┊import { DataProxy } from 'apollo-cache';\n ┊26┊29┊import { FetchResult } from 'apollo-link';\n```\n```diff\n@@ -48,11 +51,69 @@\n ┊ 48┊ 51┊    private getUsersGQL: GetUsersGQL,\n ┊ 49┊ 52┊    private addChatGQL: AddChatGQL,\n ┊ 50┊ 53┊    private addGroupGQL: AddGroupGQL,\n+┊   ┊ 54┊    private chatAddedGQL: ChatAddedGQL,\n+┊   ┊ 55┊    private messageAddedGQL: MessageAddedGQL,\n+┊   ┊ 56┊    private apollo: Apollo,\n ┊ 51┊ 57┊    private loginService: LoginService\n ┊ 52┊ 58┊  ) {\n ┊ 53┊ 59┊    this.getChatsWq = this.getChatsGQL.watch({\n ┊ 54┊ 60┊      amount: this.messagesAmount,\n ┊ 55┊ 61┊    });\n+┊   ┊ 62┊\n+┊   ┊ 63┊    this.getChatsWq.subscribeToMore({\n+┊   ┊ 64┊      document: this.chatAddedGQL.document,\n+┊   ┊ 65┊      updateQuery: (prev: GetChats.Query, { subscriptionData }) => {\n+┊   ┊ 66┊        if (!subscriptionData.data) {\n+┊   ┊ 67┊          return prev;\n+┊   ┊ 68┊        }\n+┊   ┊ 69┊\n+┊   ┊ 70┊        const newChat: GetChats.Chats = subscriptionData.data.chatAdded;\n+┊   ┊ 71┊\n+┊   ┊ 72┊        return Object.assign({}, prev, {\n+┊   ┊ 73┊          chats: [...prev.chats, newChat]\n+┊   ┊ 74┊        });\n+┊   ┊ 75┊      }\n+┊   ┊ 76┊    });\n+┊   ┊ 77┊\n+┊   ┊ 78┊    this.getChatsWq.subscribeToMore({\n+┊   ┊ 79┊      document: this.messageAddedGQL.document,\n+┊   ┊ 80┊      updateQuery: (prev: GetChats.Query, { subscriptionData }) => {\n+┊   ┊ 81┊        if (!subscriptionData.data) {\n+┊   ┊ 82┊          return prev;\n+┊   ┊ 83┊        }\n+┊   ┊ 84┊\n+┊   ┊ 85┊        const newMessage: MessageAdded.MessageAdded = subscriptionData.data.messageAdded;\n+┊   ┊ 86┊\n+┊   ┊ 87┊        // We need to update the cache for both Chat and Chats. The following updates the cache for Chat.\n+┊   ┊ 88┊        try {\n+┊   ┊ 89┊          // Read the data from our cache for this query.\n+┊   ┊ 90┊          const {chat}: GetChat.Query = this.apollo.getClient().readQuery({\n+┊   ┊ 91┊            query: this.getChatGQL.document,\n+┊   ┊ 92┊            variables: {\n+┊   ┊ 93┊              chatId: newMessage.chat.id,\n+┊   ┊ 94┊            }\n+┊   ┊ 95┊          });\n+┊   ┊ 96┊\n+┊   ┊ 97┊          // Add our message from the mutation to the end.\n+┊   ┊ 98┊          chat.messages.push(newMessage);\n+┊   ┊ 99┊          // Write our data back to the cache.\n+┊   ┊100┊          this.apollo.getClient().writeQuery({\n+┊   ┊101┊            query: this.getChatGQL.document,\n+┊   ┊102┊            data: {\n+┊   ┊103┊              chat\n+┊   ┊104┊            }\n+┊   ┊105┊          });\n+┊   ┊106┊        } catch {\n+┊   ┊107┊          console.error('The chat we received an update for does not exist in the store');\n+┊   ┊108┊        }\n+┊   ┊109┊\n+┊   ┊110┊        return Object.assign({}, prev, {\n+┊   ┊111┊          chats: [...prev.chats.map(_chat =>\n+┊   ┊112┊            _chat.id === newMessage.chat.id ? {..._chat, messages: [..._chat.messages, newMessage]} : _chat)]\n+┊   ┊113┊        });\n+┊   ┊114┊      }\n+┊   ┊115┊    });\n+┊   ┊116┊\n ┊ 56┊117┊    this.chats$ = this.getChatsWq.valueChanges.pipe(\n ┊ 57┊118┊      map((result) => result.data.chats)\n ┊ 58┊119┊    );\n```\n```diff\n@@ -130,6 +191,10 @@\n ┊130┊191┊        addMessage: {\n ┊131┊192┊          id: ChatsService.getRandomId(),\n ┊132┊193┊          __typename: 'Message',\n+┊   ┊194┊          chat: {\n+┊   ┊195┊            id: chatId,\n+┊   ┊196┊            __typename: 'Chat',\n+┊   ┊197┊          },\n ┊133┊198┊          senderId: this.loginService.getUser().id,\n ┊134┊199┊          sender: {\n ┊135┊200┊            id: this.loginService.getUser().id,\n```\n\n[}]: #\n\nWe can finally configure the WebSocket in the GraphQL Module. Please notice that the WebSocket has its own authentication instead of using the `HttpInterceptor`, in fact we use `connectionParams` to send the authorization.\nAll queries will go through HTTP except the Subscriptions, which will use the WebSocket.\n\n[{]: <helper> (diffStep \"11.1\" files=\"src/app/graphql.module.ts\" module=\"client\")\n\n#### [Step 11.1: Subscriptions](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/8219b49)\n\n##### Changed src&#x2F;app&#x2F;graphql.module.ts\n```diff\n@@ -2,6 +2,11 @@\n ┊ 2┊ 2┊import { ApolloModule, APOLLO_OPTIONS } from 'apollo-angular';\n ┊ 3┊ 3┊import { HttpLinkModule, HttpLink } from 'apollo-angular-link-http';\n ┊ 4┊ 4┊import { InMemoryCache, defaultDataIdFromObject } from 'apollo-cache-inmemory';\n+┊  ┊ 5┊import {getMainDefinition} from 'apollo-utilities';\n+┊  ┊ 6┊import {OperationDefinitionNode} from 'graphql';\n+┊  ┊ 7┊import {split} from 'apollo-link';\n+┊  ┊ 8┊import {WebSocketLink} from 'apollo-link-ws';\n+┊  ┊ 9┊import {LoginService} from './login/services/login.service';\n ┊ 5┊10┊\n ┊ 6┊11┊const uri = 'http://localhost:3000/graphql';\n ┊ 7┊12┊\n```\n```diff\n@@ -14,9 +19,28 @@\n ┊14┊19┊  }\n ┊15┊20┊};\n ┊16┊21┊\n-┊17┊  ┊export function createApollo(httpLink: HttpLink) {\n+┊  ┊22┊export function createApollo(httpLink: HttpLink, loginService: LoginService) {\n+┊  ┊23┊  const subscriptionLink = new WebSocketLink({\n+┊  ┊24┊    uri: uri.replace('http', 'ws'),\n+┊  ┊25┊    options: {\n+┊  ┊26┊      reconnect: true,\n+┊  ┊27┊      connectionParams: () => ({\n+┊  ┊28┊        authToken: loginService.getAuthHeader() || null\n+┊  ┊29┊      })\n+┊  ┊30┊    }\n+┊  ┊31┊  });\n+┊  ┊32┊\n+┊  ┊33┊  const link = split(\n+┊  ┊34┊    ({ query }) => {\n+┊  ┊35┊      const { kind, operation } = getMainDefinition(query) as OperationDefinitionNode;\n+┊  ┊36┊      return kind === 'OperationDefinition' && operation === 'subscription';\n+┊  ┊37┊    },\n+┊  ┊38┊    subscriptionLink,\n+┊  ┊39┊    httpLink.create({uri})\n+┊  ┊40┊  );\n+┊  ┊41┊\n ┊18┊42┊  return {\n-┊19┊  ┊    link: httpLink.create({ uri }),\n+┊  ┊43┊    link,\n ┊20┊44┊    cache: new InMemoryCache({\n ┊21┊45┊      dataIdFromObject,\n ┊22┊46┊    }),\n```\n```diff\n@@ -29,7 +53,7 @@\n ┊29┊53┊    {\n ┊30┊54┊      provide: APOLLO_OPTIONS,\n ┊31┊55┊      useFactory: createApollo,\n-┊32┊  ┊      deps: [HttpLink],\n+┊  ┊56┊      deps: [HttpLink, LoginService],\n ┊33┊57┊    },\n ┊34┊58┊  ],\n ┊35┊59┊})\n```\n\n[}]: #\n\nWe used `split` of ApolloLink to decide which path should a request get, through WebSocket or HTTP. We decided to push subscriptions over the WebSocket and the rest normally, just like before.\n\nFinally, let's fix the tests:\n\n[{]: <helper> (diffStep \"11.1\" files=\"src/app/chat-viewer/containers/chat/chat.component.spec.ts, src/app/chats-lister/containers/chats/chats.component.spec.ts, src/app/services/chats.service.spec.ts\" module=\"client\")\n\n#### [Step 11.1: Subscriptions](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/8219b49)\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.spec.ts\n```diff\n@@ -148,6 +148,8 @@\n ┊148┊148┊    component = fixture.componentInstance;\n ┊149┊149┊    fixture.detectChanges();\n ┊150┊150┊\n+┊   ┊151┊    controller.expectOne('chatAdded', 'call to chatAdded api');\n+┊   ┊152┊    controller.expectOne('messageAdded', 'call to messageAdded api');\n ┊151┊153┊    controller.expectOne('GetChats', 'call to getChats api');\n ┊152┊154┊\n ┊153┊155┊    const req = controller.expectOne('GetChat', 'call to getChat api');\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.spec.ts\n```diff\n@@ -360,8 +360,10 @@\n ┊360┊360┊    component = fixture.componentInstance;\n ┊361┊361┊    fixture.detectChanges();\n ┊362┊362┊\n-┊363┊   ┊    const req = controller.expectOne('GetChats', 'GetChats operation');\n+┊   ┊363┊    controller.expectOne('chatAdded', 'call to chatAdded api');\n+┊   ┊364┊    controller.expectOne('messageAdded', 'call to messageAdded api');\n ┊364┊365┊\n+┊   ┊366┊    const req = controller.expectOne('GetChats', 'GetChats operation');\n ┊365┊367┊    req.flush({\n ┊366┊368┊      data: {\n ┊367┊369┊        chats,\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.spec.ts\n```diff\n@@ -11,7 +11,7 @@\n ┊11┊11┊import { GetChats } from '../../graphql';\n ┊12┊12┊import { dataIdFromObject } from '../graphql.module';\n ┊13┊13┊import { ChatsService } from './chats.service';\n-┊14┊  ┊import {LoginService} from '../login/services/login.service';\n+┊  ┊14┊import { LoginService } from '../login/services/login.service';\n ┊15┊15┊\n ┊16┊16┊describe('ChatsService', () => {\n ┊17┊17┊  let controller: ApolloTestingController;\n```\n```diff\n@@ -341,6 +341,9 @@\n ┊341┊341┊      }\n ┊342┊342┊    });\n ┊343┊343┊\n+┊   ┊344┊    controller.expectOne('chatAdded', 'call to chatAdded api');\n+┊   ┊345┊    controller.expectOne('messageAdded', 'call to messageAdded api');\n+┊   ┊346┊\n ┊344┊347┊    const req = controller.expectOne('GetChats', 'GetChats operation');\n ┊345┊348┊\n ┊346┊349┊    req.flush({\n```\n\n[}]: #"
          },
          {
            "manualTitle": "Step 16: TypeORM with PostgreSQL",
            "stepRevision": "8686ed12d75fe225a178dd89175a3e594df424c9",
            "manualView": "## Server\n\nFirst of all you will have to install PostgreSQL on your operating system. Since there so many options (different Linux distributions, MacOS X, Windows...) I will assume that you already know how to install a software in your OS and take that part for granted.\n\nThen you will have to install a couple of packages:\n\n    yarn add pg reflect-metadata typeorm\n    yarn add -D @types/pg\n\nWe aren't going to use plain SQL, instead we will use an Object-relational mapping framework (ORM) called `TypeORM`.\n`TypeORM` takes advantage of Typescript classes and type declarations in order to infer the db structure.\n\nWe will need to enable support for experimental decorators, emit type metadata for decorators and disable strict property initialization:\n\n[{]: <helper> (diffStep \"6.1\" files=\"tsconfig.json\" module=\"server\")\n\n#### [Step 6.1: TypeORM with PostgreSQL](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/00c4cab)\n\n##### Changed tsconfig.json\n```diff\n@@ -22,11 +22,11 @@\n ┊22┊22┊    // \"isolatedModules\": true,               /* Transpile each file as a separate module (similar to 'ts.transpileModule'). */\n ┊23┊23┊\n ┊24┊24┊    /* Strict Type-Checking Options */\n-┊25┊  ┊    \"strict\": true,                            /* Enable all strict type-checking options. */\n+┊  ┊25┊    \"strict\": true,                           /* Enable all strict type-checking options. */\n ┊26┊26┊    // \"noImplicitAny\": true,                 /* Raise error on expressions and declarations with an implied 'any' type. */\n ┊27┊27┊    // \"strictNullChecks\": true,              /* Enable strict null checks. */\n ┊28┊28┊    // See https://github.com/DefinitelyTyped/DefinitelyTyped/issues/21359\n-┊29┊  ┊    \"strictFunctionTypes\": false              /* Enable strict checking of function types. */\n+┊  ┊29┊    \"strictFunctionTypes\": false,             /* Enable strict checking of function types. */\n ┊30┊30┊    // \"noImplicitThis\": true,                /* Raise error on 'this' expressions with an implied 'any' type. */\n ┊31┊31┊    // \"alwaysStrict\": true,                  /* Parse in strict mode and emit \"use strict\" for each source file. */\n ┊32┊32┊\n```\n```diff\n@@ -53,7 +53,8 @@\n ┊53┊53┊    // \"inlineSources\": true,                 /* Emit the source alongside the sourcemaps within a single file; requires '--inlineSourceMap' or '--sourceMap' to be set. */\n ┊54┊54┊\n ┊55┊55┊    /* Experimental Options */\n-┊56┊  ┊    // \"experimentalDecorators\": true,        /* Enables experimental support for ES7 decorators. */\n-┊57┊  ┊    // \"emitDecoratorMetadata\": true,         /* Enables experimental support for emitting type metadata for decorators. */\n+┊  ┊56┊    \"experimentalDecorators\": true,           /* Enables experimental support for ES7 decorators. */\n+┊  ┊57┊    \"emitDecoratorMetadata\": true,            /* Enables experimental support for emitting type metadata for decorators. */\n+┊  ┊58┊    \"strictPropertyInitialization\": false\n ┊58┊59┊  }\n ┊59┊60┊}🚫↵\n```\n\n[}]: #\n\nThe next step is to create Entities. An Entity is a class that maps to a database table. You can create a entity by defining a new class and mark it with @Entity():\n\n[{]: <helper> (diffStep \"6.1\" files=\"entity\" module=\"server\")\n\n#### [Step 6.1: TypeORM with PostgreSQL](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/00c4cab)\n\n##### Added entity&#x2F;Chat.ts\n```diff\n@@ -0,0 +1,79 @@\n+┊  ┊ 1┊import { Entity, Column, PrimaryGeneratedColumn, OneToMany, JoinTable, ManyToMany, ManyToOne } from \"typeorm\";\n+┊  ┊ 2┊import { Message } from \"./Message\";\n+┊  ┊ 3┊import { User } from \"./User\";\n+┊  ┊ 4┊import { Recipient } from \"./Recipient\";\n+┊  ┊ 5┊\n+┊  ┊ 6┊interface ChatConstructor {\n+┊  ┊ 7┊  name?: string;\n+┊  ┊ 8┊  picture?: string;\n+┊  ┊ 9┊  allTimeMembers?: User[];\n+┊  ┊10┊  listingMembers?: User[];\n+┊  ┊11┊  actualGroupMembers?: User[];\n+┊  ┊12┊  admins?: User[];\n+┊  ┊13┊  owner?: User;\n+┊  ┊14┊  messages?: Message[];\n+┊  ┊15┊}\n+┊  ┊16┊\n+┊  ┊17┊@Entity()\n+┊  ┊18┊export class Chat {\n+┊  ┊19┊  @PrimaryGeneratedColumn()\n+┊  ┊20┊  id: number;\n+┊  ┊21┊\n+┊  ┊22┊  @Column({nullable: true})\n+┊  ┊23┊  name: string;\n+┊  ┊24┊\n+┊  ┊25┊  @Column({nullable: true})\n+┊  ┊26┊  picture: string;\n+┊  ┊27┊\n+┊  ┊28┊  @ManyToMany(type => User, user => user.allTimeMemberChats, {cascade: [\"insert\", \"update\"], eager: false})\n+┊  ┊29┊  @JoinTable()\n+┊  ┊30┊  allTimeMembers: User[];\n+┊  ┊31┊\n+┊  ┊32┊  @ManyToMany(type => User, user => user.listingMemberChats, {cascade: [\"insert\", \"update\"], eager: false})\n+┊  ┊33┊  @JoinTable()\n+┊  ┊34┊  listingMembers: User[];\n+┊  ┊35┊\n+┊  ┊36┊  @ManyToMany(type => User, user => user.actualGroupMemberChats, {cascade: [\"insert\", \"update\"], eager: false})\n+┊  ┊37┊  @JoinTable()\n+┊  ┊38┊  actualGroupMembers?: User[];\n+┊  ┊39┊\n+┊  ┊40┊  @ManyToMany(type => User, user => user.adminChats, {cascade: [\"insert\", \"update\"], eager: false})\n+┊  ┊41┊  @JoinTable()\n+┊  ┊42┊  admins?: User[];\n+┊  ┊43┊\n+┊  ┊44┊  @ManyToOne(type => User, user => user.ownerChats, {cascade: [\"insert\", \"update\"], eager: false})\n+┊  ┊45┊  owner?: User | null;\n+┊  ┊46┊\n+┊  ┊47┊  @OneToMany(type => Message, message => message.chat, {cascade: [\"insert\", \"update\"], eager: true})\n+┊  ┊48┊  messages: Message[];\n+┊  ┊49┊\n+┊  ┊50┊  @OneToMany(type => Recipient, recipient => recipient.chat)\n+┊  ┊51┊  recipients: Recipient[];\n+┊  ┊52┊\n+┊  ┊53┊  constructor({name, picture, allTimeMembers, listingMembers, actualGroupMembers, admins, owner, messages}: ChatConstructor = {}) {\n+┊  ┊54┊    if (name) {\n+┊  ┊55┊      this.name = name;\n+┊  ┊56┊    }\n+┊  ┊57┊    if (picture) {\n+┊  ┊58┊      this.picture = picture;\n+┊  ┊59┊    }\n+┊  ┊60┊    if (allTimeMembers) {\n+┊  ┊61┊      this.allTimeMembers = allTimeMembers;\n+┊  ┊62┊    }\n+┊  ┊63┊    if (listingMembers) {\n+┊  ┊64┊      this.listingMembers = listingMembers;\n+┊  ┊65┊    }\n+┊  ┊66┊    if (actualGroupMembers) {\n+┊  ┊67┊      this.actualGroupMembers = actualGroupMembers;\n+┊  ┊68┊    }\n+┊  ┊69┊    if (admins) {\n+┊  ┊70┊      this.admins = admins;\n+┊  ┊71┊    }\n+┊  ┊72┊    if (owner) {\n+┊  ┊73┊      this.owner = owner;\n+┊  ┊74┊    }\n+┊  ┊75┊    if (messages) {\n+┊  ┊76┊      this.messages = messages;\n+┊  ┊77┊    }\n+┊  ┊78┊  }\n+┊  ┊79┊}\n```\n\n##### Added entity&#x2F;Message.ts\n```diff\n@@ -0,0 +1,70 @@\n+┊  ┊ 1┊import {\n+┊  ┊ 2┊  Entity, Column, PrimaryGeneratedColumn, OneToMany, ManyToOne, ManyToMany, JoinTable, CreateDateColumn\n+┊  ┊ 3┊} from \"typeorm\";\n+┊  ┊ 4┊import { Chat } from \"./Chat\";\n+┊  ┊ 5┊import { User } from \"./User\";\n+┊  ┊ 6┊import { Recipient } from \"./Recipient\";\n+┊  ┊ 7┊import { MessageType } from \"../db\";\n+┊  ┊ 8┊\n+┊  ┊ 9┊interface MessageConstructor {\n+┊  ┊10┊  sender?: User;\n+┊  ┊11┊  content?: string;\n+┊  ┊12┊  createdAt?: Date,\n+┊  ┊13┊  type?: MessageType;\n+┊  ┊14┊  recipients?: Recipient[];\n+┊  ┊15┊  holders?: User[];\n+┊  ┊16┊  chat?: Chat;\n+┊  ┊17┊}\n+┊  ┊18┊\n+┊  ┊19┊@Entity()\n+┊  ┊20┊export class Message {\n+┊  ┊21┊  @PrimaryGeneratedColumn()\n+┊  ┊22┊  id: number;\n+┊  ┊23┊\n+┊  ┊24┊  @ManyToOne(type => User, user => user.senderMessages, {eager: true})\n+┊  ┊25┊  sender: User;\n+┊  ┊26┊\n+┊  ┊27┊  @Column()\n+┊  ┊28┊  content: string;\n+┊  ┊29┊\n+┊  ┊30┊  @CreateDateColumn({nullable: true})\n+┊  ┊31┊  createdAt: Date;\n+┊  ┊32┊\n+┊  ┊33┊  @Column()\n+┊  ┊34┊  type: number;\n+┊  ┊35┊\n+┊  ┊36┊  @OneToMany(type => Recipient, recipient => recipient.message, {cascade: [\"insert\", \"update\"], eager: true})\n+┊  ┊37┊  recipients: Recipient[];\n+┊  ┊38┊\n+┊  ┊39┊  @ManyToMany(type => User, user => user.holderMessages, {cascade: [\"insert\", \"update\"], eager: true})\n+┊  ┊40┊  @JoinTable()\n+┊  ┊41┊  holders: User[];\n+┊  ┊42┊\n+┊  ┊43┊  @ManyToOne(type => Chat, chat => chat.messages)\n+┊  ┊44┊  chat: Chat;\n+┊  ┊45┊\n+┊  ┊46┊  constructor({sender, content, createdAt, type, recipients, holders, chat}: MessageConstructor = {}) {\n+┊  ┊47┊    if (sender) {\n+┊  ┊48┊      this.sender = sender;\n+┊  ┊49┊    }\n+┊  ┊50┊    if (content) {\n+┊  ┊51┊      this.content = content;\n+┊  ┊52┊    }\n+┊  ┊53┊    if (createdAt) {\n+┊  ┊54┊      this.createdAt = createdAt;\n+┊  ┊55┊    }\n+┊  ┊56┊    if (type) {\n+┊  ┊57┊      this.type = type;\n+┊  ┊58┊    }\n+┊  ┊59┊    if (recipients) {\n+┊  ┊60┊      recipients.forEach(recipient => recipient.message = this);\n+┊  ┊61┊      this.recipients = recipients;\n+┊  ┊62┊    }\n+┊  ┊63┊    if (holders) {\n+┊  ┊64┊      this.holders = holders;\n+┊  ┊65┊    }\n+┊  ┊66┊    if (chat) {\n+┊  ┊67┊      this.chat = chat;\n+┊  ┊68┊    }\n+┊  ┊69┊  }\n+┊  ┊70┊}\n```\n\n##### Added entity&#x2F;Recipient.ts\n```diff\n@@ -0,0 +1,44 @@\n+┊  ┊ 1┊import { Entity, ManyToOne, Column } from \"typeorm\";\n+┊  ┊ 2┊import { Message } from \"./Message\";\n+┊  ┊ 3┊import { User } from \"./User\";\n+┊  ┊ 4┊import { Chat } from \"./Chat\";\n+┊  ┊ 5┊\n+┊  ┊ 6┊interface RecipientConstructor {\n+┊  ┊ 7┊  user?: User;\n+┊  ┊ 8┊  message?: Message;\n+┊  ┊ 9┊  receivedAt?: Date;\n+┊  ┊10┊  readAt?: Date;\n+┊  ┊11┊}\n+┊  ┊12┊\n+┊  ┊13┊@Entity()\n+┊  ┊14┊export class Recipient {\n+┊  ┊15┊  @ManyToOne(type => User, user => user.recipients, { primary: true })\n+┊  ┊16┊  user: User;\n+┊  ┊17┊\n+┊  ┊18┊  @ManyToOne(type => Message, message => message.recipients, { primary: true })\n+┊  ┊19┊  message: Message;\n+┊  ┊20┊\n+┊  ┊21┊  @ManyToOne(type => Chat, chat => chat.recipients)\n+┊  ┊22┊  chat: Chat;\n+┊  ┊23┊\n+┊  ┊24┊  @Column({nullable: true})\n+┊  ┊25┊  receivedAt: Date;\n+┊  ┊26┊\n+┊  ┊27┊  @Column({nullable: true})\n+┊  ┊28┊  readAt: Date;\n+┊  ┊29┊\n+┊  ┊30┊  constructor({user, message, receivedAt, readAt}: RecipientConstructor = {}) {\n+┊  ┊31┊    if (user) {\n+┊  ┊32┊      this.user = user;\n+┊  ┊33┊    }\n+┊  ┊34┊    if (message) {\n+┊  ┊35┊      this.message = message;\n+┊  ┊36┊    }\n+┊  ┊37┊    if (receivedAt) {\n+┊  ┊38┊      this.receivedAt = receivedAt;\n+┊  ┊39┊    }\n+┊  ┊40┊    if (readAt) {\n+┊  ┊41┊      this.readAt = readAt;\n+┊  ┊42┊    }\n+┊  ┊43┊  }\n+┊  ┊44┊}\n```\n\n##### Added entity&#x2F;User.ts\n```diff\n@@ -0,0 +1,75 @@\n+┊  ┊ 1┊import { Entity, Column, PrimaryGeneratedColumn, ManyToMany, OneToMany } from \"typeorm\";\n+┊  ┊ 2┊import { Chat } from \"./Chat\";\n+┊  ┊ 3┊import { Message } from \"./Message\";\n+┊  ┊ 4┊import { Recipient } from \"./Recipient\";\n+┊  ┊ 5┊\n+┊  ┊ 6┊interface UserConstructor {\n+┊  ┊ 7┊  username?: string;\n+┊  ┊ 8┊  password?: string;\n+┊  ┊ 9┊  name?: string;\n+┊  ┊10┊  picture?: string;\n+┊  ┊11┊  phone?: string;\n+┊  ┊12┊}\n+┊  ┊13┊\n+┊  ┊14┊@Entity()\n+┊  ┊15┊export class User {\n+┊  ┊16┊  @PrimaryGeneratedColumn()\n+┊  ┊17┊  id: number;\n+┊  ┊18┊\n+┊  ┊19┊  @Column()\n+┊  ┊20┊  username: string;\n+┊  ┊21┊\n+┊  ┊22┊  @Column()\n+┊  ┊23┊  password: string;\n+┊  ┊24┊\n+┊  ┊25┊  @Column()\n+┊  ┊26┊  name: string;\n+┊  ┊27┊\n+┊  ┊28┊  @Column({nullable: true})\n+┊  ┊29┊  picture: string;\n+┊  ┊30┊\n+┊  ┊31┊  @Column({nullable: true})\n+┊  ┊32┊  phone?: string;\n+┊  ┊33┊\n+┊  ┊34┊  @ManyToMany(type => Chat, chat => chat.allTimeMembers)\n+┊  ┊35┊  allTimeMemberChats: Chat[];\n+┊  ┊36┊\n+┊  ┊37┊  @ManyToMany(type => Chat, chat => chat.listingMembers)\n+┊  ┊38┊  listingMemberChats: Chat[];\n+┊  ┊39┊\n+┊  ┊40┊  @ManyToMany(type => Chat, chat => chat.actualGroupMembers)\n+┊  ┊41┊  actualGroupMemberChats: Chat[];\n+┊  ┊42┊\n+┊  ┊43┊  @ManyToMany(type => Chat, chat => chat.admins)\n+┊  ┊44┊  adminChats: Chat[];\n+┊  ┊45┊\n+┊  ┊46┊  @ManyToMany(type => Message, message => message.holders)\n+┊  ┊47┊  holderMessages: Message[];\n+┊  ┊48┊\n+┊  ┊49┊  @OneToMany(type => Chat, chat => chat.owner)\n+┊  ┊50┊  ownerChats: Chat[];\n+┊  ┊51┊\n+┊  ┊52┊  @OneToMany(type => Message, message => message.sender)\n+┊  ┊53┊  senderMessages: Message[];\n+┊  ┊54┊\n+┊  ┊55┊  @OneToMany(type => Recipient, recipient => recipient.user)\n+┊  ┊56┊  recipients: Recipient[];\n+┊  ┊57┊\n+┊  ┊58┊  constructor({username, password, name, picture, phone}: UserConstructor = {}) {\n+┊  ┊59┊    if (username) {\n+┊  ┊60┊      this.username = username;\n+┊  ┊61┊    }\n+┊  ┊62┊    if (password) {\n+┊  ┊63┊      this.password = password;\n+┊  ┊64┊    }\n+┊  ┊65┊    if (name) {\n+┊  ┊66┊      this.name = name;\n+┊  ┊67┊    }\n+┊  ┊68┊    if (picture) {\n+┊  ┊69┊      this.picture = picture;\n+┊  ┊70┊    }\n+┊  ┊71┊    if (phone) {\n+┊  ┊72┊      this.phone = phone;\n+┊  ┊73┊    }\n+┊  ┊74┊  }\n+┊  ┊75┊}\n```\n\n[}]: #\n\nBasic entities consist of columns and relations. Each entity MUST have a primary column.\n\nEach entity must be registered in your connection options:\n\n[{]: <helper> (diffStep \"6.1\" files=\"ormconfig.json\" module=\"server\")\n\n#### [Step 6.1: TypeORM with PostgreSQL](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/00c4cab)\n\n##### Added ormconfig.json\n```diff\n@@ -0,0 +1,24 @@\n+┊  ┊ 1┊{\n+┊  ┊ 2┊   \"type\": \"postgres\",\n+┊  ┊ 3┊   \"host\": \"localhost\",\n+┊  ┊ 4┊   \"port\": 5432,\n+┊  ┊ 5┊   \"username\": \"test\",\n+┊  ┊ 6┊   \"password\": \"\",\n+┊  ┊ 7┊   \"database\": \"test\",\n+┊  ┊ 8┊   \"synchronize\": true,\n+┊  ┊ 9┊   \"logging\": false,\n+┊  ┊10┊   \"entities\": [\n+┊  ┊11┊      \"entity/**/*.ts\"\n+┊  ┊12┊   ],\n+┊  ┊13┊   \"migrations\": [\n+┊  ┊14┊      \"migration/**/*.ts\"\n+┊  ┊15┊   ],\n+┊  ┊16┊   \"subscribers\": [\n+┊  ┊17┊      \"subscriber/**/*.ts\"\n+┊  ┊18┊   ],\n+┊  ┊19┊   \"cli\": {\n+┊  ┊20┊      \"entitiesDir\": \"entity\",\n+┊  ┊21┊      \"migrationsDir\": \"migration\",\n+┊  ┊22┊      \"subscribersDir\": \"subscriber\"\n+┊  ┊23┊   }\n+┊  ┊24┊}🚫↵\n```\n\n[}]: #\n\nSince database table consist of columns your entities must consist of columns too. Each entity class property you marked with @Column will be mapped to a database table column.\nEach entity must have at least one primary column. There are several types of primary columns, but in our case `@PrimaryGeneratedColumn()` creates a primary column which value will be automatically generated with an auto-increment value.\n`@CreateDateColumn` is a special column that is automatically set to the entity's insertion date. You don't need set this column - it will be automatically set.\nFor the Recipient Entity we use a composite primary key that consists of two foreign keys.\n\nThe next thing to do is to create a connection with the database before firing up the web server:\n\n[{]: <helper> (diffStep \"6.1\" files=\"index.ts\" module=\"server\")\n\n#### [Step 6.1: TypeORM with PostgreSQL](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/00c4cab)\n\n##### Changed index.ts\n```diff\n@@ -1,3 +1,5 @@\n+┊ ┊1┊// For TypeORM\n+┊ ┊2┊import \"reflect-metadata\";\n ┊1┊3┊import { schema } from \"./schema\";\n ┊2┊4┊import * as bodyParser from \"body-parser\";\n ┊3┊5┊import * as cors from 'cors';\n```\n```diff\n@@ -6,12 +8,10 @@\n ┊ 6┊ 8┊import * as passport from \"passport\";\n ┊ 7┊ 9┊import * as basicStrategy from 'passport-http';\n ┊ 8┊10┊import * as bcrypt from 'bcrypt-nodejs';\n-┊ 9┊  ┊import { db, User } from \"./db\";\n ┊10┊11┊import { createServer } from \"http\";\n-┊11┊  ┊\n-┊12┊  ┊let users = db.users;\n-┊13┊  ┊\n-┊14┊  ┊console.log(users);\n+┊  ┊12┊import { createConnection } from \"typeorm\";\n+┊  ┊13┊import { User } from \"./entity/User\";\n+┊  ┊14┊import { addSampleData } from \"./db\";\n ┊15┊15┊\n ┊16┊16┊function generateHash(password: string) {\n ┊17┊17┊  return bcrypt.hashSync(password, bcrypt.genSaltSync(8));\n```\n```diff\n@@ -21,93 +21,96 @@\n ┊ 21┊ 21┊  return bcrypt.compareSync(password, localPassword);\n ┊ 22┊ 22┊}\n ┊ 23┊ 23┊\n-┊ 24┊   ┊passport.use('basic-signin', new basicStrategy.BasicStrategy(\n-┊ 25┊   ┊  function (username: string, password: string, done: any) {\n-┊ 26┊   ┊    const user = users.find(user => user.username == username);\n-┊ 27┊   ┊    if (user && validPassword(password, user.password)) {\n-┊ 28┊   ┊      return done(null, user);\n+┊   ┊ 24┊createConnection().then(async connection => {\n+┊   ┊ 25┊  await addSampleData(connection);\n+┊   ┊ 26┊\n+┊   ┊ 27┊  passport.use('basic-signin', new basicStrategy.BasicStrategy(\n+┊   ┊ 28┊    async function (username: string, password: string, done: any) {\n+┊   ┊ 29┊      const user = await connection.getRepository(User).findOne({where: { username }});\n+┊   ┊ 30┊      if (user && validPassword(password, user.password)) {\n+┊   ┊ 31┊        return done(null, user);\n+┊   ┊ 32┊      }\n+┊   ┊ 33┊      return done(null, false);\n ┊ 29┊ 34┊    }\n-┊ 30┊   ┊    return done(null, false);\n-┊ 31┊   ┊  }\n-┊ 32┊   ┊));\n-┊ 33┊   ┊\n-┊ 34┊   ┊passport.use('basic-signup', new basicStrategy.BasicStrategy({passReqToCallback: true},\n-┊ 35┊   ┊  function (req: any, username: any, password: any, done: any) {\n-┊ 36┊   ┊    const userExists = !!users.find(user => user.username === username);\n-┊ 37┊   ┊    if (!userExists && password && req.body.name) {\n-┊ 38┊   ┊      const user: User = {\n-┊ 39┊   ┊        id: (users.length && users[users.length - 1].id + 1) || 1,\n-┊ 40┊   ┊        username,\n-┊ 41┊   ┊        password: generateHash(password),\n-┊ 42┊   ┊        name: req.body.name,\n-┊ 43┊   ┊      };\n-┊ 44┊   ┊      users.push(user);\n-┊ 45┊   ┊      return done(null, user);\n+┊   ┊ 35┊  ));\n+┊   ┊ 36┊\n+┊   ┊ 37┊  passport.use('basic-signup', new basicStrategy.BasicStrategy({passReqToCallback: true},\n+┊   ┊ 38┊    async function (req: any, username: string, password: string, done: any) {\n+┊   ┊ 39┊      const userExists = !!(await connection.getRepository(User).findOne({where: { username }}));\n+┊   ┊ 40┊      if (!userExists && password && req.body.name) {\n+┊   ┊ 41┊        const user = await connection.manager.save(new User({\n+┊   ┊ 42┊          username,\n+┊   ┊ 43┊          password: generateHash(password),\n+┊   ┊ 44┊          name: req.body.name,\n+┊   ┊ 45┊        }));\n+┊   ┊ 46┊        return done(null, user);\n+┊   ┊ 47┊      }\n+┊   ┊ 48┊      return done(null, false);\n ┊ 46┊ 49┊    }\n-┊ 47┊   ┊    return done(null, false);\n-┊ 48┊   ┊  }\n-┊ 49┊   ┊));\n+┊   ┊ 50┊  ));\n ┊ 50┊ 51┊\n-┊ 51┊   ┊const PORT = 3000;\n+┊   ┊ 52┊  const PORT = 3000;\n ┊ 52┊ 53┊\n-┊ 53┊   ┊const app = express();\n+┊   ┊ 54┊  const app = express();\n ┊ 54┊ 55┊\n-┊ 55┊   ┊app.use(cors());\n-┊ 56┊   ┊app.use(bodyParser.json());\n-┊ 57┊   ┊app.use(passport.initialize());\n+┊   ┊ 56┊  app.use(cors());\n+┊   ┊ 57┊  app.use(bodyParser.json());\n+┊   ┊ 58┊  app.use(passport.initialize());\n ┊ 58┊ 59┊\n-┊ 59┊   ┊app.post('/signup',\n-┊ 60┊   ┊  passport.authenticate('basic-signup', {session: false}),\n-┊ 61┊   ┊  function (req: any, res) {\n-┊ 62┊   ┊    res.json(req.user);\n-┊ 63┊   ┊  });\n+┊   ┊ 60┊  app.post('/signup',\n+┊   ┊ 61┊    passport.authenticate('basic-signup', {session: false}),\n+┊   ┊ 62┊    function (req: any, res) {\n+┊   ┊ 63┊      res.json(req.user);\n+┊   ┊ 64┊    });\n ┊ 64┊ 65┊\n-┊ 65┊   ┊app.use(passport.authenticate('basic-signin', {session: false}));\n+┊   ┊ 66┊  app.use(passport.authenticate('basic-signin', {session: false}));\n ┊ 66┊ 67┊\n-┊ 67┊   ┊app.post('/signin', function (req: any, res) {\n-┊ 68┊   ┊  res.json(req.user);\n-┊ 69┊   ┊});\n+┊   ┊ 68┊  app.post('/signin', function (req, res) {\n+┊   ┊ 69┊    res.json(req.user);\n+┊   ┊ 70┊  });\n ┊ 70┊ 71┊\n-┊ 71┊   ┊const apollo = new ApolloServer({\n-┊ 72┊   ┊  schema,\n-┊ 73┊   ┊  context(received: any) {\n-┊ 74┊   ┊    return {\n-┊ 75┊   ┊      user: received.connection ? received.connection.context.user : received.req!['user'],\n-┊ 76┊   ┊    }\n-┊ 77┊   ┊  },\n-┊ 78┊   ┊  subscriptions: {\n-┊ 79┊   ┊    onConnect: (connectionParams: any, webSocket: any) => {\n-┊ 80┊   ┊      if (connectionParams.authToken) {\n-┊ 81┊   ┊        // create a buffer and tell it the data coming in is base64\n-┊ 82┊   ┊        const buf = new Buffer(connectionParams.authToken.split(' ')[1], 'base64');\n-┊ 83┊   ┊        // read it back out as a string\n-┊ 84┊   ┊        const [username, password]: string[] = buf.toString().split(':');\n-┊ 85┊   ┊        if (username && password) {\n-┊ 86┊   ┊          const user = users.find(user => user.username == username);\n-┊ 87┊   ┊\n-┊ 88┊   ┊          if (user && validPassword(password, user.password)) {\n-┊ 89┊   ┊            // Set context for the WebSocket\n-┊ 90┊   ┊            return {user};\n-┊ 91┊   ┊          } else {\n-┊ 92┊   ┊            throw new Error('Wrong credentials!');\n+┊   ┊ 72┊  const apollo = new ApolloServer({\n+┊   ┊ 73┊    schema,\n+┊   ┊ 74┊    context(received: any) {\n+┊   ┊ 75┊      return {\n+┊   ┊ 76┊        user: received.connection ? received.connection.context.user : received.req!['user'],\n+┊   ┊ 77┊        connection,\n+┊   ┊ 78┊      }\n+┊   ┊ 79┊    },\n+┊   ┊ 80┊    subscriptions: {\n+┊   ┊ 81┊      onConnect: async (connectionParams: any, webSocket: any) => {\n+┊   ┊ 82┊        if (connectionParams.authToken) {\n+┊   ┊ 83┊          // Create a buffer and tell it the data coming in is base64\n+┊   ┊ 84┊          const buf = new Buffer(connectionParams.authToken.split(' ')[1], 'base64');\n+┊   ┊ 85┊          // Read it back out as a string\n+┊   ┊ 86┊          const [username, password]: string[] = buf.toString().split(':');\n+┊   ┊ 87┊          if (username && password) {\n+┊   ┊ 88┊            const user = await connection.getRepository(User).findOne({where: { username }});\n+┊   ┊ 89┊\n+┊   ┊ 90┊            if (user && validPassword(password, user.password)) {\n+┊   ┊ 91┊              // Set context for the WebSocket\n+┊   ┊ 92┊              return {user};\n+┊   ┊ 93┊            } else {\n+┊   ┊ 94┊              throw new Error('Wrong credentials!');\n+┊   ┊ 95┊            }\n ┊ 93┊ 96┊          }\n ┊ 94┊ 97┊        }\n+┊   ┊ 98┊        throw new Error('Missing auth token!');\n ┊ 95┊ 99┊      }\n-┊ 96┊   ┊      throw new Error('Missing auth token!');\n ┊ 97┊100┊    }\n-┊ 98┊   ┊  }\n-┊ 99┊   ┊});\n+┊   ┊101┊  });\n ┊100┊102┊\n-┊101┊   ┊apollo.applyMiddleware({\n-┊102┊   ┊  app,\n-┊103┊   ┊  path: '/graphql'\n-┊104┊   ┊});\n+┊   ┊103┊  apollo.applyMiddleware({\n+┊   ┊104┊    app,\n+┊   ┊105┊    path: '/graphql'\n+┊   ┊106┊  });\n ┊105┊107┊\n-┊106┊   ┊// Wrap the Express server\n-┊107┊   ┊const ws = createServer(app);\n+┊   ┊108┊  // Wrap the Express server\n+┊   ┊109┊  const ws = createServer(app);\n ┊108┊110┊\n-┊109┊   ┊apollo.installSubscriptionHandlers(ws);\n+┊   ┊111┊  apollo.installSubscriptionHandlers(ws);\n ┊110┊112┊\n-┊111┊   ┊ws.listen(PORT, () => {\n-┊112┊   ┊  console.log(`Apollo Server is now running on http://localhost:${PORT}`);\n+┊   ┊113┊  ws.listen(PORT, () => {\n+┊   ┊114┊    console.log(`Apollo Server is now running on http://localhost:${PORT}`);\n+┊   ┊115┊  });\n ┊113┊116┊});\n```\n\n[}]: #\n\nWe will also remove our fake db and replace it with some real data:\n\n[{]: <helper> (diffStep \"6.1\" files=\"db.ts\" module=\"server\")\n\n#### [Step 6.1: TypeORM with PostgreSQL](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/00c4cab)\n\n##### Changed db.ts\n```diff\n@@ -1,4 +1,11 @@\n+┊  ┊ 1┊// For TypeORM\n+┊  ┊ 2┊import \"reflect-metadata\";\n+┊  ┊ 3┊import { Chat } from \"./entity/Chat\";\n+┊  ┊ 4┊import { Recipient } from \"./entity/Recipient\";\n ┊ 1┊ 5┊import * as moment from 'moment';\n+┊  ┊ 6┊import { Message } from \"./entity/Message\";\n+┊  ┊ 7┊import { User } from \"./entity/User\";\n+┊  ┊ 8┊import { Connection } from \"typeorm\";\n ┊ 2┊ 9┊\n ┊ 3┊10┊export enum MessageType {\n ┊ 4┊11┊  PICTURE,\n```\n```diff\n@@ -6,433 +13,280 @@\n ┊  6┊ 13┊  LOCATION,\n ┊  7┊ 14┊}\n ┊  8┊ 15┊\n-┊  9┊   ┊export interface User {\n-┊ 10┊   ┊  id: number,\n-┊ 11┊   ┊  username: string,\n-┊ 12┊   ┊  password: string,\n-┊ 13┊   ┊  name: string,\n-┊ 14┊   ┊  picture?: string | null,\n-┊ 15┊   ┊  phone?: string | null,\n-┊ 16┊   ┊}\n-┊ 17┊   ┊\n-┊ 18┊   ┊export interface Chat {\n-┊ 19┊   ┊  id: number,\n-┊ 20┊   ┊  name?: string | null,\n-┊ 21┊   ┊  picture?: string | null,\n-┊ 22┊   ┊  // All members, current and past ones.\n-┊ 23┊   ┊  allTimeMemberIds: number[],\n-┊ 24┊   ┊  // Whoever gets the chat listed. For groups includes past members who still didn't delete the group.\n-┊ 25┊   ┊  listingMemberIds: number[],\n-┊ 26┊   ┊  // Actual members of the group (they are not the only ones who get the group listed). Null for chats.\n-┊ 27┊   ┊  actualGroupMemberIds?: number[] | null,\n-┊ 28┊   ┊  adminIds?: number[] | null,\n-┊ 29┊   ┊  ownerId?: number | null,\n-┊ 30┊   ┊  messages: Message[],\n-┊ 31┊   ┊}\n-┊ 32┊   ┊\n-┊ 33┊   ┊export interface Message {\n-┊ 34┊   ┊  id: number,\n-┊ 35┊   ┊  chatId: number,\n-┊ 36┊   ┊  senderId: number,\n-┊ 37┊   ┊  content: string,\n-┊ 38┊   ┊  createdAt: number,\n-┊ 39┊   ┊  type: MessageType,\n-┊ 40┊   ┊  recipients: Recipient[],\n-┊ 41┊   ┊  holderIds: number[],\n-┊ 42┊   ┊}\n-┊ 43┊   ┊\n-┊ 44┊   ┊export interface Recipient {\n-┊ 45┊   ┊  userId: number,\n-┊ 46┊   ┊  messageId: number,\n-┊ 47┊   ┊  chatId: number,\n-┊ 48┊   ┊  receivedAt: number | null,\n-┊ 49┊   ┊  readAt: number | null,\n-┊ 50┊   ┊}\n-┊ 51┊   ┊\n-┊ 52┊   ┊const users: User[] = [\n-┊ 53┊   ┊  {\n-┊ 54┊   ┊    id: 1,\n+┊   ┊ 16┊export async function addSampleData(connection: Connection) {\n+┊   ┊ 17┊  const user1 = new User({\n ┊ 55┊ 18┊    username: 'ethan',\n ┊ 56┊ 19┊    password: '$2a$08$NO9tkFLCoSqX1c5wk3s7z.JfxaVMKA.m7zUDdDwEquo4rvzimQeJm', // 111\n ┊ 57┊ 20┊    name: 'Ethan Gonzalez',\n ┊ 58┊ 21┊    picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n ┊ 59┊ 22┊    phone: '+391234567890',\n-┊ 60┊   ┊  },\n-┊ 61┊   ┊  {\n-┊ 62┊   ┊    id: 2,\n+┊   ┊ 23┊  });\n+┊   ┊ 24┊  await connection.manager.save(user1);\n+┊   ┊ 25┊\n+┊   ┊ 26┊  const user2 = new User({\n ┊ 63┊ 27┊    username: 'bryan',\n ┊ 64┊ 28┊    password: '$2a$08$xE4FuCi/ifxjL2S8CzKAmuKLwv18ktksSN.F3XYEnpmcKtpbpeZgO', // 222\n ┊ 65┊ 29┊    name: 'Bryan Wallace',\n ┊ 66┊ 30┊    picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n ┊ 67┊ 31┊    phone: '+391234567891',\n-┊ 68┊   ┊  },\n-┊ 69┊   ┊  {\n-┊ 70┊   ┊    id: 3,\n+┊   ┊ 32┊  });\n+┊   ┊ 33┊  await connection.manager.save(user2);\n+┊   ┊ 34┊\n+┊   ┊ 35┊  const user3 = new User({\n ┊ 71┊ 36┊    username: 'avery',\n ┊ 72┊ 37┊    password: '$2a$08$UHgH7J8G6z1mGQn2qx2kdeWv0jvgHItyAsL9hpEUI3KJmhVW5Q1d.', // 333\n ┊ 73┊ 38┊    name: 'Avery Stewart',\n ┊ 74┊ 39┊    picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n ┊ 75┊ 40┊    phone: '+391234567892',\n-┊ 76┊   ┊  },\n-┊ 77┊   ┊  {\n-┊ 78┊   ┊    id: 4,\n+┊   ┊ 41┊  });\n+┊   ┊ 42┊  await connection.manager.save(user3);\n+┊   ┊ 43┊\n+┊   ┊ 44┊  const user4 = new User({\n ┊ 79┊ 45┊    username: 'katie',\n ┊ 80┊ 46┊    password: '$2a$08$wR1k5Q3T9FC7fUgB7Gdb9Os/GV7dGBBf4PLlWT7HERMFhmFDt47xi', // 444\n ┊ 81┊ 47┊    name: 'Katie Peterson',\n ┊ 82┊ 48┊    picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n ┊ 83┊ 49┊    phone: '+391234567893',\n-┊ 84┊   ┊  },\n-┊ 85┊   ┊  {\n-┊ 86┊   ┊    id: 5,\n+┊   ┊ 50┊  });\n+┊   ┊ 51┊  await connection.manager.save(user4);\n+┊   ┊ 52┊\n+┊   ┊ 53┊  const user5 = new User({\n ┊ 87┊ 54┊    username: 'ray',\n ┊ 88┊ 55┊    password: '$2a$08$6.mbXqsDX82ZZ7q5d8Osb..JrGSsNp4R3IKj7mxgF6YGT0OmMw242', // 555\n ┊ 89┊ 56┊    name: 'Ray Edwards',\n ┊ 90┊ 57┊    picture: 'https://randomuser.me/api/portraits/thumb/men/3.jpg',\n ┊ 91┊ 58┊    phone: '+391234567894',\n-┊ 92┊   ┊  },\n-┊ 93┊   ┊  {\n-┊ 94┊   ┊    id: 6,\n+┊   ┊ 59┊  });\n+┊   ┊ 60┊  await connection.manager.save(user5);\n+┊   ┊ 61┊\n+┊   ┊ 62┊  const user6 = new User({\n ┊ 95┊ 63┊    username: 'niko',\n ┊ 96┊ 64┊    password: '$2a$08$fL5lZR.Rwf9FWWe8XwwlceiPBBim8n9aFtaem.INQhiKT4.Ux3Uq.', // 666\n ┊ 97┊ 65┊    name: 'Niccolò Belli',\n ┊ 98┊ 66┊    picture: 'https://randomuser.me/api/portraits/thumb/men/4.jpg',\n ┊ 99┊ 67┊    phone: '+391234567895',\n-┊100┊   ┊  },\n-┊101┊   ┊  {\n-┊102┊   ┊    id: 7,\n+┊   ┊ 68┊  });\n+┊   ┊ 69┊  await connection.manager.save(user6);\n+┊   ┊ 70┊\n+┊   ┊ 71┊  const user7 = new User({\n ┊103┊ 72┊    username: 'mario',\n ┊104┊ 73┊    password: '$2a$08$nDHDmWcVxDnH5DDT3HMMC.psqcnu6wBiOgkmJUy9IH..qxa3R6YrO', // 777\n ┊105┊ 74┊    name: 'Mario Rossi',\n ┊106┊ 75┊    picture: 'https://randomuser.me/api/portraits/thumb/men/5.jpg',\n ┊107┊ 76┊    phone: '+391234567896',\n-┊108┊   ┊  },\n-┊109┊   ┊];\n+┊   ┊ 77┊  });\n+┊   ┊ 78┊  await connection.manager.save(user7);\n+┊   ┊ 79┊\n+┊   ┊ 80┊\n ┊110┊ 81┊\n-┊111┊   ┊const chats: Chat[] = [\n-┊112┊   ┊  {\n-┊113┊   ┊    id: 1,\n-┊114┊   ┊    name: null,\n-┊115┊   ┊    picture: null,\n-┊116┊   ┊    allTimeMemberIds: [1, 3],\n-┊117┊   ┊    listingMemberIds: [1, 3],\n-┊118┊   ┊    adminIds: null,\n-┊119┊   ┊    ownerId: null,\n+┊   ┊ 82┊\n+┊   ┊ 83┊  await connection.manager.save(new Chat({\n+┊   ┊ 84┊    allTimeMembers: [user1, user3],\n+┊   ┊ 85┊    listingMembers: [user1, user3],\n ┊120┊ 86┊    messages: [\n-┊121┊   ┊      {\n-┊122┊   ┊        id: 1,\n-┊123┊   ┊        chatId: 1,\n-┊124┊   ┊        senderId: 1,\n+┊   ┊ 87┊      new Message({\n+┊   ┊ 88┊        sender: user1,\n ┊125┊ 89┊        content: 'You on your way?',\n-┊126┊   ┊        createdAt: moment().subtract(1, 'hours').unix(),\n+┊   ┊ 90┊        createdAt: moment().subtract(1, 'hours').toDate(),\n ┊127┊ 91┊        type: MessageType.TEXT,\n+┊   ┊ 92┊        holders: [user1, user3],\n ┊128┊ 93┊        recipients: [\n-┊129┊   ┊          {\n-┊130┊   ┊            userId: 3,\n-┊131┊   ┊            messageId: 1,\n-┊132┊   ┊            chatId: 1,\n-┊133┊   ┊            receivedAt: null,\n-┊134┊   ┊            readAt: null,\n-┊135┊   ┊          },\n+┊   ┊ 94┊          new Recipient({\n+┊   ┊ 95┊            user: user3,\n+┊   ┊ 96┊          }),\n ┊136┊ 97┊        ],\n-┊137┊   ┊        holderIds: [1, 3],\n-┊138┊   ┊      },\n-┊139┊   ┊      {\n-┊140┊   ┊        id: 2,\n-┊141┊   ┊        chatId: 1,\n-┊142┊   ┊        senderId: 3,\n+┊   ┊ 98┊      }),\n+┊   ┊ 99┊      new Message({\n+┊   ┊100┊        sender: user3,\n ┊143┊101┊        content: 'Yep!',\n-┊144┊   ┊        createdAt: moment().subtract(1, 'hours').add(5, 'minutes').unix(),\n+┊   ┊102┊        createdAt: moment().subtract(1, 'hours').add(5, 'minutes').toDate(),\n ┊145┊103┊        type: MessageType.TEXT,\n+┊   ┊104┊        holders: [user1, user3],\n ┊146┊105┊        recipients: [\n-┊147┊   ┊          {\n-┊148┊   ┊            userId: 1,\n-┊149┊   ┊            messageId: 2,\n-┊150┊   ┊            chatId: 1,\n-┊151┊   ┊            receivedAt: null,\n-┊152┊   ┊            readAt: null,\n-┊153┊   ┊          },\n+┊   ┊106┊          new Recipient({\n+┊   ┊107┊            user: user1,\n+┊   ┊108┊          }),\n ┊154┊109┊        ],\n-┊155┊   ┊        holderIds: [3, 1],\n-┊156┊   ┊      },\n+┊   ┊110┊      }),\n ┊157┊111┊    ],\n-┊158┊   ┊  },\n-┊159┊   ┊  {\n-┊160┊   ┊    id: 2,\n-┊161┊   ┊    name: null,\n-┊162┊   ┊    picture: null,\n-┊163┊   ┊    allTimeMemberIds: [1, 4],\n-┊164┊   ┊    listingMemberIds: [1, 4],\n-┊165┊   ┊    adminIds: null,\n-┊166┊   ┊    ownerId: null,\n+┊   ┊112┊  }));\n+┊   ┊113┊\n+┊   ┊114┊  await connection.manager.save(new Chat({\n+┊   ┊115┊    allTimeMembers: [user1, user4],\n+┊   ┊116┊    listingMembers: [user1, user4],\n ┊167┊117┊    messages: [\n-┊168┊   ┊      {\n-┊169┊   ┊        id: 1,\n-┊170┊   ┊        chatId: 2,\n-┊171┊   ┊        senderId: 1,\n+┊   ┊118┊      new Message({\n+┊   ┊119┊        sender: user1,\n ┊172┊120┊        content: 'Hey, it\\'s me',\n-┊173┊   ┊        createdAt: moment().subtract(2, 'hours').unix(),\n+┊   ┊121┊        createdAt: moment().subtract(2, 'hours').toDate(),\n ┊174┊122┊        type: MessageType.TEXT,\n+┊   ┊123┊        holders: [user1, user4],\n ┊175┊124┊        recipients: [\n-┊176┊   ┊          {\n-┊177┊   ┊            userId: 4,\n-┊178┊   ┊            messageId: 1,\n-┊179┊   ┊            chatId: 2,\n-┊180┊   ┊            receivedAt: null,\n-┊181┊   ┊            readAt: null,\n-┊182┊   ┊          },\n+┊   ┊125┊          new Recipient({\n+┊   ┊126┊            user: user4,\n+┊   ┊127┊          }),\n ┊183┊128┊        ],\n-┊184┊   ┊        holderIds: [1, 4],\n-┊185┊   ┊      },\n+┊   ┊129┊      }),\n ┊186┊130┊    ],\n-┊187┊   ┊  },\n-┊188┊   ┊  {\n-┊189┊   ┊    id: 3,\n-┊190┊   ┊    name: null,\n-┊191┊   ┊    picture: null,\n-┊192┊   ┊    allTimeMemberIds: [1, 5],\n-┊193┊   ┊    listingMemberIds: [1, 5],\n-┊194┊   ┊    adminIds: null,\n-┊195┊   ┊    ownerId: null,\n+┊   ┊131┊  }));\n+┊   ┊132┊\n+┊   ┊133┊  await connection.manager.save(new Chat({\n+┊   ┊134┊    allTimeMembers: [user1, user5],\n+┊   ┊135┊    listingMembers: [user1, user5],\n ┊196┊136┊    messages: [\n-┊197┊   ┊      {\n-┊198┊   ┊        id: 1,\n-┊199┊   ┊        chatId: 3,\n-┊200┊   ┊        senderId: 1,\n+┊   ┊137┊      new Message({\n+┊   ┊138┊        sender: user1,\n ┊201┊139┊        content: 'I should buy a boat',\n-┊202┊   ┊        createdAt: moment().subtract(1, 'days').unix(),\n+┊   ┊140┊        createdAt: moment().subtract(1, 'days').toDate(),\n ┊203┊141┊        type: MessageType.TEXT,\n+┊   ┊142┊        holders: [user1, user5],\n ┊204┊143┊        recipients: [\n-┊205┊   ┊          {\n-┊206┊   ┊            userId: 5,\n-┊207┊   ┊            messageId: 1,\n-┊208┊   ┊            chatId: 3,\n-┊209┊   ┊            receivedAt: null,\n-┊210┊   ┊            readAt: null,\n-┊211┊   ┊          },\n+┊   ┊144┊          new Recipient({\n+┊   ┊145┊            user: user5,\n+┊   ┊146┊          }),\n ┊212┊147┊        ],\n-┊213┊   ┊        holderIds: [1, 5],\n-┊214┊   ┊      },\n-┊215┊   ┊      {\n-┊216┊   ┊        id: 2,\n-┊217┊   ┊        chatId: 3,\n-┊218┊   ┊        senderId: 1,\n+┊   ┊148┊      }),\n+┊   ┊149┊      new Message({\n+┊   ┊150┊        sender: user1,\n ┊219┊151┊        content: 'You still there?',\n-┊220┊   ┊        createdAt: moment().subtract(1, 'days').add(16, 'hours').unix(),\n+┊   ┊152┊        createdAt: moment().subtract(1, 'days').add(16, 'hours').toDate(),\n ┊221┊153┊        type: MessageType.TEXT,\n+┊   ┊154┊        holders: [user1, user5],\n ┊222┊155┊        recipients: [\n-┊223┊   ┊          {\n-┊224┊   ┊            userId: 5,\n-┊225┊   ┊            messageId: 2,\n-┊226┊   ┊            chatId: 3,\n-┊227┊   ┊            receivedAt: null,\n-┊228┊   ┊            readAt: null,\n-┊229┊   ┊          },\n+┊   ┊156┊          new Recipient({\n+┊   ┊157┊            user: user5,\n+┊   ┊158┊          }),\n ┊230┊159┊        ],\n-┊231┊   ┊        holderIds: [1, 5],\n-┊232┊   ┊      },\n+┊   ┊160┊      }),\n ┊233┊161┊    ],\n-┊234┊   ┊  },\n-┊235┊   ┊  {\n-┊236┊   ┊    id: 4,\n-┊237┊   ┊    name: null,\n-┊238┊   ┊    picture: null,\n-┊239┊   ┊    allTimeMemberIds: [3, 4],\n-┊240┊   ┊    listingMemberIds: [3, 4],\n-┊241┊   ┊    adminIds: null,\n-┊242┊   ┊    ownerId: null,\n+┊   ┊162┊  }));\n+┊   ┊163┊\n+┊   ┊164┊  await connection.manager.save(new Chat({\n+┊   ┊165┊    allTimeMembers: [user3, user4],\n+┊   ┊166┊    listingMembers: [user3, user4],\n ┊243┊167┊    messages: [\n-┊244┊   ┊      {\n-┊245┊   ┊        id: 1,\n-┊246┊   ┊        chatId: 4,\n-┊247┊   ┊        senderId: 3,\n+┊   ┊168┊      new Message({\n+┊   ┊169┊        sender: user3,\n ┊248┊170┊        content: 'Look at my mukluks!',\n-┊249┊   ┊        createdAt: moment().subtract(4, 'days').unix(),\n+┊   ┊171┊        createdAt: moment().subtract(4, 'days').toDate(),\n ┊250┊172┊        type: MessageType.TEXT,\n+┊   ┊173┊        holders: [user3, user4],\n ┊251┊174┊        recipients: [\n-┊252┊   ┊          {\n-┊253┊   ┊            userId: 4,\n-┊254┊   ┊            messageId: 1,\n-┊255┊   ┊            chatId: 4,\n-┊256┊   ┊            receivedAt: null,\n-┊257┊   ┊            readAt: null,\n-┊258┊   ┊          },\n+┊   ┊175┊          new Recipient({\n+┊   ┊176┊            user: user4,\n+┊   ┊177┊          }),\n ┊259┊178┊        ],\n-┊260┊   ┊        holderIds: [3, 4],\n-┊261┊   ┊      },\n+┊   ┊179┊      }),\n ┊262┊180┊    ],\n-┊263┊   ┊  },\n-┊264┊   ┊  {\n-┊265┊   ┊    id: 5,\n-┊266┊   ┊    name: null,\n-┊267┊   ┊    picture: null,\n-┊268┊   ┊    allTimeMemberIds: [2, 5],\n-┊269┊   ┊    listingMemberIds: [2, 5],\n-┊270┊   ┊    adminIds: null,\n-┊271┊   ┊    ownerId: null,\n+┊   ┊181┊  }));\n+┊   ┊182┊\n+┊   ┊183┊  await connection.manager.save(new Chat({\n+┊   ┊184┊    allTimeMembers: [user2, user5],\n+┊   ┊185┊    listingMembers: [user2, user5],\n ┊272┊186┊    messages: [\n-┊273┊   ┊      {\n-┊274┊   ┊        id: 1,\n-┊275┊   ┊        chatId: 5,\n-┊276┊   ┊        senderId: 2,\n+┊   ┊187┊      new Message({\n+┊   ┊188┊        sender: user2,\n ┊277┊189┊        content: 'This is wicked good ice cream.',\n-┊278┊   ┊        createdAt: moment().subtract(2, 'weeks').unix(),\n+┊   ┊190┊        createdAt: moment().subtract(2, 'weeks').toDate(),\n ┊279┊191┊        type: MessageType.TEXT,\n+┊   ┊192┊        holders: [user2, user5],\n ┊280┊193┊        recipients: [\n-┊281┊   ┊          {\n-┊282┊   ┊            userId: 5,\n-┊283┊   ┊            messageId: 1,\n-┊284┊   ┊            chatId: 5,\n-┊285┊   ┊            receivedAt: null,\n-┊286┊   ┊            readAt: null,\n-┊287┊   ┊          },\n+┊   ┊194┊          new Recipient({\n+┊   ┊195┊            user: user5,\n+┊   ┊196┊          }),\n ┊288┊197┊        ],\n-┊289┊   ┊        holderIds: [2, 5],\n-┊290┊   ┊      },\n-┊291┊   ┊      {\n-┊292┊   ┊        id: 2,\n-┊293┊   ┊        chatId: 6,\n-┊294┊   ┊        senderId: 5,\n+┊   ┊198┊      }),\n+┊   ┊199┊      new Message({\n+┊   ┊200┊        sender: user5,\n ┊295┊201┊        content: 'Love it!',\n-┊296┊   ┊        createdAt: moment().subtract(2, 'weeks').add(10, 'minutes').unix(),\n+┊   ┊202┊        createdAt: moment().subtract(2, 'weeks').add(10, 'minutes').toDate(),\n ┊297┊203┊        type: MessageType.TEXT,\n+┊   ┊204┊        holders: [user2, user5],\n ┊298┊205┊        recipients: [\n-┊299┊   ┊          {\n-┊300┊   ┊            userId: 2,\n-┊301┊   ┊            messageId: 2,\n-┊302┊   ┊            chatId: 5,\n-┊303┊   ┊            receivedAt: null,\n-┊304┊   ┊            readAt: null,\n-┊305┊   ┊          },\n+┊   ┊206┊          new Recipient({\n+┊   ┊207┊            user: user2,\n+┊   ┊208┊          }),\n ┊306┊209┊        ],\n-┊307┊   ┊        holderIds: [5, 2],\n-┊308┊   ┊      },\n+┊   ┊210┊      }),\n ┊309┊211┊    ],\n-┊310┊   ┊  },\n-┊311┊   ┊  {\n-┊312┊   ┊    id: 6,\n-┊313┊   ┊    name: null,\n-┊314┊   ┊    picture: null,\n-┊315┊   ┊    allTimeMemberIds: [1, 6],\n-┊316┊   ┊    listingMemberIds: [1],\n-┊317┊   ┊    adminIds: null,\n-┊318┊   ┊    ownerId: null,\n-┊319┊   ┊    messages: [],\n-┊320┊   ┊  },\n-┊321┊   ┊  {\n-┊322┊   ┊    id: 7,\n-┊323┊   ┊    name: null,\n-┊324┊   ┊    picture: null,\n-┊325┊   ┊    allTimeMemberIds: [2, 1],\n-┊326┊   ┊    listingMemberIds: [2],\n-┊327┊   ┊    adminIds: null,\n-┊328┊   ┊    ownerId: null,\n-┊329┊   ┊    messages: [],\n-┊330┊   ┊  },\n-┊331┊   ┊  {\n-┊332┊   ┊    id: 8,\n-┊333┊   ┊    name: 'A user 0 group',\n+┊   ┊212┊  }));\n+┊   ┊213┊\n+┊   ┊214┊  await connection.manager.save(new Chat({\n+┊   ┊215┊    allTimeMembers: [user1, user6],\n+┊   ┊216┊    listingMembers: [user1],\n+┊   ┊217┊  }));\n+┊   ┊218┊\n+┊   ┊219┊  await connection.manager.save(new Chat({\n+┊   ┊220┊    allTimeMembers: [user2, user1],\n+┊   ┊221┊    listingMembers: [user2],\n+┊   ┊222┊  }));\n+┊   ┊223┊\n+┊   ┊224┊  await connection.manager.save(new Chat({\n+┊   ┊225┊    name: 'Ethan\\'s group',\n ┊334┊226┊    picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n-┊335┊   ┊    allTimeMemberIds: [1, 3, 4, 6],\n-┊336┊   ┊    listingMemberIds: [1, 3, 4, 6],\n-┊337┊   ┊    actualGroupMemberIds: [1, 4, 6],\n-┊338┊   ┊    adminIds: [1, 6],\n-┊339┊   ┊    ownerId: 1,\n+┊   ┊227┊    allTimeMembers: [user1, user3, user4, user6],\n+┊   ┊228┊    listingMembers: [user1, user3, user4, user6],\n+┊   ┊229┊    actualGroupMembers: [user1, user4, user6],\n+┊   ┊230┊    admins: [user1, user6],\n+┊   ┊231┊    owner: user1,\n ┊340┊232┊    messages: [\n-┊341┊   ┊      {\n-┊342┊   ┊        id: 1,\n-┊343┊   ┊        chatId: 8,\n-┊344┊   ┊        senderId: 1,\n+┊   ┊233┊      new Message({\n+┊   ┊234┊        sender: user1,\n ┊345┊235┊        content: 'I made a group',\n-┊346┊   ┊        createdAt: moment().subtract(2, 'weeks').unix(),\n+┊   ┊236┊        createdAt: moment().subtract(2, 'weeks').toDate(),\n ┊347┊237┊        type: MessageType.TEXT,\n+┊   ┊238┊        holders: [user1, user3, user4, user6],\n ┊348┊239┊        recipients: [\n-┊349┊   ┊          {\n-┊350┊   ┊            userId: 3,\n-┊351┊   ┊            messageId: 1,\n-┊352┊   ┊            chatId: 8,\n-┊353┊   ┊            receivedAt: null,\n-┊354┊   ┊            readAt: null,\n-┊355┊   ┊          },\n-┊356┊   ┊          {\n-┊357┊   ┊            userId: 4,\n-┊358┊   ┊            messageId: 1,\n-┊359┊   ┊            chatId: 8,\n-┊360┊   ┊            receivedAt: moment().subtract(2, 'weeks').add(1, 'minutes').unix(),\n-┊361┊   ┊            readAt: moment().subtract(2, 'weeks').add(5, 'minutes').unix(),\n-┊362┊   ┊          },\n-┊363┊   ┊          {\n-┊364┊   ┊            userId: 6,\n-┊365┊   ┊            messageId: 1,\n-┊366┊   ┊            chatId: 8,\n-┊367┊   ┊            receivedAt: null,\n-┊368┊   ┊            readAt: null,\n-┊369┊   ┊          },\n+┊   ┊240┊          new Recipient({\n+┊   ┊241┊            user: user3,\n+┊   ┊242┊          }),\n+┊   ┊243┊          new Recipient({\n+┊   ┊244┊            user: user4,\n+┊   ┊245┊          }),\n+┊   ┊246┊          new Recipient({\n+┊   ┊247┊            user: user6,\n+┊   ┊248┊          }),\n ┊370┊249┊        ],\n-┊371┊   ┊        holderIds: [1, 3, 4, 6],\n-┊372┊   ┊      },\n-┊373┊   ┊      {\n-┊374┊   ┊        id: 2,\n-┊375┊   ┊        chatId: 8,\n-┊376┊   ┊        senderId: 1,\n-┊377┊   ┊        content: 'Ops, user 3 was not supposed to be here',\n-┊378┊   ┊        createdAt: moment().subtract(2, 'weeks').add(2, 'minutes').unix(),\n+┊   ┊250┊      }),\n+┊   ┊251┊      new Message({\n+┊   ┊252┊        sender: user1,\n+┊   ┊253┊        content: 'Ops, Avery was not supposed to be here',\n+┊   ┊254┊        createdAt: moment().subtract(2, 'weeks').add(2, 'minutes').toDate(),\n ┊379┊255┊        type: MessageType.TEXT,\n+┊   ┊256┊        holders: [user1, user4, user6],\n ┊380┊257┊        recipients: [\n-┊381┊   ┊          {\n-┊382┊   ┊            userId: 4,\n-┊383┊   ┊            messageId: 2,\n-┊384┊   ┊            chatId: 8,\n-┊385┊   ┊            receivedAt: moment().subtract(2, 'weeks').add(3, 'minutes').unix(),\n-┊386┊   ┊            readAt: moment().subtract(2, 'weeks').add(5, 'minutes').unix(),\n-┊387┊   ┊          },\n-┊388┊   ┊          {\n-┊389┊   ┊            userId: 6,\n-┊390┊   ┊            messageId: 2,\n-┊391┊   ┊            chatId: 8,\n-┊392┊   ┊            receivedAt: null,\n-┊393┊   ┊            readAt: null,\n-┊394┊   ┊          },\n+┊   ┊258┊          new Recipient({\n+┊   ┊259┊            user: user4,\n+┊   ┊260┊          }),\n+┊   ┊261┊          new Recipient({\n+┊   ┊262┊            user: user6,\n+┊   ┊263┊          }),\n ┊395┊264┊        ],\n-┊396┊   ┊        holderIds: [1, 4, 6],\n-┊397┊   ┊      },\n-┊398┊   ┊      {\n-┊399┊   ┊        id: 3,\n-┊400┊   ┊        chatId: 8,\n-┊401┊   ┊        senderId: 4,\n+┊   ┊265┊      }),\n+┊   ┊266┊      new Message({\n+┊   ┊267┊        sender: user4,\n ┊402┊268┊        content: 'Awesome!',\n-┊403┊   ┊        createdAt: moment().subtract(2, 'weeks').add(10, 'minutes').unix(),\n+┊   ┊269┊        createdAt: moment().subtract(2, 'weeks').add(10, 'minutes').toDate(),\n ┊404┊270┊        type: MessageType.TEXT,\n+┊   ┊271┊        holders: [user1, user4, user6],\n ┊405┊272┊        recipients: [\n-┊406┊   ┊          {\n-┊407┊   ┊            userId: 1,\n-┊408┊   ┊            messageId: 3,\n-┊409┊   ┊            chatId: 8,\n-┊410┊   ┊            receivedAt: null,\n-┊411┊   ┊            readAt: null,\n-┊412┊   ┊          },\n-┊413┊   ┊          {\n-┊414┊   ┊            userId: 6,\n-┊415┊   ┊            messageId: 3,\n-┊416┊   ┊            chatId: 8,\n-┊417┊   ┊            receivedAt: null,\n-┊418┊   ┊            readAt: null,\n-┊419┊   ┊          },\n+┊   ┊273┊          new Recipient({\n+┊   ┊274┊            user: user1,\n+┊   ┊275┊          }),\n+┊   ┊276┊          new Recipient({\n+┊   ┊277┊            user: user6,\n+┊   ┊278┊          }),\n ┊420┊279┊        ],\n-┊421┊   ┊        holderIds: [1, 4, 6],\n-┊422┊   ┊      },\n+┊   ┊280┊      }),\n ┊423┊281┊    ],\n-┊424┊   ┊  },\n-┊425┊   ┊  {\n-┊426┊   ┊    id: 9,\n-┊427┊   ┊    name: 'A user 5 group',\n-┊428┊   ┊    picture: null,\n-┊429┊   ┊    allTimeMemberIds: [6, 3],\n-┊430┊   ┊    listingMemberIds: [6, 3],\n-┊431┊   ┊    actualGroupMemberIds: [6, 3],\n-┊432┊   ┊    adminIds: [6],\n-┊433┊   ┊    ownerId: 6,\n-┊434┊   ┊    messages: [],\n-┊435┊   ┊  },\n-┊436┊   ┊];\n+┊   ┊282┊  }));\n ┊437┊283┊\n-┊438┊   ┊export const db = {users, chats};\n+┊   ┊284┊  await connection.manager.save(new Chat({\n+┊   ┊285┊    name: 'Ray\\'s group',\n+┊   ┊286┊    allTimeMembers: [user3, user6],\n+┊   ┊287┊    listingMembers: [user3, user6],\n+┊   ┊288┊    actualGroupMembers: [user3, user6],\n+┊   ┊289┊    admins: [user6],\n+┊   ┊290┊    owner: user6,\n+┊   ┊291┊  }));\n+┊   ┊292┊}\n```\n\n[}]: #\n\nIt's time to deal with resolvers:\n\n[{]: <helper> (diffStep \"6.1\" files=\"schema/resolvers.ts\" module=\"server\")\n\n#### [Step 6.1: TypeORM with PostgreSQL](https://github.com/Urigo/whatsapp-textrepo-angularcli-express/commit/00c4cab)\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,91 +1,127 @@\n ┊  1┊  1┊import { PubSub, withFilter, IResolvers } from 'apollo-server-express';\n-┊  2┊   ┊import { Chat, db, Message, MessageType, Recipient, User } from \"../db\";\n+┊   ┊  2┊import { MessageType } from \"../db\";\n ┊  3┊  3┊import {\n ┊  4┊  4┊  AddChatMutationArgs, AddGroupMutationArgs, AddMessageMutationArgs, ChatQueryArgs, MessageAddedSubscriptionArgs,\n ┊  5┊  5┊  RemoveChatMutationArgs, RemoveMessagesMutationArgs\n ┊  6┊  6┊} from \"../types\";\n ┊  7┊  7┊import * as moment from \"moment\";\n-┊  8┊   ┊\n-┊  9┊   ┊let users = db.users;\n-┊ 10┊   ┊let chats = db.chats;\n+┊   ┊  8┊import { User } from \"../entity/User\";\n+┊   ┊  9┊import { Chat } from \"../entity/Chat\";\n+┊   ┊ 10┊import { Message } from \"../entity/Message\";\n+┊   ┊ 11┊import { Recipient } from \"../entity/Recipient\";\n+┊   ┊ 12┊import { Connection } from \"typeorm\";\n ┊ 11┊ 13┊\n ┊ 12┊ 14┊export const pubsub = new PubSub();\n ┊ 13┊ 15┊\n ┊ 14┊ 16┊export const resolvers: IResolvers = {\n ┊ 15┊ 17┊  Query: {\n ┊ 16┊ 18┊    // Show all users for the moment.\n-┊ 17┊   ┊    users: (obj: any, args: any, {user: currentUser}: {user: User}): User[] => users.filter(user => user.id !== currentUser.id),\n-┊ 18┊   ┊    chats: (obj: any, args: any, {user: currentUser}: {user: User}): Chat[] => chats.filter(chat => chat.listingMemberIds.includes(currentUser.id)),\n-┊ 19┊   ┊    chat: (obj: any, {chatId}: ChatQueryArgs): Chat | null => chats.find(chat => chat.id === Number(chatId)) || null,\n+┊   ┊ 19┊    users: async (obj: any, args: any, {user: currentUser, connection}: { user: User, connection: Connection }): Promise<User[]> => {\n+┊   ┊ 20┊      return await connection\n+┊   ┊ 21┊        .createQueryBuilder(User, \"user\")\n+┊   ┊ 22┊        .where('user.id != :id', {id: currentUser.id})\n+┊   ┊ 23┊        .getMany();\n+┊   ┊ 24┊    },\n+┊   ┊ 25┊    chats: async (obj: any, args: any, {user: currentUser, connection}: { user: User, connection: Connection }): Promise<any[]> => {\n+┊   ┊ 26┊      return await connection\n+┊   ┊ 27┊        .createQueryBuilder(Chat, \"chat\")\n+┊   ┊ 28┊        .leftJoin('chat.listingMembers', 'listingMembers')\n+┊   ┊ 29┊        .where('listingMembers.id = :id', {id: currentUser.id})\n+┊   ┊ 30┊        .getMany();\n+┊   ┊ 31┊    },\n+┊   ┊ 32┊    chat: async (obj: any, {chatId}: ChatQueryArgs, {connection}: { user: User, connection: Connection }): Promise<any> => {\n+┊   ┊ 33┊      return await connection\n+┊   ┊ 34┊        .createQueryBuilder(Chat, \"chat\")\n+┊   ┊ 35┊        .whereInIds(chatId)\n+┊   ┊ 36┊        .getOne();\n+┊   ┊ 37┊    },\n ┊ 20┊ 38┊  },\n ┊ 21┊ 39┊  Mutation: {\n-┊ 22┊   ┊    addChat: (obj: any, {recipientId}: AddChatMutationArgs, {user: currentUser}: {user: User}): Chat => {\n-┊ 23┊   ┊      if (!users.find(user => user.id === Number(recipientId))) {\n+┊   ┊ 40┊    addChat: async (obj: any, {recipientId}: AddChatMutationArgs, {user: currentUser, connection}: { user: User, connection: Connection }): Promise<Chat | null> => {\n+┊   ┊ 41┊      const recipient = await connection\n+┊   ┊ 42┊        .createQueryBuilder(User, \"user\")\n+┊   ┊ 43┊        .whereInIds(recipientId)\n+┊   ┊ 44┊        .getOne();\n+┊   ┊ 45┊\n+┊   ┊ 46┊      if (!recipient) {\n ┊ 24┊ 47┊        throw new Error(`Recipient ${recipientId} doesn't exist.`);\n ┊ 25┊ 48┊      }\n ┊ 26┊ 49┊\n-┊ 27┊   ┊      const chat = chats.find(chat => !chat.name && chat.allTimeMemberIds.includes(currentUser.id) && chat.allTimeMemberIds.includes(Number(recipientId)));\n+┊   ┊ 50┊      let chat = await connection\n+┊   ┊ 51┊        .createQueryBuilder(Chat, \"chat\")\n+┊   ┊ 52┊        .where('chat.name IS NULL')\n+┊   ┊ 53┊        .innerJoin('chat.allTimeMembers', 'allTimeMembers1', 'allTimeMembers1.id = :currentUserId', {currentUserId: currentUser.id})\n+┊   ┊ 54┊        .innerJoin('chat.allTimeMembers', 'allTimeMembers2', 'allTimeMembers2.id = :recipientId', {recipientId})\n+┊   ┊ 55┊        .innerJoinAndSelect('chat.listingMembers', 'listingMembers')\n+┊   ┊ 56┊        .getOne();\n+┊   ┊ 57┊\n ┊ 28┊ 58┊      if (chat) {\n-┊ 29┊   ┊        // Chat already exists. Both users are already in the allTimeMemberIds array\n-┊ 30┊   ┊        const chatId = chat.id;\n-┊ 31┊   ┊        if (!chat.listingMemberIds.includes(currentUser.id)) {\n+┊   ┊ 59┊        // Chat already exists. Both users are already in the userIds array\n+┊   ┊ 60┊        const listingMembers = await connection\n+┊   ┊ 61┊          .createQueryBuilder(User, \"user\")\n+┊   ┊ 62┊          .innerJoin('user.listingMemberChats', 'listingMemberChats', 'listingMemberChats.id = :chatId', {chatId: chat.id})\n+┊   ┊ 63┊          .getMany();\n+┊   ┊ 64┊\n+┊   ┊ 65┊        if (!listingMembers.find(user => user.id === currentUser.id)) {\n ┊ 32┊ 66┊          // The chat isn't listed for the current user. Add him to the memberIds\n-┊ 33┊   ┊          chat.listingMemberIds.push(currentUser.id);\n-┊ 34┊   ┊          chats.find(chat => chat.id === chatId)!.listingMemberIds.push(currentUser.id);\n-┊ 35┊   ┊          return chat;\n+┊   ┊ 67┊          chat.listingMembers.push(currentUser);\n+┊   ┊ 68┊          chat = await connection.getRepository(Chat).save(chat);\n+┊   ┊ 69┊\n+┊   ┊ 70┊          return chat || null;\n ┊ 36┊ 71┊        } else {\n ┊ 37┊ 72┊          throw new Error(`Chat already exists.`);\n ┊ 38┊ 73┊        }\n ┊ 39┊ 74┊      } else {\n ┊ 40┊ 75┊        // Create the chat\n-┊ 41┊   ┊        const id = (chats.length && chats[chats.length - 1].id + 1) || 1;\n-┊ 42┊   ┊        const chat: Chat = {\n-┊ 43┊   ┊          id,\n-┊ 44┊   ┊          name: null,\n-┊ 45┊   ┊          picture: null,\n-┊ 46┊   ┊          adminIds: null,\n-┊ 47┊   ┊          ownerId: null,\n-┊ 48┊   ┊          allTimeMemberIds: [currentUser.id, Number(recipientId)],\n+┊   ┊ 76┊        chat = await connection.getRepository(Chat).save(new Chat({\n+┊   ┊ 77┊          allTimeMembers: [currentUser, recipient],\n ┊ 49┊ 78┊          // Chat will not be listed to the other user until the first message gets written\n-┊ 50┊   ┊          listingMemberIds: [currentUser.id],\n-┊ 51┊   ┊          actualGroupMemberIds: null,\n-┊ 52┊   ┊          messages: [],\n-┊ 53┊   ┊        };\n-┊ 54┊   ┊        chats.push(chat);\n+┊   ┊ 79┊          listingMembers: [currentUser],\n+┊   ┊ 80┊        }));\n ┊ 55┊ 81┊\n-┊ 56┊   ┊        return chat;\n+┊   ┊ 82┊        return chat || null;\n ┊ 57┊ 83┊      }\n ┊ 58┊ 84┊    },\n-┊ 59┊   ┊    addGroup: (obj: any, {recipientIds, groupName}: AddGroupMutationArgs, {user: currentUser}: {user: User}): Chat => {\n-┊ 60┊   ┊      recipientIds.forEach(recipientId => {\n-┊ 61┊   ┊        if (!users.find(user => user.id === Number(recipientId))) {\n+┊   ┊ 85┊    addGroup: async (obj: any, {recipientIds, groupName}: AddGroupMutationArgs, {user: currentUser, connection}: { user: User, connection: Connection }): Promise<Chat | null> => {\n+┊   ┊ 86┊      let recipients: User[] = [];\n+┊   ┊ 87┊      for (let recipientId of recipientIds) {\n+┊   ┊ 88┊        const recipient = await connection\n+┊   ┊ 89┊          .createQueryBuilder(User, \"user\")\n+┊   ┊ 90┊          .whereInIds(recipientId)\n+┊   ┊ 91┊          .getOne();\n+┊   ┊ 92┊        if (!recipient) {\n ┊ 62┊ 93┊          throw new Error(`Recipient ${recipientId} doesn't exist.`);\n ┊ 63┊ 94┊        }\n-┊ 64┊   ┊      });\n+┊   ┊ 95┊        recipients.push(recipient);\n+┊   ┊ 96┊      }\n ┊ 65┊ 97┊\n-┊ 66┊   ┊      const id = (chats.length && chats[chats.length - 1].id + 1) || 1;\n-┊ 67┊   ┊      const chat: Chat = {\n-┊ 68┊   ┊        id,\n+┊   ┊ 98┊      const chat = await connection.getRepository(Chat).save(new Chat({\n ┊ 69┊ 99┊        name: groupName,\n-┊ 70┊   ┊        picture: null,\n-┊ 71┊   ┊        adminIds: [currentUser.id],\n-┊ 72┊   ┊        ownerId: currentUser.id,\n-┊ 73┊   ┊        allTimeMemberIds: [currentUser.id, ...recipientIds.map(id => Number(id))],\n-┊ 74┊   ┊        listingMemberIds: [currentUser.id, ...recipientIds.map(id => Number(id))],\n-┊ 75┊   ┊        actualGroupMemberIds: [currentUser.id, ...recipientIds.map(id => Number(id))],\n-┊ 76┊   ┊        messages: [],\n-┊ 77┊   ┊      };\n-┊ 78┊   ┊      chats.push(chat);\n+┊   ┊100┊        admins: [currentUser],\n+┊   ┊101┊        owner: currentUser,\n+┊   ┊102┊        allTimeMembers: [...recipients, currentUser],\n+┊   ┊103┊        listingMembers: [...recipients, currentUser],\n+┊   ┊104┊        actualGroupMembers: [...recipients, currentUser],\n+┊   ┊105┊      }));\n ┊ 79┊106┊\n ┊ 80┊107┊      pubsub.publish('chatAdded', {\n ┊ 81┊108┊        creatorId: currentUser.id,\n ┊ 82┊109┊        chatAdded: chat,\n ┊ 83┊110┊      });\n ┊ 84┊111┊\n-┊ 85┊   ┊      return chat;\n+┊   ┊112┊      return chat || null;\n ┊ 86┊113┊    },\n-┊ 87┊   ┊    removeChat: (obj: any, {chatId}: RemoveChatMutationArgs, {user: currentUser}: {user: User}): number => {\n-┊ 88┊   ┊      const chat = chats.find(chat => chat.id === Number(chatId));\n+┊   ┊114┊    removeChat: async (obj: any, {chatId}: RemoveChatMutationArgs, {user: currentUser, connection}: { user: User, connection: Connection }) => {\n+┊   ┊115┊      const chat = await connection\n+┊   ┊116┊        .createQueryBuilder(Chat, \"chat\")\n+┊   ┊117┊        .whereInIds(Number(chatId))\n+┊   ┊118┊        .innerJoinAndSelect('chat.listingMembers', 'listingMembers')\n+┊   ┊119┊        .leftJoinAndSelect('chat.actualGroupMembers', 'actualGroupMembers')\n+┊   ┊120┊        .leftJoinAndSelect('chat.admins', 'admins')\n+┊   ┊121┊        .leftJoinAndSelect('chat.owner', 'owner')\n+┊   ┊122┊        .leftJoinAndSelect('chat.messages', 'messages')\n+┊   ┊123┊        .leftJoinAndSelect('messages.holders', 'holders')\n+┊   ┊124┊        .getOne();\n ┊ 89┊125┊\n ┊ 90┊126┊      if (!chat) {\n ┊ 91┊127┊        throw new Error(`The chat ${chatId} doesn't exist.`);\n```\n```diff\n@@ -93,186 +129,188 @@\n ┊ 93┊129┊\n ┊ 94┊130┊      if (!chat.name) {\n ┊ 95┊131┊        // Chat\n-┊ 96┊   ┊        if (!chat.listingMemberIds.includes(currentUser.id)) {\n-┊ 97┊   ┊          throw new Error(`The user is not a member of the chat ${chatId}.`);\n+┊   ┊132┊        if (!chat.listingMembers.find(user => user.id === currentUser.id)) {\n+┊   ┊133┊          throw new Error(`The user is not a listing member of the chat ${chatId}.`);\n ┊ 98┊134┊        }\n ┊ 99┊135┊\n ┊100┊136┊        // Instead of chaining map and filter we can loop once using reduce\n-┊101┊   ┊        const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n-┊102┊   ┊          // Remove the current user from the message holders\n-┊103┊   ┊          message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser.id);\n+┊   ┊137┊        chat.messages = await chat.messages.reduce<Promise<Message[]>>(async (filtered$, message) => {\n+┊   ┊138┊          const filtered = await filtered$;\n ┊104┊139┊\n-┊105┊   ┊          if (message.holderIds.length !== 0) {\n+┊   ┊140┊          message.holders = message.holders.filter(user => user.id !== currentUser.id);\n+┊   ┊141┊\n+┊   ┊142┊          if (message.holders.length !== 0) {\n+┊   ┊143┊            // Remove the current user from the message holders\n+┊   ┊144┊            await connection.getRepository(Message).save(message);\n ┊106┊145┊            filtered.push(message);\n-┊107┊   ┊          } // else discard the message\n+┊   ┊146┊          } else {\n+┊   ┊147┊            // Simply remove the message\n+┊   ┊148┊            const recipients = await connection\n+┊   ┊149┊              .createQueryBuilder(Recipient, \"recipient\")\n+┊   ┊150┊              .innerJoinAndSelect('recipient.message', 'message', 'message.id = :messageId', {messageId: message.id})\n+┊   ┊151┊              .innerJoinAndSelect('recipient.user', 'user')\n+┊   ┊152┊              .getMany();\n+┊   ┊153┊            for (let recipient of recipients) {\n+┊   ┊154┊              await connection.getRepository(Recipient).remove(recipient);\n+┊   ┊155┊            }\n+┊   ┊156┊            await connection.getRepository(Message).remove(message);\n+┊   ┊157┊          }\n ┊108┊158┊\n ┊109┊159┊          return filtered;\n-┊110┊   ┊        }, []);\n+┊   ┊160┊        }, Promise.resolve([]));\n ┊111┊161┊\n ┊112┊162┊        // Remove the current user from who gets the chat listed. The chat will no longer appear in his list\n-┊113┊   ┊        const listingMemberIds = chat.listingMemberIds.filter(listingId => listingId !== currentUser.id);\n+┊   ┊163┊        chat.listingMembers = chat.listingMembers.filter(user => user.id !== currentUser.id);\n ┊114┊164┊\n ┊115┊165┊        // Check how many members are left\n-┊116┊   ┊        if (listingMemberIds.length === 0) {\n+┊   ┊166┊        if (chat.listingMembers.length === 0) {\n ┊117┊167┊          // Delete the chat\n-┊118┊   ┊          chats = chats.filter(chat => chat.id !== Number(chatId));\n+┊   ┊168┊          await connection.getRepository(Chat).remove(chat);\n ┊119┊169┊        } else {\n ┊120┊170┊          // Update the chat\n-┊121┊   ┊          chats = chats.map(chat => {\n-┊122┊   ┊            if (chat.id === Number(chatId)) {\n-┊123┊   ┊              chat = {...chat, listingMemberIds, messages};\n-┊124┊   ┊            }\n-┊125┊   ┊            return chat;\n-┊126┊   ┊          });\n+┊   ┊171┊          await connection.getRepository(Chat).save(chat);\n ┊127┊172┊        }\n-┊128┊   ┊        return Number(chatId);\n+┊   ┊173┊        return chatId;\n ┊129┊174┊      } else {\n ┊130┊175┊        // Group\n-┊131┊   ┊        if (chat.ownerId !== currentUser.id) {\n-┊132┊   ┊          throw new Error(`Group ${chatId} is not owned by the user.`);\n-┊133┊   ┊        }\n ┊134┊176┊\n ┊135┊177┊        // Instead of chaining map and filter we can loop once using reduce\n-┊136┊   ┊        const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n-┊137┊   ┊          // Remove the current user from the message holders\n-┊138┊   ┊          message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser.id);\n+┊   ┊178┊        chat.messages = await chat.messages.reduce<Promise<Message[]>>(async (filtered$, message) => {\n+┊   ┊179┊          const filtered = await filtered$;\n+┊   ┊180┊\n+┊   ┊181┊          message.holders = message.holders.filter(user => user.id !== currentUser.id);\n ┊139┊182┊\n-┊140┊   ┊          if (message.holderIds.length !== 0) {\n+┊   ┊183┊          if (message.holders.length !== 0) {\n+┊   ┊184┊            // Remove the current user from the message holders\n+┊   ┊185┊            await connection.getRepository(Message).save(message);\n ┊141┊186┊            filtered.push(message);\n-┊142┊   ┊          } // else discard the message\n+┊   ┊187┊          } else {\n+┊   ┊188┊            // Simply remove the message\n+┊   ┊189┊            const recipients = await connection\n+┊   ┊190┊              .createQueryBuilder(Recipient, \"recipient\")\n+┊   ┊191┊              .innerJoinAndSelect('recipient.message', 'message', 'message.id = :messageId', {messageId: message.id})\n+┊   ┊192┊              .innerJoinAndSelect('recipient.user', 'user')\n+┊   ┊193┊              .getMany();\n+┊   ┊194┊            for (let recipient of recipients) {\n+┊   ┊195┊              await connection.getRepository(Recipient).remove(recipient);\n+┊   ┊196┊            }\n+┊   ┊197┊            await connection.getRepository(Message).remove(message);\n+┊   ┊198┊          }\n ┊143┊199┊\n ┊144┊200┊          return filtered;\n-┊145┊   ┊        }, []);\n+┊   ┊201┊        }, Promise.resolve([]));\n ┊146┊202┊\n ┊147┊203┊        // Remove the current user from who gets the group listed. The group will no longer appear in his list\n-┊148┊   ┊        const listingMemberIds = chat.listingMemberIds.filter(listingId => listingId !== currentUser.id);\n+┊   ┊204┊        chat.listingMembers = chat.listingMembers.filter(user => user.id !== currentUser.id);\n ┊149┊205┊\n ┊150┊206┊        // Check how many members (including previous ones who can still access old messages) are left\n-┊151┊   ┊        if (listingMemberIds.length === 0) {\n+┊   ┊207┊        if (chat.listingMembers.length === 0) {\n ┊152┊208┊          // Remove the group\n-┊153┊   ┊          chats = chats.filter(chat => chat.id !== Number(chatId));\n+┊   ┊209┊          await connection.getRepository(Chat).remove(chat);\n ┊154┊210┊        } else {\n ┊155┊211┊          // Update the group\n ┊156┊212┊\n ┊157┊213┊          // Remove the current user from the chat members. He is no longer a member of the group\n-┊158┊   ┊          const actualGroupMemberIds = chat.actualGroupMemberIds!.filter(memberId => memberId !== currentUser.id);\n+┊   ┊214┊          chat.actualGroupMembers = chat.actualGroupMembers && chat.actualGroupMembers.filter(user => user.id !== currentUser.id);\n ┊159┊215┊          // Remove the current user from the chat admins\n-┊160┊   ┊          const adminIds = chat.adminIds!.filter(memberId => memberId !== currentUser.id);\n-┊161┊   ┊          // Set the owner id to be null. A null owner means the group is read-only\n-┊162┊   ┊          let ownerId: number | null = null;\n-┊163┊   ┊\n-┊164┊   ┊          // Check if there is any admin left\n-┊165┊   ┊          if (adminIds!.length) {\n-┊166┊   ┊            // Pick an admin as the new owner. The group is no longer read-only\n-┊167┊   ┊            ownerId = chat.adminIds![0];\n-┊168┊   ┊          }\n+┊   ┊216┊          chat.admins = chat.admins && chat.admins.filter(user => user.id !== currentUser.id);\n+┊   ┊217┊          // If there are no more admins left the group goes read only\n+┊   ┊218┊          chat.owner = chat.admins && chat.admins[0] || null; // A null owner means the group is read-only\n ┊169┊219┊\n-┊170┊   ┊          chats = chats.map(chat => {\n-┊171┊   ┊            if (chat.id === Number(chatId)) {\n-┊172┊   ┊              chat = {...chat, messages, listingMemberIds, actualGroupMemberIds, adminIds, ownerId};\n-┊173┊   ┊            }\n-┊174┊   ┊            return chat;\n-┊175┊   ┊          });\n+┊   ┊220┊          await connection.getRepository(Chat).save(chat);\n ┊176┊221┊        }\n-┊177┊   ┊        return Number(chatId);\n+┊   ┊222┊        return chatId;\n ┊178┊223┊      }\n ┊179┊224┊    },\n-┊180┊   ┊    addMessage: (obj: any, {chatId, content}: AddMessageMutationArgs, {user: currentUser}: {user: User}): Message => {\n+┊   ┊225┊    addMessage: async (obj: any, {chatId, content}: AddMessageMutationArgs, {user: currentUser, connection}: { user: User, connection: Connection }): Promise<Message | null> => {\n ┊181┊226┊      if (content === null || content === '') {\n ┊182┊227┊        throw new Error(`Cannot add empty or null messages.`);\n ┊183┊228┊      }\n ┊184┊229┊\n-┊185┊   ┊      let chat = chats.find(chat => chat.id === Number(chatId));\n+┊   ┊230┊      let chat = await connection\n+┊   ┊231┊        .createQueryBuilder(Chat, \"chat\")\n+┊   ┊232┊        .whereInIds(chatId)\n+┊   ┊233┊        .innerJoinAndSelect('chat.allTimeMembers', 'allTimeMembers')\n+┊   ┊234┊        .innerJoinAndSelect('chat.listingMembers', 'listingMembers')\n+┊   ┊235┊        .leftJoinAndSelect('chat.actualGroupMembers', 'actualGroupMembers')\n+┊   ┊236┊        .getOne();\n ┊186┊237┊\n ┊187┊238┊      if (!chat) {\n ┊188┊239┊        throw new Error(`Cannot find chat ${chatId}.`);\n ┊189┊240┊      }\n ┊190┊241┊\n-┊191┊   ┊      let holderIds = chat.listingMemberIds;\n+┊   ┊242┊      let holders: User[];\n ┊192┊243┊\n ┊193┊244┊      if (!chat.name) {\n ┊194┊245┊        // Chat\n-┊195┊   ┊        if (!chat.listingMemberIds.find(listingId => listingId === currentUser.id)) {\n+┊   ┊246┊        if (!chat.listingMembers.map(user => user.id).includes(currentUser.id)) {\n ┊196┊247┊          throw new Error(`The chat ${chatId} must be listed for the current user before adding a message.`);\n ┊197┊248┊        }\n ┊198┊249┊\n-┊199┊   ┊        const recipientId = chat.allTimeMemberIds.filter(userId => userId !== currentUser.id)[0];\n+┊   ┊250┊        const recipientUser = chat.allTimeMembers.find(user => user.id !== currentUser.id);\n ┊200┊251┊\n-┊201┊   ┊        if (!chat.listingMemberIds.find(listingId => listingId === recipientId)) {\n-┊202┊   ┊          // Chat is not listed for the recipient. Add him to the listingMemberIds\n-┊203┊   ┊          const listingMemberIds = chat.listingMemberIds.concat(recipientId);\n+┊   ┊252┊        if (!recipientUser) {\n+┊   ┊253┊          throw new Error(`Cannot find recipient user.`);\n+┊   ┊254┊        }\n ┊204┊255┊\n-┊205┊   ┊          chats = chats.map(chat => {\n-┊206┊   ┊            if (chat.id === Number(chatId)) {\n-┊207┊   ┊              chat = {...chat, listingMemberIds};\n-┊208┊   ┊            }\n-┊209┊   ┊            return chat;\n-┊210┊   ┊          });\n+┊   ┊256┊        if (!chat.listingMembers.find(user => user.id === recipientUser.id)) {\n+┊   ┊257┊          // Chat is not listed for the recipient. Add him to the listingIds\n+┊   ┊258┊          chat.listingMembers.push(recipientUser);\n ┊211┊259┊\n-┊212┊   ┊          holderIds = listingMemberIds;\n+┊   ┊260┊          await connection.getRepository(Chat).save(chat);\n ┊213┊261┊\n ┊214┊262┊          pubsub.publish('chatAdded', {\n ┊215┊263┊            creatorId: currentUser.id,\n ┊216┊264┊            chatAdded: chat,\n ┊217┊265┊          });\n ┊218┊266┊        }\n+┊   ┊267┊\n+┊   ┊268┊        holders = chat.listingMembers;\n ┊219┊269┊      } else {\n ┊220┊270┊        // Group\n-┊221┊   ┊        if (!chat.actualGroupMemberIds!.find(memberId => memberId === currentUser.id)) {\n+┊   ┊271┊        if (!chat.actualGroupMembers || !chat.actualGroupMembers.find(user => user.id === currentUser.id)) {\n ┊222┊272┊          throw new Error(`The user is not a member of the group ${chatId}. Cannot add message.`);\n ┊223┊273┊        }\n ┊224┊274┊\n-┊225┊   ┊        holderIds = chat.actualGroupMemberIds!;\n+┊   ┊275┊        holders = chat.actualGroupMembers;\n ┊226┊276┊      }\n ┊227┊277┊\n-┊228┊   ┊      const id = (chat.messages.length && chat.messages[chat.messages.length - 1].id + 1) || 1;\n-┊229┊   ┊\n-┊230┊   ┊      let recipients: Recipient[] = [];\n-┊231┊   ┊\n-┊232┊   ┊      holderIds.forEach(holderId => {\n-┊233┊   ┊        if (holderId !== currentUser.id) {\n-┊234┊   ┊          recipients.push({\n-┊235┊   ┊            userId: holderId,\n-┊236┊   ┊            messageId: id,\n-┊237┊   ┊            chatId: Number(chatId),\n-┊238┊   ┊            receivedAt: null,\n-┊239┊   ┊            readAt: null,\n-┊240┊   ┊          });\n-┊241┊   ┊        }\n-┊242┊   ┊      });\n-┊243┊   ┊\n-┊244┊   ┊      const message: Message = {\n-┊245┊   ┊        id,\n-┊246┊   ┊        chatId: Number(chatId),\n-┊247┊   ┊        senderId: currentUser.id,\n+┊   ┊278┊      const message = await connection.getRepository(Message).save(new Message({\n+┊   ┊279┊        chat: chat,\n+┊   ┊280┊        sender: currentUser,\n ┊248┊281┊        content,\n-┊249┊   ┊        createdAt: moment().unix(),\n ┊250┊282┊        type: MessageType.TEXT,\n-┊251┊   ┊        recipients,\n-┊252┊   ┊        holderIds,\n-┊253┊   ┊      };\n-┊254┊   ┊\n-┊255┊   ┊      chats = chats.map(chat => {\n-┊256┊   ┊        if (chat.id === Number(chatId)) {\n-┊257┊   ┊          chat = {...chat, messages: chat.messages.concat(message)}\n-┊258┊   ┊        }\n-┊259┊   ┊        return chat;\n-┊260┊   ┊      });\n+┊   ┊283┊        holders,\n+┊   ┊284┊        recipients: holders.reduce<Recipient[]>((filtered, user) => {\n+┊   ┊285┊          if (user.id !== currentUser.id) {\n+┊   ┊286┊            filtered.push(new Recipient({\n+┊   ┊287┊              user,\n+┊   ┊288┊            }));\n+┊   ┊289┊          }\n+┊   ┊290┊          return filtered;\n+┊   ┊291┊        }, []),\n+┊   ┊292┊      }));\n ┊261┊293┊\n ┊262┊294┊      pubsub.publish('messageAdded', {\n ┊263┊295┊        messageAdded: message,\n ┊264┊296┊      });\n ┊265┊297┊\n-┊266┊   ┊      return message;\n+┊   ┊298┊      return message || null;\n ┊267┊299┊    },\n-┊268┊   ┊    removeMessages: (obj: any, {chatId, messageIds, all}: RemoveMessagesMutationArgs, {user: currentUser}: {user: User}): number[] => {\n-┊269┊   ┊      const chat = chats.find(chat => chat.id === Number(chatId));\n+┊   ┊300┊    removeMessages: async (obj: any, {chatId, messageIds, all}: RemoveMessagesMutationArgs, {user: currentUser, connection}: { user: User, connection: Connection }) => {\n+┊   ┊301┊      const chat = await connection\n+┊   ┊302┊        .createQueryBuilder(Chat, \"chat\")\n+┊   ┊303┊        .whereInIds(chatId)\n+┊   ┊304┊        .innerJoinAndSelect('chat.listingMembers', 'listingMembers')\n+┊   ┊305┊        .innerJoinAndSelect('chat.messages', 'messages')\n+┊   ┊306┊        .innerJoinAndSelect('messages.holders', 'holders')\n+┊   ┊307┊        .getOne();\n ┊270┊308┊\n ┊271┊309┊      if (!chat) {\n ┊272┊310┊        throw new Error(`Cannot find chat ${chatId}.`);\n ┊273┊311┊      }\n ┊274┊312┊\n-┊275┊   ┊      if (!chat.listingMemberIds.find(listingId => listingId === currentUser.id)) {\n+┊   ┊313┊      if (!chat.listingMembers.find(user => user.id === currentUser.id)) {\n ┊276┊314┊        throw new Error(`The chat/group ${chatId} is not listed for the current user, so there is nothing to delete.`);\n ┊277┊315┊      }\n ┊278┊316┊\n```\n```diff\n@@ -280,79 +318,166 @@\n ┊280┊318┊        throw new Error(`Cannot specify both 'all' and 'messageIds'.`);\n ┊281┊319┊      }\n ┊282┊320┊\n+┊   ┊321┊      if (!all && !(messageIds && messageIds.length)) {\n+┊   ┊322┊        throw new Error(`'all' and 'messageIds' cannot be both null`);\n+┊   ┊323┊      }\n+┊   ┊324┊\n ┊283┊325┊      let deletedIds: number[] = [];\n-┊284┊   ┊      chats = chats.map(chat => {\n-┊285┊   ┊        if (chat.id === Number(chatId)) {\n-┊286┊   ┊          // Instead of chaining map and filter we can loop once using reduce\n-┊287┊   ┊          const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n-┊288┊   ┊            if (all || messageIds!.includes(String(message.id))) {\n-┊289┊   ┊              deletedIds.push(message.id);\n-┊290┊   ┊              // Remove the current user from the message holders\n-┊291┊   ┊              message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser.id);\n-┊292┊   ┊            }\n+┊   ┊326┊      // Instead of chaining map and filter we can loop once using reduce\n+┊   ┊327┊      chat.messages = await chat.messages.reduce<Promise<Message[]>>(async (filtered$, message) => {\n+┊   ┊328┊        const filtered = await filtered$;\n ┊293┊329┊\n-┊294┊   ┊            if (message.holderIds.length !== 0) {\n-┊295┊   ┊              filtered.push(message);\n-┊296┊   ┊            } // else discard the message\n+┊   ┊330┊        if (all || messageIds!.includes(String(message.id))) {\n+┊   ┊331┊          deletedIds.push(message.id);\n+┊   ┊332┊          // Remove the current user from the message holders\n+┊   ┊333┊          message.holders = message.holders.filter(user => user.id !== currentUser.id);\n ┊297┊334┊\n-┊298┊   ┊            return filtered;\n-┊299┊   ┊          }, []);\n-┊300┊   ┊          chat = {...chat, messages};\n ┊301┊335┊        }\n-┊302┊   ┊        return chat;\n-┊303┊   ┊      });\n+┊   ┊336┊\n+┊   ┊337┊        if (message.holders.length !== 0) {\n+┊   ┊338┊          // Remove the current user from the message holders\n+┊   ┊339┊          await connection.getRepository(Message).save(message);\n+┊   ┊340┊          filtered.push(message);\n+┊   ┊341┊        } else {\n+┊   ┊342┊          // Simply remove the message\n+┊   ┊343┊          const recipients = await connection\n+┊   ┊344┊            .createQueryBuilder(Recipient, \"recipient\")\n+┊   ┊345┊            .innerJoinAndSelect('recipient.message', 'message', 'message.id = :messageId', {messageId: message.id})\n+┊   ┊346┊            .innerJoinAndSelect('recipient.user', 'user')\n+┊   ┊347┊            .getMany();\n+┊   ┊348┊          for (let recipient of recipients) {\n+┊   ┊349┊            await connection.getRepository(Recipient).remove(recipient);\n+┊   ┊350┊          }\n+┊   ┊351┊          await connection.getRepository(Message).remove(message);\n+┊   ┊352┊        }\n+┊   ┊353┊\n+┊   ┊354┊        return filtered;\n+┊   ┊355┊      }, Promise.resolve([]));\n+┊   ┊356┊\n+┊   ┊357┊      await connection.getRepository(Chat).save(chat);\n+┊   ┊358┊\n ┊304┊359┊      return deletedIds;\n ┊305┊360┊    },\n ┊306┊361┊  },\n ┊307┊362┊  Subscription: {\n ┊308┊363┊    messageAdded: {\n ┊309┊364┊      subscribe: withFilter(() => pubsub.asyncIterator('messageAdded'),\n-┊310┊   ┊        ({messageAdded}: {messageAdded: Message & {chat: {id: number}}}, {chatId}: MessageAddedSubscriptionArgs, {user: currentUser}: { user: User }) => {\n+┊   ┊365┊        ({messageAdded}: {messageAdded: Message}, {chatId}: MessageAddedSubscriptionArgs, {user: currentUser}: { user: User }) => {\n ┊311┊366┊          return (!chatId || messageAdded.chat.id === Number(chatId)) &&\n-┊312┊   ┊            !!messageAdded.recipients.find((recipient: Recipient) => recipient.userId === currentUser.id);\n+┊   ┊367┊            !!messageAdded.recipients.find((recipient: Recipient) => recipient.user.id === currentUser.id);\n ┊313┊368┊        }),\n ┊314┊369┊    },\n ┊315┊370┊    chatAdded: {\n ┊316┊371┊      subscribe: withFilter(() => pubsub.asyncIterator('chatAdded'),\n-┊317┊   ┊        ({creatorId, chatAdded}: {creatorId: string, chatAdded: Chat}, variables: any, {user: currentUser}: { user: User }) => {\n-┊318┊   ┊          return Number(creatorId) !== currentUser.id && !chatAdded.listingMemberIds.includes(currentUser.id);\n+┊   ┊372┊        ({creatorId, chatAdded}: {creatorId: string, chatAdded: Chat}, variables, {user: currentUser}: { user: User }) => {\n+┊   ┊373┊          return Number(creatorId) !== currentUser.id &&\n+┊   ┊374┊            !!chatAdded.listingMembers.find((user: User) => user.id === currentUser.id);\n ┊319┊375┊        }),\n ┊320┊376┊    }\n ┊321┊377┊  },\n ┊322┊378┊  Chat: {\n-┊323┊   ┊    name: (chat: Chat, args: any, {user: currentUser}: {user: User}): string => chat.name ? chat.name : users\n-┊324┊   ┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser.id))!.name,\n-┊325┊   ┊    picture: (chat: Chat, args: any, {user: currentUser}: {user: User}) => chat.name ? chat.picture : users\n-┊326┊   ┊      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser.id))!.picture,\n-┊327┊   ┊    allTimeMembers: (chat: Chat): User[] => users.filter(user => chat.allTimeMemberIds.includes(user.id)),\n-┊328┊   ┊    listingMembers: (chat: Chat): User[] => users.filter(user => chat.listingMemberIds.includes(user.id)),\n-┊329┊   ┊    actualGroupMembers: (chat: Chat): User[] => users.filter(user => chat.actualGroupMemberIds && chat.actualGroupMemberIds.includes(user.id)),\n-┊330┊   ┊    admins: (chat: Chat): User[] => users.filter(user => chat.adminIds && chat.adminIds.includes(user.id)),\n-┊331┊   ┊    owner: (chat: Chat): User | null => users.find(user => chat.ownerId === user.id) || null,\n-┊332┊   ┊    messages: (chat: Chat, {amount = 0}: {amount: number}, {user: currentUser}: {user: User}): Message[] => {\n-┊333┊   ┊      const messages = chat.messages\n-┊334┊   ┊      .filter(message => message.holderIds.includes(currentUser.id))\n-┊335┊   ┊      .sort((a, b) => b.createdAt - a.createdAt) || <Message[]>[];\n-┊336┊   ┊      return (amount ? messages.slice(0, amount) : messages).reverse();\n+┊   ┊379┊    name: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<string | null> => {\n+┊   ┊380┊      if (chat.name) {\n+┊   ┊381┊        return chat.name;\n+┊   ┊382┊      }\n+┊   ┊383┊      const user = await connection\n+┊   ┊384┊        .createQueryBuilder(User, \"user\")\n+┊   ┊385┊        .where('user.id != :userId', {userId: currentUser.id})\n+┊   ┊386┊        .innerJoin('user.allTimeMemberChats', 'allTimeMemberChats', 'allTimeMemberChats.id = :chatId', {chatId: chat.id})\n+┊   ┊387┊        .getOne();\n+┊   ┊388┊      return user && user.name || null;\n+┊   ┊389┊    },\n+┊   ┊390┊    picture: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<string | null> => {\n+┊   ┊391┊      if (chat.name) {\n+┊   ┊392┊        return chat.picture;\n+┊   ┊393┊      }\n+┊   ┊394┊      const user = await connection\n+┊   ┊395┊        .createQueryBuilder(User, \"user\")\n+┊   ┊396┊        .where('user.id != :userId', {userId: currentUser.id})\n+┊   ┊397┊        .innerJoin('user.allTimeMemberChats', 'allTimeMemberChats', 'allTimeMemberChats.id = :chatId', {chatId: chat.id})\n+┊   ┊398┊        .getOne();\n+┊   ┊399┊      return user ? user.picture : null;\n+┊   ┊400┊    },\n+┊   ┊401┊    allTimeMembers: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User[]> => {\n+┊   ┊402┊      return await connection\n+┊   ┊403┊        .createQueryBuilder(User, \"user\")\n+┊   ┊404┊        .innerJoin('user.allTimeMemberChats', 'allTimeMemberChats', 'allTimeMemberChats.id = :chatId', {chatId: chat.id})\n+┊   ┊405┊        .getMany();\n+┊   ┊406┊    },\n+┊   ┊407┊    listingMembers: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User[]> => {\n+┊   ┊408┊      return await connection\n+┊   ┊409┊        .createQueryBuilder(User, \"user\")\n+┊   ┊410┊        .innerJoin('user.listingMemberChats', 'listingMemberChats', 'listingMemberChats.id = :chatId', {chatId: chat.id})\n+┊   ┊411┊        .getMany();\n+┊   ┊412┊    },\n+┊   ┊413┊    actualGroupMembers: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User[]> => {\n+┊   ┊414┊      return await connection\n+┊   ┊415┊        .createQueryBuilder(User, \"user\")\n+┊   ┊416┊        .innerJoin('user.actualGroupMemberChats', 'actualGroupMemberChats', 'actualGroupMemberChats.id = :chatId', {chatId: chat.id})\n+┊   ┊417┊        .getMany();\n+┊   ┊418┊    },\n+┊   ┊419┊    admins: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User[]> => {\n+┊   ┊420┊      return await connection\n+┊   ┊421┊        .createQueryBuilder(User, \"user\")\n+┊   ┊422┊        .innerJoin('user.adminChats', 'adminChats', 'adminChats.id = :chatId', {chatId: chat.id})\n+┊   ┊423┊        .getMany();\n ┊337┊424┊    },\n-┊338┊   ┊    unreadMessages: (chat: Chat, args: any, {user: currentUser}: {user: User}): number => chat.messages\n-┊339┊   ┊      .filter(message => message.holderIds.includes(currentUser.id) &&\n-┊340┊   ┊        message.recipients.find(recipient => recipient.userId === currentUser.id && !recipient.readAt))\n-┊341┊   ┊      .length,\n-┊342┊   ┊    isGroup: (chat: Chat): boolean => !!chat.name,\n+┊   ┊425┊    owner: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User | null> => {\n+┊   ┊426┊      return await connection\n+┊   ┊427┊        .createQueryBuilder(User, \"user\")\n+┊   ┊428┊        .innerJoin('user.ownerChats', 'ownerChats', 'ownerChats.id = :chatId', {chatId: chat.id})\n+┊   ┊429┊        .getOne() || null;\n+┊   ┊430┊    },\n+┊   ┊431┊    messages: async (chat: Chat, {amount = 0}: {amount: number}, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<Message[]> => {\n+┊   ┊432┊      const query = connection\n+┊   ┊433┊        .createQueryBuilder(Message, \"message\")\n+┊   ┊434┊        .innerJoin('message.chat', 'chat', 'chat.id = :chatId', {chatId: chat.id})\n+┊   ┊435┊        .innerJoin('message.holders', 'holders', 'holders.id = :userId', {userId: currentUser.id})\n+┊   ┊436┊        .orderBy({\"message.createdAt\": \"DESC\"});\n+┊   ┊437┊      return (amount ? await query.take(amount).getMany() : await query.getMany()).reverse();\n+┊   ┊438┊    },\n+┊   ┊439┊    unreadMessages: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<number> => {\n+┊   ┊440┊      return await connection\n+┊   ┊441┊        .createQueryBuilder(Message, \"message\")\n+┊   ┊442┊        .innerJoin('message.chat', 'chat', 'chat.id = :chatId', {chatId: chat.id})\n+┊   ┊443┊        .innerJoin('message.recipients', 'recipients', 'recipients.user.id = :userId AND recipients.readAt IS NULL', {userId: currentUser.id})\n+┊   ┊444┊        .getCount();\n+┊   ┊445┊    },\n+┊   ┊446┊    isGroup: (chat: Chat) => !!chat.name,\n ┊343┊447┊  },\n ┊344┊448┊  Message: {\n-┊345┊   ┊    chat: (message: Message): Chat | null => chats.find(chat => message.chatId === chat.id) || null,\n-┊346┊   ┊    sender: (message: Message): User | null => users.find(user => user.id === message.senderId) || null,\n-┊347┊   ┊    holders: (message: Message): User[] => users.filter(user => message.holderIds.includes(user.id)),\n-┊348┊   ┊    ownership: (message: Message, args: any, {user: currentUser}: {user: User}): boolean => message.senderId === currentUser.id,\n-┊349┊   ┊  },\n-┊350┊   ┊  Recipient: {\n-┊351┊   ┊    user: (recipient: Recipient): User | null => users.find(user => recipient.userId === user.id) || null,\n-┊352┊   ┊    message: (recipient: Recipient): Message | null => {\n-┊353┊   ┊      const chat = chats.find(chat => recipient.chatId === chat.id);\n-┊354┊   ┊      return chat ? chat.messages.find(message => recipient.messageId === message.id) || null : null;\n+┊   ┊449┊    sender: async (message: Message, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User | null> => {\n+┊   ┊450┊      return (await connection\n+┊   ┊451┊        .createQueryBuilder(User, \"user\")\n+┊   ┊452┊        .innerJoin('user.senderMessages', 'senderMessages', 'senderMessages.id = :messageId', {messageId: message.id})\n+┊   ┊453┊        .getOne()) || null;\n+┊   ┊454┊    },\n+┊   ┊455┊    ownership: async (message: Message, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<boolean> => {\n+┊   ┊456┊      return !!(await connection\n+┊   ┊457┊        .createQueryBuilder(User, \"user\")\n+┊   ┊458┊        .whereInIds(currentUser.id)\n+┊   ┊459┊        .innerJoin('user.senderMessages', 'senderMessages', 'senderMessages.id = :messageId', {messageId: message.id})\n+┊   ┊460┊        .getCount());\n+┊   ┊461┊    },\n+┊   ┊462┊    recipients: async (message: Message, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<Recipient[]> => {\n+┊   ┊463┊      return await connection\n+┊   ┊464┊        .createQueryBuilder(Recipient, \"recipient\")\n+┊   ┊465┊        .innerJoinAndSelect('recipient.message', 'message', 'message.id = :messageId', {messageId: message.id})\n+┊   ┊466┊        .innerJoinAndSelect('recipient.user', 'user')\n+┊   ┊467┊        .innerJoinAndSelect('recipient.chat', 'chat')\n+┊   ┊468┊        .getMany();\n+┊   ┊469┊    },\n+┊   ┊470┊    holders: async (message: Message, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User[]> => {\n+┊   ┊471┊      return await connection\n+┊   ┊472┊        .createQueryBuilder(User, \"user\")\n+┊   ┊473┊        .innerJoin('user.holderMessages', 'holderMessages', 'holderMessages.id = :messageId', {messageId: message.id})\n+┊   ┊474┊        .getMany();\n+┊   ┊475┊    },\n+┊   ┊476┊    chat: async (message: Message, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<Chat | null> => {\n+┊   ┊477┊      return (await connection\n+┊   ┊478┊        .createQueryBuilder(Chat, \"chat\")\n+┊   ┊479┊        .innerJoin('chat.messages', 'messages', 'messages.id = :messageId', {messageId: message.id})\n+┊   ┊480┊        .getOne()) || null;\n ┊355┊481┊    },\n-┊356┊   ┊    chat: (recipient: Recipient): Chat | null => chats.find(chat => recipient.chatId === chat.id) || null,\n ┊357┊482┊  },\n ┊358┊483┊};\n```\n\n[}]: #\n\n`QueryBuilder` is one of the most powerful features of `TypeORM` - it allows you to build SQL queries using elegant and convenient syntax, execute them and get automatically transformed entities.\n\nYou can find more informations on `TypeORM` on http://typeorm.io\n\nThe best part is that you won't have to do anything on the client, everything will be completely transparent to it, even if migrated from NoSQL-like db structure to a relational one!\nOf course, you could remove the custom normalization for the messages because now they have their own table and they are no longer embedded (so they have unique IDs), but we could leave it as well in order to be free to use any kind of backend."
          }
        ]
      }
    ]
  }
]
