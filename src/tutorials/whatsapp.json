[
  {
    "branchName": "master",
    "historyBranchName": "master-history",
    "releases": [
      {
        "releaseVersion": "0.1.0",
        "tagName": "master@0.1.0",
        "tagRevision": "7ba0e8849cd2d04bb4e83c9390b3ab49b776f208",
        "historyRevision": "58d6bc8ce303db28a3e4263a074cd55f1fa5a5ac",
        "manuals": [
          {
            "manualTitle": "A Whatsapp clone written with Angular, Material, Express, Postgresql and Apollo GraphQL.",
            "stepRevision": "9b9fab492371c442d4f2ca107de40084ff2a5fec",
            "manualView": "A newly created Tortilla project. For more information, see https://github.com/Urigo/tortilla."
          },
          {
            "manualTitle": "Step 1: Introduction",
            "stepRevision": "8139ec33f5caf452d2891ec3bedac94c830021d4",
            "manualView": "# Step 1: How to build an app?\n\nSo you want to build an app!\nThe good news is, itâ€™s not that difficult and after a while anyone can do it!\nAnother good news is that itâ€™s a great skill to have, there is a lot of demand in the job market and you can get to be very creative. Also you can be part of basically any industry you can think of if you know how to program (Healthcare, \nbanking, education, defense, gaming, etcâ€¦).\n\nSoftware builds as layers on top of layers.  Every code you write is using code that others have written before already and you can just use it even without fully understanding it.\nThatâ€™s what makes software advance so fast and makes the pace of progress increase as time goes by.\nAlso, most software today is written in an open and free way - everyone can share their code and use other people's code for free.  We even have a social network for that!  Itâ€™s called Github.\n\nOne way of learning how to build an app is to study software from the origins. How computers, operating systems and compilers work. It is very interesting but that also takes a long time.\nAnother way to learn how to create a new app is to start by first using all the code that has been already written out there and once we have a real world running app, go deeper to understand how it works from the inside.\n\nIâ€™ll try to use the later approach because I think it is more fun and also it gives context when we will dive inside on how things work. Also it helps when we try to compare between different technologies that do the same thing (Angular vs. \nReact , etcâ€¦).\nThatâ€™s because understanding the bigger picture is more important than knowing and remembering the details.\n\nYou noticed that the chapter started with a simple question.\nAll the lessons will start and include many of those questions.  Those are the questions you will need to Google.  The reason is that the most important skill a creator has today is to know how to search Google for the things they need. Most \nprogrammers, even the best ones, donâ€™t remember anything, they just use Google for almost every line of code they write. So know that you donâ€™t need to know it all, Google knows it all for you.\nThis tutorial might get outdated (it won't, hopefully!), but Google will always have the answers so it is more important to know to ask the right questions.\nIn my opinion the most important skill a programmer needs to have is patience and acceptance when something just doesnâ€™t work, enjoy that feeling and start Googling around in order to learn new things and solve this new problem (this process of \nfeeling like you donâ€™t know anything will happen 1000 times a day, also after 20 years of programming).\n\n## Planning the app: how to design an app?\n\nThe first and most important phase in the process is the beginning - designing the app, its parts, components and architecture, and how it all works together.\nFor this tutorial we will build a WhatsApp clone so we have the designs already prepared.\n\nThe process will looks like that:\n\n1. **Visually sketch the screens of the app**. We already know how WhatsApp looks so weâ€™ll just copy it on pen and paper.\n2. **Break down to components**. The best way to describe the UI of apps is to break the UI into separate components and mix them up together. When breaking down to components we would need to think about the following steps:\n  * **Presentational components**: the small building blocks of the UI. For example input fields, images, text, buttons etcâ€¦\n  * **Layout**: how the components are positioned inside each other (talk about flex, grid and older layout types)\n  * **Styles**: colors, fonts etcâ€¦ We might skip that part at the beginning because we can have a perfectly working app without it\n  * **Data dependencies**: the data that those components need - chats, messages, people etcâ€¦ We will need to to do the following:\n    * Gather data for each component\n    * Attach all those dependencies into one schema\n    * Attach actions for each component\n    * Data updates: decide when the data should be updated in the view (ideally we shouldnâ€™t have to say when but for technical and performance reasons it helps)\n3. **Routing flow**: Moving between screens, what are the different paths the user can navigate through our app\n\nOnce we will finish that process, you will have a big picture in your head (and on your paper) and implementing it with code will be much easier and more technical, meaning you wonâ€™t need to know a lot, just Google how to do each step...\n\nAnother interesting thing is, that implementing this same process can be done with a variety of different technologies, so this work will make sense whether you are using web with React or Angular, native apps, Windows UWP or any other \ntechnology for the UI and also relevant whether your data source is a Node, .NET or Ruby server with Mongo, Postgres or MySQL database (if all those words doesnâ€™t mean anything for you, donâ€™t worry, those are just different names to very similar \nideas and we will learn all of them later on and of course you can always just Google them).\n\nHead over to the next chapter to start planning."
          },
          {
            "manualTitle": "Step 2: Planning process",
            "stepRevision": "00c5a5a7b379ec19129dda1148b3fb2e6a42ff43",
            "manualView": "## Visual sketch\nWell, not a lot to say about that: just draw your app on paper.\nDoesnâ€™t matter if you donâ€™t know how to draw, itâ€™s just squares and circles.\n\n![alt text](../../assets/chats.png \"Chats\")\n![alt text](../../assets/chat.png \"Chat\")\n![alt text](../../assets/new_chat.png \"New chat\")\n![alt text](../../assets/new_group.png \"New group\")\n![alt text](../../assets/new_group_details.png \"New group details\")\n\n## Breaking down to components\n### -> Google Search\nThis part is a bit more tricky, but after a few examples youâ€™ll get the hang of it.\n\nDraw boxes around every component and subcomponent in different colors and name each one.\nBut how do you know what should be its own component?\nJust follow the **single responsibility principle**, that is, a component should ideally only do one thing. If it ends up growing, it should be decomposed into smaller subcomponents.\n\n![alt text](../../assets/chats_components.png \"Chats components\")\n![alt text](../../assets/chat_components.png \"Chat components\")\n![alt text](../../assets/new_chat_components.png \"New chat components\")\n![alt text](../../assets/new_group_components.png \"New group components\")\n![alt text](../../assets/new_group_details_components.png \"New group details components\")\n\n  * Chats Component\n  * Header Component\n  * ChatsList Component\n  * ChatItem Component\n  * Chat Component\n  * MessagesList Component\n  * MessageItem Component\n  * NewMessage Component\n  * NewChat Component\n  * UsersList Component\n  * UserItem Component\n  * NewGroup Component\n  * NewGroupDetails Component\n\nNow letâ€™s organize them in hierarchy:\n* Chats\n  * Header\n  * ChatsList\n    * ChatItem\n* Chat\n  * Header\n  * MessagesList\n    * MessageItem\n  * NewMessage\n* NewChat\n  * Header\n  * UsersList\n    * UserItem\n* NewGroup\n  * Header\n  * UsersList\n    * UserItem\n  * NewGroupDetails\n\n## Layout\n### -> Google Search\nNow letâ€™s describe how the components are placed within each other.\nThere are infinite ways to explain how components sits inside of each other.\nAny approach has its benefits and limitations.\nWe are going to use one pattern that is pretty common, simple and also covers many types of UI structures. \nUsing that pattern we will keep us covered for a long while (until you would want to create a computer game or a graph. then youâ€™ll need to expand your horizons).\nThis pattern is called flexbox.\n\nIn Flexbox we can separate the alignment in two ways:\nContainer (parent) component behaviour\nChild component behaviour inside the container\n\nWhen describing the parent, we have 3 main properties:\n* Flex-Flow: it's a shorthand for flex-direction and flex-wrap and lets you control the direction in which the items are displayed and whether or not they can wrap onto the next line. There are four possible settings, each of them in the wrap or \nnowrap variant:\n  * row `[wrap, nowrap]`\n  * row-reverse `[wrap, nowrap]`\n  * column `[wrap, nowrap]` - this is the normal way a group of divs would be displayed, so you might not use this often\n  * column-reverse `[wrap, nowrap]`\n* Justify-content: determines where a browser should place the flex items within the row. It works only if the flex items have set widths and if the total width of the items is less than the flex container. There are five possible settings:\n  * Flex-start - squash them to the left\n  * Center - Squash them to the center\n  * Flex-end - squash them to the right\n  * Space-around - squash them away from each other and the ends. Place as much space as possible between all elements\n  * Space-between - Squash the sides to the ends and place as much space between the rest of the elements as possible\n* alignItems: Same as justifyContent but on the secondary axis\n  * Flex-start - squash them to the left\n  * Center - Squash them to the center\n  * Flex-end - squash them to the right\n  * Space-around - squash them away from each other and the ends. Place as much space as possible between all elements\n  * Space-between - Squash the sides to the ends and place as much space between the rest of the elements as possible\n\nThe easiest way to explain that is by showing live examples:\n[awaiting for McFarland's permission to share his pictures]\n\n## Data dependencies\n### -> Google Search\nOur app needs to display data. Otherwise it will be just a nice moving set of picturesâ€¦\nSo letâ€™s see what data each component needs and create a descriptions of all the data in our app.\n\nLetâ€™s start with the chats list component:\n\n* Chats: Chats, Users, Messages\n  * Header\n  * ChatsList: Chats, Users, Messages\n    * ChatItem: Chats`[chatId]`, Users`[UserId]`, Message`[messageId]`\n\nWe need to have some basic information about the chats we are part of, like the chat id, the user id and the latest message content.\nThat means we will have to query for all the chats who we are part of, then look at the user IDs and query for those users to retrieve the name. Finally we need to query for the last message of each chat.\n\nNow letâ€™s talk about the chat component (after clicking the single chat app).\nWe need a list of all the messages inside the chat, along with some info about the user or chat on the top corner:\n\n* Chat: Chat, User, Messages\n  * Header: User.name || Chat.name (Because we can have multiple participant could differ from the other personâ€™s name)\n  * MessagesList: Messages\n    * MessageItem: Messages`[ID]`\n  * NewMessage\n\nThe NewChat and NewGroup components will need just some basic info about the user:\n\n* NewChat: Users\n  * Header\n  * UsersList: Users\n    * UserItem: Users`[ID]`\n\n* NewGroup: Users\n  * Header\n  * UsersList: Users\n    * UserItem: Users`[ID]`\n  * NewGroupDetails\n\n## Actions\n### -> Google Search\nBut components can also do thing beyond just displaying data. \nLetâ€™s write all the actions each component can do.\n  * Chats list\n    * tap -> go to chat page\n    * press -> enable selection of multiple chats, confirming the selection will delete them\n  * Single Chat\n    * tap -> send the message\n    * press -> enable selection of multiple messages, confirming the selection will delete them\n  * New Chat\n    * tap -> create new chat or go to the NewGroup component\n  * New Group\n    * tap -> go to NewGroupDetails, then create the group\n\n## Communications\n### -> Google Search\nLetâ€™s define when do we need to get the data from our data source.\nSounds easy but there are a few tricky pitfalls. (query and subscriptions).\nWe will start by simply requesting the data when we first start the component, later on we will tackle subscriptions.\n\n## UI flow\n### -> Google Search\nLetâ€™s draw a diagram of how the user can navigate our app.\n  * Open the app ->\n    * Chats list ->\n      * Click on chat ->\n        * Specific chat page\n          * Click back ->\n            * Chat page\n    * Click on '+' ->\n      * NewChat page ->\n        * Click on user ->\n          * Chat page\n        * Click back ->\n          * Chats list\n        * Click on 'New Group' ->\n          * New Group page\n            * Multiple selection and subsequent confirmation ->\n              * NewGroupDetails page\n                * Insert name and click on confirm ->\n                  * Chat page\n              * Click back ->\n                * New Group page\n          * Click back ->\n            * New Group page\n\nNow letâ€™s look at the whole diagram we created.\nThat basically describes all of our app.\nIf computers were smart enough to understand english and drawings, we would have an app by now.\nBut programming languages are very similar to regular languages so we now just need to translate this into any programming language, just choose a tool and start filling in the gaps.\n\nNext chapter will be about Scaffolding which will tell us the structure to put our code into.\nJust like our sketch has defined parts, we would do the same just with folders and files."
          },
          {
            "manualTitle": "Step 3: Scaffolding",
            "stepRevision": "6dcf8e47582242451ad0d49ecf66b053536bd9b3",
            "manualView": "Now we can start writing code!\n\nBut like we said before, software is build in layers and instead of starting from nothing, we can use existing software with prepared structure.\n\nFirst letâ€™s install some software that we need on our computer:\n\nThe following instructions are for computers with the Arch Linux operating system, so your mileage may vary.\n\nFirst let's start by installing npm and node.js, as simple as `# pacman -S nodejs npm`.\n\nThen we will need a way to install our npm global packages on a per-user basis, instead of relying on sudo: https://github.com/sindresorhus/guides/blob/master/npm-global-without-sudo.md\n\nNow it's the right moment to install a couple of global packages we will need later on: `npm install -g @angular/cli node-sass tortilla typescript`\n\n## IDE\n\nNow it's time to choose our IDE. I suggest you Webstorm, but it's paid software with a kind-of perpetual EAP (Early Access Preview) available for free: https://blog.jetbrains.com/webstorm/category/eap/\nIf you decide to start using Webstorm keep in mind that sooner or later you'll have to start paying an annual subscription because EAPs are not always available.\nTo have a look at some of the Webstorm features you can have a look at those videos: https://www.jetbrains.com/webstorm/documentation/\n\nAnother, completely free (as in freedom) alternative is VSCode: https://code.visualstudio.com/\nFor most things it's as good as Webstorm, for others (like type inference) it's even better. Unfortunately it lacks most of the Webstorm features.\n\nAt the end the choice is yours.\n\n## Mobile\nWe will talk once again about scaffolding once we will introduce `Android` and `Cordova`."
          },
          {
            "manualTitle": "Step 4: Debugging",
            "stepRevision": "5fa682ea020ac24ee194736e89fd659a5f75e5ed",
            "manualView": "Before we start writing code, it is important that we learn how to check our code.\n\nThe computer runs through everything we write in split second but we can still pause the computer and go through step by step, check what actually happens when the computer runs our code instructions.\n\nThis phase is sometimes being skipped by developers but trust me, you never want to skip this phase and you should always be super comfortable in debugging your code on whatever environment itâ€™s running on.\n\nThe easiest way to debug your Javascript application is right into your editor:\n  * https://www.jetbrains.com/help/webstorm/debugging-javascript-in-chrome.html\n  * https://blog.jetbrains.com/webstorm/2017/01/debugging-angular-apps/\n\nLater on we will learn how to debug mobile applications."
          },
          {
            "manualTitle": "Step 5: Chats listing",
            "stepRevision": "7f795290e06a49f2d2a6f8b3e11ca50fc5475721",
            "manualView": "## Server\n\nAfter the planning phase it's finally time to start writing some real code!\nWe'll start with the server, so let's install a couple of packages first:\n\n    $ npm install apollo-server-express body-parser cors express graphql graphql-tools\n    $ npm install --save-dev @types/body-parser @types/cors @types/express @types/graphql\n\nExpress is a fast, unopinionated, minimalist web framework for node.\nCross-Origin Resource Sharing (CORS) is a mechanism that uses additional HTTP headers to let a user agent gain permission to access selected resources from a server on a different origin (domain) than the site currently in use. A user agent makes a cross-origin HTTP request when it requests a resource from a different domain, protocol, or port than the one from which the current document originated.\nWe will need CORS because Webpack's development server used in the client will make use of a different port than the Express server, thus configuring a different origin.\nGraphQL is a query language for APIs and a runtime for fulfilling those queries with your existing data. GraphQL provides a complete and understandable description of the data in your API, gives clients the power to ask for exactly what they need and nothing more, makes it easier to evolve APIs over time, and enables powerful developer tools.\nApollo Server is a community-maintained open-source GraphQL server. It works with pretty much all Node.js HTTP server frameworks. Apollo Server works with any GraphQL schema built with GraphQL.js or with a convenience library such as graphql-tools.\n\nThe GraphQL query language is basically about selecting fields on objects. Because the shape of a GraphQL query closely matches the result, you can predict what the query will return without knowing that much about the server. But it's useful to have an exact description of the data we can ask for - what fields can we select? What kinds of objects might they return? What fields are available on those sub-objects? That's where the schema comes in.\nEvery GraphQL service defines a set of types which completely describe the set of possible data you can query on that service. Then, when queries come in, they are validated and executed against that schema.\n\nFor the moment let's create some empty schemas and resolvers:\n\n[{]: <helper> (diffStep \"1.1\" files=\"schema/*\" module=\"server\")\n\n#### Step 1.1: Create empty Apollo server\n\n##### Added schema&#x2F;index.ts\n```diff\n@@ -0,0 +1,10 @@\n+â”Š  â”Š 1â”Šimport { makeExecutableSchema } from 'graphql-tools';\n+â”Š  â”Š 2â”Šimport { typeDefs } from \"./typeDefs\";\n+â”Š  â”Š 3â”Šimport { resolvers } from \"./resolvers\";\n+â”Š  â”Š 4â”Šimport { IExecutableSchemaDefinition } from \"graphql-tools/dist/Interfaces\";\n+â”Š  â”Š 5â”Šimport { GraphQLSchema } from \"graphql\";\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Šexport const schema: GraphQLSchema = makeExecutableSchema(<IExecutableSchemaDefinition>{\n+â”Š  â”Š 8â”Š  typeDefs,\n+â”Š  â”Š 9â”Š  resolvers,\n+â”Š  â”Š10â”Š});ðŸš«â†µ\n```\n\n##### Added schema&#x2F;resolvers.ts\n```diff\n@@ -0,0 +1,6 @@\n+â”Š â”Š1â”Šimport { IResolvers } from \"graphql-tools/dist/Interfaces\";\n+â”Š â”Š2â”Š\n+â”Š â”Š3â”Šexport const resolvers: IResolvers = {\n+â”Š â”Š4â”Š  Query: {\n+â”Š â”Š5â”Š  },\n+â”Š â”Š6â”Š};\n```\n\n##### Added schema&#x2F;typeDefs.ts\n```diff\n@@ -0,0 +1,4 @@\n+â”Š â”Š1â”Šimport { ITypeDefinitions } from \"graphql-tools/dist/Interfaces\";\n+â”Š â”Š2â”Š\n+â”Š â”Š3â”Šexport const typeDefs: ITypeDefinitions = `\n+â”Š â”Š4â”Š`;\n```\n\n[}]: #\n\nTime to create our index:\n\n[{]: <helper> (diffStep \"1.1\" files=\"^index.ts\" module=\"server\")\n\n#### Step 1.1: Create empty Apollo server\n\n##### Added index.ts\n```diff\n@@ -0,0 +1,23 @@\n+â”Š  â”Š 1â”Šimport { schema } from \"./schema\";\n+â”Š  â”Š 2â”Šimport * as bodyParser from \"body-parser\";\n+â”Š  â”Š 3â”Šimport * as cors from 'cors';\n+â”Š  â”Š 4â”Šimport * as express from 'express';\n+â”Š  â”Š 5â”Šimport { graphiqlExpress, graphqlExpress } from \"apollo-server-express\";\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Šconst PORT = 3000;\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Šconst app = express();\n+â”Š  â”Š10â”Š\n+â”Š  â”Š11â”Šapp.use(cors());\n+â”Š  â”Š12â”Šapp.use(bodyParser.json());\n+â”Š  â”Š13â”Š\n+â”Š  â”Š14â”Šapp.use('/graphql', graphqlExpress(req => ({\n+â”Š  â”Š15â”Š  schema: schema,\n+â”Š  â”Š16â”Š  context: req,\n+â”Š  â”Š17â”Š})));\n+â”Š  â”Š18â”Š\n+â”Š  â”Š19â”Šapp.use('/graphiql', graphiqlExpress({\n+â”Š  â”Š20â”Š  endpointURL: '/graphql',\n+â”Š  â”Š21â”Š}));\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Šapp.listen(PORT);\n```\n\n[}]: #\n\nNow we want to feed our graphql server with some data. Soon we will need `moment`, so let's install it:\n\n    $ npm install moment\n\nNow we can create a fake db:\n\n[{]: <helper> (diffStep \"1.2\" files=\"db.ts\" module=\"server\")\n\n#### Step 1.2: Add fake db\n\n##### Added db.ts\n```diff\n@@ -0,0 +1,438 @@\n+â”Š   â”Š  1â”Šimport * as moment from 'moment';\n+â”Š   â”Š  2â”Š\n+â”Š   â”Š  3â”Šexport enum MessageType {\n+â”Š   â”Š  4â”Š  PICTURE,\n+â”Š   â”Š  5â”Š  TEXT,\n+â”Š   â”Š  6â”Š  LOCATION,\n+â”Š   â”Š  7â”Š}\n+â”Š   â”Š  8â”Š\n+â”Š   â”Š  9â”Šexport interface User {\n+â”Š   â”Š 10â”Š  id: number,\n+â”Š   â”Š 11â”Š  username: string,\n+â”Š   â”Š 12â”Š  password: string,\n+â”Š   â”Š 13â”Š  name: string,\n+â”Š   â”Š 14â”Š  picture?: string | null,\n+â”Š   â”Š 15â”Š  phone?: string | null,\n+â”Š   â”Š 16â”Š}\n+â”Š   â”Š 17â”Š\n+â”Š   â”Š 18â”Šexport interface Chat {\n+â”Š   â”Š 19â”Š  id: number,\n+â”Š   â”Š 20â”Š  name?: string | null,\n+â”Š   â”Š 21â”Š  picture?: string | null,\n+â”Š   â”Š 22â”Š  // All members, current and past ones.\n+â”Š   â”Š 23â”Š  allTimeMemberIds: number[],\n+â”Š   â”Š 24â”Š  // Whoever gets the chat listed. For groups includes past members who still didn't delete the group.\n+â”Š   â”Š 25â”Š  listingMemberIds: number[],\n+â”Š   â”Š 26â”Š  // Actual members of the group (they are not the only ones who get the group listed). Null for chats.\n+â”Š   â”Š 27â”Š  actualGroupMemberIds?: number[] | null,\n+â”Š   â”Š 28â”Š  adminIds?: number[] | null,\n+â”Š   â”Š 29â”Š  ownerId?: number | null,\n+â”Š   â”Š 30â”Š  messages: Message[],\n+â”Š   â”Š 31â”Š}\n+â”Š   â”Š 32â”Š\n+â”Š   â”Š 33â”Šexport interface Message {\n+â”Š   â”Š 34â”Š  id: number,\n+â”Š   â”Š 35â”Š  chatId: number,\n+â”Š   â”Š 36â”Š  senderId: number,\n+â”Š   â”Š 37â”Š  content: string,\n+â”Š   â”Š 38â”Š  createdAt: number,\n+â”Š   â”Š 39â”Š  type: MessageType,\n+â”Š   â”Š 40â”Š  recipients: Recipient[],\n+â”Š   â”Š 41â”Š  holderIds: number[],\n+â”Š   â”Š 42â”Š}\n+â”Š   â”Š 43â”Š\n+â”Š   â”Š 44â”Šexport interface Recipient {\n+â”Š   â”Š 45â”Š  userId: number,\n+â”Š   â”Š 46â”Š  messageId: number,\n+â”Š   â”Š 47â”Š  chatId: number,\n+â”Š   â”Š 48â”Š  receivedAt: number | null,\n+â”Š   â”Š 49â”Š  readAt: number | null,\n+â”Š   â”Š 50â”Š}\n+â”Š   â”Š 51â”Š\n+â”Š   â”Š 52â”Šconst users: User[] = [\n+â”Š   â”Š 53â”Š  {\n+â”Š   â”Š 54â”Š    id: 1,\n+â”Š   â”Š 55â”Š    username: 'ethan',\n+â”Š   â”Š 56â”Š    password: '$2a$08$NO9tkFLCoSqX1c5wk3s7z.JfxaVMKA.m7zUDdDwEquo4rvzimQeJm', // 111\n+â”Š   â”Š 57â”Š    name: 'Ethan Gonzalez',\n+â”Š   â”Š 58â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n+â”Š   â”Š 59â”Š    phone: '+391234567890',\n+â”Š   â”Š 60â”Š  },\n+â”Š   â”Š 61â”Š  {\n+â”Š   â”Š 62â”Š    id: 2,\n+â”Š   â”Š 63â”Š    username: 'bryan',\n+â”Š   â”Š 64â”Š    password: '$2a$08$xE4FuCi/ifxjL2S8CzKAmuKLwv18ktksSN.F3XYEnpmcKtpbpeZgO', // 222\n+â”Š   â”Š 65â”Š    name: 'Bryan Wallace',\n+â”Š   â”Š 66â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n+â”Š   â”Š 67â”Š    phone: '+391234567891',\n+â”Š   â”Š 68â”Š  },\n+â”Š   â”Š 69â”Š  {\n+â”Š   â”Š 70â”Š    id: 3,\n+â”Š   â”Š 71â”Š    username: 'avery',\n+â”Š   â”Š 72â”Š    password: '$2a$08$UHgH7J8G6z1mGQn2qx2kdeWv0jvgHItyAsL9hpEUI3KJmhVW5Q1d.', // 333\n+â”Š   â”Š 73â”Š    name: 'Avery Stewart',\n+â”Š   â”Š 74â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n+â”Š   â”Š 75â”Š    phone: '+391234567892',\n+â”Š   â”Š 76â”Š  },\n+â”Š   â”Š 77â”Š  {\n+â”Š   â”Š 78â”Š    id: 4,\n+â”Š   â”Š 79â”Š    username: 'katie',\n+â”Š   â”Š 80â”Š    password: '$2a$08$wR1k5Q3T9FC7fUgB7Gdb9Os/GV7dGBBf4PLlWT7HERMFhmFDt47xi', // 444\n+â”Š   â”Š 81â”Š    name: 'Katie Peterson',\n+â”Š   â”Š 82â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n+â”Š   â”Š 83â”Š    phone: '+391234567893',\n+â”Š   â”Š 84â”Š  },\n+â”Š   â”Š 85â”Š  {\n+â”Š   â”Š 86â”Š    id: 5,\n+â”Š   â”Š 87â”Š    username: 'ray',\n+â”Š   â”Š 88â”Š    password: '$2a$08$6.mbXqsDX82ZZ7q5d8Osb..JrGSsNp4R3IKj7mxgF6YGT0OmMw242', // 555\n+â”Š   â”Š 89â”Š    name: 'Ray Edwards',\n+â”Š   â”Š 90â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/3.jpg',\n+â”Š   â”Š 91â”Š    phone: '+391234567894',\n+â”Š   â”Š 92â”Š  },\n+â”Š   â”Š 93â”Š  {\n+â”Š   â”Š 94â”Š    id: 6,\n+â”Š   â”Š 95â”Š    username: 'niko',\n+â”Š   â”Š 96â”Š    password: '$2a$08$fL5lZR.Rwf9FWWe8XwwlceiPBBim8n9aFtaem.INQhiKT4.Ux3Uq.', // 666\n+â”Š   â”Š 97â”Š    name: 'NiccolÃ² Belli',\n+â”Š   â”Š 98â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/4.jpg',\n+â”Š   â”Š 99â”Š    phone: '+391234567895',\n+â”Š   â”Š100â”Š  },\n+â”Š   â”Š101â”Š  {\n+â”Š   â”Š102â”Š    id: 7,\n+â”Š   â”Š103â”Š    username: 'mario',\n+â”Š   â”Š104â”Š    password: '$2a$08$nDHDmWcVxDnH5DDT3HMMC.psqcnu6wBiOgkmJUy9IH..qxa3R6YrO', // 777\n+â”Š   â”Š105â”Š    name: 'Mario Rossi',\n+â”Š   â”Š106â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/5.jpg',\n+â”Š   â”Š107â”Š    phone: '+391234567896',\n+â”Š   â”Š108â”Š  },\n+â”Š   â”Š109â”Š];\n+â”Š   â”Š110â”Š\n+â”Š   â”Š111â”Šconst chats: Chat[] = [\n+â”Š   â”Š112â”Š  {\n+â”Š   â”Š113â”Š    id: 1,\n+â”Š   â”Š114â”Š    name: null,\n+â”Š   â”Š115â”Š    picture: null,\n+â”Š   â”Š116â”Š    allTimeMemberIds: [1, 3],\n+â”Š   â”Š117â”Š    listingMemberIds: [1, 3],\n+â”Š   â”Š118â”Š    adminIds: null,\n+â”Š   â”Š119â”Š    ownerId: null,\n+â”Š   â”Š120â”Š    messages: [\n+â”Š   â”Š121â”Š      {\n+â”Š   â”Š122â”Š        id: 1,\n+â”Š   â”Š123â”Š        chatId: 1,\n+â”Š   â”Š124â”Š        senderId: 1,\n+â”Š   â”Š125â”Š        content: 'You on your way?',\n+â”Š   â”Š126â”Š        createdAt: moment().subtract(1, 'hours').unix(),\n+â”Š   â”Š127â”Š        type: MessageType.TEXT,\n+â”Š   â”Š128â”Š        recipients: [\n+â”Š   â”Š129â”Š          {\n+â”Š   â”Š130â”Š            userId: 3,\n+â”Š   â”Š131â”Š            messageId: 1,\n+â”Š   â”Š132â”Š            chatId: 1,\n+â”Š   â”Š133â”Š            receivedAt: null,\n+â”Š   â”Š134â”Š            readAt: null,\n+â”Š   â”Š135â”Š          },\n+â”Š   â”Š136â”Š        ],\n+â”Š   â”Š137â”Š        holderIds: [1, 3],\n+â”Š   â”Š138â”Š      },\n+â”Š   â”Š139â”Š      {\n+â”Š   â”Š140â”Š        id: 2,\n+â”Š   â”Š141â”Š        chatId: 1,\n+â”Š   â”Š142â”Š        senderId: 3,\n+â”Š   â”Š143â”Š        content: 'Yep!',\n+â”Š   â”Š144â”Š        createdAt: moment().subtract(1, 'hours').add(5, 'minutes').unix(),\n+â”Š   â”Š145â”Š        type: MessageType.TEXT,\n+â”Š   â”Š146â”Š        recipients: [\n+â”Š   â”Š147â”Š          {\n+â”Š   â”Š148â”Š            userId: 1,\n+â”Š   â”Š149â”Š            messageId: 2,\n+â”Š   â”Š150â”Š            chatId: 1,\n+â”Š   â”Š151â”Š            receivedAt: null,\n+â”Š   â”Š152â”Š            readAt: null,\n+â”Š   â”Š153â”Š          },\n+â”Š   â”Š154â”Š        ],\n+â”Š   â”Š155â”Š        holderIds: [3, 1],\n+â”Š   â”Š156â”Š      },\n+â”Š   â”Š157â”Š    ],\n+â”Š   â”Š158â”Š  },\n+â”Š   â”Š159â”Š  {\n+â”Š   â”Š160â”Š    id: 2,\n+â”Š   â”Š161â”Š    name: null,\n+â”Š   â”Š162â”Š    picture: null,\n+â”Š   â”Š163â”Š    allTimeMemberIds: [1, 4],\n+â”Š   â”Š164â”Š    listingMemberIds: [1, 4],\n+â”Š   â”Š165â”Š    adminIds: null,\n+â”Š   â”Š166â”Š    ownerId: null,\n+â”Š   â”Š167â”Š    messages: [\n+â”Š   â”Š168â”Š      {\n+â”Š   â”Š169â”Š        id: 1,\n+â”Š   â”Š170â”Š        chatId: 2,\n+â”Š   â”Š171â”Š        senderId: 1,\n+â”Š   â”Š172â”Š        content: 'Hey, it\\'s me',\n+â”Š   â”Š173â”Š        createdAt: moment().subtract(2, 'hours').unix(),\n+â”Š   â”Š174â”Š        type: MessageType.TEXT,\n+â”Š   â”Š175â”Š        recipients: [\n+â”Š   â”Š176â”Š          {\n+â”Š   â”Š177â”Š            userId: 4,\n+â”Š   â”Š178â”Š            messageId: 1,\n+â”Š   â”Š179â”Š            chatId: 2,\n+â”Š   â”Š180â”Š            receivedAt: null,\n+â”Š   â”Š181â”Š            readAt: null,\n+â”Š   â”Š182â”Š          },\n+â”Š   â”Š183â”Š        ],\n+â”Š   â”Š184â”Š        holderIds: [1, 4],\n+â”Š   â”Š185â”Š      },\n+â”Š   â”Š186â”Š    ],\n+â”Š   â”Š187â”Š  },\n+â”Š   â”Š188â”Š  {\n+â”Š   â”Š189â”Š    id: 3,\n+â”Š   â”Š190â”Š    name: null,\n+â”Š   â”Š191â”Š    picture: null,\n+â”Š   â”Š192â”Š    allTimeMemberIds: [1, 5],\n+â”Š   â”Š193â”Š    listingMemberIds: [1, 5],\n+â”Š   â”Š194â”Š    adminIds: null,\n+â”Š   â”Š195â”Š    ownerId: null,\n+â”Š   â”Š196â”Š    messages: [\n+â”Š   â”Š197â”Š      {\n+â”Š   â”Š198â”Š        id: 1,\n+â”Š   â”Š199â”Š        chatId: 3,\n+â”Š   â”Š200â”Š        senderId: 1,\n+â”Š   â”Š201â”Š        content: 'I should buy a boat',\n+â”Š   â”Š202â”Š        createdAt: moment().subtract(1, 'days').unix(),\n+â”Š   â”Š203â”Š        type: MessageType.TEXT,\n+â”Š   â”Š204â”Š        recipients: [\n+â”Š   â”Š205â”Š          {\n+â”Š   â”Š206â”Š            userId: 5,\n+â”Š   â”Š207â”Š            messageId: 1,\n+â”Š   â”Š208â”Š            chatId: 3,\n+â”Š   â”Š209â”Š            receivedAt: null,\n+â”Š   â”Š210â”Š            readAt: null,\n+â”Š   â”Š211â”Š          },\n+â”Š   â”Š212â”Š        ],\n+â”Š   â”Š213â”Š        holderIds: [1, 5],\n+â”Š   â”Š214â”Š      },\n+â”Š   â”Š215â”Š      {\n+â”Š   â”Š216â”Š        id: 2,\n+â”Š   â”Š217â”Š        chatId: 3,\n+â”Š   â”Š218â”Š        senderId: 1,\n+â”Š   â”Š219â”Š        content: 'You still there?',\n+â”Š   â”Š220â”Š        createdAt: moment().subtract(1, 'days').add(16, 'hours').unix(),\n+â”Š   â”Š221â”Š        type: MessageType.TEXT,\n+â”Š   â”Š222â”Š        recipients: [\n+â”Š   â”Š223â”Š          {\n+â”Š   â”Š224â”Š            userId: 5,\n+â”Š   â”Š225â”Š            messageId: 2,\n+â”Š   â”Š226â”Š            chatId: 3,\n+â”Š   â”Š227â”Š            receivedAt: null,\n+â”Š   â”Š228â”Š            readAt: null,\n+â”Š   â”Š229â”Š          },\n+â”Š   â”Š230â”Š        ],\n+â”Š   â”Š231â”Š        holderIds: [1, 5],\n+â”Š   â”Š232â”Š      },\n+â”Š   â”Š233â”Š    ],\n+â”Š   â”Š234â”Š  },\n+â”Š   â”Š235â”Š  {\n+â”Š   â”Š236â”Š    id: 4,\n+â”Š   â”Š237â”Š    name: null,\n+â”Š   â”Š238â”Š    picture: null,\n+â”Š   â”Š239â”Š    allTimeMemberIds: [3, 4],\n+â”Š   â”Š240â”Š    listingMemberIds: [3, 4],\n+â”Š   â”Š241â”Š    adminIds: null,\n+â”Š   â”Š242â”Š    ownerId: null,\n+â”Š   â”Š243â”Š    messages: [\n+â”Š   â”Š244â”Š      {\n+â”Š   â”Š245â”Š        id: 1,\n+â”Š   â”Š246â”Š        chatId: 4,\n+â”Š   â”Š247â”Š        senderId: 3,\n+â”Š   â”Š248â”Š        content: 'Look at my mukluks!',\n+â”Š   â”Š249â”Š        createdAt: moment().subtract(4, 'days').unix(),\n+â”Š   â”Š250â”Š        type: MessageType.TEXT,\n+â”Š   â”Š251â”Š        recipients: [\n+â”Š   â”Š252â”Š          {\n+â”Š   â”Š253â”Š            userId: 4,\n+â”Š   â”Š254â”Š            messageId: 1,\n+â”Š   â”Š255â”Š            chatId: 4,\n+â”Š   â”Š256â”Š            receivedAt: null,\n+â”Š   â”Š257â”Š            readAt: null,\n+â”Š   â”Š258â”Š          },\n+â”Š   â”Š259â”Š        ],\n+â”Š   â”Š260â”Š        holderIds: [3, 4],\n+â”Š   â”Š261â”Š      },\n+â”Š   â”Š262â”Š    ],\n+â”Š   â”Š263â”Š  },\n+â”Š   â”Š264â”Š  {\n+â”Š   â”Š265â”Š    id: 5,\n+â”Š   â”Š266â”Š    name: null,\n+â”Š   â”Š267â”Š    picture: null,\n+â”Š   â”Š268â”Š    allTimeMemberIds: [2, 5],\n+â”Š   â”Š269â”Š    listingMemberIds: [2, 5],\n+â”Š   â”Š270â”Š    adminIds: null,\n+â”Š   â”Š271â”Š    ownerId: null,\n+â”Š   â”Š272â”Š    messages: [\n+â”Š   â”Š273â”Š      {\n+â”Š   â”Š274â”Š        id: 1,\n+â”Š   â”Š275â”Š        chatId: 5,\n+â”Š   â”Š276â”Š        senderId: 2,\n+â”Š   â”Š277â”Š        content: 'This is wicked good ice cream.',\n+â”Š   â”Š278â”Š        createdAt: moment().subtract(2, 'weeks').unix(),\n+â”Š   â”Š279â”Š        type: MessageType.TEXT,\n+â”Š   â”Š280â”Š        recipients: [\n+â”Š   â”Š281â”Š          {\n+â”Š   â”Š282â”Š            userId: 5,\n+â”Š   â”Š283â”Š            messageId: 1,\n+â”Š   â”Š284â”Š            chatId: 5,\n+â”Š   â”Š285â”Š            receivedAt: null,\n+â”Š   â”Š286â”Š            readAt: null,\n+â”Š   â”Š287â”Š          },\n+â”Š   â”Š288â”Š        ],\n+â”Š   â”Š289â”Š        holderIds: [2, 5],\n+â”Š   â”Š290â”Š      },\n+â”Š   â”Š291â”Š      {\n+â”Š   â”Š292â”Š        id: 2,\n+â”Š   â”Š293â”Š        chatId: 6,\n+â”Š   â”Š294â”Š        senderId: 5,\n+â”Š   â”Š295â”Š        content: 'Love it!',\n+â”Š   â”Š296â”Š        createdAt: moment().subtract(2, 'weeks').add(10, 'minutes').unix(),\n+â”Š   â”Š297â”Š        type: MessageType.TEXT,\n+â”Š   â”Š298â”Š        recipients: [\n+â”Š   â”Š299â”Š          {\n+â”Š   â”Š300â”Š            userId: 2,\n+â”Š   â”Š301â”Š            messageId: 2,\n+â”Š   â”Š302â”Š            chatId: 5,\n+â”Š   â”Š303â”Š            receivedAt: null,\n+â”Š   â”Š304â”Š            readAt: null,\n+â”Š   â”Š305â”Š          },\n+â”Š   â”Š306â”Š        ],\n+â”Š   â”Š307â”Š        holderIds: [5, 2],\n+â”Š   â”Š308â”Š      },\n+â”Š   â”Š309â”Š    ],\n+â”Š   â”Š310â”Š  },\n+â”Š   â”Š311â”Š  {\n+â”Š   â”Š312â”Š    id: 6,\n+â”Š   â”Š313â”Š    name: null,\n+â”Š   â”Š314â”Š    picture: null,\n+â”Š   â”Š315â”Š    allTimeMemberIds: [1, 6],\n+â”Š   â”Š316â”Š    listingMemberIds: [1],\n+â”Š   â”Š317â”Š    adminIds: null,\n+â”Š   â”Š318â”Š    ownerId: null,\n+â”Š   â”Š319â”Š    messages: [],\n+â”Š   â”Š320â”Š  },\n+â”Š   â”Š321â”Š  {\n+â”Š   â”Š322â”Š    id: 7,\n+â”Š   â”Š323â”Š    name: null,\n+â”Š   â”Š324â”Š    picture: null,\n+â”Š   â”Š325â”Š    allTimeMemberIds: [2, 1],\n+â”Š   â”Š326â”Š    listingMemberIds: [2],\n+â”Š   â”Š327â”Š    adminIds: null,\n+â”Š   â”Š328â”Š    ownerId: null,\n+â”Š   â”Š329â”Š    messages: [],\n+â”Š   â”Š330â”Š  },\n+â”Š   â”Š331â”Š  {\n+â”Š   â”Š332â”Š    id: 8,\n+â”Š   â”Š333â”Š    name: 'A user 0 group',\n+â”Š   â”Š334â”Š    picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n+â”Š   â”Š335â”Š    allTimeMemberIds: [1, 3, 4, 6],\n+â”Š   â”Š336â”Š    listingMemberIds: [1, 3, 4, 6],\n+â”Š   â”Š337â”Š    actualGroupMemberIds: [1, 4, 6],\n+â”Š   â”Š338â”Š    adminIds: [1, 6],\n+â”Š   â”Š339â”Š    ownerId: 1,\n+â”Š   â”Š340â”Š    messages: [\n+â”Š   â”Š341â”Š      {\n+â”Š   â”Š342â”Š        id: 1,\n+â”Š   â”Š343â”Š        chatId: 8,\n+â”Š   â”Š344â”Š        senderId: 1,\n+â”Š   â”Š345â”Š        content: 'I made a group',\n+â”Š   â”Š346â”Š        createdAt: moment().subtract(2, 'weeks').unix(),\n+â”Š   â”Š347â”Š        type: MessageType.TEXT,\n+â”Š   â”Š348â”Š        recipients: [\n+â”Š   â”Š349â”Š          {\n+â”Š   â”Š350â”Š            userId: 3,\n+â”Š   â”Š351â”Š            messageId: 1,\n+â”Š   â”Š352â”Š            chatId: 8,\n+â”Š   â”Š353â”Š            receivedAt: null,\n+â”Š   â”Š354â”Š            readAt: null,\n+â”Š   â”Š355â”Š          },\n+â”Š   â”Š356â”Š          {\n+â”Š   â”Š357â”Š            userId: 4,\n+â”Š   â”Š358â”Š            messageId: 1,\n+â”Š   â”Š359â”Š            chatId: 8,\n+â”Š   â”Š360â”Š            receivedAt: moment().subtract(2, 'weeks').add(1, 'minutes').unix(),\n+â”Š   â”Š361â”Š            readAt: moment().subtract(2, 'weeks').add(5, 'minutes').unix(),\n+â”Š   â”Š362â”Š          },\n+â”Š   â”Š363â”Š          {\n+â”Š   â”Š364â”Š            userId: 6,\n+â”Š   â”Š365â”Š            messageId: 1,\n+â”Š   â”Š366â”Š            chatId: 8,\n+â”Š   â”Š367â”Š            receivedAt: null,\n+â”Š   â”Š368â”Š            readAt: null,\n+â”Š   â”Š369â”Š          },\n+â”Š   â”Š370â”Š        ],\n+â”Š   â”Š371â”Š        holderIds: [1, 3, 4, 6],\n+â”Š   â”Š372â”Š      },\n+â”Š   â”Š373â”Š      {\n+â”Š   â”Š374â”Š        id: 2,\n+â”Š   â”Š375â”Š        chatId: 8,\n+â”Š   â”Š376â”Š        senderId: 1,\n+â”Š   â”Š377â”Š        content: 'Ops, user 3 was not supposed to be here',\n+â”Š   â”Š378â”Š        createdAt: moment().subtract(2, 'weeks').add(2, 'minutes').unix(),\n+â”Š   â”Š379â”Š        type: MessageType.TEXT,\n+â”Š   â”Š380â”Š        recipients: [\n+â”Š   â”Š381â”Š          {\n+â”Š   â”Š382â”Š            userId: 4,\n+â”Š   â”Š383â”Š            messageId: 2,\n+â”Š   â”Š384â”Š            chatId: 8,\n+â”Š   â”Š385â”Š            receivedAt: moment().subtract(2, 'weeks').add(3, 'minutes').unix(),\n+â”Š   â”Š386â”Š            readAt: moment().subtract(2, 'weeks').add(5, 'minutes').unix(),\n+â”Š   â”Š387â”Š          },\n+â”Š   â”Š388â”Š          {\n+â”Š   â”Š389â”Š            userId: 6,\n+â”Š   â”Š390â”Š            messageId: 2,\n+â”Š   â”Š391â”Š            chatId: 8,\n+â”Š   â”Š392â”Š            receivedAt: null,\n+â”Š   â”Š393â”Š            readAt: null,\n+â”Š   â”Š394â”Š          },\n+â”Š   â”Š395â”Š        ],\n+â”Š   â”Š396â”Š        holderIds: [1, 4, 6],\n+â”Š   â”Š397â”Š      },\n+â”Š   â”Š398â”Š      {\n+â”Š   â”Š399â”Š        id: 3,\n+â”Š   â”Š400â”Š        chatId: 8,\n+â”Š   â”Š401â”Š        senderId: 4,\n+â”Š   â”Š402â”Š        content: 'Awesome!',\n+â”Š   â”Š403â”Š        createdAt: moment().subtract(2, 'weeks').add(10, 'minutes').unix(),\n+â”Š   â”Š404â”Š        type: MessageType.TEXT,\n+â”Š   â”Š405â”Š        recipients: [\n+â”Š   â”Š406â”Š          {\n+â”Š   â”Š407â”Š            userId: 1,\n+â”Š   â”Š408â”Š            messageId: 3,\n+â”Š   â”Š409â”Š            chatId: 8,\n+â”Š   â”Š410â”Š            receivedAt: null,\n+â”Š   â”Š411â”Š            readAt: null,\n+â”Š   â”Š412â”Š          },\n+â”Š   â”Š413â”Š          {\n+â”Š   â”Š414â”Š            userId: 6,\n+â”Š   â”Š415â”Š            messageId: 3,\n+â”Š   â”Š416â”Š            chatId: 8,\n+â”Š   â”Š417â”Š            receivedAt: null,\n+â”Š   â”Š418â”Š            readAt: null,\n+â”Š   â”Š419â”Š          },\n+â”Š   â”Š420â”Š        ],\n+â”Š   â”Š421â”Š        holderIds: [1, 4, 6],\n+â”Š   â”Š422â”Š      },\n+â”Š   â”Š423â”Š    ],\n+â”Š   â”Š424â”Š  },\n+â”Š   â”Š425â”Š  {\n+â”Š   â”Š426â”Š    id: 9,\n+â”Š   â”Š427â”Š    name: 'A user 5 group',\n+â”Š   â”Š428â”Š    picture: null,\n+â”Š   â”Š429â”Š    allTimeMemberIds: [6, 3],\n+â”Š   â”Š430â”Š    listingMemberIds: [6, 3],\n+â”Š   â”Š431â”Š    actualGroupMemberIds: [6, 3],\n+â”Š   â”Š432â”Š    adminIds: [6],\n+â”Š   â”Š433â”Š    ownerId: 6,\n+â”Š   â”Š434â”Š    messages: [],\n+â”Š   â”Š435â”Š  },\n+â”Š   â”Š436â”Š];\n+â”Š   â”Š437â”Š\n+â”Š   â”Š438â”Šexport const db = {users, chats};\n```\n\n[}]: #\n\nIts' finally time to create our schema and our resolvers:\n\n[{]: <helper> (diffStep \"1.3\" module=\"server\")\n\n#### Step 1.3: Add resolvers and schema\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,6 +1,51 @@\n+â”Š  â”Š 1â”Šimport { Chat, db, Message, Recipient, User } from \"../db\";\n â”Š 1â”Š 2â”Šimport { IResolvers } from \"graphql-tools/dist/Interfaces\";\n â”Š 2â”Š 3â”Š\n+â”Š  â”Š 4â”Šlet users = db.users;\n+â”Š  â”Š 5â”Šlet chats = db.chats;\n+â”Š  â”Š 6â”Šconst currentUser = 1;\n+â”Š  â”Š 7â”Š\n â”Š 3â”Š 8â”Šexport const resolvers: IResolvers = {\n â”Š 4â”Š 9â”Š  Query: {\n+â”Š  â”Š10â”Š    // Show all users for the moment.\n+â”Š  â”Š11â”Š    users: (): User[] => users.filter(user => user.id !== currentUser),\n+â”Š  â”Š12â”Š    chats: (): Chat[] => chats.filter(chat => chat.listingMemberIds.includes(currentUser)),\n+â”Š  â”Š13â”Š    chat: (obj: any, {chatId}): Chat | null => chats.find(chat => chat.id === chatId) || null,\n+â”Š  â”Š14â”Š  },\n+â”Š  â”Š15â”Š  Chat: {\n+â”Š  â”Š16â”Š    name: (chat: Chat): string => chat.name ? chat.name : users\n+â”Š  â”Š17â”Š      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser))!.name,\n+â”Š  â”Š18â”Š    picture: (chat: Chat) => chat.name ? chat.picture : users\n+â”Š  â”Š19â”Š      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser))!.picture,\n+â”Š  â”Š20â”Š    allTimeMembers: (chat: Chat): User[] => users.filter(user => chat.allTimeMemberIds.includes(user.id)),\n+â”Š  â”Š21â”Š    listingMembers: (chat: Chat): User[] => users.filter(user => chat.listingMemberIds.includes(user.id)),\n+â”Š  â”Š22â”Š    actualGroupMembers: (chat: Chat): User[] => users.filter(user => chat.actualGroupMemberIds && chat.actualGroupMemberIds.includes(user.id)),\n+â”Š  â”Š23â”Š    admins: (chat: Chat): User[] => users.filter(user => chat.adminIds && chat.adminIds.includes(user.id)),\n+â”Š  â”Š24â”Š    owner: (chat: Chat): User | null => users.find(user => chat.ownerId === user.id) || null,\n+â”Š  â”Š25â”Š    messages: (chat: Chat, {amount = null}: {amount: number}): Message[] => {\n+â”Š  â”Š26â”Š      const messages = chat.messages\n+â”Š  â”Š27â”Š      .filter(message => message.holderIds.includes(currentUser))\n+â”Š  â”Š28â”Š      .sort((a, b) => b.createdAt - a.createdAt) || <Message[]>[];\n+â”Š  â”Š29â”Š      return (amount ? messages.slice(0, amount) : messages).reverse();\n+â”Š  â”Š30â”Š    },\n+â”Š  â”Š31â”Š    unreadMessages: (chat: Chat): number => chat.messages\n+â”Š  â”Š32â”Š      .filter(message => message.holderIds.includes(currentUser) &&\n+â”Š  â”Š33â”Š        message.recipients.find(recipient => recipient.userId === currentUser && !recipient.readAt))\n+â”Š  â”Š34â”Š      .length,\n+â”Š  â”Š35â”Š    isGroup: (chat: Chat): boolean => !!chat.name,\n+â”Š  â”Š36â”Š  },\n+â”Š  â”Š37â”Š  Message: {\n+â”Š  â”Š38â”Š    chat: (message: Message): Chat | null => chats.find(chat => message.chatId === chat.id) || null,\n+â”Š  â”Š39â”Š    sender: (message: Message): User | null => users.find(user => user.id === message.senderId) || null,\n+â”Š  â”Š40â”Š    holders: (message: Message): User[] => users.filter(user => message.holderIds.includes(user.id)),\n+â”Š  â”Š41â”Š    ownership: (message: Message): boolean => message.senderId === currentUser,\n+â”Š  â”Š42â”Š  },\n+â”Š  â”Š43â”Š  Recipient: {\n+â”Š  â”Š44â”Š    user: (recipient: Recipient): User | null => users.find(user => recipient.userId === user.id) || null,\n+â”Š  â”Š45â”Š    message: (recipient: Recipient): Message | null => {\n+â”Š  â”Š46â”Š      const chat = chats.find(chat => recipient.chatId === chat.id);\n+â”Š  â”Š47â”Š      return chat ? chat.messages.find(message => recipient.messageId === message.id) || null : null;\n+â”Š  â”Š48â”Š    },\n+â”Š  â”Š49â”Š    chat: (recipient: Recipient): Chat | null => chats.find(chat => recipient.chatId === chat.id) || null,\n â”Š 5â”Š50â”Š  },\n â”Š 6â”Š51â”Š};\n```\n\n##### Changed schema&#x2F;typeDefs.ts\n```diff\n@@ -1,4 +1,70 @@\n â”Š 1â”Š 1â”Šimport { ITypeDefinitions } from \"graphql-tools/dist/Interfaces\";\n â”Š 2â”Š 2â”Š\n â”Š 3â”Š 3â”Šexport const typeDefs: ITypeDefinitions = `\n+â”Š  â”Š 4â”Š  type Query {\n+â”Š  â”Š 5â”Š    users: [User!]\n+â”Š  â”Š 6â”Š    chats: [Chat!]\n+â”Š  â”Š 7â”Š    chat(chatId: ID!): Chat\n+â”Š  â”Š 8â”Š  }\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Š  enum MessageType {\n+â”Š  â”Š11â”Š    LOCATION\n+â”Š  â”Š12â”Š    TEXT\n+â”Š  â”Š13â”Š    PICTURE\n+â”Š  â”Š14â”Š  }\n+â”Š  â”Š15â”Š  \n+â”Š  â”Š16â”Š  type Chat {\n+â”Š  â”Š17â”Š    #May be a chat or a group\n+â”Š  â”Š18â”Š    id: ID!\n+â”Š  â”Š19â”Š    #Computed for chats\n+â”Š  â”Š20â”Š    name: String\n+â”Š  â”Š21â”Š    #Computed for chats\n+â”Š  â”Š22â”Š    picture: String\n+â”Š  â”Š23â”Š    #All members, current and past ones.\n+â”Š  â”Š24â”Š    allTimeMembers: [User!]!\n+â”Š  â”Š25â”Š    #Whoever gets the chat listed. For groups includes past members who still didn't delete the group.\n+â”Š  â”Š26â”Š    listingMembers: [User!]!\n+â”Š  â”Š27â”Š    #Actual members of the group (they are not the only ones who get the group listed). Null for chats.\n+â”Š  â”Š28â”Š    actualGroupMembers: [User!]!\n+â”Š  â”Š29â”Š    #Null for chats\n+â”Š  â”Š30â”Š    admins: [User!]\n+â”Š  â”Š31â”Š    #If null the group is read-only. Null for chats.\n+â”Š  â”Š32â”Š    owner: User\n+â”Š  â”Š33â”Š    messages(amount: Int): [Message]!\n+â”Š  â”Š34â”Š    #Computed property\n+â”Š  â”Š35â”Š    unreadMessages: Int!\n+â”Š  â”Š36â”Š    #Computed property\n+â”Š  â”Š37â”Š    isGroup: Boolean!\n+â”Š  â”Š38â”Š  }\n+â”Š  â”Š39â”Š\n+â”Š  â”Š40â”Š  type Message {\n+â”Š  â”Š41â”Š    id: ID!\n+â”Š  â”Š42â”Š    sender: User!\n+â”Š  â”Š43â”Š    chat: Chat!\n+â”Š  â”Š44â”Š    content: String!\n+â”Š  â”Š45â”Š    createdAt: String!\n+â”Š  â”Š46â”Š    #FIXME: should return MessageType\n+â”Š  â”Š47â”Š    type: Int!\n+â”Š  â”Š48â”Š    #Whoever received the message\n+â”Š  â”Š49â”Š    recipients: [Recipient!]!\n+â”Š  â”Š50â”Š    #Whoever still holds a copy of the message. Cannot be null because the message gets deleted otherwise\n+â”Š  â”Š51â”Š    holders: [User!]!\n+â”Š  â”Š52â”Š    #Computed property\n+â”Š  â”Š53â”Š    ownership: Boolean!\n+â”Š  â”Š54â”Š  }\n+â”Š  â”Š55â”Š  \n+â”Š  â”Š56â”Š  type Recipient {\n+â”Š  â”Š57â”Š    user: User!\n+â”Š  â”Š58â”Š    message: Message!\n+â”Š  â”Š59â”Š    chat: Chat!\n+â”Š  â”Š60â”Š    receivedAt: String\n+â”Š  â”Š61â”Š    readAt: String\n+â”Š  â”Š62â”Š  }\n+â”Š  â”Š63â”Š\n+â”Š  â”Š64â”Š  type User {\n+â”Š  â”Š65â”Š    id: ID!\n+â”Š  â”Š66â”Š    name: String\n+â”Š  â”Š67â”Š    picture: String\n+â”Š  â”Š68â”Š    phone: String\n+â”Š  â”Š69â”Š  }\n â”Š 4â”Š70â”Š`;\n```\n\n[}]: #\n\nOut basic server is already done and working. We still have no way to do any kind of mutation, but we already set up several queries to return a list of users or chats.\nIn particular we can choose if we want to return all the chats (and how many messages we want to return for each chat) or if we want to return a single chat. We can also choose which and how many properties we want to return for each query.\nWe can start the server by simply running:\n\n    $ npm start\n\n## Client\n\nNow we can concentrate on the client and bootstrap it using angular-cli.\nFirst you will need to install angular-cli globally with:\n\n    $ npm install -g @angular/cli\n\nThen we can create a new project from scratch:\n\n    $ ng new client --style scss\n\nTime to install a couple of packages:\n\n    $ npm install apollo-angular apollo-angular-link-http apollo-cache-inmemory apollo-client apollo-link graphql graphql-tag\n    $ npm install --save-dev @types/graphql\n\nWe will also need to add `esnext.asynciterable` to the libs:\n\n[{]: <helper> (diffStep \"1.1\" files=\"tsconfig.json\" module=\"client\")\n\n#### Step 1.1: Add angular-apollo to app module\n\n##### Changed tsconfig.json\n```diff\n@@ -7,13 +7,15 @@\n â”Š 7â”Š 7â”Š    \"moduleResolution\": \"node\",\n â”Š 8â”Š 8â”Š    \"emitDecoratorMetadata\": true,\n â”Š 9â”Š 9â”Š    \"experimentalDecorators\": true,\n+â”Š  â”Š10â”Š    \"downlevelIteration\": true,\n â”Š10â”Š11â”Š    \"target\": \"es5\",\n â”Š11â”Š12â”Š    \"typeRoots\": [\n â”Š12â”Š13â”Š      \"node_modules/@types\"\n â”Š13â”Š14â”Š    ],\n â”Š14â”Š15â”Š    \"lib\": [\n â”Š15â”Š16â”Š      \"es2017\",\n-â”Š16â”Š  â”Š      \"dom\"\n+â”Š  â”Š17â”Š      \"dom\",\n+â”Š  â”Š18â”Š      \"esnext.asynciterable\"\n â”Š17â”Š19â”Š    ]\n â”Š18â”Š20â”Š  }\n â”Š19â”Š21â”Š}\n```\n\n[}]: #\n\nWe also added the `downlevelIteration` option which is required to make sure that everything will be transpiled to ES5.\n\nTo get started using Apollo with Angular, we need to import two NgModules, `ApolloModule` and `HttpLinkModule`.\n\n- `ApolloModule` is the center of using GraphQL in your app! It includes all needed services that allows to use ApolloClientâ€™s features.\n- `HttpLinkModule` makes it easy to fetch data in Angular.\n\n`HttpLinkModule` is optional, you can replace it with any other Link.\nIts biggest advantage of all is that it uses `HttpClient` internally so itâ€™s possible to use it in `NativeScript` or in combination with any other `HttpClient` provider. By using `HttpLinkModule` you get Server-Side Rendering for free, without any additional work.\n\nTo get started, inject `Apollo` and `HttpLink` services and then create a client:\n\n[{]: <helper> (diffStep \"1.1\" files=\"app.module.ts\" module=\"client\")\n\n#### Step 1.1: Add angular-apollo to app module\n\n##### Changed src&#x2F;app&#x2F;app.module.ts\n```diff\n@@ -3,6 +3,10 @@\n â”Š 3â”Š 3â”Š\n â”Š 4â”Š 4â”Š\n â”Š 5â”Š 5â”Šimport { AppComponent } from './app.component';\n+â”Š  â”Š 6â”Šimport {HttpClientModule} from '@angular/common/http';\n+â”Š  â”Š 7â”Šimport {HttpLink, HttpLinkModule, Options} from 'apollo-angular-link-http';\n+â”Š  â”Š 8â”Šimport {Apollo, ApolloModule} from 'apollo-angular';\n+â”Š  â”Š 9â”Šimport {InMemoryCache} from 'apollo-cache-inmemory';\n â”Š 6â”Š10â”Š\n â”Š 7â”Š11â”Š\n â”Š 8â”Š12â”Š@NgModule({\n```\n```diff\n@@ -10,9 +14,23 @@\n â”Š10â”Š14â”Š    AppComponent\n â”Š11â”Š15â”Š  ],\n â”Š12â”Š16â”Š  imports: [\n-â”Š13â”Š  â”Š    BrowserModule\n+â”Š  â”Š17â”Š    BrowserModule,\n+â”Š  â”Š18â”Š    // Apollo\n+â”Š  â”Š19â”Š    ApolloModule,\n+â”Š  â”Š20â”Š    HttpLinkModule,\n+â”Š  â”Š21â”Š    HttpClientModule,\n â”Š14â”Š22â”Š  ],\n â”Š15â”Š23â”Š  providers: [],\n â”Š16â”Š24â”Š  bootstrap: [AppComponent]\n â”Š17â”Š25â”Š})\n-â”Š18â”Š  â”Šexport class AppModule { }\n+â”Š  â”Š26â”Šexport class AppModule {\n+â”Š  â”Š27â”Š  constructor(\n+â”Š  â”Š28â”Š    apollo: Apollo,\n+â”Š  â”Š29â”Š    httpLink: HttpLink,\n+â”Š  â”Š30â”Š  ) {\n+â”Š  â”Š31â”Š    apollo.create({\n+â”Š  â”Š32â”Š      link: httpLink.create(<Options>{uri: 'http://localhost:3000/graphql'}),\n+â”Š  â”Š33â”Š      cache: new InMemoryCache(),\n+â”Š  â”Š34â”Š    });\n+â”Š  â”Š35â”Š  }\n+â”Š  â”Š36â”Š}\n```\n\n[}]: #\n\nWe're using the `InMemory` cache, but there are several options like `Redux`, `Hermes`, `ngrx`...\n\nThe `gql` template tag is what you use to define GraphQL queries in your Apollo apps. It parses your GraphQL query into the `GraphQL.js AST format` which may then be consumed by Apollo methods. Whenever Apollo is asking for a GraphQL query you will always want to wrap it in a `gql` template tag.\n\nYou can embed a GraphQL document containing only fragments inside of another GraphQL document using template string interpolation. This allows you to use fragments defined in one part of your codebase inside of a query defined in a completely different file.\n\n[{]: <helper> (diffStep \"1.2\" files=\"src/graphql\" module=\"client\")\n\n#### Step 1.2: Add chats service\n\n##### Added src&#x2F;graphql&#x2F;fragment.ts\n```diff\n@@ -0,0 +1,51 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag';\n+â”Š  â”Š 2â”Šimport {DocumentNode} from 'graphql';\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šexport const fragments: {\n+â”Š  â”Š 5â”Š  [key: string]: DocumentNode\n+â”Š  â”Š 6â”Š} = {\n+â”Š  â”Š 7â”Š  chatWithoutMessages: gql`\n+â”Š  â”Š 8â”Š    fragment ChatWithoutMessages on Chat {\n+â”Š  â”Š 9â”Š      id\n+â”Š  â”Š10â”Š      name\n+â”Š  â”Š11â”Š      picture\n+â”Š  â”Š12â”Š      allTimeMembers {\n+â”Š  â”Š13â”Š        id\n+â”Š  â”Š14â”Š      }\n+â”Š  â”Š15â”Š      unreadMessages\n+â”Š  â”Š16â”Š      isGroup\n+â”Š  â”Š17â”Š    }\n+â”Š  â”Š18â”Š  `,\n+â”Š  â”Š19â”Š  message: gql`\n+â”Š  â”Š20â”Š    fragment Message on Message {\n+â”Š  â”Š21â”Š      id\n+â”Š  â”Š22â”Š      chat {\n+â”Š  â”Š23â”Š        id\n+â”Š  â”Š24â”Š      }\n+â”Š  â”Š25â”Š      sender {\n+â”Š  â”Š26â”Š        id\n+â”Š  â”Š27â”Š        name\n+â”Š  â”Š28â”Š      }\n+â”Š  â”Š29â”Š      content\n+â”Š  â”Š30â”Š      createdAt\n+â”Š  â”Š31â”Š      type\n+â”Š  â”Š32â”Š      recipients {\n+â”Š  â”Š33â”Š        user {\n+â”Š  â”Š34â”Š          id\n+â”Š  â”Š35â”Š        }\n+â”Š  â”Š36â”Š        message {\n+â”Š  â”Š37â”Š          id\n+â”Š  â”Š38â”Š          chat {\n+â”Š  â”Š39â”Š            id\n+â”Š  â”Š40â”Š          }\n+â”Š  â”Š41â”Š        }\n+â”Š  â”Š42â”Š        chat {\n+â”Š  â”Š43â”Š          id\n+â”Š  â”Š44â”Š        }\n+â”Š  â”Š45â”Š        receivedAt\n+â”Š  â”Š46â”Š        readAt\n+â”Š  â”Š47â”Š      }\n+â”Š  â”Š48â”Š      ownership\n+â”Š  â”Š49â”Š    }\n+â”Š  â”Š50â”Š  `,\n+â”Š  â”Š51â”Š};\n```\n\n##### Added src&#x2F;graphql&#x2F;getChats.query.ts\n```diff\n@@ -0,0 +1,17 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag';\n+â”Š  â”Š 2â”Šimport {fragments} from './fragment';\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Š// We use the gql tag to parse our query string into a query document\n+â”Š  â”Š 5â”Šexport const getChatsQuery = gql`\n+â”Š  â”Š 6â”Š  query GetChats($amount: Int) {\n+â”Š  â”Š 7â”Š    chats {\n+â”Š  â”Š 8â”Š      ...ChatWithoutMessages\n+â”Š  â”Š 9â”Š      messages(amount: $amount) {\n+â”Š  â”Š10â”Š        ...Message\n+â”Š  â”Š11â”Š      }\n+â”Š  â”Š12â”Š    }\n+â”Š  â”Š13â”Š  }\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”Š  ${fragments['chatWithoutMessages']}\n+â”Š  â”Š16â”Š  ${fragments['message']}\n+â”Š  â”Š17â”Š`;\n```\n\n[}]: #\n\nLet's create a simple service to query the chats from our just created server:\n\n[{]: <helper> (diffStep \"1.2\" files=\"src/app/services\" module=\"client\")\n\n#### Step 1.2: Add chats service\n\n##### Added src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -0,0 +1,26 @@\n+â”Š  â”Š 1â”Šimport {ApolloQueryResult, WatchQueryOptions} from 'apollo-client';\n+â”Š  â”Š 2â”Šimport {map} from 'rxjs/operators';\n+â”Š  â”Š 3â”Šimport {Apollo} from 'apollo-angular';\n+â”Š  â”Š 4â”Šimport {Injectable} from '@angular/core';\n+â”Š  â”Š 5â”Šimport {getChatsQuery} from '../../graphql/getChats.query';\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Š@Injectable()\n+â”Š  â”Š 8â”Šexport class ChatsService {\n+â”Š  â”Š 9â”Š  messagesAmount = 3;\n+â”Š  â”Š10â”Š\n+â”Š  â”Š11â”Š  constructor(private apollo: Apollo) {}\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Š  getChats() {\n+â”Š  â”Š14â”Š    const query = this.apollo.watchQuery<any>(<WatchQueryOptions>{\n+â”Š  â”Š15â”Š      query: getChatsQuery,\n+â”Š  â”Š16â”Š      variables: {\n+â”Š  â”Š17â”Š        amount: this.messagesAmount,\n+â”Š  â”Š18â”Š      },\n+â”Š  â”Š19â”Š    });\n+â”Š  â”Š20â”Š    const chats$ = query.valueChanges.pipe(\n+â”Š  â”Š21â”Š      map((result: ApolloQueryResult<any>) => result.data.chats)\n+â”Š  â”Š22â”Š    );\n+â”Š  â”Š23â”Š\n+â”Š  â”Š24â”Š    return {query, chats$};\n+â”Š  â”Š25â”Š  }\n+â”Š  â”Š26â”Š}\n```\n\n[}]: #\n\nWe just learned how to use Apollo to attach GraphQL query results to the Angular UI. The `watchQuery` method returns a `QueryRef` object which has the `valueChanges` property that is an Observable.\nThat information is stored in Apollo Clientâ€™s global cache, so if some other query fetches new information about the chats, this component will update to remain consistent.\nItâ€™s also possible to fetch data only once. The query method of Apollo service returns an Observable that also resolves with the same result as above.\n\n#### But what is a `QueryRef`?\n\nAs you know, `Apollo.query` method returns an Observable that emits a result, just once, but `Apollo.watchQuery` also does the same except it passes multiple results.\nSo why `Apollo.watchQuery` can not expose an Observable?\n\nIn `ApolloClient.watchQuery` returns an Observable, but not a standard one, it contains many useful methods (like `refetch()`) to manipulate the watched query.\nA normal Observable, has only one method, `subscribe()`.\n\nThe API of `QueryRef` is very simple. It has the same methods as the Apolloâ€™s Observable we talked about. To subscribe to query results you have to access `valueChanges` property which exposes a clean RxJS Observable.\n\nWe will use Materials for the UI, so let's install it:\n\n    $ npm install @angular/cdk @angular/material hammerjs ng2-truncate\n\nLet's configure Material:\n\n[{]: <helper> (diffStep \"1.3\" files=\"src/index.ts, src/main.ts, src/styles.scss\" module=\"client\")\n\n#### Step 1.3: List the chats\n\n##### Changed src&#x2F;main.ts\n```diff\n@@ -4,6 +4,9 @@\n â”Š 4â”Š 4â”Šimport { AppModule } from './app/app.module';\n â”Š 5â”Š 5â”Šimport { environment } from './environments/environment';\n â”Š 6â”Š 6â”Š\n+â”Š  â”Š 7â”Š// Material gestures\n+â”Š  â”Š 8â”Šimport 'hammerjs';\n+â”Š  â”Š 9â”Š\n â”Š 7â”Š10â”Šif (environment.production) {\n â”Š 8â”Š11â”Š  enableProdMode();\n â”Š 9â”Š12â”Š}\n```\n\n##### Changed src&#x2F;styles.scss\n```diff\n@@ -1 +1,8 @@\n â”Š1â”Š1â”Š/* You can add global styles to this file, and also import other style files */\n+â”Š â”Š2â”Š\n+â”Š â”Š3â”Š/* Meterial theme */\n+â”Š â”Š4â”Š@import \"~@angular/material/prebuilt-themes/indigo-pink.css\";\n+â”Š â”Š5â”Š\n+â”Š â”Š6â”Šbody {\n+â”Š â”Š7â”Š  margin: 0;\n+â”Š â”Š8â”Š}\n```\n\n[}]: #\n\nWe're now creating a `shared` module where we will define our header component where we're going to project a different content from each component:\n\n[{]: <helper> (diffStep \"1.3\" files=\"src/app/shared/*\" module=\"client\")\n\n#### Step 1.3: List the chats\n\n##### Added src&#x2F;app&#x2F;shared&#x2F;components&#x2F;toolbar&#x2F;toolbar.component.scss\n```diff\n@@ -0,0 +1,13 @@\n+â”Š  â”Š 1â”Š:host {\n+â”Š  â”Š 2â”Š  display: block;\n+â”Š  â”Š 3â”Š  height: 8vh;\n+â”Š  â”Š 4â”Š}\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Š.mat-toolbar {\n+â”Š  â”Š 7â”Š  justify-content: space-between;\n+â”Š  â”Š 8â”Š  height: 100%;\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Š  .left-block {\n+â”Š  â”Š11â”Š    display: flex;\n+â”Š  â”Š12â”Š  }\n+â”Š  â”Š13â”Š}\n```\n\n##### Added src&#x2F;app&#x2F;shared&#x2F;components&#x2F;toolbar&#x2F;toolbar.component.ts\n```diff\n@@ -0,0 +1,18 @@\n+â”Š  â”Š 1â”Šimport {Component} from '@angular/core';\n+â”Š  â”Š 2â”Š\n+â”Š  â”Š 3â”Š@Component({\n+â”Š  â”Š 4â”Š  selector: 'app-toolbar',\n+â”Š  â”Š 5â”Š  template: `\n+â”Š  â”Š 6â”Š    <mat-toolbar>\n+â”Š  â”Š 7â”Š      <div class=\"left-block\">\n+â”Š  â”Š 8â”Š        <ng-content select=\".navigation\"></ng-content>\n+â”Š  â”Š 9â”Š        <ng-content select=\".title\"></ng-content>\n+â”Š  â”Š10â”Š      </div>\n+â”Š  â”Š11â”Š      <ng-content select=\".menu\"></ng-content>\n+â”Š  â”Š12â”Š    </mat-toolbar>\n+â”Š  â”Š13â”Š  `,\n+â”Š  â”Š14â”Š  styleUrls: ['./toolbar.component.scss']\n+â”Š  â”Š15â”Š})\n+â”Š  â”Š16â”Šexport class ToolbarComponent {\n+â”Š  â”Š17â”Š\n+â”Š  â”Š18â”Š}\n```\n\n##### Added src&#x2F;app&#x2F;shared&#x2F;shared.module.ts\n```diff\n@@ -0,0 +1,28 @@\n+â”Š  â”Š 1â”Šimport {BrowserModule} from '@angular/platform-browser';\n+â”Š  â”Š 2â”Šimport {NgModule} from '@angular/core';\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šimport {MatToolbarModule} from '@angular/material';\n+â”Š  â”Š 5â”Šimport {ToolbarComponent} from './components/toolbar/toolbar.component';\n+â”Š  â”Š 6â”Šimport {FormsModule} from '@angular/forms';\n+â”Š  â”Š 7â”Šimport {BrowserAnimationsModule} from '@angular/platform-browser/animations';\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Š@NgModule({\n+â”Š  â”Š10â”Š  declarations: [\n+â”Š  â”Š11â”Š    ToolbarComponent,\n+â”Š  â”Š12â”Š  ],\n+â”Š  â”Š13â”Š  imports: [\n+â”Š  â”Š14â”Š    BrowserModule,\n+â”Š  â”Š15â”Š    // Material\n+â”Š  â”Š16â”Š    MatToolbarModule,\n+â”Š  â”Š17â”Š    // Animations\n+â”Š  â”Š18â”Š    BrowserAnimationsModule,\n+â”Š  â”Š19â”Š    // Forms\n+â”Š  â”Š20â”Š    FormsModule,\n+â”Š  â”Š21â”Š  ],\n+â”Š  â”Š22â”Š  providers: [],\n+â”Š  â”Š23â”Š  exports: [\n+â”Š  â”Š24â”Š    ToolbarComponent,\n+â”Š  â”Š25â”Š  ],\n+â”Š  â”Š26â”Š})\n+â”Š  â”Š27â”Šexport class SharedModule {\n+â”Š  â”Š28â”Š}\n```\n\n[}]: #\n\nNow we want to create the `chats-lister` module, with a container component called `ChatsComponent` and a couple of presentational components.\n\n[{]: <helper> (diffStep \"1.3\" files=\"src/app/chats-lister/*\" module=\"client\")\n\n#### Step 1.3: List the chats\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;chats-lister.module.ts\n```diff\n@@ -0,0 +1,49 @@\n+â”Š  â”Š 1â”Šimport { BrowserModule } from '@angular/platform-browser';\n+â”Š  â”Š 2â”Šimport { NgModule } from '@angular/core';\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šimport {BrowserAnimationsModule} from '@angular/platform-browser/animations';\n+â”Š  â”Š 5â”Šimport {MatButtonModule, MatIconModule, MatListModule, MatMenuModule} from '@angular/material';\n+â”Š  â”Š 6â”Šimport {RouterModule, Routes} from '@angular/router';\n+â”Š  â”Š 7â”Šimport {FormsModule} from '@angular/forms';\n+â”Š  â”Š 8â”Šimport {ChatsService} from '../services/chats.service';\n+â”Š  â”Š 9â”Šimport {ChatItemComponent} from './components/chat-item/chat-item.component';\n+â”Š  â”Š10â”Šimport {ChatsComponent} from './containers/chats/chats.component';\n+â”Š  â”Š11â”Šimport {ChatsListComponent} from './components/chats-list/chats-list.component';\n+â”Š  â”Š12â”Šimport {TruncateModule} from 'ng2-truncate';\n+â”Š  â”Š13â”Šimport {SharedModule} from '../shared/shared.module';\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”Šconst routes: Routes = [\n+â”Š  â”Š16â”Š  {path: '', redirectTo: 'chats', pathMatch: 'full'},\n+â”Š  â”Š17â”Š  {path: 'chats', component: ChatsComponent},\n+â”Š  â”Š18â”Š];\n+â”Š  â”Š19â”Š\n+â”Š  â”Š20â”Š@NgModule({\n+â”Š  â”Š21â”Š  declarations: [\n+â”Š  â”Š22â”Š    ChatsComponent,\n+â”Š  â”Š23â”Š    ChatsListComponent,\n+â”Š  â”Š24â”Š    ChatItemComponent,\n+â”Š  â”Š25â”Š  ],\n+â”Š  â”Š26â”Š  imports: [\n+â”Š  â”Š27â”Š    BrowserModule,\n+â”Š  â”Š28â”Š    // Material\n+â”Š  â”Š29â”Š    MatMenuModule,\n+â”Š  â”Š30â”Š    MatIconModule,\n+â”Š  â”Š31â”Š    MatButtonModule,\n+â”Š  â”Š32â”Š    MatListModule,\n+â”Š  â”Š33â”Š    // Animations\n+â”Š  â”Š34â”Š    BrowserAnimationsModule,\n+â”Š  â”Š35â”Š    // Routing\n+â”Š  â”Š36â”Š    RouterModule.forChild(routes),\n+â”Š  â”Š37â”Š    // Forms\n+â”Š  â”Š38â”Š    FormsModule,\n+â”Š  â”Š39â”Š    // Truncate Pipe\n+â”Š  â”Š40â”Š    TruncateModule,\n+â”Š  â”Š41â”Š    // Feature modules\n+â”Š  â”Š42â”Š    SharedModule,\n+â”Š  â”Š43â”Š  ],\n+â”Š  â”Š44â”Š  providers: [\n+â”Š  â”Š45â”Š    ChatsService,\n+â”Š  â”Š46â”Š  ],\n+â”Š  â”Š47â”Š})\n+â”Š  â”Š48â”Šexport class ChatsListerModule {\n+â”Š  â”Š49â”Š}\n```\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chat-item&#x2F;chat-item.component.scss\n```diff\n@@ -0,0 +1,17 @@\n+â”Š  â”Š 1â”Š:host {\n+â”Š  â”Š 2â”Š  display: block;\n+â”Š  â”Š 3â”Š  width: 100%;\n+â”Š  â”Š 4â”Š}\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Š.chat-row {\n+â”Š  â”Š 7â”Š  padding: 0;\n+â”Š  â”Š 8â”Š  display: flex;\n+â”Š  â”Š 9â”Š  width: 100%;\n+â”Š  â”Š10â”Š  justify-content: space-between;\n+â”Š  â”Š11â”Š  align-items: center;\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Š  .chat-recipient {\n+â”Š  â”Š14â”Š    display: flex;\n+â”Š  â”Š15â”Š    width: 60%;\n+â”Š  â”Š16â”Š  }\n+â”Š  â”Š17â”Š}\n```\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chat-item&#x2F;chat-item.component.ts\n```diff\n@@ -0,0 +1,20 @@\n+â”Š  â”Š 1â”Šimport {Component, Input} from '@angular/core';\n+â”Š  â”Š 2â”Š\n+â”Š  â”Š 3â”Š@Component({\n+â”Š  â”Š 4â”Š  selector: 'app-chat-item',\n+â”Š  â”Š 5â”Š  template: `\n+â”Š  â”Š 6â”Š    <div class=\"chat-row\">\n+â”Š  â”Š 7â”Š        <div class=\"chat-recipient\">\n+â”Š  â”Š 8â”Š          <img *ngIf=\"chat.picture\" [src]=\"chat.picture\" width=\"48\" height=\"48\">\n+â”Š  â”Š 9â”Š          <div>{{ chat.name }} [id: {{ chat.id }}]</div>\n+â”Š  â”Š10â”Š        </div>\n+â”Š  â”Š11â”Š        <div class=\"chat-content\">{{ chat.messages[chat.messages.length - 1]?.content | truncate : 20 : '...' }}</div>\n+â”Š  â”Š12â”Š    </div>\n+â”Š  â”Š13â”Š  `,\n+â”Š  â”Š14â”Š  styleUrls: ['chat-item.component.scss'],\n+â”Š  â”Š15â”Š})\n+â”Š  â”Š16â”Šexport class ChatItemComponent {\n+â”Š  â”Š17â”Š  // tslint:disable-next-line:no-input-rename\n+â”Š  â”Š18â”Š  @Input('item')\n+â”Š  â”Š19â”Š  chat: any;\n+â”Š  â”Š20â”Š}\n```\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chats-list&#x2F;chats-list.component.scss\n```diff\n@@ -0,0 +1,3 @@\n+â”Š â”Š1â”Š:host {\n+â”Š â”Š2â”Š  display: block;\n+â”Š â”Š3â”Š}\n```\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chats-list&#x2F;chats-list.component.ts\n```diff\n@@ -0,0 +1,20 @@\n+â”Š  â”Š 1â”Šimport {Component, Input} from '@angular/core';\n+â”Š  â”Š 2â”Š\n+â”Š  â”Š 3â”Š@Component({\n+â”Š  â”Š 4â”Š  selector: 'app-chats-list',\n+â”Š  â”Š 5â”Š  template: `\n+â”Š  â”Š 6â”Š    <mat-list>\n+â”Š  â”Š 7â”Š      <mat-list-item *ngFor=\"let chat of chats\">\n+â”Š  â”Š 8â”Š        <app-chat-item [item]=\"chat\"></app-chat-item>\n+â”Š  â”Š 9â”Š      </mat-list-item>\n+â”Š  â”Š10â”Š    </mat-list>\n+â”Š  â”Š11â”Š  `,\n+â”Š  â”Š12â”Š  styleUrls: ['chats-list.component.scss'],\n+â”Š  â”Š13â”Š})\n+â”Š  â”Š14â”Šexport class ChatsListComponent {\n+â”Š  â”Š15â”Š  // tslint:disable-next-line:no-input-rename\n+â”Š  â”Š16â”Š  @Input('items')\n+â”Š  â”Š17â”Š  chats: any[];\n+â”Š  â”Š18â”Š\n+â”Š  â”Š19â”Š  constructor() {}\n+â”Š  â”Š20â”Š}\n```\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.scss\n```diff\n@@ -0,0 +1,5 @@\n+â”Š â”Š1â”Š.chat-button {\n+â”Š â”Š2â”Š  position: absolute;\n+â”Š â”Š3â”Š  bottom: 5vw;\n+â”Š â”Š4â”Š  right: 5vw;\n+â”Š â”Š5â”Š}\n```\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.ts\n```diff\n@@ -0,0 +1,46 @@\n+â”Š  â”Š 1â”Šimport {Component, OnInit} from '@angular/core';\n+â”Š  â”Š 2â”Šimport {ChatsService} from '../../../services/chats.service';\n+â”Š  â”Š 3â”Šimport {Observable} from 'rxjs/Observable';\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Š@Component({\n+â”Š  â”Š 6â”Š  template: `\n+â”Š  â”Š 7â”Š    <app-toolbar>\n+â”Š  â”Š 8â”Š      <div class=\"title\">Whatsapp Clone</div>\n+â”Š  â”Š 9â”Š      <button mat-icon-button [matMenuTriggerFor]=\"menu\" class=\"menu\">\n+â”Š  â”Š10â”Š        <mat-icon>more_vert</mat-icon>\n+â”Š  â”Š11â”Š      </button>\n+â”Š  â”Š12â”Š    </app-toolbar>\n+â”Š  â”Š13â”Š\n+â”Š  â”Š14â”Š    <mat-menu #menu=\"matMenu\">\n+â”Š  â”Š15â”Š      <button mat-menu-item>\n+â”Š  â”Š16â”Š        <mat-icon>dialpad</mat-icon>\n+â”Š  â”Š17â”Š        <span>Redial</span>\n+â”Š  â”Š18â”Š      </button>\n+â”Š  â”Š19â”Š      <button mat-menu-item disabled>\n+â”Š  â”Š20â”Š        <mat-icon>voicemail</mat-icon>\n+â”Š  â”Š21â”Š        <span>Check voicemail</span>\n+â”Š  â”Š22â”Š      </button>\n+â”Š  â”Š23â”Š      <button mat-menu-item>\n+â”Š  â”Š24â”Š        <mat-icon>notifications_off</mat-icon>\n+â”Š  â”Š25â”Š        <span>Disable alerts</span>\n+â”Š  â”Š26â”Š      </button>\n+â”Š  â”Š27â”Š    </mat-menu>\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š    <app-chats-list [items]=\"chats$ | async\"></app-chats-list>\n+â”Š  â”Š30â”Š\n+â”Š  â”Š31â”Š    <button class=\"chat-button\" mat-fab color=\"primary\">\n+â”Š  â”Š32â”Š      <mat-icon aria-label=\"Icon-button with a + icon\">add</mat-icon>\n+â”Š  â”Š33â”Š    </button>\n+â”Š  â”Š34â”Š  `,\n+â”Š  â”Š35â”Š  styleUrls: ['./chats.component.scss'],\n+â”Š  â”Š36â”Š})\n+â”Š  â”Š37â”Šexport class ChatsComponent implements OnInit {\n+â”Š  â”Š38â”Š  chats$: Observable<any[]>;\n+â”Š  â”Š39â”Š\n+â”Š  â”Š40â”Š  constructor(private chatsService: ChatsService) {\n+â”Š  â”Š41â”Š  }\n+â”Š  â”Š42â”Š\n+â”Š  â”Š43â”Š  ngOnInit() {\n+â”Š  â”Š44â”Š    this.chats$ = this.chatsService.getChats().chats$;\n+â”Š  â”Š45â”Š  }\n+â”Š  â”Š46â”Š}\n```\n\n[}]: #\n\nFinally let's wire everything up to the main module:\n\n[{]: <helper> (diffStep \"1.3\" files=\"src/app/app.component.ts, src/app/app.module.ts\" module=\"client\")\n\n#### Step 1.3: List the chats\n\n##### Changed src&#x2F;app&#x2F;app.component.ts\n```diff\n@@ -2,7 +2,9 @@\n â”Š 2â”Š 2â”Š\n â”Š 3â”Š 3â”Š@Component({\n â”Š 4â”Š 4â”Š  selector: 'app-root',\n-â”Š 5â”Š  â”Š  templateUrl: './app.component.html',\n+â”Š  â”Š 5â”Š  template: `\n+â”Š  â”Š 6â”Š    <router-outlet></router-outlet>\n+â”Š  â”Š 7â”Š  `,\n â”Š 6â”Š 8â”Š  styleUrls: ['./app.component.scss']\n â”Š 7â”Š 9â”Š})\n â”Š 8â”Š10â”Šexport class AppComponent {\n```\n\n##### Changed src&#x2F;app&#x2F;app.module.ts\n```diff\n@@ -6,8 +6,11 @@\n â”Š 6â”Š 6â”Šimport {HttpClientModule} from '@angular/common/http';\n â”Š 7â”Š 7â”Šimport {HttpLink, HttpLinkModule, Options} from 'apollo-angular-link-http';\n â”Š 8â”Š 8â”Šimport {Apollo, ApolloModule} from 'apollo-angular';\n-â”Š 9â”Š  â”Šimport {InMemoryCache} from 'apollo-cache-inmemory';\n+â”Š  â”Š 9â”Šimport {defaultDataIdFromObject, InMemoryCache} from 'apollo-cache-inmemory';\n+â”Š  â”Š10â”Šimport {ChatsListerModule} from './chats-lister/chats-lister.module';\n+â”Š  â”Š11â”Šimport {RouterModule, Routes} from '@angular/router';\n â”Š10â”Š12â”Š\n+â”Š  â”Š13â”Šconst routes: Routes = [];\n â”Š11â”Š14â”Š\n â”Š12â”Š15â”Š@NgModule({\n â”Š13â”Š16â”Š  declarations: [\n```\n```diff\n@@ -19,6 +22,10 @@\n â”Š19â”Š22â”Š    ApolloModule,\n â”Š20â”Š23â”Š    HttpLinkModule,\n â”Š21â”Š24â”Š    HttpClientModule,\n+â”Š  â”Š25â”Š    // Routing\n+â”Š  â”Š26â”Š    RouterModule.forRoot(routes),\n+â”Š  â”Š27â”Š    // Feature modules\n+â”Š  â”Š28â”Š    ChatsListerModule,\n â”Š22â”Š29â”Š  ],\n â”Š23â”Š30â”Š  providers: [],\n â”Š24â”Š31â”Š  bootstrap: [AppComponent]\n```\n\n[}]: #\n\nIf you will try to run the frontend you will notice that several messages seems like duplicated, why does it happen?\n\n`apollo-cache-inmemory` is the default cache implementation for Apollo Client 2.0. `InMemoryCache` is a normalized data store that supports all of Apollo Client 1.0's features without the dependency on Redux.\nThe `InMemoryCache` normalizes your data before saving it to the store by splitting the result into individual objects, creating a unique identifier for each object, and storing those objects in a flattened data structure. By default, `InMemoryCache` will attempt to use the commonly found primary keys of `id` and `_id` for the unique identifier if they exist along with `__typename` on an object.\nSince we use NoSQL-like structure in our backend, messages are stored as an array inside each chat so their incremental identifiers are not unique across different chats. We need to normalize them in a way that takes into account both the message id and the chat id:\n\n[{]: <helper> (diffStep \"1.4\" module=\"client\")\n\n#### Step 1.4: Better normalize messages\n\n##### Changed src&#x2F;app&#x2F;app.module.ts\n```diff\n@@ -37,7 +37,14 @@\n â”Š37â”Š37â”Š  ) {\n â”Š38â”Š38â”Š    apollo.create({\n â”Š39â”Š39â”Š      link: httpLink.create(<Options>{uri: 'http://localhost:3000/graphql'}),\n-â”Š40â”Š  â”Š      cache: new InMemoryCache(),\n+â”Š  â”Š40â”Š      cache: new InMemoryCache({\n+â”Š  â”Š41â”Š        dataIdFromObject: (object: any) => {\n+â”Š  â”Š42â”Š          switch (object.__typename) {\n+â”Š  â”Š43â”Š            case 'Message': return `${object.chat.id}:${object.id}`; // use `chatId` prefix and `messageId` as the primary key\n+â”Š  â”Š44â”Š            default: return defaultDataIdFromObject(object); // fall back to default handling\n+â”Š  â”Š45â”Š          }\n+â”Š  â”Š46â”Š        }\n+â”Š  â”Š47â”Š      }),\n â”Š41â”Š48â”Š    });\n â”Š42â”Š49â”Š  }\n â”Š43â”Š50â”Š}\n```\n\n[}]: #\n\nThat way our application will work even if the backend is a NoSQL. What's even more interesting is that our application will keep working as well even when we will switch our backend to PostgreSQL."
          },
          {
            "manualTitle": "Step 6: graphql-code-generator",
            "stepRevision": "eeb529069298c0ef53d3c0b63337bb92f4ee73a8",
            "manualView": "## Server\n\nThe GraphQL codegen library can generate any code for any languageâ€Šâ€”â€Šincluding type definitions, data models, query builder, resolvers, ORM code, complete full stack platforms.\nYou can create your own custom GraphQL codegen templates in 10 minutes, that fit exactly your needs. We will use it to generate `Typescript` typings.\n\nFirst, let's install `graphql-code-generator`  in our server and add it to the run scripts:\n\n    $ npm install graphql-code-generator\n\n[{]: <helper> (diffStep \"2.1\" module=\"server\")\n\n#### Step 2.1: Install graphql-code-generator\n\n##### Changed package.json\n```diff\n@@ -4,7 +4,8 @@\n â”Š 4â”Š 4â”Š  \"private\": true,\n â”Š 5â”Š 5â”Š  \"scripts\": {\n â”Š 6â”Š 6â”Š    \"start\": \"npm run build:live\",\n-â”Š 7â”Š  â”Š    \"build:live\": \"nodemon --exec ./node_modules/.bin/ts-node -- ./index.ts\"\n+â”Š  â”Š 7â”Š    \"build:live\": \"nodemon --exec ./node_modules/.bin/ts-node -- ./index.ts\",\n+â”Š  â”Š 8â”Š    \"generator\": \"gql-gen --url http://localhost:3000/graphql --template ts --out ./types.d.ts\"\n â”Š 8â”Š 9â”Š  },\n â”Š 9â”Š10â”Š  \"devDependencies\": {\n â”Š10â”Š11â”Š    \"@types/body-parser\": \"1.16.8\",\n```\n```diff\n@@ -22,6 +23,7 @@\n â”Š22â”Š23â”Š    \"cors\": \"2.8.4\",\n â”Š23â”Š24â”Š    \"express\": \"4.16.2\",\n â”Š24â”Š25â”Š    \"graphql\": \"0.12.3\",\n+â”Š  â”Š26â”Š    \"graphql-code-generator\": \"0.8.14\",\n â”Š25â”Š27â”Š    \"graphql-tools\": \"2.21.0\",\n â”Š26â”Š28â”Š    \"moment\": \"2.20.1\"\n â”Š27â”Š29â”Š  }\n```\n\n[}]: #\n\nNow let's run the generator (the server must be running in the background):\n\n    $ npm run generator\n\nPlease note that the server must be started before running the generator.\n\nThose are the types created with `npm run generator`:\n\n[{]: <helper> (diffStep \"2.2\" module=\"server\")\n\n#### Step 2.2: Create types with generator\n\n##### Added types.d.ts\n```diff\n@@ -0,0 +1,56 @@\n+â”Š  â”Š 1â”Š/* tslint:disable */\n+â”Š  â”Š 2â”Š\n+â”Š  â”Š 3â”Šexport interface Query {\n+â”Š  â”Š 4â”Š  users: User[]; \n+â”Š  â”Š 5â”Š  chats: Chat[]; \n+â”Š  â”Š 6â”Š  chat?: Chat | null; \n+â”Š  â”Š 7â”Š}\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Šexport interface User {\n+â”Š  â”Š10â”Š  id: string; \n+â”Š  â”Š11â”Š  name?: string | null; \n+â”Š  â”Š12â”Š  picture?: string | null; \n+â”Š  â”Š13â”Š  phone?: string | null; \n+â”Š  â”Š14â”Š}\n+â”Š  â”Š15â”Š\n+â”Š  â”Š16â”Šexport interface Chat {\n+â”Š  â”Š17â”Š  id: string; /* May be a chat or a group */\n+â”Š  â”Š18â”Š  name?: string | null; /* Computed for chats */\n+â”Š  â”Š19â”Š  picture?: string | null; /* Computed for chats */\n+â”Š  â”Š20â”Š  allTimeMembers: User[]; /* All members, current and past ones. */\n+â”Š  â”Š21â”Š  listingMembers: User[]; /* Whoever gets the chat listed. For groups includes past members who still didn&#x27;t delete the group. */\n+â”Š  â”Š22â”Š  actualGroupMembers: User[]; /* Actual members of the group (they are not the only ones who get the group listed). Null for chats. */\n+â”Š  â”Š23â”Š  admins: User[]; /* Null for chats */\n+â”Š  â”Š24â”Š  owner?: User | null; /* If null the group is read-only. Null for chats. */\n+â”Š  â”Š25â”Š  messages: Message[]; \n+â”Š  â”Š26â”Š  unreadMessages: number; /* Computed property */\n+â”Š  â”Š27â”Š  isGroup: boolean; /* Computed property */\n+â”Š  â”Š28â”Š}\n+â”Š  â”Š29â”Š\n+â”Š  â”Š30â”Šexport interface Message {\n+â”Š  â”Š31â”Š  id: string; \n+â”Š  â”Š32â”Š  sender: User; \n+â”Š  â”Š33â”Š  chat: Chat; \n+â”Š  â”Š34â”Š  content: string; \n+â”Š  â”Š35â”Š  createdAt: string; \n+â”Š  â”Š36â”Š  type: number; /* FIXME: should return MessageType */\n+â”Š  â”Š37â”Š  recipients: Recipient[]; /* Whoever received the message */\n+â”Š  â”Š38â”Š  holders: User[]; /* Whoever still holds a copy of the message. Cannot be null because the message gets deleted otherwise */\n+â”Š  â”Š39â”Š  ownership: boolean; /* Computed property */\n+â”Š  â”Š40â”Š}\n+â”Š  â”Š41â”Š\n+â”Š  â”Š42â”Šexport interface Recipient {\n+â”Š  â”Š43â”Š  user: User; \n+â”Š  â”Š44â”Š  message: Message; \n+â”Š  â”Š45â”Š  receivedAt?: string | null; \n+â”Š  â”Š46â”Š  readAt?: string | null; \n+â”Š  â”Š47â”Š}\n+â”Š  â”Š48â”Šexport interface ChatQueryArgs {\n+â”Š  â”Š49â”Š  chatId: string; \n+â”Š  â”Š50â”Š}\n+â”Š  â”Š51â”Šexport interface MessagesChatArgs {\n+â”Š  â”Š52â”Š  amount?: number | null; \n+â”Š  â”Š53â”Š}\n+â”Š  â”Š54â”Š\n+â”Š  â”Š55â”Šexport type MessageType = \"LOCATION\" | \"TEXT\" | \"PICTURE\";\n+â”Š  â”Š56â”Š\n```\n\n[}]: #\n\nNow let's use them:\n\n[{]: <helper> (diffStep \"2.3\" module=\"server\")\n\n#### Step 2.3: Use our types\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,5 +1,6 @@\n â”Š1â”Š1â”Šimport { Chat, db, Message, Recipient, User } from \"../db\";\n â”Š2â”Š2â”Šimport { IResolvers } from \"graphql-tools/dist/Interfaces\";\n+â”Š â”Š3â”Šimport { ChatQueryArgs } from \"../types\";\n â”Š3â”Š4â”Š\n â”Š4â”Š5â”Šlet users = db.users;\n â”Š5â”Š6â”Šlet chats = db.chats;\n```\n```diff\n@@ -10,7 +11,7 @@\n â”Š10â”Š11â”Š    // Show all users for the moment.\n â”Š11â”Š12â”Š    users: (): User[] => users.filter(user => user.id !== currentUser),\n â”Š12â”Š13â”Š    chats: (): Chat[] => chats.filter(chat => chat.listingMemberIds.includes(currentUser)),\n-â”Š13â”Š  â”Š    chat: (obj: any, {chatId}): Chat | null => chats.find(chat => chat.id === chatId) || null,\n+â”Š  â”Š14â”Š    chat: (obj: any, {chatId}: ChatQueryArgs): Chat | null => chats.find(chat => chat.id === Number(chatId)) || null,\n â”Š14â”Š15â”Š  },\n â”Š15â”Š16â”Š  Chat: {\n â”Š16â”Š17â”Š    name: (chat: Chat): string => chat.name ? chat.name : users\n```\n\n[}]: #\n\nDon't worry, they will be much more useful when we will write our first mutation.\n\n## Client\n\nLet's do the same on the client:\n\n    $ npm install graphql-code-generator\n\nPlease note that the server must be started before running the generator.\n\n[{]: <helper> (diffStep \"2.1\" module=\"client\")\n\n#### Step 2.1: Install graphql-code-generator\n\n##### Changed package.json\n```diff\n@@ -8,7 +8,8 @@\n â”Š 8â”Š 8â”Š    \"build\": \"ng build --prod\",\n â”Š 9â”Š 9â”Š    \"test\": \"ng test\",\n â”Š10â”Š10â”Š    \"lint\": \"ng lint\",\n-â”Š11â”Š  â”Š    \"e2e\": \"ng e2e\"\n+â”Š  â”Š11â”Š    \"e2e\": \"ng e2e\",\n+â”Š  â”Š12â”Š    \"generator\": \"gql-gen --url http://localhost:3000/graphql --template ts --out ./src/types.d.ts \\\"./src/graphql/**/*.ts\\\"\"\n â”Š12â”Š13â”Š  },\n â”Š13â”Š14â”Š  \"private\": true,\n â”Š14â”Š15â”Š  \"dependencies\": {\n```\n```diff\n@@ -46,6 +47,7 @@\n â”Š46â”Š47â”Š    \"@types/jasminewd2\": \"2.0.3\",\n â”Š47â”Š48â”Š    \"@types/node\": \"6.0.101\",\n â”Š48â”Š49â”Š    \"codelyzer\": \"4.1.0\",\n+â”Š  â”Š50â”Š    \"graphql-code-generator\": \"0.8.14\",\n â”Š49â”Š51â”Š    \"jasmine-core\": \"2.8.0\",\n â”Š50â”Š52â”Š    \"jasmine-spec-reporter\": \"4.2.1\",\n â”Š51â”Š53â”Š    \"karma\": \"2.0.0\",\n```\n\n[}]: #\n\nThose are our generated types:\n\n[{]: <helper> (diffStep \"2.2\" module=\"client\")\n\n#### Step 2.2: Run generator\n\n##### Added src&#x2F;types.d.ts\n```diff\n@@ -0,0 +1,118 @@\n+â”Š   â”Š  1â”Š/* tslint:disable */\n+â”Š   â”Š  2â”Š\n+â”Š   â”Š  3â”Šexport interface Query {\n+â”Š   â”Š  4â”Š  users: User[]; \n+â”Š   â”Š  5â”Š  chats: Chat[]; \n+â”Š   â”Š  6â”Š  chat?: Chat | null; \n+â”Š   â”Š  7â”Š}\n+â”Š   â”Š  8â”Š\n+â”Š   â”Š  9â”Šexport interface User {\n+â”Š   â”Š 10â”Š  id: string; \n+â”Š   â”Š 11â”Š  name?: string | null; \n+â”Š   â”Š 12â”Š  picture?: string | null; \n+â”Š   â”Š 13â”Š  phone?: string | null; \n+â”Š   â”Š 14â”Š}\n+â”Š   â”Š 15â”Š\n+â”Š   â”Š 16â”Šexport interface Chat {\n+â”Š   â”Š 17â”Š  id: string; /* May be a chat or a group */\n+â”Š   â”Š 18â”Š  name?: string | null; /* Computed for chats */\n+â”Š   â”Š 19â”Š  picture?: string | null; /* Computed for chats */\n+â”Š   â”Š 20â”Š  allTimeMembers: User[]; /* All members, current and past ones. */\n+â”Š   â”Š 21â”Š  listingMembers: User[]; /* Whoever gets the chat listed. For groups includes past members who still didn&#x27;t delete the group. */\n+â”Š   â”Š 22â”Š  actualGroupMembers: User[]; /* Actual members of the group (they are not the only ones who get the group listed). Null for chats. */\n+â”Š   â”Š 23â”Š  admins: User[]; /* Null for chats */\n+â”Š   â”Š 24â”Š  owner?: User | null; /* If null the group is read-only. Null for chats. */\n+â”Š   â”Š 25â”Š  messages: Message[]; \n+â”Š   â”Š 26â”Š  unreadMessages: number; /* Computed property */\n+â”Š   â”Š 27â”Š  isGroup: boolean; /* Computed property */\n+â”Š   â”Š 28â”Š}\n+â”Š   â”Š 29â”Š\n+â”Š   â”Š 30â”Šexport interface Message {\n+â”Š   â”Š 31â”Š  id: string; \n+â”Š   â”Š 32â”Š  sender: User; \n+â”Š   â”Š 33â”Š  chat: Chat; \n+â”Š   â”Š 34â”Š  content: string; \n+â”Š   â”Š 35â”Š  createdAt: string; \n+â”Š   â”Š 36â”Š  type: number; /* FIXME: should return MessageType */\n+â”Š   â”Š 37â”Š  recipients: Recipient[]; /* Whoever received the message */\n+â”Š   â”Š 38â”Š  holders: User[]; /* Whoever still holds a copy of the message. Cannot be null because the message gets deleted otherwise */\n+â”Š   â”Š 39â”Š  ownership: boolean; /* Computed property */\n+â”Š   â”Š 40â”Š}\n+â”Š   â”Š 41â”Š\n+â”Š   â”Š 42â”Šexport interface Recipient {\n+â”Š   â”Š 43â”Š  user: User; \n+â”Š   â”Š 44â”Š  message: Message; \n+â”Š   â”Š 45â”Š  receivedAt?: string | null; \n+â”Š   â”Š 46â”Š  readAt?: string | null; \n+â”Š   â”Š 47â”Š}\n+â”Š   â”Š 48â”Šexport interface ChatQueryArgs {\n+â”Š   â”Š 49â”Š  chatId: string; \n+â”Š   â”Š 50â”Š}\n+â”Š   â”Š 51â”Šexport interface MessagesChatArgs {\n+â”Š   â”Š 52â”Š  amount?: number | null; \n+â”Š   â”Š 53â”Š}\n+â”Š   â”Š 54â”Š\n+â”Š   â”Š 55â”Šexport type MessageType = \"LOCATION\" | \"TEXT\" | \"PICTURE\";\n+â”Š   â”Š 56â”Š\n+â”Š   â”Š 57â”Šexport namespace GetChats {\n+â”Š   â”Š 58â”Š  export type Variables = {\n+â”Š   â”Š 59â”Š    amount?: number | null;\n+â”Š   â”Š 60â”Š  }\n+â”Š   â”Š 61â”Š\n+â”Š   â”Š 62â”Š  export type Query = {\n+â”Š   â”Š 63â”Š    chats: Chats[]; \n+â”Š   â”Š 64â”Š  } \n+â”Š   â”Š 65â”Š\n+â”Š   â”Š 66â”Š  export type Chats = {\n+â”Š   â”Š 67â”Š    messages: Messages[]; \n+â”Š   â”Š 68â”Š  } & ChatWithoutMessages.Fragment\n+â”Š   â”Š 69â”Š\n+â”Š   â”Š 70â”Š  export type Messages = Message.Fragment\n+â”Š   â”Š 71â”Š}\n+â”Š   â”Š 72â”Š\n+â”Š   â”Š 73â”Šexport namespace ChatWithoutMessages {\n+â”Š   â”Š 74â”Š  export type Fragment = {\n+â”Š   â”Š 75â”Š    id: string; \n+â”Š   â”Š 76â”Š    name?: string | null; \n+â”Š   â”Š 77â”Š    picture?: string | null; \n+â”Š   â”Š 78â”Š    allTimeMembers: AllTimeMembers[]; \n+â”Š   â”Š 79â”Š    unreadMessages: number; \n+â”Š   â”Š 80â”Š    isGroup: boolean; \n+â”Š   â”Š 81â”Š  } \n+â”Š   â”Š 82â”Š\n+â”Š   â”Š 83â”Š  export type AllTimeMembers = {\n+â”Š   â”Š 84â”Š    id: string; \n+â”Š   â”Š 85â”Š  } \n+â”Š   â”Š 86â”Š}\n+â”Š   â”Š 87â”Š\n+â”Š   â”Š 88â”Šexport namespace Message {\n+â”Š   â”Š 89â”Š  export type Fragment = {\n+â”Š   â”Š 90â”Š    id: string; \n+â”Š   â”Š 91â”Š    sender: Sender; \n+â”Š   â”Š 92â”Š    content: string; \n+â”Š   â”Š 93â”Š    createdAt: string; \n+â”Š   â”Š 94â”Š    type: number; \n+â”Š   â”Š 95â”Š    recipients: Recipients[]; \n+â”Š   â”Š 96â”Š    ownership: boolean; \n+â”Š   â”Š 97â”Š  } \n+â”Š   â”Š 98â”Š\n+â”Š   â”Š 99â”Š  export type Sender = {\n+â”Š   â”Š100â”Š    id: string; \n+â”Š   â”Š101â”Š    name?: string | null; \n+â”Š   â”Š102â”Š  } \n+â”Š   â”Š103â”Š\n+â”Š   â”Š104â”Š  export type Recipients = {\n+â”Š   â”Š105â”Š    user: User; \n+â”Š   â”Š106â”Š    message: Message; \n+â”Š   â”Š107â”Š    receivedAt?: string | null; \n+â”Š   â”Š108â”Š    readAt?: string | null; \n+â”Š   â”Š109â”Š  } \n+â”Š   â”Š110â”Š\n+â”Š   â”Š111â”Š  export type User = {\n+â”Š   â”Š112â”Š    id: string; \n+â”Š   â”Š113â”Š  } \n+â”Š   â”Š114â”Š\n+â”Š   â”Š115â”Š  export type Message = {\n+â”Š   â”Š116â”Š    id: string; \n+â”Š   â”Š117â”Š  } \n+â”Š   â”Š118â”Š}\n```\n\n[}]: #\n\nLet's use them:\n\n[{]: <helper> (diffStep \"2.3\" module=\"client\")\n\n#### Step 2.3: Use the generated types\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chat-item&#x2F;chat-item.component.ts\n```diff\n@@ -1,4 +1,5 @@\n â”Š1â”Š1â”Šimport {Component, Input} from '@angular/core';\n+â”Š â”Š2â”Šimport {GetChats} from '../../../../types';\n â”Š2â”Š3â”Š\n â”Š3â”Š4â”Š@Component({\n â”Š4â”Š5â”Š  selector: 'app-chat-item',\n```\n```diff\n@@ -16,5 +17,5 @@\n â”Š16â”Š17â”Šexport class ChatItemComponent {\n â”Š17â”Š18â”Š  // tslint:disable-next-line:no-input-rename\n â”Š18â”Š19â”Š  @Input('item')\n-â”Š19â”Š  â”Š  chat: any;\n+â”Š  â”Š20â”Š  chat: GetChats.Chats;\n â”Š20â”Š21â”Š}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chats-list&#x2F;chats-list.component.ts\n```diff\n@@ -1,4 +1,5 @@\n â”Š1â”Š1â”Šimport {Component, Input} from '@angular/core';\n+â”Š â”Š2â”Šimport {GetChats} from '../../../../types';\n â”Š2â”Š3â”Š\n â”Š3â”Š4â”Š@Component({\n â”Š4â”Š5â”Š  selector: 'app-chats-list',\n```\n```diff\n@@ -14,7 +15,7 @@\n â”Š14â”Š15â”Šexport class ChatsListComponent {\n â”Š15â”Š16â”Š  // tslint:disable-next-line:no-input-rename\n â”Š16â”Š17â”Š  @Input('items')\n-â”Š17â”Š  â”Š  chats: any[];\n+â”Š  â”Š18â”Š  chats: GetChats.Chats[];\n â”Š18â”Š19â”Š\n â”Š19â”Š20â”Š  constructor() {}\n â”Š20â”Š21â”Š}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.ts\n```diff\n@@ -1,6 +1,7 @@\n â”Š1â”Š1â”Šimport {Component, OnInit} from '@angular/core';\n â”Š2â”Š2â”Šimport {ChatsService} from '../../../services/chats.service';\n â”Š3â”Š3â”Šimport {Observable} from 'rxjs/Observable';\n+â”Š â”Š4â”Šimport {GetChats} from '../../../../types';\n â”Š4â”Š5â”Š\n â”Š5â”Š6â”Š@Component({\n â”Š6â”Š7â”Š  template: `\n```\n```diff\n@@ -35,7 +36,7 @@\n â”Š35â”Š36â”Š  styleUrls: ['./chats.component.scss'],\n â”Š36â”Š37â”Š})\n â”Š37â”Š38â”Šexport class ChatsComponent implements OnInit {\n-â”Š38â”Š  â”Š  chats$: Observable<any[]>;\n+â”Š  â”Š39â”Š  chats$: Observable<GetChats.Chats[]>;\n â”Š39â”Š40â”Š\n â”Š40â”Š41â”Š  constructor(private chatsService: ChatsService) {\n â”Š41â”Š42â”Š  }\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -3,6 +3,7 @@\n â”Š3â”Š3â”Šimport {Apollo} from 'apollo-angular';\n â”Š4â”Š4â”Šimport {Injectable} from '@angular/core';\n â”Š5â”Š5â”Šimport {getChatsQuery} from '../../graphql/getChats.query';\n+â”Š â”Š6â”Šimport {GetChats} from '../../types';\n â”Š6â”Š7â”Š\n â”Š7â”Š8â”Š@Injectable()\n â”Š8â”Š9â”Šexport class ChatsService {\n```\n```diff\n@@ -11,14 +12,14 @@\n â”Š11â”Š12â”Š  constructor(private apollo: Apollo) {}\n â”Š12â”Š13â”Š\n â”Š13â”Š14â”Š  getChats() {\n-â”Š14â”Š  â”Š    const query = this.apollo.watchQuery<any>(<WatchQueryOptions>{\n+â”Š  â”Š15â”Š    const query = this.apollo.watchQuery<GetChats.Query>(<WatchQueryOptions>{\n â”Š15â”Š16â”Š      query: getChatsQuery,\n â”Š16â”Š17â”Š      variables: {\n â”Š17â”Š18â”Š        amount: this.messagesAmount,\n â”Š18â”Š19â”Š      },\n â”Š19â”Š20â”Š    });\n â”Š20â”Š21â”Š    const chats$ = query.valueChanges.pipe(\n-â”Š21â”Š  â”Š      map((result: ApolloQueryResult<any>) => result.data.chats)\n+â”Š  â”Š22â”Š      map((result: ApolloQueryResult<GetChats.Query>) => result.data.chats)\n â”Š22â”Š23â”Š    );\n â”Š23â”Š24â”Š\n â”Š24â”Š25â”Š    return {query, chats$};\n```\n\n[}]: #"
          },
          {
            "manualTitle": "Step 7: Testing",
            "stepRevision": "37b1788a44697c456c4246c74b328942fc6706e7",
            "manualView": "## Client\n\nTesting is a very important part of each application and for the sake of showing different testing techniques we are going to show how to test a presentational component, a container component and a service.\n\nFirst let's start by importing `hammerjs` for the Material Gestures inside the test script.\n\n[{]: <helper> (diffStep \"3.1\" files=\"src/test.ts\" module=\"client\")\n\n#### Step 3.1: Testing\n\n##### Changed src&#x2F;test.ts\n```diff\n@@ -7,6 +7,9 @@\n â”Š 7â”Š 7â”Š  platformBrowserDynamicTesting\n â”Š 8â”Š 8â”Š} from '@angular/platform-browser-dynamic/testing';\n â”Š 9â”Š 9â”Š\n+â”Š  â”Š10â”Š// Material gestures\n+â”Š  â”Š11â”Šimport 'hammerjs';\n+â”Š  â”Š12â”Š\n â”Š10â”Š13â”Šdeclare const require: any;\n â”Š11â”Š14â”Š\n â”Š12â”Š15â”Š// First, initialize the Angular testing environment.\n```\n\n[}]: #\n\nLet's start with the simplest one: the presentational component.\nWe are not going to inject any service and we don't need to access our backend, so things are quite simple: we just need to pass our Chat object as an Input, detect the changes and use the query selector to match the UI content to the one we passed as input:\n\n[{]: <helper> (diffStep \"3.1\" files=\"src/app/chats-lister/components/chat-item/chat-item.component.spec.ts\" module=\"client\")\n\n#### Step 3.1: Testing\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chat-item&#x2F;chat-item.component.spec.ts\n```diff\n@@ -0,0 +1,107 @@\n+â”Š   â”Š  1â”Šimport { async, ComponentFixture, TestBed } from '@angular/core/testing';\n+â”Š   â”Š  2â”Š\n+â”Š   â”Š  3â”Šimport { ChatItemComponent } from './chat-item.component';\n+â”Š   â”Š  4â”Šimport {DebugElement} from '@angular/core';\n+â”Š   â”Š  5â”Šimport {By} from '@angular/platform-browser';\n+â”Š   â”Š  6â”Šimport {TruncateModule} from 'ng2-truncate';\n+â”Š   â”Š  7â”Š\n+â”Š   â”Š  8â”Šdescribe('ChatItemComponent', () => {\n+â”Š   â”Š  9â”Š  let component: ChatItemComponent;\n+â”Š   â”Š 10â”Š  let fixture: ComponentFixture<ChatItemComponent>;\n+â”Š   â”Š 11â”Š  let el: DebugElement;\n+â”Š   â”Š 12â”Š\n+â”Š   â”Š 13â”Š  const chat: any = {\n+â”Š   â”Š 14â”Š    id: '1',\n+â”Š   â”Š 15â”Š    __typename: 'Chat',\n+â”Š   â”Š 16â”Š    name: 'Niccolo\\' Belli',\n+â”Š   â”Š 17â”Š    picture: null,\n+â”Š   â”Š 18â”Š    allTimeMembers: [\n+â”Š   â”Š 19â”Š      {\n+â”Š   â”Š 20â”Š        id: '1',\n+â”Š   â”Š 21â”Š        __typename: 'User',\n+â”Š   â”Š 22â”Š      },\n+â”Š   â”Š 23â”Š      {\n+â”Š   â”Š 24â”Š        id: '2',\n+â”Š   â”Š 25â”Š        __typename: 'User',\n+â”Š   â”Š 26â”Š      }\n+â”Š   â”Š 27â”Š    ],\n+â”Š   â”Š 28â”Š    unreadMessages: 0,\n+â”Š   â”Š 29â”Š    isGroup: false,\n+â”Š   â”Š 30â”Š    messages: [\n+â”Š   â”Š 31â”Š      {\n+â”Š   â”Š 32â”Š        id: '1',\n+â”Š   â”Š 33â”Š        chat: {\n+â”Š   â”Š 34â”Š          id: '1',\n+â”Š   â”Š 35â”Š          __typename: 'Chat',\n+â”Š   â”Š 36â”Š        },\n+â”Š   â”Š 37â”Š        __typename: 'Message',\n+â”Š   â”Š 38â”Š        sender: {\n+â”Š   â”Š 39â”Š          id: '1',\n+â”Š   â”Š 40â”Š          __typename: 'User',\n+â”Š   â”Š 41â”Š          name: 'Niccolo\\' Belli',\n+â”Š   â”Š 42â”Š        },\n+â”Š   â”Š 43â”Š        content: 'Hello! How are you? A lot happened since last time',\n+â”Š   â”Š 44â”Š        createdAt: '1513435525',\n+â”Š   â”Š 45â”Š        type: 1,\n+â”Š   â”Š 46â”Š        recipients: [\n+â”Š   â”Š 47â”Š          {\n+â”Š   â”Š 48â”Š            user: {\n+â”Š   â”Š 49â”Š              id: '2',\n+â”Š   â”Š 50â”Š              __typename: 'User',\n+â”Š   â”Š 51â”Š            },\n+â”Š   â”Š 52â”Š            message: {\n+â”Š   â”Š 53â”Š              id: '1',\n+â”Š   â”Š 54â”Š              __typename: 'Message',\n+â”Š   â”Š 55â”Š              chat: {\n+â”Š   â”Š 56â”Š                id: '1',\n+â”Š   â”Š 57â”Š                __typename: 'Chat',\n+â”Š   â”Š 58â”Š              },\n+â”Š   â”Š 59â”Š            },\n+â”Š   â”Š 60â”Š            __typename: 'Recipient',\n+â”Š   â”Š 61â”Š            chat: {\n+â”Š   â”Š 62â”Š              id: '1',\n+â”Š   â”Š 63â”Š              __typename: 'Chat',\n+â”Š   â”Š 64â”Š            },\n+â”Š   â”Š 65â”Š            receivedAt: null,\n+â”Š   â”Š 66â”Š            readAt: null,\n+â”Š   â”Š 67â”Š          }\n+â”Š   â”Š 68â”Š        ],\n+â”Š   â”Š 69â”Š        ownership: true,\n+â”Š   â”Š 70â”Š      }\n+â”Š   â”Š 71â”Š    ],\n+â”Š   â”Š 72â”Š  };\n+â”Š   â”Š 73â”Š\n+â”Š   â”Š 74â”Š  beforeEach(async(() => {\n+â”Š   â”Š 75â”Š    TestBed.configureTestingModule({\n+â”Š   â”Š 76â”Š      declarations: [ ChatItemComponent ],\n+â”Š   â”Š 77â”Š      imports: [TruncateModule]\n+â”Š   â”Š 78â”Š    })\n+â”Š   â”Š 79â”Š    .compileComponents();\n+â”Š   â”Š 80â”Š  }));\n+â”Š   â”Š 81â”Š\n+â”Š   â”Š 82â”Š  beforeEach(() => {\n+â”Š   â”Š 83â”Š    fixture = TestBed.createComponent(ChatItemComponent);\n+â”Š   â”Š 84â”Š    component = fixture.componentInstance;\n+â”Š   â”Š 85â”Š    component.chat = chat;\n+â”Š   â”Š 86â”Š    fixture.detectChanges();\n+â”Š   â”Š 87â”Š    el = fixture.debugElement;\n+â”Š   â”Š 88â”Š  });\n+â”Š   â”Š 89â”Š\n+â”Š   â”Š 90â”Š  it('should create', () => {\n+â”Š   â”Š 91â”Š    expect(component).toBeTruthy();\n+â”Š   â”Š 92â”Š  });\n+â”Š   â”Š 93â”Š\n+â”Š   â”Š 94â”Š  it('should contain the chat name', () => {\n+â”Š   â”Š 95â”Š    expect(el.query(By.css('.chat-recipient > div:first-child')).nativeElement.textContent).toContain(chat.name);\n+â”Š   â”Š 96â”Š  });\n+â”Š   â”Š 97â”Š\n+â”Š   â”Š 98â”Š  it('should contain the first couple of characters of the message content', () => {\n+â”Š   â”Š 99â”Š    expect(el.query(By.css('.chat-content')).nativeElement.textContent)\n+â”Š   â”Š100â”Š      .toContain(chat.messages[chat.messages.length - 1].content.slice(0, 20));\n+â”Š   â”Š101â”Š  });\n+â”Š   â”Š102â”Š\n+â”Š   â”Š103â”Š  it('should not contain the latest characters of the message content', () => {\n+â”Š   â”Š104â”Š    expect(el.query(By.css('.chat-content')).nativeElement.textContent)\n+â”Š   â”Š105â”Š      .not.toContain(chat.messages[chat.messages.length - 1].content.slice(20));\n+â”Š   â”Š106â”Š  });\n+â”Š   â”Š107â”Š});\n```\n\n[}]: #\n\nTesting a service is a bit more complicated because we will need to mock our backend in order to get fake results instead of having to fire up the backend each time.\nWe are going to simply mock the HTTP calls, which is a well known practice in the REST API world. Since we are using HTTP to retrieve the data, it will work as well with Apollo client:\n\n[{]: <helper> (diffStep \"3.1\" files=\"src/app/services/chats.service.spec.ts\" module=\"client\")\n\n#### Step 3.1: Testing\n\n##### Added src&#x2F;app&#x2F;services&#x2F;chats.service.spec.ts\n```diff\n@@ -0,0 +1,356 @@\n+â”Š   â”Š  1â”Šimport { TestBed, inject } from '@angular/core/testing';\n+â”Š   â”Š  2â”Š\n+â”Š   â”Š  3â”Šimport { ChatsService } from './chats.service';\n+â”Š   â”Š  4â”Šimport {Apollo} from 'apollo-angular';\n+â”Š   â”Š  5â”Šimport {HttpLink, HttpLinkModule, Options} from 'apollo-angular-link-http';\n+â”Š   â”Š  6â”Šimport {HttpClientTestingModule, HttpTestingController} from '@angular/common/http/testing';\n+â”Š   â”Š  7â”Šimport {defaultDataIdFromObject, InMemoryCache} from 'apollo-cache-inmemory';\n+â”Š   â”Š  8â”Š\n+â”Š   â”Š  9â”Šdescribe('ChatsService', () => {\n+â”Š   â”Š 10â”Š  let httpMock: HttpTestingController;\n+â”Š   â”Š 11â”Š  let httpLink: HttpLink;\n+â”Š   â”Š 12â”Š  let apollo: Apollo;\n+â”Š   â”Š 13â”Š\n+â”Š   â”Š 14â”Š  const chats: any = [\n+â”Š   â”Š 15â”Š    {\n+â”Š   â”Š 16â”Š      id: '1',\n+â”Š   â”Š 17â”Š      __typename: 'Chat',\n+â”Š   â”Š 18â”Š      name: 'Avery Stewart',\n+â”Š   â”Š 19â”Š      picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n+â”Š   â”Š 20â”Š      allTimeMembers: [\n+â”Š   â”Š 21â”Š        {\n+â”Š   â”Š 22â”Š          id: '1',\n+â”Š   â”Š 23â”Š          __typename: 'User',\n+â”Š   â”Š 24â”Š        },\n+â”Š   â”Š 25â”Š        {\n+â”Š   â”Š 26â”Š          id: '3',\n+â”Š   â”Š 27â”Š          __typename: 'User',\n+â”Š   â”Š 28â”Š        }\n+â”Š   â”Š 29â”Š      ],\n+â”Š   â”Š 30â”Š      unreadMessages: 1,\n+â”Š   â”Š 31â”Š      isGroup: false,\n+â”Š   â”Š 32â”Š      messages: [\n+â”Š   â”Š 33â”Š        {\n+â”Š   â”Š 34â”Š          id: '1',\n+â”Š   â”Š 35â”Š          chat: {\n+â”Š   â”Š 36â”Š            id: '1',\n+â”Š   â”Š 37â”Š            __typename: 'Chat',\n+â”Š   â”Š 38â”Š          },\n+â”Š   â”Š 39â”Š          __typename: 'Message',\n+â”Š   â”Š 40â”Š          sender: {\n+â”Š   â”Š 41â”Š            id: '3',\n+â”Š   â”Š 42â”Š            __typename: 'User',\n+â”Š   â”Š 43â”Š            name: 'Avery Stewart'\n+â”Š   â”Š 44â”Š          },\n+â”Š   â”Š 45â”Š          content: 'Yep!',\n+â”Š   â”Š 46â”Š          createdAt: '1514035700',\n+â”Š   â”Š 47â”Š          type: 0,\n+â”Š   â”Š 48â”Š          recipients: [\n+â”Š   â”Š 49â”Š            {\n+â”Š   â”Š 50â”Š              user: {\n+â”Š   â”Š 51â”Š                id: '1',\n+â”Š   â”Š 52â”Š                __typename: 'User',\n+â”Š   â”Š 53â”Š              },\n+â”Š   â”Š 54â”Š              message: {\n+â”Š   â”Š 55â”Š                id: '1',\n+â”Š   â”Š 56â”Š                __typename: 'Message',\n+â”Š   â”Š 57â”Š                chat: {\n+â”Š   â”Š 58â”Š                  id: '1',\n+â”Š   â”Š 59â”Š                  __typename: 'Chat',\n+â”Š   â”Š 60â”Š                },\n+â”Š   â”Š 61â”Š              },\n+â”Š   â”Š 62â”Š              __typename: 'Recipient',\n+â”Š   â”Š 63â”Š              chat: {\n+â”Š   â”Š 64â”Š                id: '1',\n+â”Š   â”Š 65â”Š                __typename: 'Chat',\n+â”Š   â”Š 66â”Š              },\n+â”Š   â”Š 67â”Š              receivedAt: null,\n+â”Š   â”Š 68â”Š              readAt: null,\n+â”Š   â”Š 69â”Š            }\n+â”Š   â”Š 70â”Š          ],\n+â”Š   â”Š 71â”Š          ownership: false,\n+â”Š   â”Š 72â”Š        }\n+â”Š   â”Š 73â”Š      ],\n+â”Š   â”Š 74â”Š    },\n+â”Š   â”Š 75â”Š    {\n+â”Š   â”Š 76â”Š      id: '2',\n+â”Š   â”Š 77â”Š      __typename: 'Chat',\n+â”Š   â”Š 78â”Š      name: 'Katie Peterson',\n+â”Š   â”Š 79â”Š      picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n+â”Š   â”Š 80â”Š      allTimeMembers: [\n+â”Š   â”Š 81â”Š        {\n+â”Š   â”Š 82â”Š          id: '1',\n+â”Š   â”Š 83â”Š          __typename: 'User',\n+â”Š   â”Š 84â”Š        },\n+â”Š   â”Š 85â”Š        {\n+â”Š   â”Š 86â”Š          id: '4',\n+â”Š   â”Š 87â”Š          __typename: 'User',\n+â”Š   â”Š 88â”Š        }\n+â”Š   â”Š 89â”Š      ],\n+â”Š   â”Š 90â”Š      unreadMessages: 0,\n+â”Š   â”Š 91â”Š      isGroup: false,\n+â”Š   â”Š 92â”Š      messages: [\n+â”Š   â”Š 93â”Š        {\n+â”Š   â”Š 94â”Š          id: '1',\n+â”Š   â”Š 95â”Š          chat: {\n+â”Š   â”Š 96â”Š            id: '2',\n+â”Š   â”Š 97â”Š            __typename: 'Chat',\n+â”Š   â”Š 98â”Š          },\n+â”Š   â”Š 99â”Š          __typename: 'Message',\n+â”Š   â”Š100â”Š          sender: {\n+â”Š   â”Š101â”Š            id: '1',\n+â”Š   â”Š102â”Š            __typename: 'User',\n+â”Š   â”Š103â”Š            name: 'Ethan Gonzalez'\n+â”Š   â”Š104â”Š          },\n+â”Š   â”Š105â”Š          content: 'Hey, it\\'s me',\n+â”Š   â”Š106â”Š          createdAt: '1514031800',\n+â”Š   â”Š107â”Š          type: 0,\n+â”Š   â”Š108â”Š          recipients: [\n+â”Š   â”Š109â”Š            {\n+â”Š   â”Š110â”Š              user: {\n+â”Š   â”Š111â”Š                id: '4',\n+â”Š   â”Š112â”Š                __typename: 'User',\n+â”Š   â”Š113â”Š              },\n+â”Š   â”Š114â”Š              message: {\n+â”Š   â”Š115â”Š                id: '1',\n+â”Š   â”Š116â”Š                __typename: 'Message',\n+â”Š   â”Š117â”Š                chat: {\n+â”Š   â”Š118â”Š                  id: '2',\n+â”Š   â”Š119â”Š                  __typename: 'Chat',\n+â”Š   â”Š120â”Š                },\n+â”Š   â”Š121â”Š              },\n+â”Š   â”Š122â”Š              __typename: 'Recipient',\n+â”Š   â”Š123â”Š              chat: {\n+â”Š   â”Š124â”Š                id: '2',\n+â”Š   â”Š125â”Š                __typename: 'Chat',\n+â”Š   â”Š126â”Š              },\n+â”Š   â”Š127â”Š              receivedAt: null,\n+â”Š   â”Š128â”Š              readAt: null,\n+â”Š   â”Š129â”Š            }\n+â”Š   â”Š130â”Š          ],\n+â”Š   â”Š131â”Š          ownership: true\n+â”Š   â”Š132â”Š        }\n+â”Š   â”Š133â”Š      ],\n+â”Š   â”Š134â”Š    },\n+â”Š   â”Š135â”Š    {\n+â”Š   â”Š136â”Š      id: '3',\n+â”Š   â”Š137â”Š      __typename: 'Chat',\n+â”Š   â”Š138â”Š      name: 'Ray Edwards',\n+â”Š   â”Š139â”Š      picture: 'https://randomuser.me/api/portraits/thumb/men/3.jpg',\n+â”Š   â”Š140â”Š      allTimeMembers: [\n+â”Š   â”Š141â”Š        {\n+â”Š   â”Š142â”Š          id: '1',\n+â”Š   â”Š143â”Š          __typename: 'User',\n+â”Š   â”Š144â”Š        },\n+â”Š   â”Š145â”Š        {\n+â”Š   â”Š146â”Š          id: '5',\n+â”Š   â”Š147â”Š          __typename: 'User',\n+â”Š   â”Š148â”Š        }\n+â”Š   â”Š149â”Š      ],\n+â”Š   â”Š150â”Š      unreadMessages: 0,\n+â”Š   â”Š151â”Š      isGroup: false,\n+â”Š   â”Š152â”Š      messages: [\n+â”Š   â”Š153â”Š        {\n+â”Š   â”Š154â”Š          id: '1',\n+â”Š   â”Š155â”Š          __typename: 'Message',\n+â”Š   â”Š156â”Š          chat: {\n+â”Š   â”Š157â”Š            id: '3',\n+â”Š   â”Š158â”Š            __typename: 'Chat',\n+â”Š   â”Š159â”Š          },\n+â”Š   â”Š160â”Š          sender: {\n+â”Š   â”Š161â”Š            id: '1',\n+â”Š   â”Š162â”Š            __typename: 'User',\n+â”Š   â”Š163â”Š            name: 'Ethan Gonzalez'\n+â”Š   â”Š164â”Š          },\n+â”Š   â”Š165â”Š          content: 'You still there?',\n+â”Š   â”Š166â”Š          createdAt: '1514010200',\n+â”Š   â”Š167â”Š          type: 0,\n+â”Š   â”Š168â”Š          recipients: [\n+â”Š   â”Š169â”Š            {\n+â”Š   â”Š170â”Š              user: {\n+â”Š   â”Š171â”Š                id: '5',\n+â”Š   â”Š172â”Š                __typename: 'User',\n+â”Š   â”Š173â”Š              },\n+â”Š   â”Š174â”Š              message: {\n+â”Š   â”Š175â”Š                id: '1',\n+â”Š   â”Š176â”Š                __typename: 'Message',\n+â”Š   â”Š177â”Š                chat: {\n+â”Š   â”Š178â”Š                  id: '3',\n+â”Š   â”Š179â”Š                  __typename: 'Chat',\n+â”Š   â”Š180â”Š                },\n+â”Š   â”Š181â”Š              },\n+â”Š   â”Š182â”Š              __typename: 'Recipient',\n+â”Š   â”Š183â”Š              chat: {\n+â”Š   â”Š184â”Š                id: '3',\n+â”Š   â”Š185â”Š                __typename: 'Chat',\n+â”Š   â”Š186â”Š              },\n+â”Š   â”Š187â”Š              receivedAt: null,\n+â”Š   â”Š188â”Š              readAt: null\n+â”Š   â”Š189â”Š            }\n+â”Š   â”Š190â”Š          ],\n+â”Š   â”Š191â”Š          ownership: true\n+â”Š   â”Š192â”Š        }\n+â”Š   â”Š193â”Š      ],\n+â”Š   â”Š194â”Š    },\n+â”Š   â”Š195â”Š    {\n+â”Š   â”Š196â”Š      id: '6',\n+â”Š   â”Š197â”Š      __typename: 'Chat',\n+â”Š   â”Š198â”Š      name: 'NiccolÃ² Belli',\n+â”Š   â”Š199â”Š      picture: 'https://randomuser.me/api/portraits/thumb/men/4.jpg',\n+â”Š   â”Š200â”Š      allTimeMembers: [\n+â”Š   â”Š201â”Š        {\n+â”Š   â”Š202â”Š          id: '1',\n+â”Š   â”Š203â”Š          __typename: 'User',\n+â”Š   â”Š204â”Š        },\n+â”Š   â”Š205â”Š        {\n+â”Š   â”Š206â”Š          id: '6',\n+â”Š   â”Š207â”Š          __typename: 'User',\n+â”Š   â”Š208â”Š        }\n+â”Š   â”Š209â”Š      ],\n+â”Š   â”Š210â”Š      unreadMessages: 0,\n+â”Š   â”Š211â”Š      messages: [],\n+â”Š   â”Š212â”Š      isGroup: false\n+â”Š   â”Š213â”Š    },\n+â”Š   â”Š214â”Š    {\n+â”Š   â”Š215â”Š      id: '8',\n+â”Š   â”Š216â”Š      __typename: 'Chat',\n+â”Š   â”Š217â”Š      name: 'A user 0 group',\n+â”Š   â”Š218â”Š      picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n+â”Š   â”Š219â”Š      allTimeMembers: [\n+â”Š   â”Š220â”Š        {\n+â”Š   â”Š221â”Š          id: '1',\n+â”Š   â”Š222â”Š          __typename: 'User',\n+â”Š   â”Š223â”Š        },\n+â”Š   â”Š224â”Š        {\n+â”Š   â”Š225â”Š          id: '3',\n+â”Š   â”Š226â”Š          __typename: 'User',\n+â”Š   â”Š227â”Š        },\n+â”Š   â”Š228â”Š        {\n+â”Š   â”Š229â”Š          id: '4',\n+â”Š   â”Š230â”Š          __typename: 'User',\n+â”Š   â”Š231â”Š        },\n+â”Š   â”Š232â”Š        {\n+â”Š   â”Š233â”Š          id: '6',\n+â”Š   â”Š234â”Š          __typename: 'User',\n+â”Š   â”Š235â”Š        },\n+â”Š   â”Š236â”Š      ],\n+â”Š   â”Š237â”Š      unreadMessages: 1,\n+â”Š   â”Š238â”Š      isGroup: true,\n+â”Š   â”Š239â”Š      messages: [\n+â”Š   â”Š240â”Š        {\n+â”Š   â”Š241â”Š          id: '1',\n+â”Š   â”Š242â”Š          __typename: 'Message',\n+â”Š   â”Š243â”Š          chat: {\n+â”Š   â”Š244â”Š            id: '8',\n+â”Š   â”Š245â”Š            __typename: 'Chat',\n+â”Š   â”Š246â”Š          },\n+â”Š   â”Š247â”Š          sender: {\n+â”Š   â”Š248â”Š            id: '4',\n+â”Š   â”Š249â”Š            __typename: 'User',\n+â”Š   â”Š250â”Š            name: 'Katie Peterson'\n+â”Š   â”Š251â”Š          },\n+â”Š   â”Š252â”Š          content: 'Awesome!',\n+â”Š   â”Š253â”Š          createdAt: '1512830000',\n+â”Š   â”Š254â”Š          type: 0,\n+â”Š   â”Š255â”Š          recipients: [\n+â”Š   â”Š256â”Š            {\n+â”Š   â”Š257â”Š              user: {\n+â”Š   â”Š258â”Š                id: '1',\n+â”Š   â”Š259â”Š                __typename: 'User',\n+â”Š   â”Š260â”Š              },\n+â”Š   â”Š261â”Š              message: {\n+â”Š   â”Š262â”Š                id: '1',\n+â”Š   â”Š263â”Š                __typename: 'Message',\n+â”Š   â”Š264â”Š                chat: {\n+â”Š   â”Š265â”Š                  id: '8',\n+â”Š   â”Š266â”Š                  __typename: 'Chat',\n+â”Š   â”Š267â”Š                },\n+â”Š   â”Š268â”Š              },\n+â”Š   â”Š269â”Š              __typename: 'Recipient',\n+â”Š   â”Š270â”Š              chat: {\n+â”Š   â”Š271â”Š                id: '8',\n+â”Š   â”Š272â”Š                __typename: 'Chat',\n+â”Š   â”Š273â”Š              },\n+â”Š   â”Š274â”Š              receivedAt: null,\n+â”Š   â”Š275â”Š              readAt: null\n+â”Š   â”Š276â”Š            },\n+â”Š   â”Š277â”Š            {\n+â”Š   â”Š278â”Š              user: {\n+â”Š   â”Š279â”Š                id: '6',\n+â”Š   â”Š280â”Š                __typename: 'User',\n+â”Š   â”Š281â”Š              },\n+â”Š   â”Š282â”Š              message: {\n+â”Š   â”Š283â”Š                id: '1',\n+â”Š   â”Š284â”Š                __typename: 'Message',\n+â”Š   â”Š285â”Š                chat: {\n+â”Š   â”Š286â”Š                  id: '8',\n+â”Š   â”Š287â”Š                  __typename: 'Chat',\n+â”Š   â”Š288â”Š                },\n+â”Š   â”Š289â”Š              },\n+â”Š   â”Š290â”Š              __typename: 'Recipient',\n+â”Š   â”Š291â”Š              chat: {\n+â”Š   â”Š292â”Š                id: '8',\n+â”Š   â”Š293â”Š                __typename: 'Chat',\n+â”Š   â”Š294â”Š              },\n+â”Š   â”Š295â”Š              receivedAt: null,\n+â”Š   â”Š296â”Š              readAt: null\n+â”Š   â”Š297â”Š            }\n+â”Š   â”Š298â”Š          ],\n+â”Š   â”Š299â”Š          ownership: false\n+â”Š   â”Š300â”Š        }\n+â”Š   â”Š301â”Š      ],\n+â”Š   â”Š302â”Š    },\n+â”Š   â”Š303â”Š  ];\n+â”Š   â”Š304â”Š\n+â”Š   â”Š305â”Š  beforeEach(() => {\n+â”Š   â”Š306â”Š    TestBed.configureTestingModule({\n+â”Š   â”Š307â”Š      imports: [\n+â”Š   â”Š308â”Š        HttpLinkModule,\n+â”Š   â”Š309â”Š        // HttpClientModule,\n+â”Š   â”Š310â”Š        HttpClientTestingModule,\n+â”Š   â”Š311â”Š      ],\n+â”Š   â”Š312â”Š      providers: [\n+â”Š   â”Š313â”Š        ChatsService,\n+â”Š   â”Š314â”Š        Apollo,\n+â”Š   â”Š315â”Š      ]\n+â”Š   â”Š316â”Š    });\n+â”Š   â”Š317â”Š\n+â”Š   â”Š318â”Š    httpMock = TestBed.get(HttpTestingController);\n+â”Š   â”Š319â”Š    httpLink = TestBed.get(HttpLink);\n+â”Š   â”Š320â”Š    apollo = TestBed.get(Apollo);\n+â”Š   â”Š321â”Š\n+â”Š   â”Š322â”Š    apollo.create({\n+â”Š   â”Š323â”Š      link: httpLink.create(<Options>{ uri: 'http://localhost:3000/graphql' }),\n+â”Š   â”Š324â”Š      cache: new InMemoryCache({\n+â”Š   â”Š325â”Š        dataIdFromObject: (object: any) => {\n+â”Š   â”Š326â”Š          switch (object.__typename) {\n+â”Š   â”Š327â”Š            case 'Message': return `${object.chat.id}:${object.id}`; // use `chatId` prefix and `messageId` as the primary key\n+â”Š   â”Š328â”Š            default: return defaultDataIdFromObject(object); // fall back to default handling\n+â”Š   â”Š329â”Š          }\n+â”Š   â”Š330â”Š        }\n+â”Š   â”Š331â”Š      }),\n+â”Š   â”Š332â”Š    });\n+â”Š   â”Š333â”Š  });\n+â”Š   â”Š334â”Š\n+â”Š   â”Š335â”Š  it('should be created', inject([ChatsService], (service: ChatsService) => {\n+â”Š   â”Š336â”Š    expect(service).toBeTruthy();\n+â”Š   â”Š337â”Š  }));\n+â”Š   â”Š338â”Š\n+â”Š   â”Š339â”Š  it('should get chats', inject([ChatsService], (service: ChatsService) => {\n+â”Š   â”Š340â”Š    service.getChats().chats$.subscribe(_chats => {\n+â”Š   â”Š341â”Š      expect(_chats.length).toEqual(chats.length);\n+â”Š   â”Š342â”Š      for (let i = 0; i < _chats.length; i++) {\n+â”Š   â”Š343â”Š        expect(_chats[i]).toEqual(chats[i]);\n+â”Š   â”Š344â”Š      }\n+â”Š   â”Š345â”Š    });\n+â”Š   â”Š346â”Š\n+â”Š   â”Š347â”Š    const req = httpMock.expectOne('http://localhost:3000/graphql', 'call to api');\n+â”Š   â”Š348â”Š    expect(req.request.method).toBe('POST');\n+â”Š   â”Š349â”Š    req.flush({\n+â”Š   â”Š350â”Š      data: {\n+â”Š   â”Š351â”Š        chats\n+â”Š   â”Š352â”Š      }\n+â”Š   â”Š353â”Š    });\n+â”Š   â”Š354â”Š    httpMock.verify();\n+â”Š   â”Š355â”Š  }));\n+â”Š   â”Š356â”Š});\n```\n\n[}]: #\n\nIn the last example we are going to test a container component, which makes use of several services and multiple other components:\n\n[{]: <helper> (diffStep \"3.1\" files=\"src/app/chats-lister/containers/chats/chats.component.spec.ts\" module=\"client\")\n\n#### Step 3.1: Testing\n\n##### Added src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.spec.ts\n```diff\n@@ -0,0 +1,387 @@\n+â”Š   â”Š  1â”Šimport { async, ComponentFixture, TestBed } from '@angular/core/testing';\n+â”Š   â”Š  2â”Š\n+â”Š   â”Š  3â”Šimport { ChatsComponent } from './chats.component';\n+â”Š   â”Š  4â”Šimport {DebugElement, NO_ERRORS_SCHEMA} from '@angular/core';\n+â”Š   â”Š  5â”Šimport {ChatsListComponent} from '../../components/chats-list/chats-list.component';\n+â”Š   â”Š  6â”Šimport {ChatItemComponent} from '../../components/chat-item/chat-item.component';\n+â”Š   â”Š  7â”Šimport {TruncateModule} from 'ng2-truncate';\n+â”Š   â”Š  8â”Šimport {MatButtonModule, MatIconModule, MatListModule, MatMenuModule} from '@angular/material';\n+â”Š   â”Š  9â”Šimport {ChatsService} from '../../../services/chats.service';\n+â”Š   â”Š 10â”Šimport {Apollo} from 'apollo-angular';\n+â”Š   â”Š 11â”Šimport {HttpClientTestingModule, HttpTestingController} from '@angular/common/http/testing';\n+â”Š   â”Š 12â”Šimport {HttpLink, HttpLinkModule, Options} from 'apollo-angular-link-http';\n+â”Š   â”Š 13â”Šimport {defaultDataIdFromObject, InMemoryCache} from 'apollo-cache-inmemory';\n+â”Š   â”Š 14â”Šimport {By} from '@angular/platform-browser';\n+â”Š   â”Š 15â”Šimport {RouterTestingModule} from '@angular/router/testing';\n+â”Š   â”Š 16â”Š\n+â”Š   â”Š 17â”Šdescribe('ChatsComponent', () => {\n+â”Š   â”Š 18â”Š  let component: ChatsComponent;\n+â”Š   â”Š 19â”Š  let fixture: ComponentFixture<ChatsComponent>;\n+â”Š   â”Š 20â”Š  let el: DebugElement;\n+â”Š   â”Š 21â”Š\n+â”Š   â”Š 22â”Š  let httpMock: HttpTestingController;\n+â”Š   â”Š 23â”Š  let httpLink: HttpLink;\n+â”Š   â”Š 24â”Š  let apollo: Apollo;\n+â”Š   â”Š 25â”Š\n+â”Š   â”Š 26â”Š  const chats: any = [\n+â”Š   â”Š 27â”Š    {\n+â”Š   â”Š 28â”Š      id: '1',\n+â”Š   â”Š 29â”Š      __typename: 'Chat',\n+â”Š   â”Š 30â”Š      name: 'Avery Stewart',\n+â”Š   â”Š 31â”Š      picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n+â”Š   â”Š 32â”Š      allTimeMembers: [\n+â”Š   â”Š 33â”Š        {\n+â”Š   â”Š 34â”Š          id: '1',\n+â”Š   â”Š 35â”Š          __typename: 'User',\n+â”Š   â”Š 36â”Š        },\n+â”Š   â”Š 37â”Š        {\n+â”Š   â”Š 38â”Š          id: '3',\n+â”Š   â”Š 39â”Š          __typename: 'User',\n+â”Š   â”Š 40â”Š        }\n+â”Š   â”Š 41â”Š      ],\n+â”Š   â”Š 42â”Š      unreadMessages: 1,\n+â”Š   â”Š 43â”Š      isGroup: false,\n+â”Š   â”Š 44â”Š      messages: [\n+â”Š   â”Š 45â”Š        {\n+â”Š   â”Š 46â”Š          id: '1',\n+â”Š   â”Š 47â”Š          chat: {\n+â”Š   â”Š 48â”Š            id: '1',\n+â”Š   â”Š 49â”Š            __typename: 'Chat',\n+â”Š   â”Š 50â”Š          },\n+â”Š   â”Š 51â”Š          __typename: 'Message',\n+â”Š   â”Š 52â”Š          sender: {\n+â”Š   â”Š 53â”Š            id: '3',\n+â”Š   â”Š 54â”Š            __typename: 'User',\n+â”Š   â”Š 55â”Š            name: 'Avery Stewart'\n+â”Š   â”Š 56â”Š          },\n+â”Š   â”Š 57â”Š          content: 'Yep!',\n+â”Š   â”Š 58â”Š          createdAt: '1514035700',\n+â”Š   â”Š 59â”Š          type: 0,\n+â”Š   â”Š 60â”Š          recipients: [\n+â”Š   â”Š 61â”Š            {\n+â”Š   â”Š 62â”Š              user: {\n+â”Š   â”Š 63â”Š                id: '1',\n+â”Š   â”Š 64â”Š                __typename: 'User',\n+â”Š   â”Š 65â”Š              },\n+â”Š   â”Š 66â”Š              message: {\n+â”Š   â”Š 67â”Š                id: '1',\n+â”Š   â”Š 68â”Š                __typename: 'Message',\n+â”Š   â”Š 69â”Š                chat: {\n+â”Š   â”Š 70â”Š                  id: '1',\n+â”Š   â”Š 71â”Š                  __typename: 'Chat',\n+â”Š   â”Š 72â”Š                },\n+â”Š   â”Š 73â”Š              },\n+â”Š   â”Š 74â”Š              __typename: 'Recipient',\n+â”Š   â”Š 75â”Š              chat: {\n+â”Š   â”Š 76â”Š                id: '1',\n+â”Š   â”Š 77â”Š                __typename: 'Chat',\n+â”Š   â”Š 78â”Š              },\n+â”Š   â”Š 79â”Š              receivedAt: null,\n+â”Š   â”Š 80â”Š              readAt: null,\n+â”Š   â”Š 81â”Š            }\n+â”Š   â”Š 82â”Š          ],\n+â”Š   â”Š 83â”Š          ownership: false,\n+â”Š   â”Š 84â”Š        }\n+â”Š   â”Š 85â”Š      ],\n+â”Š   â”Š 86â”Š    },\n+â”Š   â”Š 87â”Š    {\n+â”Š   â”Š 88â”Š      id: '2',\n+â”Š   â”Š 89â”Š      __typename: 'Chat',\n+â”Š   â”Š 90â”Š      name: 'Katie Peterson',\n+â”Š   â”Š 91â”Š      picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n+â”Š   â”Š 92â”Š      allTimeMembers: [\n+â”Š   â”Š 93â”Š        {\n+â”Š   â”Š 94â”Š          id: '1',\n+â”Š   â”Š 95â”Š          __typename: 'User',\n+â”Š   â”Š 96â”Š        },\n+â”Š   â”Š 97â”Š        {\n+â”Š   â”Š 98â”Š          id: '4',\n+â”Š   â”Š 99â”Š          __typename: 'User',\n+â”Š   â”Š100â”Š        }\n+â”Š   â”Š101â”Š      ],\n+â”Š   â”Š102â”Š      unreadMessages: 0,\n+â”Š   â”Š103â”Š      isGroup: false,\n+â”Š   â”Š104â”Š      messages: [\n+â”Š   â”Š105â”Š        {\n+â”Š   â”Š106â”Š          id: '1',\n+â”Š   â”Š107â”Š          chat: {\n+â”Š   â”Š108â”Š            id: '2',\n+â”Š   â”Š109â”Š            __typename: 'Chat',\n+â”Š   â”Š110â”Š          },\n+â”Š   â”Š111â”Š          __typename: 'Message',\n+â”Š   â”Š112â”Š          sender: {\n+â”Š   â”Š113â”Š            id: '1',\n+â”Š   â”Š114â”Š            __typename: 'User',\n+â”Š   â”Š115â”Š            name: 'Ethan Gonzalez'\n+â”Š   â”Š116â”Š          },\n+â”Š   â”Š117â”Š          content: 'Hey, it\\'s me',\n+â”Š   â”Š118â”Š          createdAt: '1514031800',\n+â”Š   â”Š119â”Š          type: 0,\n+â”Š   â”Š120â”Š          recipients: [\n+â”Š   â”Š121â”Š            {\n+â”Š   â”Š122â”Š              user: {\n+â”Š   â”Š123â”Š                id: '4',\n+â”Š   â”Š124â”Š                __typename: 'User',\n+â”Š   â”Š125â”Š              },\n+â”Š   â”Š126â”Š              message: {\n+â”Š   â”Š127â”Š                id: '1',\n+â”Š   â”Š128â”Š                __typename: 'Message',\n+â”Š   â”Š129â”Š                chat: {\n+â”Š   â”Š130â”Š                  id: '2',\n+â”Š   â”Š131â”Š                  __typename: 'Chat',\n+â”Š   â”Š132â”Š                },\n+â”Š   â”Š133â”Š              },\n+â”Š   â”Š134â”Š              __typename: 'Recipient',\n+â”Š   â”Š135â”Š              chat: {\n+â”Š   â”Š136â”Š                id: '2',\n+â”Š   â”Š137â”Š                __typename: 'Chat',\n+â”Š   â”Š138â”Š              },\n+â”Š   â”Š139â”Š              receivedAt: null,\n+â”Š   â”Š140â”Š              readAt: null,\n+â”Š   â”Š141â”Š            }\n+â”Š   â”Š142â”Š          ],\n+â”Š   â”Š143â”Š          ownership: true\n+â”Š   â”Š144â”Š        }\n+â”Š   â”Š145â”Š      ],\n+â”Š   â”Š146â”Š    },\n+â”Š   â”Š147â”Š    {\n+â”Š   â”Š148â”Š      id: '3',\n+â”Š   â”Š149â”Š      __typename: 'Chat',\n+â”Š   â”Š150â”Š      name: 'Ray Edwards',\n+â”Š   â”Š151â”Š      picture: 'https://randomuser.me/api/portraits/thumb/men/3.jpg',\n+â”Š   â”Š152â”Š      allTimeMembers: [\n+â”Š   â”Š153â”Š        {\n+â”Š   â”Š154â”Š          id: '1',\n+â”Š   â”Š155â”Š          __typename: 'User',\n+â”Š   â”Š156â”Š        },\n+â”Š   â”Š157â”Š        {\n+â”Š   â”Š158â”Š          id: '5',\n+â”Š   â”Š159â”Š          __typename: 'User',\n+â”Š   â”Š160â”Š        }\n+â”Š   â”Š161â”Š      ],\n+â”Š   â”Š162â”Š      unreadMessages: 0,\n+â”Š   â”Š163â”Š      isGroup: false,\n+â”Š   â”Š164â”Š      messages: [\n+â”Š   â”Š165â”Š        {\n+â”Š   â”Š166â”Š          id: '1',\n+â”Š   â”Š167â”Š          __typename: 'Message',\n+â”Š   â”Š168â”Š          chat: {\n+â”Š   â”Š169â”Š            id: '3',\n+â”Š   â”Š170â”Š            __typename: 'Chat',\n+â”Š   â”Š171â”Š          },\n+â”Š   â”Š172â”Š          sender: {\n+â”Š   â”Š173â”Š            id: '1',\n+â”Š   â”Š174â”Š            __typename: 'User',\n+â”Š   â”Š175â”Š            name: 'Ethan Gonzalez'\n+â”Š   â”Š176â”Š          },\n+â”Š   â”Š177â”Š          content: 'You still there?',\n+â”Š   â”Š178â”Š          createdAt: '1514010200',\n+â”Š   â”Š179â”Š          type: 0,\n+â”Š   â”Š180â”Š          recipients: [\n+â”Š   â”Š181â”Š            {\n+â”Š   â”Š182â”Š              user: {\n+â”Š   â”Š183â”Š                id: '5',\n+â”Š   â”Š184â”Š                __typename: 'User',\n+â”Š   â”Š185â”Š              },\n+â”Š   â”Š186â”Š              message: {\n+â”Š   â”Š187â”Š                id: '1',\n+â”Š   â”Š188â”Š                __typename: 'Message',\n+â”Š   â”Š189â”Š                chat: {\n+â”Š   â”Š190â”Š                  id: '3',\n+â”Š   â”Š191â”Š                  __typename: 'Chat',\n+â”Š   â”Š192â”Š                },\n+â”Š   â”Š193â”Š              },\n+â”Š   â”Š194â”Š              __typename: 'Recipient',\n+â”Š   â”Š195â”Š              chat: {\n+â”Š   â”Š196â”Š                id: '3',\n+â”Š   â”Š197â”Š                __typename: 'Chat',\n+â”Š   â”Š198â”Š              },\n+â”Š   â”Š199â”Š              receivedAt: null,\n+â”Š   â”Š200â”Š              readAt: null\n+â”Š   â”Š201â”Š            }\n+â”Š   â”Š202â”Š          ],\n+â”Š   â”Š203â”Š          ownership: true\n+â”Š   â”Š204â”Š        }\n+â”Š   â”Š205â”Š      ],\n+â”Š   â”Š206â”Š    },\n+â”Š   â”Š207â”Š    {\n+â”Š   â”Š208â”Š      id: '6',\n+â”Š   â”Š209â”Š      __typename: 'Chat',\n+â”Š   â”Š210â”Š      name: 'NiccolÃ² Belli',\n+â”Š   â”Š211â”Š      picture: 'https://randomuser.me/api/portraits/thumb/men/4.jpg',\n+â”Š   â”Š212â”Š      allTimeMembers: [\n+â”Š   â”Š213â”Š        {\n+â”Š   â”Š214â”Š          id: '1',\n+â”Š   â”Š215â”Š          __typename: 'User',\n+â”Š   â”Š216â”Š        },\n+â”Š   â”Š217â”Š        {\n+â”Š   â”Š218â”Š          id: '6',\n+â”Š   â”Š219â”Š          __typename: 'User',\n+â”Š   â”Š220â”Š        }\n+â”Š   â”Š221â”Š      ],\n+â”Š   â”Š222â”Š      unreadMessages: 0,\n+â”Š   â”Š223â”Š      messages: [],\n+â”Š   â”Š224â”Š      isGroup: false\n+â”Š   â”Š225â”Š    },\n+â”Š   â”Š226â”Š    {\n+â”Š   â”Š227â”Š      id: '8',\n+â”Š   â”Š228â”Š      __typename: 'Chat',\n+â”Š   â”Š229â”Š      name: 'A user 0 group',\n+â”Š   â”Š230â”Š      picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n+â”Š   â”Š231â”Š      allTimeMembers: [\n+â”Š   â”Š232â”Š        {\n+â”Š   â”Š233â”Š          id: '1',\n+â”Š   â”Š234â”Š          __typename: 'User',\n+â”Š   â”Š235â”Š        },\n+â”Š   â”Š236â”Š        {\n+â”Š   â”Š237â”Š          id: '3',\n+â”Š   â”Š238â”Š          __typename: 'User',\n+â”Š   â”Š239â”Š        },\n+â”Š   â”Š240â”Š        {\n+â”Š   â”Š241â”Š          id: '4',\n+â”Š   â”Š242â”Š          __typename: 'User',\n+â”Š   â”Š243â”Š        },\n+â”Š   â”Š244â”Š        {\n+â”Š   â”Š245â”Š          id: '6',\n+â”Š   â”Š246â”Š          __typename: 'User',\n+â”Š   â”Š247â”Š        },\n+â”Š   â”Š248â”Š      ],\n+â”Š   â”Š249â”Š      unreadMessages: 1,\n+â”Š   â”Š250â”Š      isGroup: true,\n+â”Š   â”Š251â”Š      messages: [\n+â”Š   â”Š252â”Š        {\n+â”Š   â”Š253â”Š          id: '1',\n+â”Š   â”Š254â”Š          __typename: 'Message',\n+â”Š   â”Š255â”Š          chat: {\n+â”Š   â”Š256â”Š            id: '8',\n+â”Š   â”Š257â”Š            __typename: 'Chat',\n+â”Š   â”Š258â”Š          },\n+â”Š   â”Š259â”Š          sender: {\n+â”Š   â”Š260â”Š            id: '4',\n+â”Š   â”Š261â”Š            __typename: 'User',\n+â”Š   â”Š262â”Š            name: 'Katie Peterson'\n+â”Š   â”Š263â”Š          },\n+â”Š   â”Š264â”Š          content: 'Awesome!',\n+â”Š   â”Š265â”Š          createdAt: '1512830000',\n+â”Š   â”Š266â”Š          type: 0,\n+â”Š   â”Š267â”Š          recipients: [\n+â”Š   â”Š268â”Š            {\n+â”Š   â”Š269â”Š              user: {\n+â”Š   â”Š270â”Š                id: '1',\n+â”Š   â”Š271â”Š                __typename: 'User',\n+â”Š   â”Š272â”Š              },\n+â”Š   â”Š273â”Š              message: {\n+â”Š   â”Š274â”Š                id: '1',\n+â”Š   â”Š275â”Š                __typename: 'Message',\n+â”Š   â”Š276â”Š                chat: {\n+â”Š   â”Š277â”Š                  id: '8',\n+â”Š   â”Š278â”Š                  __typename: 'Chat',\n+â”Š   â”Š279â”Š                },\n+â”Š   â”Š280â”Š              },\n+â”Š   â”Š281â”Š              __typename: 'Recipient',\n+â”Š   â”Š282â”Š              chat: {\n+â”Š   â”Š283â”Š                id: '8',\n+â”Š   â”Š284â”Š                __typename: 'Chat',\n+â”Š   â”Š285â”Š              },\n+â”Š   â”Š286â”Š              receivedAt: null,\n+â”Š   â”Š287â”Š              readAt: null\n+â”Š   â”Š288â”Š            },\n+â”Š   â”Š289â”Š            {\n+â”Š   â”Š290â”Š              user: {\n+â”Š   â”Š291â”Š                id: '6',\n+â”Š   â”Š292â”Š                __typename: 'User',\n+â”Š   â”Š293â”Š              },\n+â”Š   â”Š294â”Š              message: {\n+â”Š   â”Š295â”Š                id: '1',\n+â”Š   â”Š296â”Š                __typename: 'Message',\n+â”Š   â”Š297â”Š                chat: {\n+â”Š   â”Š298â”Š                  id: '8',\n+â”Š   â”Š299â”Š                  __typename: 'Chat',\n+â”Š   â”Š300â”Š                },\n+â”Š   â”Š301â”Š              },\n+â”Š   â”Š302â”Š              __typename: 'Recipient',\n+â”Š   â”Š303â”Š              chat: {\n+â”Š   â”Š304â”Š                id: '8',\n+â”Š   â”Š305â”Š                __typename: 'Chat',\n+â”Š   â”Š306â”Š              },\n+â”Š   â”Š307â”Š              receivedAt: null,\n+â”Š   â”Š308â”Š              readAt: null\n+â”Š   â”Š309â”Š            }\n+â”Š   â”Š310â”Š          ],\n+â”Š   â”Š311â”Š          ownership: false\n+â”Š   â”Š312â”Š        }\n+â”Š   â”Š313â”Š      ],\n+â”Š   â”Š314â”Š    },\n+â”Š   â”Š315â”Š  ];\n+â”Š   â”Š316â”Š\n+â”Š   â”Š317â”Š  beforeEach(async(() => {\n+â”Š   â”Š318â”Š    TestBed.configureTestingModule({\n+â”Š   â”Š319â”Š      declarations: [\n+â”Š   â”Š320â”Š        ChatsComponent,\n+â”Š   â”Š321â”Š        ChatsListComponent,\n+â”Š   â”Š322â”Š        ChatItemComponent\n+â”Š   â”Š323â”Š      ],\n+â”Š   â”Š324â”Š      imports: [\n+â”Š   â”Š325â”Š        MatMenuModule,\n+â”Š   â”Š326â”Š        MatIconModule,\n+â”Š   â”Š327â”Š        MatButtonModule,\n+â”Š   â”Š328â”Š        MatListModule,\n+â”Š   â”Š329â”Š        TruncateModule,\n+â”Š   â”Š330â”Š        HttpLinkModule,\n+â”Š   â”Š331â”Š        HttpClientTestingModule,\n+â”Š   â”Š332â”Š        RouterTestingModule\n+â”Š   â”Š333â”Š      ],\n+â”Š   â”Š334â”Š      providers: [\n+â”Š   â”Š335â”Š        ChatsService,\n+â”Š   â”Š336â”Š        Apollo,\n+â”Š   â”Š337â”Š      ],\n+â”Š   â”Š338â”Š      schemas: [NO_ERRORS_SCHEMA]\n+â”Š   â”Š339â”Š    })\n+â”Š   â”Š340â”Š      .compileComponents();\n+â”Š   â”Š341â”Š\n+â”Š   â”Š342â”Š    httpMock = TestBed.get(HttpTestingController);\n+â”Š   â”Š343â”Š    httpLink = TestBed.get(HttpLink);\n+â”Š   â”Š344â”Š    apollo = TestBed.get(Apollo);\n+â”Š   â”Š345â”Š\n+â”Š   â”Š346â”Š    apollo.create({\n+â”Š   â”Š347â”Š      link: httpLink.create(<Options>{ uri: 'http://localhost:3000/graphql' }),\n+â”Š   â”Š348â”Š      cache: new InMemoryCache({\n+â”Š   â”Š349â”Š        dataIdFromObject: (object: any) => {\n+â”Š   â”Š350â”Š          switch (object.__typename) {\n+â”Š   â”Š351â”Š            case 'Message': return `${object.chat.id}:${object.id}`; // use `chatId` prefix and `messageId` as the primary key\n+â”Š   â”Š352â”Š            default: return defaultDataIdFromObject(object); // fall back to default handling\n+â”Š   â”Š353â”Š          }\n+â”Š   â”Š354â”Š        }\n+â”Š   â”Š355â”Š      }),\n+â”Š   â”Š356â”Š    });\n+â”Š   â”Š357â”Š  }));\n+â”Š   â”Š358â”Š\n+â”Š   â”Š359â”Š  beforeEach(() => {\n+â”Š   â”Š360â”Š    fixture = TestBed.createComponent(ChatsComponent);\n+â”Š   â”Š361â”Š    component = fixture.componentInstance;\n+â”Š   â”Š362â”Š    fixture.detectChanges();\n+â”Š   â”Š363â”Š    const req = httpMock.expectOne('http://localhost:3000/graphql', 'call to api');\n+â”Š   â”Š364â”Š    req.flush({\n+â”Š   â”Š365â”Š      data: {\n+â”Š   â”Š366â”Š        chats\n+â”Š   â”Š367â”Š      }\n+â”Š   â”Š368â”Š    });\n+â”Š   â”Š369â”Š  });\n+â”Š   â”Š370â”Š\n+â”Š   â”Š371â”Š  it('should create', () => {\n+â”Š   â”Š372â”Š    expect(component).toBeTruthy();\n+â”Š   â”Š373â”Š  });\n+â”Š   â”Š374â”Š\n+â”Š   â”Š375â”Š  it('should display the chats', () => {\n+â”Š   â”Š376â”Š    fixture.whenStable().then(() => {\n+â”Š   â”Š377â”Š      fixture.detectChanges();\n+â”Š   â”Š378â”Š      el = fixture.debugElement;\n+â”Š   â”Š379â”Š      for (let i = 0; i < chats.length; i++) {\n+â”Š   â”Š380â”Š        expect(el.query(By.css(`app-chats-list > mat-list > mat-list-item:nth-child(${i + 1}) > div > app-chat-item > div > div > div`))\n+â”Š   â”Š381â”Š          .nativeElement.textContent).toContain(chats[i].name);\n+â”Š   â”Š382â”Š      }\n+â”Š   â”Š383â”Š    });\n+â”Š   â”Š384â”Š\n+â”Š   â”Š385â”Š    httpMock.verify();\n+â”Š   â”Š386â”Š  });\n+â”Š   â”Š387â”Š});\n```\n\n[}]: #"
          },
          {
            "manualTitle": "Step 8: Chat viewer",
            "stepRevision": "5d71e5522b20c3dc88a6d24c00d874bcd8b36e37",
            "manualView": "We created a module which lists all of our chats, but we still need to show a particular chat.\nLet's create the `chat-viewer` module! We're going to create a container component called `ChatComponent` and a couple of presentational components.\n\n[{]: <helper> (diffStep \"4.1\" module=\"client\")\n\n#### Step 4.1: Chat Viewer\n\n##### Changed src&#x2F;app&#x2F;app.module.ts\n```diff\n@@ -9,6 +9,7 @@\n â”Š 9â”Š 9â”Šimport {defaultDataIdFromObject, InMemoryCache} from 'apollo-cache-inmemory';\n â”Š10â”Š10â”Šimport {ChatsListerModule} from './chats-lister/chats-lister.module';\n â”Š11â”Š11â”Šimport {RouterModule, Routes} from '@angular/router';\n+â”Š  â”Š12â”Šimport {ChatViewerModule} from './chat-viewer/chat-viewer.module';\n â”Š12â”Š13â”Š\n â”Š13â”Š14â”Šconst routes: Routes = [];\n â”Š14â”Š15â”Š\n```\n```diff\n@@ -26,6 +27,7 @@\n â”Š26â”Š27â”Š    RouterModule.forRoot(routes),\n â”Š27â”Š28â”Š    // Feature modules\n â”Š28â”Š29â”Š    ChatsListerModule,\n+â”Š  â”Š30â”Š    ChatViewerModule,\n â”Š29â”Š31â”Š  ],\n â”Š30â”Š32â”Š  providers: [],\n â”Š31â”Š33â”Š  bootstrap: [AppComponent]\n```\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;chat-viewer.module.ts\n```diff\n@@ -0,0 +1,53 @@\n+â”Š  â”Š 1â”Šimport { BrowserModule } from '@angular/platform-browser';\n+â”Š  â”Š 2â”Šimport { NgModule } from '@angular/core';\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šimport {BrowserAnimationsModule} from '@angular/platform-browser/animations';\n+â”Š  â”Š 5â”Šimport {MatButtonModule, MatGridListModule, MatIconModule, MatListModule, MatMenuModule, MatToolbarModule} from '@angular/material';\n+â”Š  â”Š 6â”Šimport {RouterModule, Routes} from '@angular/router';\n+â”Š  â”Š 7â”Šimport {FormsModule} from '@angular/forms';\n+â”Š  â”Š 8â”Šimport {ChatsService} from '../services/chats.service';\n+â”Š  â”Š 9â”Šimport {ChatComponent} from './containers/chat/chat.component';\n+â”Š  â”Š10â”Šimport {MessagesListComponent} from './components/messages-list/messages-list.component';\n+â”Š  â”Š11â”Šimport {MessageItemComponent} from './components/message-item/message-item.component';\n+â”Š  â”Š12â”Šimport {NewMessageComponent} from './components/new-message/new-message.component';\n+â”Š  â”Š13â”Šimport {SharedModule} from '../shared/shared.module';\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”Šconst routes: Routes = [\n+â”Š  â”Š16â”Š  {\n+â”Š  â”Š17â”Š    path: 'chat', children: [\n+â”Š  â”Š18â”Š      {path: ':id', component: ChatComponent},\n+â”Š  â”Š19â”Š    ],\n+â”Š  â”Š20â”Š  },\n+â”Š  â”Š21â”Š];\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Š@NgModule({\n+â”Š  â”Š24â”Š  declarations: [\n+â”Š  â”Š25â”Š    ChatComponent,\n+â”Š  â”Š26â”Š    MessagesListComponent,\n+â”Š  â”Š27â”Š    MessageItemComponent,\n+â”Š  â”Š28â”Š    NewMessageComponent,\n+â”Š  â”Š29â”Š  ],\n+â”Š  â”Š30â”Š  imports: [\n+â”Š  â”Š31â”Š    BrowserModule,\n+â”Š  â”Š32â”Š    // Material\n+â”Š  â”Š33â”Š    MatToolbarModule,\n+â”Š  â”Š34â”Š    MatMenuModule,\n+â”Š  â”Š35â”Š    MatIconModule,\n+â”Š  â”Š36â”Š    MatButtonModule,\n+â”Š  â”Š37â”Š    MatListModule,\n+â”Š  â”Š38â”Š    MatGridListModule,\n+â”Š  â”Š39â”Š    // Animations\n+â”Š  â”Š40â”Š    BrowserAnimationsModule,\n+â”Š  â”Š41â”Š    // Routing\n+â”Š  â”Š42â”Š    RouterModule.forChild(routes),\n+â”Š  â”Š43â”Š    // Forms\n+â”Š  â”Š44â”Š    FormsModule,\n+â”Š  â”Š45â”Š    // Feature modules\n+â”Š  â”Š46â”Š    SharedModule,\n+â”Š  â”Š47â”Š  ],\n+â”Š  â”Š48â”Š  providers: [\n+â”Š  â”Š49â”Š    ChatsService,\n+â”Š  â”Š50â”Š  ],\n+â”Š  â”Š51â”Š})\n+â”Š  â”Š52â”Šexport class ChatViewerModule {\n+â”Š  â”Š53â”Š}\n```\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;components&#x2F;message-item&#x2F;message-item.component.scss\n```diff\n@@ -0,0 +1,18 @@\n+â”Š  â”Š 1â”Š:host {\n+â”Š  â”Š 2â”Š  display: flex;\n+â”Š  â”Š 3â”Š  width: 100%;\n+â”Š  â”Š 4â”Š}\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Š.message {\n+â”Š  â”Š 7â”Š  max-width: 75%;\n+â”Š  â”Š 8â”Š  background-color: lightgoldenrodyellow;\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Š  &.mine {\n+â”Š  â”Š11â”Š    background-color: lightcyan;\n+â”Š  â”Š12â”Š    margin-left: auto;\n+â”Š  â”Š13â”Š  }\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”Š  .message-sender {\n+â”Š  â”Š16â”Š    font-size: small;\n+â”Š  â”Š17â”Š  }\n+â”Š  â”Š18â”Š}\n```\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;components&#x2F;message-item&#x2F;message-item.component.ts\n```diff\n@@ -0,0 +1,21 @@\n+â”Š  â”Š 1â”Šimport {Component, Input} from '@angular/core';\n+â”Š  â”Š 2â”Š\n+â”Š  â”Š 3â”Š@Component({\n+â”Š  â”Š 4â”Š  selector: 'app-message-item',\n+â”Š  â”Š 5â”Š  template: `\n+â”Š  â”Š 6â”Š    <div class=\"message\"\n+â”Š  â”Š 7â”Š         [ngClass]=\"{'mine': message.ownership}\">\n+â”Š  â”Š 8â”Š      <div *ngIf=\"isGroup && !message.ownership\" class=\"message-sender\">{{ message.sender.name }}</div>\n+â”Š  â”Š 9â”Š      <div>{{ message.content }}</div>\n+â”Š  â”Š10â”Š    </div>\n+â”Š  â”Š11â”Š  `,\n+â”Š  â”Š12â”Š  styleUrls: ['message-item.component.scss'],\n+â”Š  â”Š13â”Š})\n+â”Š  â”Š14â”Šexport class MessageItemComponent {\n+â”Š  â”Š15â”Š  // tslint:disable-next-line:no-input-rename\n+â”Š  â”Š16â”Š  @Input('item')\n+â”Š  â”Š17â”Š  message: any;\n+â”Š  â”Š18â”Š\n+â”Š  â”Š19â”Š  @Input()\n+â”Š  â”Š20â”Š  isGroup: boolean;\n+â”Š  â”Š21â”Š}\n```\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;components&#x2F;messages-list&#x2F;messages-list.component.scss\n```diff\n@@ -0,0 +1,12 @@\n+â”Š  â”Š 1â”Š:host {\n+â”Š  â”Š 2â”Š  display: block;\n+â”Š  â”Š 3â”Š  height: 100%;\n+â”Š  â”Š 4â”Š  overflow-y: scroll;\n+â”Š  â”Š 5â”Š  background-color: aliceblue;\n+â”Š  â”Š 6â”Š}\n+â”Š  â”Š 7â”Š\n+â”Š  â”Š 8â”Š/*\n+â”Š  â”Š 9â”Š:host::-webkit-scrollbar {\n+â”Š  â”Š10â”Š  display: none;\n+â”Š  â”Š11â”Š}\n+â”Š  â”Š12â”Š*/\n```\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;components&#x2F;messages-list&#x2F;messages-list.component.ts\n```diff\n@@ -0,0 +1,23 @@\n+â”Š  â”Š 1â”Šimport {Component, Input} from '@angular/core';\n+â”Š  â”Š 2â”Š\n+â”Š  â”Š 3â”Š@Component({\n+â”Š  â”Š 4â”Š  selector: 'app-messages-list',\n+â”Š  â”Š 5â”Š  template: `\n+â”Š  â”Š 6â”Š    <mat-list>\n+â”Š  â”Š 7â”Š      <mat-list-item *ngFor=\"let message of messages\">\n+â”Š  â”Š 8â”Š        <app-message-item [item]=\"message\" [isGroup]=\"isGroup\"></app-message-item>\n+â”Š  â”Š 9â”Š      </mat-list-item>\n+â”Š  â”Š10â”Š    </mat-list>\n+â”Š  â”Š11â”Š  `,\n+â”Š  â”Š12â”Š  styleUrls: ['messages-list.component.scss'],\n+â”Š  â”Š13â”Š})\n+â”Š  â”Š14â”Šexport class MessagesListComponent {\n+â”Š  â”Š15â”Š  // tslint:disable-next-line:no-input-rename\n+â”Š  â”Š16â”Š  @Input('items')\n+â”Š  â”Š17â”Š  messages: any[];\n+â”Š  â”Š18â”Š\n+â”Š  â”Š19â”Š  @Input()\n+â”Š  â”Š20â”Š  isGroup: boolean;\n+â”Š  â”Š21â”Š\n+â”Š  â”Š22â”Š  constructor() {}\n+â”Š  â”Š23â”Š}\n```\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;components&#x2F;new-message&#x2F;new-message.component.scss\n```diff\n@@ -0,0 +1,13 @@\n+â”Š  â”Š 1â”Š:host {\n+â”Š  â”Š 2â”Š  display: flex;\n+â”Š  â”Š 3â”Š  height: 8vh;\n+â”Š  â”Š 4â”Š}\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šinput {\n+â”Š  â”Š 7â”Š  width: 100%;\n+â”Š  â”Š 8â”Š}\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Šbutton {\n+â”Š  â”Š11â”Š  width: 8vh;\n+â”Š  â”Š12â”Š  min-width: 56px;\n+â”Š  â”Š13â”Š}\n```\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;components&#x2F;new-message&#x2F;new-message.component.ts\n```diff\n@@ -0,0 +1,34 @@\n+â”Š  â”Š 1â”Šimport {Component, EventEmitter, Input, Output} from '@angular/core';\n+â”Š  â”Š 2â”Š\n+â”Š  â”Š 3â”Š@Component({\n+â”Š  â”Š 4â”Š  selector: 'app-new-message',\n+â”Š  â”Š 5â”Š  template: `\n+â”Š  â”Š 6â”Š    <input type=\"text\" [(ngModel)]=\"message\" (keyup)=\"onInputKeyup($event)\"/>\n+â”Š  â”Š 7â”Š    <button mat-button (click)=\"emitMessage()\" [disabled]=\"disabled\">\n+â”Š  â”Š 8â”Š      <mat-icon aria-label=\"Icon-button with a send icon\">send</mat-icon>\n+â”Š  â”Š 9â”Š    </button>\n+â”Š  â”Š10â”Š  `,\n+â”Š  â”Š11â”Š  styleUrls: ['new-message.component.scss'],\n+â”Š  â”Š12â”Š})\n+â”Š  â”Š13â”Šexport class NewMessageComponent {\n+â”Š  â”Š14â”Š  @Input()\n+â”Š  â”Š15â”Š  disabled: boolean;\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š  @Output()\n+â”Š  â”Š18â”Š  newMessage = new EventEmitter<string>();\n+â”Š  â”Š19â”Š\n+â”Š  â”Š20â”Š  message = '';\n+â”Š  â”Š21â”Š\n+â”Š  â”Š22â”Š  onInputKeyup({ keyCode }: KeyboardEvent) {\n+â”Š  â”Š23â”Š    if (keyCode === 13) {\n+â”Š  â”Š24â”Š      this.emitMessage();\n+â”Š  â”Š25â”Š    }\n+â”Š  â”Š26â”Š  }\n+â”Š  â”Š27â”Š\n+â”Š  â”Š28â”Š  emitMessage() {\n+â”Š  â”Š29â”Š    if (this.message && !this.disabled) {\n+â”Š  â”Š30â”Š      this.newMessage.emit(this.message);\n+â”Š  â”Š31â”Š      this.message = '';\n+â”Š  â”Š32â”Š    }\n+â”Š  â”Š33â”Š  }\n+â”Š  â”Š34â”Š}\n```\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.scss\n```diff\n@@ -0,0 +1,10 @@\n+â”Š  â”Š 1â”Š.container {\n+â”Š  â”Š 2â”Š  display: flex;\n+â”Š  â”Š 3â”Š  flex-flow: column;\n+â”Š  â”Š 4â”Š  justify-content: space-between;\n+â”Š  â”Š 5â”Š  height: calc(100vh - 8vh);\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Š  app-confirm-selection {\n+â”Š  â”Š 8â”Š    bottom: 10vh;\n+â”Š  â”Š 9â”Š  }\n+â”Š  â”Š10â”Š}\n```\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.ts\n```diff\n@@ -0,0 +1,45 @@\n+â”Š  â”Š 1â”Šimport {Component, OnInit} from '@angular/core';\n+â”Š  â”Š 2â”Šimport {ActivatedRoute, Router} from '@angular/router';\n+â”Š  â”Š 3â”Šimport {ChatsService} from '../../../services/chats.service';\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Š@Component({\n+â”Š  â”Š 6â”Š  template: `\n+â”Š  â”Š 7â”Š    <app-toolbar>\n+â”Š  â”Š 8â”Š      <button class=\"navigation\" mat-button (click)=\"goToChats()\">\n+â”Š  â”Š 9â”Š        <mat-icon aria-label=\"Icon-button with an arrow back icon\">arrow_back</mat-icon>\n+â”Š  â”Š10â”Š      </button>\n+â”Š  â”Š11â”Š      <div class=\"title\">{{ name }}</div>\n+â”Š  â”Š12â”Š    </app-toolbar>\n+â”Š  â”Š13â”Š    <div class=\"container\">\n+â”Š  â”Š14â”Š      <app-messages-list [items]=\"messages\" [isGroup]=\"isGroup\"></app-messages-list>\n+â”Š  â”Š15â”Š      <app-new-message></app-new-message>\n+â”Š  â”Š16â”Š    </div>\n+â”Š  â”Š17â”Š  `,\n+â”Š  â”Š18â”Š  styleUrls: ['./chat.component.scss']\n+â”Š  â”Š19â”Š})\n+â”Š  â”Š20â”Šexport class ChatComponent implements OnInit {\n+â”Š  â”Š21â”Š  chatId: string;\n+â”Š  â”Š22â”Š  messages: any[];\n+â”Š  â”Š23â”Š  name: string;\n+â”Š  â”Š24â”Š  isGroup: boolean;\n+â”Š  â”Š25â”Š\n+â”Š  â”Š26â”Š  constructor(private route: ActivatedRoute,\n+â”Š  â”Š27â”Š              private router: Router,\n+â”Š  â”Š28â”Š              private chatsService: ChatsService) {\n+â”Š  â”Š29â”Š  }\n+â”Š  â”Š30â”Š\n+â”Š  â”Š31â”Š  ngOnInit() {\n+â”Š  â”Š32â”Š    this.route.params.subscribe(({id: chatId}) => {\n+â”Š  â”Š33â”Š      this.chatId = chatId;\n+â”Š  â”Š34â”Š      this.chatsService.getChat(chatId).chat$.subscribe(chat => {\n+â”Š  â”Š35â”Š        this.messages = chat.messages;\n+â”Š  â”Š36â”Š        this.name = chat.name;\n+â”Š  â”Š37â”Š        this.isGroup = chat.isGroup;\n+â”Š  â”Š38â”Š      });\n+â”Š  â”Š39â”Š    });\n+â”Š  â”Š40â”Š  }\n+â”Š  â”Š41â”Š\n+â”Š  â”Š42â”Š  goToChats() {\n+â”Š  â”Š43â”Š    this.router.navigate(['/chats']);\n+â”Š  â”Š44â”Š  }\n+â”Š  â”Š45â”Š}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chat-item&#x2F;chat-item.component.ts\n```diff\n@@ -1,11 +1,11 @@\n-â”Š 1â”Š  â”Šimport {Component, Input} from '@angular/core';\n+â”Š  â”Š 1â”Šimport {Component, EventEmitter, Input, Output} from '@angular/core';\n â”Š 2â”Š 2â”Šimport {GetChats} from '../../../../types';\n â”Š 3â”Š 3â”Š\n â”Š 4â”Š 4â”Š@Component({\n â”Š 5â”Š 5â”Š  selector: 'app-chat-item',\n â”Š 6â”Š 6â”Š  template: `\n â”Š 7â”Š 7â”Š    <div class=\"chat-row\">\n-â”Š 8â”Š  â”Š        <div class=\"chat-recipient\">\n+â”Š  â”Š 8â”Š        <div class=\"chat-recipient\" (click)=\"selectChat()\">\n â”Š 9â”Š 9â”Š          <img *ngIf=\"chat.picture\" [src]=\"chat.picture\" width=\"48\" height=\"48\">\n â”Š10â”Š10â”Š          <div>{{ chat.name }} [id: {{ chat.id }}]</div>\n â”Š11â”Š11â”Š        </div>\n```\n```diff\n@@ -18,4 +18,11 @@\n â”Š18â”Š18â”Š  // tslint:disable-next-line:no-input-rename\n â”Š19â”Š19â”Š  @Input('item')\n â”Š20â”Š20â”Š  chat: GetChats.Chats;\n+â”Š  â”Š21â”Š\n+â”Š  â”Š22â”Š  @Output()\n+â”Š  â”Š23â”Š  select = new EventEmitter<string>();\n+â”Š  â”Š24â”Š\n+â”Š  â”Š25â”Š  selectChat() {\n+â”Š  â”Š26â”Š    this.select.emit(this.chat.id);\n+â”Š  â”Š27â”Š  }\n â”Š21â”Š28â”Š}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chats-list&#x2F;chats-list.component.ts\n```diff\n@@ -1,4 +1,4 @@\n-â”Š1â”Š â”Šimport {Component, Input} from '@angular/core';\n+â”Š â”Š1â”Šimport {Component, EventEmitter, Input, Output} from '@angular/core';\n â”Š2â”Š2â”Šimport {GetChats} from '../../../../types';\n â”Š3â”Š3â”Š\n â”Š4â”Š4â”Š@Component({\n```\n```diff\n@@ -6,7 +6,7 @@\n â”Š 6â”Š 6â”Š  template: `\n â”Š 7â”Š 7â”Š    <mat-list>\n â”Š 8â”Š 8â”Š      <mat-list-item *ngFor=\"let chat of chats\">\n-â”Š 9â”Š  â”Š        <app-chat-item [item]=\"chat\"></app-chat-item>\n+â”Š  â”Š 9â”Š        <app-chat-item [item]=\"chat\" (select)=\"selectChat($event)\"></app-chat-item>\n â”Š10â”Š10â”Š      </mat-list-item>\n â”Š11â”Š11â”Š    </mat-list>\n â”Š12â”Š12â”Š  `,\n```\n```diff\n@@ -17,5 +17,12 @@\n â”Š17â”Š17â”Š  @Input('items')\n â”Š18â”Š18â”Š  chats: GetChats.Chats[];\n â”Š19â”Š19â”Š\n+â”Š  â”Š20â”Š  @Output()\n+â”Š  â”Š21â”Š  select = new EventEmitter<string>();\n+â”Š  â”Š22â”Š\n â”Š20â”Š23â”Š  constructor() {}\n+â”Š  â”Š24â”Š\n+â”Š  â”Š25â”Š  selectChat(id: string) {\n+â”Š  â”Š26â”Š    this.select.emit(id);\n+â”Š  â”Š27â”Š  }\n â”Š21â”Š28â”Š}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.ts\n```diff\n@@ -2,6 +2,7 @@\n â”Š2â”Š2â”Šimport {ChatsService} from '../../../services/chats.service';\n â”Š3â”Š3â”Šimport {Observable} from 'rxjs/Observable';\n â”Š4â”Š4â”Šimport {GetChats} from '../../../../types';\n+â”Š â”Š5â”Šimport {Router} from '@angular/router';\n â”Š5â”Š6â”Š\n â”Š6â”Š7â”Š@Component({\n â”Š7â”Š8â”Š  template: `\n```\n```diff\n@@ -27,7 +28,7 @@\n â”Š27â”Š28â”Š      </button>\n â”Š28â”Š29â”Š    </mat-menu>\n â”Š29â”Š30â”Š\n-â”Š30â”Š  â”Š    <app-chats-list [items]=\"chats$ | async\"></app-chats-list>\n+â”Š  â”Š31â”Š    <app-chats-list [items]=\"chats$ | async\" (select)=\"goToChat($event)\"></app-chats-list>\n â”Š31â”Š32â”Š\n â”Š32â”Š33â”Š    <button class=\"chat-button\" mat-fab color=\"primary\">\n â”Š33â”Š34â”Š      <mat-icon aria-label=\"Icon-button with a + icon\">add</mat-icon>\n```\n```diff\n@@ -38,10 +39,15 @@\n â”Š38â”Š39â”Šexport class ChatsComponent implements OnInit {\n â”Š39â”Š40â”Š  chats$: Observable<GetChats.Chats[]>;\n â”Š40â”Š41â”Š\n-â”Š41â”Š  â”Š  constructor(private chatsService: ChatsService) {\n+â”Š  â”Š42â”Š  constructor(private chatsService: ChatsService,\n+â”Š  â”Š43â”Š              private router: Router) {\n â”Š42â”Š44â”Š  }\n â”Š43â”Š45â”Š\n â”Š44â”Š46â”Š  ngOnInit() {\n â”Š45â”Š47â”Š    this.chats$ = this.chatsService.getChats().chats$;\n â”Š46â”Š48â”Š  }\n+â”Š  â”Š49â”Š\n+â”Š  â”Š50â”Š  goToChat(chatId: string) {\n+â”Š  â”Š51â”Š    this.router.navigate(['/chat', chatId]);\n+â”Š  â”Š52â”Š  }\n â”Š47â”Š53â”Š}\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -4,6 +4,7 @@\n â”Š 4â”Š 4â”Šimport {Injectable} from '@angular/core';\n â”Š 5â”Š 5â”Šimport {getChatsQuery} from '../../graphql/getChats.query';\n â”Š 6â”Š 6â”Šimport {GetChats} from '../../types';\n+â”Š  â”Š 7â”Šimport {getChatQuery} from '../../graphql/getChat.query';\n â”Š 7â”Š 8â”Š\n â”Š 8â”Š 9â”Š@Injectable()\n â”Š 9â”Š10â”Šexport class ChatsService {\n```\n```diff\n@@ -24,4 +25,19 @@\n â”Š24â”Š25â”Š\n â”Š25â”Š26â”Š    return {query, chats$};\n â”Š26â”Š27â”Š  }\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š  getChat(chatId: string) {\n+â”Š  â”Š30â”Š    const query = this.apollo.watchQuery<any>({\n+â”Š  â”Š31â”Š      query: getChatQuery,\n+â”Š  â”Š32â”Š      variables: {\n+â”Š  â”Š33â”Š        chatId: chatId,\n+â”Š  â”Š34â”Š      }\n+â”Š  â”Š35â”Š    });\n+â”Š  â”Š36â”Š\n+â”Š  â”Š37â”Š    const chat$ = query.valueChanges.pipe(\n+â”Š  â”Š38â”Š      map((result: ApolloQueryResult<any>) => result.data.chat)\n+â”Š  â”Š39â”Š    );\n+â”Š  â”Š40â”Š\n+â”Š  â”Š41â”Š    return {query, chat$};\n+â”Š  â”Š42â”Š  }\n â”Š27â”Š43â”Š}\n```\n\n##### Added src&#x2F;graphql&#x2F;getChat.query.ts\n```diff\n@@ -0,0 +1,17 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag';\n+â”Š  â”Š 2â”Šimport {fragments} from './fragment';\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Š// We use the gql tag to parse our query string into a query document\n+â”Š  â”Š 5â”Šexport const getChatQuery = gql`\n+â”Š  â”Š 6â”Š  query GetChat($chatId: ID!) {\n+â”Š  â”Š 7â”Š    chat(chatId: $chatId) {\n+â”Š  â”Š 8â”Š      ...ChatWithoutMessages\n+â”Š  â”Š 9â”Š      messages {\n+â”Š  â”Š10â”Š        ...Message\n+â”Š  â”Š11â”Š      }\n+â”Š  â”Š12â”Š    }\n+â”Š  â”Š13â”Š  }\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”Š  ${fragments['chatWithoutMessages']}\n+â”Š  â”Š16â”Š  ${fragments['message']}\n+â”Š  â”Š17â”Š`;\n```\n\n[}]: #\n\nIt's time to generate our types:\n\n    $ npm run generator\n\nAnd use them:\n\n[{]: <helper> (diffStep \"4.2\" files=\"^\\(?!src/types.d.ts$\\).*\" module=\"client\")\n\n#### Step 4.2: Add generated types\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;components&#x2F;message-item&#x2F;message-item.component.ts\n```diff\n@@ -1,4 +1,5 @@\n â”Š1â”Š1â”Šimport {Component, Input} from '@angular/core';\n+â”Š â”Š2â”Šimport {GetChat} from '../../../../types';\n â”Š2â”Š3â”Š\n â”Š3â”Š4â”Š@Component({\n â”Š4â”Š5â”Š  selector: 'app-message-item',\n```\n```diff\n@@ -14,7 +15,7 @@\n â”Š14â”Š15â”Šexport class MessageItemComponent {\n â”Š15â”Š16â”Š  // tslint:disable-next-line:no-input-rename\n â”Š16â”Š17â”Š  @Input('item')\n-â”Š17â”Š  â”Š  message: any;\n+â”Š  â”Š18â”Š  message: GetChat.Messages;\n â”Š18â”Š19â”Š\n â”Š19â”Š20â”Š  @Input()\n â”Š20â”Š21â”Š  isGroup: boolean;\n```\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;components&#x2F;messages-list&#x2F;messages-list.component.ts\n```diff\n@@ -1,4 +1,5 @@\n â”Š1â”Š1â”Šimport {Component, Input} from '@angular/core';\n+â”Š â”Š2â”Šimport {GetChat} from '../../../../types';\n â”Š2â”Š3â”Š\n â”Š3â”Š4â”Š@Component({\n â”Š4â”Š5â”Š  selector: 'app-messages-list',\n```\n```diff\n@@ -14,7 +15,7 @@\n â”Š14â”Š15â”Šexport class MessagesListComponent {\n â”Š15â”Š16â”Š  // tslint:disable-next-line:no-input-rename\n â”Š16â”Š17â”Š  @Input('items')\n-â”Š17â”Š  â”Š  messages: any[];\n+â”Š  â”Š18â”Š  messages: GetChat.Messages[];\n â”Š18â”Š19â”Š\n â”Š19â”Š20â”Š  @Input()\n â”Š20â”Š21â”Š  isGroup: boolean;\n```\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.ts\n```diff\n@@ -1,6 +1,7 @@\n â”Š1â”Š1â”Šimport {Component, OnInit} from '@angular/core';\n â”Š2â”Š2â”Šimport {ActivatedRoute, Router} from '@angular/router';\n â”Š3â”Š3â”Šimport {ChatsService} from '../../../services/chats.service';\n+â”Š â”Š4â”Šimport {GetChat} from '../../../../types';\n â”Š4â”Š5â”Š\n â”Š5â”Š6â”Š@Component({\n â”Š6â”Š7â”Š  template: `\n```\n```diff\n@@ -19,7 +20,7 @@\n â”Š19â”Š20â”Š})\n â”Š20â”Š21â”Šexport class ChatComponent implements OnInit {\n â”Š21â”Š22â”Š  chatId: string;\n-â”Š22â”Š  â”Š  messages: any[];\n+â”Š  â”Š23â”Š  messages: GetChat.Messages[];\n â”Š23â”Š24â”Š  name: string;\n â”Š24â”Š25â”Š  isGroup: boolean;\n â”Š25â”Š26â”Š\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -3,7 +3,7 @@\n â”Š3â”Š3â”Šimport {Apollo} from 'apollo-angular';\n â”Š4â”Š4â”Šimport {Injectable} from '@angular/core';\n â”Š5â”Š5â”Šimport {getChatsQuery} from '../../graphql/getChats.query';\n-â”Š6â”Š â”Šimport {GetChats} from '../../types';\n+â”Š â”Š6â”Šimport {GetChat, GetChats} from '../../types';\n â”Š7â”Š7â”Šimport {getChatQuery} from '../../graphql/getChat.query';\n â”Š8â”Š8â”Š\n â”Š9â”Š9â”Š@Injectable()\n```\n```diff\n@@ -27,7 +27,7 @@\n â”Š27â”Š27â”Š  }\n â”Š28â”Š28â”Š\n â”Š29â”Š29â”Š  getChat(chatId: string) {\n-â”Š30â”Š  â”Š    const query = this.apollo.watchQuery<any>({\n+â”Š  â”Š30â”Š    const query = this.apollo.watchQuery<GetChat.Query>({\n â”Š31â”Š31â”Š      query: getChatQuery,\n â”Š32â”Š32â”Š      variables: {\n â”Š33â”Š33â”Š        chatId: chatId,\n```\n```diff\n@@ -35,7 +35,7 @@\n â”Š35â”Š35â”Š    });\n â”Š36â”Š36â”Š\n â”Š37â”Š37â”Š    const chat$ = query.valueChanges.pipe(\n-â”Š38â”Š  â”Š      map((result: ApolloQueryResult<any>) => result.data.chat)\n+â”Š  â”Š38â”Š      map((result: ApolloQueryResult<GetChat.Query>) => result.data.chat)\n â”Š39â”Š39â”Š    );\n â”Š40â”Š40â”Š\n â”Š41â”Š41â”Š    return {query, chat$};\n```\n\n[}]: #\n\nWe will also create some more tests for the newly created Chat container component:\n\n[{]: <helper> (diffStep \"4.3\" module=\"client\")\n\n#### Step 4.3: Testing\n\n##### Added src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.spec.ts\n```diff\n@@ -0,0 +1,170 @@\n+â”Š   â”Š  1â”Šimport { async, ComponentFixture, TestBed } from '@angular/core/testing';\n+â”Š   â”Š  2â”Š\n+â”Š   â”Š  3â”Šimport { ChatComponent } from './chat.component';\n+â”Š   â”Š  4â”Šimport {DebugElement, NO_ERRORS_SCHEMA} from '@angular/core';\n+â”Š   â”Š  5â”Šimport {MatButtonModule, MatGridListModule, MatIconModule, MatListModule, MatMenuModule, MatToolbarModule} from '@angular/material';\n+â”Š   â”Š  6â”Šimport {ChatsService} from '../../../services/chats.service';\n+â”Š   â”Š  7â”Šimport {Apollo} from 'apollo-angular';\n+â”Š   â”Š  8â”Šimport {HttpClientTestingModule, HttpTestingController} from '@angular/common/http/testing';\n+â”Š   â”Š  9â”Šimport {HttpLink, HttpLinkModule, Options} from 'apollo-angular-link-http';\n+â”Š   â”Š 10â”Šimport {defaultDataIdFromObject, InMemoryCache} from 'apollo-cache-inmemory';\n+â”Š   â”Š 11â”Šimport {RouterTestingModule} from '@angular/router/testing';\n+â”Š   â”Š 12â”Šimport {ActivatedRoute} from '@angular/router';\n+â”Š   â”Š 13â”Šimport {of} from 'rxjs/observable/of';\n+â”Š   â”Š 14â”Šimport {By} from '@angular/platform-browser';\n+â”Š   â”Š 15â”Šimport {FormsModule} from '@angular/forms';\n+â”Š   â”Š 16â”Šimport {SharedModule} from '../../../shared/shared.module';\n+â”Š   â”Š 17â”Šimport {NewMessageComponent} from '../../components/new-message/new-message.component';\n+â”Š   â”Š 18â”Šimport {MessagesListComponent} from '../../components/messages-list/messages-list.component';\n+â”Š   â”Š 19â”Šimport {MessageItemComponent} from '../../components/message-item/message-item.component';\n+â”Š   â”Š 20â”Š\n+â”Š   â”Š 21â”Šdescribe('ChatComponent', () => {\n+â”Š   â”Š 22â”Š  let component: ChatComponent;\n+â”Š   â”Š 23â”Š  let fixture: ComponentFixture<ChatComponent>;\n+â”Š   â”Š 24â”Š  let el: DebugElement;\n+â”Š   â”Š 25â”Š\n+â”Š   â”Š 26â”Š  let httpMock: HttpTestingController;\n+â”Š   â”Š 27â”Š  let httpLink: HttpLink;\n+â”Š   â”Š 28â”Š  let apollo: Apollo;\n+â”Š   â”Š 29â”Š\n+â”Š   â”Š 30â”Š  const chat: any = {\n+â”Š   â”Š 31â”Š    id: '1',\n+â”Š   â”Š 32â”Š    __typename: 'Chat',\n+â”Š   â”Š 33â”Š    name: 'Avery Stewart',\n+â”Š   â”Š 34â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n+â”Š   â”Š 35â”Š    allTimeMembers: [\n+â”Š   â”Š 36â”Š      {\n+â”Š   â”Š 37â”Š        id: '1',\n+â”Š   â”Š 38â”Š        __typename: 'User',\n+â”Š   â”Š 39â”Š      },\n+â”Š   â”Š 40â”Š      {\n+â”Š   â”Š 41â”Š        id: '3',\n+â”Š   â”Š 42â”Š        __typename: 'User',\n+â”Š   â”Š 43â”Š      }\n+â”Š   â”Š 44â”Š    ],\n+â”Š   â”Š 45â”Š    unreadMessages: 1,\n+â”Š   â”Š 46â”Š    isGroup: false,\n+â”Š   â”Š 47â”Š    messages: [\n+â”Š   â”Š 48â”Š      {\n+â”Š   â”Š 49â”Š        id: '1',\n+â”Š   â”Š 50â”Š        chat: {\n+â”Š   â”Š 51â”Š          id: '1',\n+â”Š   â”Š 52â”Š          __typename: 'Chat',\n+â”Š   â”Š 53â”Š        },\n+â”Š   â”Š 54â”Š        __typename: 'Message',\n+â”Š   â”Š 55â”Š        sender: {\n+â”Š   â”Š 56â”Š          id: '3',\n+â”Š   â”Š 57â”Š          __typename: 'User',\n+â”Š   â”Š 58â”Š          name: 'Avery Stewart'\n+â”Š   â”Š 59â”Š        },\n+â”Š   â”Š 60â”Š        content: 'Yep!',\n+â”Š   â”Š 61â”Š        createdAt: '1514035700',\n+â”Š   â”Š 62â”Š        type: 0,\n+â”Š   â”Š 63â”Š        recipients: [\n+â”Š   â”Š 64â”Š          {\n+â”Š   â”Š 65â”Š            user: {\n+â”Š   â”Š 66â”Š              id: '1',\n+â”Š   â”Š 67â”Š              __typename: 'User',\n+â”Š   â”Š 68â”Š            },\n+â”Š   â”Š 69â”Š            message: {\n+â”Š   â”Š 70â”Š              id: '1',\n+â”Š   â”Š 71â”Š              __typename: 'Message',\n+â”Š   â”Š 72â”Š              chat: {\n+â”Š   â”Š 73â”Š                id: '1',\n+â”Š   â”Š 74â”Š                __typename: 'Chat',\n+â”Š   â”Š 75â”Š              },\n+â”Š   â”Š 76â”Š            },\n+â”Š   â”Š 77â”Š            __typename: 'Recipient',\n+â”Š   â”Š 78â”Š            chat: {\n+â”Š   â”Š 79â”Š              id: '1',\n+â”Š   â”Š 80â”Š              __typename: 'Chat',\n+â”Š   â”Š 81â”Š            },\n+â”Š   â”Š 82â”Š            receivedAt: null,\n+â”Š   â”Š 83â”Š            readAt: null\n+â”Š   â”Š 84â”Š          }\n+â”Š   â”Š 85â”Š        ],\n+â”Š   â”Š 86â”Š        ownership: false\n+â”Š   â”Š 87â”Š      }\n+â”Š   â”Š 88â”Š    ],\n+â”Š   â”Š 89â”Š  };\n+â”Š   â”Š 90â”Š\n+â”Š   â”Š 91â”Š  beforeEach(async(() => {\n+â”Š   â”Š 92â”Š    TestBed.configureTestingModule({\n+â”Š   â”Š 93â”Š      declarations: [\n+â”Š   â”Š 94â”Š        ChatComponent,\n+â”Š   â”Š 95â”Š        MessagesListComponent,\n+â”Š   â”Š 96â”Š        MessageItemComponent,\n+â”Š   â”Š 97â”Š        NewMessageComponent,\n+â”Š   â”Š 98â”Š      ],\n+â”Š   â”Š 99â”Š      imports: [\n+â”Š   â”Š100â”Š        MatToolbarModule,\n+â”Š   â”Š101â”Š        MatMenuModule,\n+â”Š   â”Š102â”Š        MatIconModule,\n+â”Š   â”Š103â”Š        MatButtonModule,\n+â”Š   â”Š104â”Š        MatListModule,\n+â”Š   â”Š105â”Š        MatGridListModule,\n+â”Š   â”Š106â”Š        FormsModule,\n+â”Š   â”Š107â”Š        SharedModule,\n+â”Š   â”Š108â”Š        HttpLinkModule,\n+â”Š   â”Š109â”Š        HttpClientTestingModule,\n+â”Š   â”Š110â”Š        RouterTestingModule\n+â”Š   â”Š111â”Š      ],\n+â”Š   â”Š112â”Š      providers: [\n+â”Š   â”Š113â”Š        ChatsService,\n+â”Š   â”Š114â”Š        Apollo,\n+â”Š   â”Š115â”Š        {\n+â”Š   â”Š116â”Š          provide: ActivatedRoute,\n+â”Š   â”Š117â”Š          useValue: { params: of({ id: chat.id }) }\n+â”Š   â”Š118â”Š        }\n+â”Š   â”Š119â”Š      ],\n+â”Š   â”Š120â”Š      schemas: [NO_ERRORS_SCHEMA]\n+â”Š   â”Š121â”Š    })\n+â”Š   â”Š122â”Š      .compileComponents();\n+â”Š   â”Š123â”Š\n+â”Š   â”Š124â”Š    httpMock = TestBed.get(HttpTestingController);\n+â”Š   â”Š125â”Š    httpLink = TestBed.get(HttpLink);\n+â”Š   â”Š126â”Š    apollo = TestBed.get(Apollo);\n+â”Š   â”Š127â”Š\n+â”Š   â”Š128â”Š    apollo.create({\n+â”Š   â”Š129â”Š      link: httpLink.create(<Options>{ uri: 'http://localhost:3000/graphql' }),\n+â”Š   â”Š130â”Š      cache: new InMemoryCache({\n+â”Š   â”Š131â”Š        dataIdFromObject: (object: any) => {\n+â”Š   â”Š132â”Š          switch (object.__typename) {\n+â”Š   â”Š133â”Š            case 'Message': return `${object.chat.id}:${object.id}`; // use `chatId` prefix and `messageId` as the primary key\n+â”Š   â”Š134â”Š            default: return defaultDataIdFromObject(object); // fall back to default handling\n+â”Š   â”Š135â”Š          }\n+â”Š   â”Š136â”Š        }\n+â”Š   â”Š137â”Š      }),\n+â”Š   â”Š138â”Š    });\n+â”Š   â”Š139â”Š  }));\n+â”Š   â”Š140â”Š\n+â”Š   â”Š141â”Š  beforeEach(() => {\n+â”Š   â”Š142â”Š    fixture = TestBed.createComponent(ChatComponent);\n+â”Š   â”Š143â”Š    component = fixture.componentInstance;\n+â”Š   â”Š144â”Š    fixture.detectChanges();\n+â”Š   â”Š145â”Š    const req = httpMock.expectOne('http://localhost:3000/graphql', 'call to api');\n+â”Š   â”Š146â”Š    req.flush({\n+â”Š   â”Š147â”Š      data: {\n+â”Š   â”Š148â”Š        chat\n+â”Š   â”Š149â”Š      }\n+â”Š   â”Š150â”Š    });\n+â”Š   â”Š151â”Š  });\n+â”Š   â”Š152â”Š\n+â”Š   â”Š153â”Š  it('should create', () => {\n+â”Š   â”Š154â”Š    expect(component).toBeTruthy();\n+â”Š   â”Š155â”Š  });\n+â”Š   â”Š156â”Š\n+â”Š   â”Š157â”Š  it('should display the chat', () => {\n+â”Š   â”Š158â”Š    fixture.whenStable().then(() => {\n+â”Š   â”Š159â”Š      fixture.detectChanges();\n+â”Š   â”Š160â”Š      el = fixture.debugElement;\n+â”Š   â”Š161â”Š      expect(el.query(By.css(`app-toolbar > mat-toolbar > div > div`)).nativeElement.textContent).toContain(chat.name);\n+â”Š   â”Š162â”Š      for (let i = 0; i < chat.messages.length; i++) {\n+â”Š   â”Š163â”Š        expect(el.query(By.css(`app-messages-list > mat-list > mat-list-item:nth-child(${i + 1}) > div > app-message-item > div`))\n+â”Š   â”Š164â”Š          .nativeElement.textContent).toContain(chat.messages[i].content);\n+â”Š   â”Š165â”Š      }\n+â”Š   â”Š166â”Š    });\n+â”Š   â”Š167â”Š\n+â”Š   â”Š168â”Š    httpMock.verify();\n+â”Š   â”Š169â”Š  });\n+â”Š   â”Š170â”Š});\n```\n\n[}]: #"
          },
          {
            "manualTitle": "Step 9: Mutations",
            "stepRevision": "fb52c763a7cf0eee267296b186db067cd726be43",
            "manualView": "In addition to fetching data using queries, Apollo also helps you handle GraphQL mutations. In GraphQL, mutations are identical to queries in syntax, the only difference being that you use the keyword mutation instead of query to indicate that the root fields on this query are going to be performing writes to the backend.\nGraphQL mutations represent two things in one query string:\n\n1. The mutation field name with arguments, which represents the actual operation to be done on the server.\n2. The fields you want back from the result of the mutation to update the client.\n\nWhen we use mutations in Apollo, the result is typically integrated into the cache automatically based on the id of the result, which in turn updates the UI automatically, so we often don't need to explicitly handle the results. In order for the client to correctly do this, we need to ensure we select the necessary fields in the result. One good strategy can be to simply ask for any fields that might have been affected by the mutation. Alternatively, you can use fragments to share the fields between a query and a mutation that updates that query.\n\n## Server\n\nFinally we're going to create our mutations in the server:\n\n[{]: <helper> (diffStep \"3.1\" module=\"server\")\n\n#### Step 3.1: Add mutations\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,6 +1,7 @@\n-â”Š1â”Š â”Šimport { Chat, db, Message, Recipient, User } from \"../db\";\n+â”Š â”Š1â”Šimport { Chat, db, Message, MessageType, Recipient, User } from \"../db\";\n â”Š2â”Š2â”Šimport { IResolvers } from \"graphql-tools/dist/Interfaces\";\n â”Š3â”Š3â”Šimport { ChatQueryArgs } from \"../types\";\n+â”Š â”Š4â”Šimport * as moment from \"moment\";\n â”Š4â”Š5â”Š\n â”Š5â”Š6â”Šlet users = db.users;\n â”Š6â”Š7â”Šlet chats = db.chats;\n```\n```diff\n@@ -13,6 +14,276 @@\n â”Š 13â”Š 14â”Š    chats: (): Chat[] => chats.filter(chat => chat.listingMemberIds.includes(currentUser)),\n â”Š 14â”Š 15â”Š    chat: (obj: any, {chatId}: ChatQueryArgs): Chat | null => chats.find(chat => chat.id === Number(chatId)) || null,\n â”Š 15â”Š 16â”Š  },\n+â”Š   â”Š 17â”Š  Mutation: {\n+â”Š   â”Š 18â”Š    addChat: (obj: any, {recipientId}: any): Chat => {\n+â”Š   â”Š 19â”Š      if (!users.find(user => user.id === recipientId)) {\n+â”Š   â”Š 20â”Š        throw new Error(`Recipient ${recipientId} doesn't exist.`);\n+â”Š   â”Š 21â”Š      }\n+â”Š   â”Š 22â”Š\n+â”Š   â”Š 23â”Š      const chat = chats.find(chat => !chat.name && chat.allTimeMemberIds.includes(currentUser) && chat.allTimeMemberIds.includes(recipientId));\n+â”Š   â”Š 24â”Š      if (chat) {\n+â”Š   â”Š 25â”Š        // Chat already exists. Both users are already in the allTimeMemberIds array\n+â”Š   â”Š 26â”Š        const chatId = chat.id;\n+â”Š   â”Š 27â”Š        if (!chat.listingMemberIds.includes(currentUser)) {\n+â”Š   â”Š 28â”Š          // The chat isn't listed for the current user. Add him to the memberIds\n+â”Š   â”Š 29â”Š          chat.listingMemberIds.push(currentUser);\n+â”Š   â”Š 30â”Š          chats.find(chat => chat.id === chatId)!.listingMemberIds.push(currentUser);\n+â”Š   â”Š 31â”Š          return chat;\n+â”Š   â”Š 32â”Š        } else {\n+â”Š   â”Š 33â”Š          throw new Error(`Chat already exists.`);\n+â”Š   â”Š 34â”Š        }\n+â”Š   â”Š 35â”Š      } else {\n+â”Š   â”Š 36â”Š        // Create the chat\n+â”Š   â”Š 37â”Š        const id = (chats.length && chats[chats.length - 1].id + 1) || 1;\n+â”Š   â”Š 38â”Š        const chat: Chat = {\n+â”Š   â”Š 39â”Š          id,\n+â”Š   â”Š 40â”Š          name: null,\n+â”Š   â”Š 41â”Š          picture: null,\n+â”Š   â”Š 42â”Š          adminIds: null,\n+â”Š   â”Š 43â”Š          ownerId: null,\n+â”Š   â”Š 44â”Š          allTimeMemberIds: [currentUser, recipientId],\n+â”Š   â”Š 45â”Š          // Chat will not be listed to the other user until the first message gets written\n+â”Š   â”Š 46â”Š          listingMemberIds: [currentUser],\n+â”Š   â”Š 47â”Š          actualGroupMemberIds: null,\n+â”Š   â”Š 48â”Š          messages: [],\n+â”Š   â”Š 49â”Š        };\n+â”Š   â”Š 50â”Š        chats.push(chat);\n+â”Š   â”Š 51â”Š        return chat;\n+â”Š   â”Š 52â”Š      }\n+â”Š   â”Š 53â”Š    },\n+â”Š   â”Š 54â”Š    addGroup: (obj: any, {recipientIds, groupName}: any): Chat => {\n+â”Š   â”Š 55â”Š      recipientIds.forEach((recipientId: any) => {\n+â”Š   â”Š 56â”Š        if (!users.find(user => user.id === recipientId)) {\n+â”Š   â”Š 57â”Š          throw new Error(`Recipient ${recipientId} doesn't exist.`);\n+â”Š   â”Š 58â”Š        }\n+â”Š   â”Š 59â”Š      });\n+â”Š   â”Š 60â”Š\n+â”Š   â”Š 61â”Š      const id = (chats.length && chats[chats.length - 1].id + 1) || 1;\n+â”Š   â”Š 62â”Š      const chat: Chat = {\n+â”Š   â”Š 63â”Š        id,\n+â”Š   â”Š 64â”Š        name: groupName,\n+â”Š   â”Š 65â”Š        picture: null,\n+â”Š   â”Š 66â”Š        adminIds: [currentUser],\n+â”Š   â”Š 67â”Š        ownerId: currentUser,\n+â”Š   â”Š 68â”Š        allTimeMemberIds: [currentUser, ...recipientIds],\n+â”Š   â”Š 69â”Š        listingMemberIds: [currentUser, ...recipientIds],\n+â”Š   â”Š 70â”Š        actualGroupMemberIds: [currentUser, ...recipientIds],\n+â”Š   â”Š 71â”Š        messages: [],\n+â”Š   â”Š 72â”Š      };\n+â”Š   â”Š 73â”Š      chats.push(chat);\n+â”Š   â”Š 74â”Š      return chat;\n+â”Š   â”Š 75â”Š    },\n+â”Š   â”Š 76â”Š    removeChat: (obj: any, {chatId}: any): number => {\n+â”Š   â”Š 77â”Š      const chat = chats.find(chat => chat.id === chatId);\n+â”Š   â”Š 78â”Š\n+â”Š   â”Š 79â”Š      if (!chat) {\n+â”Š   â”Š 80â”Š        throw new Error(`The chat ${chatId} doesn't exist.`);\n+â”Š   â”Š 81â”Š      }\n+â”Š   â”Š 82â”Š\n+â”Š   â”Š 83â”Š      if (!chat.name) {\n+â”Š   â”Š 84â”Š        // Chat\n+â”Š   â”Š 85â”Š        if (!chat.listingMemberIds.includes(currentUser)) {\n+â”Š   â”Š 86â”Š          throw new Error(`The user is not a member of the chat ${chatId}.`);\n+â”Š   â”Š 87â”Š        }\n+â”Š   â”Š 88â”Š\n+â”Š   â”Š 89â”Š        // Instead of chaining map and filter we can loop once using reduce\n+â”Š   â”Š 90â”Š        const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n+â”Š   â”Š 91â”Š          // Remove the current user from the message holders\n+â”Š   â”Š 92â”Š          message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser);\n+â”Š   â”Š 93â”Š\n+â”Š   â”Š 94â”Š          if (message.holderIds.length !== 0) {\n+â”Š   â”Š 95â”Š            filtered.push(message);\n+â”Š   â”Š 96â”Š          } // else discard the message\n+â”Š   â”Š 97â”Š\n+â”Š   â”Š 98â”Š          return filtered;\n+â”Š   â”Š 99â”Š        }, []);\n+â”Š   â”Š100â”Š\n+â”Š   â”Š101â”Š        // Remove the current user from who gets the chat listed. The chat will no longer appear in his list\n+â”Š   â”Š102â”Š        const listingMemberIds = chat.listingMemberIds.filter(listingId => listingId !== currentUser);\n+â”Š   â”Š103â”Š\n+â”Š   â”Š104â”Š        // Check how many members are left\n+â”Š   â”Š105â”Š        if (listingMemberIds.length === 0) {\n+â”Š   â”Š106â”Š          // Delete the chat\n+â”Š   â”Š107â”Š          chats = chats.filter(chat => chat.id !== chatId);\n+â”Š   â”Š108â”Š        } else {\n+â”Š   â”Š109â”Š          // Update the chat\n+â”Š   â”Š110â”Š          chats = chats.map(chat => {\n+â”Š   â”Š111â”Š            if (chat.id === chatId) {\n+â”Š   â”Š112â”Š              chat = {...chat, listingMemberIds, messages};\n+â”Š   â”Š113â”Š            }\n+â”Š   â”Š114â”Š            return chat;\n+â”Š   â”Š115â”Š          });\n+â”Š   â”Š116â”Š        }\n+â”Š   â”Š117â”Š        return chatId;\n+â”Š   â”Š118â”Š      } else {\n+â”Š   â”Š119â”Š        // Group\n+â”Š   â”Š120â”Š        if (chat.ownerId !== currentUser) {\n+â”Š   â”Š121â”Š          throw new Error(`Group ${chatId} is not owned by the user.`);\n+â”Š   â”Š122â”Š        }\n+â”Š   â”Š123â”Š\n+â”Š   â”Š124â”Š        // Instead of chaining map and filter we can loop once using reduce\n+â”Š   â”Š125â”Š        const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n+â”Š   â”Š126â”Š          // Remove the current user from the message holders\n+â”Š   â”Š127â”Š          message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser);\n+â”Š   â”Š128â”Š\n+â”Š   â”Š129â”Š          if (message.holderIds.length !== 0) {\n+â”Š   â”Š130â”Š            filtered.push(message);\n+â”Š   â”Š131â”Š          } // else discard the message\n+â”Š   â”Š132â”Š\n+â”Š   â”Š133â”Š          return filtered;\n+â”Š   â”Š134â”Š        }, []);\n+â”Š   â”Š135â”Š\n+â”Š   â”Š136â”Š        // Remove the current user from who gets the group listed. The group will no longer appear in his list\n+â”Š   â”Š137â”Š        const listingMemberIds = chat.listingMemberIds.filter(listingId => listingId !== currentUser);\n+â”Š   â”Š138â”Š\n+â”Š   â”Š139â”Š        // Check how many members (including previous ones who can still access old messages) are left\n+â”Š   â”Š140â”Š        if (listingMemberIds.length === 0) {\n+â”Š   â”Š141â”Š          // Remove the group\n+â”Š   â”Š142â”Š          chats = chats.filter(chat => chat.id !== chatId);\n+â”Š   â”Š143â”Š        } else {\n+â”Š   â”Š144â”Š          // Update the group\n+â”Š   â”Š145â”Š\n+â”Š   â”Š146â”Š          // Remove the current user from the chat members. He is no longer a member of the group\n+â”Š   â”Š147â”Š          const actualGroupMemberIds = chat.actualGroupMemberIds!.filter(memberId => memberId !== currentUser);\n+â”Š   â”Š148â”Š          // Remove the current user from the chat admins\n+â”Š   â”Š149â”Š          const adminIds = chat.adminIds!.filter(memberId => memberId !== currentUser);\n+â”Š   â”Š150â”Š          // Set the owner id to be null. A null owner means the group is read-only\n+â”Š   â”Š151â”Š          let ownerId: number | null = null;\n+â”Š   â”Š152â”Š\n+â”Š   â”Š153â”Š          // Check if there is any admin left\n+â”Š   â”Š154â”Š          if (adminIds!.length) {\n+â”Š   â”Š155â”Š            // Pick an admin as the new owner. The group is no longer read-only\n+â”Š   â”Š156â”Š            ownerId = chat.adminIds![0];\n+â”Š   â”Š157â”Š          }\n+â”Š   â”Š158â”Š\n+â”Š   â”Š159â”Š          chats = chats.map(chat => {\n+â”Š   â”Š160â”Š            if (chat.id === chatId) {\n+â”Š   â”Š161â”Š              chat = {...chat, messages, listingMemberIds, actualGroupMemberIds, adminIds, ownerId};\n+â”Š   â”Š162â”Š            }\n+â”Š   â”Š163â”Š            return chat;\n+â”Š   â”Š164â”Š          });\n+â”Š   â”Š165â”Š        }\n+â”Š   â”Š166â”Š        return chatId;\n+â”Š   â”Š167â”Š      }\n+â”Š   â”Š168â”Š    },\n+â”Š   â”Š169â”Š    addMessage: (obj: any, {chatId, content}: any): Message => {\n+â”Š   â”Š170â”Š      if (content === null || content === '') {\n+â”Š   â”Š171â”Š        throw new Error(`Cannot add empty or null messages.`);\n+â”Š   â”Š172â”Š      }\n+â”Š   â”Š173â”Š\n+â”Š   â”Š174â”Š      let chat = chats.find(chat => chat.id === chatId);\n+â”Š   â”Š175â”Š\n+â”Š   â”Š176â”Š      if (!chat) {\n+â”Š   â”Š177â”Š        throw new Error(`Cannot find chat ${chatId}.`);\n+â”Š   â”Š178â”Š      }\n+â”Š   â”Š179â”Š\n+â”Š   â”Š180â”Š      let holderIds = chat.listingMemberIds;\n+â”Š   â”Š181â”Š\n+â”Š   â”Š182â”Š      if (!chat.name) {\n+â”Š   â”Š183â”Š        // Chat\n+â”Š   â”Š184â”Š        if (!chat.listingMemberIds.find(listingId => listingId === currentUser)) {\n+â”Š   â”Š185â”Š          throw new Error(`The chat ${chatId} must be listed for the current user before adding a message.`);\n+â”Š   â”Š186â”Š        }\n+â”Š   â”Š187â”Š\n+â”Š   â”Š188â”Š        const recipientId = chat.allTimeMemberIds.filter(userId => userId !== currentUser)[0];\n+â”Š   â”Š189â”Š\n+â”Š   â”Š190â”Š        if (!chat.listingMemberIds.find(listingId => listingId === recipientId)) {\n+â”Š   â”Š191â”Š          // Chat is not listed for the recipient. Add him to the listingMemberIds\n+â”Š   â”Š192â”Š          const listingMemberIds = chat.listingMemberIds.concat(recipientId);\n+â”Š   â”Š193â”Š\n+â”Š   â”Š194â”Š          chats = chats.map(chat => {\n+â”Š   â”Š195â”Š            if (chat.id === chatId) {\n+â”Š   â”Š196â”Š              chat = {...chat, listingMemberIds};\n+â”Š   â”Š197â”Š            }\n+â”Š   â”Š198â”Š            return chat;\n+â”Š   â”Š199â”Š          });\n+â”Š   â”Š200â”Š\n+â”Š   â”Š201â”Š          holderIds = listingMemberIds;\n+â”Š   â”Š202â”Š        }\n+â”Š   â”Š203â”Š      } else {\n+â”Š   â”Š204â”Š        // Group\n+â”Š   â”Š205â”Š        if (!chat.actualGroupMemberIds!.find(memberId => memberId === currentUser)) {\n+â”Š   â”Š206â”Š          throw new Error(`The user is not a member of the group ${chatId}. Cannot add message.`);\n+â”Š   â”Š207â”Š        }\n+â”Š   â”Š208â”Š\n+â”Š   â”Š209â”Š        holderIds = chat.actualGroupMemberIds!;\n+â”Š   â”Š210â”Š      }\n+â”Š   â”Š211â”Š\n+â”Š   â”Š212â”Š      const id = (chat.messages.length && chat.messages[chat.messages.length - 1].id + 1) || 1;\n+â”Š   â”Š213â”Š\n+â”Š   â”Š214â”Š      let recipients: Recipient[] = [];\n+â”Š   â”Š215â”Š\n+â”Š   â”Š216â”Š      holderIds.forEach(holderId => {\n+â”Š   â”Š217â”Š        if (holderId !== currentUser) {\n+â”Š   â”Š218â”Š          recipients.push({\n+â”Š   â”Š219â”Š            userId: holderId,\n+â”Š   â”Š220â”Š            messageId: id,\n+â”Š   â”Š221â”Š            chatId: chatId,\n+â”Š   â”Š222â”Š            receivedAt: null,\n+â”Š   â”Š223â”Š            readAt: null,\n+â”Š   â”Š224â”Š          });\n+â”Š   â”Š225â”Š        }\n+â”Š   â”Š226â”Š      });\n+â”Š   â”Š227â”Š\n+â”Š   â”Š228â”Š      const message: Message = {\n+â”Š   â”Š229â”Š        id,\n+â”Š   â”Š230â”Š        chatId,\n+â”Š   â”Š231â”Š        senderId: currentUser,\n+â”Š   â”Š232â”Š        content,\n+â”Š   â”Š233â”Š        createdAt: moment().unix(),\n+â”Š   â”Š234â”Š        type: MessageType.TEXT,\n+â”Š   â”Š235â”Š        recipients,\n+â”Š   â”Š236â”Š        holderIds,\n+â”Š   â”Š237â”Š      };\n+â”Š   â”Š238â”Š\n+â”Š   â”Š239â”Š      chats = chats.map(chat => {\n+â”Š   â”Š240â”Š        if (chat.id === chatId) {\n+â”Š   â”Š241â”Š          chat = {...chat, messages: chat.messages.concat(message)}\n+â”Š   â”Š242â”Š        }\n+â”Š   â”Š243â”Š        return chat;\n+â”Š   â”Š244â”Š      });\n+â”Š   â”Š245â”Š\n+â”Š   â”Š246â”Š      return message;\n+â”Š   â”Š247â”Š    },\n+â”Š   â”Š248â”Š    removeMessages: (obj: any, {chatId, messageIds, all}: any): number[] => {\n+â”Š   â”Š249â”Š      const chat = chats.find(chat => chat.id === chatId);\n+â”Š   â”Š250â”Š\n+â”Š   â”Š251â”Š      if (!chat) {\n+â”Š   â”Š252â”Š        throw new Error(`Cannot find chat ${chatId}.`);\n+â”Š   â”Š253â”Š      }\n+â”Š   â”Š254â”Š\n+â”Š   â”Š255â”Š      if (!chat.listingMemberIds.find(listingId => listingId === currentUser)) {\n+â”Š   â”Š256â”Š        throw new Error(`The chat/group ${chatId} is not listed for the current user, so there is nothing to delete.`);\n+â”Š   â”Š257â”Š      }\n+â”Š   â”Š258â”Š\n+â”Š   â”Š259â”Š      if (all && messageIds) {\n+â”Š   â”Š260â”Š        throw new Error(`Cannot specify both 'all' and 'messageIds'.`);\n+â”Š   â”Š261â”Š      }\n+â”Š   â”Š262â”Š\n+â”Š   â”Š263â”Š      let deletedIds: number[] = [];\n+â”Š   â”Š264â”Š      chats = chats.map(chat => {\n+â”Š   â”Š265â”Š        if (chat.id === chatId) {\n+â”Š   â”Š266â”Š          // Instead of chaining map and filter we can loop once using reduce\n+â”Š   â”Š267â”Š          const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n+â”Š   â”Š268â”Š            if (all || messageIds!.includes(message.id)) {\n+â”Š   â”Š269â”Š              deletedIds.push(message.id);\n+â”Š   â”Š270â”Š              // Remove the current user from the message holders\n+â”Š   â”Š271â”Š              message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser);\n+â”Š   â”Š272â”Š            }\n+â”Š   â”Š273â”Š\n+â”Š   â”Š274â”Š            if (message.holderIds.length !== 0) {\n+â”Š   â”Š275â”Š              filtered.push(message);\n+â”Š   â”Š276â”Š            } // else discard the message\n+â”Š   â”Š277â”Š\n+â”Š   â”Š278â”Š            return filtered;\n+â”Š   â”Š279â”Š          }, []);\n+â”Š   â”Š280â”Š          chat = {...chat, messages};\n+â”Š   â”Š281â”Š        }\n+â”Š   â”Š282â”Š        return chat;\n+â”Š   â”Š283â”Š      });\n+â”Š   â”Š284â”Š      return deletedIds;\n+â”Š   â”Š285â”Š    },\n+â”Š   â”Š286â”Š  },\n â”Š 16â”Š287â”Š  Chat: {\n â”Š 17â”Š288â”Š    name: (chat: Chat): string => chat.name ? chat.name : users\n â”Š 18â”Š289â”Š      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser))!.name,\n```\n\n##### Changed schema&#x2F;typeDefs.ts\n```diff\n@@ -67,4 +67,20 @@\n â”Š67â”Š67â”Š    picture: String\n â”Š68â”Š68â”Š    phone: String\n â”Š69â”Š69â”Š  }\n+â”Š  â”Š70â”Š\n+â”Š  â”Š71â”Š  type Mutation {\n+â”Š  â”Š72â”Š    addChat(recipientId: ID!): Chat\n+â”Š  â”Š73â”Š    addGroup(recipientIds: [ID!]!, groupName: String!): Chat\n+â”Š  â”Š74â”Š    removeChat(chatId: ID!): ID\n+â”Š  â”Š75â”Š    addMessage(chatId: ID!, content: String!): Message\n+â”Š  â”Š76â”Š    removeMessages(chatId: ID!, messageIds: [ID], all: Boolean): [ID]\n+â”Š  â”Š77â”Š    addMembers(groupId: ID!, userIds: [ID!]!): [ID]\n+â”Š  â”Š78â”Š    removeMembers(groupId: ID!, userIds: [ID!]!): [ID]\n+â”Š  â”Š79â”Š    addAdmins(groupId: ID!, userIds: [ID!]!): [ID]\n+â”Š  â”Š80â”Š    removeAdmins(groupId: ID!, userIds: [ID!]!): [ID]\n+â”Š  â”Š81â”Š    setGroupName(groupId: ID!): String\n+â”Š  â”Š82â”Š    setGroupPicture(groupId: ID!): String\n+â”Š  â”Š83â”Š    markAsReceived(chatId: ID!): Boolean\n+â”Š  â”Š84â”Š    markAsRead(chatId: ID!): Boolean\n+â”Š  â”Š85â”Š  }\n â”Š70â”Š86â”Š`;\n```\n\n[}]: #\n\nLet me briefly explain what's going on here.\nFor each chat/group we store the `allTimeMemberIds`, `listingMemberIds` and `actualGroupMemberIds` properties in our NoSQL-like fake db.\nWhat's the difference between `allTimeMemberIds` and `listingMemberIds`? When a chat gets created only the user who created it will be able too see it, the chat will be displayed to the other user only once the first messaged gets sent. `allTimeMemberIds` is an array which always contain both the users, while `listingMemberIds` contains only the users which get the chat listed (initially the creator, later both users). `actualGroupMemberIds` is only used for groups.\nGroups, instead, get listed by all members immediately since the creation. So initially both `allTimeMemberIds`, `listingMemberIds` and `actualGroupMemberIds` are similar. Later users can leave the group or get deleted (so they will be removed from `actualGroupMemberIds`) but they will still be able to list the group in read-only mode, thus remaining in the `listingMemberIds`. Once they remove the group they will also be remove from the `listingMemberIds` array.\nThat's why we have to check for several different conditions before adding/deleting messages: it could be necessary to add the other peer to the `listingMemberIds` (for example if we are writing the first message of a chat) or it could be necessary to physically remove the messages instead of simply removing the current user from the `holderIds`. `holderIds` is a field in each message which states which user will currently display that specific message. In fact each user can delete a specific message without affecting what the others will see. Once there will be no more users in the `holderIds` array it will be safe to delete the message.\nEach message has also a `recipients` array containing the receiving date and the viewing date of that particular message for all the other users. That's necessary to implement the single, double and blue ticks used by the real Whatsapp.\n\nIt may seem a bit overwhelming at first, but you should keep in mind that the real Whatsapp has tons of features and also takes advantage of a local database to store messages, so it's easier for them to implement features like per-user messages: their source of truth is not the server because once downloaded the messages are kept in the client itself, so deleting messages doesn't affect anyone else. On the contrary our source of truth is the server, so our approach is more similar to Telegram instead. This is a better approach in my opinion because it allows us to show the messages for the same user on multiple clients, instead of having to rely on questionable approaches like Whatsapp Web.\nAlso we already implemented our mutations to take care of future use cases (like reading notifications) which we still didn't implement.\n\nI said we were going to take greater advantage of `graphql-code-generator` once we started writing our first mutation and I'm going to show you why. Let's run the generator first:\n\n    $ npm run generator\n\nThen let's use the generated types:\n\n[{]: <helper> (diffStep \"3.3\" module=\"server\")\n\n#### Step 3.3: Use generated types\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,6 +1,9 @@\n â”Š1â”Š1â”Šimport { Chat, db, Message, MessageType, Recipient, User } from \"../db\";\n â”Š2â”Š2â”Šimport { IResolvers } from \"graphql-tools/dist/Interfaces\";\n-â”Š3â”Š â”Šimport { ChatQueryArgs } from \"../types\";\n+â”Š â”Š3â”Šimport {\n+â”Š â”Š4â”Š  AddChatMutationArgs, AddGroupMutationArgs, AddMessageMutationArgs, ChatQueryArgs,\n+â”Š â”Š5â”Š  RemoveChatMutationArgs, RemoveMessagesMutationArgs\n+â”Š â”Š6â”Š} from \"../types\";\n â”Š4â”Š7â”Šimport * as moment from \"moment\";\n â”Š5â”Š8â”Š\n â”Š6â”Š9â”Šlet users = db.users;\n```\n```diff\n@@ -15,12 +18,12 @@\n â”Š15â”Š18â”Š    chat: (obj: any, {chatId}: ChatQueryArgs): Chat | null => chats.find(chat => chat.id === Number(chatId)) || null,\n â”Š16â”Š19â”Š  },\n â”Š17â”Š20â”Š  Mutation: {\n-â”Š18â”Š  â”Š    addChat: (obj: any, {recipientId}: any): Chat => {\n-â”Š19â”Š  â”Š      if (!users.find(user => user.id === recipientId)) {\n+â”Š  â”Š21â”Š    addChat: (obj: any, {recipientId}: AddChatMutationArgs): Chat => {\n+â”Š  â”Š22â”Š      if (!users.find(user => user.id === Number(recipientId))) {\n â”Š20â”Š23â”Š        throw new Error(`Recipient ${recipientId} doesn't exist.`);\n â”Š21â”Š24â”Š      }\n â”Š22â”Š25â”Š\n-â”Š23â”Š  â”Š      const chat = chats.find(chat => !chat.name && chat.allTimeMemberIds.includes(currentUser) && chat.allTimeMemberIds.includes(recipientId));\n+â”Š  â”Š26â”Š      const chat = chats.find(chat => !chat.name && chat.allTimeMemberIds.includes(currentUser) && chat.allTimeMemberIds.includes(Number(recipientId)));\n â”Š24â”Š27â”Š      if (chat) {\n â”Š25â”Š28â”Š        // Chat already exists. Both users are already in the allTimeMemberIds array\n â”Š26â”Š29â”Š        const chatId = chat.id;\n```\n```diff\n@@ -41,7 +44,7 @@\n â”Š41â”Š44â”Š          picture: null,\n â”Š42â”Š45â”Š          adminIds: null,\n â”Š43â”Š46â”Š          ownerId: null,\n-â”Š44â”Š  â”Š          allTimeMemberIds: [currentUser, recipientId],\n+â”Š  â”Š47â”Š          allTimeMemberIds: [currentUser, Number(recipientId)],\n â”Š45â”Š48â”Š          // Chat will not be listed to the other user until the first message gets written\n â”Š46â”Š49â”Š          listingMemberIds: [currentUser],\n â”Š47â”Š50â”Š          actualGroupMemberIds: null,\n```\n```diff\n@@ -51,9 +54,9 @@\n â”Š51â”Š54â”Š        return chat;\n â”Š52â”Š55â”Š      }\n â”Š53â”Š56â”Š    },\n-â”Š54â”Š  â”Š    addGroup: (obj: any, {recipientIds, groupName}: any): Chat => {\n-â”Š55â”Š  â”Š      recipientIds.forEach((recipientId: any) => {\n-â”Š56â”Š  â”Š        if (!users.find(user => user.id === recipientId)) {\n+â”Š  â”Š57â”Š    addGroup: (obj: any, {recipientIds, groupName}: AddGroupMutationArgs): Chat => {\n+â”Š  â”Š58â”Š      recipientIds.forEach(recipientId => {\n+â”Š  â”Š59â”Š        if (!users.find(user => user.id === Number(recipientId))) {\n â”Š57â”Š60â”Š          throw new Error(`Recipient ${recipientId} doesn't exist.`);\n â”Š58â”Š61â”Š        }\n â”Š59â”Š62â”Š      });\n```\n```diff\n@@ -65,16 +68,16 @@\n â”Š65â”Š68â”Š        picture: null,\n â”Š66â”Š69â”Š        adminIds: [currentUser],\n â”Š67â”Š70â”Š        ownerId: currentUser,\n-â”Š68â”Š  â”Š        allTimeMemberIds: [currentUser, ...recipientIds],\n-â”Š69â”Š  â”Š        listingMemberIds: [currentUser, ...recipientIds],\n-â”Š70â”Š  â”Š        actualGroupMemberIds: [currentUser, ...recipientIds],\n+â”Š  â”Š71â”Š        allTimeMemberIds: [currentUser, ...recipientIds.map(id => Number(id))],\n+â”Š  â”Š72â”Š        listingMemberIds: [currentUser, ...recipientIds.map(id => Number(id))],\n+â”Š  â”Š73â”Š        actualGroupMemberIds: [currentUser, ...recipientIds.map(id => Number(id))],\n â”Š71â”Š74â”Š        messages: [],\n â”Š72â”Š75â”Š      };\n â”Š73â”Š76â”Š      chats.push(chat);\n â”Š74â”Š77â”Š      return chat;\n â”Š75â”Š78â”Š    },\n-â”Š76â”Š  â”Š    removeChat: (obj: any, {chatId}: any): number => {\n-â”Š77â”Š  â”Š      const chat = chats.find(chat => chat.id === chatId);\n+â”Š  â”Š79â”Š    removeChat: (obj: any, {chatId}: RemoveChatMutationArgs): number => {\n+â”Š  â”Š80â”Š      const chat = chats.find(chat => chat.id === Number(chatId));\n â”Š78â”Š81â”Š\n â”Š79â”Š82â”Š      if (!chat) {\n â”Š80â”Š83â”Š        throw new Error(`The chat ${chatId} doesn't exist.`);\n```\n```diff\n@@ -104,17 +107,17 @@\n â”Š104â”Š107â”Š        // Check how many members are left\n â”Š105â”Š108â”Š        if (listingMemberIds.length === 0) {\n â”Š106â”Š109â”Š          // Delete the chat\n-â”Š107â”Š   â”Š          chats = chats.filter(chat => chat.id !== chatId);\n+â”Š   â”Š110â”Š          chats = chats.filter(chat => chat.id !== Number(chatId));\n â”Š108â”Š111â”Š        } else {\n â”Š109â”Š112â”Š          // Update the chat\n â”Š110â”Š113â”Š          chats = chats.map(chat => {\n-â”Š111â”Š   â”Š            if (chat.id === chatId) {\n+â”Š   â”Š114â”Š            if (chat.id === Number(chatId)) {\n â”Š112â”Š115â”Š              chat = {...chat, listingMemberIds, messages};\n â”Š113â”Š116â”Š            }\n â”Š114â”Š117â”Š            return chat;\n â”Š115â”Š118â”Š          });\n â”Š116â”Š119â”Š        }\n-â”Š117â”Š   â”Š        return chatId;\n+â”Š   â”Š120â”Š        return Number(chatId);\n â”Š118â”Š121â”Š      } else {\n â”Š119â”Š122â”Š        // Group\n â”Š120â”Š123â”Š        if (chat.ownerId !== currentUser) {\n```\n```diff\n@@ -139,7 +142,7 @@\n â”Š139â”Š142â”Š        // Check how many members (including previous ones who can still access old messages) are left\n â”Š140â”Š143â”Š        if (listingMemberIds.length === 0) {\n â”Š141â”Š144â”Š          // Remove the group\n-â”Š142â”Š   â”Š          chats = chats.filter(chat => chat.id !== chatId);\n+â”Š   â”Š145â”Š          chats = chats.filter(chat => chat.id !== Number(chatId));\n â”Š143â”Š146â”Š        } else {\n â”Š144â”Š147â”Š          // Update the group\n â”Š145â”Š148â”Š\n```\n```diff\n@@ -157,21 +160,21 @@\n â”Š157â”Š160â”Š          }\n â”Š158â”Š161â”Š\n â”Š159â”Š162â”Š          chats = chats.map(chat => {\n-â”Š160â”Š   â”Š            if (chat.id === chatId) {\n+â”Š   â”Š163â”Š            if (chat.id === Number(chatId)) {\n â”Š161â”Š164â”Š              chat = {...chat, messages, listingMemberIds, actualGroupMemberIds, adminIds, ownerId};\n â”Š162â”Š165â”Š            }\n â”Š163â”Š166â”Š            return chat;\n â”Š164â”Š167â”Š          });\n â”Š165â”Š168â”Š        }\n-â”Š166â”Š   â”Š        return chatId;\n+â”Š   â”Š169â”Š        return Number(chatId);\n â”Š167â”Š170â”Š      }\n â”Š168â”Š171â”Š    },\n-â”Š169â”Š   â”Š    addMessage: (obj: any, {chatId, content}: any): Message => {\n+â”Š   â”Š172â”Š    addMessage: (obj: any, {chatId, content}: AddMessageMutationArgs): Message => {\n â”Š170â”Š173â”Š      if (content === null || content === '') {\n â”Š171â”Š174â”Š        throw new Error(`Cannot add empty or null messages.`);\n â”Š172â”Š175â”Š      }\n â”Š173â”Š176â”Š\n-â”Š174â”Š   â”Š      let chat = chats.find(chat => chat.id === chatId);\n+â”Š   â”Š177â”Š      let chat = chats.find(chat => chat.id === Number(chatId));\n â”Š175â”Š178â”Š\n â”Š176â”Š179â”Š      if (!chat) {\n â”Š177â”Š180â”Š        throw new Error(`Cannot find chat ${chatId}.`);\n```\n```diff\n@@ -192,7 +195,7 @@\n â”Š192â”Š195â”Š          const listingMemberIds = chat.listingMemberIds.concat(recipientId);\n â”Š193â”Š196â”Š\n â”Š194â”Š197â”Š          chats = chats.map(chat => {\n-â”Š195â”Š   â”Š            if (chat.id === chatId) {\n+â”Š   â”Š198â”Š            if (chat.id === Number(chatId)) {\n â”Š196â”Š199â”Š              chat = {...chat, listingMemberIds};\n â”Š197â”Š200â”Š            }\n â”Š198â”Š201â”Š            return chat;\n```\n```diff\n@@ -218,7 +221,7 @@\n â”Š218â”Š221â”Š          recipients.push({\n â”Š219â”Š222â”Š            userId: holderId,\n â”Š220â”Š223â”Š            messageId: id,\n-â”Š221â”Š   â”Š            chatId: chatId,\n+â”Š   â”Š224â”Š            chatId: Number(chatId),\n â”Š222â”Š225â”Š            receivedAt: null,\n â”Š223â”Š226â”Š            readAt: null,\n â”Š224â”Š227â”Š          });\n```\n```diff\n@@ -227,7 +230,7 @@\n â”Š227â”Š230â”Š\n â”Š228â”Š231â”Š      const message: Message = {\n â”Š229â”Š232â”Š        id,\n-â”Š230â”Š   â”Š        chatId,\n+â”Š   â”Š233â”Š        chatId: Number(chatId),\n â”Š231â”Š234â”Š        senderId: currentUser,\n â”Š232â”Š235â”Š        content,\n â”Š233â”Š236â”Š        createdAt: moment().unix(),\n```\n```diff\n@@ -237,7 +240,7 @@\n â”Š237â”Š240â”Š      };\n â”Š238â”Š241â”Š\n â”Š239â”Š242â”Š      chats = chats.map(chat => {\n-â”Š240â”Š   â”Š        if (chat.id === chatId) {\n+â”Š   â”Š243â”Š        if (chat.id === Number(chatId)) {\n â”Š241â”Š244â”Š          chat = {...chat, messages: chat.messages.concat(message)}\n â”Š242â”Š245â”Š        }\n â”Š243â”Š246â”Š        return chat;\n```\n```diff\n@@ -245,8 +248,8 @@\n â”Š245â”Š248â”Š\n â”Š246â”Š249â”Š      return message;\n â”Š247â”Š250â”Š    },\n-â”Š248â”Š   â”Š    removeMessages: (obj: any, {chatId, messageIds, all}: any): number[] => {\n-â”Š249â”Š   â”Š      const chat = chats.find(chat => chat.id === chatId);\n+â”Š   â”Š251â”Š    removeMessages: (obj: any, {chatId, messageIds, all}: RemoveMessagesMutationArgs): number[] => {\n+â”Š   â”Š252â”Š      const chat = chats.find(chat => chat.id === Number(chatId));\n â”Š250â”Š253â”Š\n â”Š251â”Š254â”Š      if (!chat) {\n â”Š252â”Š255â”Š        throw new Error(`Cannot find chat ${chatId}.`);\n```\n```diff\n@@ -262,10 +265,10 @@\n â”Š262â”Š265â”Š\n â”Š263â”Š266â”Š      let deletedIds: number[] = [];\n â”Š264â”Š267â”Š      chats = chats.map(chat => {\n-â”Š265â”Š   â”Š        if (chat.id === chatId) {\n+â”Š   â”Š268â”Š        if (chat.id === Number(chatId)) {\n â”Š266â”Š269â”Š          // Instead of chaining map and filter we can loop once using reduce\n â”Š267â”Š270â”Š          const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n-â”Š268â”Š   â”Š            if (all || messageIds!.includes(message.id)) {\n+â”Š   â”Š271â”Š            if (all || messageIds!.includes(String(message.id))) {\n â”Š269â”Š272â”Š              deletedIds.push(message.id);\n â”Š270â”Š273â”Š              // Remove the current user from the message holders\n â”Š271â”Š274â”Š              message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser);\n```\n\n[}]: #\n\n## Client\n\nFor the client I'll only show you how to make use of the addMessage mutation in this chapters. The other mutations will require much more boilerplate so I left them for their own chapter.\n\nLet's start by wiring the addMessage mutation. We're going to write the GraphQL query and then use the generator to generate the types:\n\n[{]: <helper> (diffStep \"5.1\" files=\"^\\(?!src/types.d.ts$\\).*\" module=\"client\")\n\n#### Step 5.1: Create addMessage mutation and generate types\n\n##### Added src&#x2F;graphql&#x2F;addMessage.mutation.ts\n```diff\n@@ -0,0 +1,13 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag';\n+â”Š  â”Š 2â”Šimport {fragments} from './fragment';\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Š// We use the gql tag to parse our query string into a query document\n+â”Š  â”Š 5â”Šexport const addMessageMutation = gql`\n+â”Š  â”Š 6â”Š  mutation AddMessage($chatId: ID!, $content: String!) {\n+â”Š  â”Š 7â”Š    addMessage(chatId: $chatId, content: $content) {\n+â”Š  â”Š 8â”Š      ...Message\n+â”Š  â”Š 9â”Š    }\n+â”Š  â”Š10â”Š  }\n+â”Š  â”Š11â”Š\n+â”Š  â”Š12â”Š  ${fragments['message']}\n+â”Š  â”Š13â”Š`;\n```\n\n[}]: #\n\nRun the generator:\n\n    $ npm run generator\n\nNow let's use the just-created query:\n\n[{]: <helper> (diffStep \"5.2\" module=\"client\")\n\n#### Step 5.2: Modify chat component and service\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.ts\n```diff\n@@ -13,7 +13,7 @@\n â”Š13â”Š13â”Š    </app-toolbar>\n â”Š14â”Š14â”Š    <div class=\"container\">\n â”Š15â”Š15â”Š      <app-messages-list [items]=\"messages\" [isGroup]=\"isGroup\"></app-messages-list>\n-â”Š16â”Š  â”Š      <app-new-message></app-new-message>\n+â”Š  â”Š16â”Š      <app-new-message (newMessage)=\"addMessage($event)\"></app-new-message>\n â”Š17â”Š17â”Š    </div>\n â”Š18â”Š18â”Š  `,\n â”Š19â”Š19â”Š  styleUrls: ['./chat.component.scss']\n```\n```diff\n@@ -43,4 +43,8 @@\n â”Š43â”Š43â”Š  goToChats() {\n â”Š44â”Š44â”Š    this.router.navigate(['/chats']);\n â”Š45â”Š45â”Š  }\n+â”Š  â”Š46â”Š\n+â”Š  â”Š47â”Š  addMessage(content: string) {\n+â”Š  â”Š48â”Š    this.chatsService.addMessage(this.chatId, content).subscribe();\n+â”Š  â”Š49â”Š  }\n â”Š46â”Š50â”Š}\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -3,8 +3,9 @@\n â”Š 3â”Š 3â”Šimport {Apollo} from 'apollo-angular';\n â”Š 4â”Š 4â”Šimport {Injectable} from '@angular/core';\n â”Š 5â”Š 5â”Šimport {getChatsQuery} from '../../graphql/getChats.query';\n-â”Š 6â”Š  â”Šimport {GetChat, GetChats} from '../../types';\n+â”Š  â”Š 6â”Šimport {AddMessage, GetChat, GetChats} from '../../types';\n â”Š 7â”Š 7â”Šimport {getChatQuery} from '../../graphql/getChat.query';\n+â”Š  â”Š 8â”Šimport {addMessageMutation} from '../../graphql/addMessage.mutation';\n â”Š 8â”Š 9â”Š\n â”Š 9â”Š10â”Š@Injectable()\n â”Š10â”Š11â”Šexport class ChatsService {\n```\n```diff\n@@ -40,4 +41,14 @@\n â”Š40â”Š41â”Š\n â”Š41â”Š42â”Š    return {query, chat$};\n â”Š42â”Š43â”Š  }\n+â”Š  â”Š44â”Š\n+â”Š  â”Š45â”Š  addMessage(chatId: string, content: string) {\n+â”Š  â”Š46â”Š    return this.apollo.mutate({\n+â”Š  â”Š47â”Š      mutation: addMessageMutation,\n+â”Š  â”Š48â”Š      variables: <AddMessage.Variables>{\n+â”Š  â”Š49â”Š        chatId,\n+â”Š  â”Š50â”Š        content,\n+â”Š  â”Š51â”Š      },\n+â”Š  â”Š52â”Š    });\n+â”Š  â”Š53â”Š  }\n â”Š43â”Š54â”Š}\n```\n\n[}]: #\n\nIt's that simple! You would be tempted to say that it doesn't work, but you should try to refresh the page first ;)"
          },
          {
            "manualTitle": "Step 10: Updating the store",
            "stepRevision": "bf9da3af4a4f3d0ab28630cb1d8d888b0ad1c407",
            "manualView": "## Client\n\nDid you notice that after creating a new message you'll have to refresh the page in order to see it?\nHow to fix that? If you thought about re-querying the server you would be wrong! The best solution is to use the response provided by the server to update our Apollo local cache.\n\nApollo performs two important core tasks: Executing queries and mutations, and caching the results.\n\nThanks to Apolloâ€™s store design, itâ€™s possible for the results of a query or mutation to update your UI in all the right places. In many cases itâ€™s possible for that to happen automatically, whereas in others you need to help the client out a little in doing so:\n\n[{]: <helper> (diffStep \"6.1\" module=\"client\")\n\n#### Step 6.1: Update the store\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,4 +1,4 @@\n-â”Š1â”Š â”Šimport {ApolloQueryResult, WatchQueryOptions} from 'apollo-client';\n+â”Š â”Š1â”Šimport {ApolloQueryResult, MutationOptions, WatchQueryOptions} from 'apollo-client';\n â”Š2â”Š2â”Šimport {map} from 'rxjs/operators';\n â”Š3â”Š3â”Šimport {Apollo} from 'apollo-angular';\n â”Š4â”Š4â”Šimport {Injectable} from '@angular/core';\n```\n```diff\n@@ -43,12 +43,49 @@\n â”Š43â”Š43â”Š  }\n â”Š44â”Š44â”Š\n â”Š45â”Š45â”Š  addMessage(chatId: string, content: string) {\n-â”Š46â”Š  â”Š    return this.apollo.mutate({\n+â”Š  â”Š46â”Š    return this.apollo.mutate(<MutationOptions>{\n â”Š47â”Š47â”Š      mutation: addMessageMutation,\n â”Š48â”Š48â”Š      variables: <AddMessage.Variables>{\n â”Š49â”Š49â”Š        chatId,\n â”Š50â”Š50â”Š        content,\n â”Š51â”Š51â”Š      },\n+â”Š  â”Š52â”Š      update: (store, { data: { addMessage } }: {data: AddMessage.Mutation}) => {\n+â”Š  â”Š53â”Š        // Update the messages cache\n+â”Š  â”Š54â”Š        {\n+â”Š  â”Š55â”Š          // Read the data from our cache for this query.\n+â”Š  â”Š56â”Š          const {chat}: GetChat.Query = store.readQuery({\n+â”Š  â”Š57â”Š            query: getChatQuery, variables: {\n+â”Š  â”Š58â”Š              chatId,\n+â”Š  â”Š59â”Š            }\n+â”Š  â”Š60â”Š          });\n+â”Š  â”Š61â”Š          // Add our message from the mutation to the end.\n+â”Š  â”Š62â”Š          chat.messages.push(addMessage);\n+â”Š  â”Š63â”Š          // Write our data back to the cache.\n+â”Š  â”Š64â”Š          store.writeQuery({ query: getChatQuery, data: {chat} });\n+â”Š  â”Š65â”Š        }\n+â”Š  â”Š66â”Š        // Update last message cache\n+â”Š  â”Š67â”Š        {\n+â”Š  â”Š68â”Š          // Read the data from our cache for this query.\n+â”Š  â”Š69â”Š          const {chats}: GetChats.Query = store.readQuery({\n+â”Š  â”Š70â”Š            query: getChatsQuery,\n+â”Š  â”Š71â”Š            variables: <GetChats.Variables>{\n+â”Š  â”Š72â”Š              amount: this.messagesAmount,\n+â”Š  â”Š73â”Š            },\n+â”Š  â”Š74â”Š          });\n+â”Š  â”Š75â”Š          // Add our comment from the mutation to the end.\n+â”Š  â”Š76â”Š          chats.find(chat => chat.id === chatId).messages.push(addMessage);\n+â”Š  â”Š77â”Š          // Write our data back to the cache.\n+â”Š  â”Š78â”Š          store.writeQuery({\n+â”Š  â”Š79â”Š            query: getChatsQuery,\n+â”Š  â”Š80â”Š            variables: <GetChats.Variables>{\n+â”Š  â”Š81â”Š              amount: this.messagesAmount,\n+â”Š  â”Š82â”Š            },\n+â”Š  â”Š83â”Š            data: {\n+â”Š  â”Š84â”Š              chats,\n+â”Š  â”Š85â”Š            },\n+â”Š  â”Š86â”Š          });\n+â”Š  â”Š87â”Š        }\n+â”Š  â”Š88â”Š      },\n â”Š52â”Š89â”Š    });\n â”Š53â”Š90â”Š  }\n â”Š54â”Š91â”Š}\n```\n\n[}]: #\n\nNow you won't need to reload the page in order to see the new message. What's even more interesting is that the message you wrote would also be shown as the last message in the chats list, just hit the back button in the top-left corner to find out!\nThis is because we updated our store for both the `GetChat` and the `GetChats` query."
          },
          {
            "manualTitle": "Step 11: Messages and chats removal",
            "stepRevision": "54c98b0522a09730643a34b5133dcae4711e80ee",
            "manualView": "## Client\n\nSince we're now familiar with the way mutations work, it's time to add messages and chats removal to our list of features!\nSince the most annoying part is going to be dealing with the user interface (because a multiple selection started by a press event is involved), I created an Angular directive to ease the process.\nLet's start by installing it:\n\n    $ npm install ngx-selectable-list\n\nNow let's import it:\n\n[{]: <helper> (diffStep \"7.1\" files=\"^\\(?!package.json$\\).*\" module=\"client\")\n\n#### Step 7.1: Add SelectableListModule\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;chats-lister.module.ts\n```diff\n@@ -11,6 +11,7 @@\n â”Š11â”Š11â”Šimport {ChatsListComponent} from './components/chats-list/chats-list.component';\n â”Š12â”Š12â”Šimport {TruncateModule} from 'ng2-truncate';\n â”Š13â”Š13â”Šimport {SharedModule} from '../shared/shared.module';\n+â”Š  â”Š14â”Šimport {SelectableListModule} from 'ngx-selectable-list';\n â”Š14â”Š15â”Š\n â”Š15â”Š16â”Šconst routes: Routes = [\n â”Š16â”Š17â”Š  {path: '', redirectTo: 'chats', pathMatch: 'full'},\n```\n```diff\n@@ -40,6 +41,7 @@\n â”Š40â”Š41â”Š    TruncateModule,\n â”Š41â”Š42â”Š    // Feature modules\n â”Š42â”Š43â”Š    SharedModule,\n+â”Š  â”Š44â”Š    SelectableListModule,\n â”Š43â”Š45â”Š  ],\n â”Š44â”Š46â”Š  providers: [\n â”Š45â”Š47â”Š    ChatsService,\n```\n\n[}]: #\n\nLet's create the mutations:\n\n[{]: <helper> (diffStep \"7.2\" files=\"src/graphql\" module=\"client\")\n\n#### Step 7.2: Remove messages and chats\n\n##### Added src&#x2F;graphql&#x2F;removeAllMessages.mutation.ts\n```diff\n@@ -0,0 +1,8 @@\n+â”Š â”Š1â”Šimport gql from 'graphql-tag';\n+â”Š â”Š2â”Š\n+â”Š â”Š3â”Š// We use the gql tag to parse our query string into a query document\n+â”Š â”Š4â”Šexport const removeAllMessagesMutation = gql`\n+â”Š â”Š5â”Š  mutation RemoveAllMessages($chatId: ID!, $all: Boolean) {\n+â”Š â”Š6â”Š    removeMessages(chatId: $chatId, all: $all)\n+â”Š â”Š7â”Š  }\n+â”Š â”Š8â”Š`;\n```\n\n##### Added src&#x2F;graphql&#x2F;removeChat.mutation.ts\n```diff\n@@ -0,0 +1,8 @@\n+â”Š â”Š1â”Šimport gql from 'graphql-tag';\n+â”Š â”Š2â”Š\n+â”Š â”Š3â”Š// We use the gql tag to parse our query string into a query document\n+â”Š â”Š4â”Šexport const removeChatMutation = gql`\n+â”Š â”Š5â”Š  mutation RemoveChat($chatId: ID!) {\n+â”Š â”Š6â”Š    removeChat(chatId: $chatId)\n+â”Š â”Š7â”Š  }\n+â”Š â”Š8â”Š`;\n```\n\n##### Added src&#x2F;graphql&#x2F;removeMessages.mutation.ts\n```diff\n@@ -0,0 +1,8 @@\n+â”Š â”Š1â”Šimport gql from 'graphql-tag';\n+â”Š â”Š2â”Š\n+â”Š â”Š3â”Š// We use the gql tag to parse our query string into a query document\n+â”Š â”Š4â”Šexport const removeMessagesMutation = gql`\n+â”Š â”Š5â”Š  mutation RemoveMessages($chatId: ID!, $messageIds: [ID]) {\n+â”Š â”Š6â”Š    removeMessages(chatId: $chatId, messageIds: $messageIds)\n+â”Š â”Š7â”Š  }\n+â”Š â”Š8â”Š`;\n```\n\n[}]: #\n\nNow let's update our service:\n\n[{]: <helper> (diffStep \"7.2\" files=\"chats.service.ts\" module=\"client\")\n\n#### Step 7.2: Remove messages and chats\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -3,9 +3,13 @@\n â”Š 3â”Š 3â”Šimport {Apollo} from 'apollo-angular';\n â”Š 4â”Š 4â”Šimport {Injectable} from '@angular/core';\n â”Š 5â”Š 5â”Šimport {getChatsQuery} from '../../graphql/getChats.query';\n-â”Š 6â”Š  â”Šimport {AddMessage, GetChat, GetChats} from '../../types';\n+â”Š  â”Š 6â”Šimport {AddMessage, GetChat, GetChats, RemoveAllMessages, RemoveChat, RemoveMessages} from '../../types';\n â”Š 7â”Š 7â”Šimport {getChatQuery} from '../../graphql/getChat.query';\n â”Š 8â”Š 8â”Šimport {addMessageMutation} from '../../graphql/addMessage.mutation';\n+â”Š  â”Š 9â”Šimport {removeChatMutation} from '../../graphql/removeChat.mutation';\n+â”Š  â”Š10â”Šimport {DocumentNode} from 'graphql';\n+â”Š  â”Š11â”Šimport {removeAllMessagesMutation} from '../../graphql/removeAllMessages.mutation';\n+â”Š  â”Š12â”Šimport {removeMessagesMutation} from '../../graphql/removeMessages.mutation';\n â”Š 9â”Š13â”Š\n â”Š10â”Š14â”Š@Injectable()\n â”Š11â”Š15â”Šexport class ChatsService {\n```\n```diff\n@@ -88,4 +92,104 @@\n â”Š 88â”Š 92â”Š      },\n â”Š 89â”Š 93â”Š    });\n â”Š 90â”Š 94â”Š  }\n+â”Š   â”Š 95â”Š\n+â”Š   â”Š 96â”Š  removeChat(chatId: string) {\n+â”Š   â”Š 97â”Š    return this.apollo.mutate({\n+â”Š   â”Š 98â”Š      mutation: removeChatMutation,\n+â”Š   â”Š 99â”Š      variables: <RemoveChat.Variables>{\n+â”Š   â”Š100â”Š        chatId,\n+â”Š   â”Š101â”Š      },\n+â”Š   â”Š102â”Š      update: (store, { data: { removeChat } }) => {\n+â”Š   â”Š103â”Š        // Read the data from our cache for this query.\n+â”Š   â”Š104â”Š        const {chats}: GetChats.Query = store.readQuery({\n+â”Š   â”Š105â”Š          query: getChatsQuery,\n+â”Š   â”Š106â”Š          variables: <GetChats.Variables>{\n+â”Š   â”Š107â”Š            amount: this.messagesAmount,\n+â”Š   â”Š108â”Š          },\n+â”Š   â”Š109â”Š        });\n+â”Š   â”Š110â”Š        // Remove the chat (mutable)\n+â”Š   â”Š111â”Š        for (const index of chats.keys()) {\n+â”Š   â”Š112â”Š          if (chats[index].id === removeChat) {\n+â”Š   â”Š113â”Š            chats.splice(index, 1);\n+â”Š   â”Š114â”Š          }\n+â”Š   â”Š115â”Š        }\n+â”Š   â”Š116â”Š        // Write our data back to the cache.\n+â”Š   â”Š117â”Š        store.writeQuery({\n+â”Š   â”Š118â”Š          query: getChatsQuery,\n+â”Š   â”Š119â”Š          variables: <GetChats.Variables>{\n+â”Š   â”Š120â”Š            amount: this.messagesAmount,\n+â”Š   â”Š121â”Š          },\n+â”Š   â”Š122â”Š          data: {\n+â”Š   â”Š123â”Š            chats,\n+â”Š   â”Š124â”Š          },\n+â”Š   â”Š125â”Š        });\n+â”Š   â”Š126â”Š      },\n+â”Š   â”Š127â”Š    });\n+â”Š   â”Š128â”Š  }\n+â”Š   â”Š129â”Š\n+â”Š   â”Š130â”Š  removeMessages(chatId: string, messages: GetChat.Messages[], messageIdsOrAll: string[] | boolean) {\n+â”Š   â”Š131â”Š    let variables: RemoveMessages.Variables | RemoveAllMessages.Variables;\n+â”Š   â”Š132â”Š    let ids: string[] = [];\n+â”Š   â”Š133â”Š    let mutation: DocumentNode;\n+â”Š   â”Š134â”Š\n+â”Š   â”Š135â”Š    if (typeof messageIdsOrAll === 'boolean') {\n+â”Š   â”Š136â”Š      variables = {chatId, all: messageIdsOrAll} as RemoveAllMessages.Variables;\n+â”Š   â”Š137â”Š      ids = messages.map(message => message.id);\n+â”Š   â”Š138â”Š      mutation = removeAllMessagesMutation;\n+â”Š   â”Š139â”Š    } else {\n+â”Š   â”Š140â”Š      variables = {chatId, messageIds: messageIdsOrAll} as RemoveMessages.Variables;\n+â”Š   â”Š141â”Š      ids = messageIdsOrAll;\n+â”Š   â”Š142â”Š      mutation = removeMessagesMutation;\n+â”Š   â”Š143â”Š    }\n+â”Š   â”Š144â”Š\n+â”Š   â”Š145â”Š    return this.apollo.mutate(<MutationOptions>{\n+â”Š   â”Š146â”Š      mutation,\n+â”Š   â”Š147â”Š      variables,\n+â”Š   â”Š148â”Š      update: (store, { data: { removeMessages } }: {data: RemoveMessages.Mutation | RemoveAllMessages.Mutation}) => {\n+â”Š   â”Š149â”Š        // Update the messages cache\n+â”Š   â”Š150â”Š        {\n+â”Š   â”Š151â”Š          // Read the data from our cache for this query.\n+â”Š   â”Š152â”Š          const {chat}: GetChat.Query = store.readQuery({\n+â”Š   â”Š153â”Š            query: getChatQuery, variables: {\n+â”Š   â”Š154â”Š              chatId,\n+â”Š   â”Š155â”Š            }\n+â”Š   â”Š156â”Š          });\n+â”Š   â”Š157â”Š          // Remove the messages (mutable)\n+â”Š   â”Š158â”Š          removeMessages.forEach(messageId => {\n+â”Š   â”Š159â”Š            for (const index of chat.messages.keys()) {\n+â”Š   â”Š160â”Š              if (chat.messages[index].id === messageId) {\n+â”Š   â”Š161â”Š                chat.messages.splice(index, 1);\n+â”Š   â”Š162â”Š              }\n+â”Š   â”Š163â”Š            }\n+â”Š   â”Š164â”Š          });\n+â”Š   â”Š165â”Š          // Write our data back to the cache.\n+â”Š   â”Š166â”Š          store.writeQuery({ query: getChatQuery, data: {chat} });\n+â”Š   â”Š167â”Š        }\n+â”Š   â”Š168â”Š        // Update last message cache\n+â”Š   â”Š169â”Š        {\n+â”Š   â”Š170â”Š          // Read the data from our cache for this query.\n+â”Š   â”Š171â”Š          const {chats}: GetChats.Query = store.readQuery({\n+â”Š   â”Š172â”Š            query: getChatsQuery,\n+â”Š   â”Š173â”Š            variables: <GetChats.Variables>{\n+â”Š   â”Š174â”Š              amount: this.messagesAmount,\n+â”Š   â”Š175â”Š            },\n+â”Š   â”Š176â”Š          });\n+â”Š   â”Š177â”Š          // Fix last message\n+â”Š   â”Š178â”Š          chats.find(chat => chat.id === chatId).messages = messages\n+â”Š   â”Š179â”Š            .filter(message => !ids.includes(message.id))\n+â”Š   â”Š180â”Š            .sort((a, b) => Number(b.createdAt) - Number(a.createdAt)) || [];\n+â”Š   â”Š181â”Š          // Write our data back to the cache.\n+â”Š   â”Š182â”Š          store.writeQuery({\n+â”Š   â”Š183â”Š            query: getChatsQuery,\n+â”Š   â”Š184â”Š            variables: <GetChats.Variables>{\n+â”Š   â”Š185â”Š              amount: this.messagesAmount,\n+â”Š   â”Š186â”Š            },\n+â”Š   â”Š187â”Š            data: {\n+â”Š   â”Š188â”Š              chats,\n+â”Š   â”Š189â”Š            },\n+â”Š   â”Š190â”Š          });\n+â”Š   â”Š191â”Š        }\n+â”Š   â”Š192â”Š      },\n+â”Š   â”Š193â”Š    });\n+â”Š   â”Š194â”Š  }\n â”Š 91â”Š195â”Š}\n```\n\n[}]: #\n\nAs you can see every time that we remove a message we also have to update the last message in the chats list.\n\nFinally we can wire everything up into our components:\n\n[{]: <helper> (diffStep \"7.2\" files=\"src/app/chat-viewer, src/app/chats-lister, src/app/shared\" module=\"client\")\n\n#### Step 7.2: Remove messages and chats\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;chat-viewer.module.ts\n```diff\n@@ -11,6 +11,7 @@\n â”Š11â”Š11â”Šimport {MessageItemComponent} from './components/message-item/message-item.component';\n â”Š12â”Š12â”Šimport {NewMessageComponent} from './components/new-message/new-message.component';\n â”Š13â”Š13â”Šimport {SharedModule} from '../shared/shared.module';\n+â”Š  â”Š14â”Šimport {SelectableListModule} from 'ngx-selectable-list';\n â”Š14â”Š15â”Š\n â”Š15â”Š16â”Šconst routes: Routes = [\n â”Š16â”Š17â”Š  {\n```\n```diff\n@@ -44,6 +45,7 @@\n â”Š44â”Š45â”Š    FormsModule,\n â”Š45â”Š46â”Š    // Feature modules\n â”Š46â”Š47â”Š    SharedModule,\n+â”Š  â”Š48â”Š    SelectableListModule,\n â”Š47â”Š49â”Š  ],\n â”Š48â”Š50â”Š  providers: [\n â”Š49â”Š51â”Š    ChatsService,\n```\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;components&#x2F;messages-list&#x2F;messages-list.component.ts\n```diff\n@@ -1,14 +1,17 @@\n â”Š 1â”Š 1â”Šimport {Component, Input} from '@angular/core';\n â”Š 2â”Š 2â”Šimport {GetChat} from '../../../../types';\n+â”Š  â”Š 3â”Šimport {SelectableListDirective} from 'ngx-selectable-list';\n â”Š 3â”Š 4â”Š\n â”Š 4â”Š 5â”Š@Component({\n â”Š 5â”Š 6â”Š  selector: 'app-messages-list',\n â”Š 6â”Š 7â”Š  template: `\n â”Š 7â”Š 8â”Š    <mat-list>\n â”Š 8â”Š 9â”Š      <mat-list-item *ngFor=\"let message of messages\">\n-â”Š 9â”Š  â”Š        <app-message-item [item]=\"message\" [isGroup]=\"isGroup\"></app-message-item>\n+â”Š  â”Š10â”Š        <app-message-item [item]=\"message\" [isGroup]=\"isGroup\"\n+â”Š  â”Š11â”Š                          appSelectableItem></app-message-item>\n â”Š10â”Š12â”Š      </mat-list-item>\n â”Š11â”Š13â”Š    </mat-list>\n+â”Š  â”Š14â”Š    <ng-content *ngIf=\"selectableListDirective.selecting\"></ng-content>\n â”Š12â”Š15â”Š  `,\n â”Š13â”Š16â”Š  styleUrls: ['messages-list.component.scss'],\n â”Š14â”Š17â”Š})\n```\n```diff\n@@ -20,5 +23,5 @@\n â”Š20â”Š23â”Š  @Input()\n â”Š21â”Š24â”Š  isGroup: boolean;\n â”Š22â”Š25â”Š\n-â”Š23â”Š  â”Š  constructor() {}\n+â”Š  â”Š26â”Š  constructor(public selectableListDirective: SelectableListDirective) {}\n â”Š24â”Š27â”Š}\n```\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.spec.ts\n```diff\n@@ -17,6 +17,7 @@\n â”Š17â”Š17â”Šimport {NewMessageComponent} from '../../components/new-message/new-message.component';\n â”Š18â”Š18â”Šimport {MessagesListComponent} from '../../components/messages-list/messages-list.component';\n â”Š19â”Š19â”Šimport {MessageItemComponent} from '../../components/message-item/message-item.component';\n+â”Š  â”Š20â”Šimport {SelectableListModule} from 'ngx-selectable-list';\n â”Š20â”Š21â”Š\n â”Š21â”Š22â”Šdescribe('ChatComponent', () => {\n â”Š22â”Š23â”Š  let component: ChatComponent;\n```\n```diff\n@@ -107,7 +108,8 @@\n â”Š107â”Š108â”Š        SharedModule,\n â”Š108â”Š109â”Š        HttpLinkModule,\n â”Š109â”Š110â”Š        HttpClientTestingModule,\n-â”Š110â”Š   â”Š        RouterTestingModule\n+â”Š   â”Š111â”Š        RouterTestingModule,\n+â”Š   â”Š112â”Š        SelectableListModule,\n â”Š111â”Š113â”Š      ],\n â”Š112â”Š114â”Š      providers: [\n â”Š113â”Š115â”Š        ChatsService,\n```\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.ts\n```diff\n@@ -12,7 +12,10 @@\n â”Š12â”Š12â”Š      <div class=\"title\">{{ name }}</div>\n â”Š13â”Š13â”Š    </app-toolbar>\n â”Š14â”Š14â”Š    <div class=\"container\">\n-â”Š15â”Š  â”Š      <app-messages-list [items]=\"messages\" [isGroup]=\"isGroup\"></app-messages-list>\n+â”Š  â”Š15â”Š      <app-messages-list [items]=\"messages\" [isGroup]=\"isGroup\"\n+â”Š  â”Š16â”Š                         appSelectableList=\"multiple_press\" (multiple)=\"deleteMessages($event)\">\n+â”Š  â”Š17â”Š        <app-confirm-selection #confirmSelection></app-confirm-selection>\n+â”Š  â”Š18â”Š      </app-messages-list>\n â”Š16â”Š19â”Š      <app-new-message (newMessage)=\"addMessage($event)\"></app-new-message>\n â”Š17â”Š20â”Š    </div>\n â”Š18â”Š21â”Š  `,\n```\n```diff\n@@ -47,4 +50,8 @@\n â”Š47â”Š50â”Š  addMessage(content: string) {\n â”Š48â”Š51â”Š    this.chatsService.addMessage(this.chatId, content).subscribe();\n â”Š49â”Š52â”Š  }\n+â”Š  â”Š53â”Š\n+â”Š  â”Š54â”Š  deleteMessages(messageIds: string[]) {\n+â”Š  â”Š55â”Š    this.chatsService.removeMessages(this.chatId, this.messages, messageIds).subscribe();\n+â”Š  â”Š56â”Š  }\n â”Š50â”Š57â”Š}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chat-item&#x2F;chat-item.component.ts\n```diff\n@@ -5,7 +5,7 @@\n â”Š 5â”Š 5â”Š  selector: 'app-chat-item',\n â”Š 6â”Š 6â”Š  template: `\n â”Š 7â”Š 7â”Š    <div class=\"chat-row\">\n-â”Š 8â”Š  â”Š        <div class=\"chat-recipient\" (click)=\"selectChat()\">\n+â”Š  â”Š 8â”Š        <div class=\"chat-recipient\">\n â”Š 9â”Š 9â”Š          <img *ngIf=\"chat.picture\" [src]=\"chat.picture\" width=\"48\" height=\"48\">\n â”Š10â”Š10â”Š          <div>{{ chat.name }} [id: {{ chat.id }}]</div>\n â”Š11â”Š11â”Š        </div>\n```\n```diff\n@@ -18,11 +18,4 @@\n â”Š18â”Š18â”Š  // tslint:disable-next-line:no-input-rename\n â”Š19â”Š19â”Š  @Input('item')\n â”Š20â”Š20â”Š  chat: GetChats.Chats;\n-â”Š21â”Š  â”Š\n-â”Š22â”Š  â”Š  @Output()\n-â”Š23â”Š  â”Š  select = new EventEmitter<string>();\n-â”Š24â”Š  â”Š\n-â”Š25â”Š  â”Š  selectChat() {\n-â”Š26â”Š  â”Š    this.select.emit(this.chat.id);\n-â”Š27â”Š  â”Š  }\n â”Š28â”Š21â”Š}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;components&#x2F;chats-list&#x2F;chats-list.component.ts\n```diff\n@@ -1,14 +1,17 @@\n-â”Š 1â”Š  â”Šimport {Component, EventEmitter, Input, Output} from '@angular/core';\n+â”Š  â”Š 1â”Šimport {Component, Input} from '@angular/core';\n â”Š 2â”Š 2â”Šimport {GetChats} from '../../../../types';\n+â”Š  â”Š 3â”Šimport {SelectableListDirective} from 'ngx-selectable-list';\n â”Š 3â”Š 4â”Š\n â”Š 4â”Š 5â”Š@Component({\n â”Š 5â”Š 6â”Š  selector: 'app-chats-list',\n â”Š 6â”Š 7â”Š  template: `\n â”Š 7â”Š 8â”Š    <mat-list>\n â”Š 8â”Š 9â”Š      <mat-list-item *ngFor=\"let chat of chats\">\n-â”Š 9â”Š  â”Š        <app-chat-item [item]=\"chat\" (select)=\"selectChat($event)\"></app-chat-item>\n+â”Š  â”Š10â”Š        <app-chat-item [item]=\"chat\"\n+â”Š  â”Š11â”Š                       appSelectableItem></app-chat-item>\n â”Š10â”Š12â”Š      </mat-list-item>\n â”Š11â”Š13â”Š    </mat-list>\n+â”Š  â”Š14â”Š    <ng-content *ngIf=\"selectableListDirective.selecting\"></ng-content>\n â”Š12â”Š15â”Š  `,\n â”Š13â”Š16â”Š  styleUrls: ['chats-list.component.scss'],\n â”Š14â”Š17â”Š})\n```\n```diff\n@@ -17,12 +20,5 @@\n â”Š17â”Š20â”Š  @Input('items')\n â”Š18â”Š21â”Š  chats: GetChats.Chats[];\n â”Š19â”Š22â”Š\n-â”Š20â”Š  â”Š  @Output()\n-â”Š21â”Š  â”Š  select = new EventEmitter<string>();\n-â”Š22â”Š  â”Š\n-â”Š23â”Š  â”Š  constructor() {}\n-â”Š24â”Š  â”Š\n-â”Š25â”Š  â”Š  selectChat(id: string) {\n-â”Š26â”Š  â”Š    this.select.emit(id);\n-â”Š27â”Š  â”Š  }\n+â”Š  â”Š23â”Š  constructor(public selectableListDirective: SelectableListDirective) {}\n â”Š28â”Š24â”Š}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.spec.ts\n```diff\n@@ -13,6 +13,7 @@\n â”Š13â”Š13â”Šimport {defaultDataIdFromObject, InMemoryCache} from 'apollo-cache-inmemory';\n â”Š14â”Š14â”Šimport {By} from '@angular/platform-browser';\n â”Š15â”Š15â”Šimport {RouterTestingModule} from '@angular/router/testing';\n+â”Š  â”Š16â”Šimport {SelectableListModule} from 'ngx-selectable-list';\n â”Š16â”Š17â”Š\n â”Š17â”Š18â”Šdescribe('ChatsComponent', () => {\n â”Š18â”Š19â”Š  let component: ChatsComponent;\n```\n```diff\n@@ -329,7 +330,8 @@\n â”Š329â”Š330â”Š        TruncateModule,\n â”Š330â”Š331â”Š        HttpLinkModule,\n â”Š331â”Š332â”Š        HttpClientTestingModule,\n-â”Š332â”Š   â”Š        RouterTestingModule\n+â”Š   â”Š333â”Š        RouterTestingModule,\n+â”Š   â”Š334â”Š        SelectableListModule,\n â”Š333â”Š335â”Š      ],\n â”Š334â”Š336â”Š      providers: [\n â”Š335â”Š337â”Š        ChatsService,\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.ts\n```diff\n@@ -28,9 +28,13 @@\n â”Š28â”Š28â”Š      </button>\n â”Š29â”Š29â”Š    </mat-menu>\n â”Š30â”Š30â”Š\n-â”Š31â”Š  â”Š    <app-chats-list [items]=\"chats$ | async\" (select)=\"goToChat($event)\"></app-chats-list>\n+â”Š  â”Š31â”Š    <app-chats-list [items]=\"chats$ | async\"\n+â”Š  â”Š32â”Š                    appSelectableList=\"both\"\n+â”Š  â”Š33â”Š                    (single)=\"goToChat($event)\" (multiple)=\"deleteChats($event)\" (isSelecting)=\"isSelecting = $event\">\n+â”Š  â”Š34â”Š      <app-confirm-selection #confirmSelection></app-confirm-selection>\n+â”Š  â”Š35â”Š    </app-chats-list>\n â”Š32â”Š36â”Š\n-â”Š33â”Š  â”Š    <button class=\"chat-button\" mat-fab color=\"primary\">\n+â”Š  â”Š37â”Š    <button *ngIf=\"!isSelecting\" class=\"chat-button\" mat-fab color=\"primary\">\n â”Š34â”Š38â”Š      <mat-icon aria-label=\"Icon-button with a + icon\">add</mat-icon>\n â”Š35â”Š39â”Š    </button>\n â”Š36â”Š40â”Š  `,\n```\n```diff\n@@ -38,6 +42,7 @@\n â”Š38â”Š42â”Š})\n â”Š39â”Š43â”Šexport class ChatsComponent implements OnInit {\n â”Š40â”Š44â”Š  chats$: Observable<GetChats.Chats[]>;\n+â”Š  â”Š45â”Š  isSelecting = false;\n â”Š41â”Š46â”Š\n â”Š42â”Š47â”Š  constructor(private chatsService: ChatsService,\n â”Š43â”Š48â”Š              private router: Router) {\n```\n```diff\n@@ -50,4 +55,10 @@\n â”Š50â”Š55â”Š  goToChat(chatId: string) {\n â”Š51â”Š56â”Š    this.router.navigate(['/chat', chatId]);\n â”Š52â”Š57â”Š  }\n+â”Š  â”Š58â”Š\n+â”Š  â”Š59â”Š  deleteChats(chatIds: string[]) {\n+â”Š  â”Š60â”Š    chatIds.forEach(chatId => {\n+â”Š  â”Š61â”Š      this.chatsService.removeChat(chatId).subscribe();\n+â”Š  â”Š62â”Š    });\n+â”Š  â”Š63â”Š  }\n â”Š53â”Š64â”Š}\n```\n\n##### Added src&#x2F;app&#x2F;shared&#x2F;components&#x2F;confirm-selection&#x2F;confirm-selection.component.scss\n```diff\n@@ -0,0 +1,6 @@\n+â”Š â”Š1â”Š:host {\n+â”Š â”Š2â”Š  display: block;\n+â”Š â”Š3â”Š  position: absolute;\n+â”Š â”Š4â”Š  bottom: 5vw;\n+â”Š â”Š5â”Š  right: 5vw;\n+â”Š â”Š6â”Š}\n```\n\n##### Added src&#x2F;app&#x2F;shared&#x2F;components&#x2F;confirm-selection&#x2F;confirm-selection.component.ts\n```diff\n@@ -0,0 +1,21 @@\n+â”Š  â”Š 1â”Šimport {Component, EventEmitter, Input, Output} from '@angular/core';\n+â”Š  â”Š 2â”Š\n+â”Š  â”Š 3â”Š@Component({\n+â”Š  â”Š 4â”Š  selector: 'app-confirm-selection',\n+â”Š  â”Š 5â”Š  template: `\n+â”Š  â”Š 6â”Š    <button mat-fab color=\"primary\" (click)=\"handleClick()\">\n+â”Š  â”Š 7â”Š      <mat-icon aria-label=\"Icon-button\">{{ icon }}</mat-icon>\n+â”Š  â”Š 8â”Š    </button>\n+â”Š  â”Š 9â”Š  `,\n+â”Š  â”Š10â”Š  styleUrls: ['./confirm-selection.component.scss'],\n+â”Š  â”Š11â”Š})\n+â”Š  â”Š12â”Šexport class ConfirmSelectionComponent {\n+â”Š  â”Š13â”Š  @Input()\n+â”Š  â”Š14â”Š  icon = 'delete';\n+â”Š  â”Š15â”Š  @Output()\n+â”Š  â”Š16â”Š  emitClick = new EventEmitter<null>();\n+â”Š  â”Š17â”Š\n+â”Š  â”Š18â”Š  handleClick() {\n+â”Š  â”Š19â”Š    this.emitClick.emit();\n+â”Š  â”Š20â”Š  }\n+â”Š  â”Š21â”Š}\n```\n\n##### Changed src&#x2F;app&#x2F;shared&#x2F;shared.module.ts\n```diff\n@@ -1,19 +1,23 @@\n â”Š 1â”Š 1â”Šimport {BrowserModule} from '@angular/platform-browser';\n â”Š 2â”Š 2â”Šimport {NgModule} from '@angular/core';\n â”Š 3â”Š 3â”Š\n-â”Š 4â”Š  â”Šimport {MatToolbarModule} from '@angular/material';\n+â”Š  â”Š 4â”Šimport {MatButtonModule, MatIconModule, MatToolbarModule} from '@angular/material';\n â”Š 5â”Š 5â”Šimport {ToolbarComponent} from './components/toolbar/toolbar.component';\n â”Š 6â”Š 6â”Šimport {FormsModule} from '@angular/forms';\n â”Š 7â”Š 7â”Šimport {BrowserAnimationsModule} from '@angular/platform-browser/animations';\n+â”Š  â”Š 8â”Šimport {ConfirmSelectionComponent} from './components/confirm-selection/confirm-selection.component';\n â”Š 8â”Š 9â”Š\n â”Š 9â”Š10â”Š@NgModule({\n â”Š10â”Š11â”Š  declarations: [\n â”Š11â”Š12â”Š    ToolbarComponent,\n+â”Š  â”Š13â”Š    ConfirmSelectionComponent,\n â”Š12â”Š14â”Š  ],\n â”Š13â”Š15â”Š  imports: [\n â”Š14â”Š16â”Š    BrowserModule,\n â”Š15â”Š17â”Š    // Material\n â”Š16â”Š18â”Š    MatToolbarModule,\n+â”Š  â”Š19â”Š    MatIconModule,\n+â”Š  â”Š20â”Š    MatButtonModule,\n â”Š17â”Š21â”Š    // Animations\n â”Š18â”Š22â”Š    BrowserAnimationsModule,\n â”Š19â”Š23â”Š    // Forms\n```\n```diff\n@@ -22,6 +26,7 @@\n â”Š22â”Š26â”Š  providers: [],\n â”Š23â”Š27â”Š  exports: [\n â”Š24â”Š28â”Š    ToolbarComponent,\n+â”Š  â”Š29â”Š    ConfirmSelectionComponent,\n â”Š25â”Š30â”Š  ],\n â”Š26â”Š31â”Š})\n â”Š27â”Š32â”Šexport class SharedModule {\n```\n\n[}]: #\n\nWe also created a `ConfirmSelectionComponent` to use for content projection, since our selectable list directive will be able to listen to its events.\nThe selectable list directive supports much more different use cases, for info please read the documentation.\n\nAs you can see `ngx-selectable-list` takes care of most of the boilerplate, giving us the freedom to concentrate on the actual code."
          },
          {
            "manualTitle": "Step 12: Chats creation",
            "stepRevision": "6d94afcff1967ea5771c10237ba4c95627cff30d",
            "manualView": "We still cannot create new chats or groups, so let's implement it.\nWe're going to create a `ChatsCreation` module, with a `NewChat` and a `NewGroup` containers, along with several presentational components.\nWe're going to make use of the selectable list directive once again, to ease selecting the users when we're creating a new group.\nYou should also notice that we are looking for existing chats before creating a new one: if it already exists we're are simply redirecting to that chat instead of creating a new one (the server wouldn't allow that anyway and it will simply\nreturn the chat id).\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/graphql\" module=\"client\")\n\n#### Step 8.1: New chats and groups\n\n##### Added src&#x2F;graphql&#x2F;addChat.mutation.ts\n```diff\n@@ -0,0 +1,17 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag';\n+â”Š  â”Š 2â”Šimport {fragments} from './fragment';\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Š// We use the gql tag to parse our query string into a query document\n+â”Š  â”Š 5â”Šexport const addChatMutation = gql`\n+â”Š  â”Š 6â”Š  mutation AddChat($recipientId: ID!) {\n+â”Š  â”Š 7â”Š    addChat(recipientId: $recipientId) {\n+â”Š  â”Š 8â”Š      ...ChatWithoutMessages\n+â”Š  â”Š 9â”Š      messages {\n+â”Š  â”Š10â”Š        ...Message\n+â”Š  â”Š11â”Š      }\n+â”Š  â”Š12â”Š    }\n+â”Š  â”Š13â”Š  }\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”Š  ${fragments['chatWithoutMessages']}\n+â”Š  â”Š16â”Š  ${fragments['message']}\n+â”Š  â”Š17â”Š`;\n```\n\n##### Added src&#x2F;graphql&#x2F;addGroup.mutation.ts\n```diff\n@@ -0,0 +1,17 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag';\n+â”Š  â”Š 2â”Šimport {fragments} from './fragment';\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Š// We use the gql tag to parse our query string into a query document\n+â”Š  â”Š 5â”Šexport const addGroupMutation = gql`\n+â”Š  â”Š 6â”Š  mutation AddGroup($recipientIds: [ID!]!, $groupName: String!) {\n+â”Š  â”Š 7â”Š    addGroup(recipientIds: $recipientIds, groupName: $groupName) {\n+â”Š  â”Š 8â”Š      ...ChatWithoutMessages\n+â”Š  â”Š 9â”Š      messages {\n+â”Š  â”Š10â”Š        ...Message\n+â”Š  â”Š11â”Š      }\n+â”Š  â”Š12â”Š    }\n+â”Š  â”Š13â”Š  }\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”Š  ${fragments['chatWithoutMessages']}\n+â”Š  â”Š16â”Š  ${fragments['message']}\n+â”Š  â”Š17â”Š`;\n```\n\n##### Added src&#x2F;graphql&#x2F;getUsers.query.ts\n```diff\n@@ -0,0 +1,12 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag';\n+â”Š  â”Š 2â”Š\n+â”Š  â”Š 3â”Š// We use the gql tag to parse our query string into a query document\n+â”Š  â”Š 4â”Šexport const getUsersQuery = gql`\n+â”Š  â”Š 5â”Š  query GetUsers {\n+â”Š  â”Š 6â”Š    users {\n+â”Š  â”Š 7â”Š      id,\n+â”Š  â”Š 8â”Š      name,\n+â”Š  â”Š 9â”Š      picture,\n+â”Š  â”Š10â”Š    }\n+â”Š  â”Š11â”Š  }\n+â”Š  â”Š12â”Š`;\n```\n\n[}]: #\n\nAfter creating the mutations we should run the generator to create the corresponding types:\n\n    npm run generator\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/app/app.module.ts, src/app/chats-creation, src/app/services\" module=\"client\")\n\n#### Step 8.1: New chats and groups\n\n##### Changed src&#x2F;app&#x2F;app.module.ts\n```diff\n@@ -10,6 +10,7 @@\n â”Š10â”Š10â”Šimport {ChatsListerModule} from './chats-lister/chats-lister.module';\n â”Š11â”Š11â”Šimport {RouterModule, Routes} from '@angular/router';\n â”Š12â”Š12â”Šimport {ChatViewerModule} from './chat-viewer/chat-viewer.module';\n+â”Š  â”Š13â”Šimport {ChatsCreationModule} from './chats-creation/chats-creation.module';\n â”Š13â”Š14â”Š\n â”Š14â”Š15â”Šconst routes: Routes = [];\n â”Š15â”Š16â”Š\n```\n```diff\n@@ -28,6 +29,7 @@\n â”Š28â”Š29â”Š    // Feature modules\n â”Š29â”Š30â”Š    ChatsListerModule,\n â”Š30â”Š31â”Š    ChatViewerModule,\n+â”Š  â”Š32â”Š    ChatsCreationModule,\n â”Š31â”Š33â”Š  ],\n â”Š32â”Š34â”Š  providers: [],\n â”Š33â”Š35â”Š  bootstrap: [AppComponent]\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;chats-creation.module.ts\n```diff\n@@ -0,0 +1,60 @@\n+â”Š  â”Š 1â”Šimport { BrowserModule } from '@angular/platform-browser';\n+â”Š  â”Š 2â”Šimport { NgModule } from '@angular/core';\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Šimport {BrowserAnimationsModule} from '@angular/platform-browser/animations';\n+â”Š  â”Š 5â”Šimport {\n+â”Š  â”Š 6â”Š  MatButtonModule, MatFormFieldModule, MatGridListModule, MatIconModule, MatInputModule, MatListModule, MatMenuModule,\n+â”Š  â”Š 7â”Š  MatToolbarModule\n+â”Š  â”Š 8â”Š} from '@angular/material';\n+â”Š  â”Š 9â”Šimport {RouterModule, Routes} from '@angular/router';\n+â”Š  â”Š10â”Šimport {FormsModule} from '@angular/forms';\n+â”Š  â”Š11â”Šimport {ChatsService} from '../services/chats.service';\n+â”Š  â”Š12â”Šimport {UserItemComponent} from './components/user-item/user-item.component';\n+â”Š  â”Š13â”Šimport {UsersListComponent} from './components/users-list/users-list.component';\n+â”Š  â”Š14â”Šimport {NewGroupComponent} from './containers/new-group/new-group.component';\n+â”Š  â”Š15â”Šimport {NewChatComponent} from './containers/new-chat/new-chat.component';\n+â”Š  â”Š16â”Šimport {NewGroupDetailsComponent} from './components/new-group-details/new-group-details.component';\n+â”Š  â”Š17â”Šimport {SharedModule} from '../shared/shared.module';\n+â”Š  â”Š18â”Šimport {SelectableListModule} from 'ngx-selectable-list';\n+â”Š  â”Š19â”Š\n+â”Š  â”Š20â”Šconst routes: Routes = [\n+â”Š  â”Š21â”Š  {path: 'new-chat', component: NewChatComponent},\n+â”Š  â”Š22â”Š  {path: 'new-group', component: NewGroupComponent},\n+â”Š  â”Š23â”Š];\n+â”Š  â”Š24â”Š\n+â”Š  â”Š25â”Š@NgModule({\n+â”Š  â”Š26â”Š  declarations: [\n+â”Š  â”Š27â”Š    NewChatComponent,\n+â”Š  â”Š28â”Š    UsersListComponent,\n+â”Š  â”Š29â”Š    NewGroupComponent,\n+â”Š  â”Š30â”Š    UserItemComponent,\n+â”Š  â”Š31â”Š    NewGroupDetailsComponent,\n+â”Š  â”Š32â”Š  ],\n+â”Š  â”Š33â”Š  imports: [\n+â”Š  â”Š34â”Š    BrowserModule,\n+â”Š  â”Š35â”Š    // Animations (for Material)\n+â”Š  â”Š36â”Š    BrowserAnimationsModule,\n+â”Š  â”Š37â”Š    // Material\n+â”Š  â”Š38â”Š    MatToolbarModule,\n+â”Š  â”Š39â”Š    MatMenuModule,\n+â”Š  â”Š40â”Š    MatIconModule,\n+â”Š  â”Š41â”Š    MatButtonModule,\n+â”Š  â”Š42â”Š    MatListModule,\n+â”Š  â”Š43â”Š    MatGridListModule,\n+â”Š  â”Š44â”Š    MatInputModule,\n+â”Š  â”Š45â”Š    MatFormFieldModule,\n+â”Š  â”Š46â”Š    MatGridListModule,\n+â”Š  â”Š47â”Š    // Routing\n+â”Š  â”Š48â”Š    RouterModule.forChild(routes),\n+â”Š  â”Š49â”Š    // Forms\n+â”Š  â”Š50â”Š    FormsModule,\n+â”Š  â”Š51â”Š    // Feature modules\n+â”Š  â”Š52â”Š    SelectableListModule,\n+â”Š  â”Š53â”Š    SharedModule,\n+â”Š  â”Š54â”Š  ],\n+â”Š  â”Š55â”Š  providers: [\n+â”Š  â”Š56â”Š    ChatsService,\n+â”Š  â”Š57â”Š  ],\n+â”Š  â”Š58â”Š})\n+â”Š  â”Š59â”Šexport class ChatsCreationModule {\n+â”Š  â”Š60â”Š}\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;new-group-details&#x2F;new-group-details.component.scss\n```diff\n@@ -0,0 +1,25 @@\n+â”Š  â”Š 1â”Š:host {\n+â”Š  â”Š 2â”Š  display: block;\n+â”Š  â”Š 3â”Š}\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šdiv {\n+â”Š  â”Š 6â”Š  padding: 16px;\n+â”Š  â”Š 7â”Š  mat-form-field {\n+â”Š  â”Š 8â”Š    width: 100%;\n+â”Š  â”Š 9â”Š  }\n+â”Š  â”Š10â”Š}\n+â”Š  â”Š11â”Š\n+â”Š  â”Š12â”Š.new-group {\n+â”Š  â”Š13â”Š  position: absolute;\n+â”Š  â”Š14â”Š  bottom: 5vw;\n+â”Š  â”Š15â”Š  right: 5vw;\n+â”Š  â”Š16â”Š}\n+â”Š  â”Š17â”Š\n+â”Š  â”Š18â”Š.users {\n+â”Š  â”Š19â”Š  display: flex;\n+â”Š  â”Š20â”Š  flex-flow: row wrap;\n+â”Š  â”Š21â”Š  img {\n+â”Š  â”Š22â”Š    flex: 0 1 8vh;\n+â”Š  â”Š23â”Š    height: 8vh;\n+â”Š  â”Š24â”Š  }\n+â”Š  â”Š25â”Š}\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;new-group-details&#x2F;new-group-details.component.ts\n```diff\n@@ -0,0 +1,34 @@\n+â”Š  â”Š 1â”Šimport {Component, EventEmitter, Input, Output} from '@angular/core';\n+â”Š  â”Š 2â”Šimport {GetUsers} from '../../../../types';\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Š@Component({\n+â”Š  â”Š 5â”Š  selector: 'app-new-group-details',\n+â”Š  â”Š 6â”Š  template: `\n+â”Š  â”Š 7â”Š    <div>\n+â”Š  â”Š 8â”Š      <mat-form-field>\n+â”Š  â”Š 9â”Š        <input matInput placeholder=\"Group name\" [(ngModel)]=\"groupName\">\n+â”Š  â”Š10â”Š      </mat-form-field>\n+â”Š  â”Š11â”Š    </div>\n+â”Š  â”Š12â”Š    <button [disabled]=\"!groupName\" class=\"new-group\" mat-fab color=\"primary\" (click)=\"emitGroupDetails()\">\n+â”Š  â”Š13â”Š      <mat-icon aria-label=\"Icon-button with a + icon\">arrow_forward</mat-icon>\n+â”Š  â”Š14â”Š    </button>\n+â”Š  â”Š15â”Š    <div>Members</div>\n+â”Š  â”Š16â”Š    <div class=\"users\">\n+â”Š  â”Š17â”Š      <img *ngFor=\"let user of users;\" [src]=\"user.picture\"/>\n+â”Š  â”Š18â”Š    </div>\n+â”Š  â”Š19â”Š  `,\n+â”Š  â”Š20â”Š  styleUrls: ['new-group-details.component.scss'],\n+â”Š  â”Š21â”Š})\n+â”Š  â”Š22â”Šexport class NewGroupDetailsComponent {\n+â”Š  â”Š23â”Š  groupName: string;\n+â”Š  â”Š24â”Š  @Input()\n+â”Š  â”Š25â”Š  users: GetUsers.Users[];\n+â”Š  â”Š26â”Š  @Output()\n+â”Š  â”Š27â”Š  groupDetails = new EventEmitter<string>();\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š  emitGroupDetails() {\n+â”Š  â”Š30â”Š    if (this.groupDetails) {\n+â”Š  â”Š31â”Š      this.groupDetails.emit(this.groupName);\n+â”Š  â”Š32â”Š    }\n+â”Š  â”Š33â”Š  }\n+â”Š  â”Š34â”Š}\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;user-item&#x2F;user-item.component.scss\n```diff\n@@ -0,0 +1,28 @@\n+â”Š  â”Š 1â”Š:host {\n+â”Š  â”Š 2â”Š  display: block;\n+â”Š  â”Š 3â”Š  width: 100%;\n+â”Š  â”Š 4â”Š  height: 100%;\n+â”Š  â”Š 5â”Š}\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Šbutton {\n+â”Š  â”Š 8â”Š  padding: 0;\n+â”Š  â”Š 9â”Š  display: flex;\n+â”Š  â”Š10â”Š  align-items: center;\n+â”Š  â”Š11â”Š  height: 100%;\n+â”Š  â”Š12â”Š  width: 100%;\n+â”Š  â”Š13â”Š  border: none;\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”Š  div:first-of-type {\n+â”Š  â”Š16â”Š    display: flex;\n+â”Š  â”Š17â”Š    justify-content: center;\n+â”Š  â”Š18â”Š    align-items: center;\n+â”Š  â”Š19â”Š\n+â”Š  â”Š20â”Š    img {\n+â”Š  â”Š21â”Š      max-width: 100%;\n+â”Š  â”Š22â”Š    }\n+â”Š  â”Š23â”Š  }\n+â”Š  â”Š24â”Š\n+â”Š  â”Š25â”Š  div:nth-of-type(2) {\n+â”Š  â”Š26â”Š    padding-left: 16px;\n+â”Š  â”Š27â”Š  }\n+â”Š  â”Š28â”Š}\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;user-item&#x2F;user-item.component.ts\n```diff\n@@ -0,0 +1,20 @@\n+â”Š  â”Š 1â”Šimport {Component, Input} from '@angular/core';\n+â”Š  â”Š 2â”Šimport {GetUsers} from '../../../../types';\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Š@Component({\n+â”Š  â”Š 5â”Š  selector: 'app-user-item',\n+â”Š  â”Š 6â”Š  template: `\n+â”Š  â”Š 7â”Š    <button mat-menu-item>\n+â”Š  â”Š 8â”Š      <div>\n+â”Š  â”Š 9â”Š        <img [src]=\"user.picture\" *ngIf=\"user.picture\">\n+â”Š  â”Š10â”Š      </div>\n+â”Š  â”Š11â”Š      <div>{{ user.name }}</div>\n+â”Š  â”Š12â”Š    </button>\n+â”Š  â”Š13â”Š  `,\n+â”Š  â”Š14â”Š  styleUrls: ['user-item.component.scss']\n+â”Š  â”Š15â”Š})\n+â”Š  â”Š16â”Šexport class UserItemComponent {\n+â”Š  â”Š17â”Š  // tslint:disable-next-line:no-input-rename\n+â”Š  â”Š18â”Š  @Input('item')\n+â”Š  â”Š19â”Š  user: GetUsers.Users;\n+â”Š  â”Š20â”Š}\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;users-list&#x2F;users-list.component.scss\n```diff\n@@ -0,0 +1,3 @@\n+â”Š â”Š1â”Š:host {\n+â”Š â”Š2â”Š  display: block;\n+â”Š â”Š3â”Š}\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;components&#x2F;users-list&#x2F;users-list.component.ts\n```diff\n@@ -0,0 +1,24 @@\n+â”Š  â”Š 1â”Šimport {Component, Input} from '@angular/core';\n+â”Š  â”Š 2â”Šimport {GetUsers} from '../../../../types';\n+â”Š  â”Š 3â”Šimport {SelectableListDirective} from 'ngx-selectable-list';\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Š@Component({\n+â”Š  â”Š 6â”Š  selector: 'app-users-list',\n+â”Š  â”Š 7â”Š  template: `\n+â”Š  â”Š 8â”Š    <mat-list>\n+â”Š  â”Š 9â”Š      <mat-list-item *ngFor=\"let user of users\">\n+â”Š  â”Š10â”Š        <app-user-item [item]=\"user\"\n+â”Š  â”Š11â”Š                       appSelectableItem></app-user-item>\n+â”Š  â”Š12â”Š      </mat-list-item>\n+â”Š  â”Š13â”Š    </mat-list>\n+â”Š  â”Š14â”Š    <ng-content *ngIf=\"selectableListDirective.selecting\"></ng-content>\n+â”Š  â”Š15â”Š  `,\n+â”Š  â”Š16â”Š  styleUrls: ['users-list.component.scss'],\n+â”Š  â”Š17â”Š})\n+â”Š  â”Š18â”Šexport class UsersListComponent {\n+â”Š  â”Š19â”Š  // tslint:disable-next-line:no-input-rename\n+â”Š  â”Š20â”Š  @Input('items')\n+â”Š  â”Š21â”Š  users: GetUsers.Users[];\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Š  constructor(public selectableListDirective: SelectableListDirective) {}\n+â”Š  â”Š24â”Š}\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-chat&#x2F;new-chat.component.scss\n```diff\n@@ -0,0 +1,23 @@\n+â”Š  â”Š 1â”Š.new-group {\n+â”Š  â”Š 2â”Š  display: flex;\n+â”Š  â”Š 3â”Š  height: 8vh;\n+â”Š  â”Š 4â”Š  align-items: center;\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Š  div:first-of-type {\n+â”Š  â”Š 7â”Š    height: 8vh;\n+â”Š  â”Š 8â”Š    width: 8vh;\n+â”Š  â”Š 9â”Š    display: flex;\n+â”Š  â”Š10â”Š    justify-content: center;\n+â”Š  â”Š11â”Š    align-items: center;\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Š    mat-icon {\n+â”Š  â”Š14â”Š      height: 5vh;\n+â”Š  â”Š15â”Š      width: 5vh;\n+â”Š  â”Š16â”Š      font-size: 5vh;\n+â”Š  â”Š17â”Š    }\n+â”Š  â”Š18â”Š  }\n+â”Š  â”Š19â”Š\n+â”Š  â”Š20â”Š  div:nth-of-type(2) {\n+â”Š  â”Š21â”Š    padding: 16px;\n+â”Š  â”Š22â”Š  }\n+â”Š  â”Š23â”Š}\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-chat&#x2F;new-chat.component.ts\n```diff\n@@ -0,0 +1,59 @@\n+â”Š  â”Š 1â”Šimport {Component, OnInit} from '@angular/core';\n+â”Š  â”Š 2â”Šimport {Location} from '@angular/common';\n+â”Š  â”Š 3â”Šimport {Router} from '@angular/router';\n+â”Š  â”Š 4â”Šimport {AddChat, GetUsers} from '../../../../types';\n+â”Š  â”Š 5â”Šimport {ChatsService} from '../../../services/chats.service';\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Š@Component({\n+â”Š  â”Š 8â”Š  template: `\n+â”Š  â”Š 9â”Š    <app-toolbar>\n+â”Š  â”Š10â”Š      <button class=\"navigation\" mat-button (click)=\"goBack()\">\n+â”Š  â”Š11â”Š        <mat-icon aria-label=\"Icon-button with an arrow back icon\">arrow_back</mat-icon>\n+â”Š  â”Š12â”Š      </button>\n+â”Š  â”Š13â”Š      <div class=\"title\">New chat</div>\n+â”Š  â”Š14â”Š    </app-toolbar>\n+â”Š  â”Š15â”Š\n+â”Š  â”Š16â”Š    <div class=\"new-group\" (click)=\"goToNewGroup()\">\n+â”Š  â”Š17â”Š      <div>\n+â”Š  â”Š18â”Š        <mat-icon aria-label=\"Icon-button with a group add icon\">group_add</mat-icon>\n+â”Š  â”Š19â”Š      </div>\n+â”Š  â”Š20â”Š      <div>New group</div>\n+â”Š  â”Š21â”Š    </div>\n+â”Š  â”Š22â”Š\n+â”Š  â”Š23â”Š    <app-users-list [items]=\"users\"\n+â”Š  â”Š24â”Š                    appSelectableList=\"single\" (single)=\"addChat($event)\">\n+â”Š  â”Š25â”Š    </app-users-list>\n+â”Š  â”Š26â”Š  `,\n+â”Š  â”Š27â”Š  styleUrls: ['new-chat.component.scss'],\n+â”Š  â”Š28â”Š})\n+â”Š  â”Š29â”Šexport class NewChatComponent implements OnInit {\n+â”Š  â”Š30â”Š  users: GetUsers.Users[];\n+â”Š  â”Š31â”Š\n+â”Š  â”Š32â”Š  constructor(private router: Router,\n+â”Š  â”Š33â”Š              private location: Location,\n+â”Š  â”Š34â”Š              private chatsService: ChatsService) {}\n+â”Š  â”Š35â”Š\n+â”Š  â”Š36â”Š  ngOnInit () {\n+â”Š  â”Š37â”Š    this.chatsService.getUsers().users$.subscribe(users => this.users = users);\n+â”Š  â”Š38â”Š  }\n+â”Š  â”Š39â”Š\n+â”Š  â”Š40â”Š  goBack() {\n+â”Š  â”Š41â”Š    this.location.back();\n+â”Š  â”Š42â”Š  }\n+â”Š  â”Š43â”Š\n+â”Š  â”Š44â”Š  goToNewGroup() {\n+â”Š  â”Š45â”Š    this.router.navigate(['/new-group']);\n+â”Š  â”Š46â”Š  }\n+â”Š  â”Š47â”Š\n+â”Š  â”Š48â”Š  addChat(recipientId: string) {\n+â”Š  â”Š49â”Š    const chatId = this.chatsService.getChatId(recipientId);\n+â”Š  â”Š50â”Š    if (chatId) {\n+â”Š  â”Š51â”Š      // Chat is already listed for the current user\n+â”Š  â”Š52â”Š      this.router.navigate(['/chat', chatId]);\n+â”Š  â”Š53â”Š    } else {\n+â”Š  â”Š54â”Š      this.chatsService.addChat(recipientId).subscribe(({data: {addChat: {id}}}: { data: AddChat.Mutation }) => {\n+â”Š  â”Š55â”Š        this.router.navigate(['/chat', id]);\n+â”Š  â”Š56â”Š      });\n+â”Š  â”Š57â”Š    }\n+â”Š  â”Š58â”Š  }\n+â”Š  â”Š59â”Š}\n```\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-group&#x2F;new-group.component.scss\n\n\n##### Added src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-group&#x2F;new-group.component.ts\n```diff\n@@ -0,0 +1,60 @@\n+â”Š  â”Š 1â”Šimport {Component, OnInit} from '@angular/core';\n+â”Š  â”Š 2â”Šimport {Location} from '@angular/common';\n+â”Š  â”Š 3â”Šimport {Router} from '@angular/router';\n+â”Š  â”Š 4â”Šimport {AddGroup, GetUsers} from '../../../../types';\n+â”Š  â”Š 5â”Šimport {ChatsService} from '../../../services/chats.service';\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Š@Component({\n+â”Š  â”Š 8â”Š  template: `\n+â”Š  â”Š 9â”Š    <app-toolbar>\n+â”Š  â”Š10â”Š      <button class=\"navigation\" mat-button (click)=\"goBack()\">\n+â”Š  â”Š11â”Š        <mat-icon aria-label=\"Icon-button with an arrow back icon\">arrow_back</mat-icon>\n+â”Š  â”Š12â”Š      </button>\n+â”Š  â”Š13â”Š      <div class=\"title\">New group</div>\n+â”Š  â”Š14â”Š    </app-toolbar>\n+â”Š  â”Š15â”Š\n+â”Š  â”Š16â”Š    <app-users-list *ngIf=\"!recipientIds.length\" [items]=\"users\"\n+â”Š  â”Š17â”Š                    appSelectableList=\"multiple_tap\" (multiple)=\"selectUsers($event)\">\n+â”Š  â”Š18â”Š      <app-confirm-selection #confirmSelection icon=\"arrow_forward\"></app-confirm-selection>\n+â”Š  â”Š19â”Š    </app-users-list>\n+â”Š  â”Š20â”Š    <app-new-group-details *ngIf=\"recipientIds.length\" [users]=\"getSelectedUsers()\"\n+â”Š  â”Š21â”Š                           (groupDetails)=\"addGroup($event)\"></app-new-group-details>\n+â”Š  â”Š22â”Š  `,\n+â”Š  â”Š23â”Š  styleUrls: ['new-group.component.scss'],\n+â”Š  â”Š24â”Š})\n+â”Š  â”Š25â”Šexport class NewGroupComponent implements OnInit {\n+â”Š  â”Š26â”Š  users: GetUsers.Users[];\n+â”Š  â”Š27â”Š  recipientIds: string[] = [];\n+â”Š  â”Š28â”Š\n+â”Š  â”Š29â”Š  constructor(private router: Router,\n+â”Š  â”Š30â”Š              private location: Location,\n+â”Š  â”Š31â”Š              private chatsService: ChatsService) {}\n+â”Š  â”Š32â”Š\n+â”Š  â”Š33â”Š  ngOnInit () {\n+â”Š  â”Š34â”Š    this.chatsService.getUsers().users$.subscribe(users => this.users = users);\n+â”Š  â”Š35â”Š  }\n+â”Š  â”Š36â”Š\n+â”Š  â”Š37â”Š  goBack() {\n+â”Š  â”Š38â”Š    if (this.recipientIds.length) {\n+â”Š  â”Š39â”Š      this.recipientIds = [];\n+â”Š  â”Š40â”Š    } else {\n+â”Š  â”Š41â”Š      this.location.back();\n+â”Š  â”Š42â”Š    }\n+â”Š  â”Š43â”Š  }\n+â”Š  â”Š44â”Š\n+â”Š  â”Š45â”Š  selectUsers(recipientIds: string[]) {\n+â”Š  â”Š46â”Š    this.recipientIds = recipientIds;\n+â”Š  â”Š47â”Š  }\n+â”Š  â”Š48â”Š\n+â”Š  â”Š49â”Š  getSelectedUsers() {\n+â”Š  â”Š50â”Š    return this.users.filter(user => this.recipientIds.includes(user.id));\n+â”Š  â”Š51â”Š  }\n+â”Š  â”Š52â”Š\n+â”Š  â”Š53â”Š  addGroup(groupName: string) {\n+â”Š  â”Š54â”Š    if (groupName && this.recipientIds.length) {\n+â”Š  â”Š55â”Š      this.chatsService.addGroup(this.recipientIds, groupName).subscribe(({data: {addGroup: {id}}}: { data: AddGroup.Mutation }) => {\n+â”Š  â”Š56â”Š        this.router.navigate(['/chat', id]);\n+â”Š  â”Š57â”Š      });\n+â”Š  â”Š58â”Š    }\n+â”Š  â”Š59â”Š  }\n+â”Š  â”Š60â”Š}\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,34 +1,44 @@\n â”Š 1â”Š 1â”Šimport {ApolloQueryResult, MutationOptions, WatchQueryOptions} from 'apollo-client';\n â”Š 2â”Š 2â”Šimport {map} from 'rxjs/operators';\n-â”Š 3â”Š  â”Šimport {Apollo} from 'apollo-angular';\n+â”Š  â”Š 3â”Šimport {Apollo, QueryRef} from 'apollo-angular';\n â”Š 4â”Š 4â”Šimport {Injectable} from '@angular/core';\n â”Š 5â”Š 5â”Šimport {getChatsQuery} from '../../graphql/getChats.query';\n-â”Š 6â”Š  â”Šimport {AddMessage, GetChat, GetChats, RemoveAllMessages, RemoveChat, RemoveMessages} from '../../types';\n+â”Š  â”Š 6â”Šimport {AddChat, AddGroup, AddMessage, GetChat, GetChats, GetUsers, RemoveAllMessages, RemoveChat, RemoveMessages} from '../../types';\n â”Š 7â”Š 7â”Šimport {getChatQuery} from '../../graphql/getChat.query';\n â”Š 8â”Š 8â”Šimport {addMessageMutation} from '../../graphql/addMessage.mutation';\n â”Š 9â”Š 9â”Šimport {removeChatMutation} from '../../graphql/removeChat.mutation';\n â”Š10â”Š10â”Šimport {DocumentNode} from 'graphql';\n â”Š11â”Š11â”Šimport {removeAllMessagesMutation} from '../../graphql/removeAllMessages.mutation';\n â”Š12â”Š12â”Šimport {removeMessagesMutation} from '../../graphql/removeMessages.mutation';\n+â”Š  â”Š13â”Šimport {getUsersQuery} from '../../graphql/getUsers.query';\n+â”Š  â”Š14â”Šimport {Observable} from 'rxjs/Observable';\n+â”Š  â”Š15â”Šimport {addChatMutation} from '../../graphql/addChat.mutation';\n+â”Š  â”Š16â”Šimport {addGroupMutation} from '../../graphql/addGroup.mutation';\n+â”Š  â”Š17â”Š\n+â”Š  â”Š18â”Šconst currentUserId = '1';\n â”Š13â”Š19â”Š\n â”Š14â”Š20â”Š@Injectable()\n â”Š15â”Š21â”Šexport class ChatsService {\n â”Š16â”Š22â”Š  messagesAmount = 3;\n+â”Š  â”Š23â”Š  getChatsWq: QueryRef<GetChats.Query>;\n+â”Š  â”Š24â”Š  chats$: Observable<GetChats.Chats[]>;\n+â”Š  â”Š25â”Š  chats: GetChats.Chats[];\n â”Š17â”Š26â”Š\n-â”Š18â”Š  â”Š  constructor(private apollo: Apollo) {}\n-â”Š19â”Š  â”Š\n-â”Š20â”Š  â”Š  getChats() {\n-â”Š21â”Š  â”Š    const query = this.apollo.watchQuery<GetChats.Query>(<WatchQueryOptions>{\n+â”Š  â”Š27â”Š  constructor(private apollo: Apollo) {\n+â”Š  â”Š28â”Š    this.getChatsWq = this.apollo.watchQuery<GetChats.Query>(<WatchQueryOptions>{\n â”Š22â”Š29â”Š      query: getChatsQuery,\n â”Š23â”Š30â”Š      variables: {\n â”Š24â”Š31â”Š        amount: this.messagesAmount,\n â”Š25â”Š32â”Š      },\n â”Š26â”Š33â”Š    });\n-â”Š27â”Š  â”Š    const chats$ = query.valueChanges.pipe(\n+â”Š  â”Š34â”Š    this.chats$ = this.getChatsWq.valueChanges.pipe(\n â”Š28â”Š35â”Š      map((result: ApolloQueryResult<GetChats.Query>) => result.data.chats)\n â”Š29â”Š36â”Š    );\n+â”Š  â”Š37â”Š    this.chats$.subscribe(chats => this.chats = chats);\n+â”Š  â”Š38â”Š  }\n â”Š30â”Š39â”Š\n-â”Š31â”Š  â”Š    return {query, chats$};\n+â”Š  â”Š40â”Š  getChats() {\n+â”Š  â”Š41â”Š    return {query: this.getChatsWq, chats$: this.chats$};\n â”Š32â”Š42â”Š  }\n â”Š33â”Š43â”Š\n â”Š34â”Š44â”Š  getChat(chatId: string) {\n```\n```diff\n@@ -192,4 +202,85 @@\n â”Š192â”Š202â”Š      },\n â”Š193â”Š203â”Š    });\n â”Š194â”Š204â”Š  }\n+â”Š   â”Š205â”Š\n+â”Š   â”Š206â”Š  getUsers() {\n+â”Š   â”Š207â”Š    const query = this.apollo.watchQuery<GetUsers.Query>(<WatchQueryOptions>{\n+â”Š   â”Š208â”Š      query: getUsersQuery,\n+â”Š   â”Š209â”Š    });\n+â”Š   â”Š210â”Š    const users$ = query.valueChanges.pipe(\n+â”Š   â”Š211â”Š      map((result: ApolloQueryResult<GetUsers.Query>) => result.data.users)\n+â”Š   â”Š212â”Š    );\n+â”Š   â”Š213â”Š\n+â”Š   â”Š214â”Š    return {query, users$};\n+â”Š   â”Š215â”Š  }\n+â”Š   â”Š216â”Š\n+â”Š   â”Š217â”Š  // Checks if the chat is listed for the current user and returns the id\n+â”Š   â”Š218â”Š  getChatId(recipientId: string) {\n+â”Š   â”Š219â”Š    const _chat = this.chats.find(chat => {\n+â”Š   â”Š220â”Š      return !chat.isGroup && !!chat.allTimeMembers.find(user => user.id === currentUserId) &&\n+â”Š   â”Š221â”Š        !!chat.allTimeMembers.find(user => user.id === recipientId);\n+â”Š   â”Š222â”Š    });\n+â”Š   â”Š223â”Š    return _chat ? _chat.id : false;\n+â”Š   â”Š224â”Š  }\n+â”Š   â”Š225â”Š\n+â”Š   â”Š226â”Š  addChat(recipientId: string) {\n+â”Š   â”Š227â”Š    return this.apollo.mutate({\n+â”Š   â”Š228â”Š      mutation: addChatMutation,\n+â”Š   â”Š229â”Š      variables: <AddChat.Variables>{\n+â”Š   â”Š230â”Š        recipientId,\n+â”Š   â”Š231â”Š      },\n+â”Š   â”Š232â”Š      update: (store, { data: { addChat } }) => {\n+â”Š   â”Š233â”Š        // Read the data from our cache for this query.\n+â”Š   â”Š234â”Š        const {chats}: GetChats.Query = store.readQuery({\n+â”Š   â”Š235â”Š          query: getChatsQuery,\n+â”Š   â”Š236â”Š          variables: <GetChats.Variables>{\n+â”Š   â”Š237â”Š            amount: this.messagesAmount,\n+â”Š   â”Š238â”Š          },\n+â”Š   â”Š239â”Š        });\n+â”Š   â”Š240â”Š        // Add our comment from the mutation to the end.\n+â”Š   â”Š241â”Š        chats.push(addChat);\n+â”Š   â”Š242â”Š        // Write our data back to the cache.\n+â”Š   â”Š243â”Š        store.writeQuery({\n+â”Š   â”Š244â”Š          query: getChatsQuery,\n+â”Š   â”Š245â”Š          variables: <GetChats.Variables>{\n+â”Š   â”Š246â”Š            amount: this.messagesAmount,\n+â”Š   â”Š247â”Š          },\n+â”Š   â”Š248â”Š          data: {\n+â”Š   â”Š249â”Š            chats,\n+â”Š   â”Š250â”Š          },\n+â”Š   â”Š251â”Š        });\n+â”Š   â”Š252â”Š      },\n+â”Š   â”Š253â”Š    });\n+â”Š   â”Š254â”Š  }\n+â”Š   â”Š255â”Š\n+â”Š   â”Š256â”Š  addGroup(recipientIds: string[], groupName: string) {\n+â”Š   â”Š257â”Š    return this.apollo.mutate({\n+â”Š   â”Š258â”Š      mutation: addGroupMutation,\n+â”Š   â”Š259â”Š      variables: <AddGroup.Variables>{\n+â”Š   â”Š260â”Š        recipientIds,\n+â”Š   â”Š261â”Š        groupName,\n+â”Š   â”Š262â”Š      },\n+â”Š   â”Š263â”Š      update: (store, { data: { addGroup } }) => {\n+â”Š   â”Š264â”Š        // Read the data from our cache for this query.\n+â”Š   â”Š265â”Š        const {chats}: GetChats.Query = store.readQuery({\n+â”Š   â”Š266â”Š          query: getChatsQuery,\n+â”Š   â”Š267â”Š          variables: <GetChats.Variables>{\n+â”Š   â”Š268â”Š            amount: this.messagesAmount,\n+â”Š   â”Š269â”Š          },\n+â”Š   â”Š270â”Š        });\n+â”Š   â”Š271â”Š        // Add our comment from the mutation to the end.\n+â”Š   â”Š272â”Š        chats.push(addGroup);\n+â”Š   â”Š273â”Š        // Write our data back to the cache.\n+â”Š   â”Š274â”Š        store.writeQuery({\n+â”Š   â”Š275â”Š          query: getChatsQuery,\n+â”Š   â”Š276â”Š          variables: <GetChats.Variables>{\n+â”Š   â”Š277â”Š            amount: this.messagesAmount,\n+â”Š   â”Š278â”Š          },\n+â”Š   â”Š279â”Š          data: {\n+â”Š   â”Š280â”Š            chats,\n+â”Š   â”Š281â”Š          },\n+â”Š   â”Š282â”Š        });\n+â”Š   â”Š283â”Š      },\n+â”Š   â”Š284â”Š    });\n+â”Š   â”Š285â”Š  }\n â”Š195â”Š286â”Š}\n```\n\n[}]: #\n\nFinally we should update our tests:\n\n[{]: <helper> (diffStep \"8.1\" files=\"src/app/chat-viewer/containers/chat/chat.component.spec.ts\" module=\"client\")\n\n#### Step 8.1: New chats and groups\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.spec.ts\n```diff\n@@ -144,7 +144,8 @@\n â”Š144â”Š144â”Š    fixture = TestBed.createComponent(ChatComponent);\n â”Š145â”Š145â”Š    component = fixture.componentInstance;\n â”Š146â”Š146â”Š    fixture.detectChanges();\n-â”Š147â”Š   â”Š    const req = httpMock.expectOne('http://localhost:3000/graphql', 'call to api');\n+â”Š   â”Š147â”Š    httpMock.expectOne(httpReq => httpReq.body.operationName === 'GetChats', 'call to getChats api');\n+â”Š   â”Š148â”Š    const req = httpMock.expectOne(httpReq => httpReq.body.operationName === 'GetChat', 'call to getChat api');\n â”Š148â”Š149â”Š    req.flush({\n â”Š149â”Š150â”Š      data: {\n â”Š150â”Š151â”Š        chat\n```\n\n[}]: #"
          },
          {
            "manualTitle": "Step 13: Zero latency on slow 3g networks",
            "stepRevision": "1f1887e84592ce2e8766558e70d1fb57ec1564c7",
            "manualView": "## Client\n\nNow let's start our client in production mode:\n\n    $ ng serve --prod\n\nNow open the Chrome Developers Tools and, in the Network tab, select 'Slow 3G Network' and 'Disable cache'.\nNow refresh the page and look at the DOMContentLoaded time and at the transferred size. You'll notice that our bundle size is quite small and so the loads time.\nNow let's click on a specific chat. It will take some time to load the data. Now let's add a new message. Once again it will take some time to load the data. We could also create a new chat and the result would be the same. The whole app doesn't\nfeel as snappier as the real Whatsapp on a slow 3G Network.\n\"That's normal, it's a web application with a remote db while Whatsapp is a native app with a local database...\"\nThat's just an excuse, because we can do as good as Whatsapp thanks to Apollo!\n\nLet's install `moment`, we will soon need it:\n\n    $ npm install moment\n\nLet's start by making our UI optimistic. We can predict most of the response we will get from our server, except for a few things like `id` of newly created messages. But since we don't really need that id, we can simply generate a fake one\nwhich will be later overridden once we get the response from the server:\n\n[{]: <helper> (diffStep \"9.1\" files=\"^\\(?!package.json$\\).*\" module=\"client\")\n\n#### Step 9.1: Optimistic updates\n\n##### Changed src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-chat&#x2F;new-chat.component.ts\n```diff\n@@ -51,7 +51,7 @@\n â”Š51â”Š51â”Š      // Chat is already listed for the current user\n â”Š52â”Š52â”Š      this.router.navigate(['/chat', chatId]);\n â”Š53â”Š53â”Š    } else {\n-â”Š54â”Š  â”Š      this.chatsService.addChat(recipientId).subscribe(({data: {addChat: {id}}}: { data: AddChat.Mutation }) => {\n+â”Š  â”Š54â”Š      this.chatsService.addChat(recipientId, this.users).subscribe(({data: {addChat: {id}}}: { data: AddChat.Mutation }) => {\n â”Š55â”Š55â”Š        this.router.navigate(['/chat', id]);\n â”Š56â”Š56â”Š      });\n â”Š57â”Š57â”Š    }\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -14,8 +14,10 @@\n â”Š14â”Š14â”Šimport {Observable} from 'rxjs/Observable';\n â”Š15â”Š15â”Šimport {addChatMutation} from '../../graphql/addChat.mutation';\n â”Š16â”Š16â”Šimport {addGroupMutation} from '../../graphql/addGroup.mutation';\n+â”Š  â”Š17â”Šimport * as moment from 'moment';\n â”Š17â”Š18â”Š\n â”Š18â”Š19â”Šconst currentUserId = '1';\n+â”Š  â”Š20â”Šconst currentUserName = 'Ethan Gonzalez';\n â”Š19â”Š21â”Š\n â”Š20â”Š22â”Š@Injectable()\n â”Š21â”Š23â”Šexport class ChatsService {\n```\n```diff\n@@ -37,6 +39,10 @@\n â”Š37â”Š39â”Š    this.chats$.subscribe(chats => this.chats = chats);\n â”Š38â”Š40â”Š  }\n â”Š39â”Š41â”Š\n+â”Š  â”Š42â”Š  static getRandomId() {\n+â”Š  â”Š43â”Š    return String(Math.round(Math.random() * 1000000000000));\n+â”Š  â”Š44â”Š  }\n+â”Š  â”Š45â”Š\n â”Š40â”Š46â”Š  getChats() {\n â”Š41â”Š47â”Š    return {query: this.getChatsWq, chats$: this.chats$};\n â”Š42â”Š48â”Š  }\n```\n```diff\n@@ -63,6 +69,24 @@\n â”Š63â”Š69â”Š        chatId,\n â”Š64â”Š70â”Š        content,\n â”Š65â”Š71â”Š      },\n+â”Š  â”Š72â”Š      optimisticResponse: {\n+â”Š  â”Š73â”Š        __typename: 'Mutation',\n+â”Š  â”Š74â”Š        addMessage: {\n+â”Š  â”Š75â”Š          id: ChatsService.getRandomId(),\n+â”Š  â”Š76â”Š          __typename: 'Message',\n+â”Š  â”Š77â”Š          senderId: currentUserId,\n+â”Š  â”Š78â”Š          sender: {\n+â”Š  â”Š79â”Š            id: currentUserId,\n+â”Š  â”Š80â”Š            __typename: 'User',\n+â”Š  â”Š81â”Š            name: currentUserName,\n+â”Š  â”Š82â”Š          },\n+â”Š  â”Š83â”Š          content,\n+â”Š  â”Š84â”Š          createdAt: moment().unix(),\n+â”Š  â”Š85â”Š          type: 0,\n+â”Š  â”Š86â”Š          recipients: [],\n+â”Š  â”Š87â”Š          ownership: true,\n+â”Š  â”Š88â”Š        },\n+â”Š  â”Š89â”Š      },\n â”Š66â”Š90â”Š      update: (store, { data: { addMessage } }: {data: AddMessage.Mutation}) => {\n â”Š67â”Š91â”Š        // Update the messages cache\n â”Š68â”Š92â”Š        {\n```\n```diff\n@@ -109,6 +133,10 @@\n â”Š109â”Š133â”Š      variables: <RemoveChat.Variables>{\n â”Š110â”Š134â”Š        chatId,\n â”Š111â”Š135â”Š      },\n+â”Š   â”Š136â”Š      optimisticResponse: {\n+â”Š   â”Š137â”Š        __typename: 'Mutation',\n+â”Š   â”Š138â”Š        removeChat: chatId,\n+â”Š   â”Š139â”Š      },\n â”Š112â”Š140â”Š      update: (store, { data: { removeChat } }) => {\n â”Š113â”Š141â”Š        // Read the data from our cache for this query.\n â”Š114â”Š142â”Š        const {chats}: GetChats.Query = store.readQuery({\n```\n```diff\n@@ -155,6 +183,10 @@\n â”Š155â”Š183â”Š    return this.apollo.mutate(<MutationOptions>{\n â”Š156â”Š184â”Š      mutation,\n â”Š157â”Š185â”Š      variables,\n+â”Š   â”Š186â”Š      optimisticResponse: {\n+â”Š   â”Š187â”Š        __typename: 'Mutation',\n+â”Š   â”Š188â”Š        removeMessages: ids,\n+â”Š   â”Š189â”Š      },\n â”Š158â”Š190â”Š      update: (store, { data: { removeMessages } }: {data: RemoveMessages.Mutation | RemoveAllMessages.Mutation}) => {\n â”Š159â”Š191â”Š        // Update the messages cache\n â”Š160â”Š192â”Š        {\n```\n```diff\n@@ -223,12 +255,34 @@\n â”Š223â”Š255â”Š    return _chat ? _chat.id : false;\n â”Š224â”Š256â”Š  }\n â”Š225â”Š257â”Š\n-â”Š226â”Š   â”Š  addChat(recipientId: string) {\n+â”Š   â”Š258â”Š  addChat(recipientId: string, users: GetUsers.Users[]) {\n â”Š227â”Š259â”Š    return this.apollo.mutate({\n â”Š228â”Š260â”Š      mutation: addChatMutation,\n â”Š229â”Š261â”Š      variables: <AddChat.Variables>{\n â”Š230â”Š262â”Š        recipientId,\n â”Š231â”Š263â”Š      },\n+â”Š   â”Š264â”Š      optimisticResponse: {\n+â”Š   â”Š265â”Š        __typename: 'Mutation',\n+â”Š   â”Š266â”Š        addChat: {\n+â”Š   â”Š267â”Š          id: ChatsService.getRandomId(),\n+â”Š   â”Š268â”Š          __typename: 'Chat',\n+â”Š   â”Š269â”Š          name: users.find(user => user.id === recipientId).name,\n+â”Š   â”Š270â”Š          picture: users.find(user => user.id === recipientId).picture,\n+â”Š   â”Š271â”Š          allTimeMembers: [\n+â”Š   â”Š272â”Š            {\n+â”Š   â”Š273â”Š              id: currentUserId,\n+â”Š   â”Š274â”Š              __typename: 'User',\n+â”Š   â”Š275â”Š            },\n+â”Š   â”Š276â”Š            {\n+â”Š   â”Š277â”Š              id: recipientId,\n+â”Š   â”Š278â”Š              __typename: 'User',\n+â”Š   â”Š279â”Š            }\n+â”Š   â”Š280â”Š          ],\n+â”Š   â”Š281â”Š          unreadMessages: 0,\n+â”Š   â”Š282â”Š          messages: [],\n+â”Š   â”Š283â”Š          isGroup: false,\n+â”Š   â”Š284â”Š        },\n+â”Š   â”Š285â”Š      },\n â”Š232â”Š286â”Š      update: (store, { data: { addChat } }) => {\n â”Š233â”Š287â”Š        // Read the data from our cache for this query.\n â”Š234â”Š288â”Š        const {chats}: GetChats.Query = store.readQuery({\n```\n```diff\n@@ -260,6 +314,26 @@\n â”Š260â”Š314â”Š        recipientIds,\n â”Š261â”Š315â”Š        groupName,\n â”Š262â”Š316â”Š      },\n+â”Š   â”Š317â”Š      optimisticResponse: {\n+â”Š   â”Š318â”Š        __typename: 'Mutation',\n+â”Š   â”Š319â”Š        addGroup: {\n+â”Š   â”Š320â”Š          id: ChatsService.getRandomId(),\n+â”Š   â”Š321â”Š          __typename: 'Chat',\n+â”Š   â”Š322â”Š          name: groupName,\n+â”Š   â”Š323â”Š          picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n+â”Š   â”Š324â”Š          userIds: [currentUserId, recipientIds],\n+â”Š   â”Š325â”Š          allTimeMembers: [\n+â”Š   â”Š326â”Š            {\n+â”Š   â”Š327â”Š              id: currentUserId,\n+â”Š   â”Š328â”Š              __typename: 'User',\n+â”Š   â”Š329â”Š            },\n+â”Š   â”Š330â”Š            ...recipientIds.map(id => ({id, __typename: 'User'})),\n+â”Š   â”Š331â”Š          ],\n+â”Š   â”Š332â”Š          unreadMessages: 0,\n+â”Š   â”Š333â”Š          messages: [],\n+â”Š   â”Š334â”Š          isGroup: true,\n+â”Š   â”Š335â”Š        },\n+â”Š   â”Š336â”Š      },\n â”Š263â”Š337â”Š      update: (store, { data: { addGroup } }) => {\n â”Š264â”Š338â”Š        // Read the data from our cache for this query.\n â”Š265â”Š339â”Š        const {chats}: GetChats.Query = store.readQuery({\n```\n\n[}]: #\n\nWhen we open a specific chat we can also preload some data from our chats list cache while waiting for the server response. We will initially be able to show only the chat name, the last message or the last few messages and a few more informations instead of the whole content from the server, but that would be more than enough to entertain the user while waiting for the server response:\n\n[{]: <helper> (diffStep \"9.2\" module=\"client\")\n\n#### Step 9.2: Get chat data from chats cache while waiting for server response\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,5 +1,5 @@\n â”Š1â”Š1â”Šimport {ApolloQueryResult, MutationOptions, WatchQueryOptions} from 'apollo-client';\n-â”Š2â”Š â”Šimport {map} from 'rxjs/operators';\n+â”Š â”Š2â”Šimport {concat, map} from 'rxjs/operators';\n â”Š3â”Š3â”Šimport {Apollo, QueryRef} from 'apollo-angular';\n â”Š4â”Š4â”Šimport {Injectable} from '@angular/core';\n â”Š5â”Š5â”Šimport {getChatsQuery} from '../../graphql/getChats.query';\n```\n```diff\n@@ -15,6 +15,8 @@\n â”Š15â”Š15â”Šimport {addChatMutation} from '../../graphql/addChat.mutation';\n â”Š16â”Š16â”Šimport {addGroupMutation} from '../../graphql/addGroup.mutation';\n â”Š17â”Š17â”Šimport * as moment from 'moment';\n+â”Š  â”Š18â”Šimport {AsyncSubject} from 'rxjs/AsyncSubject';\n+â”Š  â”Š19â”Šimport {of} from 'rxjs/observable/of';\n â”Š18â”Š20â”Š\n â”Š19â”Š21â”Šconst currentUserId = '1';\n â”Š20â”Š22â”Šconst currentUserName = 'Ethan Gonzalez';\n```\n```diff\n@@ -25,6 +27,7 @@\n â”Š25â”Š27â”Š  getChatsWq: QueryRef<GetChats.Query>;\n â”Š26â”Š28â”Š  chats$: Observable<GetChats.Chats[]>;\n â”Š27â”Š29â”Š  chats: GetChats.Chats[];\n+â”Š  â”Š30â”Š  getChatWqSubject: AsyncSubject<QueryRef<GetChat.Query>>;\n â”Š28â”Š31â”Š\n â”Š29â”Š32â”Š  constructor(private apollo: Apollo) {\n â”Š30â”Š33â”Š    this.getChatsWq = this.apollo.watchQuery<GetChats.Query>(<WatchQueryOptions>{\n```\n```diff\n@@ -48,18 +51,34 @@\n â”Š48â”Š51â”Š  }\n â”Š49â”Š52â”Š\n â”Š50â”Š53â”Š  getChat(chatId: string) {\n+â”Š  â”Š54â”Š    const _chat = this.chats && this.chats.find(chat => chat.id === chatId) || {\n+â”Š  â”Š55â”Š      id: chatId,\n+â”Š  â”Š56â”Š      name: '',\n+â”Š  â”Š57â”Š      picture: null,\n+â”Š  â”Š58â”Š      allTimeMembers: [],\n+â”Š  â”Š59â”Š      unreadMessages: 0,\n+â”Š  â”Š60â”Š      isGroup: false,\n+â”Š  â”Š61â”Š      messages: [],\n+â”Š  â”Š62â”Š    };\n+â”Š  â”Š63â”Š    const chat$FromCache = of<GetChat.Chat>(_chat);\n+â”Š  â”Š64â”Š\n â”Š51â”Š65â”Š    const query = this.apollo.watchQuery<GetChat.Query>({\n â”Š52â”Š66â”Š      query: getChatQuery,\n â”Š53â”Š67â”Š      variables: {\n-â”Š54â”Š  â”Š        chatId: chatId,\n+â”Š  â”Š68â”Š        chatId,\n â”Š55â”Š69â”Š      }\n â”Š56â”Š70â”Š    });\n â”Š57â”Š71â”Š\n-â”Š58â”Š  â”Š    const chat$ = query.valueChanges.pipe(\n-â”Š59â”Š  â”Š      map((result: ApolloQueryResult<GetChat.Query>) => result.data.chat)\n-â”Š60â”Š  â”Š    );\n+â”Š  â”Š72â”Š    const chat$ = chat$FromCache.pipe(\n+â”Š  â”Š73â”Š      concat(query.valueChanges.pipe(\n+â”Š  â”Š74â”Š        map((result: ApolloQueryResult<GetChat.Query>) => result.data.chat)\n+â”Š  â”Š75â”Š      )));\n+â”Š  â”Š76â”Š\n+â”Š  â”Š77â”Š    this.getChatWqSubject = new AsyncSubject();\n+â”Š  â”Š78â”Š    this.getChatWqSubject.next(query);\n+â”Š  â”Š79â”Š    this.getChatWqSubject.complete();\n â”Š61â”Š80â”Š\n-â”Š62â”Š  â”Š    return {query, chat$};\n+â”Š  â”Š81â”Š    return {query$: this.getChatWqSubject.asObservable(), chat$};\n â”Š63â”Š82â”Š  }\n â”Š64â”Š83â”Š\n â”Š65â”Š84â”Š  addMessage(chatId: string, content: string) {\n```\n\n[}]: #\n\nNow let's deal with the most difficult part: what about chats creation? We cannot predict the `id` of the new chat and so we cannot navigate to the chat page because it contains the chat id in the url. We could simply navigate to the \"optimistic\" id, but then the user wouldn't be able to reach that url if he refreshes the page or bookmarks it. That's a problem we care about. How to solve it? We're going to create a landing page and we will later override the url once we get the response from the server!\n\n[{]: <helper> (diffStep \"9.3\" module=\"client\")\n\n#### Step 9.3: Landing page for new chats/groups\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.spec.ts\n```diff\n@@ -116,7 +116,10 @@\n â”Š116â”Š116â”Š        Apollo,\n â”Š117â”Š117â”Š        {\n â”Š118â”Š118â”Š          provide: ActivatedRoute,\n-â”Š119â”Š   â”Š          useValue: { params: of({ id: chat.id }) }\n+â”Š   â”Š119â”Š          useValue: {\n+â”Š   â”Š120â”Š            params: of({ id: chat.id }),\n+â”Š   â”Š121â”Š            queryParams: of({}),\n+â”Š   â”Š122â”Š          }\n â”Š120â”Š123â”Š        }\n â”Š121â”Š124â”Š      ],\n â”Š122â”Š125â”Š      schemas: [NO_ERRORS_SCHEMA]\n```\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.ts\n```diff\n@@ -2,6 +2,8 @@\n â”Š2â”Š2â”Šimport {ActivatedRoute, Router} from '@angular/router';\n â”Š3â”Š3â”Šimport {ChatsService} from '../../../services/chats.service';\n â”Š4â”Š4â”Šimport {GetChat} from '../../../../types';\n+â”Š â”Š5â”Šimport {combineLatest} from 'rxjs/observable/combineLatest';\n+â”Š â”Š6â”Šimport {Location} from '@angular/common';\n â”Š5â”Š7â”Š\n â”Š6â”Š8â”Š@Component({\n â”Š7â”Š9â”Š  template: `\n```\n```diff\n@@ -26,21 +28,40 @@\n â”Š26â”Š28â”Š  messages: GetChat.Messages[];\n â”Š27â”Š29â”Š  name: string;\n â”Š28â”Š30â”Š  isGroup: boolean;\n+â”Š  â”Š31â”Š  optimisticUI: boolean;\n â”Š29â”Š32â”Š\n â”Š30â”Š33â”Š  constructor(private route: ActivatedRoute,\n â”Š31â”Š34â”Š              private router: Router,\n+â”Š  â”Š35â”Š              private location: Location,\n â”Š32â”Š36â”Š              private chatsService: ChatsService) {\n â”Š33â”Š37â”Š  }\n â”Š34â”Š38â”Š\n â”Š35â”Š39â”Š  ngOnInit() {\n-â”Š36â”Š  â”Š    this.route.params.subscribe(({id: chatId}) => {\n-â”Š37â”Š  â”Š      this.chatId = chatId;\n-â”Š38â”Š  â”Š      this.chatsService.getChat(chatId).chat$.subscribe(chat => {\n-â”Š39â”Š  â”Š        this.messages = chat.messages;\n-â”Š40â”Š  â”Š        this.name = chat.name;\n-â”Š41â”Š  â”Š        this.isGroup = chat.isGroup;\n+â”Š  â”Š40â”Š    combineLatest(this.route.params, this.route.queryParams,\n+â”Š  â”Š41â”Š      (params: { id: string }, queryParams: { oui?: boolean }) => ({params, queryParams}))\n+â”Š  â”Š42â”Š      .subscribe(({params: {id: chatId}, queryParams: {oui}}) => {\n+â”Š  â”Š43â”Š        this.chatId = chatId;\n+â”Š  â”Š44â”Š\n+â”Š  â”Š45â”Š        this.optimisticUI = oui;\n+â”Š  â”Š46â”Š\n+â”Š  â”Š47â”Š        if (this.optimisticUI) {\n+â”Š  â”Š48â”Š          // We are using fake IDs generated by the Optimistic UI\n+â”Š  â”Š49â”Š          this.chatsService.addChat$.subscribe(({data: {addChat, addGroup}}) => {\n+â”Š  â”Š50â”Š            this.chatId = addChat ? addChat.id : addGroup.id;\n+â”Š  â”Š51â”Š            console.log(`Switching from the Optimistic UI id ${chatId} to ${this.chatId}`);\n+â”Š  â”Š52â”Š            // Rewrite the URL\n+â”Š  â”Š53â”Š            this.location.go(`chat/${this.chatId}`);\n+â”Š  â”Š54â”Š            // Optimistic UI no more\n+â”Š  â”Š55â”Š            this.optimisticUI = false;\n+â”Š  â”Š56â”Š          });\n+â”Š  â”Š57â”Š        }\n+â”Š  â”Š58â”Š\n+â”Š  â”Š59â”Š        this.chatsService.getChat(chatId, this.optimisticUI).chat$.subscribe(chat => {\n+â”Š  â”Š60â”Š          this.messages = chat.messages;\n+â”Š  â”Š61â”Š          this.name = chat.name;\n+â”Š  â”Š62â”Š          this.isGroup = chat.isGroup;\n+â”Š  â”Š63â”Š        });\n â”Š42â”Š64â”Š      });\n-â”Š43â”Š  â”Š    });\n â”Š44â”Š65â”Š  }\n â”Š45â”Š66â”Š\n â”Š46â”Š67â”Š  goToChats() {\n```\n\n##### Changed src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-chat&#x2F;new-chat.component.ts\n```diff\n@@ -51,9 +51,10 @@\n â”Š51â”Š51â”Š      // Chat is already listed for the current user\n â”Š52â”Š52â”Š      this.router.navigate(['/chat', chatId]);\n â”Š53â”Š53â”Š    } else {\n-â”Š54â”Š  â”Š      this.chatsService.addChat(recipientId, this.users).subscribe(({data: {addChat: {id}}}: { data: AddChat.Mutation }) => {\n-â”Š55â”Š  â”Š        this.router.navigate(['/chat', id]);\n-â”Š56â”Š  â”Š      });\n+â”Š  â”Š54â”Š      // Generate id for Optimistic UI\n+â”Š  â”Š55â”Š      const ouiId = ChatsService.getRandomId();\n+â”Š  â”Š56â”Š      this.chatsService.addChat(recipientId, this.users, ouiId).subscribe();\n+â”Š  â”Š57â”Š      this.router.navigate(['/chat', ouiId], {queryParams: {oui: true}, skipLocationChange: true});\n â”Š57â”Š58â”Š    }\n â”Š58â”Š59â”Š  }\n â”Š59â”Š60â”Š}\n```\n\n##### Changed src&#x2F;app&#x2F;chats-creation&#x2F;containers&#x2F;new-group&#x2F;new-group.component.ts\n```diff\n@@ -52,9 +52,9 @@\n â”Š52â”Š52â”Š\n â”Š53â”Š53â”Š  addGroup(groupName: string) {\n â”Š54â”Š54â”Š    if (groupName && this.recipientIds.length) {\n-â”Š55â”Š  â”Š      this.chatsService.addGroup(this.recipientIds, groupName).subscribe(({data: {addGroup: {id}}}: { data: AddGroup.Mutation }) => {\n-â”Š56â”Š  â”Š        this.router.navigate(['/chat', id]);\n-â”Š57â”Š  â”Š      });\n+â”Š  â”Š55â”Š      const ouiId = ChatsService.getRandomId();\n+â”Š  â”Š56â”Š      this.chatsService.addGroup(this.recipientIds, groupName, ouiId).subscribe();\n+â”Š  â”Š57â”Š      this.router.navigate(['/chat', ouiId], {queryParams: {oui: true}, skipLocationChange: true});\n â”Š58â”Š58â”Š    }\n â”Š59â”Š59â”Š  }\n â”Š60â”Š60â”Š}\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -1,5 +1,5 @@\n â”Š1â”Š1â”Šimport {ApolloQueryResult, MutationOptions, WatchQueryOptions} from 'apollo-client';\n-â”Š2â”Š â”Šimport {concat, map} from 'rxjs/operators';\n+â”Š â”Š2â”Šimport {concat, map, share, switchMap} from 'rxjs/operators';\n â”Š3â”Š3â”Šimport {Apollo, QueryRef} from 'apollo-angular';\n â”Š4â”Š4â”Šimport {Injectable} from '@angular/core';\n â”Š5â”Š5â”Šimport {getChatsQuery} from '../../graphql/getChats.query';\n```\n```diff\n@@ -17,6 +17,7 @@\n â”Š17â”Š17â”Šimport * as moment from 'moment';\n â”Š18â”Š18â”Šimport {AsyncSubject} from 'rxjs/AsyncSubject';\n â”Š19â”Š19â”Šimport {of} from 'rxjs/observable/of';\n+â”Š  â”Š20â”Šimport {FetchResult} from 'apollo-link';\n â”Š20â”Š21â”Š\n â”Š21â”Š22â”Šconst currentUserId = '1';\n â”Š22â”Š23â”Šconst currentUserName = 'Ethan Gonzalez';\n```\n```diff\n@@ -28,6 +29,7 @@\n â”Š28â”Š29â”Š  chats$: Observable<GetChats.Chats[]>;\n â”Š29â”Š30â”Š  chats: GetChats.Chats[];\n â”Š30â”Š31â”Š  getChatWqSubject: AsyncSubject<QueryRef<GetChat.Query>>;\n+â”Š  â”Š32â”Š  addChat$: Observable<FetchResult<AddChat.Mutation | AddGroup.Mutation>>;\n â”Š31â”Š33â”Š\n â”Š32â”Š34â”Š  constructor(private apollo: Apollo) {\n â”Š33â”Š35â”Š    this.getChatsWq = this.apollo.watchQuery<GetChats.Query>(<WatchQueryOptions>{\n```\n```diff\n@@ -50,7 +52,7 @@\n â”Š50â”Š52â”Š    return {query: this.getChatsWq, chats$: this.chats$};\n â”Š51â”Š53â”Š  }\n â”Š52â”Š54â”Š\n-â”Š53â”Š  â”Š  getChat(chatId: string) {\n+â”Š  â”Š55â”Š  getChat(chatId: string, oui?: boolean) {\n â”Š54â”Š56â”Š    const _chat = this.chats && this.chats.find(chat => chat.id === chatId) || {\n â”Š55â”Š57â”Š      id: chatId,\n â”Š56â”Š58â”Š      name: '',\n```\n```diff\n@@ -62,21 +64,39 @@\n â”Š 62â”Š 64â”Š    };\n â”Š 63â”Š 65â”Š    const chat$FromCache = of<GetChat.Chat>(_chat);\n â”Š 64â”Š 66â”Š\n-â”Š 65â”Š   â”Š    const query = this.apollo.watchQuery<GetChat.Query>({\n-â”Š 66â”Š   â”Š      query: getChatQuery,\n-â”Š 67â”Š   â”Š      variables: {\n-â”Š 68â”Š   â”Š        chatId,\n-â”Š 69â”Š   â”Š      }\n-â”Š 70â”Š   â”Š    });\n-â”Š 71â”Š   â”Š\n-â”Š 72â”Š   â”Š    const chat$ = chat$FromCache.pipe(\n-â”Š 73â”Š   â”Š      concat(query.valueChanges.pipe(\n-â”Š 74â”Š   â”Š        map((result: ApolloQueryResult<GetChat.Query>) => result.data.chat)\n-â”Š 75â”Š   â”Š      )));\n+â”Š   â”Š 67â”Š    const getApolloWatchQuery = (id: string) => {\n+â”Š   â”Š 68â”Š      return this.apollo.watchQuery<GetChat.Query>({\n+â”Š   â”Š 69â”Š        query: getChatQuery,\n+â”Š   â”Š 70â”Š        variables: {\n+â”Š   â”Š 71â”Š          chatId: id,\n+â”Š   â”Š 72â”Š        }\n+â”Š   â”Š 73â”Š      });\n+â”Š   â”Š 74â”Š    };\n â”Š 76â”Š 75â”Š\n+â”Š   â”Š 76â”Š    let chat$: Observable<GetChat.Chat>;\n â”Š 77â”Š 77â”Š    this.getChatWqSubject = new AsyncSubject();\n-â”Š 78â”Š   â”Š    this.getChatWqSubject.next(query);\n-â”Š 79â”Š   â”Š    this.getChatWqSubject.complete();\n+â”Š   â”Š 78â”Š\n+â”Š   â”Š 79â”Š    if (oui) {\n+â”Š   â”Š 80â”Š      chat$ = chat$FromCache.pipe(\n+â”Š   â”Š 81â”Š        concat(this.addChat$.pipe(\n+â”Š   â”Š 82â”Š          switchMap(({ data: { addChat, addGroup } }) => {\n+â”Š   â”Š 83â”Š            const query = getApolloWatchQuery(addChat ? addChat.id : addGroup.id);\n+â”Š   â”Š 84â”Š            this.getChatWqSubject.next(query);\n+â”Š   â”Š 85â”Š            this.getChatWqSubject.complete();\n+â”Š   â”Š 86â”Š            return query.valueChanges.pipe(\n+â”Š   â”Š 87â”Š              map((result: ApolloQueryResult<GetChat.Query>) => result.data.chat)\n+â”Š   â”Š 88â”Š            );\n+â”Š   â”Š 89â”Š          }))\n+â”Š   â”Š 90â”Š        ));\n+â”Š   â”Š 91â”Š    } else {\n+â”Š   â”Š 92â”Š      const query = getApolloWatchQuery(chatId);\n+â”Š   â”Š 93â”Š      this.getChatWqSubject.next(query);\n+â”Š   â”Š 94â”Š      this.getChatWqSubject.complete();\n+â”Š   â”Š 95â”Š      chat$ = chat$FromCache.pipe(\n+â”Š   â”Š 96â”Š        concat(query.valueChanges.pipe(\n+â”Š   â”Š 97â”Š          map((result: ApolloQueryResult<GetChat.Query>) => result.data.chat)\n+â”Š   â”Š 98â”Š        )));\n+â”Š   â”Š 99â”Š    }\n â”Š 80â”Š100â”Š\n â”Š 81â”Š101â”Š    return {query$: this.getChatWqSubject.asObservable(), chat$};\n â”Š 82â”Š102â”Š  }\n```\n```diff\n@@ -274,8 +294,8 @@\n â”Š274â”Š294â”Š    return _chat ? _chat.id : false;\n â”Š275â”Š295â”Š  }\n â”Š276â”Š296â”Š\n-â”Š277â”Š   â”Š  addChat(recipientId: string, users: GetUsers.Users[]) {\n-â”Š278â”Š   â”Š    return this.apollo.mutate({\n+â”Š   â”Š297â”Š  addChat(recipientId: string, users: GetUsers.Users[], ouiId: string) {\n+â”Š   â”Š298â”Š    this.addChat$ = this.apollo.mutate({\n â”Š279â”Š299â”Š      mutation: addChatMutation,\n â”Š280â”Š300â”Š      variables: <AddChat.Variables>{\n â”Š281â”Š301â”Š        recipientId,\n```\n```diff\n@@ -283,7 +303,7 @@\n â”Š283â”Š303â”Š      optimisticResponse: {\n â”Š284â”Š304â”Š        __typename: 'Mutation',\n â”Š285â”Š305â”Š        addChat: {\n-â”Š286â”Š   â”Š          id: ChatsService.getRandomId(),\n+â”Š   â”Š306â”Š          id: ouiId,\n â”Š287â”Š307â”Š          __typename: 'Chat',\n â”Š288â”Š308â”Š          name: users.find(user => user.id === recipientId).name,\n â”Š289â”Š309â”Š          picture: users.find(user => user.id === recipientId).picture,\n```\n```diff\n@@ -323,11 +343,12 @@\n â”Š323â”Š343â”Š          },\n â”Š324â”Š344â”Š        });\n â”Š325â”Š345â”Š      },\n-â”Š326â”Š   â”Š    });\n+â”Š   â”Š346â”Š    }).pipe(share());\n+â”Š   â”Š347â”Š    return this.addChat$;\n â”Š327â”Š348â”Š  }\n â”Š328â”Š349â”Š\n-â”Š329â”Š   â”Š  addGroup(recipientIds: string[], groupName: string) {\n-â”Š330â”Š   â”Š    return this.apollo.mutate({\n+â”Š   â”Š350â”Š  addGroup(recipientIds: string[], groupName: string, ouiId: string) {\n+â”Š   â”Š351â”Š    this.addChat$ = this.apollo.mutate({\n â”Š331â”Š352â”Š      mutation: addGroupMutation,\n â”Š332â”Š353â”Š      variables: <AddGroup.Variables>{\n â”Š333â”Š354â”Š        recipientIds,\n```\n```diff\n@@ -336,7 +357,7 @@\n â”Š336â”Š357â”Š      optimisticResponse: {\n â”Š337â”Š358â”Š        __typename: 'Mutation',\n â”Š338â”Š359â”Š        addGroup: {\n-â”Š339â”Š   â”Š          id: ChatsService.getRandomId(),\n+â”Š   â”Š360â”Š          id: ouiId,\n â”Š340â”Š361â”Š          __typename: 'Chat',\n â”Š341â”Š362â”Š          name: groupName,\n â”Š342â”Š363â”Š          picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n```\n```diff\n@@ -374,6 +395,7 @@\n â”Š374â”Š395â”Š          },\n â”Š375â”Š396â”Š        });\n â”Š376â”Š397â”Š      },\n-â”Š377â”Š   â”Š    });\n+â”Š   â”Š398â”Š    }).pipe(share());\n+â”Š   â”Š399â”Š    return this.addChat$;\n â”Š378â”Š400â”Š  }\n â”Š379â”Š401â”Š}\n```\n\n[}]: #"
          },
          {
            "manualTitle": "Step 14: Authentication",
            "stepRevision": "9f1e41047667dae351c598fb43bd3ebc72a7da16",
            "manualView": "## Server\n\nAuthentication is an hot topic in the GraphQL world and there are some projects which aim at authenticating through GraphQL.\nSince often you will be required to use a specific auth framework (because of a feature you need or because of an existing authorization infrastructure) I will show you how to use a classic REST API framework within your GraphQL application.\nThis approach is completely fine and in line with the official GraphQL best practices.\nWe will use `Passport` for the authentication and `BasicAuth` as the auth mechanism:\n\n    npm install bcrypt-nodejs passport passport-http\n    npm install --save-dev @types/bcrypt-nodejs @types/passport @types/passport-http\n\n`BasicAuth` basically involves to send username e password in an Authorization Header together with each request and is fully supported by any browser (meaning that we will be able to use `Graphiql` simply by proving username and password in the login window provided by the browser itself).\nIt's the most simple auth mechanism but it's completely fine for our needs. Later we could decide to use something more complicated like `JWT`, but it's outside of the scope of this tutorial.\n\n[{]: <helper> (diffStep \"4.1\" files=\"index.ts\" module=\"server\")\n\n#### Step 4.1: Authentication\n\n##### Changed index.ts\n```diff\n@@ -3,6 +3,47 @@\n â”Š 3â”Š 3â”Šimport * as cors from 'cors';\n â”Š 4â”Š 4â”Šimport * as express from 'express';\n â”Š 5â”Š 5â”Šimport { graphiqlExpress, graphqlExpress } from \"apollo-server-express\";\n+â”Š  â”Š 6â”Šimport * as passport from \"passport\";\n+â”Š  â”Š 7â”Šimport * as basicStrategy from 'passport-http';\n+â”Š  â”Š 8â”Šimport * as bcrypt from 'bcrypt-nodejs';\n+â”Š  â”Š 9â”Šimport { db, User } from \"./db\";\n+â”Š  â”Š10â”Š\n+â”Š  â”Š11â”Šlet users = db.users;\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Šfunction generateHash(password: string) {\n+â”Š  â”Š14â”Š  return bcrypt.hashSync(password, bcrypt.genSaltSync(8));\n+â”Š  â”Š15â”Š}\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Šfunction validPassword(password: string, localPassword: string) {\n+â”Š  â”Š18â”Š  return bcrypt.compareSync(password, localPassword);\n+â”Š  â”Š19â”Š}\n+â”Š  â”Š20â”Š\n+â”Š  â”Š21â”Špassport.use('basic-signin', new basicStrategy.BasicStrategy(\n+â”Š  â”Š22â”Š  function (username, password, done) {\n+â”Š  â”Š23â”Š    const user = users.find(user => user.username == username);\n+â”Š  â”Š24â”Š    if (user && validPassword(password, user.password)) {\n+â”Š  â”Š25â”Š      return done(null, user);\n+â”Š  â”Š26â”Š    }\n+â”Š  â”Š27â”Š    return done(null, false);\n+â”Š  â”Š28â”Š  }\n+â”Š  â”Š29â”Š));\n+â”Š  â”Š30â”Š\n+â”Š  â”Š31â”Špassport.use('basic-signup', new basicStrategy.BasicStrategy({passReqToCallback: true},\n+â”Š  â”Š32â”Š  function (req: any, username: any, password: any, done: any) {\n+â”Š  â”Š33â”Š    const userExists = !!users.find(user => user.username === username);\n+â”Š  â”Š34â”Š    if (!userExists && password && req.body.name) {\n+â”Š  â”Š35â”Š      const user: User = {\n+â”Š  â”Š36â”Š        id: (users.length && users[users.length - 1].id + 1) || 1,\n+â”Š  â”Š37â”Š        username,\n+â”Š  â”Š38â”Š        password: generateHash(password),\n+â”Š  â”Š39â”Š        name: req.body.name,\n+â”Š  â”Š40â”Š      };\n+â”Š  â”Š41â”Š      users.push(user);\n+â”Š  â”Š42â”Š      return done(null, user);\n+â”Š  â”Š43â”Š    }\n+â”Š  â”Š44â”Š    return done(null, false);\n+â”Š  â”Š45â”Š  }\n+â”Š  â”Š46â”Š));\n â”Š 6â”Š47â”Š\n â”Š 7â”Š48â”Šconst PORT = 3000;\n â”Š 8â”Š49â”Š\n```\n```diff\n@@ -10,10 +51,25 @@\n â”Š10â”Š51â”Š\n â”Š11â”Š52â”Šapp.use(cors());\n â”Š12â”Š53â”Šapp.use(bodyParser.json());\n+â”Š  â”Š54â”Šapp.use(passport.initialize());\n+â”Š  â”Š55â”Š\n+â”Š  â”Š56â”Šapp.post('/signup',\n+â”Š  â”Š57â”Š  passport.authenticate('basic-signup', {session: false}),\n+â”Š  â”Š58â”Š  function (req, res) {\n+â”Š  â”Š59â”Š    res.json(req.user);\n+â”Š  â”Š60â”Š  });\n+â”Š  â”Š61â”Š\n+â”Š  â”Š62â”Šapp.use(passport.authenticate('basic-signin', {session: false}));\n+â”Š  â”Š63â”Š\n+â”Š  â”Š64â”Šapp.post('/signin', function (req, res) {\n+â”Š  â”Š65â”Š  res.json(req.user);\n+â”Š  â”Š66â”Š});\n â”Š13â”Š67â”Š\n â”Š14â”Š68â”Šapp.use('/graphql', graphqlExpress(req => ({\n â”Š15â”Š69â”Š  schema: schema,\n-â”Š16â”Š  â”Š  context: req,\n+â”Š  â”Š70â”Š  context: {\n+â”Š  â”Š71â”Š    user: req!['user'],\n+â”Š  â”Š72â”Š  },\n â”Š17â”Š73â”Š})));\n â”Š18â”Š74â”Š\n â”Š19â”Š75â”Šapp.use('/graphiql', graphiqlExpress({\n```\n\n[}]: #\n\nWe are going to store hashes instead of plain passwords, that's why we're using `bcrypt-nodejs`.\nWith `passport.use('basic-signin')` and `passport.use('basic-signup')` we define how the auth framework deals with our database (well, our JSON file for the moment).\n`app.post('/signup')` is the endpoint for creating new accounts, so we left it out of the authentication middleware (`app.use(passport.authenticate('basic-signin')`).\nWhat's of particular interest is that we're passing the user object to the GraphQL context.\n\n[{]: <helper> (diffStep \"4.1\" files=\"schema/resolvers.ts\" module=\"server\")\n\n#### Step 4.1: Authentication\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -8,29 +8,28 @@\n â”Š 8â”Š 8â”Š\n â”Š 9â”Š 9â”Šlet users = db.users;\n â”Š10â”Š10â”Šlet chats = db.chats;\n-â”Š11â”Š  â”Šconst currentUser = 1;\n â”Š12â”Š11â”Š\n â”Š13â”Š12â”Šexport const resolvers: IResolvers = {\n â”Š14â”Š13â”Š  Query: {\n â”Š15â”Š14â”Š    // Show all users for the moment.\n-â”Š16â”Š  â”Š    users: (): User[] => users.filter(user => user.id !== currentUser),\n-â”Š17â”Š  â”Š    chats: (): Chat[] => chats.filter(chat => chat.listingMemberIds.includes(currentUser)),\n+â”Š  â”Š15â”Š    users: (obj: any, args: any, {user: currentUser}: {user: User}): User[] => users.filter(user => user.id !== currentUser.id),\n+â”Š  â”Š16â”Š    chats: (obj: any, args: any, {user: currentUser}: {user: User}): Chat[] => chats.filter(chat => chat.listingMemberIds.includes(currentUser.id)),\n â”Š18â”Š17â”Š    chat: (obj: any, {chatId}: ChatQueryArgs): Chat | null => chats.find(chat => chat.id === Number(chatId)) || null,\n â”Š19â”Š18â”Š  },\n â”Š20â”Š19â”Š  Mutation: {\n-â”Š21â”Š  â”Š    addChat: (obj: any, {recipientId}: AddChatMutationArgs): Chat => {\n+â”Š  â”Š20â”Š    addChat: (obj: any, {recipientId}: AddChatMutationArgs, {user: currentUser}: {user: User}): Chat => {\n â”Š22â”Š21â”Š      if (!users.find(user => user.id === Number(recipientId))) {\n â”Š23â”Š22â”Š        throw new Error(`Recipient ${recipientId} doesn't exist.`);\n â”Š24â”Š23â”Š      }\n â”Š25â”Š24â”Š\n-â”Š26â”Š  â”Š      const chat = chats.find(chat => !chat.name && chat.allTimeMemberIds.includes(currentUser) && chat.allTimeMemberIds.includes(Number(recipientId)));\n+â”Š  â”Š25â”Š      const chat = chats.find(chat => !chat.name && chat.allTimeMemberIds.includes(currentUser.id) && chat.allTimeMemberIds.includes(Number(recipientId)));\n â”Š27â”Š26â”Š      if (chat) {\n â”Š28â”Š27â”Š        // Chat already exists. Both users are already in the allTimeMemberIds array\n â”Š29â”Š28â”Š        const chatId = chat.id;\n-â”Š30â”Š  â”Š        if (!chat.listingMemberIds.includes(currentUser)) {\n+â”Š  â”Š29â”Š        if (!chat.listingMemberIds.includes(currentUser.id)) {\n â”Š31â”Š30â”Š          // The chat isn't listed for the current user. Add him to the memberIds\n-â”Š32â”Š  â”Š          chat.listingMemberIds.push(currentUser);\n-â”Š33â”Š  â”Š          chats.find(chat => chat.id === chatId)!.listingMemberIds.push(currentUser);\n+â”Š  â”Š31â”Š          chat.listingMemberIds.push(currentUser.id);\n+â”Š  â”Š32â”Š          chats.find(chat => chat.id === chatId)!.listingMemberIds.push(currentUser.id);\n â”Š34â”Š33â”Š          return chat;\n â”Š35â”Š34â”Š        } else {\n â”Š36â”Š35â”Š          throw new Error(`Chat already exists.`);\n```\n```diff\n@@ -44,9 +43,9 @@\n â”Š44â”Š43â”Š          picture: null,\n â”Š45â”Š44â”Š          adminIds: null,\n â”Š46â”Š45â”Š          ownerId: null,\n-â”Š47â”Š  â”Š          allTimeMemberIds: [currentUser, Number(recipientId)],\n+â”Š  â”Š46â”Š          allTimeMemberIds: [currentUser.id, Number(recipientId)],\n â”Š48â”Š47â”Š          // Chat will not be listed to the other user until the first message gets written\n-â”Š49â”Š  â”Š          listingMemberIds: [currentUser],\n+â”Š  â”Š48â”Š          listingMemberIds: [currentUser.id],\n â”Š50â”Š49â”Š          actualGroupMemberIds: null,\n â”Š51â”Š50â”Š          messages: [],\n â”Š52â”Š51â”Š        };\n```\n```diff\n@@ -54,7 +53,7 @@\n â”Š54â”Š53â”Š        return chat;\n â”Š55â”Š54â”Š      }\n â”Š56â”Š55â”Š    },\n-â”Š57â”Š  â”Š    addGroup: (obj: any, {recipientIds, groupName}: AddGroupMutationArgs): Chat => {\n+â”Š  â”Š56â”Š    addGroup: (obj: any, {recipientIds, groupName}: AddGroupMutationArgs, {user: currentUser}: {user: User}): Chat => {\n â”Š58â”Š57â”Š      recipientIds.forEach(recipientId => {\n â”Š59â”Š58â”Š        if (!users.find(user => user.id === Number(recipientId))) {\n â”Š60â”Š59â”Š          throw new Error(`Recipient ${recipientId} doesn't exist.`);\n```\n```diff\n@@ -66,17 +65,17 @@\n â”Š66â”Š65â”Š        id,\n â”Š67â”Š66â”Š        name: groupName,\n â”Š68â”Š67â”Š        picture: null,\n-â”Š69â”Š  â”Š        adminIds: [currentUser],\n-â”Š70â”Š  â”Š        ownerId: currentUser,\n-â”Š71â”Š  â”Š        allTimeMemberIds: [currentUser, ...recipientIds.map(id => Number(id))],\n-â”Š72â”Š  â”Š        listingMemberIds: [currentUser, ...recipientIds.map(id => Number(id))],\n-â”Š73â”Š  â”Š        actualGroupMemberIds: [currentUser, ...recipientIds.map(id => Number(id))],\n+â”Š  â”Š68â”Š        adminIds: [currentUser.id],\n+â”Š  â”Š69â”Š        ownerId: currentUser.id,\n+â”Š  â”Š70â”Š        allTimeMemberIds: [currentUser.id, ...recipientIds.map(id => Number(id))],\n+â”Š  â”Š71â”Š        listingMemberIds: [currentUser.id, ...recipientIds.map(id => Number(id))],\n+â”Š  â”Š72â”Š        actualGroupMemberIds: [currentUser.id, ...recipientIds.map(id => Number(id))],\n â”Š74â”Š73â”Š        messages: [],\n â”Š75â”Š74â”Š      };\n â”Š76â”Š75â”Š      chats.push(chat);\n â”Š77â”Š76â”Š      return chat;\n â”Š78â”Š77â”Š    },\n-â”Š79â”Š  â”Š    removeChat: (obj: any, {chatId}: RemoveChatMutationArgs): number => {\n+â”Š  â”Š78â”Š    removeChat: (obj: any, {chatId}: RemoveChatMutationArgs, {user: currentUser}: {user: User}): number => {\n â”Š80â”Š79â”Š      const chat = chats.find(chat => chat.id === Number(chatId));\n â”Š81â”Š80â”Š\n â”Š82â”Š81â”Š      if (!chat) {\n```\n```diff\n@@ -85,14 +84,14 @@\n â”Š85â”Š84â”Š\n â”Š86â”Š85â”Š      if (!chat.name) {\n â”Š87â”Š86â”Š        // Chat\n-â”Š88â”Š  â”Š        if (!chat.listingMemberIds.includes(currentUser)) {\n+â”Š  â”Š87â”Š        if (!chat.listingMemberIds.includes(currentUser.id)) {\n â”Š89â”Š88â”Š          throw new Error(`The user is not a member of the chat ${chatId}.`);\n â”Š90â”Š89â”Š        }\n â”Š91â”Š90â”Š\n â”Š92â”Š91â”Š        // Instead of chaining map and filter we can loop once using reduce\n â”Š93â”Š92â”Š        const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n â”Š94â”Š93â”Š          // Remove the current user from the message holders\n-â”Š95â”Š  â”Š          message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser);\n+â”Š  â”Š94â”Š          message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser.id);\n â”Š96â”Š95â”Š\n â”Š97â”Š96â”Š          if (message.holderIds.length !== 0) {\n â”Š98â”Š97â”Š            filtered.push(message);\n```\n```diff\n@@ -102,7 +101,7 @@\n â”Š102â”Š101â”Š        }, []);\n â”Š103â”Š102â”Š\n â”Š104â”Š103â”Š        // Remove the current user from who gets the chat listed. The chat will no longer appear in his list\n-â”Š105â”Š   â”Š        const listingMemberIds = chat.listingMemberIds.filter(listingId => listingId !== currentUser);\n+â”Š   â”Š104â”Š        const listingMemberIds = chat.listingMemberIds.filter(listingId => listingId !== currentUser.id);\n â”Š106â”Š105â”Š\n â”Š107â”Š106â”Š        // Check how many members are left\n â”Š108â”Š107â”Š        if (listingMemberIds.length === 0) {\n```\n```diff\n@@ -120,14 +119,14 @@\n â”Š120â”Š119â”Š        return Number(chatId);\n â”Š121â”Š120â”Š      } else {\n â”Š122â”Š121â”Š        // Group\n-â”Š123â”Š   â”Š        if (chat.ownerId !== currentUser) {\n+â”Š   â”Š122â”Š        if (chat.ownerId !== currentUser.id) {\n â”Š124â”Š123â”Š          throw new Error(`Group ${chatId} is not owned by the user.`);\n â”Š125â”Š124â”Š        }\n â”Š126â”Š125â”Š\n â”Š127â”Š126â”Š        // Instead of chaining map and filter we can loop once using reduce\n â”Š128â”Š127â”Š        const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n â”Š129â”Š128â”Š          // Remove the current user from the message holders\n-â”Š130â”Š   â”Š          message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser);\n+â”Š   â”Š129â”Š          message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser.id);\n â”Š131â”Š130â”Š\n â”Š132â”Š131â”Š          if (message.holderIds.length !== 0) {\n â”Š133â”Š132â”Š            filtered.push(message);\n```\n```diff\n@@ -137,7 +136,7 @@\n â”Š137â”Š136â”Š        }, []);\n â”Š138â”Š137â”Š\n â”Š139â”Š138â”Š        // Remove the current user from who gets the group listed. The group will no longer appear in his list\n-â”Š140â”Š   â”Š        const listingMemberIds = chat.listingMemberIds.filter(listingId => listingId !== currentUser);\n+â”Š   â”Š139â”Š        const listingMemberIds = chat.listingMemberIds.filter(listingId => listingId !== currentUser.id);\n â”Š141â”Š140â”Š\n â”Š142â”Š141â”Š        // Check how many members (including previous ones who can still access old messages) are left\n â”Š143â”Š142â”Š        if (listingMemberIds.length === 0) {\n```\n```diff\n@@ -147,9 +146,9 @@\n â”Š147â”Š146â”Š          // Update the group\n â”Š148â”Š147â”Š\n â”Š149â”Š148â”Š          // Remove the current user from the chat members. He is no longer a member of the group\n-â”Š150â”Š   â”Š          const actualGroupMemberIds = chat.actualGroupMemberIds!.filter(memberId => memberId !== currentUser);\n+â”Š   â”Š149â”Š          const actualGroupMemberIds = chat.actualGroupMemberIds!.filter(memberId => memberId !== currentUser.id);\n â”Š151â”Š150â”Š          // Remove the current user from the chat admins\n-â”Š152â”Š   â”Š          const adminIds = chat.adminIds!.filter(memberId => memberId !== currentUser);\n+â”Š   â”Š151â”Š          const adminIds = chat.adminIds!.filter(memberId => memberId !== currentUser.id);\n â”Š153â”Š152â”Š          // Set the owner id to be null. A null owner means the group is read-only\n â”Š154â”Š153â”Š          let ownerId: number | null = null;\n â”Š155â”Š154â”Š\n```\n```diff\n@@ -169,7 +168,7 @@\n â”Š169â”Š168â”Š        return Number(chatId);\n â”Š170â”Š169â”Š      }\n â”Š171â”Š170â”Š    },\n-â”Š172â”Š   â”Š    addMessage: (obj: any, {chatId, content}: AddMessageMutationArgs): Message => {\n+â”Š   â”Š171â”Š    addMessage: (obj: any, {chatId, content}: AddMessageMutationArgs, {user: currentUser}: {user: User}): Message => {\n â”Š173â”Š172â”Š      if (content === null || content === '') {\n â”Š174â”Š173â”Š        throw new Error(`Cannot add empty or null messages.`);\n â”Š175â”Š174â”Š      }\n```\n```diff\n@@ -184,11 +183,11 @@\n â”Š184â”Š183â”Š\n â”Š185â”Š184â”Š      if (!chat.name) {\n â”Š186â”Š185â”Š        // Chat\n-â”Š187â”Š   â”Š        if (!chat.listingMemberIds.find(listingId => listingId === currentUser)) {\n+â”Š   â”Š186â”Š        if (!chat.listingMemberIds.find(listingId => listingId === currentUser.id)) {\n â”Š188â”Š187â”Š          throw new Error(`The chat ${chatId} must be listed for the current user before adding a message.`);\n â”Š189â”Š188â”Š        }\n â”Š190â”Š189â”Š\n-â”Š191â”Š   â”Š        const recipientId = chat.allTimeMemberIds.filter(userId => userId !== currentUser)[0];\n+â”Š   â”Š190â”Š        const recipientId = chat.allTimeMemberIds.filter(userId => userId !== currentUser.id)[0];\n â”Š192â”Š191â”Š\n â”Š193â”Š192â”Š        if (!chat.listingMemberIds.find(listingId => listingId === recipientId)) {\n â”Š194â”Š193â”Š          // Chat is not listed for the recipient. Add him to the listingMemberIds\n```\n```diff\n@@ -205,7 +204,7 @@\n â”Š205â”Š204â”Š        }\n â”Š206â”Š205â”Š      } else {\n â”Š207â”Š206â”Š        // Group\n-â”Š208â”Š   â”Š        if (!chat.actualGroupMemberIds!.find(memberId => memberId === currentUser)) {\n+â”Š   â”Š207â”Š        if (!chat.actualGroupMemberIds!.find(memberId => memberId === currentUser.id)) {\n â”Š209â”Š208â”Š          throw new Error(`The user is not a member of the group ${chatId}. Cannot add message.`);\n â”Š210â”Š209â”Š        }\n â”Š211â”Š210â”Š\n```\n```diff\n@@ -217,7 +216,7 @@\n â”Š217â”Š216â”Š      let recipients: Recipient[] = [];\n â”Š218â”Š217â”Š\n â”Š219â”Š218â”Š      holderIds.forEach(holderId => {\n-â”Š220â”Š   â”Š        if (holderId !== currentUser) {\n+â”Š   â”Š219â”Š        if (holderId !== currentUser.id) {\n â”Š221â”Š220â”Š          recipients.push({\n â”Š222â”Š221â”Š            userId: holderId,\n â”Š223â”Š222â”Š            messageId: id,\n```\n```diff\n@@ -231,7 +230,7 @@\n â”Š231â”Š230â”Š      const message: Message = {\n â”Š232â”Š231â”Š        id,\n â”Š233â”Š232â”Š        chatId: Number(chatId),\n-â”Š234â”Š   â”Š        senderId: currentUser,\n+â”Š   â”Š233â”Š        senderId: currentUser.id,\n â”Š235â”Š234â”Š        content,\n â”Š236â”Š235â”Š        createdAt: moment().unix(),\n â”Š237â”Š236â”Š        type: MessageType.TEXT,\n```\n```diff\n@@ -248,14 +247,14 @@\n â”Š248â”Š247â”Š\n â”Š249â”Š248â”Š      return message;\n â”Š250â”Š249â”Š    },\n-â”Š251â”Š   â”Š    removeMessages: (obj: any, {chatId, messageIds, all}: RemoveMessagesMutationArgs): number[] => {\n+â”Š   â”Š250â”Š    removeMessages: (obj: any, {chatId, messageIds, all}: RemoveMessagesMutationArgs, {user: currentUser}: {user: User}): number[] => {\n â”Š252â”Š251â”Š      const chat = chats.find(chat => chat.id === Number(chatId));\n â”Š253â”Š252â”Š\n â”Š254â”Š253â”Š      if (!chat) {\n â”Š255â”Š254â”Š        throw new Error(`Cannot find chat ${chatId}.`);\n â”Š256â”Š255â”Š      }\n â”Š257â”Š256â”Š\n-â”Š258â”Š   â”Š      if (!chat.listingMemberIds.find(listingId => listingId === currentUser)) {\n+â”Š   â”Š257â”Š      if (!chat.listingMemberIds.find(listingId => listingId === currentUser.id)) {\n â”Š259â”Š258â”Š        throw new Error(`The chat/group ${chatId} is not listed for the current user, so there is nothing to delete.`);\n â”Š260â”Š259â”Š      }\n â”Š261â”Š260â”Š\n```\n```diff\n@@ -271,7 +270,7 @@\n â”Š271â”Š270â”Š            if (all || messageIds!.includes(String(message.id))) {\n â”Š272â”Š271â”Š              deletedIds.push(message.id);\n â”Š273â”Š272â”Š              // Remove the current user from the message holders\n-â”Š274â”Š   â”Š              message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser);\n+â”Š   â”Š273â”Š              message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser.id);\n â”Š275â”Š274â”Š            }\n â”Š276â”Š275â”Š\n â”Š277â”Š276â”Š            if (message.holderIds.length !== 0) {\n```\n```diff\n@@ -288,24 +287,24 @@\n â”Š288â”Š287â”Š    },\n â”Š289â”Š288â”Š  },\n â”Š290â”Š289â”Š  Chat: {\n-â”Š291â”Š   â”Š    name: (chat: Chat): string => chat.name ? chat.name : users\n-â”Š292â”Š   â”Š      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser))!.name,\n-â”Š293â”Š   â”Š    picture: (chat: Chat) => chat.name ? chat.picture : users\n-â”Š294â”Š   â”Š      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser))!.picture,\n+â”Š   â”Š290â”Š    name: (chat: Chat, args: any, {user: currentUser}: {user: User}): string => chat.name ? chat.name : users\n+â”Š   â”Š291â”Š      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser.id))!.name,\n+â”Š   â”Š292â”Š    picture: (chat: Chat, args: any, {user: currentUser}: {user: User}) => chat.name ? chat.picture : users\n+â”Š   â”Š293â”Š      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser.id))!.picture,\n â”Š295â”Š294â”Š    allTimeMembers: (chat: Chat): User[] => users.filter(user => chat.allTimeMemberIds.includes(user.id)),\n â”Š296â”Š295â”Š    listingMembers: (chat: Chat): User[] => users.filter(user => chat.listingMemberIds.includes(user.id)),\n â”Š297â”Š296â”Š    actualGroupMembers: (chat: Chat): User[] => users.filter(user => chat.actualGroupMemberIds && chat.actualGroupMemberIds.includes(user.id)),\n â”Š298â”Š297â”Š    admins: (chat: Chat): User[] => users.filter(user => chat.adminIds && chat.adminIds.includes(user.id)),\n â”Š299â”Š298â”Š    owner: (chat: Chat): User | null => users.find(user => chat.ownerId === user.id) || null,\n-â”Š300â”Š   â”Š    messages: (chat: Chat, {amount = null}: {amount: number}): Message[] => {\n+â”Š   â”Š299â”Š    messages: (chat: Chat, {amount = null}: {amount: number}, {user: currentUser}: {user: User}): Message[] => {\n â”Š301â”Š300â”Š      const messages = chat.messages\n-â”Š302â”Š   â”Š      .filter(message => message.holderIds.includes(currentUser))\n+â”Š   â”Š301â”Š      .filter(message => message.holderIds.includes(currentUser.id))\n â”Š303â”Š302â”Š      .sort((a, b) => b.createdAt - a.createdAt) || <Message[]>[];\n â”Š304â”Š303â”Š      return (amount ? messages.slice(0, amount) : messages).reverse();\n â”Š305â”Š304â”Š    },\n-â”Š306â”Š   â”Š    unreadMessages: (chat: Chat): number => chat.messages\n-â”Š307â”Š   â”Š      .filter(message => message.holderIds.includes(currentUser) &&\n-â”Š308â”Š   â”Š        message.recipients.find(recipient => recipient.userId === currentUser && !recipient.readAt))\n+â”Š   â”Š305â”Š    unreadMessages: (chat: Chat, args: any, {user: currentUser}: {user: User}): number => chat.messages\n+â”Š   â”Š306â”Š      .filter(message => message.holderIds.includes(currentUser.id) &&\n+â”Š   â”Š307â”Š        message.recipients.find(recipient => recipient.userId === currentUser.id && !recipient.readAt))\n â”Š309â”Š308â”Š      .length,\n â”Š310â”Š309â”Š    isGroup: (chat: Chat): boolean => !!chat.name,\n â”Š311â”Š310â”Š  },\n```\n```diff\n@@ -313,7 +312,7 @@\n â”Š313â”Š312â”Š    chat: (message: Message): Chat | null => chats.find(chat => message.chatId === chat.id) || null,\n â”Š314â”Š313â”Š    sender: (message: Message): User | null => users.find(user => user.id === message.senderId) || null,\n â”Š315â”Š314â”Š    holders: (message: Message): User[] => users.filter(user => message.holderIds.includes(user.id)),\n-â”Š316â”Š   â”Š    ownership: (message: Message): boolean => message.senderId === currentUser,\n+â”Š   â”Š315â”Š    ownership: (message: Message, args: any, {user: currentUser}: {user: User}): boolean => message.senderId === currentUser.id,\n â”Š317â”Š316â”Š  },\n â”Š318â”Š317â”Š  Recipient: {\n â”Š319â”Š318â”Š    user: (recipient: Recipient): User | null => users.find(user => recipient.userId === user.id) || null,\n```\n\n[}]: #\n\nIn the resolvers we're basically making use of the user object taken from the context.\n\n## Client\n\nLet's start installing `@angular/flex-layout`, because we will use it later:\n\n    $ npm install @angular/flex-layout\n\nFirst of all we need to create an HTTP Interceptor, which will intercept every HTTP request and will add authentication headers.\nFor the moment we still don't have those headers, but we are going to store them in the LocalStorage later.\nWe are also creating an AuthGuard, which we will use to stop the user from reaching unauthorized Routes.\nThe AuthGuard will simply look for the presence of the Authentication Header, but will not guarantee that the header is authentic.\nThis is no problem, because client side AuthGuards are not safe by design and the real authentication will be done server side anyway.\nAuthGuards are here just to redirect the user to the Login page.\nThe service we are going to create will contain some auth methods we are going to use across the app.\n\n[{]: <helper> (diffStep \"10.1\" files=\"src/app/login/services\" module=\"client\")\n\n#### Step 10.1: Authentication\n\n##### Added src&#x2F;app&#x2F;login&#x2F;services&#x2F;auth.guard.ts\n```diff\n@@ -0,0 +1,18 @@\n+â”Š  â”Š 1â”Šimport {Injectable} from '@angular/core';\n+â”Š  â”Š 2â”Šimport {CanActivate, Router} from '@angular/router';\n+â”Š  â”Š 3â”Šimport {LoginService} from './login.service';\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Š@Injectable()\n+â”Š  â”Š 6â”Šexport class AuthGuard implements CanActivate {\n+â”Š  â”Š 7â”Š  constructor(private router: Router,\n+â”Š  â”Š 8â”Š              private loginService: LoginService) {}\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Š  canActivate() {\n+â”Š  â”Š11â”Š    if (this.loginService.getAuthHeader()) {\n+â”Š  â”Š12â”Š      return true;\n+â”Š  â”Š13â”Š    } else {\n+â”Š  â”Š14â”Š      this.router.navigate(['/login']);\n+â”Š  â”Š15â”Š      return false;\n+â”Š  â”Š16â”Š    }\n+â”Š  â”Š17â”Š  }\n+â”Š  â”Š18â”Š}\n```\n\n##### Added src&#x2F;app&#x2F;login&#x2F;services&#x2F;auth.interceptor.ts\n```diff\n@@ -0,0 +1,20 @@\n+â”Š  â”Š 1â”Šimport {Injectable} from '@angular/core';\n+â”Š  â”Š 2â”Šimport {HttpEvent, HttpHandler, HttpInterceptor, HttpRequest} from '@angular/common/http';\n+â”Š  â”Š 3â”Šimport {Observable} from 'rxjs/Observable';\n+â”Š  â”Š 4â”Šimport {LoginService} from './login.service';\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Š@Injectable()\n+â”Š  â”Š 7â”Šexport class AuthInterceptor implements HttpInterceptor {\n+â”Š  â”Š 8â”Š  constructor(private loginService: LoginService) {}\n+â”Š  â”Š 9â”Š  intercept(request: HttpRequest<any>, next: HttpHandler): Observable<HttpEvent<any>> {\n+â”Š  â”Š10â”Š    const auth = this.loginService.getAuthHeader();\n+â”Š  â”Š11â”Š    if (auth) {\n+â”Š  â”Š12â”Š      request = request.clone({\n+â”Š  â”Š13â”Š        setHeaders: {\n+â”Š  â”Š14â”Š          Authorization: auth,\n+â”Š  â”Š15â”Š        }\n+â”Š  â”Š16â”Š      });\n+â”Š  â”Š17â”Š    }\n+â”Š  â”Š18â”Š    return next.handle(request);\n+â”Š  â”Š19â”Š  }\n+â”Š  â”Š20â”Š}\n```\n\n##### Added src&#x2F;app&#x2F;login&#x2F;services&#x2F;login.service.ts\n```diff\n@@ -0,0 +1,24 @@\n+â”Š  â”Š 1â”Šimport { Injectable } from '@angular/core';\n+â”Š  â”Š 2â”Šimport {User} from '../../../types';\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Š@Injectable()\n+â”Š  â”Š 5â”Šexport class LoginService {\n+â”Š  â”Š 6â”Š\n+â”Š  â”Š 7â”Š  constructor() { }\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Š  storeAuthHeader(auth: string) {\n+â”Š  â”Š10â”Š    localStorage.setItem('Authorization', auth);\n+â”Š  â”Š11â”Š  }\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Š  getAuthHeader(): string {\n+â”Š  â”Š14â”Š    return localStorage.getItem('Authorization');\n+â”Š  â”Š15â”Š  }\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š  storeUser(user: User) {\n+â”Š  â”Š18â”Š    localStorage.setItem('user', JSON.stringify(user));\n+â”Š  â”Š19â”Š  }\n+â”Š  â”Š20â”Š\n+â”Š  â”Š21â”Š  getUser(): User {\n+â”Š  â”Š22â”Š    return JSON.parse(localStorage.getItem('user'));\n+â”Š  â”Š23â”Š  }\n+â”Š  â”Š24â”Š}\n```\n\n[}]: #\n\nNow it's time to create a SignIn/SignUp component. Since we use Passport in the server we are going to make REST calls for the authentication, instead of using GraphQL.\nSince we use Basic Auth we will simply combine the username and the password together to create the authentication header.\nWe will also store the response from the server, which will contain the user information like the ID, etc. which we are going to need later.\n\n[{]: <helper> (diffStep \"10.1\" files=\"src/app/login/containers, src/app/login/login.module.ts\" module=\"client\")\n\n#### Step 10.1: Authentication\n\n##### Added src&#x2F;app&#x2F;login&#x2F;containers&#x2F;login.component.scss\n```diff\n@@ -0,0 +1,18 @@\n+â”Š  â”Š 1â”Š:host {\n+â”Š  â”Š 2â”Š  display: block;\n+â”Š  â”Š 3â”Š}\n+â”Š  â”Š 4â”Š\n+â”Š  â”Š 5â”Šform:first-of-type {\n+â”Š  â”Š 6â”Š  margin-top: 24px;\n+â”Š  â”Š 7â”Š  margin-bottom: 48px;\n+â”Š  â”Š 8â”Š}\n+â”Š  â”Š 9â”Š\n+â”Š  â”Š10â”Šlabel {\n+â”Š  â”Š11â”Š  display: block;\n+â”Š  â”Š12â”Š  margin-top: 4px;\n+â”Š  â”Š13â”Š  margin-bottom: 4px;\n+â”Š  â”Š14â”Š}\n+â”Š  â”Š15â”Š\n+â”Š  â”Š16â”Š.error {\n+â”Š  â”Š17â”Š  color: red;\n+â”Š  â”Š18â”Š}\n```\n\n##### Added src&#x2F;app&#x2F;login&#x2F;containers&#x2F;login.component.ts\n```diff\n@@ -0,0 +1,133 @@\n+â”Š   â”Š  1â”Šimport {Component} from '@angular/core';\n+â”Š   â”Š  2â”Šimport {HttpClient} from '@angular/common/http';\n+â”Š   â”Š  3â”Šimport {FormBuilder, Validators} from '@angular/forms';\n+â”Š   â”Š  4â”Š// import {matchOtherValidator} from '@moebius/ng-validators';\n+â”Š   â”Š  5â”Šimport {Router} from '@angular/router';\n+â”Š   â”Š  6â”Šimport {User} from '../../../types';\n+â”Š   â”Š  7â”Šimport {LoginService} from '../services/login.service';\n+â”Š   â”Š  8â”Š\n+â”Š   â”Š  9â”Š@Component({\n+â”Š   â”Š 10â”Š  selector: 'app-login',\n+â”Š   â”Š 11â”Š  template: `\n+â”Š   â”Š 12â”Š    <form (ngSubmit)=\"signIn()\" [formGroup]=\"signInForm\" novalidate>\n+â”Š   â”Š 13â”Š      <fieldset fxLayout=\"column\" fxLayoutGap=\"17px\">\n+â”Š   â”Š 14â”Š        <legend>Sign in</legend>\n+â”Š   â”Š 15â”Š        <div>\n+â”Š   â”Š 16â”Š          <label>Username</label>\n+â”Š   â”Š 17â”Š          <input formControlName=\"username\" autocomplete=\"username\" type=\"text\">\n+â”Š   â”Š 18â”Š        </div>\n+â”Š   â”Š 19â”Š        <div class=\"error\" *ngIf=\"signInForm.get('username').hasError('required') && signInForm.get('username').touched\">\n+â”Š   â”Š 20â”Š          Username is required\n+â”Š   â”Š 21â”Š        </div>\n+â”Š   â”Š 22â”Š\n+â”Š   â”Š 23â”Š        <div>\n+â”Š   â”Š 24â”Š          <label>Password</label>\n+â”Š   â”Š 25â”Š          <input formControlName=\"password\" autocomplete=\"current-password\" type=\"password\">\n+â”Š   â”Š 26â”Š        </div>\n+â”Š   â”Š 27â”Š        <div class=\"error\" *ngIf=\"signInForm.get('password').hasError('required') && signInForm.get('password').touched\">\n+â”Š   â”Š 28â”Š          Password is required\n+â”Š   â”Š 29â”Š        </div>\n+â”Š   â”Š 30â”Š\n+â”Š   â”Š 31â”Š        <button type=\"submit\" [disabled]=\"signInForm.invalid\">Sign in</button>\n+â”Š   â”Š 32â”Š      </fieldset>\n+â”Š   â”Š 33â”Š    </form>\n+â”Š   â”Š 34â”Š\n+â”Š   â”Š 35â”Š    <form (ngSubmit)=\"signUp()\" [formGroup]=\"signUpForm\" novalidate>\n+â”Š   â”Š 36â”Š      <fieldset fxLayout=\"column\" fxLayoutGap=\"17px\">\n+â”Š   â”Š 37â”Š        <legend>Sign up</legend>\n+â”Š   â”Š 38â”Š        <div>\n+â”Š   â”Š 39â”Š          <label>Name</label>\n+â”Š   â”Š 40â”Š          <input formControlName=\"name\" type=\"text\">\n+â”Š   â”Š 41â”Š        </div>\n+â”Š   â”Š 42â”Š\n+â”Š   â”Š 43â”Š        <div>\n+â”Š   â”Š 44â”Š          <label>Username</label>\n+â”Š   â”Š 45â”Š          <input formControlName=\"username\" autocomplete=\"username\" type=\"text\">\n+â”Š   â”Š 46â”Š        </div>\n+â”Š   â”Š 47â”Š        <div class=\"error\" *ngIf=\"signUpForm.get('username').hasError('required') && signUpForm.get('username').touched\">\n+â”Š   â”Š 48â”Š          Username is required\n+â”Š   â”Š 49â”Š        </div>\n+â”Š   â”Š 50â”Š\n+â”Š   â”Š 51â”Š        <div>\n+â”Š   â”Š 52â”Š          <label>Password</label>\n+â”Š   â”Š 53â”Š          <input formControlName=\"newPassword\" autocomplete=\"new-password\" type=\"password\">\n+â”Š   â”Š 54â”Š        </div>\n+â”Š   â”Š 55â”Š        <div class=\"error\" *ngIf=\"signUpForm.get('newPassword').hasError('required') && signUpForm.get('newPassword').touched\">\n+â”Š   â”Š 56â”Š          Password is required\n+â”Š   â”Š 57â”Š        </div>\n+â”Š   â”Š 58â”Š\n+â”Š   â”Š 59â”Š        <div>\n+â”Š   â”Š 60â”Š          <label>Password</label>\n+â”Š   â”Š 61â”Š          <input formControlName=\"confirmPassword\" type=\"password\">\n+â”Š   â”Š 62â”Š        </div>\n+â”Š   â”Š 63â”Š        <div class=\"error\" *ngIf=\"signUpForm.get('confirmPassword').hasError('required') && signUpForm.get('confirmPassword').touched\">\n+â”Š   â”Š 64â”Š          Passwords must match\n+â”Š   â”Š 65â”Š        </div>\n+â”Š   â”Š 66â”Š\n+â”Š   â”Š 67â”Š        <button type=\"submit\" [disabled]=\"signUpForm.invalid\">Sign up</button>\n+â”Š   â”Š 68â”Š      </fieldset>\n+â”Š   â”Š 69â”Š    </form>\n+â”Š   â”Š 70â”Š  `,\n+â”Š   â”Š 71â”Š  styleUrls: ['./login.component.scss'],\n+â”Š   â”Š 72â”Š})\n+â”Š   â”Š 73â”Šexport class LoginComponent {\n+â”Š   â”Š 74â”Š  signInForm = this.fb.group({\n+â”Š   â”Š 75â”Š    username: [null, [\n+â”Š   â”Š 76â”Š      Validators.required,\n+â”Š   â”Š 77â”Š    ]],\n+â”Š   â”Š 78â”Š    password: [null, [\n+â”Š   â”Š 79â”Š      Validators.required,\n+â”Š   â”Š 80â”Š    ]],\n+â”Š   â”Š 81â”Š  });\n+â”Š   â”Š 82â”Š\n+â”Š   â”Š 83â”Š  signUpForm = this.fb.group({\n+â”Š   â”Š 84â”Š    name: [null, [\n+â”Š   â”Š 85â”Š      Validators.required,\n+â”Š   â”Š 86â”Š    ]],\n+â”Š   â”Š 87â”Š    username: [null, [\n+â”Š   â”Š 88â”Š      Validators.required,\n+â”Š   â”Š 89â”Š    ]],\n+â”Š   â”Š 90â”Š    newPassword: [null, [\n+â”Š   â”Š 91â”Š      Validators.required,\n+â”Š   â”Š 92â”Š    ]],\n+â”Š   â”Š 93â”Š    confirmPassword: [null, [\n+â”Š   â”Š 94â”Š      Validators.required,\n+â”Š   â”Š 95â”Š      // matchOtherValidator('newPassword'),\n+â”Š   â”Š 96â”Š    ]],\n+â”Š   â”Š 97â”Š  });\n+â”Š   â”Š 98â”Š\n+â”Š   â”Š 99â”Š  constructor(private http: HttpClient,\n+â”Š   â”Š100â”Š              private fb: FormBuilder,\n+â”Š   â”Š101â”Š              private router: Router,\n+â”Š   â”Š102â”Š              private loginService: LoginService) {}\n+â”Š   â”Š103â”Š\n+â”Š   â”Š104â”Š  signIn() {\n+â”Š   â”Š105â”Š    const {username, password} = this.signInForm.value;\n+â”Š   â”Š106â”Š    const auth = `Basic ${btoa(`${username}:${password}`)}`;\n+â”Š   â”Š107â”Š    this.http.post('http://localhost:3000/signin', null, {\n+â”Š   â”Š108â”Š      headers: {\n+â”Š   â”Š109â”Š        Authorization: auth,\n+â”Š   â”Š110â”Š      }\n+â”Š   â”Š111â”Š    }).subscribe((user: User) => {\n+â”Š   â”Š112â”Š      this.loginService.storeAuthHeader(auth);\n+â”Š   â”Š113â”Š      this.loginService.storeUser(user);\n+â”Š   â”Š114â”Š      this.router.navigate(['/chats']);\n+â”Š   â”Š115â”Š    }, err => console.error(err));\n+â”Š   â”Š116â”Š  }\n+â”Š   â”Š117â”Š\n+â”Š   â”Š118â”Š  signUp() {\n+â”Š   â”Š119â”Š    const {username, newPassword: password, name} = this.signInForm.value;\n+â”Š   â”Š120â”Š    const auth = `Basic ${btoa(`${username}:${password}`)}`;\n+â”Š   â”Š121â”Š    this.http.post('http://localhost:3000/signup', {\n+â”Š   â”Š122â”Š      name,\n+â”Š   â”Š123â”Š    }, {\n+â”Š   â”Š124â”Š      headers: {\n+â”Š   â”Š125â”Š        Authorization: auth,\n+â”Š   â”Š126â”Š      }\n+â”Š   â”Š127â”Š    }).subscribe((user: User) => {\n+â”Š   â”Š128â”Š      this.loginService.storeAuthHeader(auth);\n+â”Š   â”Š129â”Š      this.loginService.storeUser(user);\n+â”Š   â”Š130â”Š      this.router.navigate(['/chats']);\n+â”Š   â”Š131â”Š    }, err => console.error(err));\n+â”Š   â”Š132â”Š  }\n+â”Š   â”Š133â”Š}\n```\n\n##### Added src&#x2F;app&#x2F;login&#x2F;login.module.ts\n```diff\n@@ -0,0 +1,52 @@\n+â”Š  â”Š 1â”Šimport {RouterModule, Routes} from '@angular/router';\n+â”Š  â”Š 2â”Šimport {NgModule} from '@angular/core';\n+â”Š  â”Š 3â”Šimport {TruncateModule} from 'ng2-truncate';\n+â”Š  â”Š 4â”Šimport {MatButtonModule, MatIconModule, MatListModule, MatMenuModule} from '@angular/material';\n+â”Š  â”Š 5â”Šimport {SharedModule} from '../shared/shared.module';\n+â”Š  â”Š 6â”Šimport {BrowserModule} from '@angular/platform-browser';\n+â”Š  â”Š 7â”Šimport {FormsModule, ReactiveFormsModule} from '@angular/forms';\n+â”Š  â”Š 8â”Šimport {BrowserAnimationsModule} from '@angular/platform-browser/animations';\n+â”Š  â”Š 9â”Šimport {LoginComponent} from './containers/login.component';\n+â”Š  â”Š10â”Šimport {FlexLayoutModule} from '@angular/flex-layout';\n+â”Š  â”Š11â”Šimport {AuthInterceptor} from './services/auth.interceptor';\n+â”Š  â”Š12â”Šimport {AuthGuard} from './services/auth.guard';\n+â”Š  â”Š13â”Šimport {LoginService} from './services/login.service';\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”Š\n+â”Š  â”Š16â”Šconst routes: Routes = [\n+â”Š  â”Š17â”Š  {path: 'login', component: LoginComponent},\n+â”Š  â”Š18â”Š];\n+â”Š  â”Š19â”Š\n+â”Š  â”Š20â”Š@NgModule({\n+â”Š  â”Š21â”Š  declarations: [\n+â”Š  â”Š22â”Š    LoginComponent,\n+â”Š  â”Š23â”Š  ],\n+â”Š  â”Š24â”Š  imports: [\n+â”Š  â”Š25â”Š    BrowserModule,\n+â”Š  â”Š26â”Š    // Material\n+â”Š  â”Š27â”Š    MatMenuModule,\n+â”Š  â”Š28â”Š    MatIconModule,\n+â”Š  â”Š29â”Š    MatButtonModule,\n+â”Š  â”Š30â”Š    MatListModule,\n+â”Š  â”Š31â”Š    // Animations\n+â”Š  â”Š32â”Š    BrowserAnimationsModule,\n+â”Š  â”Š33â”Š    // Flex layout\n+â”Š  â”Š34â”Š    FlexLayoutModule,\n+â”Š  â”Š35â”Š    // Routing\n+â”Š  â”Š36â”Š    RouterModule.forChild(routes),\n+â”Š  â”Š37â”Š    // Forms\n+â”Š  â”Š38â”Š    FormsModule,\n+â”Š  â”Š39â”Š    ReactiveFormsModule,\n+â”Š  â”Š40â”Š    // Truncate Pipe\n+â”Š  â”Š41â”Š    TruncateModule,\n+â”Š  â”Š42â”Š    // Feature modules\n+â”Š  â”Š43â”Š    SharedModule,\n+â”Š  â”Š44â”Š  ],\n+â”Š  â”Š45â”Š  providers: [\n+â”Š  â”Š46â”Š    LoginService,\n+â”Š  â”Š47â”Š    AuthInterceptor,\n+â”Š  â”Š48â”Š    AuthGuard,\n+â”Š  â”Š49â”Š  ],\n+â”Š  â”Š50â”Š})\n+â”Š  â”Š51â”Šexport class LoginModule {\n+â”Š  â”Š52â”Š}\n```\n\n[}]: #\n\nNow it's time use the Interceptor we just created:\n\n[{]: <helper> (diffStep \"10.1\" files=\"src/app/app.module.ts\" module=\"client\")\n\n#### Step 10.1: Authentication\n\n##### Changed src&#x2F;app&#x2F;app.module.ts\n```diff\n@@ -3,7 +3,7 @@\n â”Š3â”Š3â”Š\n â”Š4â”Š4â”Š\n â”Š5â”Š5â”Šimport { AppComponent } from './app.component';\n-â”Š6â”Š â”Šimport {HttpClientModule} from '@angular/common/http';\n+â”Š â”Š6â”Šimport {HTTP_INTERCEPTORS, HttpClientModule} from '@angular/common/http';\n â”Š7â”Š7â”Šimport {HttpLink, HttpLinkModule, Options} from 'apollo-angular-link-http';\n â”Š8â”Š8â”Šimport {Apollo, ApolloModule} from 'apollo-angular';\n â”Š9â”Š9â”Šimport {defaultDataIdFromObject, InMemoryCache} from 'apollo-cache-inmemory';\n```\n```diff\n@@ -11,6 +11,8 @@\n â”Š11â”Š11â”Šimport {RouterModule, Routes} from '@angular/router';\n â”Š12â”Š12â”Šimport {ChatViewerModule} from './chat-viewer/chat-viewer.module';\n â”Š13â”Š13â”Šimport {ChatsCreationModule} from './chats-creation/chats-creation.module';\n+â”Š  â”Š14â”Šimport {LoginModule} from './login/login.module';\n+â”Š  â”Š15â”Šimport {AuthInterceptor} from './login/services/auth.interceptor';\n â”Š14â”Š16â”Š\n â”Š15â”Š17â”Šconst routes: Routes = [];\n â”Š16â”Š18â”Š\n```\n```diff\n@@ -30,8 +32,15 @@\n â”Š30â”Š32â”Š    ChatsListerModule,\n â”Š31â”Š33â”Š    ChatViewerModule,\n â”Š32â”Š34â”Š    ChatsCreationModule,\n+â”Š  â”Š35â”Š    LoginModule,\n+â”Š  â”Š36â”Š  ],\n+â”Š  â”Š37â”Š  providers: [\n+â”Š  â”Š38â”Š    {\n+â”Š  â”Š39â”Š      provide: HTTP_INTERCEPTORS,\n+â”Š  â”Š40â”Š      useClass: AuthInterceptor,\n+â”Š  â”Š41â”Š      multi: true,\n+â”Š  â”Š42â”Š    }\n â”Š33â”Š43â”Š  ],\n-â”Š34â”Š  â”Š  providers: [],\n â”Š35â”Š44â”Š  bootstrap: [AppComponent]\n â”Š36â”Š45â”Š})\n â”Š37â”Š46â”Šexport class AppModule {\n```\n\n[}]: #\n\nAs well as the AuthGuard:\n\n[{]: <helper> (diffStep \"10.1\" files=\"src/app/chat-viewer/chat-viewer.module.ts, src/app/chats-creation/chats-creation.module.ts, src/app/chats-lister/chats-lister.module.ts\" module=\"client\")\n\n#### Step 10.1: Authentication\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;chat-viewer.module.ts\n```diff\n@@ -12,11 +12,12 @@\n â”Š12â”Š12â”Šimport {NewMessageComponent} from './components/new-message/new-message.component';\n â”Š13â”Š13â”Šimport {SharedModule} from '../shared/shared.module';\n â”Š14â”Š14â”Šimport {SelectableListModule} from 'ngx-selectable-list';\n+â”Š  â”Š15â”Šimport {AuthGuard} from '../login/services/auth.guard';\n â”Š15â”Š16â”Š\n â”Š16â”Š17â”Šconst routes: Routes = [\n â”Š17â”Š18â”Š  {\n â”Š18â”Š19â”Š    path: 'chat', children: [\n-â”Š19â”Š  â”Š      {path: ':id', component: ChatComponent},\n+â”Š  â”Š20â”Š      {path: ':id', canActivate: [AuthGuard], component: ChatComponent},\n â”Š20â”Š21â”Š    ],\n â”Š21â”Š22â”Š  },\n â”Š22â”Š23â”Š];\n```\n\n##### Changed src&#x2F;app&#x2F;chats-creation&#x2F;chats-creation.module.ts\n```diff\n@@ -16,10 +16,11 @@\n â”Š16â”Š16â”Šimport {NewGroupDetailsComponent} from './components/new-group-details/new-group-details.component';\n â”Š17â”Š17â”Šimport {SharedModule} from '../shared/shared.module';\n â”Š18â”Š18â”Šimport {SelectableListModule} from 'ngx-selectable-list';\n+â”Š  â”Š19â”Šimport {AuthGuard} from '../login/services/auth.guard';\n â”Š19â”Š20â”Š\n â”Š20â”Š21â”Šconst routes: Routes = [\n-â”Š21â”Š  â”Š  {path: 'new-chat', component: NewChatComponent},\n-â”Š22â”Š  â”Š  {path: 'new-group', component: NewGroupComponent},\n+â”Š  â”Š22â”Š  {path: 'new-chat', canActivate: [AuthGuard], component: NewChatComponent},\n+â”Š  â”Š23â”Š  {path: 'new-group', canActivate: [AuthGuard], component: NewGroupComponent},\n â”Š23â”Š24â”Š];\n â”Š24â”Š25â”Š\n â”Š25â”Š26â”Š@NgModule({\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;chats-lister.module.ts\n```diff\n@@ -12,10 +12,11 @@\n â”Š12â”Š12â”Šimport {TruncateModule} from 'ng2-truncate';\n â”Š13â”Š13â”Šimport {SharedModule} from '../shared/shared.module';\n â”Š14â”Š14â”Šimport {SelectableListModule} from 'ngx-selectable-list';\n+â”Š  â”Š15â”Šimport {AuthGuard} from '../login/services/auth.guard';\n â”Š15â”Š16â”Š\n â”Š16â”Š17â”Šconst routes: Routes = [\n â”Š17â”Š18â”Š  {path: '', redirectTo: 'chats', pathMatch: 'full'},\n-â”Š18â”Š  â”Š  {path: 'chats', component: ChatsComponent},\n+â”Š  â”Š19â”Š  {path: 'chats', canActivate: [AuthGuard], component: ChatsComponent},\n â”Š19â”Š20â”Š];\n â”Š20â”Š21â”Š\n â”Š21â”Š22â”Š@NgModule({\n```\n\n[}]: #\n\nLast but not the least we need to fix our main service in order to not use the hardcoded user anymore. Instead we will use our Login service to read the user info from the LocalStorage.\n\n[{]: <helper> (diffStep \"10.1\" files=\"src/app/services/chats.service.ts\" module=\"client\")\n\n#### Step 10.1: Authentication\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -18,9 +18,7 @@\n â”Š18â”Š18â”Šimport {AsyncSubject} from 'rxjs/AsyncSubject';\n â”Š19â”Š19â”Šimport {of} from 'rxjs/observable/of';\n â”Š20â”Š20â”Šimport {FetchResult} from 'apollo-link';\n-â”Š21â”Š  â”Š\n-â”Š22â”Š  â”Šconst currentUserId = '1';\n-â”Š23â”Š  â”Šconst currentUserName = 'Ethan Gonzalez';\n+â”Š  â”Š21â”Šimport {LoginService} from '../login/services/login.service';\n â”Š24â”Š22â”Š\n â”Š25â”Š23â”Š@Injectable()\n â”Š26â”Š24â”Šexport class ChatsService {\n```\n```diff\n@@ -31,7 +29,8 @@\n â”Š31â”Š29â”Š  getChatWqSubject: AsyncSubject<QueryRef<GetChat.Query>>;\n â”Š32â”Š30â”Š  addChat$: Observable<FetchResult<AddChat.Mutation | AddGroup.Mutation>>;\n â”Š33â”Š31â”Š\n-â”Š34â”Š  â”Š  constructor(private apollo: Apollo) {\n+â”Š  â”Š32â”Š  constructor(private apollo: Apollo,\n+â”Š  â”Š33â”Š              private loginService: LoginService) {\n â”Š35â”Š34â”Š    this.getChatsWq = this.apollo.watchQuery<GetChats.Query>(<WatchQueryOptions>{\n â”Š36â”Š35â”Š      query: getChatsQuery,\n â”Š37â”Š36â”Š      variables: {\n```\n```diff\n@@ -113,11 +112,11 @@\n â”Š113â”Š112â”Š        addMessage: {\n â”Š114â”Š113â”Š          id: ChatsService.getRandomId(),\n â”Š115â”Š114â”Š          __typename: 'Message',\n-â”Š116â”Š   â”Š          senderId: currentUserId,\n+â”Š   â”Š115â”Š          senderId: this.loginService.getUser().id,\n â”Š117â”Š116â”Š          sender: {\n-â”Š118â”Š   â”Š            id: currentUserId,\n+â”Š   â”Š117â”Š            id: this.loginService.getUser().id,\n â”Š119â”Š118â”Š            __typename: 'User',\n-â”Š120â”Š   â”Š            name: currentUserName,\n+â”Š   â”Š119â”Š            name: this.loginService.getUser().name,\n â”Š121â”Š120â”Š          },\n â”Š122â”Š121â”Š          content,\n â”Š123â”Š122â”Š          createdAt: moment().unix(),\n```\n```diff\n@@ -288,7 +287,7 @@\n â”Š288â”Š287â”Š  // Checks if the chat is listed for the current user and returns the id\n â”Š289â”Š288â”Š  getChatId(recipientId: string) {\n â”Š290â”Š289â”Š    const _chat = this.chats.find(chat => {\n-â”Š291â”Š   â”Š      return !chat.isGroup && !!chat.allTimeMembers.find(user => user.id === currentUserId) &&\n+â”Š   â”Š290â”Š      return !chat.isGroup && !!chat.allTimeMembers.find(user => user.id === this.loginService.getUser().id) &&\n â”Š292â”Š291â”Š        !!chat.allTimeMembers.find(user => user.id === recipientId);\n â”Š293â”Š292â”Š    });\n â”Š294â”Š293â”Š    return _chat ? _chat.id : false;\n```\n```diff\n@@ -309,7 +308,7 @@\n â”Š309â”Š308â”Š          picture: users.find(user => user.id === recipientId).picture,\n â”Š310â”Š309â”Š          allTimeMembers: [\n â”Š311â”Š310â”Š            {\n-â”Š312â”Š   â”Š              id: currentUserId,\n+â”Š   â”Š311â”Š              id: this.loginService.getUser().id,\n â”Š313â”Š312â”Š              __typename: 'User',\n â”Š314â”Š313â”Š            },\n â”Š315â”Š314â”Š            {\n```\n```diff\n@@ -361,10 +360,10 @@\n â”Š361â”Š360â”Š          __typename: 'Chat',\n â”Š362â”Š361â”Š          name: groupName,\n â”Š363â”Š362â”Š          picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n-â”Š364â”Š   â”Š          userIds: [currentUserId, recipientIds],\n+â”Š   â”Š363â”Š          userIds: [this.loginService.getUser().id, recipientIds],\n â”Š365â”Š364â”Š          allTimeMembers: [\n â”Š366â”Š365â”Š            {\n-â”Š367â”Š   â”Š              id: currentUserId,\n+â”Š   â”Š366â”Š              id: this.loginService.getUser().id,\n â”Š368â”Š367â”Š              __typename: 'User',\n â”Š369â”Š368â”Š            },\n â”Š370â”Š369â”Š            ...recipientIds.map(id => ({id, __typename: 'User'})),\n```\n\n[}]: #\n\nWe also need to fix our tests:\n\n[{]: <helper> (diffStep \"10.1\" files=\"src/app/chat-viewer/containers/chat/chat.component.spec.ts, src/app/chats-lister/containers/chats/chats.component.spec.ts, src/app/services/chats.service.spec.ts\" module=\"client\")\n\n#### Step 10.1: Authentication\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.spec.ts\n```diff\n@@ -18,6 +18,7 @@\n â”Š18â”Š18â”Šimport {MessagesListComponent} from '../../components/messages-list/messages-list.component';\n â”Š19â”Š19â”Šimport {MessageItemComponent} from '../../components/message-item/message-item.component';\n â”Š20â”Š20â”Šimport {SelectableListModule} from 'ngx-selectable-list';\n+â”Š  â”Š21â”Šimport {LoginService} from '../../../login/services/login.service';\n â”Š21â”Š22â”Š\n â”Š22â”Š23â”Šdescribe('ChatComponent', () => {\n â”Š23â”Š24â”Š  let component: ChatComponent;\n```\n```diff\n@@ -120,7 +121,8 @@\n â”Š120â”Š121â”Š            params: of({ id: chat.id }),\n â”Š121â”Š122â”Š            queryParams: of({}),\n â”Š122â”Š123â”Š          }\n-â”Š123â”Š   â”Š        }\n+â”Š   â”Š124â”Š        },\n+â”Š   â”Š125â”Š        LoginService,\n â”Š124â”Š126â”Š      ],\n â”Š125â”Š127â”Š      schemas: [NO_ERRORS_SCHEMA]\n â”Š126â”Š128â”Š    })\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.spec.ts\n```diff\n@@ -14,6 +14,7 @@\n â”Š14â”Š14â”Šimport {By} from '@angular/platform-browser';\n â”Š15â”Š15â”Šimport {RouterTestingModule} from '@angular/router/testing';\n â”Š16â”Š16â”Šimport {SelectableListModule} from 'ngx-selectable-list';\n+â”Š  â”Š17â”Šimport {LoginService} from '../../../login/services/login.service';\n â”Š17â”Š18â”Š\n â”Š18â”Š19â”Šdescribe('ChatsComponent', () => {\n â”Š19â”Š20â”Š  let component: ChatsComponent;\n```\n```diff\n@@ -336,6 +337,7 @@\n â”Š336â”Š337â”Š      providers: [\n â”Š337â”Š338â”Š        ChatsService,\n â”Š338â”Š339â”Š        Apollo,\n+â”Š   â”Š340â”Š        LoginService,\n â”Š339â”Š341â”Š      ],\n â”Š340â”Š342â”Š      schemas: [NO_ERRORS_SCHEMA]\n â”Š341â”Š343â”Š    })\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.spec.ts\n```diff\n@@ -5,6 +5,7 @@\n â”Š 5â”Š 5â”Šimport {HttpLink, HttpLinkModule, Options} from 'apollo-angular-link-http';\n â”Š 6â”Š 6â”Šimport {HttpClientTestingModule, HttpTestingController} from '@angular/common/http/testing';\n â”Š 7â”Š 7â”Šimport {defaultDataIdFromObject, InMemoryCache} from 'apollo-cache-inmemory';\n+â”Š  â”Š 8â”Šimport {LoginService} from '../login/services/login.service';\n â”Š 8â”Š 9â”Š\n â”Š 9â”Š10â”Šdescribe('ChatsService', () => {\n â”Š10â”Š11â”Š  let httpMock: HttpTestingController;\n```\n```diff\n@@ -312,6 +313,7 @@\n â”Š312â”Š313â”Š      providers: [\n â”Š313â”Š314â”Š        ChatsService,\n â”Š314â”Š315â”Š        Apollo,\n+â”Š   â”Š316â”Š        LoginService,\n â”Š315â”Š317â”Š      ]\n â”Š316â”Š318â”Š    });\n â”Š317â”Š319â”Š\n```\n\n[}]: #"
          },
          {
            "manualTitle": "Step 15: Subscriptions",
            "stepRevision": "c5a160d3632c16983c729016b143a44d9daf45c9",
            "manualView": "## Server\n\nIn order to use WebSockets we will need to install a couple of packages:\n\n    npm install graphql-subscriptions subscriptions-transport-ws\n\nOur GraphQL server will use WebSockets only for subscriptions, while using HTTP for everything else. That means that we will have to add subscriptions on a specific path.\nWe're using `connectionParams` for the authentication over WebSockets, that means that we won't be using the `Passport` framework at all. Instead we will use the `onConnect` hook to manually validate the parameters provided by the user to either validate the WebSocket connection or throw an error.\nWe will also return the user object we retrieved from the db, to let the resolvers know who is the current user.\n\n[{]: <helper> (diffStep \"5.1\" files=\"index.ts\" module=\"server\")\n\n#### Step 5.1: Subscriptions\n\n##### Changed index.ts\n```diff\n@@ -7,6 +7,9 @@\n â”Š 7â”Š 7â”Šimport * as basicStrategy from 'passport-http';\n â”Š 8â”Š 8â”Šimport * as bcrypt from 'bcrypt-nodejs';\n â”Š 9â”Š 9â”Šimport { db, User } from \"./db\";\n+â”Š  â”Š10â”Šimport { createServer } from \"http\";\n+â”Š  â”Š11â”Šimport { SubscriptionServer } from \"subscriptions-transport-ws\";\n+â”Š  â”Š12â”Šimport { execute, subscribe } from \"graphql\";\n â”Š10â”Š13â”Š\n â”Š11â”Š14â”Šlet users = db.users;\n â”Š12â”Š15â”Š\n```\n```diff\n@@ -76,4 +79,36 @@\n â”Š 76â”Š 79â”Š  endpointURL: '/graphql',\n â”Š 77â”Š 80â”Š}));\n â”Š 78â”Š 81â”Š\n-â”Š 79â”Š   â”Šapp.listen(PORT);\n+â”Š   â”Š 82â”Š// Wrap the Express server\n+â”Š   â”Š 83â”Šconst ws = createServer(app);\n+â”Š   â”Š 84â”Šws.listen(PORT, () => {\n+â”Š   â”Š 85â”Š  console.log(`Apollo Server is now running on http://localhost:${PORT}`);\n+â”Š   â”Š 86â”Š  // Set up the WebSocket for handling GraphQL subscriptions\n+â”Š   â”Š 87â”Š  new SubscriptionServer({\n+â”Š   â”Š 88â”Š    onConnect: (connectionParams: any, webSocket: any) => {\n+â”Š   â”Š 89â”Š      if (connectionParams.authToken) {\n+â”Š   â”Š 90â”Š        // create a buffer and tell it the data coming in is base64\n+â”Š   â”Š 91â”Š        const buf = new Buffer(connectionParams.authToken.split(' ')[1], 'base64');\n+â”Š   â”Š 92â”Š        // read it back out as a string\n+â”Š   â”Š 93â”Š        const [username, password]: string[] = buf.toString().split(':');\n+â”Š   â”Š 94â”Š        if (username && password) {\n+â”Š   â”Š 95â”Š          const user = users.find(user => user.username == username);\n+â”Š   â”Š 96â”Š\n+â”Š   â”Š 97â”Š          if (user && validPassword(password, user.password)) {\n+â”Š   â”Š 98â”Š            // Set context for the WebSocket\n+â”Š   â”Š 99â”Š            return {user};\n+â”Š   â”Š100â”Š          } else {\n+â”Š   â”Š101â”Š            throw new Error('Wrong credentials!');\n+â”Š   â”Š102â”Š          }\n+â”Š   â”Š103â”Š        }\n+â”Š   â”Š104â”Š      }\n+â”Š   â”Š105â”Š      throw new Error('Missing auth token!');\n+â”Š   â”Š106â”Š    },\n+â”Š   â”Š107â”Š    execute,\n+â”Š   â”Š108â”Š    subscribe,\n+â”Š   â”Š109â”Š    schema\n+â”Š   â”Š110â”Š  }, {\n+â”Š   â”Š111â”Š    server: ws,\n+â”Š   â”Š112â”Š    path: '/subscriptions',\n+â”Š   â”Š113â”Š  });\n+â”Š   â”Š114â”Š});\n```\n\n[}]: #\n\nWe will use the `PubSub` implementation from `graphql-subscriptions`, and we will connect it to `subscribe` executor of `graphql`, and publish the data using `subscriptions-transport-ws` (a WebSocket server and client library for GraphQL that can be used directly in a JavaScript app or wired up to a fully-featured GraphQL client like Apollo).\n\nThe process of setting up a GraphQL subscriptions server consist of the following steps:\n\n1. Declaring subscriptions in the GraphQL schema\n2. Setup a PubSub instance that our server will publish new events to\n3. Hook together `PubSub` event and GraphQL subscription.\n4. Setting up `SubscriptionsServer`, a transport between the server and the clients\n\n[{]: <helper> (diffStep \"5.1\" files=\"schema/typeDefs.ts\" module=\"server\")\n\n#### Step 5.1: Subscriptions\n\n##### Changed schema&#x2F;typeDefs.ts\n```diff\n@@ -7,6 +7,11 @@\n â”Š 7â”Š 7â”Š    chat(chatId: ID!): Chat\n â”Š 8â”Š 8â”Š  }\n â”Š 9â”Š 9â”Š\n+â”Š  â”Š10â”Š  type Subscription {\n+â”Š  â”Š11â”Š    messageAdded(chatId: ID): Message\n+â”Š  â”Š12â”Š    chatAdded: Chat\n+â”Š  â”Š13â”Š  }\n+â”Š  â”Š14â”Š\n â”Š10â”Š15â”Š  enum MessageType {\n â”Š11â”Š16â”Š    LOCATION\n â”Š12â”Š17â”Š    TEXT\n```\n\n[}]: #\n\nWe created two subscriptions: one to notify for new chats and one to notify for new messages.\n\n[{]: <helper> (diffStep \"5.1\" files=\"schema/resolvers.ts\" module=\"server\")\n\n#### Step 5.1: Subscriptions\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,14 +1,17 @@\n â”Š 1â”Š 1â”Šimport { Chat, db, Message, MessageType, Recipient, User } from \"../db\";\n â”Š 2â”Š 2â”Šimport { IResolvers } from \"graphql-tools/dist/Interfaces\";\n â”Š 3â”Š 3â”Šimport {\n-â”Š 4â”Š  â”Š  AddChatMutationArgs, AddGroupMutationArgs, AddMessageMutationArgs, ChatQueryArgs,\n+â”Š  â”Š 4â”Š  AddChatMutationArgs, AddGroupMutationArgs, AddMessageMutationArgs, ChatQueryArgs, MessageAddedSubscriptionArgs,\n â”Š 5â”Š 5â”Š  RemoveChatMutationArgs, RemoveMessagesMutationArgs\n â”Š 6â”Š 6â”Š} from \"../types\";\n â”Š 7â”Š 7â”Šimport * as moment from \"moment\";\n+â”Š  â”Š 8â”Šimport { PubSub, withFilter } from \"graphql-subscriptions\";\n â”Š 8â”Š 9â”Š\n â”Š 9â”Š10â”Šlet users = db.users;\n â”Š10â”Š11â”Šlet chats = db.chats;\n â”Š11â”Š12â”Š\n+â”Š  â”Š13â”Šexport const pubsub = new PubSub();\n+â”Š  â”Š14â”Š\n â”Š12â”Š15â”Šexport const resolvers: IResolvers = {\n â”Š13â”Š16â”Š  Query: {\n â”Š14â”Š17â”Š    // Show all users for the moment.\n```\n```diff\n@@ -50,6 +53,7 @@\n â”Š50â”Š53â”Š          messages: [],\n â”Š51â”Š54â”Š        };\n â”Š52â”Š55â”Š        chats.push(chat);\n+â”Š  â”Š56â”Š\n â”Š53â”Š57â”Š        return chat;\n â”Š54â”Š58â”Š      }\n â”Š55â”Š59â”Š    },\n```\n```diff\n@@ -73,6 +77,12 @@\n â”Š73â”Š77â”Š        messages: [],\n â”Š74â”Š78â”Š      };\n â”Š75â”Š79â”Š      chats.push(chat);\n+â”Š  â”Š80â”Š\n+â”Š  â”Š81â”Š      pubsub.publish('chatAdded', {\n+â”Š  â”Š82â”Š        creatorId: currentUser.id,\n+â”Š  â”Š83â”Š        chatAdded: chat,\n+â”Š  â”Š84â”Š      });\n+â”Š  â”Š85â”Š\n â”Š76â”Š86â”Š      return chat;\n â”Š77â”Š87â”Š    },\n â”Š78â”Š88â”Š    removeChat: (obj: any, {chatId}: RemoveChatMutationArgs, {user: currentUser}: {user: User}): number => {\n```\n```diff\n@@ -201,6 +211,11 @@\n â”Š201â”Š211â”Š          });\n â”Š202â”Š212â”Š\n â”Š203â”Š213â”Š          holderIds = listingMemberIds;\n+â”Š   â”Š214â”Š\n+â”Š   â”Š215â”Š          pubsub.publish('chatAdded', {\n+â”Š   â”Š216â”Š            creatorId: currentUser.id,\n+â”Š   â”Š217â”Š            chatAdded: chat,\n+â”Š   â”Š218â”Š          });\n â”Š204â”Š219â”Š        }\n â”Š205â”Š220â”Š      } else {\n â”Š206â”Š221â”Š        // Group\n```\n```diff\n@@ -245,6 +260,10 @@\n â”Š245â”Š260â”Š        return chat;\n â”Š246â”Š261â”Š      });\n â”Š247â”Š262â”Š\n+â”Š   â”Š263â”Š      pubsub.publish('messageAdded', {\n+â”Š   â”Š264â”Š        messageAdded: message,\n+â”Š   â”Š265â”Š      });\n+â”Š   â”Š266â”Š\n â”Š248â”Š267â”Š      return message;\n â”Š249â”Š268â”Š    },\n â”Š250â”Š269â”Š    removeMessages: (obj: any, {chatId, messageIds, all}: RemoveMessagesMutationArgs, {user: currentUser}: {user: User}): number[] => {\n```\n```diff\n@@ -286,6 +305,21 @@\n â”Š286â”Š305â”Š      return deletedIds;\n â”Š287â”Š306â”Š    },\n â”Š288â”Š307â”Š  },\n+â”Š   â”Š308â”Š  Subscription: {\n+â”Š   â”Š309â”Š    messageAdded: {\n+â”Š   â”Š310â”Š      subscribe: withFilter(() => pubsub.asyncIterator('messageAdded'),\n+â”Š   â”Š311â”Š        ({messageAdded}: {messageAdded: Message & {chat: {id: number}}}, {chatId}: MessageAddedSubscriptionArgs, {user: currentUser}: { user: User }) => {\n+â”Š   â”Š312â”Š          return (!chatId || messageAdded.chat.id === Number(chatId)) &&\n+â”Š   â”Š313â”Š            !!messageAdded.recipients.find((recipient: Recipient) => recipient.userId === currentUser.id);\n+â”Š   â”Š314â”Š        }),\n+â”Š   â”Š315â”Š    },\n+â”Š   â”Š316â”Š    chatAdded: {\n+â”Š   â”Š317â”Š      subscribe: withFilter(() => pubsub.asyncIterator('chatAdded'),\n+â”Š   â”Š318â”Š        ({creatorId, chatAdded}: {creatorId: string, chatAdded: Chat}, variables: any, {user: currentUser}: { user: User }) => {\n+â”Š   â”Š319â”Š          return Number(creatorId) !== currentUser.id && !chatAdded.listingMemberIds.includes(currentUser.id);\n+â”Š   â”Š320â”Š        }),\n+â”Š   â”Š321â”Š    }\n+â”Š   â”Š322â”Š  },\n â”Š289â”Š323â”Š  Chat: {\n â”Š290â”Š324â”Š    name: (chat: Chat, args: any, {user: currentUser}: {user: User}): string => chat.name ? chat.name : users\n â”Š291â”Š325â”Š      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser.id))!.name,\n```\n\n[}]: #\n\nWe will publish a message to the `messageAdded` subscription every time that a user sends a message, then we will filter them according to the current user (we don't want to send someone else's messages).\nThe `chatAdded` subscription is similar: we will publish each time that a group gets created, but not when chats get created. This is because when a user creates a chat the chat doesn't appear to the other peer until he writes the first message. That's why we also publish when new messages get added (we first look if the other peer already gets the chat listed).\n\n## Client\n\nIn order to use WebSockets we will need to install a couple of dependencies:\n\n    $ npm install apollo-link-ws apollo-utilities subscriptions-transport-ws\n\nFirst let's create the queries for the GraphQL Subscriptions:\n\n[{]: <helper> (diffStep \"11.1\" files=\"src/graphql\" module=\"client\")\n\n#### Step 11.1: Subscriptions\n\n##### Added src&#x2F;graphql&#x2F;chatAdded.subscription.ts\n```diff\n@@ -0,0 +1,17 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag';\n+â”Š  â”Š 2â”Šimport {fragments} from './fragment';\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Š// We use the gql tag to parse our query string into a query document\n+â”Š  â”Š 5â”Šexport const chatAddedSubscription = gql`\n+â”Š  â”Š 6â”Š  subscription chatAdded {\n+â”Š  â”Š 7â”Š    chatAdded {\n+â”Š  â”Š 8â”Š      ...ChatWithoutMessages\n+â”Š  â”Š 9â”Š      messages {\n+â”Š  â”Š10â”Š        ...Message\n+â”Š  â”Š11â”Š      }\n+â”Š  â”Š12â”Š    }\n+â”Š  â”Š13â”Š  }\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”Š  ${fragments['chatWithoutMessages']}\n+â”Š  â”Š16â”Š  ${fragments['message']}\n+â”Š  â”Š17â”Š`;\n```\n\n##### Added src&#x2F;graphql&#x2F;messageAdded.subscription.ts\n```diff\n@@ -0,0 +1,16 @@\n+â”Š  â”Š 1â”Šimport gql from 'graphql-tag';\n+â”Š  â”Š 2â”Šimport {fragments} from './fragment';\n+â”Š  â”Š 3â”Š\n+â”Š  â”Š 4â”Š// We use the gql tag to parse our query string into a query document\n+â”Š  â”Š 5â”Šexport const messageAddedSubscription = gql`\n+â”Š  â”Š 6â”Š  subscription messageAdded($chatId: ID) {\n+â”Š  â”Š 7â”Š    messageAdded(chatId: $chatId) {\n+â”Š  â”Š 8â”Š      ...Message\n+â”Š  â”Š 9â”Š      chat {\n+â”Š  â”Š10â”Š        id,\n+â”Š  â”Š11â”Š      },\n+â”Š  â”Š12â”Š    }\n+â”Š  â”Š13â”Š  }\n+â”Š  â”Š14â”Š\n+â”Š  â”Š15â”Š  ${fragments['message']}\n+â”Š  â”Š16â”Š`;\n```\n\n[}]: #\n\nThen we need to run `graphql-code-generator` to generate the types:\n\n    $ npm run generator\n\nNow we can update the chats service to update the getChats query every time that we receive a new chat from the subscription.\nWith GraphQL subscriptions your client will be alerted on push from the server and you should choose the pattern that fits your application the most:\n\n- Use it as a notification and run any logic you want when it fires, for example alerting the user or refetching data\n- Use the data sent along with the notification and merge it directly into the store (existing queries are automatically notified)\n\nWith subscribeToMore, you can easily do the latter. We will manipulate the store to add the newly created chat.\n\nWe will do to do the same for the newMessage subscription, but this time we will have to update two different queries in the store: getChats and getChat.\n\n[{]: <helper> (diffStep \"11.1\" files=\"src/app/services/chats.service.ts\" module=\"client\")\n\n#### Step 11.1: Subscriptions\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.ts\n```diff\n@@ -3,7 +3,10 @@\n â”Š 3â”Š 3â”Šimport {Apollo, QueryRef} from 'apollo-angular';\n â”Š 4â”Š 4â”Šimport {Injectable} from '@angular/core';\n â”Š 5â”Š 5â”Šimport {getChatsQuery} from '../../graphql/getChats.query';\n-â”Š 6â”Š  â”Šimport {AddChat, AddGroup, AddMessage, GetChat, GetChats, GetUsers, RemoveAllMessages, RemoveChat, RemoveMessages} from '../../types';\n+â”Š  â”Š 6â”Šimport {\n+â”Š  â”Š 7â”Š  AddChat, AddGroup, AddMessage, GetChat, GetChats, GetUsers, MessageAdded, RemoveAllMessages, RemoveChat,\n+â”Š  â”Š 8â”Š  RemoveMessages\n+â”Š  â”Š 9â”Š} from '../../types';\n â”Š 7â”Š10â”Šimport {getChatQuery} from '../../graphql/getChat.query';\n â”Š 8â”Š11â”Šimport {addMessageMutation} from '../../graphql/addMessage.mutation';\n â”Š 9â”Š12â”Šimport {removeChatMutation} from '../../graphql/removeChat.mutation';\n```\n```diff\n@@ -19,6 +22,8 @@\n â”Š19â”Š22â”Šimport {of} from 'rxjs/observable/of';\n â”Š20â”Š23â”Šimport {FetchResult} from 'apollo-link';\n â”Š21â”Š24â”Šimport {LoginService} from '../login/services/login.service';\n+â”Š  â”Š25â”Šimport {chatAddedSubscription} from '../../graphql/chatAdded.subscription';\n+â”Š  â”Š26â”Šimport {messageAddedSubscription} from '../../graphql/messageAdded.subscription';\n â”Š22â”Š27â”Š\n â”Š23â”Š28â”Š@Injectable()\n â”Š24â”Š29â”Šexport class ChatsService {\n```\n```diff\n@@ -37,6 +42,55 @@\n â”Š37â”Š42â”Š        amount: this.messagesAmount,\n â”Š38â”Š43â”Š      },\n â”Š39â”Š44â”Š    });\n+â”Š  â”Š45â”Š\n+â”Š  â”Š46â”Š    this.getChatsWq.subscribeToMore({\n+â”Š  â”Š47â”Š      document: chatAddedSubscription,\n+â”Š  â”Š48â”Š      updateQuery: (prev: GetChats.Query, { subscriptionData }) => {\n+â”Š  â”Š49â”Š        if (!subscriptionData.data) {\n+â”Š  â”Š50â”Š          return prev;\n+â”Š  â”Š51â”Š        }\n+â”Š  â”Š52â”Š\n+â”Š  â”Š53â”Š        const newChat: GetChats.Chats = subscriptionData.data.chatAdded;\n+â”Š  â”Š54â”Š\n+â”Š  â”Š55â”Š        return Object.assign({}, prev, {\n+â”Š  â”Š56â”Š          chats: [...prev.chats, newChat]\n+â”Š  â”Š57â”Š        });\n+â”Š  â”Š58â”Š      }\n+â”Š  â”Š59â”Š    });\n+â”Š  â”Š60â”Š\n+â”Š  â”Š61â”Š    this.getChatsWq.subscribeToMore({\n+â”Š  â”Š62â”Š      document: messageAddedSubscription,\n+â”Š  â”Š63â”Š      updateQuery: (prev: GetChats.Query, { subscriptionData }) => {\n+â”Š  â”Š64â”Š        if (!subscriptionData.data) {\n+â”Š  â”Š65â”Š          return prev;\n+â”Š  â”Š66â”Š        }\n+â”Š  â”Š67â”Š\n+â”Š  â”Š68â”Š        const newMessage: MessageAdded.MessageAdded = subscriptionData.data.messageAdded;\n+â”Š  â”Š69â”Š\n+â”Š  â”Š70â”Š        // We need to update the cache for both Chat and Chats. The following updates the cache for Chat.\n+â”Š  â”Š71â”Š        try {\n+â”Š  â”Š72â”Š          // Read the data from our cache for this query.\n+â”Š  â”Š73â”Š          const {chat}: GetChat.Query = this.apollo.getClient().readQuery({\n+â”Š  â”Š74â”Š            query: getChatQuery, variables: {\n+â”Š  â”Š75â”Š              chatId: newMessage.chat.id,\n+â”Š  â”Š76â”Š            }\n+â”Š  â”Š77â”Š          });\n+â”Š  â”Š78â”Š\n+â”Š  â”Š79â”Š          // Add our message from the mutation to the end.\n+â”Š  â”Š80â”Š          chat.messages.push(newMessage);\n+â”Š  â”Š81â”Š          // Write our data back to the cache.\n+â”Š  â”Š82â”Š          this.apollo.getClient().writeQuery({ query: getChatQuery, data: {chat} });\n+â”Š  â”Š83â”Š        } catch {\n+â”Š  â”Š84â”Š          console.error('The chat we received an update for does not exist in the store');\n+â”Š  â”Š85â”Š        }\n+â”Š  â”Š86â”Š\n+â”Š  â”Š87â”Š        return Object.assign({}, prev, {\n+â”Š  â”Š88â”Š          chats: [...prev.chats.map(_chat =>\n+â”Š  â”Š89â”Š            _chat.id === newMessage.chat.id ? {..._chat, messages: [..._chat.messages, newMessage]} : _chat)]\n+â”Š  â”Š90â”Š        });\n+â”Š  â”Š91â”Š      }\n+â”Š  â”Š92â”Š    });\n+â”Š  â”Š93â”Š\n â”Š40â”Š94â”Š    this.chats$ = this.getChatsWq.valueChanges.pipe(\n â”Š41â”Š95â”Š      map((result: ApolloQueryResult<GetChats.Query>) => result.data.chats)\n â”Š42â”Š96â”Š    );\n```\n\n[}]: #\n\nWe can finally configure the WebSocket in the app module. Please notice that the WebSocket has its own authentication instead of using the HttpInterceptor, in fact we use `connectionParams` to send the authorization.\nAll queries will go through HTTP except the Subscriptions, which will use the WebSocket.\n\n[{]: <helper> (diffStep \"11.1\" files=\"src/app/app.module.ts\" module=\"client\")\n\n#### Step 11.1: Subscriptions\n\n##### Changed src&#x2F;app&#x2F;app.module.ts\n```diff\n@@ -13,6 +13,11 @@\n â”Š13â”Š13â”Šimport {ChatsCreationModule} from './chats-creation/chats-creation.module';\n â”Š14â”Š14â”Šimport {LoginModule} from './login/login.module';\n â”Š15â”Š15â”Šimport {AuthInterceptor} from './login/services/auth.interceptor';\n+â”Š  â”Š16â”Šimport {getMainDefinition} from 'apollo-utilities';\n+â”Š  â”Š17â”Šimport {OperationDefinitionNode} from 'graphql';\n+â”Š  â”Š18â”Šimport {split} from 'apollo-link';\n+â”Š  â”Š19â”Šimport {WebSocketLink} from 'apollo-link-ws';\n+â”Š  â”Š20â”Šimport {LoginService} from './login/services/login.service';\n â”Š16â”Š21â”Š\n â”Š17â”Š22â”Šconst routes: Routes = [];\n â”Š18â”Š23â”Š\n```\n```diff\n@@ -47,9 +52,30 @@\n â”Š47â”Š52â”Š  constructor(\n â”Š48â”Š53â”Š    apollo: Apollo,\n â”Š49â”Š54â”Š    httpLink: HttpLink,\n+â”Š  â”Š55â”Š    loginService: LoginService,\n â”Š50â”Š56â”Š  ) {\n+â”Š  â”Š57â”Š    const subscriptionLink = new WebSocketLink({\n+â”Š  â”Š58â”Š      uri:\n+â”Š  â”Š59â”Š        'ws://localhost:3000/subscriptions',\n+â”Š  â”Š60â”Š      options: {\n+â”Š  â”Š61â”Š        reconnect: true,\n+â”Š  â”Š62â”Š        connectionParams: () => ({\n+â”Š  â”Š63â”Š          authToken: loginService.getAuthHeader() || null\n+â”Š  â”Š64â”Š        })\n+â”Š  â”Š65â”Š      }\n+â”Š  â”Š66â”Š    });\n+â”Š  â”Š67â”Š\n+â”Š  â”Š68â”Š    const link = split(\n+â”Š  â”Š69â”Š      ({ query }) => {\n+â”Š  â”Š70â”Š        const { kind, operation } = <OperationDefinitionNode>getMainDefinition(query);\n+â”Š  â”Š71â”Š        return kind === 'OperationDefinition' && operation === 'subscription';\n+â”Š  â”Š72â”Š      },\n+â”Š  â”Š73â”Š      subscriptionLink,\n+â”Š  â”Š74â”Š      httpLink.create(<Options>{uri: 'http://localhost:3000/graphql'})\n+â”Š  â”Š75â”Š    );\n+â”Š  â”Š76â”Š\n â”Š51â”Š77â”Š    apollo.create({\n-â”Š52â”Š  â”Š      link: httpLink.create(<Options>{uri: 'http://localhost:3000/graphql'}),\n+â”Š  â”Š78â”Š      link,\n â”Š53â”Š79â”Š      cache: new InMemoryCache({\n â”Š54â”Š80â”Š        dataIdFromObject: (object: any) => {\n â”Š55â”Š81â”Š          switch (object.__typename) {\n```\n\n[}]: #\n\nFinally, let's fix the tests:\n\n[{]: <helper> (diffStep \"11.1\" files=\"src/app/chat-viewer/containers/chat/chat.component.spec.ts, src/app/chats-lister/containers/chats/chats.component.spec.ts, src/app/services/chats.service.spec.ts\" module=\"client\")\n\n#### Step 11.1: Subscriptions\n\n##### Changed src&#x2F;app&#x2F;chat-viewer&#x2F;containers&#x2F;chat&#x2F;chat.component.spec.ts\n```diff\n@@ -149,6 +149,8 @@\n â”Š149â”Š149â”Š    fixture = TestBed.createComponent(ChatComponent);\n â”Š150â”Š150â”Š    component = fixture.componentInstance;\n â”Š151â”Š151â”Š    fixture.detectChanges();\n+â”Š   â”Š152â”Š    httpMock.expectOne(httpReq => httpReq.body.operationName === 'chatAdded', 'call to chatAdded api');\n+â”Š   â”Š153â”Š    httpMock.expectOne(httpReq => httpReq.body.operationName === 'messageAdded', 'call to messageAdded api');\n â”Š152â”Š154â”Š    httpMock.expectOne(httpReq => httpReq.body.operationName === 'GetChats', 'call to getChats api');\n â”Š153â”Š155â”Š    const req = httpMock.expectOne(httpReq => httpReq.body.operationName === 'GetChat', 'call to getChat api');\n â”Š154â”Š156â”Š    req.flush({\n```\n\n##### Changed src&#x2F;app&#x2F;chats-lister&#x2F;containers&#x2F;chats&#x2F;chats.component.spec.ts\n```diff\n@@ -364,7 +364,9 @@\n â”Š364â”Š364â”Š    fixture = TestBed.createComponent(ChatsComponent);\n â”Š365â”Š365â”Š    component = fixture.componentInstance;\n â”Š366â”Š366â”Š    fixture.detectChanges();\n-â”Š367â”Š   â”Š    const req = httpMock.expectOne('http://localhost:3000/graphql', 'call to api');\n+â”Š   â”Š367â”Š    httpMock.expectOne(httpReq => httpReq.body.operationName === 'chatAdded', 'call to chatAdded api');\n+â”Š   â”Š368â”Š    httpMock.expectOne(httpReq => httpReq.body.operationName === 'messageAdded', 'call to messageAdded api');\n+â”Š   â”Š369â”Š    const req = httpMock.expectOne(httpReq => httpReq.body.operationName === 'GetChats', 'call to getChats api');\n â”Š368â”Š370â”Š    req.flush({\n â”Š369â”Š371â”Š      data: {\n â”Š370â”Š372â”Š        chats\n```\n\n##### Changed src&#x2F;app&#x2F;services&#x2F;chats.service.spec.ts\n```diff\n@@ -346,7 +346,9 @@\n â”Š346â”Š346â”Š      }\n â”Š347â”Š347â”Š    });\n â”Š348â”Š348â”Š\n-â”Š349â”Š   â”Š    const req = httpMock.expectOne('http://localhost:3000/graphql', 'call to api');\n+â”Š   â”Š349â”Š    httpMock.expectOne(httpReq => httpReq.body.operationName === 'chatAdded', 'call to chatAdded api');\n+â”Š   â”Š350â”Š    httpMock.expectOne(httpReq => httpReq.body.operationName === 'messageAdded', 'call to messageAdded api');\n+â”Š   â”Š351â”Š    const req = httpMock.expectOne(httpReq => httpReq.body.operationName === 'GetChats', 'call to getChats api');\n â”Š350â”Š352â”Š    expect(req.request.method).toBe('POST');\n â”Š351â”Š353â”Š    req.flush({\n â”Š352â”Š354â”Š      data: {\n```\n\n[}]: #"
          },
          {
            "manualTitle": "Step 16: TypeORM with PostgreSQL",
            "stepRevision": "0411c7b124bb9f3c4eb5785934865abf7e7b0ea1",
            "manualView": "## Server\n\nFirst of all you will have to install PostgreSQL on your operating system. Since there so many options (different Linux distributions, MacOS X, Windows...) I will assume that you already know how to install a software in your OS and take that part for granted.\n\nThen you will have to install a couple of packages:\n\n    npm install pg reflect-metadata typeorm\n    npm install --save-dev @types/pg\n\nWe aren't going to use plain SQL, instead we will use an Object-relational mapping framework (ORM) called `TypeORM`.\n`TypeORM` takes advantage of Typescript classes and type declarations in order to infer the db structure.\n\nWe will need to enable support for experimental decorators, emit type metadata for decorators and disable strict property initialization:\n\n[{]: <helper> (diffStep \"6.1\" files=\"tsconfig.json\" module=\"server\")\n\n#### Step 6.1: TypeORM with PostgreSQL\n\n##### Changed tsconfig.json\n```diff\n@@ -22,11 +22,11 @@\n â”Š22â”Š22â”Š    // \"isolatedModules\": true,               /* Transpile each file as a separate module (similar to 'ts.transpileModule'). */\n â”Š23â”Š23â”Š\n â”Š24â”Š24â”Š    /* Strict Type-Checking Options */\n-â”Š25â”Š  â”Š    \"strict\": true,                            /* Enable all strict type-checking options. */\n+â”Š  â”Š25â”Š    \"strict\": true,                           /* Enable all strict type-checking options. */\n â”Š26â”Š26â”Š    // \"noImplicitAny\": true,                 /* Raise error on expressions and declarations with an implied 'any' type. */\n â”Š27â”Š27â”Š    // \"strictNullChecks\": true,              /* Enable strict null checks. */\n â”Š28â”Š28â”Š    // See https://github.com/DefinitelyTyped/DefinitelyTyped/issues/21359\n-â”Š29â”Š  â”Š    \"strictFunctionTypes\": false              /* Enable strict checking of function types. */\n+â”Š  â”Š29â”Š    \"strictFunctionTypes\": false,             /* Enable strict checking of function types. */\n â”Š30â”Š30â”Š    // \"noImplicitThis\": true,                /* Raise error on 'this' expressions with an implied 'any' type. */\n â”Š31â”Š31â”Š    // \"alwaysStrict\": true,                  /* Parse in strict mode and emit \"use strict\" for each source file. */\n â”Š32â”Š32â”Š\n```\n```diff\n@@ -53,7 +53,8 @@\n â”Š53â”Š53â”Š    // \"inlineSources\": true,                 /* Emit the source alongside the sourcemaps within a single file; requires '--inlineSourceMap' or '--sourceMap' to be set. */\n â”Š54â”Š54â”Š\n â”Š55â”Š55â”Š    /* Experimental Options */\n-â”Š56â”Š  â”Š    // \"experimentalDecorators\": true,        /* Enables experimental support for ES7 decorators. */\n-â”Š57â”Š  â”Š    // \"emitDecoratorMetadata\": true,         /* Enables experimental support for emitting type metadata for decorators. */\n+â”Š  â”Š56â”Š    \"experimentalDecorators\": true,           /* Enables experimental support for ES7 decorators. */\n+â”Š  â”Š57â”Š    \"emitDecoratorMetadata\": true,            /* Enables experimental support for emitting type metadata for decorators. */\n+â”Š  â”Š58â”Š    \"strictPropertyInitialization\": false\n â”Š58â”Š59â”Š  }\n â”Š59â”Š60â”Š}ðŸš«â†µ\n```\n\n[}]: #\n\nThe next step is to create Entities. An Entity is a class that maps to a database table. You can create a entity by defining a new class and mark it with @Entity():\n\n[{]: <helper> (diffStep \"6.1\" files=\"entity\" module=\"server\")\n\n#### Step 6.1: TypeORM with PostgreSQL\n\n##### Added entity&#x2F;Chat.ts\n```diff\n@@ -0,0 +1,79 @@\n+â”Š  â”Š 1â”Šimport { Entity, Column, PrimaryGeneratedColumn, OneToMany, JoinTable, ManyToMany, ManyToOne } from \"typeorm\";\n+â”Š  â”Š 2â”Šimport { Message } from \"./Message\";\n+â”Š  â”Š 3â”Šimport { User } from \"./User\";\n+â”Š  â”Š 4â”Šimport { Recipient } from \"./Recipient\";\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šinterface ChatConstructor {\n+â”Š  â”Š 7â”Š  name?: string;\n+â”Š  â”Š 8â”Š  picture?: string;\n+â”Š  â”Š 9â”Š  allTimeMembers?: User[];\n+â”Š  â”Š10â”Š  listingMembers?: User[];\n+â”Š  â”Š11â”Š  actualGroupMembers?: User[];\n+â”Š  â”Š12â”Š  admins?: User[];\n+â”Š  â”Š13â”Š  owner?: User;\n+â”Š  â”Š14â”Š  messages?: Message[];\n+â”Š  â”Š15â”Š}\n+â”Š  â”Š16â”Š\n+â”Š  â”Š17â”Š@Entity()\n+â”Š  â”Š18â”Šexport class Chat {\n+â”Š  â”Š19â”Š  @PrimaryGeneratedColumn()\n+â”Š  â”Š20â”Š  id: number;\n+â”Š  â”Š21â”Š\n+â”Š  â”Š22â”Š  @Column({nullable: true})\n+â”Š  â”Š23â”Š  name: string;\n+â”Š  â”Š24â”Š\n+â”Š  â”Š25â”Š  @Column({nullable: true})\n+â”Š  â”Š26â”Š  picture: string;\n+â”Š  â”Š27â”Š\n+â”Š  â”Š28â”Š  @ManyToMany(type => User, user => user.allTimeMemberChats, {cascadeInsert: true, cascadeUpdate: true, eager: false})\n+â”Š  â”Š29â”Š  @JoinTable()\n+â”Š  â”Š30â”Š  allTimeMembers: User[];\n+â”Š  â”Š31â”Š\n+â”Š  â”Š32â”Š  @ManyToMany(type => User, user => user.listingMemberChats, {cascadeInsert: true, cascadeUpdate: true, eager: false})\n+â”Š  â”Š33â”Š  @JoinTable()\n+â”Š  â”Š34â”Š  listingMembers: User[];\n+â”Š  â”Š35â”Š\n+â”Š  â”Š36â”Š  @ManyToMany(type => User, user => user.actualGroupMemberChats, {cascadeInsert: true, cascadeUpdate: true, eager: false})\n+â”Š  â”Š37â”Š  @JoinTable()\n+â”Š  â”Š38â”Š  actualGroupMembers?: User[];\n+â”Š  â”Š39â”Š\n+â”Š  â”Š40â”Š  @ManyToMany(type => User, user => user.adminChats, {cascadeInsert: true, cascadeUpdate: true, eager: false})\n+â”Š  â”Š41â”Š  @JoinTable()\n+â”Š  â”Š42â”Š  admins?: User[];\n+â”Š  â”Š43â”Š\n+â”Š  â”Š44â”Š  @ManyToOne(type => User, user => user.ownerChats, {cascadeInsert: true, cascadeUpdate: true, eager: false})\n+â”Š  â”Š45â”Š  owner?: User | null;\n+â”Š  â”Š46â”Š\n+â”Š  â”Š47â”Š  @OneToMany(type => Message, message => message.chat, {cascadeInsert: true, cascadeUpdate: true, eager: true})\n+â”Š  â”Š48â”Š  messages: Message[];\n+â”Š  â”Š49â”Š\n+â”Š  â”Š50â”Š  @OneToMany(type => Recipient, recipient => recipient.chat)\n+â”Š  â”Š51â”Š  recipients: Recipient[];\n+â”Š  â”Š52â”Š\n+â”Š  â”Š53â”Š  constructor({name, picture, allTimeMembers, listingMembers, actualGroupMembers, admins, owner, messages}: ChatConstructor = {}) {\n+â”Š  â”Š54â”Š    if (name) {\n+â”Š  â”Š55â”Š      this.name = name;\n+â”Š  â”Š56â”Š    }\n+â”Š  â”Š57â”Š    if (picture) {\n+â”Š  â”Š58â”Š      this.picture = picture;\n+â”Š  â”Š59â”Š    }\n+â”Š  â”Š60â”Š    if (allTimeMembers) {\n+â”Š  â”Š61â”Š      this.allTimeMembers = allTimeMembers;\n+â”Š  â”Š62â”Š    }\n+â”Š  â”Š63â”Š    if (listingMembers) {\n+â”Š  â”Š64â”Š      this.listingMembers = listingMembers;\n+â”Š  â”Š65â”Š    }\n+â”Š  â”Š66â”Š    if (actualGroupMembers) {\n+â”Š  â”Š67â”Š      this.actualGroupMembers = actualGroupMembers;\n+â”Š  â”Š68â”Š    }\n+â”Š  â”Š69â”Š    if (admins) {\n+â”Š  â”Š70â”Š      this.admins = admins;\n+â”Š  â”Š71â”Š    }\n+â”Š  â”Š72â”Š    if (owner) {\n+â”Š  â”Š73â”Š      this.owner = owner;\n+â”Š  â”Š74â”Š    }\n+â”Š  â”Š75â”Š    if (messages) {\n+â”Š  â”Š76â”Š      this.messages = messages;\n+â”Š  â”Š77â”Š    }\n+â”Š  â”Š78â”Š  }\n+â”Š  â”Š79â”Š}\n```\n\n##### Added entity&#x2F;Message.ts\n```diff\n@@ -0,0 +1,70 @@\n+â”Š  â”Š 1â”Šimport {\n+â”Š  â”Š 2â”Š  Entity, Column, PrimaryGeneratedColumn, OneToMany, ManyToOne, ManyToMany, JoinTable, CreateDateColumn\n+â”Š  â”Š 3â”Š} from \"typeorm\";\n+â”Š  â”Š 4â”Šimport { Chat } from \"./Chat\";\n+â”Š  â”Š 5â”Šimport { User } from \"./User\";\n+â”Š  â”Š 6â”Šimport { Recipient } from \"./Recipient\";\n+â”Š  â”Š 7â”Šimport { MessageType } from \"../db\";\n+â”Š  â”Š 8â”Š\n+â”Š  â”Š 9â”Šinterface MessageConstructor {\n+â”Š  â”Š10â”Š  sender?: User;\n+â”Š  â”Š11â”Š  content?: string;\n+â”Š  â”Š12â”Š  createdAt?: Date,\n+â”Š  â”Š13â”Š  type?: MessageType;\n+â”Š  â”Š14â”Š  recipients?: Recipient[];\n+â”Š  â”Š15â”Š  holders?: User[];\n+â”Š  â”Š16â”Š  chat?: Chat;\n+â”Š  â”Š17â”Š}\n+â”Š  â”Š18â”Š\n+â”Š  â”Š19â”Š@Entity()\n+â”Š  â”Š20â”Šexport class Message {\n+â”Š  â”Š21â”Š  @PrimaryGeneratedColumn()\n+â”Š  â”Š22â”Š  id: number;\n+â”Š  â”Š23â”Š\n+â”Š  â”Š24â”Š  @ManyToOne(type => User, user => user.senderMessages, {eager: true})\n+â”Š  â”Š25â”Š  sender: User;\n+â”Š  â”Š26â”Š\n+â”Š  â”Š27â”Š  @Column()\n+â”Š  â”Š28â”Š  content: string;\n+â”Š  â”Š29â”Š\n+â”Š  â”Š30â”Š  @CreateDateColumn({nullable: true})\n+â”Š  â”Š31â”Š  createdAt: Date;\n+â”Š  â”Š32â”Š\n+â”Š  â”Š33â”Š  @Column()\n+â”Š  â”Š34â”Š  type: number;\n+â”Š  â”Š35â”Š\n+â”Š  â”Š36â”Š  @OneToMany(type => Recipient, recipient => recipient.message, {cascadeInsert: true, cascadeUpdate: true, eager: true})\n+â”Š  â”Š37â”Š  recipients: Recipient[];\n+â”Š  â”Š38â”Š\n+â”Š  â”Š39â”Š  @ManyToMany(type => User, user => user.holderMessages, {cascadeInsert: true, cascadeUpdate: true, eager: true})\n+â”Š  â”Š40â”Š  @JoinTable()\n+â”Š  â”Š41â”Š  holders: User[];\n+â”Š  â”Š42â”Š\n+â”Š  â”Š43â”Š  @ManyToOne(type => Chat, chat => chat.messages)\n+â”Š  â”Š44â”Š  chat: Chat;\n+â”Š  â”Š45â”Š\n+â”Š  â”Š46â”Š  constructor({sender, content, createdAt, type, recipients, holders, chat}: MessageConstructor = {}) {\n+â”Š  â”Š47â”Š    if (sender) {\n+â”Š  â”Š48â”Š      this.sender = sender;\n+â”Š  â”Š49â”Š    }\n+â”Š  â”Š50â”Š    if (content) {\n+â”Š  â”Š51â”Š      this.content = content;\n+â”Š  â”Š52â”Š    }\n+â”Š  â”Š53â”Š    if (createdAt) {\n+â”Š  â”Š54â”Š      this.createdAt = createdAt;\n+â”Š  â”Š55â”Š    }\n+â”Š  â”Š56â”Š    if (type) {\n+â”Š  â”Š57â”Š      this.type = type;\n+â”Š  â”Š58â”Š    }\n+â”Š  â”Š59â”Š    if (recipients) {\n+â”Š  â”Š60â”Š      recipients.forEach(recipient => recipient.message = this);\n+â”Š  â”Š61â”Š      this.recipients = recipients;\n+â”Š  â”Š62â”Š    }\n+â”Š  â”Š63â”Š    if (holders) {\n+â”Š  â”Š64â”Š      this.holders = holders;\n+â”Š  â”Š65â”Š    }\n+â”Š  â”Š66â”Š    if (chat) {\n+â”Š  â”Š67â”Š      this.chat = chat;\n+â”Š  â”Š68â”Š    }\n+â”Š  â”Š69â”Š  }\n+â”Š  â”Š70â”Š}\n```\n\n##### Added entity&#x2F;Recipient.ts\n```diff\n@@ -0,0 +1,44 @@\n+â”Š  â”Š 1â”Šimport { Entity, ManyToOne, Column } from \"typeorm\";\n+â”Š  â”Š 2â”Šimport { Message } from \"./Message\";\n+â”Š  â”Š 3â”Šimport { User } from \"./User\";\n+â”Š  â”Š 4â”Šimport { Chat } from \"./Chat\";\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šinterface RecipientConstructor {\n+â”Š  â”Š 7â”Š  user?: User;\n+â”Š  â”Š 8â”Š  message?: Message;\n+â”Š  â”Š 9â”Š  receivedAt?: Date;\n+â”Š  â”Š10â”Š  readAt?: Date;\n+â”Š  â”Š11â”Š}\n+â”Š  â”Š12â”Š\n+â”Š  â”Š13â”Š@Entity()\n+â”Š  â”Š14â”Šexport class Recipient {\n+â”Š  â”Š15â”Š  @ManyToOne(type => User, user => user.recipients, { primary: true })\n+â”Š  â”Š16â”Š  user: User;\n+â”Š  â”Š17â”Š\n+â”Š  â”Š18â”Š  @ManyToOne(type => Message, message => message.recipients, { primary: true })\n+â”Š  â”Š19â”Š  message: Message;\n+â”Š  â”Š20â”Š\n+â”Š  â”Š21â”Š  @ManyToOne(type => Chat, chat => chat.recipients)\n+â”Š  â”Š22â”Š  chat: Chat;\n+â”Š  â”Š23â”Š\n+â”Š  â”Š24â”Š  @Column({nullable: true})\n+â”Š  â”Š25â”Š  receivedAt: Date;\n+â”Š  â”Š26â”Š\n+â”Š  â”Š27â”Š  @Column({nullable: true})\n+â”Š  â”Š28â”Š  readAt: Date;\n+â”Š  â”Š29â”Š\n+â”Š  â”Š30â”Š  constructor({user, message, receivedAt, readAt}: RecipientConstructor = {}) {\n+â”Š  â”Š31â”Š    if (user) {\n+â”Š  â”Š32â”Š      this.user = user;\n+â”Š  â”Š33â”Š    }\n+â”Š  â”Š34â”Š    if (message) {\n+â”Š  â”Š35â”Š      this.message = message;\n+â”Š  â”Š36â”Š    }\n+â”Š  â”Š37â”Š    if (receivedAt) {\n+â”Š  â”Š38â”Š      this.receivedAt = receivedAt;\n+â”Š  â”Š39â”Š    }\n+â”Š  â”Š40â”Š    if (readAt) {\n+â”Š  â”Š41â”Š      this.readAt = readAt;\n+â”Š  â”Š42â”Š    }\n+â”Š  â”Š43â”Š  }\n+â”Š  â”Š44â”Š}\n```\n\n##### Added entity&#x2F;User.ts\n```diff\n@@ -0,0 +1,75 @@\n+â”Š  â”Š 1â”Šimport { Entity, Column, PrimaryGeneratedColumn, ManyToMany, OneToMany } from \"typeorm\";\n+â”Š  â”Š 2â”Šimport { Chat } from \"./Chat\";\n+â”Š  â”Š 3â”Šimport { Message } from \"./Message\";\n+â”Š  â”Š 4â”Šimport { Recipient } from \"./Recipient\";\n+â”Š  â”Š 5â”Š\n+â”Š  â”Š 6â”Šinterface UserConstructor {\n+â”Š  â”Š 7â”Š  username?: string;\n+â”Š  â”Š 8â”Š  password?: string;\n+â”Š  â”Š 9â”Š  name?: string;\n+â”Š  â”Š10â”Š  picture?: string;\n+â”Š  â”Š11â”Š  phone?: string;\n+â”Š  â”Š12â”Š}\n+â”Š  â”Š13â”Š\n+â”Š  â”Š14â”Š@Entity()\n+â”Š  â”Š15â”Šexport class User {\n+â”Š  â”Š16â”Š  @PrimaryGeneratedColumn()\n+â”Š  â”Š17â”Š  id: number;\n+â”Š  â”Š18â”Š\n+â”Š  â”Š19â”Š  @Column()\n+â”Š  â”Š20â”Š  username: string;\n+â”Š  â”Š21â”Š\n+â”Š  â”Š22â”Š  @Column()\n+â”Š  â”Š23â”Š  password: string;\n+â”Š  â”Š24â”Š\n+â”Š  â”Š25â”Š  @Column()\n+â”Š  â”Š26â”Š  name: string;\n+â”Š  â”Š27â”Š\n+â”Š  â”Š28â”Š  @Column({nullable: true})\n+â”Š  â”Š29â”Š  picture: string;\n+â”Š  â”Š30â”Š\n+â”Š  â”Š31â”Š  @Column({nullable: true})\n+â”Š  â”Š32â”Š  phone?: string;\n+â”Š  â”Š33â”Š\n+â”Š  â”Š34â”Š  @ManyToMany(type => Chat, chat => chat.allTimeMembers)\n+â”Š  â”Š35â”Š  allTimeMemberChats: Chat[];\n+â”Š  â”Š36â”Š\n+â”Š  â”Š37â”Š  @ManyToMany(type => Chat, chat => chat.listingMembers)\n+â”Š  â”Š38â”Š  listingMemberChats: Chat[];\n+â”Š  â”Š39â”Š\n+â”Š  â”Š40â”Š  @ManyToMany(type => Chat, chat => chat.actualGroupMembers)\n+â”Š  â”Š41â”Š  actualGroupMemberChats: Chat[];\n+â”Š  â”Š42â”Š\n+â”Š  â”Š43â”Š  @ManyToMany(type => Chat, chat => chat.admins)\n+â”Š  â”Š44â”Š  adminChats: Chat[];\n+â”Š  â”Š45â”Š\n+â”Š  â”Š46â”Š  @ManyToMany(type => Message, message => message.holders)\n+â”Š  â”Š47â”Š  holderMessages: Message[];\n+â”Š  â”Š48â”Š\n+â”Š  â”Š49â”Š  @OneToMany(type => Chat, chat => chat.owner)\n+â”Š  â”Š50â”Š  ownerChats: Chat[];\n+â”Š  â”Š51â”Š\n+â”Š  â”Š52â”Š  @OneToMany(type => Message, message => message.sender)\n+â”Š  â”Š53â”Š  senderMessages: Message[];\n+â”Š  â”Š54â”Š\n+â”Š  â”Š55â”Š  @OneToMany(type => Recipient, recipient => recipient.user)\n+â”Š  â”Š56â”Š  recipients: Recipient[];\n+â”Š  â”Š57â”Š\n+â”Š  â”Š58â”Š  constructor({username, password, name, picture, phone}: UserConstructor = {}) {\n+â”Š  â”Š59â”Š    if (username) {\n+â”Š  â”Š60â”Š      this.username = username;\n+â”Š  â”Š61â”Š    }\n+â”Š  â”Š62â”Š    if (password) {\n+â”Š  â”Š63â”Š      this.password = password;\n+â”Š  â”Š64â”Š    }\n+â”Š  â”Š65â”Š    if (name) {\n+â”Š  â”Š66â”Š      this.name = name;\n+â”Š  â”Š67â”Š    }\n+â”Š  â”Š68â”Š    if (picture) {\n+â”Š  â”Š69â”Š      this.picture = picture;\n+â”Š  â”Š70â”Š    }\n+â”Š  â”Š71â”Š    if (phone) {\n+â”Š  â”Š72â”Š      this.phone = phone;\n+â”Š  â”Š73â”Š    }\n+â”Š  â”Š74â”Š  }\n+â”Š  â”Š75â”Š}\n```\n\n[}]: #\n\nBasic entities consist of columns and relations. Each entity MUST have a primary column.\n\nEach entity must be registered in your connection options:\n\n[{]: <helper> (diffStep \"6.1\" files=\"ormconfig.json\" module=\"server\")\n\n#### Step 6.1: TypeORM with PostgreSQL\n\n##### Added ormconfig.json\n```diff\n@@ -0,0 +1,24 @@\n+â”Š  â”Š 1â”Š{\n+â”Š  â”Š 2â”Š   \"type\": \"postgres\",\n+â”Š  â”Š 3â”Š   \"host\": \"localhost\",\n+â”Š  â”Š 4â”Š   \"port\": 5432,\n+â”Š  â”Š 5â”Š   \"username\": \"test\",\n+â”Š  â”Š 6â”Š   \"password\": \"\",\n+â”Š  â”Š 7â”Š   \"database\": \"test\",\n+â”Š  â”Š 8â”Š   \"synchronize\": true,\n+â”Š  â”Š 9â”Š   \"logging\": false,\n+â”Š  â”Š10â”Š   \"entities\": [\n+â”Š  â”Š11â”Š      \"entity/**/*.ts\"\n+â”Š  â”Š12â”Š   ],\n+â”Š  â”Š13â”Š   \"migrations\": [\n+â”Š  â”Š14â”Š      \"migration/**/*.ts\"\n+â”Š  â”Š15â”Š   ],\n+â”Š  â”Š16â”Š   \"subscribers\": [\n+â”Š  â”Š17â”Š      \"subscriber/**/*.ts\"\n+â”Š  â”Š18â”Š   ],\n+â”Š  â”Š19â”Š   \"cli\": {\n+â”Š  â”Š20â”Š      \"entitiesDir\": \"entity\",\n+â”Š  â”Š21â”Š      \"migrationsDir\": \"migration\",\n+â”Š  â”Š22â”Š      \"subscribersDir\": \"subscriber\"\n+â”Š  â”Š23â”Š   }\n+â”Š  â”Š24â”Š}ðŸš«â†µ\n```\n\n[}]: #\n\nSince database table consist of columns your entities must consist of columns too. Each entity class property you marked with @Column will be mapped to a database table column.\nEach entity must have at least one primary column. There are several types of primary columns, but in our case `@PrimaryGeneratedColumn()` creates a primary column which value will be automatically generated with an auto-increment value.\n`@CreateDateColumn` is a special column that is automatically set to the entity's insertion date. You don't need set this column - it will be automatically set.\nFor the Recipient Entity we use a composite primary key that consists of two foreign keys.\n\nThe next thing to do is to create a connection with the database before firing up the web server:\n\n[{]: <helper> (diffStep \"6.1\" files=\"index.ts\" module=\"server\")\n\n#### Step 6.1: TypeORM with PostgreSQL\n\n##### Changed index.ts\n```diff\n@@ -1,3 +1,5 @@\n+â”Š â”Š1â”Š// For TypeORM\n+â”Š â”Š2â”Šimport \"reflect-metadata\";\n â”Š1â”Š3â”Šimport { schema } from \"./schema\";\n â”Š2â”Š4â”Šimport * as bodyParser from \"body-parser\";\n â”Š3â”Š5â”Šimport * as cors from 'cors';\n```\n```diff\n@@ -6,12 +8,12 @@\n â”Š 6â”Š 8â”Šimport * as passport from \"passport\";\n â”Š 7â”Š 9â”Šimport * as basicStrategy from 'passport-http';\n â”Š 8â”Š10â”Šimport * as bcrypt from 'bcrypt-nodejs';\n-â”Š 9â”Š  â”Šimport { db, User } from \"./db\";\n â”Š10â”Š11â”Šimport { createServer } from \"http\";\n â”Š11â”Š12â”Šimport { SubscriptionServer } from \"subscriptions-transport-ws\";\n â”Š12â”Š13â”Šimport { execute, subscribe } from \"graphql\";\n-â”Š13â”Š  â”Š\n-â”Š14â”Š  â”Šlet users = db.users;\n+â”Š  â”Š14â”Šimport { createConnection } from \"typeorm\";\n+â”Š  â”Š15â”Šimport { User } from \"./entity/User\";\n+â”Š  â”Š16â”Šimport { addSampleData } from \"./db\";\n â”Š15â”Š17â”Š\n â”Š16â”Š18â”Šfunction generateHash(password: string) {\n â”Š17â”Š19â”Š  return bcrypt.hashSync(password, bcrypt.genSaltSync(8));\n```\n```diff\n@@ -21,94 +23,97 @@\n â”Š 21â”Š 23â”Š  return bcrypt.compareSync(password, localPassword);\n â”Š 22â”Š 24â”Š}\n â”Š 23â”Š 25â”Š\n-â”Š 24â”Š   â”Špassport.use('basic-signin', new basicStrategy.BasicStrategy(\n-â”Š 25â”Š   â”Š  function (username, password, done) {\n-â”Š 26â”Š   â”Š    const user = users.find(user => user.username == username);\n-â”Š 27â”Š   â”Š    if (user && validPassword(password, user.password)) {\n-â”Š 28â”Š   â”Š      return done(null, user);\n+â”Š   â”Š 26â”ŠcreateConnection().then(async connection => {\n+â”Š   â”Š 27â”Š  await addSampleData(connection);\n+â”Š   â”Š 28â”Š\n+â”Š   â”Š 29â”Š  passport.use('basic-signin', new basicStrategy.BasicStrategy(\n+â”Š   â”Š 30â”Š    async function (username, password, done) {\n+â”Š   â”Š 31â”Š      const user = await connection.getRepository(User).findOne({where: { username }});\n+â”Š   â”Š 32â”Š      if (user && validPassword(password, user.password)) {\n+â”Š   â”Š 33â”Š        return done(null, user);\n+â”Š   â”Š 34â”Š      }\n+â”Š   â”Š 35â”Š      return done(null, false);\n â”Š 29â”Š 36â”Š    }\n-â”Š 30â”Š   â”Š    return done(null, false);\n-â”Š 31â”Š   â”Š  }\n-â”Š 32â”Š   â”Š));\n+â”Š   â”Š 37â”Š  ));\n â”Š 33â”Š 38â”Š\n-â”Š 34â”Š   â”Špassport.use('basic-signup', new basicStrategy.BasicStrategy({passReqToCallback: true},\n-â”Š 35â”Š   â”Š  function (req: any, username: any, password: any, done: any) {\n-â”Š 36â”Š   â”Š    const userExists = !!users.find(user => user.username === username);\n-â”Š 37â”Š   â”Š    if (!userExists && password && req.body.name) {\n-â”Š 38â”Š   â”Š      const user: User = {\n-â”Š 39â”Š   â”Š        id: (users.length && users[users.length - 1].id + 1) || 1,\n-â”Š 40â”Š   â”Š        username,\n-â”Š 41â”Š   â”Š        password: generateHash(password),\n-â”Š 42â”Š   â”Š        name: req.body.name,\n-â”Š 43â”Š   â”Š      };\n-â”Š 44â”Š   â”Š      users.push(user);\n-â”Š 45â”Š   â”Š      return done(null, user);\n+â”Š   â”Š 39â”Š  passport.use('basic-signup', new basicStrategy.BasicStrategy({passReqToCallback: true},\n+â”Š   â”Š 40â”Š    async function (req: any, username: any, password: any, done: any) {\n+â”Š   â”Š 41â”Š      const userExists = !!(await connection.getRepository(User).findOne({where: { username }}));\n+â”Š   â”Š 42â”Š      if (!userExists && password && req.body.name) {\n+â”Š   â”Š 43â”Š        const user = await connection.manager.save(new User({\n+â”Š   â”Š 44â”Š          username,\n+â”Š   â”Š 45â”Š          password: generateHash(password),\n+â”Š   â”Š 46â”Š          name: req.body.name,\n+â”Š   â”Š 47â”Š        }));\n+â”Š   â”Š 48â”Š        return done(null, user);\n+â”Š   â”Š 49â”Š      }\n+â”Š   â”Š 50â”Š      return done(null, false);\n â”Š 46â”Š 51â”Š    }\n-â”Š 47â”Š   â”Š    return done(null, false);\n-â”Š 48â”Š   â”Š  }\n-â”Š 49â”Š   â”Š));\n+â”Š   â”Š 52â”Š  ));\n â”Š 50â”Š 53â”Š\n-â”Š 51â”Š   â”Šconst PORT = 3000;\n+â”Š   â”Š 54â”Š  const PORT = 3000;\n â”Š 52â”Š 55â”Š\n-â”Š 53â”Š   â”Šconst app = express();\n+â”Š   â”Š 56â”Š  const app = express();\n â”Š 54â”Š 57â”Š\n-â”Š 55â”Š   â”Šapp.use(cors());\n-â”Š 56â”Š   â”Šapp.use(bodyParser.json());\n-â”Š 57â”Š   â”Šapp.use(passport.initialize());\n+â”Š   â”Š 58â”Š  app.use(cors());\n+â”Š   â”Š 59â”Š  app.use(bodyParser.json());\n+â”Š   â”Š 60â”Š  app.use(passport.initialize());\n â”Š 58â”Š 61â”Š\n-â”Š 59â”Š   â”Šapp.post('/signup',\n-â”Š 60â”Š   â”Š  passport.authenticate('basic-signup', {session: false}),\n-â”Š 61â”Š   â”Š  function (req, res) {\n-â”Š 62â”Š   â”Š    res.json(req.user);\n-â”Š 63â”Š   â”Š  });\n+â”Š   â”Š 62â”Š  app.post('/signup',\n+â”Š   â”Š 63â”Š    passport.authenticate('basic-signup', {session: false}),\n+â”Š   â”Š 64â”Š    function (req, res) {\n+â”Š   â”Š 65â”Š      res.json(req.user);\n+â”Š   â”Š 66â”Š    });\n â”Š 64â”Š 67â”Š\n-â”Š 65â”Š   â”Šapp.use(passport.authenticate('basic-signin', {session: false}));\n+â”Š   â”Š 68â”Š  app.use(passport.authenticate('basic-signin', {session: false}));\n â”Š 66â”Š 69â”Š\n-â”Š 67â”Š   â”Šapp.post('/signin', function (req, res) {\n-â”Š 68â”Š   â”Š  res.json(req.user);\n-â”Š 69â”Š   â”Š});\n+â”Š   â”Š 70â”Š  app.post('/signin', function (req, res) {\n+â”Š   â”Š 71â”Š    res.json(req.user);\n+â”Š   â”Š 72â”Š  });\n â”Š 70â”Š 73â”Š\n-â”Š 71â”Š   â”Šapp.use('/graphql', graphqlExpress(req => ({\n-â”Š 72â”Š   â”Š  schema: schema,\n-â”Š 73â”Š   â”Š  context: {\n-â”Š 74â”Š   â”Š    user: req!['user'],\n-â”Š 75â”Š   â”Š  },\n-â”Š 76â”Š   â”Š})));\n+â”Š   â”Š 74â”Š  app.use('/graphql', graphqlExpress(req => ({\n+â”Š   â”Š 75â”Š    schema: schema,\n+â”Š   â”Š 76â”Š    context: {\n+â”Š   â”Š 77â”Š      user: req!['user'],\n+â”Š   â”Š 78â”Š      connection,\n+â”Š   â”Š 79â”Š    },\n+â”Š   â”Š 80â”Š  })));\n â”Š 77â”Š 81â”Š\n-â”Š 78â”Š   â”Šapp.use('/graphiql', graphiqlExpress({\n-â”Š 79â”Š   â”Š  endpointURL: '/graphql',\n-â”Š 80â”Š   â”Š}));\n+â”Š   â”Š 82â”Š  app.use('/graphiql', graphiqlExpress({\n+â”Š   â”Š 83â”Š    endpointURL: '/graphql',\n+â”Š   â”Š 84â”Š  }));\n â”Š 81â”Š 85â”Š\n â”Š 82â”Š 86â”Š// Wrap the Express server\n-â”Š 83â”Š   â”Šconst ws = createServer(app);\n-â”Š 84â”Š   â”Šws.listen(PORT, () => {\n-â”Š 85â”Š   â”Š  console.log(`Apollo Server is now running on http://localhost:${PORT}`);\n-â”Š 86â”Š   â”Š  // Set up the WebSocket for handling GraphQL subscriptions\n-â”Š 87â”Š   â”Š  new SubscriptionServer({\n-â”Š 88â”Š   â”Š    onConnect: (connectionParams: any, webSocket: any) => {\n-â”Š 89â”Š   â”Š      if (connectionParams.authToken) {\n-â”Š 90â”Š   â”Š        // create a buffer and tell it the data coming in is base64\n-â”Š 91â”Š   â”Š        const buf = new Buffer(connectionParams.authToken.split(' ')[1], 'base64');\n-â”Š 92â”Š   â”Š        // read it back out as a string\n-â”Š 93â”Š   â”Š        const [username, password]: string[] = buf.toString().split(':');\n-â”Š 94â”Š   â”Š        if (username && password) {\n-â”Š 95â”Š   â”Š          const user = users.find(user => user.username == username);\n+â”Š   â”Š 87â”Š  const ws = createServer(app);\n+â”Š   â”Š 88â”Š  ws.listen(PORT, () => {\n+â”Š   â”Š 89â”Š    console.log(`Apollo Server is now running on http://localhost:${PORT}`);\n+â”Š   â”Š 90â”Š    // Set up the WebSocket for handling GraphQL subscriptions\n+â”Š   â”Š 91â”Š    new SubscriptionServer({\n+â”Š   â”Š 92â”Š      onConnect: async (connectionParams: any, webSocket: any) => {\n+â”Š   â”Š 93â”Š        if (connectionParams.authToken) {\n+â”Š   â”Š 94â”Š          // Create a buffer and tell it the data coming in is base64\n+â”Š   â”Š 95â”Š          const buf = new Buffer(connectionParams.authToken.split(' ')[1], 'base64');\n+â”Š   â”Š 96â”Š          // Read it back out as a string\n+â”Š   â”Š 97â”Š          const [username, password]: string[] = buf.toString().split(':');\n+â”Š   â”Š 98â”Š          if (username && password) {\n+â”Š   â”Š 99â”Š            const user = await connection.getRepository(User).findOne({where: { username }});\n â”Š 96â”Š100â”Š\n-â”Š 97â”Š   â”Š          if (user && validPassword(password, user.password)) {\n-â”Š 98â”Š   â”Š            // Set context for the WebSocket\n-â”Š 99â”Š   â”Š            return {user};\n-â”Š100â”Š   â”Š          } else {\n-â”Š101â”Š   â”Š            throw new Error('Wrong credentials!');\n+â”Š   â”Š101â”Š            if (user && validPassword(password, user.password)) {\n+â”Š   â”Š102â”Š              // Set context for the WebSocket\n+â”Š   â”Š103â”Š              return {user, connection};\n+â”Š   â”Š104â”Š            } else {\n+â”Š   â”Š105â”Š              throw new Error('Wrong credentials!');\n+â”Š   â”Š106â”Š            }\n â”Š102â”Š107â”Š          }\n â”Š103â”Š108â”Š        }\n-â”Š104â”Š   â”Š      }\n-â”Š105â”Š   â”Š      throw new Error('Missing auth token!');\n-â”Š106â”Š   â”Š    },\n-â”Š107â”Š   â”Š    execute,\n-â”Š108â”Š   â”Š    subscribe,\n-â”Š109â”Š   â”Š    schema\n-â”Š110â”Š   â”Š  }, {\n-â”Š111â”Š   â”Š    server: ws,\n-â”Š112â”Š   â”Š    path: '/subscriptions',\n+â”Š   â”Š109â”Š        throw new Error('Missing auth token!');\n+â”Š   â”Š110â”Š      },\n+â”Š   â”Š111â”Š      execute,\n+â”Š   â”Š112â”Š      subscribe,\n+â”Š   â”Š113â”Š      schema\n+â”Š   â”Š114â”Š    }, {\n+â”Š   â”Š115â”Š      server: ws,\n+â”Š   â”Š116â”Š      path: '/subscriptions',\n+â”Š   â”Š117â”Š    });\n â”Š113â”Š118â”Š  });\n â”Š114â”Š119â”Š});\n```\n\n[}]: #\n\nWe will also remove our fake db and replace it with some real data:\n\n[{]: <helper> (diffStep \"6.1\" files=\"db.ts\" module=\"server\")\n\n#### Step 6.1: TypeORM with PostgreSQL\n\n##### Changed db.ts\n```diff\n@@ -1,4 +1,11 @@\n+â”Š  â”Š 1â”Š// For TypeORM\n+â”Š  â”Š 2â”Šimport \"reflect-metadata\";\n+â”Š  â”Š 3â”Šimport { Chat } from \"./entity/Chat\";\n+â”Š  â”Š 4â”Šimport { Recipient } from \"./entity/Recipient\";\n â”Š 1â”Š 5â”Šimport * as moment from 'moment';\n+â”Š  â”Š 6â”Šimport { Message } from \"./entity/Message\";\n+â”Š  â”Š 7â”Šimport { User } from \"./entity/User\";\n+â”Š  â”Š 8â”Šimport { Connection } from \"typeorm\";\n â”Š 2â”Š 9â”Š\n â”Š 3â”Š10â”Šexport enum MessageType {\n â”Š 4â”Š11â”Š  PICTURE,\n```\n```diff\n@@ -6,433 +13,280 @@\n â”Š  6â”Š 13â”Š  LOCATION,\n â”Š  7â”Š 14â”Š}\n â”Š  8â”Š 15â”Š\n-â”Š  9â”Š   â”Šexport interface User {\n-â”Š 10â”Š   â”Š  id: number,\n-â”Š 11â”Š   â”Š  username: string,\n-â”Š 12â”Š   â”Š  password: string,\n-â”Š 13â”Š   â”Š  name: string,\n-â”Š 14â”Š   â”Š  picture?: string | null,\n-â”Š 15â”Š   â”Š  phone?: string | null,\n-â”Š 16â”Š   â”Š}\n-â”Š 17â”Š   â”Š\n-â”Š 18â”Š   â”Šexport interface Chat {\n-â”Š 19â”Š   â”Š  id: number,\n-â”Š 20â”Š   â”Š  name?: string | null,\n-â”Š 21â”Š   â”Š  picture?: string | null,\n-â”Š 22â”Š   â”Š  // All members, current and past ones.\n-â”Š 23â”Š   â”Š  allTimeMemberIds: number[],\n-â”Š 24â”Š   â”Š  // Whoever gets the chat listed. For groups includes past members who still didn't delete the group.\n-â”Š 25â”Š   â”Š  listingMemberIds: number[],\n-â”Š 26â”Š   â”Š  // Actual members of the group (they are not the only ones who get the group listed). Null for chats.\n-â”Š 27â”Š   â”Š  actualGroupMemberIds?: number[] | null,\n-â”Š 28â”Š   â”Š  adminIds?: number[] | null,\n-â”Š 29â”Š   â”Š  ownerId?: number | null,\n-â”Š 30â”Š   â”Š  messages: Message[],\n-â”Š 31â”Š   â”Š}\n-â”Š 32â”Š   â”Š\n-â”Š 33â”Š   â”Šexport interface Message {\n-â”Š 34â”Š   â”Š  id: number,\n-â”Š 35â”Š   â”Š  chatId: number,\n-â”Š 36â”Š   â”Š  senderId: number,\n-â”Š 37â”Š   â”Š  content: string,\n-â”Š 38â”Š   â”Š  createdAt: number,\n-â”Š 39â”Š   â”Š  type: MessageType,\n-â”Š 40â”Š   â”Š  recipients: Recipient[],\n-â”Š 41â”Š   â”Š  holderIds: number[],\n-â”Š 42â”Š   â”Š}\n-â”Š 43â”Š   â”Š\n-â”Š 44â”Š   â”Šexport interface Recipient {\n-â”Š 45â”Š   â”Š  userId: number,\n-â”Š 46â”Š   â”Š  messageId: number,\n-â”Š 47â”Š   â”Š  chatId: number,\n-â”Š 48â”Š   â”Š  receivedAt: number | null,\n-â”Š 49â”Š   â”Š  readAt: number | null,\n-â”Š 50â”Š   â”Š}\n-â”Š 51â”Š   â”Š\n-â”Š 52â”Š   â”Šconst users: User[] = [\n-â”Š 53â”Š   â”Š  {\n-â”Š 54â”Š   â”Š    id: 1,\n+â”Š   â”Š 16â”Šexport async function addSampleData(connection: Connection) {\n+â”Š   â”Š 17â”Š  const user1 = new User({\n â”Š 55â”Š 18â”Š    username: 'ethan',\n â”Š 56â”Š 19â”Š    password: '$2a$08$NO9tkFLCoSqX1c5wk3s7z.JfxaVMKA.m7zUDdDwEquo4rvzimQeJm', // 111\n â”Š 57â”Š 20â”Š    name: 'Ethan Gonzalez',\n â”Š 58â”Š 21â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/1.jpg',\n â”Š 59â”Š 22â”Š    phone: '+391234567890',\n-â”Š 60â”Š   â”Š  },\n-â”Š 61â”Š   â”Š  {\n-â”Š 62â”Š   â”Š    id: 2,\n+â”Š   â”Š 23â”Š  });\n+â”Š   â”Š 24â”Š  await connection.manager.save(user1);\n+â”Š   â”Š 25â”Š\n+â”Š   â”Š 26â”Š  const user2 = new User({\n â”Š 63â”Š 27â”Š    username: 'bryan',\n â”Š 64â”Š 28â”Š    password: '$2a$08$xE4FuCi/ifxjL2S8CzKAmuKLwv18ktksSN.F3XYEnpmcKtpbpeZgO', // 222\n â”Š 65â”Š 29â”Š    name: 'Bryan Wallace',\n â”Š 66â”Š 30â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/2.jpg',\n â”Š 67â”Š 31â”Š    phone: '+391234567891',\n-â”Š 68â”Š   â”Š  },\n-â”Š 69â”Š   â”Š  {\n-â”Š 70â”Š   â”Š    id: 3,\n+â”Š   â”Š 32â”Š  });\n+â”Š   â”Š 33â”Š  await connection.manager.save(user2);\n+â”Š   â”Š 34â”Š\n+â”Š   â”Š 35â”Š  const user3 = new User({\n â”Š 71â”Š 36â”Š    username: 'avery',\n â”Š 72â”Š 37â”Š    password: '$2a$08$UHgH7J8G6z1mGQn2qx2kdeWv0jvgHItyAsL9hpEUI3KJmhVW5Q1d.', // 333\n â”Š 73â”Š 38â”Š    name: 'Avery Stewart',\n â”Š 74â”Š 39â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/1.jpg',\n â”Š 75â”Š 40â”Š    phone: '+391234567892',\n-â”Š 76â”Š   â”Š  },\n-â”Š 77â”Š   â”Š  {\n-â”Š 78â”Š   â”Š    id: 4,\n+â”Š   â”Š 41â”Š  });\n+â”Š   â”Š 42â”Š  await connection.manager.save(user3);\n+â”Š   â”Š 43â”Š\n+â”Š   â”Š 44â”Š  const user4 = new User({\n â”Š 79â”Š 45â”Š    username: 'katie',\n â”Š 80â”Š 46â”Š    password: '$2a$08$wR1k5Q3T9FC7fUgB7Gdb9Os/GV7dGBBf4PLlWT7HERMFhmFDt47xi', // 444\n â”Š 81â”Š 47â”Š    name: 'Katie Peterson',\n â”Š 82â”Š 48â”Š    picture: 'https://randomuser.me/api/portraits/thumb/women/2.jpg',\n â”Š 83â”Š 49â”Š    phone: '+391234567893',\n-â”Š 84â”Š   â”Š  },\n-â”Š 85â”Š   â”Š  {\n-â”Š 86â”Š   â”Š    id: 5,\n+â”Š   â”Š 50â”Š  });\n+â”Š   â”Š 51â”Š  await connection.manager.save(user4);\n+â”Š   â”Š 52â”Š\n+â”Š   â”Š 53â”Š  const user5 = new User({\n â”Š 87â”Š 54â”Š    username: 'ray',\n â”Š 88â”Š 55â”Š    password: '$2a$08$6.mbXqsDX82ZZ7q5d8Osb..JrGSsNp4R3IKj7mxgF6YGT0OmMw242', // 555\n â”Š 89â”Š 56â”Š    name: 'Ray Edwards',\n â”Š 90â”Š 57â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/3.jpg',\n â”Š 91â”Š 58â”Š    phone: '+391234567894',\n-â”Š 92â”Š   â”Š  },\n-â”Š 93â”Š   â”Š  {\n-â”Š 94â”Š   â”Š    id: 6,\n+â”Š   â”Š 59â”Š  });\n+â”Š   â”Š 60â”Š  await connection.manager.save(user5);\n+â”Š   â”Š 61â”Š\n+â”Š   â”Š 62â”Š  const user6 = new User({\n â”Š 95â”Š 63â”Š    username: 'niko',\n â”Š 96â”Š 64â”Š    password: '$2a$08$fL5lZR.Rwf9FWWe8XwwlceiPBBim8n9aFtaem.INQhiKT4.Ux3Uq.', // 666\n â”Š 97â”Š 65â”Š    name: 'NiccolÃ² Belli',\n â”Š 98â”Š 66â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/4.jpg',\n â”Š 99â”Š 67â”Š    phone: '+391234567895',\n-â”Š100â”Š   â”Š  },\n-â”Š101â”Š   â”Š  {\n-â”Š102â”Š   â”Š    id: 7,\n+â”Š   â”Š 68â”Š  });\n+â”Š   â”Š 69â”Š  await connection.manager.save(user6);\n+â”Š   â”Š 70â”Š\n+â”Š   â”Š 71â”Š  const user7 = new User({\n â”Š103â”Š 72â”Š    username: 'mario',\n â”Š104â”Š 73â”Š    password: '$2a$08$nDHDmWcVxDnH5DDT3HMMC.psqcnu6wBiOgkmJUy9IH..qxa3R6YrO', // 777\n â”Š105â”Š 74â”Š    name: 'Mario Rossi',\n â”Š106â”Š 75â”Š    picture: 'https://randomuser.me/api/portraits/thumb/men/5.jpg',\n â”Š107â”Š 76â”Š    phone: '+391234567896',\n-â”Š108â”Š   â”Š  },\n-â”Š109â”Š   â”Š];\n+â”Š   â”Š 77â”Š  });\n+â”Š   â”Š 78â”Š  await connection.manager.save(user7);\n+â”Š   â”Š 79â”Š\n+â”Š   â”Š 80â”Š\n â”Š110â”Š 81â”Š\n-â”Š111â”Š   â”Šconst chats: Chat[] = [\n-â”Š112â”Š   â”Š  {\n-â”Š113â”Š   â”Š    id: 1,\n-â”Š114â”Š   â”Š    name: null,\n-â”Š115â”Š   â”Š    picture: null,\n-â”Š116â”Š   â”Š    allTimeMemberIds: [1, 3],\n-â”Š117â”Š   â”Š    listingMemberIds: [1, 3],\n-â”Š118â”Š   â”Š    adminIds: null,\n-â”Š119â”Š   â”Š    ownerId: null,\n+â”Š   â”Š 82â”Š\n+â”Š   â”Š 83â”Š  await connection.manager.save(new Chat({\n+â”Š   â”Š 84â”Š    allTimeMembers: [user1, user3],\n+â”Š   â”Š 85â”Š    listingMembers: [user1, user3],\n â”Š120â”Š 86â”Š    messages: [\n-â”Š121â”Š   â”Š      {\n-â”Š122â”Š   â”Š        id: 1,\n-â”Š123â”Š   â”Š        chatId: 1,\n-â”Š124â”Š   â”Š        senderId: 1,\n+â”Š   â”Š 87â”Š      new Message({\n+â”Š   â”Š 88â”Š        sender: user1,\n â”Š125â”Š 89â”Š        content: 'You on your way?',\n-â”Š126â”Š   â”Š        createdAt: moment().subtract(1, 'hours').unix(),\n+â”Š   â”Š 90â”Š        createdAt: moment().subtract(1, 'hours').toDate(),\n â”Š127â”Š 91â”Š        type: MessageType.TEXT,\n+â”Š   â”Š 92â”Š        holders: [user1, user3],\n â”Š128â”Š 93â”Š        recipients: [\n-â”Š129â”Š   â”Š          {\n-â”Š130â”Š   â”Š            userId: 3,\n-â”Š131â”Š   â”Š            messageId: 1,\n-â”Š132â”Š   â”Š            chatId: 1,\n-â”Š133â”Š   â”Š            receivedAt: null,\n-â”Š134â”Š   â”Š            readAt: null,\n-â”Š135â”Š   â”Š          },\n+â”Š   â”Š 94â”Š          new Recipient({\n+â”Š   â”Š 95â”Š            user: user3,\n+â”Š   â”Š 96â”Š          }),\n â”Š136â”Š 97â”Š        ],\n-â”Š137â”Š   â”Š        holderIds: [1, 3],\n-â”Š138â”Š   â”Š      },\n-â”Š139â”Š   â”Š      {\n-â”Š140â”Š   â”Š        id: 2,\n-â”Š141â”Š   â”Š        chatId: 1,\n-â”Š142â”Š   â”Š        senderId: 3,\n+â”Š   â”Š 98â”Š      }),\n+â”Š   â”Š 99â”Š      new Message({\n+â”Š   â”Š100â”Š        sender: user3,\n â”Š143â”Š101â”Š        content: 'Yep!',\n-â”Š144â”Š   â”Š        createdAt: moment().subtract(1, 'hours').add(5, 'minutes').unix(),\n+â”Š   â”Š102â”Š        createdAt: moment().subtract(1, 'hours').add(5, 'minutes').toDate(),\n â”Š145â”Š103â”Š        type: MessageType.TEXT,\n+â”Š   â”Š104â”Š        holders: [user1, user3],\n â”Š146â”Š105â”Š        recipients: [\n-â”Š147â”Š   â”Š          {\n-â”Š148â”Š   â”Š            userId: 1,\n-â”Š149â”Š   â”Š            messageId: 2,\n-â”Š150â”Š   â”Š            chatId: 1,\n-â”Š151â”Š   â”Š            receivedAt: null,\n-â”Š152â”Š   â”Š            readAt: null,\n-â”Š153â”Š   â”Š          },\n+â”Š   â”Š106â”Š          new Recipient({\n+â”Š   â”Š107â”Š            user: user1,\n+â”Š   â”Š108â”Š          }),\n â”Š154â”Š109â”Š        ],\n-â”Š155â”Š   â”Š        holderIds: [3, 1],\n-â”Š156â”Š   â”Š      },\n+â”Š   â”Š110â”Š      }),\n â”Š157â”Š111â”Š    ],\n-â”Š158â”Š   â”Š  },\n-â”Š159â”Š   â”Š  {\n-â”Š160â”Š   â”Š    id: 2,\n-â”Š161â”Š   â”Š    name: null,\n-â”Š162â”Š   â”Š    picture: null,\n-â”Š163â”Š   â”Š    allTimeMemberIds: [1, 4],\n-â”Š164â”Š   â”Š    listingMemberIds: [1, 4],\n-â”Š165â”Š   â”Š    adminIds: null,\n-â”Š166â”Š   â”Š    ownerId: null,\n+â”Š   â”Š112â”Š  }));\n+â”Š   â”Š113â”Š\n+â”Š   â”Š114â”Š  await connection.manager.save(new Chat({\n+â”Š   â”Š115â”Š    allTimeMembers: [user1, user4],\n+â”Š   â”Š116â”Š    listingMembers: [user1, user4],\n â”Š167â”Š117â”Š    messages: [\n-â”Š168â”Š   â”Š      {\n-â”Š169â”Š   â”Š        id: 1,\n-â”Š170â”Š   â”Š        chatId: 2,\n-â”Š171â”Š   â”Š        senderId: 1,\n+â”Š   â”Š118â”Š      new Message({\n+â”Š   â”Š119â”Š        sender: user1,\n â”Š172â”Š120â”Š        content: 'Hey, it\\'s me',\n-â”Š173â”Š   â”Š        createdAt: moment().subtract(2, 'hours').unix(),\n+â”Š   â”Š121â”Š        createdAt: moment().subtract(2, 'hours').toDate(),\n â”Š174â”Š122â”Š        type: MessageType.TEXT,\n+â”Š   â”Š123â”Š        holders: [user1, user4],\n â”Š175â”Š124â”Š        recipients: [\n-â”Š176â”Š   â”Š          {\n-â”Š177â”Š   â”Š            userId: 4,\n-â”Š178â”Š   â”Š            messageId: 1,\n-â”Š179â”Š   â”Š            chatId: 2,\n-â”Š180â”Š   â”Š            receivedAt: null,\n-â”Š181â”Š   â”Š            readAt: null,\n-â”Š182â”Š   â”Š          },\n+â”Š   â”Š125â”Š          new Recipient({\n+â”Š   â”Š126â”Š            user: user4,\n+â”Š   â”Š127â”Š          }),\n â”Š183â”Š128â”Š        ],\n-â”Š184â”Š   â”Š        holderIds: [1, 4],\n-â”Š185â”Š   â”Š      },\n+â”Š   â”Š129â”Š      }),\n â”Š186â”Š130â”Š    ],\n-â”Š187â”Š   â”Š  },\n-â”Š188â”Š   â”Š  {\n-â”Š189â”Š   â”Š    id: 3,\n-â”Š190â”Š   â”Š    name: null,\n-â”Š191â”Š   â”Š    picture: null,\n-â”Š192â”Š   â”Š    allTimeMemberIds: [1, 5],\n-â”Š193â”Š   â”Š    listingMemberIds: [1, 5],\n-â”Š194â”Š   â”Š    adminIds: null,\n-â”Š195â”Š   â”Š    ownerId: null,\n+â”Š   â”Š131â”Š  }));\n+â”Š   â”Š132â”Š\n+â”Š   â”Š133â”Š  await connection.manager.save(new Chat({\n+â”Š   â”Š134â”Š    allTimeMembers: [user1, user5],\n+â”Š   â”Š135â”Š    listingMembers: [user1, user5],\n â”Š196â”Š136â”Š    messages: [\n-â”Š197â”Š   â”Š      {\n-â”Š198â”Š   â”Š        id: 1,\n-â”Š199â”Š   â”Š        chatId: 3,\n-â”Š200â”Š   â”Š        senderId: 1,\n+â”Š   â”Š137â”Š      new Message({\n+â”Š   â”Š138â”Š        sender: user1,\n â”Š201â”Š139â”Š        content: 'I should buy a boat',\n-â”Š202â”Š   â”Š        createdAt: moment().subtract(1, 'days').unix(),\n+â”Š   â”Š140â”Š        createdAt: moment().subtract(1, 'days').toDate(),\n â”Š203â”Š141â”Š        type: MessageType.TEXT,\n+â”Š   â”Š142â”Š        holders: [user1, user5],\n â”Š204â”Š143â”Š        recipients: [\n-â”Š205â”Š   â”Š          {\n-â”Š206â”Š   â”Š            userId: 5,\n-â”Š207â”Š   â”Š            messageId: 1,\n-â”Š208â”Š   â”Š            chatId: 3,\n-â”Š209â”Š   â”Š            receivedAt: null,\n-â”Š210â”Š   â”Š            readAt: null,\n-â”Š211â”Š   â”Š          },\n+â”Š   â”Š144â”Š          new Recipient({\n+â”Š   â”Š145â”Š            user: user5,\n+â”Š   â”Š146â”Š          }),\n â”Š212â”Š147â”Š        ],\n-â”Š213â”Š   â”Š        holderIds: [1, 5],\n-â”Š214â”Š   â”Š      },\n-â”Š215â”Š   â”Š      {\n-â”Š216â”Š   â”Š        id: 2,\n-â”Š217â”Š   â”Š        chatId: 3,\n-â”Š218â”Š   â”Š        senderId: 1,\n+â”Š   â”Š148â”Š      }),\n+â”Š   â”Š149â”Š      new Message({\n+â”Š   â”Š150â”Š        sender: user1,\n â”Š219â”Š151â”Š        content: 'You still there?',\n-â”Š220â”Š   â”Š        createdAt: moment().subtract(1, 'days').add(16, 'hours').unix(),\n+â”Š   â”Š152â”Š        createdAt: moment().subtract(1, 'days').add(16, 'hours').toDate(),\n â”Š221â”Š153â”Š        type: MessageType.TEXT,\n+â”Š   â”Š154â”Š        holders: [user1, user5],\n â”Š222â”Š155â”Š        recipients: [\n-â”Š223â”Š   â”Š          {\n-â”Š224â”Š   â”Š            userId: 5,\n-â”Š225â”Š   â”Š            messageId: 2,\n-â”Š226â”Š   â”Š            chatId: 3,\n-â”Š227â”Š   â”Š            receivedAt: null,\n-â”Š228â”Š   â”Š            readAt: null,\n-â”Š229â”Š   â”Š          },\n+â”Š   â”Š156â”Š          new Recipient({\n+â”Š   â”Š157â”Š            user: user5,\n+â”Š   â”Š158â”Š          }),\n â”Š230â”Š159â”Š        ],\n-â”Š231â”Š   â”Š        holderIds: [1, 5],\n-â”Š232â”Š   â”Š      },\n+â”Š   â”Š160â”Š      }),\n â”Š233â”Š161â”Š    ],\n-â”Š234â”Š   â”Š  },\n-â”Š235â”Š   â”Š  {\n-â”Š236â”Š   â”Š    id: 4,\n-â”Š237â”Š   â”Š    name: null,\n-â”Š238â”Š   â”Š    picture: null,\n-â”Š239â”Š   â”Š    allTimeMemberIds: [3, 4],\n-â”Š240â”Š   â”Š    listingMemberIds: [3, 4],\n-â”Š241â”Š   â”Š    adminIds: null,\n-â”Š242â”Š   â”Š    ownerId: null,\n+â”Š   â”Š162â”Š  }));\n+â”Š   â”Š163â”Š\n+â”Š   â”Š164â”Š  await connection.manager.save(new Chat({\n+â”Š   â”Š165â”Š    allTimeMembers: [user3, user4],\n+â”Š   â”Š166â”Š    listingMembers: [user3, user4],\n â”Š243â”Š167â”Š    messages: [\n-â”Š244â”Š   â”Š      {\n-â”Š245â”Š   â”Š        id: 1,\n-â”Š246â”Š   â”Š        chatId: 4,\n-â”Š247â”Š   â”Š        senderId: 3,\n+â”Š   â”Š168â”Š      new Message({\n+â”Š   â”Š169â”Š        sender: user3,\n â”Š248â”Š170â”Š        content: 'Look at my mukluks!',\n-â”Š249â”Š   â”Š        createdAt: moment().subtract(4, 'days').unix(),\n+â”Š   â”Š171â”Š        createdAt: moment().subtract(4, 'days').toDate(),\n â”Š250â”Š172â”Š        type: MessageType.TEXT,\n+â”Š   â”Š173â”Š        holders: [user3, user4],\n â”Š251â”Š174â”Š        recipients: [\n-â”Š252â”Š   â”Š          {\n-â”Š253â”Š   â”Š            userId: 4,\n-â”Š254â”Š   â”Š            messageId: 1,\n-â”Š255â”Š   â”Š            chatId: 4,\n-â”Š256â”Š   â”Š            receivedAt: null,\n-â”Š257â”Š   â”Š            readAt: null,\n-â”Š258â”Š   â”Š          },\n+â”Š   â”Š175â”Š          new Recipient({\n+â”Š   â”Š176â”Š            user: user4,\n+â”Š   â”Š177â”Š          }),\n â”Š259â”Š178â”Š        ],\n-â”Š260â”Š   â”Š        holderIds: [3, 4],\n-â”Š261â”Š   â”Š      },\n+â”Š   â”Š179â”Š      }),\n â”Š262â”Š180â”Š    ],\n-â”Š263â”Š   â”Š  },\n-â”Š264â”Š   â”Š  {\n-â”Š265â”Š   â”Š    id: 5,\n-â”Š266â”Š   â”Š    name: null,\n-â”Š267â”Š   â”Š    picture: null,\n-â”Š268â”Š   â”Š    allTimeMemberIds: [2, 5],\n-â”Š269â”Š   â”Š    listingMemberIds: [2, 5],\n-â”Š270â”Š   â”Š    adminIds: null,\n-â”Š271â”Š   â”Š    ownerId: null,\n+â”Š   â”Š181â”Š  }));\n+â”Š   â”Š182â”Š\n+â”Š   â”Š183â”Š  await connection.manager.save(new Chat({\n+â”Š   â”Š184â”Š    allTimeMembers: [user2, user5],\n+â”Š   â”Š185â”Š    listingMembers: [user2, user5],\n â”Š272â”Š186â”Š    messages: [\n-â”Š273â”Š   â”Š      {\n-â”Š274â”Š   â”Š        id: 1,\n-â”Š275â”Š   â”Š        chatId: 5,\n-â”Š276â”Š   â”Š        senderId: 2,\n+â”Š   â”Š187â”Š      new Message({\n+â”Š   â”Š188â”Š        sender: user2,\n â”Š277â”Š189â”Š        content: 'This is wicked good ice cream.',\n-â”Š278â”Š   â”Š        createdAt: moment().subtract(2, 'weeks').unix(),\n+â”Š   â”Š190â”Š        createdAt: moment().subtract(2, 'weeks').toDate(),\n â”Š279â”Š191â”Š        type: MessageType.TEXT,\n+â”Š   â”Š192â”Š        holders: [user2, user5],\n â”Š280â”Š193â”Š        recipients: [\n-â”Š281â”Š   â”Š          {\n-â”Š282â”Š   â”Š            userId: 5,\n-â”Š283â”Š   â”Š            messageId: 1,\n-â”Š284â”Š   â”Š            chatId: 5,\n-â”Š285â”Š   â”Š            receivedAt: null,\n-â”Š286â”Š   â”Š            readAt: null,\n-â”Š287â”Š   â”Š          },\n+â”Š   â”Š194â”Š          new Recipient({\n+â”Š   â”Š195â”Š            user: user5,\n+â”Š   â”Š196â”Š          }),\n â”Š288â”Š197â”Š        ],\n-â”Š289â”Š   â”Š        holderIds: [2, 5],\n-â”Š290â”Š   â”Š      },\n-â”Š291â”Š   â”Š      {\n-â”Š292â”Š   â”Š        id: 2,\n-â”Š293â”Š   â”Š        chatId: 6,\n-â”Š294â”Š   â”Š        senderId: 5,\n+â”Š   â”Š198â”Š      }),\n+â”Š   â”Š199â”Š      new Message({\n+â”Š   â”Š200â”Š        sender: user5,\n â”Š295â”Š201â”Š        content: 'Love it!',\n-â”Š296â”Š   â”Š        createdAt: moment().subtract(2, 'weeks').add(10, 'minutes').unix(),\n+â”Š   â”Š202â”Š        createdAt: moment().subtract(2, 'weeks').add(10, 'minutes').toDate(),\n â”Š297â”Š203â”Š        type: MessageType.TEXT,\n+â”Š   â”Š204â”Š        holders: [user2, user5],\n â”Š298â”Š205â”Š        recipients: [\n-â”Š299â”Š   â”Š          {\n-â”Š300â”Š   â”Š            userId: 2,\n-â”Š301â”Š   â”Š            messageId: 2,\n-â”Š302â”Š   â”Š            chatId: 5,\n-â”Š303â”Š   â”Š            receivedAt: null,\n-â”Š304â”Š   â”Š            readAt: null,\n-â”Š305â”Š   â”Š          },\n+â”Š   â”Š206â”Š          new Recipient({\n+â”Š   â”Š207â”Š            user: user2,\n+â”Š   â”Š208â”Š          }),\n â”Š306â”Š209â”Š        ],\n-â”Š307â”Š   â”Š        holderIds: [5, 2],\n-â”Š308â”Š   â”Š      },\n+â”Š   â”Š210â”Š      }),\n â”Š309â”Š211â”Š    ],\n-â”Š310â”Š   â”Š  },\n-â”Š311â”Š   â”Š  {\n-â”Š312â”Š   â”Š    id: 6,\n-â”Š313â”Š   â”Š    name: null,\n-â”Š314â”Š   â”Š    picture: null,\n-â”Š315â”Š   â”Š    allTimeMemberIds: [1, 6],\n-â”Š316â”Š   â”Š    listingMemberIds: [1],\n-â”Š317â”Š   â”Š    adminIds: null,\n-â”Š318â”Š   â”Š    ownerId: null,\n-â”Š319â”Š   â”Š    messages: [],\n-â”Š320â”Š   â”Š  },\n-â”Š321â”Š   â”Š  {\n-â”Š322â”Š   â”Š    id: 7,\n-â”Š323â”Š   â”Š    name: null,\n-â”Š324â”Š   â”Š    picture: null,\n-â”Š325â”Š   â”Š    allTimeMemberIds: [2, 1],\n-â”Š326â”Š   â”Š    listingMemberIds: [2],\n-â”Š327â”Š   â”Š    adminIds: null,\n-â”Š328â”Š   â”Š    ownerId: null,\n-â”Š329â”Š   â”Š    messages: [],\n-â”Š330â”Š   â”Š  },\n-â”Š331â”Š   â”Š  {\n-â”Š332â”Š   â”Š    id: 8,\n-â”Š333â”Š   â”Š    name: 'A user 0 group',\n+â”Š   â”Š212â”Š  }));\n+â”Š   â”Š213â”Š\n+â”Š   â”Š214â”Š  await connection.manager.save(new Chat({\n+â”Š   â”Š215â”Š    allTimeMembers: [user1, user6],\n+â”Š   â”Š216â”Š    listingMembers: [user1],\n+â”Š   â”Š217â”Š  }));\n+â”Š   â”Š218â”Š\n+â”Š   â”Š219â”Š  await connection.manager.save(new Chat({\n+â”Š   â”Š220â”Š    allTimeMembers: [user2, user1],\n+â”Š   â”Š221â”Š    listingMembers: [user2],\n+â”Š   â”Š222â”Š  }));\n+â”Š   â”Š223â”Š\n+â”Š   â”Š224â”Š  await connection.manager.save(new Chat({\n+â”Š   â”Š225â”Š    name: 'Ethan\\'s group',\n â”Š334â”Š226â”Š    picture: 'https://randomuser.me/api/portraits/thumb/lego/1.jpg',\n-â”Š335â”Š   â”Š    allTimeMemberIds: [1, 3, 4, 6],\n-â”Š336â”Š   â”Š    listingMemberIds: [1, 3, 4, 6],\n-â”Š337â”Š   â”Š    actualGroupMemberIds: [1, 4, 6],\n-â”Š338â”Š   â”Š    adminIds: [1, 6],\n-â”Š339â”Š   â”Š    ownerId: 1,\n+â”Š   â”Š227â”Š    allTimeMembers: [user1, user3, user4, user6],\n+â”Š   â”Š228â”Š    listingMembers: [user1, user3, user4, user6],\n+â”Š   â”Š229â”Š    actualGroupMembers: [user1, user4, user6],\n+â”Š   â”Š230â”Š    admins: [user1, user6],\n+â”Š   â”Š231â”Š    owner: user1,\n â”Š340â”Š232â”Š    messages: [\n-â”Š341â”Š   â”Š      {\n-â”Š342â”Š   â”Š        id: 1,\n-â”Š343â”Š   â”Š        chatId: 8,\n-â”Š344â”Š   â”Š        senderId: 1,\n+â”Š   â”Š233â”Š      new Message({\n+â”Š   â”Š234â”Š        sender: user1,\n â”Š345â”Š235â”Š        content: 'I made a group',\n-â”Š346â”Š   â”Š        createdAt: moment().subtract(2, 'weeks').unix(),\n+â”Š   â”Š236â”Š        createdAt: moment().subtract(2, 'weeks').toDate(),\n â”Š347â”Š237â”Š        type: MessageType.TEXT,\n+â”Š   â”Š238â”Š        holders: [user1, user3, user4, user6],\n â”Š348â”Š239â”Š        recipients: [\n-â”Š349â”Š   â”Š          {\n-â”Š350â”Š   â”Š            userId: 3,\n-â”Š351â”Š   â”Š            messageId: 1,\n-â”Š352â”Š   â”Š            chatId: 8,\n-â”Š353â”Š   â”Š            receivedAt: null,\n-â”Š354â”Š   â”Š            readAt: null,\n-â”Š355â”Š   â”Š          },\n-â”Š356â”Š   â”Š          {\n-â”Š357â”Š   â”Š            userId: 4,\n-â”Š358â”Š   â”Š            messageId: 1,\n-â”Š359â”Š   â”Š            chatId: 8,\n-â”Š360â”Š   â”Š            receivedAt: moment().subtract(2, 'weeks').add(1, 'minutes').unix(),\n-â”Š361â”Š   â”Š            readAt: moment().subtract(2, 'weeks').add(5, 'minutes').unix(),\n-â”Š362â”Š   â”Š          },\n-â”Š363â”Š   â”Š          {\n-â”Š364â”Š   â”Š            userId: 6,\n-â”Š365â”Š   â”Š            messageId: 1,\n-â”Š366â”Š   â”Š            chatId: 8,\n-â”Š367â”Š   â”Š            receivedAt: null,\n-â”Š368â”Š   â”Š            readAt: null,\n-â”Š369â”Š   â”Š          },\n+â”Š   â”Š240â”Š          new Recipient({\n+â”Š   â”Š241â”Š            user: user3,\n+â”Š   â”Š242â”Š          }),\n+â”Š   â”Š243â”Š          new Recipient({\n+â”Š   â”Š244â”Š            user: user4,\n+â”Š   â”Š245â”Š          }),\n+â”Š   â”Š246â”Š          new Recipient({\n+â”Š   â”Š247â”Š            user: user6,\n+â”Š   â”Š248â”Š          }),\n â”Š370â”Š249â”Š        ],\n-â”Š371â”Š   â”Š        holderIds: [1, 3, 4, 6],\n-â”Š372â”Š   â”Š      },\n-â”Š373â”Š   â”Š      {\n-â”Š374â”Š   â”Š        id: 2,\n-â”Š375â”Š   â”Š        chatId: 8,\n-â”Š376â”Š   â”Š        senderId: 1,\n-â”Š377â”Š   â”Š        content: 'Ops, user 3 was not supposed to be here',\n-â”Š378â”Š   â”Š        createdAt: moment().subtract(2, 'weeks').add(2, 'minutes').unix(),\n+â”Š   â”Š250â”Š      }),\n+â”Š   â”Š251â”Š      new Message({\n+â”Š   â”Š252â”Š        sender: user1,\n+â”Š   â”Š253â”Š        content: 'Ops, Avery was not supposed to be here',\n+â”Š   â”Š254â”Š        createdAt: moment().subtract(2, 'weeks').add(2, 'minutes').toDate(),\n â”Š379â”Š255â”Š        type: MessageType.TEXT,\n+â”Š   â”Š256â”Š        holders: [user1, user4, user6],\n â”Š380â”Š257â”Š        recipients: [\n-â”Š381â”Š   â”Š          {\n-â”Š382â”Š   â”Š            userId: 4,\n-â”Š383â”Š   â”Š            messageId: 2,\n-â”Š384â”Š   â”Š            chatId: 8,\n-â”Š385â”Š   â”Š            receivedAt: moment().subtract(2, 'weeks').add(3, 'minutes').unix(),\n-â”Š386â”Š   â”Š            readAt: moment().subtract(2, 'weeks').add(5, 'minutes').unix(),\n-â”Š387â”Š   â”Š          },\n-â”Š388â”Š   â”Š          {\n-â”Š389â”Š   â”Š            userId: 6,\n-â”Š390â”Š   â”Š            messageId: 2,\n-â”Š391â”Š   â”Š            chatId: 8,\n-â”Š392â”Š   â”Š            receivedAt: null,\n-â”Š393â”Š   â”Š            readAt: null,\n-â”Š394â”Š   â”Š          },\n+â”Š   â”Š258â”Š          new Recipient({\n+â”Š   â”Š259â”Š            user: user4,\n+â”Š   â”Š260â”Š          }),\n+â”Š   â”Š261â”Š          new Recipient({\n+â”Š   â”Š262â”Š            user: user6,\n+â”Š   â”Š263â”Š          }),\n â”Š395â”Š264â”Š        ],\n-â”Š396â”Š   â”Š        holderIds: [1, 4, 6],\n-â”Š397â”Š   â”Š      },\n-â”Š398â”Š   â”Š      {\n-â”Š399â”Š   â”Š        id: 3,\n-â”Š400â”Š   â”Š        chatId: 8,\n-â”Š401â”Š   â”Š        senderId: 4,\n+â”Š   â”Š265â”Š      }),\n+â”Š   â”Š266â”Š      new Message({\n+â”Š   â”Š267â”Š        sender: user4,\n â”Š402â”Š268â”Š        content: 'Awesome!',\n-â”Š403â”Š   â”Š        createdAt: moment().subtract(2, 'weeks').add(10, 'minutes').unix(),\n+â”Š   â”Š269â”Š        createdAt: moment().subtract(2, 'weeks').add(10, 'minutes').toDate(),\n â”Š404â”Š270â”Š        type: MessageType.TEXT,\n+â”Š   â”Š271â”Š        holders: [user1, user4, user6],\n â”Š405â”Š272â”Š        recipients: [\n-â”Š406â”Š   â”Š          {\n-â”Š407â”Š   â”Š            userId: 1,\n-â”Š408â”Š   â”Š            messageId: 3,\n-â”Š409â”Š   â”Š            chatId: 8,\n-â”Š410â”Š   â”Š            receivedAt: null,\n-â”Š411â”Š   â”Š            readAt: null,\n-â”Š412â”Š   â”Š          },\n-â”Š413â”Š   â”Š          {\n-â”Š414â”Š   â”Š            userId: 6,\n-â”Š415â”Š   â”Š            messageId: 3,\n-â”Š416â”Š   â”Š            chatId: 8,\n-â”Š417â”Š   â”Š            receivedAt: null,\n-â”Š418â”Š   â”Š            readAt: null,\n-â”Š419â”Š   â”Š          },\n+â”Š   â”Š273â”Š          new Recipient({\n+â”Š   â”Š274â”Š            user: user1,\n+â”Š   â”Š275â”Š          }),\n+â”Š   â”Š276â”Š          new Recipient({\n+â”Š   â”Š277â”Š            user: user6,\n+â”Š   â”Š278â”Š          }),\n â”Š420â”Š279â”Š        ],\n-â”Š421â”Š   â”Š        holderIds: [1, 4, 6],\n-â”Š422â”Š   â”Š      },\n+â”Š   â”Š280â”Š      }),\n â”Š423â”Š281â”Š    ],\n-â”Š424â”Š   â”Š  },\n-â”Š425â”Š   â”Š  {\n-â”Š426â”Š   â”Š    id: 9,\n-â”Š427â”Š   â”Š    name: 'A user 5 group',\n-â”Š428â”Š   â”Š    picture: null,\n-â”Š429â”Š   â”Š    allTimeMemberIds: [6, 3],\n-â”Š430â”Š   â”Š    listingMemberIds: [6, 3],\n-â”Š431â”Š   â”Š    actualGroupMemberIds: [6, 3],\n-â”Š432â”Š   â”Š    adminIds: [6],\n-â”Š433â”Š   â”Š    ownerId: 6,\n-â”Š434â”Š   â”Š    messages: [],\n-â”Š435â”Š   â”Š  },\n-â”Š436â”Š   â”Š];\n+â”Š   â”Š282â”Š  }));\n â”Š437â”Š283â”Š\n-â”Š438â”Š   â”Šexport const db = {users, chats};\n+â”Š   â”Š284â”Š  await connection.manager.save(new Chat({\n+â”Š   â”Š285â”Š    name: 'Ray\\'s group',\n+â”Š   â”Š286â”Š    allTimeMembers: [user3, user6],\n+â”Š   â”Š287â”Š    listingMembers: [user3, user6],\n+â”Š   â”Š288â”Š    actualGroupMembers: [user3, user6],\n+â”Š   â”Š289â”Š    admins: [user6],\n+â”Š   â”Š290â”Š    owner: user6,\n+â”Š   â”Š291â”Š  }));\n+â”Š   â”Š292â”Š}\n```\n\n[}]: #\n\nIt's time to deal with resolvers:\n\n[{]: <helper> (diffStep \"6.1\" files=\"schema/resolvers.ts\" module=\"server\")\n\n#### Step 6.1: TypeORM with PostgreSQL\n\n##### Changed schema&#x2F;resolvers.ts\n```diff\n@@ -1,4 +1,4 @@\n-â”Š1â”Š â”Šimport { Chat, db, Message, MessageType, Recipient, User } from \"../db\";\n+â”Š â”Š1â”Šimport { MessageType } from \"../db\";\n â”Š2â”Š2â”Šimport { IResolvers } from \"graphql-tools/dist/Interfaces\";\n â”Š3â”Š3â”Šimport {\n â”Š4â”Š4â”Š  AddChatMutationArgs, AddGroupMutationArgs, AddMessageMutationArgs, ChatQueryArgs, MessageAddedSubscriptionArgs,\n```\n```diff\n@@ -6,87 +6,123 @@\n â”Š  6â”Š  6â”Š} from \"../types\";\n â”Š  7â”Š  7â”Šimport * as moment from \"moment\";\n â”Š  8â”Š  8â”Šimport { PubSub, withFilter } from \"graphql-subscriptions\";\n-â”Š  9â”Š   â”Š\n-â”Š 10â”Š   â”Šlet users = db.users;\n-â”Š 11â”Š   â”Šlet chats = db.chats;\n+â”Š   â”Š  9â”Šimport { User } from \"../entity/User\";\n+â”Š   â”Š 10â”Šimport { Chat } from \"../entity/Chat\";\n+â”Š   â”Š 11â”Šimport { Message } from \"../entity/Message\";\n+â”Š   â”Š 12â”Šimport { Recipient } from \"../entity/Recipient\";\n+â”Š   â”Š 13â”Šimport { Connection } from \"typeorm\";\n â”Š 12â”Š 14â”Š\n â”Š 13â”Š 15â”Šexport const pubsub = new PubSub();\n â”Š 14â”Š 16â”Š\n â”Š 15â”Š 17â”Šexport const resolvers: IResolvers = {\n â”Š 16â”Š 18â”Š  Query: {\n â”Š 17â”Š 19â”Š    // Show all users for the moment.\n-â”Š 18â”Š   â”Š    users: (obj: any, args: any, {user: currentUser}: {user: User}): User[] => users.filter(user => user.id !== currentUser.id),\n-â”Š 19â”Š   â”Š    chats: (obj: any, args: any, {user: currentUser}: {user: User}): Chat[] => chats.filter(chat => chat.listingMemberIds.includes(currentUser.id)),\n-â”Š 20â”Š   â”Š    chat: (obj: any, {chatId}: ChatQueryArgs): Chat | null => chats.find(chat => chat.id === Number(chatId)) || null,\n+â”Š   â”Š 20â”Š    users: async (obj: any, args: any, {user: currentUser, connection}: { user: User, connection: Connection }): Promise<User[]> => {\n+â”Š   â”Š 21â”Š      return await connection\n+â”Š   â”Š 22â”Š        .createQueryBuilder(User, \"user\")\n+â”Š   â”Š 23â”Š        .where('user.id != :id', {id: currentUser.id})\n+â”Š   â”Š 24â”Š        .getMany();\n+â”Š   â”Š 25â”Š    },\n+â”Š   â”Š 26â”Š    chats: async (obj: any, args: any, {user: currentUser, connection}: { user: User, connection: Connection }): Promise<any[]> => {\n+â”Š   â”Š 27â”Š      return await connection\n+â”Š   â”Š 28â”Š        .createQueryBuilder(Chat, \"chat\")\n+â”Š   â”Š 29â”Š        .leftJoin('chat.listingMembers', 'listingMembers')\n+â”Š   â”Š 30â”Š        .where('listingMembers.id = :id', {id: currentUser.id})\n+â”Š   â”Š 31â”Š        .getMany();\n+â”Š   â”Š 32â”Š    },\n+â”Š   â”Š 33â”Š    chat: async (obj: any, {chatId}: ChatQueryArgs, {connection}: { user: User, connection: Connection }): Promise<any> => {\n+â”Š   â”Š 34â”Š      return await connection\n+â”Š   â”Š 35â”Š        .createQueryBuilder(Chat, \"chat\")\n+â”Š   â”Š 36â”Š        .whereInIds(chatId)\n+â”Š   â”Š 37â”Š        .getOne();\n+â”Š   â”Š 38â”Š    },\n â”Š 21â”Š 39â”Š  },\n â”Š 22â”Š 40â”Š  Mutation: {\n-â”Š 23â”Š   â”Š    addChat: (obj: any, {recipientId}: AddChatMutationArgs, {user: currentUser}: {user: User}): Chat => {\n-â”Š 24â”Š   â”Š      if (!users.find(user => user.id === Number(recipientId))) {\n+â”Š   â”Š 41â”Š    addChat: async (obj: any, {recipientId}: AddChatMutationArgs, {user: currentUser, connection}: { user: User, connection: Connection }): Promise<Chat | null> => {\n+â”Š   â”Š 42â”Š      const recipient = await connection\n+â”Š   â”Š 43â”Š        .createQueryBuilder(User, \"user\")\n+â”Š   â”Š 44â”Š        .whereInIds(recipientId)\n+â”Š   â”Š 45â”Š        .getOne();\n+â”Š   â”Š 46â”Š\n+â”Š   â”Š 47â”Š      if (!recipient) {\n â”Š 25â”Š 48â”Š        throw new Error(`Recipient ${recipientId} doesn't exist.`);\n â”Š 26â”Š 49â”Š      }\n â”Š 27â”Š 50â”Š\n-â”Š 28â”Š   â”Š      const chat = chats.find(chat => !chat.name && chat.allTimeMemberIds.includes(currentUser.id) && chat.allTimeMemberIds.includes(Number(recipientId)));\n+â”Š   â”Š 51â”Š      let chat = await connection\n+â”Š   â”Š 52â”Š        .createQueryBuilder(Chat, \"chat\")\n+â”Š   â”Š 53â”Š        .where('chat.name IS NULL')\n+â”Š   â”Š 54â”Š        .innerJoin('chat.allTimeMembers', 'allTimeMembers1', 'allTimeMembers1.id = :currentUserId', {currentUserId: currentUser.id})\n+â”Š   â”Š 55â”Š        .innerJoin('chat.allTimeMembers', 'allTimeMembers2', 'allTimeMembers2.id = :recipientId', {recipientId})\n+â”Š   â”Š 56â”Š        .innerJoinAndSelect('chat.listingMembers', 'listingMembers')\n+â”Š   â”Š 57â”Š        .getOne();\n+â”Š   â”Š 58â”Š\n â”Š 29â”Š 59â”Š      if (chat) {\n-â”Š 30â”Š   â”Š        // Chat already exists. Both users are already in the allTimeMemberIds array\n-â”Š 31â”Š   â”Š        const chatId = chat.id;\n-â”Š 32â”Š   â”Š        if (!chat.listingMemberIds.includes(currentUser.id)) {\n+â”Š   â”Š 60â”Š        // Chat already exists. Both users are already in the userIds array\n+â”Š   â”Š 61â”Š        const listingMembers = await connection\n+â”Š   â”Š 62â”Š          .createQueryBuilder(User, \"user\")\n+â”Š   â”Š 63â”Š          .innerJoin('user.listingMemberChats', 'listingMemberChats', 'listingMemberChats.id = :chatId', {chatId: chat.id})\n+â”Š   â”Š 64â”Š          .getMany();\n+â”Š   â”Š 65â”Š\n+â”Š   â”Š 66â”Š        if (!listingMembers.find(user => user.id === currentUser.id)) {\n â”Š 33â”Š 67â”Š          // The chat isn't listed for the current user. Add him to the memberIds\n-â”Š 34â”Š   â”Š          chat.listingMemberIds.push(currentUser.id);\n-â”Š 35â”Š   â”Š          chats.find(chat => chat.id === chatId)!.listingMemberIds.push(currentUser.id);\n-â”Š 36â”Š   â”Š          return chat;\n+â”Š   â”Š 68â”Š          chat.listingMembers.push(currentUser);\n+â”Š   â”Š 69â”Š          chat = await connection.getRepository(Chat).save(chat);\n+â”Š   â”Š 70â”Š\n+â”Š   â”Š 71â”Š          return chat || null;\n â”Š 37â”Š 72â”Š        } else {\n â”Š 38â”Š 73â”Š          throw new Error(`Chat already exists.`);\n â”Š 39â”Š 74â”Š        }\n â”Š 40â”Š 75â”Š      } else {\n â”Š 41â”Š 76â”Š        // Create the chat\n-â”Š 42â”Š   â”Š        const id = (chats.length && chats[chats.length - 1].id + 1) || 1;\n-â”Š 43â”Š   â”Š        const chat: Chat = {\n-â”Š 44â”Š   â”Š          id,\n-â”Š 45â”Š   â”Š          name: null,\n-â”Š 46â”Š   â”Š          picture: null,\n-â”Š 47â”Š   â”Š          adminIds: null,\n-â”Š 48â”Š   â”Š          ownerId: null,\n-â”Š 49â”Š   â”Š          allTimeMemberIds: [currentUser.id, Number(recipientId)],\n+â”Š   â”Š 77â”Š        chat = await connection.getRepository(Chat).save(new Chat({\n+â”Š   â”Š 78â”Š          allTimeMembers: [currentUser, recipient],\n â”Š 50â”Š 79â”Š          // Chat will not be listed to the other user until the first message gets written\n-â”Š 51â”Š   â”Š          listingMemberIds: [currentUser.id],\n-â”Š 52â”Š   â”Š          actualGroupMemberIds: null,\n-â”Š 53â”Š   â”Š          messages: [],\n-â”Š 54â”Š   â”Š        };\n-â”Š 55â”Š   â”Š        chats.push(chat);\n+â”Š   â”Š 80â”Š          listingMembers: [currentUser],\n+â”Š   â”Š 81â”Š        }));\n â”Š 56â”Š 82â”Š\n-â”Š 57â”Š   â”Š        return chat;\n+â”Š   â”Š 83â”Š        return chat || null;\n â”Š 58â”Š 84â”Š      }\n â”Š 59â”Š 85â”Š    },\n-â”Š 60â”Š   â”Š    addGroup: (obj: any, {recipientIds, groupName}: AddGroupMutationArgs, {user: currentUser}: {user: User}): Chat => {\n-â”Š 61â”Š   â”Š      recipientIds.forEach(recipientId => {\n-â”Š 62â”Š   â”Š        if (!users.find(user => user.id === Number(recipientId))) {\n+â”Š   â”Š 86â”Š    addGroup: async (obj: any, {recipientIds, groupName}: AddGroupMutationArgs, {user: currentUser, connection}: { user: User, connection: Connection }): Promise<Chat | null> => {\n+â”Š   â”Š 87â”Š      let recipients: User[] = [];\n+â”Š   â”Š 88â”Š      for (let recipientId of recipientIds) {\n+â”Š   â”Š 89â”Š        const recipient = await connection\n+â”Š   â”Š 90â”Š          .createQueryBuilder(User, \"user\")\n+â”Š   â”Š 91â”Š          .whereInIds(recipientId)\n+â”Š   â”Š 92â”Š          .getOne();\n+â”Š   â”Š 93â”Š        if (!recipient) {\n â”Š 63â”Š 94â”Š          throw new Error(`Recipient ${recipientId} doesn't exist.`);\n â”Š 64â”Š 95â”Š        }\n-â”Š 65â”Š   â”Š      });\n+â”Š   â”Š 96â”Š        recipients.push(recipient);\n+â”Š   â”Š 97â”Š      }\n â”Š 66â”Š 98â”Š\n-â”Š 67â”Š   â”Š      const id = (chats.length && chats[chats.length - 1].id + 1) || 1;\n-â”Š 68â”Š   â”Š      const chat: Chat = {\n-â”Š 69â”Š   â”Š        id,\n+â”Š   â”Š 99â”Š      const chat = await connection.getRepository(Chat).save(new Chat({\n â”Š 70â”Š100â”Š        name: groupName,\n-â”Š 71â”Š   â”Š        picture: null,\n-â”Š 72â”Š   â”Š        adminIds: [currentUser.id],\n-â”Š 73â”Š   â”Š        ownerId: currentUser.id,\n-â”Š 74â”Š   â”Š        allTimeMemberIds: [currentUser.id, ...recipientIds.map(id => Number(id))],\n-â”Š 75â”Š   â”Š        listingMemberIds: [currentUser.id, ...recipientIds.map(id => Number(id))],\n-â”Š 76â”Š   â”Š        actualGroupMemberIds: [currentUser.id, ...recipientIds.map(id => Number(id))],\n-â”Š 77â”Š   â”Š        messages: [],\n-â”Š 78â”Š   â”Š      };\n-â”Š 79â”Š   â”Š      chats.push(chat);\n+â”Š   â”Š101â”Š        admins: [currentUser],\n+â”Š   â”Š102â”Š        owner: currentUser,\n+â”Š   â”Š103â”Š        allTimeMembers: [...recipients, currentUser],\n+â”Š   â”Š104â”Š        listingMembers: [...recipients, currentUser],\n+â”Š   â”Š105â”Š        actualGroupMembers: [...recipients, currentUser],\n+â”Š   â”Š106â”Š      }));\n â”Š 80â”Š107â”Š\n â”Š 81â”Š108â”Š      pubsub.publish('chatAdded', {\n â”Š 82â”Š109â”Š        creatorId: currentUser.id,\n â”Š 83â”Š110â”Š        chatAdded: chat,\n â”Š 84â”Š111â”Š      });\n â”Š 85â”Š112â”Š\n-â”Š 86â”Š   â”Š      return chat;\n+â”Š   â”Š113â”Š      return chat || null;\n â”Š 87â”Š114â”Š    },\n-â”Š 88â”Š   â”Š    removeChat: (obj: any, {chatId}: RemoveChatMutationArgs, {user: currentUser}: {user: User}): number => {\n-â”Š 89â”Š   â”Š      const chat = chats.find(chat => chat.id === Number(chatId));\n+â”Š   â”Š115â”Š    removeChat: async (obj: any, {chatId}: RemoveChatMutationArgs, {user: currentUser, connection}: { user: User, connection: Connection }) => {\n+â”Š   â”Š116â”Š      const chat = await connection\n+â”Š   â”Š117â”Š        .createQueryBuilder(Chat, \"chat\")\n+â”Š   â”Š118â”Š        .whereInIds(Number(chatId))\n+â”Š   â”Š119â”Š        .innerJoinAndSelect('chat.listingMembers', 'listingMembers')\n+â”Š   â”Š120â”Š        .leftJoinAndSelect('chat.actualGroupMembers', 'actualGroupMembers')\n+â”Š   â”Š121â”Š        .leftJoinAndSelect('chat.admins', 'admins')\n+â”Š   â”Š122â”Š        .leftJoinAndSelect('chat.owner', 'owner')\n+â”Š   â”Š123â”Š        .leftJoinAndSelect('chat.messages', 'messages')\n+â”Š   â”Š124â”Š        .leftJoinAndSelect('messages.holders', 'holders')\n+â”Š   â”Š125â”Š        .getOne();\n â”Š 90â”Š126â”Š\n â”Š 91â”Š127â”Š      if (!chat) {\n â”Š 92â”Š128â”Š        throw new Error(`The chat ${chatId} doesn't exist.`);\n```\n```diff\n@@ -94,186 +130,188 @@\n â”Š 94â”Š130â”Š\n â”Š 95â”Š131â”Š      if (!chat.name) {\n â”Š 96â”Š132â”Š        // Chat\n-â”Š 97â”Š   â”Š        if (!chat.listingMemberIds.includes(currentUser.id)) {\n-â”Š 98â”Š   â”Š          throw new Error(`The user is not a member of the chat ${chatId}.`);\n+â”Š   â”Š133â”Š        if (!chat.listingMembers.find(user => user.id === currentUser.id)) {\n+â”Š   â”Š134â”Š          throw new Error(`The user is not a listing member of the chat ${chatId}.`);\n â”Š 99â”Š135â”Š        }\n â”Š100â”Š136â”Š\n â”Š101â”Š137â”Š        // Instead of chaining map and filter we can loop once using reduce\n-â”Š102â”Š   â”Š        const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n-â”Š103â”Š   â”Š          // Remove the current user from the message holders\n-â”Š104â”Š   â”Š          message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser.id);\n+â”Š   â”Š138â”Š        chat.messages = await chat.messages.reduce<Promise<Message[]>>(async (filtered$, message) => {\n+â”Š   â”Š139â”Š          const filtered = await filtered$;\n â”Š105â”Š140â”Š\n-â”Š106â”Š   â”Š          if (message.holderIds.length !== 0) {\n+â”Š   â”Š141â”Š          message.holders = message.holders.filter(user => user.id !== currentUser.id);\n+â”Š   â”Š142â”Š\n+â”Š   â”Š143â”Š          if (message.holders.length !== 0) {\n+â”Š   â”Š144â”Š            // Remove the current user from the message holders\n+â”Š   â”Š145â”Š            await connection.getRepository(Message).save(message);\n â”Š107â”Š146â”Š            filtered.push(message);\n-â”Š108â”Š   â”Š          } // else discard the message\n+â”Š   â”Š147â”Š          } else {\n+â”Š   â”Š148â”Š            // Simply remove the message\n+â”Š   â”Š149â”Š            const recipients = await connection\n+â”Š   â”Š150â”Š              .createQueryBuilder(Recipient, \"recipient\")\n+â”Š   â”Š151â”Š              .innerJoinAndSelect('recipient.message', 'message', 'message.id = :messageId', {messageId: message.id})\n+â”Š   â”Š152â”Š              .innerJoinAndSelect('recipient.user', 'user')\n+â”Š   â”Š153â”Š              .getMany();\n+â”Š   â”Š154â”Š            for (let recipient of recipients) {\n+â”Š   â”Š155â”Š              await connection.getRepository(Recipient).remove(recipient);\n+â”Š   â”Š156â”Š            }\n+â”Š   â”Š157â”Š            await connection.getRepository(Message).remove(message);\n+â”Š   â”Š158â”Š          }\n â”Š109â”Š159â”Š\n â”Š110â”Š160â”Š          return filtered;\n-â”Š111â”Š   â”Š        }, []);\n+â”Š   â”Š161â”Š        }, Promise.resolve([]));\n â”Š112â”Š162â”Š\n â”Š113â”Š163â”Š        // Remove the current user from who gets the chat listed. The chat will no longer appear in his list\n-â”Š114â”Š   â”Š        const listingMemberIds = chat.listingMemberIds.filter(listingId => listingId !== currentUser.id);\n+â”Š   â”Š164â”Š        chat.listingMembers = chat.listingMembers.filter(user => user.id !== currentUser.id);\n â”Š115â”Š165â”Š\n â”Š116â”Š166â”Š        // Check how many members are left\n-â”Š117â”Š   â”Š        if (listingMemberIds.length === 0) {\n+â”Š   â”Š167â”Š        if (chat.listingMembers.length === 0) {\n â”Š118â”Š168â”Š          // Delete the chat\n-â”Š119â”Š   â”Š          chats = chats.filter(chat => chat.id !== Number(chatId));\n+â”Š   â”Š169â”Š          await connection.getRepository(Chat).remove(chat);\n â”Š120â”Š170â”Š        } else {\n â”Š121â”Š171â”Š          // Update the chat\n-â”Š122â”Š   â”Š          chats = chats.map(chat => {\n-â”Š123â”Š   â”Š            if (chat.id === Number(chatId)) {\n-â”Š124â”Š   â”Š              chat = {...chat, listingMemberIds, messages};\n-â”Š125â”Š   â”Š            }\n-â”Š126â”Š   â”Š            return chat;\n-â”Š127â”Š   â”Š          });\n+â”Š   â”Š172â”Š          await connection.getRepository(Chat).save(chat);\n â”Š128â”Š173â”Š        }\n-â”Š129â”Š   â”Š        return Number(chatId);\n+â”Š   â”Š174â”Š        return chatId;\n â”Š130â”Š175â”Š      } else {\n â”Š131â”Š176â”Š        // Group\n-â”Š132â”Š   â”Š        if (chat.ownerId !== currentUser.id) {\n-â”Š133â”Š   â”Š          throw new Error(`Group ${chatId} is not owned by the user.`);\n-â”Š134â”Š   â”Š        }\n â”Š135â”Š177â”Š\n â”Š136â”Š178â”Š        // Instead of chaining map and filter we can loop once using reduce\n-â”Š137â”Š   â”Š        const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n-â”Š138â”Š   â”Š          // Remove the current user from the message holders\n-â”Š139â”Š   â”Š          message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser.id);\n+â”Š   â”Š179â”Š        chat.messages = await chat.messages.reduce<Promise<Message[]>>(async (filtered$, message) => {\n+â”Š   â”Š180â”Š          const filtered = await filtered$;\n+â”Š   â”Š181â”Š\n+â”Š   â”Š182â”Š          message.holders = message.holders.filter(user => user.id !== currentUser.id);\n â”Š140â”Š183â”Š\n-â”Š141â”Š   â”Š          if (message.holderIds.length !== 0) {\n+â”Š   â”Š184â”Š          if (message.holders.length !== 0) {\n+â”Š   â”Š185â”Š            // Remove the current user from the message holders\n+â”Š   â”Š186â”Š            await connection.getRepository(Message).save(message);\n â”Š142â”Š187â”Š            filtered.push(message);\n-â”Š143â”Š   â”Š          } // else discard the message\n+â”Š   â”Š188â”Š          } else {\n+â”Š   â”Š189â”Š            // Simply remove the message\n+â”Š   â”Š190â”Š            const recipients = await connection\n+â”Š   â”Š191â”Š              .createQueryBuilder(Recipient, \"recipient\")\n+â”Š   â”Š192â”Š              .innerJoinAndSelect('recipient.message', 'message', 'message.id = :messageId', {messageId: message.id})\n+â”Š   â”Š193â”Š              .innerJoinAndSelect('recipient.user', 'user')\n+â”Š   â”Š194â”Š              .getMany();\n+â”Š   â”Š195â”Š            for (let recipient of recipients) {\n+â”Š   â”Š196â”Š              await connection.getRepository(Recipient).remove(recipient);\n+â”Š   â”Š197â”Š            }\n+â”Š   â”Š198â”Š            await connection.getRepository(Message).remove(message);\n+â”Š   â”Š199â”Š          }\n â”Š144â”Š200â”Š\n â”Š145â”Š201â”Š          return filtered;\n-â”Š146â”Š   â”Š        }, []);\n+â”Š   â”Š202â”Š        }, Promise.resolve([]));\n â”Š147â”Š203â”Š\n â”Š148â”Š204â”Š        // Remove the current user from who gets the group listed. The group will no longer appear in his list\n-â”Š149â”Š   â”Š        const listingMemberIds = chat.listingMemberIds.filter(listingId => listingId !== currentUser.id);\n+â”Š   â”Š205â”Š        chat.listingMembers = chat.listingMembers.filter(user => user.id !== currentUser.id);\n â”Š150â”Š206â”Š\n â”Š151â”Š207â”Š        // Check how many members (including previous ones who can still access old messages) are left\n-â”Š152â”Š   â”Š        if (listingMemberIds.length === 0) {\n+â”Š   â”Š208â”Š        if (chat.listingMembers.length === 0) {\n â”Š153â”Š209â”Š          // Remove the group\n-â”Š154â”Š   â”Š          chats = chats.filter(chat => chat.id !== Number(chatId));\n+â”Š   â”Š210â”Š          await connection.getRepository(Chat).remove(chat);\n â”Š155â”Š211â”Š        } else {\n â”Š156â”Š212â”Š          // Update the group\n â”Š157â”Š213â”Š\n â”Š158â”Š214â”Š          // Remove the current user from the chat members. He is no longer a member of the group\n-â”Š159â”Š   â”Š          const actualGroupMemberIds = chat.actualGroupMemberIds!.filter(memberId => memberId !== currentUser.id);\n+â”Š   â”Š215â”Š          chat.actualGroupMembers = chat.actualGroupMembers && chat.actualGroupMembers.filter(user => user.id !== currentUser.id);\n â”Š160â”Š216â”Š          // Remove the current user from the chat admins\n-â”Š161â”Š   â”Š          const adminIds = chat.adminIds!.filter(memberId => memberId !== currentUser.id);\n-â”Š162â”Š   â”Š          // Set the owner id to be null. A null owner means the group is read-only\n-â”Š163â”Š   â”Š          let ownerId: number | null = null;\n-â”Š164â”Š   â”Š\n-â”Š165â”Š   â”Š          // Check if there is any admin left\n-â”Š166â”Š   â”Š          if (adminIds!.length) {\n-â”Š167â”Š   â”Š            // Pick an admin as the new owner. The group is no longer read-only\n-â”Š168â”Š   â”Š            ownerId = chat.adminIds![0];\n-â”Š169â”Š   â”Š          }\n+â”Š   â”Š217â”Š          chat.admins = chat.admins && chat.admins.filter(user => user.id !== currentUser.id);\n+â”Š   â”Š218â”Š          // If there are no more admins left the group goes read only\n+â”Š   â”Š219â”Š          chat.owner = chat.admins && chat.admins[0] || null; // A null owner means the group is read-only\n â”Š170â”Š220â”Š\n-â”Š171â”Š   â”Š          chats = chats.map(chat => {\n-â”Š172â”Š   â”Š            if (chat.id === Number(chatId)) {\n-â”Š173â”Š   â”Š              chat = {...chat, messages, listingMemberIds, actualGroupMemberIds, adminIds, ownerId};\n-â”Š174â”Š   â”Š            }\n-â”Š175â”Š   â”Š            return chat;\n-â”Š176â”Š   â”Š          });\n+â”Š   â”Š221â”Š          await connection.getRepository(Chat).save(chat);\n â”Š177â”Š222â”Š        }\n-â”Š178â”Š   â”Š        return Number(chatId);\n+â”Š   â”Š223â”Š        return chatId;\n â”Š179â”Š224â”Š      }\n â”Š180â”Š225â”Š    },\n-â”Š181â”Š   â”Š    addMessage: (obj: any, {chatId, content}: AddMessageMutationArgs, {user: currentUser}: {user: User}): Message => {\n+â”Š   â”Š226â”Š    addMessage: async (obj: any, {chatId, content}: AddMessageMutationArgs, {user: currentUser, connection}: { user: User, connection: Connection }): Promise<Message | null> => {\n â”Š182â”Š227â”Š      if (content === null || content === '') {\n â”Š183â”Š228â”Š        throw new Error(`Cannot add empty or null messages.`);\n â”Š184â”Š229â”Š      }\n â”Š185â”Š230â”Š\n-â”Š186â”Š   â”Š      let chat = chats.find(chat => chat.id === Number(chatId));\n+â”Š   â”Š231â”Š      let chat = await connection\n+â”Š   â”Š232â”Š        .createQueryBuilder(Chat, \"chat\")\n+â”Š   â”Š233â”Š        .whereInIds(chatId)\n+â”Š   â”Š234â”Š        .innerJoinAndSelect('chat.allTimeMembers', 'allTimeMembers')\n+â”Š   â”Š235â”Š        .innerJoinAndSelect('chat.listingMembers', 'listingMembers')\n+â”Š   â”Š236â”Š        .leftJoinAndSelect('chat.actualGroupMembers', 'actualGroupMembers')\n+â”Š   â”Š237â”Š        .getOne();\n â”Š187â”Š238â”Š\n â”Š188â”Š239â”Š      if (!chat) {\n â”Š189â”Š240â”Š        throw new Error(`Cannot find chat ${chatId}.`);\n â”Š190â”Š241â”Š      }\n â”Š191â”Š242â”Š\n-â”Š192â”Š   â”Š      let holderIds = chat.listingMemberIds;\n+â”Š   â”Š243â”Š      let holders: User[];\n â”Š193â”Š244â”Š\n â”Š194â”Š245â”Š      if (!chat.name) {\n â”Š195â”Š246â”Š        // Chat\n-â”Š196â”Š   â”Š        if (!chat.listingMemberIds.find(listingId => listingId === currentUser.id)) {\n+â”Š   â”Š247â”Š        if (!chat.listingMembers.map(user => user.id).includes(currentUser.id)) {\n â”Š197â”Š248â”Š          throw new Error(`The chat ${chatId} must be listed for the current user before adding a message.`);\n â”Š198â”Š249â”Š        }\n â”Š199â”Š250â”Š\n-â”Š200â”Š   â”Š        const recipientId = chat.allTimeMemberIds.filter(userId => userId !== currentUser.id)[0];\n+â”Š   â”Š251â”Š        const recipientUser = chat.allTimeMembers.find(user => user.id !== currentUser.id);\n â”Š201â”Š252â”Š\n-â”Š202â”Š   â”Š        if (!chat.listingMemberIds.find(listingId => listingId === recipientId)) {\n-â”Š203â”Š   â”Š          // Chat is not listed for the recipient. Add him to the listingMemberIds\n-â”Š204â”Š   â”Š          const listingMemberIds = chat.listingMemberIds.concat(recipientId);\n+â”Š   â”Š253â”Š        if (!recipientUser) {\n+â”Š   â”Š254â”Š          throw new Error(`Cannot find recipient user.`);\n+â”Š   â”Š255â”Š        }\n â”Š205â”Š256â”Š\n-â”Š206â”Š   â”Š          chats = chats.map(chat => {\n-â”Š207â”Š   â”Š            if (chat.id === Number(chatId)) {\n-â”Š208â”Š   â”Š              chat = {...chat, listingMemberIds};\n-â”Š209â”Š   â”Š            }\n-â”Š210â”Š   â”Š            return chat;\n-â”Š211â”Š   â”Š          });\n+â”Š   â”Š257â”Š        if (!chat.listingMembers.find(user => user.id === recipientUser.id)) {\n+â”Š   â”Š258â”Š          // Chat is not listed for the recipient. Add him to the listingIds\n+â”Š   â”Š259â”Š          chat.listingMembers.push(recipientUser);\n â”Š212â”Š260â”Š\n-â”Š213â”Š   â”Š          holderIds = listingMemberIds;\n+â”Š   â”Š261â”Š          await connection.getRepository(Chat).save(chat);\n â”Š214â”Š262â”Š\n â”Š215â”Š263â”Š          pubsub.publish('chatAdded', {\n â”Š216â”Š264â”Š            creatorId: currentUser.id,\n â”Š217â”Š265â”Š            chatAdded: chat,\n â”Š218â”Š266â”Š          });\n â”Š219â”Š267â”Š        }\n+â”Š   â”Š268â”Š\n+â”Š   â”Š269â”Š        holders = chat.listingMembers;\n â”Š220â”Š270â”Š      } else {\n â”Š221â”Š271â”Š        // Group\n-â”Š222â”Š   â”Š        if (!chat.actualGroupMemberIds!.find(memberId => memberId === currentUser.id)) {\n+â”Š   â”Š272â”Š        if (!chat.actualGroupMembers || !chat.actualGroupMembers.find(user => user.id === currentUser.id)) {\n â”Š223â”Š273â”Š          throw new Error(`The user is not a member of the group ${chatId}. Cannot add message.`);\n â”Š224â”Š274â”Š        }\n â”Š225â”Š275â”Š\n-â”Š226â”Š   â”Š        holderIds = chat.actualGroupMemberIds!;\n+â”Š   â”Š276â”Š        holders = chat.actualGroupMembers;\n â”Š227â”Š277â”Š      }\n â”Š228â”Š278â”Š\n-â”Š229â”Š   â”Š      const id = (chat.messages.length && chat.messages[chat.messages.length - 1].id + 1) || 1;\n-â”Š230â”Š   â”Š\n-â”Š231â”Š   â”Š      let recipients: Recipient[] = [];\n-â”Š232â”Š   â”Š\n-â”Š233â”Š   â”Š      holderIds.forEach(holderId => {\n-â”Š234â”Š   â”Š        if (holderId !== currentUser.id) {\n-â”Š235â”Š   â”Š          recipients.push({\n-â”Š236â”Š   â”Š            userId: holderId,\n-â”Š237â”Š   â”Š            messageId: id,\n-â”Š238â”Š   â”Š            chatId: Number(chatId),\n-â”Š239â”Š   â”Š            receivedAt: null,\n-â”Š240â”Š   â”Š            readAt: null,\n-â”Š241â”Š   â”Š          });\n-â”Š242â”Š   â”Š        }\n-â”Š243â”Š   â”Š      });\n-â”Š244â”Š   â”Š\n-â”Š245â”Š   â”Š      const message: Message = {\n-â”Š246â”Š   â”Š        id,\n-â”Š247â”Š   â”Š        chatId: Number(chatId),\n-â”Š248â”Š   â”Š        senderId: currentUser.id,\n+â”Š   â”Š279â”Š      const message = await connection.getRepository(Message).save(new Message({\n+â”Š   â”Š280â”Š        chat: chat,\n+â”Š   â”Š281â”Š        sender: currentUser,\n â”Š249â”Š282â”Š        content,\n-â”Š250â”Š   â”Š        createdAt: moment().unix(),\n â”Š251â”Š283â”Š        type: MessageType.TEXT,\n-â”Š252â”Š   â”Š        recipients,\n-â”Š253â”Š   â”Š        holderIds,\n-â”Š254â”Š   â”Š      };\n-â”Š255â”Š   â”Š\n-â”Š256â”Š   â”Š      chats = chats.map(chat => {\n-â”Š257â”Š   â”Š        if (chat.id === Number(chatId)) {\n-â”Š258â”Š   â”Š          chat = {...chat, messages: chat.messages.concat(message)}\n-â”Š259â”Š   â”Š        }\n-â”Š260â”Š   â”Š        return chat;\n-â”Š261â”Š   â”Š      });\n+â”Š   â”Š284â”Š        holders,\n+â”Š   â”Š285â”Š        recipients: holders.reduce<Recipient[]>((filtered, user) => {\n+â”Š   â”Š286â”Š          if (user.id !== currentUser.id) {\n+â”Š   â”Š287â”Š            filtered.push(new Recipient({\n+â”Š   â”Š288â”Š              user,\n+â”Š   â”Š289â”Š            }));\n+â”Š   â”Š290â”Š          }\n+â”Š   â”Š291â”Š          return filtered;\n+â”Š   â”Š292â”Š        }, []),\n+â”Š   â”Š293â”Š      }));\n â”Š262â”Š294â”Š\n â”Š263â”Š295â”Š      pubsub.publish('messageAdded', {\n â”Š264â”Š296â”Š        messageAdded: message,\n â”Š265â”Š297â”Š      });\n â”Š266â”Š298â”Š\n-â”Š267â”Š   â”Š      return message;\n+â”Š   â”Š299â”Š      return message || null;\n â”Š268â”Š300â”Š    },\n-â”Š269â”Š   â”Š    removeMessages: (obj: any, {chatId, messageIds, all}: RemoveMessagesMutationArgs, {user: currentUser}: {user: User}): number[] => {\n-â”Š270â”Š   â”Š      const chat = chats.find(chat => chat.id === Number(chatId));\n+â”Š   â”Š301â”Š    removeMessages: async (obj: any, {chatId, messageIds, all}: RemoveMessagesMutationArgs, {user: currentUser, connection}: { user: User, connection: Connection }) => {\n+â”Š   â”Š302â”Š      const chat = await connection\n+â”Š   â”Š303â”Š        .createQueryBuilder(Chat, \"chat\")\n+â”Š   â”Š304â”Š        .whereInIds(chatId)\n+â”Š   â”Š305â”Š        .innerJoinAndSelect('chat.listingMembers', 'listingMembers')\n+â”Š   â”Š306â”Š        .innerJoinAndSelect('chat.messages', 'messages')\n+â”Š   â”Š307â”Š        .innerJoinAndSelect('messages.holders', 'holders')\n+â”Š   â”Š308â”Š        .getOne();\n â”Š271â”Š309â”Š\n â”Š272â”Š310â”Š      if (!chat) {\n â”Š273â”Š311â”Š        throw new Error(`Cannot find chat ${chatId}.`);\n â”Š274â”Š312â”Š      }\n â”Š275â”Š313â”Š\n-â”Š276â”Š   â”Š      if (!chat.listingMemberIds.find(listingId => listingId === currentUser.id)) {\n+â”Š   â”Š314â”Š      if (!chat.listingMembers.find(user => user.id === currentUser.id)) {\n â”Š277â”Š315â”Š        throw new Error(`The chat/group ${chatId} is not listed for the current user, so there is nothing to delete.`);\n â”Š278â”Š316â”Š      }\n â”Š279â”Š317â”Š\n```\n```diff\n@@ -281,79 +319,166 @@\n â”Š281â”Š319â”Š        throw new Error(`Cannot specify both 'all' and 'messageIds'.`);\n â”Š282â”Š320â”Š      }\n â”Š283â”Š321â”Š\n+â”Š   â”Š322â”Š      if (!all && !(messageIds && messageIds.length)) {\n+â”Š   â”Š323â”Š        throw new Error(`'all' and 'messageIds' cannot be both null`);\n+â”Š   â”Š324â”Š      }\n+â”Š   â”Š325â”Š\n â”Š284â”Š326â”Š      let deletedIds: number[] = [];\n-â”Š285â”Š   â”Š      chats = chats.map(chat => {\n-â”Š286â”Š   â”Š        if (chat.id === Number(chatId)) {\n-â”Š287â”Š   â”Š          // Instead of chaining map and filter we can loop once using reduce\n-â”Š288â”Š   â”Š          const messages = chat.messages.reduce<Message[]>((filtered, message) => {\n-â”Š289â”Š   â”Š            if (all || messageIds!.includes(String(message.id))) {\n-â”Š290â”Š   â”Š              deletedIds.push(message.id);\n-â”Š291â”Š   â”Š              // Remove the current user from the message holders\n-â”Š292â”Š   â”Š              message.holderIds = message.holderIds.filter(holderId => holderId !== currentUser.id);\n-â”Š293â”Š   â”Š            }\n+â”Š   â”Š327â”Š      // Instead of chaining map and filter we can loop once using reduce\n+â”Š   â”Š328â”Š      chat.messages = await chat.messages.reduce<Promise<Message[]>>(async (filtered$, message) => {\n+â”Š   â”Š329â”Š        const filtered = await filtered$;\n â”Š294â”Š330â”Š\n-â”Š295â”Š   â”Š            if (message.holderIds.length !== 0) {\n-â”Š296â”Š   â”Š              filtered.push(message);\n-â”Š297â”Š   â”Š            } // else discard the message\n+â”Š   â”Š331â”Š        if (all || messageIds!.includes(String(message.id))) {\n+â”Š   â”Š332â”Š          deletedIds.push(message.id);\n+â”Š   â”Š333â”Š          // Remove the current user from the message holders\n+â”Š   â”Š334â”Š          message.holders = message.holders.filter(user => user.id !== currentUser.id);\n â”Š298â”Š335â”Š\n-â”Š299â”Š   â”Š            return filtered;\n-â”Š300â”Š   â”Š          }, []);\n-â”Š301â”Š   â”Š          chat = {...chat, messages};\n â”Š302â”Š336â”Š        }\n-â”Š303â”Š   â”Š        return chat;\n-â”Š304â”Š   â”Š      });\n+â”Š   â”Š337â”Š\n+â”Š   â”Š338â”Š        if (message.holders.length !== 0) {\n+â”Š   â”Š339â”Š          // Remove the current user from the message holders\n+â”Š   â”Š340â”Š          await connection.getRepository(Message).save(message);\n+â”Š   â”Š341â”Š          filtered.push(message);\n+â”Š   â”Š342â”Š        } else {\n+â”Š   â”Š343â”Š          // Simply remove the message\n+â”Š   â”Š344â”Š          const recipients = await connection\n+â”Š   â”Š345â”Š            .createQueryBuilder(Recipient, \"recipient\")\n+â”Š   â”Š346â”Š            .innerJoinAndSelect('recipient.message', 'message', 'message.id = :messageId', {messageId: message.id})\n+â”Š   â”Š347â”Š            .innerJoinAndSelect('recipient.user', 'user')\n+â”Š   â”Š348â”Š            .getMany();\n+â”Š   â”Š349â”Š          for (let recipient of recipients) {\n+â”Š   â”Š350â”Š            await connection.getRepository(Recipient).remove(recipient);\n+â”Š   â”Š351â”Š          }\n+â”Š   â”Š352â”Š          await connection.getRepository(Message).remove(message);\n+â”Š   â”Š353â”Š        }\n+â”Š   â”Š354â”Š\n+â”Š   â”Š355â”Š        return filtered;\n+â”Š   â”Š356â”Š      }, Promise.resolve([]));\n+â”Š   â”Š357â”Š\n+â”Š   â”Š358â”Š      await connection.getRepository(Chat).save(chat);\n+â”Š   â”Š359â”Š\n â”Š305â”Š360â”Š      return deletedIds;\n â”Š306â”Š361â”Š    },\n â”Š307â”Š362â”Š  },\n â”Š308â”Š363â”Š  Subscription: {\n â”Š309â”Š364â”Š    messageAdded: {\n â”Š310â”Š365â”Š      subscribe: withFilter(() => pubsub.asyncIterator('messageAdded'),\n-â”Š311â”Š   â”Š        ({messageAdded}: {messageAdded: Message & {chat: {id: number}}}, {chatId}: MessageAddedSubscriptionArgs, {user: currentUser}: { user: User }) => {\n+â”Š   â”Š366â”Š        ({messageAdded}: {messageAdded: Message}, {chatId}: MessageAddedSubscriptionArgs, {user: currentUser}: { user: User }) => {\n â”Š312â”Š367â”Š          return (!chatId || messageAdded.chat.id === Number(chatId)) &&\n-â”Š313â”Š   â”Š            !!messageAdded.recipients.find((recipient: Recipient) => recipient.userId === currentUser.id);\n+â”Š   â”Š368â”Š            !!messageAdded.recipients.find((recipient: Recipient) => recipient.user.id === currentUser.id);\n â”Š314â”Š369â”Š        }),\n â”Š315â”Š370â”Š    },\n â”Š316â”Š371â”Š    chatAdded: {\n â”Š317â”Š372â”Š      subscribe: withFilter(() => pubsub.asyncIterator('chatAdded'),\n-â”Š318â”Š   â”Š        ({creatorId, chatAdded}: {creatorId: string, chatAdded: Chat}, variables: any, {user: currentUser}: { user: User }) => {\n-â”Š319â”Š   â”Š          return Number(creatorId) !== currentUser.id && !chatAdded.listingMemberIds.includes(currentUser.id);\n+â”Š   â”Š373â”Š        ({creatorId, chatAdded}: {creatorId: string, chatAdded: Chat}, variables, {user: currentUser}: { user: User }) => {\n+â”Š   â”Š374â”Š          return Number(creatorId) !== currentUser.id &&\n+â”Š   â”Š375â”Š            !!chatAdded.listingMembers.find((user: User) => user.id === currentUser.id);\n â”Š320â”Š376â”Š        }),\n â”Š321â”Š377â”Š    }\n â”Š322â”Š378â”Š  },\n â”Š323â”Š379â”Š  Chat: {\n-â”Š324â”Š   â”Š    name: (chat: Chat, args: any, {user: currentUser}: {user: User}): string => chat.name ? chat.name : users\n-â”Š325â”Š   â”Š      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser.id))!.name,\n-â”Š326â”Š   â”Š    picture: (chat: Chat, args: any, {user: currentUser}: {user: User}) => chat.name ? chat.picture : users\n-â”Š327â”Š   â”Š      .find(user => user.id === chat.allTimeMemberIds.find(userId => userId !== currentUser.id))!.picture,\n-â”Š328â”Š   â”Š    allTimeMembers: (chat: Chat): User[] => users.filter(user => chat.allTimeMemberIds.includes(user.id)),\n-â”Š329â”Š   â”Š    listingMembers: (chat: Chat): User[] => users.filter(user => chat.listingMemberIds.includes(user.id)),\n-â”Š330â”Š   â”Š    actualGroupMembers: (chat: Chat): User[] => users.filter(user => chat.actualGroupMemberIds && chat.actualGroupMemberIds.includes(user.id)),\n-â”Š331â”Š   â”Š    admins: (chat: Chat): User[] => users.filter(user => chat.adminIds && chat.adminIds.includes(user.id)),\n-â”Š332â”Š   â”Š    owner: (chat: Chat): User | null => users.find(user => chat.ownerId === user.id) || null,\n-â”Š333â”Š   â”Š    messages: (chat: Chat, {amount = null}: {amount: number}, {user: currentUser}: {user: User}): Message[] => {\n-â”Š334â”Š   â”Š      const messages = chat.messages\n-â”Š335â”Š   â”Š      .filter(message => message.holderIds.includes(currentUser.id))\n-â”Š336â”Š   â”Š      .sort((a, b) => b.createdAt - a.createdAt) || <Message[]>[];\n-â”Š337â”Š   â”Š      return (amount ? messages.slice(0, amount) : messages).reverse();\n+â”Š   â”Š380â”Š    name: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<string | null> => {\n+â”Š   â”Š381â”Š      if (chat.name) {\n+â”Š   â”Š382â”Š        return chat.name;\n+â”Š   â”Š383â”Š      }\n+â”Š   â”Š384â”Š      const user = await connection\n+â”Š   â”Š385â”Š        .createQueryBuilder(User, \"user\")\n+â”Š   â”Š386â”Š        .where('user.id != :userId', {userId: currentUser.id})\n+â”Š   â”Š387â”Š        .innerJoin('user.allTimeMemberChats', 'allTimeMemberChats', 'allTimeMemberChats.id = :chatId', {chatId: chat.id})\n+â”Š   â”Š388â”Š        .getOne();\n+â”Š   â”Š389â”Š      return user && user.name || null;\n+â”Š   â”Š390â”Š    },\n+â”Š   â”Š391â”Š    picture: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<string | null> => {\n+â”Š   â”Š392â”Š      if (chat.name) {\n+â”Š   â”Š393â”Š        return chat.picture;\n+â”Š   â”Š394â”Š      }\n+â”Š   â”Š395â”Š      const user = await connection\n+â”Š   â”Š396â”Š        .createQueryBuilder(User, \"user\")\n+â”Š   â”Š397â”Š        .where('user.id != :userId', {userId: currentUser.id})\n+â”Š   â”Š398â”Š        .innerJoin('user.allTimeMemberChats', 'allTimeMemberChats', 'allTimeMemberChats.id = :chatId', {chatId: chat.id})\n+â”Š   â”Š399â”Š        .getOne();\n+â”Š   â”Š400â”Š      return user ? user.picture : null;\n+â”Š   â”Š401â”Š    },\n+â”Š   â”Š402â”Š    allTimeMembers: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User[]> => {\n+â”Š   â”Š403â”Š      return await connection\n+â”Š   â”Š404â”Š        .createQueryBuilder(User, \"user\")\n+â”Š   â”Š405â”Š        .innerJoin('user.allTimeMemberChats', 'allTimeMemberChats', 'allTimeMemberChats.id = :chatId', {chatId: chat.id})\n+â”Š   â”Š406â”Š        .getMany();\n+â”Š   â”Š407â”Š    },\n+â”Š   â”Š408â”Š    listingMembers: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User[]> => {\n+â”Š   â”Š409â”Š      return await connection\n+â”Š   â”Š410â”Š        .createQueryBuilder(User, \"user\")\n+â”Š   â”Š411â”Š        .innerJoin('user.listingMemberChats', 'listingMemberChats', 'listingMemberChats.id = :chatId', {chatId: chat.id})\n+â”Š   â”Š412â”Š        .getMany();\n+â”Š   â”Š413â”Š    },\n+â”Š   â”Š414â”Š    actualGroupMembers: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User[]> => {\n+â”Š   â”Š415â”Š      return await connection\n+â”Š   â”Š416â”Š        .createQueryBuilder(User, \"user\")\n+â”Š   â”Š417â”Š        .innerJoin('user.actualGroupMemberChats', 'actualGroupMemberChats', 'actualGroupMemberChats.id = :chatId', {chatId: chat.id})\n+â”Š   â”Š418â”Š        .getMany();\n+â”Š   â”Š419â”Š    },\n+â”Š   â”Š420â”Š    admins: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User[]> => {\n+â”Š   â”Š421â”Š      return await connection\n+â”Š   â”Š422â”Š        .createQueryBuilder(User, \"user\")\n+â”Š   â”Š423â”Š        .innerJoin('user.adminChats', 'adminChats', 'adminChats.id = :chatId', {chatId: chat.id})\n+â”Š   â”Š424â”Š        .getMany();\n â”Š338â”Š425â”Š    },\n-â”Š339â”Š   â”Š    unreadMessages: (chat: Chat, args: any, {user: currentUser}: {user: User}): number => chat.messages\n-â”Š340â”Š   â”Š      .filter(message => message.holderIds.includes(currentUser.id) &&\n-â”Š341â”Š   â”Š        message.recipients.find(recipient => recipient.userId === currentUser.id && !recipient.readAt))\n-â”Š342â”Š   â”Š      .length,\n-â”Š343â”Š   â”Š    isGroup: (chat: Chat): boolean => !!chat.name,\n+â”Š   â”Š426â”Š    owner: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User | null> => {\n+â”Š   â”Š427â”Š      return await connection\n+â”Š   â”Š428â”Š        .createQueryBuilder(User, \"user\")\n+â”Š   â”Š429â”Š        .innerJoin('user.ownerChats', 'ownerChats', 'ownerChats.id = :chatId', {chatId: chat.id})\n+â”Š   â”Š430â”Š        .getOne() || null;\n+â”Š   â”Š431â”Š    },\n+â”Š   â”Š432â”Š    messages: async (chat: Chat, {amount = null}: {amount: number}, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<Message[]> => {\n+â”Š   â”Š433â”Š      const query = connection\n+â”Š   â”Š434â”Š        .createQueryBuilder(Message, \"message\")\n+â”Š   â”Š435â”Š        .innerJoin('message.chat', 'chat', 'chat.id = :chatId', {chatId: chat.id})\n+â”Š   â”Š436â”Š        .innerJoin('message.holders', 'holders', 'holders.id = :userId', {userId: currentUser.id})\n+â”Š   â”Š437â”Š        .orderBy({\"message.createdAt\": \"DESC\"});\n+â”Š   â”Š438â”Š      return (amount ? await query.take(amount).getMany() : await query.getMany()).reverse();\n+â”Š   â”Š439â”Š    },\n+â”Š   â”Š440â”Š    unreadMessages: async (chat: Chat, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<number> => {\n+â”Š   â”Š441â”Š      return await connection\n+â”Š   â”Š442â”Š        .createQueryBuilder(Message, \"message\")\n+â”Š   â”Š443â”Š        .innerJoin('message.chat', 'chat', 'chat.id = :chatId', {chatId: chat.id})\n+â”Š   â”Š444â”Š        .innerJoin('message.recipients', 'recipients', 'recipients.user.id = :userId AND recipients.readAt IS NULL', {userId: currentUser.id})\n+â”Š   â”Š445â”Š        .getCount();\n+â”Š   â”Š446â”Š    },\n+â”Š   â”Š447â”Š    isGroup: (chat: Chat) => !!chat.name,\n â”Š344â”Š448â”Š  },\n â”Š345â”Š449â”Š  Message: {\n-â”Š346â”Š   â”Š    chat: (message: Message): Chat | null => chats.find(chat => message.chatId === chat.id) || null,\n-â”Š347â”Š   â”Š    sender: (message: Message): User | null => users.find(user => user.id === message.senderId) || null,\n-â”Š348â”Š   â”Š    holders: (message: Message): User[] => users.filter(user => message.holderIds.includes(user.id)),\n-â”Š349â”Š   â”Š    ownership: (message: Message, args: any, {user: currentUser}: {user: User}): boolean => message.senderId === currentUser.id,\n-â”Š350â”Š   â”Š  },\n-â”Š351â”Š   â”Š  Recipient: {\n-â”Š352â”Š   â”Š    user: (recipient: Recipient): User | null => users.find(user => recipient.userId === user.id) || null,\n-â”Š353â”Š   â”Š    message: (recipient: Recipient): Message | null => {\n-â”Š354â”Š   â”Š      const chat = chats.find(chat => recipient.chatId === chat.id);\n-â”Š355â”Š   â”Š      return chat ? chat.messages.find(message => recipient.messageId === message.id) || null : null;\n+â”Š   â”Š450â”Š    sender: async (message: Message, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User | null> => {\n+â”Š   â”Š451â”Š      return (await connection\n+â”Š   â”Š452â”Š        .createQueryBuilder(User, \"user\")\n+â”Š   â”Š453â”Š        .innerJoin('user.senderMessages', 'senderMessages', 'senderMessages.id = :messageId', {messageId: message.id})\n+â”Š   â”Š454â”Š        .getOne()) || null;\n+â”Š   â”Š455â”Š    },\n+â”Š   â”Š456â”Š    ownership: async (message: Message, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<boolean> => {\n+â”Š   â”Š457â”Š      return !!(await connection\n+â”Š   â”Š458â”Š        .createQueryBuilder(User, \"user\")\n+â”Š   â”Š459â”Š        .whereInIds(currentUser.id)\n+â”Š   â”Š460â”Š        .innerJoin('user.senderMessages', 'senderMessages', 'senderMessages.id = :messageId', {messageId: message.id})\n+â”Š   â”Š461â”Š        .getCount());\n+â”Š   â”Š462â”Š    },\n+â”Š   â”Š463â”Š    recipients: async (message: Message, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<Recipient[]> => {\n+â”Š   â”Š464â”Š      return await connection\n+â”Š   â”Š465â”Š        .createQueryBuilder(Recipient, \"recipient\")\n+â”Š   â”Š466â”Š        .innerJoinAndSelect('recipient.message', 'message', 'message.id = :messageId', {messageId: message.id})\n+â”Š   â”Š467â”Š        .innerJoinAndSelect('recipient.user', 'user')\n+â”Š   â”Š468â”Š        .innerJoinAndSelect('recipient.chat', 'chat')\n+â”Š   â”Š469â”Š        .getMany();\n+â”Š   â”Š470â”Š    },\n+â”Š   â”Š471â”Š    holders: async (message: Message, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<User[]> => {\n+â”Š   â”Š472â”Š      return await connection\n+â”Š   â”Š473â”Š        .createQueryBuilder(User, \"user\")\n+â”Š   â”Š474â”Š        .innerJoin('user.holderMessages', 'holderMessages', 'holderMessages.id = :messageId', {messageId: message.id})\n+â”Š   â”Š475â”Š        .getMany();\n+â”Š   â”Š476â”Š    },\n+â”Š   â”Š477â”Š    chat: async (message: Message, args: any, {user: currentUser, connection}: {user: User, connection: Connection}): Promise<Chat | null> => {\n+â”Š   â”Š478â”Š      return (await connection\n+â”Š   â”Š479â”Š        .createQueryBuilder(Chat, \"chat\")\n+â”Š   â”Š480â”Š        .innerJoin('chat.messages', 'messages', 'messages.id = :messageId', {messageId: message.id})\n+â”Š   â”Š481â”Š        .getOne()) || null;\n â”Š356â”Š482â”Š    },\n-â”Š357â”Š   â”Š    chat: (recipient: Recipient): Chat | null => chats.find(chat => recipient.chatId === chat.id) || null,\n â”Š358â”Š483â”Š  },\n â”Š359â”Š484â”Š};\n```\n\n[}]: #\n\n`QueryBuilder` is one of the most powerful features of `TypeORM` - it allows you to build SQL queries using elegant and convenient syntax, execute them and get automatically transformed entities.\n\nYou can find more informations on `TypeORM` on http://typeorm.io\n\nThe best part is that you won't have to do anything on the client, everything will be completely transparent to it, even if migrated from NoSQL-like db structure to a relational one!\nOf course, you could remove the custom normalization for the messages because now they have their own table and they are no longer embedded (so they have unique IDs), but we could leave it as well in order to be free to use any kind of backend."
          }
        ]
      }
    ]
  }
]
